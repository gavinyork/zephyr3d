
# è‡ªå®šä¹‰åŠ¨ç”»ï¼ˆCustom Animationï¼‰

é™¤äº†ç³»ç»Ÿæä¾›çš„é¢„å®šä¹‰è½¨é“ï¼ˆå¦‚å¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾ç­‰ï¼‰å¤–ï¼Œ  
Zephyr3D è¿˜å…è®¸å¼€å‘è€…**é€šè¿‡ç»§æ‰¿ `AnimationTrack` ç±»åˆ›å»ºè‡ªå®šä¹‰è½¨é“**ï¼Œ  
ä»è€Œå®ç°ä»»æ„æ•ˆæœçš„è‡ªå®šä¹‰åŠ¨ç”»ï¼ˆå¦‚ UV æ»šåŠ¨ã€æè´¨å˜åŒ–ã€é¢œè‰²æ·¡å…¥æ·¡å‡ºç­‰ï¼‰ã€‚

---

## è‡ªå®šä¹‰è½¨é“çš„æ ¸å¿ƒåŸç†

è‡ªå®šä¹‰è½¨é“ï¼ˆ`Custom AnimationTrack`ï¼‰æ˜¯é€šè¿‡ç»§æ‰¿åŸºç±» `AnimationTrack` å®ç°çš„ã€‚  
ä½ éœ€è¦é‡å†™ä»¥ä¸‹å››ä¸ªå…³é”®æ–¹æ³•ï¼Œä»¥å®šä¹‰è½¨é“å¦‚ä½•è®¡ç®—çŠ¶æ€ã€æ··åˆçŠ¶æ€å¹¶åº”ç”¨åˆ°ç›®æ ‡ä¸Šã€‚

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| **`calculateState(target, currentTime)`** | è®¡ç®—æŒ‡å®šæ—¶åˆ»çš„è½¨é“çŠ¶æ€ï¼ˆå¦‚ä½ç½®ã€æ—‹è½¬ã€æ•°å€¼ç­‰ï¼‰ï¼Œè¿”å›ä¸€ä¸ªçŠ¶æ€å¯¹è±¡ï¼Œå¯ä¸º `Vector3`ã€`Quaternion`ã€`Number` æˆ–ä»»ä½•ç±»å‹ã€‚ |
| **`mixState(stateA, stateB, t)`** | åœ¨ä¸¤ä¸ªçŠ¶æ€é—´æ’å€¼ï¼Œç”¨äºåŠ¨ä½œèåˆã€‚å¿…é¡»è¿”å›æ–°çŠ¶æ€å¯¹è±¡ã€‚ |
| **`applyState(target, state)`** | å°†å½“å‰è½¨é“çŠ¶æ€åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡ä¸Šã€‚ç›®æ ‡å¯¹è±¡é€šå¸¸ä¸º `SceneNode`ã€‚ |
| **`getBlendId()`** | è¿”å›è½¨é“çš„å”¯ä¸€æ ‡è¯†ã€‚å…·æœ‰ç›¸åŒ `blendId` çš„è½¨é“è¢«è®¤ä¸ºå¯ç›¸äº’æ··åˆï¼Œä½†ä¸èƒ½åŒæ—¶å­˜åœ¨äºä¸€ä¸ªåŠ¨ç”»ç‰‡æ®µä¸­ã€‚ |

> ğŸ’¡ **æ³¨æ„ï¼š**  
> åŒä¸€ `AnimationClip` ä¸­ï¼Œä¸å…è®¸æ·»åŠ ä¸¤ä¸ªå…·æœ‰ç›¸åŒ `blendId` çš„è½¨é“ï¼Œ
> å¦åˆ™ç³»ç»Ÿä¼šè®¤ä¸ºå®ƒä»¬æ§åˆ¶çš„æ˜¯åŒä¸€å±æ€§ã€‚

---

## ç¤ºä¾‹ï¼šåˆ›å»ºè‡ªå®šä¹‰ UV åŠ¨ç”»è½¨é“

ä¸‹é¢ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰åŠ¨ç”»è½¨é“ï¼Œä½¿æ¨¡å‹æè´¨çš„è´´å›¾äº§ç”Ÿå¾ªç¯æ»šåŠ¨çš„ UV åŠ¨ç”»æ•ˆæœã€‚

```javascript
// è‡ªå®šä¹‰åŠ¨ç”»è½¨é“ï¼šå®ç°UVåŠ¨ç”»
class MyAnimationTrack extends AnimationTrack {
  _state; // å½“å‰è½¨é“çŠ¶æ€ï¼ˆFloat32Arrayï¼‰
  _interpolator; // æ’å€¼å™¨ï¼Œç”¨äºè®¡ç®—å…³é”®å¸§é—´çš„çŠ¶æ€

  // æ„é€ å‡½æ•°ï¼šæ¥æ”¶ä¸€ä¸ªå…³é”®å¸§æ’å€¼å™¨
  constructor(interpolator) {
    super();
    this._interpolator = interpolator;
    this._state = new Float32Array(1);
  }

  // è®¡ç®—å¹¶è¿”å›ç»™å®šæ—¶åˆ»çš„è½¨é“çŠ¶æ€
  calculateState(target, currentTime) {
    this._interpolator.interpolate(currentTime, this._state);
    return this._state;
  }

  // æ··åˆä¸¤ä¸ªåŠ¨ç”»çŠ¶æ€ï¼ˆç”¨äºèåˆï¼‰
  mixState(a, b, t) {
    const result = new Float32Array(1);
    result[0] = a[0] + (b[0] - a[0]) * t;
    return result;
  }

  // å°†çŠ¶æ€åº”ç”¨è‡³èŠ‚ç‚¹
  applyState(target, state) {
    // éå†èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰Mesh
    target.iterate((child) => {
      if (child.isMesh()) {
        // åº”ç”¨UVåŠ¨ç”»ï¼ˆå¹³ç§»UVåæ ‡ï¼‰
        child.material.albedoTexCoordMatrix = Matrix4x4.translation(
          new Vector3(state[0], 0, 0)
        );
      }
    });
  }

  // Blend IDç”¨äºåŒºåˆ†è½¨é“ç±»å‹
  getBlendId() {
    return 'uv-animation';
  }
}
```

---

## åº”ç”¨è‡ªå®šä¹‰è½¨é“

å®Œæ•´åº”ç”¨æµç¨‹åŒ…æ‹¬ä»¥ä¸‹å‡ æ­¥ï¼š

1. **åŠ è½½æ¨¡å‹**
2. **åˆ›å»ºåŠ¨ç”»ç‰‡æ®µ**
3. **æ„å»ºæ’å€¼å™¨ï¼ˆInterpolatorï¼‰**
4. **åˆ›å»ºå¹¶æ·»åŠ è‡ªå®šä¹‰è½¨é“**
5. **æ’­æ”¾åŠ¨ç”»**

```javascript
// æ­¥éª¤ 1ï¼šåŠ è½½æ¨¡å‹
const model = await getEngine().resourceManager.instantiatePrefab(
  scene.rootNode,
  '/assets/BoxTextured.zprefab'
);

// æ­¥éª¤ 2ï¼šåˆ›å»ºä¸€ä¸ªåŠ¨ç”»ç‰‡æ®µ
const animation = model.animationSet.createAnimation('UserTrackTest');

// æ­¥éª¤ 3ï¼šåˆ›å»ºä¸€ä¸ªå…³é”®å¸§æ’å€¼å™¨
const interpolator = new Interpolator(
  'linear',                  // æ’å€¼æ¨¡å¼ï¼ˆ'linear' / 'step' / 'cubicspline'ï¼‰
  null,                      // è‡ªåŠ¨è®¡ç®—å…³é”®å¸§ç»´åº¦
  new Float32Array([0, 2]),  // æ—¶é—´å…³é”®å¸§ï¼š0s â†’ 2s
  new Float32Array([0, 1])   // å€¼å…³é”®å¸§ï¼šUV ä» 0 æ»šåŠ¨åˆ° 1
);

// æ­¥éª¤ 4ï¼šåˆ›å»ºå¹¶æ·»åŠ è‡ªå®šä¹‰è½¨é“
const track = new MyAnimationTrack(interpolator);
animation.addTrack(model, track);

// æ­¥éª¤ 5ï¼šæ’­æ”¾åŠ¨ç”»
model.animationSet.playAnimation('UserTrackTest', {
  repeat: 0,     // å¾ªç¯æ¬¡æ•°ï¼ˆ0 è¡¨ç¤ºæ— é™å¾ªç¯ï¼‰
  speedRatio: 1, // æ’­æ”¾é€Ÿåº¦
  weight: 1,     // èåˆæƒå€¼ï¼ˆå¤šä¸ªåŠ¨ç”»å åŠ æ—¶ä½¿ç”¨ï¼‰
  fadeIn: 0,     // æ·¡å…¥æ—¶é—´
});
```

<div class="showcase" case="tut-26"></div>

---

## æ–¹æ³•å®ç°è¯´æ˜

### `calculateState()`
ç”¨äºæ ¹æ®å½“å‰æ’­æ”¾æ—¶é—´è®¡ç®—è½¨é“çŠ¶æ€ï¼Œå¦‚ä½ç½®æˆ–æ•°å€¼å˜åŒ–ã€‚  
ç³»ç»Ÿæ¯å¸§è°ƒç”¨æ­¤æ–¹æ³•ï¼Œç„¶åé€šè¿‡ `applyState()` å°†ç»“æœåº”ç”¨åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚

### `mixState()`
å½“ä¸¤ä¸ªå…·æœ‰ç›¸åŒ `blendId` çš„åŠ¨ç”»åŒæ—¶æ’­æ”¾æ—¶è°ƒç”¨æ­¤æ–¹æ³•ï¼Œ  
è¿”å›ä¸¤ä¸ªçŠ¶æ€æŒ‰æ¯”ä¾‹ `t` æ··åˆåçš„æ–°çŠ¶æ€ï¼Œç”¨äºåŠ¨ç”»èåˆã€‚

### `applyState()`
å®é™…å°†è®¡ç®—å¾—åˆ°çš„è½¨é“çŠ¶æ€ä½œç”¨äºèŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼š
- ä¿®æ”¹ä½ç§»ã€æ—‹è½¬ã€ç¼©æ”¾ï¼›
- è°ƒæ•´æè´¨æˆ–é¢œè‰²å±æ€§ï¼›
- æ›´æ–°è‡ªå®šä¹‰å±æ€§ï¼ˆå¦‚ç¯å…‰å¼ºåº¦æˆ–è´´å›¾åç§»ï¼‰ã€‚

### `getBlendId()`
ç”¨äºå®šä¹‰è½¨é“ç±»å‹å”¯ä¸€æ€§ã€‚  
ç³»ç»Ÿé€šè¿‡ `blendId` åˆ¤å®šè½¨é“èƒ½å¦èåˆæˆ–æ˜¯å¦å†²çªã€‚

---

## å®ç”¨æŠ€å·§

| ä½¿ç”¨åœºæ™¯ | å»ºè®®å®ç°æ–¹å¼ |
|-----------|--------------|
| è‡ªå®šä¹‰æè´¨åŠ¨ç”»ï¼ˆUVæ»šåŠ¨ã€é—ªçƒï¼‰ | é€šè¿‡æè´¨å±æ€§å®ç°ï¼ˆå¦‚ `UV` æˆ– `emission`ï¼‰ |
| æ‘„åƒæœºç‰¹æ•ˆï¼ˆç„¦è·ã€æ™¯æ·±å˜åŒ–ï¼‰ | è½¨é“ç›´æ¥ä¿®æ”¹æ‘„åƒæœºå‚æ•° |
| ç¯å…‰åŠ¨ç”»ï¼ˆæ˜æš—å˜åŒ–ï¼‰ | è½¨é“ä¿®æ”¹å…‰ç…§å¼ºåº¦æˆ–é¢œè‰² |
| ç¯å¢ƒå˜åŒ–ï¼ˆé›¾æ•ˆã€æ›å…‰ï¼‰ | æ§åˆ¶å…¨å±€æ¸²æŸ“å‚æ•°å®ç° |

---

## å°ç»“

- é€šè¿‡ç»§æ‰¿ **`AnimationTrack`** å¯å®ç°å„ç§è‡ªå®šä¹‰åŠ¨ç”»ï¼›
- å¿…é¡»å®ç° `calculateState()`ã€`mixState()`ã€`applyState()`ã€`getBlendId()` å››ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼›
- å¯ç»“åˆ **Interpolator** å®ç°ç²¾å‡†çš„å…³é”®å¸§æ§åˆ¶ï¼›
- è‡ªå®šä¹‰è½¨é“çš„å¼ºå¤§ä¹‹å¤„åœ¨äºâ€”â€”**å‡ ä¹å¯ä»¥å¯¹å¼•æ“ä¸­ä»»ä½•å¯åŠ¨ç”»å‚æ•°è¿›è¡Œæ§åˆ¶**ã€‚

---

> **å»ºè®®ï¼š**
> - ä¿æŒå„è½¨é“çš„ `blendId` å”¯ä¸€ä»¥é¿å…å†²çªï¼›
> - è‡ªå®šä¹‰åŠ¨ç”»é€‚åˆç”¨äºé«˜çº§æè´¨ã€ç¯å¢ƒæˆ–ç‰¹æ•ˆç³»ç»Ÿï¼›
> - **Zephyr3D ç¼–è¾‘å™¨** æ”¯æŒä¸ºå¤§éƒ¨åˆ†èŠ‚ç‚¹å¯¹è±¡å±æ€§åˆ›å»ºå…³é”®å¸§åŠ¨ç”»ï¼›
