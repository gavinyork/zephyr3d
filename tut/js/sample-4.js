const e={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32",transparent:"rgba(0,0,0,0)"};function t(e){return function(){return class extends e{_listeners;constructor(...e){super(...e),this._listeners=null}on(e,t,r){this._listeners=this._internalAddEventListener(this._listeners,e,t,{context:r})}once(e,t,r){this._listeners=this._internalAddEventListener(this._listeners,e,t,{context:r,once:!0})}off(e,t){this._internalRemoveEventListener(this._listeners,e,t)}dispatchEvent(e,t){this._invokeLocalListeners(e,t)}_internalAddEventListener(e,t,r,s){if("string"!=typeof t)return;e||(e={});const i=r,n={once:!!s?.once,context:s?.context};let a=e[t];return a||(e[t]=a=[]),a.push({handler:i,options:n,removed:!1}),e}_internalRemoveEventListener(e,t,r){if("string"!=typeof t||!e)return;const s=r,i=e[t];if(i)for(let e=0;e<i.length;e++){if(i[e].handler===s){i.splice(e,1);break}}0===i.length&&delete e[t]}_invokeLocalListeners(e,t){if(!this._listeners)return;const r=this._listeners[t??e?.type];if(r&&r.length>0){const t=r.slice();for(const r of t)r.handler.call(r.options?.context||this,e),r.options.once&&(r.removed=!0);for(let e=r.length-1;e>=0;e--)r[e].removed&&r.splice(e,1)}}}}}var r,s,i;!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.TOP=3]="TOP",e[e.FRONT=4]="FRONT",e[e.BACK=5]="BACK"}(r||(r={})),function(e){e[e.NOT_CLIPPED=0]="NOT_CLIPPED",e[e.A_INSIDE_B=1]="A_INSIDE_B",e[e.B_INSIDE_A=2]="B_INSIDE_A",e[e.CLIPPED=2]="CLIPPED"}(s||(s={})),function(e){e[e.PX=0]="PX",e[e.NX=1]="NX",e[e.PY=2]="PY",e[e.NY=3]="NY",e[e.PZ=4]="PZ",e[e.NZ=5]="NZ"}(i||(i={}));const n=new Float32Array([1,0,0,0,1,0,0,0,1]),a=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class o extends Float32Array{equalsTo(e,t){if(!e||this.length!==e.length)return!1;if(this===e)return!0;for(let r=0;r<this.length;r++){const s=this[r],i=e[r],n=t??1e-4*Math.max(1,Math.abs(s),Math.abs(i));if(Math.abs(s-i)>n)return!1}return!0}toString(){const e=[...this].map((e=>e.toFixed(3)));return`${this.constructor.name}{${e.join(",")}}`}isNaN(){for(let e=0;e<this.length;e++)if(Number.isNaN(this[e]))return!0;return!1}setRandom(e,t){for(let r=0;r<this.length;r++)this[r]=e+(t-e)*Math.random()}}class u extends o{constructor(e,t){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,2);else if(super(2),"number"==typeof e&&"number"==typeof t)this[0]=e,this[1]=t;else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=2)this[0]=e[0],this[1]=e[1];else if(void 0!==e)throw new Error("Vector2.constructor(): invalid arguments")}clone(){return new u(this)}get x(){return this[0]}set x(e){this[0]=e}get y(){return this[1]}set y(e){this[1]=e}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]}setXY(e,t){return this[0]=e,this[1]=t,this}setAndNormalize(e,t){const r=Math.sqrt(e*e+t*t);return this.setXY(e/r,t/r)}subBy(e){return u.sub(this,e,this)}addBy(e){return u.add(this,e,this)}mulBy(e){return u.mul(this,e,this)}divBy(e){return u.div(this,e,this)}scaleBy(e){return u.scale(this,e,this)}inplaceNormalize(){return u.normalize(this,this)}inplaceInverse(){return u.inverse(this,this)}inplaceMin(e){return u.min(this,e,this)}inplaceMax(e){return u.max(this,e,this)}static zero(){return new u(0,0)}static one(){return new u(1,1)}static axisPX(){return new u(1,0)}static axisNX(){return new u(-1,0)}static axisPY(){return new u(0,1)}static axisNY(){return new u(0,-1)}static distance(e,t){return Math.sqrt(this.distanceSq(e,t))}static distanceSq(e,t){const r=e.x-t.x,s=e.y-t.y;return r*r+s*s}static normalize(e,t){const r=e.magnitude,s=e.x/r,i=e.y/r;return(t||new u).setXY(s,i)}static inverse(e,t){const r=1/e.x,s=1/e.y;return(t||new u).setXY(r,s)}static sub(e,t,r){const s=e.x-t.x,i=e.y-t.y;return(r||new u).setXY(s,i)}static add(e,t,r){const s=e.x+t.x,i=e.y+t.y;return(r||new u).setXY(s,i)}static mul(e,t,r){const s=e.x*t.x,i=e.y*t.y;return(r||new u).setXY(s,i)}static div(e,t,r){const s=e.x/t.x,i=e.y/t.y;return(r||new u).setXY(s,i)}static scale(e,t,r){const s=e.x*t,i=e.y*t;return(r||new u).setXY(s,i)}static min(e,t,r){const s=e.x<t.x?e.x:t.x,i=e.y<t.y?e.y:t.y;return(r||new u).setXY(s,i)}static max(e,t,r){const s=e.x>t.x?e.x:t.x,i=e.y>t.y?e.y:t.y;return(r||new u).setXY(s,i)}static abs(e,t){const r=e.x<0?-e.x:e.x,s=e.y<0?-e.y:e.y;return(t||new u).setXY(r,s)}static dot(e,t){return e.x*t.x+e.y*t.y}static cross(e,t){return e.x*t.y-e.y*t.x}}class h extends o{constructor(e,t,r){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,3);else if(super(3),"number"==typeof e&&"number"==typeof t&&"number"==typeof r)this[0]=e,this[1]=t,this[2]=r;else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=3)this[0]=e[0],this[1]=e[1],this[2]=e[2];else if(void 0!==e)throw new Error("Vector3.constructor(): invalid arguments")}clone(){return new h(this)}get x(){return this[0]}set x(e){this[0]=e}get y(){return this[1]}set y(e){this[1]=e}get z(){return this[2]}set z(e){this[2]=e}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]}xy(){return new u(this.x,this.y)}setXYZ(e,t,r){return this[0]=e,this[1]=t,this[2]=r,this}setAndNormalize(e,t,r){const s=Math.sqrt(e*e+t*t+r*r);return this.setXYZ(e/s,t/s,r/s)}subBy(e){return h.sub(this,e,this)}addBy(e){return h.add(this,e,this)}mulBy(e){return h.mul(this,e,this)}divBy(e){return h.div(this,e,this)}scaleBy(e){return h.scale(this,e,this)}inplaceNormalize(){return h.normalize(this,this)}inplaceInverse(){return h.inverse(this,this)}inplaceMin(e){return h.min(this,e,this)}inplaceMax(e){return h.max(this,e,this)}static zero(){return new h(0,0,0)}static one(){return new h(1,1,1)}static axisPX(){return new h(1,0,0)}static axisNX(){return new h(-1,0,0)}static axisPY(){return new h(0,1,0)}static axisNY(){return new h(0,-1,0)}static axisPZ(){return new h(0,0,1)}static axisNZ(){return new h(0,0,-1)}static distance(e,t){return Math.sqrt(this.distanceSq(e,t))}static distanceSq(e,t){const r=e.x-t.x,s=e.y-t.y,i=e.z-t.z;return r*r+s*s+i*i}static normalize(e,t){const r=e.magnitude,s=e.x/r,i=e.y/r,n=e.z/r;return(t||new h).setXYZ(s,i,n)}static inverse(e,t){const r=1/e.x,s=1/e.y,i=1/e.z;return(t||new h).setXYZ(r,s,i)}static sub(e,t,r){const s=e.x-t.x,i=e.y-t.y,n=e.z-t.z;return(r||new h).setXYZ(s,i,n)}static add(e,t,r){const s=e.x+t.x,i=e.y+t.y,n=e.z+t.z;return(r||new h).setXYZ(s,i,n)}static mul(e,t,r){const s=e.x*t.x,i=e.y*t.y,n=e.z*t.z;return(r||new h).setXYZ(s,i,n)}static div(e,t,r){const s=e.x/t.x,i=e.y/t.y,n=e.z/t.z;return(r||new h).setXYZ(s,i,n)}static scale(e,t,r){const s=e.x*t,i=e.y*t,n=e.z*t;return(r||new h).setXYZ(s,i,n)}static min(e,t,r){const s=e.x<t.x?e.x:t.x,i=e.y<t.y?e.y:t.y,n=e.z<t.z?e.z:t.z;return(r||new h).setXYZ(s,i,n)}static max(e,t,r){const s=e.x>t.x?e.x:t.x,i=e.y>t.y?e.y:t.y,n=e.z>t.z?e.z:t.z;return(r||new h).setXYZ(s,i,n)}static abs(e,t){const r=e.x<0?-e.x:e.x,s=e.y<0?-e.y:e.y,i=e.z<0?-e.z:e.z;return(t||new h).setXYZ(r,s,i)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static cross(e,t,r){const s=e.y*t.z-e.z*t.y,i=e.z*t.x-e.x*t.z,n=e.x*t.y-e.y*t.x;return(r||new h).setXYZ(s,i,n)}}class l extends o{constructor(e,t,r,s){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,4);else if(super(4),"number"==typeof e&&"number"==typeof t&&"number"==typeof r&&"number"==typeof s)this[0]=e,this[1]=t,this[2]=r,this[3]=s;else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=4)this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3];else if(void 0!==e)throw new Error("Vector4.constructor(): invalid arguments")}clone(){return new l(this)}get x(){return this[0]}set x(e){this[0]=e}get y(){return this[1]}set y(e){this[1]=e}get z(){return this[2]}set z(e){this[2]=e}get w(){return this[3]}set w(e){this[3]=e}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3]}xy(){return new u(this.x,this.y)}xyz(){return new h(this.x,this.y,this.z)}setXYZW(e,t,r,s){return this[0]=e,this[1]=t,this[2]=r,this[3]=s,this}setAndNormalize(e,t,r,s){const i=Math.sqrt(e*e+t*t+r*r+s*s);return this.setXYZW(e/i,t/i,r/i,s/i)}subBy(e){return l.sub(this,e,this)}addBy(e){return l.add(this,e,this)}mulBy(e){return l.mul(this,e,this)}divBy(e){return l.div(this,e,this)}scaleBy(e){return l.scale(this,e,this)}inplaceNormalize(){return l.normalize(this,this)}inplaceInverse(){return l.inverse(this,this)}inplaceMin(e){return l.min(this,e,this)}inplaceMax(e){return l.max(this,e,this)}static zero(){return new l(0,0,0,0)}static one(){return new l(1,1,1,1)}static axisPX(){return new l(1,0,0,0)}static axisNX(){return new l(-1,0,0,0)}static axisPY(){return new l(0,1,0,0)}static axisNY(){return new l(0,-1,0,0)}static axisPZ(){return new l(0,0,1,0)}static axisNZ(){return new l(0,0,-1,0)}static axisPW(){return new l(0,0,0,1)}static axisNW(){return new l(0,0,0,-1)}static normalize(e,t){const r=e.magnitude,s=e.x/r,i=e.y/r,n=e.z/r,a=e.w/r;return(t||new l).setXYZW(s,i,n,a)}static inverse(e,t){const r=1/e.x,s=1/e.y,i=1/e.z,n=1/e.w;return(t||new l).setXYZW(r,s,i,n)}static sub(e,t,r){const s=e.x-t.x,i=e.y-t.y,n=e.z-t.z,a=e.w-t.w;return(r||new l).setXYZW(s,i,n,a)}static add(e,t,r){const s=e.x+t.x,i=e.y+t.y,n=e.z+t.z,a=e.w+t.w;return(r||new l).setXYZW(s,i,n,a)}static mul(e,t,r){const s=e.x*t.x,i=e.y*t.y,n=e.z*t.z,a=e.w*t.w;return(r||new l).setXYZW(s,i,n,a)}static div(e,t,r){const s=e.x/t.x,i=e.y/t.y,n=e.z/t.z,a=e.w/t.w;return(r||new l).setXYZW(s,i,n,a)}static scale(e,t,r){const s=e.x*t,i=e.y*t,n=e.z*t,a=e.w*t;return(r||new l).setXYZW(s,i,n,a)}static min(e,t,r){const s=e.x<t.x?e.x:t.x,i=e.y<t.y?e.y:t.y,n=e.z<t.z?e.z:t.z,a=e.w<t.w?e.w:t.w;return(r||new l).setXYZW(s,i,n,a)}static max(e,t,r){const s=e.x>t.x?e.x:t.x,i=e.y>t.y?e.y:t.y,n=e.z>t.z?e.z:t.z,a=e.w>t.w?e.w:t.w;return(r||new l).setXYZW(s,i,n,a)}static abs(e,t){const r=e.x<0?-e.x:e.x,s=e.y<0?-e.y:e.y,i=e.z<0?-e.z:e.z,n=e.w<0?-e.w:e.w;return(t||new l).setXYZW(r,s,i,n)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}}class c extends o{constructor(e,t,r,s){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,4);else if(super(4),"number"==typeof e&&"number"==typeof t&&"number"==typeof r&&"number"==typeof s)this[0]=e,this[1]=t,this[2]=r,this[3]=s;else if(e instanceof p||e instanceof f)this.fromRotationMatrix(e);else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=4)this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3];else{if(void 0!==e)throw new Error("Quaternion.constructor(): invalid arguments");this[0]=0,this[1]=0,this[2]=0,this[3]=1}}clone(){return new c(this)}get x(){return this[0]}set x(e){this[0]=e}get y(){return this[1]}set y(e){this[1]=e}get z(){return this[2]}set z(e){this[2]=e}get w(){return this[3]}set w(e){this[3]=e}setXYZW(e,t,r,s){return this[0]=e,this[1]=t,this[2]=r,this[3]=s,this}scaleBy(e){return c.scale(this,e,this)}setAndNormalize(e,t,r,s){const i=Math.sqrt(e*e+t*t+r*r+s*s);return this.setXYZW(e/i,t/i,r/i,s/i)}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3]}identity(){return c.identity(this)}inplaceNormalize(){return c.normalize(this,this)}inplaceConjugate(){return c.conjugate(this,this)}multiplyRight(e){return c.multiply(this,e,this)}multiplyLeft(e){return c.multiply(e,this,this)}unitVectorToUnitVector(e,t){return c.unitVectorToUnitVector(e,t,this)}fromEulerAngle(e,t,r,s){return c.fromEulerAngle(e,t,r,s,this)}fromAxisAngle(e,t){return c.fromAxisAngle(e,t,this)}toAxisAngle(e){const t=2*Math.acos(this[3]),r=Math.sin(t/2);return r>1e-6?e.setXYZ(this[0]/r,this[1]/2,this[2]/r):e.setXYZ(1,0,0),t}toEulerAngles(e){e=e??new h;const t=2*(this.w*this.x+this.y*this.z),r=1-2*(this.x*this.x+this.y*this.y),s=Math.atan2(t,r),i=Math.max(-1,Math.min(1,2*(this.w*this.y-this.z*this.x))),n=Math.asin(i),a=2*(this.w*this.z+this.x*this.y),o=1-2*(this.y*this.y+this.z*this.z),u=Math.atan2(a,o);return e.setXYZ(s,n,u)}fromRotationMatrix(e){return c.fromRotationMatrix(e,this)}toMatrix3x3(e){const t=e||new p;return this.toMatrix(t),t}toMatrix4x4(e){const t=e||f.identity();return this.toMatrix(t),t}getDirectionX(e){return(e=e??new h).setXYZ(1-2*(this.y*this.y+this.z*this.z),2*(this.x*this.y+this.z*this.w),2*(this.z*this.x-this.y*this.w))}getDirectionY(e){return(e=e??new h).setXYZ(2*(this.x*this.y-this.z*this.w),1-2*(this.z*this.z+this.x*this.x),2*(this.y*this.z+this.x*this.w))}getDirectionZ(e){return(e=e??new h).setXYZ(2*(this.z*this.x+this.y*this.w),2*(this.y*this.z-this.x*this.w),1-2*(this.y*this.y+this.x*this.x))}getAxisAngle(e){e=e??new l;const t=this.w<0?-1:1,r=this.x*t,s=this.y*t,i=this.z*t,n=this.w*t,a=Math.acos(n),o=Math.sin(a);return e.setXYZW(r/o,s/o,i/o,2*a)}transform(e,t){t=t||new h;const r=2*this.x,s=2*this.y,i=2*this.z,n=this.x*r,a=this.y*s,o=this.z*i,u=this.x*s,l=this.x*i,c=this.y*i,p=this.w*r,f=this.w*s,d=this.w*i;return t.setXYZ((1-a-o)*e.x+(u-d)*e.y+(l+f)*e.z,(u+d)*e.x+(1-n-o)*e.y+(c-p)*e.z,(l-f)*e.x+(c+p)*e.y+(1-n-a)*e.z)}static scale(e,t,r){return(r=r||e).setXYZW(e.x*t,e.y*t,e.z*t,e.w*t)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static identity(e){return(e||new c).setXYZW(0,0,0,1)}static normalize(e,t){const r=e.magnitude;return(t||new c).setXYZW(e.x/r,e.y/r,e.z/r,e.w/r)}static conjugate(e,t){return(t||new c).setXYZW(-e.x,-e.y,-e.z,e.w)}static multiply(e,t,r){r=r||new c;const s=e.x*t.w+e.w*t.x+e.y*t.z-e.z*t.y,i=e.y*t.w+e.w*t.y+e.z*t.x-e.x*t.z,n=e.z*t.w+e.w*t.z+e.x*t.y-e.y*t.x,a=e.w*t.w-e.x*t.x-e.y*t.y-e.z*t.z;return r.setXYZW(s,i,n,a)}static slerp(e,t,r,s){if(s=s||new c,r<=0)return s.setXYZW(e.x,e.y,e.z,e.w);if(r>=1)return s.setXYZW(t.x,t.y,t.z,t.w);const i=this.dot(e,t),n=i<0?-1:1,a=e.x,o=e.y,u=e.z,h=e.w,l=t.x*n,p=t.y*n,f=t.z*n,d=t.w*n,m=i*n;if(m>=1)return s.setXYZW(a,o,u,h);const _=1-m*m;if(_<=Number.EPSILON){const i=1-r;return s.setAndNormalize(e.x*i+t.x*r,e.y*i+t.y*r,e.z*i+t.z*r,e.w*i+t.w*r)}const g=Math.sqrt(_),x=Math.atan2(g,m),y=Math.sin((1-r)*x)/g,b=Math.sin(r*x)/g;return s.setXYZW(a*y+l*b,o*y+p*b,u*y+f*b,h*y+d*b)}static angleBetween(e,t){const r=this.dot(e,t),s=r<-1?-1:r>1?1:r;return 2*Math.acos(Math.abs(s))}static unitVectorToUnitVector(e,t,r){r=r||new c;let s=h.dot(e,t)+1;return s<1e-6?(s=0,Math.abs(e.x)>Math.abs(e.z)?r.setAndNormalize(-e.y,e.x,0,s):r.setAndNormalize(0,-e.z,e.y,s)):r.setAndNormalize(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x,s)}static fromEulerAngle(e,t,r,s,i){i=i||new c;const n=Math.cos(e/2),a=Math.cos(t/2),o=Math.cos(r/2),u=Math.sin(e/2),h=Math.sin(t/2),l=Math.sin(r/2);switch(s){case"XYZ":return i.setXYZW(u*a*o+n*h*l,n*h*o-u*a*l,n*a*l+u*h*o,n*a*o-u*h*l);case"YXZ":return i.setXYZW(u*a*o+n*h*l,n*h*o-u*a*l,n*a*l-u*h*o,n*a*o+u*h*l);case"ZXY":return i.setXYZW(u*a*o-n*h*l,n*h*o+u*a*l,n*a*l+u*h*o,n*a*o-u*h*l);case"ZYX":return i.setXYZW(u*a*o-n*h*l,n*h*o+u*a*l,n*a*l-u*h*o,n*a*o+u*h*l);case"YZX":return i.setXYZW(u*a*o+n*h*l,n*h*o+u*a*l,n*a*l-u*h*o,n*a*o-u*h*l);case"XZY":return i.setXYZW(u*a*o-n*h*l,n*h*o-u*a*l,n*a*l+u*h*o,n*a*o+u*h*l)}}static fromAxisAngle(e,t,r){r=r||new c;const s=t/2,i=Math.sin(s);return r.setXYZW(e.x*i,e.y*i,e.z*i,Math.cos(s))}static fromRotationMatrix(e,t){t=t||new c;const r=e.m00+e.m11+e.m22;let s;return r>0?(s=.5/Math.sqrt(r+1),t.setXYZW((e.m21-e.m12)*s,(e.m02-e.m20)*s,(e.m10-e.m01)*s,.25/s)):e.m00>e.m11&&e.m00>e.m22?(s=2*Math.sqrt(1+e.m00-e.m11-e.m22),t.setXYZW(.25*s,(e.m01+e.m10)/s,(e.m02+e.m20)/s,(e.m21-e.m12)/s)):e.m11>e.m22?(s=2*Math.sqrt(1-e.m00+e.m11-e.m22),t.setXYZW((e.m10+e.m01)/s,.25*s,(e.m21+e.m12)/s,(e.m02-e.m20)/s)):(s=2*Math.sqrt(1-e.m00-e.m11+e.m22),t.setXYZW((e.m02+e.m20)/s,(e.m12+e.m21)/s,.25*s,(e.m10-e.m01)/s)),t}toMatrix(e){const t=this.x*this.x,r=this.y*this.y,s=this.z*this.z,i=this.x*this.y,n=this.z*this.w,a=this.z*this.x,o=this.y*this.w,u=this.y*this.z,h=this.x*this.w;e.m00=1-2*(r+s),e.m10=2*(i+n),e.m20=2*(a-o),e.m01=2*(i-n),e.m11=1-2*(s+t),e.m21=2*(u+h),e.m02=2*(a+o),e.m12=2*(u-h),e.m22=1-2*(r+t)}}class p extends o{constructor(e,t,r,s,i,n,a,o,u){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,9);else if(super(9),"number"==typeof e)this[0]=e,this[1]=t,this[2]=r,this[3]=s,this[4]=i,this[5]=n,this[6]=a,this[7]=o,this[8]=u;else if(e instanceof c)e.toMatrix3x3(this);else if(e instanceof f)this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[4],this[4]=e[5],this[5]=e[6],this[6]=e[8],this[7]=e[9],this[8]=e[10];else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=9)this.set(e);else{if(void 0!==e)throw new Error("Matrix3x4.constructor(): invalid arguments");this.identity()}}clone(){return new p(this)}get m00(){return this[0]}set m00(e){this[0]=e}get m10(){return this[1]}set m10(e){this[1]=e}get m20(){return this[2]}set m20(e){this[2]=e}get m01(){return this[3]}set m01(e){this[3]=e}get m11(){return this[4]}set m11(e){this[4]=e}get m21(){return this[5]}set m21(e){this[5]=e}get m02(){return this[6]}set m02(e){this[6]=e}get m12(){return this[7]}set m12(e){this[7]=e}get m22(){return this[8]}set m22(e){this[8]=e}getRow(e,t){return(t||new h).setXYZ(this[3*e],this[3*e+1],this[3*e+2])}setRow(e,t){return this[3*e]=t.x,this[3*e+1]=t.y,this[3*e+2]=t.z,this}setRowXYZ(e,t,r,s){return this[3*e]=t,this[3*e+1]=r,this[3*e+2]=s,this}getCol(e,t){return(t||new h).setXYZ(this[e],this[3+e],this[6+e])}setCol(e,t){return this[e]=t.x,this[3+e]=t.y,this[6+e]=t.z,this}setColXYZ(e,t,r,s){return this[e]=t,this[3+e]=r,this[6+e]=s,this}static add(e,t,r){r=r||new p;for(let s=0;s<9;s++)r[s]=e[s]+t[s];return r}static sub(e,t,r){r=r||new p;for(let s=0;s<9;s++)r[s]=e[s]-t[s];return r}static mul(e,t,r){r=r||new p;for(let s=0;s<9;s++)r[s]=e[s]*t[s];return r}static div(e,t,r){r=r||new p;for(let s=0;s<9;s++)r[s]=e[s]/t[s];return r}static scale(e,t,r){r=r||new p;for(let s=0;s<9;s++)r[s]=e[s]*t;return r}static identity(e){return(e=e||new p).set(n),e}static transpose(e,t){return e===(t=t||new p)?([t[1],t[3]]=[t[3],t[1]],[t[2],t[6]]=[t[6],t[2]],[t[5],t[7]]=[t[7],t[5]]):(t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8]),t}static invert(e,t){t=t||new p;const r=e[0],s=e[1],i=e[2],n=e[3],a=e[4],o=e[5],u=e[6],h=e[7],l=e[8],c=l*a-o*h,f=o*u-l*n,d=h*n-u*a,m=1/(r*c+s*f+i*d);return t[0]=c*m,t[1]=(i*h-l*s)*m,t[2]=(o*s-i*a)*m,t[3]=f*m,t[4]=(l*r-i*u)*m,t[5]=(i*n-o*r)*m,t[6]=d*m,t[7]=(s*u-h*r)*m,t[8]=(a*r-s*n)*m,t}static rotationX(e,t){t=t||new p;const r=Math.cos(e),s=Math.sin(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=r,t[5]=s,t[6]=0,t[7]=-s,t[8]=r,t}static rotationY(e,t){t=t||new p;const r=Math.cos(e),s=Math.sin(e);return t[0]=r,t[1]=0,t[2]=-s,t[3]=0,t[4]=1,t[5]=0,t[6]=s,t[7]=0,t[8]=r,t}static rotationZ(e,t){t=t||new p;const r=Math.cos(e),s=Math.sin(e);return t[0]=r,t[1]=s,t[2]=0,t[3]=-s,t[4]=r,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}static rotation(e,t,r){r=r||new p;let s=e.x,i=e.y,n=e.z;const a=Math.sqrt(s*s+i*i+n*n);s/=a,i/=a,n/=a;const o=s*s,u=i*i,h=n*n,l=Math.cos(t),c=Math.sin(t),f=1-l;return r[0]=o+(1-o)*l,r[1]=s*i*f+n*c,r[2]=s*n*f-i*c,r[3]=s*i*f-n*c,r[4]=u+(1-u)*l,r[5]=i*n*f+s*c,r[6]=s*n*f+i*c,r[7]=i*n*f-s*c,r[8]=h+(1-h)*l,r}static multiply(e,t,r){r=r||new p;const s=e[0],i=e[1],n=e[2],a=e[3],o=e[4],u=e[5],h=e[6],l=e[7],c=e[8],f=t[0],d=t[1],m=t[2],_=t[3],g=t[4],x=t[5],y=t[6],b=t[7],T=t[8];return r[0]=s*f+a*d+h*m,r[1]=i*f+o*d+l*m,r[2]=n*f+u*d+c*m,r[3]=s*_+a*g+h*x,r[4]=i*_+o*g+l*x,r[5]=n*_+u*g+c*x,r[6]=s*y+a*b+h*T,r[7]=i*y+o*b+l*T,r[8]=n*y+u*b+c*T,r}subBy(e){return p.sub(this,e,this)}addBy(e){return p.add(this,e,this)}mulBy(e){return p.mul(this,e,this)}divBy(e){return p.div(this,e,this)}scaleBy(e){return p.scale(this,e,this)}identity(){return p.identity(this)}inplaceInvert(){return p.invert(this,this)}transpose(){return p.transpose(this,this)}multiplyRight(e){return p.multiply(this,e,this)}multiplyLeft(e){return p.multiply(e,this,this)}rotationX(e){return p.rotationX(e,this)}rotationY(e){return p.rotationY(e,this)}rotationZ(e){return p.rotationZ(e,this)}rotation(e,t){return p.rotation(e,t,this)}transform(e,t){return(t=t||new h).setXYZ(this[0]*e[0]+this[3]*e[1]+this[6]*e[2],this[1]*e[0]+this[4]*e[1]+this[7]*e[2],this[2]*e[0]+this[5]*e[1]+this[8]*e[2])}transformPoint(e,t){return this.transform(e,t)}transformVector(e,t){return this.transform(e,t)}}class f extends o{constructor(e,t,r,s,i,n,a,o,u,h,l,f,d,m,_,g){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,16);else if(super(16),"number"==typeof e)this[0]=e,this[1]=t,this[2]=r,this[3]=s,this[4]=i,this[5]=n,this[6]=a,this[7]=o,this[8]=u,this[9]=h,this[10]=l,this[11]=f,this[12]=d,this[13]=m,this[14]=_,this[15]=g;else if(e instanceof c)e.toMatrix4x4(this),this.m03=0,this.m13=0,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=1;else if(e instanceof p)this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=0,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=0,this.m20=e.m20,this.m21=e.m21,this.m22=e.m22,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=1;else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=16)this.set(e);else{if(void 0!==e)throw new Error("Matrix4x4.constructor(): invalid arguments");this.identity()}}clone(){return new f(this)}get m00(){return this[0]}set m00(e){this[0]=e}get m10(){return this[1]}set m10(e){this[1]=e}get m20(){return this[2]}set m20(e){this[2]=e}get m30(){return this[3]}set m30(e){this[3]=e}get m01(){return this[4]}set m01(e){this[4]=e}get m11(){return this[5]}set m11(e){this[5]=e}get m21(){return this[6]}set m21(e){this[6]=e}get m31(){return this[7]}set m31(e){this[7]=e}get m02(){return this[8]}set m02(e){this[8]=e}get m12(){return this[9]}set m12(e){this[9]=e}get m22(){return this[10]}set m22(e){this[10]=e}get m32(){return this[11]}set m32(e){this[11]=e}get m03(){return this[12]}set m03(e){this[12]=e}get m13(){return this[13]}set m13(e){this[13]=e}get m23(){return this[14]}set m23(e){this[14]=e}get m33(){return this[15]}set m33(e){this[15]=e}getRow(e,t){return(t||new l).setXYZW(this[4*e],this[4*e+1],this[4*e+2],this[4*e+3])}setRow(e,t){return this[4*e]=t.x,this[4*e+1]=t.y,this[4*e+2]=t.z,this[4*e+3]=t.w,this}setRowXYZW(e,t,r,s,i){return this[4*e]=t,this[4*e+1]=r,this[4*e+2]=s,this[4*e+3]=i,this}getCol(e,t){return(t||new l).setXYZW(this[e],this[4+e],this[8+e],this[12+e])}setCol(e,t){return this[e]=t.x,this[4+e]=t.y,this[8+e]=t.z,this[12+e]=t.w,this}setColXYZW(e,t,r,s,i){return this[e]=t,this[4+e]=r,this[8+e]=s,this[12+e]=i,this}static add(e,t,r){r=r||new f;for(let s=0;s<16;s++)r[s]=e[s]+t[s];return r}static sub(e,t,r){r=r||new f;for(let s=0;s<16;s++)r[s]=e[s]-t[s];return r}static mul(e,t,r){r=r||new f;for(let s=0;s<16;s++)r[s]=e[s]*t[s];return r}static div(e,t,r){r=r||new f;for(let s=0;s<16;s++)r[s]=e[s]/t[s];return r}static scale(e,t,r){r=r||new f;for(let s=0;s<16;s++)r[s]=e[s]*t;return r}static identity(e){return(e=e||new f).set(a),e}static ortho(e,t,r,s,i,n,a){return(a=a||new f)[0]=2/(t-e),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(s-r),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2/(i-n),a[11]=0,a[12]=(e+t)/(e-t),a[13]=(r+s)/(r-s),a[14]=(i+n)/(i-n),a[15]=1,a}static reflection(e,t,r,s,i){return(i=i||new f).m00=1-2*e*e,i.m01=-2*e*t,i.m02=-2*e*r,i.m03=-2*e*s,i.m10=-2*e*t,i.m11=1-2*t*t,i.m12=-2*t*r,i.m13=-2*t*s,i.m20=-2*e*r,i.m21=-2*t*r,i.m22=1-2*r*r,i.m23=-2*r*s,i.m30=0,i.m31=0,i.m32=0,i.m33=1,i}static perspective(e,t,r,s,i){const n=r*Math.tan(.5*e),a=n*t;return this.frustum(-a,a,-n,n,r,s,i)}static obliqueProjection(e,t){const r=new f(e),s=f.invert(e).transform(new l(t.a>0?1:-1,t.b>0?1:-1,1,1)),i=2/(s.x*t.a+s.y*t.b+s.z*t.c+s.w*t.d);return r[2]=t.a*i-r[3],r[6]=t.b*i-r[7],r[10]=t.c*i-r[11],r[14]=t.d*i-r[15],r}static obliquePerspective(e,t){const r=new f(e),s=new l(((t.x>0?1:t.x<0?-1:0)+e.m02)/e.m00,((t.y>0?1:t.y<0?-1:0)+e.m12)/e.m11,-1,(1+e.m22)/e.m23),i=l.scale(t,2/l.dot(t,s));return r.m20=i.x,r.m21=i.y,r.m22=i.z+1,r.m23=i.w,r}static frustum(e,t,r,s,i,n,a){const o=t-e,u=s-r,h=i-n;return(a=a||new f)[0]=2*i/o,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*i/u,a[6]=0,a[7]=0,a[8]=(e+t)/o,a[9]=(s+r)/u,a[10]=(i+n)/h,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*i*n/h,a[15]=0,a}static transpose(e,t){return e===(t=t||new f)?([t[1],t[4]]=[t[4],t[1]],[t[2],t[8]]=[t[8],t[2]],[t[3],t[12]]=[t[12],t[3]],[t[6],t[9]]=[t[9],t[6]],[t[7],t[13]]=[t[13],t[7]],[t[11],t[14]]=[t[14],t[11]]):(t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]),t}static invert(e,t){t=t||new f;const r=e[0],s=e[1],i=e[2],n=e[3],a=e[4],o=e[5],u=e[6],h=e[7],l=e[8],c=e[9],p=e[10],d=e[11],m=e[12],_=e[13],g=e[14],x=e[15],y=p*x,b=g*d,T=u*x,w=g*h,v=u*d,E=p*h,C=i*x,S=g*n,$=i*d,A=p*n,L=i*h,I=u*n,B=l*_,D=m*c,O=a*_,F=m*o,M=a*c,R=l*o,V=r*_,G=m*s,P=r*c,N=l*s,U=r*o,z=a*s,k=y*o+w*c+v*_-(b*o+T*c+E*_),W=b*s+C*c+A*_-(y*s+S*c+$*_),X=T*s+S*o+L*_-(w*s+C*o+I*_),Y=E*s+$*o+I*c-(v*s+A*o+L*c),j=1/(r*k+a*W+l*X+m*Y);return t[0]=j*k,t[1]=j*W,t[2]=j*X,t[3]=j*Y,t[4]=j*(b*a+T*l+E*m-(y*a+w*l+v*m)),t[5]=j*(y*r+S*l+$*m-(b*r+C*l+A*m)),t[6]=j*(w*r+C*a+I*m-(T*r+S*a+L*m)),t[7]=j*(v*r+A*a+L*l-(E*r+$*a+I*l)),t[8]=j*(B*h+F*d+M*x-(D*h+O*d+R*x)),t[9]=j*(D*n+V*d+N*x-(B*n+G*d+P*x)),t[10]=j*(O*n+G*h+U*x-(F*n+V*h+z*x)),t[11]=j*(R*n+P*h+z*d-(M*n+N*h+U*d)),t[12]=j*(O*p+R*g+D*u-(M*g+B*u+F*p)),t[13]=j*(P*g+B*i+G*p-(V*p+N*g+D*i)),t[14]=j*(V*u+z*g+F*i-(U*g+O*i+G*u)),t[15]=j*(U*p+M*i+N*u-(P*u+z*p+R*i)),t}static invertAffine(e,t){t=t||new f;const r=e[0],s=e[1],i=e[2],n=e[4],a=e[5],o=e[6],u=e[8],h=e[9],l=e[10],c=e[12],p=e[13],d=e[14],m=l*a-o*h,_=i*h-l*s,g=o*s-i*a,x=1/(r*m+n*_+u*g);return t[0]=x*m,t[1]=x*_,t[2]=x*g,t[3]=0,t[4]=x*(o*u-l*n),t[5]=x*(l*r-i*u),t[6]=x*(i*n-o*r),t[7]=0,t[8]=x*(n*h-u*a),t[9]=x*(u*s-r*h),t[10]=x*(r*a-n*s),t[11]=0,t[12]=x*(n*p*l+u*a*d+c*h*o-(n*h*d+u*p*o+c*a*l)),t[13]=x*(r*h*d+u*p*i+c*s*l-(r*p*l+u*s*d+c*h*i)),t[14]=x*(r*p*o+n*s*d+c*a*i-(r*a*d+n*p*i+c*s*o)),t[15]=1,t}static translation(e,t){return(t=t||new f)[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e.x,t[13]=e.y,t[14]=e.z,t[15]=1,t}static scaling(e,t){return(t=t||new f)[0]=e.x,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e.y,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e.z,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static rotationX(e,t){t=t||new f;const r=Math.cos(e),s=Math.sin(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=s,t[7]=0,t[8]=0,t[9]=-s,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static rotationY(e,t){t=t||new f;const r=Math.cos(e),s=Math.sin(e);return t[0]=r,t[1]=0,t[2]=-s,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=s,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static rotationZ(e,t){t=t||new f;const r=Math.cos(e),s=Math.sin(e);return t[0]=r,t[1]=s,t[2]=0,t[3]=0,t[4]=-s,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static rotation(e,t,r){r=r||new f;let s=e.x,i=e.y,n=e.z;const a=Math.sqrt(s*s+i*i+n*n);s/=a,i/=a,n/=a;const o=s*s,u=i*i,h=n*n,l=Math.cos(t),c=Math.sin(t),p=1-l;return r[0]=o+(1-o)*l,r[1]=s*i*p+n*c,r[2]=s*n*p-i*c,r[3]=0,r[4]=s*i*p-n*c,r[5]=u+(1-u)*l,r[6]=i*n*p+s*c,r[7]=0,r[8]=s*n*p+i*c,r[9]=i*n*p-s*c,r[10]=h+(1-h)*l,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}static lookAt(e,t,r,s){s=s||new f;const i=h.normalize(h.sub(e,t)),n=h.normalize(h.cross(r,i)),a=h.normalize(h.cross(i,n));return s[0]=n.x,s[1]=n.y,s[2]=n.z,s[3]=0,s[4]=a.x,s[5]=a.y,s[6]=a.z,s[7]=0,s[8]=i.x,s[9]=i.y,s[10]=i.z,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,s}static lookAtCubeFace(e,t,r){switch(e){case i.PX:return this.lookAt(t,new h(t.x+1,t.y,t.z),new h(0,-1,0),r);case i.NX:return this.lookAt(t,new h(t.x-1,t.y,t.z),new h(0,-1,0),r);case i.PY:return this.lookAt(t,new h(t.x,t.y+1,t.z),new h(0,0,1),r);case i.NY:return this.lookAt(t,new h(t.x,t.y-1,t.z),new h(0,0,-1),r);case i.PZ:return this.lookAt(t,new h(t.x,t.y,t.z+1),new h(0,-1,0),r);case i.NZ:return this.lookAt(t,new h(t.x,t.y,t.z-1),new h(0,-1,0),r);default:return null}}static multiply(e,t,r){r=r||new f;const s=e[0],i=e[1],n=e[2],a=e[3],o=e[4],u=e[5],h=e[6],l=e[7],c=e[8],p=e[9],d=e[10],m=e[11],_=e[12],g=e[13],x=e[14],y=e[15],b=t[0],T=t[1],w=t[2],v=t[3],E=t[4],C=t[5],S=t[6],$=t[7],A=t[8],L=t[9],I=t[10],B=t[11],D=t[12],O=t[13],F=t[14],M=t[15];return r[0]=s*b+o*T+c*w+_*v,r[1]=i*b+u*T+p*w+g*v,r[2]=n*b+h*T+d*w+x*v,r[3]=a*b+l*T+m*w+y*v,r[4]=s*E+o*C+c*S+_*$,r[5]=i*E+u*C+p*S+g*$,r[6]=n*E+h*C+d*S+x*$,r[7]=a*E+l*C+m*S+y*$,r[8]=s*A+o*L+c*I+_*B,r[9]=i*A+u*L+p*I+g*B,r[10]=n*A+h*L+d*I+x*B,r[11]=a*A+l*L+m*I+y*B,r[12]=s*D+o*O+c*F+_*M,r[13]=i*D+u*O+p*F+g*M,r[14]=n*D+h*O+d*F+x*M,r[15]=a*D+l*O+m*F+y*M,r}static multiplyAffine(e,t,r){r=r||new f;const s=e[0],i=e[1],n=e[2],a=e[4],o=e[5],u=e[6],h=e[8],l=e[9],c=e[10],p=e[12],d=e[13],m=e[14],_=t[0],g=t[1],x=t[2],y=t[4],b=t[5],T=t[6],w=t[8],v=t[9],E=t[10],C=t[12],S=t[13],$=t[14];return r[0]=s*_+a*g+h*x,r[1]=i*_+o*g+l*x,r[2]=n*_+u*g+c*x,r[3]=0,r[4]=s*y+a*b+h*T,r[5]=i*y+o*b+l*T,r[6]=n*y+u*b+c*T,r[7]=0,r[8]=s*w+a*v+h*E,r[9]=i*w+o*v+l*E,r[10]=n*w+u*v+c*E,r[11]=0,r[12]=s*C+a*S+h*$+p,r[13]=i*C+o*S+l*$+d,r[14]=n*C+u*S+c*$+m,r[15]=1,r}static translateRight(e,t,r){if((r=r||new f)!==e)r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12],r[13]=e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13],r[14]=e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14],r[15]=e[15];else{const s=e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12],i=e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13],n=e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14];r[12]=s,r[13]=i,r[14]=n}return r}static translateLeft(e,t,r){return(r=r||new f)!==e?(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12]+t.x,r[13]=e[13]+t.y,r[14]=e[14]+t.z,r[15]=e[15]):(r[12]+=t.x,r[13]+=t.y,r[14]+=t.z),r}static scaleRight(e,t,r){return(r=r||new f)!==e?(r[0]=e[0]*t.x,r[1]=e[1]*t.x,r[2]=e[2]*t.x,r[3]=e[3]*t.x,r[4]=e[4]*t.y,r[5]=e[5]*t.y,r[6]=e[6]*t.y,r[7]=e[7]*t.y,r[8]=e[8]*t.z,r[9]=e[9]*t.z,r[10]=e[10]*t.z,r[11]=e[11]*t.z,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):(r[0]*=t.x,r[1]*=t.x,r[2]*=t.x,r[3]*=t.x,r[4]*=t.y,r[5]*=t.y,r[6]*=t.y,r[7]*=t.y,r[8]*=t.z,r[9]*=t.z,r[10]*=t.z,r[11]*=t.z),r}static scaleLeft(e,t,r){return(r=r||new f)!==e?(r[0]=e[0]*t.x,r[1]=e[1]*t.y,r[2]=e[2]*t.z,r[3]=e[3],r[4]=e[4]*t.x,r[5]=e[5]*t.y,r[6]=e[6]*t.z,r[7]=e[7],r[8]=e[8]*t.x,r[9]=e[9]*t.y,r[10]=e[10]*t.z,r[11]=e[11],r[12]=e[12]*t.x,r[13]=e[13]*t.y,r[14]=e[14]*t.z,r[15]=e[15]):(r[0]*=t.x,r[1]*=t.y,r[2]*=t.z,r[4]*=t.x,r[5]*=t.y,r[6]*=t.z,r[8]*=t.x,r[9]*=t.y,r[10]*=t.z,r[12]*=t.x,r[13]*=t.y,r[14]*=t.z),r}static rotateRight(e,t,r){r=r||new f;const s=t instanceof c?new p(t):t,i=e[0],n=e[1],a=e[2],o=e[3],u=e[4],h=e[5],l=e[6],d=e[7],m=e[8],_=e[9],g=e[10],x=e[11],y=e[12],b=e[13],T=e[14],w=e[15],v=s.m00,E=s.m10,C=s.m20,S=s.m01,$=s.m11,A=s.m21,L=s.m02,I=s.m12,B=s.m22;return r[0]=i*v+u*E+m*C,r[1]=n*v+h*E+_*C,r[2]=a*v+l*E+g*C,r[3]=o*v+d*E+x*C,r[4]=i*S+u*$+m*A,r[5]=n*S+h*$+_*A,r[6]=a*S+l*$+g*A,r[7]=o*S+d*$+x*A,r[8]=i*L+u*I+m*B,r[9]=n*L+h*I+_*B,r[10]=a*L+l*I+g*B,r[11]=o*L+d*I+x*B,r[12]=y,r[13]=b,r[14]=T,r[15]=w,r}static rotateLeft(e,t,r){r=r||new f;const s=t instanceof c?new p(t):t,i=s.m00,n=s.m10,a=s.m20,o=s.m01,u=s.m11,h=s.m21,l=s.m02,d=s.m12,m=s.m22,_=e[0],g=e[1],x=e[2],y=e[3],b=e[4],T=e[5],w=e[6],v=e[7],E=e[8],C=e[9],S=e[10],$=e[11],A=e[12],L=e[13],I=e[14],B=e[15];return r[0]=i*_+o*g+l*x,r[1]=n*_+u*g+d*x,r[2]=a*_+h*g+m*x,r[3]=y,r[4]=i*b+o*T+l*w,r[5]=n*b+u*T+d*w,r[6]=a*b+h*T+m*w,r[7]=v,r[8]=i*E+o*C+l*S,r[9]=n*E+u*C+d*S,r[10]=a*E+h*C+m*S,r[11]=$,r[12]=i*A+o*L+l*I,r[13]=n*A+u*L+d*I,r[14]=a*A+h*L+m*I,r[15]=B,r}subBy(e){return f.sub(this,e,this)}addBy(e){return f.add(this,e,this)}mulBy(e){return f.mul(this,e,this)}divBy(e){return f.div(this,e,this)}scaleBy(e){return f.scale(this,e,this)}identity(){return f.identity(this)}perspective(e,t,r,s){return f.perspective(e,t,r,s,this)}frustum(e,t,r,s,i,n){return f.frustum(e,t,r,s,i,n,this)}ortho(e,t,r,s,i,n){return f.ortho(e,t,r,s,i,n,this)}isOrtho(){return 1===this[15]}isPerspective(){return 0===this[15]}getNearPlaneWidth(){return this.isPerspective()?2*this.getNearPlane()/this[0]:2/this[0]}getNearPlaneHeight(){return this.isPerspective()?2*this.getNearPlane()/this[5]:2/this[5]}getNearPlane(){return this.isPerspective()?this[14]/(this[10]-1):(this[14]+1)/this[10]}getFarPlaneWidth(){return this.isPerspective()?this.getNearPlaneWidth()*this.getFarPlane()/this.getNearPlane():this.getNearPlaneWidth()}getFarPlaneHeight(){return this.isPerspective()?this.getNearPlaneHeight()*this.getFarPlane()/this.getNearPlane():this.getNearPlaneHeight()}getFarPlane(){return this.isPerspective()?this[14]/(this[10]+1):(this[14]-1)/this[10]}getFov(){return this.isOrtho()?0:2*Math.atan(1/this[5])}getTanHalfFov(){return this.isOrtho()?0:1/this[5]}getAspect(){return this[5]/this[0]}getLeftPlane(){return(-1-this[12])/this[0]}getRightPlane(){return(1-this[12])/this[0]}getTopPlane(){return(1-this[13])/this[5]}getBottomPlane(){return(-1-this[13])/this[5]}setNearFar(e,t){return this.isPerspective()?this.perspective(this.getFov(),this.getAspect(),e,t):(this[10]=2/(e-t),this[14]=(e+t)/(e-t)),this}translation(e){return f.translation(e,this)}scaling(e){return f.scaling(e,this)}inplaceInvert(){return f.invert(this,this)}inplaceInvertAffine(){return f.invertAffine(this,this)}transpose(){return f.transpose(this,this)}multiplyRight(e){return f.multiply(this,e,this)}multiplyRightAffine(e){return f.multiplyAffine(this,e,this)}multiplyLeft(e){return f.multiply(e,this,this)}multiplyLeftAffine(e){return f.multiplyAffine(e,this,this)}rotationX(e){return f.rotationX(e,this)}rotationY(e){return f.rotationY(e,this)}rotationZ(e){return f.rotationZ(e,this)}rotation(e,t){return f.rotation(e,t,this)}translateRight(e){return f.translateRight(this,e,this)}translateLeft(e){return f.translateLeft(this,e,this)}scaleRight(e){return f.scaleRight(this,e,this)}scaleLeft(e){return f.scaleLeft(this,e,this)}rotateRight(e){return f.rotateRight(this,e,this)}rotateLeft(e){return f.rotateLeft(this,e,this)}lookAt(e,t,r){return f.lookAt(e,t,r,this)}transformPoint(e,t){return(t=t||new l).setXYZW(this[0]*e[0]+this[4]*e[1]+this[8]*e[2]+this[12],this[1]*e[0]+this[5]*e[1]+this[9]*e[2]+this[13],this[2]*e[0]+this[6]*e[1]+this[10]*e[2]+this[14],this[3]*e[0]+this[7]*e[1]+this[11]*e[2]+this[15])}transformPointP(e,t){t=t||new h;const r=this[0]*e[0]+this[4]*e[1]+this[8]*e[2]+this[12],s=this[1]*e[0]+this[5]*e[1]+this[9]*e[2]+this[13],i=this[2]*e[0]+this[6]*e[1]+this[10]*e[2]+this[14],n=this[3]*e[0]+this[7]*e[1]+this[11]*e[2]+this[15];return t.setXYZ(r/n,s/n,i/n)}transformPointAffine(e,t){return(t=t||new h).setXYZ(this[0]*e[0]+this[4]*e[1]+this[8]*e[2]+this[12],this[1]*e[0]+this[5]*e[1]+this[9]*e[2]+this[13],this[2]*e[0]+this[6]*e[1]+this[10]*e[2]+this[14])}transformVector(e,t){return(t=t||new l).setXYZW(this[0]*e[0]+this[4]*e[1]+this[8]*e[2],this[1]*e[0]+this[5]*e[1]+this[9]*e[2],this[2]*e[0]+this[6]*e[1]+this[10]*e[2],this[3]*e[0]+this[7]*e[1]+this[11]*e[2])}transformVectorAffine(e,t){return(t=t||new h).setXYZ(this[0]*e[0]+this[4]*e[1]+this[8]*e[2],this[1]*e[0]+this[5]*e[1]+this[9]*e[2],this[2]*e[0]+this[6]*e[1]+this[10]*e[2])}transform(e,t){return(t=t||new l).setXYZW(this[0]*e[0]+this[4]*e[1]+this[8]*e[2]+this[12]*e[3],this[1]*e[0]+this[5]*e[1]+this[9]*e[2]+this[13]*e[3],this[2]*e[0]+this[6]*e[1]+this[10]*e[2]+this[14]*e[3],this[3]*e[0]+this[7]*e[1]+this[11]*e[2]+this[15]*e[3])}transformAffine(e,t){return(t=t||new l).setXYZW(this[0]*e[0]+this[4]*e[1]+this[8]*e[2]+this[12]*e[3],this[1]*e[0]+this[5]*e[1]+this[9]*e[2]+this[13]*e[3],this[2]*e[0]+this[6]*e[1]+this[10]*e[2]+this[14]*e[3],e.w)}det(){const e=this[0],t=this[1],r=this[2],s=this[3],i=this[4],n=this[5],a=this[6],o=this[7],u=this[8],h=this[9],l=this[10],c=this[11],p=this[12],f=this[13],d=this[14],m=this[15],_=l*m-d*c,g=h*m-f*c,x=h*d-f*l,y=u*m-p*c,b=u*d-l*p,T=u*f-p*h;return e*+(n*_-a*g+o*x)+t*-(i*_-a*y+o*b)+r*+(i*g-n*y+o*T)+s*-(i*x-n*b+a*T)}decompose(e,t,r){r&&r.setXYZ(this[12],this[13],this[14]);const s=this.det()<=0?-1:1,i=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),n=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6])*s,a=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]);if(e&&e.setXYZ(i,n,a),t instanceof c){const e=new p(this);e[0]/=i,e[1]/=i,e[2]/=i,e[3]/=n,e[4]/=n,e[5]/=n,e[6]/=a,e[7]/=a,e[8]/=a,t.fromRotationMatrix(e)}else t instanceof p?(t[0]=this[0]/i,t[1]=this[1]/i,t[2]=this[2]/i,t[3]=this[4]/n,t[4]=this[5]/n,t[5]=this[6]/n,t[6]=this[8]/a,t[7]=this[9]/a,t[8]=this[10]/a):t instanceof f&&(t[0]=this[0]/i,t[1]=this[1]/i,t[2]=this[2]/i,t[3]=0,t[4]=this[4]/n,t[5]=this[5]/n,t[6]=this[6]/n,t[7]=0,t[8]=this[8]/a,t[9]=this[9]/a,t[10]=this[10]/a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1);return this}decomposeLookAt(e,t,r){return e&&e.setXYZ(this[12],this[13],this[14]),r&&r.setXYZ(this[4],this[5],this[6]),t&&t.setXYZ(this[12]-this[8],this[13]-this[9],this[14]-this[10]),this}toDualQuaternion(){const e=new h,t=new c,r=new h;this.decompose(r,t,e);const s=new c(.5*this.m03,.5*this.m13,.5*this.m23,0);return{real:t,dual:c.multiply(s,t),scale:r}}}class d{_bins;_maxBins;_width;_height;constructor(e,t,r=0){this._width=e,this._height=t,this._maxBins=r,this._bins=[new m(this._width,this._height)]}clear(){this._bins=[new m(this._width,this._height)]}insert(e,t){if(e>this._width||t>this._height)return null;const r=this._bins[this._bins.length-1].insert(e,t);if(r)return{x:r.x,y:r.y,width:r.width,height:r.height,binIndex:this._bins.length-1};if(0===this._maxBins||this._bins.length<this._maxBins){this._bins.push(new m(this._width,this._height));const r=this._bins[this._bins.length-1].insert(e,t);return{x:r.x,y:r.y,width:r.width,height:r.height,binIndex:this._bins.length-1}}return null}}class m{freeRects;constructor(e,t){this.freeRects=[{x:0,y:0,width:e,height:t}]}insert(e,t){const r=this.findBestFit(e,t);if(!r)return null;let s=this.freeRects.length,i=0;for(;i<s;)this.splitFreeRect(this.freeRects[i],r)&&(this.freeRects.splice(i,1),--s,--i),++i;return this.pruneFreeRects(),r}findBestFit(e,t){let r=Number.MAX_VALUE,s=null;for(const i of this.freeRects)if(i.width>=e&&i.height>=t){const n=i.width*i.height-e*t;n<r&&(s||(s={width:e,height:t}),s.x=i.x,s.y=i.y,r=n)}return s}splitFreeRect(e,t){return!(t.x>=e.x+e.width||t.x+t.width<=e.x||t.y>=e.y+e.height||t.y+t.height<=e.y)&&(t.x<e.x+e.width&&t.x+t.width>e.x&&(t.y>e.y&&t.y<e.y+e.height&&this.freeRects.push({x:e.x,y:e.y,width:e.width,height:t.y-e.y}),t.y+t.height<e.y+e.height&&this.freeRects.push({x:e.x,y:t.y+t.height,width:e.width,height:e.y+e.height-t.y-t.height})),t.y<e.y+e.height&&t.y+t.height>e.y&&(t.x>e.x&&t.x<e.x+e.width&&this.freeRects.push({x:e.x,y:e.y,width:t.x-e.x,height:e.height}),t.x+t.width<e.x+e.width&&this.freeRects.push({x:t.x+t.width,y:e.y,width:e.x+e.width-t.x-t.width,height:e.height})),!0)}pruneFreeRects(){let e=0,t=0,r=this.freeRects.length;for(;e<r;){t=e+1;const s=this.freeRects[e];for(;t<r;){const i=this.freeRects[t];if(this.isRectInRect(s,i)){this.freeRects.splice(e,1),--e,--r;break}this.isRectInRect(i,s)&&(this.freeRects.splice(t,1),--t,--r),t++}e++}}isRectInRect(e,t){return e.x>=t.x&&e.y>=t.y&&e.x+e.width<=t.x+t.width&&e.y+e.height<=t.y+t.height}}const _=16777216,g=33554432,x=50331648,y=67108864,b=83886080,T=100663296,w=117440512,v=134217728;function E(e,t,r,s,i,n,a,o,u,h,l,c,p,f,d){return e|((t?1:0)|(r?2:0)|(s?4:0)|(i?8:0))|((n?16:0)|(a?32:0))|(o?64:0)|(u?128:0)|(h?256:0)|(l?512:0)|(c?1024:0)|(p<<16|f<<20|d<<11)}const C={unknown:0,r8unorm:E(0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,1,1,1),r8snorm:E(0,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,1,1,1),r16f:E(0,!0,!1,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,2),r32f:E(0,!0,!1,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,4),r8ui:E(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,1),r8i:E(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,1),r16ui:E(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,2),r16i:E(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,2),r32ui:E(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,4),r32i:E(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,4),rg8unorm:E(0,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,1,1,2),rg8snorm:E(0,!0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,1,1,2),rg16f:E(0,!0,!0,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,4),rg32f:E(0,!0,!0,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,8),rg8ui:E(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,2),rg8i:E(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,2),rg16ui:E(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,4),rg16i:E(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,4),rg32ui:E(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,8),rg32i:E(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,8),rgba8unorm:E(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,1,1,4),"rgba8unorm-srgb":E(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,1,1,4),rgba8snorm:E(0,!0,!0,!0,!0,!1,!1,!1,!1,!0,!1,!1,1,1,4),bgra8unorm:E(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!0,1,1,4),"bgra8unorm-srgb":E(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!0,1,1,4),rgba16f:E(0,!0,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1,1,1,8),rgba32f:E(0,!0,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1,1,1,16),rgba8ui:E(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,4),rgba8i:E(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,4),rgba16ui:E(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,8),rgba16i:E(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,8),rgba32ui:E(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,16),rgba32i:E(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,16),rg11b10uf:E(0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,!1,1,1,4),d16:E(0,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,1,1,2),d24:E(0,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,0,0,0),d32f:E(0,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!1,1,1,4),d24s8:E(0,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,1,1,4),d32fs8:E(0,!1,!1,!1,!1,!0,!0,!0,!1,!0,!1,!1,1,1,5),dxt1:E(_,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,8),"dxt1-srgb":E(_,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,8),dxt3:E(g,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"dxt3-srgb":E(g,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),dxt5:E(x,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"dxt5-srgb":E(x,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),bc4:E(y,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,4,4,8),"bc4-signed":E(y,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,4,4,8),bc5:E(b,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,4,4,16),"bc5-signed":E(b,!0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,4,4,16),bc6h:E(T,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,!1,4,4,16),"bc6h-signed":E(T,!0,!0,!0,!1,!1,!1,!0,!1,!0,!1,!1,4,4,16),bc7:E(w,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"bc7-srgb":E(w,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),"astc-4x4":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"astc-4x4-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),"astc-5x4":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,5,4,16),"astc-5x4-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,5,4,16),"astc-5x5":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,5,5,16),"astc-5x5-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,5,5,16),"astc-6x5":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,6,5,16),"astc-6x5-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,6,5,16),"astc-6x6":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,6,6,16),"astc-6x6-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,6,6,16),"astc-8x5":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,5,16),"astc-8x5-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,5,16),"astc-8x6":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,6,16),"astc-8x6-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,6,16),"astc-8x8":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,8,16),"astc-8x8-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,8,16),"astc-10x5":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,5,16),"astc-10x5-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,5,16),"astc-10x6":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,6,16),"astc-10x6-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,6,16),"astc-10x8":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,8,16),"astc-10x8-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,8,16),"astc-10x10":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,10,16),"astc-10x10-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,10,16),"astc-12x10":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,12,10,16),"astc-12x10-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,12,10,16),"astc-12x12":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,12,12,16),"astc-12x12-srgb":E(v,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,12,12,16)};function S(e){switch(e){case"rgba8unorm":return"rgba8unorm-srgb";case"bgra8unorm":return"bgra8unorm-srgb";case"dxt1":return"dxt1-srgb";case"dxt3":return"dxt3-srgb";case"dxt5":return"dxt5-srgb";case"bc7":return"bc7-srgb";case"astc-4x4":return"astc-4x4-srgb";case"astc-5x4":return"astc-5x4-srgb";case"astc-5x5":return"astc-5x5-srgb";case"astc-6x5":return"astc-6x5-srgb";case"astc-6x6":return"astc-6x6-srgb";case"astc-8x5":return"astc-8x5-srgb";case"astc-8x6":return"astc-8x6-srgb";case"astc-8x8":return"astc-8x8-srgb";case"astc-10x5":return"astc-10x5-srgb";case"astc-10x6":return"astc-10x6-srgb";case"astc-10x8":return"astc-10x8-srgb";case"astc-10x10":return"astc-10x10-srgb";case"astc-12x10":return"astc-12x10-srgb";case"astc-12x12":return"astc-12x12-srgb";default:return e}}function $(e){return!!(16&C[e])}function A(e){return!!(32&C[e])}function L(e){return!!(128&C[e])}function I(e){return!!(256&C[e])}function B(e){return(63488&C[e])>>11}function D(e){return(983040&C[e])>>16}function O(e){return(15728640&C[e])>>20}var F;!function(e){e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Compute=4]="Compute"}(F||(F={}));class M{static NAME="resize";width;height;type=M.NAME;constructor(e,t){this.width=e,this.height=t}}class R{static NAME="gpuobject_added";object;type=R.NAME;constructor(e){this.object=e}}class V{static NAME="gpuobject_removed";object;type=V.NAME;constructor(e){this.object=e}}class G{static NAME="gpuobject_rename";object;lastName;type=G.NAME;constructor(e,t){this.object=e,this.lastName=t}}function P(e,t){return e+t-1&~(t-1)}function N(e){if(e.isPrimitiveType())return e.isScalarType()?4:1<<Math.min(4,e.cols+1);if(e.isAtomicI32()||e.isAtomicU32())return 4;if(e.isArrayType())return e.elementType.isAnyType()?1:N(e.elementType);{let t=0;for(const r of e.structMembers)t=Math.max(t,N(r.type));return Math.max(t,16)}}function U(e){if(e.isPrimitiveType())return e.isMatrixType()?e.rows*N(ue.getCachedTypeInfo(e.resizeType(1,e.cols))):4*e.cols;if(e.isArrayType())return e.elementType.isAnyType()?0:e.dimension*P(U(e.elementType),N(e.elementType));if(e.isAtomicI32()||e.isAtomicU32())return 4;{let t=0,r=0;for(const s of e.structMembers){const e=N(s.type);t=P(t,e),t+=U(s.type),r=Math.max(r,e)}return P(t,r)}}function z(e){if(e.isPrimitiveType()){let t;switch(e.scalarType){case X.U8:case X.U8_NORM:case X.I8:case X.I8_NORM:t=1;break;case X.F16:case X.I16:case X.I16_NORM:case X.U16:case X.U16_NORM:t=2;break;default:t=4}return e.rows*e.cols*t}if(e.isArrayType())return e.elementType.isAnyType()?0:e.dimension*z(e.elementType);if(e.isAtomicI32()||e.isAtomicU32())return 4;{let t=0;for(const r of e.structMembers)t+=z(r.type);return t}}function k(e,t,r,s){return e|t<<4|r<<7|s<<10}function W(e){return e.isPrimitiveType()?e.scalarType:e.isArrayType()?e.elementType.isAnyType()?null:W(e.elementType):X.U8}var X;!function(e){e[e.NONE=0]="NONE",e[e.F16=k(1,1,1,0)]="F16",e[e.F16VEC2=k(1,1,2,0)]="F16VEC2",e[e.F16VEC3=k(1,1,3,0)]="F16VEC3",e[e.F16VEC4=k(1,1,4,0)]="F16VEC4",e[e.F32=k(2,1,1,0)]="F32",e[e.F32VEC2=k(2,1,2,0)]="F32VEC2",e[e.F32VEC3=k(2,1,3,0)]="F32VEC3",e[e.F32VEC4=k(2,1,4,0)]="F32VEC4",e[e.BOOL=k(3,1,1,0)]="BOOL",e[e.BVEC2=k(3,1,2,0)]="BVEC2",e[e.BVEC3=k(3,1,3,0)]="BVEC3",e[e.BVEC4=k(3,1,4,0)]="BVEC4",e[e.I8=k(4,1,1,0)]="I8",e[e.I8VEC2=k(4,1,2,0)]="I8VEC2",e[e.I8VEC3=k(4,1,3,0)]="I8VEC3",e[e.I8VEC4=k(4,1,4,0)]="I8VEC4",e[e.I8_NORM=k(4,1,1,1)]="I8_NORM",e[e.I8VEC2_NORM=k(4,1,2,1)]="I8VEC2_NORM",e[e.I8VEC3_NORM=k(4,1,3,1)]="I8VEC3_NORM",e[e.I8VEC4_NORM=k(4,1,4,1)]="I8VEC4_NORM",e[e.I16=k(5,1,1,0)]="I16",e[e.I16VEC2=k(5,1,2,0)]="I16VEC2",e[e.I16VEC3=k(5,1,3,0)]="I16VEC3",e[e.I16VEC4=k(5,1,4,0)]="I16VEC4",e[e.I16_NORM=k(5,1,1,1)]="I16_NORM",e[e.I16VEC2_NORM=k(5,1,2,1)]="I16VEC2_NORM",e[e.I16VEC3_NORM=k(5,1,3,1)]="I16VEC3_NORM",e[e.I16VEC4_NORM=k(5,1,4,1)]="I16VEC4_NORM",e[e.I32=k(6,1,1,0)]="I32",e[e.I32VEC2=k(6,1,2,0)]="I32VEC2",e[e.I32VEC3=k(6,1,3,0)]="I32VEC3",e[e.I32VEC4=k(6,1,4,0)]="I32VEC4",e[e.I32_NORM=k(6,1,1,1)]="I32_NORM",e[e.I32VEC2_NORM=k(6,1,2,1)]="I32VEC2_NORM",e[e.I32VEC3_NORM=k(6,1,3,1)]="I32VEC3_NORM",e[e.I32VEC4_NORM=k(6,1,4,1)]="I32VEC4_NORM",e[e.U8=k(7,1,1,0)]="U8",e[e.U8VEC2=k(7,1,2,0)]="U8VEC2",e[e.U8VEC3=k(7,1,3,0)]="U8VEC3",e[e.U8VEC4=k(7,1,4,0)]="U8VEC4",e[e.U8_NORM=k(7,1,1,1)]="U8_NORM",e[e.U8VEC2_NORM=k(7,1,2,1)]="U8VEC2_NORM",e[e.U8VEC3_NORM=k(7,1,3,1)]="U8VEC3_NORM",e[e.U8VEC4_NORM=k(7,1,4,1)]="U8VEC4_NORM",e[e.U16=k(8,1,1,0)]="U16",e[e.U16VEC2=k(8,1,2,0)]="U16VEC2",e[e.U16VEC3=k(8,1,3,0)]="U16VEC3",e[e.U16VEC4=k(8,1,4,0)]="U16VEC4",e[e.U16_NORM=k(8,1,1,1)]="U16_NORM",e[e.U16VEC2_NORM=k(8,1,2,1)]="U16VEC2_NORM",e[e.U16VEC3_NORM=k(8,1,3,1)]="U16VEC3_NORM",e[e.U16VEC4_NORM=k(8,1,4,1)]="U16VEC4_NORM",e[e.U32=k(9,1,1,0)]="U32",e[e.U32VEC2=k(9,1,2,0)]="U32VEC2",e[e.U32VEC3=k(9,1,3,0)]="U32VEC3",e[e.U32VEC4=k(9,1,4,0)]="U32VEC4",e[e.U32_NORM=k(9,1,1,1)]="U32_NORM",e[e.U32VEC2_NORM=k(9,1,2,1)]="U32VEC2_NORM",e[e.U32VEC3_NORM=k(9,1,3,1)]="U32VEC3_NORM",e[e.U32VEC4_NORM=k(9,1,4,1)]="U32VEC4_NORM",e[e.MAT2=k(2,2,2,0)]="MAT2",e[e.MAT2x3=k(2,2,3,0)]="MAT2x3",e[e.MAT2x4=k(2,2,4,0)]="MAT2x4",e[e.MAT3x2=k(2,3,2,0)]="MAT3x2",e[e.MAT3=k(2,3,3,0)]="MAT3",e[e.MAT3x4=k(2,3,4,0)]="MAT3x4",e[e.MAT4x2=k(2,4,2,0)]="MAT4x2",e[e.MAT4x3=k(2,4,3,0)]="MAT4x3",e[e.MAT4=k(2,4,4,0)]="MAT4"}(X||(X={}));const Y={[X.F32]:"float",[X.F32VEC2]:"vec2",[X.F32VEC3]:"vec3",[X.F32VEC4]:"vec4",[X.BOOL]:"bool",[X.BVEC2]:"bvec2",[X.BVEC3]:"bvec3",[X.BVEC4]:"bvec4",[X.I32]:"int",[X.I32VEC2]:"ivec2",[X.I32VEC3]:"ivec3",[X.I32VEC4]:"ivec4",[X.U32]:"uint",[X.U32VEC2]:"uvec2",[X.U32VEC3]:"uvec3",[X.U32VEC4]:"uvec4",[X.MAT2]:"mat2",[X.MAT2x3]:"mat2x3",[X.MAT2x4]:"mat2x4",[X.MAT3x2]:"mat3x2",[X.MAT3]:"mat3",[X.MAT3x4]:"mat3x4",[X.MAT4x2]:"mat4x2",[X.MAT4x3]:"mat4x3",[X.MAT4]:"mat4"},j={[X.F32]:"f32",[X.F32VEC2]:"vec2<f32>",[X.F32VEC3]:"vec3<f32>",[X.F32VEC4]:"vec4<f32>",[X.BOOL]:"bool",[X.BVEC2]:"vec2<bool>",[X.BVEC3]:"vec3<bool>",[X.BVEC4]:"vec4<bool>",[X.I32]:"i32",[X.I32VEC2]:"vec2<i32>",[X.I32VEC3]:"vec3<i32>",[X.I32VEC4]:"vec4<i32>",[X.U32]:"u32",[X.U32VEC2]:"vec2<u32>",[X.U32VEC3]:"vec3<u32>",[X.U32VEC4]:"vec4<u32>",[X.MAT2]:"mat2x2<f32>",[X.MAT2x3]:"mat2x3<f32>",[X.MAT2x4]:"mat2x4<f32>",[X.MAT3x2]:"mat3x2<f32>",[X.MAT3]:"mat3x3<f32>",[X.MAT3x4]:"mat3x4<f32>",[X.MAT4x2]:"mat4x2<f32>",[X.MAT4x3]:"mat4x3<f32>",[X.MAT4]:"mat4x4<f32>"},H=16,q=64,Z=128,Q=512,K=1024;var J;!function(e){e[e.TEX_1D=257]="TEX_1D",e[e.ITEX_1D=513]="ITEX_1D",e[e.UTEX_1D=1025]="UTEX_1D",e[e.TEX_2D=258]="TEX_2D",e[e.ITEX_2D=514]="ITEX_2D",e[e.UTEX_2D=1026]="UTEX_2D",e[e.TEX_2D_ARRAY=274]="TEX_2D_ARRAY",e[e.ITEX_2D_ARRAY=530]="ITEX_2D_ARRAY",e[e.UTEX_2D_ARRAY=1042]="UTEX_2D_ARRAY",e[e.TEX_3D=260]="TEX_3D",e[e.ITEX_3D=516]="ITEX_3D",e[e.UTEX_3D=1028]="UTEX_3D",e[e.TEX_CUBE=264]="TEX_CUBE",e[e.ITEX_CUBE=520]="ITEX_CUBE",e[e.UTEX_CUBE=1032]="UTEX_CUBE",e[e.TEX_CUBE_ARRAY=280]="TEX_CUBE_ARRAY",e[e.ITEX_CUBE_ARRAY=536]="ITEX_CUBE_ARRAY",e[e.UTEX_CUBE_ARRAY=1048]="UTEX_CUBE_ARRAY",e[e.TEX_MULTISAMPLED_2D=290]="TEX_MULTISAMPLED_2D",e[e.ITEX_MULTISAMPLED_2D=546]="ITEX_MULTISAMPLED_2D",e[e.UTEX_MULTISAMPLED_2D=1058]="UTEX_MULTISAMPLED_2D",e[e.TEX_STORAGE_1D=65]="TEX_STORAGE_1D",e[e.TEX_STORAGE_2D=66]="TEX_STORAGE_2D",e[e.TEX_STORAGE_2D_ARRAY=82]="TEX_STORAGE_2D_ARRAY",e[e.TEX_STORAGE_3D=68]="TEX_STORAGE_3D",e[e.TEX_DEPTH_2D=130]="TEX_DEPTH_2D",e[e.TEX_DEPTH_2D_ARRAY=146]="TEX_DEPTH_2D_ARRAY",e[e.TEX_DEPTH_CUBE=136]="TEX_DEPTH_CUBE",e[e.TEX_DEPTH_CUBE_ARRAY=152]="TEX_DEPTH_CUBE_ARRAY",e[e.TEX_DEPTH_MULTISAMPLED_2D=162]="TEX_DEPTH_MULTISAMPLED_2D",e[e.TEX_EXTERNAL=2048]="TEX_EXTERNAL"}(J||(J={}));const ee={[J.TEX_1D]:"highp sampler2D",[J.TEX_2D]:"highp sampler2D",[J.TEX_CUBE]:"highp samplerCube",[J.TEX_EXTERNAL]:"highp sampler2D"},te={[J.TEX_1D]:"highp sampler2D",[J.TEX_2D]:"highp sampler2D",[J.ITEX_1D]:"highp isampler2D",[J.ITEX_2D]:"highp isampler2D",[J.UTEX_1D]:"highp usampler2D",[J.UTEX_2D]:"highp usampler2D",[J.TEX_2D_ARRAY]:"highp sampler2DArray",[J.ITEX_2D_ARRAY]:"highp isampler2DArray",[J.UTEX_2D_ARRAY]:"highp usampler2DArray",[J.TEX_3D]:"highp sampler3D",[J.ITEX_3D]:"highp isampler3D",[J.UTEX_3D]:"highp usampler3D",[J.TEX_CUBE]:"highp samplerCube",[J.ITEX_CUBE]:"highp isamplerCube",[J.UTEX_CUBE]:"highp usamplerCube",[J.TEX_DEPTH_2D]:"highp sampler2DShadow",[J.TEX_DEPTH_2D_ARRAY]:"highp sampler2DArrayShadow",[J.TEX_DEPTH_CUBE]:"highp samplerCubeShadow",[J.TEX_EXTERNAL]:"highp sampler2D"},re={[J.TEX_1D]:"texture_1d<f32>",[J.ITEX_1D]:"texture_1d<i32>",[J.UTEX_1D]:"texture_1d<u32>",[J.TEX_2D]:"texture_2d<f32>",[J.ITEX_2D]:"texture_2d<i32>",[J.UTEX_2D]:"texture_2d<u32>",[J.TEX_2D_ARRAY]:"texture_2d_array<f32>",[J.ITEX_2D_ARRAY]:"texture_2d_array<i32>",[J.UTEX_2D_ARRAY]:"texture_2d_array<u32>",[J.TEX_3D]:"texture_3d<f32>",[J.ITEX_3D]:"texture_3d<i32>",[J.UTEX_3D]:"texture_3d<u32>",[J.TEX_CUBE]:"texture_cube<f32>",[J.ITEX_CUBE]:"texture_cube<i32>",[J.UTEX_CUBE]:"texture_cube<u32>",[J.TEX_CUBE_ARRAY]:"texture_cube_array<f32>",[J.ITEX_CUBE_ARRAY]:"texture_cube_array<i32>",[J.UTEX_CUBE_ARRAY]:"texture_cube_array<u32>",[J.TEX_MULTISAMPLED_2D]:"texture_multisampled_2d<f32>",[J.ITEX_MULTISAMPLED_2D]:"texture_multisampled_2d<i32>",[J.UTEX_MULTISAMPLED_2D]:"texture_multisampled_2d<u32>",[J.TEX_STORAGE_1D]:"texture_storage_1d",[J.TEX_STORAGE_2D]:"texture_storage_2d",[J.TEX_STORAGE_2D_ARRAY]:"texture_storage_2d_array",[J.TEX_STORAGE_3D]:"texture_storage_3d",[J.TEX_DEPTH_2D]:"texture_depth_2d",[J.TEX_DEPTH_2D_ARRAY]:"texture_depth_2d_array",[J.TEX_DEPTH_CUBE]:"texture_depth_cube",[J.TEX_DEPTH_CUBE_ARRAY]:"texture_depth_cube_array",[J.TEX_DEPTH_MULTISAMPLED_2D]:"texture_depth_multisampled_2d",[J.TEX_EXTERNAL]:"texture_external"},se={rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",bgra8unorm:"bgra8unorm",rgba8ui:"rgba8uint",rgba8i:"rgba8sint",rgba16ui:"rgba16uint",rgba16i:"rgba16sint",rgba16f:"rgba16float",r32f:"r32float",r32ui:"r32uint",r32i:"r32sint",rg32f:"rg32float",rg32ui:"rg32uint",rg32i:"rg32sint",rgba32f:"rgba32float",rgba32ui:"rgba32uint",rgba32i:"rgba32sint"};var ie,ne,ae;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SAMPLE=1]="SAMPLE",e[e.COMPARISON=2]="COMPARISON"}(ie||(ie={})),function(e){e.UNKNOWN="unknown",e.FUNCTION="function",e.PRIVATE="private",e.WORKGROUP="workgroup",e.UNIFORM="uniform",e.STORAGE="storage"}(ne||(ne={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.PLAIN=1]="PLAIN",e[e.ARRAY=2]="ARRAY",e[e.POINTER=3]="POINTER",e[e.ATOMIC_I32=4]="ATOMIC_I32",e[e.ATOMIC_U32=5]="ATOMIC_U32",e[e.TEXTURE=6]="TEXTURE",e[e.SAMPLER=7]="SAMPLER",e[e.FUNCTION=8]="FUNCTION",e[e.VOID=9]="VOID",e[e.ANY=10]="ANY"}(ae||(ae={}));class oe{cls;detail;id;constructor(e,t){this.cls=e,this.detail=t,this.id=null}get typeId(){return this.id||(this.id=this.genTypeId()),this.id}isVoidType(){return!1}isAnyType(){return!1}isPrimitiveType(){return!1}haveAtomicMembers(){return!1}isStructType(){return!1}isArrayType(){return!1}isPointerType(){return!1}isAtomicI32(){return!1}isAtomicU32(){return!1}isSamplerType(){return!1}isTextureType(){return!1}isHostSharable(){return!1}isConstructible(){return!1}isStorable(){return!1}getConstructorOverloads(e){return[]}isCompatibleType(e){return e.typeId===this.typeId}}class ue extends oe{static cachedTypes={};static cachedCtorOverloads={};constructor(e){super(ae.PLAIN,{primitiveType:e})}static getCachedTypeInfo(e){let t=this.cachedTypes[e];return t||(t=new ue(e),this.cachedTypes[e]=t),t}static getCachedOverloads(e,t){let r=this.cachedCtorOverloads[e];r||(r={},this.cachedCtorOverloads[e]=r);let s=r[t];if(!s){const i=this.getCachedTypeInfo(t),n=i.toTypeName(e);if(s=[new de(n,i,[])],i.isScalarType())s.push(new de(n,i,[{type:this.getCachedTypeInfo(X.F32)}])),s.push(new de(n,i,[{type:this.getCachedTypeInfo(X.I32)}])),s.push(new de(n,i,[{type:this.getCachedTypeInfo(X.U32)}])),s.push(new de(n,i,[{type:this.getCachedTypeInfo(X.BOOL)}]));else if(i.isVectorType()){const e={type:this.getCachedTypeInfo(i.scalarType)},t={type:this.getCachedTypeInfo(i.resizeType(1,2))},r={type:this.getCachedTypeInfo(i.resizeType(1,3))};switch(s.push(new de(n,i,[e])),i.cols){case 2:s.push(new de(n,i,[e,e])),s.push(new de(n,i,[{type:_e}])),s.push(new de(n,i,[{type:we}])),s.push(new de(n,i,[{type:Se}])),s.push(new de(n,i,[{type:Ie}]));break;case 3:s.push(new de(n,i,[e,e,e])),s.push(new de(n,i,[e,t])),s.push(new de(n,i,[t,e])),s.push(new de(n,i,[{type:ge}])),s.push(new de(n,i,[{type:ve}])),s.push(new de(n,i,[{type:$e}])),s.push(new de(n,i,[{type:Be}]));break;case 4:s.push(new de(n,i,[e,e,e,e])),s.push(new de(n,i,[e,e,t])),s.push(new de(n,i,[e,t,e])),s.push(new de(n,i,[t,e,e])),s.push(new de(n,i,[t,t])),s.push(new de(n,i,[e,r])),s.push(new de(n,i,[r,e])),s.push(new de(n,i,[{type:xe}])),s.push(new de(n,i,[{type:Ee}])),s.push(new de(n,i,[{type:Ae}])),s.push(new de(n,i,[{type:De}]))}}else if(i.isMatrixType()){const e=this.getCachedTypeInfo(i.resizeType(1,i.cols));s.push(new de(n,i,Array.from({length:i.rows}).map((()=>({type:e}))))),s.push(new de(n,i,Array.from({length:i.rows*i.cols}).map((()=>({type:me})))))}r[t]=s}return s}get primitiveType(){return this.detail.primitiveType}isInteger(){const e=15&this.primitiveType;return 4===e||7===e||5===e||8===e||6===e||9===e}get scalarType(){return this.resizeType(1,1)}get rows(){return this.primitiveType>>4&7}get cols(){return this.primitiveType>>7&7}get normalized(){return!!(this.primitiveType>>10&1)}getLayoutAlignment(e){return"packed"===e?1:this.isScalarType()?4:1<<Math.min(4,this.cols+1)}getLayoutSize(){return this.getSize()}getSize(){let e;switch(this.scalarType){case X.BOOL:case X.I32:case X.I32_NORM:case X.U32:case X.U32_NORM:case X.F32:e=4;break;case X.F16:case X.I16:case X.I16_NORM:case X.U16:case X.U16_NORM:e=2;break;default:e=1}return e*this.cols*this.rows}resizeType(e,t){return k(15&this.primitiveType,e,t,this.normalized?1:0)}isScalarType(){return 1===this.rows&&1===this.cols}isVectorType(){return 1===this.rows&&this.cols>1}isMatrixType(){return this.rows>1&&this.cols>1}isPrimitiveType(){return!0}isHostSharable(){return this.scalarType!==X.BOOL}isConstructible(){return!0}isStorable(){return!0}getConstructorOverloads(e){return ue.getCachedOverloads(e,this.primitiveType)}toTypeName(e,t){if("webgpu"===e){const e=j[this.primitiveType];return t?`${t}: ${e}`:e}{const e=Y[this.primitiveType];return t?`${e} ${t}`:e}}toBufferLayout(e){return null}genTypeId(){return`PRIM:${this.primitiveType}`}}class he extends oe{constructor(e,t,r){super(ae.PLAIN,{layout:t||"default",structName:e,structMembers:r.map((e=>{const t=N(e.type),r=U(e.type);return{name:e.name,type:e.type,alignment:t,size:r,defaultAlignment:t,defaultSize:r}}))}),"std140"===this.layout?this.calcAlignmentAndSizeSTD140():"std430"===this.layout&&this.calcAlignmentAndSizePacked()}get layout(){return this.detail.layout}get structName(){return this.detail.structName}set structName(e){this.detail.structName=e}get structMembers(){return this.detail.structMembers}haveAtomicMembers(){for(const e of this.structMembers)return!(!e.type.isStructType()||!e.type.haveAtomicMembers())||(!(!e.type.isArrayType()||!e.type.haveAtomicMembers())||(e.type.isAtomicI32()||e.type.isAtomicU32()))}extends(e,t){const r=this.structMembers.map((e=>({name:e.name,type:e.type})));return new he(e,this.layout,[...r,...t])}isStructType(){return!0}isHostSharable(){return this.detail.structMembers.every((e=>e.type.isHostSharable()))}isConstructible(){return this.detail.structMembers.every((e=>e.type.isConstructible()))}isStorable(){return!0}getConstructorOverloads(){const e=[new de(this.structName,this,[])];return this.isConstructible()&&e.push(new de(this.structName,this,this.structMembers.map((e=>({type:e.type}))))),e}toTypeName(e,t){return"webgpu"===e?t?`${t}: ${this.structName}`:this.structName:t?`${this.structName} ${t}`:this.structName}getLayoutAlignment(e){if("packed"===e)return 1;let t=0;for(const r of this.structMembers)t=Math.max(t,r.type.getLayoutAlignment(e));return"std140"===e&&(t=P(t,16)),t}getLayoutSize(e){let t=0,r=0;for(const s of this.structMembers){const i=s.type.getLayoutAlignment(e);t=P(t,i),t+=s.type.getLayoutSize(e),r=Math.max(r,i)}return P(t,r)}toBufferLayout(e,t){const r={byteSize:0,entries:[]},s=e;for(const s of this.structMembers){e=P(e,s.type.getLayoutAlignment(t));const i=s.type.getLayoutSize(t);r.entries.push({name:s.name,offset:e,byteSize:i,type:W(s.type),subLayout:s.type.isStructType()?s.type.toBufferLayout(e,t):null,arraySize:s.type.isArrayType()?s.type.dimension:0}),e+=i}return r.byteSize="std140"===t?P(e-s,16):e-s,r}clone(e){return new he(e||this.structName,this.layout,this.structMembers)}reset(e,t,r){this.detail={layout:t||"default",structName:e,structMembers:r.map((e=>{const t=N(e.type),r=U(e.type);return{name:e.name,type:e.type,alignment:t,size:r,defaultAlignment:t,defaultSize:r}}))},"std140"===this.layout?this.calcAlignmentAndSizeSTD140():"std430"===this.layout&&this.calcAlignmentAndSizePacked(),this.id=null}genTypeId(){return`STRUCT:${this.structName}:${this.layout}:${this.structMembers.map((e=>`${e.name}(${e.type.typeId})`)).join(":")}`}calcAlignmentAndSizeSTD140(){for(const e of this.structMembers)if(e.type.isPrimitiveType()){if(e.type.isMatrixType()&&2===e.type.cols)throw new Error(`matrix${e.type.rows}x${e.type.cols} can not be used in std140 layout`)}else{if(e.type.isArrayType()&&(e.type.elementType.isAnyType()||16!==N(e.type.elementType)))throw new Error("array element must be 16 bytes aligned in std140 layout");e.type.isStructType()&&(e.alignment=16,e.size=P(e.defaultSize,16))}}calcAlignmentAndSizePacked(){for(const e of this.structMembers)e.alignment=(e.type,1),e.size=z(e.type)}}class le extends oe{constructor(e,t){super(ae.ARRAY,{elementType:e,dimension:Number(t)||0})}get elementType(){return this.detail.elementType}get dimension(){return this.detail.dimension}haveAtomicMembers(){return this.elementType.isStructType()||this.elementType.isArrayType()?this.elementType.haveAtomicMembers():this.elementType.isAtomicI32()||this.elementType.isAtomicU32()}isArrayType(){return!0}isHostSharable(){return this.detail.elementType.isHostSharable()}isConstructible(){return this.dimension&&this.detail.elementType.isConstructible()}isStorable(){return!0}getConstructorOverloads(e){const t=this.toTypeName(e),r=[new de(t,this,[])];return"webgl"!==e&&this.isConstructible()&&r.push(new de(t,this,Array.from({length:this.dimension}).map((()=>({type:this.elementType}))))),r}toTypeName(e,t){if("webgpu"===e){const r=`array<${this.elementType.toTypeName(e)}${this.dimension?", "+this.dimension:""}>`;return t?`${t}: ${r}`:r}console.assert(!!this.dimension,"runtime-sized array not supported for webgl"),console.assert(!this.elementType.isArrayType(),"multi-dimensional arrays not supported for webgl");return`${this.elementType.toTypeName(e,t)}[${this.dimension}]`}getLayoutAlignment(e){return"packed"===e||this.elementType.isAnyType()?1:"std430"===e?this.elementType.getLayoutAlignment(e):P(this.elementType.getLayoutAlignment(e),16)}getLayoutSize(e){const t=this.elementType.isAnyType()?1:this.elementType.getLayoutAlignment(e);if("std140"===e&&15&t)throw new Error("Error: array element stride of std140 must be multiple of 16");return this.elementType.isAnyType()?0:this.dimension*P(this.elementType.getLayoutSize(e),t)}toBufferLayout(e){return null}isCompatibleType(e){return!!e.isArrayType()&&((0===this.dimension||e.dimension===this.dimension)&&this.elementType.isCompatibleType(e.elementType))}genTypeId(){return`ARRAY:(${this.elementType.typeId})[${this.dimension}]`}}class ce extends oe{writable;constructor(e,t){super(ae.POINTER,{pointerType:e,addressSpace:t}),console.assert(e.isStorable(),"the pointee type must be storable"),this.writable=!1}get pointerType(){return this.detail.pointerType}get addressSpace(){return this.detail.addressSpace}set addressSpace(e){this.detail.addressSpace!==e&&(this.detail.addressSpace=e,this.id=null)}haveAtomicMembers(){return this.pointerType.haveAtomicMembers()}isPointerType(){return!0}toTypeName(e,t){if("webgpu"===e){const r=this.addressSpace===ne.UNKNOWN?ne.FUNCTION:this.addressSpace,s=r===ne.STORAGE&&this.writable?", read_write":"",i=`ptr<${r}, ${this.pointerType.toTypeName(e)} ${s}>`;return t?`${t}: ${i}`:i}throw new Error("pointer type not supported for webgl")}toBufferLayout(e){return null}genTypeId(){return`PTR:(${this.pointerType.typeId})`}}class pe extends oe{constructor(e){super(ae.SAMPLER,{accessMode:e})}get accessMode(){return this.detail.accessMode}isSamplerType(){return!0}isStorable(){return!0}toTypeName(e,t){if("webgpu"===e){const e=this.accessMode===ie.SAMPLE?"sampler":"sampler_comparison";return t?`${t}: ${e}`:e}throw new Error("sampler type not supported for webgl")}toBufferLayout(e){return null}genTypeId(){return`SAMPLER:${this.accessMode}`}}class fe extends oe{constructor(e,t,r,s){super(ae.TEXTURE,{textureType:e,readable:r,writable:s,storageTexelFormat:t||null}),console.assert(!!re[e],"unsupported texture type"),console.assert(!(e&q&&!se[t]),"invalid texel format for storage texture")}get textureType(){return this.detail.textureType}get storageTexelFormat(){return this.detail.storageTexelFormat}get readable(){return this.detail.readable}set readable(e){this.detail.readable=!!e}get writable(){return this.detail.writable}set writable(e){this.detail.writable=!!e}isStorable(){return!0}is1DTexture(){return!!(1&this.detail.textureType)}is2DTexture(){return!!(2&this.detail.textureType)}is3DTexture(){return!!(4&this.detail.textureType)}isCubeTexture(){return!!(8&this.detail.textureType)}isArrayTexture(){return!!(this.detail.textureType&H)}isStorageTexture(){return!!(this.detail.textureType&q)}isDepthTexture(){return!!(this.detail.textureType&Z)}isMultisampledTexture(){return!!(32&this.detail.textureType)}isExternalTexture(){return!!(2048&this.detail.textureType)}isIntTexture(){return!!(this.detail.textureType&Q)}isUIntTexture(){return!!(this.detail.textureType&K)}isTextureType(){return!0}toTypeName(e,t){if("webgpu"===e){let e=re[this.textureType];if(this.isStorageTexture()){e=`${e}<${se[this.storageTexelFormat]}, ${this.writable?this.readable?"read_write":"write":"read"}>`}return t?`${t}: ${e}`:e}{const r=("webgl"===e?ee:te)[this.textureType];return console.assert(!!r,"unsupported texture type"),t?`${r} ${t}`:r}}toBufferLayout(e){return null}genTypeId(){return`TEXTURE:${this.textureType}`}}class de extends oe{constructor(e,t,r){super(ae.FUNCTION,{name:e,returnType:t,argTypes:r})}get name(){return this.detail.name}get returnType(){return this.detail.returnType}get argTypes(){return this.detail.argTypes}get argHash(){return this.argTypes.map((e=>e.type.typeId)).join(",")}genTypeId(){return`fn(${this.argHash}):${this.returnType.typeId}`}toBufferLayout(e){return null}toTypeName(e,t){throw new Error("not supported")}}ue.getCachedTypeInfo(X.F16),ue.getCachedTypeInfo(X.F16VEC2),ue.getCachedTypeInfo(X.F16VEC3),ue.getCachedTypeInfo(X.F16VEC4);const me=ue.getCachedTypeInfo(X.F32),_e=ue.getCachedTypeInfo(X.F32VEC2),ge=ue.getCachedTypeInfo(X.F32VEC3),xe=ue.getCachedTypeInfo(X.F32VEC4);ue.getCachedTypeInfo(X.I8),ue.getCachedTypeInfo(X.I8VEC2),ue.getCachedTypeInfo(X.I8VEC3),ue.getCachedTypeInfo(X.I8VEC4),ue.getCachedTypeInfo(X.I8_NORM),ue.getCachedTypeInfo(X.I8VEC2_NORM),ue.getCachedTypeInfo(X.I8VEC3_NORM),ue.getCachedTypeInfo(X.I8VEC4_NORM),ue.getCachedTypeInfo(X.I16),ue.getCachedTypeInfo(X.I16VEC2),ue.getCachedTypeInfo(X.I16VEC3),ue.getCachedTypeInfo(X.I16VEC4),ue.getCachedTypeInfo(X.I16_NORM),ue.getCachedTypeInfo(X.I16VEC2_NORM),ue.getCachedTypeInfo(X.I16VEC3_NORM),ue.getCachedTypeInfo(X.I16VEC4_NORM);const ye=new class extends oe{constructor(){super(ae.ATOMIC_I32,null)}haveAtomicMembers(){return!0}isAtomicI32(){return!0}isHostSharable(){return!0}isStorable(){return!0}toTypeName(e,t){if("webgpu"===e){const e="atomic<i32>";return t?`${t}: ${e}`:e}throw new Error("atomic type not supported for webgl")}toBufferLayout(e){return null}getLayoutAlignment(e){return 4}getLayoutSize(){return this.getSize()}getSize(){return 4}genTypeId(){return"ATOMICI32"}},be=new class extends oe{constructor(){super(ae.ATOMIC_U32,null)}haveAtomicMembers(){return!0}isAtomicU32(){return!0}isHostSharable(){return!0}isStorable(){return!0}toTypeName(e,t){if("webgpu"===e){const e="atomic<u32>";return t?`${t}: ${e}`:e}throw new Error("atomic type not supported for webgl")}toBufferLayout(e){return null}getLayoutAlignment(e){return 4}getLayoutSize(){return this.getSize()}getSize(){return 4}genTypeId(){return"ATOMICU32"}},Te=ue.getCachedTypeInfo(X.I32),we=ue.getCachedTypeInfo(X.I32VEC2),ve=ue.getCachedTypeInfo(X.I32VEC3),Ee=ue.getCachedTypeInfo(X.I32VEC4);ue.getCachedTypeInfo(X.I32),ue.getCachedTypeInfo(X.I32VEC2_NORM),ue.getCachedTypeInfo(X.I32VEC3_NORM),ue.getCachedTypeInfo(X.I32VEC4_NORM),ue.getCachedTypeInfo(X.U8),ue.getCachedTypeInfo(X.U8VEC2),ue.getCachedTypeInfo(X.U8VEC3),ue.getCachedTypeInfo(X.U8VEC4),ue.getCachedTypeInfo(X.U8_NORM),ue.getCachedTypeInfo(X.U8VEC2_NORM),ue.getCachedTypeInfo(X.U8VEC3_NORM),ue.getCachedTypeInfo(X.U8VEC4_NORM),ue.getCachedTypeInfo(X.U16),ue.getCachedTypeInfo(X.U16VEC2),ue.getCachedTypeInfo(X.U16VEC3),ue.getCachedTypeInfo(X.U16VEC4),ue.getCachedTypeInfo(X.U16_NORM),ue.getCachedTypeInfo(X.U16VEC2_NORM),ue.getCachedTypeInfo(X.U16VEC3_NORM),ue.getCachedTypeInfo(X.U16VEC4_NORM);const Ce=ue.getCachedTypeInfo(X.U32),Se=ue.getCachedTypeInfo(X.U32VEC2),$e=ue.getCachedTypeInfo(X.U32VEC3),Ae=ue.getCachedTypeInfo(X.U32VEC4);ue.getCachedTypeInfo(X.U32_NORM),ue.getCachedTypeInfo(X.U32VEC2_NORM),ue.getCachedTypeInfo(X.U32VEC3_NORM),ue.getCachedTypeInfo(X.U32VEC4_NORM);const Le=ue.getCachedTypeInfo(X.BOOL),Ie=ue.getCachedTypeInfo(X.BVEC2),Be=ue.getCachedTypeInfo(X.BVEC3),De=ue.getCachedTypeInfo(X.BVEC4),Oe=ue.getCachedTypeInfo(X.MAT2),Fe=ue.getCachedTypeInfo(X.MAT2x3),Me=ue.getCachedTypeInfo(X.MAT2x4),Re=ue.getCachedTypeInfo(X.MAT3x2),Ve=ue.getCachedTypeInfo(X.MAT3),Ge=ue.getCachedTypeInfo(X.MAT3x4),Pe=ue.getCachedTypeInfo(X.MAT4x2),Ne=ue.getCachedTypeInfo(X.MAT4x3),Ue=ue.getCachedTypeInfo(X.MAT4),ze=new fe(J.TEX_1D),ke=new fe(J.ITEX_1D),We=new fe(J.UTEX_1D),Xe=new fe(J.TEX_2D),Ye=new fe(J.ITEX_2D),je=new fe(J.UTEX_2D),He=new fe(J.TEX_2D_ARRAY),qe=new fe(J.ITEX_2D_ARRAY),Ze=new fe(J.UTEX_2D_ARRAY),Qe=new fe(J.TEX_3D),Ke=new fe(J.ITEX_3D),Je=new fe(J.UTEX_3D),et=new fe(J.TEX_CUBE),tt=new fe(J.ITEX_CUBE),rt=new fe(J.UTEX_CUBE),st=new fe(J.TEX_EXTERNAL),it=new fe(J.TEX_CUBE_ARRAY),nt=new fe(J.ITEX_CUBE_ARRAY),at=new fe(J.UTEX_CUBE_ARRAY),ot=new fe(J.TEX_MULTISAMPLED_2D),ut=new fe(J.ITEX_MULTISAMPLED_2D),ht=new fe(J.UTEX_MULTISAMPLED_2D),lt=new fe(J.TEX_STORAGE_1D,"rgba8unorm"),ct=new fe(J.TEX_STORAGE_1D,"rgba8snorm"),pt=new fe(J.TEX_STORAGE_1D,"rgba8unorm"),ft=new fe(J.TEX_STORAGE_1D,"rgba8ui"),dt=new fe(J.TEX_STORAGE_1D,"rgba8i"),mt=new fe(J.TEX_STORAGE_1D,"rgba16ui"),_t=new fe(J.TEX_STORAGE_1D,"rgba16i"),gt=new fe(J.TEX_STORAGE_1D,"rgba16f"),xt=new fe(J.TEX_STORAGE_1D,"rgba32ui"),yt=new fe(J.TEX_STORAGE_1D,"rgba32i"),bt=new fe(J.TEX_STORAGE_1D,"rgba32f"),Tt=new fe(J.TEX_STORAGE_1D,"rg32ui"),wt=new fe(J.TEX_STORAGE_1D,"rg32i"),vt=new fe(J.TEX_STORAGE_1D,"rg32f"),Et=new fe(J.TEX_STORAGE_1D,"r32ui"),Ct=new fe(J.TEX_STORAGE_1D,"r32i"),St=new fe(J.TEX_STORAGE_1D,"r32f"),$t=new fe(J.TEX_STORAGE_2D,"rgba8unorm"),At=new fe(J.TEX_STORAGE_2D,"rgba8snorm"),Lt=new fe(J.TEX_STORAGE_2D,"bgra8unorm"),It=new fe(J.TEX_STORAGE_2D,"rgba8ui"),Bt=new fe(J.TEX_STORAGE_2D,"rgba8i"),Dt=new fe(J.TEX_STORAGE_2D,"rgba16ui"),Ot=new fe(J.TEX_STORAGE_2D,"rgba16i"),Ft=new fe(J.TEX_STORAGE_2D,"rgba16f"),Mt=new fe(J.TEX_STORAGE_2D,"rgba32ui"),Rt=new fe(J.TEX_STORAGE_2D,"rgba32i"),Vt=new fe(J.TEX_STORAGE_2D,"rgba32f"),Gt=new fe(J.TEX_STORAGE_2D,"rg32ui"),Pt=new fe(J.TEX_STORAGE_2D,"rg32i"),Nt=new fe(J.TEX_STORAGE_2D,"rg32f"),Ut=new fe(J.TEX_STORAGE_2D,"r32ui"),zt=new fe(J.TEX_STORAGE_2D,"r32i"),kt=new fe(J.TEX_STORAGE_2D,"r32f"),Wt=new fe(J.TEX_STORAGE_2D_ARRAY,"rgba8unorm"),Xt=new fe(J.TEX_STORAGE_2D_ARRAY,"rgba8snorm");new fe(J.TEX_STORAGE_2D_ARRAY,"bgra8unorm");const Yt=new fe(J.TEX_STORAGE_2D_ARRAY,"rgba8ui"),jt=new fe(J.TEX_STORAGE_2D_ARRAY,"rgba8i"),Ht=new fe(J.TEX_STORAGE_2D_ARRAY,"rgba16ui"),qt=new fe(J.TEX_STORAGE_2D_ARRAY,"rgba16i"),Zt=new fe(J.TEX_STORAGE_2D_ARRAY,"rgba16f"),Qt=new fe(J.TEX_STORAGE_2D_ARRAY,"rgba32ui"),Kt=new fe(J.TEX_STORAGE_2D_ARRAY,"rgba32i"),Jt=new fe(J.TEX_STORAGE_2D_ARRAY,"rgba32f"),er=new fe(J.TEX_STORAGE_2D_ARRAY,"rg32ui"),tr=new fe(J.TEX_STORAGE_2D_ARRAY,"rg32i"),rr=new fe(J.TEX_STORAGE_2D_ARRAY,"rg32f"),sr=new fe(J.TEX_STORAGE_2D_ARRAY,"r32ui"),ir=new fe(J.TEX_STORAGE_2D_ARRAY,"r32i"),nr=new fe(J.TEX_STORAGE_2D_ARRAY,"r32f"),ar=new fe(J.TEX_STORAGE_3D,"rgba8unorm"),or=new fe(J.TEX_STORAGE_3D,"rgba8snorm"),ur=new fe(J.TEX_STORAGE_3D,"bgra8unorm"),hr=new fe(J.TEX_STORAGE_3D,"rgba8ui"),lr=new fe(J.TEX_STORAGE_3D,"rgba8i"),cr=new fe(J.TEX_STORAGE_3D,"rgba16ui"),pr=new fe(J.TEX_STORAGE_3D,"rgba16i"),fr=new fe(J.TEX_STORAGE_3D,"rgba16f"),dr=new fe(J.TEX_STORAGE_3D,"rgba32ui"),mr=new fe(J.TEX_STORAGE_3D,"rgba32i"),_r=new fe(J.TEX_STORAGE_3D,"rgba32f"),gr=new fe(J.TEX_STORAGE_3D,"rg32ui"),xr=new fe(J.TEX_STORAGE_3D,"rg32i"),yr=new fe(J.TEX_STORAGE_3D,"rg32f"),br=new fe(J.TEX_STORAGE_3D,"r32ui"),Tr=new fe(J.TEX_STORAGE_3D,"r32i"),wr=new fe(J.TEX_STORAGE_3D,"r32f"),vr=new fe(J.TEX_DEPTH_2D),Er=new fe(J.TEX_DEPTH_2D_ARRAY),Cr=new fe(J.TEX_DEPTH_CUBE),Sr=new fe(J.TEX_DEPTH_CUBE_ARRAY),$r=new fe(J.TEX_DEPTH_MULTISAMPLED_2D),Ar=new pe(ie.SAMPLE),Lr=new pe(ie.COMPARISON),Ir=new class extends oe{constructor(){super(ae.VOID,null)}isVoidType(){return!0}toTypeName(e,t){return"void"}genTypeId(){return"void"}toBufferLayout(e){return null}};new class extends oe{constructor(){super(ae.ANY,null)}isAnyType(){return!0}toTypeName(e,t){return"any"}genTypeId(){return"any"}toBufferLayout(e){return null}isCompatibleType(e){return!0}};const Br=new he("FrexpResult","default",[{name:"sig",type:me},{name:"exp",type:Te}]),Dr=new he("FrexpResultVec2","default",[{name:"sig",type:_e},{name:"exp",type:we}]),Or=new he("FrexpResultVec3","default",[{name:"sig",type:ge},{name:"exp",type:ve}]),Fr=new he("FrexpResultVec4","default",[{name:"sig",type:xe},{name:"exp",type:Ee}]),Mr=10,Rr=11,Vr=12,Gr=13,Pr={position_u8normx2:[0,X.U8VEC2_NORM,2,"u8norm",2],position_u8normx4:[0,X.U8VEC4_NORM,4,"u8norm",4],position_i8normx2:[0,X.I8VEC2_NORM,2,"i8norm",2],position_i8normx4:[0,X.I8VEC4_NORM,4,"i8norm",4],position_u16x2:[0,X.U16VEC2,4,"u16",2],position_u16x4:[0,X.U16VEC4,8,"u16",4],position_i16x2:[0,X.I16VEC2,4,"i16",2],position_i16x4:[0,X.I16VEC4,8,"i16",4],position_u16normx2:[0,X.U16VEC2_NORM,4,"u16norm",2],position_u16normx4:[0,X.U16VEC4_NORM,8,"u16norm",4],position_i16normx2:[0,X.I16VEC2_NORM,4,"i16norm",2],position_i16normx4:[0,X.I16VEC4_NORM,8,"i16norm",4],position_f16x2:[0,X.F16VEC2,4,"f16",2],position_f16x4:[0,X.F16VEC4,8,"f16",4],position_f32:[0,X.F32,4,"f32",1],position_f32x2:[0,X.F32VEC2,8,"f32",2],position_f32x3:[0,X.F32VEC3,12,"f32",3],position_f32x4:[0,X.F32VEC4,16,"f32",4],position_i32:[0,X.I32,4,"i32",1],position_i32x2:[0,X.I32VEC2,8,"i32",2],position_i32x3:[0,X.I32VEC3,12,"i32",3],position_i32x4:[0,X.I32VEC4,16,"i32",4],position_u32:[0,X.U32,4,"u32",1],position_u32x2:[0,X.U32VEC2,8,"u32",2],position_u32x3:[0,X.U32VEC3,12,"u32",3],position_u32x4:[0,X.U32VEC4,16,"u32",4],normal_f16x4:[1,X.F16VEC4,8,"f16",4],normal_f32x3:[1,X.F32VEC3,12,"f32",3],normal_f32x4:[1,X.F32VEC4,16,"f32",4],diffuse_u8normx4:[2,X.U8VEC4_NORM,4,"u8norm",4],diffuse_u16x4:[2,X.U16VEC4,8,"u16",4],diffuse_u16normx4:[2,X.U16VEC4_NORM,8,"u16norm",4],diffuse_f16x4:[2,X.F16VEC4,8,"f16",4],diffuse_f32x3:[2,X.F32VEC3,12,"f32",3],diffuse_f32x4:[2,X.F32VEC4,16,"f32",4],diffuse_u32x3:[2,X.U32VEC3,12,"u32",3],diffuse_u32x4:[2,X.U32VEC4,16,"u32",4],tangent_f16x4:[3,X.F16VEC4,8,"f16",4],tangent_f32x3:[3,X.F32VEC3,12,"f32",3],tangent_f32x4:[3,X.F32VEC4,16,"f32",4],tex0_u8normx2:[4,X.U8VEC2_NORM,2,"u8norm",2],tex0_u8normx4:[4,X.U8VEC4_NORM,4,"u8norm",4],tex0_i8normx2:[4,X.I8VEC2_NORM,2,"i8norm",2],tex0_i8normx4:[4,X.I8VEC4_NORM,4,"i8norm",4],tex0_u16x2:[4,X.U16VEC2,4,"u16",2],tex0_u16x4:[4,X.U16VEC4,8,"u16",4],tex0_i16x2:[4,X.I16VEC2,4,"i16",2],tex0_i16x4:[4,X.I16VEC4,8,"i16",4],tex0_u16normx2:[4,X.U16VEC2_NORM,4,"u16norm",2],tex0_u16normx4:[4,X.U16VEC4_NORM,8,"u16norm",4],tex0_i16normx2:[4,X.I16VEC2_NORM,4,"i16norm",2],tex0_i16normx4:[4,X.I16VEC4_NORM,8,"i16norm",4],tex0_f16x2:[4,X.F16VEC2,4,"f16",2],tex0_f16x4:[4,X.F16VEC4,8,"f16",4],tex0_f32:[4,X.F32,4,"f32",1],tex0_f32x2:[4,X.F32VEC2,8,"f32",2],tex0_f32x3:[4,X.F32VEC3,12,"f32",3],tex0_f32x4:[4,X.F32VEC4,16,"f32",4],tex0_i32:[4,X.I32,4,"i32",1],tex0_i32x2:[4,X.I32VEC2,8,"i32",2],tex0_i32x3:[4,X.I32VEC3,12,"i32",3],tex0_i32x4:[4,X.I32VEC4,16,"i32",4],tex0_u32:[4,X.U32,4,"u32",1],tex0_u32x2:[4,X.U32VEC2,8,"u32",2],tex0_u32x3:[4,X.U32VEC3,12,"u32",3],tex0_u32x4:[4,X.U32VEC4,16,"u32",4],tex1_u8normx2:[5,X.U8VEC2_NORM,2,"u8norm",2],tex1_u8normx4:[5,X.U8VEC4_NORM,4,"u8norm",4],tex1_i8normx2:[5,X.I8VEC2_NORM,2,"i8norm",2],tex1_i8normx4:[5,X.I8VEC4_NORM,4,"i8norm",4],tex1_u16x2:[5,X.U16VEC2,4,"u16",2],tex1_u16x4:[5,X.U16VEC4,8,"u16",4],tex1_i16x2:[5,X.I16VEC2,4,"i16",2],tex1_i16x4:[5,X.I16VEC4,8,"i16",4],tex1_u16normx2:[5,X.U16VEC2_NORM,4,"u16norm",2],tex1_u16normx4:[5,X.U16VEC4_NORM,8,"u16norm",4],tex1_i16normx2:[5,X.I16VEC2_NORM,4,"i16norm",2],tex1_i16normx4:[5,X.I16VEC4_NORM,8,"i16norm",4],tex1_f16x2:[5,X.F16VEC2,4,"f16",2],tex1_f16x4:[5,X.F16VEC4,8,"f16",4],tex1_f32:[5,X.F32,4,"f32",1],tex1_f32x2:[5,X.F32VEC2,8,"f32",2],tex1_f32x3:[5,X.F32VEC3,12,"f32",3],tex1_f32x4:[5,X.F32VEC4,16,"f32",4],tex1_i32:[5,X.I32,4,"i32",1],tex1_i32x2:[5,X.I32VEC2,8,"i32",2],tex1_i32x3:[5,X.I32VEC3,12,"i32",3],tex1_i32x4:[5,X.I32VEC4,16,"i32",4],tex1_u32:[5,X.U32,4,"u32",1],tex1_u32x2:[5,X.U32VEC2,8,"u32",2],tex1_u32x3:[5,X.U32VEC3,12,"u32",3],tex1_u32x4:[5,X.U32VEC4,16,"u32",4],tex2_u8normx2:[6,X.U8VEC2_NORM,2,"u8norm",2],tex2_u8normx4:[6,X.U8VEC4_NORM,4,"u8norm",4],tex2_i8normx2:[6,X.I8VEC2_NORM,2,"i8norm",2],tex2_i8normx4:[6,X.I8VEC4_NORM,4,"i8norm",4],tex2_u16x2:[6,X.U16VEC2,4,"u16",2],tex2_u16x4:[6,X.U16VEC4,8,"u16",4],tex2_i16x2:[6,X.I16VEC2,4,"i16",2],tex2_i16x4:[6,X.I16VEC4,8,"i16",4],tex2_u16normx2:[6,X.U16VEC2_NORM,4,"u16norm",2],tex2_u16normx4:[6,X.U16VEC4_NORM,8,"u16norm",4],tex2_i16normx2:[6,X.I16VEC2_NORM,4,"i16norm",2],tex2_i16normx4:[6,X.I16VEC4_NORM,8,"i16norm",4],tex2_f16x2:[6,X.F16VEC2,4,"f16",2],tex2_f16x4:[6,X.F16VEC4,8,"f16",4],tex2_f32:[6,X.F32,4,"f32",1],tex2_f32x2:[6,X.F32VEC2,8,"f32",2],tex2_f32x3:[6,X.F32VEC3,12,"f32",3],tex2_f32x4:[6,X.F32VEC4,16,"f32",4],tex2_i32:[6,X.I32,4,"i32",1],tex2_i32x2:[6,X.I32VEC2,8,"i32",2],tex2_i32x3:[6,X.I32VEC3,12,"i32",3],tex2_i32x4:[6,X.I32VEC4,16,"i32",4],tex2_u32:[6,X.U32,4,"u32",1],tex2_u32x2:[6,X.U32VEC2,8,"u32",2],tex2_u32x3:[6,X.U32VEC3,12,"u32",3],tex2_u32x4:[6,X.U32VEC4,16,"u32",4],tex3_u8normx2:[7,X.U8VEC2_NORM,2,"u8norm",2],tex3_u8normx4:[7,X.U8VEC4_NORM,4,"u8norm",4],tex3_i8normx2:[7,X.I8VEC2_NORM,2,"i8norm",2],tex3_i8normx4:[7,X.I8VEC4_NORM,4,"i8norm",4],tex3_u16x2:[7,X.U16VEC2,4,"u16",2],tex3_u16x4:[7,X.U16VEC4,8,"u16",4],tex3_i16x2:[7,X.I16VEC2,4,"i16",2],tex3_i16x4:[7,X.I16VEC4,8,"i16",4],tex3_u16normx2:[7,X.U16VEC2_NORM,4,"u16norm",2],tex3_u16normx4:[7,X.U16VEC4_NORM,8,"u16norm",4],tex3_i16normx2:[7,X.I16VEC2_NORM,4,"i16norm",2],tex3_i16normx4:[7,X.I16VEC4_NORM,8,"i16norm",4],tex3_f16x2:[7,X.F16VEC2,4,"f16",2],tex3_f16x4:[7,X.F16VEC4,8,"f16",4],tex3_f32:[7,X.F32,4,"f32",1],tex3_f32x2:[7,X.F32VEC2,8,"f32",2],tex3_f32x3:[7,X.F32VEC3,12,"f32",3],tex3_f32x4:[7,X.F32VEC4,16,"f32",4],tex3_i32:[7,X.I32,4,"i32",1],tex3_i32x2:[7,X.I32VEC2,8,"i32",2],tex3_i32x3:[7,X.I32VEC3,12,"i32",3],tex3_i32x4:[7,X.I32VEC4,16,"i32",4],tex3_u32:[7,X.U32,4,"u32",1],tex3_u32x2:[7,X.U32VEC2,8,"u32",2],tex3_u32x3:[7,X.U32VEC3,12,"u32",3],tex3_u32x4:[7,X.U32VEC4,16,"u32",4],tex4_u8normx2:[8,X.U8VEC2_NORM,2,"u8norm",2],tex4_u8normx4:[8,X.U8VEC4_NORM,4,"u8norm",4],tex4_i8normx2:[8,X.I8VEC2_NORM,2,"i8norm",2],tex4_i8normx4:[8,X.I8VEC4_NORM,4,"i8norm",4],tex4_u16x2:[8,X.U16VEC2,4,"u16",2],tex4_u16x4:[8,X.U16VEC4,8,"u16",4],tex4_i16x2:[8,X.I16VEC2,4,"i16",2],tex4_i16x4:[8,X.I16VEC4,8,"i16",4],tex4_u16normx2:[8,X.U16VEC2_NORM,4,"u16norm",2],tex4_u16normx4:[8,X.U16VEC4_NORM,8,"u16norm",4],tex4_i16normx2:[8,X.I16VEC2_NORM,4,"i16norm",2],tex4_i16normx4:[8,X.I16VEC4_NORM,8,"i16norm",4],tex4_f16x2:[8,X.F16VEC2,4,"f16",2],tex4_f16x4:[8,X.F16VEC4,8,"f16",4],tex4_f32:[8,X.F32,4,"f32",1],tex4_f32x2:[8,X.F32VEC2,8,"f32",2],tex4_f32x3:[8,X.F32VEC3,12,"f32",3],tex4_f32x4:[8,X.F32VEC4,16,"f32",4],tex4_i32:[8,X.I32,4,"i32",1],tex4_i32x2:[8,X.I32VEC2,8,"i32",2],tex4_i32x3:[8,X.I32VEC3,12,"i32",3],tex4_i32x4:[8,X.I32VEC4,16,"i32",4],tex4_u32:[8,X.U32,4,"u32",1],tex4_u32x2:[8,X.U32VEC2,8,"u32",2],tex4_u32x3:[8,X.U32VEC3,12,"u32",3],tex4_u32x4:[8,X.U32VEC4,16,"u32",4],tex5_u8normx2:[9,X.U8VEC2_NORM,2,"u8norm",2],tex5_u8normx4:[9,X.U8VEC4_NORM,4,"u8norm",4],tex5_i8normx2:[9,X.I8VEC2_NORM,2,"i8norm",2],tex5_i8normx4:[9,X.I8VEC4_NORM,4,"i8norm",4],tex5_u16x2:[9,X.U16VEC2,4,"u16",2],tex5_u16x4:[9,X.U16VEC4,8,"u16",4],tex5_i16x2:[9,X.I16VEC2,4,"i16",2],tex5_i16x4:[9,X.I16VEC4,8,"i16",4],tex5_u16normx2:[9,X.U16VEC2_NORM,4,"u16norm",2],tex5_u16normx4:[9,X.U16VEC4_NORM,8,"u16norm",4],tex5_i16normx2:[9,X.I16VEC2_NORM,4,"i16norm",2],tex5_i16normx4:[9,X.I16VEC4_NORM,8,"i16norm",4],tex5_f16x2:[9,X.F16VEC2,4,"f16",2],tex5_f16x4:[9,X.F16VEC4,8,"f16",4],tex5_f32:[9,X.F32,4,"f32",1],tex5_f32x2:[9,X.F32VEC2,8,"f32",2],tex5_f32x3:[9,X.F32VEC3,12,"f32",3],tex5_f32x4:[9,X.F32VEC4,16,"f32",4],tex5_i32:[9,X.I32,4,"i32",1],tex5_i32x2:[9,X.I32VEC2,8,"i32",2],tex5_i32x3:[9,X.I32VEC3,12,"i32",3],tex5_i32x4:[9,X.I32VEC4,16,"i32",4],tex5_u32:[9,X.U32,4,"u32",1],tex5_u32x2:[9,X.U32VEC2,8,"u32",2],tex5_u32x3:[9,X.U32VEC3,12,"u32",3],tex5_u32x4:[9,X.U32VEC4,16,"u32",4],tex6_u8normx2:[Mr,X.U8VEC2_NORM,2,"u8norm",2],tex6_u8normx4:[Mr,X.U8VEC4_NORM,4,"u8norm",4],tex6_i8normx2:[Mr,X.I8VEC2_NORM,2,"i8norm",2],tex6_i8normx4:[Mr,X.I8VEC4_NORM,4,"i8norm",4],tex6_u16x2:[Mr,X.U16VEC2,4,"u16",2],tex6_u16x4:[Mr,X.U16VEC4,8,"u16",4],tex6_i16x2:[Mr,X.I16VEC2,4,"i16",2],tex6_i16x4:[Mr,X.I16VEC4,8,"i16",4],tex6_u16normx2:[Mr,X.U16VEC2_NORM,4,"u16norm",2],tex6_u16normx4:[Mr,X.U16VEC4_NORM,8,"u16norm",4],tex6_i16normx2:[Mr,X.I16VEC2_NORM,4,"i16norm",2],tex6_i16normx4:[Mr,X.I16VEC4_NORM,8,"i16norm",4],tex6_f16x2:[Mr,X.F16VEC2,4,"f16",2],tex6_f16x4:[Mr,X.F16VEC4,8,"f16",4],tex6_f32:[Mr,X.F32,4,"f32",1],tex6_f32x2:[Mr,X.F32VEC2,8,"f32",2],tex6_f32x3:[Mr,X.F32VEC3,12,"f32",3],tex6_f32x4:[Mr,X.F32VEC4,16,"f32",4],tex6_i32:[Mr,X.I32,4,"i32",1],tex6_i32x2:[Mr,X.I32VEC2,8,"i32",2],tex6_i32x3:[Mr,X.I32VEC3,12,"i32",3],tex6_i32x4:[Mr,X.I32VEC4,16,"i32",4],tex6_u32:[Mr,X.U32,4,"u32",1],tex6_u32x2:[Mr,X.U32VEC2,8,"u32",2],tex6_u32x3:[Mr,X.U32VEC3,12,"u32",3],tex6_u32x4:[Mr,X.U32VEC4,16,"u32",4],tex7_u8normx2:[Rr,X.U8VEC2_NORM,2,"u8norm",2],tex7_u8normx4:[Rr,X.U8VEC4_NORM,4,"u8norm",4],tex7_i8normx2:[Rr,X.I8VEC2_NORM,2,"i8norm",2],tex7_i8normx4:[Rr,X.I8VEC4_NORM,4,"i8norm",4],tex7_u16x2:[Rr,X.U16VEC2,4,"u16",2],tex7_u16x4:[Rr,X.U16VEC4,8,"u16",4],tex7_i16x2:[Rr,X.I16VEC2,4,"i16",2],tex7_i16x4:[Rr,X.I16VEC4,8,"i16",4],tex7_u16normx2:[Rr,X.U16VEC2_NORM,4,"u16norm",2],tex7_u16normx4:[Rr,X.U16VEC4_NORM,8,"u16norm",4],tex7_i16normx2:[Rr,X.I16VEC2_NORM,4,"i16norm",2],tex7_i16normx4:[Rr,X.I16VEC4_NORM,8,"i16norm",4],tex7_f16x2:[Rr,X.F16VEC2,4,"f16",2],tex7_f16x4:[Rr,X.F16VEC4,8,"f16",4],tex7_f32:[Rr,X.F32,4,"f32",1],tex7_f32x2:[Rr,X.F32VEC2,8,"f32",2],tex7_f32x3:[Rr,X.F32VEC3,12,"f32",3],tex7_f32x4:[Rr,X.F32VEC4,16,"f32",4],tex7_i32:[Rr,X.I32,4,"i32",1],tex7_i32x2:[Rr,X.I32VEC2,8,"i32",2],tex7_i32x3:[Rr,X.I32VEC3,12,"i32",3],tex7_i32x4:[Rr,X.I32VEC4,16,"i32",4],tex7_u32:[Rr,X.U32,4,"u32",1],tex7_u32x2:[Rr,X.U32VEC2,8,"u32",2],tex7_u32x3:[Rr,X.U32VEC3,12,"u32",3],tex7_u32x4:[Rr,X.U32VEC4,16,"u32",4],blendweights_f16x1:[Vr,X.F16,2,"f16",1],blendweights_f32x1:[Vr,X.F32,4,"f32",1],blendweights_f16x2:[Vr,X.F16VEC2,4,"f16",2],blendweights_f32x2:[Vr,X.F32VEC2,8,"f32",2],blendweights_f16x3:[Vr,X.F16VEC3,6,"f16",3],blendweights_f32x3:[Vr,X.F32VEC3,12,"f32",3],blendweights_f16x4:[Vr,X.F16VEC4,8,"f16",4],blendweights_f32x4:[Vr,X.F32VEC4,16,"f32",4],blendindices_u16x1:[Gr,X.U16,2,"u16",1],blendindices_f16x1:[Gr,X.F16,2,"f16",1],blendindices_f32x1:[Gr,X.F32,4,"f32",1],blendindices_u32x1:[Gr,X.U32,4,"u32",1],blendindices_u16x2:[Gr,X.U16VEC2,4,"u16",2],blendindices_f16x2:[Gr,X.F16VEC2,4,"f16",2],blendindices_f32x2:[Gr,X.F32VEC2,8,"f32",2],blendindices_u32x2:[Gr,X.U32VEC2,8,"u32",2],blendindices_u16x3:[Gr,X.U16VEC3,6,"u16",3],blendindices_f16x3:[Gr,X.F16VEC3,6,"f16",3],blendindices_f32x3:[Gr,X.F32VEC3,12,"f32",3],blendindices_u32x3:[Gr,X.U32VEC3,12,"u32",3],blendindices_u16x4:[Gr,X.U16VEC4,8,"u16",4],blendindices_f16x4:[Gr,X.F16VEC4,8,"f16",4],blendindices_f32x4:[Gr,X.F32VEC4,16,"f32",4],blendindices_u32x4:[Gr,X.U32VEC4,16,"u32",4]},Nr={position:0,normal:1,diffuse:2,tangent:3,blendIndices:Gr,blendWeights:Vr,texCoord0:4,texCoord1:5,texCoord2:6,texCoord3:7,texCoord4:8,texCoord5:9,texCoord6:Mr,texCoord7:Rr},Ur={0:"position",1:"normal",2:"diffuse",3:"tangent",[Gr]:"blendIndices",[Vr]:"blendWeights",4:"texCoord0",5:"texCoord1",6:"texCoord2",7:"texCoord3",8:"texCoord4",9:"texCoord5",[Mr]:"texCoord6",[Rr]:"texCoord7"};var zr;function kr(e){return Nr[e]}function Wr(e){return Ur[e]}function Xr(e){return Pr[e][2]}function Yr(e){const t=e.structMembers[0].type.elementType;if(t.isStructType()){let e=0;for(const r of t.structMembers)e+=r.type.getSize();return e}return t.getSize()}function jr(e,t){const r=Wr(t);return r?function(e,t){const r=e.structMembers[0],s=r.type.elementType;if(s.isStructType()){for(const e of s.structMembers)if(e.name===t)return e.type;return null}return r.name===t?s:null}(e,r):null}function Hr(e,...t){if(0===t.length)return null;if(1===t.length){const r=Pr[t[0]];return new he(null,"packed",[{name:Wr(r[0]),type:new le(ue.getCachedTypeInfo(r[1]),e)}])}{const r=new he(null,"packed",t.map((e=>({name:Wr(Pr[e][0]),type:ue.getCachedTypeInfo(Pr[e][1])}))));return new he(null,"packed",[{name:"value",type:new le(r,e)}])}}function qr(e){switch(e){case 0:return"a_position";case 1:return"a_normal";case 2:return"a_diffuse";case 3:return"a_tangent";case 4:return"a_texcoord0";case 5:return"a_texcoord1";case 6:return"a_texcoord2";case 7:return"a_texcoord3";case 8:return"a_texcoord4";case 9:return"a_texcoord5";case Mr:return"a_texcoord6";case Rr:return"a_texcoord7";case Gr:return"a_indices";case Vr:return"a_weight";default:return null}}!function(e){e[e.TF_LINEAR_COLOR_SPACE=2]="TF_LINEAR_COLOR_SPACE",e[e.TF_NO_MIPMAP=4]="TF_NO_MIPMAP",e[e.TF_WRITABLE=8]="TF_WRITABLE",e[e.TF_NO_GC=16]="TF_NO_GC",e[e.BF_VERTEX=32]="BF_VERTEX",e[e.BF_INDEX=64]="BF_INDEX",e[e.BF_READ=128]="BF_READ",e[e.BF_WRITE=256]="BF_WRITE",e[e.BF_UNIFORM=512]="BF_UNIFORM",e[e.BF_STORAGE=1024]="BF_STORAGE",e[e.DYNAMIC=2048]="DYNAMIC",e[e.MANAGED=4096]="MANAGED"}(zr||(zr={}));class Zr{_vertexBuffers;_indexBuffer;_drawOffset;constructor(){this._vertexBuffers=[];for(let e=0;e<16;e++)this._vertexBuffers.push(null);this._indexBuffer=null,this._drawOffset=0}clone(){const e=new Zr;return e._vertexBuffers=this._vertexBuffers.slice(),e._indexBuffer=this._indexBuffer,e._drawOffset=this._drawOffset,e}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}getDrawOffset(){return this._drawOffset}setDrawOffset(e){e!==this._drawOffset&&(this._drawOffset=e)}getVertexBuffer(e){return this._vertexBuffers[kr(e)]?.buffer??null}getVertexBufferInfo(e){return this._vertexBuffers[kr(e)]??null}getIndexBuffer(){return this._indexBuffer||null}setVertexBuffer(e,t){if(!(e&&e.usage&zr.BF_VERTEX))throw new Error("setVertexBuffer() failed: buffer is null or buffer has not Vertex usage flag");t=t||"vertex";const r=e.structure.structMembers[0].type.elementType;if(r.isStructType()){let s=0;for(const i of r.structMembers){const r=kr(i.name);this.internalSetVertexBuffer(r,e,s,t),s+=i.size}}else{const r=kr(e.structure.structMembers[0].name);this.internalSetVertexBuffer(r,e,0,t)}return e}removeVertexBuffer(e){let t=!1;for(let r=0;r<this._vertexBuffers.length;r++){const s=this._vertexBuffers[r];s?.buffer===e&&(this._vertexBuffers[r]=null,t=!0)}return t}setIndexBuffer(e){return e!==this._indexBuffer&&(this._indexBuffer=e||null),e}internalSetVertexBuffer(e,t,r,s){if(e<0||e>=16)throw new Error(`setVertexBuffer() failed: location out of bounds: ${e}`);r=Number(r)||0,s=s||"vertex";const i=this._vertexBuffers[e];return i&&i.buffer===t&&i.offset===r&&i.stepMode===s?null:(this._vertexBuffers[e]={buffer:t,offset:r,type:jr(t.structure,e),stride:Yr(t.structure),drawOffset:0,stepMode:s},t)}}class Qr{_cpuTimer;_cpuStart;_cpuTime;_ended;constructor(){this._cpuTimer=window.performance||window.Date,this._cpuTime=null,this._ended=!1}now(){return this._cpuTimer.now()}begin(){this._cpuStart=this.now(),this._cpuTime=null,this._ended=!1}end(){this._cpuTime=this.now()-this._cpuStart,this._ended=!0}ended(){return this._ended}elapsed(){return this._cpuTime}}function Kr(e,t){return"number"==typeof t||"boolean"==typeof t||Array.isArray(t)?`${t}`:t.$ast?.toString(e)}function Jr(e,t){return t?.toTypeName(e)}class es extends Error{}class ts extends es{value;constructor(e){super(),this.value=e}getMessage(e){return`value out of range: ${this.value}`}}class rs extends es{value;valueType;expectedType;constructor(e,t,r){super(),this.value=e,this.valueType=t,this.expectedType=r}getMessage(e){return`cannot convert '${"string"==typeof this.value?this.value:Kr(e,this.value)}' of type '${"string"==typeof this.valueType?this.valueType:Jr(e,this.valueType)}' to type ${"string"==typeof this.expectedType?this.expectedType:Jr(e,this.expectedType)}`}}class ss extends es{func;constructor(e){super(),this.func=e}getMessage(e){return`wrong argument count for function '${this.func}'`}}class is extends es{func;param;constructor(e,t){super(),this.func=e,this.param=t||null}getMessage(e){return`parameter type error for function '${this.func}': ${this.param}`}}class ns extends es{func;param;reason;constructor(e,t,r){super(),this.func=e,this.param=t||null,this.reason=r||null}getMessage(e){return`invalid parameter value for function '${this.func}'${this.param?": "+this.param:""}${this.reason?": "+this.reason:""}}`}}class as extends es{func;constructor(e){super(),this.func=e}getMessage(e){return`No matched overloading found for function '${this.func}'`}}class os extends es{value;constructor(e){super(),this.value=e}getMessage(e){return`'${Kr(e,this.value)}' is not a reference type`}}class us extends es{value;constructor(e){super(),this.value=e}getMessage(e){return`'${Kr(e,this.value)}' is not a pointer type`}}class hs extends es{feature;constructor(e){super(),this.feature=e}getMessage(e){return`feature not support for ${e} device: ${this.feature}`}}class ls extends es{funcName;constructor(e){super(),this.funcName=e}getMessage(e){return`function call must be made inside a function scope: ${this.funcName}()`}}class cs extends es{ast;text;constructor(e,t){super(),this.ast=e,this.text=t}getMessage(e){return`${this.text}: ${this.ast.toString(e)}`}}class ps extends es{constructor(e){super(e)}getMessage(e){return`Internal error: ${this.message}`}}const fs="zVSInput",ds="zVSOutput",ms="zFSInput",_s="zFSOutput",gs="zCSInput";var xs,ys;function bs(e){switch(e){case F.Vertex:return"zVertexInput";case F.Fragment:return"zVertexOutput";case F.Compute:return"zComputeInput";default:return null}}function Ts(e){switch(e){case F.Vertex:return"zVSInputCpy";case F.Fragment:return"zFSInputCpy";case F.Compute:return"zCSInputCpy";default:return null}}function ws(e){switch(e){case F.Vertex:return"zVSOutputCpy";case F.Fragment:return"zFSOutputCpy";case F.Compute:return"zCSOutputCpy";default:return null}}function vs(e){switch(e){case F.Vertex:return fs;case F.Fragment:return ms;case F.Compute:return gs;default:return null}}function Es(e,t){return`ch_auto_sampler_${e}${t?"_comparison":""}`}!function(e){e[e.DECLARE_TYPE_NONE=0]="DECLARE_TYPE_NONE",e[e.DECLARE_TYPE_IN=1]="DECLARE_TYPE_IN",e[e.DECLARE_TYPE_OUT=2]="DECLARE_TYPE_OUT",e[e.DECLARE_TYPE_WORKGROUP=3]="DECLARE_TYPE_WORKGROUP",e[e.DECLARE_TYPE_UNIFORM=4]="DECLARE_TYPE_UNIFORM",e[e.DECLARE_TYPE_STORAGE=5]="DECLARE_TYPE_STORAGE"}(xs||(xs={})),function(e){e[e.NONE=0]="NONE",e[e.HIGH=1]="HIGH",e[e.MEDIUM=2]="MEDIUM",e[e.LOW=3]="LOW"}(ys||(ys={}));const Cs={webgl:{position:{name:"gl_Position",type:new ue(X.F32VEC4),stage:"vertex"},pointSize:{name:"gl_PointSize",type:new ue(X.F32),stage:"vertex"},fragCoord:{name:"gl_FragCoord",type:new ue(X.F32VEC4),stage:"fragment"},frontFacing:{name:"gl_FrontFacing",type:new ue(X.BOOL),stage:"fragment"},fragDepth:{name:"gl_FragDepthEXT",type:new ue(X.F32),inOrOut:"out",extension:"GL_EXT_frag_depth",stage:"fragment"}},webgl2:{vertexIndex:{name:"gl_VertexID",semantic:"vertex_index",type:new ue(X.U32),inOrOut:"in",stage:"vertex"},instanceIndex:{name:"gl_InstanceID",semantic:"instance_index",type:new ue(X.U32),inOrOut:"in",stage:"vertex"},position:{name:"gl_Position",type:new ue(X.F32VEC4),stage:"vertex"},pointSize:{name:"gl_PointSize",type:new ue(X.F32),stage:"vertex"},fragCoord:{name:"gl_FragCoord",type:new ue(X.F32VEC4),stage:"fragment"},frontFacing:{name:"gl_FrontFacing",type:new ue(X.BOOL),stage:"fragment"},fragDepth:{name:"gl_FragDepth",type:new ue(X.F32),stage:"fragment"}},webgpu:{vertexIndex:{name:"zVertexId",semantic:"vertex_index",type:new ue(X.U32),inOrOut:"in",stage:"vertex"},instanceIndex:{name:"zInstanceId",semantic:"instance_index",type:new ue(X.U32),inOrOut:"in",stage:"vertex"},position:{name:"zPosition",semantic:"position",type:new ue(X.F32VEC4),inOrOut:"out",stage:"vertex"},fragCoord:{name:"zFragCoord",semantic:"position",type:new ue(X.F32VEC4),inOrOut:"in",stage:"fragment"},frontFacing:{name:"zFrontFacing",semantic:"front_facing",type:new ue(X.BOOL),inOrOut:"in",stage:"fragment"},fragDepth:{name:"zFragDepth",semantic:"frag_depth",type:new ue(X.F32),inOrOut:"out",stage:"fragment"},localInvocationId:{name:"zLocalInvocationId",semantic:"local_invocation_id",type:new ue(X.U32VEC3),inOrOut:"in",stage:"compute"},globalInvocationId:{name:"zGlobalInvocationId",semantic:"global_invocation_id",type:new ue(X.U32VEC3),inOrOut:"in",stage:"compute"},workGroupId:{name:"zWorkGroupId",semantic:"workgroup_id",type:new ue(X.U32VEC3),inOrOut:"in",stage:"compute"},numWorkGroups:{name:"zNumWorkGroups",semantic:"num_workgroups",type:new ue(X.U32VEC3),inOrOut:"in",stage:"compute"},sampleMaskIn:{name:"zSampleMaskIn",semantic:"sample_mask_in",type:new ue(X.U32),inOrOut:"in",stage:"fragment"},sampleMaskOut:{name:"zSampleMaskOut",semantic:"sample_mask_out",type:new ue(X.U32),inOrOut:"out",stage:"fragment"},sampleIndex:{name:"zSampleIndex",semantic:"sample_index",type:new ue(X.U32),inOrOut:"in",stage:"fragment"}}};function Ss(e){return e%1==0?e.toFixed(1):String(e)}function $s(e){return String(0|e)}function As(e){return String(e>>>0)}function Ls(e){if("("===(e=e.trim())[0]&&")"===e[e.length-1]){let t=0;for(let r=1;r<e.length-1;r++)if("("===e[r])t++;else if(")"===e[r]&&(t--,t<0))break;if(t>0)throw new ps(`Invalid expression: ${e}`);if(0===t)return e.substring(1,e.length-1)}return e}class Is{isReference(){return!1}isPointer(){return!!this.getType()?.isPointerType()}getType(){return null}toWebGL(e,t){return""}toWebGL2(e,t){return""}toWGSL(e,t){return""}toString(e){return this.constructor.name}}class Bs extends Is{}class Ds extends Bs{paramAST;writable;constructor(e){super(),this.paramAST=e,this.writable=!1}getType(){return this.paramAST.getType()}markWritable(){this.paramAST instanceof Rs&&console.warn(`Write to non-output parameter ${this.paramAST.value.$str}`),this.writable=!0}isWritable(){return this.writable}getAddressSpace(){return this.paramAST.getAddressSpace()}isConstExp(){return this.paramAST.isConstExp()}isReference(){return this.paramAST.isReference()}toWebGL(e,t){return this.paramAST.toWebGL(e,t)}toWebGL2(e,t){return this.paramAST.toWebGL2(e,t)}toWGSL(e,t){return this.paramAST.toWGSL(e,t)}}class Os extends Is{statements;constructor(){super(),this.statements=[]}toWebGL(e,t){return this.statements.filter((e=>!(e instanceof ii)||e.isStatement)).map((r=>r.toWebGL(e,t))).join("")}toWebGL2(e,t){return this.statements.filter((e=>!(e instanceof ii)||e.isStatement)).map((r=>r.toWebGL2(e,t))).join("")}toWGSL(e,t){return this.statements.filter((e=>!(e instanceof ii)||e.isStatement)).map((r=>r instanceof ii&&!r.getType().isVoidType()?`${e}_ = ${r.toWGSL("",t)}`:r.toWGSL(e,t))).join("")}}class Fs extends Os{toWebGL(e,t){return`${e}{\n${super.toWebGL(e+" ",t)}${e}}\n`}toWebGL2(e,t){return`${e}{\n${super.toWebGL2(e+" ",t)}${e}}\n`}toWGSL(e,t){return`${e}{\n${super.toWGSL(e+" ",t)}${e}}\n`}}class Ms extends Os{uniforms;constructor(){super(),this.uniforms=[]}findFunctions(e){const t=[];for(const r of this.statements)r instanceof ai&&r.name===e&&t.push(r);return t}toWebGL(e,t){const r=`${e}precision highp float;\n${e}precision highp int;\n`,s=`${e}#version 100\n`,i=t.types.map((r=>r.toWebGL(e,t))).join("")+this.uniforms.map((r=>r.toWebGL(e,t))).join("")+t.inputs.map((r=>r.toWebGL(e,t))).join("")+t.outputs.map((r=>r.toWebGL(e,t))).join("")+super.toWebGL(e,t);for(const e of t.builtins){const r=Cs.webgl[e];r.extension&&t.extensions.add(r.extension)}return s+[...t.extensions].map((t=>`${e}#extension ${t}: enable\n`)).join("")+r+t.defines.join("")+i}toWebGL2(e,t){const r=`${e}precision highp float;\n${e}precision highp int;\n`,s=`${e}#version 300 es\n`,i=t.types.map((r=>r.toWebGL2(e,t))).join("")+this.uniforms.map((r=>r.toWebGL2(e,t))).join("")+t.inputs.map((r=>r.toWebGL2(e,t))).join("")+t.outputs.map((r=>r.toWebGL2(e,t))).join("")+super.toWebGL2(e,t);for(const e of t.builtins){const r=Cs.webgl2[e];r.extension&&t.extensions.add(r.extension)}return s+[...t.extensions].map((t=>`${e}#extension ${t}: enable\n`)).join("")+r+t.defines.join("")+i}toWGSL(e,t){const r=t.type===F.Vertex?[fs,ds]:t.type===F.Fragment?[ms,_s]:[gs],s=[];for(const e of t.builtins)s.push(Cs.webgpu[e].name);const i=Object.keys(Cs.webgpu).map((e=>Cs.webgpu[e].name));for(const e of t.types)if(e instanceof ci&&r.indexOf(e.type.structName)>=0)for(let t=e.type.structMembers.length-1;t>=0;t--){const r=e.type.structMembers[t];i.indexOf(r.name)>=0&&s.indexOf(r.name)<0&&(e.type.structMembers.splice(t,1),e.prefix.splice(t,1))}return t.types=t.types.filter((e=>!(e instanceof ci)||e.type.structMembers.length>0)),t.types.map((r=>r.toWGSL(e,t))).join("")+this.uniforms.map((r=>r.toWGSL(e,t))).join("")+super.toWGSL(e,t)}}class Rs extends Bs{value;ref;writable;constExp;constructor(e){super(),this.value=e,this.ref=null,this.writable=!1,this.constExp=!1}get name(){return this.value.$str}isReference(){return!0}isConstExp(){return this.constExp}markWritable(){this.writable=!0,this.constExp=!1,this.ref&&this.ref.markWritable()}isWritable(){const e=this.getType();return this.writable||e.isAtomicI32()||e.isAtomicU32()||e.isStructType()&&e.haveAtomicMembers()}getAddressSpace(){switch(this.value.$declareType){case xs.DECLARE_TYPE_UNIFORM:return ne.UNIFORM;case xs.DECLARE_TYPE_STORAGE:return ne.STORAGE;case xs.DECLARE_TYPE_IN:case xs.DECLARE_TYPE_OUT:return null;default:return this.value.$global?ne.PRIVATE:ne.FUNCTION}}getType(){return this.value.$typeinfo}toWebGL(e,t){return this.name}toWebGL2(e,t){return this.name}toWGSL(e,t){if(this.value.$declareType===xs.DECLARE_TYPE_IN){const r=Ts(t.type);return t.global[r][this.name].$ast.toWGSL(e,t)}if(this.value.$declareType===xs.DECLARE_TYPE_OUT){const r=ws(t.type);return t.global[r][this.name].$ast.toWGSL(e,t)}return this.name}toString(e){return this.name}}class Vs extends Is{}class Gs extends Vs{value;constructor(e){if(super(),e.getAddressSpace()===ne.UNIFORM)throw new cs(e,"cannot assign to uniform variable");this.value=e,this.value instanceof ii&&(this.value.isStatement=!1)}getType(){return this.value.getType()}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isReference(){return this.value.isReference()}toWebGL(e,t){return this.value.toWebGL(e,t)}toWebGL2(e,t){return this.value.toWebGL2(e,t)}toWGSL(e,t){return this.value.toWGSL(e,t)}toString(e){return this.value.toString(e)}}class Ps extends Vs{scope;field;type;constructor(e,t,r){super(),this.scope=e,this.field=t,this.type=r}getType(){return this.type}markWritable(){this.scope.markWritable()}isWritable(){return this.scope.isWritable()}isReference(){return this.scope.isReference()}toWebGL(e,t){return`${this.scope.toWebGL(e,t)}.${this.field}`}toWebGL2(e,t){return`${this.scope.toWebGL2(e,t)}.${this.field}`}toWGSL(e,t){return`${(this.scope.isPointer()?new js(this.scope):this.scope).toWGSL(e,t)}.${this.field}`}toString(e){return`${(this.scope.isPointer()?new js(this.scope):this.scope).toString(e)}.${this.field}`}}class Ns extends Vs{value;index;type;constructor(e,t,r){super(),this.value=e,this.index=t,this.type=r,this.index instanceof ii&&(this.index.isStatement=!1)}getType(){return this.type}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isReference(){return this.value.isReference()}toWebGL(e,t){return`${this.value.toWebGL(e,t)}[${this.index.toWebGL(e,t)}]`}toWebGL2(e,t){return`${this.value.toWebGL2(e,t)}[${this.index.toWebGL2(e,t)}]`}toWGSL(e,t){return`${(this.value.isPointer()?new js(this.value):this.value).toWGSL(e,t)}[${this.index.toWGSL(e,t)}]`}toString(e){return`${(this.value.isPointer()?new js(this.value):this.value).toString(e)}[${this.index.toString(e)}]`}}class Us extends Vs{value;constructor(e){super(),this.value=e,this.value.constExp=!0}getType(){return this.value.getType()}markWritable(){}isWritable(){return!1}isReference(){return!0}toWebGL(e,t){let r="";switch(this.value.value.$declareType){case xs.DECLARE_TYPE_IN:case xs.DECLARE_TYPE_OUT:case xs.DECLARE_TYPE_UNIFORM:case xs.DECLARE_TYPE_STORAGE:throw new Error("invalid declare type");default:r=!this.value.constExp||this.value.isWritable()||this.getType().isStructType()?"":"const "}return`${r}${this.getType().toTypeName("webgl",this.value.name)}`}toWebGL2(e,t){let r="";switch(this.value.value.$declareType){case xs.DECLARE_TYPE_IN:case xs.DECLARE_TYPE_OUT:case xs.DECLARE_TYPE_UNIFORM:case xs.DECLARE_TYPE_STORAGE:throw new Error("invalid declare type");default:r=!this.value.constExp||this.value.isWritable()||this.getType().isStructType()?"":"const "}return`${r}${this.getType().toTypeName("webgl2",this.value.name)}`}toWGSL(e,t){let r;switch(this.value.value.$declareType){case xs.DECLARE_TYPE_IN:case xs.DECLARE_TYPE_OUT:case xs.DECLARE_TYPE_UNIFORM:case xs.DECLARE_TYPE_STORAGE:throw new Error("invalid declare type");default:{const e=this.value.getAddressSpace(),t=this.getType().isPointerType()||!this.value.isWritable()&&(e===ne.PRIVATE||e===ne.FUNCTION),s=e===ne.PRIVATE,i=e===ne.STORAGE&&this.value.isWritable()?", read_write":"",n=e!==ne.FUNCTION?`<${e}${i}>`:"";r=t?s?"const ":"let ":`var${n} `;break}}{const e=this.getType();e.isPointerType()&&(this.value.isWritable()||this.value.ref.isWritable())&&(e.writable=!0);return`${r}${e.toTypeName("webgpu",this.value.name)}`}}toString(e){return this.value.toString(e)}}class zs extends Bs{type;args;constExp;constructor(e,t){super(),this.type=e,this.args=t,this.constExp=!0;for(const e of t){if(null==e)throw new Error("invalid constructor argument");e instanceof ii&&(e.isStatement=!1),this.constExp&&=!(e instanceof Bs)||e.isConstExp()}}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.constExp}getAddressSpace(){return null}toWebGL(e,t){console.assert(!this.type.isArrayType(),"array constructor not supported in webgl1 device"),console.assert(this.type.isConstructible(),`type '${this.type.toTypeName("webgl")}' is not constructible`);const r=this.type.getConstructorOverloads("webgl");for(const s of r){const r=pi(this.args,s);if(r){const s=r.args.map((r=>Ls(r.toWebGL(e,t)))).join(",");return`${r.name}(${s})`}}throw new Error(`no matching overload function found for type ${this.type.toTypeName("webgl")}`)}toWebGL2(e,t){console.assert(this.type.isConstructible(),`type '${this.type.toTypeName("webgl2")}' is not constructible`,!0);const r=this.type.getConstructorOverloads("webgl2");for(const s of r){const r=pi(this.args,s);if(r){const s=r.args.map((r=>Ls(r.toWebGL2(e,t)))).join(",");return`${r.name}(${s})`}}throw new Error(`no matching overload function found for type ${this.type.toTypeName("webgl2")}`)}toWGSL(e,t){const r=this.type.getConstructorOverloads("webgpu");for(const s of r){const r=pi(this.args,s);if(r){const s=r.args.map((r=>Ls(r.toWGSL(e,t)))).join(",");return`${r.name}(${s})`}}throw new Error(`no matching overload function found for type ${this.type.toTypeName("webgpu")}`)}toString(e){return"constructor"}}class ks extends Bs{value;type;constructor(e,t){if(super(),this.value=e,this.type=t,"number"==typeof e){if(t.primitiveType===X.BOOL)throw new rs(e,typeof e,t);if(t.primitiveType===X.I32&&(!Number.isInteger(e)||e<-2147483648||e>4294967295))throw new rs(e,typeof e,t);if(e<0&&t.primitiveType===X.U32&&(!Number.isInteger(e)||e<0||e>4294967295))throw new rs(e,typeof e,t)}else if(t.primitiveType!==X.BOOL)throw new rs(e,typeof e,t)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return!0}getAddressSpace(){return null}toWebGL(e,t){switch(this.type.primitiveType){case X.F32:return Ss(this.value);case X.I32:return $s(this.value);case X.U32:return As(this.value);case X.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toWebGL2(e,t){switch(this.type.primitiveType){case X.F32:return Ss(this.value);case X.I32:return $s(this.value);case X.U32:return`${As(this.value)}u`;case X.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toWGSL(e,t){switch(this.type.primitiveType){case X.F32:return Ss(this.value);case X.I32:return $s(this.value);case X.U32:return`${As(this.value)}u`;case X.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toString(e){return`${this.value}`}}class Ws extends Bs{source;field;type;constructor(e,t,r){super(),this.source=e,this.field=t,this.type=r,this.source instanceof ii&&(this.source.isStatement=!1)}getType(){return this.type}isReference(){return this.source.isReference()}isConstExp(){return this.source.isConstExp()}markWritable(){this.source.markWritable()}isWritable(){return this.source.isWritable()}getAddressSpace(){return this.source.getAddressSpace()}toWebGL(e,t){return`${this.source.toWebGL(e,t)}.${this.field}`}toWebGL2(e,t){return`${this.source.toWebGL2(e,t)}.${this.field}`}toWGSL(e,t){return`${(this.source.isPointer()?new js(this.source):this.source).toWGSL(e,t)}.${this.field}`}toString(e){return`${(this.source.isPointer()?new js(this.source):this.source).toString(e)}.${this.field}`}}class Xs extends Bs{sourceValue;castType;constructor(e,t){super(),this.sourceValue=e,this.castType=t,this.sourceValue instanceof ii&&(this.sourceValue.isStatement=!1)}getType(){return this.castType}markWritable(){}isWritable(){return!1}isConstExp(){return this.sourceValue.isConstExp()}getAddressSpace(){return null}toWebGL(e,t){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWebGL(e,t):`${this.castType.toTypeName("webgl")}(${Ls(this.sourceValue.toWebGL(e,t))})`}toWebGL2(e,t){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWebGL2(e,t):`${this.castType.toTypeName("webgl2")}(${Ls(this.sourceValue.toWebGL2(e,t))})`}toWGSL(e,t){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWGSL(e,t):`${this.castType.toTypeName("webgpu")}(${Ls(this.sourceValue.toWGSL(e,t))})`}toString(e){return`${this.castType.toTypeName(e)}(${Ls(this.sourceValue.toString(e))})`}}class Ys extends Bs{value;type;constructor(e){super(),console.assert(e.isReference(),"no pointer type for non-reference values",!0),this.value=e,this.type=new ce(e.getType(),e.getAddressSpace())}getType(){return this.type}isConstExp(){return!1}markWritable(){if(this.value.getAddressSpace()===ne.UNIFORM)throw new cs(this.value,"uniforms are not writable");this.value.markWritable()}isWritable(){return this.value.isWritable()}getAddressSpace(){return this.value.getAddressSpace()}toWebGL(e,t){throw new Error("GLSL does not support pointer type")}toWebGL2(e,t){throw new Error("GLSL does not support pointer type")}toWGSL(e,t){const r=this.value instanceof Ds?this.value.paramAST:this.value;return r instanceof js?r.value.toWGSL(e,t):`(&${r.toWGSL(e,t)})`}toString(e){const t=this.value instanceof Ds?this.value.paramAST:this.value;return t instanceof js?t.value.toString(e):`(&${t.toString(e)})`}}class js extends Bs{value;constructor(e){super(),this.value=e,this.value instanceof ii&&(this.value.isStatement=!1)}getType(){const e=this.value.getType();return e.isPointerType()?e.pointerType:e}isReference(){return!0}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isConstExp(){return!1}getAddressSpace(){return this.value instanceof Bs?this.value.getAddressSpace():null}toWebGL(e,t){return this.value.toWebGL(e,t)}toWebGL2(e,t){return this.value.toWebGL2(e,t)}toWGSL(e,t){return this.value.getType().isPointerType()?`(*${this.value.toWGSL(e,t)})`:this.value.toWGSL(e,t)}toString(e){return`*${this.value.toString(e)}`}}class Hs extends Bs{value;op;type;constructor(e,t,r){super(),this.value=e,this.op=t,this.type=r,this.value instanceof ii&&(this.value.isStatement=!1)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.value.isConstExp()}getAddressSpace(){return null}toWebGL(e,t){return`${this.op}${this.value.toWebGL(e,t)}`}toWebGL2(e,t){return`${this.op}${this.value.toWebGL2(e,t)}`}toWGSL(e,t){const r=this.value.isPointer()?new js(this.value):this.value;return`${this.op}${r.toWGSL(e,t)}`}toString(e){const t=this.value.isPointer()?new js(this.value):this.value;return`${this.op}${t.toString(e)}`}}class qs extends Bs{left;right;type;op;constructor(e,t,r,s){super(),this.left=e,this.right=t,this.op=r,this.type=s,this.left instanceof ii&&(this.left.isStatement=!1),this.right instanceof ii&&(this.right.isStatement=!1)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.left.isConstExp()&&this.right.isConstExp()}getAddressSpace(){return null}toWebGL(e,t){return`(${this.left.toWebGL(e,t)} ${this.op} ${this.right.toWebGL(e,t)})`}toWebGL2(e,t){return`(${this.left.toWebGL2(e,t)} ${this.op} ${this.right.toWebGL2(e,t)})`}toWGSL(e,t){const r=this.left.isPointer()?new js(this.left):this.left,s=this.right.isPointer()?new js(this.right):this.right;return`(${r.toWGSL(e,t)} ${this.op} ${s.toWGSL(e,t)})`}toString(e){const t=this.left.isPointer()?new js(this.left):this.left,r=this.right.isPointer()?new js(this.right):this.right;return`(${t.toString(e)} ${this.op} ${r.toString(e)})`}}class Zs extends Bs{source;index;type;constructor(e,t,r){super(),this.source=e,this.index=t,this.type=r,this.source instanceof ii&&(this.source.isStatement=!1),this.index instanceof ii&&(this.index.isStatement=!1)}getType(){return this.type}isReference(){return this.source.isReference()}markWritable(){this.source.markWritable()}isWritable(){return this.source.isWritable()}isConstExp(){return this.source.isConstExp()&&this.index.isConstExp()}getAddressSpace(){return this.source.getAddressSpace()}toWebGL(e,t){return`${this.source.toWebGL(e,t)}[${Ls(this.index.toWebGL(e,t))}]`}toWebGL2(e,t){return`${this.source.toWebGL2(e,t)}[${Ls(this.index.toWebGL2(e,t))}]`}toWGSL(e,t){return`${this.source.toWGSL(e,t)}[${Ls(this.index.toWGSL(e,t))}]`}toString(e){return`${this.source.toString(e)}[${Ls(this.index.toString(e))}]`}}class Qs extends Is{value;constructor(e){if(super(),e.getType().isVoidType())throw new Error("can not touch void type");e instanceof ii&&(e.isStatement=!1),this.value=e}toWebGL(e,t){return`${e}${this.value.toWebGL("",t)};\n`}toWebGL2(e,t){return`${e}${this.value.toWebGL2("",t)};\n`}toWGSL(e,t){return this.value.getType().isVoidType()?`${e}${this.value.toWGSL("",t)};\n`:`${e}_ = ${this.value.toWGSL("",t)};\n`}}class Ks extends Bs{condition;first;second;type;constructor(e,t,r){super(),this.condition=e instanceof Bs?e:new ks(e,Le);let s=null,i=null;if(t instanceof Bs)s=t.getType(),this.first=t,t instanceof ii&&(t.isStatement=!1);else if("number"==typeof t)Number.isInteger(t)||(this.first=new ks(t,me),s=me);else{if("boolean"!=typeof t)throw new Error("select: invalid first value");this.first=new ks(t,Le),s=Le}if(r instanceof Bs)i=r.getType(),this.second=r,r instanceof ii&&(r.isStatement=!1);else if("number"==typeof r)Number.isInteger(r)||(this.second=new ks(r,me),i=me);else{if("boolean"!=typeof r)throw new Error("select: invalid second value");this.second=new ks(r,Le),i=Le}if(!s&&!i)throw new Error("select: cannot determine the value types");if(s&&i){if(!s.isCompatibleType(i))throw new Error("select: first value and second value must be the same type");this.type=s}else if(s){if(s.typeId===me.typeId)this.second=new ks(r,me);else if(s.typeId===Te.typeId)this.second=new ks(r,Te);else{if(s.typeId!==Ce.typeId)throw new Error("select: invalid type of the second value");this.second=new ks(r,Ce)}this.type=s}else{if(i.typeId===me.typeId)this.first=new ks(t,me);else if(i.typeId===Te.typeId)this.first=new ks(t,Te);else{if(i.typeId!==Ce.typeId)throw new Error("select: invalid type of the first value");this.first=new ks(t,Ce)}this.type=i}}getType(){return this.type}isConstExp(){return!1}markWritable(){}isWritable(){return!1}getAddressSpace(){return null}toWebGL(e,t){return`${e}(${this.condition.toWebGL("",t)} ? ${this.first.toWebGL("",t)} : ${this.second.toWebGL("",t)})`}toWebGL2(e,t){return`${e}(${this.condition.toWebGL2("",t)} ? ${this.first.toWebGL2("",t)} : ${this.second.toWebGL2("",t)})`}toWGSL(e,t){return`${e}select(${this.second.toWGSL("",t)}, ${this.first.toWGSL("",t)}, ${this.condition.toWGSL("",t)})`}}class Js extends Is{lvalue;rvalue;constructor(e,t){if(super(),!e.isReference())throw new Error("assignment: l-value required");if(this.lvalue=e,this.rvalue=t,this.lvalue instanceof Us)if(this.lvalue.getType().isPointerType())if(this.rvalue instanceof Rs)this.lvalue.value.ref=this.rvalue.ref;else{if(!(this.rvalue instanceof Ys))throw new cs(this.lvalue,"invalid pointer assignment");this.lvalue.value.ref=this.rvalue.value}else this.rvalue instanceof Bs&&(this.lvalue.value.constExp=this.rvalue.isConstExp());else{if(this.lvalue.getType().isPointerType())throw new cs(this.lvalue,"cannot assign to read-only variable");this.lvalue.markWritable()}this.rvalue instanceof ii&&(this.rvalue.isStatement=!1)}getType(){return null}toWebGL(e,t){let r=null;const s=this.lvalue.getType(),i=this.checkScalarType(this.rvalue,s);if(!s.isCompatibleType(i))throw new rs(this.rvalue instanceof Bs?this.rvalue.toString("webgl"):`${this.rvalue}`,i,s);return r="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?i.primitiveType===X.F32?Ss(this.rvalue):String(this.rvalue):Ls(this.rvalue.toWebGL(e,t)),this.lvalue instanceof Us&&(this.lvalue.value.constExp&&=!(this.rvalue instanceof Bs)||this.rvalue.isConstExp()),`${e}${this.lvalue.toWebGL(e,t)} = ${r};\n`}toWebGL2(e,t){let r=null;const s=this.lvalue.getType(),i=this.checkScalarType(this.rvalue,s);if(!s.isCompatibleType(i))throw new rs(this.rvalue instanceof Bs?this.rvalue.toString("webgl2"):`${this.rvalue}`,i,s);return r="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?i.primitiveType===X.F32?Ss(this.rvalue):String(this.rvalue):Ls(this.rvalue.toWebGL2(e,t)),this.lvalue instanceof Us&&(this.lvalue.value.constExp&&=!(this.rvalue instanceof Bs)||this.rvalue.isConstExp()),`${e}${this.lvalue.toWebGL2(e,t)} = ${r};\n`}toWGSL(e,t){const r=this.lvalue.getType(),[s,i]=r.isPointerType()?[r.pointerType,!0]:[r,!1],n=this.checkScalarType(this.rvalue,s),a=n&&n.isPointerType(),o=a?n.pointerType:n;if(!s.isCompatibleType(o))throw new rs(this.rvalue instanceof Bs?this.rvalue.toString("webgpu"):`${this.rvalue}`,n,r);if(this.lvalue instanceof Gs||this.lvalue instanceof Us){const e=s.isStructType()?s.structName:null;if(e&&t.types.findIndex((t=>t instanceof ci&&t.type.structName===e))<0)return""}let u;u="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?n.primitiveType===X.F32?Ss(this.rvalue):String(this.rvalue):Ls(this.rvalue.toWGSL(e,t));const h=this.lvalue.toWGSL(e,t);if(i&&!a){if(this.lvalue instanceof Us)throw new Error(`rvalue must be pointer type: ${u}`);return`${e}*(${h}) = ${u};\n`}return a&&!i?`${e}${h} = *(${u});\n`:`${e}${h} = ${u};\n`}checkScalarType(e,t){if(e instanceof Bs)return e.getType();const r="boolean"==typeof e,s="number"==typeof e&&Number.isInteger(e)&&e>=-2147483648&&e<=2147483647,i="number"==typeof e&&Number.isInteger(e)&&e>=0&&e<=4294967295,n="number"==typeof e;if(!t.isPrimitiveType())return r?Le:s?Te:i?Ce:me;switch(t.primitiveType){case X.BOOL:return r?t:s?Te:i?Ce:me;case X.F32:return n?t:Le;case X.I32:return s?t:r?Le:i?Ce:me;case X.U32:return i?t:r?Le:s?Te:me;default:return null}}}class ei extends Is{toWebGL(e,t){return`${e}discard;\n`}toWebGL2(e,t){return`${e}discard;\n`}toWGSL(e,t){return`${e}discard;\n`}}class ti extends Is{toWebGL(e,t){return`${e}break;\n`}toWebGL2(e,t){return`${e}break;\n`}toWGSL(e,t){return`${e}break;\n`}}class ri extends Is{toWebGL(e,t){return`${e}continue;\n`}toWebGL2(e,t){return`${e}continue;\n`}toWGSL(e,t){return`${e}continue;\n`}}class si extends Is{value;constructor(e){super(),this.value=e,this.value instanceof ii&&(this.value.isStatement=!1)}toWebGL(e,t){return this.value?`${e}return ${Ls(this.value.toWebGL(e,t))};\n`:`${e}return;\n`}toWebGL2(e,t){return this.value?`${e}return ${Ls(this.value.toWebGL2(e,t))};\n`:`${e}return;\n`}toWGSL(e,t){return this.value?`${e}return ${Ls(this.value.toWGSL(e,t))};\n`:`${e}return;\n`}}class ii extends Bs{name;args;retType;func;isStatement;constructor(e,t,r,s,i){if(super(),this.name=e,this.args=t,this.retType=r?.returnType??i??Ir,this.func=r,this.isStatement=!0,r){if(r.funcType.argTypes.length!==this.args.length)throw new ps("ASTCallFunction(): number of parameters mismatch");for(let i=0;i<this.args.length;i++){const n=r.funcType.argTypes[i];if(n.byRef){if("webgpu"===s){const r=t[i].getAddressSpace();if(r!==ne.FUNCTION&&r!==ne.PRIVATE)throw new is(e,"pointer type of function parameter must be function or private");const s=n.type;if(!s.isPointerType())throw new ps("ASTCallFunction(): invalid reference type");if(s.addressSpace===ne.UNKNOWN)s.addressSpace=r;else if(s.addressSpace!==r)throw new is(e,`invalid pointer parameter address space '${r}', should be '${s.addressSpace}`)}this.args[i].markWritable()}}}for(const e of this.args)e instanceof ii&&(e.isStatement=!1)}getType(){return this.retType}isConstExp(){return!1}markWritable(){}isWritable(){return!1}getAddressSpace(){return null}toWebGL(e,t){"dFdx"===this.name||"dFdy"===this.name||"fwidth"===this.name?t.extensions.add("GL_OES_standard_derivatives"):"texture2DLodEXT"!==this.name&&"texture2DProjLodEXT"!==this.name&&"textureCubeLodEXT"!==this.name&&"texture2DGradEXT"!==this.name&&"texture2DProjGradEXT"!==this.name&&"textureCubeGradEXT"!==this.name||t.extensions.add("GL_EXT_shader_texture_lod");const r=this.args.map((r=>Ls(r.toWebGL(e,t))));return`${this.isStatement?e:""}${this.name}(${r.join(",")})${this.isStatement?";\n":""}`}toWebGL2(e,t){const r=this.args.map((r=>Ls(r.toWebGL2(e,t))));return`${this.isStatement?e:""}${this.name}(${r.join(",")})${this.isStatement?";\n":""}`}toWGSL(e,t){let r=this.args;if(this.func){let e;const s=pi(r,this.func.funcType);if(s&&(e=s.args),!e)throw new Error(`no matching overloading found for function '${this.name}'`);r=e.filter((e=>{const r=e.getType();return!(r.isStructType()&&t.types.findIndex((e=>e instanceof ci&&e.type.structName===r.structName))<0)}))}const s=r.map((r=>Ls(r.toWGSL(e,t))));return`${this.isStatement?e:""}${this.name}(${s.join(",")})${this.isStatement?";\n":""}`}toString(e){return`${this.name}(...)`}}class ni extends Is{value;group;binding;blockName;constructor(e){super(),this.value=e,this.group=0,this.binding=0}isReference(){return!0}isPointer(){return this.value.getType().isPointerType()}toWebGL(e,t){let r="",s=!1,i=this.value.getType();switch(this.value.value.$declareType){case xs.DECLARE_TYPE_IN:t.type===F.Vertex?(r="attribute ",t.defines.push(`#define ${this.value.name} ${qr(t.vertexAttributes[this.value.value.$location])}\n`)):r="varying ";break;case xs.DECLARE_TYPE_OUT:t.type===F.Vertex?r="varying ":(s=!0,t.mrt?(t.defines.push(`#define ${this.value.name} gl_FragData[${this.value.value.$location}]\n`),t.extensions.add("GL_EXT_draw_buffers")):t.defines.push(`#define ${this.value.name} gl_FragColor\n`));break;case xs.DECLARE_TYPE_UNIFORM:r="uniform ",i=t.typeReplacement?.get(this.value.value)||i;break;case xs.DECLARE_TYPE_STORAGE:throw new Error(`invalid variable declare type: ${this.value.name}`)}if(!s)return`${e}${r}${i.toTypeName("webgl",this.value.name)};\n`}toWebGL2(e,t){let r="",s=this.value.getType();switch(this.value.value.$declareType){case xs.DECLARE_TYPE_IN:r=t.type===F.Fragment&&s.isPrimitiveType()&&s.isInteger()?"flat in ":"in ",t.type===F.Vertex&&t.defines.push(`#define ${this.value.name} ${qr(t.vertexAttributes[this.value.value.$location])}\n`);break;case xs.DECLARE_TYPE_OUT:r=t.type===F.Vertex?s.isPrimitiveType()&&s.isInteger()?"flat out ":"out ":`layout(location = ${this.value.value.$location}) out `;break;case xs.DECLARE_TYPE_UNIFORM:return s.isStructType()?`${e}layout(std140) uniform ${this.blockName} { ${s.structName} ${this.value.name}; };\n`:(s=t.typeReplacement?.get(this.value.value)||s,`${e}uniform ${s.toTypeName("webgl2",this.value.name)};\n`);case xs.DECLARE_TYPE_STORAGE:throw new Error(`invalid variable declare type: ${this.value.name}`)}return`${e}${r}${this.value.getType().toTypeName("webgl2",this.value.name)};\n`}toWGSL(e,t){let r;const s=this.value.getType().isPrimitiveType()||this.value.getType().isStructType()||this.value.getType().isArrayType();switch(this.value.value.$declareType){case xs.DECLARE_TYPE_IN:case xs.DECLARE_TYPE_OUT:throw new Error("Internal error");case xs.DECLARE_TYPE_UNIFORM:r=`@group(${this.group}) @binding(${this.binding}) var${s?"<uniform>":""} `;break;case xs.DECLARE_TYPE_STORAGE:r=`@group(${this.group}) @binding(${this.binding}) var<storage, ${this.value.value.$readonly?"read":"read_write"}> `;break;case xs.DECLARE_TYPE_WORKGROUP:r="var<workgroup> ";break;default:r=`${this.value.getType().isPointerType()?"let":"var"}${this.value.value.$global&&!this.value.getType().isPointerType()?"<private>":""} `}{const s=this.value.getType(),i=s.isStructType()?s.structName:null;return i&&t.types.findIndex((e=>e instanceof ci&&e.type.structName===i))<0?"":`${e}${r}${s.toTypeName("webgpu",this.value.name)};\n`}}toString(e){return this.value.toString(e)}}class ai extends Os{name;args;isBuiltin;isMainFunc;funcType;builtins;returnType;constructor(e,t,r,s,i=!1){super(),this.name=e,this.args=t,this.funcType=s,this.builtins=[],this.isBuiltin=i,this.isMainFunc=r,this.returnType=s?s.returnType:null}toWebGL(e,t){if(this.isBuiltin)return"";{let r="";const s=[];for(const e of this.args){let t,r,i;e.paramAST instanceof Rs?(t=e.paramAST.value,r=e.paramAST.name,i=""):(t=e.paramAST.value.value,r=e.paramAST.value.name,i=`${t.$inout} `),s.push(`${i}${e.getType().toTypeName("webgl",r)}`)}return r+=`${e}${this.returnType.toTypeName("webgl")} ${this.name}(${s.join(",")}) {\n`,r+=super.toWebGL(e+"  ",t),r+=`${e}}\n`,r}}toWebGL2(e,t){if(this.isBuiltin)return"";{let r="";const s=[];for(const e of this.args){let t,r,i;e.paramAST instanceof Rs?(t=e.paramAST.value,r=e.paramAST.name,i=""):(t=e.paramAST.value.value,r=e.paramAST.value.name,i=`${t.$inout} `),s.push(`${i}${e.getType().toTypeName("webgl2",r)}`)}return r+=`${e}${this.returnType.toTypeName("webgl2")} ${this.name}(${s.join(",")}) {\n`,r+=super.toWebGL2(e+"  ",t),r+=`${e}}\n`,r}}toWGSL(e,t){if(this.isBuiltin)return"";{let r="";const s=[...this.builtins];for(const e of this.args){const r=e.paramAST instanceof Rs?e.paramAST.name:e.paramAST.value.name,i=e.paramAST instanceof Rs?e.paramAST.getType():e.paramAST.value.getType(),n=i.isPointerType()?i.pointerType:i;n.isStructType()&&t.types.findIndex((e=>e instanceof ci&&e.type.structName===n.structName))<0||s.push(`${i.toTypeName("webgpu",r)}`)}let i="";if(this.isMainFunc)switch(t.type){case F.Vertex:i="@vertex ";break;case F.Fragment:i="@fragment ";break;case F.Compute:i=`@compute @workgroup_size(${t.workgroupSize[0]}, ${t.workgroupSize[1]}, ${t.workgroupSize[2]}) `}const n=this.returnType.isVoidType()?null:this.returnType.toTypeName("webgpu"),a=n?` -> ${n}`:"";return r+=`${e}${i}fn ${this.name}(${s.join(",")})${a} {\n`,r+=super.toWGSL(e+"  ",t),r+=`${e}}\n`,r}}}class oi extends Os{keyword;condition;nextElse;constructor(e,t){super(),this.keyword=e,this.condition=t,this.nextElse=null,this.condition instanceof ii&&(this.condition.isStatement=!1)}toWebGL(e,t){let r=`${e}${this.keyword} ${this.condition?"("+Ls(this.condition.toWebGL(e,t))+")":""} {\n`;return r+=super.toWebGL(e+"  ",t),r+=`${e}}\n`,this.nextElse&&(r+=this.nextElse.toWebGL(e,t)),r}toWebGL2(e,t){let r=`${e}${this.keyword} ${this.condition?"("+Ls(this.condition.toWebGL2(e,t))+")":""} {\n`;return r+=super.toWebGL2(e+"  ",t),r+=`${e}}\n`,this.nextElse&&(r+=this.nextElse.toWebGL2(e,t)),r}toWGSL(e,t){let r=`${e}${this.keyword} ${this.condition?"("+Ls(this.condition.toWGSL(e,t))+")":""} {\n`;return r+=super.toWGSL(e+"  ",t),r+=`${e}}\n`,this.nextElse&&(r+=this.nextElse.toWGSL(e,t)),r}}class ui extends Os{init;start;end;open;constructor(e,t,r,s){super(),this.init=e,this.start=t,this.end=r,this.open=s,this.statements=[],this.start instanceof ii&&(this.start.isStatement=!1),this.end instanceof ii&&(this.end.isStatement=!1)}toWebGL(e,t){const r=this.init.getType().toTypeName("webgl",this.init.name),s=Ls(this.start.toWebGL(e,t)),i=Ls(this.end.toWebGL(e,t)),n=this.open?"<":"<=";let a=`${e}for (${r} = ${s}; ${this.init.name} ${n} ${i}; ${this.init.name}++) {\n`;return a+=super.toWebGL(e+"  ",t),a+=`${e}}\n`,a}toWebGL2(e,t){const r=this.init.getType().toTypeName("webgl2",this.init.name),s=Ls(this.start.toWebGL2(e,t)),i=Ls(this.end.toWebGL2(e,t)),n=this.open?"<":"<=";let a=`${e}for (${r} = ${s}; ${this.init.name} ${n} ${i}; ${this.init.name}++) {\n`;return a+=super.toWebGL2(e+"  ",t),a+=`${e}}\n`,a}toWGSL(e,t){const r=`var ${this.init.getType().toTypeName("webgpu",this.init.name)}`,s=Ls(this.start.toWGSL(e,t)),i=Ls(this.end.toWGSL(e,t)),n=new ks(1,this.init.getType()).toWGSL(e,t),a=this.open?"<":"<=";let o=`${e}for (${r} = ${s}; ${this.init.name} ${a} ${i}; ${this.init.name} = ${this.init.name} + ${n}) {\n`;return o+=super.toWGSL(e+"  ",t),o+=`${e}}\n`,o}}class hi extends Os{condition;constructor(e){super(),this.condition=e,this.condition instanceof ii&&(this.condition.isStatement=!1)}toWebGL(e,t){throw new Error("No do-while() loop support for WebGL1.0 device")}toWebGL2(e,t){let r=`${e}do {\n`;return r+=super.toWebGL2(e+" ",t),r+=`${e}} while(${Ls(this.condition.toWebGL2(e,t))});\n`,r}toWGSL(e,t){let r=`${e}loop {\n`;return r+=super.toWGSL(e+" ",t),r+=`${e}  if (!(${Ls(this.condition.toWGSL(e,t))})) { break; }\n`,r+=`${e}}\n`,r}}class li extends Os{condition;constructor(e){super(),this.condition=e,this.condition instanceof ii&&(this.condition.isStatement=!1)}toWebGL(e,t){let r=`${e}for(int z_tmp_counter = 0; z_tmp_counter == 0; z_tmp_counter += 0) {\n`;const s=e+"  ";return r+=`${s}if(!(${Ls(this.condition.toWebGL(e,t))})){ break; }\n`,r+=super.toWebGL(s,t),r+=`${e}}\n`,r}toWebGL2(e,t){let r=`${e}while(${Ls(this.condition.toWebGL2(e,t))}) {\n`;return r+=super.toWebGL2(e+"  ",t),r+=`${e}}\n`,r}toWGSL(e,t){let r=`${e}for(;${Ls(this.condition.toWGSL(e,t))};) {\n`;return r+=super.toWGSL(e+"  ",t),r+=`${e}}\n`,r}}class ci extends Is{type;prefix;builtin;constructor(e,t){super(),this.prefix=null,this.builtin=t,this.type=e}getType(){return this.type}toWebGL(e,t){if(this.builtin)return"";{let t=`${e}struct ${this.type.structName} {\n`;for(const r of this.type.structMembers)t+=`${e}  ${r.type.toTypeName("webgl",r.name)};\n`;return t+=`${e}};\n`,t}}toWebGL2(e,t){if(this.builtin)return"";{let t=`${e}struct ${this.type.structName} {\n`;for(const r of this.type.structMembers)t+=`${e}  ${r.type.toTypeName("webgl2",r.name)};\n`;return t+=`${e}};\n`,t}}toWGSL(e,t){if(this.builtin)return"";{let t=`${e}struct ${this.type.structName} {\n`;return t+=this.type.structMembers.map(((t,r)=>{const s=this.prefix?this.prefix[r]:"",i=t.type.getLayoutSize(this.type.layout)!==t.type.getLayoutSize("default")?`@size(${t.type.getLayoutSize(this.type.layout)}) `:"",n=r>0&&t.type.getLayoutAlignment(this.type.layout)!==t.type.getLayoutAlignment("default")?`@align(${t.type.getLayoutAlignment(this.type.layout)}) `:"";return`${e}  ${s}${n}${i}${t.type.toTypeName("webgpu",t.name)}`})).join(",\n"),t+=`\n${e}};\n`,t}}}function pi(e,t){if(e.length!==t.argTypes.length)return null;const r=[];for(let s=0;s<e.length;s++){const i=!!t.argTypes[s].byRef,n=i?t.argTypes[s].type.pointerType:t.argTypes[s].type,a=e[s];if("number"==typeof a){if(i||!n.isPrimitiveType()||!n.isScalarType()||n.primitiveType===X.BOOL)return null;r.push(new ks(a,n))}else if("boolean"==typeof a){if(i||!n.isPrimitiveType()||n.primitiveType!==X.BOOL)return null;r.push(new ks(a,n))}else{if(!n.isCompatibleType(a.getType()))return null;i?(a.markWritable(),r.push(new Ys(a))):r.push(a)}}return{name:t.name,args:r}}class fi{_builder;_tagList;_attribList;constructor(e){this._builder=e,this._tagList={},this._attribList={}}get vertexAttributes(){return this._builder.getVertexAttributes()}hasVertexAttribute(e){return this.vertexAttributes.indexOf(e)>=0}clear(){this._tagList={},this._attribList={}}tag(e,t){if("string"==typeof e){if(void 0===t)return this.getTag(e);this.addTag(e,t)}else for(const t of Object.keys(e))this.addTag(t,e[t])}attribute(e){return this._attribList[e]||null}setAttrib(e,t){this._attribList[e]=t}addTag(e,t){this._tagList[e]=t}getTag(e){const t=this._tagList[e];return t?t(this._builder.getGlobalScope()):null}}let di=null;const mi=new Map;function _i(e){di=e}function gi(){return di}function xi(e,t){return new Proxy(e,{get:function(r,s){if("symbol"==typeof s||s in r)return r[s];let i=mi.get(e);i||(i={},mi.set(e,i));let n=i[s];if(!n&&(t.isPrimitiveType()||t.isStructType()||t.isArrayType()||t.isAtomicI32()||t.isAtomicU32()))if("ptr"===s){const e=new ce(t,ne.FUNCTION);n=function(...t){if(1===t.length&&"string"==typeof t[0])return new Ti(t[0],e);throw new Error("Invalid pointer type constructor")}}else{const e=Number(s);if(Number.isInteger(e)&&e>=0){const r=new le(t,e);n=xi((function(...e){if(1===e.length&&"string"==typeof e[0])return new Ti(e[0],r);{const t=new Ti("",r);return t.$ast=new zs(t.$typeinfo,e.map((e=>e instanceof Ti?e.$ast:e))),t}}),r)}}return n&&(i[s]=n),n}})}class yi{proxy;constructor(){return this.proxy=new Proxy(this,{get:function(e,t){return"string"==typeof t?e.$get(t):void 0},set:function(e,t,r){return"string"==typeof t&&e.$set(t,r)}}),this.proxy}get $thisProxy(){return this.proxy}}let bi=0;class Ti extends yi{$uid;$str;$location;$typeinfo;$global;$sampleType;$precision;$ast;$inout;$memberCache;$attrib;$tags;$_group;$declareType;$isBuffer;$readonly;$bindingSize;constructor(e,t){if(super(),!e&&t.isPointerType())throw new Error("no default constructor for pointer type");if(this.$uid=bi++,this.$str=e||"",this.$location=0,this.$global=!1,this.$typeinfo=t,this.$qualifier=null,this.$precision=ys.NONE,this.$ast=new Rs(this),this.$inout=null,this.$memberCache={},this.$attrib=null,this.$tags=[],this.$_group=null,this.$declareType=xs.DECLARE_TYPE_NONE,this.$isBuffer=!1,this.$bindingSize=0,this.$readonly=!1,t.isTextureType())if(t.isDepthTexture())this.$sampleType="depth";else{const e=function(e){switch(e.textureType){case J.TEX_1D:case J.TEX_STORAGE_1D:case J.TEX_2D:case J.TEX_STORAGE_2D:case J.TEX_2D_ARRAY:case J.TEX_STORAGE_2D_ARRAY:case J.TEX_3D:case J.TEX_STORAGE_3D:case J.TEX_CUBE:case J.TEX_EXTERNAL:return new ue(X.F32VEC4);case J.TEX_DEPTH_2D_ARRAY:case J.TEX_DEPTH_2D:case J.TEX_DEPTH_CUBE:return new ue(X.F32);case J.ITEX_2D_ARRAY:case J.ITEX_1D:case J.ITEX_2D:case J.ITEX_3D:case J.ITEX_CUBE:return new ue(X.I32);case J.UTEX_2D_ARRAY:case J.UTEX_1D:case J.UTEX_2D:case J.UTEX_3D:case J.UTEX_CUBE:return new ue(X.U32);default:return null}}(t);e.primitiveType===X.I32?this.$sampleType="sint":e.primitiveType===X.U32?this.$sampleType="uint":this.$sampleType="float"}}get $group(){return this.$_group}set $group(e){this.$_group=e,this.$_group}uniform(e){return this.$declareType=xs.DECLARE_TYPE_UNIFORM,this.$group=e,this.$isBuffer=!1,this}uniformBuffer(e,t=0){if(!this.$typeinfo.isPrimitiveType()&&!this.$typeinfo.isArrayType()&&!this.$typeinfo.isStructType())throw new cs(this.$ast,"only primitive type, array type or structure type can be set as uniform buffer");return this.$declareType=xs.DECLARE_TYPE_UNIFORM,this.$group=e,this.$isBuffer=!0,this.$bindingSize=t,this}workgroup(){return this.$declareType=xs.DECLARE_TYPE_WORKGROUP,this}storage(e){if(!this.$typeinfo.isHostSharable())throw new cs(this.$ast,"type cannot be declared in storage address space");return this.$declareType=xs.DECLARE_TYPE_STORAGE,this.$group=e,this.$isBuffer=!1,this.$readonly=!1,this}storageReadonly(e){return this.storage(e),this.$readonly=!0,this}storageBuffer(e,t=0){if(!(this.$typeinfo.isPrimitiveType()||this.$typeinfo.isArrayType()||this.$typeinfo.isStructType()||this.$typeinfo.isAtomicI32()||this.$typeinfo.isAtomicU32()))throw new cs(this.$ast,"only primitive type, array type or structure type can be set as storage buffer");return this.$declareType=xs.DECLARE_TYPE_STORAGE,this.$group=e,this.$isBuffer=!0,this.$bindingSize=t,this.$readonly=!1,this}storageBufferReadonly(e,t=0){return this.storageBuffer(e,t),this.$readonly=!0,this}inout(){return this.$inout="inout",this}out(){return this.$inout="out",this}attrib(e){return this.$declareType=xs.DECLARE_TYPE_IN,this.$attrib=e,this}tag(...e){return e.forEach((e=>{this.$tags.indexOf(e)<0&&this.$tags.push(e)})),this}sampleType(e){return e&&(this.$sampleType=e),this}at(e){const t=this.$ast.getType();if(!(t.isArrayType()||t.isPrimitiveType()&&(t.isVectorType()||t.isMatrixType())))throw new Error("at() function must be used with array types");let r,s=null;t.isArrayType()?(s=t.elementType,r=t.dimension):t.isVectorType()?(s=ue.getCachedTypeInfo(t.resizeType(1,1)),r=t.cols):t.isMatrixType()&&(s=ue.getCachedTypeInfo(t.resizeType(1,t.cols)),r=t.rows);const i=new Ti("",s);if("number"==typeof e){if(!Number.isInteger(e))throw new Error("at() array index must be integer type");if(e<0||r>0&&e>=r)throw new Error("at() array index out of bounds");i.$ast=new Zs(this.$ast,new ks(e,Te),s)}else{const t=e.$ast.getType();if(!t.isPrimitiveType()||!t.isScalarType())throw new Error("at() array index must be scalar type");let r=e.$ast;t.scalarType!==X.I32&&t.scalarType!==X.U32&&(r=new Xs(r,Te)),i.$ast=new Zs(this.$ast,r,s)}return i}setAt(e,t){const r=this.$ast.getType();if(!r.isArrayType())throw new Error("setAt() function must be used with array types");if("number"==typeof e){if(!Number.isInteger(e))throw new Error("setAt() array index must be integer type");if(e<0||r.dimension>0&&e>=r.dimension)throw new Error("setAt() array index out of bounds")}di.getCurrentScope().$ast.statements.push(new Js(new Ns(new Gs(this.$ast),"number"==typeof e?new ks(e,Te):e.$ast,r.elementType),t instanceof Ti?t.$ast:t))}highp(){return this.$precision=ys.HIGH,this}mediump(){return this.$precision=ys.MEDIUM,this}lowp(){return this.$precision=ys.LOW,this}isConstructor(){return this.$ast instanceof zs&&0===this.$ast.args.length}isVector(){const e=this.$ast.getType();return e.isPrimitiveType()&&e.isVectorType()}numComponents(){const e=this.$ast.getType();return e.isPrimitiveType()?e.cols:0}getTypeName(){return this.$ast.getType().toTypeName(di.getDevice().type)}$get(e){if("string"==typeof e){if("$"===e[0]||e in this)return this[e];{let t=this.$memberCache[e];if(!t){const r=this.$ast?.getType()||this.$typeinfo,s=Number(e);if(Number.isNaN(s))if(r.isStructType()){const s=r.structMembers.findIndex((t=>t.name===e));if(s<0)throw new Error(`unknown struct member '${e}'`);const i=r.structMembers[s];if(i.type.isStructType()){t=di.structInfo.structs[i.type.structName].call(di,`${this.$str}.${e}`)}else t=new Ti(`${this.$str}.${e}`,i.type);t.$ast=new Ws(this.$ast,e,i.type)}else{if(!r.isPrimitiveType()||!r.isVectorType())throw new Error(`invalid index operation: ${this.$ast.toString(di.getDevice().type)}[${e}]`);if(0===e.length||e.length>4||[...e].some((e=>"xyzw".slice(0,r.cols).indexOf(e)<0))&&[...e].some((e=>"rgba".slice(0,r.cols).indexOf(e)<0)))throw new Error(`unknown swizzle target: ${this.$ast.toString(di.getDevice().type)}[${e}]`);const s=ue.getCachedTypeInfo(r.resizeType(1,e.length));t=new Ti("",s),t.$ast=new Ws(this.$ast,e,s)}else if(r.isArrayType())t=this.at(s);else if(r.isPrimitiveType()&&r.isVectorType()){if(s>=r.cols)throw new Error(`component index out of bounds: ${this.$str}[${s}]`);t=this.$get("xyzw"[s])}else{if(!r.isPrimitiveType()||!r.isMatrixType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);{const e=ue.getCachedTypeInfo(r.resizeType(1,r.cols));t=new Ti("",e),t.$ast=new Zs(this.$ast,new ks(s,Te),e)}}this.$memberCache[e]=t}return t}}}$set(e,t){if("string"==typeof e){if("$"===e[0]||e in this)this[e]=t;else{if("number"!=typeof t&&"boolean"!=typeof t&&!(t instanceof Ti))throw new Error("Invalid output value assignment");const r=this.$ast?.getType()||this.$typeinfo,s=Number(e);if(Number.isNaN(s))if(r.isStructType()){const s=r.structMembers.findIndex((t=>t.name===e));if(s<0)throw new Error(`unknown struct member '${e}`);const i=r.structMembers[s];let n;if("number"==typeof t||"boolean"==typeof t){if(!i.type.isPrimitiveType()||!i.type.isScalarType())throw new Error(`can not set struct member '${e}: invalid value type`);n=new ks(t,i.type)}else t instanceof Ti&&(n=t.$ast);if(!n)throw new Error(`can not set struct member '${e}: invalid value type`);di.getCurrentScope().$ast.statements.push(new Js(new Ps(new Gs(this.$ast),e,i.type),n))}else{if(e.length>1||"xyzw".indexOf(e)<0&&"rgba".indexOf(e)<0)throw new Error(`invalid index operation: ${this.$str}[${s}]`);if(!r.isPrimitiveType()||!r.isVectorType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);const i=ue.getCachedTypeInfo(r.scalarType);di.getCurrentScope().$ast.statements.push(new Js(new Ps(new Gs(this.$ast),e,i),t instanceof Ti?t.$ast:t))}else if(r.isArrayType())this.setAt(s,t);else if(r.isPrimitiveType()&&r.isVectorType()){if(s>=r.cols)throw new Error(`component index out of bounds: ${this.$str}[${s}]`);this.$set("xyzw"[s],t)}else{if(!r.isPrimitiveType()||!r.isMatrixType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);{if(!(t instanceof Ti))throw new Error(`invalid matrix column vector assignment: ${this.$str}[${s}]`);const e=ue.getCachedTypeInfo(r.resizeType(1,r.cols));di.getCurrentScope().$ast.statements.push(new Js(new Ns(new Gs(this.$ast),new ks(s,Te),e),t.$ast))}}}return!0}return!1}}const wi=[[me,_e,ge,xe],[Te,we,ve,Ee],[Ce,Se,$e,Ae],[Le,Ie,Be,De]],vi=[Oe,Fe,Me,Re,Ve,Ge,Pe,Ne,Ue];function Ei(e,t,...r){const s="webgl"===e.getDevice().type?Bi:"webgl2"===e.getDevice().type?Di:Oi,i=Ri?.[t].overloads.filter((e=>!!(e[1]&s))).map((e=>e[0]));if(!i||0===i.length)throw new hs(`builtin shader function '${t}'`);const n=r.map((t=>e.normalizeExpValue(t))),a=e._matchFunctionOverloading(i,n);if(!a)throw new as(t);return a}function Ci(e,t){return e.$callFunction(t[0].name,t[1],t[0])}function Si(e,t,...r){return Ci(e,Ei(e,t,...r))}function $i(e,t,r,s){const i=[];for(let n=0;n<vi.length;n++){const a=r||vi[n],o=s.map((e=>({type:e||vi[n]})));i.push([new ai(e,null,!1,new de(e,a,o),!0),t])}return i}function Ai(e,t,r,s,i){if(s.findIndex((e=>"number"==typeof e))<0)return[[new ai(e,null,!1,new de(e,r,s.map((e=>({type:e})))),!0),t]];{const n=[];let a=i?1:0;for(;a<4;a++){const i="number"==typeof r?wi[r][a]:r,o=s.map((e=>"number"==typeof e?{type:wi[e][a]}:{type:e}));n.push([new ai(e,null,!1,new de(e,i,o),!0),t])}return n}}function Li(e,t,r){const s=new Ti("",r);return s.$ast=new Hs(e,t,r),s}function Ii(e,t,r,s){const i=new Ti("",s);return i.$ast=new qs(e,t,r,s),i}const Bi=1,Di=2,Oi=4,Fi=Bi|Di,Mi=Fi|Oi,Ri={add_2:{overloads:[...Ai("",Mi,0,[0,0]),...Ai("",Mi,1,[1,1]),...Ai("",Mi,2,[2,2]),...Ai("",Mi,3,[3,3]),...Ai("",Mi,_e,[me,_e]),...Ai("",Mi,_e,[_e,me]),...Ai("",Mi,ge,[me,ge]),...Ai("",Mi,ge,[ge,me]),...Ai("",Mi,xe,[me,xe]),...Ai("",Mi,xe,[xe,me]),...Ai("",Mi,we,[Te,we]),...Ai("",Mi,we,[we,Te]),...Ai("",Mi,ve,[Te,ve]),...Ai("",Mi,ve,[ve,Te]),...Ai("",Mi,Ee,[Te,Ee]),...Ai("",Mi,Ee,[Ee,Te]),...Ai("",Mi,Se,[Ce,Se]),...Ai("",Mi,Se,[Se,Ce]),...Ai("",Mi,$e,[Ce,$e]),...Ai("",Mi,$e,[$e,Ce]),...Ai("",Mi,Ae,[Ce,Ae]),...Ai("",Mi,Ae,[Ae,Ce]),...$i("",Mi,null,[null,null])],normalizeFunc(e,t,...r){if(2===r.length&&"number"==typeof r[0]&&"number"==typeof r[1])return r[0]+r[1];const s=Ei(e,t,...r);return Ii(s[1][0],s[1][1],"+",s[0].returnType)}},add:{overloads:[],normalizeFunc(e,t,...r){if(r.length<2)throw new ss("add");let s=r[0];for(let t=1;t<r.length;t++)s=e.add_2(s,r[t]);return s}},sub:{overloads:[...Ai("",Mi,0,[0,0]),...Ai("",Mi,1,[1,1]),...Ai("",Mi,2,[2,2]),...Ai("",Mi,3,[3,3]),...Ai("",Mi,_e,[me,_e]),...Ai("",Mi,_e,[_e,me]),...Ai("",Mi,ge,[me,ge]),...Ai("",Mi,ge,[ge,me]),...Ai("",Mi,xe,[me,xe]),...Ai("",Mi,xe,[xe,me]),...Ai("",Mi,we,[Te,we]),...Ai("",Mi,we,[we,Te]),...Ai("",Mi,ve,[Te,ve]),...Ai("",Mi,ve,[ve,Te]),...Ai("",Mi,Ee,[Te,Ee]),...Ai("",Mi,Ee,[Ee,Te]),...Ai("",Mi,Se,[Ce,Se]),...Ai("",Mi,Se,[Se,Ce]),...Ai("",Mi,$e,[Ce,$e]),...Ai("",Mi,$e,[$e,Ce]),...Ai("",Mi,Ae,[Ce,Ae]),...Ai("",Mi,Ae,[Ae,Ce]),...$i("",Mi,null,[null,null])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return Ii(s[1][0],s[1][1],"-",s[0].returnType)}},div:{overloads:[...Ai("",Mi,0,[0,0]),...Ai("",Mi,1,[1,1]),...Ai("",Mi,2,[2,2]),...Ai("",Mi,3,[3,3]),...Ai("",Mi,_e,[me,_e]),...Ai("",Mi,_e,[_e,me]),...Ai("",Mi,ge,[me,ge]),...Ai("",Mi,ge,[ge,me]),...Ai("",Mi,xe,[me,xe]),...Ai("",Mi,xe,[xe,me]),...Ai("",Mi,we,[Te,we]),...Ai("",Mi,we,[we,Te]),...Ai("",Mi,ve,[Te,ve]),...Ai("",Mi,ve,[ve,Te]),...Ai("",Mi,Ee,[Te,Ee]),...Ai("",Mi,Ee,[Ee,Te]),...Ai("",Mi,Se,[Ce,Se]),...Ai("",Mi,Se,[Se,Ce]),...Ai("",Mi,$e,[Ce,$e]),...Ai("",Mi,$e,[$e,Ce]),...Ai("",Mi,Ae,[Ce,Ae]),...Ai("",Mi,Ae,[Ae,Ce])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return Ii(s[1][0],s[1][1],"/",s[0].returnType)}},mul_2:{overloads:[...Ai("",Mi,0,[0,0]),...Ai("",Mi,1,[1,1]),...Ai("",Mi,2,[2,2]),...Ai("",Mi,3,[3,3]),...Ai("",Mi,_e,[me,_e]),...Ai("",Mi,_e,[_e,me]),...Ai("",Mi,ge,[me,ge]),...Ai("",Mi,ge,[ge,me]),...Ai("",Mi,xe,[me,xe]),...Ai("",Mi,xe,[xe,me]),...Ai("",Mi,we,[Te,we]),...Ai("",Mi,we,[we,Te]),...Ai("",Mi,ve,[Te,ve]),...Ai("",Mi,ve,[ve,Te]),...Ai("",Mi,Ee,[Te,Ee]),...Ai("",Mi,Ee,[Ee,Te]),...Ai("",Mi,Se,[Ce,Se]),...Ai("",Mi,Se,[Se,Ce]),...Ai("",Mi,$e,[Ce,$e]),...Ai("",Mi,$e,[$e,Ce]),...Ai("",Mi,Ae,[Ce,Ae]),...Ai("",Mi,Ae,[Ae,Ce]),...$i("",Mi,null,[me,null]),...$i("",Mi,null,[null,me]),...Ai("",Mi,Oe,[Oe,Oe]),...Ai("",Mi,Re,[Oe,Re]),...Ai("",Mi,Pe,[Oe,Pe]),...Ai("",Mi,_e,[Oe,_e]),...Ai("",Mi,_e,[_e,Oe]),...Ai("",Mi,Fe,[Fe,Oe]),...Ai("",Mi,Ve,[Fe,Re]),...Ai("",Mi,Ne,[Fe,Pe]),...Ai("",Mi,ge,[Fe,_e]),...Ai("",Mi,_e,[ge,Fe]),...Ai("",Mi,Me,[Me,Oe]),...Ai("",Mi,Ge,[Me,Re]),...Ai("",Mi,Ue,[Me,Pe]),...Ai("",Mi,xe,[Me,_e]),...Ai("",Mi,_e,[xe,Me]),...Ai("",Mi,Oe,[Re,Fe]),...Ai("",Mi,Re,[Re,Ve]),...Ai("",Mi,Pe,[Re,Ne]),...Ai("",Mi,_e,[Re,ge]),...Ai("",Mi,ge,[_e,Re]),...Ai("",Mi,Fe,[Ve,Fe]),...Ai("",Mi,Ve,[Ve,Ve]),...Ai("",Mi,Ne,[Ve,Ne]),...Ai("",Mi,ge,[Ve,ge]),...Ai("",Mi,ge,[ge,Ve]),...Ai("",Mi,Me,[Ge,Fe]),...Ai("",Mi,Ge,[Ge,Ve]),...Ai("",Mi,Ue,[Ge,Ne]),...Ai("",Mi,xe,[Ge,ge]),...Ai("",Mi,ge,[xe,Ge]),...Ai("",Mi,Oe,[Pe,Me]),...Ai("",Mi,Re,[Pe,Ge]),...Ai("",Mi,Pe,[Pe,Ue]),...Ai("",Mi,_e,[Pe,xe]),...Ai("",Mi,xe,[_e,Pe]),...Ai("",Mi,Fe,[Ne,Me]),...Ai("",Mi,Ve,[Ne,Ge]),...Ai("",Mi,Ne,[Ne,Ue]),...Ai("",Mi,ge,[Ne,xe]),...Ai("",Mi,xe,[ge,Ne]),...Ai("",Mi,Me,[Ue,Me]),...Ai("",Mi,Ge,[Ue,Ge]),...Ai("",Mi,Ue,[Ue,Ue]),...Ai("",Mi,xe,[Ue,xe]),...Ai("",Mi,xe,[xe,Ue])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return Ii(s[1][0],s[1][1],"*",s[0].returnType)}},mul:{overloads:[],normalizeFunc(e,t,...r){if(r.length<2)throw new ss("mul");let s=r[0];for(let t=1;t<r.length;t++)s=e.mul_2(s,r[t]);return s}},mod:{overloads:[...Ai("mod",Mi,0,[0,0]),...Ai("mod",Mi,1,[1,1]),...Ai("mod",Mi,2,[2,2]),...Ai("mod",Mi,3,[3,3])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r),i=s[1][0].getType(),n=i.isPrimitiveType()&&(i.scalarType===X.I32||i.scalarType===X.U32);if("webgl"===e.getDevice().type&&n)throw new hs("integer modulus");return"webgpu"===e.getDevice().type||n?Ii(s[1][0],s[1][1],"%",s[0].returnType):Ci(e,s)}},radians:{overloads:Ai("radians",Mi,0,[0])},degrees:{overloads:Ai("degrees",Mi,0,[0])},sin:{overloads:Ai("sin",Mi,0,[0])},cos:{overloads:Ai("cos",Mi,0,[0])},tan:{overloads:Ai("tan",Mi,0,[0])},asin:{overloads:Ai("asin",Mi,0,[0])},acos:{overloads:Ai("acos",Mi,0,[0])},atan:{overloads:Ai("atan",Mi,0,[0])},atan2:{overloads:[...Ai("atan",Fi,0,[0,0]),...Ai("atan2",Oi,0,[0,0])]},sinh:{overloads:Ai("sinh",Di|Oi,0,[0])},cosh:{overloads:Ai("cosh",Di|Oi,0,[0])},tanh:{overloads:Ai("tanh",Di|Oi,0,[0])},asinh:{overloads:Ai("asinh",Di,0,[0])},acosh:{overloads:Ai("acosh",Di,0,[0])},atanh:{overloads:Ai("atanh",Di,0,[0])},pow:{overloads:Ai("pow",Mi,0,[0,0])},exp:{overloads:Ai("exp",Mi,0,[0])},exp2:{overloads:Ai("exp2",Mi,0,[0])},log:{overloads:Ai("log",Mi,0,[0])},log2:{overloads:Ai("log2",Mi,0,[0])},sqrt:{overloads:Ai("sqrt",Mi,0,[0])},inverseSqrt:{overloads:[...Ai("inversesqrt",Fi,0,[0]),...Ai("inverseSqrt",Oi,0,[0])]},abs:{overloads:[...Ai("abs",Mi,0,[0]),...Ai("abs",Di|Oi,1,[1]),...Ai("abs",Oi,2,[2])]},sign:{overloads:[...Ai("sign",Mi,0,[0]),...Ai("sign",Di,1,[1])]},floor:{overloads:Ai("floor",Mi,0,[0])},ceil:{overloads:Ai("ceil",Mi,0,[0])},fract:{overloads:Ai("fract",Mi,0,[0])},fma:{overloads:Ai("fma",Mi,0,[0,0,0]),normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return"webgpu"===e.getDevice().type?Ci(e,s):e.add(e.mul(r[0],r[1]),r[2])}},round:{overloads:Ai("round",Oi,0,[0])},trunc:{overloads:Ai("trunc",Oi,0,[0])},min:{overloads:[...Ai("min",Mi,0,[0,0]),...Ai("min",Di|Oi,1,[1,1]),...Ai("min",Di|Oi,2,[2,2])]},max:{overloads:[...Ai("max",Mi,0,[0,0]),...Ai("max",Di|Oi,1,[1,1]),...Ai("max",Di|Oi,2,[2,2])]},clamp:{overloads:[...Ai("clamp",Mi,0,[0,0,0]),...Ai("clamp",Di|Oi,1,[1,1,1]),...Ai("clamp",Di|Oi,2,[2,2,2])]},mix:{overloads:[...Ai("mix",Mi,0,[0,0,0]),...Ai("mix",Mi,0,[0,0,me])]},step:{overloads:Ai("step",Mi,0,[0,0])},smoothStep:{overloads:Ai("smoothstep",Mi,0,[0,0,0])},isnan:{overloads:Ai("isnan",Di,3,[0])},isinf:{overloads:Ai("isinf",Di,3,[0])},length:{overloads:Ai("length",Mi,me,[0])},distance:{overloads:Ai("distance",Mi,me,[0,0])},dot:{overloads:[...Ai("dot",Mi,me,[0,0],!0),...Ai("dot",Oi,Te,[1,1],!0),...Ai("dot",Oi,Ce,[2,2],!0)]},cross:{overloads:Ai("cross",Mi,ge,[ge,ge])},normalize:{overloads:Ai("normalize",Mi,0,[0],!0)},faceForward:{overloads:[...Ai("faceforward",Fi,0,[0,0,0],!0),...Ai("faceForward",Oi,0,[0,0,0],!0)]},reflect:{overloads:Ai("reflect",Mi,0,[0,0],!0)},refract:{overloads:Ai("refract",Mi,0,[0,0,me],!0)},frexp:{overloads:[...Ai("frexp",Oi,Br,[me]),...Ai("frexp",Oi,Dr,[_e]),...Ai("frexp",Oi,Or,[ge]),...Ai("frexp",Oi,Fr,[xe])]},outerProduct:{overloads:[...Ai("outerProduct",Di,Oe,[_e,_e]),...Ai("outerProduct",Di,Ve,[ge,ge]),...Ai("outerProduct",Di,Ue,[xe,xe]),...Ai("outerProduct",Di,Fe,[ge,_e]),...Ai("outerProduct",Di,Re,[_e,ge]),...Ai("outerProduct",Di,Me,[xe,_e]),...Ai("outerProduct",Di,Pe,[_e,xe]),...Ai("outerProduct",Di,Ge,[xe,ge]),...Ai("outerProduct",Di,Ne,[ge,xe])]},transpose:{overloads:[...Ai("transpose",Di|Oi,Oe,[Oe]),...Ai("transpose",Di|Oi,Ve,[Ve]),...Ai("transpose",Di|Oi,Ue,[Ue]),...Ai("transpose",Di|Oi,Fe,[Re]),...Ai("transpose",Di|Oi,Re,[Fe]),...Ai("transpose",Di|Oi,Me,[Pe]),...Ai("transpose",Di|Oi,Pe,[Me]),...Ai("transpose",Di|Oi,Ge,[Ne]),...Ai("transpose",Di|Oi,Ne,[Ge])]},determinant:{overloads:[...Ai("determinant",Di|Oi,me,[Oe]),...Ai("determinant",Di|Oi,me,[Ve]),...Ai("determinant",Di|Oi,me,[Ue])]},inverse:{overloads:[...Ai("inverse",Di,Oe,[Oe]),...Ai("inverse",Di,Ve,[Ve]),...Ai("inverse",Di,Ue,[Ue])]},lessThan:{overloads:[...Ai("lessThan",Mi,3,[0,0]),...Ai("lessThan",Mi,3,[1,1]),...Ai("lessThan",Mi,3,[2,2])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?Ii(s[1][0],s[1][1],"<",s[0].returnType):Ci(e,s)}},lessThanEqual:{overloads:[...Ai("lessThanEqual",Mi,3,[0,0]),...Ai("lessThanEqual",Mi,3,[1,1]),...Ai("lessThanEqual",Mi,3,[2,2])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?Ii(s[1][0],s[1][1],"<=",s[0].returnType):Ci(e,s)}},greaterThan:{overloads:[...Ai("greaterThan",Mi,3,[0,0]),...Ai("greaterThan",Mi,3,[1,1]),...Ai("greaterThan",Mi,3,[2,2])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?Ii(s[1][0],s[1][1],">",s[0].returnType):Ci(e,s)}},greaterThanEqual:{overloads:[...Ai("greaterThanEqual",Mi,3,[0,0]),...Ai("greaterThanEqual",Mi,3,[1,1]),...Ai("greaterThanEqual",Mi,3,[2,2])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?Ii(s[1][0],s[1][1],">=",s[0].returnType):Ci(e,s)}},compEqual:{overloads:[...Ai("equal",Mi,3,[0,0]),...Ai("equal",Mi,3,[1,1]),...Ai("equal",Mi,3,[2,2]),...Ai("equal",Mi,3,[3,3])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?Ii(s[1][0],s[1][1],"==",s[0].returnType):Ci(e,s)}},compNotEqual:{overloads:[...Ai("notEqual",Mi,3,[0,0]),...Ai("notEqual",Mi,3,[1,1]),...Ai("notEqual",Mi,3,[2,2]),...Ai("notEqual",Mi,3,[3,3])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?Ii(s[1][0],s[1][1],"!=",s[0].returnType):Ci(e,s)}},equal:{overloads:[...Ai("equal",Mi,Le,[0,0]),...Ai("equal",Mi,Le,[1,1]),...Ai("equal",Mi,Le,[2,2]),...Ai("equal",Mi,Le,[3,3])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type&&i.isPrimitiveType()&&!i.isScalarType()?e.all(e.compEqual(r[0],r[1])):Ii(s[1][0],s[1][1],"==",s[0].returnType)}},notEqual:{overloads:[...Ai("notEqual",Mi,Le,[0,0]),...Ai("notEqual",Mi,Le,[1,1]),...Ai("notEqual",Mi,Le,[2,2]),...Ai("notEqual",Mi,Le,[3,3])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type&&i.isPrimitiveType()&&!i.isScalarType()?e.any(e.compNotEqual(r[0],r[1])):Ii(s[1][0],s[1][1],"!=",s[0].returnType)}},any:{overloads:Ai("any",Mi,Le,[3],!0)},all:{overloads:Ai("all",Mi,Le,[3],!0)},not:{overloads:Ai("not",Mi,3,[3]),normalizeFunc(e,t,...r){const s=Ei(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?Li(s[1][0],"!",s[0].returnType):Ci(e,s)}},neg:{overloads:[...Ai("neg",Mi,0,[0]),...Ai("neg",Mi,1,[1])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return Li(s[1][0],"-",s[0].returnType)}},or_2:{overloads:Ai("or",Mi,Le,[3,3]),normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return Ii(s[1][0],s[1][1],"||",s[0].returnType)}},or:{overloads:[],normalizeFunc(e,t,...r){if(r.length<2)throw new ss("or");let s=r[0];for(let t=1;t<r.length;t++)s=e.or_2(s,r[t]);return s}},compOr:{overloads:[...Ai("compOr",Di|Oi,1,[1,1]),...Ai("compOr",Di|Oi,2,[2,2])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return Ii(s[1][0],s[1][1],"|",s[0].returnType)}},and_2:{overloads:Ai("and",Mi,Le,[3,3]),normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return Ii(s[1][0],s[1][1],"&&",s[0].returnType)}},and:{overloads:[],normalizeFunc(e,t,...r){if(r.length<2)throw new ss("and");let s=r[0];for(let t=1;t<r.length;t++)s=e.and_2(s,r[t]);return s}},compAnd:{overloads:[...Ai("compAnd",Di|Oi,1,[1,1]),...Ai("compAnd",Di|Oi,2,[2,2])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return Ii(s[1][0],s[1][1],"&",s[0].returnType)}},compXor:{overloads:[...Ai("compXor",Di|Oi,1,[1,1]),...Ai("compXor",Di|Oi,2,[2,2])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return Ii(s[1][0],s[1][1],"^",s[0].returnType)}},sal:{overloads:[...Ai("sal",Di|Oi,1,[1,2]),...Ai("sal",Di|Oi,2,[2,2])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return Ii(s[1][0],s[1][1],"<<",s[0].returnType)}},sar:{overloads:[...Ai("sar",Di|Oi,1,[1,2]),...Ai("sar",Di|Oi,2,[2,2])],normalizeFunc(e,t,...r){const s=Ei(e,t,...r);return Ii(s[1][0],s[1][1],">>",s[0].returnType)}},arrayLength:{overloads:[],normalizeFunc(e,t,...r){if(1!==r.length)throw new ss("arrayLength");if(!(r[0]instanceof Ti))throw new ns("arrayLength","array");const s=r[0].$ast.getType(),i=s.isPointerType()?s.pointerType:s;if(!i.isArrayType()||0!==i.dimension)throw new is("arrayLength","array");const n=s.isArrayType()?e.addressOf(r[0]).$ast:r[0].$ast;return e.$callFunctionNoCheck(t,[n],Ce)}},select:{overloads:[...Ai("select",Oi,0,[0,0,Le]),...Ai("select",Oi,1,[1,1,Le]),...Ai("select",Oi,2,[2,2,Le]),...Ai("select",Oi,3,[3,3,Le]),...Ai("select",Oi,0,[0,0,3],!0),...Ai("select",Oi,1,[1,1,3],!0),...Ai("select",Oi,2,[2,2,3],!0),...Ai("select",Oi,3,[3,3,3],!0),...Ai("mix",Di,0,[0,0,3]),...Ai("mix",Di,1,[1,1,3]),...Ai("mix",Di,2,[2,2,3])]},floatBitsToInt:{overloads:Ai("floatBitsToInt",Di,1,[0]),normalizeFunc(e,t,...r){if(1!==r.length)throw new ss("floatBitsToInt");if(r[0]instanceof Ti){if(r[0].$ast.getType().typeId!==me.typeId)throw new is("floatBitsToInt","x")}else if("number"!=typeof r[0])throw new ns("floatBitsToInt","x");return"webgpu"===e.getDevice().type?e.$callFunctionNoCheck("bitcast<i32>",[r[0]instanceof Ti?r[0].$ast:new ks(r[0],me)],Te):Si(e,t,...r)}},floatBitsToUint:{overloads:Ai("floatBitsToUint",Di,2,[0]),normalizeFunc(e,t,...r){if(1!==r.length)throw new ss("floatBitsToUint");if(r[0]instanceof Ti){if(r[0].$ast.getType().typeId!==me.typeId)throw new is("floatBitsToUint","x")}else if("number"!=typeof r[0])throw new ns("floatBitsToUint","x");return"webgpu"===e.getDevice().type?e.$callFunctionNoCheck("bitcast<u32>",[r[0]instanceof Ti?r[0].$ast:new ks(r[0],me)],Ce):Si(e,t,...r)}},intBitsToFloat:{overloads:Ai("intBitsToFloat",Di,0,[1]),normalizeFunc(e,t,...r){if(1!==r.length)throw new ss("intBitsToFloat");if(r[0]instanceof Ti){if(r[0].$ast.getType().typeId!==Te.typeId)throw new is("intBitsToFloat","x")}else if("number"!=typeof r[0])throw new ns("intBitsToFloat","x");return"webgpu"===e.getDevice().type?e.$callFunctionNoCheck("bitcast<f32>",[r[0]instanceof Ti?r[0].$ast:new ks(r[0],Te)],me):Si(e,t,...r)}},uintBitsToFloat:{overloads:Ai("uintBitsToFloat",Di,0,[2]),normalizeFunc(e,t,...r){if(1!==r.length)throw new ss("uintBitsToFloat");if(r[0]instanceof Ti){if(r[0].$ast.getType().typeId!==Ce.typeId)throw new is("uintBitsToFloat","x")}else if("number"!=typeof r[0])throw new ns("uintBitsToFloat","x");return"webgpu"===e.getDevice().type?e.$callFunctionNoCheck("bitcast<f32>",[r[0]instanceof Ti?r[0].$ast:new ks(r[0],Ce)],me):Si(e,t,...r)}},pack4x8snorm:{overloads:Ai("pack4x8snorm",Oi,Ce,[xe])},unpack4x8snorm:{overloads:Ai("unpack4x8snorm",Oi,xe,[Ce])},pack4x8unorm:{overloads:Ai("pack4x8unorm",Oi,Ce,[xe])},unpack4x8unorm:{overloads:Ai("unpack4x8unorm",Oi,xe,[Ce])},pack2x16snorm:{overloads:[...Ai("pack2x16snorm",Oi,Ce,[_e]),...Ai("packSnorm2x16",Di,Ce,[_e])]},unpack2x16snorm:{overloads:[...Ai("unpack2x16snorm",Oi,_e,[Ce]),...Ai("unpackSnorm2x16",Di,_e,[Ce])]},pack2x16unorm:{overloads:[...Ai("pack2x16unorm",Oi,Ce,[_e]),...Ai("packUnorm2x16",Di,Ce,[_e])]},unpack2x16unorm:{overloads:[...Ai("unpack2x16unorm",Oi,_e,[Ce]),...Ai("unpackUnorm2x16",Di,_e,[Ce])]},pack2x16float:{overloads:[...Ai("pack2x16float",Oi,Ce,[_e]),...Ai("packHalf2x16",Di,Ce,[_e])]},unpack2x16float:{overloads:[...Ai("unpack2x16float",Oi,_e,[Ce]),...Ai("unpackHalf2x16",Di,_e,[Ce])]},matrixCompMult:{overloads:$i("matrixCompMult",Fi,null,[null,null])},dpdx:{overloads:[...Ai("dFdx",Fi,0,[0]),...Ai("dpdx",Oi,0,[0])]},dpdy:{overloads:[...Ai("dFdy",Fi,0,[0]),...Ai("dpdy",Oi,0,[0])]},fwidth:{overloads:Ai("fwidth",Mi,0,[0])},dpdxCoarse:{overloads:[...Ai("dpdxCoarse",Oi,0,[0]),...Ai("dFdx",Fi,0,[0])]},dpdxFine:{overloads:[...Ai("dpdxFine",Oi,0,[0]),...Ai("dFdx",Fi,0,[0])]},dpdyCoarse:{overloads:[...Ai("dpdyCoarse",Oi,0,[0]),...Ai("dFdy",Fi,0,[0])]},dpdyFine:{overloads:[...Ai("dpdyFine",Oi,0,[0]),...Ai("dFdy",Fi,0,[0])]},textureDimensions:{overloads:[...Ai("textureDimensions",Oi,Ce,[ze,Te]),...Ai("textureDimensions",Oi,Ce,[ke,Te]),...Ai("textureDimensions",Oi,Ce,[We,Te]),...Ai("textureDimensions",Oi,Se,[Xe,Te]),...Ai("textureDimensions",Oi,Se,[Ye,Te]),...Ai("textureDimensions",Oi,Se,[je,Te]),...Ai("textureDimensions",Oi,Se,[He,Te]),...Ai("textureDimensions",Oi,Se,[qe,Te]),...Ai("textureDimensions",Oi,Se,[Ze,Te]),...Ai("textureDimensions",Oi,$e,[Qe,Te]),...Ai("textureDimensions",Oi,$e,[Ke,Te]),...Ai("textureDimensions",Oi,$e,[Je,Te]),...Ai("textureDimensions",Oi,Se,[et,Te]),...Ai("textureDimensions",Oi,Se,[tt,Te]),...Ai("textureDimensions",Oi,Se,[rt,Te]),...Ai("textureDimensions",Oi,Se,[it,Te]),...Ai("textureDimensions",Oi,Se,[nt,Te]),...Ai("textureDimensions",Oi,Se,[at,Te]),...Ai("textureDimensions",Oi,Se,[ot]),...Ai("textureDimensions",Oi,Se,[ut]),...Ai("textureDimensions",Oi,Se,[ht]),...Ai("textureDimensions",Oi,Se,[vr,Te]),...Ai("textureDimensions",Oi,Se,[Er,Te]),...Ai("textureDimensions",Oi,Se,[Cr,Te]),...Ai("textureDimensions",Oi,Se,[Sr,Te]),...Ai("textureDimensions",Oi,Se,[$r]),...Ai("textureDimensions",Oi,Ce,[lt]),...Ai("textureDimensions",Oi,Ce,[ct]),...Ai("textureDimensions",Oi,Ce,[ft]),...Ai("textureDimensions",Oi,Ce,[dt]),...Ai("textureDimensions",Oi,Ce,[mt]),...Ai("textureDimensions",Oi,Ce,[_t]),...Ai("textureDimensions",Oi,Ce,[gt]),...Ai("textureDimensions",Oi,Ce,[xt]),...Ai("textureDimensions",Oi,Ce,[yt]),...Ai("textureDimensions",Oi,Ce,[bt]),...Ai("textureDimensions",Oi,Ce,[Tt]),...Ai("textureDimensions",Oi,Ce,[wt]),...Ai("textureDimensions",Oi,Ce,[vt]),...Ai("textureDimensions",Oi,Ce,[Et]),...Ai("textureDimensions",Oi,Ce,[Ct]),...Ai("textureDimensions",Oi,Ce,[St]),...Ai("textureDimensions",Oi,Se,[$t]),...Ai("textureDimensions",Oi,Se,[At]),...Ai("textureDimensions",Oi,Se,[It]),...Ai("textureDimensions",Oi,Se,[Bt]),...Ai("textureDimensions",Oi,Se,[Dt]),...Ai("textureDimensions",Oi,Se,[Ot]),...Ai("textureDimensions",Oi,Se,[Ft]),...Ai("textureDimensions",Oi,Se,[Mt]),...Ai("textureDimensions",Oi,Se,[Rt]),...Ai("textureDimensions",Oi,Se,[Vt]),...Ai("textureDimensions",Oi,Se,[Gt]),...Ai("textureDimensions",Oi,Se,[Pt]),...Ai("textureDimensions",Oi,Se,[Nt]),...Ai("textureDimensions",Oi,Se,[Ut]),...Ai("textureDimensions",Oi,Se,[zt]),...Ai("textureDimensions",Oi,Se,[kt]),...Ai("textureDimensions",Oi,Se,[Wt]),...Ai("textureDimensions",Oi,Se,[Xt]),...Ai("textureDimensions",Oi,Se,[Yt]),...Ai("textureDimensions",Oi,Se,[jt]),...Ai("textureDimensions",Oi,Se,[Ht]),...Ai("textureDimensions",Oi,Se,[qt]),...Ai("textureDimensions",Oi,Se,[Zt]),...Ai("textureDimensions",Oi,Se,[Qt]),...Ai("textureDimensions",Oi,Se,[Kt]),...Ai("textureDimensions",Oi,Se,[Jt]),...Ai("textureDimensions",Oi,Se,[er]),...Ai("textureDimensions",Oi,Se,[tr]),...Ai("textureDimensions",Oi,Se,[rr]),...Ai("textureDimensions",Oi,Se,[sr]),...Ai("textureDimensions",Oi,Se,[ir]),...Ai("textureDimensions",Oi,Se,[nr]),...Ai("textureDimensions",Oi,$e,[ar]),...Ai("textureDimensions",Oi,$e,[or]),...Ai("textureDimensions",Oi,$e,[hr]),...Ai("textureDimensions",Oi,$e,[lr]),...Ai("textureDimensions",Oi,$e,[cr]),...Ai("textureDimensions",Oi,$e,[pr]),...Ai("textureDimensions",Oi,$e,[fr]),...Ai("textureDimensions",Oi,$e,[dr]),...Ai("textureDimensions",Oi,$e,[mr]),...Ai("textureDimensions",Oi,$e,[_r]),...Ai("textureDimensions",Oi,$e,[gr]),...Ai("textureDimensions",Oi,$e,[xr]),...Ai("textureDimensions",Oi,$e,[yr]),...Ai("textureDimensions",Oi,$e,[br]),...Ai("textureDimensions",Oi,$e,[Tr]),...Ai("textureDimensions",Oi,$e,[wr]),...Ai("textureSize",Di,we,[ze,Te]),...Ai("textureSize",Di,we,[Xe,Te]),...Ai("textureSize",Di,we,[ke,Te]),...Ai("textureSize",Di,we,[Ye,Te]),...Ai("textureSize",Di,we,[We,Te]),...Ai("textureSize",Di,we,[je,Te]),...Ai("textureSize",Di,we,[He,Te]),...Ai("textureSize",Di,we,[qe,Te]),...Ai("textureSize",Di,we,[Ze,Te]),...Ai("textureSize",Di,we,[et,Te]),...Ai("textureSize",Di,we,[tt,Te]),...Ai("textureSize",Di,we,[rt,Te]),...Ai("textureSize",Di,ve,[Qe,Te]),...Ai("textureSize",Di,ve,[Ke,Te]),...Ai("textureSize",Di,ve,[Je,Te]),...Ai("textureSize",Di,we,[vr,Te]),...Ai("textureSize",Di,we,[Cr,Te]),...Ai("textureSize",Di,we,[Er,Te])],normalizeFunc(e,t,...r){if(r.length<1||r.length>2)throw new ss("textureDimensions");if(!(r[0]instanceof Ti))throw new ns("textureDimensions","tex");const s=r[0].$ast.getType();if(!s.isTextureType())throw new is("textureDimensions","tex");if("webgpu"===e.getDevice().type){if((s.isMultisampledTexture()||s.isStorageTexture())&&void 0!==r[1])throw new ns("textureDimensions","level");return Si(e,t,...r)}if("webgl2"===e.getDevice().type){const i=r[0],n=r[1]||0;return s.is1DTexture()?Si(e,t,i,n).x:Si(e,t,i,n)}}},textureGather:{overloads:[...Ai("textureGather",Oi,xe,[Te,Xe,Ar,_e]),...Ai("textureGather",Oi,Ee,[Te,Ye,Ar,_e]),...Ai("textureGather",Oi,Ae,[Te,je,Ar,_e]),...Ai("textureGather",Oi,xe,[Te,et,Ar,ge]),...Ai("textureGather",Oi,Ee,[Te,tt,Ar,ge]),...Ai("textureGather",Oi,Ae,[Te,rt,Ar,ge]),...Ai("textureGather",Oi,xe,[vr,Ar,_e]),...Ai("textureGather",Oi,xe,[Cr,Ar,ge])]},textureArrayGather:{overloads:[...Ai("textureGather",Oi,xe,[Te,He,Ar,_e,Te]),...Ai("textureGather",Oi,Ee,[Te,qe,Ar,_e,Te]),...Ai("textureGather",Oi,Ae,[Te,Ze,Ar,_e,Te]),...Ai("textureGather",Oi,xe,[Te,it,Ar,ge,Te]),...Ai("textureGather",Oi,Ee,[Te,nt,Ar,ge,Te]),...Ai("textureGather",Oi,Ae,[Te,at,Ar,ge,Te]),...Ai("textureGather",Oi,xe,[Er,Ar,_e,Te]),...Ai("textureGather",Oi,xe,[Sr,Ar,ge,Te])]},textureGatherCompare:{overloads:[...Ai("textureGatherCompare",Oi,xe,[vr,Lr,_e,me]),...Ai("textureGatherCompare",Oi,xe,[Cr,Lr,ge,me])]},textureArrayGatherCompare:{overloads:[...Ai("textureGatherCompare",Oi,xe,[Er,Lr,_e,Te,me]),...Ai("textureGatherCompare",Oi,xe,[Sr,Lr,ge,Te,me])]},textureLoad:{overloads:[...Ai("textureLoad",Oi,xe,[ze,Te,Te]),...Ai("textureLoad",Oi,Ee,[ke,Te,Te]),...Ai("textureLoad",Oi,Ae,[We,Te,Te]),...Ai("textureLoad",Oi,xe,[pt,Te]),...Ai("textureLoad",Oi,xe,[St,Te]),...Ai("textureLoad",Oi,Ee,[Ct,Te]),...Ai("textureLoad",Oi,Ae,[Et,Te]),...Ai("textureLoad",Oi,xe,[vt,Te]),...Ai("textureLoad",Oi,Ee,[wt,Te]),...Ai("textureLoad",Oi,Ae,[Tt,Te]),...Ai("textureLoad",Oi,xe,[gt,Te]),...Ai("textureLoad",Oi,Ee,[_t,Te]),...Ai("textureLoad",Oi,Ae,[mt,Te]),...Ai("textureLoad",Oi,xe,[bt,Te]),...Ai("textureLoad",Oi,Ee,[yt,Te]),...Ai("textureLoad",Oi,Ae,[xt,Te]),...Ai("textureLoad",Oi,Ee,[dt,Te]),...Ai("textureLoad",Oi,Ae,[ft,Te]),...Ai("textureLoad",Oi,xe,[ct,Te]),...Ai("textureLoad",Oi,xe,[lt,Te]),...Ai("textureLoad",Oi,xe,[Xe,we,Te]),...Ai("textureLoad",Oi,Ee,[Ye,we,Te]),...Ai("textureLoad",Oi,Ae,[je,we,Te]),...Ai("textureLoad",Oi,xe,[Lt,we]),...Ai("textureLoad",Oi,xe,[kt,we]),...Ai("textureLoad",Oi,Ee,[zt,we]),...Ai("textureLoad",Oi,Ae,[Ut,we]),...Ai("textureLoad",Oi,xe,[Nt,we]),...Ai("textureLoad",Oi,Ee,[Pt,we]),...Ai("textureLoad",Oi,Ae,[Gt,we]),...Ai("textureLoad",Oi,xe,[Ft,we]),...Ai("textureLoad",Oi,Ee,[Ot,we]),...Ai("textureLoad",Oi,Ae,[Dt,we]),...Ai("textureLoad",Oi,xe,[Vt,we]),...Ai("textureLoad",Oi,Ee,[Rt,we]),...Ai("textureLoad",Oi,Ae,[Mt,we]),...Ai("textureLoad",Oi,Ee,[Bt,we]),...Ai("textureLoad",Oi,Ae,[It,we]),...Ai("textureLoad",Oi,xe,[At,we]),...Ai("textureLoad",Oi,xe,[$t,we]),...Ai("textureLoad",Oi,xe,[Qe,ve,Te]),...Ai("textureLoad",Oi,Ee,[Ke,ve,Te]),...Ai("textureLoad",Oi,Ae,[Je,ve,Te]),...Ai("textureLoad",Oi,xe,[ur,ve]),...Ai("textureLoad",Oi,xe,[wr,ve]),...Ai("textureLoad",Oi,Ee,[Tr,ve]),...Ai("textureLoad",Oi,Ae,[br,ve]),...Ai("textureLoad",Oi,xe,[yr,ve]),...Ai("textureLoad",Oi,Ee,[xr,ve]),...Ai("textureLoad",Oi,Ae,[gr,ve]),...Ai("textureLoad",Oi,xe,[fr,ve]),...Ai("textureLoad",Oi,Ee,[pr,ve]),...Ai("textureLoad",Oi,Ae,[cr,ve]),...Ai("textureLoad",Oi,xe,[_r,ve]),...Ai("textureLoad",Oi,Ee,[mr,ve]),...Ai("textureLoad",Oi,Ae,[dr,ve]),...Ai("textureLoad",Oi,Ee,[lr,ve]),...Ai("textureLoad",Oi,Ae,[hr,ve]),...Ai("textureLoad",Oi,xe,[or,ve]),...Ai("textureLoad",Oi,xe,[ar,ve]),...Ai("textureLoad",Oi,xe,[ot,we,Te]),...Ai("textureLoad",Oi,Ee,[ut,we,Te]),...Ai("textureLoad",Oi,Ae,[ht,we,Te]),...Ai("textureLoad",Oi,xe,[st,we]),...Ai("textureLoad",Oi,me,[vr,we,Te]),...Ai("textureLoad",Oi,me,[$r,we,Te]),...Ai("texelFetch",Di,xe,[ze,we,Te]),...Ai("texelFetch",Di,xe,[Xe,we,Te]),...Ai("texelFetch",Di,xe,[Qe,ve,Te]),...Ai("texelFetch",Di,Ae,[st,we,Te]),...Ai("texelFetch",Di,xe,[ke,we,Te]),...Ai("texelFetch",Di,Ee,[Ye,we,Te]),...Ai("texelFetch",Di,Ee,[Ke,ve,Te]),...Ai("texelFetch",Di,xe,[We,we,Te]),...Ai("texelFetch",Di,Ae,[je,we,Te]),...Ai("texelFetch",Di,Ae,[Je,ve,Te])],normalizeFunc(e,t,...r){if(0===r.length)throw new ss("textureLoad");if(!(r[0]instanceof Ti))throw new ns("textureLoad","tex");const s=r[0].$ast.getType();if(!s.isTextureType())throw new is("textureLoad","tex");if("webgl2"===e.getDevice().type){if(3!==r.length)throw new ss("textureLoad");if(s.is1DTexture()){if("number"==typeof r[1]){if(!Number.isInteger(r[1]))throw new is("textureLoad","coord")}else{if(!(r[1]instanceof Ti))throw new is("textureLoad","coord");{const e=r[1].$ast.getType();if(!e.isPrimitiveType()||!e.isScalarType()||e.scalarType!==X.I32)throw new is("textureLoad","coord")}}r[1]=e.ivec2(r[1],0)}}else"webgpu"===e.getDevice().type&&(s.isExternalTexture()&&(r=r.slice(0,2)),s.isStorageTexture()&&(s.readable=!0));return Si(e,t,...r)}},textureArrayLoad:{overloads:[...Ai("textureLoad",Oi,xe,[He,we,Te,Te]),...Ai("textureLoad",Oi,Ee,[qe,we,Te,Te]),...Ai("textureLoad",Oi,Ae,[Ze,we,Te,Te]),...Ai("textureLoad",Oi,me,[Er,we,Te,Te]),...Ai("texelFetch",Di,xe,[He,ve,Te]),...Ai("texelFetch",Di,Ee,[qe,ve,Te]),...Ai("texelFetch",Di,Ae,[Ze,ve,Te])],normalizeFunc(e,t,...r){if("webgl2"===e.getDevice().type){if(4!==r.length)throw new ss("textureArrayLoad");const s=r[0],i=e.ivec3(r[1],r[2]);return Si(e,t,s,i,r[3])}return Si(e,t,...r)}},textureStore:{overloads:[...Ai("textureStore",Oi,Ir,[lt,Ce,xe]),...Ai("textureStore",Oi,Ir,[ct,Ce,xe]),...Ai("textureStore",Oi,Ir,[ft,Ce,Ae]),...Ai("textureStore",Oi,Ir,[dt,Ce,Ee]),...Ai("textureStore",Oi,Ir,[mt,Ce,Ae]),...Ai("textureStore",Oi,Ir,[_t,Ce,Ee]),...Ai("textureStore",Oi,Ir,[gt,Ce,xe]),...Ai("textureStore",Oi,Ir,[xt,Ce,Ae]),...Ai("textureStore",Oi,Ir,[yt,Ce,Ee]),...Ai("textureStore",Oi,Ir,[bt,Ce,xe]),...Ai("textureStore",Oi,Ir,[Tt,Ce,Ae]),...Ai("textureStore",Oi,Ir,[wt,Ce,Ee]),...Ai("textureStore",Oi,Ir,[vt,Ce,xe]),...Ai("textureStore",Oi,Ir,[Et,Ce,Ae]),...Ai("textureStore",Oi,Ir,[Ct,Ce,Ee]),...Ai("textureStore",Oi,Ir,[St,Ce,xe]),...Ai("textureStore",Oi,Ir,[$t,Se,xe]),...Ai("textureStore",Oi,Ir,[At,Se,xe]),...Ai("textureStore",Oi,Ir,[It,Se,Ae]),...Ai("textureStore",Oi,Ir,[Bt,Se,Ee]),...Ai("textureStore",Oi,Ir,[Dt,Se,Ae]),...Ai("textureStore",Oi,Ir,[Ot,Se,Ee]),...Ai("textureStore",Oi,Ir,[Ft,Se,xe]),...Ai("textureStore",Oi,Ir,[Mt,Se,Ae]),...Ai("textureStore",Oi,Ir,[Rt,Se,Ee]),...Ai("textureStore",Oi,Ir,[Vt,Se,xe]),...Ai("textureStore",Oi,Ir,[Gt,Se,Ae]),...Ai("textureStore",Oi,Ir,[Pt,Se,Ee]),...Ai("textureStore",Oi,Ir,[Nt,Se,xe]),...Ai("textureStore",Oi,Ir,[Ut,Se,Ae]),...Ai("textureStore",Oi,Ir,[Ut,we,Ae]),...Ai("textureStore",Oi,Ir,[zt,Se,Ee]),...Ai("textureStore",Oi,Ir,[kt,Se,xe]),...Ai("textureStore",Oi,Ir,[ar,$e,xe]),...Ai("textureStore",Oi,Ir,[or,$e,xe]),...Ai("textureStore",Oi,Ir,[hr,$e,Ae]),...Ai("textureStore",Oi,Ir,[lr,$e,Ee]),...Ai("textureStore",Oi,Ir,[cr,$e,Ae]),...Ai("textureStore",Oi,Ir,[pr,$e,Ee]),...Ai("textureStore",Oi,Ir,[fr,$e,xe]),...Ai("textureStore",Oi,Ir,[dr,$e,Ae]),...Ai("textureStore",Oi,Ir,[mr,$e,Ee]),...Ai("textureStore",Oi,Ir,[_r,$e,xe]),...Ai("textureStore",Oi,Ir,[gr,$e,Ae]),...Ai("textureStore",Oi,Ir,[xr,$e,Ee]),...Ai("textureStore",Oi,Ir,[yr,$e,xe]),...Ai("textureStore",Oi,Ir,[br,$e,Ae]),...Ai("textureStore",Oi,Ir,[Tr,$e,Ee]),...Ai("textureStore",Oi,Ir,[wr,$e,xe])],normalizeFunc(e,t,...r){if("webgpu"===e.getDevice().type){const e=r[0];if(e instanceof Ti){const t=e.$ast.getType();t?.isTextureType()&&t.isStorageTexture()&&(t.writable=!0)}}return Si(e,t,...r)}},textureArrayStore:{overloads:[...Ai("textureStore",Oi,Ir,[Wt,we,Te,xe]),...Ai("textureStore",Oi,Ir,[Xt,we,Te,xe]),...Ai("textureStore",Oi,Ir,[Yt,we,Te,Ae]),...Ai("textureStore",Oi,Ir,[jt,we,Te,Ee]),...Ai("textureStore",Oi,Ir,[Ht,we,Te,Ae]),...Ai("textureStore",Oi,Ir,[qt,we,Te,Ee]),...Ai("textureStore",Oi,Ir,[Zt,we,Te,xe]),...Ai("textureStore",Oi,Ir,[Qt,we,Te,Ae]),...Ai("textureStore",Oi,Ir,[Kt,we,Te,Ee]),...Ai("textureStore",Oi,Ir,[Jt,we,Te,xe]),...Ai("textureStore",Oi,Ir,[er,we,Te,Ae]),...Ai("textureStore",Oi,Ir,[tr,we,Te,Ee]),...Ai("textureStore",Oi,Ir,[rr,we,Te,xe]),...Ai("textureStore",Oi,Ir,[sr,we,Te,Ae]),...Ai("textureStore",Oi,Ir,[ir,we,Te,Ee]),...Ai("textureStore",Oi,Ir,[nr,we,Te,xe])]},textureNumLayers:{overloads:[...Ai("textureNumLayers",Oi,Te,[He]),...Ai("textureNumLayers",Oi,Te,[qe]),...Ai("textureNumLayers",Oi,Te,[Ze]),...Ai("textureNumLayers",Oi,Te,[it]),...Ai("textureNumLayers",Oi,Te,[nt]),...Ai("textureNumLayers",Oi,Te,[at]),...Ai("textureNumLayers",Oi,Te,[Er]),...Ai("textureNumLayers",Oi,Te,[Sr]),...Ai("textureNumLayers",Oi,Te,[nr]),...Ai("textureNumLayers",Oi,Te,[ir]),...Ai("textureNumLayers",Oi,Te,[sr]),...Ai("textureNumLayers",Oi,Te,[rr]),...Ai("textureNumLayers",Oi,Te,[tr]),...Ai("textureNumLayers",Oi,Te,[er]),...Ai("textureNumLayers",Oi,Te,[Zt]),...Ai("textureNumLayers",Oi,Te,[qt]),...Ai("textureNumLayers",Oi,Te,[Ht]),...Ai("textureNumLayers",Oi,Te,[Jt]),...Ai("textureNumLayers",Oi,Te,[Kt]),...Ai("textureNumLayers",Oi,Te,[Qt]),...Ai("textureNumLayers",Oi,Te,[jt]),...Ai("textureNumLayers",Oi,Te,[Xt]),...Ai("textureNumLayers",Oi,Te,[Yt]),...Ai("textureNumLayers",Oi,Te,[Wt])]},textureNumLevels:{overloads:[...Ai("textureNumLevels",Oi,Te,[ze]),...Ai("textureNumLevels",Oi,Te,[ke]),...Ai("textureNumLevels",Oi,Te,[We]),...Ai("textureNumLevels",Oi,Te,[Xe]),...Ai("textureNumLevels",Oi,Te,[Ye]),...Ai("textureNumLevels",Oi,Te,[je]),...Ai("textureNumLevels",Oi,Te,[He]),...Ai("textureNumLevels",Oi,Te,[qe]),...Ai("textureNumLevels",Oi,Te,[Ze]),...Ai("textureNumLevels",Oi,Te,[Qe]),...Ai("textureNumLevels",Oi,Te,[Ke]),...Ai("textureNumLevels",Oi,Te,[Je]),...Ai("textureNumLevels",Oi,Te,[et]),...Ai("textureNumLevels",Oi,Te,[tt]),...Ai("textureNumLevels",Oi,Te,[rt]),...Ai("textureNumLevels",Oi,Te,[it]),...Ai("textureNumLevels",Oi,Te,[nt]),...Ai("textureNumLevels",Oi,Te,[at]),...Ai("textureNumLevels",Oi,Te,[vr]),...Ai("textureNumLevels",Oi,Te,[Er]),...Ai("textureNumLevels",Oi,Te,[Cr]),...Ai("textureNumLevels",Oi,Te,[Sr])]},textureNumSamples:{overloads:[...Ai("textureNumSamples",Oi,Te,[ot]),...Ai("textureNumSamples",Oi,Te,[ut]),...Ai("textureNumSamples",Oi,Te,[ht]),...Ai("textureNumSamples",Oi,Te,[$r])]},textureSample:{overloads:[...Ai("textureSample",Oi,xe,[ze,Ar,me]),...Ai("textureSample",Oi,xe,[Xe,Ar,_e]),...Ai("textureSample",Oi,xe,[Qe,Ar,ge]),...Ai("textureSample",Oi,xe,[et,Ar,ge]),...Ai("textureSample",Oi,me,[vr,Ar,_e]),...Ai("textureSample",Oi,me,[Cr,Ar,ge]),...Ai("textureSampleBaseClampToEdge",Oi,xe,[st,Ar,_e]),...Ai("texture",Di,xe,[ze,_e]),...Ai("texture",Di,xe,[Xe,_e]),...Ai("texture",Di,xe,[st,_e]),...Ai("texture",Di,xe,[vr,_e]),...Ai("texture",Di,xe,[Qe,ge]),...Ai("texture",Di,xe,[et,ge]),...Ai("texture",Di,xe,[Cr,ge]),...Ai("texture2D",Bi,xe,[ze,_e]),...Ai("texture2D",Bi,xe,[Xe,_e]),...Ai("texture2D",Bi,xe,[st,_e]),...Ai("texture2D",Bi,xe,[vr,_e]),...Ai("textureCube",Bi,xe,[et,ge]),...Ai("textureCube",Bi,xe,[Cr,ge])],normalizeFunc(e,t,...r){if(2!==r.length)throw new ss("textureSample");const s=r[0];if(!(s instanceof Ti))throw new is("textureSample","texture");const i=s.$ast.getType();if(!i.isTextureType())throw new is("textureSample","texture");if("webgpu"===e.getDevice().type){if(i.isStorageTexture())throw new is("textureSample","texture");const n=e.getDefaultSampler(s,!1),a=Si(e,t,s,n,r[1]);return a.$ast.getType().isCompatibleType(me)?e.vec4(a):a}if(e.getDefaultSampler(s,!1),i.is1DTexture()){if(r[1]instanceof Ti){const e=r[1].$ast.getType();if(!e.isPrimitiveType()||!e.isScalarType()||e.scalarType!==X.F32)throw new is("textureSample","coord")}else if("number"!=typeof r[1])throw new is("textureSample","coord");r[1]=e.vec2(r[1],0)}return Si(e,t,...r)}},textureArraySample:{overloads:[...Ai("textureSample",Oi,xe,[He,Ar,_e,Te]),...Ai("textureSample",Oi,xe,[it,Ar,ge,Te]),...Ai("textureSample",Oi,me,[Er,Ar,_e,Te]),...Ai("textureSample",Oi,me,[Sr,Ar,ge,Te]),...Ai("texture",Di,xe,[He,ge]),...Ai("texture",Di,xe,[Er,ge])],normalizeFunc(e,t,...r){if(3!==r.length)throw new ss("textureArraySample");const s=r[0];if(!(s instanceof Ti))throw new is("textureArraySample","texture");if(!s.$ast.getType().isTextureType())throw new is("textureArraySample","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!1),n=Si(e,t,s,i,r[1],r[2]);return n.$ast.getType().isCompatibleType(me)?e.vec4(n):n}{e.getDefaultSampler(s,!1);const i=r[1],n=r[2],a=e.vec3(i,e.float(n));return Si(e,t,s,a)}}},textureSampleBias:{overloads:[...Ai("textureSampleBias",Oi,xe,[Xe,Ar,_e,me]),...Ai("textureSampleBias",Oi,xe,[Qe,Ar,ge,me]),...Ai("textureSampleBias",Oi,xe,[et,Ar,ge,me]),...Ai("texture",Di,xe,[Xe,_e,me]),...Ai("texture",Di,xe,[Qe,ge,me]),...Ai("texture",Di,xe,[et,ge,me]),...Ai("texture2D",Bi,xe,[Xe,_e,me]),...Ai("textureCube",Bi,xe,[et,ge,me])],normalizeFunc(e,t,...r){if(3!==r.length)throw new ss("textureSampleBias");const s=r[0];if(!(s instanceof Ti))throw new is("textureSampleBias","texture");if(!s.$ast.getType().isTextureType())throw new is("textureSampleBias","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!1);return Si(e,t,s,i,r[1],r[2])}return e.getDefaultSampler(s,!1),Si(e,t,...r)}},textureArraySampleBias:{overloads:[...Ai("textureSampleBias",Oi,xe,[He,Ar,_e,Te,me]),...Ai("textureSampleBias",Oi,xe,[it,Ar,ge,Te,me]),...Ai("texture",Di,xe,[He,ge,me])],normalizeFunc(e,t,...r){if(4!==r.length)throw new ss("textureArraySampleBias");const s=r[0];if(!(s instanceof Ti))throw new is("textureArraySampleBias","texture");if(!s.$ast.getType().isTextureType())throw new is("textureArraySampleBias","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!1);return Si(e,t,s,i,r[1],r[2],r[3])}if("webgl2"===e.getDevice().type){e.getDefaultSampler(s,!1);const i=r[1],n=r[2],a=e.vec3(i,e.float(n));return Si(e,t,s,a,r[3])}}},textureSampleCompare:{overloads:[...Ai("textureSampleCompare",Oi,me,[vr,Lr,_e,me]),...Ai("textureSampleCompare",Oi,me,[Cr,Lr,ge,me]),...Ai("texture",Di,me,[vr,ge]),...Ai("texture",Di,me,[Cr,xe])],normalizeFunc(e,t,...r){if(3!==r.length)throw new ss("textureSampleCompare");const s=r[0];if(!(s instanceof Ti))throw new is("textureSampleCompare","texture");const i=s.$ast.getType();if(!i.isTextureType()||!i.isDepthTexture())throw new is("textureSampleCompare","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(r[0],!0);return Si(e,t,s,i,r[1],r[2])}{let n;return e.getDefaultSampler(r[0],!0),n=i.isCubeTexture()||i.isArrayTexture()?e.vec4(r[1],r[2]):e.vec3(r[1],r[2]),Si(e,t,s,n)}}},textureArraySampleCompare:{overloads:[...Ai("textureSampleCompare",Oi,me,[Er,Lr,_e,Te,me]),...Ai("textureSampleCompare",Oi,me,[Sr,Lr,ge,Te,me]),...Ai("texture",Di,me,[Er,xe])],normalizeFunc(e,t,...r){if(4!==r.length)throw new ss("textureArraySampleCompare");const s=r[0];if(!(s instanceof Ti))throw new is("textureArraySampleCompare","texture");const i=s.$ast.getType();if(!i.isTextureType()||!i.isDepthTexture())throw new is("textureArraySampleCompare","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(r[0],!0);return Si(e,t,s,i,r[1],r[2],r[3])}{e.getDefaultSampler(r[0],!0);const i=e.vec4(r[1],e.float(r[2]),r[3]);return Si(e,t,s,i)}}},textureSampleLevel:{overloads:[...Ai("textureSampleLevel",Oi,xe,[Xe,Ar,_e,me]),...Ai("textureSampleLevel",Oi,xe,[Qe,Ar,ge,me]),...Ai("textureSampleLevel",Oi,xe,[et,Ar,ge,me]),...Ai("textureSampleLevel",Oi,xe,[st,Ar,_e]),...Ai("textureSampleLevel",Oi,me,[vr,Ar,_e,Te]),...Ai("textureSampleLevel",Oi,me,[Cr,Ar,ge,Te]),...Ai("textureLod",Di,xe,[Xe,_e,me]),...Ai("textureLod",Di,xe,[vr,_e,me]),...Ai("textureLod",Di,xe,[st,_e,me]),...Ai("textureLod",Di,xe,[Qe,ge,me]),...Ai("textureLod",Di,xe,[et,ge,me]),...Ai("textureLod",Di,xe,[Cr,ge,me]),...Ai("texture2DLodEXT",Bi,xe,[Xe,_e,me]),...Ai("texture2DLodEXT",Bi,xe,[vr,_e,me]),...Ai("texture2DLodEXT",Bi,xe,[st,_e,me]),...Ai("textureCubeLodEXT",Bi,xe,[et,ge,me]),...Ai("textureCubeLodEXT",Bi,xe,[Cr,ge,me])],normalizeFunc(e,t,...r){const s=r[0];if(!(s instanceof Ti))throw new is("textureSampleLevel","texture");const i=s.$ast.getType();if(!i.isTextureType())throw new is("textureSampleLevel","texture");if("webgl"===e.getDevice().type&&"vertex"===e.shaderKind)return e.textureSample(s,r[1]);if("webgpu"===e.getDevice().type){if(i.isExternalTexture())return e.textureLoad(s,e.ivec2(r[1]),0);{const n=e.getDefaultSampler(s,!1),a=i.isDepthTexture()&&("number"==typeof r[2]||r[2]instanceof Ti&&r[2].$ast.getType().isCompatibleType(me))?e.int(r[2]):r[2],o=i.isExternalTexture()?Si(e,t,s,n,r[1]):Si(e,t,s,n,r[1],a);return o.$ast.getType().isCompatibleType(me)?e.vec4(o):o}}return e.getDefaultSampler(s,!1),i.isExternalTexture()?Si(e,t,r[0],r[1],0):Si(e,t,r[0],r[1],r[2])}},textureArraySampleLevel:{overloads:[...Ai("textureSampleLevel",Oi,xe,[He,Ar,_e,Te,me]),...Ai("textureSampleLevel",Oi,xe,[it,Ar,ge,Te,me]),...Ai("textureSampleLevel",Oi,me,[Er,Ar,_e,Te,Te]),...Ai("textureSampleLevel",Oi,me,[Sr,Ar,ge,Te,Te]),...Ai("textureLod",Di,xe,[He,ge,me])],normalizeFunc(e,t,...r){if(4!==r.length)throw new ss("textureArraySampleLevel");const s=r[0];if(!(s instanceof Ti))throw new is("textureArraySampleLevel","texture");const i=s.$ast.getType();if(!i.isTextureType())throw new is("textureArraySampleLevel","texture");if("webgpu"===e.getDevice().type){const n=e.getDefaultSampler(s,!1),a=i.isDepthTexture()&&("number"==typeof r[3]||r[3]instanceof Ti&&r[3].$ast.getType().isCompatibleType(me))?e.int(r[3]):r[3],o=Si(e,t,s,n,r[1],r[2],a);return o.$ast.getType().isCompatibleType(me)?e.vec4(o):o}{e.getDefaultSampler(s,!1);const i=e.vec3(r[1],e.float(r[2]));return Si(e,t,s,i,r[3])}}},textureSampleCompareLevel:{overloads:[...Ai("textureSampleCompareLevel",Oi,me,[vr,Lr,_e,me]),...Ai("textureSampleCompareLevel",Oi,me,[Cr,Lr,ge,me]),...Ai("textureLod",Di,me,[vr,ge,me]),...Ai("texture",Di,me,[Cr,xe])],normalizeFunc(e,t,...r){if(3!==r.length)throw new ss("textureSampleCompareLevel");const s=r[0];if(!(s instanceof Ti))throw new is("textureSampleCompareLevel","texture");const i=s.$ast.getType();if(!i.isTextureType()||!i.isDepthTexture())throw new is("textureSampleCompareLevel","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!0);return Si(e,t,s,i,r[1],r[2])}{let n;return e.getDefaultSampler(r[0],!0),n=i.isCubeTexture()||i.isArrayTexture()?e.vec4(r[1],r[2]):e.vec3(r[1],r[2]),i.isCubeTexture()?Si(e,t,s,n):Si(e,t,s,n,0)}}},textureArraySampleCompareLevel:{overloads:[...Ai("textureSampleCompareLevel",Oi,me,[Er,Lr,_e,Te,me]),...Ai("textureSampleCompareLevel",Oi,me,[Sr,Lr,ge,Te,me]),...Ai("texture",Di,me,[Er,xe])],normalizeFunc(e,t,...r){if(4!==r.length)throw new ss("textureArraySampleCompareLevel");const s=r[0];if(!(s instanceof Ti))throw new is("textureArraySampleCompareLevel","texture");const i=s.$ast.getType();if(!i.isTextureType()||!i.isDepthTexture())throw new is("textureArraySampleCompareLevel","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!0);return Si(e,t,s,i,r[1],r[2],r[3])}{e.getDefaultSampler(r[0],!0);const i=e.vec4(r[1],e.float(r[2]),r[3]);return Si(e,t,s,i)}}},textureSampleGrad:{overloads:[...Ai("textureSampleGrad",Oi,xe,[Xe,Ar,_e,_e,_e]),...Ai("textureSampleGrad",Oi,xe,[Qe,Ar,ge,ge,ge]),...Ai("textureSampleGrad",Oi,xe,[et,Ar,ge,ge,ge]),...Ai("textureGrad",Di,xe,[Xe,_e,_e,_e]),...Ai("textureGrad",Di,xe,[Qe,ge,ge,ge]),...Ai("textureGrad",Di,xe,[et,ge,ge,ge]),...Ai("texture2DGradEXT",Bi,xe,[Xe,_e,_e,_e]),...Ai("textureCubeGradEXT",Bi,xe,[et,ge,ge,ge])],normalizeFunc(e,t,...r){if(4!==r.length)throw new ss("textureSampleGrad");const s=r[0];if(!(s instanceof Ti))throw new is("textureSampleGrad","texture");if(!s.$ast.getType().isTextureType())throw new is("textureSampleGrad","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!1);return Si(e,t,s,i,r[1],r[2],r[3])}return e.getDefaultSampler(s,!1),Si(e,t,...r)}},textureArraySampleGrad:{overloads:[...Ai("textureSampleGrad",Oi,xe,[He,Ar,_e,Te,_e,_e]),...Ai("textureSampleGrad",Oi,xe,[it,Ar,ge,Te,ge,ge]),...Ai("textureGrad",Di,xe,[He,ge,_e,_e])],normalizeFunc(e,t,...r){if(5!==r.length)throw new ss("textureArraySampleGrad");const s=r[0];if(!(s instanceof Ti))throw new is("textureArraySampleGrad","texture");const i=s.$ast.getType();if(!i.isTextureType()||!i.isArrayTexture())throw new is("textureArraySampleGrad","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!1);return Si(e,t,s,i,r[1],r[2],r[3],r[4])}{e.getDefaultSampler(s,!1);const i=e.vec3(r[1],e.float(r[2]));return Si(e,t,s,i,r[3],r[4])}}},storageBarrier:{overloads:Ai("storageBarrier",Oi,Ir,[])},workgroupBarrier:{overloads:Ai("workgroupBarrier",Oi,Ir,[])},atomicLoad:{overloades:[],normalizeFunc(e,t,...r){if(1!==r.length)throw new ss(t);const s=r[0];if(!(s instanceof Ti))throw new is(t,"ptr");if(s.$ast.getType().typeId===ye.typeId)return e.$callFunctionNoCheck(t,[new Ys(s.$ast)],Te);if(s.$ast.getType().typeId===be.typeId)return e.$callFunctionNoCheck(t,[new Ys(s.$ast)],Ce);throw new ns(t,"ptr must be atomic type")}},atomicStore:{overloades:[],normalizeFunc(e,t,...r){if(2!==r.length)throw new ss(t);const s=r[0],i=r[1];if(!(s instanceof Ti))throw new is(t,"ptr");if(s.$ast.getType().typeId===ye.typeId){if("number"==typeof i){if(!Number.isInteger(i))throw new ns(t,"value");return e.$callFunctionNoCheck(t,[new Ys(s.$ast),new ks(i,Te)],Ir)}if(i instanceof Ti){if(i.$ast.getType().typeId!==Te.typeId)throw new is(t,"value");return e.$callFunctionNoCheck(t,[new Ys(s.$ast),i.$ast],Ir)}throw new is(t,"value")}if(s.$ast.getType().typeId===be.typeId){if("number"==typeof i){if(!Number.isInteger(i))throw new ns(t,"value");return e.$callFunctionNoCheck(t,[new Ys(s.$ast),new ks(i,Ce)],Ir)}if(i instanceof Ti){if(i.$ast.getType().typeId!==Ce.typeId)throw new is(t,"value");return e.$callFunctionNoCheck(t,[new Ys(s.$ast),i.$ast],Ir)}throw new is(t,"value")}throw new ns(t,"ptr must be atomic type")}}};for(const e of["atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange"])Ri[e]={overloades:[],normalizeFunc(e,t,...r){if(2!==r.length)throw new ss(t);const s=r[0],i=r[1];if(!(s instanceof Ti))throw new is(t,"ptr");if(s.$ast.getType().typeId===ye.typeId){if("number"==typeof i){if(!Number.isInteger(i))throw new ns(t,"value");return e.$callFunctionNoCheck(t,[new Ys(s.$ast),new ks(i,Te)],Te)}if(i instanceof Ti){if(i.$ast.getType().typeId!==Te.typeId)throw new is(t,"value");return e.$callFunctionNoCheck(t,[new Ys(s.$ast),i.$ast],Te)}throw new is(t,"value")}if(s.$ast.getType().typeId===be.typeId){if("number"==typeof i){if(!Number.isInteger(i))throw new ns(t,"value");return e.$callFunctionNoCheck(t,[new Ys(s.$ast),new ks(i,Ce)],Ce)}if(i instanceof Ti){if(i.$ast.getType().typeId!==Ce.typeId)throw new is(t,"value");return e.$callFunctionNoCheck(t,[new Ys(s.$ast),i.$ast],Ce)}throw new is(t,"value")}throw new ns(t,"ptr must be atomic type")}};const Vi={rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",rgba8uint:"rgba8ui",rgba8sint:"rgba8i",rgba16uint:"rgba16ui",rgba16sint:"rgba16i",rgba16float:"rgba16f",r32float:"r32f",r32uint:"r32ui",r32sint:"r32i",rg32float:"rg32f",rg32uint:"rg32ui",rg32sint:"rg32i",rgba32float:"rgba32f",rgba32uint:"rgba32ui",rgba32sint:"rgba32i"};function Gi(e,...t){if("webgl"===this.getDevice().type){if(e.scalarType===X.U32)throw new hs("unsigned integer type");if(e.isMatrixType()&&e.cols!==e.rows)throw new hs("non-square matrix type")}if(1===t.length&&"string"==typeof t[0])return new Ti(t[0],e);{const r=new Ti("",e);return!e.isScalarType()||1!==t.length||"number"!=typeof t[0]&&"boolean"!=typeof t[0]?r.$ast=new zs(r.$typeinfo,t.map((e=>{if("string"==typeof e)throw new is("vec_n");return e instanceof Ti?e.$ast:e}))):r.$ast=new ks(t[0],e),r}}const Pi={float:me,int:Te,uint:Ce,bool:Le,vec2:_e,ivec2:we,uvec2:Se,bvec2:Ie,vec3:ge,ivec3:ve,uvec3:$e,bvec3:Be,vec4:xe,ivec4:Ee,uvec4:Ae,bvec4:De,mat2:Oe,mat2x3:Fe,mat2x4:Me,mat3x2:Re,mat3:Ve,mat3x4:Ge,mat4x2:Pe,mat4x3:Ne,mat4:Ue},Ni={tex1D:ze,tex2D:Xe,tex3D:Qe,texCube:et,tex2DShadow:vr,texCubeShadow:Cr,tex2DArray:He,tex2DArrayShadow:Er,texExternal:st,itex1D:ke,itex2D:Ye,itex3D:Ke,itexCube:tt,itex2DArray:qe,utex1D:We,utex2D:je,utex3D:Je,utexCube:rt,utex2DArray:Ze,sampler:Ar,samplerComparison:Lr};const Ui={texStorage1D:J.TEX_STORAGE_1D,texStorage2D:J.TEX_STORAGE_2D,texStorage2DArray:J.TEX_STORAGE_2D_ARRAY,texStorage3D:J.TEX_STORAGE_3D};const zi="zVSInput_",ki="zVSOutput_";class Wi{_device;_workgroupSize;_scopeStack=[];_shaderType=F.Vertex|F.Fragment|F.Compute;_structInfo;_uniforms;_globalScope;_builtinScope;_inputScope;_outputScope;_inputs;_outputs;_vertexAttributes;_depthRangeCorrection;_emulateDepthClamp;_lastError;_reflection;_autoStructureTypeIndex;_nameMap;constructor(e){this._device=e,this._workgroupSize=null,this._structInfo={},this._uniforms=[],this._scopeStack=[],this._globalScope=null,this._builtinScope=null,this._inputScope=null,this._outputScope=null,this._inputs=[],this._outputs=[],this._vertexAttributes=[],this._depthRangeCorrection="webgpu"===e.type,this._emulateDepthClamp=!1,this._lastError=null,this._reflection=new fi(this),this._autoStructureTypeIndex=0,this._nameMap=[]}get lastError(){return this._lastError}get shaderType(){return this._shaderType}get shaderKind(){return this._shaderType===F.Vertex?"vertex":this._shaderType===F.Fragment?"fragment":this._shaderType===F.Compute?"compute":null}getGlobalScope(){return this._globalScope}get builtinScope(){return this._builtinScope}get inputScope(){return this._inputScope}get outputScope(){return this._outputScope}get depthRangeCorrection(){return this._depthRangeCorrection}get emulateDepthClamp(){return this._emulateDepthClamp}set emulateDepthClamp(e){this._emulateDepthClamp=e}getReflection(){return this._reflection}getDevice(){return this._device}reset(){this._workgroupSize=null,this._structInfo={},this._uniforms=[],this._scopeStack=[],this._globalScope=null,this._builtinScope=null,this._inputScope=null,this._outputScope=null,this._inputs=[],this._outputs=[],this._vertexAttributes=[],this._depthRangeCorrection="webgpu"===this._device.type,this._reflection=new fi(this),this._autoStructureTypeIndex=0,this._nameMap=[]}queryGlobal(e){return this.getReflection().tag(e)}pushScope(e){this._scopeStack.unshift(e)}popScope(){return this._scopeStack.shift()}getCurrentScope(){return this._scopeStack[0]}getCurrentFunctionScope(){let e=this.getCurrentScope();for(;e&&!(e instanceof Ki);)e=e.$parent;return e}buildRender(e){_i(this),this._lastError=null,this.defineInternalStructs();const t=this.buildRenderSource(e);return _i(null),this.reset(),t}buildCompute(e){_i(this),this._lastError=null,this._workgroupSize=e.workgroupSize,this.defineInternalStructs();const t=this.buildComputeSource(e);return _i(null),this.reset(),t}buildRenderProgram(e){const t=this.buildRender(e);return t?this._device.createGPUProgram({type:"render",label:e.label,params:{vs:t[0],fs:t[1],bindGroupLayouts:t[2],vertexAttributes:t[3]}}):null}buildComputeProgram(e){const t=this.buildCompute(e);return t?this._device.createGPUProgram({type:"compute",params:{source:t[0],bindGroupLayouts:t[1]}}):null}func(e,t,r){this.getGlobalScope().$createFunctionIfNotExists(e,t,r)}main(e){this.getGlobalScope().$mainFunc(e)}addressOf(e){if("webgpu"!==this._device.type)throw new hs("pointer shader type");if(!e.$ast.isReference())throw new os(e);const t=new Ti("",e.$ast.getType());return t.$ast=new Ys(e.$ast),t}referenceOf(e){if("webgpu"!==this._device.type)throw new hs("pointer shader type");if(!e.$ast.getType().isPointerType())throw new us(e);const t=new js(e.$ast),r=new Ti("",t.getType());return r.$ast=t,r}struct(e,t){let r=null;for(const t of[F.Vertex,F.Fragment,F.Compute])if(t&this._shaderType){const s=this._structInfo[t];if(r=s?.structs[e],r)break}if(!r)throw new ns("struct","structName",`Struct type ${e} not exists`);return r.call(this,t)}isIdenticalStruct(e,t,r){if(r&&e.structName&&t.structName&&e.structName!==t.structName)return!1;if(e.structMembers.length!==t.structMembers.length)return!1;for(let r=0;r<e.structMembers.length;r++){const s=e.structMembers[r],i=t.structMembers[r];if(s.name!==i.name)return!1;if(s.type.isStructType()){if(!i.type.isStructType())return!1;if(!this.isIdenticalStruct(s.type,i.type,!0))return!1}else if(!s.type.isCompatibleType(i.type))return!1}return!0}generateStructureName(){return"zStruct"+this._autoStructureTypeIndex++}getVertexAttributes(){return this._vertexAttributes}defineHiddenStruct(e){for(const t of[F.Vertex,F.Fragment,F.Compute]){let r=this._structInfo[t];if(r||(r={structs:{},types:[]},this._structInfo[t]=r),r.structs[e.structName])throw new ns("defineStruct","structName",`cannot re-define struct '${e.structName}'`);r.types.push(new ci(e,!0))}}defineStruct(e,t){const r="default",s=new he(t??"",r,e.map((e=>{if(!(e.$typeinfo.isPrimitiveType()||e.$typeinfo.isArrayType()||e.$typeinfo.isStructType()||e.$typeinfo.isAtomicI32()||e.$typeinfo.isAtomicU32()))throw new Error(`invalid struct member type: '${e.$str}'`);return{name:e.$str,type:e.$typeinfo}})));for(const e of[F.Vertex,F.Fragment,F.Compute]){let t=null,i=null;const n=this._structInfo[e];if(n){if(gi().shaderType===e&&n.structs[s.structName])throw new ns("defineStruct","structName",`cannot re-define struct '${s.structName}'`);for(const e of n.types)if(!e.builtin&&this.isIdenticalStruct(e.getType(),s,!1)){t=e,i=n.structs[e.getType().structName];break}}if(t){if(t.type.layout!==r)throw new Error(`Can not redefine struct ${t.type.structName} with different layout`);return e!==gi().shaderType&&(this._structInfo[gi().shaderType]||(this._structInfo[gi().shaderType]={structs:{},types:[]}),this._structInfo[gi().shaderType].types.indexOf(t)<0&&(this._structInfo[gi().shaderType].types.push(t),this._structInfo[gi().shaderType].structs[t.getType().structName]=i)),i}}return this.internalDefineStruct(t??this.generateStructureName(),r,this._shaderType,!1,...e)}defineStructByType(e){const t=e.extends(e.structName||this.generateStructureName(),[]);for(const e of[F.Vertex,F.Fragment,F.Compute]){let r=null,s=null;const i=this._structInfo[e];if(i){if(gi().shaderType===e&&i.structs[t.structName])throw new ns("defineStruct","structName",`cannot re-define struct '${t.structName}'`);for(const e of i.types)if(!e.builtin&&this.isIdenticalStruct(e.getType(),t,!1)){r=e,s=i.structs[e.getType().structName];break}}if(r){if(r.type.layout!==t.layout)throw new Error(`Can not redefine struct ${r.type.structName} with different layout`);return e!==gi().shaderType&&(this._structInfo[gi().shaderType]||(this._structInfo[gi().shaderType]={structs:{},types:[]}),this._structInfo[gi().shaderType].types.push(r),this._structInfo[gi().shaderType].structs[r.getType().structName]=s),s}}return this.internalDefineStructByType(this._shaderType,!1,t)}internalDefineStruct(e,t,r,s,...i){const n=new he(e,t,i.map((e=>{if(!(e.$typeinfo.isPrimitiveType()||e.$typeinfo.isArrayType()||e.$typeinfo.isStructType()||e.$typeinfo.isAtomicI32()||e.$typeinfo.isAtomicU32()))throw new Error(`invalid struct member type: '${e.$str}'`);return{name:e.$str,type:e.$typeinfo}})));return this.internalDefineStructByType(r,s,n)}internalDefineStructByType(e,t,r){const s=xi((function(...e){let t;return 1===e.length&&"string"==typeof e[0]?t=new Ti(e[0],r):(t=new Ti("",r),t.$ast=new zs(t.$typeinfo,e.map((e=>e instanceof Ti?e.$ast:e)))),t}),r);for(const i of[F.Vertex,F.Fragment,F.Compute])if(e&i){let e=this._structInfo[i];if(e||(e={structs:{},types:[]},this._structInfo[i]=e),e.structs[r.structName])throw new ns("defineStruct","structName",`cannot re-define struct '${r.structName}'`);e.types.push(new ci(r,t)),e.structs[r.structName]=s}return s}getFunction(e){return this._globalScope?this._globalScope.$getFunctions(e):null}get structInfo(){return this._structInfo[this._shaderType]}getBlockName(e){return`ch_block_name_${e}`}defineBuiltinStruct(e,t){const r="in"===t?vs(e):function(e){switch(e){case F.Vertex:return ds;case F.Fragment:return _s;case F.Compute:return"zCSOutput";default:return null}}(e),s="in"===t?Ts(e):ws(e),i=e===F.Vertex?"vertex":e===F.Fragment?"fragment":"compute",n=Cs.webgpu,a=[],o=[];for(const e in n)n[e].stage===i&&n[e].inOrOut===t&&(a.push({name:n[e].name,type:n[e].type}),o.push(`@builtin(${n[e].semantic}) `));const u="in"===t?this._inputs:this._outputs;for(const e of u){if(!(e[1]instanceof ni))throw new ps("defineBuiltinStruct() failed: input/output is not declare var ast node");const t=e[1].value.getType();if(!t.isPrimitiveType()&&!t.isArrayType()&&!t.isStructType())throw new Error(`invalid in/out variable type: '${e[1].value.name}'`);a.push({name:e[1].value.name,type:t}),o.push(`@location(${e[1].value.value.$location}) ${t.isPrimitiveType()&&t.isInteger()?"@interpolate(flat) ":""}`)}if(a.length>0){const i=this.findStructType(r,e);if(i)return i.getType().reset(r,"default",a),i.prefix=o,null;{const i=this.internalDefineStructByType(this._shaderType,!1,new he(r,"default",a));this.findStructType(r,e).prefix=o;const n=this.struct(r,s);return[i,n,r,"in"===t?this.struct(r,bs(e)):n]}}return null}defineInternalStructs(){this.defineHiddenStruct(Br),this.defineHiddenStruct(Dr),this.defineHiddenStruct(Or),this.defineHiddenStruct(Fr)}array(...e){if(0===e.length)throw new ss("array");e=e.map((e=>this.normalizeExpValue(e)));let t=!0,r=null,s=!0,i=!0,n=!0,a=!0,o=!1;for(const s of e)if(s instanceof Ti){const e=s.$ast.getType();if(!e.isConstructible()){t=!1;break}r?e.isCompatibleType(r)||(t=!1):r=e}if(t){r&&r.isPrimitiveType()&&r.isScalarType()?(s=r.primitiveType===X.BOOL,i=r.primitiveType===X.F32,a=r.primitiveType===X.U32,n=r.primitiveType===X.I32):r&&(s=!1,i=!1,a=!1,n=!1,o=!0);for(const r of e){if(!(r instanceof Ti)&&o){t=!1;break}"number"==typeof r?(s=!1,(0|r)===r&&(r<0?(a=!1,n=n&&r>=-2147483648):(a=a&&r<=4294967295,n=n&&r<=2147483647))):"boolean"==typeof r&&(i=!1,n=!1,a=!1)}}if(t&&!o&&(s?r=Le:n?r=Te:a?r=Ce:i&&(r=me),t=!!r),!t)throw new is("array");if(!r.isPrimitiveType()&&!r.isArrayType()&&!r.isStructType())throw new is("array");const u=new le(r,e.length),h=new Ti("",u);return h.$ast=new zs(u,e.map((e=>{if(e instanceof Ti)return e.$ast;if(!r.isPrimitiveType()||!r.isScalarType())throw new rs(e,typeof e,r);return new ks(e,r)}))),h}discard(){this.getCurrentScope().$ast.statements.push(new ei)}tagShaderExp(e,t){if("string"==typeof t)this._reflection.tag(t,e);else if(Array.isArray(t))t.forEach((t=>this.tagShaderExp(e,t)));else for(const r of Object.keys(t))this.tagShaderExp((t=>e(t)[r]),t[r])}in(e,t,r){this._inputs[e]?this._inputScope[t]||Object.defineProperty(this._inputScope,t,{get:function(){return r},set:function(){throw new Error(`cannot assign to readonly variable: ${t}`)}}):(r.$location=e,r.$declareType=xs.DECLARE_TYPE_IN,this._inputs[e]=[t,new ni(new Rs(r))],Object.defineProperty(this._inputScope,t,{get:function(){return r},set:function(){throw new Error(`cannot assign to readonly variable: ${t}`)}}),r.$tags.forEach((e=>this.tagShaderExp((()=>r),e))))}out(e,t,r){if(this._outputs[e])throw new Error(`output location ${e} has already been used`);r.$location=e,r.$declareType=xs.DECLARE_TYPE_OUT,this._outputs[e]=[t,new ni(new Rs(r))];for(const s of[t,String(e)])Object.defineProperty(this._outputScope,s,{get:function(){return r},set:function(e){gi().getCurrentScope().$ast.statements.push(new Js(new Gs(r.$ast),e instanceof Ti?e.$ast:e))}})}getDefaultSampler(e,t){const r=this._uniforms.findIndex((t=>t.texture?.exp===e));if(r<0)return;const s=t?"comparison":"sample";if(this._uniforms[r].texture.autoBindSampler&&this._uniforms[r].texture.autoBindSampler!==s)throw new Error("multiple sampler not supported");if(this._uniforms[r].texture.autoBindSampler=s,"webgpu"===this._device.type){const r=Es(e.$str,t);if(!this.getGlobalScope()[r])throw new Error(`failed to find sampler name ${r}`);return this.getGlobalScope()[r]}return null}normalizeExpValue(e){if(Array.isArray(e)){const t=e.map((e=>Array.isArray(e)?this.normalizeExpValue(e):e));return this.array(...t)}return e}guessExpValueType(e){const t=this.normalizeExpValue(e);if("boolean"==typeof t)return Le;if("number"==typeof t){if(Number.isInteger(t)){if(t>=-1073741824&&t<=2147483647)return Te;if(t>=0&&t<=4294967295)return Ce;throw new ts(t)}return me}return t instanceof Ti?t.$ast?.getType()||t.$typeinfo:void 0}findStructType(e,t){for(const r of[F.Vertex,F.Fragment,F.Compute])if(r&t){const t=this._structInfo[r];if(t)for(const r of t.types)if(r.type.structName===e)return r}return null}findStructConstructor(e,t){for(const r of[F.Vertex,F.Fragment,F.Compute])if(r&t){const t=this._structInfo[r];if(t&&t.structs?.[e])return t.structs[e]}return null}buildComputeSource(e){try{return this._lastError=null,this._shaderType=F.Compute,this._scopeStack=[],this._globalScope=new Zi,this._builtinScope=new ji,this._inputs=[],this._outputs=[],this._inputScope=new Hi,this._outputScope=new qi,this._reflection.clear(),this.generate(e.compute),this.mergeUniformsCompute(this._globalScope),this.updateUniformBindings([this._globalScope],[F.Compute]),[this.generateComputeSource(this._globalScope,this._builtinScope),this.createBindGroupLayouts(e.label)]}catch(e){return e instanceof es?(this._lastError=e.getMessage(this._device.type),console.error(this._lastError),null):e instanceof Error?(this._lastError=e.toString(),console.error(this._lastError),null):(this._lastError=Object.prototype.toString.call(e),console.log(`Error: ${this._lastError}`),null)}}buildRenderSource(e){try{this._lastError=null,this._shaderType=F.Vertex,this._scopeStack=[],this._globalScope=new Zi,this._builtinScope=new ji,this._inputs=[],this._outputs=[],this._inputScope=new Hi,this._outputScope=new qi,this._reflection.clear(),this.generate(e.vertex);const t=this._globalScope,r=this._builtinScope,s=this._inputs,i=this._outputs;this._device.type,this._shaderType=F.Fragment,this._scopeStack=[],this._globalScope=new Zi,this._builtinScope=new ji,this._inputs=[],this._outputs=[],this._inputScope=new Hi,this._outputScope=new qi,this._reflection.clear(),i.forEach(((e,t)=>{this.in(t,e[0],new Ti(e[1].value.name,e[1].value.getType()).tag(...e[1].value.value.$tags))})),this.generate(e.fragment);const n=this._globalScope,a=this._builtinScope,o=this._inputs,u=this._outputs;return this._device.type,this.mergeUniforms(t,n),this.updateUniformBindings([t,n],[F.Vertex,F.Fragment]),[this.generateRenderSource(F.Vertex,t,r,s.map((e=>e[1])),i.map((e=>e[1]))),this.generateRenderSource(F.Fragment,n,a,o.map((e=>e[1])),u.map((e=>e[1]))),this.createBindGroupLayouts(e.label),this._vertexAttributes]}catch(e){return e instanceof es?(this._lastError=e.getMessage(this._device.type),console.error(this._lastError),null):e instanceof Error?(this._lastError=e.toString(),console.error(this._lastError),null):(this._lastError=Object.prototype.toString.call(e),console.log(`Error: ${this._lastError}`),null)}}generate(e){this.pushScope(this._globalScope),this._emulateDepthClamp&&this._shaderType===F.Vertex&&(this._globalScope.$outputs.clamppedDepth=this.float().tag("CLAMPPED_DEPTH")),e&&e.call(this._globalScope,this),this.popScope(),this._globalScope.$ast.statements=[...this._globalScope.$ast.statements.filter((e=>e instanceof ni||e instanceof Js)),...this._globalScope.$ast.statements.filter((e=>!(e instanceof ni||e instanceof Js)))]}generateRenderSource(e,t,r,s,i){const n={type:e,mrt:e===F.Fragment&&i.length>1,defines:[],extensions:new Set,builtins:[...r.$_usedBuiltins],types:this._structInfo[e]?.types||[],typeReplacement:new Map,inputs:s,outputs:i,global:t,vertexAttributes:this._vertexAttributes,workgroupSize:null};switch(this._device.type){case"webgl":for(const e of this._uniforms)if(e.texture){const t=e.texture.exp.$ast.getType();if(t.isTextureType()&&t.isDepthTexture()){if("comparison"===e.texture.autoBindSampler)throw new hs("depth texture comparison");"sample"===e.texture.autoBindSampler&&(t.is2DTexture()?n.typeReplacement.set(e.texture.exp,Xe):t.isCubeTexture()&&n.typeReplacement.set(e.texture.exp,et))}}return t.$ast.toWebGL("",n);case"webgl2":for(const e of this._uniforms)if(e.texture){const t=e.texture.exp.$ast.getType();t.isTextureType()&&t.isDepthTexture()&&"sample"===e.texture.autoBindSampler&&(t.is2DTexture()?n.typeReplacement.set(e.texture.exp,t.isArrayTexture()?He:Xe):t.isCubeTexture()&&n.typeReplacement.set(e.texture.exp,et))}return t.$ast.toWebGL2("",n);case"webgpu":return t.$ast.toWGSL("",n);default:return null}}generateComputeSource(e,t){const r={type:F.Compute,mrt:!1,defines:[],extensions:new Set,builtins:[...t.$_usedBuiltins],types:this._structInfo[F.Compute]?.types||[],typeReplacement:null,inputs:[],outputs:[],global:e,vertexAttributes:[],workgroupSize:this._workgroupSize};return e.$ast.toWGSL("",r)}mergeUniformsCompute(e){const t=[];for(let e=0;e<this._uniforms.length;e++){const r=this._uniforms[e];if(r.block&&(r.block.exp.$declareType===xs.DECLARE_TYPE_UNIFORM||r.block.exp.$declareType===xs.DECLARE_TYPE_STORAGE)){if(r.block.exp.$typeinfo.isStructType()&&r.block.exp.$isBuffer)continue;t[r.group]||(t[r.group]=[]);const s=new Ti(r.block.exp.$str,r.block.exp.$ast.getType());s.$declareType=r.block.exp.$declareType,s.$isBuffer=r.block.exp.$isBuffer,s.$bindingSize=r.block.exp.$bindingSize,s.$readonly=r.block.exp.$readonly,t[r.group].push({member:s,uniform:e})}}for(const r in t)if(t[r].length>0){const s=["std140","std430"],i=["ch_compute_uniform_block","ch_compute_storage_block"],n=[t[r].filter((e=>e.member.$declareType===xs.DECLARE_TYPE_UNIFORM)),t[r].filter((e=>e.member.$declareType===xs.DECLARE_TYPE_STORAGE))];for(let t=0;t<2;t++){if(0===n[t].length)continue;const a=[n[t].filter((e=>!e.member.$isBuffer)),...n[t].filter((e=>e.member.$isBuffer)).map((e=>[e]))];for(let n=0;n<a.length;n++){if(0===a[n].length)continue;const o=`${i[t]}_${r}_${n}`,u=this.generateStructureName(),h=gi().internalDefineStruct(u,s[t],F.Compute,!1,...a[n].map((e=>e.member))),l=!(t>0)||a[n].findIndex((e=>!e.member.$readonly))<0,c=h();0===t?c.uniformBuffer(Number(r),n>0?a[n][0].member.$bindingSize:0):(c.storageBuffer(Number(r),n>0?a[n][0].member.$bindingSize:0),c.$readonly=l),e[o]=c;const p=this._uniforms.findIndex((e=>e.block?.name===o));this._uniforms[p].mask=F.Compute;let f=this._nameMap[Number(r)];f||(f={},this._nameMap[Number(r)]=f);let d=!1;for(let e=a[n].length-1;e>=0;e--){const t=a[n][e],r=this._uniforms[t.uniform].block.exp;f[r.$str]=o,r.$str=`${o}.${r.$str}`,d||=r.$ast.isWritable()}d&&e[o].$ast.markWritable()}}}this._uniforms=this._uniforms.filter((e=>!e.block||e.block.exp.$typeinfo.isStructType()&&e.block.exp.$isBuffer))}mergeUniforms(e,t){const r=[],s=[],i=[];for(let e=0;e<this._uniforms.length;e++){const t=this._uniforms[e];if(t.block&&(t.block.exp.$declareType===xs.DECLARE_TYPE_UNIFORM||t.block.exp.$declareType===xs.DECLARE_TYPE_STORAGE)){if(t.block.exp.$typeinfo.isStructType()&&t.block.exp.$isBuffer)continue;const n=!!(t.mask&F.Vertex),a=!!(t.mask&F.Fragment);if(n&&a){i[t.group]||(i[t.group]=[]);const r=new Ti(t.block.exp.$str,t.block.exp.$ast.getType());r.$declareType=t.block.exp.$declareType,r.$isBuffer=t.block.exp.$isBuffer,r.$bindingSize=t.block.exp.$bindingSize,r.$readonly=t.block.exp.$readonly,i[t.group].push({member:r,uniform:e})}else if(n){r[t.group]||(r[t.group]=[]);const s=new Ti(t.block.exp.$str,t.block.exp.$ast.getType());s.$declareType=t.block.exp.$declareType,s.$isBuffer=t.block.exp.$isBuffer,s.$bindingSize=t.block.exp.$bindingSize,s.$readonly=t.block.exp.$readonly,r[t.group].push({member:s,uniform:e})}else if(a){s[t.group]||(s[t.group]=[]);const r=new Ti(t.block.exp.$str,t.block.exp.$ast.getType());r.$declareType=t.block.exp.$declareType,r.$isBuffer=t.block.exp.$isBuffer,r.$bindingSize=t.block.exp.$bindingSize,r.$readonly=t.block.exp.$readonly,s[t.group].push({member:r,uniform:e})}}}const n=[r,s,i],a=["ch_vertex_uniform_block","ch_fragment_uniform_block","ch_shared_uniform_block"],o=["ch_vertex_storage_block","ch_fragment_storage_block","ch_shared_storage_block"],u=[F.Vertex,F.Fragment,F.Vertex|F.Fragment];for(let r=0;r<3;r++)for(const s in n[r])if(n[r][s]?.length>0){const i=[n[r][s].filter((e=>e.member.$declareType===xs.DECLARE_TYPE_UNIFORM)),n[r][s].filter((e=>e.member.$declareType===xs.DECLARE_TYPE_STORAGE))],h=[a,o],l=["std140","std430"];for(let n=0;n<2;n++){if(0===i[n].length)continue;const a=[i[n].filter((e=>!e.member.$isBuffer)),...i[n].filter((e=>e.member.$isBuffer)).map((e=>[e]))];for(let i=0;i<a.length;i++){if(0===a[i].length)continue;const o=`${h[n][r]}_${s}_${i}`,c=this.generateStructureName(),p=gi().internalDefineStruct(c,l[n],u[r],!1,...a[i].map((e=>e.member))),f=!(n>0)||a[i].findIndex((e=>!e.member.$readonly))<0;if(u[r]&F.Vertex){const t=p();if(n>0&&!f)throw new Error("Storage buffer in vertex shader must be read-only");0===n?t.uniformBuffer(Number(s),i>0?a[i][0].member.$bindingSize:0):(t.storageBuffer(Number(s),i>0?a[i][0].member.$bindingSize:0),t.$readonly=f),e[o]=t}if(u[r]&F.Fragment){const e=p();0===n?e.uniformBuffer(Number(s),i>0?a[i][0].member.$bindingSize:0):(e.storageBuffer(Number(s),i>0?a[i][0].member.$bindingSize:0),e.$readonly=f),t[o]=e}const d=this._uniforms.findIndex((e=>e.block?.name===o));this._uniforms[d].mask=u[r];let m=this._nameMap[Number(s)];m||(m={},this._nameMap[Number(s)]=m);let _=!1;for(let e=a[i].length-1;e>=0;e--){const t=a[i][e],r=this._uniforms[t.uniform].block.exp;m[r.$str]=o,r.$str=`${o}.${r.$str}`,_||=r.$ast.isWritable()}_&&(u[r]&F.Vertex?e[o].$ast.markWritable():t[o].$ast.markWritable())}}}this._uniforms=this._uniforms.filter((e=>!e.block||e.block.exp.$typeinfo.isStructType()&&e.block.exp.$isBuffer))}updateUniformBindings(e,t){this._uniforms=this._uniforms.filter((e=>!!e.mask));const r=Array.from({length:4}).fill(0);for(const e of this._uniforms)e.binding=r[e.group]++;for(let r=0;r<e.length;r++){const s=e[r],i=t[r];for(const e of this._uniforms)if(e.mask&i){const t=s.$ast.uniforms,r=e.block?e.block.name:e.texture?e.texture.exp.$str:e.sampler.$str,i=t.findIndex((e=>e.value.name===r));if(i<0)throw new Error(`updateUniformBindings() failed: unable to find uniform ${r}`);t[i].binding=e.binding}}}createBindGroupLayouts(e){const t=[],r=[0,0,0,0];for(const s of this._uniforms){let i=t[s.group];i||(i={label:`${e||"unknown"}[${s.group}]`,entries:[]},this._nameMap[s.group]&&(i.nameMap=this._nameMap[s.group]),t[s.group]=i);const n={binding:s.binding,visibility:s.mask,type:null,name:""};if(s.block){n.type=s.block.exp.$typeinfo.clone(this.getBlockName(s.block.name));const e=s.block.exp.$declareType===xs.DECLARE_TYPE_STORAGE;n.buffer={type:e?s.block.exp.$readonly?"read-only-storage":"storage":"uniform",minBindingSize:s.block.bindingSize,hasDynamicOffset:!!s.block.bindingSize,uniformLayout:n.type.toBufferLayout(0,n.type.layout),dynamicOffsetIndex:s.block.bindingSize?r[s.group]++:-1},n.name=s.block.name}else if(s.texture){if(n.type=s.texture.exp.$typeinfo,!n.type.isTextureType())throw new Error("internal error");if(n.type.isStorageTexture())n.storageTexture={access:"write-only",viewDimension:n.type.is1DTexture()?"1d":"2d",format:n.type.storageTexelFormat};else if(n.type.isExternalTexture())n.externalTexture={autoBindSampler:s.texture.autoBindSampler?Es(s.texture.exp.$str,!1):null};else{const e="webgpu"===this._device.type?s.texture.exp.$sampleType:s.texture.autoBindSampler&&n.type.isDepthTexture()?"float":s.texture.exp.$sampleType;let t;t=n.type.isArrayTexture()?n.type.isCubeTexture()?"cube-array":"2d-array":n.type.is3DTexture()?"3d":n.type.isCubeTexture()?"cube":n.type.is1DTexture()?"1d":"2d",n.texture={sampleType:e,viewDimension:t,multisampled:!1,autoBindSampler:null,autoBindSamplerComparison:null},"webgpu"!==this._device.type&&"sample"!==s.texture.autoBindSampler||(n.texture.autoBindSampler=Es(s.texture.exp.$str,!1)),("webgpu"===this._device.type&&n.type.isDepthTexture()||"comparison"===s.texture.autoBindSampler)&&(n.texture.autoBindSamplerComparison=Es(s.texture.exp.$str,!0))}n.name=s.texture.exp.$str}else{if(!s.sampler)throw new ps("invalid uniform entry type");if(n.type=s.sampler.$typeinfo,!n.type.isSamplerType())throw new Error("internal error");n.sampler={type:n.type.accessMode===ie.SAMPLE?"float"===s.sampler.$sampleType?"filtering":"non-filtering":"comparison"},n.name=s.sampler.$str}i.entries.push(n)}for(let r=0;r<t.length;r++)t[r]||(t[r]={label:`${e||"unknown"}[${r}]`,entries:[]});return t}_getFunctionOverload(e,t){const r=t.filter((e=>{if(e instanceof Ti){const t=e.$ast.getType();if(t.isStructType()&&this._structInfo[this._shaderType]?.types.findIndex((e=>e.type.structName===t.structName))<0)return!1}return!0})),s=this.getGlobalScope().$getFunctions(e);return s?this._matchFunctionOverloading(s,r):null}_matchFunctionOverloading(e,t){for(const r of e){if(t.length!==r.funcType.argTypes.length)continue;const e=[];let s=!0;for(let i=0;i<t.length;i++){const n=r.funcType.argTypes[i],a=n.byRef&&n.type instanceof ce?n.type.pointerType:n.type,o=t[i];if("boolean"==typeof o){if(!a.isPrimitiveType()||a.primitiveType!==X.BOOL){s=!1;break}e.push(new ks(o,Le))}else if("number"==typeof o){if(!a.isPrimitiveType()||!a.isScalarType()||a.scalarType===X.BOOL){s=!1;break}if(a.scalarType===X.I32){if(!Number.isInteger(o)||o<-2147483648||o>2147483647){s=!1;break}e.push(new ks(o,Te))}else if(a.scalarType===X.U32){if(!Number.isInteger(o)||o<0||o>4294967295){s=!1;break}e.push(new ks(o,Ce))}else e.push(new ks(o,a))}else{if(!a.isCompatibleType(o.$ast.getType())){s=!1;break}e.push(o.$ast)}}if(s)return[r,e]}return null}$callFunction(e,t,r){if(this.getCurrentScope()===this.getGlobalScope())throw new ls(e);const s=new Ti("",r.returnType);return s.$ast=new ii(e,t,r,gi().getDevice().type),this.getCurrentScope().$ast.statements.push(s.$ast),s}$callFunctionNoCheck(e,t,r){if(this.getCurrentScope()===this.getGlobalScope())throw new ls(e);const s=new Ti("",r);return s.$ast=new ii(e,t,null,gi().getDevice().type,r),this.getCurrentScope().$ast.statements.push(s.$ast),s}}class Xi extends yi{$_variables;$_parentScope;$_AST;$_localScope;constructor(e,t){super(),this.$_parentScope=t||null,this.$_variables={},this.$_AST=e,this.$_localScope=null}get $builder(){return gi()}get $builtins(){return gi().builtinScope}get $inputs(){return gi().inputScope}get $outputs(){return gi().outputScope}get $parent(){return this.$_parentScope}get $ast(){return this.$_AST}set $ast(e){this.$_AST=e}$getVertexAttrib(e){return this.$inputs.$getVertexAttrib(e)}get $l(){return this.$_getLocalScope()}get $g(){return this.$_getGlobalScope()}$local(e,t){const r=gi().normalizeExpValue(t);e.$global=this instanceof Zi,this.$_declare(e,r)}$touch(e){this.$ast.statements.push(new Qs(e.$ast))}$query(e){return this.$builder.getReflection().tag(e)}$_declareInternal(e,t){const r=e.$str;if(this.$_variables[r])throw new Error(`cannot re-declare variable '${r}'`);if(!(e.$ast instanceof Rs))throw new Error(`invalid variable declaration: '${e.$ast.toString(gi().getDevice().type)}'`);const s=e.$typeinfo;if(s.isPointerType()){if(!t)throw new Error(`cannot declare pointer type variable without initialization: '${e.$str}'`);if(!(t instanceof Ti))throw new Error(`invalid initialization for pointer type declaration: '${e.$str}`);const r=t.$ast.getType();if(!r.isPointerType()||!s.pointerType.isCompatibleType(r.pointerType))throw new Error(`incompatible pointer type assignment: '${e.$str}'`);e.$typeinfo=r}if(this.$_registerVar(e,r),null==t)return new ni(e.$ast);if(t instanceof Ti&&t.$ast instanceof zs&&0===t.$ast.args.length){if(!t.$ast.getType().isCompatibleType(e.$ast.getType()))throw new rs(t,t.$ast.getType(),e.$ast.getType());return new ni(e.$ast)}return new Js(new Us(e.$ast),t instanceof Ti?t.$ast:t)}$_findOrSetUniform(e){const t=e.$str,r={group:e.$group,binding:0,mask:0};e.$typeinfo.isTextureType()?r.texture={autoBindSampler:null,exp:e}:e.$typeinfo.isSamplerType()?r.sampler=e:r.block={name:t,bindingSize:e.$bindingSize,exp:e};let s=!1;for(const t of gi()._uniforms)if(t.group===r.group){if(r.block&&t.block&&t.block.name===r.block.name&&t.block.exp.$typeinfo.isCompatibleType(r.block.exp.$typeinfo)){t.mask|=gi().shaderType,e=t.block.exp,s=!0;break}if(r.texture&&t.texture&&r.texture.exp.$str===t.texture.exp.$str&&r.texture.exp.$typeinfo.isCompatibleType(t.texture.exp.$typeinfo)){t.mask|=gi().shaderType,e=t.texture.exp,s=!0;break}if(r.sampler&&t.sampler&&r.sampler.$str===t.sampler.$str&&r.sampler.$typeinfo.isCompatibleType(t.sampler.$typeinfo)){t.mask|=gi().shaderType,e=t.sampler,s=!0;break}}if(s||(r.mask=gi().shaderType,gi()._uniforms.push(r)),r.texture&&!r.texture.exp.$typeinfo.isStorageTexture()&&"webgpu"===gi().getDevice().type){const t=e.$typeinfo.isTextureType()&&e.$typeinfo.isDepthTexture(),s=Es(e.$str,!1),i=gi().sampler(s).uniform(r.group).sampleType(e.$sampleType);if(i.$sampleType=e.$sampleType,this.$local(i),t){const t=Es(e.$str,!0),s=gi().samplerComparison(t).uniform(r.group).sampleType(e.$sampleType);this.$local(s)}}return e}$_declare(e,t){if(this.$_variables[e.$str])throw new cs(e.$ast,"cannot re-declare variable");if(e.$declareType===xs.DECLARE_TYPE_UNIFORM||e.$declareType===xs.DECLARE_TYPE_STORAGE){const t=e.$ast.name;if(!(this instanceof Zi))throw new Error(`uniform or storage variables can only be declared within global scope: ${t}`);if(!(e.$declareType!==xs.DECLARE_TYPE_UNIFORM||e.$typeinfo.isTextureType()||e.$typeinfo.isSamplerType()||e.$typeinfo.isConstructible()&&e.$typeinfo.isHostSharable()))throw new cs(e.$ast,`type '${e.$typeinfo.toTypeName(gi().getDevice().type)}' cannot be declared in uniform address space`);if(e.$declareType===xs.DECLARE_TYPE_STORAGE){if("webgpu"!==gi().getDevice().type)throw new hs("storage buffer binding");if(!e.$typeinfo.isHostSharable())throw new cs(e.$ast,`type '${e.$typeinfo.toTypeName(gi().getDevice().type)}' cannot be declared in storage address space`)}e=this.$_findOrSetUniform(e);const r=this.$_declareInternal(e);r.group=e.$group,r.binding=0,r.blockName=gi().getBlockName(t);const s=e.$typeinfo;(s.isStructType()&&e.$isBuffer||s.isTextureType()||s.isSamplerType()||s.isStructType()&&("std140"===s.detail.layout||"std430"===s.detail.layout))&&this.$ast.uniforms.push(r),e.$tags.forEach((t=>{gi().tagShaderExp((()=>e),t)}))}else{const r=this.$_declareInternal(e,t);this.$ast.statements.push(r)}}$_registerVar(e,t){const r=t||e.$str,s={configurable:!0,get:function(){return e},set:function(t){gi().getCurrentScope().$ast.statements.push(new Js(new Gs(e.$ast),t instanceof Ti?t.$ast:t))}};Object.defineProperty(this,r,s),this.$_variables[r]=e}$localGet(e){if("string"==typeof e&&("$"===e[0]||e in this))return this[e]}$localSet(e,t){return("$"===e[0]||e in this)&&(this[e]=t,!0)}$get(e){const t=this.$localGet(e);return void 0===t&&this.$_parentScope?this.$_parentScope.$thisProxy.$get(e):t}$set(e,t){if("$"===e[0])return this[e]=t,!0;{let r=this;for(;r&&!(e in r);)r=r.$_parentScope;if(r)return r[e]=t,!0;if(this.$l)return this.$l[e]=t,!0}return!1}$_getLocalScope(){return this.$_localScope||(this.$_localScope=new Yi(this)),this.$_localScope}$_getGlobalScope(){return this.$builder.getGlobalScope()}}class Yi extends Xi{$_scope;constructor(e){super(null,null),this.$_scope=e}$get(e){return"$"===e[0]?this[e]:this.$_scope.$localGet(e)}$set(e,t){if("$"===e[0])return this[e]=t,!0;if(!(this.$_scope instanceof Zi)&&t instanceof Ti&&(t.isConstructor()||t.$typeinfo.isTextureType()&&t.$ast instanceof Rs&&!t.$ast.name)&&(t.$declareType===xs.DECLARE_TYPE_UNIFORM||t.$declareType===xs.DECLARE_TYPE_STORAGE))return this.$g[e]=t,!0;if(void 0===this.$_scope.$localGet(e)){const r=gi().guessExpValueType(t);if(r.isCompatibleType(Ir))throw new Error(`Cannot assign void type to '${e}'`);const s=new Ti(e,r);return t instanceof Ti&&!this.$_scope.$parent&&(s.$declareType=t.$declareType,s.$isBuffer=t.$isBuffer,s.$bindingSize=t.$bindingSize,s.$readonly=t.$readonly,s.$group=t.$group,s.$attrib=t.$attrib,s.$sampleType=t.$sampleType,s.$precision=t.$precision,s.tag(...t.$tags)),this.$_scope.$local(s,t),!0}return this.$_scope.$localSet(e,t)}$_getLocalScope(){return this}}class ji extends Xi{$_usedBuiltins;$_builtinVars;constructor(){super(null),this.$_usedBuiltins=new Set;if(!("webgpu"===gi().getDevice().type)){this.$_builtinVars={};const e=Cs[gi().getDevice().type];for(const t in e){const r=e[t];this.$_builtinVars[t]=new Ti(r.name,r.type)}}const e=Cs[gi().getDevice().type],t=this;for(const r of Object.keys(e))Object.defineProperty(this,r,{get:function(){return t.$getBuiltinVar(r)},set:function(e){if("number"!=typeof e&&!(e instanceof Ti))throw new Error("Invalid output value assignment");const s=t.$getBuiltinVar(r);gi().getCurrentScope().$ast.statements.push(new Js(new Gs(s.$ast),e instanceof Ti?e.$ast:e))}})}$_getLocalScope(){return null}$getBuiltinVar(e){const t=gi();this.$_usedBuiltins.add(e);if("webgpu"===t.getDevice().type){const r=Cs[t.getDevice().type][e],s=r.inOrOut;if("in"===s)return t.getCurrentFunctionScope()[bs(t.shaderType)][r.name];const i="in"===s?Ts(t.shaderType):ws(t.shaderType),n=t.getCurrentScope();if(!n[i]||!n[i][r.name])throw new Error(`invalid use of builtin variable ${e}`);return n[i][r.name]}return"webgl2"!==t.getDevice().type||"vertexIndex"!==e&&"instanceIndex"!==e?this.$_builtinVars[e]:t.uint(this.$_builtinVars[e])}}class Hi extends Xi{$_names;$_aliases;constructor(){super(null),this.$_names={},this.$_aliases={}}$getVertexAttrib(e){const t=this.$_names[e];return t?this[t]:null}$_getLocalScope(){return null}$get(e){if("$"===e[0])return this[e];this.$_aliases[e]&&(e=this.$_aliases[e]);const t=this.$builder;if("webgpu"===t.getDevice().type){const r=t.getCurrentFunctionScope()[bs(t.shaderType)],s="vertex"===t.shaderKind?zi:ki,i=`${s}${e}`;if(r.$typeinfo.structMembers.findIndex((e=>e.name===i))<0)return;return r[`${s}${e}`]}return super.$get(e)}$set(e,t){if("$"===e[0])this[e]=t;else{if(!(t instanceof Ti))throw new Error("invalid vertex input value");const r=gi().shaderType;if(r!==F.Vertex)throw new Error(`shader input variables can only be declared in vertex shader: "${e}"`);const s=kr(t.$attrib);if(void 0===s)throw new Error(`can not declare shader input variable: invalid vertex attribute: "${e}"`);if(gi()._vertexAttributes.indexOf(s)>=0){const r=this.$_names[t.$attrib];if(e!==r){if(this[r].$typeinfo.typeId!==t.$typeinfo.typeId)throw new Error(`can not declare shader input variable: attribute already declared with different type: "${e}"`);this.$_aliases[e]=r}return!0}if(!(t instanceof Ti&&t.$ast instanceof zs))throw new Error(`invalid shader input variable declaration: "${e}"`);const i=t.$ast.getType();if(!i.isPrimitiveType()||i.isMatrixType()||i.primitiveType===X.BOOL)throw new Error(`type cannot be used as pipeline input/output: ${e}`);this.$_names[t.$attrib]=e;const n=gi()._inputs.length,a=new Ti(`${zi}${e}`,i).tag(...t.$tags);gi().in(n,e,a),gi()._vertexAttributes.push(s),"webgpu"===gi().getDevice().type&&gi().findStructType(vs(r),r)&&gi().defineBuiltinStruct(r,"in")}return!0}}class qi extends Xi{constructor(){super(null)}$_getLocalScope(){return null}$set(e,t){if("$"===e[0])this[e]=t;else{const r=gi();if(!(e in this)){if(!(r.getCurrentScope()!==r.getGlobalScope()||t instanceof Ti&&t.$ast instanceof zs))throw new Error(`invalid shader output variable declaration: ${e}`);const s=t.$ast.getType();if(!s.isPrimitiveType()||s.isMatrixType()||s.primitiveType===X.BOOL)throw new Error(`type cannot be used as pipeline input/output: ${e}`);const i=r._outputs.length;if(r.out(i,e,new Ti(`${"vertex"===r.shaderKind?ki:"zFSOutput_"}${e}`,s).tag(...t.$tags)),"webgpu"===gi().getDevice().type){const e=gi().shaderType;gi().findStructType(vs(e),e)&&gi().defineBuiltinStruct(e,"out")}}if(gi().getCurrentScope()!==gi().getGlobalScope()){const r=t.$ast;r instanceof zs&&!(r.args.length>0)||(this[e]=t)}}return!0}}class Zi extends Xi{$_inputStructInfo;constructor(){super(new Ms),this.$_inputStructInfo=null}get $inputStructInfo(){return this.$_inputStructInfo||(this.$_inputStructInfo=this.$builder.defineBuiltinStruct(this.$builder.shaderType,"in")),this.$_inputStructInfo}get $inputStruct(){return this.$inputStructInfo[0]}$mainFunc(e){const t=gi();if("webgpu"===t.getDevice().type){const r=this.$inputStructInfo,s=t.shaderType===F.Compute,i=s?null:t.defineBuiltinStruct(t.shaderType,"out");i&&this.$local(i[1]),this.$internalCreateFunction("main",r?[r[3]]:[],!0,(function(){t.shaderType===F.Fragment&&t.emulateDepthClamp&&(this.$builtins.fragDepth=t.clamp(this.$inputs.clamppedDepth,0,1)),e?.call(this),t.shaderType===F.Vertex&&(t.depthRangeCorrection&&(this.$builtins.position.z=t.mul(t.add(this.$builtins.position.z,this.$builtins.position.w),.5)),t.emulateDepthClamp&&(this.$outputs.clamppedDepth=t.div(this.$builtins.position.z,this.$builtins.position.w),this.$builtins.position.z=0)),s||this.$return(i[1])}))}else this.$internalCreateFunction("main",[],!0,(function(){t.shaderType===F.Fragment&&t.emulateDepthClamp&&(this.$builtins.fragDepth=t.clamp(this.$inputs.clamppedDepth,0,1)),e?.call(this),t.shaderType===F.Vertex&&t.emulateDepthClamp&&(this.$outputs.clamppedDepth=t.div(t.add(t.div(this.$builtins.position.z,this.$builtins.position.w),1),2),this.$builtins.position.z=0)}))}$createFunctionIfNotExists(e,t,r){this.$internalCreateFunction(e,t,!1,r)}$getFunctions(e){return this.$ast.findFunctions(e)}$getCurrentFunctionScope(){let e=gi().getCurrentScope();for(;e&&!(e instanceof Ki);)e=e.$parent;return e}$internalCreateFunction(e,t,r,s){const i=gi();"webgpu"!==i.getDevice().type||r||t.push(this.$inputStruct(bs(i.shaderType))),t.forEach((t=>{if(!(t.$ast instanceof Rs))throw new Error(`${e}(): invalid function definition`);let r=t.$ast;t.$inout&&("webgpu"===gi().getDevice().type&&(t.$typeinfo=new ce(t.$typeinfo,ne.UNKNOWN)),r=new js(t.$ast)),t.$ast=new Ds(r)}));const n=this.$getFunctions(e),a=this.$getCurrentFunctionScope(),o=new ai(e,t.map((e=>e.$ast)),r,null,!1);if(a){const e=this.$ast.statements.indexOf(a.$ast);if(e<0)throw new Error("Internal error");this.$ast.statements.splice(e,0,o)}else this.$ast.statements.push(o);new Ki(this,t,o,s),o.returnType||(o.returnType=Ir),o.funcType=new de(o.name,o.returnType,t.map((e=>{const t=e.$ast;return t.paramAST instanceof js?{type:t.paramAST.value.getType(),byRef:t.paramAST instanceof js}:{type:t.paramAST.getType(),byRef:!1}})));for(const t of n)if(t.funcType.argHash===o.funcType.argHash){if(t.returnType.isCompatibleType(o.returnType))return void this.$ast.statements.splice(this.$ast.statements.indexOf(o),1);throw new Error(`Invalid function overloading: ${e}`)}0===n.length&&Object.defineProperty(this,e,{get:function(){if(0===this.$getFunctions(e).length)throw new Error(`function ${e} not found`);return(...t)=>{let r=null;if("webgpu"===i.getDevice().type){let e=i.getCurrentScope();for(;e&&!(e instanceof Ki);)e=e.$parent;const t=e.$ast.args;r=e[t[t.length-1].paramAST.name]}const s=(r?[...t,r]:t).map((e=>i.normalizeExpValue(e))),n=i._getFunctionOverload(e,s);if(!n)throw new Error(`ERROR: no matching overloads for function ${e}`);return gi().$callFunction(e,n[1],n[0])}}})}}class Qi extends Xi{constructor(e){super(new Os,e)}$return(e){const t=this.findOwnerFunction().$ast;let r=null;const s=gi().normalizeExpValue(e);if(null!=s)if("number"==typeof s){if(t.returnType&&t.returnType.isPrimitiveType()&&t.returnType.isScalarType()&&!t.returnType.isCompatibleType(Le)&&(r=t.returnType),!r)if(Number.isInteger(s))if(s<0){if(s<-2147483648)throw new Error(`function ${t.name}: invalid return value: ${s}`);r=Te}else{if(s>4294967295)throw new Error(`function ${t.name}: invalid return value: ${s}`);r=s<=2147483647?Te:Ce}else r=me}else r="boolean"==typeof s?Le:s.$ast.getType();else r=Ir;if(r.isPointerType())throw new Error("function can not return pointer type");if(t.returnType){if(!t.returnType.isCompatibleType(r))throw new Error(`function ${t.name}: return type must be ${t.returnType?.toTypeName(gi().getDevice().type)||"void"}`)}else t.returnType=r;let i=null;if(null!=s)if(s instanceof Ti)i=s.$ast;else{if(!r.isPrimitiveType()||!r.isScalarType())throw new rs(s,typeof s,r);i=new ks(s,r)}this.$ast.statements.push(new si(i))}$scope(e){const t=new Fs;return this.$ast.statements.push(t),new rn(this,t,e)}$if(e,t){const r=new oi("if",e instanceof Ti?e.$ast:new ks(e,"number"==typeof e?me:Le));return this.$ast.statements.push(r),new sn(this,r,t)}$choice(e,t,r){const s=new Ks(e instanceof Ti?e.$ast:e,t instanceof Ti?t.$ast:t,r instanceof Ti?r.$ast:r),i=new Ti("",s.getType());return i.$ast=s,i}$break(){this.$ast.statements.push(new ti)}$continue(){this.$ast.statements.push(new ri)}$for(e,t,r,s){const i=e.$ast.getType();if(!i.isPrimitiveType()||!i.isScalarType())throw new cs(e.$ast,"invalid for range initializer type");const n=t instanceof Ti?t.$ast:new ks(t,i),a=new ui(e.$ast,n,r instanceof Ti?r.$ast:new ks(r,i),!0);this.$ast.statements.push(a),new tn(this,e,r,a,s)}$do(e){if("webgl"===this.$builder.getDevice().type)throw new Error("No do-while() loop support for WebGL1.0 device");const t=new hi(null);return this.$ast.statements.push(t),new en(this,t,e)}$while(e,t){const r=new li(e instanceof Ti?e.$ast:new ks(e,"number"==typeof e?me:Le));this.$ast.statements.push(r),new Ji(this,r,t)}findOwnerFunction(){for(let e=this;e;e=e.$parent)if(e instanceof Ki)return e;return null}}class Ki extends Qi{$typeinfo;constructor(e,t,r,s){super(e),this.$ast=r;for(const e of t){if(this.$_variables[e.$str])throw new Error("Duplicate function parameter name is not allowed");this.$_registerVar(e)}gi().pushScope(this),s&&s.call(this),gi().popScope()}$isMain(){return this.$ast.isMainFunc}}class Ji extends Qi{constructor(e,t,r){super(e),this.$ast=t,gi().pushScope(this),r&&r.call(this),gi().popScope()}}class en extends Qi{constructor(e,t,r){super(e),this.$ast=t,gi().pushScope(this),r&&r.call(this),gi().popScope()}$while(e){this.$ast.condition=e instanceof Ti?e.$ast:new ks(e,"number"==typeof e?me:Le)}}class tn extends Qi{constructor(e,t,r,s,i){super(e),this.$ast=s,this.$_registerVar(t),gi().pushScope(this),i&&i.call(this),gi().popScope()}}class rn extends Qi{constructor(e,t,r){super(e),this.$ast=t,gi().pushScope(this),r&&r.call(this),gi().popScope()}}class sn extends Qi{constructor(e,t,r){super(e),this.$ast=t,gi().pushScope(this),r&&r.call(this),gi().popScope()}$elseif(e,t){const r=new oi("else if",e instanceof Ti?e.$ast:new ks(e,"number"==typeof e?me:Le));return this.$ast.nextElse=r,new sn(this.$_parentScope,r,t)}$else(e){const t=new oi("else",null);this.$ast.nextElse=t,new sn(this.$_parentScope,t,e)}}var nn;!function(e){for(const t of Object.keys(Ri))e.prototype[t]=function(...e){return(Ri?.[t]?.normalizeFunc||Si)(this,t,...e)}}(Wi),nn=Wi,Object.keys(Pi).forEach((e=>{nn.prototype[e]=xi((function(...t){return Gi.call(this,Pi[e],...t)}),Pi[e])})),Object.keys(Ni).forEach((e=>{nn.prototype[e]=function(t){return new Ti(t,Ni[e])}})),Object.keys(Ui).forEach((e=>{nn.prototype[e]=function(e){const t={};for(const r of Object.keys(Vi))t[r]=function(t){return new Ti(t,new fe(e,Vi[r]))};return t}(Ui[e])})),nn.prototype.atomic_int=xi((function(...e){if(e.length>1)throw new ss("atomic_int");if(1===e.length){if("string"!=typeof e[0])throw new is("atomic_int","name");return new Ti(e[0],ye)}{const e=new Ti("",ye);return e.$ast=new zs(e.$typeinfo,[]),e}}),ye),nn.prototype.atomic_uint=xi((function(...e){if(e.length>1)throw new ss("atomic_uint");if(1===e.length&&"string"==typeof e[0])return new Ti(e[0],be);if(0===e.length){const e=new Ti("",be);return e.$ast=new zs(e.$typeinfo,[]),e}const t=e[0];if("number"==typeof t&&Number.isInteger(t)||t instanceof Ti&&t.$ast.getType().typeId===Ce.typeId){const e=new Ti("",be);return e.$ast=new zs(e.$typeinfo,[t instanceof Ti?t.$ast:t]),e}return null}),be);class an{static _canvas=null;static _context=null;static get canvas(){return this._realize(),this._canvas}static get context(){return this._realize(),this._context}static get font(){return this.context.font}static set font(e){this.context.font=e}static _realize(){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=512,this._canvas.height=512,this._canvas.style.left="-10000px",this._canvas.style.position="absolute",this._context=this._canvas.getContext("2d",{willReadFrequently:!0}),this._context.textBaseline="top",this._context.textAlign="left",this._context.fillStyle="transparent",this._context.fillRect(0,0,this._canvas.width,this._canvas.height),this._context.fillStyle="#ffffff",this._context.imageSmoothingEnabled=!0)}}class on{static fontCache={};_name;_nameScaled;_scale;_size;_family;_top;_bottom;_topScaled;_bottomScaled;_div;constructor(e,t){this._top=0,this._bottom=0,this._size=0,this._topScaled=0,this._bottomScaled=0,this._family="",this._scale=t,this._name=e,this._nameScaled=null,this._div=document.createElement("div"),this._name&&this._normalizeFont()}static fetchFont(e,t){let r=this.fontCache[e];r||(r={},this.fontCache[e]=r);let s=r[t];return s||(s=new on(e,t),r[t]=s),s}get fontName(){return this._name}set fontName(e){this._name=e,this._normalizeFont()}get fontNameScaled(){return this._nameScaled}get size(){return this._size}get family(){return this._family}get top(){return this._top}get bottom(){return this._bottom}get topScaled(){return this._topScaled}get bottomScaled(){return this._bottomScaled}get maxHeight(){return this._bottom-this._top+1}get maxHeightScaled(){return this._bottomScaled-this._topScaled+1}equalTo(e){return this._size===e._size&&this._family===e._family}_measureFontHeight(e){const t=an.context.font,r=an.context.textBaseline,s=an.context.fillStyle;an.context.font=e,this._div.style.font=an.context.font;const i=this._div.style.fontSize,n=parseInt(i.substring(0,i.length-2)),a=this._div.style.fontFamily,o="bdfghijklpq|_~",u=an.context.measureText(o);let h,l;h=0,l=n-1;const c=Math.ceil(u.width)+10,p=n+10;an.context.clearRect(0,0,c,p),an.context.textBaseline="top",an.context.fillStyle="#ffffff",an.context.fillText(o,5,5);const f=an.context.getImageData(0,0,c,p).data;for(let e=0;e<c*p;e++)if(f[4*e+3]>0){h=Math.floor(e/c);break}for(let e=c*p-1;e>=0;e--)if(f[4*e+3]>0){l=Math.floor(e/c);break}return h-=5,l-=5,an.context.font=t,an.context.textBaseline=r,an.context.fillStyle=s,{size:n,family:a,top:h,bottom:l}}_normalizeFont(){const e=this._measureFontHeight(this._name);this._nameScaled=`${Math.round(e.size*this._scale)}px ${e.family}`;const t=this._measureFontHeight(this._nameScaled);this._size=e.size,this._family=e.family,this._top=e.top,this._bottom=e.bottom,this._topScaled=t.top,this._bottomScaled=t.bottom}}class un{static ATLAS_WIDTH=1024;static ATLAS_HEIGHT=1024;_packer;_device;_binWidth;_binHeight;_rectBorderWidth;_linearSpace;_atlasList;_atlasInfoMap;_atlasRestoreHandler;constructor(e,t,r,s,i){this._device=e,this._binWidth=t,this._binHeight=r,this._rectBorderWidth=s,this._linearSpace=!!i,this._packer=new d(this._binWidth,this._binHeight),this._atlasList=[],this._atlasInfoMap={},this._atlasRestoreHandler=null}get atlasTextureRestoreHandler(){return this._atlasRestoreHandler}set atlasTextureRestoreHandler(e){this._atlasRestoreHandler=e}getAtlasTexture(e){return this._atlasList[e]}getAtlasInfo(e){return this._atlasInfoMap[e]||null}isEmpty(){return 0===this._atlasList.length}clear(){this._packer.clear();for(const e of this._atlasList)e.dispose();this._atlasList=[],this._atlasInfoMap={}}pushCanvas(e,t,r,s,i,n){const a=this._packer.insert(i+2*this._rectBorderWidth,n+2*this._rectBorderWidth);if(a){const o=a.x+this._rectBorderWidth,u=a.y+this._rectBorderWidth;this._updateAtlasTextureCanvas(a.binIndex,t,o,u,i,n,r,s);const h={atlasIndex:a.binIndex,uMin:o/this._binWidth,vMin:u/this._binHeight,uMax:(o+i)/this._binWidth,vMax:(u+n)/this._binHeight,width:i,height:n};return this._atlasInfoMap[e]=h,h}return null}pushBitmap(e,t){const r=this._packer.insert(t.width+2*this._rectBorderWidth,t.height+2*this._rectBorderWidth);if(r){const s=r.x+this._rectBorderWidth,i=r.y+this._rectBorderWidth;this._updateAtlasTexture(r.binIndex,t,s,i);const n={atlasIndex:r.binIndex,uMin:s/this._binWidth,vMin:i/this._binHeight,uMax:(s+t.width)/this._binWidth,vMax:(i+t.height)/this._binHeight,width:t.width,height:t.height};return this._atlasInfoMap[e]=n,n}return null}_createAtlasTexture(){const e=this._device.createTexture2D("rgba8unorm",this._binWidth,this._binHeight,{samplerOptions:{mipFilter:"none"}});return e.update(new Uint8Array(e.width*e.height*4),0,0,e.width,e.height),e.restoreHandler=async()=>{e.update(new Uint8Array(e.width*e.height*4),0,0,e.width,e.height),this._atlasRestoreHandler&&await this._atlasRestoreHandler(e)},e}_updateAtlasTextureCanvas(e,t,r,s,i,n,a,o){let u=null;e===this._atlasList.length?(u=this._createAtlasTexture(),this._atlasList.push(u)):u=this._atlasList[e],u.updateFromElement(t.canvas,r,s,a,o,i,n)}_updateAtlasTexture(e,t,r,s){let i=null;if(e===this._atlasList.length?(i=this._createAtlasTexture(),this._atlasList.push(i)):i=this._atlasList[e],t instanceof ImageBitmap)i.updateFromElement(t,r,s,0,0,t.width,t.height);else{const e=new Uint8Array(t.data.buffer);i.update(e,r,s,t.width,t.height)}}}class hn extends un{constructor(e,t,r,s){super(e,t,r,s,!0),this.atlasTextureRestoreHandler=async()=>{this.isEmpty()||this.clear()}}getGlyphInfo(e,t){if(!e||!t)return null;let r=this.getAtlasInfo(this._hash(e,t));return r||(r=this._cacheGlyph(e,t),r.width=Math.round(r.width*(t.maxHeight/t.maxHeightScaled)),r.height=t.maxHeight),r}measureStringWidth(e,t,r){let s=0;for(const i of e)s+=t+this.getCharWidth(i,r);return s}clipStringToWidth(e,t,r,s,i){let n=0,a=s;for(;a<e.length&&(n+=r+this.getCharWidth(e[a],i),!(n>t));a++);return a-s}_hash(e,t){return`${t.family}@${t.size}&${e}`}_cacheGlyph(e,t){const r=this._getGlyphBitmap(e,t);return this.pushBitmap(this._hash(e,t),r)}getCharWidth(e,t){if(!t)return 0;an.font=t.fontNameScaled;const r=an.context.measureText(e);let s=r.width;return 0===s?0:("number"==typeof r.actualBoundingBoxRight&&(s=Math.floor(Math.max(s,r.actualBoundingBoxRight)+.8)),s=Math.round(s*(t.maxHeight/t.maxHeightScaled)),s)}_getGlyphBitmap(e,t){if(!t)return null;an.font=t.fontNameScaled;const r=an.context.measureText(e);let s=r.width;if(0===s)return null;"number"==typeof r.actualBoundingBoxRight&&(s=Math.floor(Math.max(s,r.actualBoundingBoxRight)+.8));const i=t.maxHeightScaled;return an.context.fillStyle="#fff",an.context.clearRect(0,0,s+2,i),an.context.fillText(e,0,-t.topScaled),an.context.getImageData(0,0,s,i)}}class ln{static GLYPH_COUNT=1024;static glyphManager=null;static prepared=!1;static textVertexBuffer=null;static textVertexLayout=null;static textProgram=null;static textBindGroup=null;static textRenderStates=null;static textOffset=0;static textMatrix=new f;static font=null;static vertexCache=null;static colorValue=new l;static calculateTextMatrix(e,t){const r=e.getViewport(),s=f.ortho(0,r.width,0,r.height,1,100),i=f.translation(new h(0,r.height,0)).scaleRight(new h(1,-1,1));f.multiply(s,i,t)}static setFont(e,t){this.font=on.fetchFont(t,e.getScale())||on.fetchFont("12px arial",e.getScale())}static drawText(t,r,s,i,n){if(r.length>0){t.pushDeviceStates(),this.prepareDrawText(t),this.calculateTextMatrix(t,this.textMatrix);const a=function(t){t=t.trim().toLowerCase();let r=null;if("#"===(t=e[t]||t)[0]){const e=(t.length-1)/3,s=[17,1,.062272][e-1];r={r:parseInt(t.substring(1,1+e),16)*s/255,g:parseInt(t.substring(1+e,1+2*e),16)*s/255,b:parseInt(t.substring(1+2*e,1+3*e),16)*s/255,a:1}}else{let e;(e=t.match(/^\s*rgb\s*\(\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\s*,\s*(\d\.?\d*)\s*\)\s*$/i))?r={r:Number(e[1])/255,g:Number(e[2])/255,b:Number(e[3])/255,a:1}:(e=t.match(/^\s*rgba\s*\(\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\s*,\s*([\d*.?\d*]+)\s*,\s*(\d*\.?\d*)\s*\)\s*$/i))&&(r={r:Number(e[1])/255,g:Number(e[2])/255,b:Number(e[3])/255,a:Number(e[4])})}if(!r||Number.isNaN(r.r)||Number.isNaN(r.g)||Number.isNaN(r.b)||Number.isNaN(r.a))throw new Error(`parseColor(): invalid color '${t}'`);return r.r=Math.pow(Math.min(1,r.r),2.2),r.g=Math.pow(Math.min(1,r.g),2.2),r.b=Math.pow(Math.min(1,r.b),2.2),r.a=Math.min(1,r.a),r}(s);this.colorValue.x=a.r,this.colorValue.y=a.g,this.colorValue.z=a.b,this.colorValue.w=a.a,this.textBindGroup.setValue("flip","webgpu"===t.type&&t.getFramebuffer()?1:0),this.textBindGroup.setValue("srgbOut",t.getFramebuffer()?0:1),this.textBindGroup.setValue("textMatrix",this.textMatrix),this.textBindGroup.setValue("textColor",this.colorValue),t.setProgram(this.textProgram),t.setVertexLayout(this.textVertexLayout),t.setRenderStates(this.textRenderStates),t.setBindGroup(0,this.textBindGroup);let o=0;const u=r.length;for(;o<u;){const e=Math.min(u-o,this.GLYPH_COUNT-this.textOffset);e>0&&(i=this.drawTextNoOverflow(t,r,o,e,i,n),o+=e,this.textOffset+=e),this.GLYPH_COUNT===this.textOffset&&(this.textOffset=0,t.flush())}t.popDeviceStates()}}static drawTextNoOverflow(e,t,r,s,i,n){let a=0,o=-1,u=0;for(;u<s;u++){const s=this.glyphManager.getGlyphInfo(t[u+r],this.font)||this.glyphManager.getGlyphInfo("?",this.font);o>=0&&s.atlasIndex!==o&&(this.textVertexBuffer.bufferSubData(16*(this.textOffset+a)*4,this.vertexCache,16*(this.textOffset+a),16*(u-a)),this.textBindGroup.setTexture("tex",this.glyphManager.getAtlasTexture(o)),e.draw("triangle-list",6*(this.textOffset+a),6*(u-a)),a=u),o=s.atlasIndex;const h=16*(this.textOffset+u);this.vertexCache[h+0]=i,this.vertexCache[h+1]=n,this.vertexCache[h+2]=s.uMin,this.vertexCache[h+3]=s.vMin,this.vertexCache[h+4]=i+s.width,this.vertexCache[h+5]=n,this.vertexCache[h+6]=s.uMax,this.vertexCache[h+7]=s.vMin,this.vertexCache[h+8]=i+s.width,this.vertexCache[h+9]=n+s.height,this.vertexCache[h+10]=s.uMax,this.vertexCache[h+11]=s.vMax,this.vertexCache[h+12]=i,this.vertexCache[h+13]=n+s.height,this.vertexCache[h+14]=s.uMin,this.vertexCache[h+15]=s.vMax,i+=s.width}return this.textVertexBuffer.bufferSubData(16*(this.textOffset+a)*4,this.vertexCache,16*(this.textOffset+a),16*(u-a)),this.textBindGroup.setTexture("tex",this.glyphManager.getAtlasTexture(o)),e.draw("triangle-list",6*(this.textOffset+a),6*(u-a)),i}static prepareDrawText(e){if(!this.prepared){this.prepared=!0,this.font=this.font||on.fetchFont("16px arial",e.getScale()),this.glyphManager=new hn(e,1024,1024,1),this.vertexCache=new Float32Array(16*this.GLYPH_COUNT),this.textVertexBuffer=e.createInterleavedVertexBuffer(["position_f32x2","tex0_f32x2"],this.vertexCache,{dynamic:!0});const t=new Uint16Array(6*this.GLYPH_COUNT);for(let e=0;e<this.GLYPH_COUNT;e++){const r=4*e;t[6*e+0]=r+0,t[6*e+1]=r+1,t[6*e+2]=r+2,t[6*e+3]=r+0,t[6*e+4]=r+2,t[6*e+5]=r+3}const r=e.createIndexBuffer(t);this.textVertexLayout=e.createVertexLayout({vertexBuffers:[{buffer:this.textVertexBuffer}],indexBuffer:r}),this.textOffset=0,this.textProgram=e.buildRenderProgram({vertex(e){this.$inputs.pos=e.vec2().attrib("position"),this.$inputs.uv=e.vec2().attrib("texCoord0"),this.$outputs.uv=e.vec2(),this.flip=e.int(0).uniform(0),this.textMatrix=e.mat4().uniform(0),e.main((function(){this.$builtins.position=e.mul(this.textMatrix,e.vec4(this.$inputs.pos,-50,1)),this.$if(e.notEqual(this.flip,0),(function(){this.$builtins.position.y=e.neg(this.$builtins.position.y)})),this.$outputs.uv=this.$inputs.uv}))},fragment(e){this.$outputs.color=e.vec4(),this.textColor=e.vec4().uniform(0),this.tex=e.tex2D().uniform(0),this.srgbOut=e.int().uniform(0),e.main((function(){this.alpha=e.mul(e.textureSample(this.tex,this.$inputs.uv).a,this.textColor.a),this.$if(e.notEqual(this.srgbOut,0),(function(){this.$outputs.color=e.vec4(e.mul(e.pow(this.textColor.rgb,e.vec3(1/2.2)),this.alpha),this.alpha)})).$else((function(){this.$outputs.color=e.vec4(e.mul(this.textColor.rgb,this.alpha),this.alpha)}))}))}}),this.textBindGroup=e.createBindGroup(this.textProgram.bindGroupLayouts[0]),this.textRenderStates=e.createRenderStateSet(),this.textRenderStates.useBlendingState().enable(!0).setBlendFuncRGB("one","inv-src-alpha").setBlendFuncAlpha("zero","one"),this.textRenderStates.useDepthState().enableTest(!1).enableWrite(!1),this.textRenderStates.useRasterizerState().setCullMode("none")}}}class cn{_memCost;_memCostThreshold;_device;_freeTextures={};_allocatedTextures=new WeakMap;_autoReleaseTextures=new Set;_freeFramebuffers={};_allocatedFramebuffers=new WeakMap;_autoReleaseFramebuffers=new Set;constructor(e,t=1073741824){this._device=e,this._memCost=0,this._memCostThreshold=t,this._freeTextures={},this._allocatedTextures=new WeakMap,this._autoReleaseTextures=new Set,this._freeFramebuffers={},this._allocatedFramebuffers=new WeakMap,this._autoReleaseFramebuffers=new Set,this._memCost=0}autoRelease(){for(const e of this._autoReleaseTextures)this.releaseTexture(e);this._autoReleaseTextures.clear();for(const e of this._autoReleaseFramebuffers)this.releaseFrameBuffer(e);this._autoReleaseFramebuffers.clear(),this._memCost>=this._memCostThreshold&&this.purge()}fetchTemporalTexture2D(e,t,r,s,i){const n=`2d:${t}:${r}:${s}:${i?1:0}`;let a=null;const o=this._freeTextures[n];return o?(a=o.pop(),0===o.length&&delete this._freeTextures[n]):(a=this._device.createTexture2D(t,r,s,i?{}:{samplerOptions:{mipFilter:"none"}}),this._memCost+=a.memCost),this._allocatedTextures.set(a,{hash:n,refcount:1,dispose:!1}),e&&this._autoReleaseTextures.add(a),a}fetchTemporalTexture2DArray(e,t,r,s,i,n){const a=`2darray:${t}:${r}:${s}:${i}:${n?1:0}`;let o=null;const u=this._freeTextures[a];return u?(o=u.pop(),0===u.length&&delete this._freeTextures[a]):(o=this._device.createTexture2DArray(t,r,s,i,n?{}:{samplerOptions:{mipFilter:"none"}}),this._memCost+=o.memCost),this._allocatedTextures.set(o,{hash:a,refcount:1,dispose:!1}),e&&this._autoReleaseTextures.add(o),o}fetchTemporalTextureCube(e,t,r,s){const i=`cube:${t}:${r}:${s?1:0}`;let n=null;const a=this._freeTextures[i];return a?(n=a.pop(),0===a.length&&delete this._freeTextures[i]):(n=this._device.createCubeTexture(t,r,s?{}:{samplerOptions:{mipFilter:"none"}}),this._memCost+=n.memCost),this._allocatedTextures.set(n,{hash:i,refcount:1,dispose:!1}),e&&this._autoReleaseTextures.add(n),n}fetchTemporalFramebuffer(e,t,r,s,i,n,a,o){const u="string"==typeof s?[this.fetchTemporalTexture2D(!1,s,t,r,n)]:s?[s]:null,h="string"==typeof i?this.fetchTemporalTexture2D(!1,i,t,r,!1):i,l=this.createTemporalFramebuffer(e,u,h,a,o);return"string"==typeof s&&this.releaseTexture(u[0]),"string"==typeof i&&this.releaseTexture(h),l}createTemporalFramebuffer(e,t,r,s,i){t=t??[];let n=`${r?.uid??0}:${s??1}:${i?1:0}`;for(const e of t)n+=`:${e.uid}`;let a=null;const o=this._freeFramebuffers[n];o?(a=o.pop(),0===o.length&&delete this._freeFramebuffers[n]):a=this._device.createFrameBuffer(t,r,{ignoreDepthStencil:i,sampleCount:s});const u=this._allocatedTextures.get(r);u&&u.refcount++;for(const e of t){const t=this._allocatedTextures.get(e);t&&t.refcount++}return this._allocatedFramebuffers.set(a,n),e&&this._autoReleaseFramebuffers.add(a),a}disposeTexture(e){this.safeReleaseTexture(e,!0)}releaseTexture(e){this._allocatedTextures.get(e)?this.safeReleaseTexture(e):console.error("ObjectPool.releaseTexture(): texture is not allocated from pool")}disposeFrameBuffer(e){this._allocatedFramebuffers.get(e)?(this.internalDisposeFrameBuffer(e),e.dispose()):console.error("ObjectPool.disposeFrameBuffer(): framebuffer is not allocated from pool")}releaseFrameBuffer(e){const t=this._allocatedFramebuffers.get(e);if(t){this.internalDisposeFrameBuffer(e);const r=this._freeFramebuffers[t];r?r.push(e):this._freeFramebuffers[t]=[e]}else console.error("ObjectPool.releaseFrameBuffer(): framebuffer is not allocated from pool")}purge(){for(const e in this._freeFramebuffers){if(this._freeFramebuffers[e])for(const t of this._freeFramebuffers[e])this.internalDisposeFrameBuffer(t),t.dispose()}this._freeFramebuffers={};for(const e in this._freeTextures){const t=this._freeTextures[e];for(const e of t)this._memCost-=e.memCost,e.dispose()}this._freeTextures={}}internalDisposeFrameBuffer(e){if(e){const t=e.getColorAttachments();if(t)for(const e of t)this.safeReleaseTexture(e);const r=e.getDepthAttachment();r&&this.safeReleaseTexture(r),this._allocatedFramebuffers.delete(e),this._autoReleaseFramebuffers.delete(e)}}safeReleaseTexture(e,t=!1){const r=this._allocatedTextures.get(e);if(r)if(r.refcount--,0===r.refcount)if(this._allocatedTextures.delete(e),this._autoReleaseTextures.delete(e),t||r.dispose)this._memCost-=e.memCost,e.dispose();else{const t=this._freeTextures[r.hash];t?t.push(e):this._freeTextures[r.hash]=[e]}else t&&(r.dispose=!0)}}class pn{_canvas;_canvasClientWidth;_canvasClientHeight;_gpuObjectList;_gpuMemCost;_disposeObjectList;_beginFrameTime;_endFrameTime;_frameInfo;_cpuTimer;_gpuTimer;_runningLoop;_fpsCounter;_runLoopFunc;_backend;_beginFrameCounter;_programBuilder;_pool;_temporalFramebuffer;_vSync;_stateStack;constructor(e,t){this._backend=t,this._gpuObjectList={textures:[],samplers:[],buffers:[],programs:[],framebuffers:[],vertexArrayObjects:[],bindGroups:[]},this._canvas=e,this._canvas.setAttribute("tabindex","1"),this._canvasClientWidth=e.clientWidth,this._canvasClientHeight=e.clientHeight,this._gpuMemCost=0,this._disposeObjectList=[],this._beginFrameTime=0,this._endFrameTime=0,this._runLoopFunc=null,this._frameInfo={frameCounter:0,frameTimestamp:0,elapsedTimeCPU:0,elapsedTimeGPU:0,elapsedFrame:0,elapsedOverall:0,FPS:0,drawCalls:0,computeCalls:0,nextFrameCall:[],nextFrameCallNext:[]},this._programBuilder=new Wi(this),this._cpuTimer=new Qr,this._gpuTimer=null,this._runningLoop=null,this._fpsCounter={time:0,frame:0},this._stateStack=[],this._beginFrameCounter=0,this._pool=new cn(this),this._temporalFramebuffer=!1,this._vSync=!0,this._registerEventHandlers()}get backend(){return this._backend}get videoMemoryUsage(){return this._gpuMemCost}get frameInfo(){return this._frameInfo}get isRendering(){return null!==this._runningLoop}get canvas(){return this._canvas}get type(){return this._backend.typeName()}get vSync(){return this._vSync}set vSync(e){this._vSync=!!e}get pool(){return this._pool}get runLoopFunction(){return this._runLoopFunc}get programBuilder(){return this._programBuilder}setFont(e){ln.setFont(this,e)}drawText(e,t,r,s){ln.drawText(this,e,s,t,r)}setFramebuffer(e,t,r){let s=null,i=!1;if(Array.isArray(e)){const n=e.map((e=>e.texture??e));s=this._pool.createTemporalFramebuffer(!1,n,t,r,!0);for(let t=0;t<e.length;t++){const r=e[t];s.setColorAttachmentMipLevel(t,r.texture?r.miplevel??0:0),s.setColorAttachmentLayer(t,r.texture?r.face??0:0),s.setColorAttachmentCubeFace(t,r.texture?r.layer??0:0)}i=!0}else s=e??null;const n=this.getFramebuffer();n!==s&&(this._temporalFramebuffer&&this._pool.releaseFrameBuffer(n),this._temporalFramebuffer=i,this._setFramebuffer(s))}disposeObject(e,t=!0){e&&(t&&this.removeGPUObject(e),e.disposed||(this.isContextLost()?e.destroy():this._disposeObjectList.push(e)),e.dispatchEvent(null,"disposed"))}async restoreObject(e){e&&e.disposed&&!this.isContextLost()&&(await e.restore(),e.restoreHandler&&await e.restoreHandler(e))}enableGPUTimeRecording(e){e&&!this._gpuTimer?this._gpuTimer=this.createGPUTimer():e||(this._gpuTimer?.end(),this._gpuTimer=null)}beginFrame(){if(0===this._beginFrameCounter){for(const e of this._disposeObjectList)e.destroy();this._disposeObjectList=[]}return this._beginFrameCounter++,this._beginFrameTime=this._cpuTimer.now(),this.updateFrameInfo(),this._pool.autoRelease(),this.onBeginFrame()}endFrame(){this._beginFrameCounter>0&&(this._beginFrameCounter--,0===this._beginFrameCounter&&(this._endFrameTime=this._cpuTimer.now(),this.onEndFrame()))}getVertexAttribFormat(e,t,r){return function(e,t,r){const s=kr(e);for(const e in Pr){const i=Pr[e];if(i[0]===s&&i[3]===t&&i[4]===r)return e}return null}(e,t,r)}createInterleavedVertexBuffer(e,t,r){if(r&&r.usage&&"vertex"!==r.usage)return console.error("createVertexBuffer() failed: options.usage must be 'vertex' or not set"),null;let s=0;for(const t of e)s+=Xr(t);const i=Hr(t.byteLength/s>>0,...e),n=Object.assign({usage:"vertex",dynamic:!1,managed:!0,storage:!1},r||{});return n.storage&&(n.dynamic=!1,n.managed=!1),n.dynamic&&(n.managed=!1),this.createStructuredBuffer(i,n,t)}createVertexBuffer(e,t,r){if(r&&r.usage&&"vertex"!==r.usage)return console.error("createVertexBuffer() failed: options.usage must be 'vertex' or not set"),null;const s=Xr(e),i=Hr(t.byteLength/s>>0,e),n=Object.assign({usage:"vertex",dynamic:!1,managed:!0,storage:!1},r||{});return n.storage&&(n.dynamic=!1,n.managed=!1),n.dynamic&&(n.managed=!1),this.createStructuredBuffer(i,n,t)}draw(e,t,r){this._frameInfo.drawCalls++,this._draw(e,t,r)}drawInstanced(e,t,r,s){this._frameInfo.drawCalls++,this._drawInstanced(e,t,r,s)}compute(e,t,r){this._frameInfo.computeCalls++,this._compute(e,t,r)}runNextFrame(e){e&&this._frameInfo.nextFrameCall.push(e)}exitLoop(){null!==this._runningLoop&&(0!==this._runningLoop?cancelAnimationFrame(this._runningLoop):this.cancelNextFrame(this._runningLoop),this._runningLoop=null)}runLoop(e){if(null!==this._runningLoop)return void console.error("Device.runLoop() can not be nested");if(!e)return void console.error("Device.runLoop() argment error");const t=this;t._runLoopFunc=e,function e(){t._vSync?t._runningLoop=requestAnimationFrame(e):t._runningLoop=t.nextFrame((()=>{null!==t._runningLoop&&e()})),t.beginFrame()&&(t._runLoopFunc(t),t.endFrame())}()}pushDeviceStates(){this._stateStack.push({windowOrderReversed:this.isWindingOrderReversed(),framebuffer:this.getFramebuffer(),viewport:this.getViewport(),scissor:this.getScissor(),program:this.getProgram(),renderStateSet:this.getRenderStates(),vertexLayout:this.getVertexLayout(),bindGroups:[this.getBindGroup(0),this.getBindGroup(1),this.getBindGroup(2),this.getBindGroup(3)]})}popDeviceStates(){if(0===this._stateStack.length)console.error("Device.popDeviceStates(): stack is empty");else{const e=this._stateStack.pop();this.setFramebuffer(e.framebuffer),this.setViewport(e.viewport),this.setScissor(e.scissor),this.setProgram(e.program),this.setRenderStates(e.renderStateSet),this.setVertexLayout(e.vertexLayout),this.setBindGroup(0,...e.bindGroups[0]),this.setBindGroup(1,...e.bindGroups[1]),this.setBindGroup(2,...e.bindGroups[2]),this.setBindGroup(3,...e.bindGroups[3]),this.reverseVertexWindingOrder(e.windowOrderReversed)}}getGPUObjects(){return this._gpuObjectList}getGPUObjectById(e){for(const t of[this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.buffers,this._gpuObjectList.framebuffers,this._gpuObjectList.programs,this._gpuObjectList.vertexArrayObjects])for(const r of t)if(r.uid===e)return r;return null}screenToDevice(e){return this.getFramebuffer()?e:Math.round(e*this.getScale())}deviceToScreen(e){return this.getFramebuffer()?e:Math.round(e/this.getScale())}buildRenderProgram(e){return this._programBuilder.buildRenderProgram(e)}buildComputeProgram(e){return this._programBuilder.buildComputeProgram(e)}addGPUObject(e){const t=this.getGPUObjectList(e);t&&t.indexOf(e)<0&&(t.push(e),this.dispatchEvent(new R(e)))}removeGPUObject(e){const t=this.getGPUObjectList(e);if(t){const r=t.indexOf(e);r>=0&&(t.splice(r,1),this.dispatchEvent(new V(e)))}}updateVideoMemoryCost(e){this._gpuMemCost+=e}_onresize(){this._canvasClientWidth===this._canvas.clientWidth&&this._canvasClientHeight===this._canvas.clientHeight||(this._canvasClientWidth=this._canvas.clientWidth,this._canvasClientHeight=this._canvas.clientHeight,this.dispatchEvent(new M(this._canvasClientWidth,this._canvasClientHeight)))}_registerEventHandlers(){const e=this._canvas,t=this;window.ResizeObserver?new window.ResizeObserver((e=>{t._onresize()})).observe(e,{}):(window.MutationObserver&&new MutationObserver((function(e){e.length>0&&t._onresize()})).observe(e,{attributes:!0,attributeFilter:["style"]}),window.addEventListener("resize",(()=>{this._onresize()})))}updateFrameInfo(){this._frameInfo.frameCounter++,this._frameInfo.drawCalls=0,this._frameInfo.computeCalls=0;const e=this._beginFrameTime;if(0===this._frameInfo.frameTimestamp)this._frameInfo.frameTimestamp=e,this._frameInfo.elapsedTimeCPU=0,this._frameInfo.elapsedTimeGPU=0,this._frameInfo.elapsedFrame=0,this._frameInfo.elapsedOverall=0,this._frameInfo.FPS=0,this._fpsCounter.time=e,this._fpsCounter.frame=this._frameInfo.frameCounter,this._gpuTimer&&this._gpuTimer.begin();else{this._frameInfo.elapsedFrame=e-this._frameInfo.frameTimestamp,this._frameInfo.elapsedOverall+=this._frameInfo.elapsedFrame;let t=0,r=0;0!==this._endFrameTime&&(t=e-this._endFrameTime,r=this._endFrameTime-this._frameInfo.frameTimestamp),this._frameInfo.frameTimestamp=e,e>=this._fpsCounter.time+1e3&&(this._frameInfo.FPS=1e3*(this._frameInfo.frameCounter-this._fpsCounter.frame)/(e-this._fpsCounter.time),this._fpsCounter.time=e,this._fpsCounter.frame=this._frameInfo.frameCounter,this._frameInfo.elapsedTimeGPU=t,this._frameInfo.elapsedTimeCPU=r)}const t=this._frameInfo.nextFrameCall;this._frameInfo.nextFrameCall=this._frameInfo.nextFrameCallNext,this._frameInfo.nextFrameCallNext=t;for(const e of this._frameInfo.nextFrameCallNext)e();this._frameInfo.nextFrameCallNext.length=0}getGPUObjectList(e){let t=null;return e.isTexture()?t=this._gpuObjectList.textures:e.isSampler()?t=this._gpuObjectList.samplers:e.isBuffer()?t=this._gpuObjectList.buffers:e.isFramebuffer()?t=this._gpuObjectList.framebuffers:e.isProgram()?t=this._gpuObjectList.programs:e.isVertexLayout()?t=this._gpuObjectList.vertexArrayObjects:e.isBindGroup()&&(t=this._gpuObjectList.bindGroups),t}invalidateAll(){for(const e of[this._gpuObjectList.buffers,this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.programs,this._gpuObjectList.framebuffers,this._gpuObjectList.vertexArrayObjects,this._gpuObjectList.bindGroups])for(const t of e)this.disposeObject(t,!1);if(this.isContextLost()){for(const e of this._disposeObjectList)e.destroy();this._disposeObjectList=[]}}async reloadAll(){const e=[];for(const t of[this._gpuObjectList.buffers,this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.programs,this._gpuObjectList.framebuffers,this._gpuObjectList.vertexArrayObjects,this._gpuObjectList.bindGroups])for(const r of t.slice())e.push(r.reload());Promise.all(e)}parseTextureOptions(e){return("none"===e?.samplerOptions?.mipFilter?zr.TF_NO_MIPMAP:0)|(e?.writable?zr.TF_WRITABLE:0)|(e?.dynamic?zr.DYNAMIC:0)}parseBufferOptions(e,t){let r;switch(e?.usage||t){case"uniform":r=zr.BF_UNIFORM,e.managed=!1,e.dynamic=e.dynamic??!0;break;case"vertex":r=zr.BF_VERTEX;break;case"index":r=zr.BF_INDEX;break;case"read":r=zr.BF_READ,e.managed=!1;break;case"write":r=zr.BF_WRITE,e.managed=!1;break;default:r=0}const s=e?.storage?zr.BF_STORAGE:0,i=e?.dynamic?zr.DYNAMIC:0;return r|s|i|(0===i&&(e?.managed??1)?zr.MANAGED:0)}}class fn{_cache;_buffer;_size;_uniformMap;_uniformPositions;constructor(e,t){if(this._size=e.byteSize+15&-16,this._size<=0)throw new Error(`UniformBuffer(): invalid uniform buffer byte size: ${this._size}`);this._uniformMap={},this._uniformPositions={},this._cache=t instanceof ArrayBuffer?t:null,this._buffer=t instanceof ArrayBuffer?null:t,this.init(e,0,"")}get byteLength(){return this._size}get buffer(){return this._cache}get uniforms(){return this._uniformMap}set(e,t){if(void 0!==t){const r=this._uniformMap[e];if(r)if(this._cache)if("number"==typeof t)r[0]=t;else if(t?._v)r.set(t._v);else{if("number"!=typeof t?.length)throw new Error("invalid uniform value");r.set(t)}else{const s=this._uniformPositions[e][1];if("number"==typeof t)r[0]=t,this._buffer.bufferSubData(this._uniformPositions[e][0],r);else{if(!(t.BYTES_PER_ELEMENT&&s<=t.byteLength))throw new Error("invalid uniform value");{const r=t;this._buffer.bufferSubData(this._uniformPositions[e][0],r,0,s/r.BYTES_PER_ELEMENT>>0)}}}else{if(Object.getPrototypeOf(t)!==Object.getPrototypeOf({}))throw new Error("invalid uniform value");this.setStruct(e,t)}}}setStruct(e,t){for(const r in t)this.set(`${e}.${r}`,t[r])}init(e,t,r){for(const s of e.entries)if(s.subLayout)t=this.init(s.subLayout,t,`${r}${s.name}.`);else{const e=`${r}${s.name}`;if(this._uniformPositions[e])throw new Error(`UniformBuffer(): duplicate uniform name: ${e}`);if(s.offset<t||s.byteSize<0)throw new Error("UniformBuffer(): invalid layout");this._uniformPositions[e]=[s.offset,s.byteSize];let i=null;switch(s.type){case X.F32:i=Float32Array;break;case X.U32:case X.BOOL:i=Uint32Array;break;case X.I32:i=Int32Array;break;case X.U16:case X.U16_NORM:case X.F16:i=Uint16Array;break;case X.I16:case X.I16_NORM:i=Int16Array;break;case X.U8:case X.U8_NORM:i=Uint8Array;break;case X.I8:case X.I8_NORM:i=Int8Array}if(!i)throw new Error(`UniformBuffer(): invalid data type for uniform: ${e}`);if(s.byteSize%i.BYTES_PER_ELEMENT)throw new Error(`UniformBuffer(): invalid byte size for uniform: ${e}`);this._cache?this._uniformMap[e]=new i(this._cache,s.offset,s.byteSize/i.BYTES_PER_ELEMENT):this._uniformMap[e]=new i(1),t=s.offset+s.byteSize}return t}}let dn=0;class mn extends(t(Object)()){_device;_object;_uid;_cid;_name;_queueState;_restoreHandler;constructor(e){var t;super(),this._device=e,this._object=null,this._uid=++dn,this._cid=1,this._name=`${t=this,t.isTexture2D()?"texture_2d":t.isTexture2DArray()?"texture_2darray":t.isTexture3D()?"texture_3d":t.isTextureCube()?"texture_cube":t.isTextureVideo()?"texture_video":t.isBuffer()?"buffer":t.isFramebuffer()?"framebuffer":t.isProgram()?"program":t.isSampler()?"sampler":t.isVertexLayout()?"vbo":"unknown"}#${this._uid}`,this._queueState=0,this._restoreHandler=null,this._device.addGPUObject(this)}get device(){return this._device}get object(){return this._object}get uid(){return this._uid}get cid(){return this._cid}get disposed(){return!this._object}get restoreHandler(){return this._restoreHandler}set restoreHandler(e){this._restoreHandler=e}get name(){return this._name}set name(e){if(e!==this._name){const t=new G(this,this._name);this._name=e,this._device.dispatchEvent(t)}}get queueState(){return this._queueState}set queueState(e){this._queueState=e}isVertexLayout(){return!1}isFramebuffer(){return!1}isSampler(){return!1}isTexture(){return!1}isTexture2D(){return!1}isTexture2DArray(){return!1}isTexture3D(){return!1}isTextureCube(){return!1}isTextureVideo(){return!1}isProgram(){return!1}isBuffer(){return!1}isBindGroup(){return!1}dispose(){this.disposed||this._device.disposeObject(this,!0)}async reload(){if(this.disposed){const e=this._device.restoreObject(this);return this._cid++,e}}destroy(){throw new Error("Abstract function call: dispose()")}async restore(){throw new Error("Abstract function call: restore()")}}class _n extends mn{static _hashCounter=0;_type;_vs;_fs;_cs;_label;_hash;_error;_bindGroupLayouts;_vertexAttributes;_csModule;_vsModule;_fsModule;_pipelineLayout;constructor(e,t){if(super(e),this._type=t.type,this._label=t.label,this._bindGroupLayouts=[...t.params.bindGroupLayouts],this._error="","render"===t.type){const e=t.params;this._vs=e.vs,this._fs=e.fs,this._vertexAttributes=e.vertexAttributes?e.vertexAttributes.join(":"):""}else{const e=t.params;this._cs=e.source}this._load(),this._hash=String(++_n._hashCounter)}get type(){return this._type}get label(){return this._label}getCompileError(){return this._error}getShaderSource(e){switch(e){case"vertex":return this._vs;case"fragment":return this._fs;case"compute":return this._cs}}getBindingInfo(e){for(let t=0;t<this._bindGroupLayouts.length;t++){const r=this._bindGroupLayouts[t],s=r.nameMap?.[e]??e;for(let e=0;e<r.entries.length;e++){const i=r.entries[e];if(i.name===s)return{group:t,binding:e,type:i.type}}}return null}get bindGroupLayouts(){return this._bindGroupLayouts}get vertexAttributes(){return this._vertexAttributes}get hash(){return this._hash}getPipelineLayout(){return this._pipelineLayout}getShaderModule(){return{vsModule:this._vsModule,fsModule:this._fsModule,csModule:this._csModule,pipelineLayout:this._pipelineLayout}}get fsModule(){return this._fsModule}destroy(){this._vsModule=null,this._fsModule=null,this._pipelineLayout=null,this._object=null}async restore(){this._object||this._load()}isProgram(){return!0}createUniformBuffer(e){const t=this.getBindingInfo(e)?.type;return t?this.device.createStructuredBuffer(t,{usage:"uniform"}):null}_load(){"render"===this._type?(this._vsModule=this.createShaderModule(this._vs),this._fsModule=this.createShaderModule(this._fs)):this._csModule=this.createShaderModule(this._cs),this._pipelineLayout=this.createPipelineLayout(this._bindGroupLayouts),this._object={}}createPipelineLayout(e){const t=[];return e.forEach((e=>{t.push(this._device.fetchBindGroupLayout(e)[1])})),this._device.device.createPipelineLayout({bindGroupLayouts:t})}createShaderModule(e){let t=this._device.device.createShaderModule({code:e});if(t){const r=t.compilationInfo||t.getCompilationInfo;if(!r)return t;r.call(t).then((r=>{let s=!1;if(r?.messages?.length>0){let t="";for(const i of r.messages)"error"===i.type&&(s=!0),t+=`Line ${i.lineNum}:${i.linePos} - ${e.slice(i.offset,i.offset+i.length)}\n`,t+=`${i.message}\n`,"error"===i.type?(s=!0,console.error(t)):"warning"===i.type?console.warn(t):console.log(t),this._error+=t}s&&(t=null)}))}return t}use(){this._device.setProgram(this)}}class gn{_device;_bufferList;_defaultSize;_unmappedBufferList;constructor(e,t=65536){this._device=e,this._bufferList=[],this._defaultSize=t,this._unmappedBufferList=[]}uploadBuffer(e,t,r,s,i,n){const a=i+3&-4,o=this.fetchBufferMapped(a,!!n);if(e){const t=o.mappedRange;new Uint8Array(t,o.offset,a).set(new Uint8Array(e,r,i))}const u={mappedBuffer:{...o},uploadSize:a,uploadBuffer:t,uploadOffset:s};return o.offset+=a,o.offset=o.offset+7&-8,u}beginUploads(){for(let e=this._bufferList.length-1;e>=0;e--){const t=this._bufferList[e];t.used&&(t.buffer.unmap(),this._unmappedBufferList.push(t),this._bufferList.splice(e,1),t.mappedRange=null)}return this._unmappedBufferList.length}endUploads(){for(const e of this._unmappedBufferList)e.buffer.mapAsync(GPUMapMode.WRITE).then((()=>{e.offset=0,e.used=!1,e.mappedRange=e.buffer.getMappedRange(),this._bufferList.push(e)}));this._unmappedBufferList=[]}purge(){for(let e=this._bufferList.length-1;e>=0;e--){const t=this._bufferList[e];t.mappedRange&&(t.buffer.unmap(),t.buffer.destroy())}this._bufferList=[];for(const e of this._unmappedBufferList)e.buffer.destroy();this._unmappedBufferList=[]}fetchBufferMapped(e,t){for(const r of this._bufferList)if(t||r.size-r.offset>=e)return r.used=!0,r;const r=Math.max(e,this._defaultSize)+3&-4,s=this._device.device.createBuffer({label:`StagingRingBuffer${this._bufferList.length}:${r}`,size:r,usage:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,mappedAtCreation:!0});return this._bufferList.push({buffer:s,size:r,offset:0,used:!0,mappedRange:s.getMappedRange()}),this._bufferList[this._bufferList.length-1]}}class xn extends mn{_size;_usage;_gpuUsage;_memCost;_ringBuffer;_pendingUploads;constructor(e,t,r){if(super(e),this._object=null,this._memCost=0,this._usage=t,this._gpuUsage=0,this._size="number"==typeof r?r:r.byteLength,this._size<=0)throw new Error("can not create buffer with zero size");this._ringBuffer=new gn(e,this._size+15&-16),this._pendingUploads=[],this.load("number"==typeof r?null:r)}get hash(){return this._object?this._device.gpuGetObjectHash(this._object):0}get byteLength(){return this._size}get usage(){return this._usage}get gpuUsage(){return this._gpuUsage}searchInsertPosition(e){let t=0,r=this._pendingUploads.length-1,s=this._pendingUploads.length;for(;t<=r;){const i=Math.floor((t+r)/2);this._pendingUploads[i].uploadOffset<e?t=i+1:(s=i,r=i-1)}return s}bufferSubData(e,t,r,s){if(r=Number(r)||0,e=Number(e)||0,r+(s=Number(s)||t.length-r)>t.length)throw new Error("bufferSubData() failed: source buffer is too small");if(e+s*t.BYTES_PER_ELEMENT>this.byteLength)throw new Error("bufferSubData() failed: dest buffer is too small");const i=s*t.BYTES_PER_ELEMENT;if(0!=(3&e)||0!=(3&i))throw new Error("bufferSubData() failed: destination byte offset or upload size must be 4 bytes aligned");const n=t.byteOffset+r*t.BYTES_PER_ELEMENT,a=this.searchInsertPosition(e);if(a<this._pendingUploads.length){const t=this._pendingUploads[a];t.uploadOffset<e+i&&t.uploadOffset+t.uploadSize>e&&this._device.bufferUpload(this)}let o=!1;if(0===this._pendingUploads.length)this.pushUpload(e,i,0),o=!0;else{let t=e,r=e+i;for(;a<this._pendingUploads.length;){const e=this._pendingUploads[a],s=e.uploadOffset,i=s+e.uploadSize;if(!(s<r&&i>t))break;t=Math.min(t,s),r=Math.max(r,i),this._pendingUploads.splice(a,1)}this.pushUpload(t,r-t,a)}new Uint8Array(this._pendingUploads[0].mappedBuffer.mappedRange,e,i).set(new Uint8Array(t.buffer,n,i)),o&&this._device.bufferUpload(this)}async getBufferSubData(e,t,r){if(!(this._usage&zr.BF_READ))throw new Error("getBufferSubData() failed: buffer does not have BF_READ flag set");if(this.sync(),t=Number(t)||0,r=Number(r)||this.byteLength-t,t<0||t+r>this.byteLength)throw new Error("data query range out of bounds");if(e&&e.byteLength<r)throw new Error("no enough space for querying buffer data");e=e||new Uint8Array(r),await this._object.mapAsync(GPUMapMode.READ);const s=this._object.getMappedRange();return e.set(new Uint8Array(s,t,r)),this._object.unmap(),e}async restore(){this._device.isContextLost()||this.load()}destroy(){this._object&&(this._object.destroy(),this._object=null,this._gpuUsage=0,this._memCost=0)}isBuffer(){return!0}beginSyncChanges(e){if(this._pendingUploads.length>0){const t=e||this._device.device.createCommandEncoder();for(const e of this._pendingUploads)t.copyBufferToBuffer(e.mappedBuffer.buffer,e.mappedBuffer.offset,this._object,e.uploadOffset,e.uploadSize);e||this._device.device.queue.submit([t.finish()]),this._pendingUploads.length=0,this._ringBuffer.beginUploads()}}endSyncChanges(){this._usage&zr.DYNAMIC?this._ringBuffer.endUploads():this._ringBuffer.purge()}load(e){if(!this._device.isContextLost()&&(this._memCost=0,!this._device.isContextLost()&&!this._object)){this._gpuUsage=0;let t="";if(this._usage&zr.BF_VERTEX&&(this._gpuUsage|=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,t+="[vertex]"),this._usage&zr.BF_INDEX&&(this._gpuUsage|=GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,t+="[index]"),this._usage&zr.BF_UNIFORM&&(this._gpuUsage|=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC,t+="[uniform]"),this._usage&zr.BF_STORAGE&&(this._gpuUsage|=GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC,t+="[storage]"),this._usage&zr.BF_READ&&(this._gpuUsage|=GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ,t+="[mapRead]"),this._usage&zr.BF_WRITE&&(this._gpuUsage|=GPUBufferUsage.COPY_SRC|GPUBufferUsage.MAP_WRITE,t+="[mapWrite]"),e){this._object=this._device.gpuCreateBuffer({label:t,size:e.byteLength+15&-16,usage:this._gpuUsage,mappedAtCreation:!0});const r=this._object.getMappedRange();new e.constructor(r).set(e),this._object.unmap()}else this._object=this._device.gpuCreateBuffer({label:t,size:this.byteLength+15&-16,usage:this._gpuUsage});const r=this.byteLength;this._device.updateVideoMemoryCost(r-this._memCost),this._memCost=r}}sync(){this._pendingUploads&&this._device.flushUploads()}pushUpload(e,t,r){const s=this._ringBuffer.fetchBufferMapped(t,!0);this._pendingUploads.splice(r,0,{mappedBuffer:{buffer:s.buffer,size:s.size,offset:e,used:s.used,mappedRange:s.mappedRange},uploadSize:t,uploadOffset:e,uploadBuffer:this._object})}}const yn=ue.getCachedTypeInfo(X.U8VEC2_NORM),bn=ue.getCachedTypeInfo(X.U8VEC4_NORM),Tn=ue.getCachedTypeInfo(X.I8VEC2_NORM),wn=ue.getCachedTypeInfo(X.I8VEC4_NORM),vn=ue.getCachedTypeInfo(X.U16VEC2),En=ue.getCachedTypeInfo(X.U16VEC4),Cn=ue.getCachedTypeInfo(X.I16VEC2),Sn=ue.getCachedTypeInfo(X.I16VEC4),$n=ue.getCachedTypeInfo(X.U16VEC2_NORM),An=ue.getCachedTypeInfo(X.U16VEC4_NORM),Ln=ue.getCachedTypeInfo(X.I16VEC2_NORM),In=ue.getCachedTypeInfo(X.I16VEC4_NORM),Bn=ue.getCachedTypeInfo(X.F16VEC2),Dn=ue.getCachedTypeInfo(X.F16VEC4),On=ue.getCachedTypeInfo(X.F32),Fn=ue.getCachedTypeInfo(X.F32VEC2),Mn=ue.getCachedTypeInfo(X.F32VEC3),Rn=ue.getCachedTypeInfo(X.F32VEC4),Vn=ue.getCachedTypeInfo(X.U32),Gn=ue.getCachedTypeInfo(X.U32VEC2),Pn=ue.getCachedTypeInfo(X.U32VEC3),Nn=ue.getCachedTypeInfo(X.U32VEC4),Un=ue.getCachedTypeInfo(X.I32),zn=ue.getCachedTypeInfo(X.I32VEC2),kn=ue.getCachedTypeInfo(X.I32VEC3),Wn=ue.getCachedTypeInfo(X.I32VEC4),Xn={[yn.typeId]:"unorm8x2",[bn.typeId]:"unorm8x4",[Tn.typeId]:"snorm8x2",[wn.typeId]:"snorm8x4",[vn.typeId]:"uint16x2",[En.typeId]:"uint16x4",[Cn.typeId]:"sint16x2",[Sn.typeId]:"sint16x4",[$n.typeId]:"unorm16x2",[An.typeId]:"unorm16x4",[Ln.typeId]:"snorm16x2",[In.typeId]:"snorm16x4",[Bn.typeId]:"float16x2",[Dn.typeId]:"float16x4",[On.typeId]:"float32",[Fn.typeId]:"float32x2",[Mn.typeId]:"float32x3",[Rn.typeId]:"float32x4",[Vn.typeId]:"uint32",[Gn.typeId]:"uint32x2",[Pn.typeId]:"uint32x3",[Nn.typeId]:"uint32x4",[Un.typeId]:"sint32",[zn.typeId]:"sint32x2",[kn.typeId]:"sint32x3",[Wn.typeId]:"sint32x4"};class Yn extends xn{_structure;_data;constructor(e,t,r,s){if(!t?.isStructType())throw new Error("invalid structure type");if(r&zr.BF_INDEX)throw new Error("structured buffer must not have Index usage flag");if(r&zr.BF_READ||r&zr.BF_WRITE)throw new Error("structured buffer must not have Read or Write usage flags");if(r&zr.BF_VERTEX&&(1!==t.structMembers.length||!t.structMembers[0].type.isArrayType()))throw new Error("structured buffer for vertex usage must have only one array member");(r&zr.BF_UNIFORM||r&zr.BF_STORAGE)&&(r|=zr.DYNAMIC);const i=t.toBufferLayout(0,t.layout);if(s&&i.byteSize!==s.byteLength)throw new Error(`create structured buffer failed: invalid source size: ${s.byteLength}, should be ${i.byteSize}`);super(e,r,s||i.byteSize),this._data=new fn(i,this),this._structure=t}set(e,t){this._data.set(e,t)}get structure(){return this._structure}set structure(e){if(e&&!e.isCompatibleType(this._structure)){const t=e.toBufferLayout(0,e.layout);if(t.byteSize>this.byteLength)throw new Error(`set structure type failed: new structure type is too large: ${t.byteSize}`);this._data=new fn(t,this),this._structure=e}}static getGPUVertexFormat(e){return Xn[e.typeId]}}class jn extends mn{_layout;_layoutDesc;_entries;_bindGroup;_buffers;_textures;_gpuId;_videoTextures;_dynamicOffsets;_resources;constructor(e,t){super(e),this._device=e,this._layout=t,this._layoutDesc=null,this._entries=null,this._bindGroup=null,this._dynamicOffsets=null,this._gpuId=0,this._resources={},this._buffers=[],this._textures=[],this._videoTextures=null;for(const e of this._layout.entries)e.buffer&&e.buffer.hasDynamicOffset&&(this._dynamicOffsets||(this._dynamicOffsets=[]),this._dynamicOffsets[e.buffer.dynamicOffsetIndex]=0)}get bindGroup(){return this._bindGroup||(this._bindGroup=this._create()),this._bindGroup}get layoutDescriptor(){return this._bindGroup||(this._bindGroup=this._create()),this._layoutDesc}get entries(){return this._bindGroup||(this._bindGroup=this._create()),this._entries}getGPUId(){return`${this._uid}:${this._gpuId}`}get bufferList(){return this._buffers}get textureList(){return this._textures}invalidate(){this._bindGroup=null,this._gpuId++}getLayout(){return this._layout}getDynamicOffsets(){return this._dynamicOffsets}getBuffer(e){return this._getBuffer(e,zr.BF_UNIFORM|zr.BF_STORAGE,!0)}setBuffer(e,t,r,s,i){const n=this._layout.nameMap?.[e]??e;for(const a of this._layout.entries)if(a.name===n){if(a.buffer){s=s??0,i=i??(t?Math.max(0,t.byteLength-s):0);const n=this._resources[a.name],o="uniform"===a.buffer.type?zr.BF_UNIFORM:zr.BF_STORAGE;t&&t.usage&o?t===n?.[0]&&s===n?.[1]&&i===n?.[2]||(this._resources[a.name]=[t,s,i],this.invalidate()):console.log(`setBuffer() failed: buffer resource '${e}' must be type '${a.buffer.type}'`),a.buffer.hasDynamicOffset&&(this._dynamicOffsets[a.buffer.dynamicOffsetIndex]=r??0)}else console.log(`setBuffer() failed: resource '${e}' is not buffer`);return}console.log(`setBuffer() failed: no buffer resource named '${e}'`)}setValue(e,t){const r=this._layout.nameMap?.[e];if(r)this.setValue(r,{[e]:t});else{const r=this._getBuffer(e,zr.BF_UNIFORM|zr.BF_STORAGE,!1);if(r){if(!(r instanceof Yn))throw new Error(`BindGroup.setValue() failed: '${e}' is not structured buffer`);if(t?.BYTES_PER_ELEMENT)r.bufferSubData(0,t);else for(const e in t)r.set(e,t[e])}else console.log(`setValue() failed: no uniform buffer named '${e}'`)}}setRawData(e,t,r,s,i){const n=this._layout.nameMap?.[e];if(n)this.setRawData(n,t,r,s,i);else{const n=this._getBuffer(e,zr.BF_UNIFORM|zr.BF_STORAGE,!1);n?n.bufferSubData(t,r,s,i):console.log(`set(): no uniform buffer named '${e}'`)}}getTexture(e){if(this._findTextureLayout(e)){const t=this._resources[e];return t?t[0]:null}throw new Error(`getTexture() failed:${e} is not a texture`)}setTextureView(e,t,r,s,i,n){if(!t)throw new Error(`WebGPUBindGroup.setTextureView() failed: invalid texture uniform value: ${t}`);{const a=this._findTextureLayout(e);if(!a)throw new Error(`WebGPUBindGroup.setView() failed: no texture uniform named '${e}'`);{if(a.externalTexture)throw new Error("WebGPUBindGroup.setTextureView() failed: video texture does not have view");if(t.isTextureVideo())throw new Error("WebGPUBindGroup.setTextureView() failed: invalid texture type");const o=this._resources[e],u=t.getView(r,s,i);if(o&&o[1]===u||(this._resources[e]=[t,u],this.invalidate()),a.texture?.autoBindSampler){const e=this._findSamplerLayout(a.texture.autoBindSampler);if(!e||!e.sampler)throw new Error(`WebGPUBindGroup.setTextureView() failed: sampler entry not found: ${a.texture.autoBindSampler}`);const r=!n||n.compare?t.getDefaultSampler(!1):n;r.object!==this._resources[a.texture.autoBindSampler]&&(this._resources[a.texture.autoBindSampler]=r.object,this.invalidate())}if(a.texture?.autoBindSamplerComparison){const e=this._findSamplerLayout(a.texture.autoBindSamplerComparison);if(!e||!e.sampler)throw new Error(`WebGPUBindGroup.setTextureView() failed: sampler entry not found: ${a.texture.autoBindSamplerComparison}`);const r=n&&n.compare?n:t.getDefaultSampler(!0);r.object!==this._resources[a.texture.autoBindSamplerComparison]&&(this._resources[a.texture.autoBindSamplerComparison]=r.object,this.invalidate())}}}}setTexture(e,t,r){if(!t)throw new Error(`WebGPUBindGroup.setTexture() failed: invalid texture uniform value: ${t}`);{const s=this._findTextureLayout(e);if(!s)throw new Error(`WebGPUBindGroup.setTexture() failed: no texture uniform named '${e}'`);{const i=this._resources[e];if(s.externalTexture){if(!t.isTextureVideo())throw new Error(`WebGPUBindGroup.setTexture() failed: invalid texture type of resource '${e}'`);if(!i||i!==t){i&&i.removeBindGroupReference(this),t&&t.addBindGroupReference(this),this._resources[e]=t,this.invalidate(),this._videoTextures=[];for(const e of this._layout.entries)if(e.externalTexture){const t=this._resources[e.name];t&&this._videoTextures.indexOf(t)<0&&this._videoTextures.push(t)}}}else{if(t.isTextureVideo())throw new Error(`WebGPUBindGroup.setTexture() failed: invalid texture type of resource '${e}'`);const r=t.getDefaultView();if(!s.externalTexture&&!r)throw new Error("WebGPUBindGroup.setTexture() failed: create texture view failed");i&&i[0]===t||(this._resources[e]=[t,r],this.invalidate())}const n=s.texture?.autoBindSampler||s.externalTexture?.autoBindSampler;if(n){const e=this._findSamplerLayout(n);if(!e||!e.sampler)throw new Error(`WebGPUBindGroup.setTexture() failed: sampler entry not found: ${n}`);const s=!r||r.compare?t.getDefaultSampler(!1):r;s.object!==this._resources[n]&&(this._resources[n]=s.object,this.invalidate())}const a=s.texture?.autoBindSamplerComparison;if(a){const e=this._findSamplerLayout(a);if(!e||!e.sampler)throw new Error(`WebGPUBindGroup.setTexture() failed: sampler entry not found: ${a}`);const s=r&&r.compare?r:t.getDefaultSampler(!0);s.object!==this._resources[a]&&(this._resources[a]=s.object,this.invalidate())}}}}setSampler(e,t){const r=t?.object;r?this._resources[e]!==r&&(this._findSamplerLayout(e)?(this._resources[e]=r,this.invalidate()):console.log(`WebGPUBindGroup.setSampler() failed: no sampler uniform named '${e}'`)):console.log(`WebGPUBindGroup.setSampler() failed: invalid sampler uniform value: ${t}`)}destroy(){this.invalidate(),this._resources={},this._buffers=[],this._textures=[],this._videoTextures=null,this._object=null}async restore(){this.invalidate(),this._object={}}isBindGroup(){return!0}updateVideoTextures(){this._videoTextures?.forEach((e=>{e.updateVideoFrame()&&this.invalidate()}))}_findTextureLayout(e){for(const t of this._layout.entries)if((t.texture||t.storageTexture||t.externalTexture)&&t.name===e)return t;return null}_findSamplerLayout(e){for(const t of this._layout.entries)if(t.sampler&&t.name===e)return t;return null}_getBuffer(e,t,r=!1){const s=this._getBufferInfo(e,t,r);return s?.[0]??null}_getBufferInfo(e,t,r=!1){const s=this._layout.nameMap?.[e]??e;for(const e of this._layout.entries)if(e.buffer&&e.name===s){const s="uniform"===e.buffer.type?zr.BF_UNIFORM:zr.BF_STORAGE;if(!(t&s))return null;let i=this._resources[e.name];if(!(i&&i[0]||r)){const t={usage:s===zr.BF_UNIFORM?"uniform":null,storage:s===zr.BF_STORAGE,dynamic:!0},r=this._device.createStructuredBuffer(e.type,t);i=[r,0,r.byteLength],this._resources[e.name]=i}return i}return null}_create(){let e=null;this._layoutDesc=null,this._entries=null,this._textures=[],this._buffers=[];const t=[];let r=!0;for(const e of this._layout.entries){const s={binding:e.binding};if(e.buffer){const t=this._getBufferInfo(e.name,"uniform"===e.buffer.type?zr.BF_UNIFORM:zr.BF_STORAGE,!0);if(!t)throw new Error(`Uniform buffer '${e.name}' not exists, maybe you forgot settings some uniform values`);this._buffers.indexOf(t[0])<0&&this._buffers.push(t[0]),s.resource={buffer:t[0].object,offset:t[1],size:t[2]},r=r&&!!t[0].object}else if(e.texture||e.storageTexture){const t=this._resources[e.name];t?(this._textures.indexOf(t[0])<0&&this._textures.push(t[0]),s.resource=t[1],r=r&&!!t[1]):(console.error(`Missing texture in bind group: ${e.name}`),r=!1)}else if(e.externalTexture){const t=this._resources[e.name];s.resource=t.object,r=r&&!!t.object}else if(e.sampler){const t=this._resources[e.name];s.resource=t,r=r&&!!t}t.push(s)}if(!r)return null;const[s,i]=this._device.fetchBindGroupLayout(this._layout),n={layout:i,entries:t};return i.label&&(n.label=`${i.label}.bindgroup`),e=this._device.gpuCreateBindGroup(n),e||console.log("Create bindgroup failed"),this._layoutDesc=s,this._entries=t,e}}const Hn={repeat:"repeat","mirrored-repeat":"mirror-repeat",clamp:"clamp-to-edge"},qn={nearest:"nearest",linear:"linear",none:void 0},Zn={always:"always",le:"less-equal",ge:"greater-equal",lt:"less",gt:"greater",eq:"equal",ne:"not-equal",never:"never"},Qn={keep:"keep",replace:"replace",zero:"zero",invert:"invert",incr:"increment-clamp",decr:"decrement-clamp","incr-wrap":"increment-wrap","decr-wrap":"decrement-wrap"},Kn={"triangle-list":"triangle-list","triangle-strip":"triangle-strip","triangle-fan":null,"line-list":"line-list","line-strip":"line-strip","point-list":"point-list"},Jn={back:"back",front:"front",none:"none"},ea={add:"add",subtract:"subtract","reverse-subtract":"reverse-subtract",min:"min",max:"max"},ta={"const-color":"constant","const-alpha":"constant","dst-color":"dst","dst-alpha":"dst-alpha","inv-const-color":"one-minus-constant","inv-const-alpha":"one-minus-constant","inv-dst-color":"one-minus-dst","inv-dst-alpha":"one-minus-dst-alpha","src-color":"src","src-alpha":"src-alpha","inv-src-color":"one-minus-src","inv-src-alpha":"one-minus-src-alpha","src-alpha-saturate":"src-alpha-saturated",one:"one",zero:"zero"},ra={float32:"0",float32x2:"1",float32x3:"2",float32x4:"3",uint32:"4",uint32x2:"5",uint32x3:"6",uint32x4:"7",sint32:"8",sint32x2:"9",sint32x3:"a",sint32x4:"b",uint16x2:"c",uint16x4:"d",unorm16x2:"e",unorm16x4:"f",sint16x2:"g",sint16x4:"h",snorm16x2:"i",snorm16x4:"j",uint8x2:"k",uint8x4:"l",unorm8x2:"m",unorm8x4:"n",sint8x2:"o",sint8x4:"p",snorm8x2:"q",snorm8x4:"r"},sa={unknown:null,rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",bgra8unorm:"bgra8unorm",dxt1:"bc1-rgba-unorm",dxt3:"bc2-rgba-unorm",dxt5:"bc3-rgba-unorm","dxt1-srgb":"bc1-rgba-unorm-srgb","dxt3-srgb":"bc2-rgba-unorm-srgb","dxt5-srgb":"bc3-rgba-unorm-srgb",bc4:"bc4-r-unorm","bc4-signed":"bc4-r-snorm",bc5:"bc5-rg-unorm","bc5-signed":"bc5-rg-snorm",bc6h:"bc6h-rgb-ufloat","bc6h-signed":"bc6h-rgb-float",bc7:"bc7-rgba-unorm","bc7-srgb":"bc7-rgba-unorm-srgb","astc-4x4":"astc-4x4-unorm","astc-4x4-srgb":"astc-4x4-unorm-srgb","astc-5x4":"astc-5x4-unorm","astc-5x4-srgb":"astc-5x4-unorm-srgb","astc-5x5":"astc-5x5-unorm","astc-5x5-srgb":"astc-5x5-unorm-srgb","astc-6x5":"astc-6x5-unorm","astc-6x5-srgb":"astc-6x5-unorm-srgb","astc-6x6":"astc-6x6-unorm","astc-6x6-srgb":"astc-6x6-unorm-srgb","astc-8x5":"astc-8x5-unorm","astc-8x5-srgb":"astc-8x5-unorm-srgb","astc-8x6":"astc-8x6-unorm","astc-8x6-srgb":"astc-8x6-unorm-srgb","astc-8x8":"astc-8x8-unorm","astc-8x8-srgb":"astc-8x8-unorm-srgb","astc-10x5":"astc-10x5-unorm","astc-10x5-srgb":"astc-10x5-unorm-srgb","astc-10x6":"astc-10x6-unorm","astc-10x6-srgb":"astc-10x6-unorm-srgb","astc-10x8":"astc-10x8-unorm","astc-10x8-srgb":"astc-10x8-unorm-srgb","astc-10x10":"astc-10x10-unorm","astc-10x10-srgb":"astc-10x10-unorm-srgb","astc-12x10":"astc-12x10-unorm","astc-12x10-srgb":"astc-12x10-unorm-srgb","astc-12x12":"astc-12x12-unorm","astc-12x12-srgb":"astc-12x12-unorm-srgb",r8unorm:"r8unorm",r8snorm:"r8snorm",r16f:"r16float",r32f:"r32float",r8ui:"r8uint",r8i:"r8sint",r16ui:"r16uint",r16i:"r16sint",r32ui:"r32uint",r32i:"r32sint",rg8unorm:"rg8unorm",rg8snorm:"rg8snorm",rg16f:"rg16float",rg32f:"rg32float",rg8ui:"rg8uint",rg8i:"rg8sint",rg16ui:"rg16uint",rg16i:"rg16sint",rg32ui:"rg32uint",rg32i:"rg32sint","rgba8unorm-srgb":"rgba8unorm-srgb","bgra8unorm-srgb":"bgra8unorm-srgb",rgba16f:"rgba16float",rgba32f:"rgba32float",rgba8ui:"rgba8uint",rgba8i:"rgba8sint",rgba16ui:"rgba16uint",rgba16i:"rgba16sint",rgba32ui:"rgba32uint",rgba32i:"rgba32sint",rg11b10uf:"rg11b10ufloat",d16:"depth16unorm",d24:"depth24plus",d32f:"depth32float",d32fs8:"depth32float-stencil8",d24s8:"depth24plus-stencil8"};function ia(e,t){const r={},s=e.length;for(let i=0;i<s;i++)r[e[i]]=t[i];return r}const na=ia(Object.values(sa),Object.keys(sa)),aa=ia(Object.values(ra),Object.keys(ra));class oa extends mn{_target;_hash;_memCost;_views;_defaultView;_mipmapDirty;_flags;_width;_height;_depth;_format;_renderable;_fb;_gpuFormat;_mipLevelCount;_samplerOptions;_ringBuffer;_pendingUploads;constructor(e,t){super(e),this._target=t,this._flags=0,this._width=0,this._height=0,this._depth=0,this._renderable=!1,this._fb=!1,this._format="unknown",this._gpuFormat=null,this._mipLevelCount=0,this._samplerOptions=null,this._memCost=0,this._mipmapDirty=!1,this._views=[],this._defaultView=null,this._ringBuffer=new gn(e),this._pendingUploads=[]}get hash(){return this._object?this._device.gpuGetObjectHash(this._object):0}get target(){return this._target}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get memCost(){return this._memCost}get format(){return this._format}get mipLevelCount(){return this._mipLevelCount}get gpuFormat(){return this._gpuFormat}get samplerOptions(){return this._samplerOptions}set samplerOptions(e){const t=this.getTextureCaps().getTextureFormatInfo(this._format);this._samplerOptions=e?Object.assign({},this._getSamplerOptions(t,!!e.compare),e):null}isTexture(){return!0}isFilterable(){return!!this.getTextureCaps().getTextureFormatInfo(this._format)?.filterable}clearPendingUploads(){this._pendingUploads.length>0&&(this._pendingUploads=[],this.beginSyncChanges(null),this.endSyncChanges())}isMipmapDirty(){return this._mipmapDirty}setMipmapDirty(e){this._mipmapDirty=e}destroy(){this._object&&(this.isTextureVideo()||this._object.destroy(),this._object=null,this._device.updateVideoMemoryCost(-this._memCost),this._memCost=0)}async restore(){this._object||this._device.isContextLost()||this.init()}getTextureCaps(){return this._device.getDeviceCaps().textureCaps}isSRGBFormat(){return e=this._format,!!(512&C[e]);var e}isFloatFormat(){return e=this._format,!!(64&C[e]);var e}isIntegerFormat(){return L(this._format)}isSignedFormat(){return I(this._format)}isCompressedFormat(){return e=this._format,!!(520093696&C[e]);var e}isDepth(){return $(this._format)}isRenderable(){return this._renderable}getView(e,t,r){return e=Number(e)||0,t=Number(t)||0,r=Number(r)||0,this._views[t]||(this._views[t]=[]),this._views[t][e]||(this._views[t][e]=[]),this._views[t][e][r]||(this._views[t][e][r]=this.createView(e,t,r)),this._views[t][e][r]}getDefaultView(){return this._defaultView||!this._object||this.isTextureVideo()||(this._defaultView=this._device.gpuCreateTextureView(this._object,{dimension:this.isTextureCube()?"cube":this.isTexture3D()?"3d":this.isTexture2DArray()?"2d-array":"2d",arrayLayerCount:this.isTextureCube()?6:this.isTexture2DArray()?this._depth:1,aspect:$(this.format)?"depth-only":"all"})),this._defaultView}copyPixelDataToBuffer(e,t,r,s,i,n,a){if(this.isTextureVideo())throw new Error("copyPixelDataToBuffer() failed: can not copy pixel data of video texture");this.sync(),oa.copyTexturePixelsToBuffer(this._device.device,this.object,this.width,this.height,this.format,e,t,r,s,i,n,a)}generateMipmaps(){this._mipmapDirty=!0,this._device.textureUpload(this)}beginSyncChanges(e){if(!this.isTextureVideo()&&this._pendingUploads.length>0&&this._object){const t=e||this._device.device.createCommandEncoder();for(const e of this._pendingUploads)if(e.mappedBuffer){const r=e;t.copyBufferToTexture({buffer:r.mappedBuffer.buffer,offset:r.mappedBuffer.offset,bytesPerRow:r.bufferStride,rowsPerImage:r.uploadHeight},{texture:this._object,origin:{x:r.uploadOffsetX,y:r.uploadOffsetY,z:r.uploadOffsetZ},mipLevel:r.mipLevel},{width:r.uploadWidth,height:r.uploadHeight,depthOrArrayLayers:r.uploadDepth})}else if(e.image){const t=e,r={texture:this._object,origin:{x:t.offsetX,y:t.offsetY,z:t.offsetZ},mipLevel:t.mipLevel,premultipliedAlpha:!1};this._device.device.queue.copyExternalImageToTexture({source:t.image,origin:{x:t.srcX,y:t.srcY}},r,{width:t.width,height:t.height,depthOrArrayLayers:t.depth})}this._pendingUploads.length=0,e||this._device.device.queue.submit([t.finish()]),this._ringBuffer.beginUploads()}}endSyncChanges(){this._flags&zr.DYNAMIC?this._ringBuffer.endUploads():this._ringBuffer.purge()}getDefaultSampler(e){const t=this.getTextureCaps().getTextureFormatInfo(this._format);return this._device.createSampler(this._samplerOptions&&!this._samplerOptions.compare==!e?this._samplerOptions:this._getSamplerOptions(t,e))}sync(){this._device.flush()}_calcMipLevelCount(e,t,r,s){if($(e)||this.isTexture3D()||this.isTextureVideo())return 1;if(this._flags&zr.TF_NO_MIPMAP)return 1;const i=this.getTextureCaps().getTextureFormatInfo(e);return i&&i.renderable?Math.floor(Math.log2(Math.max(t,r)))+1:1}allocInternal(e,t,r,s,i){if(!this.isTextureVideo()){if(0===i)i=this._calcMipLevelCount(e,t,r,s);else if(1!==i){let e=Math.max(t,r);this.isTexture3D()&&(e=Math.max(e,s));const n=Math.floor(Math.log2(e))+1;(!Number.isInteger(i)||i<0||i>n)&&(i=n)}if(this._object&&(this._format!==e||this._width!==t||this._height!==r||this._depth,this._mipLevelCount!==i)){const e=this._object;this._device.runNextFrame((()=>{e.destroy()})),this._object=null}if(!this._object&&(this._format=e,this._width=t,this._height=r,this._depth=s,this._mipLevelCount=i,!this._device.isContextLost())){this._gpuFormat=sa[this._format];const e=this.getTextureCaps().getTextureFormatInfo(this._format);this._renderable=e.renderable&&!(this._flags&zr.TF_WRITABLE),this._object=this._device.gpuCreateTexture({size:{width:this._width,height:this._height,depthOrArrayLayers:this.isTextureCube()?6:this._depth},format:this._gpuFormat,mipLevelCount:this._mipLevelCount,sampleCount:1,dimension:this.isTexture3D()?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(this._renderable&&!this.isTexture3D()?GPUTextureUsage.RENDER_ATTACHMENT:0)|(this._flags&zr.TF_WRITABLE?GPUTextureUsage.STORAGE_BINDING:0)});const t=this.getTextureCaps().calcMemoryUsage(this._format,this._width*this._height*(this.isTextureCube()?6:this._depth));this._device.updateVideoMemoryCost(t-this._memCost),this._memCost=t}}}static copyTexturePixelsToBuffer(e,t,r,s,i,n,a,o,u,h,l,c){if(!(c.gpuUsage&GPUBufferUsage.COPY_DST))throw new Error("copyTexturePixelsToBuffer() failed: destination buffer does not have COPY_DST usage set");const p=D(i),f=s/O(i),d=r/p*B(i),m=d+255&-256,_=f*d,g=f*m;if(c.byteLength<_)throw new Error(`copyTexturePixelsToBuffer() failed: destination buffer size is ${c.byteLength}, should be at least ${_}`);const x=e.createBuffer({size:g,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),y=e.createCommandEncoder();if(y.copyTextureToBuffer({texture:t,mipLevel:l??0,origin:{x:n,y:a,z:h??0}},{buffer:x,offset:0,bytesPerRow:m},{width:o,height:u,depthOrArrayLayers:1}),_!==g)for(let e=0;e<f;e++)y.copyBufferToBuffer(x,e*m,c.object,e*d,d);else y.copyBufferToBuffer(x,0,c.object,0,_);e.queue.submit([y.finish()]),x.destroy()}uploadRaw(e,t,r,s,i,n,a,o){if(this.isTextureVideo())return void console.error("BaseTexture.uploadRaw(): Cannot upload to video texture");const u=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),h=this.getTextureCaps().getTextureFormatInfo(this._format),l=h.blockWidth||1,c=h.blockHeight||1,p=Math.ceil(t/l),f=Math.ceil(r/c),d=p*h.size;if(d*f*s!==u.byteLength)throw new Error(`WebGPUTexture.update() invalid data size: ${u.byteLength}`);if(this._device.isTextureUploading(this)){const e=d+255&-256,t=e*f*s,r=this._ringBuffer.uploadBuffer(null,null,0,0,t),h=r.mappedBuffer.mappedRange,m=new Uint8Array(u),_=new Uint8Array(h,r.mappedBuffer.offset,t);if(t===u.byteLength)_.set(new Uint8Array(u));else for(let t=0;t<s;t++){const r=t*d*p,s=t*e*f;for(let t=0;t<f;t++)_.set(m.subarray(r+t*d,r+(t+1)*d),s+t*e)}this._pendingUploads.push({mappedBuffer:r.mappedBuffer,uploadOffsetX:i,uploadOffsetY:n,uploadOffsetZ:a,uploadWidth:l*p,uploadHeight:c*f,uploadDepth:s,bufferStride:e,mipLevel:o}),this._device.textureUpload(this)}else{this.clearPendingUploads();const e={texture:this._object,mipLevel:o,origin:{x:i,y:n,z:a}},t={bytesPerRow:d,rowsPerImage:c*f},r={width:l*p,height:c*f,depthOrArrayLayers:s};this._device.device.queue.writeTexture(e,u,t,r)}}uploadImageData(e,t,r,s,i,n,a,o,u){this.isTextureVideo()?console.error("BaseTexture.uploadImageData(): Cannot upload to video texture"):(this._pendingUploads.push({image:e,offsetX:n,offsetY:a,offsetZ:u??0,srcX:t??0,srcY:r??0,srcZ:0,width:s,height:i,depth:1,mipLevel:o??0}),this._device.textureUpload(this))}_getSamplerOptions(e,t){const r=this.isDepth()&&t,s=e.filterable||r;return{addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:s?"linear":"nearest",minFilter:e.filterable?"linear":"nearest",mipFilter:this._mipLevelCount>1?s?"linear":"nearest":"none",compare:r?"lt":null}}_markAsCurrentFB(e){this._fb=e}_isMarkedAsCurrentFB(){return this._fb}}class ua extends oa{constructor(e){super(e,"2d")}isTexture2D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._mipLevelCount)}update(e,t,r,s,i){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),this.uploadRaw(e,s,i,1,t,r,0,0),this._mipLevelCount>1&&this.generateMipmaps())}updateFromElement(e,t,r,s,i,n,a){if(!this._device.isContextLost())if(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),e instanceof HTMLCanvasElement||this._device.isTextureUploading(this)){const o=document.createElement("canvas");o.width=n,o.height=a;const u=o.getContext("2d");u.drawImage(e,s,i,n,a,0,0,n,a);const h=u.getImageData(0,0,n,a);this.update(h.data,t,r,n,a),o.width=0,o.height=0}else this.uploadImageData(e,s,i,n,a,t,r,0,0)}async readPixels(e,t,r,s,i,n,a){if(0!==i)throw new Error("Texture2D.readPixels(): parameter faceOrLayer must be 0");if(n>=this.mipLevelCount||n<0)throw new Error(`Texture2D.readPixels(): invalid miplevel: ${n}`);const o=D(this.format),u=O(this.format),h=B(this.format),l=Math.ceil(r/o)*Math.ceil(s/u)*h;if(a.byteLength<l)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${a.byteLength}, should be at least ${l}`);const c=this._device.createBuffer(l,{usage:"read"});await this.copyPixelDataToBuffer(e,t,r,s,0,n,c),await c.getBufferSubData(new Uint8Array(a.buffer,a.byteOffset,a.byteLength),0,l),c.dispose()}readPixelsToBuffer(e,t,r,s,i,n,a){if(0!==i)throw new Error("Texture2D.readPixels(): parameter faceOrLayer must be 0");if(n>=this.mipLevelCount||n<0)throw new Error(`Texture2D.readPixels(): invalid miplevel: ${n}`);this.copyPixelDataToBuffer(e,t,r,s,0,n,a)}loadFromElement(e,t,r){this._flags=Number(r)||0;const s=t?"rgba8unorm-srgb":"rgba8unorm";this.loadImage(e,s)}createEmpty(e,t,r,s){this._flags=Number(s)||0,this.loadEmpty(e,t,r,0)}createView(e,t,r){return this._object?this._device.gpuCreateTextureView(this._object,{dimension:"2d",baseMipLevel:e??0,mipLevelCount:r||this._mipLevelCount-(e??0),baseArrayLayer:0,arrayLayerCount:1}):null}createWithMipmapData(e,t,r){e.isCubemap||e.isVolume?console.error("loading 2d texture with mipmap data failed: data is not 2d texture"):(this._flags=Number(r)||0,this._flags&zr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadLevels(e,t))}loadEmpty(e,t,r,s){this.allocInternal(e,t,r,1,s),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(e,t){let r=t?S(e.format):e.format,s=!1;"bgra8unorm"===r?(r="rgba8unorm",s=!0):"bgra8unorm-srgb"===this._format&&(r="rgba8unorm-srgb",s=!0);const i=e.width,n=e.height,a=e.mipLevels;if(!e.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(r,i,n,1,a),!this._device.isContextLost())for(let t=0;t<e.mipDatas[0].length;t++){if(s)for(let r=0;r<e.mipDatas[0][t].width*e.mipDatas[0][t].height;r++){const s=e.mipDatas[0][t].data[4*r];e.mipDatas[0][t].data[4*r]=e.mipDatas[0][t].data[4*r+2],e.mipDatas[0][t].data[4*r+2]=s}this.uploadRaw(e.mipDatas[0][t].data,e.mipDatas[0][t].width,e.mipDatas[0][t].height,1,0,0,0,t)}}else console.error("No s3tc compression format support")}loadImage(e,t){this.allocInternal(t,Number(e.width),Number(e.height),1,0),this._device.isContextLost()||(this.updateFromElement(e,0,0,0,0,this._width,this._height),this._mipLevelCount>1&&this.generateMipmaps())}}class ha extends oa{constructor(e){super(e,"2darray")}isTexture2DArray(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(e,t,r,s,i,n,a){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount),this.uploadRaw(e,i,n,a,t,r,s,0),this._mipLevelCount>1&&this.generateMipmaps())}updateFromElement(e,t,r,s,i,n,a,o){if(!this._device.isContextLost())if(this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount),e instanceof HTMLCanvasElement||this._device.isTextureUploading(this)){const u=document.createElement("canvas");u.width=a,u.height=o;const h=u.getContext("2d");h.drawImage(e,i,n,a,o,0,0,a,o);const l=h.getImageData(0,0,a,o);this.update(l.data,t,r,s,a,o,1),u.width=0,u.height=0}else this.uploadImageData(e,i,n,a,o,t,r,0,s)}createEmpty(e,t,r,s,i){this._flags=Number(i)||0,this.loadEmpty(e,t,r,s,0)}createWithMipmapData(e,t){e.arraySize?(this._flags=Number(t)||0,this._flags&zr.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(e)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}createView(e,t,r){return this._object?this._device.gpuCreateTextureView(this._object,{dimension:"2d",baseMipLevel:e??0,mipLevelCount:r||this._mipLevelCount-(e??0),baseArrayLayer:t??0,arrayLayerCount:1}):null}async readPixels(e,t,r,s,i,n,a){if(i<0||i>=this._depth)throw new Error(`Texture2DArray.readPixels(): invalid layer: ${i}`);if(n<0||n>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixels(): invalid miplevel: ${n}`);const o=D(this.format),u=O(this.format),h=B(this.format),l=Math.ceil(r/o)*Math.ceil(s/u)*h;if(a.byteLength<l)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${a.byteLength}, should be at least ${l}`);const c=this._device.createBuffer(l,{usage:"read"});await this.copyPixelDataToBuffer(e,t,r,s,i,n,c),await c.getBufferSubData(new Uint8Array(a.buffer,a.byteOffset,a.byteLength),0,l),c.dispose()}readPixelsToBuffer(e,t,r,s,i,n,a){if(i<0||i>=this._depth)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid layer: ${i}`);if(n<0||n>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid miplevel: ${n}`);this.copyPixelDataToBuffer(e,t,r,s,i,n,a)}loadEmpty(e,t,r,s,i){this.allocInternal(e,t,r,s,i),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(e){const t=e.format,r=e.width,s=e.height,i=e.arraySize,n=1!==e.mipLevels||this._flags&zr.TF_NO_MIPMAP?e.mipLevels:this._calcMipLevelCount(e.format,r,s,i);if(!e.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(t,r,s,e.arraySize,n),!this._device.isContextLost()){for(let t=0;t<e.arraySize;t++){if(e.mipDatas[t].length!==e.mipLevels)return void console.log("Texture2DArray.loadLevels() failed: Invalid texture data");for(let r=0;r<e.mipLevels;r++)this.uploadRaw(e.mipDatas[t][r].data,e.mipDatas[t][r].width,e.mipDatas[t][r].height,1,0,0,t,r)}e.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture2DArray.loadLevels(): No s3tc compression format support")}}class la extends oa{constructor(e){super(e,"3d")}isTexture3D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(e,t,r,s,i,n,a){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount),this.uploadRaw(e,i,n,a,t,r,s,0))}createEmpty(e,t,r,s,i){this._flags=Number(i)||0,this.loadEmpty(e,t,r,s,0)}createView(e,t,r){return this._object?this._device.gpuCreateTextureView(this._object,{dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:t,arrayLayerCount:1}):null}async readPixels(e,t,r,s,i,n,a){if(0!==n)throw new Error("Texture3D.readPixels(): parameter mipLevel must be 0");const o=D(this.format),u=O(this.format),h=B(this.format),l=this.width/o*(this.height/u)*h;if(a.byteLength<l)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${a.byteLength}, should be at least ${l}`);const c=this._device.createBuffer(l,{usage:"read"});await this.copyPixelDataToBuffer(e,t,r,s,i,0,c),await c.getBufferSubData(new Uint8Array(a.buffer,a.byteOffset,a.byteLength),0,l),c.dispose()}readPixelsToBuffer(e,t,r,s,i,n,a){if(0!==n)throw new Error("Texture3D.readPixelsToBuffer(): parameter mipLevel must be 0");this.copyPixelDataToBuffer(e,t,r,s,i,0,a)}createWithMipmapData(e,t){e.arraySize?(this._flags=Number(t)||0,this._flags&zr.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(e)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}loadLevels(e){const t=e.format,r=e.width,s=e.height,i=e.depth,n=1!==e.mipLevels||this._flags&zr.TF_NO_MIPMAP?e.mipLevels:this._calcMipLevelCount(e.format,r,s,i);if(!e.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(t,r,s,i,n),!this._device.isContextLost()){for(let t=0;t<i;t++){if(e.mipDatas[t].length!==e.mipLevels)return void console.log("Texture3D.loadLevels() failed: Invalid texture data");for(let r=0;r<e.mipLevels;r++)this.uploadRaw(e.mipDatas[t][r].data,e.mipDatas[t][r].width,e.mipDatas[t][r].height,1,0,0,t,r)}e.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture3D.loadLevels(): No s3tc compression format support")}loadEmpty(e,t,r,s,i){this.allocInternal(e,t,r,s,i),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}}class ca extends oa{constructor(e){super(e,"cube")}init(){this.loadEmpty(this._format,this._width,this._mipLevelCount)}update(e,t,r,s,i,n){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),this.uploadRaw(e,s,i,1,t,r,n,0),this._mipLevelCount>1&&this.generateMipmaps())}updateFromElement(e,t,r,s,i,n,a,o){if(!this._device.isContextLost())if(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),e instanceof HTMLCanvasElement||this._device.isTextureUploading(this)){const u=document.createElement("canvas");u.width=a,u.height=o;const h=u.getContext("2d");h.drawImage(e,i,n,a,o,0,0,a,o);const l=h.getImageData(0,0,a,o);this.update(l.data,t,r,a,o,s),u.width=0,u.height=0}else this.uploadImageData(e,i,n,a,o,t,r,0,s)}createEmpty(e,t,r){this._flags=Number(r)||0,this._flags&zr.TF_WRITABLE?console.error(new Error("storage texture can not be cube texture")):this.loadEmpty(e,t,0)}isTextureCube(){return!0}createView(e,t,r){return this._object?this._device.gpuCreateTextureView(this._object,{format:this._gpuFormat,dimension:"2d",baseMipLevel:e??0,mipLevelCount:r||this._mipLevelCount-(e??0),baseArrayLayer:t??0,arrayLayerCount:1,aspect:"all"}):null}async readPixels(e,t,r,s,i,n,a){if(n<0||n>=this.mipLevelCount)throw new Error(`TextureCube.readPixels(): invalid miplevel: ${n}`);const o=D(this.format),u=O(this.format),h=B(this.format),l=Math.ceil(r/o)*Math.ceil(s/u)*h;if(a.byteLength<l)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${a.byteLength}, should be at least ${l}`);const c=this._device.createBuffer(l,{usage:"read"});await this.copyPixelDataToBuffer(e,t,r,s,i,n,c),await c.getBufferSubData(new Uint8Array(a.buffer,a.byteOffset,a.byteLength),0,l),c.dispose()}readPixelsToBuffer(e,t,r,s,i,n,a){if(n<0||n>=this.mipLevelCount)throw new Error(`TextureCube.readPixelsToBuffer(): invalid miplevel: ${n}`);this.copyPixelDataToBuffer(e,t,r,s,i,n,a)}createWithMipmapData(e,t,r){e.isCubemap?(this._flags=Number(r)||0,this._flags&zr.TF_WRITABLE?console.error("webgl device does not support storage texture"):this.loadLevels(e,t)):console.error("loading cubmap with mipmap data failed: data is not cubemap")}loadEmpty(e,t,r){this.allocInternal(e,t,t,1,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadImages(e,t){const r=e[0].width,s=e[0].height;if(6===e.length){for(let t=1;t<6;t++)if(e[t].width!==r||e[t].height!==s)return void console.error(new Error("cubemap face images must have identical sizes"));if(0!==r&&0!==s&&(this.allocInternal(t,r,s,1,0),!this._device.isContextLost())){const t=this._width,r=this._height;for(let s=0;s<6;s++)createImageBitmap(e[s],{premultiplyAlpha:"none"}).then((e=>{this.updateFromElement(e,0,0,s,0,0,t,r)}));this._mipLevelCount>1&&this.generateMipmaps()}}else console.error(new Error("cubemap face list must have 6 images"))}loadLevels(e,t){const r=t?S(e.format):e.format,s=e.width,i=e.height,n=1!==e.mipLevels||this._flags&zr.TF_NO_MIPMAP?e.mipLevels:this._calcMipLevelCount(e.format,s,i,1);if(!e.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(r,s,i,1,n),!this._device.isContextLost())for(let t=0;t<6;t++){if(e.mipDatas[t].length!==e.mipLevels)return void console.log("TextureCube.loadLevels() failed: Invalid texture data");for(let r=0;r<e.mipLevels;r++)this.uploadRaw(e.mipDatas[t][r].data,e.mipDatas[t][r].width,e.mipDatas[t][r].height,1,0,0,t,r)}e.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}else console.error("TextureCube.loadLevels(): No s3tc compression format support")}}class pa extends oa{_source;_refBindGroups;constructor(e,t){super(e,"2d"),this._source=t,this._width=0,this._height=0,this._refBindGroups=[],this.loadFromElement()}isTextureVideo(){return!0}addBindGroupReference(e){this._refBindGroups.push(e)}removeBindGroupReference(e){const t=this._refBindGroups.indexOf(e);t>=0&&this._refBindGroups.splice(t,1)}get width(){return this._width}get height(){return this._height}get source(){return this._source}async restore(){this._object||this._device.isContextLost()||this.loadElement(this._source)}updateVideoFrame(){if(this._source.readyState>2){return new window.VideoFrame(this._source).close(),this._object=this._device.gpuImportExternalTexture(this._source),!0}return!1}createView(e,t,r){return null}init(){this.loadFromElement()}readPixels(e,t,r,s,i,n,a){throw new Error("Video texture does not support readPixels()")}readPixelsToBuffer(e,t,r,s,i,n,a){throw new Error("Video texture does not support readPixelsToBuffer()")}loadFromElement(){this.loadElement(this._source)}loadElement(e){if(this._format="rgba8unorm",this._width=e.videoWidth,this._height=e.videoHeight,this._depth=1,this._mipLevelCount=1,!this._device.isContextLost()&&e.readyState>2){this._object=this._device.gpuImportExternalTexture(e);const t=this;this._device.runNextFrame((function e(){if(!t.disposed){if(t._source.readyState>2){new window.VideoFrame(t._source).close(),t._object=t._device.gpuImportExternalTexture(t._source);for(const e of t._refBindGroups)e.invalidate()}t._device.runNextFrame(e)}}))}return!!this._object}}class fa{maxDrawBuffers;maxColorAttachmentBytesPerSample;supportMultisampledFramebuffer;supportFloatBlending;supportDepth32float;supportDepth32floatStencil8;constructor(e){this.maxDrawBuffers=e.device.limits.maxColorAttachments,this.maxColorAttachmentBytesPerSample=e.device.limits.maxColorAttachmentBytesPerSample,this.supportMultisampledFramebuffer=!0,this.supportFloatBlending=!0,this.supportDepth32float=!0,this.supportDepth32floatStencil8=e.device.features.has("depth32float-stencil8")}}class da{supportOversizedViewport;supportBlendMinMax;support32BitIndex;supportDepthClamp;maxBindGroups;maxTexCoordIndex;constructor(e){this.supportOversizedViewport=!1,this.supportBlendMinMax=!0,this.support32BitIndex=!0,this.supportDepthClamp=e.device.features.has("depth-clip-control"),this.maxBindGroups=4,this.maxTexCoordIndex=8}}class ma{supportFragmentDepth;supportStandardDerivatives;supportShaderTextureLod;supportHighPrecisionFloat;supportHighPrecisionInt;maxUniformBufferSize;uniformBufferOffsetAlignment;maxStorageBufferSize;storageBufferOffsetAlignment;constructor(e){this.supportFragmentDepth=!0,this.supportStandardDerivatives=!0,this.supportShaderTextureLod=!0,this.supportHighPrecisionFloat=!0,this.maxUniformBufferSize=e.device.limits.maxUniformBufferBindingSize||65536,this.uniformBufferOffsetAlignment=e.device.limits.minUniformBufferOffsetAlignment||256,this.maxStorageBufferSize=e.device.limits.maxStorageBufferBindingSize||134217728,this.storageBufferOffsetAlignment=e.device.limits.minStorageBufferOffsetAlignment||256}}class _a{_textureFormatInfos;maxTextureSize;maxCubeTextureSize;npo2Mipmapping;npo2Repeating;supportS3TC;supportS3TCSRGB;supportBPTC;supportRGTC;supportASTC;supportDepthTexture;support3DTexture;supportSRGBTexture;supportFloatTexture;supportLinearFloatTexture;supportHalfFloatTexture;supportLinearHalfFloatTexture;supportAnisotropicFiltering;supportFloatColorBuffer;supportHalfFloatColorBuffer;supportFloatBlending;constructor(e){if(this.supportAnisotropicFiltering=!0,this.supportDepthTexture=!0,this.support3DTexture=!0,this.supportSRGBTexture=!0,this.supportFloatTexture=!0,this.supportFloatColorBuffer=!0,this.supportHalfFloatColorBuffer=!0,this.supportFloatBlending=!0,this.supportS3TC=e.device.features.has("texture-compression-bc"),this.supportS3TCSRGB=this.supportS3TC,this.supportBPTC=this.supportS3TC,this.supportRGTC=this.supportS3TC,this.supportASTC=e.device.features.has("texture-compression-astc"),this.supportHalfFloatTexture=!0,this.maxTextureSize=e.device.limits.maxTextureDimension2D,this.maxCubeTextureSize=e.device.limits.maxTextureDimension2D,this.npo2Mipmapping=!0,this.npo2Repeating=!0,this._textureFormatInfos={rgba8unorm:{gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!0,size:4},rgba8snorm:{gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!1,writable:!0,size:4},bgra8unorm:{gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:4}},this.supportASTC)for(const e of["4x4","5x4","5x5","6x5","6x6","8x5","8x6","8x8","10x5","10x6","10x8","10x10","12x10","12x12"]){const[t,r]=e.split("x").map((e=>Number(e)));this._textureFormatInfos[`astc-${e}`]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:t,blockHeight:r},this._textureFormatInfos[`astc-${e}-srgb`]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:t,blockHeight:r}}this.supportS3TC&&(this._textureFormatInfos.dxt1={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:8,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos.dxt3={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos.dxt5={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4}),this.supportRGTC&&(this._textureFormatInfos.bc4={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:8,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc4-signed"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:8,writable:!1,blockWidth:4,blockHeight:4}),this._textureFormatInfos.bc5={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc5-signed"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this.supportBPTC&&(this._textureFormatInfos.bc6h={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc6h-signed"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos.bc7={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc7-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4}),this.supportS3TCSRGB&&(this._textureFormatInfos["dxt1-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:8,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["dxt3-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["dxt5-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4}),this._textureFormatInfos.r8unorm={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:1},this._textureFormatInfos.r8snorm={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!1,writable:!1,size:1},this._textureFormatInfos.r16f={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.r32f={gpuSampleType:"unfilterable-float",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:4},this._textureFormatInfos.r8ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:1},this._textureFormatInfos.r8i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:1},this._textureFormatInfos.r16ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.r16i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.r32ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:4},this._textureFormatInfos.r32i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:4},this._textureFormatInfos.rg8unorm={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.rg8snorm={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!1,writable:!1,size:2},this._textureFormatInfos.rg16f={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.rg32f={gpuSampleType:"unfilterable-float",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos.rg8ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.rg8i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.rg16ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.rg16i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.rg32ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos.rg32i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos["rgba8unorm-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos["bgra8unorm-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.rgba16f={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos.rgba32f={gpuSampleType:"unfilterable-float",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:16},this._textureFormatInfos.rgba8ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:4},this._textureFormatInfos.rgba8i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:4},this._textureFormatInfos.rgba16ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos.rgba16i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos.rgba32ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:16},this._textureFormatInfos.rgba32i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:16},this._textureFormatInfos.rg11b10uf={gpuSampleType:"float",filterable:!0,renderable:e.device.features.has("rg11b10ufloat-renderable"),compressed:!1,writable:!1,size:4},this._textureFormatInfos.d16={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.d24={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.d32f={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.d32fs8={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:8},this._textureFormatInfos.d24s8={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:4},this.supportLinearFloatTexture=this._textureFormatInfos.r32f.filterable&&this._textureFormatInfos.rg32f.filterable&&this._textureFormatInfos.rgba32f.filterable,this.supportLinearHalfFloatTexture=this._textureFormatInfos.r16f.filterable&&this._textureFormatInfos.rg16f.filterable&&this._textureFormatInfos.rgba16f.filterable}calcMemoryUsage(e,t){return this._textureFormatInfos[e]?this._textureFormatInfos[e].size*t:0}getTextureFormatInfo(e){return this._textureFormatInfos[e]}}class ga extends mn{static _hashCounter=0;_vertexData;_hash;_layouts;constructor(e,t){super(e),this._vertexData=new Zr;for(const e of t.vertexBuffers)this._vertexData.setVertexBuffer(e.buffer,e.stepMode);t.indexBuffer&&this._vertexData.setIndexBuffer(t.indexBuffer),this._hash=String(++ga._hashCounter),this._layouts={}}destroy(){this._object=null}async restore(){this._object={}}setDrawOffset(e,t){for(const r of this._vertexData.vertexBuffers)r?.buffer===e&&(r.drawOffset=t)}get hash(){return this._hash}get vertexBuffers(){return this._vertexData.vertexBuffers}get indexBuffer(){return this._vertexData.indexBuffer}getDrawOffset(){return this._vertexData.getDrawOffset()}getVertexBuffer(e){return this._vertexData.getVertexBuffer(e)}getVertexBufferInfo(e){return this._vertexData.getVertexBufferInfo(e)}getIndexBuffer(){return this._vertexData.getIndexBuffer()}getLayouts(e){if(!e)return null;let t=this._layouts[e];return t||(t=this.calcHash(e),this._layouts[e]=t),t}calcHash(e){const t=[],r=[],s=this._vertexData.vertexBuffers,i=e.split(":").map((e=>Number(e)));for(let e=0;e<i.length;e++){const n=s[i[e]],a=n?.buffer;if(!a){console.log(`ERROR: No vertex buffer set for location ${e}`);continue}const o=Yn.getGPUVertexFormat(n.type);if(!o)throw new Error("Invalid vertex buffer format");const u=r.findIndex((e=>e.buffer===a)),h=n.stride;let l=u>=0?t[u]:`${h}-${Number("instance"===n.stepMode)}`;l+=`-${ra[o]}-${n.offset}-${e}`,u>=0?t[u]=l:(t.push(l),r.push(n))}return{layoutHash:t.join(":"),buffers:r}}bind(){this._device.setVertexLayout(this)}draw(e,t,r){this.bind(),this._device.draw(e,t,r)}drawInstanced(e,t,r,s){this.bind(),this._device.drawInstanced(e,t,r,s)}}class xa{static _defaultState;_hash;static get defaultState(){return this._defaultState}constructor(){this._hash=null}get hash(){return this._getHash(this.constructor)}invalidateHash(){this._hash=null}_getHash(e){return this===e.defaultState?"":(null===this._hash&&(this._hash=this.computeHash()),this._hash)}}class ya extends xa{static _defaultState=new ya;_redMask;_greenMask;_blueMask;_alphaMask;constructor(){super(),this._redMask=this._greenMask=this._blueMask=this._alphaMask=!0}clone(){return(new ya).setColorMask(this._redMask,this._greenMask,this._blueMask,this._alphaMask)}get redMask(){return this._redMask}set redMask(e){this._redMask!==!!e&&(this._redMask=!!e,this.invalidateHash())}get greenMask(){return this._greenMask}set greenMask(e){this._greenMask!==!!e&&(this._greenMask=!!e,this.invalidateHash())}get blueMask(){return this._blueMask}set blueMask(e){this._blueMask!==!!e&&(this._blueMask=!!e,this.invalidateHash())}get alphaMask(){return this._alphaMask}set alphaMask(e){this._alphaMask!==!!e&&(this._alphaMask=!!e,this.invalidateHash())}setColorMask(e,t,r,s){return this.redMask=e,this.greenMask=t,this.blueMask=r,this.alphaMask=s,this}computeHash(){let e=0;return this.redMask&&(e+=1),this.greenMask&&(e+=2),this.blueMask&&(e+=4),this.alphaMask&&(e+=8),String(e)}}class ba extends xa{static _defaultState=new ba;_enabled;_alphaToCoverageEnabled;_srcBlendRGB;_dstBlendRGB;_srcBlendAlpha;_dstBlendAlpha;_rgbEquation;_alphaEquation;constructor(){super(),this._enabled=!1,this._alphaToCoverageEnabled=!1,this._srcBlendRGB="one",this._dstBlendRGB="zero",this._srcBlendAlpha="one",this._dstBlendAlpha="zero",this._rgbEquation="add",this._alphaEquation="add"}clone(){const e=new ba;return e.enable(this._enabled),e.enableAlphaToCoverage(this._alphaToCoverageEnabled),e.setBlendFuncRGB(this._srcBlendRGB,this._dstBlendRGB),e.setBlendFuncAlpha(this._srcBlendAlpha,this._dstBlendAlpha),e.setBlendEquation(this._rgbEquation,this._alphaEquation),e}get enabled(){return this._enabled}set enabled(e){this._enabled!==!!e&&(this._enabled=!!e,this.invalidateHash())}get alphaToCoverageEnabled(){return this._alphaToCoverageEnabled}set alphaToCoverageEnabled(e){this._alphaToCoverageEnabled!==!!e&&(this._alphaToCoverageEnabled=!!e,this.invalidateHash())}get srcBlendRGB(){return this._srcBlendRGB}set srcBlendRGB(e){this._srcBlendRGB!==e&&(this._srcBlendRGB=e,this.invalidateHash())}get srcBlendAlpha(){return this._srcBlendAlpha}set srcBlendAlpha(e){this._srcBlendAlpha!==e&&(this._srcBlendAlpha=e,this.invalidateHash())}get dstBlendRGB(){return this._dstBlendRGB}set dstBlendRGB(e){this._dstBlendRGB!==e&&(this._dstBlendRGB=e,this.invalidateHash())}get dstBlendAlpha(){return this._dstBlendAlpha}set dstBlendAlpha(e){this._dstBlendAlpha!==e&&(this._dstBlendAlpha=e,this.invalidateHash())}get rgbEquation(){return this._rgbEquation}set rgbEquation(e){this._rgbEquation!==e&&(this._rgbEquation=e,this.invalidateHash())}get alphaEquation(){return this._alphaEquation}set alphaEquation(e){this._alphaEquation!==e&&(this._alphaEquation=e,this.invalidateHash())}enable(e){return this.enabled=e,this}enableAlphaToCoverage(e){return this.alphaToCoverageEnabled=e,this}setBlendFunc(e,t){return this.srcBlendRGB=e,this.dstBlendRGB=t,this.srcBlendAlpha=e,this.dstBlendAlpha=t,this}setBlendFuncRGB(e,t){return this.srcBlendRGB=e,this.dstBlendRGB=t,this}setBlendFuncAlpha(e,t){return this.srcBlendAlpha=e,this.dstBlendAlpha=t,this}setBlendEquation(e,t){return this.rgbEquation=e,this.alphaEquation=t,this}computeHash(){return this._enabled?`${this._srcBlendRGB}-${this._srcBlendAlpha}-${this._dstBlendRGB}-${this._dstBlendAlpha}-${this._rgbEquation}-${this._alphaEquation}-${Number(!!this._alphaToCoverageEnabled)}`:`${Number(!!this._alphaToCoverageEnabled)}`}}class Ta extends xa{static _defaultState=new Ta;_cullMode;_depthClampEnabled;constructor(){super(),this._cullMode="back",this._depthClampEnabled=!1}clone(){return(new Ta).setCullMode(this._cullMode).enableDepthClamp(this._depthClampEnabled)}get cullMode(){return this._cullMode}set cullMode(e){this._cullMode!==e&&(this._cullMode=e,this.invalidateHash())}setCullMode(e){return this.cullMode=e,this}get depthClampEnabled(){return this._depthClampEnabled}set depthClampEnabled(e){this.enableDepthClamp(e)}enableDepthClamp(e){return this._depthClampEnabled!==!!e&&(this._depthClampEnabled=!!e,this.invalidateHash()),this}computeHash(){return`${this._cullMode}-${this._depthClampEnabled?1:0}`}}class wa extends xa{static _defaultState=new wa;_testEnabled;_writeEnabled;_compareFunc;constructor(){super(),this._testEnabled=!0,this._writeEnabled=!0,this._compareFunc="le"}clone(){const e=new wa;return e.enableTest(this._testEnabled),e.enableWrite(this._writeEnabled),e.setCompareFunc(this._compareFunc),e}get testEnabled(){return this._testEnabled}set testEnabled(e){this._testEnabled!==!!e&&(this._testEnabled=e,this.invalidateHash())}get writeEnabled(){return this._writeEnabled}set writeEnabled(e){this._writeEnabled!==!!e&&(this._writeEnabled=e,this.invalidateHash())}get compareFunc(){return this._compareFunc}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this.invalidateHash())}enableTest(e){return this.testEnabled=e,this}enableWrite(e){return this.writeEnabled=e,this}setCompareFunc(e){return this.compareFunc=e,this}computeHash(){return`${Number(this._testEnabled)}-${Number(this._writeEnabled)}-${this.compareFunc}}`}}class va extends xa{static _defaultState=new va;_enabled;_writeMask;_failOp;_failOpBack;_zFailOp;_zFailOpBack;_passOp;_passOpBack;_func;_funcBack;_ref;_readMask;constructor(){super(),this._enabled=!1,this._failOp=this.failOpBack="keep",this._zFailOp=this.zFailOpBack="keep",this._passOp=this.passOpBack="keep",this._func=this.funcBack="always",this._ref=0,this._writeMask=4294967295,this._readMask=4294967295}clone(){const e=new va;return e.enable(this._enabled),e.setWriteMask(this._writeMask),e.setFrontOp(this._failOp,this._zFailOp,this._passOp),e.setBackOp(this._failOpBack,this._zFailOpBack,this._passOpBack),e.setFrontCompareFunc(this._func),e.setBackCompareFunc(this._funcBack),e.setReference(this._ref),e.setReadMask(this._readMask),e}get enabled(){return this._enabled}set enabled(e){this._enabled!==!!e&&(this._enabled=!!e,this.invalidateHash())}get writeMask(){return this._writeMask}set writeMask(e){this._writeMask!==e&&(this._writeMask=e,this.invalidateHash())}get failOp(){return this._failOp}set failOp(e){this._failOp!==e&&(this._failOp=e,this.invalidateHash())}get failOpBack(){return this._failOpBack}set failOpBack(e){this._failOpBack!==e&&(this._failOpBack=e,this.invalidateHash())}get zFailOp(){return this._zFailOp}set zFailOp(e){this._zFailOp!==e&&(this._zFailOp=e,this.invalidateHash())}get zFailOpBack(){return this._zFailOpBack}set zFailOpBack(e){this._zFailOpBack!==e&&(this._zFailOpBack=e,this.invalidateHash())}get passOp(){return this._passOp}set passOp(e){this._passOp!==e&&(this._passOp=e,this.invalidateHash())}get passOpBack(){return this._passOpBack}set passOpBack(e){this._passOpBack!==e&&(this._passOpBack=e,this.invalidateHash())}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this.invalidateHash())}get funcBack(){return this._funcBack}set funcBack(e){this._funcBack!==e&&(this._funcBack=e,this.invalidateHash())}get ref(){return this._ref}set ref(e){this._ref!==e&&(this._ref=e,this.invalidateHash())}get readMask(){return this._readMask}set readMask(e){this._readMask!==e&&(this._readMask=e,this.invalidateHash())}enable(e){return this.enabled=e,this}setWriteMask(e){return this.writeMask=e,this}setFrontOp(e,t,r){return this.failOp=e,this.zFailOp=t,this.passOp=r,this}setBackOp(e,t,r){return this.failOpBack=e,this.zFailOpBack=t,this.passOpBack=r,this}setFrontCompareFunc(e){return this.func=e,this}setBackCompareFunc(e){return this.funcBack=e,this}setReference(e){return this.ref=e,this}setReadMask(e){return this.readMask=e,this}computeHash(){return this._enabled?`${this.sideHash(!1)}-${this.sideHash(!0)}-${this.readMask.toString(16)}-${this.writeMask.toString(16)}-${this.ref.toString(16)}`:""}sideHash(e){return e?`${this._failOpBack}-${this._zFailOpBack}-${this._passOpBack}-${this._funcBack}`:`${this._failOp}-${this._zFailOp}-${this._passOp}-${this._func}`}}class Ea{_device;colorState;blendingState;rasterizerState;depthState;stencilState;constructor(e){this._device=e,this.colorState=null,this.blendingState=null,this.rasterizerState=null,this.depthState=null,this.stencilState=null}clone(){const e=new Ea(this._device);return e.colorState=this.colorState?.clone()??null,e.blendingState=this.blendingState?.clone()??null,e.rasterizerState=this.rasterizerState?.clone()??null,e.depthState=this.depthState?.clone()??null,e.stencilState=this.stencilState?.clone()??null,e}copyFrom(e){this.colorState=e.colorState,this.blendingState=e.blendingState,this.rasterizerState=e.rasterizerState,this.depthState=e.depthState,this.stencilState=e.stencilState}get hash(){return`${this.colorState?.hash||""}:${this.blendingState?.hash||""}:${this.rasterizerState?.hash||""}:${this.depthState?.hash||""}:${this.stencilState?.hash||""}`}useColorState(e){return this.colorState=e??this.colorState??new ya}defaultColorState(){this.colorState=null}useBlendingState(e){return this.blendingState=e??this.blendingState??new ba}defaultBlendingState(){this.blendingState=null}useRasterizerState(e){return this.rasterizerState=e??this.rasterizerState??new Ta}defaultRasterizerState(){this.rasterizerState=null}useDepthState(e){return this.depthState=e??this.depthState??new wa}defaultDepthState(){this.depthState=null}useStencilState(e){return this.stencilState=e??this.stencilState??new va}defaultStencilState(){this.stencilState=null}apply(e){this._device.setRenderStates(this)}}const Ca=ue.getCachedTypeInfo(X.U16),Sa=["stencil8","depth24plus-stencil8","depth24unorm-stencil8","depth32float-stencil8"],$a=["depth16unorm","depth24plus","depth24plus-stencil8","depth32float","depth24unorm-stencil8","depth32float-stencil8"];class Aa{_device;_renderPipelines;_computePipelines;constructor(e){this._device=e,this._renderPipelines={},this._computePipelines={}}wipeCache(){this._renderPipelines={},this._computePipelines={}}fetchComputePipeline(e){const t=this.getComputePipelineHash(e);let r=this._computePipelines[t];if(void 0===r){const s=e.getShaderModule(),i={layout:s.pipelineLayout,compute:{module:s.csModule,entryPoint:"main"}};r=this._device.gpuCreateComputePipeline(i),this._computePipelines[t]=r}return r}fetchRenderPipeline(e,t,r,s,i){if(!i.hash)return null;e.vertexAttributes||(t=null);const n=this.getRenderPipelineHash(i.hash,e,t,r,s);let a=this._renderPipelines[n];if(void 0===a){const o=t?this._device.fetchVertexLayout(t.getLayouts(e.vertexAttributes).layoutHash):null,u=e.getShaderModule(),h={module:u.vsModule,entryPoint:"main"};o&&(h.buffers=o);const l=this.createPrimitiveState(t,r,s),c=this.createDepthStencilState(i.depthFormat,r),p=i.colorFormats.map((e=>this.createColorTargetState(r,e))),f={label:n,layout:u.pipelineLayout,vertex:h,primitive:l,depthStencil:c,multisample:this.createMultisampleState(i.sampleCount,r),fragment:{module:u.fsModule,entryPoint:"main",targets:p}};a=this._device.gpuCreateRenderPipeline(f),this._renderPipelines[n]=a}return a}createPrimitiveState(e,t,r){const s=Kn[r];if(!s)throw new Error(`createPrimitiveState() failed: invalid primitive type: ${r}`);const i=t?.rasterizerState||Ta.defaultState,n=Jn[i.cullMode];if(!n)throw new Error(`createPrimitiveState() failed: invalid cull mode: ${i.cullMode}`);const a={topology:s,frontFace:this._device.isWindingOrderReversed()?"cw":"ccw",cullMode:n};return this._device.device.features.has("depth-clip-control")&&(a.unclippedDepth=i.depthClampEnabled),"triangle-strip"!==s&&"line-strip"!==s||(a.stripIndexFormat=e?.getIndexBuffer()?.indexType===Ca?"uint16":"uint32"),a}createMultisampleState(e,t){return{count:e,alphaToCoverageEnabled:e>1&&(t?.blendingState??ba.defaultState).alphaToCoverageEnabled}}createDepthStencilState(e,t){if(!e)return;const r=t?.depthState||wa.defaultState,s=t?.stencilState||va.defaultState,i=Sa.indexOf(e)>=0,n=$a.indexOf(e)>=0,a={format:e,depthWriteEnabled:!!n&&r.writeEnabled,depthCompare:n&&r.testEnabled?Zn[r.compareFunc]:"always"};if(i){const e=s.enabled?this.createStencilFaceState(s.func,s.failOp,s.zFailOp,s.passOp):void 0,t=s.enabled?this.createStencilFaceState(s.funcBack,s.failOpBack,s.zFailOpBack,s.passOpBack):void 0,r=s.enabled?s.readMask:void 0,i=s.enabled?s.writeMask:void 0;a.stencilFront=e,a.stencilBack=t,a.stencilReadMask=r,a.stencilWriteMask=i}return a}createStencilFaceState(e,t,r,s){return{compare:Zn[e],failOp:Qn[t],depthFailOp:Qn[r],passOp:Qn[s]}}createColorTargetState(e,t){const r=e?.blendingState||ba.defaultState,s=e?.colorState||ya.defaultState,i={format:t,writeMask:(s.redMask?GPUColorWrite.RED:0)|(s.greenMask?GPUColorWrite.GREEN:0)|(s.blueMask?GPUColorWrite.BLUE:0)|(s.alphaMask?GPUColorWrite.ALPHA:0)};return r.enabled&&(i.blend=this.createBlendState(r)),i}createBlendState(e){return{color:this.createBlendComponent(e.rgbEquation,e.srcBlendRGB,e.dstBlendRGB),alpha:this.createBlendComponent(e.alphaEquation,e.srcBlendAlpha,e.dstBlendAlpha)}}createBlendComponent(e,t,r){const s=ea[e];if(!s)throw new Error(`createBlendComponent() failed: invalid blend op: ${e}`);const i=ta[t];if(!i)throw new Error(`createBlendComponent() failed: invalid source blend func ${t}`);const n=ta[r];if(!n)throw new Error(`createBlendComponent() failed: invalid dest blend func ${r}`);return{operation:s,srcFactor:i,dstFactor:n}}getRenderPipelineHash(e,t,r,s,i){return`${t.hash}:${r?.getLayouts(t.vertexAttributes).layoutHash||""}:${e}:${i}:${s?.hash||""}:${Number(this._device.isWindingOrderReversed())}`}getComputePipelineHash(e){return e.hash}}class La extends mn{_options;_width;_height;_bindFlag;_hash;_msaaColorTextures;_msaaDepthTexture;constructor(e,t,r,s){if(super(e),t.length>0&&t.findIndex((e=>!e))>=0)throw new Error("WebGPUFramebuffer(): invalid color attachments");if(this._object=null,this._options={colorAttachments:t?.length>0?t.map((e=>({texture:e,face:0,layer:0,level:0,generateMipmaps:!0}))):null,depthAttachment:r?{texture:r,face:0,layer:0,level:0,generateMipmaps:!1}:null,sampleCount:s?.sampleCount??1,ignoreDepthStencil:s?.ignoreDepthStencil??!1},!this._options.colorAttachments&&!this._options.depthAttachment)throw new Error("WebGPUFramebuffer(): colorAttachments or depthAttachment must be specified");if(this._width=this._options.colorAttachments?this._options.colorAttachments[0].texture.width:this._options.depthAttachment.texture.width,this._height=this._options.colorAttachments?this._options.colorAttachments[0].texture.height:this._options.depthAttachment.texture.height,this._options.colorAttachments&&this._options.colorAttachments.findIndex((e=>e.texture.width!==this._width||e.texture.height!==this._height))>=0||this._options.depthAttachment&&(this._options.depthAttachment.texture.width!==this._width||this._options.depthAttachment.texture.height!==this._height))throw new Error("WebGPUFramebuffer(): attachment textures must have same width and height");this._bindFlag=0,this._msaaColorTextures=null,this._msaaDepthTexture=null;const i=this._options.colorAttachments?.map((e=>e.texture.format)).join(":")??"",n=this._options.depthAttachment?.texture.format??"";this._hash=`${i}-${n}-${this._options.sampleCount??1}`,this._init()}getOptions(){return this._options}get bindFlag(){return this._bindFlag}getHash(){return this._hash}getWidth(){const e=this._options.colorAttachments?.[0]??this._options.depthAttachment;return e?Math.max(e.texture.width>>e.level,1):0}getHeight(){const e=this._options.colorAttachments?.[0]??this._options.depthAttachment;return e?Math.max(e.texture.height>>e.level,1):0}async restore(){if(this._options?.depthAttachment?.texture?.disposed&&await this._options.depthAttachment.texture.reload(),this._options?.colorAttachments)for(const e of this._options.colorAttachments)e?.texture?.disposed&&await e.texture.reload();this._device.isContextLost()||this._init()}destroy(){if(this._object=null,this._msaaColorTextures){for(const e of this._msaaColorTextures)e.destroy();this._msaaColorTextures=null}this._msaaDepthTexture&&(this._msaaDepthTexture.destroy(),this._msaaDepthTexture=null)}setColorAttachmentGenerateMipmaps(e,t){const r=this._options.colorAttachments?.[e];r&&(r.generateMipmaps=!!t)}setColorAttachmentCubeFace(e,t){const r=this._options.colorAttachments?.[e];r&&r.face!==t&&(r.face=t,this._bindFlag++)}setColorAttachmentMipLevel(e,t){const r=this._options.colorAttachments?.[e];r&&r.level!==t&&(r.level=t,this._bindFlag++)}setColorAttachmentLayer(e,t){const r=this._options.colorAttachments?.[e];r&&r.layer!==t&&(r.layer=t,this._bindFlag++)}setDepthAttachmentCubeFace(e){const t=this._options.depthAttachment;t&&t.face!==e&&(t.face=e,this._bindFlag++)}setDepthAttachmentLayer(e){const t=this._options.depthAttachment;t&&t.layer!==e&&(t.layer=e,this._bindFlag++)}getDepthAttachment(){return this._options?.depthAttachment?.texture||null}getColorAttachments(){return this._options?.colorAttachments?.map((e=>e?.texture||null))||[]}getMSAADepthAttachment(){return this._msaaDepthTexture}getMSAAColorAttacments(){return this._msaaColorTextures}getColorFormats(){return this._options?.colorAttachments?.map((e=>(e?.texture)?.gpuFormat||null))}getDepthFormat(){return(this._options.depthAttachment?.texture)?.gpuFormat||null}bind(){throw new Error("no bind operatation for WebGPU")}unbind(){throw new Error("no unbind operatation for WebGPU")}_init(){if(this._options.sampleCount>1){this._msaaColorTextures=[];for(const e of this._options.colorAttachments){const t=this.device.gpuCreateTexture({size:{width:this._width,height:this._height,depthOrArrayLayers:1},format:e.texture.gpuFormat,mipLevelCount:1,sampleCount:this._options.sampleCount,dimension:"2d",usage:GPUTextureUsage.COPY_SRC|GPUTextureUsage.RENDER_ATTACHMENT});this._msaaColorTextures.push(t)}if(this._options.depthAttachment){const e=this.device.gpuCreateTexture({size:{width:this._width,height:this._height,depthOrArrayLayers:1},format:this._options.depthAttachment.texture.gpuFormat,mipLevelCount:1,sampleCount:this._options.sampleCount,dimension:"2d",usage:GPUTextureUsage.COPY_SRC|GPUTextureUsage.RENDER_ATTACHMENT});this._msaaDepthTexture=e}}this._object={}}isFramebuffer(){return!0}getSampleCount(){return this._options.sampleCount}}const Ia=ue.getCachedTypeInfo(X.U16),Ba=ue.getCachedTypeInfo(X.U32);class Da extends xn{indexType;length;constructor(e,t,r){if(!(t instanceof Uint16Array||t instanceof Uint32Array))throw new Error("invalid index data");super(e,zr.BF_INDEX|r,t),this.indexType=t instanceof Uint16Array?Ia:Ba,this.length=t.length}}class Oa{_device;_bindGroupLayoutCache;constructor(e){this._device=e,this._bindGroupLayoutCache={}}fetchBindGroupLayout(e){const t=e?this.getLayoutHash(e):"";let r=this._bindGroupLayoutCache[t];if(!r){if(r=this.createBindGroupLayout(e),!r)throw new Error(`fetchBindGroupLayout() failed: hash: ${t}`);this._bindGroupLayoutCache[t]=r}return r}getLayoutHash(e){let t="";for(const r of e.entries){let e=`${r.binding}:${r.visibility}:`;r.buffer?e+=`b:${r.buffer.type}:${r.buffer.hasDynamicOffset}:${r.buffer.minBindingSize}`:r.sampler?e+=`s${r.sampler.type}:`:r.texture?e+=`t${r.texture.sampleType}-${r.texture.viewDimension}-${Number(!!r.texture.multisampled)}:`:r.storageTexture?e+=`k${r.storageTexture.access}-${r.storageTexture.format}-${r.storageTexture.viewDimension}:`:r.externalTexture&&(e+="v:"),t=`${t} ${e}`}return t}createBindGroupLayout(e){const t={entries:e?.entries.map((e=>{const t=e.binding,r=(e.visibility&F.Vertex?GPUShaderStage.VERTEX:0)|(e.visibility&F.Fragment?GPUShaderStage.FRAGMENT:0)|(e.visibility&F.Compute?GPUShaderStage.COMPUTE:0),s=e.buffer?{type:e.buffer.type,hasDynamicOffset:e.buffer.hasDynamicOffset,minBindingSize:Number(e.buffer.minBindingSize)||0}:void 0,i=e.sampler?{type:e.sampler.type}:void 0,n=e.texture?{sampleType:e.texture.sampleType,viewDimension:e.texture.viewDimension}:void 0,a=e.storageTexture?{access:"write-only",viewDimension:"2d",format:sa[e.storageTexture.format]}:void 0,o=e.externalTexture?{}:void 0,u={binding:t,visibility:r};return s?u.buffer=s:i?u.sampler=i:n?u.texture=n:a?u.storageTexture=a:o&&(u.externalTexture=o),u}))||[]};return e?.label&&(t.label=e.label),[t,this._device.device.createBindGroupLayout(t)]}}class Fa{_layouts;constructor(){this._layouts={}}fetchVertexLayout(e){let t=this._layouts[e];return t||(t=[],e.split(":").forEach((e=>{const r=e.split("-"),s={arrayStride:Number(r[0]),stepMode:Number(r[1])?"instance":"vertex",attributes:[]};for(let e=2;e<r.length;e+=3)s.attributes.push({format:aa[r[e]],offset:Number(r[e+1]),shaderLocation:Number(r[e+2])});t.push(s)})),this._layouts[e]=t),t}}class Ma extends mn{_options;constructor(e,t){super(e),this._options=Object.assign({addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:"nearest",minFilter:"nearest",mipFilter:"none",lodMin:0,lodMax:32,compare:null,maxAnisotropy:1},t||{}),this._load()}get hash(){return this._object?this._device.gpuGetObjectHash(this._object):0}get addressModeU(){return this._options.addressU}get addressModeV(){return this._options.addressV}get addressModeW(){return this._options.addressW}get magFilter(){return this._options.magFilter}get minFilter(){return this._options.minFilter}get mipFilter(){return this._options.mipFilter}get lodMin(){return this._options.lodMin}get lodMax(){return this._options.lodMax}get compare(){return this._options.compare}get maxAnisotropy(){return this._options.maxAnisotropy}destroy(){this._object=null}async restore(){this._device.isContextLost()||this._load()}_load(){return this._object=this._device.gpuCreateSampler({addressModeU:Hn[this._options.addressU],addressModeV:Hn[this._options.addressV],addressModeW:Hn[this._options.addressW],magFilter:qn[this._options.magFilter],minFilter:qn[this._options.minFilter],mipmapFilter:qn[this._options.mipFilter],lodMinClamp:this._options.lodMin,lodMaxClamp:this._options.lodMax,compare:Zn[this._options.compare]||void 0,maxAnisotropy:this._options.maxAnisotropy}),!!this._object}isSampler(){return!0}}class Ra{_device;_samplers;constructor(e){this._device=e,this._samplers={}}fetchSampler(e){const t=this.hash(e);let r=this._samplers[t];return r||(r=this.createSampler(e),this._samplers[t]=r),r}hash(e){return`${e.addressU?String(e.addressU):""}:${e.addressV?String(e.addressV):""}:${e.addressW?String(e.addressW):""}:${e.magFilter?String(e.magFilter):""}:${e.minFilter?String(e.minFilter):""}:${e.mipFilter?String(e.mipFilter):""}:${e.lodMin?String(e.lodMin):""}:${e.lodMax?String(e.lodMax):""}:${e.compare?String(e.compare):""}:${e.maxAnisotropy?String(e.maxAnisotropy):""}`}createSampler(e){return new Ma(this._device,e)}}class Va{static _clearPrograms={};static _clearBindGroup=null;static _clearStateSet=null;static _defaultClearColor=new l(0,0,0,1);static drawClearQuad(e,t,r,s){this._clearBindGroup||this.initClearQuad(e);const i=e.getFrameBufferInfo().clearHash,n=this.getClearProgram(e.getDevice(),i),a=!!t,o=!(null==r),u=!(null==s);n.bindGroup.setValue("clearDepth",r??1),n.bindGroup.setValue("clearColor",t??this._defaultClearColor),this._clearStateSet.useDepthState().enableWrite(o),this._clearStateSet.useColorState().setColorMask(a,a,a,a),this._clearStateSet.useStencilState().enable(u).setReference(u?s:0),e.getDevice().commandQueue.draw(n.program,null,this._clearStateSet,[n.bindGroup],null,"triangle-strip",0,4,1)}static getClearProgram(e,t){let r=this._clearPrograms[t];if(!r){const s=t.split(""),i=e.buildRenderProgram({label:`ClearQuad-${t}`,vertex(e){this.clearDepth=e.float().uniform(0),this.coords=[e.vec2(-1,1),e.vec2(1,1),e.vec2(-1,-1),e.vec2(1,-1)],e.main((function(){this.$builtins.position=e.vec4(this.coords.at(this.$builtins.vertexIndex),this.clearDepth,1)}))},fragment(e){if(this.clearColor=e.vec4().uniform(0),0===s.length)this.$outputs.outColor=e.vec4(),e.main((function(){this.$outputs.outColor=this.clearColor}));else{for(let t=0;t<s.length;t++)this.$outputs[`outColor${t}`]="f"===s[t]?e.vec4():"i"===s[t]?e.ivec4():e.uvec4();e.main((function(){for(let t=0;t<s.length;t++)this.$outputs[`outColor${t}`]="f"===s[t]?this.clearColor:"i"===s[t]?e.ivec4(this.clearColor):e.uvec4(this.clearColor)}))}}});r={program:i,bindGroup:e.createBindGroup(i.bindGroupLayouts[0])},this._clearPrograms[t]=r}return r}static initClearQuad(e){this._clearStateSet=e.getDevice().createRenderStateSet(),this._clearStateSet.useDepthState().enableTest(!1),this._clearStateSet.useRasterizerState().setCullMode("none"),this._clearStateSet.useStencilState().enable(!0).setFrontOp("replace","replace","replace").setBackOp("replace","replace","replace").setFrontCompareFunc("always").setBackCompareFunc("always")}}class Ga{static _frameBufferInfo=null;static _mipmapGenerationProgram=null;static _mipmapGenerationBindGroup=new WeakMap;static _mipmapGenerationStateSet=null;static generateMipmap(e,t,r){if(!t.isRenderable())return;this._mipmapGenerationProgram||this.initMipmapGeneration(e);const s=r??e.device.createCommandEncoder(),i=t.mipLevelCount,n=t.isTextureCube()?6:t.isTexture2DArray()?t.depth:1;t.setMipmapDirty(!1);for(let r=0;r<n;r++)for(let n=1;n<i;n++)this.generateMiplevel(e,s,t,t.object,t.gpuFormat,n,n,r);r||e.device.queue.submit([s.finish()])}static generateMipmapsForBindGroups(e,t){for(const r of t)if(r)for(const t of r.textureList)!t.disposed&&t.isMipmapDirty()&&Ga.generateMipmap(e,t)}static generateMiplevel(e,t,r,s,i,n,a,o){const u=this.beginMipmapGenerationPass(t,s,i,n,o);u.setBindGroup(0,this.getMipmapGenerationBindGroup(e,r,a,o).bindGroup);const h=e.pipelineCache.fetchRenderPipeline(this._mipmapGenerationProgram,null,this._mipmapGenerationStateSet,"triangle-strip",this._frameBufferInfo);h&&(u.setPipeline(h),u.draw(4,1,0)),u.end()}static beginMipmapGenerationPass(e,t,r,s,i){const n={colorAttachments:[{view:t.createView({dimension:"2d",baseMipLevel:s||0,mipLevelCount:1,baseArrayLayer:i||0,arrayLayerCount:1}),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}]};this._frameBufferInfo={colorFormats:[r],depthFormat:null,sampleCount:1,hash:null,clearHash:null},this._frameBufferInfo.hash=`${this._frameBufferInfo.colorFormats.join("-")}:${this._frameBufferInfo.depthFormat}:${this._frameBufferInfo.sampleCount}`;const a=e.beginRenderPass(n);return a.insertDebugMarker("MipmapGeneration"),a}static getMipmapGenerationBindGroup(e,t,r,s){let i=this._mipmapGenerationBindGroup.get(t);i||(i=[],this._mipmapGenerationBindGroup.set(t,i));let n=i[s];n||(n=[],i[s]=n);let a=n[r];return a||(a=e.createBindGroup(this._mipmapGenerationProgram.bindGroupLayouts[0]),a.setTextureView("tex",t,r-1,s,1),n[r]=a),a}static initMipmapGeneration(e){this._mipmapGenerationProgram=e.buildRenderProgram({label:"MipmapGeneration",vertex(e){this.$outputs.outUV=e.vec2(),this.coords=[e.vec2(-1,1),e.vec2(1,1),e.vec2(-1,-1),e.vec2(1,-1)],this.uv=[e.vec2(0,0),e.vec2(1,0),e.vec2(0,1),e.vec2(1,1)],e.main((function(){this.$builtins.position=e.vec4(this.coords.at(this.$builtins.vertexIndex),0,1),this.$outputs.outUV=this.uv.at(this.$builtins.vertexIndex)}))},fragment(e){this.$outputs.color=e.vec4(),this.tex=e.tex2D().uniform(0),e.main((function(){this.$outputs.color=e.textureSampleLevel(this.tex,this.$inputs.outUV,0)}))}}),this._mipmapGenerationStateSet=e.createRenderStateSet(),this._mipmapGenerationStateSet.useDepthState().enableTest(!1).enableWrite(!1),this._mipmapGenerationStateSet.useRasterizerState().setCullMode("none")}}const Pa=ue.getCachedTypeInfo(X.U16);class Na{_device;_renderCommandEncoder;_renderPassEncoder;_fbBindFlag;_currentViewport;_currentScissor;_frameBufferInfo;constructor(e){this._device=e,this._renderCommandEncoder=this._device.device.createCommandEncoder(),this._renderPassEncoder=null,this._fbBindFlag=null,this._currentViewport=null,this._currentScissor=null,this._frameBufferInfo=this.createFrameBufferInfo(null)}get active(){return!!this._renderPassEncoder}createFrameBufferInfo(e){const t=e?{frameBuffer:e,colorFormats:e.getColorAttachments().map((e=>e.gpuFormat)),depthFormat:e.getDepthAttachment()?.gpuFormat,sampleCount:e.getOptions().sampleCount,hash:null,clearHash:e.getColorAttachments().map((e=>{const t=na[e.gpuFormat];return L(t)?I(t)?"i":"u":"f"})).join("")}:{frameBuffer:null,colorFormats:[this._device.backbufferFormat],depthFormat:this._device.backbufferDepthFormat,sampleCount:this._device.sampleCount,hash:null,clearHash:"f"};return t.hash=`${t.colorFormats.join("-")}:${t.depthFormat}:${t.sampleCount}`,t}setFramebuffer(e){this._frameBufferInfo.frameBuffer!==e&&(this.end(),this._frameBufferInfo=this.createFrameBufferInfo(e),this.setViewport(null),this.setScissor(null))}getFramebuffer(){return this._frameBufferInfo.frameBuffer}setViewport(e){!e||!Array.isArray(e)&&e.default?this._currentViewport={x:0,y:0,width:this._device.deviceToScreen(this._device.drawingBufferWidth),height:this._device.deviceToScreen(this._device.drawingBufferHeight),default:!0}:Array.isArray(e)?this._currentViewport={x:e[0],y:e[1],width:e[2],height:e[3],default:!1}:this._currentViewport=Object.assign({default:!1},e);const t=this._device.screenToDevice(this._currentViewport.x),r=this._device.screenToDevice(this._currentViewport.y),s=this._device.screenToDevice(this._currentViewport.width),i=this._device.screenToDevice(this._currentViewport.height);(t<0||r<0||s>this._device.drawingBufferWidth||i>this._device.drawingBufferHeight)&&console.log(`** VIEWPORT ERROR **: (${t}, ${r}, ${s}, ${i}) => (0, 0, ${this._device.drawingBufferWidth}, ${this._device.drawingBufferHeight})`),this._renderPassEncoder&&this._renderPassEncoder.setViewport(t,this._device.drawingBufferHeight-r-i,s,i,0,1)}getViewport(){return Object.assign({},this._currentViewport)}setScissor(e){const t=this._device.deviceToScreen(this._device.drawingBufferWidth),r=this._device.deviceToScreen(this._device.drawingBufferHeight);null==e||!Array.isArray(e)&&e.default?this._currentScissor={x:0,y:0,width:t,height:r,default:!0}:Array.isArray(e)?this._currentScissor={x:e[0],y:e[1],width:e[2],height:e[3],default:!1}:this._currentScissor=Object.assign({default:!1},e);let s=this._device.screenToDevice(this._currentScissor.x),i=this._device.screenToDevice(this._currentScissor.y),n=this._device.screenToDevice(this._currentScissor.width),a=this._device.screenToDevice(this._currentScissor.height);s<0&&(n+=s,s=0),i<0&&(a+=i,i=0),n=Math.min(this._device.screenToDevice(t)-s,n),a=Math.min(this._device.screenToDevice(r)-i,a),(n<0||a<0)&&(s=0,i=0,n=0,a=0),this._renderPassEncoder&&this._renderPassEncoder.setScissorRect(s,this._device.drawingBufferHeight-i-a,n,a)}getScissor(){return Object.assign({},this._currentScissor)}executeRenderBundle(e){this.active||this.begin(),this._renderPassEncoder.executeBundles([e])}draw(e,t,r,s,i,n,a,o,u){const h=this.validateDraw(e,s);2&h||(1&h&&this.end(),this.active||this.begin(),this.drawInternal(this._renderPassEncoder,e,t,r,s,i,n,a,o,u))}clear(e,t,r){this._currentScissor?(this._renderPassEncoder||this.begin(),this._renderPassEncoder.insertDebugMarker("clear"),Va.drawClearQuad(this,e,t,r),this._renderPassEncoder.insertDebugMarker("end clear")):(this.end(),this.begin(e,t,r))}getDevice(){return this._device}getFrameBufferInfo(){return this._frameBufferInfo}begin(e,t,r){if(this.active)return void console.error("WebGPURenderPass.begin() failed: begin() has already been called");this._renderCommandEncoder=this._device.device.createCommandEncoder();const s=this._frameBufferInfo.frameBuffer;if(s){const i=s.getDepthAttachment();let n;if(i){i._markAsCurrentFB(!0);const e=s.getOptions().depthAttachment,t=i.isTexture2DArray()||i.isTexture3D()?e.layer:i.isTextureCube()?e.face:0;n=i.getView(0,t??0,1)}this._fbBindFlag=s.bindFlag;const a={label:`customRenderPass:${this._frameBufferInfo.hash}`,colorAttachments:s.getOptions().colorAttachments?.map(((t,r)=>{const i=t.texture;if(i){i._markAsCurrentFB(!0);const n=i.isTexture2DArray()||i.isTexture3D()?t.layer:i.isTextureCube()?t.face:0;if(1===s.getOptions().sampleCount)return{view:i.getView(t.level??0,n??0,1),loadOp:e?"clear":"load",clearValue:e,storeOp:"store"};{const a=s.getMSAAColorAttacments()[r];return{view:this._device.gpuCreateTextureView(a,{dimension:"2d",baseMipLevel:t.level??0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}),resolveTarget:i.getView(t.level??0,n??0,1),loadOp:e?"clear":"load",clearValue:e,storeOp:"store"}}}return null}))??[],depthStencilAttachment:i?1===s.getOptions().sampleCount?{view:n,depthLoadOp:"number"==typeof t?"clear":"load",depthClearValue:t,depthStoreOp:"store",stencilLoadOp:A(i.format)?"number"==typeof r?"clear":"load":void 0,stencilClearValue:r,stencilStoreOp:A(i.format)?"store":void 0}:{view:s.getMSAADepthAttachment().createView(),depthLoadOp:"number"==typeof t?"clear":"load",depthClearValue:t,depthStoreOp:"store",stencilLoadOp:A(i.format)?"number"==typeof r?"clear":"load":void 0,stencilClearValue:r,stencilStoreOp:A(i.format)?"store":void 0}:void 0};this._renderPassEncoder=this._renderCommandEncoder.beginRenderPass(a)}else{const s=this._device.defaultRenderPassDesc,i=this._device.defaultRenderPassDesc.colorAttachments[0];this._frameBufferInfo.sampleCount>1?i.resolveTarget=this._device.context.getCurrentTexture().createView():i.view=this._device.context.getCurrentTexture().createView(),i.loadOp=e?"clear":"load",i.clearValue=e;const n=this._device.defaultRenderPassDesc.depthStencilAttachment;n.depthLoadOp="number"==typeof t?"clear":"load",n.depthClearValue=t,n.stencilLoadOp="number"==typeof r?"clear":"load",n.stencilClearValue=r,this._renderPassEncoder=this._renderCommandEncoder.beginRenderPass(s)}this.setViewport(this._currentViewport),this.setScissor(this._currentScissor)}end(){if(this._renderPassEncoder&&(this._renderPassEncoder.end(),this._renderPassEncoder=null),this._renderCommandEncoder&&(this._device.device.queue.submit([this._renderCommandEncoder.finish()]),this._renderCommandEncoder=null),this._frameBufferInfo.frameBuffer){const e=this._frameBufferInfo.frameBuffer.getOptions();if(e.colorAttachments)for(const t of e.colorAttachments)t.texture._markAsCurrentFB(!1),t.generateMipmaps&&t.texture.mipLevelCount>1&&t.texture.generateMipmaps();(e.depthAttachment?.texture)?._markAsCurrentFB(!1)}}capture(e,t,r,s,i,n,a,o,u,h){this.drawInternal(this._renderPassEncoder,t,r,s,i,n,a,o,u,h,e)}drawInternal(e,t,r,s,i,n,a,o,u,h,l){if(this.setBindGroupsForRender(e,t,i,n,l)){const i=this._device.pipelineCache.fetchRenderPipeline(t,r,s,a,this._frameBufferInfo);if(i){e.setPipeline(i),l?.setPipeline(i);const n=s?.stencilState;if(n&&e.setStencilReference(n.ref),r){const s=r.getLayouts(t.vertexAttributes)?.buffers;s?.forEach(((t,r)=>{e.setVertexBuffer(r,t.buffer.object,t.drawOffset),l?.setVertexBuffer(r,t.buffer.object,t.drawOffset)}));const i=r.getIndexBuffer();i?(e.setIndexBuffer(i.object,i.indexType===Pa?"uint16":"uint32"),l?.setIndexBuffer(i.object,i.indexType===Pa?"uint16":"uint32"),e.drawIndexed(u,h,o),l?.drawIndexed(u,h,o)):(e.draw(u,h,o),l?.draw(u,h,o))}else e.draw(u,h,o),l?.draw(u,h,o)}}}validateDraw(e,t){let r=0;if(t)for(let s=0;s<e.bindGroupLayouts.length;s++){const i=t[s];if(!i)return console.error(`Missing bind group (${s}) when drawing with program '${e.name}'`),2;if(i.bindGroup){for(const e of i.bufferList)e.disposed&&(r|=2);for(const e of i.textureList)e.disposed&&(r|=2),e._isMarkedAsCurrentFB()&&(console.error("bind resource texture can not be current render target"),r|=2)}}return this._frameBufferInfo.frameBuffer&&this._frameBufferInfo.frameBuffer.bindFlag!==this._fbBindFlag&&(r|=1),r}setBindGroupsForRender(e,t,r,s,i){if(r)for(let n=0;n<4;n++)if(n<t.bindGroupLayouts.length){const t=r[n].bindGroup;if(!t)return!1;const a=r[n].getDynamicOffsets()??s?.[n];a?(e.setBindGroup(n,t,a),i?.setBindGroup(n,t,a)):(e.setBindGroup(n,t),i?.setBindGroup(n,t))}else e.setBindGroup(n,this._device.emptyBindGroup),i?.setBindGroup(n,this._device.emptyBindGroup);return!0}}class Ua{_device;_computeCommandEncoder;_computePassEncoder;constructor(e,t){this._device=e,this._computeCommandEncoder=this._device.device.createCommandEncoder(),this._computePassEncoder=null}get active(){return!!this._computePassEncoder}compute(e,t,r,s,i,n){if(1&this.validateCompute(e,t))return;this._computePassEncoder||this.begin(),this.setBindGroupsForCompute(this._computePassEncoder,e,t,r);const a=this._device.pipelineCache.fetchComputePipeline(e);a&&(this._computePassEncoder.setPipeline(a),this._computePassEncoder.dispatchWorkgroups(s,i,n))}setBindGroupsForCompute(e,t,r,s){if(r)for(let i=0;i<4;i++)if(i<t.bindGroupLayouts.length){const t=r[i].bindGroup;if(!t)return!1;const n=s?.[i];n?e.setBindGroup(i,t,n):e.setBindGroup(i,t)}else e.setBindGroup(i,this._device.emptyBindGroup);return!0}begin(){this.active?console.error("WebGPUComputePass.begin() failed: WebGPUComputePass.begin() has already been called"):(this._computeCommandEncoder=this._device.device.createCommandEncoder(),this._computePassEncoder=this._computeCommandEncoder.beginComputePass())}end(){this.active&&(this._computePassEncoder.end(),this._computePassEncoder=null,this._device.device.queue.submit([this._computeCommandEncoder.finish()]),this._computeCommandEncoder=null)}validateCompute(e,t){let r=0;if(t)for(let s=0;s<e.bindGroupLayouts.length;s++){const i=t[s];if(!i)return console.error(`Missing bind group (${s}) when compute with program '${e.name}'`),1;if(i.bindGroup){for(const e of i.bufferList)e.disposed&&(r|=1);for(const e of i.textureList)e.disposed&&(r|=1)}}return r}}class za{_renderPass;_computePass;_bufferUploads;_textureUploads;_device;_drawcallCounter;constructor(e){this._device=e,this._bufferUploads=new Map,this._textureUploads=new Map,this._renderPass=new Na(e),this._computePass=new Ua(e),this._drawcallCounter=0}isBufferUploading(e){return!!this._bufferUploads.has(e)}isTextureUploading(e){return!!this._textureUploads.has(e)}flushUploads(){if(this._bufferUploads.size>0||this._textureUploads.size>0){this._drawcallCounter=0;const e=this._bufferUploads;this._bufferUploads=new Map;const t=this._textureUploads;this._textureUploads=new Map;const r=this._device.device.createCommandEncoder();e.forEach(((e,t)=>t.beginSyncChanges(r))),t.forEach(((e,t)=>{t.beginSyncChanges(r),t.isMipmapDirty()&&Ga.generateMipmap(this._device,t,r)})),this._device.device.queue.submit([r.finish()]),e.forEach(((e,t)=>t.endSyncChanges())),t.forEach(((e,t)=>t.endSyncChanges())),this._renderPass.end(),this._computePass.end()}}get currentPass(){return this._renderPass.active?this._renderPass:this._computePass.active?this._computePass:null}beginFrame(){}endFrame(){this.flush()}flush(){this.flushUploads(),this._renderPass.end(),this._computePass.end()}setFramebuffer(e){this.flushUploads(),this._renderPass.setFramebuffer(e)}getFramebuffer(){return this._renderPass.getFramebuffer()}getFramebufferInfo(){return this._renderPass.getFrameBufferInfo()}executeRenderBundle(e){this._computePass.end(),this._renderPass.executeRenderBundle(e)}bufferUpload(e){this._bufferUploads.has(e)?this._drawcallCounter>this._bufferUploads.get(e)&&this.flushUploads():this._bufferUploads.set(e,this._drawcallCounter)}textureUpload(e){this._textureUploads.has(e)?this._drawcallCounter>this._textureUploads.get(e)&&this.flushUploads():this._textureUploads.set(e,this._drawcallCounter)}copyBuffer(e,t,r,s,i){this.flushUploads();const n=this._device.device.createCommandEncoder();n.copyBufferToBuffer(e.object,r,t.object,s,i),this._device.device.queue.submit([n.finish()])}compute(e,t,r,s,i,n){this._drawcallCounter++,this._renderPass.end(),this._computePass.compute(e,t,r,s,i,n)}draw(e,t,r,s,i,n,a,o,u){this._drawcallCounter++,this._computePass.end(),this._renderPass.draw(e,t,r,s,i,n,a,o,u)}capture(e,t,r,s,i,n,a,o,u,h){this._drawcallCounter++,this._computePass.end(),this._renderPass.capture(e,t,r,s,i,n,a,o,u,h)}setViewport(e){this._renderPass.setViewport(e)}getViewport(){return this._renderPass.getViewport()}setScissor(e){this._renderPass.setScissor(e)}getScissor(){return this._renderPass.getScissor()}clear(e,t,r){this._renderPass.clear(e,t,r)}finish(){return this._device.device.queue.onSubmittedWorkDone()}}class ka extends pn{_context;_dpr;_device;_adapter;_deviceCaps;_reverseWindingOrder;_canRender;_backBufferFormat;_depthFormat;_defaultMSAAColorTexture;_defaultMSAAColorTextureView;_defaultDepthTexture;_defaultDepthTextureView;_pipelineCache;_bindGroupCache;_vertexLayoutCache;_samplerCache;_currentProgram;_currentVertexData;_currentStateSet;_currentBindGroups;_currentBindGroupOffsets;_commandQueue;_gpuObjectHashCounter;_gpuObjectHasher;_defaultRenderPassDesc;_sampleCount;_emptyBindGroup;_captureRenderBundle;_adapterInfo;constructor(e,t,r){super(t,e),this._dpr=Math.max(1,Math.floor(r?.dpr??window.devicePixelRatio)),this._device=null,this._adapter=null,this._context=null,this._reverseWindingOrder=!1,this._defaultMSAAColorTexture=null,this._defaultMSAAColorTextureView=null,this._defaultDepthTexture=null,this._defaultDepthTextureView=null,this._pipelineCache=null,this._bindGroupCache=null,this._vertexLayoutCache=null,this._currentProgram=null,this._currentVertexData=null,this._currentStateSet=null,this._currentBindGroups=[],this._currentBindGroupOffsets=[],this._defaultRenderPassDesc=null,this._sampleCount=r?.msaa?4:1,this._deviceCaps=null,this._gpuObjectHasher=new WeakMap,this._gpuObjectHashCounter=1,this._emptyBindGroup=null,this._captureRenderBundle=null,this._samplerCache=new Ra(this),this._adapterInfo={}}get context(){return this._context}getFrameBufferSampleCount(){return this.getFramebuffer()?.getSampleCount()??this._sampleCount}get device(){return this._device}get adapter(){return this._adapter}get commandQueue(){return this._commandQueue}get drawingBufferWidth(){return this.getDrawingBufferWidth()}get drawingBufferHeight(){return this.getDrawingBufferHeight()}get clientWidth(){return this.canvas.clientWidth}get clientHeight(){return this.canvas.clientHeight}get pipelineCache(){return this._pipelineCache}get backbufferFormat(){return this._backBufferFormat}get backbufferDepthFormat(){return this._depthFormat}get defaultDepthTexture(){return this._defaultDepthTexture}get defaultDepthTextureView(){return this._defaultDepthTextureView}get defaultMSAAColorTextureView(){return this._defaultMSAAColorTextureView}get defaultRenderPassDesc(){return this._defaultRenderPassDesc}get sampleCount(){return this._sampleCount}get currentPass(){return this._commandQueue.currentPass}get emptyBindGroup(){return this._emptyBindGroup}getScale(){return this._dpr}getAdapterInfo(){return this._adapterInfo}isContextLost(){return!1}getDeviceCaps(){return this._deviceCaps}getDrawingBufferWidth(){return this.getFramebuffer()?.getWidth()||this.canvas.width}getDrawingBufferHeight(){return this.getFramebuffer()?.getHeight()||this.canvas.height}getBackBufferWidth(){return this.canvas.width}getBackBufferHeight(){return this.canvas.height}async initContext(){if(!navigator.gpu)throw new Error("No browser support for WebGPU");if(this._adapter=await navigator.gpu.requestAdapter(),!this._adapter)throw new Error("WebGPU: requestAdapter() failed");this._adapter.isFallbackAdapter&&console.warn("using a fallback adapter"),this._adapterInfo=this._adapter.requestAdapterInfo?await this._adapter.requestAdapterInfo():{},this._device=await this._adapter.requestDevice({requiredFeatures:[...this._adapter.features],requiredLimits:{...this._adapter.limits}}),console.log("WebGPU device features:");for(const e of this._device.features)console.log(` - ${e}`);if(this.device.lost.then((e=>{console.error(`WebGPU device was lost: ${e.message}`),this._canRender=!1})),this._emptyBindGroup=this.device.createBindGroup({layout:this.device.createBindGroupLayout({entries:[]}),entries:[]}),this._context=this.canvas.getContext("webgpu")||null,!this._context)throw this._canRender=!1,new Error("WebGPU: getContext() failed");this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this._deviceCaps={textureCaps:new _a(this),framebufferCaps:new fa(this),miscCaps:new da(this),shaderCaps:new ma(this)},this.configure(),this._pipelineCache=new Aa(this),this._bindGroupCache=new Oa(this),this._vertexLayoutCache=new Fa,this._commandQueue=new za(this),this._canRender=!0,this.setViewport(null),this.setScissor(null),this.on("resize",(e=>{const t=Math.max(1,Math.round(this.canvas.clientWidth*this._dpr)),r=Math.max(1,Math.round(this.canvas.clientHeight*this._dpr));t===this.canvas.width&&r===this.canvas.height||(this.canvas.width=t,this.canvas.height=r,this.createDefaultRenderAttachments(),this.setViewport(null),this.setScissor(null))})),this.dispatchEvent(new M(this.canvas.clientWidth,this.canvas.clientHeight))}nextFrame(e){return this._commandQueue.finish().then(e),0}cancelNextFrame(e){}clearFrameBuffer(e,t,r){this._commandQueue.clear(e,t,r)}createGPUTimer(){return null}createRenderStateSet(){return new Ea(this)}createSampler(e){return this.fetchSampler(e)}createTextureFromMipmapData(e,t,r){if(!e)return console.error("Device.createTextureFromMipmapData() failed: invalid data"),null;if(e.isCubemap){const s=new ca(this);return s.createWithMipmapData(e,t,this.parseTextureOptions(r)),s}if(e.isVolume){const t=new la(this);return t.createWithMipmapData(e,this.parseTextureOptions(r)),t}if(e.isArray){const t=new ha(this);return t.createWithMipmapData(e,this.parseTextureOptions(r)),t}{const s=new ua(this);return s.createWithMipmapData(e,t,this.parseTextureOptions(r)),s}}createTexture2D(e,t,r,s){const i=s?.texture??new ua(this);return i.isTexture2D()?(i.createEmpty(e,t,r,this.parseTextureOptions(s)),i.samplerOptions=s?.samplerOptions??null,i):(console.error("createTexture2D() failed: options.texture must be 2d texture"),null)}createTexture2DFromMipmapData(e,t,r){const s=r?.texture??new ua(this);return s.isTexture2D()?(s.createWithMipmapData(e,t,this.parseTextureOptions(r)),s.samplerOptions=r?.samplerOptions??null,s):(console.error("createTexture2DFromMipmapData() failed: options.texture must be 2d texture"),null)}createTexture2DFromImage(e,t,r){const s=r?.texture??new ua(this);return s.isTexture2D()?(s.loadFromElement(e,t,this.parseTextureOptions(r)),s.samplerOptions=r?.samplerOptions??null,s):(console.error("createTexture2DFromImage() failed: options.texture must be 2d texture"),null)}createTexture2DArray(e,t,r,s,i){const n=i?.texture??new ha(this);return n.isTexture2DArray()?(n.createEmpty(e,t,r,s,this.parseTextureOptions(i)),n.samplerOptions=i?.samplerOptions??null,n):(console.error("createTexture2DArray() failed: options.texture must be 2d array texture"),null)}createTexture2DArrayFromMipmapData(e,t){const r=t?.texture??new ha(this);return r.isTexture2DArray()?(r.createWithMipmapData(e,this.parseTextureOptions(t)),r.samplerOptions=t?.samplerOptions??null,r):(console.error("createTexture2DArrayFromMipmapData() failed: options.texture must be 2d array texture"),null)}createTexture2DArrayFromImages(e,t,r){if(!e||0===e.length)return console.error("createTexture2DArrayFromImages() failed: Invalid image elements"),null;let s=0,i=0;for(const t of e)if(0===s||0===i)s=t.width,i=t.height;else if(s!==t.width||i!==t.height)return console.error("createTexture2DArrayFromImages() failed: Image elements must have the same size"),null;if(r?.texture&&!r.texture.isTexture2DArray())return console.error("createTexture2DArrayFromImages() failed: options.texture must be 2d array texture"),null;let n=r?.texture;if(n){if(n.depth!==e.length)return console.error("createTexture2DArrayFromImages() failed: Layer count of options.texture not match the given image elements"),null;if(n.width!==s||n.height!==i)return console.error("createTexture2DArrayFromImages() failed: Size of options.texture not match the given image elements"),null}else{n=this.createTexture2DArray(t?"rgba8unorm-srgb":"rgba8unorm",s,i,e.length,r);for(let t=0;t<e.length;t++)n.updateFromElement(e[t],0,0,t,0,0,s,i)}return n.samplerOptions=r?.samplerOptions??null,n}createTexture3D(e,t,r,s,i){const n=i?.texture??new la(this);return n.isTexture3D()?(n.createEmpty(e,t,r,s,this.parseTextureOptions(i)),n.samplerOptions=i?.samplerOptions??null,n):(console.error("createTexture3D() failed: options.texture must be 3d texture"),null)}createCubeTexture(e,t,r){const s=r?.texture??new ca(this);return s.isTextureCube()?(s.createEmpty(e,t,this.parseTextureOptions(r)),s.samplerOptions=r?.samplerOptions??null,s):(console.error("createCubeTexture() failed: options.texture must be cube texture"),null)}createCubeTextureFromMipmapData(e,t,r){const s=r?.texture??new ca(this);return s.isTextureCube()?(s.createWithMipmapData(e,t,this.parseTextureOptions(r)),s.samplerOptions=r?.samplerOptions??null,s):(console.error("createCubeTextureFromMipmapData() failed: options.texture must be cube texture"),null)}createTextureVideo(e,t){const r=new pa(this,e);return r.samplerOptions=t??null,r}createGPUProgram(e){return new _n(this,e)}createBindGroup(e){return new jn(this,e)}createBuffer(e,t){return new xn(this,this.parseBufferOptions(t),e)}copyBuffer(e,t,r,s,i){this._commandQueue.copyBuffer(e,t,r,s,i)}createIndexBuffer(e,t){return new Da(this,e,this.parseBufferOptions(t,"index"))}createStructuredBuffer(e,t,r){return new Yn(this,e,this.parseBufferOptions(t),r)}createVertexLayout(e){return new ga(this,e)}createFrameBuffer(e,t,r){return new La(this,e,t,r)}setBindGroup(e,t,r){this._currentBindGroups[e]=t,this._currentBindGroupOffsets[e]=r??t?.getDynamicOffsets()??null}getBindGroup(e){return[this._currentBindGroups[e],this._currentBindGroupOffsets[e]]}setViewport(e){this._commandQueue.setViewport(e)}getViewport(){return this._commandQueue.getViewport()}setScissor(e){this._commandQueue.setScissor(e)}getScissor(){return this._commandQueue.getScissor()}setProgram(e){this._currentProgram=e}getProgram(){return this._currentProgram}setVertexLayout(e){this._currentVertexData=e}getVertexLayout(){return this._currentVertexData}setRenderStates(e){this._currentStateSet=e}getRenderStates(){return this._currentStateSet}getFramebuffer(){return this._commandQueue.getFramebuffer()??null}reverseVertexWindingOrder(e){this._reverseWindingOrder=!!e}isWindingOrderReversed(){return this._reverseWindingOrder}isBufferUploading(e){return this._commandQueue.isBufferUploading(e)}isTextureUploading(e){return this._commandQueue.isTextureUploading(e)}getFramebufferInfo(){return this._commandQueue.getFramebufferInfo()}gpuGetObjectHash(e){return this._gpuObjectHasher.get(e)}gpuCreateTexture(e){const t=this._device.createTexture(e);return t&&this._gpuObjectHasher.set(t,++this._gpuObjectHashCounter),t}gpuImportExternalTexture(e){const t=this._device.importExternalTexture({source:e});return t&&this._gpuObjectHasher.set(t,++this._gpuObjectHashCounter),t}gpuCreateSampler(e){const t=this._device.createSampler(e);return t&&this._gpuObjectHasher.set(t,++this._gpuObjectHashCounter),t}gpuCreateBindGroup(e){const t=this._device.createBindGroup(e);return t&&this._gpuObjectHasher.set(t,++this._gpuObjectHashCounter),t}gpuCreateBuffer(e){const t=this._device.createBuffer(e);return t&&this._gpuObjectHasher.set(t,++this._gpuObjectHashCounter),t}gpuCreateTextureView(e,t){const r=e?.createView(t);return r&&this._gpuObjectHasher.set(r,++this._gpuObjectHashCounter),r}gpuCreateRenderPipeline(e){const t=this._device.createRenderPipeline(e);return t&&this._gpuObjectHasher.set(t,++this._gpuObjectHashCounter),t}gpuCreateComputePipeline(e){const t=this._device.createComputePipeline(e);return t&&this._gpuObjectHasher.set(t,++this._gpuObjectHashCounter),t}fetchVertexLayout(e){return this._vertexLayoutCache.fetchVertexLayout(e)}fetchSampler(e){return this._samplerCache.fetchSampler(e)}fetchBindGroupLayout(e){return this._bindGroupCache.fetchBindGroupLayout(e)}flush(){this._commandQueue.flush()}async readPixels(e,t,r,s,i,n){const a=this.getFramebuffer(),o=a?a.getColorAttachments()[e]?.object:this.context.getCurrentTexture(),u=a?a.getColorAttachments()[e]?.format:na[this._backBufferFormat];if(o&&u){const e=s*i*B(u),a=this.createBuffer(e,{usage:"read"});this.readPixelsToBuffer(0,t,r,s,i,a);const o=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);await a.getBufferSubData(o),a.dispose()}else console.error("readPixels() failed: no color attachment0 or unrecoganized color attachment format")}readPixelsToBuffer(e,t,r,s,i,n){const a=this.getFramebuffer(),o=a?a.getColorAttachments()[e]?.object:this.context.getCurrentTexture(),u=a?a.getColorAttachments()[e]?.format:na[this._backBufferFormat],h=a?a.getColorAttachments()[e]?.width:this.getDrawingBufferWidth(),l=a?a.getColorAttachments()[e]?.height:this.getDrawingBufferHeight();o&&u?(this.flush(),oa.copyTexturePixelsToBuffer(this._device,o,h,l,u,t,r,s,i,0,0,n)):console.error("readPixelsToBuffer() failed: no color attachment0 or unrecoganized color attachment format")}looseContext(){}restoreContext(){}beginCapture(){if(this._captureRenderBundle)throw new Error("Device.beginCapture() failed: device is already capturing draw commands");const e=this.getFramebufferInfo(),t={colorFormats:e.colorFormats,depthStencilFormat:e.depthFormat,sampleCount:e.sampleCount};this._captureRenderBundle=this._device.createRenderBundleEncoder(t)}endCapture(){if(!this._captureRenderBundle)throw new Error("Device.endCapture() failed: device is not capturing draw commands");const e=this._captureRenderBundle.finish();return this._captureRenderBundle=null,e}executeRenderBundle(e){this._commandQueue.executeRenderBundle(e)}bufferUpload(e){this._commandQueue.bufferUpload(e)}textureUpload(e){this._commandQueue.textureUpload(e)}flushUploads(){this._commandQueue.flushUploads()}_setFramebuffer(e){this._commandQueue.setFramebuffer(e)}onBeginFrame(){return!!this._canRender&&(this._commandQueue.beginFrame(),!0)}onEndFrame(){this._commandQueue.endFrame()}_draw(e,t,r){this._commandQueue.draw(this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,e,t,r,1),this._captureRenderBundle&&this._commandQueue.capture(this._captureRenderBundle,this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,e,t,r,1)}_drawInstanced(e,t,r,s){this._commandQueue.draw(this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,e,t,r,s),this._captureRenderBundle&&this._commandQueue.capture(this._captureRenderBundle,this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,e,t,r,s)}_compute(e,t,r){this._commandQueue.compute(this._currentProgram,this._currentBindGroups,this._currentBindGroupOffsets,e,t,r)}configure(){this._backBufferFormat=navigator.gpu.getPreferredCanvasFormat(),this._depthFormat=this._deviceCaps.framebufferCaps.supportDepth32floatStencil8?"depth32float-stencil8":"depth24plus-stencil8",this._context.configure({device:this._device,format:this._backBufferFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:"opaque",colorSpace:"srgb"}),this.createDefaultRenderAttachments()}createDefaultRenderAttachments(){const e=Math.max(1,this.canvas.width),t=Math.max(1,this.canvas.height);this._defaultMSAAColorTexture?.destroy(),this._defaultMSAAColorTexture=null,this._defaultMSAAColorTextureView=null,this._defaultDepthTexture?.destroy(),this._defaultDepthTexture=null,this._defaultDepthTextureView=null,this._sampleCount>1&&(this._defaultMSAAColorTexture=this.gpuCreateTexture({size:{width:e,height:t,depthOrArrayLayers:1},format:this._backBufferFormat,dimension:"2d",mipLevelCount:1,sampleCount:this._sampleCount,usage:GPUTextureUsage.RENDER_ATTACHMENT}),this._defaultMSAAColorTextureView=this._defaultMSAAColorTexture.createView()),this._defaultDepthTexture=this.gpuCreateTexture({size:{width:e,height:t,depthOrArrayLayers:1},format:this._depthFormat,dimension:"2d",mipLevelCount:1,sampleCount:this._sampleCount,usage:GPUTextureUsage.RENDER_ATTACHMENT}),this._defaultDepthTextureView=this._defaultDepthTexture.createView(),this._defaultRenderPassDesc={label:`mainRenderPass:${this._sampleCount}`,colorAttachments:[{view:this._sampleCount>1?this._defaultMSAAColorTextureView:null,resolveTarget:void 0,loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}],depthStencilAttachment:{view:this._defaultDepthTextureView,depthLoadOp:"clear",depthClearValue:1,depthStoreOp:"store",stencilLoadOp:"clear",stencilClearValue:0,stencilStoreOp:"store"}}}}const Wa={typeName:()=>"webgpu",supported:()=>!!window.GPU&&navigator.gpu instanceof window.GPU,async createDevice(e,r){try{const s=new(t(ka)())(this,e,r);return await s.initContext(),s.setViewport(),s.setScissor(),s}catch(e){return console.error(e),null}}};!async function(){if(!Wa.supported())return void alert("Error: Browser does not support WebGPU.");const e=document.querySelector("#canvas"),t=await Wa.createDevice(e),r=t.buildRenderProgram({label:"spriteRender",vertex(e){this.$inputs.pos=e.vec2().attrib("position"),this.$inputs.instPos=e.vec2().attrib("texCoord0"),this.$inputs.instVel=e.vec2().attrib("texCoord1"),e.main((function(){this.angle=e.neg(e.atan2(this.$inputs.instVel.x,this.$inputs.instVel.y)),this.c=e.cos(this.angle),this.s=e.sin(this.angle),this.x=e.sub(e.mul(this.$inputs.pos.x,this.c),e.mul(this.$inputs.pos.y,this.s)),this.y=e.add(e.mul(this.$inputs.pos.x,this.s),e.mul(this.$inputs.pos.y,this.c)),this.$builtins.position=e.vec4(e.add(this.$inputs.instPos,e.vec2(this.x,this.y)),0,1)}))},fragment(e){this.$outputs.color=e.vec4(),e.main((function(){this.$outputs.color=e.vec4(1)}))}}),s=t.buildComputeProgram({label:"spriteUpdate",workgroupSize:[64,1,1],compute(e){const t=e.defineStruct([e.vec2("pos"),e.vec2("vel")],"Particle"),r=e.defineStruct([e.float("deltaT"),e.float("rule1Distance"),e.float("rule2Distance"),e.float("rule3Distance"),e.float("rule1Scale"),e.float("rule2Scale"),e.float("rule3Scale")],"SimParams");this.params=r().uniformBuffer(0),this.particlesA=t[0]().storageBuffer(0),this.particlesB=t[0]().storageBuffer(0),e.main((function(){this.index=this.$builtins.globalInvocationId.x,this.vPos=this.particlesA.at(this.index).pos,this.vVel=this.particlesA.at(this.index).vel,this.cMass=e.vec2(0),this.cVel=e.vec2(0),this.colVel=e.vec2(0),this.cMassCount=e.uint(0),this.cVelCount=e.uint(0),this.pos=e.vec2(),this.vel=e.vec2(),this.$for(e.uint("i"),0,e.arrayLength(this.particlesA),(function(){this.$if(e.equal(this.i,this.index),(function(){this.$continue()})),this.pos=this.particlesA.at(this.i).pos.xy,this.vel=this.particlesA.at(this.i).vel.xy,this.$if(e.lessThan(e.distance(this.pos,this.vPos),this.params.rule1Distance),(function(){this.cMass=e.add(this.cMass,this.pos),this.cMassCount=e.add(this.cMassCount,1)})),this.$if(e.lessThan(e.distance(this.pos,this.vPos),this.params.rule2Distance),(function(){this.colVel=e.sub(this.colVel,e.sub(this.pos,this.vPos))})),this.$if(e.lessThan(e.distance(this.pos,this.vPos),this.params.rule3Distance),(function(){this.cVel=e.add(this.cVel,this.vel),this.cVelCount=e.add(this.cVelCount,1)}))})),this.$if(e.greaterThan(this.cMassCount,0),(function(){this.temp=e.float(this.cMassCount),this.cMass=e.sub(e.div(this.cMass,e.vec2(this.temp)),this.vPos)})),this.$if(e.greaterThan(this.cVelCount,0),(function(){this.temp=e.float(this.cVelCount),this.cVel=e.div(this.cVel,e.vec2(this.temp))})),this.vVel=e.add(this.vVel,e.mul(this.cMass,this.params.rule1Scale)),this.vVel=e.add(this.vVel,e.mul(this.colVel,this.params.rule2Scale)),this.vVel=e.add(this.vVel,e.mul(this.cVel,this.params.rule3Scale)),this.vVel=e.mul(e.normalize(this.vVel),e.clamp(e.length(this.vVel),0,.1)),this.vPos=e.add(this.vPos,e.mul(this.vVel,this.params.deltaT)),this.$if(e.lessThan(this.vPos.x,-1),(function(){this.vPos.x=1})),this.$if(e.greaterThan(this.vPos.x,1),(function(){this.vPos.x=-1})),this.$if(e.lessThan(this.vPos.y,-1),(function(){this.vPos.y=1})),this.$if(e.greaterThan(this.vPos.y,1),(function(){this.vPos.y=-1})),this.particlesB.at(this.index).pos=this.vPos,this.particlesB.at(this.index).vel=this.vVel}))}});console.log(s.getShaderSource("compute")),console.log(s.bindGroupLayouts[0]);const i=t.createVertexBuffer("position_f32x2",new Float32Array([-.01,-.02,.01,-.02,0,.02])),n={deltaT:.04,rule1Distance:.1,rule2Distance:.025,rule3Distance:.025,rule1Scale:.02,rule2Scale:.05,rule3Scale:.005},a=s.createUniformBuffer("params"),o=1500,u=new Float32Array(6e3);for(let e=0;e<o;++e)u[4*e+0]=2*(Math.random()-.5),u[4*e+1]=2*(Math.random()-.5),u[4*e+2]=2*(Math.random()-.5)*.1,u[4*e+3]=2*(Math.random()-.5)*.1;const h=[],c=[],p=[];for(let e=0;e<2;e++)h.push(t.createInterleavedVertexBuffer(["tex0_f32x2","tex1_f32x2"],u,{storage:!0}));for(let e=0;e<2;e++){const r=t.createBindGroup(s.bindGroupLayouts[0]);r.setBuffer("params",a),r.setBuffer("particlesA",h[e]),r.setBuffer("particlesB",h[(e+1)%2]),c.push(r);const n=t.createVertexLayout({vertexBuffers:[{buffer:i,stepMode:"vertex"},{buffer:h[e],stepMode:"instance"}]});p.push(n)}!function(){for(const e in n)a.set(e,n[e])}();let f=0;t.runLoop((e=>{e.setProgram(s),e.setBindGroup(0,c[f%2]),e.compute(Math.ceil(23.4375),1,1),e.clearFrameBuffer(new l(0,0,0,1),1,0),e.setProgram(r),p[(f+1)%2].drawInstanced("triangle-list",0,3,o),f++,e.drawText(`Device: ${e.type}`,30,30,"#ffffff"),e.drawText(`FPS: ${e.frameInfo.FPS.toFixed(2)}`,30,50,"#ffff00")}))}();
//# sourceMappingURL=sample-4.js.map
