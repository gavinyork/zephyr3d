const t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32",transparent:"rgba(0,0,0,0)"};function e(t){return function(){return class extends t{_listeners;constructor(...t){super(...t),this._listeners=null}on(t,e,i){this._listeners=this._internalAddEventListener(this._listeners,t,e,{context:i})}once(t,e,i){this._listeners=this._internalAddEventListener(this._listeners,t,e,{context:i,once:!0})}off(t,e){this._internalRemoveEventListener(this._listeners,t,e)}dispatchEvent(t,e){this._invokeLocalListeners(t,e)}_internalAddEventListener(t,e,i,s){if("string"!=typeof e)return;t||(t={});const r=i,a={once:!!s?.once,context:s?.context};let n=t[e];return n||(t[e]=n=[]),n.push({handler:r,options:a,removed:!1}),t}_internalRemoveEventListener(t,e,i){if("string"!=typeof e||!t)return;const s=i,r=t[e];if(r)for(let t=0;t<r.length;t++){if(r[t].handler===s){r.splice(t,1);break}}0===r.length&&delete t[e]}_invokeLocalListeners(t,e){if(!this._listeners)return;const i=this._listeners[e??t?.type];if(i&&i.length>0){const e=i.slice();for(const i of e)i.handler.call(i.options?.context||this,t),i.options.once&&(i.removed=!0);for(let t=i.length-1;t>=0;t--)i[t].removed&&i.splice(t,1)}}}}}class i{_node;_reverse;_dl;constructor(t,e,i){this._dl=t,this._node=e,this._reverse=i}valid(){return this._node!==this._dl.head}next(){if(!this.valid())throw new Error("ListIterator.next(): iterator is invalid");return this._node=this._reverse?this._node.prev:this._node.next,this}getNext(){if(!this.valid())throw new Error("ListIterator.getNext(): iterator is invalid");return new i(this._dl,this._reverse?this._node.prev:this._node.next,this._reverse)}prev(){if(!this.valid())throw new Error("ListIterator.prev(): iterator is invalid");return this._node=this._reverse?this._node.next:this._node.prev,this}getPrev(){if(!this.valid())throw new Error("ListIterator.getPrev(): iterator is invalid");return new i(this._dl,this._reverse?this._node.next:this._node.prev,this._reverse)}get node(){return this._node}set node(t){this._node=t}get reversed(){return this._reverse}get list(){return this._dl}get data(){if(!this.valid())throw new Error("ListIterator.data: iterator is invalid");return this._node.data}set data(t){this.valid()&&(this._node.data=t)}}class s{_head;_length;constructor(){this._head=new r,this._length=0}get head(){return this._head}get length(){return this._length}clear(){for(;this._length>0;)this.remove(this.begin())}append(t){return this._insertAt(t,this._head)}prepend(t){return this._insertAt(t,this._head.next)}remove(t){if(t.valid()&&t.list===this){const e=t.node;t.next(),this._remove(e)}}insert(t,e){return e.list===this?e.valid()?e.reversed?this._insertAt(t,e.node.next):this._insertAt(t,e.node):this.append(t):null}forEach(t){if(t)for(let e=this.begin();e.valid();e.next())t(e.data)}forEachReverse(t){if(t)for(let e=this.rbegin();e.valid();e.next())t(e.data)}front(){if(0===this.length)throw new Error("List.front(): list is empty");return this.begin().data}back(){if(0===this.length)throw new Error("List.back(): list is empty");return this.rbegin().data}begin(){return new i(this,this._length>0?this._head.next:this._head,!1)}end(){return new i(this,this._head,!1)}rbegin(){return new i(this,this._length>0?this._head.prev:this._head,!0)}rend(){return new i(this,this._head,!0)}_remove(t){t.prev.next=t.next,t.next.prev=t.prev,delete t.prev,delete t.next,this._length--}_insertAt(t,e){const s=new a(t);return s.next=e,s.prev=e.prev,e.prev.next=s,e.prev=s,this._length++,new i(this,s,!1)}}class r{next;prev;constructor(){this.next=this,this.prev=this}}class a extends r{data;constructor(t){super(),this.data=t}}const n=new ArrayBuffer(4),o=new Float32Array(n);function h(t){return o[0]=t,o[0]}function u(t){return t%1==0&&t>=0&&0==(t&t-1)}var l,c,d;!function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.TOP=3]="TOP",t[t.FRONT=4]="FRONT",t[t.BACK=5]="BACK"}(l||(l={})),function(t){t[t.NOT_CLIPPED=0]="NOT_CLIPPED",t[t.A_INSIDE_B=1]="A_INSIDE_B",t[t.B_INSIDE_A=2]="B_INSIDE_A",t[t.CLIPPED=2]="CLIPPED"}(c||(c={})),function(t){t[t.PX=0]="PX",t[t.NX=1]="NX",t[t.PY=2]="PY",t[t.NY=3]="NY",t[t.PZ=4]="PZ",t[t.NZ=5]="NZ"}(d||(d={}));const p=new Float32Array([1,0,0,0,1,0,0,0,1]),_=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class m extends Float32Array{equalsTo(t,e){if(!t||this.length!==t.length)return!1;if(this===t)return!0;for(let i=0;i<this.length;i++){const s=this[i],r=t[i],a=e??1e-4*Math.max(1,Math.abs(s),Math.abs(r));if(Math.abs(s-r)>a)return!1}return!0}toString(){const t=[...this].map((t=>t.toFixed(3)));return`${this.constructor.name}{${t.join(",")}}`}isNaN(){for(let t=0;t<this.length;t++)if(Number.isNaN(this[t]))return!0;return!1}}class f extends m{constructor(t,e){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,2);else if(super(2),"number"==typeof t&&"number"==typeof e)this[0]=t,this[1]=e;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=2)this[0]=t[0],this[1]=t[1];else if(void 0!==t)throw new Error("Vector2.constructor(): invalid arguments")}clone(){return new f(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]}setXY(t,e){return this[0]=t,this[1]=e,this}setAndNormalize(t,e){const i=Math.sqrt(t*t+e*e);return this.setXY(t/i,e/i)}subBy(t){return f.sub(this,t,this)}addBy(t){return f.add(this,t,this)}mulBy(t){return f.mul(this,t,this)}divBy(t){return f.div(this,t,this)}scaleBy(t){return f.scale(this,t,this)}inplaceNormalize(){return f.normalize(this,this)}inplaceInverse(){return f.inverse(this,this)}inplaceMin(t){return f.min(this,t,this)}inplaceMax(t){return f.max(this,t,this)}static zero(){return new f(0,0)}static one(){return new f(1,1)}static axisPX(){return new f(1,0)}static axisNX(){return new f(-1,0)}static axisPY(){return new f(0,1)}static axisNY(){return new f(0,-1)}static distance(t,e){return Math.sqrt(this.distanceSq(t,e))}static distanceSq(t,e){const i=t.x-e.x,s=t.y-e.y;return i*i+s*s}static normalize(t,e){const i=t.magnitude,s=t.x/i,r=t.y/i;return(e||new f).setXY(s,r)}static inverse(t,e){const i=1/t.x,s=1/t.y;return(e||new f).setXY(i,s)}static sub(t,e,i){const s=t.x-e.x,r=t.y-e.y;return(i||new f).setXY(s,r)}static add(t,e,i){const s=t.x+e.x,r=t.y+e.y;return(i||new f).setXY(s,r)}static mul(t,e,i){const s=t.x*e.x,r=t.y*e.y;return(i||new f).setXY(s,r)}static div(t,e,i){const s=t.x/e.x,r=t.y/e.y;return(i||new f).setXY(s,r)}static scale(t,e,i){const s=t.x*e,r=t.y*e;return(i||new f).setXY(s,r)}static min(t,e,i){const s=t.x<e.x?t.x:e.x,r=t.y<e.y?t.y:e.y;return(i||new f).setXY(s,r)}static max(t,e,i){const s=t.x>e.x?t.x:e.x,r=t.y>e.y?t.y:e.y;return(i||new f).setXY(s,r)}static abs(t,e){const i=t.x<0?-t.x:t.x,s=t.y<0?-t.y:t.y;return(e||new f).setXY(i,s)}static dot(t,e){return t.x*e.x+t.y*e.y}static cross(t,e){return t.x*e.y-t.y*e.x}}class g extends m{constructor(t,e,i){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,3);else if(super(3),"number"==typeof t&&"number"==typeof e&&"number"==typeof i)this[0]=t,this[1]=e,this[2]=i;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=3)this[0]=t[0],this[1]=t[1],this[2]=t[2];else if(void 0!==t)throw new Error("Vector3.constructor(): invalid arguments")}clone(){return new g(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]}xy(){return new f(this.x,this.y)}setXYZ(t,e,i){return this[0]=t,this[1]=e,this[2]=i,this}setAndNormalize(t,e,i){const s=Math.sqrt(t*t+e*e+i*i);return this.setXYZ(t/s,e/s,i/s)}subBy(t){return g.sub(this,t,this)}addBy(t){return g.add(this,t,this)}mulBy(t){return g.mul(this,t,this)}divBy(t){return g.div(this,t,this)}scaleBy(t){return g.scale(this,t,this)}inplaceNormalize(){return g.normalize(this,this)}inplaceInverse(){return g.inverse(this,this)}inplaceMin(t){return g.min(this,t,this)}inplaceMax(t){return g.max(this,t,this)}static zero(){return new g(0,0,0)}static one(){return new g(1,1,1)}static axisPX(){return new g(1,0,0)}static axisNX(){return new g(-1,0,0)}static axisPY(){return new g(0,1,0)}static axisNY(){return new g(0,-1,0)}static axisPZ(){return new g(0,0,1)}static axisNZ(){return new g(0,0,-1)}static distance(t,e){return Math.sqrt(this.distanceSq(t,e))}static distanceSq(t,e){const i=t.x-e.x,s=t.y-e.y,r=t.z-e.z;return i*i+s*s+r*r}static normalize(t,e){const i=t.magnitude,s=t.x/i,r=t.y/i,a=t.z/i;return(e||new g).setXYZ(s,r,a)}static inverse(t,e){const i=1/t.x,s=1/t.y,r=1/t.z;return(e||new g).setXYZ(i,s,r)}static sub(t,e,i){const s=t.x-e.x,r=t.y-e.y,a=t.z-e.z;return(i||new g).setXYZ(s,r,a)}static add(t,e,i){const s=t.x+e.x,r=t.y+e.y,a=t.z+e.z;return(i||new g).setXYZ(s,r,a)}static mul(t,e,i){const s=t.x*e.x,r=t.y*e.y,a=t.z*e.z;return(i||new g).setXYZ(s,r,a)}static div(t,e,i){const s=t.x/e.x,r=t.y/e.y,a=t.z/e.z;return(i||new g).setXYZ(s,r,a)}static scale(t,e,i){const s=t.x*e,r=t.y*e,a=t.z*e;return(i||new g).setXYZ(s,r,a)}static min(t,e,i){const s=t.x<e.x?t.x:e.x,r=t.y<e.y?t.y:e.y,a=t.z<e.z?t.z:e.z;return(i||new g).setXYZ(s,r,a)}static max(t,e,i){const s=t.x>e.x?t.x:e.x,r=t.y>e.y?t.y:e.y,a=t.z>e.z?t.z:e.z;return(i||new g).setXYZ(s,r,a)}static abs(t,e){const i=t.x<0?-t.x:t.x,s=t.y<0?-t.y:t.y,r=t.z<0?-t.z:t.z;return(e||new g).setXYZ(i,s,r)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e,i){const s=t.y*e.z-t.z*e.y,r=t.z*e.x-t.x*e.z,a=t.x*e.y-t.y*e.x;return(i||new g).setXYZ(s,r,a)}}class x extends g{_callback;get callback(){return this._callback}set callback(t){this._callback=t}get x(){return super.x}set x(t){(t=h(t))!==super.x&&(super.x=t,this._callback&&this._callback())}get y(){return super.y}set y(t){(t=h(t))!==super.y&&(super.y=t,this._callback&&this._callback())}get z(){return super.z}set z(t){(t=h(t))!==super.z&&(super.z=t,this._callback&&this._callback())}setXYZ(t,e,i){return t=h(t),e=h(e),i=h(i),t===super.x&&e===super.y&&i===super.z||(super.setXYZ(t,e,i),this._callback&&this._callback()),this}copyWithin(t,e,i){return super.copyWithin(t,e,i),this._callback&&this._callback(),this}fill(t,e,i){return super.fill(t,e,i),this._callback&&this._callback(),this}reverse(){return super.reverse(),this._callback&&this._callback(),this}set(t,e){super.set(t,e),this._callback&&this._callback()}sort(t){return super.sort(t),this._callback&&this._callback(),this}}class T extends m{constructor(t,e,i,s){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,4);else if(super(4),"number"==typeof t&&"number"==typeof e&&"number"==typeof i&&"number"==typeof s)this[0]=t,this[1]=e,this[2]=i,this[3]=s;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=4)this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3];else if(void 0!==t)throw new Error("Vector4.constructor(): invalid arguments")}clone(){return new T(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3]}xy(){return new f(this.x,this.y)}xyz(){return new g(this.x,this.y,this.z)}setXYZW(t,e,i,s){return this[0]=t,this[1]=e,this[2]=i,this[3]=s,this}setAndNormalize(t,e,i,s){const r=Math.sqrt(t*t+e*e+i*i+s*s);return this.setXYZW(t/r,e/r,i/r,s/r)}subBy(t){return T.sub(this,t,this)}addBy(t){return T.add(this,t,this)}mulBy(t){return T.mul(this,t,this)}divBy(t){return T.div(this,t,this)}scaleBy(t){return T.scale(this,t,this)}inplaceNormalize(){return T.normalize(this,this)}inplaceInverse(){return T.inverse(this,this)}inplaceMin(t){return T.min(this,t,this)}inplaceMax(t){return T.max(this,t,this)}static zero(){return new T(0,0,0,0)}static one(){return new T(1,1,1,1)}static axisPX(){return new T(1,0,0,0)}static axisNX(){return new T(-1,0,0,0)}static axisPY(){return new T(0,1,0,0)}static axisNY(){return new T(0,-1,0,0)}static axisPZ(){return new T(0,0,1,0)}static axisNZ(){return new T(0,0,-1,0)}static axisPW(){return new T(0,0,0,1)}static axisNW(){return new T(0,0,0,-1)}static normalize(t,e){const i=t.magnitude,s=t.x/i,r=t.y/i,a=t.z/i,n=t.w/i;return(e||new T).setXYZW(s,r,a,n)}static inverse(t,e){const i=1/t.x,s=1/t.y,r=1/t.z,a=1/t.w;return(e||new T).setXYZW(i,s,r,a)}static sub(t,e,i){const s=t.x-e.x,r=t.y-e.y,a=t.z-e.z,n=t.w-e.w;return(i||new T).setXYZW(s,r,a,n)}static add(t,e,i){const s=t.x+e.x,r=t.y+e.y,a=t.z+e.z,n=t.w+e.w;return(i||new T).setXYZW(s,r,a,n)}static mul(t,e,i){const s=t.x*e.x,r=t.y*e.y,a=t.z*e.z,n=t.w*e.w;return(i||new T).setXYZW(s,r,a,n)}static div(t,e,i){const s=t.x/e.x,r=t.y/e.y,a=t.z/e.z,n=t.w/e.w;return(i||new T).setXYZW(s,r,a,n)}static scale(t,e,i){const s=t.x*e,r=t.y*e,a=t.z*e,n=t.w*e;return(i||new T).setXYZW(s,r,a,n)}static min(t,e,i){const s=t.x<e.x?t.x:e.x,r=t.y<e.y?t.y:e.y,a=t.z<e.z?t.z:e.z,n=t.w<e.w?t.w:e.w;return(i||new T).setXYZW(s,r,a,n)}static max(t,e,i){const s=t.x>e.x?t.x:e.x,r=t.y>e.y?t.y:e.y,a=t.z>e.z?t.z:e.z,n=t.w>e.w?t.w:e.w;return(i||new T).setXYZW(s,r,a,n)}static abs(t,e){const i=t.x<0?-t.x:t.x,s=t.y<0?-t.y:t.y,r=t.z<0?-t.z:t.z,a=t.w<0?-t.w:t.w;return(e||new T).setXYZW(i,s,r,a)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}}class b extends m{constructor(t,e,i,s){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,4);else if(super(4),"number"==typeof t&&"number"==typeof e&&"number"==typeof i&&"number"==typeof s)this[0]=t,this[1]=e,this[2]=i,this[3]=s;else if(t instanceof y||t instanceof v)this.fromRotationMatrix(t);else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=4)this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3];else{if(void 0!==t)throw new Error("Quaternion.constructor(): invalid arguments");this[0]=0,this[1]=0,this[2]=0,this[3]=1}}clone(){return new b(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}setXYZW(t,e,i,s){return this[0]=t,this[1]=e,this[2]=i,this[3]=s,this}scaleBy(t){return b.scale(this,t,this)}setAndNormalize(t,e,i,s){const r=Math.sqrt(t*t+e*e+i*i+s*s);return this.setXYZW(t/r,e/r,i/r,s/r)}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3]}identity(){return b.identity(this)}inplaceNormalize(){return b.normalize(this,this)}inplaceConjugate(){return b.conjugate(this,this)}multiplyRight(t){return b.multiply(this,t,this)}multiplyLeft(t){return b.multiply(t,this,this)}unitVectorToUnitVector(t,e){return b.unitVectorToUnitVector(t,e,this)}fromEulerAngle(t,e,i,s){return b.fromEulerAngle(t,e,i,s,this)}fromAxisAngle(t,e){return b.fromAxisAngle(t,e,this)}toAxisAngle(t){const e=2*Math.acos(this[3]),i=Math.sin(e/2);return i>1e-6?t.setXYZ(this[0]/i,this[1]/2,this[2]/i):t.setXYZ(1,0,0),e}toEulerAngles(t){t=t??new g;const e=2*(this.w*this.x+this.y*this.z),i=1-2*(this.x*this.x+this.y*this.y),s=Math.atan2(e,i),r=Math.max(-1,Math.min(1,2*(this.w*this.y-this.z*this.x))),a=Math.asin(r),n=2*(this.w*this.z+this.x*this.y),o=1-2*(this.y*this.y+this.z*this.z),h=Math.atan2(n,o);return t.setXYZ(s,a,h)}fromRotationMatrix(t){return b.fromRotationMatrix(t,this)}toMatrix3x3(t){const e=t||new y;return this.toMatrix(e),e}toMatrix4x4(t){const e=t||v.identity();return this.toMatrix(e),e}getDirectionX(t){return(t=t??new g).setXYZ(1-2*(this.y*this.y+this.z*this.z),2*(this.x*this.y+this.z*this.w),2*(this.z*this.x-this.y*this.w))}getDirectionY(t){return(t=t??new g).setXYZ(2*(this.x*this.y-this.z*this.w),1-2*(this.z*this.z+this.x*this.x),2*(this.y*this.z+this.x*this.w))}getDirectionZ(t){return(t=t??new g).setXYZ(2*(this.z*this.x+this.y*this.w),2*(this.y*this.z-this.x*this.w),1-2*(this.y*this.y+this.x*this.x))}getAxisAngle(t){t=t??new T;const e=this.w<0?-1:1,i=this.x*e,s=this.y*e,r=this.z*e,a=this.w*e,n=Math.acos(a),o=Math.sin(n);return t.setXYZW(i/o,s/o,r/o,2*n)}transform(t,e){e=e||new g;const i=2*this.x,s=2*this.y,r=2*this.z,a=this.x*i,n=this.y*s,o=this.z*r,h=this.x*s,u=this.x*r,l=this.y*r,c=this.w*i,d=this.w*s,p=this.w*r;return e.setXYZ((1-n-o)*t.x+(h-p)*t.y+(u+d)*t.z,(h+p)*t.x+(1-a-o)*t.y+(l-c)*t.z,(u-d)*t.x+(l+c)*t.y+(1-a-n)*t.z)}static scale(t,e,i){return(i=i||t).setXYZW(t.x*e,t.y*e,t.z*e,t.w*e)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static identity(t){return(t||new b).setXYZW(0,0,0,1)}static normalize(t,e){const i=t.magnitude;return(e||new b).setXYZW(t.x/i,t.y/i,t.z/i,t.w/i)}static conjugate(t,e){return(e||new b).setXYZW(-t.x,-t.y,-t.z,t.w)}static multiply(t,e,i){i=i||new b;const s=t.x*e.w+t.w*e.x+t.y*e.z-t.z*e.y,r=t.y*e.w+t.w*e.y+t.z*e.x-t.x*e.z,a=t.z*e.w+t.w*e.z+t.x*e.y-t.y*e.x,n=t.w*e.w-t.x*e.x-t.y*e.y-t.z*e.z;return i.setXYZW(s,r,a,n)}static slerp(t,e,i,s){if(s=s||new b,i<=0)return s.setXYZW(t.x,t.y,t.z,t.w);if(i>=1)return s.setXYZW(e.x,e.y,e.z,e.w);const r=this.dot(t,e),a=r<0?-1:1,n=t.x,o=t.y,h=t.z,u=t.w,l=e.x*a,c=e.y*a,d=e.z*a,p=e.w*a,_=r*a;if(_>=1)return s.setXYZW(n,o,h,u);const m=1-_*_;if(m<=Number.EPSILON){const r=1-i;return s.setAndNormalize(t.x*r+e.x*i,t.y*r+e.y*i,t.z*r+e.z*i,t.w*r+e.w*i)}const f=Math.sqrt(m),g=Math.atan2(f,_),x=Math.sin((1-i)*g)/f,T=Math.sin(i*g)/f;return s.setXYZW(n*x+l*T,o*x+c*T,h*x+d*T,u*x+p*T)}static angleBetween(t,e){const i=this.dot(t,e),s=i<-1?-1:i>1?1:i;return 2*Math.acos(Math.abs(s))}static unitVectorToUnitVector(t,e,i){i=i||new b;let s=g.dot(t,e)+1;return s<1e-6?(s=0,Math.abs(t.x)>Math.abs(t.z)?i.setAndNormalize(-t.y,t.x,0,s):i.setAndNormalize(0,-t.z,t.y,s)):i.setAndNormalize(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x,s)}static fromEulerAngle(t,e,i,s,r){r=r||new b;const a=Math.cos(t/2),n=Math.cos(e/2),o=Math.cos(i/2),h=Math.sin(t/2),u=Math.sin(e/2),l=Math.sin(i/2);switch(s){case"XYZ":return r.setXYZW(h*n*o+a*u*l,a*u*o-h*n*l,a*n*l+h*u*o,a*n*o-h*u*l);case"YXZ":return r.setXYZW(h*n*o+a*u*l,a*u*o-h*n*l,a*n*l-h*u*o,a*n*o+h*u*l);case"ZXY":return r.setXYZW(h*n*o-a*u*l,a*u*o+h*n*l,a*n*l+h*u*o,a*n*o-h*u*l);case"ZYX":return r.setXYZW(h*n*o-a*u*l,a*u*o+h*n*l,a*n*l-h*u*o,a*n*o+h*u*l);case"YZX":return r.setXYZW(h*n*o+a*u*l,a*u*o+h*n*l,a*n*l-h*u*o,a*n*o-h*u*l);case"XZY":return r.setXYZW(h*n*o-a*u*l,a*u*o-h*n*l,a*n*l+h*u*o,a*n*o+h*u*l)}}static fromAxisAngle(t,e,i){i=i||new b;const s=e/2,r=Math.sin(s);return i.setXYZW(t.x*r,t.y*r,t.z*r,Math.cos(s))}static fromRotationMatrix(t,e){e=e||new b;const i=t.m00+t.m11+t.m22;let s;return i>0?(s=.5/Math.sqrt(i+1),e.setXYZW((t.m21-t.m12)*s,(t.m02-t.m20)*s,(t.m10-t.m01)*s,.25/s)):t.m00>t.m11&&t.m00>t.m22?(s=2*Math.sqrt(1+t.m00-t.m11-t.m22),e.setXYZW(.25*s,(t.m01+t.m10)/s,(t.m02+t.m20)/s,(t.m21-t.m12)/s)):t.m11>t.m22?(s=2*Math.sqrt(1-t.m00+t.m11-t.m22),e.setXYZW((t.m10+t.m01)/s,.25*s,(t.m21+t.m12)/s,(t.m02-t.m20)/s)):(s=2*Math.sqrt(1-t.m00-t.m11+t.m22),e.setXYZW((t.m02+t.m20)/s,(t.m12+t.m21)/s,.25*s,(t.m10-t.m01)/s)),e}toMatrix(t){const e=this.x*this.x,i=this.y*this.y,s=this.z*this.z,r=this.x*this.y,a=this.z*this.w,n=this.z*this.x,o=this.y*this.w,h=this.y*this.z,u=this.x*this.w;t.m00=1-2*(i+s),t.m10=2*(r+a),t.m20=2*(n-o),t.m01=2*(r-a),t.m11=1-2*(s+e),t.m21=2*(h+u),t.m02=2*(n+o),t.m12=2*(h-u),t.m22=1-2*(i+e)}}class E extends b{_callback;get callback(){return this._callback}set callback(t){this._callback=t}get x(){return super.x}set x(t){(t=h(t))!==super.x&&(super.x=t,this._callback&&this._callback())}get y(){return super.y}set y(t){(t=h(t))!==super.y&&(super.y=t,this._callback&&this._callback())}get z(){return super.z}set z(t){(t=h(t))!==super.z&&(super.z=t,this._callback&&this._callback())}get w(){return super.w}set w(t){(t=h(t))!==super.w&&(super.w=t,this._callback&&this._callback())}setXYZW(t,e,i,s){return t=h(t),e=h(e),i=h(i),s=h(s),t===super.x&&e===super.y&&i===super.z&&s===super.w||(super.setXYZW(t,e,i,s),this._callback&&this._callback()),this}copyWithin(t,e,i){return super.copyWithin(t,e,i),this._callback&&this._callback(),this}fill(t,e,i){return super.fill(t,e,i),this._callback&&this._callback(),this}reverse(){return super.reverse(),this._callback&&this._callback(),this}set(t,e){super.set(t,e),this._callback&&this._callback()}sort(t){return super.sort(t),this._callback&&this._callback(),this}}class y extends m{constructor(t,e,i,s,r,a,n,o,h){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,9);else if(super(9),"number"==typeof t)this[0]=t,this[1]=e,this[2]=i,this[3]=s,this[4]=r,this[5]=a,this[6]=n,this[7]=o,this[8]=h;else if(t instanceof b)t.toMatrix3x3(this);else if(t instanceof v)this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[4],this[4]=t[5],this[5]=t[6],this[6]=t[8],this[7]=t[9],this[8]=t[10];else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=9)this.set(t);else{if(void 0!==t)throw new Error("Matrix3x4.constructor(): invalid arguments");this.identity()}}clone(){return new y(this)}get m00(){return this[0]}set m00(t){this[0]=t}get m10(){return this[1]}set m10(t){this[1]=t}get m20(){return this[2]}set m20(t){this[2]=t}get m01(){return this[3]}set m01(t){this[3]=t}get m11(){return this[4]}set m11(t){this[4]=t}get m21(){return this[5]}set m21(t){this[5]=t}get m02(){return this[6]}set m02(t){this[6]=t}get m12(){return this[7]}set m12(t){this[7]=t}get m22(){return this[8]}set m22(t){this[8]=t}getRow(t,e){return(e||new g).setXYZ(this[3*t],this[3*t+1],this[3*t+2])}setRow(t,e){return this[3*t]=e.x,this[3*t+1]=e.y,this[3*t+2]=e.z,this}setRowXYZ(t,e,i,s){return this[3*t]=e,this[3*t+1]=i,this[3*t+2]=s,this}getCol(t,e){return(e||new g).setXYZ(this[t],this[3+t],this[6+t])}setCol(t,e){return this[t]=e.x,this[3+t]=e.y,this[6+t]=e.z,this}setColXYZ(t,e,i,s){return this[t]=e,this[3+t]=i,this[6+t]=s,this}static add(t,e,i){i=i||new y;for(let s=0;s<9;s++)i[s]=t[s]+e[s];return i}static sub(t,e,i){i=i||new y;for(let s=0;s<9;s++)i[s]=t[s]-e[s];return i}static mul(t,e,i){i=i||new y;for(let s=0;s<9;s++)i[s]=t[s]*e[s];return i}static div(t,e,i){i=i||new y;for(let s=0;s<9;s++)i[s]=t[s]/e[s];return i}static scale(t,e,i){i=i||new y;for(let s=0;s<9;s++)i[s]=t[s]*e;return i}static identity(t){return(t=t||new y).set(p),t}static transpose(t,e){return t===(e=e||new y)?([e[1],e[3]]=[e[3],e[1]],[e[2],e[6]]=[e[6],e[2]],[e[5],e[7]]=[e[7],e[5]]):(e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]),e}static invert(t,e){e=e||new y;const i=t[0],s=t[1],r=t[2],a=t[3],n=t[4],o=t[5],h=t[6],u=t[7],l=t[8],c=l*n-o*u,d=o*h-l*a,p=u*a-h*n,_=1/(i*c+s*d+r*p);return e[0]=c*_,e[1]=(r*u-l*s)*_,e[2]=(o*s-r*n)*_,e[3]=d*_,e[4]=(l*i-r*h)*_,e[5]=(r*a-o*i)*_,e[6]=p*_,e[7]=(s*h-u*i)*_,e[8]=(n*i-s*a)*_,e}static rotationX(t,e){e=e||new y;const i=Math.cos(t),s=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=i,e[5]=s,e[6]=0,e[7]=-s,e[8]=i,e}static rotationY(t,e){e=e||new y;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=0,e[2]=-s,e[3]=0,e[4]=1,e[5]=0,e[6]=s,e[7]=0,e[8]=i,e}static rotationZ(t,e){e=e||new y;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=-s,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}static rotation(t,e,i){i=i||new y;let s=t.x,r=t.y,a=t.z;const n=Math.sqrt(s*s+r*r+a*a);s/=n,r/=n,a/=n;const o=s*s,h=r*r,u=a*a,l=Math.cos(e),c=Math.sin(e),d=1-l;return i[0]=o+(1-o)*l,i[1]=s*r*d+a*c,i[2]=s*a*d-r*c,i[3]=s*r*d-a*c,i[4]=h+(1-h)*l,i[5]=r*a*d+s*c,i[6]=s*a*d+r*c,i[7]=r*a*d-s*c,i[8]=u+(1-u)*l,i}static multiply(t,e,i){i=i||new y;const s=t[0],r=t[1],a=t[2],n=t[3],o=t[4],h=t[5],u=t[6],l=t[7],c=t[8],d=e[0],p=e[1],_=e[2],m=e[3],f=e[4],g=e[5],x=e[6],T=e[7],b=e[8];return i[0]=s*d+n*p+u*_,i[1]=r*d+o*p+l*_,i[2]=a*d+h*p+c*_,i[3]=s*m+n*f+u*g,i[4]=r*m+o*f+l*g,i[5]=a*m+h*f+c*g,i[6]=s*x+n*T+u*b,i[7]=r*x+o*T+l*b,i[8]=a*x+h*T+c*b,i}subBy(t){return y.sub(this,t,this)}addBy(t){return y.add(this,t,this)}mulBy(t){return y.mul(this,t,this)}divBy(t){return y.div(this,t,this)}scaleBy(t){return y.scale(this,t,this)}identity(){return y.identity(this)}inplaceInvert(){return y.invert(this,this)}transpose(){return y.transpose(this,this)}multiplyRight(t){return y.multiply(this,t,this)}multiplyLeft(t){return y.multiply(t,this,this)}rotationX(t){return y.rotationX(t,this)}rotationY(t){return y.rotationY(t,this)}rotationZ(t){return y.rotationZ(t,this)}rotation(t,e){return y.rotation(t,e,this)}transform(t,e){return(e=e||new g).setXYZ(this[0]*t[0]+this[3]*t[1]+this[6]*t[2],this[1]*t[0]+this[4]*t[1]+this[7]*t[2],this[2]*t[0]+this[5]*t[1]+this[8]*t[2])}transformPoint(t,e){return this.transform(t,e)}transformVector(t,e){return this.transform(t,e)}}class v extends m{constructor(t,e,i,s,r,a,n,o,h,u,l,c,d,p,_,m){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,16);else if(super(16),"number"==typeof t)this[0]=t,this[1]=e,this[2]=i,this[3]=s,this[4]=r,this[5]=a,this[6]=n,this[7]=o,this[8]=h,this[9]=u,this[10]=l,this[11]=c,this[12]=d,this[13]=p,this[14]=_,this[15]=m;else if(t instanceof b)t.toMatrix4x4(this),this.m03=0,this.m13=0,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=1;else if(t instanceof y)this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=0,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=0,this.m20=t.m20,this.m21=t.m21,this.m22=t.m22,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=1;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=16)this.set(t);else{if(void 0!==t)throw new Error("Matrix4x4.constructor(): invalid arguments");this.identity()}}clone(){return new v(this)}get m00(){return this[0]}set m00(t){this[0]=t}get m10(){return this[1]}set m10(t){this[1]=t}get m20(){return this[2]}set m20(t){this[2]=t}get m30(){return this[3]}set m30(t){this[3]=t}get m01(){return this[4]}set m01(t){this[4]=t}get m11(){return this[5]}set m11(t){this[5]=t}get m21(){return this[6]}set m21(t){this[6]=t}get m31(){return this[7]}set m31(t){this[7]=t}get m02(){return this[8]}set m02(t){this[8]=t}get m12(){return this[9]}set m12(t){this[9]=t}get m22(){return this[10]}set m22(t){this[10]=t}get m32(){return this[11]}set m32(t){this[11]=t}get m03(){return this[12]}set m03(t){this[12]=t}get m13(){return this[13]}set m13(t){this[13]=t}get m23(){return this[14]}set m23(t){this[14]=t}get m33(){return this[15]}set m33(t){this[15]=t}getRow(t,e){return(e||new T).setXYZW(this[4*t],this[4*t+1],this[4*t+2],this[4*t+3])}setRow(t,e){return this[4*t]=e.x,this[4*t+1]=e.y,this[4*t+2]=e.z,this[4*t+3]=e.w,this}setRowXYZW(t,e,i,s,r){return this[4*t]=e,this[4*t+1]=i,this[4*t+2]=s,this[4*t+3]=r,this}getCol(t,e){return(e||new T).setXYZW(this[t],this[4+t],this[8+t],this[12+t])}setCol(t,e){return this[t]=e.x,this[4+t]=e.y,this[8+t]=e.z,this[12+t]=e.w,this}setColXYZW(t,e,i,s,r){return this[t]=e,this[4+t]=i,this[8+t]=s,this[12+t]=r,this}static add(t,e,i){i=i||new v;for(let s=0;s<16;s++)i[s]=t[s]+e[s];return i}static sub(t,e,i){i=i||new v;for(let s=0;s<16;s++)i[s]=t[s]-e[s];return i}static mul(t,e,i){i=i||new v;for(let s=0;s<16;s++)i[s]=t[s]*e[s];return i}static div(t,e,i){i=i||new v;for(let s=0;s<16;s++)i[s]=t[s]/e[s];return i}static scale(t,e,i){i=i||new v;for(let s=0;s<16;s++)i[s]=t[s]*e;return i}static identity(t){return(t=t||new v).set(_),t}static ortho(t,e,i,s,r,a,n){return(n=n||new v)[0]=2/(e-t),n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/(s-i),n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2/(r-a),n[11]=0,n[12]=(t+e)/(t-e),n[13]=(i+s)/(i-s),n[14]=(r+a)/(r-a),n[15]=1,n}static reflection(t,e,i,s,r){return(r=r||new v).m00=1-2*t*t,r.m01=-2*t*e,r.m02=-2*t*i,r.m03=-2*t*s,r.m10=-2*t*e,r.m11=1-2*e*e,r.m12=-2*e*i,r.m13=-2*e*s,r.m20=-2*t*i,r.m21=-2*e*i,r.m22=1-2*i*i,r.m23=-2*i*s,r.m30=0,r.m31=0,r.m32=0,r.m33=1,r}static perspective(t,e,i,s,r){const a=i*Math.tan(.5*t),n=a*e;return this.frustum(-n,n,-a,a,i,s,r)}static obliqueProjection(t,e){const i=new v(t),s=v.invert(t).transform(new T(e.a>0?1:-1,e.b>0?1:-1,1,1)),r=2/(s.x*e.a+s.y*e.b+s.z*e.c+s.w*e.d);return i[2]=e.a*r-i[3],i[6]=e.b*r-i[7],i[10]=e.c*r-i[11],i[14]=e.d*r-i[15],i}static obliquePerspective(t,e){const i=new v(t),s=new T(((e.x>0?1:e.x<0?-1:0)+t.m02)/t.m00,((e.y>0?1:e.y<0?-1:0)+t.m12)/t.m11,-1,(1+t.m22)/t.m23),r=T.scale(e,2/T.dot(e,s));return i.m20=r.x,i.m21=r.y,i.m22=r.z+1,i.m23=r.w,i}static frustum(t,e,i,s,r,a,n){const o=e-t,h=s-i,u=r-a;return(n=n||new v)[0]=2*r/o,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*r/h,n[6]=0,n[7]=0,n[8]=(t+e)/o,n[9]=(s+i)/h,n[10]=(r+a)/u,n[11]=-1,n[12]=0,n[13]=0,n[14]=2*r*a/u,n[15]=0,n}static transpose(t,e){return t===(e=e||new v)?([e[1],e[4]]=[e[4],e[1]],[e[2],e[8]]=[e[8],e[2]],[e[3],e[12]]=[e[12],e[3]],[e[6],e[9]]=[e[9],e[6]],[e[7],e[13]]=[e[13],e[7]],[e[11],e[14]]=[e[14],e[11]]):(e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]),e}static invert(t,e){e=e||new v;const i=t[0],s=t[1],r=t[2],a=t[3],n=t[4],o=t[5],h=t[6],u=t[7],l=t[8],c=t[9],d=t[10],p=t[11],_=t[12],m=t[13],f=t[14],g=t[15],x=d*g,T=f*p,b=h*g,E=f*u,y=h*p,S=d*u,w=r*g,C=f*a,A=r*p,R=d*a,M=r*u,$=h*a,N=l*m,D=_*c,I=n*m,L=_*o,F=n*c,P=l*o,B=i*m,O=_*s,U=i*c,V=l*s,G=i*o,z=n*s,k=x*o+E*c+y*m-(T*o+b*c+S*m),X=T*s+w*c+R*m-(x*s+C*c+A*m),W=b*s+C*o+M*m-(E*s+w*o+$*m),H=S*s+A*o+$*c-(y*s+R*o+M*c),Y=1/(i*k+n*X+l*W+_*H);return e[0]=Y*k,e[1]=Y*X,e[2]=Y*W,e[3]=Y*H,e[4]=Y*(T*n+b*l+S*_-(x*n+E*l+y*_)),e[5]=Y*(x*i+C*l+A*_-(T*i+w*l+R*_)),e[6]=Y*(E*i+w*n+$*_-(b*i+C*n+M*_)),e[7]=Y*(y*i+R*n+M*l-(S*i+A*n+$*l)),e[8]=Y*(N*u+L*p+F*g-(D*u+I*p+P*g)),e[9]=Y*(D*a+B*p+V*g-(N*a+O*p+U*g)),e[10]=Y*(I*a+O*u+G*g-(L*a+B*u+z*g)),e[11]=Y*(P*a+U*u+z*p-(F*a+V*u+G*p)),e[12]=Y*(I*d+P*f+D*h-(F*f+N*h+L*d)),e[13]=Y*(U*f+N*r+O*d-(B*d+V*f+D*r)),e[14]=Y*(B*h+z*f+L*r-(G*f+I*r+O*h)),e[15]=Y*(G*d+F*r+V*h-(U*h+z*d+P*r)),e}static invertAffine(t,e){e=e||new v;const i=t[0],s=t[1],r=t[2],a=t[4],n=t[5],o=t[6],h=t[8],u=t[9],l=t[10],c=t[12],d=t[13],p=t[14],_=l*n-o*u,m=r*u-l*s,f=o*s-r*n,g=1/(i*_+a*m+h*f);return e[0]=g*_,e[1]=g*m,e[2]=g*f,e[3]=0,e[4]=g*(o*h-l*a),e[5]=g*(l*i-r*h),e[6]=g*(r*a-o*i),e[7]=0,e[8]=g*(a*u-h*n),e[9]=g*(h*s-i*u),e[10]=g*(i*n-a*s),e[11]=0,e[12]=g*(a*d*l+h*n*p+c*u*o-(a*u*p+h*d*o+c*n*l)),e[13]=g*(i*u*p+h*d*r+c*s*l-(i*d*l+h*s*p+c*u*r)),e[14]=g*(i*d*o+a*s*p+c*n*r-(i*n*p+a*d*r+c*s*o)),e[15]=1,e}static translation(t,e){return(e=e||new v)[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t.x,e[13]=t.y,e[14]=t.z,e[15]=1,e}static scaling(t,e){return(e=e||new v)[0]=t.x,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t.y,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t.z,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotationX(t,e){e=e||new v;const i=Math.cos(t),s=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=s,e[7]=0,e[8]=0,e[9]=-s,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotationY(t,e){e=e||new v;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=0,e[2]=-s,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=s,e[9]=0,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotationZ(t,e){e=e||new v;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=0,e[4]=-s,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotation(t,e,i){i=i||new v;let s=t.x,r=t.y,a=t.z;const n=Math.sqrt(s*s+r*r+a*a);s/=n,r/=n,a/=n;const o=s*s,h=r*r,u=a*a,l=Math.cos(e),c=Math.sin(e),d=1-l;return i[0]=o+(1-o)*l,i[1]=s*r*d+a*c,i[2]=s*a*d-r*c,i[3]=0,i[4]=s*r*d-a*c,i[5]=h+(1-h)*l,i[6]=r*a*d+s*c,i[7]=0,i[8]=s*a*d+r*c,i[9]=r*a*d-s*c,i[10]=u+(1-u)*l,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}static lookAt(t,e,i,s){s=s||new v;const r=g.normalize(g.sub(t,e)),a=g.normalize(g.cross(i,r)),n=g.normalize(g.cross(r,a));return s[0]=a.x,s[1]=a.y,s[2]=a.z,s[3]=0,s[4]=n.x,s[5]=n.y,s[6]=n.z,s[7]=0,s[8]=r.x,s[9]=r.y,s[10]=r.z,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1,s}static lookAtCubeFace(t,e,i){switch(t){case d.PX:return this.lookAt(e,new g(e.x+1,e.y,e.z),new g(0,-1,0),i);case d.NX:return this.lookAt(e,new g(e.x-1,e.y,e.z),new g(0,-1,0),i);case d.PY:return this.lookAt(e,new g(e.x,e.y+1,e.z),new g(0,0,1),i);case d.NY:return this.lookAt(e,new g(e.x,e.y-1,e.z),new g(0,0,-1),i);case d.PZ:return this.lookAt(e,new g(e.x,e.y,e.z+1),new g(0,-1,0),i);case d.NZ:return this.lookAt(e,new g(e.x,e.y,e.z-1),new g(0,-1,0),i);default:return null}}static multiply(t,e,i){i=i||new v;const s=t[0],r=t[1],a=t[2],n=t[3],o=t[4],h=t[5],u=t[6],l=t[7],c=t[8],d=t[9],p=t[10],_=t[11],m=t[12],f=t[13],g=t[14],x=t[15],T=e[0],b=e[1],E=e[2],y=e[3],S=e[4],w=e[5],C=e[6],A=e[7],R=e[8],M=e[9],$=e[10],N=e[11],D=e[12],I=e[13],L=e[14],F=e[15];return i[0]=s*T+o*b+c*E+m*y,i[1]=r*T+h*b+d*E+f*y,i[2]=a*T+u*b+p*E+g*y,i[3]=n*T+l*b+_*E+x*y,i[4]=s*S+o*w+c*C+m*A,i[5]=r*S+h*w+d*C+f*A,i[6]=a*S+u*w+p*C+g*A,i[7]=n*S+l*w+_*C+x*A,i[8]=s*R+o*M+c*$+m*N,i[9]=r*R+h*M+d*$+f*N,i[10]=a*R+u*M+p*$+g*N,i[11]=n*R+l*M+_*$+x*N,i[12]=s*D+o*I+c*L+m*F,i[13]=r*D+h*I+d*L+f*F,i[14]=a*D+u*I+p*L+g*F,i[15]=n*D+l*I+_*L+x*F,i}static multiplyAffine(t,e,i){i=i||new v;const s=t[0],r=t[1],a=t[2],n=t[4],o=t[5],h=t[6],u=t[8],l=t[9],c=t[10],d=t[12],p=t[13],_=t[14],m=e[0],f=e[1],g=e[2],x=e[4],T=e[5],b=e[6],E=e[8],y=e[9],S=e[10],w=e[12],C=e[13],A=e[14];return i[0]=s*m+n*f+u*g,i[1]=r*m+o*f+l*g,i[2]=a*m+h*f+c*g,i[3]=0,i[4]=s*x+n*T+u*b,i[5]=r*x+o*T+l*b,i[6]=a*x+h*T+c*b,i[7]=0,i[8]=s*E+n*y+u*S,i[9]=r*E+o*y+l*S,i[10]=a*E+h*y+c*S,i[11]=0,i[12]=s*w+n*C+u*A+d,i[13]=r*w+o*C+l*A+p,i[14]=a*w+h*C+c*A+_,i[15]=1,i}static translateRight(t,e,i){if((i=i||new v)!==t)i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12],i[13]=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13],i[14]=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14],i[15]=t[15];else{const s=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12],r=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13],a=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14];i[12]=s,i[13]=r,i[14]=a}return i}static translateLeft(t,e,i){return(i=i||new v)!==t?(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12]+e.x,i[13]=t[13]+e.y,i[14]=t[14]+e.z,i[15]=t[15]):(i[12]+=e.x,i[13]+=e.y,i[14]+=e.z),i}static scaleRight(t,e,i){return(i=i||new v)!==t?(i[0]=t[0]*e.x,i[1]=t[1]*e.x,i[2]=t[2]*e.x,i[3]=t[3]*e.x,i[4]=t[4]*e.y,i[5]=t[5]*e.y,i[6]=t[6]*e.y,i[7]=t[7]*e.y,i[8]=t[8]*e.z,i[9]=t[9]*e.z,i[10]=t[10]*e.z,i[11]=t[11]*e.z,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):(i[0]*=e.x,i[1]*=e.x,i[2]*=e.x,i[3]*=e.x,i[4]*=e.y,i[5]*=e.y,i[6]*=e.y,i[7]*=e.y,i[8]*=e.z,i[9]*=e.z,i[10]*=e.z,i[11]*=e.z),i}static scaleLeft(t,e,i){return(i=i||new v)!==t?(i[0]=t[0]*e.x,i[1]=t[1]*e.y,i[2]=t[2]*e.z,i[3]=t[3],i[4]=t[4]*e.x,i[5]=t[5]*e.y,i[6]=t[6]*e.z,i[7]=t[7],i[8]=t[8]*e.x,i[9]=t[9]*e.y,i[10]=t[10]*e.z,i[11]=t[11],i[12]=t[12]*e.x,i[13]=t[13]*e.y,i[14]=t[14]*e.z,i[15]=t[15]):(i[0]*=e.x,i[1]*=e.y,i[2]*=e.z,i[4]*=e.x,i[5]*=e.y,i[6]*=e.z,i[8]*=e.x,i[9]*=e.y,i[10]*=e.z,i[12]*=e.x,i[13]*=e.y,i[14]*=e.z),i}static rotateRight(t,e,i){i=i||new v;const s=e instanceof b?new y(e):e,r=t[0],a=t[1],n=t[2],o=t[3],h=t[4],u=t[5],l=t[6],c=t[7],d=t[8],p=t[9],_=t[10],m=t[11],f=t[12],g=t[13],x=t[14],T=t[15],E=s.m00,S=s.m10,w=s.m20,C=s.m01,A=s.m11,R=s.m21,M=s.m02,$=s.m12,N=s.m22;return i[0]=r*E+h*S+d*w,i[1]=a*E+u*S+p*w,i[2]=n*E+l*S+_*w,i[3]=o*E+c*S+m*w,i[4]=r*C+h*A+d*R,i[5]=a*C+u*A+p*R,i[6]=n*C+l*A+_*R,i[7]=o*C+c*A+m*R,i[8]=r*M+h*$+d*N,i[9]=a*M+u*$+p*N,i[10]=n*M+l*$+_*N,i[11]=o*M+c*$+m*N,i[12]=f,i[13]=g,i[14]=x,i[15]=T,i}static rotateLeft(t,e,i){i=i||new v;const s=e instanceof b?new y(e):e,r=s.m00,a=s.m10,n=s.m20,o=s.m01,h=s.m11,u=s.m21,l=s.m02,c=s.m12,d=s.m22,p=t[0],_=t[1],m=t[2],f=t[3],g=t[4],x=t[5],T=t[6],E=t[7],S=t[8],w=t[9],C=t[10],A=t[11],R=t[12],M=t[13],$=t[14],N=t[15];return i[0]=r*p+o*_+l*m,i[1]=a*p+h*_+c*m,i[2]=n*p+u*_+d*m,i[3]=f,i[4]=r*g+o*x+l*T,i[5]=a*g+h*x+c*T,i[6]=n*g+u*x+d*T,i[7]=E,i[8]=r*S+o*w+l*C,i[9]=a*S+h*w+c*C,i[10]=n*S+u*w+d*C,i[11]=A,i[12]=r*R+o*M+l*$,i[13]=a*R+h*M+c*$,i[14]=n*R+u*M+d*$,i[15]=N,i}subBy(t){return v.sub(this,t,this)}addBy(t){return v.add(this,t,this)}mulBy(t){return v.mul(this,t,this)}divBy(t){return v.div(this,t,this)}scaleBy(t){return v.scale(this,t,this)}identity(){return v.identity(this)}perspective(t,e,i,s){return v.perspective(t,e,i,s,this)}frustum(t,e,i,s,r,a){return v.frustum(t,e,i,s,r,a,this)}ortho(t,e,i,s,r,a){return v.ortho(t,e,i,s,r,a,this)}isOrtho(){return 1===this[15]}isPerspective(){return 0===this[15]}getNearPlaneWidth(){return this.isPerspective()?2*this.getNearPlane()/this[0]:2/this[0]}getNearPlaneHeight(){return this.isPerspective()?2*this.getNearPlane()/this[5]:2/this[5]}getNearPlane(){return this.isPerspective()?this[14]/(this[10]-1):(this[14]+1)/this[10]}getFarPlaneWidth(){return this.isPerspective()?this.getNearPlaneWidth()*this.getFarPlane()/this.getNearPlane():this.getNearPlaneWidth()}getFarPlaneHeight(){return this.isPerspective()?this.getNearPlaneHeight()*this.getFarPlane()/this.getNearPlane():this.getNearPlaneHeight()}getFarPlane(){return this.isPerspective()?this[14]/(this[10]+1):(this[14]-1)/this[10]}getFov(){return this.isOrtho()?0:2*Math.atan(1/this[5])}getTanHalfFov(){return this.isOrtho()?0:1/this[5]}getAspect(){return this[5]/this[0]}getLeftPlane(){return(-1-this[12])/this[0]}getRightPlane(){return(1-this[12])/this[0]}getTopPlane(){return(1-this[13])/this[5]}getBottomPlane(){return(-1-this[13])/this[5]}setNearFar(t,e){return this.isPerspective()?this.perspective(this.getFov(),this.getAspect(),t,e):(this[10]=2/(t-e),this[14]=(t+e)/(t-e)),this}translation(t){return v.translation(t,this)}scaling(t){return v.scaling(t,this)}inplaceInvert(){return v.invert(this,this)}inplaceInvertAffine(){return v.invertAffine(this,this)}transpose(){return v.transpose(this,this)}multiplyRight(t){return v.multiply(this,t,this)}multiplyRightAffine(t){return v.multiplyAffine(this,t,this)}multiplyLeft(t){return v.multiply(t,this,this)}multiplyLeftAffine(t){return v.multiplyAffine(t,this,this)}rotationX(t){return v.rotationX(t,this)}rotationY(t){return v.rotationY(t,this)}rotationZ(t){return v.rotationZ(t,this)}rotation(t,e){return v.rotation(t,e,this)}translateRight(t){return v.translateRight(this,t,this)}translateLeft(t){return v.translateLeft(this,t,this)}scaleRight(t){return v.scaleRight(this,t,this)}scaleLeft(t){return v.scaleLeft(this,t,this)}rotateRight(t){return v.rotateRight(this,t,this)}rotateLeft(t){return v.rotateLeft(this,t,this)}lookAt(t,e,i){return v.lookAt(t,e,i,this)}transformPoint(t,e){return(e=e||new T).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14],this[3]*t[0]+this[7]*t[1]+this[11]*t[2]+this[15])}transformPointP(t,e){e=e||new g;const i=this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12],s=this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13],r=this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14],a=this[3]*t[0]+this[7]*t[1]+this[11]*t[2]+this[15];return e.setXYZ(i/a,s/a,r/a)}transformPointAffine(t,e){return(e=e||new g).setXYZ(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14])}transformVector(t,e){return(e=e||new T).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2],this[1]*t[0]+this[5]*t[1]+this[9]*t[2],this[2]*t[0]+this[6]*t[1]+this[10]*t[2],this[3]*t[0]+this[7]*t[1]+this[11]*t[2])}transformVectorAffine(t,e){return(e=e||new g).setXYZ(this[0]*t[0]+this[4]*t[1]+this[8]*t[2],this[1]*t[0]+this[5]*t[1]+this[9]*t[2],this[2]*t[0]+this[6]*t[1]+this[10]*t[2])}transform(t,e){return(e=e||new T).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12]*t[3],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13]*t[3],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14]*t[3],this[3]*t[0]+this[7]*t[1]+this[11]*t[2]+this[15]*t[3])}transformAffine(t,e){return(e=e||new T).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12]*t[3],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13]*t[3],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14]*t[3],t.w)}det(){const t=this[0],e=this[1],i=this[2],s=this[3],r=this[4],a=this[5],n=this[6],o=this[7],h=this[8],u=this[9],l=this[10],c=this[11],d=this[12],p=this[13],_=this[14],m=this[15],f=l*m-_*c,g=u*m-p*c,x=u*_-p*l,T=h*m-d*c,b=h*_-l*d,E=h*p-d*u;return t*+(a*f-n*g+o*x)+e*-(r*f-n*T+o*b)+i*+(r*g-a*T+o*E)+s*-(r*x-a*b+n*E)}decompose(t,e,i){i&&i.setXYZ(this[12],this[13],this[14]);const s=this.det()<=0?-1:1,r=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),a=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6])*s,n=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]);if(t&&t.setXYZ(r,a,n),e instanceof b){const t=new y(this);t[0]/=r,t[1]/=r,t[2]/=r,t[3]/=a,t[4]/=a,t[5]/=a,t[6]/=n,t[7]/=n,t[8]/=n,e.fromRotationMatrix(t)}else e instanceof y?(e[0]=this[0]/r,e[1]=this[1]/r,e[2]=this[2]/r,e[3]=this[4]/a,e[4]=this[5]/a,e[5]=this[6]/a,e[6]=this[8]/n,e[7]=this[9]/n,e[8]=this[10]/n):e instanceof v&&(e[0]=this[0]/r,e[1]=this[1]/r,e[2]=this[2]/r,e[3]=0,e[4]=this[4]/a,e[5]=this[5]/a,e[6]=this[6]/a,e[7]=0,e[8]=this[8]/n,e[9]=this[9]/n,e[10]=this[10]/n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1);return this}decomposeLookAt(t,e,i){return t&&t.setXYZ(this[12],this[13],this[14]),i&&i.setXYZ(this[4],this[5],this[6]),e&&e.setXYZ(this[12]-this[8],this[13]-this[9],this[14]-this[10]),this}toDualQuaternion(){const t=new g,e=new b,i=new g;this.decompose(i,e,t);const s=new b(.5*this.m03,.5*this.m13,.5*this.m23,0);return{real:e,dual:b.multiply(s,e),scale:i}}}class S extends m{_px;_py;_pz;_nx;_ny;_nz;_npDirty;constructor(t,e,i,s){switch(super(4),arguments.length){case 0:this[0]=0,this[1]=1,this[2]=0,this[3]=0,this._npDirty=!0;break;case 1:this.set(t);break;case 2:this.initWithOriginNormal(t,e);break;case 3:this.initWithPoints(t,e,i);break;case 4:this.setEquation(t,e,i,s);break;default:console.log("ERROR: Plane constructor must have 0/2/3/4 arguments")}}get a(){return this[0]}set a(t){this[0]=t,this._npDirty=!0}get b(){return this[1]}set b(t){this[1]=t,this._npDirty=!0}get c(){return this[2]}set c(t){this[2]=t,this._npDirty=!0}get d(){return this[3]}set d(t){this[3]=t,this._npDirty=!0}get px(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._px}get py(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._py}get pz(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._pz}get nx(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._nx}get ny(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._ny}get nz(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._nz}assign(t){return this._npDirty=!0,super.set(t),this}setEquation(t,e,i,s){return this[0]=t,this[1]=e,this[2]=i,this[3]=s,this._npDirty=!0,this}initWithOriginNormal(t,e){return this.setEquation(e.x,e.y,e.z,-g.dot(t,e))}initWithPoints(t,e,i){const s=g.cross(g.sub(e,t),g.sub(i,t)).inplaceNormalize();return this.initWithOriginNormal(t,s)}distanceToPoint(t){return t.x*this[0]+t.y*this[1]+t.z*this[2]+this[3]}nearestPointToPoint(t,e){const i=this.distanceToPoint(t);return(e||new g).setXYZ(t.x-this[0]*i,t.y-this[1]*i,t.z-this[2]*i)}getNormal(t){return(t||new g).setXYZ(this[0],this[1],this[2])}inplaceFlip(){return S.flip(this,this)}inplaceNormalize(){return S.normalize(this,this)}static flip(t,e){return(e||new S).setEquation(-t[0],-t[1],-t[2],-t[3])}static normalize(t,e){const i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return(e||new S).setEquation(t[0]/i,t[1]/i,t[2]/i,t[3]/i)}static transform(t,e,i){const s=v.transpose(v.invertAffine(e)).transform(new T(t[0],t[1],t[2],t[3])),r=i||t;return r.setEquation(s.x,s.y,s.z,s.w),r.inplaceNormalize()}_calcNP(){this._px=this[0]>0?1:-1,this._py=this[1]>0?1:-1,this._pz=this[2]>0?1:-1,this._nx=-this._px,this._ny=-this._py,this._nz=-this._pz}}const w=[-1,1,-1],C=[-1,1,1],A=[1,1,1],R=[1,1,-1],M=[-1,-1,-1],$=[-1,-1,1],N=[1,-1,1],D=[1,-1,-1];class I{static ndcVertices=[w,C,A,R,M,$,N,D];static generateVertexData(t){return[...t[0],...t[1],...t[2],...t[3],...t[1],...t[5],...t[6],...t[2],...t[2],...t[6],...t[7],...t[3],...t[3],...t[7],...t[4],...t[0],...t[0],...t[4],...t[5],...t[1],...t[5],...t[4],...t[7],...t[6]]}static ndcBoxVertices=new Float32Array([...w,...C,...A,...R,...C,...$,...N,...A,...A,...N,...D,...R,...R,...D,...M,...w,...w,...M,...$,...C,...$,...M,...D,...N]);static boxBarycentric=new Float32Array([1,0,0,0,1,0,0,1,1,0,1,0,1,0,0,0,1,0,0,1,1,0,1,0,1,0,0,0,1,0,0,1,1,0,1,0,1,0,0,0,1,0,0,1,1,0,1,0,1,0,0,0,1,0,0,1,1,0,1,0,1,0,0,0,1,0,0,1,1,0,1,0]);static boxIndices=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23])}class L{static CORNER_LEFT_TOP_NEAR=0;static CORNER_LEFT_TOP_FAR=1;static CORNER_RIGHT_TOP_FAR=2;static CORNER_RIGHT_TOP_NEAR=3;static CORNER_LEFT_BOTTOM_NEAR=4;static CORNER_LEFT_BOTTOM_FAR=5;static CORNER_RIGHT_BOTTOM_FAR=6;static CORNER_RIGHT_BOTTOM_NEAR=7;_planes;_corners;constructor(t){this._planes=null,this._corners=null,t instanceof L?(this._planes=t._planes.map((t=>new S(t))),this._corners=t._corners.map((t=>new g(t)))):this.initWithMatrix(t)}get planes(){return this._planes}get corners(){return this._corners}getCorner(t){return this.corners[t]}containsPoint(t){for(const e of this.planes)if(e.distanceToPoint(t)<0)return!1;return!0}initWithMatrix(t){this._planes=this._planes||Array.from({length:6}).map((()=>new S)),this._planes[l.LEFT].setEquation(t.m30+t.m00,t.m31+t.m01,t.m32+t.m02,t.m33+t.m03).inplaceNormalize(),this._planes[l.RIGHT].setEquation(t.m30-t.m00,t.m31-t.m01,t.m32-t.m02,t.m33-t.m03).inplaceNormalize(),this._planes[l.BOTTOM].setEquation(t.m30+t.m10,t.m31+t.m11,t.m32+t.m12,t.m33+t.m13).inplaceNormalize(),this._planes[l.TOP].setEquation(t.m30-t.m10,t.m31-t.m11,t.m32-t.m12,t.m33-t.m13).inplaceNormalize(),this._planes[l.FRONT].setEquation(t.m30+t.m20,t.m31+t.m21,t.m32+t.m22,t.m33+t.m23).inplaceNormalize(),this._planes[l.BACK].setEquation(t.m30-t.m20,t.m31-t.m21,t.m32-t.m22,t.m33-t.m23).inplaceNormalize();const e=v.invert(t),i=I.ndcVertices.map((t=>new g(t[0],t[1],t[2])));this._corners=this._corners||[];for(let t=0;t<8;t++){const s=e.transformPoint(i[t]);this._corners[t]=s.scaleBy(1/s.w).xyz()}return this}}class F{static ClipLeft=1<<l.LEFT;static ClipRight=1<<l.RIGHT;static ClipBottom=1<<l.BOTTOM;static ClipTop=1<<l.TOP;static ClipFront=1<<l.FRONT;static ClipBack=1<<l.BACK;_minPoint;_maxPoint;constructor(t,e){t instanceof F?(this._minPoint=new g(t.minPoint),this._maxPoint=new g(t.maxPoint)):t instanceof g?(this._minPoint=new g(t),this._maxPoint=new g(e)):(this._minPoint=new g(0,0,0),this._maxPoint=new g(0,0,0))}get minPoint(){return this._minPoint}set minPoint(t){this._minPoint.set(t)}get maxPoint(){return this._maxPoint}set maxPoint(t){this._maxPoint.set(t)}get extents(){return g.sub(this._maxPoint,this._minPoint).scaleBy(.5)}get center(){return g.add(this._maxPoint,this._minPoint).scaleBy(.5)}get size(){return g.sub(this._maxPoint,this._minPoint)}get diagonalLength(){return g.sub(this._maxPoint,this._minPoint).magnitude}computePoints(){const{x:t,y:e,z:i}=this._minPoint,{x:s,y:r,z:a}=this._maxPoint;return[new g(t,e,i),new g(t,r,i),new g(s,e,i),new g(s,r,i),new g(t,e,a),new g(t,r,a),new g(s,e,a),new g(s,r,a)]}inplaceTransform(t){return F.transform(this,t,this)}beginExtend(){this._minPoint.setXYZ(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this._maxPoint.setXYZ(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)}extend(t){this._minPoint.inplaceMin(t),this._maxPoint.inplaceMax(t)}extend3(t,e,i){t<this._minPoint.x&&(this._minPoint.x=t),t>this._maxPoint.x&&(this._maxPoint.x=t),e<this._minPoint.y&&(this._minPoint.y=e),e>this._maxPoint.y&&(this._maxPoint.y=e),i<this._minPoint.z&&(this._minPoint.z=i),i>this._maxPoint.z&&(this._maxPoint.z=i)}union(t){return t&&t.isValid()&&(this.extend(t._minPoint),this.extend(t._maxPoint)),this}isValid(){return this._minPoint.x<=this._maxPoint.x&&this._minPoint.y<=this._maxPoint.y&&this._minPoint.z<=this._maxPoint.z}equalsTo(t,e){return this._minPoint.equalsTo(t._minPoint,e)&&this._maxPoint.equalsTo(t._maxPoint,e)}intersectedWithBox(t){return!(this._maxPoint.x<=t._minPoint.x||this._minPoint.x>=t._maxPoint.x||this._maxPoint.y<=t._minPoint.y||this._minPoint.y>=t._maxPoint.y||this._maxPoint.z<=t._minPoint.z||this._minPoint.z>=t._maxPoint.z)}containsPoint(t){return this._minPoint.x<=t.x&&this._maxPoint.x>=t.x&&this._minPoint.y<=t.y&&this._maxPoint.y>=t.y&&this._minPoint.z<=t.z&&this._maxPoint.z>=t.z}containsBox(t){return this._minPoint.x<=t._minPoint.x&&this._maxPoint.x>=t._maxPoint.x&&this._minPoint.y<=t._minPoint.y&&this._maxPoint.y>=t._maxPoint.y&&this._minPoint.z<=t._minPoint.z&&this._maxPoint.z>=t._maxPoint.z}getClipStateMask(t,e){let i=65535,s=0;const r=new g,a=new T,n=e&F.ClipLeft,o=e&F.ClipRight,h=e&F.ClipTop,u=e&F.ClipBottom,l=e&F.ClipFront,d=e&F.ClipBack,p=this._minPoint,_=this._maxPoint;for(let e=0;e<8;e++){let c=0;r.setXYZ(1&e?p.x:_.x,2&e?p.y:_.y,3&e?p.z:_.z),t.transformPoint(r,a),n&&a.x<-a.w?c|=F.ClipLeft:o&&a.x>a.w&&(c|=F.ClipRight),u&&a.y<-a.w?c|=F.ClipBottom:h&&a.y>a.w&&(c|=F.ClipTop),d&&a.z<-a.w?c|=F.ClipBack:l&&a.z>a.w&&(c|=F.ClipFront),i&=c,s|=c}return 0===s?c.A_INSIDE_B:0!==i?c.NOT_CLIPPED:c.CLIPPED}getClipState(t){let e=65535,i=0;const s=new g,r=new T,a=this._minPoint,n=this._maxPoint;for(let o=0;o<8;o++){let h=0;s.setXYZ(1&o?a.x:n.x,2&o?a.y:n.y,3&o?a.z:n.z),t.transformPoint(s,r),r.x<-r.w?h|=F.ClipLeft:r.x>r.w&&(h|=F.ClipRight),r.y<-r.w?h|=F.ClipBottom:r.y>r.w&&(h|=F.ClipTop),r.z<-r.w?h|=F.ClipBack:r.z>r.w&&(h|=F.ClipFront),e&=h,i|=h}return 0===i?c.A_INSIDE_B:0!==e?c.NOT_CLIPPED:c.CLIPPED}behindPlane(t){const e=.5*(this._maxPoint.x+this._minPoint.x),i=.5*(this._maxPoint.y+this._minPoint.y),s=.5*(this._maxPoint.z+this._minPoint.z),r=this._maxPoint.x-e,a=this._maxPoint.y-i,n=this._maxPoint.z-s;return t.a*(e+t.px*r)+t.b*(i+t.py*a)+t.c*(s+t.pz*n)+t.d<0}getClipStateWithFrustum(t){let e=!1;const i=.5*(this._maxPoint.x+this._minPoint.x),s=.5*(this._maxPoint.y+this._minPoint.y),r=.5*(this._maxPoint.z+this._minPoint.z),a=this._maxPoint.x-i,n=this._maxPoint.y-s,o=this._maxPoint.z-r;for(let h=0;h<6;h++){const u=t.planes[h];if(u.a*(i+u.px*a)+u.b*(s+u.py*n)+u.c*(r+u.pz*o)+u.d<0)return c.NOT_CLIPPED;u.a*(i+u.nx*a)+u.b*(s+u.ny*n)+u.c*(r+u.nz*o)+u.d<0&&(e=!0)}return e?c.CLIPPED:c.A_INSIDE_B}getClipStateWithFrustumMask(t,e){let i=!1;const s=.5*(this._maxPoint.x+this._minPoint.x),r=.5*(this._maxPoint.y+this._minPoint.y),a=.5*(this._maxPoint.z+this._minPoint.z),n=this._maxPoint.x-s,o=this._maxPoint.y-r,h=this._maxPoint.z-a;for(let u=0;u<6;u++)if(e&1<<u){const e=t.planes[u];if(e.a*(s+e.px*n)+e.b*(r+e.py*o)+e.c*(a+e.pz*h)+e.d<0)return c.NOT_CLIPPED;e.a*(s+e.nx*n)+e.b*(r+e.ny*o)+e.c*(a+e.nz*h)+e.d<0&&(i=!0)}return i?c.CLIPPED:c.A_INSIDE_B}static transform(t,e,i){const s=i||new F,r=[0,0,0],a=[0,0,0],n=t.minPoint,o=t.maxPoint;let h;for(let t=0;t<3;++t){h=t,r[t]=a[t]=e[12+t];for(let i=0;i<3;++i){const s=e[h]*n[i],u=e[h]*o[i];s<u?(r[t]+=s,a[t]+=u):(r[t]+=u,a[t]+=s),h+=4}}return s.minPoint.set(r),s.maxPoint.set(a),s}}const P=new g,B=new g,O=new g,U=new g,V=new g;class G{_origin;_direction;_ii;_ij;_ik;_ibyj;_jbyi;_kbyj;_jbyk;_ibyk;_kbyi;_c_xy;_c_xz;_c_yx;_c_yz;_c_zx;_c_zy;bboxIntersectionTest;bboxIntersectionTestEx;constructor(t,e){this._origin=t?new g(t):g.zero(),this._direction=e?new g(e):g.axisPZ(),this.prepare()}get origin(){return this._origin}get direction(){return this._direction}set(t,e){this._origin.set(t),this._direction.set(e),this.prepare()}transform(t,e){if(e)t.transformPointAffine(this._origin,e._origin),t.transformPointAffine(g.add(this._origin,this._direction),e._direction).subBy(e._origin).inplaceNormalize(),e.prepare();else{const i=t.transformPointAffine(this._origin),s=t.transformPointAffine(g.add(this._origin,this._direction)).subBy(i).inplaceNormalize();e=new G(i,s)}return e}intersectionTestTriangle(t,e,i,s){const r=this._origin,a=this._direction,n=g.sub(e,t,P),o=g.sub(i,t,B),h=g.cross(a,o,O),u=g.dot(n,h);if(s){if(u<0)return null;const e=g.sub(r,t,U),i=g.dot(e,h);if(i<0||i>u)return null;const s=g.cross(e,n,V),l=g.dot(a,s);return l<0||i+l>u?null:g.dot(o,s)/u}{if(u>-1e-4&&u<1e-4)return null;const e=1/u,i=g.sub(r,t,U),s=e*g.dot(i,h);if(s<0||s>1)return null;const l=g.cross(i,n,V),c=e*g.dot(a,l);return c<0||s+c>1?null:g.dot(o,l)*e}}qtestMMM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.y<i||this._origin.z<s||this._jbyi*e-a+this._c_xy>0||this._ibyj*i-r+this._c_yx>0||this._jbyk*s-a+this._c_zy>0||this._kbyj*i-n+this._c_yz>0||this._kbyi*e-n+this._c_xz>0||this._ibyk*s-r+this._c_zx>0)}qtestMMMEx(t){if(!this.qtestMMM(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestMMP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.y<i||this._origin.z>n||this._jbyi*e-a+this._c_xy>0||this._ibyj*i-r+this._c_yx>0||this._jbyk*n-a+this._c_zy>0||this._kbyj*i-s+this._c_yz<0||this._kbyi*e-s+this._c_xz<0||this._ibyk*n-r+this._c_zx>0)}qtestMMPEx(t){if(!this.qtestMMP(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestMPM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.y>a||this._origin.z<s||this._jbyi*e-i+this._c_xy<0||this._ibyj*a-r+this._c_yx>0||this._jbyk*s-i+this._c_zy<0||this._kbyj*a-n+this._c_yz>0||this._kbyi*e-n+this._c_xz>0||this._ibyk*s-r+this._c_zx>0)}qtestMPMEx(t){if(!this.qtestMPM(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestMPP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.y>a||this._origin.z>n||this._jbyi*e-i+this._c_xy<0||this._ibyj*a-r+this._c_yx>0||this._jbyk*n-i+this._c_zy<0||this._kbyj*a-s+this._c_yz<0||this._kbyi*e-s+this._c_xz<0||this._ibyk*n-r+this._c_zx>0)}qtestMPPEx(t){if(!this.qtestMPP(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPMM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x>r||this._origin.y<i||this._origin.z<s||this._jbyi*r-a+this._c_xy>0||this._ibyj*i-e+this._c_yx<0||this._jbyk*s-a+this._c_zy>0||this._kbyj*i-n+this._c_yz>0||this._kbyi*r-n+this._c_xz>0||this._ibyk*s-e+this._c_zx<0)}qtestPMMEx(t){if(!this.qtestPMM(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPMP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x>r||this._origin.y<i||this._origin.z>n||this._jbyi*r-a+this._c_xy>0||this._ibyj*i-e+this._c_yx<0||this._jbyk*n-a+this._c_zy>0||this._kbyj*i-s+this._c_yz<0||this._kbyi*r-s+this._c_xz<0||this._ibyk*n-e+this._c_zx<0)}qtestPMPEx(t){if(!this.qtestPMP(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPPM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x>r||this._origin.y>a||this._origin.z<s||this._jbyi*r-i+this._c_xy<0||this._ibyj*a-e+this._c_yx<0||this._jbyk*s-i+this._c_zy<0||this._kbyj*a-n+this._c_yz>0||this._kbyi*r-n+this._c_xz>0||this._ibyk*s-e+this._c_zx<0)}qtestPPMEx(t){if(!this.qtestPPM(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPPP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x>r||this._origin.y>a||this._origin.z>n||this._jbyi*r-i+this._c_xy<0||this._ibyj*a-e+this._c_yx<0||this._jbyk*n-i+this._c_zy<0||this._kbyj*a-s+this._c_yz<0||this._kbyi*r-s+this._c_xz<0||this._ibyk*n-e+this._c_zx<0)}qtestPPPEx(t){if(!this.qtestPPP(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestOMM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y<i||this._origin.z<s||this._jbyk*s-a+this._c_zy>0||this._kbyj*i-n+this._c_yz>0)}qtestOMMEx(t){if(!this.qtestOMM(t))return null;let e=(t.maxPoint.y-this._origin.y)*this._ij;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestOMP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y<i||this._origin.z>n||this._jbyk*n-a+this._c_zy>0||this._kbyj*i-s+this._c_yz<0)}qtestOMPEx(t){if(!this.qtestOMP(t))return null;let e=(t.maxPoint.y-this._origin.y)*this._ij;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestOPM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y>a||this._origin.z<s||this._jbyk*s-i+this._c_zy<0||this._kbyj*a-n+this._c_yz>0)}qtestOPMEx(t){if(!this.qtestOPM(t))return null;let e=(t.minPoint.y-this._origin.y)*this._ij;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestOPP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y>a||this._origin.z>n||this._jbyk*n-i+this._c_zy<0||this._kbyj*a-s+this._c_yz<0)}qtestOPPEx(t){if(!this.qtestOPP(t))return null;let e=(t.minPoint.y-this._origin.y)*this._ij;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestMOM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>a||this._origin.x<e||this._origin.z<s||this._kbyi*e-n+this._c_xz>0||this._ibyk*s-r+this._c_zx>0)}qtestMOMEx(t){if(!this.qtestMOM(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestMOP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>a||this._origin.x<e||this._origin.z>n||this._kbyi*e-s+this._c_xz<0||this._ibyk*n-r+this._c_zx>0)}qtestMOPEx(t){if(!this.qtestMOP(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestPOM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>a||this._origin.x>r||this._origin.z<s||this._kbyi*r-n+this._c_xz>0||this._ibyk*s-e+this._c_zx<0)}qtestPOMEx(t){if(!this.qtestPOM(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestPOP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>a||this._origin.x>r||this._origin.z>n||this._kbyi*r-s+this._c_xz<0||this._ibyk*n-e+this._c_zx<0)}qtestPOPEx(t){if(!this.qtestPOP(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestMMO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>n||this._origin.x<e||this._origin.y<i||this._jbyi*e-a+this._c_xy>0||this._ibyj*i-r+this._c_yx>0)}qtestMMOEx(t){if(!this.qtestMMO(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestMPO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>n||this._origin.x<e||this._origin.y>a||this._jbyi*e-i+this._c_xy<0||this._ibyj*a-r+this._c_yx>0)}qtestMPOEx(t){if(!this.qtestMPO(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestPMO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>n||this._origin.x>r||this._origin.y<i||this._jbyi*r-a+this._c_xy>0||this._ibyj*i-e+this._c_yx<0)}qtestPMOEx(t){if(!this.qtestPMO(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestPPO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>n||this._origin.x>r||this._origin.y>a||this._jbyi*r-i+this._c_xy<0||this._ibyj*a-e+this._c_yx<0)}qtestPPOEx(t){if(!this.qtestPPO(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestMOO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x<e||this._origin.y<i||this._origin.y>r||this._origin.z<s||this._origin.z>a)}qtestMOOEx(t){if(!this.qtestMOO(t))return null;return(t.maxPoint.x-this._origin.x)*this._ii}qtestPOO(t){const e=t.minPoint.y,i=t.minPoint.z,s=t.maxPoint.x,r=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x>s||this._origin.y<e||this._origin.y>r||this._origin.z<i||this._origin.z>a)}qtestPOOEx(t){if(!this.qtestPOO(t))return null;return(t.minPoint.x-this._origin.x)*this._ii}qtestOMO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.z;return!(this._origin.y<i||this._origin.x<e||this._origin.x>r||this._origin.z<s||this._origin.z>a)}qtestOMOEx(t){if(!this.qtestOMO(t))return null;return(t.maxPoint.y-this._origin.y)*this._ij}qtestOPO(t){const e=t.minPoint.x,i=t.minPoint.z,s=t.maxPoint.x,r=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.y>r||this._origin.x<e||this._origin.x>s||this._origin.z<i||this._origin.z>a)}qtestOPOEx(t){if(!this.qtestOPO(t))return null;return(t.minPoint.y-this._origin.y)*this._ij}qtestOOM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y;return!(this._origin.z<s||this._origin.x<e||this._origin.x>r||this._origin.y<i||this._origin.y>a)}qtestOOMEx(t){if(!this.qtestOOM(t))return null;return(t.maxPoint.z-this._origin.z)*this._ik}qtestOOP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.maxPoint.x,r=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.z>a||this._origin.x<e||this._origin.x>s||this._origin.y<i||this._origin.y>r)}qtestOOPEx(t){if(!this.qtestOOP(t))return null;return(t.minPoint.z-this._origin.z)*this._ik}prepare(){const t=this._origin.x,e=this._origin.y,i=this._origin.z,s=this._direction.x,r=this._direction.y,a=this._direction.z;this._ii=1/s,this._ij=1/r,this._ik=1/a,this._ibyj=s*this._ij,this._jbyi=r*this._ii,this._jbyk=r*this._ik,this._kbyj=a*this._ij,this._ibyk=s*this._ik,this._kbyi=a*this._ii,this._c_xy=e-this._jbyi*t,this._c_xz=i-this._kbyi*t,this._c_yx=t-this._ibyj*e,this._c_yz=i-this._kbyj*e,this._c_zx=t-this._ibyk*i,this._c_zy=e-this._jbyk*i,s<0?r<0?a<0?(this.bboxIntersectionTest=this.qtestMMM,this.bboxIntersectionTestEx=this.qtestMMMEx):a>0?(this.bboxIntersectionTest=this.qtestMMP,this.bboxIntersectionTestEx=this.qtestMMPEx):(this.bboxIntersectionTest=this.qtestMMO,this.bboxIntersectionTestEx=this.qtestMMOEx):a<0?(this.bboxIntersectionTest=r>0?this.qtestMPM:this.qtestMOM,this.bboxIntersectionTestEx=r>0?this.qtestMPMEx:this.qtestMOMEx):0===r&&0===a?(this.bboxIntersectionTest=this.qtestMOO,this.bboxIntersectionTestEx=this.qtestMOOEx):0===a?(this.bboxIntersectionTest=this.qtestMPO,this.bboxIntersectionTestEx=this.qtestMPOEx):0===r?(this.bboxIntersectionTest=this.qtestMOP,this.bboxIntersectionTestEx=this.qtestMOPEx):(this.bboxIntersectionTest=this.qtestMPP,this.bboxIntersectionTestEx=this.qtestMPPEx):r<0?a<0?(this.bboxIntersectionTest=s>0?this.qtestPMM:this.qtestOMM,this.bboxIntersectionTestEx=s>0?this.qtestPMMEx:this.qtestOMMEx):0===s&&0===a?(this.bboxIntersectionTest=this.qtestOMO,this.bboxIntersectionTestEx=this.qtestOMOEx):0===a?(this.bboxIntersectionTest=this.qtestPMO,this.bboxIntersectionTestEx=this.qtestPMOEx):0===s?(this.bboxIntersectionTest=this.qtestOMP,this.bboxIntersectionTestEx=this.qtestOMPEx):(this.bboxIntersectionTest=this.qtestPMP,this.bboxIntersectionTestEx=this.qtestPMPEx):a<0?0===s&&0===r?(this.bboxIntersectionTest=this.qtestOOM,this.bboxIntersectionTestEx=this.qtestOOMEx):0===s?(this.bboxIntersectionTest=this.qtestOPM,this.bboxIntersectionTestEx=this.qtestOPMEx):0===r?(this.bboxIntersectionTest=this.qtestPOM,this.bboxIntersectionTestEx=this.qtestPOMEx):(this.bboxIntersectionTest=this.qtestPPM,this.bboxIntersectionTestEx=this.qtestPPMEx):0===s?0===r?(this.bboxIntersectionTest=this.qtestOOP,this.bboxIntersectionTestEx=this.qtestOOPEx):0===a?(this.bboxIntersectionTest=this.qtestOPO,this.bboxIntersectionTestEx=this.qtestOPOEx):(this.bboxIntersectionTest=this.qtestOPP,this.bboxIntersectionTestEx=this.qtestOPPEx):0===r&&0===a?(this.bboxIntersectionTest=this.qtestPOO,this.bboxIntersectionTestEx=this.qtestPOOEx):0===r?(this.bboxIntersectionTest=this.qtestPOP,this.bboxIntersectionTestEx=this.qtestPOPEx):0===a?(this.bboxIntersectionTest=this.qtestPPO,this.bboxIntersectionTestEx=this.qtestPPOEx):(this.bboxIntersectionTest=this.qtestPPP,this.bboxIntersectionTestEx=this.qtestPPPEx)}}class z{_bins;_maxBins;_width;_height;constructor(t,e,i=0){this._width=t,this._height=e,this._maxBins=i,this._bins=[new k(this._width,this._height)]}clear(){this._bins=[new k(this._width,this._height)]}insert(t,e){if(t>this._width||e>this._height)return null;const i=this._bins[this._bins.length-1].insert(t,e);if(i)return{x:i.x,y:i.y,width:i.width,height:i.height,binIndex:this._bins.length-1};if(0===this._maxBins||this._bins.length<this._maxBins){this._bins.push(new k(this._width,this._height));const i=this._bins[this._bins.length-1].insert(t,e);return{x:i.x,y:i.y,width:i.width,height:i.height,binIndex:this._bins.length-1}}return null}}class k{freeRects;constructor(t,e){this.freeRects=[{x:0,y:0,width:t,height:e}]}insert(t,e){const i=this.findBestFit(t,e);if(!i)return null;let s=this.freeRects.length,r=0;for(;r<s;)this.splitFreeRect(this.freeRects[r],i)&&(this.freeRects.splice(r,1),--s,--r),++r;return this.pruneFreeRects(),i}findBestFit(t,e){let i=Number.MAX_VALUE,s=null;for(const r of this.freeRects)if(r.width>=t&&r.height>=e){const a=r.width*r.height-t*e;a<i&&(s||(s={width:t,height:e}),s.x=r.x,s.y=r.y,i=a)}return s}splitFreeRect(t,e){return!(e.x>=t.x+t.width||e.x+e.width<=t.x||e.y>=t.y+t.height||e.y+e.height<=t.y)&&(e.x<t.x+t.width&&e.x+e.width>t.x&&(e.y>t.y&&e.y<t.y+t.height&&this.freeRects.push({x:t.x,y:t.y,width:t.width,height:e.y-t.y}),e.y+e.height<t.y+t.height&&this.freeRects.push({x:t.x,y:e.y+e.height,width:t.width,height:t.y+t.height-e.y-e.height})),e.y<t.y+t.height&&e.y+e.height>t.y&&(e.x>t.x&&e.x<t.x+t.width&&this.freeRects.push({x:t.x,y:t.y,width:e.x-t.x,height:t.height}),e.x+e.width<t.x+t.width&&this.freeRects.push({x:e.x+e.width,y:t.y,width:t.x+t.width-e.x-e.width,height:t.height})),!0)}pruneFreeRects(){let t=0,e=0,i=this.freeRects.length;for(;t<i;){e=t+1;const s=this.freeRects[t];for(;e<i;){const r=this.freeRects[e];if(this.isRectInRect(s,r)){this.freeRects.splice(t,1),--t,--i;break}this.isRectInRect(r,s)&&(this.freeRects.splice(e,1),--e,--i),e++}t++}}isRectInRect(t,e){return t.x>=e.x&&t.y>=e.y&&t.x+t.width<=e.x+e.width&&t.y+t.height<=e.y+e.height}}class X{_app;_target;_started;_clickDistTolerance;_clickTimeTolerance;_dblclickDistTolerance;_dblclickTimeTolerance;_pointerDownHandler;_pointerUpHandler;_pointerMoveHandler;_pointerCancelHandler;_keyboardHandler;_dragHandler;_wheelHandler;_captureId;_middlewares;_lastEventDatas;constructor(t){this._app=t,this._target=t.options.canvas,this._started=!1,this._clickDistTolerance=16,this._clickTimeTolerance=400,this._dblclickDistTolerance=16,this._dblclickTimeTolerance=400,this._lastEventDatas=[],this._pointerDownHandler=this._getPointerDownHandler(),this._pointerUpHandler=this._getPointerUpHandler(),this._pointerMoveHandler=this._getPointerMoveHander(),this._pointerCancelHandler=this._getPointerCancelHandler(),this._keyboardHandler=this._getKeyboardHandler(),this._dragHandler=this._getDragHandler(),this._wheelHandler=this._getWheelHandler(),this._captureId=-1,this._middlewares=[]}start(){this._started||(this._started=!0,this._target.addEventListener("pointerdown",this._pointerDownHandler),this._target.addEventListener("pointerup",this._pointerUpHandler),this._target.addEventListener("pointermove",this._pointerMoveHandler),this._target.addEventListener("pointercancel",this._pointerCancelHandler),this._target.addEventListener("keydown",this._keyboardHandler),this._target.addEventListener("keyup",this._keyboardHandler),this._target.addEventListener("keypress",this._keyboardHandler),this._target.addEventListener("drag",this._dragHandler),this._target.addEventListener("dragenter",this._dragHandler),this._target.addEventListener("dragleave",this._dragHandler),this._target.addEventListener("dragstart",this._dragHandler),this._target.addEventListener("dragend",this._dragHandler),this._target.addEventListener("dragover",this._dragHandler),this._target.addEventListener("drop",this._dragHandler),this._target.addEventListener("wheel",this._wheelHandler))}stop(){this._started&&(this._started=!1,this._target.removeEventListener("pointerdown",this._pointerDownHandler),this._target.removeEventListener("pointerup",this._pointerUpHandler),this._target.removeEventListener("pointermove",this._pointerMoveHandler),this._target.removeEventListener("pointercancel",this._pointerCancelHandler),this._target.removeEventListener("keydown",this._keyboardHandler),this._target.removeEventListener("keyup",this._keyboardHandler),this._target.removeEventListener("keypress",this._keyboardHandler),this._target.removeEventListener("drag",this._dragHandler),this._target.removeEventListener("dragenter",this._dragHandler),this._target.removeEventListener("dragleave",this._dragHandler),this._target.removeEventListener("dragstart",this._dragHandler),this._target.removeEventListener("dragend",this._dragHandler),this._target.removeEventListener("dragover",this._dragHandler),this._target.removeEventListener("drop",this._dragHandler),this._target.removeEventListener("wheel",this._wheelHandler),this._lastEventDatas=[])}use(t){return t&&this._middlewares.push(t),this}_callMiddlewares(t,e){for(const i of this._middlewares)if(i(t,e??t.type))return!0;return!1}_getPointerCancelHandler(){const t=this;return function(e){const i=t._getPointerEventData(e.pointerId);i.lastDown=!1,i.lastClick=!1,t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getPointerMoveHander(){const t=this;return function(e){const i=t._getPointerEventData(e.pointerId);i.lastMoveX=e.offsetX,i.lastMoveY=e.offsetY,t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getPointerDownHandler(){const t=this;return function(e){"mouse"===e.pointerType&&0===e.button&&(t._captureId=e.pointerId,t._app.options.canvas.setPointerCapture(e.pointerId));const i=t._getPointerEventData(e.pointerId);i.lastDown=!0,i.lastDownX=e.offsetX,i.lastDownY=e.offsetY,i.lastDownTime=Date.now(),t._app.focus(),t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getPointerUpHandler(){const t=this;return function(e){"mouse"===e.pointerType&&0===e.button&&t._captureId===e.pointerId&&(t._app.options.canvas.releasePointerCapture(e.pointerId),t._captureId=-1);const i=t._getPointerEventData(e.pointerId);let s=!1,r=!1;const a=Date.now();if(i.lastDown&&a<=i.lastDownTime+t._clickTimeTolerance){let n=e.offsetX-i.lastDownX,o=e.offsetY-i.lastDownY;n*n+o*o<=t._clickDistTolerance&&(s=!0,i.lastClick&&a<=i.lastClickTime+t._dblclickTimeTolerance&&(n=e.offsetX-i.lastClickX,o=e.offsetY-i.lastClickY,n*n+o*o<=t._dblclickDistTolerance&&(r=!0)))}i.lastDown=!1,i.lastMoveX=e.offsetX,i.lastMoveY=e.offsetY,t._callMiddlewares(e)||t._app.dispatchEvent(e),s&&(t._callMiddlewares(e,"click")||t._app.dispatchEvent(e,"click"),r?(t._callMiddlewares(e,"dblclick")||t._app.dispatchEvent(e,"dblclick"),i.lastClick=!1):(i.lastClick=!0,i.lastClickX=e.offsetX,i.lastClickY=e.offsetY,i.lastClickTime=a))}}_getKeyboardHandler(){const t=this;return function(e){t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getDragHandler(){const t=this;return function(e){t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getWheelHandler(){const t=this;return function(e){t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getPointerEventData(t){return this._lastEventDatas[t]??(this._lastEventDatas[t]={lastClick:!1,lastClickX:0,lastClickY:0,lastClickTime:0,lastDown:!1,lastDownX:0,lastDownY:0,lastDownTime:0,lastMoveX:0,lastMoveY:0})}}class W{type="tick"}class H{width;height;type;constructor(t,e){this.type="resize",this.width=t,this.height=e}}class Y extends(e(Object)()){_options;_device;_inputManager;_running;_ready;_canRender;_drawEvent;_logger;_elapsed;static _instance;constructor(t){if(super(),Y._instance)throw new Error("It is not allowed to have multiple Application instances");Y._instance=this,this._options={backend:t.backend,enableMSAA:t.enableMSAA??!1,pixelRatio:t.pixelRatio??window.devicePixelRatio??1,canvas:t.canvas},this._inputManager=new X(this),this._running=null,this._ready=!1,this._canRender=!1,this._elapsed=0,this._drawEvent=new W,this._logger={log(t,e){"warn"===e?console.warn(t):"error"===e?console.error(t):"debug"===e?console.debug(t):"info"===e?console.info(t):console.log(t)}}}get inputManager(){return this._inputManager}get options(){return this._options}get canRender(){return this._canRender}get timeElapsedInSeconds(){return this._elapsed}static get instance(){return this._instance}get device(){return this._device}get deviceType(){return this._options.backend.typeName()}get logger(){return this._logger}set logger(t){this._logger=t}focus(){this._device.canvas.focus()}async ready(){if(!this._ready){if(this._device=await this._options.backend.createDevice(this._options.canvas,{dpr:this._options.pixelRatio,msaa:!!this._options.enableMSAA}),!this._device)throw new Error("App.init(): create device failed");this._device.canvas.focus(),this._inputManager.start(),this._device.on("resize",(t=>{this.dispatchEvent(new H(t.width,t.height))})),this._ready=!0}}frame(){this._ready&&(this._canRender=this.device.beginFrame(),this._elapsed=.001*this.device.frameInfo.elapsedFrame,this.device.setFramebuffer(null),this.device.setViewport(null),this.device.setScissor(null),this.dispatchEvent(this._drawEvent),this.device.endFrame())}run(){if(this._running)return;const t=this;!function e(){t._running=requestAnimationFrame(e),t.frame()}()}stop(){this._running&&(cancelAnimationFrame(this._running),this._running=null)}log(t,e){this._logger?.log(t,e)}}let q=null,j=null;const Z={},K=[[new g(0,0,-1),new g(0,-1,0),new g(1,0,0)],[new g(0,0,1),new g(0,-1,0),new g(-1,0,0)],[new g(1,0,0),new g(0,0,1),new g(0,1,0)],[new g(1,0,0),new g(0,0,-1),new g(0,-1,0)],[new g(1,0,0),new g(0,-1,0),new g(0,0,1)],[new g(-1,0,0),new g(0,-1,0),new g(0,0,-1)]];function Q(t,e){const i=Y.instance.device,s=`${t}:${e}`;let r=Z[s];if(!r){const a=function(t,e){const i=Y.instance.device,s=i;return s.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.up=t.vec3().uniform(0),this.right=t.vec3().uniform(0),this.front=t.vec3().uniform(0),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.direction=t.mul(t.mat3(this.up,this.right,this.front),t.vec3(this.$inputs.pos,1)),"webgpu"===i.type&&(this.$builtins.position.y=t.neg(this.$builtins.position.y))}))},fragment(s){"ggx"===t&&(this.alphaG=s.float().uniform(0)),this.vFilteringInfo=s.vec2().uniform(0),this.hdrScale=s.float().uniform(0),this.inputTexture=s.texCube().uniform(0),this.NUM_SAMPLES_FLOAT=s.float(e),this.NUM_SAMPLES_FLOAT_INVERSED=s.float(1/e),this.K=s.float(4),this.$outputs.outcolor=s.vec4(),"webgl"===i.type?(s.func("radicalInverse_VdC",[s.int("bits")],(function(){this.$l.rand=s.float(0),this.$l.denom=s.float(1),this.$l.invBase=s.float(.5),this.$l.n=this.bits,this.$for(s.int("i"),0,32,(function(){this.denom=s.mul(this.denom,2),this.rand=s.add(this.rand,s.div(s.mod(s.float(this.n),2),this.denom)),this.n=s.div(this.n,2),this.$if(s.equal(this.n,0),(function(){this.$break()}))})),this.$return(this.rand)})),s.func("hammersley2d",[s.int("i"),s.int("N")],(function(){this.$return(s.vec2(s.div(s.float(this.i),s.float(this.N)),this.radicalInverse_VdC(this.i)))}))):(s.func("radicalInverse_VdC",[s.uint("bits")],(function(){this.$l.n=this.bits,this.n=s.compOr(s.sal(this.n,16),s.sar(this.n,16)),this.n=s.compOr(s.sal(s.compAnd(this.n,1431655765),1),s.sar(s.compAnd(this.n,2863311530),1)),this.n=s.compOr(s.sal(s.compAnd(this.n,858993459),2),s.sar(s.compAnd(this.n,3435973836),2)),this.n=s.compOr(s.sal(s.compAnd(this.n,252645135),4),s.sar(s.compAnd(this.n,4042322160),4)),this.n=s.compOr(s.sal(s.compAnd(this.n,16711935),8),s.sar(s.compAnd(this.n,4278255360),8)),this.$return(s.mul(s.float(this.n),2.3283064365386963e-10))})),s.func("hammersley2d",[s.int("i"),s.int("N")],(function(){this.$return(s.vec2(s.div(s.float(this.i),s.float(this.N)),this.radicalInverse_VdC(s.uint(this.i))))}))),s.func("log4",[s.float("x")],(function(){this.$return(s.mul(s.log2(this.x),.5))})),"lambertian"===t&&(s.func("hemisphereCosSample",[s.vec2("u")],(function(){this.$l.phi=s.mul(this.u.x,2*Math.PI),this.$l.cosTheta2=s.sub(1,this.u.y),this.$l.cosTheta=s.sqrt(this.cosTheta2),this.$l.sinTheta=s.sqrt(s.sub(1,this.cosTheta2)),this.$return(s.vec3(s.mul(this.sinTheta,s.cos(this.phi)),s.mul(this.sinTheta,s.sin(this.phi)),this.cosTheta))})),s.func("irradiance",[s.vec3("direction"),s.vec2("vFilteringInfo")],(function(){this.$l.n=s.normalize(this.direction),this.$l.result=s.vec3(0),this.$l.tangent=s.vec3(),this.$if(s.lessThan(s.abs(this.n.z),.999),(function(){this.tangent=s.vec3(0,0,1)})).$else((function(){this.tangent=s.vec3(1,0,0)})),this.tangent=s.normalize(s.cross(this.tangent,this.n)),this.$l.bitangent=s.cross(this.n,this.tangent),this.$l.tbn=s.mat3(this.tangent,this.bitangent,this.n),this.$l.maxLevel=this.vFilteringInfo.y,this.$l.dim0=this.vFilteringInfo.x,this.$l.omegaP=s.div(4*Math.PI,s.mul(this.dim0,this.dim0,6)),this.$for(s.int("i"),0,e,(function(){this.$l.Xi=this.hammersley2d(this.i,e),this.$l.Ls=s.normalize(this.hemisphereCosSample(this.Xi)),this.$l.Ns=s.vec3(0,0,1),this.$l.NoL=s.dot(this.Ns,this.Ls),this.$if(s.greaterThan(this.NoL,0),(function(){this.$l.pdf_inversed=s.div(Math.PI,this.NoL),this.$l.omegaS=s.mul(this.pdf_inversed,this.NUM_SAMPLES_FLOAT_INVERSED),this.$l.l=s.add(s.sub(this.log4(this.omegaS),this.log4(this.omegaP)),this.log4(this.K)),this.$l.mipLevel=s.clamp(this.l,0,this.maxLevel),this.$l.c=s.textureSampleLevel(this.inputTexture,s.mul(this.tbn,this.Ls),this.mipLevel).rgb,this.result=s.add(this.result,this.c)}))})),this.result=s.mul(this.result,this.NUM_SAMPLES_FLOAT_INVERSED),this.$return(this.result)}))),"ggx"===t&&(s.func("hemisphereImportanceSampleDggx",[s.vec2("u"),s.float("a")],(function(){this.$l.phi=s.mul(this.u.x,2*Math.PI),this.$l.cosTheta2=s.div(s.sub(1,this.u.y),s.add(s.mul(s.add(this.a,1),s.sub(this.a,1),this.u.y),1)),this.$l.cosTheta=s.sqrt(this.cosTheta2),this.$l.sinTheta=s.sqrt(s.sub(1,this.cosTheta2)),this.$return(s.vec3(s.mul(s.cos(this.phi),this.sinTheta),s.mul(s.sin(this.phi),this.sinTheta),this.cosTheta))})),s.func("normalDistributionFunction_TrowbridgeReitzGGX",[s.float("NoH"),s.float("alphaG")],(function(){this.$l.a2=s.mul(this.alphaG,this.alphaG),this.$l.d=s.add(s.mul(this.NoH,this.NoH,s.sub(this.a2,1)),1),this.$return(s.div(this.a2,s.mul(this.d,this.d,Math.PI)))})),s.func("radiance",[s.float("alphaG"),s.vec3("direction"),s.vec2("vFilteringInfo")],(function(){this.$l.n=s.normalize(this.direction),this.$if(s.equal(this.alphaG,0),(function(){this.$l.c=s.textureSampleLevel(this.inputTexture,this.n,0).rgb,this.$return(this.c)})).$else((function(){this.$l.result=s.vec3(0),this.$l.tangent=s.vec3(),this.$if(s.lessThan(s.abs(this.n.z),.999),(function(){this.tangent=s.vec3(0,0,1)})).$else((function(){this.tangent=s.vec3(1,0,0)})),this.tangent=s.normalize(s.cross(this.tangent,this.n)),this.$l.bitangent=s.cross(this.n,this.tangent),this.$l.tbn=s.mat3(this.tangent,this.bitangent,this.n),this.$l.maxLevel=this.vFilteringInfo.y,this.$l.dim0=this.vFilteringInfo.x,this.$l.omegaP=s.div(4*Math.PI,s.mul(this.dim0,this.dim0,6)),this.$l.weight=s.float(0),this.$for(s.int("i"),0,e,(function(){this.$l.Xi=this.hammersley2d(this.i,e),this.$l.H=this.hemisphereImportanceSampleDggx(this.Xi,this.alphaG),this.$l.NoV=s.float(1),this.$l.NoH=this.H.z,this.$l.NoH2=s.mul(this.H.z,this.H.z),this.$l.NoL=s.sub(s.mul(this.NoH2,2),1),this.$l.L=s.normalize(s.vec3(s.mul(this.NoH,this.H.x,2),s.mul(this.NoH,this.H.y,2),this.NoL)),this.$if(s.greaterThan(this.NoL,0),(function(){this.$l.pdf_inversed=s.div(4,this.normalDistributionFunction_TrowbridgeReitzGGX(this.NoH,this.alphaG)),this.$l.omegaS=s.mul(this.pdf_inversed,this.NUM_SAMPLES_FLOAT_INVERSED),this.$l.l=s.add(s.sub(this.log4(this.omegaS),this.log4(this.omegaP)),this.log4(this.K)),this.$l.mipLevel=s.clamp(this.l,0,this.maxLevel),this.weight=s.add(this.weight,this.NoL),this.$l.c=s.textureSampleLevel(this.inputTexture,s.mul(this.tbn,this.L),this.mipLevel).rgb,this.result=s.add(this.result,s.mul(this.c,this.NoL))}))})),this.result=s.div(this.result,this.weight),this.$return(this.result)}))}))),s.main((function(){"ggx"===t&&(this.$l.color=this.radiance(this.alphaG,this.$inputs.direction,this.vFilteringInfo)),"lambertian"===t&&(this.$l.color=this.irradiance(this.$inputs.direction,this.vFilteringInfo)),this.$outputs.outcolor=s.vec4(s.mul(this.color,this.hdrScale),1)}))}})}(t,e),n=i.createBindGroup(a.bindGroupLayouts[0]);Z[s]=r={program:a,bindgroup:n}}return r}function J(t,e,i,s,r,a,n){const o=Y.instance.device,h=o.createFrameBuffer([r],null);h.setColorAttachmentMipLevel(0,i),h.setColorAttachmentGenerateMipmaps(0,!1);const{program:u,bindgroup:l}=Q(t,n);l.setValue("vFilteringInfo",a),l.setValue("hdrScale",1),l.setTexture("inputTexture",s),"ggx"===t&&l.setValue("alphaG",e),o.setProgram(u),o.setBindGroup(0,l),o.setFramebuffer(h);for(let t=0;t<6;t++)h.setColorAttachmentCubeFace(0,t),o.setVertexLayout(q),o.setRenderStates(j),l.setValue("up",K[t][0]),l.setValue("right",K[t][1]),l.setValue("front",K[t][2]),o.draw("triangle-list",0,6)}function tt(t,e,i,s){if(!t||!t.isTextureCube())return void console.error("prefilterCubemap(): source texture must be cube texture");const r=Y.instance.device;q||function(){const t=Y.instance.device,e=new Float32Array([1,1,-1,1,-1,-1,1,-1]),i=new Uint16Array([0,1,2,0,2,3]);q=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",e)}],indexBuffer:t.createIndexBuffer(i)}),j=t.createRenderStateSet(),j.useRasterizerState().setCullMode("none"),j.useDepthState().enableTest(!1).enableWrite(!1)}(),r.pushDeviceStates();const a=r.getRenderStates(),n=t,o=t.width,h=t.mipLevelCount,u=new f(o,h),l="ggx"===e?i.mipLevelCount:1;for(let t=0;t<l;t++){J(e,0===t?0:Math.pow(2,t)/o,t,n,i,u,s??64)}r.popDeviceStates(),r.setRenderStates(a)}const et=1<<24,it=2<<24,st=3<<24,rt=16;function at(t,e,i,s,r,a,n,o,h,u,l,c,d,p,_){return t|((e?1:0)|(i?2:0)|(s?4:0)|(r?8:0))|((a?rt:0)|(n?32:0))|(o?64:0)|(h?128:0)|(u?256:0)|(l?512:0)|(c?1024:0)|(d<<16|p<<20|_<<11)}const nt={unknown:0,r8unorm:at(0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,1,1,1),r8snorm:at(0,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,1,1,1),r16f:at(0,!0,!1,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,2),r32f:at(0,!0,!1,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,4),r8ui:at(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,1),r8i:at(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,1),r16ui:at(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,2),r16i:at(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,2),r32ui:at(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,4),r32i:at(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,4),rg8unorm:at(0,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,1,1,2),rg8snorm:at(0,!0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,1,1,2),rg16f:at(0,!0,!0,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,4),rg32f:at(0,!0,!0,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,8),rg8ui:at(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,2),rg8i:at(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,2),rg16ui:at(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,4),rg16i:at(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,4),rg32ui:at(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,8),rg32i:at(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,8),rgba8unorm:at(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,1,1,4),"rgba8unorm-srgb":at(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,1,1,4),rgba8snorm:at(0,!0,!0,!0,!0,!1,!1,!1,!1,!0,!1,!1,1,1,4),bgra8unorm:at(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!0,1,1,4),"bgra8unorm-srgb":at(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!0,1,1,4),rgba16f:at(0,!0,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1,1,1,8),rgba32f:at(0,!0,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1,1,1,16),rgba8ui:at(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,4),rgba8i:at(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,4),rgba16ui:at(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,8),rgba16i:at(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,8),rgba32ui:at(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,16),rgba32i:at(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,16),rg11b10uf:at(0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,!1,1,1,4),d16:at(0,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,1,1,2),d24:at(0,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,0,0,0),d32f:at(0,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!1,1,1,4),d24s8:at(0,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,1,1,4),d32fs8:at(0,!1,!1,!1,!1,!0,!0,!0,!1,!0,!1,!1,1,1,5),dxt1:at(et,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,8),"dxt1-srgb":at(et,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,8),dxt3:at(it,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"dxt3-srgb":at(it,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),dxt5:at(st,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"dxt5-srgb":at(st,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16)};function ot(t){switch(t){case"rgba8unorm":return"rgba8unorm-srgb";case"bgra8unorm":return"bgra8unorm-srgb";case"dxt1":return"dxt1-srgb";case"dxt3":return"dxt3-srgb";case"dxt5":return"dxt5-srgb";default:return t}}function ht(t){return!!(nt[t]&rt)}function ut(t){return!!(64&nt[t])}function lt(t){return!!(128&nt[t])}function ct(t){return!!(256&nt[t])}function dt(t){return!!(520093696&nt[t])}function pt(t){return(63488&nt[t])>>11}var _t;!function(t){t[t.Vertex=1]="Vertex",t[t.Fragment=2]="Fragment",t[t.Compute=4]="Compute"}(_t||(_t={}));class mt{static NAME="devicelost";type=mt.NAME}class ft{static NAME="devicerestored";type=ft.NAME}class gt{static NAME="resize";width;height;type=gt.NAME;constructor(t,e){this.width=t,this.height=e}}class xt{static NAME="gpuobject_added";object;type=xt.NAME;constructor(t){this.object=t}}class Tt{static NAME="gpuobject_removed";object;type=Tt.NAME;constructor(t){this.object=t}}class bt{static NAME="gpuobject_rename";object;lastName;type=bt.NAME;constructor(t,e){this.object=t,this.lastName=e}}function Et(t,e){return t+e-1&~(e-1)}function yt(t){if(t.isPrimitiveType())return t.isScalarType()?4:1<<Math.min(4,t.cols+1);if(t.isAtomicI32()||t.isAtomicU32())return 4;if(t.isArrayType())return t.elementType.isAnyType()?1:yt(t.elementType);{let e=0;for(const i of t.structMembers)e=Math.max(e,yt(i.type));return Math.max(e,16)}}function vt(t){if(t.isPrimitiveType())return t.isMatrixType()?t.rows*yt(Xt.getCachedTypeInfo(t.resizeType(1,t.cols))):4*t.cols;if(t.isArrayType())return t.elementType.isAnyType()?0:t.dimension*Et(vt(t.elementType),yt(t.elementType));if(t.isAtomicI32()||t.isAtomicU32())return 4;{let e=0,i=0;for(const s of t.structMembers){const t=yt(s.type);e=Et(e,t),e+=vt(s.type),i=Math.max(i,t)}return Et(e,i)}}function St(t){if(t.isPrimitiveType()){let e;switch(t.scalarType){case At.U8:case At.U8_NORM:case At.I8:case At.I8_NORM:e=1;break;case At.F16:case At.I16:case At.I16_NORM:case At.U16:case At.U16_NORM:e=2;break;default:e=4}return t.rows*t.cols*e}if(t.isArrayType())return t.elementType.isAnyType()?0:t.dimension*St(t.elementType);if(t.isAtomicI32()||t.isAtomicU32())return 4;{let e=0;for(const i of t.structMembers)e+=St(i.type);return e}}function wt(t,e,i,s){return t|e<<4|i<<7|s<<10}function Ct(t){return t.isPrimitiveType()?t.scalarType:t.isArrayType()?t.elementType.isAnyType()?null:Ct(t.elementType):At.U8}var At;!function(t){t[t.NONE=0]="NONE",t[t.F16=wt(1,1,1,0)]="F16",t[t.F16VEC2=wt(1,1,2,0)]="F16VEC2",t[t.F16VEC3=wt(1,1,3,0)]="F16VEC3",t[t.F16VEC4=wt(1,1,4,0)]="F16VEC4",t[t.F32=wt(2,1,1,0)]="F32",t[t.F32VEC2=wt(2,1,2,0)]="F32VEC2",t[t.F32VEC3=wt(2,1,3,0)]="F32VEC3",t[t.F32VEC4=wt(2,1,4,0)]="F32VEC4",t[t.BOOL=wt(3,1,1,0)]="BOOL",t[t.BVEC2=wt(3,1,2,0)]="BVEC2",t[t.BVEC3=wt(3,1,3,0)]="BVEC3",t[t.BVEC4=wt(3,1,4,0)]="BVEC4",t[t.I8=wt(4,1,1,0)]="I8",t[t.I8VEC2=wt(4,1,2,0)]="I8VEC2",t[t.I8VEC3=wt(4,1,3,0)]="I8VEC3",t[t.I8VEC4=wt(4,1,4,0)]="I8VEC4",t[t.I8_NORM=wt(4,1,1,1)]="I8_NORM",t[t.I8VEC2_NORM=wt(4,1,2,1)]="I8VEC2_NORM",t[t.I8VEC3_NORM=wt(4,1,3,1)]="I8VEC3_NORM",t[t.I8VEC4_NORM=wt(4,1,4,1)]="I8VEC4_NORM",t[t.I16=wt(5,1,1,0)]="I16",t[t.I16VEC2=wt(5,1,2,0)]="I16VEC2",t[t.I16VEC3=wt(5,1,3,0)]="I16VEC3",t[t.I16VEC4=wt(5,1,4,0)]="I16VEC4",t[t.I16_NORM=wt(5,1,1,1)]="I16_NORM",t[t.I16VEC2_NORM=wt(5,1,2,1)]="I16VEC2_NORM",t[t.I16VEC3_NORM=wt(5,1,3,1)]="I16VEC3_NORM",t[t.I16VEC4_NORM=wt(5,1,4,1)]="I16VEC4_NORM",t[t.I32=wt(6,1,1,0)]="I32",t[t.I32VEC2=wt(6,1,2,0)]="I32VEC2",t[t.I32VEC3=wt(6,1,3,0)]="I32VEC3",t[t.I32VEC4=wt(6,1,4,0)]="I32VEC4",t[t.I32_NORM=wt(6,1,1,1)]="I32_NORM",t[t.I32VEC2_NORM=wt(6,1,2,1)]="I32VEC2_NORM",t[t.I32VEC3_NORM=wt(6,1,3,1)]="I32VEC3_NORM",t[t.I32VEC4_NORM=wt(6,1,4,1)]="I32VEC4_NORM",t[t.U8=wt(7,1,1,0)]="U8",t[t.U8VEC2=wt(7,1,2,0)]="U8VEC2",t[t.U8VEC3=wt(7,1,3,0)]="U8VEC3",t[t.U8VEC4=wt(7,1,4,0)]="U8VEC4",t[t.U8_NORM=wt(7,1,1,1)]="U8_NORM",t[t.U8VEC2_NORM=wt(7,1,2,1)]="U8VEC2_NORM",t[t.U8VEC3_NORM=wt(7,1,3,1)]="U8VEC3_NORM",t[t.U8VEC4_NORM=wt(7,1,4,1)]="U8VEC4_NORM",t[t.U16=wt(8,1,1,0)]="U16",t[t.U16VEC2=wt(8,1,2,0)]="U16VEC2",t[t.U16VEC3=wt(8,1,3,0)]="U16VEC3",t[t.U16VEC4=wt(8,1,4,0)]="U16VEC4",t[t.U16_NORM=wt(8,1,1,1)]="U16_NORM",t[t.U16VEC2_NORM=wt(8,1,2,1)]="U16VEC2_NORM",t[t.U16VEC3_NORM=wt(8,1,3,1)]="U16VEC3_NORM",t[t.U16VEC4_NORM=wt(8,1,4,1)]="U16VEC4_NORM",t[t.U32=wt(9,1,1,0)]="U32",t[t.U32VEC2=wt(9,1,2,0)]="U32VEC2",t[t.U32VEC3=wt(9,1,3,0)]="U32VEC3",t[t.U32VEC4=wt(9,1,4,0)]="U32VEC4",t[t.U32_NORM=wt(9,1,1,1)]="U32_NORM",t[t.U32VEC2_NORM=wt(9,1,2,1)]="U32VEC2_NORM",t[t.U32VEC3_NORM=wt(9,1,3,1)]="U32VEC3_NORM",t[t.U32VEC4_NORM=wt(9,1,4,1)]="U32VEC4_NORM",t[t.MAT2=wt(2,2,2,0)]="MAT2",t[t.MAT2x3=wt(2,2,3,0)]="MAT2x3",t[t.MAT2x4=wt(2,2,4,0)]="MAT2x4",t[t.MAT3x2=wt(2,3,2,0)]="MAT3x2",t[t.MAT3=wt(2,3,3,0)]="MAT3",t[t.MAT3x4=wt(2,3,4,0)]="MAT3x4",t[t.MAT4x2=wt(2,4,2,0)]="MAT4x2",t[t.MAT4x3=wt(2,4,3,0)]="MAT4x3",t[t.MAT4=wt(2,4,4,0)]="MAT4"}(At||(At={}));const Rt={[At.F32]:"float",[At.F32VEC2]:"vec2",[At.F32VEC3]:"vec3",[At.F32VEC4]:"vec4",[At.BOOL]:"bool",[At.BVEC2]:"bvec2",[At.BVEC3]:"bvec3",[At.BVEC4]:"bvec4",[At.I32]:"int",[At.I32VEC2]:"ivec2",[At.I32VEC3]:"ivec3",[At.I32VEC4]:"ivec4",[At.U32]:"uint",[At.U32VEC2]:"uvec2",[At.U32VEC3]:"uvec3",[At.U32VEC4]:"uvec4",[At.MAT2]:"mat2",[At.MAT2x3]:"mat2x3",[At.MAT2x4]:"mat2x4",[At.MAT3x2]:"mat3x2",[At.MAT3]:"mat3",[At.MAT3x4]:"mat3x4",[At.MAT4x2]:"mat4x2",[At.MAT4x3]:"mat4x3",[At.MAT4]:"mat4"},Mt={[At.F32]:"f32",[At.F32VEC2]:"vec2<f32>",[At.F32VEC3]:"vec3<f32>",[At.F32VEC4]:"vec4<f32>",[At.BOOL]:"bool",[At.BVEC2]:"vec2<bool>",[At.BVEC3]:"vec3<bool>",[At.BVEC4]:"vec4<bool>",[At.I32]:"i32",[At.I32VEC2]:"vec2<i32>",[At.I32VEC3]:"vec3<i32>",[At.I32VEC4]:"vec4<i32>",[At.U32]:"u32",[At.U32VEC2]:"vec2<u32>",[At.U32VEC3]:"vec3<u32>",[At.U32VEC4]:"vec4<u32>",[At.MAT2]:"mat2x2<f32>",[At.MAT2x3]:"mat2x3<f32>",[At.MAT2x4]:"mat2x4<f32>",[At.MAT3x2]:"mat3x2<f32>",[At.MAT3]:"mat3x3<f32>",[At.MAT3x4]:"mat3x4<f32>",[At.MAT4x2]:"mat4x2<f32>",[At.MAT4x3]:"mat4x3<f32>",[At.MAT4]:"mat4x4<f32>"},$t=16,Nt=64,Dt=128,It=512,Lt=1024;var Ft;!function(t){t[t.TEX_1D=257]="TEX_1D",t[t.ITEX_1D=513]="ITEX_1D",t[t.UTEX_1D=1025]="UTEX_1D",t[t.TEX_2D=258]="TEX_2D",t[t.ITEX_2D=514]="ITEX_2D",t[t.UTEX_2D=1026]="UTEX_2D",t[t.TEX_2D_ARRAY=274]="TEX_2D_ARRAY",t[t.ITEX_2D_ARRAY=530]="ITEX_2D_ARRAY",t[t.UTEX_2D_ARRAY=1042]="UTEX_2D_ARRAY",t[t.TEX_3D=260]="TEX_3D",t[t.ITEX_3D=516]="ITEX_3D",t[t.UTEX_3D=1028]="UTEX_3D",t[t.TEX_CUBE=264]="TEX_CUBE",t[t.ITEX_CUBE=520]="ITEX_CUBE",t[t.UTEX_CUBE=1032]="UTEX_CUBE",t[t.TEX_CUBE_ARRAY=280]="TEX_CUBE_ARRAY",t[t.ITEX_CUBE_ARRAY=536]="ITEX_CUBE_ARRAY",t[t.UTEX_CUBE_ARRAY=1048]="UTEX_CUBE_ARRAY",t[t.TEX_MULTISAMPLED_2D=290]="TEX_MULTISAMPLED_2D",t[t.ITEX_MULTISAMPLED_2D=546]="ITEX_MULTISAMPLED_2D",t[t.UTEX_MULTISAMPLED_2D=1058]="UTEX_MULTISAMPLED_2D",t[t.TEX_STORAGE_1D=65]="TEX_STORAGE_1D",t[t.TEX_STORAGE_2D=66]="TEX_STORAGE_2D",t[t.TEX_STORAGE_2D_ARRAY=82]="TEX_STORAGE_2D_ARRAY",t[t.TEX_STORAGE_3D=68]="TEX_STORAGE_3D",t[t.TEX_DEPTH_2D=130]="TEX_DEPTH_2D",t[t.TEX_DEPTH_2D_ARRAY=146]="TEX_DEPTH_2D_ARRAY",t[t.TEX_DEPTH_CUBE=136]="TEX_DEPTH_CUBE",t[t.TEX_DEPTH_CUBE_ARRAY=152]="TEX_DEPTH_CUBE_ARRAY",t[t.TEX_DEPTH_MULTISAMPLED_2D=162]="TEX_DEPTH_MULTISAMPLED_2D",t[t.TEX_EXTERNAL=2048]="TEX_EXTERNAL"}(Ft||(Ft={}));const Pt={[Ft.TEX_1D]:"highp sampler2D",[Ft.TEX_2D]:"highp sampler2D",[Ft.TEX_CUBE]:"highp samplerCube",[Ft.TEX_EXTERNAL]:"highp sampler2D"},Bt={[Ft.TEX_1D]:"highp sampler2D",[Ft.TEX_2D]:"highp sampler2D",[Ft.ITEX_1D]:"highp isampler2D",[Ft.ITEX_2D]:"highp isampler2D",[Ft.UTEX_1D]:"highp usampler2D",[Ft.UTEX_2D]:"highp usampler2D",[Ft.TEX_2D_ARRAY]:"highp sampler2DArray",[Ft.ITEX_2D_ARRAY]:"highp isampler2DArray",[Ft.UTEX_2D_ARRAY]:"highp usampler2DArray",[Ft.TEX_3D]:"highp sampler3D",[Ft.ITEX_3D]:"highp isampler3D",[Ft.UTEX_3D]:"highp usampler3D",[Ft.TEX_CUBE]:"highp samplerCube",[Ft.ITEX_CUBE]:"highp isamplerCube",[Ft.UTEX_CUBE]:"highp usamplerCube",[Ft.TEX_DEPTH_2D]:"highp sampler2DShadow",[Ft.TEX_DEPTH_2D_ARRAY]:"highp sampler2DArrayShadow",[Ft.TEX_DEPTH_CUBE]:"highp samplerCubeShadow",[Ft.TEX_EXTERNAL]:"highp sampler2D"},Ot={[Ft.TEX_1D]:"texture_1d<f32>",[Ft.ITEX_1D]:"texture_1d<i32>",[Ft.UTEX_1D]:"texture_1d<u32>",[Ft.TEX_2D]:"texture_2d<f32>",[Ft.ITEX_2D]:"texture_2d<i32>",[Ft.UTEX_2D]:"texture_2d<u32>",[Ft.TEX_2D_ARRAY]:"texture_2d_array<f32>",[Ft.ITEX_2D_ARRAY]:"texture_2d_array<i32>",[Ft.UTEX_2D_ARRAY]:"texture_2d_array<u32>",[Ft.TEX_3D]:"texture_3d<f32>",[Ft.ITEX_3D]:"texture_3d<i32>",[Ft.UTEX_3D]:"texture_3d<u32>",[Ft.TEX_CUBE]:"texture_cube<f32>",[Ft.ITEX_CUBE]:"texture_cube<i32>",[Ft.UTEX_CUBE]:"texture_cube<u32>",[Ft.TEX_CUBE_ARRAY]:"texture_cube_array<f32>",[Ft.ITEX_CUBE_ARRAY]:"texture_cube_array<i32>",[Ft.UTEX_CUBE_ARRAY]:"texture_cube_array<u32>",[Ft.TEX_MULTISAMPLED_2D]:"texture_multisampled_2d<f32>",[Ft.ITEX_MULTISAMPLED_2D]:"texture_multisampled_2d<i32>",[Ft.UTEX_MULTISAMPLED_2D]:"texture_multisampled_2d<u32>",[Ft.TEX_STORAGE_1D]:"texture_storage_1d",[Ft.TEX_STORAGE_2D]:"texture_storage_2d",[Ft.TEX_STORAGE_2D_ARRAY]:"texture_storage_2d_array",[Ft.TEX_STORAGE_3D]:"texture_storage_3d",[Ft.TEX_DEPTH_2D]:"texture_depth_2d",[Ft.TEX_DEPTH_2D_ARRAY]:"texture_depth_2d_array",[Ft.TEX_DEPTH_CUBE]:"texture_depth_cube",[Ft.TEX_DEPTH_CUBE_ARRAY]:"texture_depth_cube_array",[Ft.TEX_DEPTH_MULTISAMPLED_2D]:"texture_depth_multisampled_2d",[Ft.TEX_EXTERNAL]:"texture_external"},Ut={rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",bgra8unorm:"bgra8unorm",rgba8ui:"rgba8uint",rgba8i:"rgba8sint",rgba16ui:"rgba16uint",rgba16i:"rgba16sint",rgba16f:"rgba16float",r32f:"r32float",r32ui:"r32uint",r32i:"r32sint",rg32f:"rg32float",rg32ui:"rg32uint",rg32i:"rg32sint",rgba32f:"rgba32float",rgba32ui:"rgba32uint",rgba32i:"rgba32sint"};var Vt,Gt,zt;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SAMPLE=1]="SAMPLE",t[t.COMPARISON=2]="COMPARISON"}(Vt||(Vt={})),function(t){t.UNKNOWN="unknown",t.FUNCTION="function",t.PRIVATE="private",t.WORKGROUP="workgroup",t.UNIFORM="uniform",t.STORAGE="storage"}(Gt||(Gt={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.PLAIN=1]="PLAIN",t[t.ARRAY=2]="ARRAY",t[t.POINTER=3]="POINTER",t[t.ATOMIC_I32=4]="ATOMIC_I32",t[t.ATOMIC_U32=5]="ATOMIC_U32",t[t.TEXTURE=6]="TEXTURE",t[t.SAMPLER=7]="SAMPLER",t[t.FUNCTION=8]="FUNCTION",t[t.VOID=9]="VOID",t[t.ANY=10]="ANY"}(zt||(zt={}));class kt{cls;detail;id;constructor(t,e){this.cls=t,this.detail=e,this.id=null}get typeId(){return this.id||(this.id=this.genTypeId()),this.id}isVoidType(){return!1}isAnyType(){return!1}isPrimitiveType(){return!1}isStructType(){return!1}isArrayType(){return!1}isPointerType(){return!1}isAtomicI32(){return!1}isAtomicU32(){return!1}isSamplerType(){return!1}isTextureType(){return!1}isHostSharable(){return!1}isConstructible(){return!1}isStorable(){return!1}getConstructorOverloads(t){return[]}isCompatibleType(t){return t.typeId===this.typeId}}class Xt extends kt{static cachedTypes={};static cachedCtorOverloads={};constructor(t){super(zt.PLAIN,{primitiveType:t})}static getCachedTypeInfo(t){let e=this.cachedTypes[t];return e||(e=new Xt(t),this.cachedTypes[t]=e),e}static getCachedOverloads(t,e){let i=this.cachedCtorOverloads[t];i||(i={},this.cachedCtorOverloads[t]=i);let s=i[e];if(!s){const r=this.getCachedTypeInfo(e),a=r.toTypeName(t);if(s=[new Zt(a,r,[])],r.isScalarType())s.push(new Zt(a,r,[{type:this.getCachedTypeInfo(At.F32)}])),s.push(new Zt(a,r,[{type:this.getCachedTypeInfo(At.I32)}])),s.push(new Zt(a,r,[{type:this.getCachedTypeInfo(At.U32)}])),s.push(new Zt(a,r,[{type:this.getCachedTypeInfo(At.BOOL)}]));else if(r.isVectorType()){const t={type:this.getCachedTypeInfo(r.scalarType)},e={type:this.getCachedTypeInfo(r.resizeType(1,2))},i={type:this.getCachedTypeInfo(r.resizeType(1,3))};switch(s.push(new Zt(a,r,[t])),r.cols){case 2:s.push(new Zt(a,r,[t,t])),s.push(new Zt(a,r,[{type:Qt}])),s.push(new Zt(a,r,[{type:re}])),s.push(new Zt(a,r,[{type:he}])),s.push(new Zt(a,r,[{type:de}]));break;case 3:s.push(new Zt(a,r,[t,t,t])),s.push(new Zt(a,r,[t,e])),s.push(new Zt(a,r,[e,t])),s.push(new Zt(a,r,[{type:Jt}])),s.push(new Zt(a,r,[{type:ae}])),s.push(new Zt(a,r,[{type:ue}])),s.push(new Zt(a,r,[{type:pe}]));break;case 4:s.push(new Zt(a,r,[t,t,t,t])),s.push(new Zt(a,r,[t,t,e])),s.push(new Zt(a,r,[t,e,t])),s.push(new Zt(a,r,[e,t,t])),s.push(new Zt(a,r,[e,e])),s.push(new Zt(a,r,[t,i])),s.push(new Zt(a,r,[i,t])),s.push(new Zt(a,r,[{type:te}])),s.push(new Zt(a,r,[{type:ne}])),s.push(new Zt(a,r,[{type:le}])),s.push(new Zt(a,r,[{type:_e}]))}}else if(r.isMatrixType()){const t=this.getCachedTypeInfo(r.resizeType(1,r.cols));s.push(new Zt(a,r,Array.from({length:r.rows}).map((()=>({type:t}))))),s.push(new Zt(a,r,Array.from({length:r.rows*r.cols}).map((()=>({type:Kt})))))}i[e]=s}return s}get primitiveType(){return this.detail.primitiveType}isInteger(){const t=15&this.primitiveType;return 4===t||7===t||5===t||8===t||6===t||9===t}get scalarType(){return this.resizeType(1,1)}get rows(){return this.primitiveType>>4&7}get cols(){return this.primitiveType>>7&7}get normalized(){return!!(this.primitiveType>>10&1)}getLayoutAlignment(t){return"packed"===t?1:this.isScalarType()?4:1<<Math.min(4,this.cols+1)}getLayoutSize(){return this.getSize()}getSize(){let t;switch(this.scalarType){case At.BOOL:case At.I32:case At.I32_NORM:case At.U32:case At.U32_NORM:case At.F32:t=4;break;case At.F16:case At.I16:case At.I16_NORM:case At.U16:case At.U16_NORM:t=2;break;default:t=1}return t*this.cols*this.rows}resizeType(t,e){return wt(15&this.primitiveType,t,e,this.normalized?1:0)}isScalarType(){return 1===this.rows&&1===this.cols}isVectorType(){return 1===this.rows&&this.cols>1}isMatrixType(){return this.rows>1&&this.cols>1}isPrimitiveType(){return!0}isHostSharable(){return this.scalarType!==At.BOOL}isConstructible(){return!0}isStorable(){return!0}getConstructorOverloads(t){return Xt.getCachedOverloads(t,this.primitiveType)}toTypeName(t,e){if("webgpu"===t){const t=Mt[this.primitiveType];return e?`${e}: ${t}`:t}{const t=Rt[this.primitiveType];return e?`${t} ${e}`:t}}toBufferLayout(t){return null}genTypeId(){return`PRIM:${this.primitiveType}`}}class Wt extends kt{constructor(t,e,i){super(zt.PLAIN,{layout:e||"default",structName:t,structMembers:i.map((t=>{const e=yt(t.type),i=vt(t.type);return{name:t.name,type:t.type,alignment:e,size:i,defaultAlignment:e,defaultSize:i}}))}),"std140"===this.layout?this.calcAlignmentAndSizeSTD140():"std430"===this.layout&&this.calcAlignmentAndSizePacked()}get layout(){return this.detail.layout}get structName(){return this.detail.structName}set structName(t){this.detail.structName=t}get structMembers(){return this.detail.structMembers}extends(t,e){const i=this.structMembers.map((t=>({name:t.name,type:t.type})));return new Wt(t,this.layout,[...i,...e])}isStructType(){return!0}isHostSharable(){return this.detail.structMembers.every((t=>t.type.isHostSharable()))}isConstructible(){return this.detail.structMembers.every((t=>t.type.isConstructible()))}isStorable(){return!0}getConstructorOverloads(){const t=[new Zt(this.structName,this,[])];return this.isConstructible()&&t.push(new Zt(this.structName,this,this.structMembers.map((t=>({type:t.type}))))),t}toTypeName(t,e){return"webgpu"===t?e?`${e}: ${this.structName}`:this.structName:e?`${this.structName} ${e}`:this.structName}isWritable(){for(const t of this.structMembers){if(t.type.isAtomicI32()||t.type.isAtomicU32())return!0;if(t.type.isStructType()&&t.type.isWritable())return!0}return!1}getLayoutAlignment(t){if("packed"===t)return 1;let e=0;for(const i of this.structMembers)e=Math.max(e,i.type.getLayoutAlignment(t));return"std140"===t&&(e=Et(e,16)),e}getLayoutSize(t){let e=0,i=0;for(const s of this.structMembers){const r=s.type.getLayoutAlignment(t);e=Et(e,r),e+=s.type.getLayoutSize(t),i=Math.max(i,r)}return Et(e,i)}toBufferLayout(t,e){const i={byteSize:0,entries:[]},s=t;for(const s of this.structMembers){t=Et(t,s.type.getLayoutAlignment(e));const r=s.type.getLayoutSize(e);i.entries.push({name:s.name,offset:t,byteSize:r,type:Ct(s.type),subLayout:s.type.isStructType()?s.type.toBufferLayout(t,e):null,arraySize:s.type.isArrayType()?s.type.dimension:0}),t+=r}return i.byteSize="std140"===e?Et(t-s,16):t-s,i}clone(t){return new Wt(t||this.structName,this.layout,this.structMembers)}reset(t,e,i){this.detail={layout:e||"default",structName:t,structMembers:i.map((t=>{const e=yt(t.type),i=vt(t.type);return{name:t.name,type:t.type,alignment:e,size:i,defaultAlignment:e,defaultSize:i}}))},"std140"===this.layout?this.calcAlignmentAndSizeSTD140():"std430"===this.layout&&this.calcAlignmentAndSizePacked(),this.id=null}genTypeId(){return`STRUCT:${this.structName}:${this.layout}:${this.structMembers.map((t=>`${t.name}(${t.type.typeId})`)).join(":")}`}calcAlignmentAndSizeSTD140(){for(const t of this.structMembers)if(t.type.isPrimitiveType()){if(t.type.isMatrixType()&&2===t.type.cols)throw new Error(`matrix${t.type.rows}x${t.type.cols} can not be used in std140 layout`)}else{if(t.type.isArrayType()&&(t.type.elementType.isAnyType()||16!==yt(t.type.elementType)))throw new Error("array element must be 16 bytes aligned in std140 layout");t.type.isStructType()&&(t.alignment=16,t.size=Et(t.defaultSize,16))}}calcAlignmentAndSizePacked(){for(const t of this.structMembers)t.alignment=(t.type,1),t.size=St(t.type)}}class Ht extends kt{constructor(t,e){super(zt.ARRAY,{elementType:t,dimension:Number(e)||0})}get elementType(){return this.detail.elementType}get dimension(){return this.detail.dimension}isArrayType(){return!0}isHostSharable(){return this.detail.elementType.isHostSharable()}isConstructible(){return this.dimension&&this.detail.elementType.isConstructible()}isStorable(){return!0}getConstructorOverloads(t){const e=this.toTypeName(t),i=[new Zt(e,this,[])];return"webgl"!==t&&this.isConstructible()&&i.push(new Zt(e,this,Array.from({length:this.dimension}).map((()=>({type:this.elementType}))))),i}toTypeName(t,e){if("webgpu"===t){const i=`array<${this.elementType.toTypeName(t)}${this.dimension?", "+this.dimension:""}>`;return e?`${e}: ${i}`:i}console.assert(!!this.dimension,"runtime-sized array not supported for webgl"),console.assert(!this.elementType.isArrayType(),"multi-dimensional arrays not supported for webgl");return`${this.elementType.toTypeName(t,e)}[${this.dimension}]`}getLayoutAlignment(t){return"packed"===t||this.elementType.isAnyType()?1:"std430"===t?this.elementType.getLayoutAlignment(t):Et(this.elementType.getLayoutAlignment(t),16)}getLayoutSize(t){const e=this.elementType.isAnyType()?1:this.elementType.getLayoutAlignment(t);if("std140"===t&&15&e)throw new Error("Error: array element stride of std140 must be multiple of 16");return this.elementType.isAnyType()?0:this.dimension*Et(this.elementType.getLayoutSize(t),e)}toBufferLayout(t){return null}isCompatibleType(t){return!!t.isArrayType()&&((0===this.dimension||t.dimension===this.dimension)&&this.elementType.isCompatibleType(t.elementType))}genTypeId(){return`ARRAY:(${this.elementType.typeId})[${this.dimension}]`}}class Yt extends kt{writable;constructor(t,e){super(zt.POINTER,{pointerType:t,addressSpace:e}),console.assert(t.isStorable(),"the pointee type must be storable"),this.writable=!1}get pointerType(){return this.detail.pointerType}get addressSpace(){return this.detail.addressSpace}set addressSpace(t){this.detail.addressSpace!==t&&(this.detail.addressSpace=t,this.id=null)}isPointerType(){return!0}toTypeName(t,e){if("webgpu"===t){const i=this.addressSpace===Gt.UNKNOWN?Gt.FUNCTION:this.addressSpace,s=i===Gt.STORAGE&&this.writable?", read_write":"",r=`ptr<${i}, ${this.pointerType.toTypeName(t)} ${s}>`;return e?`${e}: ${r}`:r}throw new Error("pointer type not supported for webgl")}toBufferLayout(t){return null}genTypeId(){return`PTR:(${this.pointerType.typeId})`}}class qt extends kt{constructor(t){super(zt.SAMPLER,{accessMode:t})}get accessMode(){return this.detail.accessMode}isSamplerType(){return!0}isStorable(){return!0}toTypeName(t,e){if("webgpu"===t){const t=this.accessMode===Vt.SAMPLE?"sampler":"sampler_comparison";return e?`${e}: ${t}`:t}throw new Error("sampler type not supported for webgl")}toBufferLayout(t){return null}genTypeId(){return`SAMPLER:${this.accessMode}`}}class jt extends kt{constructor(t,e,i,s){super(zt.TEXTURE,{textureType:t,readable:i,writable:s,storageTexelFormat:e||null}),console.assert(!!Ot[t],"unsupported texture type"),console.assert(!(t&Nt&&!Ut[e]),"invalid texel format for storage texture")}get textureType(){return this.detail.textureType}get storageTexelFormat(){return this.detail.storageTexelFormat}get readable(){return this.detail.readable}get writable(){return this.detail.writable}isStorable(){return!0}is1DTexture(){return!!(1&this.detail.textureType)}is2DTexture(){return!!(2&this.detail.textureType)}is3DTexture(){return!!(4&this.detail.textureType)}isCubeTexture(){return!!(8&this.detail.textureType)}isArrayTexture(){return!!(this.detail.textureType&$t)}isStorageTexture(){return!!(this.detail.textureType&Nt)}isDepthTexture(){return!!(this.detail.textureType&Dt)}isMultisampledTexture(){return!!(32&this.detail.textureType)}isExternalTexture(){return!!(2048&this.detail.textureType)}isIntTexture(){return!!(this.detail.textureType&It)}isUIntTexture(){return!!(this.detail.textureType&Lt)}isTextureType(){return!0}toTypeName(t,e){if("webgpu"===t){let t=Ot[this.textureType];if(this.isStorageTexture()){t=`${t}<${Ut[this.storageTexelFormat]}, ${"write"}>`}return e?`${e}: ${t}`:t}{const i=("webgl"===t?Pt:Bt)[this.textureType];return console.assert(!!i,"unsupported texture type"),e?`${i} ${e}`:i}}toBufferLayout(t){return null}genTypeId(){return`TEXTURE:${this.textureType}`}}class Zt extends kt{constructor(t,e,i){super(zt.FUNCTION,{name:t,returnType:e,argTypes:i})}get name(){return this.detail.name}get returnType(){return this.detail.returnType}get argTypes(){return this.detail.argTypes}get argHash(){return this.argTypes.map((t=>t.type.typeId)).join(",")}genTypeId(){return`fn(${this.argHash}):${this.returnType.typeId}`}toBufferLayout(t){return null}toTypeName(t,e){throw new Error("not supported")}}Xt.getCachedTypeInfo(At.F16),Xt.getCachedTypeInfo(At.F16VEC2),Xt.getCachedTypeInfo(At.F16VEC3),Xt.getCachedTypeInfo(At.F16VEC4);const Kt=Xt.getCachedTypeInfo(At.F32),Qt=Xt.getCachedTypeInfo(At.F32VEC2),Jt=Xt.getCachedTypeInfo(At.F32VEC3),te=Xt.getCachedTypeInfo(At.F32VEC4);Xt.getCachedTypeInfo(At.I8),Xt.getCachedTypeInfo(At.I8VEC2),Xt.getCachedTypeInfo(At.I8VEC3),Xt.getCachedTypeInfo(At.I8VEC4),Xt.getCachedTypeInfo(At.I8_NORM),Xt.getCachedTypeInfo(At.I8VEC2_NORM),Xt.getCachedTypeInfo(At.I8VEC3_NORM),Xt.getCachedTypeInfo(At.I8VEC4_NORM),Xt.getCachedTypeInfo(At.I16),Xt.getCachedTypeInfo(At.I16VEC2),Xt.getCachedTypeInfo(At.I16VEC3),Xt.getCachedTypeInfo(At.I16VEC4),Xt.getCachedTypeInfo(At.I16_NORM),Xt.getCachedTypeInfo(At.I16VEC2_NORM),Xt.getCachedTypeInfo(At.I16VEC3_NORM),Xt.getCachedTypeInfo(At.I16VEC4_NORM);const ee=new class extends kt{constructor(){super(zt.ATOMIC_I32,null)}isAtomicI32(){return!0}isHostSharable(){return!0}isStorable(){return!0}toTypeName(t,e){if("webgpu"===t){const t="atomic<i32>";return e?`${e}: ${t}`:t}throw new Error("atomic type not supported for webgl")}toBufferLayout(t){return null}getLayoutAlignment(t){return 4}getLayoutSize(){return this.getSize()}getSize(){return 4}genTypeId(){return"ATOMICI32"}},ie=new class extends kt{constructor(){super(zt.ATOMIC_U32,null)}isAtomicU32(){return!0}isHostSharable(){return!0}isStorable(){return!0}toTypeName(t,e){if("webgpu"===t){const t="atomic<u32>";return e?`${e}: ${t}`:t}throw new Error("atomic type not supported for webgl")}toBufferLayout(t){return null}getLayoutAlignment(t){return 4}getLayoutSize(){return this.getSize()}getSize(){return 4}genTypeId(){return"ATOMICU32"}},se=Xt.getCachedTypeInfo(At.I32),re=Xt.getCachedTypeInfo(At.I32VEC2),ae=Xt.getCachedTypeInfo(At.I32VEC3),ne=Xt.getCachedTypeInfo(At.I32VEC4);Xt.getCachedTypeInfo(At.I32),Xt.getCachedTypeInfo(At.I32VEC2_NORM),Xt.getCachedTypeInfo(At.I32VEC3_NORM),Xt.getCachedTypeInfo(At.I32VEC4_NORM),Xt.getCachedTypeInfo(At.U8),Xt.getCachedTypeInfo(At.U8VEC2),Xt.getCachedTypeInfo(At.U8VEC3),Xt.getCachedTypeInfo(At.U8VEC4),Xt.getCachedTypeInfo(At.U8_NORM),Xt.getCachedTypeInfo(At.U8VEC2_NORM),Xt.getCachedTypeInfo(At.U8VEC3_NORM),Xt.getCachedTypeInfo(At.U8VEC4_NORM),Xt.getCachedTypeInfo(At.U16),Xt.getCachedTypeInfo(At.U16VEC2),Xt.getCachedTypeInfo(At.U16VEC3),Xt.getCachedTypeInfo(At.U16VEC4),Xt.getCachedTypeInfo(At.U16_NORM),Xt.getCachedTypeInfo(At.U16VEC2_NORM),Xt.getCachedTypeInfo(At.U16VEC3_NORM),Xt.getCachedTypeInfo(At.U16VEC4_NORM);const oe=Xt.getCachedTypeInfo(At.U32),he=Xt.getCachedTypeInfo(At.U32VEC2),ue=Xt.getCachedTypeInfo(At.U32VEC3),le=Xt.getCachedTypeInfo(At.U32VEC4);Xt.getCachedTypeInfo(At.U32_NORM),Xt.getCachedTypeInfo(At.U32VEC2_NORM),Xt.getCachedTypeInfo(At.U32VEC3_NORM),Xt.getCachedTypeInfo(At.U32VEC4_NORM);const ce=Xt.getCachedTypeInfo(At.BOOL),de=Xt.getCachedTypeInfo(At.BVEC2),pe=Xt.getCachedTypeInfo(At.BVEC3),_e=Xt.getCachedTypeInfo(At.BVEC4),me=Xt.getCachedTypeInfo(At.MAT2),fe=Xt.getCachedTypeInfo(At.MAT2x3),ge=Xt.getCachedTypeInfo(At.MAT2x4),xe=Xt.getCachedTypeInfo(At.MAT3x2),Te=Xt.getCachedTypeInfo(At.MAT3),be=Xt.getCachedTypeInfo(At.MAT3x4),Ee=Xt.getCachedTypeInfo(At.MAT4x2),ye=Xt.getCachedTypeInfo(At.MAT4x3),ve=Xt.getCachedTypeInfo(At.MAT4),Se=new jt(Ft.TEX_1D),we=new jt(Ft.ITEX_1D),Ce=new jt(Ft.UTEX_1D),Ae=new jt(Ft.TEX_2D),Re=new jt(Ft.ITEX_2D),Me=new jt(Ft.UTEX_2D),$e=new jt(Ft.TEX_2D_ARRAY),Ne=new jt(Ft.ITEX_2D_ARRAY),De=new jt(Ft.UTEX_2D_ARRAY),Ie=new jt(Ft.TEX_3D),Le=new jt(Ft.ITEX_3D),Fe=new jt(Ft.UTEX_3D),Pe=new jt(Ft.TEX_CUBE),Be=new jt(Ft.ITEX_CUBE),Oe=new jt(Ft.UTEX_CUBE),Ue=new jt(Ft.TEX_EXTERNAL),Ve=new jt(Ft.TEX_CUBE_ARRAY),Ge=new jt(Ft.ITEX_CUBE_ARRAY),ze=new jt(Ft.UTEX_CUBE_ARRAY),ke=new jt(Ft.TEX_MULTISAMPLED_2D),Xe=new jt(Ft.ITEX_MULTISAMPLED_2D),We=new jt(Ft.UTEX_MULTISAMPLED_2D),He=new jt(Ft.TEX_STORAGE_1D,"rgba8unorm"),Ye=new jt(Ft.TEX_STORAGE_1D,"rgba8snorm");new jt(Ft.TEX_STORAGE_1D,"rgba8unorm");const qe=new jt(Ft.TEX_STORAGE_1D,"rgba8ui"),je=new jt(Ft.TEX_STORAGE_1D,"rgba8i"),Ze=new jt(Ft.TEX_STORAGE_1D,"rgba16ui"),Ke=new jt(Ft.TEX_STORAGE_1D,"rgba16i"),Qe=new jt(Ft.TEX_STORAGE_1D,"rgba16f"),Je=new jt(Ft.TEX_STORAGE_1D,"rgba32ui"),ti=new jt(Ft.TEX_STORAGE_1D,"rgba32i"),ei=new jt(Ft.TEX_STORAGE_1D,"rgba32f"),ii=new jt(Ft.TEX_STORAGE_1D,"rg32ui"),si=new jt(Ft.TEX_STORAGE_1D,"rg32i"),ri=new jt(Ft.TEX_STORAGE_1D,"rg32f"),ai=new jt(Ft.TEX_STORAGE_1D,"r32ui"),ni=new jt(Ft.TEX_STORAGE_1D,"r32i"),oi=new jt(Ft.TEX_STORAGE_1D,"r32f"),hi=new jt(Ft.TEX_STORAGE_2D,"rgba8unorm"),ui=new jt(Ft.TEX_STORAGE_2D,"rgba8snorm");new jt(Ft.TEX_STORAGE_2D,"bgra8unorm");const li=new jt(Ft.TEX_STORAGE_2D,"rgba8ui"),ci=new jt(Ft.TEX_STORAGE_2D,"rgba8i"),di=new jt(Ft.TEX_STORAGE_2D,"rgba16ui"),pi=new jt(Ft.TEX_STORAGE_2D,"rgba16i"),_i=new jt(Ft.TEX_STORAGE_2D,"rgba16f"),mi=new jt(Ft.TEX_STORAGE_2D,"rgba32ui"),fi=new jt(Ft.TEX_STORAGE_2D,"rgba32i"),gi=new jt(Ft.TEX_STORAGE_2D,"rgba32f"),xi=new jt(Ft.TEX_STORAGE_2D,"rg32ui"),Ti=new jt(Ft.TEX_STORAGE_2D,"rg32i"),bi=new jt(Ft.TEX_STORAGE_2D,"rg32f"),Ei=new jt(Ft.TEX_STORAGE_2D,"r32ui"),yi=new jt(Ft.TEX_STORAGE_2D,"r32i"),vi=new jt(Ft.TEX_STORAGE_2D,"r32f"),Si=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rgba8unorm"),wi=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rgba8snorm");new jt(Ft.TEX_STORAGE_2D_ARRAY,"bgra8unorm");const Ci=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rgba8ui"),Ai=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rgba8i"),Ri=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rgba16ui"),Mi=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rgba16i"),$i=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rgba16f"),Ni=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rgba32ui"),Di=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rgba32i"),Ii=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rgba32f"),Li=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rg32ui"),Fi=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rg32i"),Pi=new jt(Ft.TEX_STORAGE_2D_ARRAY,"rg32f"),Bi=new jt(Ft.TEX_STORAGE_2D_ARRAY,"r32ui"),Oi=new jt(Ft.TEX_STORAGE_2D_ARRAY,"r32i"),Ui=new jt(Ft.TEX_STORAGE_2D_ARRAY,"r32f"),Vi=new jt(Ft.TEX_STORAGE_3D,"rgba8unorm"),Gi=new jt(Ft.TEX_STORAGE_3D,"rgba8snorm");new jt(Ft.TEX_STORAGE_3D,"bgra8unorm");const zi=new jt(Ft.TEX_STORAGE_3D,"rgba8ui"),ki=new jt(Ft.TEX_STORAGE_3D,"rgba8i"),Xi=new jt(Ft.TEX_STORAGE_3D,"rgba16ui"),Wi=new jt(Ft.TEX_STORAGE_3D,"rgba16i"),Hi=new jt(Ft.TEX_STORAGE_3D,"rgba16f"),Yi=new jt(Ft.TEX_STORAGE_3D,"rgba32ui"),qi=new jt(Ft.TEX_STORAGE_3D,"rgba32i"),ji=new jt(Ft.TEX_STORAGE_3D,"rgba32f"),Zi=new jt(Ft.TEX_STORAGE_3D,"rg32ui"),Ki=new jt(Ft.TEX_STORAGE_3D,"rg32i"),Qi=new jt(Ft.TEX_STORAGE_3D,"rg32f"),Ji=new jt(Ft.TEX_STORAGE_3D,"r32ui"),ts=new jt(Ft.TEX_STORAGE_3D,"r32i"),es=new jt(Ft.TEX_STORAGE_3D,"r32f"),is=new jt(Ft.TEX_DEPTH_2D),ss=new jt(Ft.TEX_DEPTH_2D_ARRAY),rs=new jt(Ft.TEX_DEPTH_CUBE),as=new jt(Ft.TEX_DEPTH_CUBE_ARRAY),ns=new jt(Ft.TEX_DEPTH_MULTISAMPLED_2D),os=new qt(Vt.SAMPLE),hs=new qt(Vt.COMPARISON),us=new class extends kt{constructor(){super(zt.VOID,null)}isVoidType(){return!0}toTypeName(t,e){return"void"}genTypeId(){return"void"}toBufferLayout(t){return null}};new class extends kt{constructor(){super(zt.ANY,null)}isAnyType(){return!0}toTypeName(t,e){return"any"}genTypeId(){return"any"}toBufferLayout(t){return null}isCompatibleType(t){return!0}};const ls=new Wt("FrexpResult","default",[{name:"sig",type:Kt},{name:"exp",type:se}]),cs=new Wt("FrexpResultVec2","default",[{name:"sig",type:Qt},{name:"exp",type:re}]),ds=new Wt("FrexpResultVec3","default",[{name:"sig",type:Jt},{name:"exp",type:ae}]),ps=new Wt("FrexpResultVec4","default",[{name:"sig",type:te},{name:"exp",type:ne}]),_s=10,ms=11,fs=13,gs={position_u8normx2:[0,At.U8VEC2_NORM,2,"u8norm",2],position_u8normx4:[0,At.U8VEC4_NORM,4,"u8norm",4],position_i8normx2:[0,At.I8VEC2_NORM,2,"i8norm",2],position_i8normx4:[0,At.I8VEC4_NORM,4,"i8norm",4],position_u16x2:[0,At.U16VEC2,4,"u16",2],position_u16x4:[0,At.U16VEC4,8,"u16",4],position_i16x2:[0,At.I16VEC2,4,"i16",2],position_i16x4:[0,At.I16VEC4,8,"i16",4],position_u16normx2:[0,At.U16VEC2_NORM,4,"u16norm",2],position_u16normx4:[0,At.U16VEC4_NORM,8,"u16norm",4],position_i16normx2:[0,At.I16VEC2_NORM,4,"i16norm",2],position_i16normx4:[0,At.I16VEC4_NORM,8,"i16norm",4],position_f16x2:[0,At.F16VEC2,4,"f16",2],position_f16x4:[0,At.F16VEC4,8,"f16",4],position_f32:[0,At.F32,4,"f32",1],position_f32x2:[0,At.F32VEC2,8,"f32",2],position_f32x3:[0,At.F32VEC3,12,"f32",3],position_f32x4:[0,At.F32VEC4,16,"f32",4],position_i32:[0,At.I32,4,"i32",1],position_i32x2:[0,At.I32VEC2,8,"i32",2],position_i32x3:[0,At.I32VEC3,12,"i32",3],position_i32x4:[0,At.I32VEC4,16,"i32",4],position_u32:[0,At.U32,4,"u32",1],position_u32x2:[0,At.U32VEC2,8,"u32",2],position_u32x3:[0,At.U32VEC3,12,"u32",3],position_u32x4:[0,At.U32VEC4,16,"u32",4],normal_f16x4:[1,At.F16VEC4,8,"f16",4],normal_f32x3:[1,At.F32VEC3,12,"f32",3],normal_f32x4:[1,At.F32VEC4,16,"f32",4],diffuse_u8normx4:[2,At.U8VEC4_NORM,4,"u8norm",4],diffuse_u16x4:[2,At.U16VEC4,8,"u16",4],diffuse_u16normx4:[2,At.U16VEC4_NORM,8,"u16norm",4],diffuse_f16x4:[2,At.F16VEC4,8,"f16",4],diffuse_f32x3:[2,At.F32VEC3,12,"f32",3],diffuse_f32x4:[2,At.F32VEC4,16,"f32",4],diffuse_u32x3:[2,At.U32VEC3,12,"u32",3],diffuse_u32x4:[2,At.U32VEC4,16,"u32",4],tangent_f16x4:[3,At.F16VEC4,8,"f16",4],tangent_f32x3:[3,At.F32VEC3,12,"f32",3],tangent_f32x4:[3,At.F32VEC4,16,"f32",4],tex0_u8normx2:[4,At.U8VEC2_NORM,2,"u8norm",2],tex0_u8normx4:[4,At.U8VEC4_NORM,4,"u8norm",4],tex0_i8normx2:[4,At.I8VEC2_NORM,2,"i8norm",2],tex0_i8normx4:[4,At.I8VEC4_NORM,4,"i8norm",4],tex0_u16x2:[4,At.U16VEC2,4,"u16",2],tex0_u16x4:[4,At.U16VEC4,8,"u16",4],tex0_i16x2:[4,At.I16VEC2,4,"i16",2],tex0_i16x4:[4,At.I16VEC4,8,"i16",4],tex0_u16normx2:[4,At.U16VEC2_NORM,4,"u16norm",2],tex0_u16normx4:[4,At.U16VEC4_NORM,8,"u16norm",4],tex0_i16normx2:[4,At.I16VEC2_NORM,4,"i16norm",2],tex0_i16normx4:[4,At.I16VEC4_NORM,8,"i16norm",4],tex0_f16x2:[4,At.F16VEC2,4,"f16",2],tex0_f16x4:[4,At.F16VEC4,8,"f16",4],tex0_f32:[4,At.F32,4,"f32",1],tex0_f32x2:[4,At.F32VEC2,8,"f32",2],tex0_f32x3:[4,At.F32VEC3,12,"f32",3],tex0_f32x4:[4,At.F32VEC4,16,"f32",4],tex0_i32:[4,At.I32,4,"i32",1],tex0_i32x2:[4,At.I32VEC2,8,"i32",2],tex0_i32x3:[4,At.I32VEC3,12,"i32",3],tex0_i32x4:[4,At.I32VEC4,16,"i32",4],tex0_u32:[4,At.U32,4,"u32",1],tex0_u32x2:[4,At.U32VEC2,8,"u32",2],tex0_u32x3:[4,At.U32VEC3,12,"u32",3],tex0_u32x4:[4,At.U32VEC4,16,"u32",4],tex1_u8normx2:[5,At.U8VEC2_NORM,2,"u8norm",2],tex1_u8normx4:[5,At.U8VEC4_NORM,4,"u8norm",4],tex1_i8normx2:[5,At.I8VEC2_NORM,2,"i8norm",2],tex1_i8normx4:[5,At.I8VEC4_NORM,4,"i8norm",4],tex1_u16x2:[5,At.U16VEC2,4,"u16",2],tex1_u16x4:[5,At.U16VEC4,8,"u16",4],tex1_i16x2:[5,At.I16VEC2,4,"i16",2],tex1_i16x4:[5,At.I16VEC4,8,"i16",4],tex1_u16normx2:[5,At.U16VEC2_NORM,4,"u16norm",2],tex1_u16normx4:[5,At.U16VEC4_NORM,8,"u16norm",4],tex1_i16normx2:[5,At.I16VEC2_NORM,4,"i16norm",2],tex1_i16normx4:[5,At.I16VEC4_NORM,8,"i16norm",4],tex1_f16x2:[5,At.F16VEC2,4,"f16",2],tex1_f16x4:[5,At.F16VEC4,8,"f16",4],tex1_f32:[5,At.F32,4,"f32",1],tex1_f32x2:[5,At.F32VEC2,8,"f32",2],tex1_f32x3:[5,At.F32VEC3,12,"f32",3],tex1_f32x4:[5,At.F32VEC4,16,"f32",4],tex1_i32:[5,At.I32,4,"i32",1],tex1_i32x2:[5,At.I32VEC2,8,"i32",2],tex1_i32x3:[5,At.I32VEC3,12,"i32",3],tex1_i32x4:[5,At.I32VEC4,16,"i32",4],tex1_u32:[5,At.U32,4,"u32",1],tex1_u32x2:[5,At.U32VEC2,8,"u32",2],tex1_u32x3:[5,At.U32VEC3,12,"u32",3],tex1_u32x4:[5,At.U32VEC4,16,"u32",4],tex2_u8normx2:[6,At.U8VEC2_NORM,2,"u8norm",2],tex2_u8normx4:[6,At.U8VEC4_NORM,4,"u8norm",4],tex2_i8normx2:[6,At.I8VEC2_NORM,2,"i8norm",2],tex2_i8normx4:[6,At.I8VEC4_NORM,4,"i8norm",4],tex2_u16x2:[6,At.U16VEC2,4,"u16",2],tex2_u16x4:[6,At.U16VEC4,8,"u16",4],tex2_i16x2:[6,At.I16VEC2,4,"i16",2],tex2_i16x4:[6,At.I16VEC4,8,"i16",4],tex2_u16normx2:[6,At.U16VEC2_NORM,4,"u16norm",2],tex2_u16normx4:[6,At.U16VEC4_NORM,8,"u16norm",4],tex2_i16normx2:[6,At.I16VEC2_NORM,4,"i16norm",2],tex2_i16normx4:[6,At.I16VEC4_NORM,8,"i16norm",4],tex2_f16x2:[6,At.F16VEC2,4,"f16",2],tex2_f16x4:[6,At.F16VEC4,8,"f16",4],tex2_f32:[6,At.F32,4,"f32",1],tex2_f32x2:[6,At.F32VEC2,8,"f32",2],tex2_f32x3:[6,At.F32VEC3,12,"f32",3],tex2_f32x4:[6,At.F32VEC4,16,"f32",4],tex2_i32:[6,At.I32,4,"i32",1],tex2_i32x2:[6,At.I32VEC2,8,"i32",2],tex2_i32x3:[6,At.I32VEC3,12,"i32",3],tex2_i32x4:[6,At.I32VEC4,16,"i32",4],tex2_u32:[6,At.U32,4,"u32",1],tex2_u32x2:[6,At.U32VEC2,8,"u32",2],tex2_u32x3:[6,At.U32VEC3,12,"u32",3],tex2_u32x4:[6,At.U32VEC4,16,"u32",4],tex3_u8normx2:[7,At.U8VEC2_NORM,2,"u8norm",2],tex3_u8normx4:[7,At.U8VEC4_NORM,4,"u8norm",4],tex3_i8normx2:[7,At.I8VEC2_NORM,2,"i8norm",2],tex3_i8normx4:[7,At.I8VEC4_NORM,4,"i8norm",4],tex3_u16x2:[7,At.U16VEC2,4,"u16",2],tex3_u16x4:[7,At.U16VEC4,8,"u16",4],tex3_i16x2:[7,At.I16VEC2,4,"i16",2],tex3_i16x4:[7,At.I16VEC4,8,"i16",4],tex3_u16normx2:[7,At.U16VEC2_NORM,4,"u16norm",2],tex3_u16normx4:[7,At.U16VEC4_NORM,8,"u16norm",4],tex3_i16normx2:[7,At.I16VEC2_NORM,4,"i16norm",2],tex3_i16normx4:[7,At.I16VEC4_NORM,8,"i16norm",4],tex3_f16x2:[7,At.F16VEC2,4,"f16",2],tex3_f16x4:[7,At.F16VEC4,8,"f16",4],tex3_f32:[7,At.F32,4,"f32",1],tex3_f32x2:[7,At.F32VEC2,8,"f32",2],tex3_f32x3:[7,At.F32VEC3,12,"f32",3],tex3_f32x4:[7,At.F32VEC4,16,"f32",4],tex3_i32:[7,At.I32,4,"i32",1],tex3_i32x2:[7,At.I32VEC2,8,"i32",2],tex3_i32x3:[7,At.I32VEC3,12,"i32",3],tex3_i32x4:[7,At.I32VEC4,16,"i32",4],tex3_u32:[7,At.U32,4,"u32",1],tex3_u32x2:[7,At.U32VEC2,8,"u32",2],tex3_u32x3:[7,At.U32VEC3,12,"u32",3],tex3_u32x4:[7,At.U32VEC4,16,"u32",4],tex4_u8normx2:[8,At.U8VEC2_NORM,2,"u8norm",2],tex4_u8normx4:[8,At.U8VEC4_NORM,4,"u8norm",4],tex4_i8normx2:[8,At.I8VEC2_NORM,2,"i8norm",2],tex4_i8normx4:[8,At.I8VEC4_NORM,4,"i8norm",4],tex4_u16x2:[8,At.U16VEC2,4,"u16",2],tex4_u16x4:[8,At.U16VEC4,8,"u16",4],tex4_i16x2:[8,At.I16VEC2,4,"i16",2],tex4_i16x4:[8,At.I16VEC4,8,"i16",4],tex4_u16normx2:[8,At.U16VEC2_NORM,4,"u16norm",2],tex4_u16normx4:[8,At.U16VEC4_NORM,8,"u16norm",4],tex4_i16normx2:[8,At.I16VEC2_NORM,4,"i16norm",2],tex4_i16normx4:[8,At.I16VEC4_NORM,8,"i16norm",4],tex4_f16x2:[8,At.F16VEC2,4,"f16",2],tex4_f16x4:[8,At.F16VEC4,8,"f16",4],tex4_f32:[8,At.F32,4,"f32",1],tex4_f32x2:[8,At.F32VEC2,8,"f32",2],tex4_f32x3:[8,At.F32VEC3,12,"f32",3],tex4_f32x4:[8,At.F32VEC4,16,"f32",4],tex4_i32:[8,At.I32,4,"i32",1],tex4_i32x2:[8,At.I32VEC2,8,"i32",2],tex4_i32x3:[8,At.I32VEC3,12,"i32",3],tex4_i32x4:[8,At.I32VEC4,16,"i32",4],tex4_u32:[8,At.U32,4,"u32",1],tex4_u32x2:[8,At.U32VEC2,8,"u32",2],tex4_u32x3:[8,At.U32VEC3,12,"u32",3],tex4_u32x4:[8,At.U32VEC4,16,"u32",4],tex5_u8normx2:[9,At.U8VEC2_NORM,2,"u8norm",2],tex5_u8normx4:[9,At.U8VEC4_NORM,4,"u8norm",4],tex5_i8normx2:[9,At.I8VEC2_NORM,2,"i8norm",2],tex5_i8normx4:[9,At.I8VEC4_NORM,4,"i8norm",4],tex5_u16x2:[9,At.U16VEC2,4,"u16",2],tex5_u16x4:[9,At.U16VEC4,8,"u16",4],tex5_i16x2:[9,At.I16VEC2,4,"i16",2],tex5_i16x4:[9,At.I16VEC4,8,"i16",4],tex5_u16normx2:[9,At.U16VEC2_NORM,4,"u16norm",2],tex5_u16normx4:[9,At.U16VEC4_NORM,8,"u16norm",4],tex5_i16normx2:[9,At.I16VEC2_NORM,4,"i16norm",2],tex5_i16normx4:[9,At.I16VEC4_NORM,8,"i16norm",4],tex5_f16x2:[9,At.F16VEC2,4,"f16",2],tex5_f16x4:[9,At.F16VEC4,8,"f16",4],tex5_f32:[9,At.F32,4,"f32",1],tex5_f32x2:[9,At.F32VEC2,8,"f32",2],tex5_f32x3:[9,At.F32VEC3,12,"f32",3],tex5_f32x4:[9,At.F32VEC4,16,"f32",4],tex5_i32:[9,At.I32,4,"i32",1],tex5_i32x2:[9,At.I32VEC2,8,"i32",2],tex5_i32x3:[9,At.I32VEC3,12,"i32",3],tex5_i32x4:[9,At.I32VEC4,16,"i32",4],tex5_u32:[9,At.U32,4,"u32",1],tex5_u32x2:[9,At.U32VEC2,8,"u32",2],tex5_u32x3:[9,At.U32VEC3,12,"u32",3],tex5_u32x4:[9,At.U32VEC4,16,"u32",4],tex6_u8normx2:[_s,At.U8VEC2_NORM,2,"u8norm",2],tex6_u8normx4:[_s,At.U8VEC4_NORM,4,"u8norm",4],tex6_i8normx2:[_s,At.I8VEC2_NORM,2,"i8norm",2],tex6_i8normx4:[_s,At.I8VEC4_NORM,4,"i8norm",4],tex6_u16x2:[_s,At.U16VEC2,4,"u16",2],tex6_u16x4:[_s,At.U16VEC4,8,"u16",4],tex6_i16x2:[_s,At.I16VEC2,4,"i16",2],tex6_i16x4:[_s,At.I16VEC4,8,"i16",4],tex6_u16normx2:[_s,At.U16VEC2_NORM,4,"u16norm",2],tex6_u16normx4:[_s,At.U16VEC4_NORM,8,"u16norm",4],tex6_i16normx2:[_s,At.I16VEC2_NORM,4,"i16norm",2],tex6_i16normx4:[_s,At.I16VEC4_NORM,8,"i16norm",4],tex6_f16x2:[_s,At.F16VEC2,4,"f16",2],tex6_f16x4:[_s,At.F16VEC4,8,"f16",4],tex6_f32:[_s,At.F32,4,"f32",1],tex6_f32x2:[_s,At.F32VEC2,8,"f32",2],tex6_f32x3:[_s,At.F32VEC3,12,"f32",3],tex6_f32x4:[_s,At.F32VEC4,16,"f32",4],tex6_i32:[_s,At.I32,4,"i32",1],tex6_i32x2:[_s,At.I32VEC2,8,"i32",2],tex6_i32x3:[_s,At.I32VEC3,12,"i32",3],tex6_i32x4:[_s,At.I32VEC4,16,"i32",4],tex6_u32:[_s,At.U32,4,"u32",1],tex6_u32x2:[_s,At.U32VEC2,8,"u32",2],tex6_u32x3:[_s,At.U32VEC3,12,"u32",3],tex6_u32x4:[_s,At.U32VEC4,16,"u32",4],tex7_u8normx2:[ms,At.U8VEC2_NORM,2,"u8norm",2],tex7_u8normx4:[ms,At.U8VEC4_NORM,4,"u8norm",4],tex7_i8normx2:[ms,At.I8VEC2_NORM,2,"i8norm",2],tex7_i8normx4:[ms,At.I8VEC4_NORM,4,"i8norm",4],tex7_u16x2:[ms,At.U16VEC2,4,"u16",2],tex7_u16x4:[ms,At.U16VEC4,8,"u16",4],tex7_i16x2:[ms,At.I16VEC2,4,"i16",2],tex7_i16x4:[ms,At.I16VEC4,8,"i16",4],tex7_u16normx2:[ms,At.U16VEC2_NORM,4,"u16norm",2],tex7_u16normx4:[ms,At.U16VEC4_NORM,8,"u16norm",4],tex7_i16normx2:[ms,At.I16VEC2_NORM,4,"i16norm",2],tex7_i16normx4:[ms,At.I16VEC4_NORM,8,"i16norm",4],tex7_f16x2:[ms,At.F16VEC2,4,"f16",2],tex7_f16x4:[ms,At.F16VEC4,8,"f16",4],tex7_f32:[ms,At.F32,4,"f32",1],tex7_f32x2:[ms,At.F32VEC2,8,"f32",2],tex7_f32x3:[ms,At.F32VEC3,12,"f32",3],tex7_f32x4:[ms,At.F32VEC4,16,"f32",4],tex7_i32:[ms,At.I32,4,"i32",1],tex7_i32x2:[ms,At.I32VEC2,8,"i32",2],tex7_i32x3:[ms,At.I32VEC3,12,"i32",3],tex7_i32x4:[ms,At.I32VEC4,16,"i32",4],tex7_u32:[ms,At.U32,4,"u32",1],tex7_u32x2:[ms,At.U32VEC2,8,"u32",2],tex7_u32x3:[ms,At.U32VEC3,12,"u32",3],tex7_u32x4:[ms,At.U32VEC4,16,"u32",4],blendweights_f16x4:[12,At.F16VEC4,8,"f16",4],blendweights_f32x4:[12,At.F32VEC4,16,"f32",4],blendindices_u16x4:[fs,At.U16VEC4,8,"u16",4],blendindices_f16x4:[fs,At.F16VEC4,8,"f16",4],blendindices_f32x4:[fs,At.F32VEC4,16,"f32",4],blendindices_u32x4:[fs,At.U32VEC4,16,"u32",4]},xs={position:0,normal:1,diffuse:2,tangent:3,blendIndices:fs,blendWeights:12,texCoord0:4,texCoord1:5,texCoord2:6,texCoord3:7,texCoord4:8,texCoord5:9,texCoord6:_s,texCoord7:ms},Ts={0:"position",1:"normal",2:"diffuse",3:"tangent",[fs]:"blendIndices",12:"blendWeights",4:"texCoord0",5:"texCoord1",6:"texCoord2",7:"texCoord3",8:"texCoord4",9:"texCoord5",[_s]:"texCoord6",[ms]:"texCoord7"};var bs;function Es(t){return xs[t]}function ys(t){return Ts[t]}function vs(t){return gs[t][2]}function Ss(t){const e=t.structMembers[0].type.elementType;if(e.isStructType()){let t=0;for(const i of e.structMembers)t+=i.type.getSize();return t}return e.getSize()}function ws(t,e){const i=ys(e);return i?function(t,e){const i=t.structMembers[0],s=i.type.elementType;if(s.isStructType()){for(const t of s.structMembers)if(t.name===e)return t.type;return null}return i.name===e?s:null}(t,i):null}function Cs(t,...e){if(0===e.length)return null;if(1===e.length){const i=gs[e[0]];return new Wt(null,"packed",[{name:ys(i[0]),type:new Ht(Xt.getCachedTypeInfo(i[1]),t)}])}{const i=new Wt(null,"packed",e.map((t=>({name:ys(gs[t][0]),type:Xt.getCachedTypeInfo(gs[t][1])}))));return new Wt(null,"packed",[{name:"value",type:new Ht(i,t)}])}}!function(t){t[t.TF_LINEAR_COLOR_SPACE=2]="TF_LINEAR_COLOR_SPACE",t[t.TF_NO_MIPMAP=4]="TF_NO_MIPMAP",t[t.TF_WRITABLE=8]="TF_WRITABLE",t[t.TF_NO_GC=16]="TF_NO_GC",t[t.BF_VERTEX=32]="BF_VERTEX",t[t.BF_INDEX=64]="BF_INDEX",t[t.BF_READ=128]="BF_READ",t[t.BF_WRITE=256]="BF_WRITE",t[t.BF_UNIFORM=512]="BF_UNIFORM",t[t.BF_STORAGE=1024]="BF_STORAGE",t[t.DYNAMIC=2048]="DYNAMIC",t[t.MANAGED=4096]="MANAGED"}(bs||(bs={}));const As=function(){const t=[];for(let e=0;e<16;e++)t.push(Rs(e));return t}();function Rs(t){switch(t){case 0:return"a_position";case 1:return"a_normal";case 2:return"a_diffuse";case 3:return"a_tangent";case 4:return"a_texcoord0";case 5:return"a_texcoord1";case 6:return"a_texcoord2";case 7:return"a_texcoord3";case 8:return"a_texcoord4";case 9:return"a_texcoord5";case _s:return"a_texcoord6";case ms:return"a_texcoord7";case fs:return"a_indices";case 12:return"a_weight";default:return null}}class Ms{_vertexBuffers;_indexBuffer;_drawOffset;constructor(){this._vertexBuffers=[];for(let t=0;t<16;t++)this._vertexBuffers.push(null);this._indexBuffer=null,this._drawOffset=0}clone(){const t=new Ms;return t._vertexBuffers=this._vertexBuffers.slice(),t._indexBuffer=this._indexBuffer,t._drawOffset=this._drawOffset,t}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}getDrawOffset(){return this._drawOffset}setDrawOffset(t){t!==this._drawOffset&&(this._drawOffset=t)}getVertexBuffer(t){return this._vertexBuffers[Es(t)]?.buffer??null}getVertexBufferInfo(t){return this._vertexBuffers[Es(t)]??null}getIndexBuffer(){return this._indexBuffer||null}setVertexBuffer(t,e){if(!(t&&t.usage&bs.BF_VERTEX))throw new Error("setVertexBuffer() failed: buffer is null or buffer has not Vertex usage flag");e=e||"vertex";const i=t.structure.structMembers[0].type.elementType;if(i.isStructType()){let s=0;for(const r of i.structMembers){const i=Es(r.name);this.internalSetVertexBuffer(i,t,s,e),s+=r.size}}else{const i=Es(t.structure.structMembers[0].name);this.internalSetVertexBuffer(i,t,0,e)}return t}removeVertexBuffer(t){let e=!1;for(let i=0;i<this._vertexBuffers.length;i++){const s=this._vertexBuffers[i];s?.buffer===t&&(this._vertexBuffers[i]=null,e=!0)}return e}setIndexBuffer(t){return t!==this._indexBuffer&&(this._indexBuffer=t||null),t}internalSetVertexBuffer(t,e,i,s){if(t<0||t>=16)throw new Error(`setVertexBuffer() failed: location out of bounds: ${t}`);i=Number(i)||0,s=s||"vertex";const r=this._vertexBuffers[t];return r&&r.buffer===e&&r.offset===i&&r.stepMode===s?null:(this._vertexBuffers[t]={buffer:e,offset:i,type:ws(e.structure,t),stride:Ss(e.structure),drawOffset:0,stepMode:s},e)}}class $s{_cpuTimer;_cpuStart;_cpuTime;_ended;constructor(){this._cpuTimer=window.performance||window.Date,this._cpuTime=null,this._ended=!1}now(){return this._cpuTimer.now()}begin(){this._cpuStart=this.now(),this._cpuTime=null,this._ended=!1}end(){this._cpuTime=this.now()-this._cpuStart,this._ended=!0}ended(){return this._ended}elapsed(){return this._cpuTime}}function Ns(t,e){return"number"==typeof e||"boolean"==typeof e||Array.isArray(e)?`${e}`:e.$ast?.toString(t)}function Ds(t,e){return e?.toTypeName(t)}class Is extends Error{}class Ls extends Is{value;constructor(t){super(),this.value=t}getMessage(t){return`value out of range: ${this.value}`}}class Fs extends Is{value;valueType;expectedType;constructor(t,e,i){super(),this.value=t,this.valueType=e,this.expectedType=i}getMessage(t){return`cannot convert '${"string"==typeof this.value?this.value:Ns(t,this.value)}' of type '${"string"==typeof this.valueType?this.valueType:Ds(t,this.valueType)}' to type ${"string"==typeof this.expectedType?this.expectedType:Ds(t,this.expectedType)}`}}class Ps extends Is{func;constructor(t){super(),this.func=t}getMessage(t){return`wrong argument count for function '${this.func}'`}}class Bs extends Is{func;param;constructor(t,e){super(),this.func=t,this.param=e||null}getMessage(t){return`parameter type error for function '${this.func}': ${this.param}`}}class Os extends Is{func;param;reason;constructor(t,e,i){super(),this.func=t,this.param=e||null,this.reason=i||null}getMessage(t){return`invalid parameter value for function '${this.func}'${this.param?": "+this.param:""}${this.reason?": "+this.reason:""}}`}}class Us extends Is{func;constructor(t){super(),this.func=t}getMessage(t){return`No matched overloading found for function '${this.func}'`}}class Vs extends Is{value;constructor(t){super(),this.value=t}getMessage(t){return`'${Ns(t,this.value)}' is not a reference type`}}class Gs extends Is{value;constructor(t){super(),this.value=t}getMessage(t){return`'${Ns(t,this.value)}' is not a pointer type`}}class zs extends Is{feature;constructor(t){super(),this.feature=t}getMessage(t){return`feature not support for ${t} device: ${this.feature}`}}class ks extends Is{funcName;constructor(t){super(),this.funcName=t}getMessage(t){return`function call must be made inside a function scope: ${this.funcName}()`}}class Xs extends Is{ast;text;constructor(t,e){super(),this.ast=t,this.text=e}getMessage(t){return`${this.text}: ${this.ast.toString(t)}`}}class Ws extends Is{constructor(t){super(t)}getMessage(t){return`Internal error: ${this.message}`}}const Hs="uu_VSInput",Ys="uu_VSOutput",qs="uu_FSInput",js="uu_FSOutput",Zs="uu_CSInput";var Ks,Qs;function Js(t){switch(t){case _t.Vertex:return"uu_VSInputCpy";case _t.Fragment:return"uu_FSInputCpy";case _t.Compute:return"uu_CSInputCpy";default:return null}}function tr(t){switch(t){case _t.Vertex:return"uu_VSOutputCpy";case _t.Fragment:return"uu_FSOutputCpy";case _t.Compute:return"uu_CSOutputCpy";default:return null}}function er(t){switch(t){case _t.Vertex:return Hs;case _t.Fragment:return qs;case _t.Compute:return Zs;default:return null}}function ir(t,e){return`ch_auto_sampler_${t}${e?"_comparison":""}`}!function(t){t[t.DECLARE_TYPE_NONE=0]="DECLARE_TYPE_NONE",t[t.DECLARE_TYPE_IN=1]="DECLARE_TYPE_IN",t[t.DECLARE_TYPE_OUT=2]="DECLARE_TYPE_OUT",t[t.DECLARE_TYPE_WORKGROUP=3]="DECLARE_TYPE_WORKGROUP",t[t.DECLARE_TYPE_UNIFORM=4]="DECLARE_TYPE_UNIFORM",t[t.DECLARE_TYPE_STORAGE=5]="DECLARE_TYPE_STORAGE"}(Ks||(Ks={})),function(t){t[t.NONE=0]="NONE",t[t.HIGH=1]="HIGH",t[t.MEDIUM=2]="MEDIUM",t[t.LOW=3]="LOW"}(Qs||(Qs={}));const sr={webgl:{position:{name:"gl_Position",type:new Xt(At.F32VEC4),stage:"vertex"},pointSize:{name:"gl_PointSize",type:new Xt(At.F32),stage:"vertex"},fragCoord:{name:"gl_FragCoord",type:new Xt(At.F32VEC4),stage:"fragment"},frontFacing:{name:"gl_FrontFacing",type:new Xt(At.BOOL),stage:"fragment"},fragDepth:{name:"gl_FragDepthEXT",type:new Xt(At.F32),inOrOut:"out",extension:"GL_EXT_frag_depth",stage:"fragment"}},webgl2:{vertexIndex:{name:"gl_VertexID",semantic:"vertex_index",type:new Xt(At.U32),inOrOut:"in",stage:"vertex"},instanceIndex:{name:"gl_InstanceID",semantic:"instance_index",type:new Xt(At.U32),inOrOut:"in",stage:"vertex"},position:{name:"gl_Position",type:new Xt(At.F32VEC4),stage:"vertex"},pointSize:{name:"gl_PointSize",type:new Xt(At.F32),stage:"vertex"},fragCoord:{name:"gl_FragCoord",type:new Xt(At.F32VEC4),stage:"fragment"},frontFacing:{name:"gl_FrontFacing",type:new Xt(At.BOOL),stage:"fragment"},fragDepth:{name:"gl_FragDepth",type:new Xt(At.F32),stage:"fragment"}},webgpu:{vertexIndex:{name:"ch_builtin_vertexIndex",semantic:"vertex_index",type:new Xt(At.U32),inOrOut:"in",stage:"vertex"},instanceIndex:{name:"ch_builtin_instanceIndex",semantic:"instance_index",type:new Xt(At.U32),inOrOut:"in",stage:"vertex"},position:{name:"ch_builtin_position",semantic:"position",type:new Xt(At.F32VEC4),inOrOut:"out",stage:"vertex"},fragCoord:{name:"ch_builtin_fragCoord",semantic:"position",type:new Xt(At.F32VEC4),inOrOut:"in",stage:"fragment"},frontFacing:{name:"ch_builtin_frontFacing",semantic:"front_facing",type:new Xt(At.BOOL),inOrOut:"in",stage:"fragment"},fragDepth:{name:"ch_builtin_fragDepth",semantic:"frag_depth",type:new Xt(At.F32),inOrOut:"out",stage:"fragment"},localInvocationId:{name:"ch_builtin_localInvocationId",semantic:"local_invocation_id",type:new Xt(At.U32VEC3),inOrOut:"in",stage:"compute"},globalInvocationId:{name:"ch_builtin_globalInvocationId",semantic:"global_invocation_id",type:new Xt(At.U32VEC3),inOrOut:"in",stage:"compute"},workGroupId:{name:"ch_builtin_workGroupId",semantic:"workgroup_id",type:new Xt(At.U32VEC3),inOrOut:"in",stage:"compute"},numWorkGroups:{name:"ch_builtin_numWorkGroups",semantic:"num_workgroups",type:new Xt(At.U32VEC3),inOrOut:"in",stage:"compute"},sampleMaskIn:{name:"ch_builtin_sampleMaskIn",semantic:"sample_mask_in",type:new Xt(At.U32),inOrOut:"in",stage:"fragment"},sampleMaskOut:{name:"ch_builtin_sampleMaskOut",semantic:"sample_mask_out",type:new Xt(At.U32),inOrOut:"out",stage:"fragment"},sampleIndex:{name:"ch_builtin_sampleIndex",semantic:"sample_index",type:new Xt(At.U32),inOrOut:"in",stage:"fragment"}}};function rr(t){return t%1==0?t.toFixed(1):String(t)}function ar(t){return String(0|t)}function nr(t){return String(t>>>0)}function or(t){if("("===(t=t.trim())[0]&&")"===t[t.length-1]){let e=0;for(let i=1;i<t.length-1;i++)if("("===t[i])e++;else if(")"===t[i]&&(e--,e<0))break;if(e>0)throw new Ws(`Invalid expression: ${t}`);if(0===e)return t.substring(1,t.length-1)}return t}class hr{isReference(){return!1}isPointer(){return!!this.getType()?.isPointerType()}getType(){return null}toWebGL(t,e){return""}toWebGL2(t,e){return""}toWGSL(t,e){return""}toString(t){return this.constructor.name}}class ur extends hr{}class lr extends ur{paramAST;writable;constructor(t){super(),this.paramAST=t,this.writable=!1}getType(){return this.paramAST.getType()}markWritable(){this.paramAST instanceof _r&&console.warn(`Write to non-output parameter ${this.paramAST.value.$str}`),this.writable=!0}isWritable(){return this.writable}getAddressSpace(){return this.paramAST.getAddressSpace()}isConstExp(){return this.paramAST.isConstExp()}isReference(){return this.paramAST.isReference()}toWebGL(t,e){return this.paramAST.toWebGL(t,e)}toWebGL2(t,e){return this.paramAST.toWebGL2(t,e)}toWGSL(t,e){return this.paramAST.toWGSL(t,e)}}class cr extends hr{statements;constructor(){super(),this.statements=[]}toWebGL(t,e){return this.statements.filter((t=>!(t instanceof Pr)||t.isStatement)).map((i=>i.toWebGL(t,e))).join("")}toWebGL2(t,e){return this.statements.filter((t=>!(t instanceof Pr)||t.isStatement)).map((i=>i.toWebGL2(t,e))).join("")}toWGSL(t,e){return this.statements.filter((t=>!(t instanceof Pr)||t.isStatement)).map((i=>i instanceof Pr&&!i.getType().isVoidType()?`${t}_ = ${i.toWGSL("",e)}`:i.toWGSL(t,e))).join("")}}class dr extends cr{toWebGL(t,e){return`${t}{\n${super.toWebGL(t+" ",e)}${t}}\n`}toWebGL2(t,e){return`${t}{\n${super.toWebGL2(t+" ",e)}${t}}\n`}toWGSL(t,e){return`${t}{\n${super.toWGSL(t+" ",e)}${t}}\n`}}class pr extends cr{uniforms;constructor(){super(),this.uniforms=[]}findFunctions(t){const e=[];for(const i of this.statements)i instanceof Or&&i.name===t&&e.push(i);return e}toWebGL(t,e){const i=`${t}precision highp float;\n${t}precision highp int;\n`,s=`${t}#version 100\n`,r=e.types.map((i=>i.toWebGL(t,e))).join("")+this.uniforms.map((i=>i.toWebGL(t,e))).join("")+e.inputs.map((i=>i.toWebGL(t,e))).join("")+e.outputs.map((i=>i.toWebGL(t,e))).join("")+super.toWebGL(t,e);for(const t of e.builtins){const i=sr.webgl[t];i.extension&&e.extensions.add(i.extension)}return s+[...e.extensions].map((e=>`${t}#extension ${e}: enable\n`)).join("")+i+e.defines.join("")+r}toWebGL2(t,e){const i=`${t}precision highp float;\n${t}precision highp int;\n`,s=`${t}#version 300 es\n`,r=e.types.map((i=>i.toWebGL2(t,e))).join("")+this.uniforms.map((i=>i.toWebGL2(t,e))).join("")+e.inputs.map((i=>i.toWebGL2(t,e))).join("")+e.outputs.map((i=>i.toWebGL2(t,e))).join("")+super.toWebGL2(t,e);for(const t of e.builtins){const i=sr.webgl2[t];i.extension&&e.extensions.add(i.extension)}return s+[...e.extensions].map((e=>`${t}#extension ${e}: enable\n`)).join("")+i+e.defines.join("")+r}toWGSL(t,e){const i=e.type===_t.Vertex?[Hs,Ys]:e.type===_t.Fragment?[qs,js]:[Zs],s=[];for(const t of e.builtins)s.push(sr.webgpu[t].name);const r=Object.keys(sr.webgpu).map((t=>sr.webgpu[t].name));for(const t of e.types)if(t instanceof kr&&i.indexOf(t.type.structName)>=0)for(let e=t.type.structMembers.length-1;e>=0;e--){const i=t.type.structMembers[e];r.indexOf(i.name)>=0&&s.indexOf(i.name)<0&&(t.type.structMembers.splice(e,1),t.prefix.splice(e,1))}return e.types=e.types.filter((t=>!(t instanceof kr)||t.type.structMembers.length>0)),e.types.map((i=>i.toWGSL(t,e))).join("")+this.uniforms.map((i=>i.toWGSL(t,e))).join("")+super.toWGSL(t,e)}}class _r extends ur{value;ref;writable;constExp;constructor(t){super(),this.value=t,this.ref=null,this.writable=!1,this.constExp=!1}get name(){return this.value.$str}isReference(){return!0}isConstExp(){return this.constExp}markWritable(){this.writable=!0,this.constExp=!1,this.ref&&this.ref.markWritable()}isWritable(){const t=this.getType();return this.writable||t.isAtomicI32()||t.isAtomicU32()||t.isStructType()&&t.isWritable()}getAddressSpace(){switch(this.value.$declareType){case Ks.DECLARE_TYPE_UNIFORM:return Gt.UNIFORM;case Ks.DECLARE_TYPE_STORAGE:return Gt.STORAGE;case Ks.DECLARE_TYPE_IN:case Ks.DECLARE_TYPE_OUT:return null;default:return this.value.$global?Gt.PRIVATE:Gt.FUNCTION}}getType(){return this.value.$typeinfo}toWebGL(t,e){return this.name}toWebGL2(t,e){return this.name}toWGSL(t,e){if(this.value.$declareType===Ks.DECLARE_TYPE_IN){const i=Js(e.type);return e.global[i][this.name].$ast.toWGSL(t,e)}if(this.value.$declareType===Ks.DECLARE_TYPE_OUT){const i=tr(e.type);return e.global[i][this.name].$ast.toWGSL(t,e)}return this.name}toString(t){return this.name}}class mr extends hr{}class fr extends mr{value;constructor(t){if(super(),t.getAddressSpace()===Gt.UNIFORM)throw new Xs(t,"cannot assign to uniform variable");this.value=t,this.value instanceof Pr&&(this.value.isStatement=!1)}getType(){return this.value.getType()}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isReference(){return this.value.isReference()}toWebGL(t,e){return this.value.toWebGL(t,e)}toWebGL2(t,e){return this.value.toWebGL2(t,e)}toWGSL(t,e){return this.value.toWGSL(t,e)}toString(t){return this.value.toString(t)}}class gr extends mr{scope;field;type;constructor(t,e,i){super(),this.scope=t,this.field=e,this.type=i}getType(){return this.type}markWritable(){this.scope.markWritable()}isWritable(){return this.scope.isWritable()}isReference(){return this.scope.isReference()}toWebGL(t,e){return`${this.scope.toWebGL(t,e)}.${this.field}`}toWebGL2(t,e){return`${this.scope.toWebGL2(t,e)}.${this.field}`}toWGSL(t,e){return`${(this.scope.isPointer()?new wr(this.scope):this.scope).toWGSL(t,e)}.${this.field}`}toString(t){return`${(this.scope.isPointer()?new wr(this.scope):this.scope).toString(t)}.${this.field}`}}class xr extends mr{value;index;type;constructor(t,e,i){super(),this.value=t,this.index=e,this.type=i,this.index instanceof Pr&&(this.index.isStatement=!1)}getType(){return this.type}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isReference(){return this.value.isReference()}toWebGL(t,e){return`${this.value.toWebGL(t,e)}[${this.index.toWebGL(t,e)}]`}toWebGL2(t,e){return`${this.value.toWebGL2(t,e)}[${this.index.toWebGL2(t,e)}]`}toWGSL(t,e){return`${(this.value.isPointer()?new wr(this.value):this.value).toWGSL(t,e)}[${this.index.toWGSL(t,e)}]`}toString(t){return`${(this.value.isPointer()?new wr(this.value):this.value).toString(t)}[${this.index.toString(t)}]`}}class Tr extends mr{value;constructor(t){super(),this.value=t,this.value.constExp=!0}getType(){return this.value.getType()}markWritable(){}isWritable(){return!1}isReference(){return!0}toWebGL(t,e){let i="";switch(this.value.value.$declareType){case Ks.DECLARE_TYPE_IN:case Ks.DECLARE_TYPE_OUT:case Ks.DECLARE_TYPE_UNIFORM:case Ks.DECLARE_TYPE_STORAGE:throw new Error("invalid declare type");default:i=!this.value.constExp||this.value.isWritable()||this.getType().isStructType()?"":"const "}return`${i}${this.getType().toTypeName("webgl",this.value.name)}`}toWebGL2(t,e){let i="";switch(this.value.value.$declareType){case Ks.DECLARE_TYPE_IN:case Ks.DECLARE_TYPE_OUT:case Ks.DECLARE_TYPE_UNIFORM:case Ks.DECLARE_TYPE_STORAGE:throw new Error("invalid declare type");default:i=!this.value.constExp||this.value.isWritable()||this.getType().isStructType()?"":"const "}return`${i}${this.getType().toTypeName("webgl2",this.value.name)}`}toWGSL(t,e){let i;switch(this.value.value.$declareType){case Ks.DECLARE_TYPE_IN:case Ks.DECLARE_TYPE_OUT:case Ks.DECLARE_TYPE_UNIFORM:case Ks.DECLARE_TYPE_STORAGE:throw new Error("invalid declare type");default:{const t=this.value.getAddressSpace(),e=this.getType().isPointerType()||!this.value.isWritable()&&(t===Gt.PRIVATE||t===Gt.FUNCTION),s=t===Gt.PRIVATE,r=t===Gt.STORAGE&&this.value.isWritable()?", read_write":"",a=t!==Gt.FUNCTION?`<${t}${r}>`:"";i=e?s?"const ":"let ":`var${a} `;break}}{const t=this.getType();t.isPointerType()&&(this.value.isWritable()||this.value.ref.isWritable())&&(t.writable=!0);return`${i}${t.toTypeName("webgpu",this.value.name)}`}}toString(t){return this.value.toString(t)}}class br extends ur{type;args;constExp;constructor(t,e){super(),this.type=t,this.args=e,this.constExp=!0;for(const t of e){if(null==t)throw new Error("invalid constructor argument");t instanceof Pr&&(t.isStatement=!1),this.constExp&&=!(t instanceof ur)||t.isConstExp()}}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.constExp}getAddressSpace(){return null}toWebGL(t,e){console.assert(!this.type.isArrayType(),"array constructor not supported in webgl1 device"),console.assert(this.type.isConstructible(),`type '${this.type.toTypeName("webgl")}' is not constructible`);const i=this.type.getConstructorOverloads("webgl");for(const s of i){const i=Xr(this.args,s);if(i){const s=i.args.map((i=>or(i.toWebGL(t,e)))).join(",");return`${i.name}(${s})`}}throw new Error(`no matching overload function found for type ${this.type.toTypeName("webgl")}`)}toWebGL2(t,e){console.assert(this.type.isConstructible(),`type '${this.type.toTypeName("webgl2")}' is not constructible`,!0);const i=this.type.getConstructorOverloads("webgl2");for(const s of i){const i=Xr(this.args,s);if(i){const s=i.args.map((i=>or(i.toWebGL2(t,e)))).join(",");return`${i.name}(${s})`}}throw new Error(`no matching overload function found for type ${this.type.toTypeName("webgl2")}`)}toWGSL(t,e){const i=this.type.getConstructorOverloads("webgpu");for(const s of i){const i=Xr(this.args,s);if(i){const s=i.args.map((i=>or(i.toWGSL(t,e)))).join(",");return`${i.name}(${s})`}}throw new Error(`no matching overload function found for type ${this.type.toTypeName("webgpu")}`)}toString(t){return"constructor"}}class Er extends ur{value;type;constructor(t,e){if(super(),this.value=t,this.type=e,"number"==typeof t){if(e.primitiveType===At.BOOL)throw new Fs(t,typeof t,e);if(e.primitiveType===At.I32&&(!Number.isInteger(t)||t<-2147483648||t>4294967295))throw new Fs(t,typeof t,e);if(t<0&&e.primitiveType===At.U32&&(!Number.isInteger(t)||t<0||t>4294967295))throw new Fs(t,typeof t,e)}else if(e.primitiveType!==At.BOOL)throw new Fs(t,typeof t,e)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return!0}getAddressSpace(){return null}toWebGL(t,e){switch(this.type.primitiveType){case At.F32:return rr(this.value);case At.I32:return ar(this.value);case At.U32:return nr(this.value);case At.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toWebGL2(t,e){switch(this.type.primitiveType){case At.F32:return rr(this.value);case At.I32:return ar(this.value);case At.U32:return`${nr(this.value)}u`;case At.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toWGSL(t,e){switch(this.type.primitiveType){case At.F32:return rr(this.value);case At.I32:return ar(this.value);case At.U32:return`${nr(this.value)}u`;case At.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toString(t){return`${this.value}`}}class yr extends ur{source;field;type;constructor(t,e,i){super(),this.source=t,this.field=e,this.type=i,this.source instanceof Pr&&(this.source.isStatement=!1)}getType(){return this.type}isReference(){return this.source.isReference()}isConstExp(){return this.source.isConstExp()}markWritable(){this.source.markWritable()}isWritable(){return this.source.isWritable()}getAddressSpace(){return this.source.getAddressSpace()}toWebGL(t,e){return`${this.source.toWebGL(t,e)}.${this.field}`}toWebGL2(t,e){return`${this.source.toWebGL2(t,e)}.${this.field}`}toWGSL(t,e){return`${(this.source.isPointer()?new wr(this.source):this.source).toWGSL(t,e)}.${this.field}`}toString(t){return`${(this.source.isPointer()?new wr(this.source):this.source).toString(t)}.${this.field}`}}class vr extends ur{sourceValue;castType;constructor(t,e){super(),this.sourceValue=t,this.castType=e,this.sourceValue instanceof Pr&&(this.sourceValue.isStatement=!1)}getType(){return this.castType}markWritable(){}isWritable(){return!1}isConstExp(){return this.sourceValue.isConstExp()}getAddressSpace(){return null}toWebGL(t,e){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWebGL(t,e):`${this.castType.toTypeName("webgl")}(${or(this.sourceValue.toWebGL(t,e))})`}toWebGL2(t,e){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWebGL2(t,e):`${this.castType.toTypeName("webgl2")}(${or(this.sourceValue.toWebGL2(t,e))})`}toWGSL(t,e){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWGSL(t,e):`${this.castType.toTypeName("webgpu")}(${or(this.sourceValue.toWGSL(t,e))})`}toString(t){return`${this.castType.toTypeName(t)}(${or(this.sourceValue.toString(t))})`}}class Sr extends ur{value;type;constructor(t){super(),console.assert(t.isReference(),"no pointer type for non-reference values",!0),this.value=t,this.type=new Yt(t.getType(),t.getAddressSpace())}getType(){return this.type}isConstExp(){return!1}markWritable(){if(this.value.getAddressSpace()===Gt.UNIFORM)throw new Xs(this.value,"uniforms are not writable");this.value.markWritable()}isWritable(){return this.value.isWritable()}getAddressSpace(){return this.value.getAddressSpace()}toWebGL(t,e){throw new Error("GLSL does not support pointer type")}toWebGL2(t,e){throw new Error("GLSL does not support pointer type")}toWGSL(t,e){const i=this.value instanceof lr?this.value.paramAST:this.value;return i instanceof wr?i.value.toWGSL(t,e):`(&${i.toWGSL(t,e)})`}toString(t){const e=this.value instanceof lr?this.value.paramAST:this.value;return e instanceof wr?e.value.toString(t):`(&${e.toString(t)})`}}class wr extends ur{value;constructor(t){super(),this.value=t,this.value instanceof Pr&&(this.value.isStatement=!1)}getType(){const t=this.value.getType();return t.isPointerType()?t.pointerType:t}isReference(){return!0}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isConstExp(){return!1}getAddressSpace(){return this.value instanceof ur?this.value.getAddressSpace():null}toWebGL(t,e){return this.value.toWebGL(t,e)}toWebGL2(t,e){return this.value.toWebGL2(t,e)}toWGSL(t,e){return this.value.getType().isPointerType()?`(*${this.value.toWGSL(t,e)})`:this.value.toWGSL(t,e)}toString(t){return`*${this.value.toString(t)}`}}class Cr extends ur{value;op;type;constructor(t,e,i){super(),this.value=t,this.op=e,this.type=i,this.value instanceof Pr&&(this.value.isStatement=!1)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.value.isConstExp()}getAddressSpace(){return null}toWebGL(t,e){return`${this.op}${this.value.toWebGL(t,e)}`}toWebGL2(t,e){return`${this.op}${this.value.toWebGL2(t,e)}`}toWGSL(t,e){const i=this.value.isPointer()?new wr(this.value):this.value;return`${this.op}${i.toWGSL(t,e)}`}toString(t){const e=this.value.isPointer()?new wr(this.value):this.value;return`${this.op}${e.toString(t)}`}}class Ar extends ur{left;right;type;op;constructor(t,e,i,s){super(),this.left=t,this.right=e,this.op=i,this.type=s,this.left instanceof Pr&&(this.left.isStatement=!1),this.right instanceof Pr&&(this.right.isStatement=!1)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.left.isConstExp()&&this.right.isConstExp()}getAddressSpace(){return null}toWebGL(t,e){return`(${this.left.toWebGL(t,e)} ${this.op} ${this.right.toWebGL(t,e)})`}toWebGL2(t,e){return`(${this.left.toWebGL2(t,e)} ${this.op} ${this.right.toWebGL2(t,e)})`}toWGSL(t,e){const i=this.left.isPointer()?new wr(this.left):this.left,s=this.right.isPointer()?new wr(this.right):this.right;return`(${i.toWGSL(t,e)} ${this.op} ${s.toWGSL(t,e)})`}toString(t){const e=this.left.isPointer()?new wr(this.left):this.left,i=this.right.isPointer()?new wr(this.right):this.right;return`(${e.toString(t)} ${this.op} ${i.toString(t)})`}}class Rr extends ur{source;index;type;constructor(t,e,i){super(),this.source=t,this.index=e,this.type=i,this.source instanceof Pr&&(this.source.isStatement=!1),this.index instanceof Pr&&(this.index.isStatement=!1)}getType(){return this.type}isReference(){return this.source.isReference()}markWritable(){this.source.markWritable()}isWritable(){return this.source.isWritable()}isConstExp(){return this.source.isConstExp()&&this.index.isConstExp()}getAddressSpace(){return this.source.getAddressSpace()}toWebGL(t,e){return`${this.source.toWebGL(t,e)}[${or(this.index.toWebGL(t,e))}]`}toWebGL2(t,e){return`${this.source.toWebGL2(t,e)}[${or(this.index.toWebGL2(t,e))}]`}toWGSL(t,e){return`${this.source.toWGSL(t,e)}[${or(this.index.toWGSL(t,e))}]`}toString(t){return`${this.source.toString(t)}[${or(this.index.toString(t))}]`}}class Mr extends hr{value;constructor(t){if(super(),t.getType().isVoidType())throw new Error("can not touch void type");t instanceof Pr&&(t.isStatement=!1),this.value=t}toWebGL(t,e){return`${t}${this.value.toWebGL("",e)};\n`}toWebGL2(t,e){return`${t}${this.value.toWebGL2("",e)};\n`}toWGSL(t,e){return this.value.getType().isVoidType()?`${t}${this.value.toWGSL("",e)};\n`:`${t}_ = ${this.value.toWGSL("",e)};\n`}}class $r extends ur{condition;first;second;type;constructor(t,e,i){super(),this.condition=t instanceof ur?t:new Er(t,ce);let s=null,r=null;if(e instanceof ur)s=e.getType(),this.first=e,e instanceof Pr&&(e.isStatement=!1);else if("number"==typeof e)Number.isInteger(e)||(this.first=new Er(e,Kt),s=Kt);else{if("boolean"!=typeof e)throw new Error("select: invalid first value");this.first=new Er(e,ce),s=ce}if(i instanceof ur)r=i.getType(),this.second=i,i instanceof Pr&&(i.isStatement=!1);else if("number"==typeof i)Number.isInteger(i)||(this.second=new Er(i,Kt),r=Kt);else{if("boolean"!=typeof i)throw new Error("select: invalid second value");this.second=new Er(i,ce),r=ce}if(!s&&!r)throw new Error("select: cannot determine the value types");if(s&&r){if(!s.isCompatibleType(r))throw new Error("select: first value and second value must be the same type");this.type=s}else if(s){if(s.typeId===Kt.typeId)this.second=new Er(i,Kt);else if(s.typeId===se.typeId)this.second=new Er(i,se);else{if(s.typeId!==oe.typeId)throw new Error("select: invalid type of the second value");this.second=new Er(i,oe)}this.type=s}else{if(r.typeId===Kt.typeId)this.first=new Er(e,Kt);else if(r.typeId===se.typeId)this.first=new Er(e,se);else{if(r.typeId!==oe.typeId)throw new Error("select: invalid type of the first value");this.first=new Er(e,oe)}this.type=r}}getType(){return this.type}isConstExp(){return!1}markWritable(){}isWritable(){return!1}getAddressSpace(){return null}toWebGL(t,e){return`${t}(${this.condition.toWebGL("",e)} ? ${this.first.toWebGL("",e)} : ${this.second.toWebGL("",e)})`}toWebGL2(t,e){return`${t}(${this.condition.toWebGL2("",e)} ? ${this.first.toWebGL2("",e)} : ${this.second.toWebGL2("",e)})`}toWGSL(t,e){return`${t}select(${this.second.toWGSL("",e)}, ${this.first.toWGSL("",e)}, ${this.condition.toWGSL("",e)})`}}class Nr extends hr{lvalue;rvalue;constructor(t,e){if(super(),!t.isReference())throw new Error("assignment: l-value required");if(this.lvalue=t,this.rvalue=e,this.lvalue instanceof Tr)if(this.lvalue.getType().isPointerType())if(this.rvalue instanceof _r)this.lvalue.value.ref=this.rvalue.ref;else{if(!(this.rvalue instanceof Sr))throw new Xs(this.lvalue,"invalid pointer assignment");this.lvalue.value.ref=this.rvalue.value}else this.rvalue instanceof ur&&(this.lvalue.value.constExp=this.rvalue.isConstExp());else{if(this.lvalue.getType().isPointerType())throw new Xs(this.lvalue,"cannot assign to read-only variable");this.lvalue.markWritable()}this.rvalue instanceof Pr&&(this.rvalue.isStatement=!1)}getType(){return null}toWebGL(t,e){let i=null;const s=this.lvalue.getType(),r=this.checkScalarType(this.rvalue,s);if(!s.isCompatibleType(r))throw new Fs(this.rvalue instanceof ur?this.rvalue.toString("webgl"):`${this.rvalue}`,r,s);return i="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?r.primitiveType===At.F32?rr(this.rvalue):String(this.rvalue):or(this.rvalue.toWebGL(t,e)),this.lvalue instanceof Tr&&(this.lvalue.value.constExp&&=!(this.rvalue instanceof ur)||this.rvalue.isConstExp()),`${t}${this.lvalue.toWebGL(t,e)} = ${i};\n`}toWebGL2(t,e){let i=null;const s=this.lvalue.getType(),r=this.checkScalarType(this.rvalue,s);if(!s.isCompatibleType(r))throw new Fs(this.rvalue instanceof ur?this.rvalue.toString("webgl2"):`${this.rvalue}`,r,s);return i="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?r.primitiveType===At.F32?rr(this.rvalue):String(this.rvalue):or(this.rvalue.toWebGL2(t,e)),this.lvalue instanceof Tr&&(this.lvalue.value.constExp&&=!(this.rvalue instanceof ur)||this.rvalue.isConstExp()),`${t}${this.lvalue.toWebGL2(t,e)} = ${i};\n`}toWGSL(t,e){const i=this.lvalue.getType(),[s,r]=i.isPointerType()?[i.pointerType,!0]:[i,!1],a=this.checkScalarType(this.rvalue,s),n=a&&a.isPointerType(),o=n?a.pointerType:a;if(!s.isCompatibleType(o))throw new Fs(this.rvalue instanceof ur?this.rvalue.toString("webgpu"):`${this.rvalue}`,a,i);if(this.lvalue instanceof fr||this.lvalue instanceof Tr){const t=s.isStructType()?s.structName:null;if(t&&e.types.findIndex((e=>e instanceof kr&&e.type.structName===t))<0)return""}let h;h="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?a.primitiveType===At.F32?rr(this.rvalue):String(this.rvalue):or(this.rvalue.toWGSL(t,e));const u=this.lvalue.toWGSL(t,e);if(r&&!n){if(this.lvalue instanceof Tr)throw new Error(`rvalue must be pointer type: ${h}`);return`${t}*(${u}) = ${h};\n`}return n&&!r?`${t}${u} = *(${h});\n`:`${t}${u} = ${h};\n`}checkScalarType(t,e){if(t instanceof ur)return t.getType();const i="boolean"==typeof t,s="number"==typeof t&&Number.isInteger(t)&&t>=-2147483648&&t<=2147483647,r="number"==typeof t&&Number.isInteger(t)&&t>=0&&t<=4294967295,a="number"==typeof t;if(!e.isPrimitiveType())return i?ce:s?se:r?oe:Kt;switch(e.primitiveType){case At.BOOL:return i?e:s?se:r?oe:Kt;case At.F32:return a?e:ce;case At.I32:return s?e:i?ce:r?oe:Kt;case At.U32:return r?e:i?ce:s?se:Kt;default:return null}}}class Dr extends hr{toWebGL(t,e){return`${t}discard;\n`}toWebGL2(t,e){return`${t}discard;\n`}toWGSL(t,e){return`${t}discard;\n`}}class Ir extends hr{toWebGL(t,e){return`${t}break;\n`}toWebGL2(t,e){return`${t}break;\n`}toWGSL(t,e){return`${t}break;\n`}}class Lr extends hr{toWebGL(t,e){return`${t}continue;\n`}toWebGL2(t,e){return`${t}continue;\n`}toWGSL(t,e){return`${t}continue;\n`}}class Fr extends hr{value;constructor(t){super(),this.value=t,this.value instanceof Pr&&(this.value.isStatement=!1)}toWebGL(t,e){return this.value?`${t}return ${or(this.value.toWebGL(t,e))};\n`:`${t}return;\n`}toWebGL2(t,e){return this.value?`${t}return ${or(this.value.toWebGL2(t,e))};\n`:`${t}return;\n`}toWGSL(t,e){return this.value?`${t}return ${or(this.value.toWGSL(t,e))};\n`:`${t}return;\n`}}class Pr extends ur{name;args;retType;func;isStatement;constructor(t,e,i,s,r){if(super(),this.name=t,this.args=e,this.retType=i?.returnType??r??us,this.func=i,this.isStatement=!0,i){if(i.funcType.argTypes.length!==this.args.length)throw new Ws("ASTCallFunction(): number of parameters mismatch");for(let r=0;r<this.args.length;r++){const a=i.funcType.argTypes[r];if(a.byRef){if("webgpu"===s){const i=e[r].getAddressSpace();if(i!==Gt.FUNCTION&&i!==Gt.PRIVATE)throw new Bs(t,"pointer type of function parameter must be function or private");const s=a.type;if(!s.isPointerType())throw new Ws("ASTCallFunction(): invalid reference type");if(s.addressSpace===Gt.UNKNOWN)s.addressSpace=i;else if(s.addressSpace!==i)throw new Bs(t,`invalid pointer parameter address space '${i}', should be '${s.addressSpace}`)}this.args[r].markWritable()}}}for(const t of this.args)t instanceof Pr&&(t.isStatement=!1)}getType(){return this.retType}isConstExp(){return!1}markWritable(){}isWritable(){return!1}getAddressSpace(){return null}toWebGL(t,e){"dFdx"===this.name||"dFdy"===this.name||"fwidth"===this.name?e.extensions.add("GL_OES_standard_derivatives"):"texture2DLodEXT"!==this.name&&"texture2DProjLodEXT"!==this.name&&"textureCubeLodEXT"!==this.name&&"texture2DGradEXT"!==this.name&&"texture2DProjGradEXT"!==this.name&&"textureCubeGradEXT"!==this.name||e.extensions.add("GL_EXT_shader_texture_lod");const i=this.args.map((i=>or(i.toWebGL(t,e))));return`${this.isStatement?t:""}${this.name}(${i.join(",")})${this.isStatement?";\n":""}`}toWebGL2(t,e){const i=this.args.map((i=>or(i.toWebGL2(t,e))));return`${this.isStatement?t:""}${this.name}(${i.join(",")})${this.isStatement?";\n":""}`}toWGSL(t,e){let i=this.args.filter((t=>{const i=t.getType();return!(t instanceof _r&&i.isStructType()&&e.types.findIndex((t=>t instanceof kr&&t.type.structName===i.structName))<0)}));if(this.func){let t;const e=Xr(i,this.func.funcType);if(e&&(t=e.args),!t)throw new Error(`no matching overloading found for function '${this.name}'`);i=t}const s=i.map((i=>or(i.toWGSL(t,e))));return`${this.isStatement?t:""}${this.name}(${s.join(",")})${this.isStatement?";\n":""}`}toString(t){return`${this.name}(...)`}}class Br extends hr{value;group;binding;blockName;constructor(t){super(),this.value=t,this.group=0,this.binding=0}isReference(){return!0}isPointer(){return this.value.getType().isPointerType()}toWebGL(t,e){let i="",s=!1,r=this.value.getType();switch(this.value.value.$declareType){case Ks.DECLARE_TYPE_IN:e.type===_t.Vertex?(i="attribute ",e.defines.push(`#define ${this.value.name} ${Rs(e.vertexAttributes[this.value.value.$location])}\n`)):i="varying ";break;case Ks.DECLARE_TYPE_OUT:e.type===_t.Vertex?i="varying ":(s=!0,e.mrt?(e.defines.push(`#define ${this.value.name} gl_FragData[${this.value.value.$location}]\n`),e.extensions.add("GL_EXT_draw_buffers")):e.defines.push(`#define ${this.value.name} gl_FragColor\n`));break;case Ks.DECLARE_TYPE_UNIFORM:i="uniform ",r=e.typeReplacement?.get(this.value.value)||r;break;case Ks.DECLARE_TYPE_STORAGE:throw new Error(`invalid variable declare type: ${this.value.name}`)}if(!s)return`${t}${i}${r.toTypeName("webgl",this.value.name)};\n`}toWebGL2(t,e){let i="",s=this.value.getType();switch(this.value.value.$declareType){case Ks.DECLARE_TYPE_IN:i=e.type===_t.Fragment&&s.isPrimitiveType()&&s.isInteger()?"flat in ":"in ",e.type===_t.Vertex&&e.defines.push(`#define ${this.value.name} ${Rs(e.vertexAttributes[this.value.value.$location])}\n`);break;case Ks.DECLARE_TYPE_OUT:i=e.type===_t.Vertex?s.isPrimitiveType()&&s.isInteger()?"flat out ":"out ":`layout(location = ${this.value.value.$location}) out `;break;case Ks.DECLARE_TYPE_UNIFORM:return s.isStructType()?`${t}layout(std140) uniform ${this.blockName} { ${s.structName} ${this.value.name}; };\n`:(s=e.typeReplacement?.get(this.value.value)||s,`${t}uniform ${s.toTypeName("webgl2",this.value.name)};\n`);case Ks.DECLARE_TYPE_STORAGE:throw new Error(`invalid variable declare type: ${this.value.name}`)}return`${t}${i}${this.value.getType().toTypeName("webgl2",this.value.name)};\n`}toWGSL(t,e){let i;const s=this.value.getType().isPrimitiveType()||this.value.getType().isStructType()||this.value.getType().isArrayType();switch(this.value.value.$declareType){case Ks.DECLARE_TYPE_IN:case Ks.DECLARE_TYPE_OUT:throw new Error("Internal error");case Ks.DECLARE_TYPE_UNIFORM:this.group,i=`@group(${this.group}) @binding(${this.binding}) var${s?"<uniform>":""} `;break;case Ks.DECLARE_TYPE_STORAGE:i=`@group(${this.group}) @binding(${this.binding}) var<storage, ${this.value.isWritable()?"read_write":"read"}> `;break;case Ks.DECLARE_TYPE_WORKGROUP:i="var<workgroup> ";break;default:i=`${this.value.getType().isPointerType()?"let":"var"}${this.value.value.$global&&!this.value.getType().isPointerType()?"<private>":""} `}{const s=this.value.getType(),r=s.isStructType()?s.structName:null;return r&&e.types.findIndex((t=>t instanceof kr&&t.type.structName===r))<0?"":`${t}${i}${s.toTypeName("webgpu",this.value.name)};\n`}}toString(t){return this.value.toString(t)}}class Or extends cr{name;args;isBuiltin;isMainFunc;funcType;builtins;returnType;constructor(t,e,i,s,r=!1){super(),this.name=t,this.args=e,this.funcType=s,this.builtins=[],this.isBuiltin=r,this.isMainFunc=i,this.returnType=s?s.returnType:null}toWebGL(t,e){if(this.isBuiltin)return"";{let i="";const s=[];for(const t of this.args){let e,i,r;t.paramAST instanceof _r?(e=t.paramAST.value,i=t.paramAST.name,r=""):(e=t.paramAST.value.value,i=t.paramAST.value.name,r=`${e.$inout} `),s.push(`${r}${t.getType().toTypeName("webgl",i)}`)}return i+=`${t}${this.returnType.toTypeName("webgl")} ${this.name}(${s.join(",")}) {\n`,i+=super.toWebGL(t+"  ",e),i+=`${t}}\n`,i}}toWebGL2(t,e){if(this.isBuiltin)return"";{let i="";const s=[];for(const t of this.args){let e,i,r;t.paramAST instanceof _r?(e=t.paramAST.value,i=t.paramAST.name,r=""):(e=t.paramAST.value.value,i=t.paramAST.value.name,r=`${e.$inout} `),s.push(`${r}${t.getType().toTypeName("webgl2",i)}`)}return i+=`${t}${this.returnType.toTypeName("webgl2")} ${this.name}(${s.join(",")}) {\n`,i+=super.toWebGL2(t+"  ",e),i+=`${t}}\n`,i}}toWGSL(t,e){if(this.isBuiltin)return"";{let i="";const s=[...this.builtins];for(const t of this.args){const i=t.paramAST instanceof _r?t.paramAST.name:t.paramAST.value.name,r=t.paramAST instanceof _r?t.paramAST.getType():t.paramAST.value.getType(),a=r.isPointerType()?r.pointerType:r;a.isStructType()&&e.types.findIndex((t=>t instanceof kr&&t.type.structName===a.structName))<0||s.push(`${r.toTypeName("webgpu",i)}`)}let r="";if(this.isMainFunc)switch(e.type){case _t.Vertex:r="@vertex ";break;case _t.Fragment:r="@fragment ";break;case _t.Compute:r=`@compute @workgroup_size(${e.workgroupSize[0]}, ${e.workgroupSize[1]}, ${e.workgroupSize[2]}) `}const a=this.returnType.isVoidType()?null:this.returnType.toTypeName("webgpu"),n=a?` -> ${a}`:"";return i+=`${t}${r}fn ${this.name}(${s.join(",")})${n} {\n`,i+=super.toWGSL(t+"  ",e),i+=`${t}}\n`,i}}}class Ur extends cr{keyword;condition;nextElse;constructor(t,e){super(),this.keyword=t,this.condition=e,this.nextElse=null,this.condition instanceof Pr&&(this.condition.isStatement=!1)}toWebGL(t,e){let i=`${t}${this.keyword} ${this.condition?"("+or(this.condition.toWebGL(t,e))+")":""} {\n`;return i+=super.toWebGL(t+"  ",e),i+=`${t}}\n`,this.nextElse&&(i+=this.nextElse.toWebGL(t,e)),i}toWebGL2(t,e){let i=`${t}${this.keyword} ${this.condition?"("+or(this.condition.toWebGL2(t,e))+")":""} {\n`;return i+=super.toWebGL2(t+"  ",e),i+=`${t}}\n`,this.nextElse&&(i+=this.nextElse.toWebGL2(t,e)),i}toWGSL(t,e){let i=`${t}${this.keyword} ${this.condition?"("+or(this.condition.toWGSL(t,e))+")":""} {\n`;return i+=super.toWGSL(t+"  ",e),i+=`${t}}\n`,this.nextElse&&(i+=this.nextElse.toWGSL(t,e)),i}}class Vr extends cr{init;start;end;open;constructor(t,e,i,s){super(),this.init=t,this.start=e,this.end=i,this.open=s,this.statements=[],this.start instanceof Pr&&(this.start.isStatement=!1),this.end instanceof Pr&&(this.end.isStatement=!1)}toWebGL(t,e){const i=this.init.getType().toTypeName("webgl",this.init.name),s=or(this.start.toWebGL(t,e)),r=or(this.end.toWebGL(t,e)),a=this.open?"<":"<=";let n=`${t}for (${i} = ${s}; ${this.init.name} ${a} ${r}; ${this.init.name}++) {\n`;return n+=super.toWebGL(t+"  ",e),n+=`${t}}\n`,n}toWebGL2(t,e){const i=this.init.getType().toTypeName("webgl2",this.init.name),s=or(this.start.toWebGL2(t,e)),r=or(this.end.toWebGL2(t,e)),a=this.open?"<":"<=";let n=`${t}for (${i} = ${s}; ${this.init.name} ${a} ${r}; ${this.init.name}++) {\n`;return n+=super.toWebGL2(t+"  ",e),n+=`${t}}\n`,n}toWGSL(t,e){const i=`var ${this.init.getType().toTypeName("webgpu",this.init.name)}`,s=or(this.start.toWGSL(t,e)),r=or(this.end.toWGSL(t,e)),a=new Er(1,this.init.getType()).toWGSL(t,e),n=this.open?"<":"<=";let o=`${t}for (${i} = ${s}; ${this.init.name} ${n} ${r}; ${this.init.name} = ${this.init.name} + ${a}) {\n`;return o+=super.toWGSL(t+"  ",e),o+=`${t}}\n`,o}}class Gr extends cr{condition;constructor(t){super(),this.condition=t,this.condition instanceof Pr&&(this.condition.isStatement=!1)}toWebGL(t,e){let i=`${t}do {\n`;return i+=super.toWebGL(t+" ",e),i+=`${t}} while(${or(this.condition.toWebGL(t,e))});\n`,i}toWebGL2(t,e){let i=`${t}do {\n`;return i+=super.toWebGL2(t+" ",e),i+=`${t}} while(${or(this.condition.toWebGL2(t,e))});\n`,i}toWGSL(t,e){let i=`${t}loop {\n`;return i+=super.toWGSL(t+" ",e),i+=`${t}  if (!(${or(this.condition.toWGSL(t,e))})) { break; }\n`,i+=`${t}}\n`,i}}class zr extends cr{condition;constructor(t){super(),this.condition=t,this.condition instanceof Pr&&(this.condition.isStatement=!1)}toWebGL(t,e){let i=`${t}while(${or(this.condition.toWebGL(t,e))}) {\n`;return i+=super.toWebGL(t+"  ",e),i+=`${t}}\n`,i}toWebGL2(t,e){let i=`${t}while(${or(this.condition.toWebGL2(t,e))}) {\n`;return i+=super.toWebGL2(t+"  ",e),i+=`${t}}\n`,i}toWGSL(t,e){let i=`${t}for(;${or(this.condition.toWGSL(t,e))};) {\n`;return i+=super.toWGSL(t+"  ",e),i+=`${t}}\n`,i}}class kr extends hr{type;prefix;builtin;constructor(t,e){super(),this.prefix=null,this.builtin=e,this.type=t}getType(){return this.type}toWebGL(t,e){if(this.builtin)return"";{let e=`${t}struct ${this.type.structName} {\n`;for(const i of this.type.structMembers)e+=`${t}  ${i.type.toTypeName("webgl",i.name)};\n`;return e+=`${t}};\n`,e}}toWebGL2(t,e){if(this.builtin)return"";{let e=`${t}struct ${this.type.structName} {\n`;for(const i of this.type.structMembers)e+=`${t}  ${i.type.toTypeName("webgl2",i.name)};\n`;return e+=`${t}};\n`,e}}toWGSL(t,e){if(this.builtin)return"";{let e=`${t}struct ${this.type.structName} {\n`;return e+=this.type.structMembers.map(((e,i)=>{const s=this.prefix?this.prefix[i]:"",r=e.type.getLayoutSize(this.type.layout)!==e.type.getLayoutSize("default")?`@size(${e.type.getLayoutSize(this.type.layout)}) `:"",a=i>0&&e.type.getLayoutAlignment(this.type.layout)!==e.type.getLayoutAlignment("default")?`@align(${e.type.getLayoutAlignment(this.type.layout)}) `:"";return`${t}  ${s}${a}${r}${e.type.toTypeName("webgpu",e.name)}`})).join(",\n"),e+=`\n${t}};\n`,e}}}function Xr(t,e){if(t.length!==e.argTypes.length)return null;const i=[];for(let s=0;s<t.length;s++){const r=!!e.argTypes[s].byRef,a=r?e.argTypes[s].type.pointerType:e.argTypes[s].type,n=t[s];if("number"==typeof n){if(r||!a.isPrimitiveType()||!a.isScalarType()||a.primitiveType===At.BOOL)return null;i.push(new Er(n,a))}else if("boolean"==typeof n){if(r||!a.isPrimitiveType()||a.primitiveType!==At.BOOL)return null;i.push(new Er(n,a))}else{if(!a.isCompatibleType(n.getType()))return null;r?(n.markWritable(),i.push(new Sr(n))):i.push(n)}}return{name:e.name,args:i}}class Wr{_builder;_tagList;_attribList;constructor(t){this._builder=t,this._tagList={},this._attribList={}}get vertexAttributes(){return this._builder.getVertexAttributes()}hasVertexAttribute(t){return this.vertexAttributes.indexOf(t)>=0}clear(){this._tagList={},this._attribList={}}tag(t,e){if("string"==typeof t){if(void 0===e)return this.getTag(t);this.addTag(t,e)}else for(const e of Object.keys(t))this.addTag(e,t[e])}attribute(t){return this._attribList[t]||null}setAttrib(t,e){this._attribList[t]=e}addTag(t,e){this._tagList[t]=e}getTag(t){const e=this._tagList[t];return e?e(this._builder.getGlobalScope()):null}}let Hr=null;const Yr=new Map;function qr(t){Hr=t}function jr(){return Hr}function Zr(t,e){return new Proxy(t,{get:function(i,s){if("symbol"==typeof s||s in i)return i[s];let r=Yr.get(t);r||(r={},Yr.set(t,r));let a=r[s];if(!a&&(e.isPrimitiveType()||e.isStructType()||e.isArrayType()))if("ptr"===s){const t=new Yt(e,Gt.FUNCTION);a=function(...e){if(1===e.length&&"string"==typeof e[0])return new Jr(e[0],t);throw new Error("Invalid pointer type constructor")}}else{const t=Number(s);if(Number.isInteger(t)&&t>=0){const i=new Ht(e,t);a=Zr((function(...t){if(1===t.length&&"string"==typeof t[0])return new Jr(t[0],i);{const e=new Jr("",i);return e.$ast=new br(e.$typeinfo,t.map((t=>t instanceof Jr?t.$ast:t))),e}}),i)}}return a&&(r[s]=a),a}})}class Kr{proxy;constructor(){return this.proxy=new Proxy(this,{get:function(t,e){return"string"==typeof e?t.$get(e):void 0},set:function(t,e,i){return"string"==typeof e&&t.$set(e,i)}}),this.proxy}get $thisProxy(){return this.proxy}}let Qr=0;class Jr extends Kr{$uid;$str;$location;$typeinfo;$global;$sampleType;$precision;$ast;$inout;$memberCache;$attrib;$tags;$_group;$declareType;$isBuffer;constructor(t,e){if(super(),!t&&e.isPointerType())throw new Error("no default constructor for pointer type");if(this.$uid=Qr++,this.$str=t||"",this.$location=0,this.$global=!1,this.$typeinfo=e,this.$qualifier=null,this.$precision=Qs.NONE,this.$ast=new _r(this),this.$inout=null,this.$memberCache={},this.$attrib=null,this.$tags=[],this.$_group=null,this.$declareType=Ks.DECLARE_TYPE_NONE,this.$isBuffer=!1,e.isTextureType())if(e.isDepthTexture())this.$sampleType="depth";else{const t=function(t){switch(t.textureType){case Ft.TEX_1D:case Ft.TEX_STORAGE_1D:case Ft.TEX_2D:case Ft.TEX_STORAGE_2D:case Ft.TEX_2D_ARRAY:case Ft.TEX_STORAGE_2D_ARRAY:case Ft.TEX_3D:case Ft.TEX_STORAGE_3D:case Ft.TEX_CUBE:case Ft.TEX_EXTERNAL:return new Xt(At.F32VEC4);case Ft.TEX_DEPTH_2D_ARRAY:case Ft.TEX_DEPTH_2D:case Ft.TEX_DEPTH_CUBE:return new Xt(At.F32);case Ft.ITEX_2D_ARRAY:case Ft.ITEX_1D:case Ft.ITEX_2D:case Ft.ITEX_3D:case Ft.ITEX_CUBE:return new Xt(At.I32);case Ft.UTEX_2D_ARRAY:case Ft.UTEX_1D:case Ft.UTEX_2D:case Ft.UTEX_3D:case Ft.UTEX_CUBE:return new Xt(At.U32);default:return null}}(e);t.primitiveType===At.I32?this.$sampleType="sint":t.primitiveType===At.U32?this.$sampleType="uint":this.$sampleType="float"}}get $group(){return this.$_group}set $group(t){this.$_group=t,this.$_group}uniform(t){return this.$declareType=Ks.DECLARE_TYPE_UNIFORM,this.$group=t,this.$isBuffer=!1,this}uniformBuffer(t){if(!this.$typeinfo.isPrimitiveType()&&!this.$typeinfo.isArrayType()&&!this.$typeinfo.isStructType())throw new Xs(this.$ast,"only primitive type, array type or structure type can be set as uniform buffer");return this.$declareType=Ks.DECLARE_TYPE_UNIFORM,this.$group=t,this.$isBuffer=!0,this}workgroup(){return this.$declareType=Ks.DECLARE_TYPE_WORKGROUP,this}storage(t){if(!this.$typeinfo.isHostSharable())throw new Xs(this.$ast,"type cannot be declared in storage address space");return this.$declareType=Ks.DECLARE_TYPE_STORAGE,this.$group=t,this.$isBuffer=!1,this}storageBuffer(t){if(!this.$typeinfo.isPrimitiveType()&&!this.$typeinfo.isArrayType()&&!this.$typeinfo.isStructType())throw new Xs(this.$ast,"only primitive type, array type or structure type can be set as storage buffer");return this.$declareType=Ks.DECLARE_TYPE_STORAGE,this.$group=t,this.$isBuffer=!0,this}inout(){return this.$inout="inout",this}out(){return this.$inout="out",this}attrib(t){return this.$declareType=Ks.DECLARE_TYPE_IN,this.$attrib=t,this}tag(...t){return t.forEach((t=>{this.$tags.indexOf(t)<0&&this.$tags.push(t)})),this}sampleType(t){return t&&(this.$sampleType=t),this}at(t){const e=this.$ast.getType();if(!(e.isArrayType()||e.isPrimitiveType()&&(e.isVectorType()||e.isMatrixType())))throw new Error("at() function must be used with array types");let i,s=null;e.isArrayType()?(s=e.elementType,i=e.dimension):e.isVectorType()?(s=Xt.getCachedTypeInfo(e.resizeType(1,1)),i=e.cols):e.isMatrixType()&&(s=Xt.getCachedTypeInfo(e.resizeType(1,e.cols)),i=e.rows);const r=new Jr("",s);if("number"==typeof t){if(!Number.isInteger(t))throw new Error("at() array index must be integer type");if(t<0||i>0&&t>=i)throw new Error("at() array index out of bounds");r.$ast=new Rr(this.$ast,new Er(t,se),s)}else{const e=t.$ast.getType();if(!e.isPrimitiveType()||!e.isScalarType())throw new Error("at() array index must be scalar type");let i=t.$ast;e.scalarType!==At.I32&&e.scalarType!==At.U32&&(i=new vr(i,se)),r.$ast=new Rr(this.$ast,i,s)}return r}setAt(t,e){const i=this.$ast.getType();if(!i.isArrayType())throw new Error("setAt() function must be used with array types");if("number"==typeof t){if(!Number.isInteger(t))throw new Error("setAt() array index must be integer type");if(t<0||i.dimension>0&&t>=i.dimension)throw new Error("setAt() array index out of bounds")}Hr.getCurrentScope().$ast.statements.push(new Nr(new xr(new fr(this.$ast),"number"==typeof t?new Er(t,se):t.$ast,i.elementType),e instanceof Jr?e.$ast:e))}highp(){return this.$precision=Qs.HIGH,this}mediump(){return this.$precision=Qs.MEDIUM,this}lowp(){return this.$precision=Qs.LOW,this}isVector(){const t=this.$ast.getType();return t.isPrimitiveType()&&t.isVectorType()}numComponents(){const t=this.$ast.getType();return t.isPrimitiveType()?t.cols:0}getTypeName(){return this.$ast.getType().toTypeName(Hr.getDevice().type)}$get(t){if("string"==typeof t){if("$"===t[0]||t in this)return this[t];{let e=this.$memberCache[t];if(!e){const i=this.$ast?.getType()||this.$typeinfo,s=Number(t);if(Number.isNaN(s))if(i.isStructType()){const s=i.structMembers.findIndex((e=>e.name===t));if(s<0)throw new Error(`unknown struct member '${t}'`);const r=i.structMembers[s];if(r.type.isStructType()){e=Hr.structInfo.structs[r.type.structName].call(Hr,`${this.$str}.${t}`)}else e=new Jr(`${this.$str}.${t}`,r.type);e.$ast=new yr(this.$ast,t,r.type)}else{if(!i.isPrimitiveType()||!i.isVectorType())throw new Error(`invalid index operation: ${this.$ast.toString(Hr.getDevice().type)}[${t}]`);if(0===t.length||t.length>4||[...t].some((t=>"xyzw".slice(0,i.cols).indexOf(t)<0))&&[...t].some((t=>"rgba".slice(0,i.cols).indexOf(t)<0)))throw new Error(`unknown swizzle target: ${this.$ast.toString(Hr.getDevice().type)}[${t}]`);const s=Xt.getCachedTypeInfo(i.resizeType(1,t.length));e=new Jr("",s),e.$ast=new yr(this.$ast,t,s)}else if(i.isArrayType())e=this.at(s);else if(i.isPrimitiveType()&&i.isVectorType()){if(s>=i.cols)throw new Error(`component index out of bounds: ${this.$str}[${s}]`);e=this.$get("xyzw"[s])}else{if(!i.isPrimitiveType()||!i.isMatrixType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);{const t=Xt.getCachedTypeInfo(i.resizeType(1,i.cols));e=new Jr("",t),e.$ast=new Rr(this.$ast,new Er(s,se),t)}}this.$memberCache[t]=e}return e}}}$set(t,e){if("string"==typeof t){if("$"===t[0]||t in this)this[t]=e;else{if("number"!=typeof e&&"boolean"!=typeof e&&!(e instanceof Jr))throw new Error("Invalid output value assignment");const i=this.$ast?.getType()||this.$typeinfo,s=Number(t);if(Number.isNaN(s))if(i.isStructType()){const s=i.structMembers.findIndex((e=>e.name===t));if(s<0)throw new Error(`unknown struct member '${t}`);const r=i.structMembers[s];let a;if("number"==typeof e||"boolean"==typeof e){if(!r.type.isPrimitiveType()||!r.type.isScalarType())throw new Error(`can not set struct member '${t}: invalid value type`);a=new Er(e,r.type)}else e instanceof Jr&&(a=e.$ast);if(!a)throw new Error(`can not set struct member '${t}: invalid value type`);Hr.getCurrentScope().$ast.statements.push(new Nr(new gr(new fr(this.$ast),t,r.type),a))}else{if(t.length>1||"xyzw".indexOf(t)<0&&"rgba".indexOf(t)<0)throw new Error(`invalid index operation: ${this.$str}[${s}]`);if(!i.isPrimitiveType()||!i.isVectorType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);const r=Xt.getCachedTypeInfo(i.scalarType);Hr.getCurrentScope().$ast.statements.push(new Nr(new gr(new fr(this.$ast),t,r),e instanceof Jr?e.$ast:e))}else if(i.isArrayType())this.setAt(s,e);else if(i.isPrimitiveType()&&i.isVectorType()){if(s>=i.cols)throw new Error(`component index out of bounds: ${this.$str}[${s}]`);this.$set("xyzw"[s],e)}else{if(!i.isPrimitiveType()||!i.isMatrixType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);{if(!(e instanceof Jr))throw new Error(`invalid matrix column vector assignment: ${this.$str}[${s}]`);const t=Xt.getCachedTypeInfo(i.resizeType(1,i.cols));Hr.getCurrentScope().$ast.statements.push(new Nr(new xr(new fr(this.$ast),new Er(s,se),t),e.$ast))}}}return!0}return!1}}const ta=[[Kt,Qt,Jt,te],[se,re,ae,ne],[oe,he,ue,le],[ce,de,pe,_e]],ea=[me,fe,ge,xe,Te,be,Ee,ye,ve];function ia(t,e,...i){const s="webgl"===t.getDevice().type?ua:"webgl2"===t.getDevice().type?la:ca,r=_a?.[e].overloads.filter((t=>!!(t[1]&s))).map((t=>t[0]));if(!r||0===r.length)throw new zs(`builtin shader function '${e}'`);const a=i.map((e=>t.normalizeExpValue(e))),n=t._matchFunctionOverloading(r,a);if(!n)throw new Us(e);return n}function sa(t,e){return t.$callFunction(e[0].name,e[1],e[0])}function ra(t,e,...i){return sa(t,ia(t,e,...i))}function aa(t,e,i,s){const r=[];for(let a=0;a<ea.length;a++){const n=i||ea[a],o=s.map((t=>({type:t||ea[a]})));r.push([new Or(t,null,!1,new Zt(t,n,o),!0),e])}return r}function na(t,e,i,s,r){if(s.findIndex((t=>"number"==typeof t))<0)return[[new Or(t,null,!1,new Zt(t,i,s.map((t=>({type:t})))),!0),e]];{const a=[];let n=r?1:0;for(;n<4;n++){const r="number"==typeof i?ta[i][n]:i,o=s.map((t=>"number"==typeof t?{type:ta[t][n]}:{type:t}));a.push([new Or(t,null,!1,new Zt(t,r,o),!0),e])}return a}}function oa(t,e,i){const s=new Jr("",i);return s.$ast=new Cr(t,e,i),s}function ha(t,e,i,s){const r=new Jr("",s);return r.$ast=new Ar(t,e,i,s),r}const ua=1,la=2,ca=4,da=ua|la,pa=da|ca,_a={add_2:{overloads:[...na("",pa,0,[0,0]),...na("",pa,1,[1,1]),...na("",pa,2,[2,2]),...na("",pa,3,[3,3]),...na("",pa,Qt,[Kt,Qt]),...na("",pa,Qt,[Qt,Kt]),...na("",pa,Jt,[Kt,Jt]),...na("",pa,Jt,[Jt,Kt]),...na("",pa,te,[Kt,te]),...na("",pa,te,[te,Kt]),...na("",pa,re,[se,re]),...na("",pa,re,[re,se]),...na("",pa,ae,[se,ae]),...na("",pa,ae,[ae,se]),...na("",pa,ne,[se,ne]),...na("",pa,ne,[ne,se]),...na("",pa,he,[oe,he]),...na("",pa,he,[he,oe]),...na("",pa,ue,[oe,ue]),...na("",pa,ue,[ue,oe]),...na("",pa,le,[oe,le]),...na("",pa,le,[le,oe]),...aa("",pa,null,[null,null])],normalizeFunc(t,e,...i){if(2===i.length&&"number"==typeof i[0]&&"number"==typeof i[1])return i[0]+i[1];const s=ia(t,e,...i);return ha(s[1][0],s[1][1],"+",s[0].returnType)}},add:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Ps("add");let s=i[0];for(let e=1;e<i.length;e++)s=t.add_2(s,i[e]);return s}},sub:{overloads:[...na("",pa,0,[0,0]),...na("",pa,1,[1,1]),...na("",pa,2,[2,2]),...na("",pa,3,[3,3]),...na("",pa,Qt,[Kt,Qt]),...na("",pa,Qt,[Qt,Kt]),...na("",pa,Jt,[Kt,Jt]),...na("",pa,Jt,[Jt,Kt]),...na("",pa,te,[Kt,te]),...na("",pa,te,[te,Kt]),...na("",pa,re,[se,re]),...na("",pa,re,[re,se]),...na("",pa,ae,[se,ae]),...na("",pa,ae,[ae,se]),...na("",pa,ne,[se,ne]),...na("",pa,ne,[ne,se]),...na("",pa,he,[oe,he]),...na("",pa,he,[he,oe]),...na("",pa,ue,[oe,ue]),...na("",pa,ue,[ue,oe]),...na("",pa,le,[oe,le]),...na("",pa,le,[le,oe]),...aa("",pa,null,[null,null])],normalizeFunc(t,e,...i){const s=ia(t,e,...i);return ha(s[1][0],s[1][1],"-",s[0].returnType)}},div:{overloads:[...na("",pa,0,[0,0]),...na("",pa,1,[1,1]),...na("",pa,2,[2,2]),...na("",pa,3,[3,3]),...na("",pa,Qt,[Kt,Qt]),...na("",pa,Qt,[Qt,Kt]),...na("",pa,Jt,[Kt,Jt]),...na("",pa,Jt,[Jt,Kt]),...na("",pa,te,[Kt,te]),...na("",pa,te,[te,Kt]),...na("",pa,re,[se,re]),...na("",pa,re,[re,se]),...na("",pa,ae,[se,ae]),...na("",pa,ae,[ae,se]),...na("",pa,ne,[se,ne]),...na("",pa,ne,[ne,se]),...na("",pa,he,[oe,he]),...na("",pa,he,[he,oe]),...na("",pa,ue,[oe,ue]),...na("",pa,ue,[ue,oe]),...na("",pa,le,[oe,le]),...na("",pa,le,[le,oe])],normalizeFunc(t,e,...i){const s=ia(t,e,...i);return ha(s[1][0],s[1][1],"/",s[0].returnType)}},mul_2:{overloads:[...na("",pa,0,[0,0]),...na("",pa,1,[1,1]),...na("",pa,2,[2,2]),...na("",pa,3,[3,3]),...na("",pa,Qt,[Kt,Qt]),...na("",pa,Qt,[Qt,Kt]),...na("",pa,Jt,[Kt,Jt]),...na("",pa,Jt,[Jt,Kt]),...na("",pa,te,[Kt,te]),...na("",pa,te,[te,Kt]),...na("",pa,re,[se,re]),...na("",pa,re,[re,se]),...na("",pa,ae,[se,ae]),...na("",pa,ae,[ae,se]),...na("",pa,ne,[se,ne]),...na("",pa,ne,[ne,se]),...na("",pa,he,[oe,he]),...na("",pa,he,[he,oe]),...na("",pa,ue,[oe,ue]),...na("",pa,ue,[ue,oe]),...na("",pa,le,[oe,le]),...na("",pa,le,[le,oe]),...aa("",pa,null,[Kt,null]),...aa("",pa,null,[null,Kt]),...na("",pa,me,[me,me]),...na("",pa,xe,[me,xe]),...na("",pa,Ee,[me,Ee]),...na("",pa,Qt,[me,Qt]),...na("",pa,Qt,[Qt,me]),...na("",pa,fe,[fe,me]),...na("",pa,Te,[fe,xe]),...na("",pa,ye,[fe,Ee]),...na("",pa,Jt,[fe,Qt]),...na("",pa,Qt,[Jt,fe]),...na("",pa,ge,[ge,me]),...na("",pa,be,[ge,xe]),...na("",pa,ve,[ge,Ee]),...na("",pa,te,[ge,Qt]),...na("",pa,Qt,[te,ge]),...na("",pa,me,[xe,fe]),...na("",pa,xe,[xe,Te]),...na("",pa,Ee,[xe,ye]),...na("",pa,Qt,[xe,Jt]),...na("",pa,Jt,[Qt,xe]),...na("",pa,fe,[Te,fe]),...na("",pa,Te,[Te,Te]),...na("",pa,ye,[Te,ye]),...na("",pa,Jt,[Te,Jt]),...na("",pa,Jt,[Jt,Te]),...na("",pa,ge,[be,fe]),...na("",pa,be,[be,Te]),...na("",pa,ve,[be,ye]),...na("",pa,te,[be,Jt]),...na("",pa,Jt,[te,be]),...na("",pa,me,[Ee,ge]),...na("",pa,xe,[Ee,be]),...na("",pa,Ee,[Ee,ve]),...na("",pa,Qt,[Ee,te]),...na("",pa,te,[Qt,Ee]),...na("",pa,fe,[ye,ge]),...na("",pa,Te,[ye,be]),...na("",pa,ye,[ye,ve]),...na("",pa,Jt,[ye,te]),...na("",pa,te,[Jt,ye]),...na("",pa,ge,[ve,ge]),...na("",pa,be,[ve,be]),...na("",pa,ve,[ve,ve]),...na("",pa,te,[ve,te]),...na("",pa,te,[te,ve])],normalizeFunc(t,e,...i){const s=ia(t,e,...i);return ha(s[1][0],s[1][1],"*",s[0].returnType)}},mul:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Ps("mul");let s=i[0];for(let e=1;e<i.length;e++)s=t.mul_2(s,i[e]);return s}},mod:{overloads:[...na("mod",pa,0,[0,0]),...na("mod",pa,1,[1,1]),...na("mod",pa,2,[2,2]),...na("mod",pa,3,[3,3])],normalizeFunc(t,e,...i){const s=ia(t,e,...i),r=s[1][0].getType(),a=r.isPrimitiveType()&&(r.scalarType===At.I32||r.scalarType===At.U32);if("webgl"===t.getDevice().type&&a)throw new zs("integer modulus");return"webgpu"===t.getDevice().type||a?ha(s[1][0],s[1][1],"%",s[0].returnType):sa(t,s)}},radians:{overloads:na("radians",pa,0,[0])},degrees:{overloads:na("degrees",pa,0,[0])},sin:{overloads:na("sin",pa,0,[0])},cos:{overloads:na("cos",pa,0,[0])},tan:{overloads:na("tan",pa,0,[0])},asin:{overloads:na("asin",pa,0,[0])},acos:{overloads:na("acos",pa,0,[0])},atan:{overloads:na("atan",pa,0,[0])},atan2:{overloads:[...na("atan",da,0,[0,0]),...na("atan2",ca,0,[0,0])]},sinh:{overloads:na("sinh",la|ca,0,[0])},cosh:{overloads:na("cosh",la|ca,0,[0])},tanh:{overloads:na("tanh",la|ca,0,[0])},asinh:{overloads:na("asinh",la,0,[0])},acosh:{overloads:na("acosh",la,0,[0])},atanh:{overloads:na("atanh",la,0,[0])},pow:{overloads:na("pow",pa,0,[0,0])},exp:{overloads:na("exp",pa,0,[0])},exp2:{overloads:na("exp2",pa,0,[0])},log:{overloads:na("log",pa,0,[0])},log2:{overloads:na("log2",pa,0,[0])},sqrt:{overloads:na("sqrt",pa,0,[0])},inverseSqrt:{overloads:[...na("inversesqrt",da,0,[0]),...na("inverseSqrt",ca,0,[0])]},abs:{overloads:[...na("abs",pa,0,[0]),...na("abs",la|ca,1,[1]),...na("abs",ca,2,[2])]},sign:{overloads:[...na("sign",pa,0,[0]),...na("sign",la,1,[1])]},floor:{overloads:na("floor",pa,0,[0])},ceil:{overloads:na("ceil",pa,0,[0])},fract:{overloads:na("fract",pa,0,[0])},fma:{overloads:na("fma",pa,0,[0,0,0]),normalizeFunc(t,e,...i){const s=ia(t,e,...i);return"webgpu"===t.getDevice().type?sa(t,s):t.add(t.mul(i[0],i[1]),i[2])}},round:{overloads:na("round",ca,0,[0])},trunc:{overloads:na("trunc",ca,0,[0])},min:{overloads:[...na("min",pa,0,[0,0]),...na("min",la|ca,1,[1,1]),...na("min",la|ca,2,[2,2])]},max:{overloads:[...na("max",pa,0,[0,0]),...na("max",la|ca,1,[1,1]),...na("max",la|ca,2,[2,2])]},clamp:{overloads:[...na("clamp",pa,0,[0,0,0]),...na("clamp",la|ca,1,[1,1,1]),...na("clamp",la|ca,2,[2,2,2])]},mix:{overloads:[...na("mix",pa,0,[0,0,0]),...na("mix",pa,0,[0,0,Kt])]},step:{overloads:na("step",pa,0,[0,0])},smoothStep:{overloads:na("smoothstep",pa,0,[0,0,0])},isnan:{overloads:na("isnan",la,3,[0])},isinf:{overloads:na("isinf",la,3,[0])},length:{overloads:na("length",pa,Kt,[0])},distance:{overloads:na("distance",pa,Kt,[0,0])},dot:{overloads:[...na("dot",pa,Kt,[0,0],!0),...na("dot",ca,se,[1,1],!0),...na("dot",ca,oe,[2,2],!0)]},cross:{overloads:na("cross",pa,Jt,[Jt,Jt])},normalize:{overloads:na("normalize",pa,0,[0],!0)},faceForward:{overloads:[...na("faceforward",da,0,[0,0,0],!0),...na("faceForward",ca,0,[0,0,0],!0)]},reflect:{overloads:na("reflect",pa,0,[0,0],!0)},refract:{overloads:na("refract",pa,0,[0,0,Kt],!0)},frexp:{overloads:[...na("frexp",ca,ls,[Kt]),...na("frexp",ca,cs,[Qt]),...na("frexp",ca,ds,[Jt]),...na("frexp",ca,ps,[te])]},outerProduct:{overloads:[...na("outerProduct",la,me,[Qt,Qt]),...na("outerProduct",la,Te,[Jt,Jt]),...na("outerProduct",la,ve,[te,te]),...na("outerProduct",la,fe,[Jt,Qt]),...na("outerProduct",la,xe,[Qt,Jt]),...na("outerProduct",la,ge,[te,Qt]),...na("outerProduct",la,Ee,[Qt,te]),...na("outerProduct",la,be,[te,Jt]),...na("outerProduct",la,ye,[Jt,te])]},transpose:{overloads:[...na("transpose",la|ca,me,[me]),...na("transpose",la|ca,Te,[Te]),...na("transpose",la|ca,ve,[ve]),...na("transpose",la|ca,fe,[xe]),...na("transpose",la|ca,xe,[fe]),...na("transpose",la|ca,ge,[Ee]),...na("transpose",la|ca,Ee,[ge]),...na("transpose",la|ca,be,[ye]),...na("transpose",la|ca,ye,[be])]},determinant:{overloads:[...na("determinant",la|ca,Kt,[me]),...na("determinant",la|ca,Kt,[Te]),...na("determinant",la|ca,Kt,[ve])]},inverse:{overloads:[...na("inverse",la,me,[me]),...na("inverse",la,Te,[Te]),...na("inverse",la,ve,[ve])]},lessThan:{overloads:[...na("lessThan",pa,3,[0,0]),...na("lessThan",pa,3,[1,1]),...na("lessThan",pa,3,[2,2])],normalizeFunc(t,e,...i){const s=ia(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?ha(s[1][0],s[1][1],"<",s[0].returnType):sa(t,s)}},lessThanEqual:{overloads:[...na("lessThanEqual",pa,3,[0,0]),...na("lessThanEqual",pa,3,[1,1]),...na("lessThanEqual",pa,3,[2,2])],normalizeFunc(t,e,...i){const s=ia(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?ha(s[1][0],s[1][1],"<=",s[0].returnType):sa(t,s)}},greaterThan:{overloads:[...na("greaterThan",pa,3,[0,0]),...na("greaterThan",pa,3,[1,1]),...na("greaterThan",pa,3,[2,2])],normalizeFunc(t,e,...i){const s=ia(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?ha(s[1][0],s[1][1],">",s[0].returnType):sa(t,s)}},greaterThanEqual:{overloads:[...na("greaterThanEqual",pa,3,[0,0]),...na("greaterThanEqual",pa,3,[1,1]),...na("greaterThanEqual",pa,3,[2,2])],normalizeFunc(t,e,...i){const s=ia(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?ha(s[1][0],s[1][1],">=",s[0].returnType):sa(t,s)}},compEqual:{overloads:[...na("equal",pa,3,[0,0]),...na("equal",pa,3,[1,1]),...na("equal",pa,3,[2,2]),...na("equal",pa,3,[3,3])],normalizeFunc(t,e,...i){const s=ia(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?ha(s[1][0],s[1][1],"==",s[0].returnType):sa(t,s)}},compNotEqual:{overloads:[...na("notEqual",pa,3,[0,0]),...na("notEqual",pa,3,[1,1]),...na("notEqual",pa,3,[2,2]),...na("notEqual",pa,3,[3,3])],normalizeFunc(t,e,...i){const s=ia(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?ha(s[1][0],s[1][1],"!=",s[0].returnType):sa(t,s)}},equal:{overloads:[...na("equal",pa,ce,[0,0]),...na("equal",pa,ce,[1,1]),...na("equal",pa,ce,[2,2]),...na("equal",pa,ce,[3,3])],normalizeFunc(t,e,...i){const s=ia(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type&&r.isPrimitiveType()&&!r.isScalarType()?t.all(t.compEqual(i[0],i[1])):ha(s[1][0],s[1][1],"==",s[0].returnType)}},notEqual:{overloads:[...na("notEqual",pa,ce,[0,0]),...na("notEqual",pa,ce,[1,1]),...na("notEqual",pa,ce,[2,2]),...na("notEqual",pa,ce,[3,3])],normalizeFunc(t,e,...i){const s=ia(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type&&r.isPrimitiveType()&&!r.isScalarType()?t.any(t.compNotEqual(i[0],i[1])):ha(s[1][0],s[1][1],"!=",s[0].returnType)}},any:{overloads:na("any",pa,ce,[3],!0)},all:{overloads:na("all",pa,ce,[3],!0)},not:{overloads:na("not",pa,3,[3]),normalizeFunc(t,e,...i){const s=ia(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?oa(s[1][0],"!",s[0].returnType):sa(t,s)}},neg:{overloads:[...na("neg",pa,0,[0]),...na("neg",pa,1,[1])],normalizeFunc(t,e,...i){const s=ia(t,e,...i);return oa(s[1][0],"-",s[0].returnType)}},or_2:{overloads:na("or",pa,ce,[3,3]),normalizeFunc(t,e,...i){const s=ia(t,e,...i);return ha(s[1][0],s[1][1],"||",s[0].returnType)}},or:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Ps("or");let s=i[0];for(let e=1;e<i.length;e++)s=t.or_2(s,i[e]);return s}},compOr:{overloads:[...na("compOr",la|ca,1,[1,1]),...na("compOr",la|ca,2,[2,2])],normalizeFunc(t,e,...i){const s=ia(t,e,...i);return ha(s[1][0],s[1][1],"|",s[0].returnType)}},and_2:{overloads:na("and",pa,ce,[3,3]),normalizeFunc(t,e,...i){const s=ia(t,e,...i);return ha(s[1][0],s[1][1],"&&",s[0].returnType)}},and:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Ps("and");let s=i[0];for(let e=1;e<i.length;e++)s=t.and_2(s,i[e]);return s}},compAnd:{overloads:[...na("compAnd",la|ca,1,[1,1]),...na("compAnd",la|ca,2,[2,2])],normalizeFunc(t,e,...i){const s=ia(t,e,...i);return ha(s[1][0],s[1][1],"&",s[0].returnType)}},compXor:{overloads:[...na("compXor",la|ca,1,[1,1]),...na("compXor",la|ca,2,[2,2])],normalizeFunc(t,e,...i){const s=ia(t,e,...i);return ha(s[1][0],s[1][1],"^",s[0].returnType)}},sal:{overloads:[...na("sal",la|ca,1,[1,2]),...na("sal",la|ca,2,[2,2])],normalizeFunc(t,e,...i){const s=ia(t,e,...i);return ha(s[1][0],s[1][1],"<<",s[0].returnType)}},sar:{overloads:[...na("sar",la|ca,1,[1,2]),...na("sar",la|ca,2,[2,2])],normalizeFunc(t,e,...i){const s=ia(t,e,...i);return ha(s[1][0],s[1][1],">>",s[0].returnType)}},arrayLength:{overloads:[],normalizeFunc(t,e,...i){if(1!==i.length)throw new Ps("arrayLength");if(!(i[0]instanceof Jr))throw new Os("arrayLength","array");const s=i[0].$ast.getType(),r=s.isPointerType()?s.pointerType:s;if(!r.isArrayType()||0!==r.dimension)throw new Bs("arrayLength","array");const a=s.isArrayType()?t.addressOf(i[0]).$ast:i[0].$ast;return t.$callFunctionNoCheck(e,[a],oe)}},select:{overloads:[...na("select",ca,0,[0,0,ce]),...na("select",ca,1,[1,1,ce]),...na("select",ca,2,[2,2,ce]),...na("select",ca,3,[3,3,ce]),...na("select",ca,0,[0,0,3],!0),...na("select",ca,1,[1,1,3],!0),...na("select",ca,2,[2,2,3],!0),...na("select",ca,3,[3,3,3],!0),...na("mix",la,0,[0,0,3]),...na("mix",la,1,[1,1,3]),...na("mix",la,2,[2,2,3])]},floatBitsToInt:{overloads:na("floatBitsToInt",la,1,[0])},floatBitsToUint:{overloads:na("floatBitsToUint",la,2,[0])},intBitsToFloat:{overloads:na("intBitsToFloat",la,0,[1])},uintBitsToFloat:{overloads:na("uintBitsToFloat",la,0,[2])},pack4x8snorm:{overloads:na("pack4x8snorm",ca,oe,[te])},unpack4x8snorm:{overloads:na("unpack4x8snorm",ca,te,[oe])},pack4x8unorm:{overloads:na("pack4x8unorm",ca,oe,[te])},unpack4x8unorm:{overloads:na("unpack4x8unorm",ca,te,[oe])},pack2x16snorm:{overloads:[...na("pack2x16snorm",ca,oe,[Qt]),...na("packSnorm2x16",la,oe,[Qt])]},unpack2x16snorm:{overloads:[...na("unpack2x16snorm",ca,Qt,[oe]),...na("unpackSnorm2x16",la,Qt,[oe])]},pack2x16unorm:{overloads:[...na("pack2x16unorm",ca,oe,[Qt]),...na("packUnorm2x16",la,oe,[Qt])]},unpack2x16unorm:{overloads:[...na("unpack2x16unorm",ca,Qt,[oe]),...na("unpackUnorm2x16",la,Qt,[oe])]},pack2x16float:{overloads:[...na("pack2x16float",ca,oe,[Qt]),...na("packHalf2x16",la,oe,[Qt])]},unpack2x16float:{overloads:[...na("unpack2x16float",ca,Qt,[oe]),...na("unpackHalf2x16",la,Qt,[oe])]},matrixCompMult:{overloads:aa("matrixCompMult",da,null,[null,null])},dpdx:{overloads:[...na("dFdx",da,0,[0]),...na("dpdx",ca,0,[0])]},dpdy:{overloads:[...na("dFdy",da,0,[0]),...na("dpdy",ca,0,[0])]},fwidth:{overloads:na("fwidth",pa,0,[0])},dpdxCoarse:{overloads:[...na("dpdxCoarse",ca,0,[0]),...na("dFdx",da,0,[0])]},dpdxFine:{overloads:[...na("dpdxFine",ca,0,[0]),...na("dFdx",da,0,[0])]},dpdyCoarse:{overloads:[...na("dpdyCoarse",ca,0,[0]),...na("dFdy",da,0,[0])]},dpdyFine:{overloads:[...na("dpdyFine",ca,0,[0]),...na("dFdy",da,0,[0])]},textureDimensions:{overloads:[...na("textureDimensions",ca,oe,[Se,se]),...na("textureDimensions",ca,oe,[we,se]),...na("textureDimensions",ca,oe,[Ce,se]),...na("textureDimensions",ca,he,[Ae,se]),...na("textureDimensions",ca,he,[Re,se]),...na("textureDimensions",ca,he,[Me,se]),...na("textureDimensions",ca,he,[$e,se]),...na("textureDimensions",ca,he,[Ne,se]),...na("textureDimensions",ca,he,[De,se]),...na("textureDimensions",ca,ue,[Ie,se]),...na("textureDimensions",ca,ue,[Le,se]),...na("textureDimensions",ca,ue,[Fe,se]),...na("textureDimensions",ca,he,[Pe,se]),...na("textureDimensions",ca,he,[Be,se]),...na("textureDimensions",ca,he,[Oe,se]),...na("textureDimensions",ca,he,[Ve,se]),...na("textureDimensions",ca,he,[Ge,se]),...na("textureDimensions",ca,he,[ze,se]),...na("textureDimensions",ca,he,[ke]),...na("textureDimensions",ca,he,[Xe]),...na("textureDimensions",ca,he,[We]),...na("textureDimensions",ca,he,[is,se]),...na("textureDimensions",ca,he,[ss,se]),...na("textureDimensions",ca,he,[rs,se]),...na("textureDimensions",ca,he,[as,se]),...na("textureDimensions",ca,he,[ns]),...na("textureDimensions",ca,oe,[He]),...na("textureDimensions",ca,oe,[Ye]),...na("textureDimensions",ca,oe,[qe]),...na("textureDimensions",ca,oe,[je]),...na("textureDimensions",ca,oe,[Ze]),...na("textureDimensions",ca,oe,[Ke]),...na("textureDimensions",ca,oe,[Qe]),...na("textureDimensions",ca,oe,[Je]),...na("textureDimensions",ca,oe,[ti]),...na("textureDimensions",ca,oe,[ei]),...na("textureDimensions",ca,oe,[ii]),...na("textureDimensions",ca,oe,[si]),...na("textureDimensions",ca,oe,[ri]),...na("textureDimensions",ca,oe,[ai]),...na("textureDimensions",ca,oe,[ni]),...na("textureDimensions",ca,oe,[oi]),...na("textureDimensions",ca,he,[hi]),...na("textureDimensions",ca,he,[ui]),...na("textureDimensions",ca,he,[li]),...na("textureDimensions",ca,he,[ci]),...na("textureDimensions",ca,he,[di]),...na("textureDimensions",ca,he,[pi]),...na("textureDimensions",ca,he,[_i]),...na("textureDimensions",ca,he,[mi]),...na("textureDimensions",ca,he,[fi]),...na("textureDimensions",ca,he,[gi]),...na("textureDimensions",ca,he,[xi]),...na("textureDimensions",ca,he,[Ti]),...na("textureDimensions",ca,he,[bi]),...na("textureDimensions",ca,he,[Ei]),...na("textureDimensions",ca,he,[yi]),...na("textureDimensions",ca,he,[vi]),...na("textureDimensions",ca,he,[Si]),...na("textureDimensions",ca,he,[wi]),...na("textureDimensions",ca,he,[Ci]),...na("textureDimensions",ca,he,[Ai]),...na("textureDimensions",ca,he,[Ri]),...na("textureDimensions",ca,he,[Mi]),...na("textureDimensions",ca,he,[$i]),...na("textureDimensions",ca,he,[Ni]),...na("textureDimensions",ca,he,[Di]),...na("textureDimensions",ca,he,[Ii]),...na("textureDimensions",ca,he,[Li]),...na("textureDimensions",ca,he,[Fi]),...na("textureDimensions",ca,he,[Pi]),...na("textureDimensions",ca,he,[Bi]),...na("textureDimensions",ca,he,[Oi]),...na("textureDimensions",ca,he,[Ui]),...na("textureDimensions",ca,ue,[Vi]),...na("textureDimensions",ca,ue,[Gi]),...na("textureDimensions",ca,ue,[zi]),...na("textureDimensions",ca,ue,[ki]),...na("textureDimensions",ca,ue,[Xi]),...na("textureDimensions",ca,ue,[Wi]),...na("textureDimensions",ca,ue,[Hi]),...na("textureDimensions",ca,ue,[Yi]),...na("textureDimensions",ca,ue,[qi]),...na("textureDimensions",ca,ue,[ji]),...na("textureDimensions",ca,ue,[Zi]),...na("textureDimensions",ca,ue,[Ki]),...na("textureDimensions",ca,ue,[Qi]),...na("textureDimensions",ca,ue,[Ji]),...na("textureDimensions",ca,ue,[ts]),...na("textureDimensions",ca,ue,[es]),...na("textureSize",la,re,[Se,se]),...na("textureSize",la,re,[Ae,se]),...na("textureSize",la,re,[we,se]),...na("textureSize",la,re,[Re,se]),...na("textureSize",la,re,[Ce,se]),...na("textureSize",la,re,[Me,se]),...na("textureSize",la,re,[$e,se]),...na("textureSize",la,re,[Ne,se]),...na("textureSize",la,re,[De,se]),...na("textureSize",la,re,[Pe,se]),...na("textureSize",la,re,[Be,se]),...na("textureSize",la,re,[Oe,se]),...na("textureSize",la,ae,[Ie,se]),...na("textureSize",la,ae,[Le,se]),...na("textureSize",la,ae,[Fe,se]),...na("textureSize",la,re,[is,se]),...na("textureSize",la,re,[rs,se]),...na("textureSize",la,re,[ss,se])],normalizeFunc(t,e,...i){if(i.length<1||i.length>2)throw new Ps("textureDimensions");if(!(i[0]instanceof Jr))throw new Os("textureDimensions","tex");const s=i[0].$ast.getType();if(!s.isTextureType())throw new Bs("textureDimensions","tex");if("webgpu"===t.getDevice().type){if((s.isMultisampledTexture()||s.isStorageTexture())&&void 0!==i[1])throw new Os("textureDimensions","level");return ra(t,e,...i)}if("webgl2"===t.getDevice().type){const r=i[0],a=i[1]||0;return s.is1DTexture()?ra(t,e,r,a).x:ra(t,e,r,a)}}},textureGather:{overloads:[...na("textureGather",ca,te,[se,Ae,os,Qt]),...na("textureGather",ca,ne,[se,Re,os,Qt]),...na("textureGather",ca,le,[se,Me,os,Qt]),...na("textureGather",ca,te,[se,Pe,os,Jt]),...na("textureGather",ca,ne,[se,Be,os,Jt]),...na("textureGather",ca,le,[se,Oe,os,Jt]),...na("textureGather",ca,te,[is,os,Qt]),...na("textureGather",ca,te,[rs,os,Jt])]},textureArrayGather:{overloads:[...na("textureGather",ca,te,[se,$e,os,Qt,se]),...na("textureGather",ca,ne,[se,Ne,os,Qt,se]),...na("textureGather",ca,le,[se,De,os,Qt,se]),...na("textureGather",ca,te,[se,Ve,os,Jt,se]),...na("textureGather",ca,ne,[se,Ge,os,Jt,se]),...na("textureGather",ca,le,[se,ze,os,Jt,se]),...na("textureGather",ca,te,[ss,os,Qt,se]),...na("textureGather",ca,te,[as,os,Jt,se])]},textureGatherCompare:{overloads:[...na("textureGatherCompare",ca,te,[is,hs,Qt,Kt]),...na("textureGatherCompare",ca,te,[rs,hs,Jt,Kt])]},textureArrayGatherCompare:{overloads:[...na("textureGatherCompare",ca,te,[ss,hs,Qt,se,Kt]),...na("textureGatherCompare",ca,te,[as,hs,Jt,se,Kt])]},textureLoad:{overloads:[...na("textureLoad",ca,te,[Se,se,se]),...na("textureLoad",ca,ne,[we,se,se]),...na("textureLoad",ca,le,[Ce,se,se]),...na("textureLoad",ca,te,[Ae,re,se]),...na("textureLoad",ca,ne,[Re,re,se]),...na("textureLoad",ca,le,[Me,re,se]),...na("textureLoad",ca,te,[Ie,ae,se]),...na("textureLoad",ca,ne,[Le,ae,se]),...na("textureLoad",ca,le,[Fe,ae,se]),...na("textureLoad",ca,te,[ke,re,se]),...na("textureLoad",ca,ne,[Xe,re,se]),...na("textureLoad",ca,le,[We,re,se]),...na("textureLoad",ca,te,[Ue,re]),...na("textureLoad",ca,Kt,[is,re,se]),...na("textureLoad",ca,Kt,[ns,re,se]),...na("texelFetch",la,te,[Se,re,se]),...na("texelFetch",la,te,[Ae,re,se]),...na("texelFetch",la,te,[Ie,ae,se]),...na("texelFetch",la,le,[Ue,re,se]),...na("texelFetch",la,te,[we,re,se]),...na("texelFetch",la,ne,[Re,re,se]),...na("texelFetch",la,ne,[Le,ae,se]),...na("texelFetch",la,te,[Ce,re,se]),...na("texelFetch",la,le,[Me,re,se]),...na("texelFetch",la,le,[Fe,ae,se])],normalizeFunc(t,e,...i){if(0===i.length)throw new Ps("textureLoad");if(!(i[0]instanceof Jr))throw new Os("textureLoad","tex");const s=i[0].$ast.getType();if(!s.isTextureType())throw new Bs("textureLoad","tex");if("webgl2"===t.getDevice().type){if(3!==i.length)throw new Ps("textureLoad");if(s.is1DTexture()){if("number"==typeof i[1]){if(!Number.isInteger(i[1]))throw new Bs("textureLoad","coord")}else{if(!(i[1]instanceof Jr))throw new Bs("textureLoad","coord");{const t=i[1].$ast.getType();if(!t.isPrimitiveType()||!t.isScalarType()||t.scalarType!==At.I32)throw new Bs("textureLoad","coord")}}i[1]=t.ivec2(i[1],0)}}else"webgpu"===t.getDevice().type&&s.isExternalTexture()&&(i=i.slice(0,2));return ra(t,e,...i)}},textureArrayLoad:{overloads:[...na("textureLoad",ca,te,[$e,re,se,se]),...na("textureLoad",ca,ne,[Ne,re,se,se]),...na("textureLoad",ca,le,[De,re,se,se]),...na("textureLoad",ca,Kt,[ss,re,se,se]),...na("texelFetch",la,te,[$e,ae,se]),...na("texelFetch",la,ne,[Ne,ae,se]),...na("texelFetch",la,le,[De,ae,se])],normalizeFunc(t,e,...i){if("webgl2"===t.getDevice().type){if(4!==i.length)throw new Ps("textureArrayLoad");const s=i[0],r=t.ivec3(i[1],i[2]);return ra(t,e,s,r,i[3])}return ra(t,e,...i)}},textureStore:{overloads:[...na("textureStore",ca,us,[He,oe,te]),...na("textureStore",ca,us,[Ye,oe,te]),...na("textureStore",ca,us,[qe,oe,le]),...na("textureStore",ca,us,[je,oe,ne]),...na("textureStore",ca,us,[Ze,oe,le]),...na("textureStore",ca,us,[Ke,oe,ne]),...na("textureStore",ca,us,[Qe,oe,te]),...na("textureStore",ca,us,[Je,oe,le]),...na("textureStore",ca,us,[ti,oe,ne]),...na("textureStore",ca,us,[ei,oe,te]),...na("textureStore",ca,us,[ii,oe,le]),...na("textureStore",ca,us,[si,oe,ne]),...na("textureStore",ca,us,[ri,oe,te]),...na("textureStore",ca,us,[ai,oe,le]),...na("textureStore",ca,us,[ni,oe,ne]),...na("textureStore",ca,us,[oi,oe,te]),...na("textureStore",ca,us,[hi,he,te]),...na("textureStore",ca,us,[ui,he,te]),...na("textureStore",ca,us,[li,he,le]),...na("textureStore",ca,us,[ci,he,ne]),...na("textureStore",ca,us,[di,he,le]),...na("textureStore",ca,us,[pi,he,ne]),...na("textureStore",ca,us,[_i,he,te]),...na("textureStore",ca,us,[mi,he,le]),...na("textureStore",ca,us,[fi,he,ne]),...na("textureStore",ca,us,[gi,he,te]),...na("textureStore",ca,us,[xi,he,le]),...na("textureStore",ca,us,[Ti,he,ne]),...na("textureStore",ca,us,[bi,he,te]),...na("textureStore",ca,us,[Ei,he,le]),...na("textureStore",ca,us,[yi,he,ne]),...na("textureStore",ca,us,[vi,he,te]),...na("textureStore",ca,us,[Vi,ue,te]),...na("textureStore",ca,us,[Gi,ue,te]),...na("textureStore",ca,us,[zi,ue,le]),...na("textureStore",ca,us,[ki,ue,ne]),...na("textureStore",ca,us,[Xi,ue,le]),...na("textureStore",ca,us,[Wi,ue,ne]),...na("textureStore",ca,us,[Hi,ue,te]),...na("textureStore",ca,us,[Yi,ue,le]),...na("textureStore",ca,us,[qi,ue,ne]),...na("textureStore",ca,us,[ji,ue,te]),...na("textureStore",ca,us,[Zi,ue,le]),...na("textureStore",ca,us,[Ki,ue,ne]),...na("textureStore",ca,us,[Qi,ue,te]),...na("textureStore",ca,us,[Ji,ue,le]),...na("textureStore",ca,us,[ts,ue,ne]),...na("textureStore",ca,us,[es,ue,te])]},textureArrayStore:{overloads:[...na("textureStore",ca,us,[Si,re,se,te]),...na("textureStore",ca,us,[wi,re,se,te]),...na("textureStore",ca,us,[Ci,re,se,le]),...na("textureStore",ca,us,[Ai,re,se,ne]),...na("textureStore",ca,us,[Ri,re,se,le]),...na("textureStore",ca,us,[Mi,re,se,ne]),...na("textureStore",ca,us,[$i,re,se,te]),...na("textureStore",ca,us,[Ni,re,se,le]),...na("textureStore",ca,us,[Di,re,se,ne]),...na("textureStore",ca,us,[Ii,re,se,te]),...na("textureStore",ca,us,[Li,re,se,le]),...na("textureStore",ca,us,[Fi,re,se,ne]),...na("textureStore",ca,us,[Pi,re,se,te]),...na("textureStore",ca,us,[Bi,re,se,le]),...na("textureStore",ca,us,[Oi,re,se,ne]),...na("textureStore",ca,us,[Ui,re,se,te])]},textureNumLayers:{overloads:[...na("textureNumLayers",ca,se,[$e]),...na("textureNumLayers",ca,se,[Ne]),...na("textureNumLayers",ca,se,[De]),...na("textureNumLayers",ca,se,[Ve]),...na("textureNumLayers",ca,se,[Ge]),...na("textureNumLayers",ca,se,[ze]),...na("textureNumLayers",ca,se,[ss]),...na("textureNumLayers",ca,se,[as]),...na("textureNumLayers",ca,se,[Ui]),...na("textureNumLayers",ca,se,[Oi]),...na("textureNumLayers",ca,se,[Bi]),...na("textureNumLayers",ca,se,[Pi]),...na("textureNumLayers",ca,se,[Fi]),...na("textureNumLayers",ca,se,[Li]),...na("textureNumLayers",ca,se,[$i]),...na("textureNumLayers",ca,se,[Mi]),...na("textureNumLayers",ca,se,[Ri]),...na("textureNumLayers",ca,se,[Ii]),...na("textureNumLayers",ca,se,[Di]),...na("textureNumLayers",ca,se,[Ni]),...na("textureNumLayers",ca,se,[Ai]),...na("textureNumLayers",ca,se,[wi]),...na("textureNumLayers",ca,se,[Ci]),...na("textureNumLayers",ca,se,[Si])]},textureNumLevels:{overloads:[...na("textureNumLevels",ca,se,[Se]),...na("textureNumLevels",ca,se,[we]),...na("textureNumLevels",ca,se,[Ce]),...na("textureNumLevels",ca,se,[Ae]),...na("textureNumLevels",ca,se,[Re]),...na("textureNumLevels",ca,se,[Me]),...na("textureNumLevels",ca,se,[$e]),...na("textureNumLevels",ca,se,[Ne]),...na("textureNumLevels",ca,se,[De]),...na("textureNumLevels",ca,se,[Ie]),...na("textureNumLevels",ca,se,[Le]),...na("textureNumLevels",ca,se,[Fe]),...na("textureNumLevels",ca,se,[Pe]),...na("textureNumLevels",ca,se,[Be]),...na("textureNumLevels",ca,se,[Oe]),...na("textureNumLevels",ca,se,[Ve]),...na("textureNumLevels",ca,se,[Ge]),...na("textureNumLevels",ca,se,[ze]),...na("textureNumLevels",ca,se,[is]),...na("textureNumLevels",ca,se,[ss]),...na("textureNumLevels",ca,se,[rs]),...na("textureNumLevels",ca,se,[as])]},textureNumSamples:{overloads:[...na("textureNumSamples",ca,se,[ke]),...na("textureNumSamples",ca,se,[Xe]),...na("textureNumSamples",ca,se,[We]),...na("textureNumSamples",ca,se,[ns])]},textureSample:{overloads:[...na("textureSample",ca,te,[Se,os,Kt]),...na("textureSample",ca,te,[Ae,os,Qt]),...na("textureSample",ca,te,[Ie,os,Jt]),...na("textureSample",ca,te,[Pe,os,Jt]),...na("textureSample",ca,Kt,[is,os,Qt]),...na("textureSample",ca,Kt,[rs,os,Jt]),...na("textureSampleBaseClampToEdge",ca,te,[Ue,os,Qt]),...na("texture",la,te,[Se,Qt]),...na("texture",la,te,[Ae,Qt]),...na("texture",la,te,[Ue,Qt]),...na("texture",la,te,[is,Qt]),...na("texture",la,te,[Ie,Jt]),...na("texture",la,te,[Pe,Jt]),...na("texture",la,te,[rs,Jt]),...na("texture2D",ua,te,[Se,Qt]),...na("texture2D",ua,te,[Ae,Qt]),...na("texture2D",ua,te,[Ue,Qt]),...na("texture2D",ua,te,[is,Qt]),...na("textureCube",ua,te,[Pe,Jt]),...na("textureCube",ua,te,[rs,Jt])],normalizeFunc(t,e,...i){if(2!==i.length)throw new Ps("textureSample");const s=i[0];if(!(s instanceof Jr))throw new Bs("textureSample","texture");const r=s.$ast.getType();if(!r.isTextureType())throw new Bs("textureSample","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1),a=ra(t,e,s,r,i[1]);return a.$ast.getType().isCompatibleType(Kt)?t.vec4(a):a}if(t.getDefaultSampler(s,!1),r.is1DTexture()){if(i[1]instanceof Jr){const t=i[1].$ast.getType();if(!t.isPrimitiveType()||!t.isScalarType()||t.scalarType!==At.F32)throw new Bs("textureSample","coord")}else if("number"!=typeof i[1])throw new Bs("textureSample","coord");i[1]=t.vec2(i[1],0)}return ra(t,e,...i)}},textureArraySample:{overloads:[...na("textureSample",ca,te,[$e,os,Qt,se]),...na("textureSample",ca,te,[Ve,os,Jt,se]),...na("textureSample",ca,Kt,[ss,os,Qt,se]),...na("textureSample",ca,Kt,[as,os,Jt,se]),...na("texture",la,te,[$e,Jt]),...na("texture",la,te,[ss,Jt])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Ps("textureArraySample");const s=i[0];if(!(s instanceof Jr))throw new Bs("textureArraySample","texture");if(!s.$ast.getType().isTextureType())throw new Bs("textureArraySample","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1),a=ra(t,e,s,r,i[1],i[2]);return a.$ast.getType().isCompatibleType(Kt)?t.vec4(a):a}{t.getDefaultSampler(s,!1);const r=i[1],a=i[2],n=t.vec3(r,t.float(a));return ra(t,e,s,n)}}},textureSampleBias:{overloads:[...na("textureSampleBias",ca,te,[Ae,os,Qt,Kt]),...na("textureSampleBias",ca,te,[Ie,os,Jt,Kt]),...na("textureSampleBias",ca,te,[Pe,os,Jt,Kt]),...na("texture",la,te,[Ae,Qt,Kt]),...na("texture",la,te,[Ie,Jt,Kt]),...na("texture",la,te,[Pe,Jt,Kt]),...na("texture2D",ua,te,[Ae,Qt,Kt]),...na("textureCube",ua,te,[Pe,Jt,Kt])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Ps("textureSampleBias");const s=i[0];if(!(s instanceof Jr))throw new Bs("textureSampleBias","texture");if(!s.$ast.getType().isTextureType())throw new Bs("textureSampleBias","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return ra(t,e,s,r,i[1],i[2])}return t.getDefaultSampler(s,!1),ra(t,e,...i)}},textureArraySampleBias:{overloads:[...na("textureSampleBias",ca,te,[$e,os,Qt,se,Kt]),...na("textureSampleBias",ca,te,[Ve,os,Jt,se,Kt]),...na("texture",la,te,[$e,Jt,Kt])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Ps("textureArraySampleBias");const s=i[0];if(!(s instanceof Jr))throw new Bs("textureArraySampleBias","texture");if(!s.$ast.getType().isTextureType())throw new Bs("textureArraySampleBias","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return ra(t,e,s,r,i[1],i[2],i[3])}if("webgl2"===t.getDevice().type){t.getDefaultSampler(s,!1);const r=i[1],a=i[2],n=t.vec3(r,t.float(a));return ra(t,e,s,n,i[3])}}},textureSampleCompare:{overloads:[...na("textureSampleCompare",ca,Kt,[is,hs,Qt,Kt]),...na("textureSampleCompare",ca,Kt,[rs,hs,Jt,Kt]),...na("texture",la,Kt,[is,Jt]),...na("texture",la,Kt,[rs,te])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Ps("textureSampleCompare");const s=i[0];if(!(s instanceof Jr))throw new Bs("textureSampleCompare","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Bs("textureSampleCompare","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(i[0],!0);return ra(t,e,s,r,i[1],i[2])}{let a;return t.getDefaultSampler(i[0],!0),a=r.isCubeTexture()||r.isArrayTexture()?t.vec4(i[1],i[2]):t.vec3(i[1],i[2]),ra(t,e,s,a)}}},textureArraySampleCompare:{overloads:[...na("textureSampleCompare",ca,Kt,[ss,hs,Qt,se,Kt]),...na("textureSampleCompare",ca,Kt,[as,hs,Jt,se,Kt]),...na("texture",la,Kt,[ss,te])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Ps("textureArraySampleCompare");const s=i[0];if(!(s instanceof Jr))throw new Bs("textureArraySampleCompare","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Bs("textureArraySampleCompare","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(i[0],!0);return ra(t,e,s,r,i[1],i[2],i[3])}{t.getDefaultSampler(i[0],!0);const r=t.vec4(i[1],t.float(i[2]),i[3]);return ra(t,e,s,r)}}},textureSampleLevel:{overloads:[...na("textureSampleLevel",ca,te,[Ae,os,Qt,Kt]),...na("textureSampleLevel",ca,te,[Ie,os,Jt,Kt]),...na("textureSampleLevel",ca,te,[Pe,os,Jt,Kt]),...na("textureSampleLevel",ca,te,[Ue,os,Qt]),...na("textureSampleLevel",ca,Kt,[is,os,Qt,se]),...na("textureSampleLevel",ca,Kt,[rs,os,Jt,se]),...na("textureLod",la,te,[Ae,Qt,Kt]),...na("textureLod",la,te,[is,Qt,Kt]),...na("textureLod",la,te,[Ue,Qt,Kt]),...na("textureLod",la,te,[Ie,Jt,Kt]),...na("textureLod",la,te,[Pe,Jt,Kt]),...na("textureLod",la,te,[rs,Jt,Kt]),...na("texture2DLodEXT",ua,te,[Ae,Qt,Kt]),...na("texture2DLodEXT",ua,te,[is,Qt,Kt]),...na("texture2DLodEXT",ua,te,[Ue,Qt,Kt]),...na("textureCubeLodEXT",ua,te,[Pe,Jt,Kt]),...na("textureCubeLodEXT",ua,te,[rs,Jt,Kt])],normalizeFunc(t,e,...i){const s=i[0];if(!(s instanceof Jr))throw new Bs("textureSampleLevel","texture");const r=s.$ast.getType();if(!r.isTextureType())throw new Bs("textureSampleLevel","texture");if("webgpu"===t.getDevice().type){if(r.isExternalTexture())return t.textureLoad(s,t.ivec2(i[1]),0);{const a=t.getDefaultSampler(s,!1),n=r.isDepthTexture()&&("number"==typeof i[2]||i[2]instanceof Jr&&i[2].$ast.getType().isCompatibleType(Kt))?t.int(i[2]):i[2],o=r.isExternalTexture()?ra(t,e,s,a,i[1]):ra(t,e,s,a,i[1],n);return o.$ast.getType().isCompatibleType(Kt)?t.vec4(o):o}}return t.getDefaultSampler(s,!1),r.isExternalTexture()?ra(t,e,i[0],i[1],0):ra(t,e,i[0],i[1],i[2])}},textureArraySampleLevel:{overloads:[...na("textureSampleLevel",ca,te,[$e,os,Qt,se,Kt]),...na("textureSampleLevel",ca,te,[Ve,os,Jt,se,Kt]),...na("textureSampleLevel",ca,Kt,[ss,os,Qt,se,se]),...na("textureSampleLevel",ca,Kt,[as,os,Jt,se,se]),...na("textureLod",la,te,[$e,Jt,Kt])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Ps("textureArraySampleLevel");const s=i[0];if(!(s instanceof Jr))throw new Bs("textureArraySampleLevel","texture");const r=s.$ast.getType();if(!r.isTextureType())throw new Bs("textureArraySampleLevel","texture");if("webgpu"===t.getDevice().type){const a=t.getDefaultSampler(s,!1),n=r.isDepthTexture()&&("number"==typeof i[3]||i[3]instanceof Jr&&i[3].$ast.getType().isCompatibleType(Kt))?t.int(i[3]):i[3],o=ra(t,e,s,a,i[1],i[2],n);return o.$ast.getType().isCompatibleType(Kt)?t.vec4(o):o}{t.getDefaultSampler(s,!1);const r=t.vec3(i[1],t.float(i[2]));return ra(t,e,s,r,i[3])}}},textureSampleCompareLevel:{overloads:[...na("textureSampleCompareLevel",ca,Kt,[is,hs,Qt,Kt]),...na("textureSampleCompareLevel",ca,Kt,[rs,hs,Jt,Kt]),...na("textureLod",la,Kt,[is,Jt,Kt]),...na("texture",la,Kt,[rs,te])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Ps("textureSampleCompareLevel");const s=i[0];if(!(s instanceof Jr))throw new Bs("textureSampleCompareLevel","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Bs("textureSampleCompareLevel","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!0);return ra(t,e,s,r,i[1],i[2])}{let a;return t.getDefaultSampler(i[0],!0),a=r.isCubeTexture()||r.isArrayTexture()?t.vec4(i[1],i[2]):t.vec3(i[1],i[2]),r.isCubeTexture()?ra(t,e,s,a):ra(t,e,s,a,0)}}},textureArraySampleCompareLevel:{overloads:[...na("textureSampleCompareLevel",ca,Kt,[ss,hs,Qt,se,Kt]),...na("textureSampleCompareLevel",ca,Kt,[as,hs,Jt,se,Kt]),...na("texture",la,Kt,[ss,te])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Ps("textureArraySampleCompareLevel");const s=i[0];if(!(s instanceof Jr))throw new Bs("textureArraySampleCompareLevel","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Bs("textureArraySampleCompareLevel","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!0);return ra(t,e,s,r,i[1],i[2],i[3])}{t.getDefaultSampler(i[0],!0);const r=t.vec4(i[1],t.float(i[2]),i[3]);return ra(t,e,s,r)}}},textureSampleGrad:{overloads:[...na("textureSampleGrad",ca,te,[Ae,os,Qt,Qt,Qt]),...na("textureSampleGrad",ca,te,[Ie,os,Jt,Jt,Jt]),...na("textureSampleGrad",ca,te,[Pe,os,Jt,Jt,Jt]),...na("textureGrad",la,te,[Ae,Qt,Qt,Qt]),...na("textureGrad",la,te,[Ie,Jt,Jt,Jt]),...na("textureGrad",la,te,[Pe,Jt,Jt,Jt]),...na("texture2DGradEXT",ua,te,[Ae,Qt,Qt,Qt]),...na("textureCubeGradEXT",ua,te,[Pe,Jt,Jt,Jt])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Ps("textureSampleGrad");const s=i[0];if(!(s instanceof Jr))throw new Bs("textureSampleGrad","texture");if(!s.$ast.getType().isTextureType())throw new Bs("textureSampleGrad","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return ra(t,e,s,r,i[1],i[2],i[3])}return t.getDefaultSampler(s,!1),ra(t,e,...i)}},textureArraySampleGrad:{overloads:[...na("textureSampleGrad",ca,te,[$e,os,Qt,se,Qt,Qt]),...na("textureSampleGrad",ca,te,[Ve,os,Jt,se,Jt,Jt]),...na("textureGrad",la,te,[$e,Jt,Qt,Qt])],normalizeFunc(t,e,...i){if(5!==i.length)throw new Ps("textureArraySampleGrad");const s=i[0];if(!(s instanceof Jr))throw new Bs("textureArraySampleGrad","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isArrayTexture())throw new Bs("textureArraySampleGrad","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return ra(t,e,s,r,i[1],i[2],i[3],i[4])}{t.getDefaultSampler(s,!1);const r=t.vec3(i[1],t.float(i[2]));return ra(t,e,s,r,i[3],i[4])}}},storageBarrier:{overloads:na("storageBarrier",ca,us,[])},workgroupBarrier:{overloads:na("workgroupBarrier",ca,us,[])},atomicLoad:{overloades:[],normalizeFunc(t,e,...i){if(1!==i.length)throw new Ps(e);const s=i[0];if(!(s instanceof Jr))throw new Bs(e,"ptr");if(s.$ast.getType().typeId===ee.typeId)return t.$callFunctionNoCheck(e,[new Sr(s.$ast)],se);if(s.$ast.getType().typeId===ie.typeId)return t.$callFunctionNoCheck(e,[new Sr(s.$ast)],oe);throw new Os(e,"ptr must be atomic type")}},atomicStore:{overloades:[],normalizeFunc(t,e,...i){if(2!==i.length)throw new Ps(e);const s=i[0],r=i[1];if(!(s instanceof Jr))throw new Bs(e,"ptr");if(s.$ast.getType().typeId===ee.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Os(e,"value");return t.$callFunctionNoCheck(e,[new Sr(s.$ast),new Er(r,se)],us)}if(r instanceof Jr){if(r.$ast.getType().typeId!==se.typeId)throw new Bs(e,"value");return t.$callFunctionNoCheck(e,[new Sr(s.$ast),r.$ast],us)}throw new Bs(e,"value")}if(s.$ast.getType().typeId===ie.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Os(e,"value");return t.$callFunctionNoCheck(e,[new Sr(s.$ast),new Er(r,oe)],us)}if(r instanceof Jr){if(r.$ast.getType().typeId!==oe.typeId)throw new Bs(e,"value");return t.$callFunctionNoCheck(e,[new Sr(s.$ast),r.$ast],us)}throw new Bs(e,"value")}throw new Os(e,"ptr must be atomic type")}}};for(const t of["atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor"])_a[t]={overloades:[],normalizeFunc(t,e,...i){if(2!==i.length)throw new Ps(e);const s=i[0],r=i[1];if(!(s instanceof Jr))throw new Bs(e,"ptr");if(s.$ast.getType().typeId===ee.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Os(e,"value");return t.$callFunctionNoCheck(e,[new Sr(s.$ast),new Er(r,se)],se)}if(r instanceof Jr){if(r.$ast.getType().typeId!==se.typeId)throw new Bs(e,"value");return t.$callFunctionNoCheck(e,[new Sr(s.$ast),r.$ast],se)}throw new Bs(e,"value")}if(s.$ast.getType().typeId===ie.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Os(e,"value");return t.$callFunctionNoCheck(e,[new Sr(s.$ast),new Er(r,oe)],oe)}if(r instanceof Jr){if(r.$ast.getType().typeId!==oe.typeId)throw new Bs(e,"value");return t.$callFunctionNoCheck(e,[new Sr(s.$ast),r.$ast],oe)}throw new Bs(e,"value")}throw new Os(e,"ptr must be atomic type")}};const ma={rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",rgba8uint:"rgba8ui",rgba8sint:"rgba8i",rgba16uint:"rgba16ui",rgba16sint:"rgba16i",rgba16float:"rgba16f",r32float:"r32f",r32uint:"r32ui",r32sint:"r32i",rg32float:"rg32f",rg32uint:"rg32ui",rg32sint:"rg32i",rgba32float:"rgba32f",rgba32uint:"rgba32ui",rgba32sint:"rgba32i"};function fa(t,...e){if("webgl"===this.getDevice().type){if(t.scalarType===At.U32)throw new zs("unsigned integer type");if(t.isMatrixType()&&t.cols!==t.rows)throw new zs("non-square matrix type")}if(1===e.length&&"string"==typeof e[0])return new Jr(e[0],t);{const i=new Jr("",t);return!t.isScalarType()||1!==e.length||"number"!=typeof e[0]&&"boolean"!=typeof e[0]?i.$ast=new br(i.$typeinfo,e.map((t=>{if("string"==typeof t)throw new Bs("vec_n");return t instanceof Jr?t.$ast:t}))):i.$ast=new Er(e[0],t),i}}const ga={float:Kt,int:se,uint:oe,bool:ce,vec2:Qt,ivec2:re,uvec2:he,bvec2:de,vec3:Jt,ivec3:ae,uvec3:ue,bvec3:pe,vec4:te,ivec4:ne,uvec4:le,bvec4:_e,mat2:me,mat2x3:fe,mat2x4:ge,mat3x2:xe,mat3:Te,mat3x4:be,mat4x2:Ee,mat4x3:ye,mat4:ve},xa={tex1D:Se,tex2D:Ae,tex3D:Ie,texCube:Pe,tex2DShadow:is,texCubeShadow:rs,tex2DArray:$e,tex2DArrayShadow:ss,texExternal:Ue,itex1D:we,itex2D:Re,itex3D:Le,itexCube:Be,itex2DArray:Ne,utex1D:Ce,utex2D:Me,utex3D:Fe,utexCube:Oe,utex2DArray:De,sampler:os,samplerComparison:hs};const Ta={texStorage1D:Ft.TEX_STORAGE_1D,texStorage2D:Ft.TEX_STORAGE_2D,texStorage2DArray:Ft.TEX_STORAGE_2D_ARRAY,texStorage3D:Ft.TEX_STORAGE_3D};class ba{_device;_workgroupSize;_scopeStack=[];_shaderType=_t.Vertex|_t.Fragment|_t.Compute;_structInfo;_uniforms;_globalScope;_builtinScope;_inputScope;_outputScope;_inputs;_outputs;_vertexAttributes;_depthRangeCorrection;_emulateDepthClamp;_lastError;_reflection;_autoStructureTypeIndex;_nameMap;constructor(t){this._device=t,this._workgroupSize=null,this._structInfo={},this._uniforms=[],this._scopeStack=[],this._globalScope=null,this._builtinScope=null,this._inputScope=null,this._outputScope=null,this._inputs=[],this._outputs=[],this._vertexAttributes=[],this._depthRangeCorrection="webgpu"===t.type,this._emulateDepthClamp=!1,this._lastError=null,this._reflection=new Wr(this),this._autoStructureTypeIndex=0,this._nameMap=[]}get lastError(){return this._lastError}get shaderType(){return this._shaderType}get shaderKind(){return this._shaderType===_t.Vertex?"vertex":this._shaderType===_t.Fragment?"fragment":this._shaderType===_t.Compute?"compute":null}getGlobalScope(){return this._globalScope}get builtinScope(){return this._builtinScope}get inputScope(){return this._inputScope}get outputScope(){return this._outputScope}get depthRangeCorrection(){return this._depthRangeCorrection}get emulateDepthClamp(){return this._emulateDepthClamp}set emulateDepthClamp(t){this._emulateDepthClamp=t}getReflection(){return this._reflection}getDevice(){return this._device}reset(){this._workgroupSize=null,this._structInfo={},this._uniforms=[],this._scopeStack=[],this._globalScope=null,this._builtinScope=null,this._inputScope=null,this._outputScope=null,this._inputs=[],this._outputs=[],this._vertexAttributes=[],this._depthRangeCorrection="webgpu"===this._device.type,this._reflection=new Wr(this),this._autoStructureTypeIndex=0,this._nameMap=[]}queryGlobal(t){return this.getReflection().tag(t)}pushScope(t){this._scopeStack.unshift(t)}popScope(){return this._scopeStack.shift()}getCurrentScope(){return this._scopeStack[0]}buildRender(t){qr(this),this._lastError=null,this.defineInternalStructs();const e=this.buildRenderSource(t);return qr(null),this.reset(),e}buildCompute(t){qr(this),this._lastError=null,this._workgroupSize=t.workgroupSize,this.defineInternalStructs();const e=this.buildComputeSource(t);return qr(null),this.reset(),e}buildRenderProgram(t){const e=this.buildRender(t);return e?this._device.createGPUProgram({type:"render",label:t.label,params:{vs:e[0],fs:e[1],bindGroupLayouts:e[2],vertexAttributes:e[3]}}):null}buildComputeProgram(t){const e=this.buildCompute(t);return e?this._device.createGPUProgram({type:"compute",params:{source:e[0],bindGroupLayouts:e[1]}}):null}func(t,e,i){this.getGlobalScope().$createFunctionIfNotExists(t,e,i)}main(t){this.getGlobalScope().$mainFunc(t)}addressOf(t){if("webgpu"!==this._device.type)throw new zs("pointer shader type");if(!t.$ast.isReference())throw new Vs(t);const e=new Jr("",t.$ast.getType());return e.$ast=new Sr(t.$ast),e}referenceOf(t){if("webgpu"!==this._device.type)throw new zs("pointer shader type");if(!t.$ast.getType().isPointerType())throw new Gs(t);const e=new wr(t.$ast),i=new Jr("",e.getType());return i.$ast=e,i}struct(t,e){let i=null;for(const e of[_t.Vertex,_t.Fragment,_t.Compute])if(e&this._shaderType){const s=this._structInfo[e];if(i=s?.structs[t],i)break}if(!i)throw new Os("struct","structName",`Struct type ${t} not exists`);return i.call(this,e)}isIdenticalStruct(t,e,i){if(i&&t.structName&&e.structName&&t.structName!==e.structName)return!1;if(t.structMembers.length!==e.structMembers.length)return!1;for(let i=0;i<t.structMembers.length;i++){const s=t.structMembers[i],r=e.structMembers[i];if(s.name!==r.name)return!1;if(s.type.isStructType()){if(!r.type.isStructType())return!1;if(!this.isIdenticalStruct(s.type,r.type,!0))return!1}else if(!s.type.isCompatibleType(r.type))return!1}return!0}generateStructureName(){return"uu_GeneratedStruct"+this._autoStructureTypeIndex++}getVertexAttributes(){return this._vertexAttributes}defineHiddenStruct(t){for(const e of[_t.Vertex,_t.Fragment,_t.Compute]){let i=this._structInfo[e];if(i||(i={structs:{},types:[]},this._structInfo[e]=i),i.structs[t.structName])throw new Os("defineStruct","structName",`cannot re-define struct '${t.structName}'`);i.types.push(new kr(t,!0))}}defineStruct(t,e){const i="default",s=new Wt(e??"",i,t.map((t=>{if(!(t.$typeinfo.isPrimitiveType()||t.$typeinfo.isArrayType()||t.$typeinfo.isStructType()||t.$typeinfo.isAtomicI32()||t.$typeinfo.isAtomicU32()))throw new Error(`invalid struct member type: '${t.$str}'`);return{name:t.$str,type:t.$typeinfo}})));for(const t of[_t.Vertex,_t.Fragment,_t.Compute]){let e=null,r=null;const a=this._structInfo[t];if(a){if(jr().shaderType===t&&a.structs[s.structName])throw new Os("defineStruct","structName",`cannot re-define struct '${s.structName}'`);for(const t of a.types)if(!t.builtin&&this.isIdenticalStruct(t.getType(),s,!1)){e=t,r=a.structs[t.getType().structName];break}}if(e){if(e.type.layout!==i)throw new Error(`Can not redefine struct ${e.type.structName} with different layout`);return t!==jr().shaderType&&(this._structInfo[jr().shaderType]||(this._structInfo[jr().shaderType]={structs:{},types:[]}),this._structInfo[jr().shaderType].types.indexOf(e)<0&&(this._structInfo[jr().shaderType].types.push(e),this._structInfo[jr().shaderType].structs[e.getType().structName]=r)),r}}return this.internalDefineStruct(e??this.generateStructureName(),i,this._shaderType,!1,...t)}defineStructByType(t){const e=t.extends(t.structName||this.generateStructureName(),[]);for(const t of[_t.Vertex,_t.Fragment,_t.Compute]){let i=null,s=null;const r=this._structInfo[t];if(r){if(jr().shaderType===t&&r.structs[e.structName])throw new Os("defineStruct","structName",`cannot re-define struct '${e.structName}'`);for(const t of r.types)if(!t.builtin&&this.isIdenticalStruct(t.getType(),e,!1)){i=t,s=r.structs[t.getType().structName];break}}if(i){if(i.type.layout!==e.layout)throw new Error(`Can not redefine struct ${i.type.structName} with different layout`);return t!==jr().shaderType&&(this._structInfo[jr().shaderType]||(this._structInfo[jr().shaderType]={structs:{},types:[]}),this._structInfo[jr().shaderType].types.push(i),this._structInfo[jr().shaderType].structs[i.getType().structName]=s),s}}return this.internalDefineStructByType(this._shaderType,!1,e)}internalDefineStruct(t,e,i,s,...r){const a=new Wt(t,e,r.map((t=>{if(!(t.$typeinfo.isPrimitiveType()||t.$typeinfo.isArrayType()||t.$typeinfo.isStructType()||t.$typeinfo.isAtomicI32()||t.$typeinfo.isAtomicU32()))throw new Error(`invalid struct member type: '${t.$str}'`);return{name:t.$str,type:t.$typeinfo}})));return this.internalDefineStructByType(i,s,a)}internalDefineStructByType(t,e,i){const s=Zr((function(...t){let e;return 1===t.length&&"string"==typeof t[0]?e=new Jr(t[0],i):(e=new Jr("",i),e.$ast=new br(e.$typeinfo,t.map((t=>t instanceof Jr?t.$ast:t)))),e}),i);for(const r of[_t.Vertex,_t.Fragment,_t.Compute])if(t&r){let t=this._structInfo[r];if(t||(t={structs:{},types:[]},this._structInfo[r]=t),t.structs[i.structName])throw new Os("defineStruct","structName",`cannot re-define struct '${i.structName}'`);t.types.push(new kr(i,e)),t.structs[i.structName]=s}return s}getFunction(t){return this._globalScope?this._globalScope.$getFunctions(t):null}get structInfo(){return this._structInfo[this._shaderType]}getBlockName(t){return`ch_block_name_${t}`}defineBuiltinStruct(t,e){const i="in"===e?er(t):function(t){switch(t){case _t.Vertex:return Ys;case _t.Fragment:return js;case _t.Compute:return"uu_CSOutput";default:return null}}(t),s="in"===e?Js(t):tr(t),r=t===_t.Vertex?"vertex":t===_t.Fragment?"fragment":"compute",a=sr.webgpu,n=[],o=[];for(const t in a)a[t].stage===r&&a[t].inOrOut===e&&(n.push({name:a[t].name,type:a[t].type}),o.push(`@builtin(${a[t].semantic}) `));const h="in"===e?this._inputs:this._outputs;for(const t of h){if(!(t[1]instanceof Br))throw new Ws("defineBuiltinStruct() failed: input/output is not declare var ast node");const e=t[1].value.getType();if(!e.isPrimitiveType()&&!e.isArrayType()&&!e.isStructType())throw new Error(`invalid in/out variable type: '${t[1].value.name}'`);n.push({name:t[1].value.name,type:e}),o.push(`@location(${t[1].value.value.$location}) ${e.isPrimitiveType()&&e.isInteger()?"@interpolate(flat) ":""}`)}if(n.length>0){const r=this.findStructType(i,t);if(r)return r.getType().reset(i,"default",n),r.prefix=o,null;{const r=this.internalDefineStructByType(this._shaderType,!1,new Wt(i,"default",n));this.findStructType(i,t).prefix=o;const a=this.struct(i,s);return[r,a,i,"in"===e?this.struct(i,"uu_AppInput"):a]}}return null}defineInternalStructs(){this.defineHiddenStruct(ls),this.defineHiddenStruct(cs),this.defineHiddenStruct(ds),this.defineHiddenStruct(ps)}array(...t){if(0===t.length)throw new Ps("array");t=t.map((t=>this.normalizeExpValue(t)));let e=!0,i=null,s=!0,r=!0,a=!0,n=!0,o=!1;for(const s of t)if(s instanceof Jr){const t=s.$ast.getType();if(!t.isConstructible()){e=!1;break}i?t.isCompatibleType(i)||(e=!1):i=t}if(e){i&&i.isPrimitiveType()&&i.isScalarType()?(s=i.primitiveType===At.BOOL,r=i.primitiveType===At.F32,n=i.primitiveType===At.U32,a=i.primitiveType===At.I32):i&&(s=!1,r=!1,n=!1,a=!1,o=!0);for(const i of t){if(!(i instanceof Jr)&&o){e=!1;break}"number"==typeof i?(s=!1,(0|i)===i&&(i<0?(n=!1,a=a&&i>=-2147483648):(n=n&&i<=4294967295,a=a&&i<=2147483647))):"boolean"==typeof i&&(r=!1,a=!1,n=!1)}}if(e&&!o&&(s?i=ce:a?i=se:n?i=oe:r&&(i=Kt),e=!!i),!e)throw new Bs("array");if(!i.isPrimitiveType()&&!i.isArrayType()&&!i.isStructType())throw new Bs("array");const h=new Ht(i,t.length),u=new Jr("",h);return u.$ast=new br(h,t.map((t=>{if(t instanceof Jr)return t.$ast;if(!i.isPrimitiveType()||!i.isScalarType())throw new Fs(t,typeof t,i);return new Er(t,i)}))),u}discard(){this.getCurrentScope().$ast.statements.push(new Dr)}tagShaderExp(t,e){if("string"==typeof e)this._reflection.tag(e,t);else if(Array.isArray(e))e.forEach((e=>this.tagShaderExp(t,e)));else for(const i of Object.keys(e))this.tagShaderExp((e=>t(e)[i]),e[i])}in(t,e,i){if(this._inputs[t])throw new Error(`input location ${t} already declared`);i.$location=t,i.$declareType=Ks.DECLARE_TYPE_IN,this._inputs[t]=[e,new Br(new _r(i))],Object.defineProperty(this._inputScope,e,{get:function(){return i},set:function(){throw new Error(`cannot assign to readonly variable: ${e}`)}}),i.$tags.forEach((t=>this.tagShaderExp((()=>i),t)))}out(t,e,i){if(this._outputs[t])throw new Error(`output location ${t} has already been used`);i.$location=t,i.$declareType=Ks.DECLARE_TYPE_OUT,this._outputs[t]=[e,new Br(new _r(i))],Object.defineProperty(this._outputScope,e,{get:function(){return i},set:function(t){jr().getCurrentScope().$ast.statements.push(new Nr(new fr(i.$ast),t instanceof Jr?t.$ast:t))}})}getDefaultSampler(t,e){const i=this._uniforms.findIndex((e=>e.texture?.exp===t));if(i<0)return;const s=e?"comparison":"sample";if(this._uniforms[i].texture.autoBindSampler&&this._uniforms[i].texture.autoBindSampler!==s)throw new Error("multiple sampler not supported");if(this._uniforms[i].texture.autoBindSampler=s,"webgpu"===this._device.type){const i=ir(t.$str,e);if(!this.getGlobalScope()[i])throw new Error(`failed to find sampler name ${i}`);return this.getGlobalScope()[i]}return null}normalizeExpValue(t){if(Array.isArray(t)){const e=t.map((t=>Array.isArray(t)?this.normalizeExpValue(t):t));return this.array(...e)}return t}guessExpValueType(t){const e=this.normalizeExpValue(t);if("boolean"==typeof e)return ce;if("number"==typeof e){if(Number.isInteger(e)){if(e>=-1073741824&&e<=2147483647)return se;if(e>=0&&e<=4294967295)return oe;throw new Ls(e)}return Kt}return e instanceof Jr?e.$ast?.getType()||e.$typeinfo:void 0}findStructType(t,e){for(const i of[_t.Vertex,_t.Fragment,_t.Compute])if(i&e){const e=this._structInfo[i];if(e)for(const i of e.types)if(i.type.structName===t)return i}return null}findStructConstructor(t,e){for(const i of[_t.Vertex,_t.Fragment,_t.Compute])if(i&e){const e=this._structInfo[i];if(e&&e.structs?.[t])return e.structs[t]}return null}buildComputeSource(t){try{return this._lastError=null,this._shaderType=_t.Compute,this._scopeStack=[],this._globalScope=new Ca,this._builtinScope=new va,this._inputs=[],this._outputs=[],this._inputScope=new Sa,this._outputScope=new wa,this._reflection.clear(),this.generate(t.compute),this.mergeUniformsCompute(this._globalScope),this.updateUniformBindings([this._globalScope],[_t.Compute]),[this.generateComputeSource(this._globalScope,this._builtinScope),this.createBindGroupLayouts(t.label)]}catch(t){return t instanceof Is?(this._lastError=t.getMessage(this._device.type),console.error(this._lastError),null):t instanceof Error?(this._lastError=t.toString(),console.error(this._lastError),null):(this._lastError=Object.prototype.toString.call(t),console.log(`Error: ${this._lastError}`),null)}}buildRenderSource(t){try{this._lastError=null,this._shaderType=_t.Vertex,this._scopeStack=[],this._globalScope=new Ca,this._builtinScope=new va,this._inputs=[],this._outputs=[],this._inputScope=new Sa,this._outputScope=new wa,this._reflection.clear(),this.generate(t.vertex);const e=this._globalScope,i=this._builtinScope,s=this._inputs,r=this._outputs;this._device.type,this._shaderType=_t.Fragment,this._scopeStack=[],this._globalScope=new Ca,this._builtinScope=new va,this._inputs=[],this._outputs=[],this._inputScope=new Sa,this._outputScope=new wa,this._reflection.clear(),r.forEach(((t,e)=>{this.in(e,t[0],new Jr(t[1].value.name,t[1].value.getType()).tag(...t[1].value.value.$tags))})),this.generate(t.fragment);const a=this._globalScope,n=this._builtinScope,o=this._inputs,h=this._outputs;return this._device.type,this.mergeUniforms(e,a),this.updateUniformBindings([e,a],[_t.Vertex,_t.Fragment]),[this.generateRenderSource(_t.Vertex,e,i,s.map((t=>t[1])),r.map((t=>t[1]))),this.generateRenderSource(_t.Fragment,a,n,o.map((t=>t[1])),h.map((t=>t[1]))),this.createBindGroupLayouts(t.label),this._vertexAttributes]}catch(t){return t instanceof Is?(this._lastError=t.getMessage(this._device.type),console.error(this._lastError),null):t instanceof Error?(this._lastError=t.toString(),console.error(this._lastError),null):(this._lastError=Object.prototype.toString.call(t),console.log(`Error: ${this._lastError}`),null)}}generate(t){this.pushScope(this._globalScope),this._emulateDepthClamp&&this._shaderType===_t.Vertex&&(this._globalScope.$outputs.clamppedDepth=this.float().tag("CLAMPPED_DEPTH")),t&&t.call(this._globalScope,this),this.popScope()}generateRenderSource(t,e,i,s,r){const a={type:t,mrt:t===_t.Fragment&&r.length>1,defines:[],extensions:new Set,builtins:[...i.$_usedBuiltins],types:this._structInfo[t]?.types||[],typeReplacement:new Map,inputs:s,outputs:r,global:e,vertexAttributes:this._vertexAttributes,workgroupSize:null};switch(this._device.type){case"webgl":for(const t of this._uniforms)if(t.texture){const e=t.texture.exp.$ast.getType();if(e.isTextureType()&&e.isDepthTexture()){if("comparison"===t.texture.autoBindSampler)throw new zs("depth texture comparison");"sample"===t.texture.autoBindSampler&&(e.is2DTexture()?a.typeReplacement.set(t.texture.exp,Ae):e.isCubeTexture()&&a.typeReplacement.set(t.texture.exp,Pe))}}return e.$ast.toWebGL("",a);case"webgl2":for(const t of this._uniforms)if(t.texture){const e=t.texture.exp.$ast.getType();e.isTextureType()&&e.isDepthTexture()&&"sample"===t.texture.autoBindSampler&&(e.is2DTexture()?a.typeReplacement.set(t.texture.exp,e.isArrayTexture()?$e:Ae):e.isCubeTexture()&&a.typeReplacement.set(t.texture.exp,Pe))}return e.$ast.toWebGL2("",a);case"webgpu":return e.$ast.toWGSL("",a);default:return null}}generateComputeSource(t,e){const i={type:_t.Compute,mrt:!1,defines:[],extensions:new Set,builtins:[...e.$_usedBuiltins],types:this._structInfo[_t.Compute]?.types||[],typeReplacement:null,inputs:[],outputs:[],global:t,vertexAttributes:[],workgroupSize:this._workgroupSize};return t.$ast.toWGSL("",i)}mergeUniformsCompute(t){const e=[];for(let t=0;t<this._uniforms.length;t++){const i=this._uniforms[t];if(i.block&&(i.block.exp.$declareType===Ks.DECLARE_TYPE_UNIFORM||i.block.exp.$declareType===Ks.DECLARE_TYPE_STORAGE)){if(i.block.exp.$typeinfo.isStructType()&&i.block.exp.$isBuffer)continue;e[i.group]||(e[i.group]=[]);const s=new Jr(i.block.exp.$str,i.block.exp.$ast.getType());s.$declareType=i.block.exp.$declareType,s.$isBuffer=i.block.exp.$isBuffer,e[i.group].push({member:s,uniform:t})}}for(const i in e)if(e[i].length>0){const s=["std140","std430"],r=["ch_compute_uniform_block","ch_compute_storage_block"],a=[e[i].filter((t=>t.member.$declareType===Ks.DECLARE_TYPE_UNIFORM)),e[i].filter((t=>t.member.$declareType===Ks.DECLARE_TYPE_STORAGE))];for(let e=0;e<2;e++){if(0===a[e].length)continue;const n=[a[e].filter((t=>!t.member.$isBuffer)),...a[e].filter((t=>t.member.$isBuffer)).map((t=>[t]))];for(let a=0;a<n.length;a++){if(0===n[a].length)continue;const o=`${r[e]}_${i}_${a}`,h=this.generateStructureName(),u=jr().internalDefineStruct(h,s[e],_t.Compute,!1,...n[a].map((t=>t.member)))();0===e?u.uniformBuffer(Number(i)):u.storageBuffer(Number(i)),t[o]=u;const l=this._uniforms.findIndex((t=>t.block?.name===o));this._uniforms[l].mask=_t.Compute;let c=this._nameMap[Number(i)];c||(c={},this._nameMap[Number(i)]=c);let d=!1;for(let t=n[a].length-1;t>=0;t--){const e=n[a][t],i=this._uniforms[e.uniform].block.exp;c[i.$str]=o,i.$str=`${o}.${i.$str}`,d||=i.$ast.isWritable()}d&&t[o].$ast.markWritable()}}}this._uniforms=this._uniforms.filter((t=>!t.block||t.block.exp.$typeinfo.isStructType()&&t.block.exp.$isBuffer))}mergeUniforms(t,e){const i=[],s=[],r=[];for(let t=0;t<this._uniforms.length;t++){const e=this._uniforms[t];if(e.block&&(e.block.exp.$declareType===Ks.DECLARE_TYPE_UNIFORM||e.block.exp.$declareType===Ks.DECLARE_TYPE_STORAGE)){if(e.block.exp.$typeinfo.isStructType()&&e.block.exp.$isBuffer)continue;const a=!!(e.mask&_t.Vertex),n=!!(e.mask&_t.Fragment);if(a&&n){r[e.group]||(r[e.group]=[]);const i=new Jr(e.block.exp.$str,e.block.exp.$ast.getType());i.$declareType=e.block.exp.$declareType,i.$isBuffer=e.block.exp.$isBuffer,r[e.group].push({member:i,uniform:t})}else if(a){i[e.group]||(i[e.group]=[]);const s=new Jr(e.block.exp.$str,e.block.exp.$ast.getType());s.$declareType=e.block.exp.$declareType,s.$isBuffer=e.block.exp.$isBuffer,i[e.group].push({member:s,uniform:t})}else if(n){s[e.group]||(s[e.group]=[]);const i=new Jr(e.block.exp.$str,e.block.exp.$ast.getType());i.$declareType=e.block.exp.$declareType,i.$isBuffer=e.block.exp.$isBuffer,s[e.group].push({member:i,uniform:t})}}}const a=[i,s,r],n=["ch_vertex_uniform_block","ch_fragment_uniform_block","ch_shared_uniform_block"],o=["ch_vertex_storage_block","ch_fragment_storage_block","ch_shared_storage_block"],h=[_t.Vertex,_t.Fragment,_t.Vertex|_t.Fragment];for(let i=0;i<3;i++)for(const s in a[i])if(a[i][s]?.length>0){const r=[a[i][s].filter((t=>t.member.$declareType===Ks.DECLARE_TYPE_UNIFORM)),a[i][s].filter((t=>t.member.$declareType===Ks.DECLARE_TYPE_STORAGE))],u=[n,o],l=["std140","std430"];for(let a=0;a<2;a++){if(0===r[a].length)continue;const n=[r[a].filter((t=>!t.member.$isBuffer)),...r[a].filter((t=>t.member.$isBuffer)).map((t=>[t]))];for(let r=0;r<n.length;r++){if(0===n[r].length)continue;const o=`${u[a][i]}_${s}_${r}`,c=this.generateStructureName(),d=jr().internalDefineStruct(c,l[a],h[i],!1,...n[r].map((t=>t.member)));if(h[i]&_t.Vertex){const e=d();0===a?e.uniformBuffer(Number(s)):e.storageBuffer(Number(s)),t[o]=e}if(h[i]&_t.Fragment){const t=d();0===a?t.uniformBuffer(Number(s)):t.storageBuffer(Number(s)),e[o]=t}const p=this._uniforms.findIndex((t=>t.block?.name===o));this._uniforms[p].mask=h[i];let _=this._nameMap[Number(s)];_||(_={},this._nameMap[Number(s)]=_);let m=!1;for(let t=n[r].length-1;t>=0;t--){const e=n[r][t],i=this._uniforms[e.uniform].block.exp;_[i.$str]=o,i.$str=`${o}.${i.$str}`,m||=i.$ast.isWritable()}m&&(h[i]&_t.Vertex?t[o].$ast.markWritable():e[o].$ast.markWritable())}}}this._uniforms=this._uniforms.filter((t=>!t.block||t.block.exp.$typeinfo.isStructType()&&t.block.exp.$isBuffer))}updateUniformBindings(t,e){this._uniforms=this._uniforms.filter((t=>!!t.mask));const i=Array.from({length:4}).fill(0);for(const t of this._uniforms)t.binding=i[t.group]++;for(let i=0;i<t.length;i++){const s=t[i],r=e[i];for(const t of this._uniforms)if(t.mask&r){const e=s.$ast.uniforms,i=t.block?t.block.name:t.texture?t.texture.exp.$str:t.sampler.$str,r=e.findIndex((t=>t.value.name===i));if(r<0)throw new Error(`updateUniformBindings() failed: unable to find uniform ${i}`);e[r].binding=t.binding}}}createBindGroupLayouts(t){const e=[];for(const i of this._uniforms){let s=e[i.group];s||(s={label:`${t||"unknown"}[${i.group}]`,entries:[]},this._nameMap[i.group]&&(s.nameMap=this._nameMap[i.group]),e[i.group]=s);const r={binding:i.binding,visibility:i.mask,type:null,name:""};if(i.block){r.type=i.block.exp.$typeinfo.clone(this.getBlockName(i.block.name));const t=i.block.exp.$declareType===Ks.DECLARE_TYPE_STORAGE;r.buffer={type:t?i.block.exp.$ast.isWritable()?"storage":"read-only-storage":"uniform",hasDynamicOffset:i.block.dynamicOffset,uniformLayout:r.type.toBufferLayout(0,r.type.layout)},r.name=i.block.name}else if(i.texture){if(r.type=i.texture.exp.$typeinfo,!r.type.isTextureType())throw new Error("internal error");if(r.type.isStorageTexture())r.storageTexture={access:"write-only",viewDimension:r.type.is1DTexture()?"1d":"2d",format:r.type.storageTexelFormat};else if(r.type.isExternalTexture())r.externalTexture={autoBindSampler:i.texture.autoBindSampler?ir(i.texture.exp.$str,!1):null};else{const t="webgpu"===this._device.type?i.texture.exp.$sampleType:i.texture.autoBindSampler&&r.type.isDepthTexture()?"float":i.texture.exp.$sampleType;let e;e=r.type.isArrayTexture()?r.type.isCubeTexture()?"cube-array":"2d-array":r.type.is3DTexture()?"3d":r.type.isCubeTexture()?"cube":r.type.is1DTexture()?"1d":"2d",r.texture={sampleType:t,viewDimension:e,multisampled:!1,autoBindSampler:null,autoBindSamplerComparison:null},"webgpu"!==this._device.type&&"sample"!==i.texture.autoBindSampler||(r.texture.autoBindSampler=ir(i.texture.exp.$str,!1)),("webgpu"===this._device.type&&r.type.isDepthTexture()||"comparison"===i.texture.autoBindSampler)&&(r.texture.autoBindSamplerComparison=ir(i.texture.exp.$str,!0))}r.name=i.texture.exp.$str}else{if(!i.sampler)throw new Ws("invalid uniform entry type");if(r.type=i.sampler.$typeinfo,!r.type.isSamplerType())throw new Error("internal error");r.sampler={type:r.type.accessMode===Vt.SAMPLE?"float"===i.sampler.$sampleType?"filtering":"non-filtering":"comparison"},r.name=i.sampler.$str}s.entries.push(r)}for(let i=0;i<e.length;i++)e[i]||(e[i]={label:`${t||"unknown"}[${i}]`,entries:[]});return e}_getFunctionOverload(t,e){const i=e.filter((t=>{if(t instanceof Jr){const e=t.$ast.getType();if(e.isStructType()&&this._structInfo[this._shaderType]?.types.findIndex((t=>t.type.structName===e.structName))<0)return!1}return!0})),s=this.getGlobalScope().$getFunctions(t);return s?this._matchFunctionOverloading(s,i):null}_matchFunctionOverloading(t,e){for(const i of t){if(e.length!==i.funcType.argTypes.length)continue;const t=[];let s=!0;for(let r=0;r<e.length;r++){const a=i.funcType.argTypes[r],n=a.byRef&&a.type instanceof Yt?a.type.pointerType:a.type,o=e[r];if("boolean"==typeof o){if(!n.isPrimitiveType()||n.primitiveType!==At.BOOL){s=!1;break}t.push(new Er(o,ce))}else if("number"==typeof o){if(!n.isPrimitiveType()||!n.isScalarType()||n.scalarType===At.BOOL){s=!1;break}if(n.scalarType===At.I32){if(!Number.isInteger(o)||o<-2147483648||o>2147483647){s=!1;break}t.push(new Er(o,se))}else if(n.scalarType===At.U32){if(!Number.isInteger(o)||o<0||o>4294967295){s=!1;break}t.push(new Er(o,oe))}else t.push(new Er(o,n))}else{if(!n.isCompatibleType(o.$ast.getType())){s=!1;break}t.push(o.$ast)}}if(s)return[i,t]}return null}$callFunction(t,e,i){if(this.getCurrentScope()===this.getGlobalScope())throw new ks(t);const s=new Jr("",i.returnType);return s.$ast=new Pr(t,e,i,jr().getDevice().type),this.getCurrentScope().$ast.statements.push(s.$ast),s}$callFunctionNoCheck(t,e,i){if(this.getCurrentScope()===this.getGlobalScope())throw new ks(t);const s=new Jr("",i);return s.$ast=new Pr(t,e,null,jr().getDevice().type,i),this.getCurrentScope().$ast.statements.push(s.$ast),s}}class Ea extends Kr{$_variables;$_parentScope;$_AST;$_localScope;constructor(t,e){super(),this.$_parentScope=e||null,this.$_variables={},this.$_AST=t,this.$_localScope=null}get $builder(){return jr()}get $builtins(){return jr().builtinScope}get $inputs(){return jr().inputScope}get $outputs(){return jr().outputScope}get $parent(){return this.$_parentScope}get $ast(){return this.$_AST}set $ast(t){this.$_AST=t}$getVertexAttrib(t){return jr().getReflection().attribute(t)}get $l(){return this.$_getLocalScope()}get $g(){return this.$_getGlobalScope()}$local(t,e){const i=jr().normalizeExpValue(e);t.$global=this instanceof Ca,this.$_declare(t,i)}$touch(t){this.$ast.statements.push(new Mr(t.$ast))}$query(t){return this.$builder.getReflection().tag(t)}$_declareInternal(t,e){const i=t.$str;if(this.$_variables[i])throw new Error(`cannot re-declare variable '${i}'`);if(!(t.$ast instanceof _r))throw new Error(`invalid variable declaration: '${t.$ast.toString(jr().getDevice().type)}'`);const s=t.$typeinfo;if(s.isPointerType()){if(!e)throw new Error(`cannot declare pointer type variable without initialization: '${t.$str}'`);if(!(e instanceof Jr))throw new Error(`invalid initialization for pointer type declaration: '${t.$str}`);const i=e.$ast.getType();if(!i.isPointerType()||!s.pointerType.isCompatibleType(i.pointerType))throw new Error(`incompatible pointer type assignment: '${t.$str}'`);t.$typeinfo=i}if(this.$_registerVar(t,i),null==e)return new Br(t.$ast);if(e instanceof Jr&&e.$ast instanceof br&&0===e.$ast.args.length){if(!e.$ast.getType().isCompatibleType(t.$ast.getType()))throw new Fs(e,e.$ast.getType(),t.$ast.getType());return new Br(t.$ast)}return new Nr(new Tr(t.$ast),e instanceof Jr?e.$ast:e)}$_findOrSetUniform(t){const e=t.$str,i={group:t.$group,binding:0,mask:0};t.$typeinfo.isTextureType()?i.texture={autoBindSampler:null,exp:t}:t.$typeinfo.isSamplerType()?i.sampler=t:i.block={name:e,dynamicOffset:!1,exp:t};let s=!1;for(const e of jr()._uniforms)if(e.group===i.group){if(i.block&&e.block&&e.block.name===i.block.name&&e.block.exp.$typeinfo.isCompatibleType(i.block.exp.$typeinfo)){e.mask|=jr().shaderType,t=e.block.exp,s=!0;break}if(i.texture&&e.texture&&i.texture.exp.$str===e.texture.exp.$str&&i.texture.exp.$typeinfo.isCompatibleType(e.texture.exp.$typeinfo)){e.mask|=jr().shaderType,t=e.texture.exp,s=!0;break}if(i.sampler&&e.sampler&&i.sampler.$str===e.sampler.$str&&i.sampler.$typeinfo.isCompatibleType(e.sampler.$typeinfo)){e.mask|=jr().shaderType,t=e.sampler,s=!0;break}}if(s||(i.mask=jr().shaderType,jr()._uniforms.push(i)),i.texture&&!i.texture.exp.$typeinfo.isStorageTexture()&&"webgpu"===jr().getDevice().type){const e=t.$typeinfo.isTextureType()&&t.$typeinfo.isDepthTexture(),s=ir(t.$str,!1),r=jr().sampler(s).uniform(i.group).sampleType(t.$sampleType);if(r.$sampleType=t.$sampleType,this.$local(r),e){const e=ir(t.$str,!0),s=jr().samplerComparison(e).uniform(i.group).sampleType(t.$sampleType);this.$local(s)}}return t}$_declare(t,e){if(this.$_variables[t.$str])throw new Xs(t.$ast,"cannot re-declare variable");if(t.$declareType===Ks.DECLARE_TYPE_UNIFORM||t.$declareType===Ks.DECLARE_TYPE_STORAGE){const e=t.$ast.name;if(!(this instanceof Ca))throw new Error(`uniform or storage variables can only be declared within global scope: ${e}`);if(!(t.$declareType!==Ks.DECLARE_TYPE_UNIFORM||t.$typeinfo.isTextureType()||t.$typeinfo.isSamplerType()||t.$typeinfo.isConstructible()&&t.$typeinfo.isHostSharable()))throw new Xs(t.$ast,`type '${t.$typeinfo.toTypeName(jr().getDevice().type)}' cannot be declared in uniform address space`);if(t.$declareType===Ks.DECLARE_TYPE_STORAGE){if("webgpu"!==jr().getDevice().type)throw new zs("storage buffer binding");if(!t.$typeinfo.isHostSharable())throw new Xs(t.$ast,`type '${t.$typeinfo.toTypeName(jr().getDevice().type)}' cannot be declared in storage address space`)}t=this.$_findOrSetUniform(t);const i=this.$_declareInternal(t);i.group=t.$group,i.binding=0,i.blockName=jr().getBlockName(e);const s=t.$typeinfo;(s.isStructType()&&t.$isBuffer||s.isTextureType()||s.isSamplerType()||s.isStructType()&&("std140"===s.detail.layout||"std430"===s.detail.layout))&&this.$ast.uniforms.push(i),t.$tags.forEach((e=>{jr().tagShaderExp((()=>t),e)}))}else{const i=this.$_declareInternal(t,e);this.$ast.statements.push(i)}}$_registerVar(t,e){const i=e||t.$str,s={configurable:!0,get:function(){return t},set:function(e){jr().getCurrentScope().$ast.statements.push(new Nr(new fr(t.$ast),e instanceof Jr?e.$ast:e))}};Object.defineProperty(this,i,s),this.$_variables[i]=t}$localGet(t){if("string"==typeof t&&("$"===t[0]||t in this))return this[t]}$localSet(t,e){return("$"===t[0]||t in this)&&(this[t]=e,!0)}$get(t){const e=this.$localGet(t);return void 0===e&&this.$_parentScope?this.$_parentScope.$thisProxy.$get(t):e}$set(t,e){if("$"===t[0])return this[t]=e,!0;{let i=this;for(;i&&!(t in i);)i=i.$_parentScope;if(i)return i[t]=e,!0;if(this.$l)return this.$l[t]=e,!0}return!1}$_getLocalScope(){return this.$_localScope||(this.$_localScope=new ya(this)),this.$_localScope}$_getGlobalScope(){return this.$builder.getGlobalScope()}}class ya extends Ea{$_scope;constructor(t){super(null,null),this.$_scope=t}$get(t){return"$"===t[0]?this[t]:this.$_scope.$localGet(t)}$set(t,e){if("$"===t[0])return this[t]=e,!0;if(void 0===this.$_scope.$localGet(t)){const i=jr().guessExpValueType(e);if(i.isCompatibleType(us))throw new Error(`Cannot assign void type to '${t}'`);const s=new Jr(t,i);return e instanceof Jr&&!this.$_scope.$parent&&(s.$declareType=e.$declareType,s.$isBuffer=e.$isBuffer,s.$group=e.$group,s.$attrib=e.$attrib,s.$sampleType=e.$sampleType,s.$precision=e.$precision,s.tag(...e.$tags)),this.$_scope.$local(s,e),!0}return this.$_scope.$localSet(t,e)}$_getLocalScope(){return this}}class va extends Ea{$_usedBuiltins;$_builtinVars;constructor(){super(null),this.$_usedBuiltins=new Set;if(!("webgpu"===jr().getDevice().type)){this.$_builtinVars={};const t=sr[jr().getDevice().type];for(const e in t){const i=t[e];this.$_builtinVars[e]=new Jr(i.name,i.type)}}const t=sr[jr().getDevice().type],e=this;for(const i of Object.keys(t))Object.defineProperty(this,i,{get:function(){return e.$getBuiltinVar(i)},set:function(t){if("number"!=typeof t&&!(t instanceof Jr))throw new Error("Invalid output value assignment");const s=e.$getBuiltinVar(i);jr().getCurrentScope().$ast.statements.push(new Nr(new fr(s.$ast),t instanceof Jr?t.$ast:t))}})}$_getLocalScope(){return null}$getBuiltinVar(t){const e=jr();this.$_usedBuiltins.add(t);if("webgpu"===e.getDevice().type){const i=sr[e.getDevice().type][t],s="in"===i.inOrOut?Js(e.shaderType):tr(e.shaderType),r=e.getCurrentScope();if(!r[s]||!r[s][i.name])throw new Error(`invalid use of builtin variable ${t}`);return r[s][i.name]}return"webgl2"!==e.getDevice().type||"vertexIndex"!==t&&"instanceIndex"!==t?this.$_builtinVars[t]:e.uint(this.$_builtinVars[t])}}class Sa extends Ea{constructor(){super(null)}$_getLocalScope(){return null}$set(t,e){if("$"===t[0])this[t]=e;else{if(t in this)throw new Error(`Can not assign to shader input variable: "${t}"`);{const i=jr().shaderType;if(i!==_t.Vertex)throw new Error(`shader input variables can only be declared in vertex shader: "${t}"`);const s=Es(e.$attrib);if(void 0===s)throw new Error(`can not declare shader input variable: invalid vertex attribute: "${t}"`);if(jr()._vertexAttributes.indexOf(s)>=0)throw new Error(`can not declare shader input variable: attribute already declared: "${t}"`);if(!(e instanceof Jr&&e.$ast instanceof br))throw new Error(`invalid shader input variable declaration: "${t}"`);const r=e.$ast.getType();if(!r.isPrimitiveType()||r.isMatrixType()||r.primitiveType===At.BOOL)throw new Error(`type cannot be used as pipeline input/output: ${t}`);const a=jr()._inputs.length,n=new Jr(`uu_in_${t}`,r).tag(...e.$tags);jr().in(a,t,n),jr()._vertexAttributes.push(s),jr().getReflection().setAttrib(e.$attrib,n),"webgpu"===jr().getDevice().type&&jr().findStructType(er(i),i)&&jr().defineBuiltinStruct(i,"in")}}return!0}}class wa extends Ea{constructor(){super(null)}$_getLocalScope(){return null}$set(t,e){if("$"===t[0])this[t]=e;else{const i=jr();if(!(t in this)){if(!(i.getCurrentScope()!==i.getGlobalScope()||e instanceof Jr&&e.$ast instanceof br))throw new Error(`invalid shader output variable declaration: ${t}`);const s=e.$ast.getType();if(!s.isPrimitiveType()||s.isMatrixType()||s.primitiveType===At.BOOL)throw new Error(`type cannot be used as pipeline input/output: ${t}`);const r=i._outputs.length;if(i.out(r,t,new Jr(`${"vertex"===i.shaderKind?"uu_vsout_":"uu_fsout_"}${t}`,s).tag(...e.$tags)),"webgpu"===jr().getDevice().type){const t=jr().shaderType;jr().findStructType(er(t),t)&&jr().defineBuiltinStruct(t,"out")}}if(jr().getCurrentScope()!==jr().getGlobalScope()){const i=e.$ast;i instanceof br&&!(i.args.length>0)||(this[t]=e)}}return!0}}class Ca extends Ea{constructor(){super(new pr)}$mainFunc(t){const e=jr();if("webgpu"===e.getDevice().type){const i=e.defineBuiltinStruct(e.shaderType,"in");this.$local(i[1]);const s=e.shaderType===_t.Compute,r=s?null:e.defineBuiltinStruct(e.shaderType,"out");s||this.$local(r[1]),this.$internalCreateFunction("chMainStub",[],!1,t),this.$internalCreateFunction("main",i?[i[3]]:[],!0,(function(){i&&(this[i[1].$str]=this[i[3].$str]),e.shaderType===_t.Fragment&&e.emulateDepthClamp&&(this.$builtins.fragDepth=e.clamp(this.$inputs.clamppedDepth,0,1)),this.chMainStub(),e.shaderType===_t.Vertex&&(e.depthRangeCorrection&&(this.$builtins.position.z=e.mul(e.add(this.$builtins.position.z,this.$builtins.position.w),.5)),e.emulateDepthClamp&&(this.$outputs.clamppedDepth=e.div(this.$builtins.position.z,this.$builtins.position.w),this.$builtins.position.z=0)),s||this.$return(r[1])}))}else this.$internalCreateFunction("main",[],!0,(function(){e.shaderType===_t.Fragment&&e.emulateDepthClamp&&(this.$builtins.fragDepth=e.clamp(this.$inputs.clamppedDepth,0,1)),t?.call(this),e.shaderType===_t.Vertex&&e.emulateDepthClamp&&(this.$outputs.clamppedDepth=e.div(e.add(e.div(this.$builtins.position.z,this.$builtins.position.w),1),2),this.$builtins.position.z=0)}))}$createFunctionIfNotExists(t,e,i){this.$internalCreateFunction(t,e,!1,i)}$getFunctions(t){return this.$ast.findFunctions(t)}$getCurrentFunctionScope(){let t=jr().getCurrentScope();for(;t&&!(t instanceof Ra);)t=t.$parent;return t}$internalCreateFunction(t,e,i,s){const r=jr();e.forEach((e=>{if(!(e.$ast instanceof _r))throw new Error(`${t}(): invalid function definition`);let i=e.$ast;e.$inout&&("webgpu"===jr().getDevice().type&&(e.$typeinfo=new Yt(e.$typeinfo,Gt.UNKNOWN)),i=new wr(e.$ast)),e.$ast=new lr(i)}));const a=this.$getFunctions(t),n=this.$getCurrentFunctionScope(),o=new Or(t,e.map((t=>t.$ast)),i,null,!1);if(n){const t=this.$ast.statements.indexOf(n.$ast);if(t<0)throw new Error("Internal error");this.$ast.statements.splice(t,0,o)}else this.$ast.statements.push(o);new Ra(this,e,o,s),o.returnType||(o.returnType=us),o.funcType=new Zt(o.name,o.returnType,e.map((t=>{const e=t.$ast;return e.paramAST instanceof wr?{type:e.paramAST.value.getType(),byRef:e.paramAST instanceof wr}:{type:e.paramAST.getType(),byRef:!1}})));for(const e of a)if(e.funcType.argHash===o.funcType.argHash){if(e.returnType.isCompatibleType(o.returnType))return void this.$ast.statements.splice(this.$ast.statements.indexOf(o),1);throw new Error(`Invalid function overloading: ${t}`)}0===a.length&&Object.defineProperty(this,t,{get:function(){if(0===this.$getFunctions(t).length)throw new Error(`function ${t} not found`);return(...e)=>{const i=e.map((t=>r.normalizeExpValue(t))),s=r._getFunctionOverload(t,i);if(!s)throw new Error(`ERROR: no matching overloads for function ${t}`);return jr().$callFunction(t,s[1],s[0])}}})}}class Aa extends Ea{constructor(t){super(new cr,t)}$return(t){const e=this.findOwnerFunction().$ast;let i=null;const s=jr().normalizeExpValue(t);if(null!=s)if("number"==typeof s){if(e.returnType&&e.returnType.isPrimitiveType()&&e.returnType.isScalarType()&&!e.returnType.isCompatibleType(ce)&&(i=e.returnType),!i)if(Number.isInteger(s))if(s<0){if(s<-2147483648)throw new Error(`function ${e.name}: invalid return value: ${s}`);i=se}else{if(s>4294967295)throw new Error(`function ${e.name}: invalid return value: ${s}`);i=s<=2147483647?se:oe}else i=Kt}else i="boolean"==typeof s?ce:s.$ast.getType();else i=us;if(i.isPointerType())throw new Error("function can not return pointer type");if(e.returnType){if(!e.returnType.isCompatibleType(i))throw new Error(`function ${e.name}: return type must be ${e.returnType?.toTypeName(jr().getDevice().type)||"void"}`)}else e.returnType=i;let r=null;if(null!=s)if(s instanceof Jr)r=s.$ast;else{if(!i.isPrimitiveType()||!i.isScalarType())throw new Fs(s,typeof s,i);r=new Er(s,i)}this.$ast.statements.push(new Fr(r))}$scope(t){const e=new dr;return this.$ast.statements.push(e),new Da(this,e,t)}$if(t,e){const i=new Ur("if",t instanceof Jr?t.$ast:new Er(t,"number"==typeof t?Kt:ce));return this.$ast.statements.push(i),new Ia(this,i,e)}$choice(t,e,i){const s=new $r(t instanceof Jr?t.$ast:t,e instanceof Jr?e.$ast:e,i instanceof Jr?i.$ast:i),r=new Jr("",s.getType());return r.$ast=s,r}$break(){this.$ast.statements.push(new Ir)}$continue(){this.$ast.statements.push(new Lr)}$for(t,e,i,s){const r=t.$ast.getType();if(!r.isPrimitiveType()||!r.isScalarType())throw new Xs(t.$ast,"invalid for range initializer type");const a=e instanceof Jr?e.$ast:new Er(e,r),n=new Vr(t.$ast,a,i instanceof Jr?i.$ast:new Er(i,r),!0);this.$ast.statements.push(n),new Na(this,t,i,n,s)}$do(t){const e=new Gr(null);return this.$ast.statements.push(e),new $a(this,e,t)}$while(t,e){const i=new zr(t instanceof Jr?t.$ast:new Er(t,"number"==typeof t?Kt:ce));this.$ast.statements.push(i),new Ma(this,i,e)}findOwnerFunction(){for(let t=this;t;t=t.$parent)if(t instanceof Ra)return t;return null}}class Ra extends Aa{$typeinfo;constructor(t,e,i,s){super(t),this.$ast=i;for(const t of e){if(this.$_variables[t.$str])throw new Error("Duplicate function parameter name is not allowed");this.$_registerVar(t)}jr().pushScope(this),s&&s.call(this),jr().popScope()}}class Ma extends Aa{constructor(t,e,i){super(t),this.$ast=e,jr().pushScope(this),i&&i.call(this),jr().popScope()}}class $a extends Aa{constructor(t,e,i){super(t),this.$ast=e,jr().pushScope(this),i&&i.call(this),jr().popScope()}$while(t){this.$ast.condition=t instanceof Jr?t.$ast:new Er(t,"number"==typeof t?Kt:ce)}}class Na extends Aa{constructor(t,e,i,s,r){super(t),this.$ast=s,this.$_registerVar(e),jr().pushScope(this),r&&r.call(this),jr().popScope()}}class Da extends Aa{constructor(t,e,i){super(t),this.$ast=e,jr().pushScope(this),i&&i.call(this),jr().popScope()}}class Ia extends Aa{constructor(t,e,i){super(t),this.$ast=e,jr().pushScope(this),i&&i.call(this),jr().popScope()}$elseif(t,e){const i=new Ur("else if",t instanceof Jr?t.$ast:new Er(t,"number"==typeof t?Kt:ce));return this.$ast.nextElse=i,new Ia(this.$_parentScope,i,e)}$else(t){const e=new Ur("else",null);this.$ast.nextElse=e,new Ia(this.$_parentScope,e,t)}}var La;!function(t){for(const e of Object.keys(_a))t.prototype[e]=function(...t){return(_a?.[e]?.normalizeFunc||ra)(this,e,...t)}}(ba),La=ba,Object.keys(ga).forEach((t=>{La.prototype[t]=Zr((function(...e){return fa.call(this,ga[t],...e)}),ga[t])})),Object.keys(xa).forEach((t=>{La.prototype[t]=function(e){return new Jr(e,xa[t])}})),Object.keys(Ta).forEach((t=>{La.prototype[t]=function(t){const e={};for(const i of Object.keys(ma))e[i]=function(e){return new Jr(e,new jt(t,ma[i]))};return e}(Ta[t])})),La.prototype.atomic_int=function(...t){if(t.length>1)throw new Ps("atomic_int");if(1===t.length){if("string"!=typeof t[0])throw new Bs("atomic_int","name");return new Jr(t[0],ee)}{const t=new Jr("",ee);return t.$ast=new br(t.$typeinfo,[]),t}},La.prototype.atomic_uint=function(...t){if(t.length>1)throw new Ps("atomic_uint");if(1===t.length&&"string"==typeof t[0])return new Jr(t[0],ie);if(0===t.length){const t=new Jr("",ie);return t.$ast=new br(t.$typeinfo,[]),t}const e=t[0];if("number"==typeof e&&Number.isInteger(e)||e instanceof Jr&&e.$ast.getType().typeId===oe.typeId){const t=new Jr("",ie);return t.$ast=new br(t.$typeinfo,[e instanceof Jr?e.$ast:e]),t}return null};class Fa{static _canvas=null;static _context=null;static get canvas(){return this._realize(),this._canvas}static get context(){return this._realize(),this._context}static get font(){return this.context.font}static set font(t){this.context.font=t}static _realize(){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=512,this._canvas.height=512,this._canvas.style.left="-10000px",this._canvas.style.position="absolute",this._context=this._canvas.getContext("2d",{willReadFrequently:!0}),this._context.textBaseline="top",this._context.textAlign="left",this._context.fillStyle="transparent",this._context.fillRect(0,0,this._canvas.width,this._canvas.height),this._context.fillStyle="#ffffff",this._context.imageSmoothingEnabled=!0)}}class Pa{static fontCache={};_name;_nameScaled;_scale;_size;_family;_top;_bottom;_topScaled;_bottomScaled;_div;constructor(t,e){this._top=0,this._bottom=0,this._size=0,this._topScaled=0,this._bottomScaled=0,this._family="",this._scale=e,this._name=t,this._nameScaled=null,this._div=document.createElement("div"),this._name&&this._normalizeFont()}static fetchFont(t,e){let i=this.fontCache[t];i||(i={},this.fontCache[t]=i);let s=i[e];return s||(s=new Pa(t,e),i[e]=s),s}get fontName(){return this._name}set fontName(t){this._name=t,this._normalizeFont()}get fontNameScaled(){return this._nameScaled}get size(){return this._size}get family(){return this._family}get top(){return this._top}get bottom(){return this._bottom}get topScaled(){return this._topScaled}get bottomScaled(){return this._bottomScaled}get maxHeight(){return this._bottom-this._top+1}get maxHeightScaled(){return this._bottomScaled-this._topScaled+1}equalTo(t){return this._size===t._size&&this._family===t._family}_measureFontHeight(t){const e=Fa.context.font,i=Fa.context.textBaseline,s=Fa.context.fillStyle;Fa.context.font=t,this._div.style.font=Fa.context.font;const r=this._div.style.fontSize,a=parseInt(r.substring(0,r.length-2)),n=this._div.style.fontFamily,o="bdfghijklpq|_~",h=Fa.context.measureText(o);let u,l;u=0,l=a-1;const c=Math.ceil(h.width)+10,d=a+10;Fa.context.clearRect(0,0,c,d),Fa.context.textBaseline="top",Fa.context.fillStyle="#ffffff",Fa.context.fillText(o,5,5);const p=Fa.context.getImageData(0,0,c,d).data;for(let t=0;t<c*d;t++)if(p[4*t+3]>0){u=Math.floor(t/c);break}for(let t=c*d-1;t>=0;t--)if(p[4*t+3]>0){l=Math.floor(t/c);break}return u-=5,l-=5,Fa.context.font=e,Fa.context.textBaseline=i,Fa.context.fillStyle=s,{size:a,family:n,top:u,bottom:l}}_normalizeFont(){const t=this._measureFontHeight(this._name);this._nameScaled=`${Math.round(t.size*this._scale)}px ${t.family}`;const e=this._measureFontHeight(this._nameScaled);this._size=t.size,this._family=t.family,this._top=t.top,this._bottom=t.bottom,this._topScaled=e.top,this._bottomScaled=e.bottom}}class Ba{static ATLAS_WIDTH=1024;static ATLAS_HEIGHT=1024;_packer;_device;_binWidth;_binHeight;_rectBorderWidth;_linearSpace;_atlasList;_atlasInfoMap;_atlasRestoreHandler;constructor(t,e,i,s,r){this._device=t,this._binWidth=e,this._binHeight=i,this._rectBorderWidth=s,this._linearSpace=!!r,this._packer=new z(this._binWidth,this._binHeight),this._atlasList=[],this._atlasInfoMap={},this._atlasRestoreHandler=null}get atlasTextureRestoreHandler(){return this._atlasRestoreHandler}set atlasTextureRestoreHandler(t){this._atlasRestoreHandler=t}getAtlasTexture(t){return this._atlasList[t]}getAtlasInfo(t){return this._atlasInfoMap[t]||null}isEmpty(){return 0===this._atlasList.length}clear(){this._packer.clear();for(const t of this._atlasList)t.dispose();this._atlasList=[],this._atlasInfoMap={}}pushCanvas(t,e,i,s,r,a){const n=this._packer.insert(r+2*this._rectBorderWidth,a+2*this._rectBorderWidth);if(n){const o=n.x+this._rectBorderWidth,h=n.y+this._rectBorderWidth;this._updateAtlasTextureCanvas(n.binIndex,e,o,h,r,a,i,s);const u={atlasIndex:n.binIndex,uMin:o/this._binWidth,vMin:h/this._binHeight,uMax:(o+r)/this._binWidth,vMax:(h+a)/this._binHeight,width:r,height:a};return this._atlasInfoMap[t]=u,u}return null}pushBitmap(t,e){const i=this._packer.insert(e.width+2*this._rectBorderWidth,e.height+2*this._rectBorderWidth);if(i){const s=i.x+this._rectBorderWidth,r=i.y+this._rectBorderWidth;this._updateAtlasTexture(i.binIndex,e,s,r);const a={atlasIndex:i.binIndex,uMin:s/this._binWidth,vMin:r/this._binHeight,uMax:(s+e.width)/this._binWidth,vMax:(r+e.height)/this._binHeight,width:e.width,height:e.height};return this._atlasInfoMap[t]=a,a}return null}_createAtlasTexture(){const t=this._device.createTexture2D("rgba8unorm",this._binWidth,this._binHeight,{samplerOptions:{mipFilter:"none"}});return t.update(new Uint8Array(t.width*t.height*4),0,0,t.width,t.height),t.restoreHandler=async()=>{t.update(new Uint8Array(t.width*t.height*4),0,0,t.width,t.height),this._atlasRestoreHandler&&await this._atlasRestoreHandler(t)},t}_updateAtlasTextureCanvas(t,e,i,s,r,a,n,o){let h=null;t===this._atlasList.length?(h=this._createAtlasTexture(),this._atlasList.push(h)):h=this._atlasList[t],h.updateFromElement(e.canvas,i,s,n,o,r,a)}_updateAtlasTexture(t,e,i,s){let r=null;if(t===this._atlasList.length?(r=this._createAtlasTexture(),this._atlasList.push(r)):r=this._atlasList[t],e instanceof ImageBitmap)r.updateFromElement(e,i,s,0,0,e.width,e.height);else{const t=new Uint8Array(e.data.buffer);r.update(t,i,s,e.width,e.height)}}}class Oa extends Ba{constructor(t,e,i,s){super(t,e,i,s,!0),this.atlasTextureRestoreHandler=async()=>{this.isEmpty()||this.clear()}}getGlyphInfo(t,e){if(!t||!e)return null;let i=this.getAtlasInfo(this._hash(t,e));return i||(i=this._cacheGlyph(t,e),i.width=Math.round(i.width*(e.maxHeight/e.maxHeightScaled)),i.height=e.maxHeight),i}measureStringWidth(t,e,i){let s=0;for(const r of t)s+=e+this.getCharWidth(r,i);return s}clipStringToWidth(t,e,i,s,r){let a=0,n=s;for(;n<t.length&&(a+=i+this.getCharWidth(t[n],r),!(a>e));n++);return n-s}_hash(t,e){return`${e.family}@${e.size}&${t}`}_cacheGlyph(t,e){const i=this._getGlyphBitmap(t,e);return this.pushBitmap(this._hash(t,e),i)}getCharWidth(t,e){if(!e)return 0;Fa.font=e.fontNameScaled;const i=Fa.context.measureText(t);let s=i.width;return 0===s?0:("number"==typeof i.actualBoundingBoxRight&&(s=Math.floor(Math.max(s,i.actualBoundingBoxRight)+.8)),s=Math.round(s*(e.maxHeight/e.maxHeightScaled)),s)}_getGlyphBitmap(t,e){if(!e)return null;Fa.font=e.fontNameScaled;const i=Fa.context.measureText(t);let s=i.width;if(0===s)return null;"number"==typeof i.actualBoundingBoxRight&&(s=Math.floor(Math.max(s,i.actualBoundingBoxRight)+.8));const r=e.maxHeightScaled;return Fa.context.fillStyle="#fff",Fa.context.clearRect(0,0,s+2,r),Fa.context.fillText(t,0,-e.topScaled),Fa.context.getImageData(0,0,s,r)}}class Ua{static GLYPH_COUNT=1024;static glyphManager=null;static prepared=!1;static textVertexBuffer=null;static textVertexLayout=null;static textProgram=null;static textBindGroup=null;static textRenderStates=null;static textOffset=0;static textMatrix=new v;static font=null;static vertexCache=null;static colorValue=new T;static calculateTextMatrix(t,e){const i=t.getViewport(),s=v.ortho(0,i.width,0,i.height,1,100),r=v.translation(new g(0,i.height,0)).scaleRight(new g(1,-1,1));v.multiply(s,r,e)}static setFont(t,e){this.font=Pa.fetchFont(e,t.getScale())||Pa.fetchFont("12px arial",t.getScale())}static drawText(e,i,s,r,a){if(i.length>0){e.pushDeviceStates(),this.prepareDrawText(e),this.calculateTextMatrix(e,this.textMatrix);const n=function(e){e=e.trim().toLowerCase();let i=null;if("#"===(e=t[e]||e)[0]){const t=(e.length-1)/3,s=[17,1,.062272][t-1];i={r:parseInt(e.substring(1,1+t),16)*s/255,g:parseInt(e.substring(1+t,1+2*t),16)*s/255,b:parseInt(e.substring(1+2*t,1+3*t),16)*s/255,a:1}}else{let t;(t=e.match(/^\s*rgb\s*\(\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\s*,\s*(\d\.?\d*)\s*\)\s*$/i))?i={r:Number(t[1])/255,g:Number(t[2])/255,b:Number(t[3])/255,a:1}:(t=e.match(/^\s*rgba\s*\(\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\s*,\s*([\d*.?\d*]+)\s*,\s*(\d*\.?\d*)\s*\)\s*$/i))&&(i={r:Number(t[1])/255,g:Number(t[2])/255,b:Number(t[3])/255,a:Number(t[4])})}if(!i||Number.isNaN(i.r)||Number.isNaN(i.g)||Number.isNaN(i.b)||Number.isNaN(i.a))throw new Error(`parseColor(): invalid color '${e}'`);return i.r=Math.pow(Math.min(1,i.r),2.2),i.g=Math.pow(Math.min(1,i.g),2.2),i.b=Math.pow(Math.min(1,i.b),2.2),i.a=Math.min(1,i.a),i}(s);this.colorValue.x=n.r,this.colorValue.y=n.g,this.colorValue.z=n.b,this.colorValue.w=n.a,this.textBindGroup.setValue("flip","webgpu"===e.type&&e.getFramebuffer()?1:0),this.textBindGroup.setValue("srgbOut",e.getFramebuffer()?0:1),this.textBindGroup.setValue("textMatrix",this.textMatrix),this.textBindGroup.setValue("textColor",this.colorValue),e.setProgram(this.textProgram),e.setVertexLayout(this.textVertexLayout),e.setRenderStates(this.textRenderStates),e.setBindGroup(0,this.textBindGroup);let o=0;const h=i.length;for(;o<h;){const t=Math.min(h-o,this.GLYPH_COUNT-this.textOffset);t>0&&(r=this.drawTextNoOverflow(e,i,o,t,r,a),o+=t,this.textOffset+=t),this.GLYPH_COUNT===this.textOffset&&(this.textOffset=0,e.flush())}e.popDeviceStates()}}static drawTextNoOverflow(t,e,i,s,r,a){let n=0,o=-1,h=0;for(;h<s;h++){const s=this.glyphManager.getGlyphInfo(e[h+i],this.font)||this.glyphManager.getGlyphInfo("?",this.font);o>=0&&s.atlasIndex!==o&&(this.textVertexBuffer.bufferSubData(16*(this.textOffset+n)*4,this.vertexCache,16*(this.textOffset+n),16*(h-n)),this.textBindGroup.setTexture("tex",this.glyphManager.getAtlasTexture(o)),t.draw("triangle-list",6*(this.textOffset+n),6*(h-n)),n=h),o=s.atlasIndex;const u=16*(this.textOffset+h);this.vertexCache[u+0]=r,this.vertexCache[u+1]=a,this.vertexCache[u+2]=s.uMin,this.vertexCache[u+3]=s.vMin,this.vertexCache[u+4]=r+s.width,this.vertexCache[u+5]=a,this.vertexCache[u+6]=s.uMax,this.vertexCache[u+7]=s.vMin,this.vertexCache[u+8]=r+s.width,this.vertexCache[u+9]=a+s.height,this.vertexCache[u+10]=s.uMax,this.vertexCache[u+11]=s.vMax,this.vertexCache[u+12]=r,this.vertexCache[u+13]=a+s.height,this.vertexCache[u+14]=s.uMin,this.vertexCache[u+15]=s.vMax,r+=s.width}return this.textVertexBuffer.bufferSubData(16*(this.textOffset+n)*4,this.vertexCache,16*(this.textOffset+n),16*(h-n)),this.textBindGroup.setTexture("tex",this.glyphManager.getAtlasTexture(o)),t.draw("triangle-list",6*(this.textOffset+n),6*(h-n)),r}static prepareDrawText(t){if(!this.prepared){this.prepared=!0,this.font=this.font||Pa.fetchFont("16px arial",t.getScale()),this.glyphManager=new Oa(t,1024,1024,1),this.vertexCache=new Float32Array(16*this.GLYPH_COUNT),this.textVertexBuffer=t.createInterleavedVertexBuffer(["position_f32x2","tex0_f32x2"],this.vertexCache,{dynamic:!0});const e=new Uint16Array(6*this.GLYPH_COUNT);for(let t=0;t<this.GLYPH_COUNT;t++){const i=4*t;e[6*t+0]=i+0,e[6*t+1]=i+1,e[6*t+2]=i+2,e[6*t+3]=i+0,e[6*t+4]=i+2,e[6*t+5]=i+3}const i=t.createIndexBuffer(e);this.textVertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:this.textVertexBuffer}],indexBuffer:i}),this.textOffset=0,this.textProgram=t.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.$inputs.uv=t.vec2().attrib("texCoord0"),this.$outputs.uv=t.vec2(),this.flip=t.int(0).uniform(0),this.textMatrix=t.mat4().uniform(0),t.main((function(){this.$builtins.position=t.mul(this.textMatrix,t.vec4(this.$inputs.pos,-50,1)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})),this.$outputs.uv=this.$inputs.uv}))},fragment(t){this.$outputs.color=t.vec4(),this.textColor=t.vec4().uniform(0),this.tex=t.tex2D().uniform(0),this.srgbOut=t.int().uniform(0),t.main((function(){this.alpha=t.mul(t.textureSample(this.tex,this.$inputs.uv).a,this.textColor.a),this.$if(t.notEqual(this.srgbOut,0),(function(){this.$outputs.color=t.vec4(t.mul(t.pow(this.textColor.rgb,t.vec3(1/2.2)),this.alpha),this.alpha)})).$else((function(){this.$outputs.color=t.vec4(t.mul(this.textColor.rgb,this.alpha),this.alpha)}))}))}}),this.textBindGroup=t.createBindGroup(this.textProgram.bindGroupLayouts[0]),this.textRenderStates=t.createRenderStateSet(),this.textRenderStates.useBlendingState().enable(!0).setBlendFuncRGB("one","inv-src-alpha").setBlendFuncAlpha("zero","one"),this.textRenderStates.useDepthState().enableTest(!1).enableWrite(!1),this.textRenderStates.useRasterizerState().setCullMode("none")}}}class Va{_canvas;_canvasClientWidth;_canvasClientHeight;_gpuObjectList;_gpuMemCost;_disposeObjectList;_beginFrameTime;_endFrameTime;_frameInfo;_cpuTimer;_gpuTimer;_runningLoop;_fpsCounter;_runLoopFunc;_backend;_beginFrameCounter;_programBuilder;_stateStack;constructor(t,e){this._backend=e,this._gpuObjectList={textures:[],samplers:[],buffers:[],programs:[],framebuffers:[],vertexArrayObjects:[],bindGroups:[]},this._canvas=t,this._canvas.setAttribute("tabindex","1"),this._canvasClientWidth=t.clientWidth,this._canvasClientHeight=t.clientHeight,this._gpuMemCost=0,this._disposeObjectList=[],this._beginFrameTime=0,this._endFrameTime=0,this._runLoopFunc=null,this._frameInfo={frameCounter:0,frameTimestamp:0,elapsedTimeCPU:0,elapsedTimeGPU:0,elapsedFrame:0,elapsedOverall:0,FPS:0,drawCalls:0,computeCalls:0,nextFrameCall:[]},this._programBuilder=new ba(this),this._cpuTimer=new $s,this._gpuTimer=null,this._runningLoop=null,this._fpsCounter={time:0,frame:0},this._stateStack=[],this._beginFrameCounter=0,this._registerEventHandlers()}get backend(){return this._backend}get videoMemoryUsage(){return this._gpuMemCost}get frameInfo(){return this._frameInfo}get isRendering(){return null!==this._runningLoop}get canvas(){return this._canvas}get type(){return this._backend.typeName()}get runLoopFunction(){return this._runLoopFunc}get programBuilder(){return this._programBuilder}setFont(t){Ua.setFont(this,t)}drawText(t,e,i,s){Ua.drawText(this,t,s,e,i)}disposeObject(t,e=!0){t&&(e&&this.removeGPUObject(t),t.disposed||(this.isContextLost()?t.destroy():this._disposeObjectList.push(t)),t.dispatchEvent(null,"disposed"))}async restoreObject(t){t&&t.disposed&&!this.isContextLost()&&(await t.restore(),t.restoreHandler&&await t.restoreHandler(t))}enableGPUTimeRecording(t){t&&!this._gpuTimer?this._gpuTimer=this.createGPUTimer():t||(this._gpuTimer?.end(),this._gpuTimer=null)}beginFrame(){if(0===this._beginFrameCounter){for(const t of this._disposeObjectList)t.destroy();this._disposeObjectList=[]}return this._beginFrameCounter++,this._beginFrameTime=this._cpuTimer.now(),this.updateFrameInfo(),this.onBeginFrame()}endFrame(){this._beginFrameCounter>0&&(this._beginFrameCounter--,0===this._beginFrameCounter&&(this._endFrameTime=this._cpuTimer.now(),this.onEndFrame()))}getVertexAttribFormat(t,e,i){return function(t,e,i){const s=Es(t);for(const t in gs){const r=gs[t];if(r[0]===s&&r[3]===e&&r[4]===i)return t}return null}(t,e,i)}createInterleavedVertexBuffer(t,e,i){if(i&&i.usage&&"vertex"!==i.usage)return console.error("createVertexBuffer() failed: options.usage must be 'vertex' or not set"),null;let s=0;for(const e of t)s+=vs(e);const r=Cs(e.byteLength/s>>0,...t),a=Object.assign({usage:"vertex",dynamic:!1,managed:!0,storage:!1},i||{});return a.storage&&(a.dynamic=!1,a.managed=!1),a.dynamic&&(a.managed=!1),this.createStructuredBuffer(r,a,e)}createVertexBuffer(t,e,i){if(i&&i.usage&&"vertex"!==i.usage)return console.error("createVertexBuffer() failed: options.usage must be 'vertex' or not set"),null;const s=vs(t),r=Cs(e.byteLength/s>>0,t),a=Object.assign({usage:"vertex",dynamic:!1,managed:!0,storage:!1},i||{});return a.storage&&(a.dynamic=!1,a.managed=!1),a.dynamic&&(a.managed=!1),this.createStructuredBuffer(r,a,e)}draw(t,e,i){this._frameInfo.drawCalls++,this._draw(t,e,i)}drawInstanced(t,e,i,s){this._frameInfo.drawCalls++,this._drawInstanced(t,e,i,s)}compute(t,e,i){this._frameInfo.computeCalls++,this._compute(t,e,i)}runNextFrame(t){t&&this._frameInfo.nextFrameCall.push(t)}cancelNextFrameCall(t){const e=this._frameInfo.nextFrameCall.indexOf(t);e>=0&&this._frameInfo.nextFrameCall.splice(e,1)}exitLoop(){this._runningLoop&&(cancelAnimationFrame(this._runningLoop),this._runningLoop=null)}runLoop(t){if(null!==this._runningLoop)return void console.error("Device.runLoop() can not be nested");if(!t)return void console.error("Device.runLoop() argment error");const e=this;e._runLoopFunc=t,function t(){e._runningLoop=requestAnimationFrame(t),e.beginFrame()&&(e._runLoopFunc(e),e.endFrame())}()}pushDeviceStates(){this._stateStack.push({windowOrderReversed:this.isWindingOrderReversed(),framebuffer:this.getFramebuffer(),viewport:this.getViewport(),scissor:this.getScissor(),program:this.getProgram(),renderStateSet:this.getRenderStates(),vertexLayout:this.getVertexLayout(),bindGroups:[this.getBindGroup(0),this.getBindGroup(1),this.getBindGroup(2),this.getBindGroup(3)]})}popDeviceStates(){if(0===this._stateStack.length)console.error("Device.popDeviceStates(): stack is empty");else{const t=this._stateStack.pop();this.setFramebuffer(t.framebuffer),this.setViewport(t.viewport),this.setScissor(t.scissor),this.setProgram(t.program),this.setRenderStates(t.renderStateSet),this.setVertexLayout(t.vertexLayout),this.setBindGroup(0,...t.bindGroups[0]),this.setBindGroup(1,...t.bindGroups[1]),this.setBindGroup(2,...t.bindGroups[2]),this.setBindGroup(3,...t.bindGroups[3]),this.reverseVertexWindingOrder(t.windowOrderReversed)}}getGPUObjects(){return this._gpuObjectList}getGPUObjectById(t){for(const e of[this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.buffers,this._gpuObjectList.framebuffers,this._gpuObjectList.programs,this._gpuObjectList.vertexArrayObjects])for(const i of e)if(i.uid===t)return i;return null}screenToDevice(t){return this.getFramebuffer()?t:Math.round(t*this.getScale())}deviceToScreen(t){return this.getFramebuffer()?t:Math.round(t/this.getScale())}buildRenderProgram(t){return this._programBuilder.buildRenderProgram(t)}buildComputeProgram(t){return this._programBuilder.buildComputeProgram(t)}addGPUObject(t){const e=this.getGPUObjectList(t);e&&e.indexOf(t)<0&&(e.push(t),this.dispatchEvent(new xt(t)))}removeGPUObject(t){const e=this.getGPUObjectList(t);if(e){const i=e.indexOf(t);i>=0&&(e.splice(i,1),this.dispatchEvent(new Tt(t)))}}updateVideoMemoryCost(t){this._gpuMemCost+=t}_onresize(){this._canvasClientWidth===this._canvas.clientWidth&&this._canvasClientHeight===this._canvas.clientHeight||(this._canvasClientWidth=this._canvas.clientWidth,this._canvasClientHeight=this._canvas.clientHeight,this.dispatchEvent(new gt(this._canvasClientWidth,this._canvasClientHeight)))}_registerEventHandlers(){const t=this._canvas,e=this;window.ResizeObserver?new window.ResizeObserver((t=>{e._onresize()})).observe(t,{}):(window.MutationObserver&&new MutationObserver((function(t){t.length>0&&e._onresize()})).observe(t,{attributes:!0,attributeFilter:["style"]}),window.addEventListener("resize",(()=>{this._onresize()})))}updateFrameInfo(){this._frameInfo.frameCounter++,this._frameInfo.drawCalls=0,this._frameInfo.computeCalls=0;const t=this._beginFrameTime;if(0===this._frameInfo.frameTimestamp)this._frameInfo.frameTimestamp=t,this._frameInfo.elapsedTimeCPU=0,this._frameInfo.elapsedTimeGPU=0,this._frameInfo.elapsedFrame=0,this._frameInfo.elapsedOverall=0,this._frameInfo.FPS=0,this._fpsCounter.time=t,this._fpsCounter.frame=this._frameInfo.frameCounter,this._gpuTimer&&this._gpuTimer.begin();else{this._frameInfo.elapsedFrame=t-this._frameInfo.frameTimestamp,this._frameInfo.elapsedOverall+=this._frameInfo.elapsedFrame;let e=0,i=0;0!==this._endFrameTime&&(e=t-this._endFrameTime,i=this._endFrameTime-this._frameInfo.frameTimestamp),this._frameInfo.frameTimestamp=t,t>=this._fpsCounter.time+1e3&&(this._frameInfo.FPS=1e3*(this._frameInfo.frameCounter-this._fpsCounter.frame)/(t-this._fpsCounter.time),this._fpsCounter.time=t,this._fpsCounter.frame=this._frameInfo.frameCounter,this._frameInfo.elapsedTimeGPU=e,this._frameInfo.elapsedTimeCPU=i)}for(const t of this._frameInfo.nextFrameCall)t();this._frameInfo.nextFrameCall.length=0}getGPUObjectList(t){let e=null;return t.isTexture()?e=this._gpuObjectList.textures:t.isSampler()?e=this._gpuObjectList.samplers:t.isBuffer()?e=this._gpuObjectList.buffers:t.isFramebuffer()?e=this._gpuObjectList.framebuffers:t.isProgram()?e=this._gpuObjectList.programs:t.isVertexLayout()?e=this._gpuObjectList.vertexArrayObjects:t.isBindGroup()&&(e=this._gpuObjectList.bindGroups),e}invalidateAll(){for(const t of[this._gpuObjectList.buffers,this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.programs,this._gpuObjectList.framebuffers,this._gpuObjectList.vertexArrayObjects,this._gpuObjectList.bindGroups])for(const e of t)this.disposeObject(e,!1);if(this.isContextLost()){for(const t of this._disposeObjectList)t.destroy();this._disposeObjectList=[]}}async reloadAll(){const t=[];for(const e of[this._gpuObjectList.buffers,this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.programs,this._gpuObjectList.framebuffers,this._gpuObjectList.vertexArrayObjects,this._gpuObjectList.bindGroups])for(const i of e.slice())t.push(i.reload());Promise.all(t)}parseTextureOptions(t){return("none"===t?.samplerOptions?.mipFilter?bs.TF_NO_MIPMAP:0)|(t?.writable?bs.TF_WRITABLE:0)|(t?.dynamic?bs.DYNAMIC:0)}parseBufferOptions(t,e){let i;switch(t?.usage||e){case"uniform":i=bs.BF_UNIFORM,t.managed=!1,t.dynamic=t.dynamic??!0;break;case"vertex":i=bs.BF_VERTEX;break;case"index":i=bs.BF_INDEX;break;case"read":i=bs.BF_READ,t.managed=!1;break;case"write":i=bs.BF_WRITE,t.managed=!1;break;default:i=0}const s=t?.storage?bs.BF_STORAGE:0,r=t?.dynamic?bs.DYNAMIC:0;return i|s|r|(0===r&&(t?.managed??1)?bs.MANAGED:0)}}class Ga{_cache;_buffer;_size;_uniformMap;_uniformPositions;constructor(t,e){if(this._size=t.byteSize+15&-16,this._size<=0)throw new Error(`UniformBuffer(): invalid uniform buffer byte size: ${this._size}`);this._uniformMap={},this._uniformPositions={},this._cache=e instanceof ArrayBuffer?e:null,this._buffer=e instanceof ArrayBuffer?null:e,this.init(t,0,"")}get byteLength(){return this._size}get buffer(){return this._cache}get uniforms(){return this._uniformMap}set(t,e){if(void 0!==e){const i=this._uniformMap[t];if(i)if(this._cache)if("number"==typeof e)i[0]=e;else if(e?._v)i.set(e._v);else{if("number"!=typeof e?.length)throw new Error("invalid uniform value");i.set(e)}else{const s=this._uniformPositions[t][1];if("number"==typeof e)i[0]=e,this._buffer.bufferSubData(this._uniformPositions[t][0],i);else{if(!(e.BYTES_PER_ELEMENT&&s<=e.byteLength))throw new Error("invalid uniform value");{const i=e;this._buffer.bufferSubData(this._uniformPositions[t][0],i,0,s/i.BYTES_PER_ELEMENT>>0)}}}else{if(Object.getPrototypeOf(e)!==Object.getPrototypeOf({}))throw new Error("invalid uniform value");this.setStruct(t,e)}}}setStruct(t,e){for(const i in e)this.set(`${t}.${i}`,e[i])}init(t,e,i){for(const s of t.entries)if(s.subLayout)e=this.init(s.subLayout,e,`${i}${s.name}.`);else{const t=`${i}${s.name}`;if(this._uniformPositions[t])throw new Error(`UniformBuffer(): duplicate uniform name: ${t}`);if(s.offset<e||s.byteSize<0)throw new Error("UniformBuffer(): invalid layout");this._uniformPositions[t]=[s.offset,s.byteSize];let r=null;switch(s.type){case At.F32:r=Float32Array;break;case At.U32:case At.BOOL:r=Uint32Array;break;case At.I32:r=Int32Array;break;case At.U16:case At.U16_NORM:case At.F16:r=Uint16Array;break;case At.I16:case At.I16_NORM:r=Int16Array;break;case At.U8:case At.U8_NORM:r=Uint8Array;break;case At.I8:case At.I8_NORM:r=Int8Array}if(!r)throw new Error(`UniformBuffer(): invalid data type for uniform: ${t}`);if(s.byteSize%r.BYTES_PER_ELEMENT)throw new Error(`UniformBuffer(): invalid byte size for uniform: ${t}`);this._cache?this._uniformMap[t]=new r(this._cache,s.offset,s.byteSize/r.BYTES_PER_ELEMENT):this._uniformMap[t]=new r(1),e=s.offset+s.byteSize}return e}}const za=0,ka=1,Xa=2,Wa=2,Ha=255;class Ya{static _groundAlbedo=1;static _groundRadiusMM=6.36;static _atmosphereRadiusMM=6.46;static _scatteringSteps=32;static _sunTransmittanceSteps=40;static _rayleighScatteringBase=[5.802,13.558,33.1];static _rayleighAbsorptionBase=0;static _mieScatteringBase=3.996;static _mieAbsorptionBase=4.4;static _ozoneAbsorptionBase=[.65,1.881,.085];static _multiScatteringSteps=20;static _sqrtSamples=8;static _transmittanceLutWidth=256;static _transmittanceLutHeight=64;static _multiScatteringLutWidth=32;static _multiScatteringLutHeight=32;static _skyViewLutWidth=256;static _skyViewLutHeight=256;static _vertexLayout=null;static _renderStates=null;static _programTransmittanceLut=null;static _bindgroupTransmittanceLut=null;static _programMultiScatteringLut=null;static _bindgroupMultiScatteringLut=null;static _programSkyViewLut=null;static _bindgroupSkyViewLut=null;static _transmittanceLut=null;static _multiScatteringLut=null;static _skyViewFramebuffer=null;static _programAerialPerspectiveLut=null;static _bindgroupAerialPerspectiveLut=null;static _aerialPerspectiveLut=null;static _currentSkyViewSunAltitude=0;static _currentAerialPerspectiveAltitude=0;static _currentMaxAerialPerspectiveDistance=800;static _aerialPerspectiveSliceX=32;static _aerialPerspectiveSliceY=32;static _aerialPerspectiveSliceZ=32;static _aerialPerspectiveTextureWidth=this._aerialPerspectiveSliceX*this._aerialPerspectiveSliceZ;static _aerialPerspectiveTextureHeight=this._aerialPerspectiveSliceY;static _viewPos=new g(0,this._groundRadiusMM+5e-5,0);static get aerialPerspectiveSliceZ(){return this._aerialPerspectiveSliceZ}static get groundRadius(){return this._groundRadiusMM}static get atmosphereRadius(){return this._atmosphereRadiusMM}static get viewPosition(){return this._viewPos}static getMultiScatteringLut(){const t=Y.instance.device;if(!this._multiScatteringLut){this.prepare(t);const e=t.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer&&t.getDeviceCaps().textureCaps.supportLinearHalfFloatTexture?"rgba16f":"rgba8unorm";this._multiScatteringLut=t.createTexture2D(e,this._multiScatteringLutWidth,this._multiScatteringLutHeight,{samplerOptions:{mipFilter:"none"}}),this._multiScatteringLut.name="MultiScatteringLUT";const i=this.getTransmittanceLut(),s=t.createFrameBuffer([this._multiScatteringLut],null);t.pushDeviceStates(),t.setFramebuffer(s),t.setProgram(this._programMultiScatteringLut),t.setBindGroup(0,this._bindgroupMultiScatteringLut),this._bindgroupMultiScatteringLut.setValue("flip","webgpu"===t.type?1:0),this._bindgroupMultiScatteringLut.setTexture("tLut",i),this.drawQuad(t),t.popDeviceStates(),s.dispose()}return this._multiScatteringLut}static getAerialPerspectiveLut(t,e){const i=Y.instance.device;if(t!==this._currentAerialPerspectiveAltitude||e!==this._currentMaxAerialPerspectiveDistance||!this._aerialPerspectiveLut){if(!this._aerialPerspectiveLut){const t=i.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer&&i.getDeviceCaps().textureCaps.supportLinearHalfFloatTexture?"rgba16f":"rgba8unorm";this._aerialPerspectiveLut||(this._aerialPerspectiveLut=i.createTexture2D(t,this._aerialPerspectiveTextureWidth,this._aerialPerspectiveTextureHeight,{samplerOptions:{mipFilter:"none"}}),this._aerialPerspectiveLut.name="AerialPerspectiveLUT")}const s=i.createFrameBuffer([this._aerialPerspectiveLut],null),r=this.getTransmittanceLut(),a=this.getMultiScatteringLut();this._currentAerialPerspectiveAltitude=t,this._currentMaxAerialPerspectiveDistance=e,i.pushDeviceStates(),i.setFramebuffer(s),i.setProgram(this._programAerialPerspectiveLut),i.setBindGroup(0,this._bindgroupAerialPerspectiveLut),this._bindgroupAerialPerspectiveLut.setValue("flip","webgpu"===i.type?1:0),this._bindgroupAerialPerspectiveLut.setValue("sunAltitude",this._currentAerialPerspectiveAltitude),this._bindgroupAerialPerspectiveLut.setValue("maxDistance",this._currentMaxAerialPerspectiveDistance),this._bindgroupAerialPerspectiveLut.setTexture("tLut",r),this._bindgroupAerialPerspectiveLut.setTexture("msLut",a),this.drawQuad(i),i.popDeviceStates(),s.dispose()}return this._aerialPerspectiveLut}static getSkyViewLut(t){const e=Y.instance.device;if(t!==this._currentSkyViewSunAltitude||!this._skyViewFramebuffer){if(!this._skyViewFramebuffer){const t=e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer&&e.getDeviceCaps().textureCaps.supportLinearHalfFloatTexture?"rgba16f":"rgba8unorm",i=e.createTexture2D(t,this._skyViewLutWidth,this._skyViewLutHeight,{samplerOptions:{mipFilter:"none"}});i.name="SkyViewLut",this._skyViewFramebuffer=e.createFrameBuffer([i],null)}const i=this.getTransmittanceLut(),s=this.getMultiScatteringLut();this._currentSkyViewSunAltitude=t,e.pushDeviceStates(),e.setFramebuffer(this._skyViewFramebuffer),e.setProgram(this._programSkyViewLut),e.setBindGroup(0,this._bindgroupSkyViewLut),this._bindgroupSkyViewLut.setValue("flip","webgpu"===e.type?1:0),this._bindgroupSkyViewLut.setValue("sunAltitude",this._currentSkyViewSunAltitude),this._bindgroupSkyViewLut.setTexture("tLut",i),this._bindgroupSkyViewLut.setTexture("msLut",s),this.drawQuad(e),e.popDeviceStates()}return this._skyViewFramebuffer.getColorAttachments()[0]}static getTransmittanceLut(){const t=Y.instance.device;if(!this._transmittanceLut){this.prepare(t);const e=t.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer&&t.getDeviceCaps().textureCaps.supportLinearHalfFloatTexture?"rgba16f":"rgba8unorm";this._transmittanceLut=t.createTexture2D(e,this._transmittanceLutWidth,this._transmittanceLutHeight,{samplerOptions:{mipFilter:"none"}}),this._transmittanceLut.name="TransmittanceLUT";const i=t.createFrameBuffer([this._transmittanceLut],null);t.pushDeviceStates(),t.setFramebuffer(i),t.setProgram(this._programTransmittanceLut),t.setBindGroup(0,this._bindgroupTransmittanceLut),this._bindgroupTransmittanceLut.setValue("flip","webgpu"===t.type?1:0),this.drawQuad(t),t.popDeviceStates(),i.dispose()}return this._transmittanceLut}static drawQuad(t){const e=t.getRenderStates();t.setRenderStates(this._renderStates),t.setVertexLayout(this._vertexLayout),t.draw("triangle-strip",0,4),t.setRenderStates(e)}static commonVertexShader(){const t=this.$builder;this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))}static commonFunctions(){const t=this.$builder;this.viewPos=t.vec3(Ya._viewPos.x,Ya._viewPos.y,Ya._viewPos.z),t.func("getMiePhase",[t.float("cosTheta")],(function(){this.$l.g=t.float(.8),this.$l.scale=t.float(3/(8*Math.PI)),this.$l.gg=t.mul(this.g,this.g),this.$l.num=t.mul(t.sub(1,this.gg),t.add(t.mul(this.cosTheta,this.cosTheta),1)),this.$l.denom=t.mul(t.add(2,this.gg),t.pow(t.sub(t.add(1,this.gg),t.mul(this.g,this.cosTheta,2)),1.5)),this.$return(t.div(t.mul(this.scale,this.num),this.denom))})),t.func("getRayleighPhase",[t.float("cosTheta")],(function(){this.$l.k=t.float(3/(16*Math.PI)),this.$return(t.mul(this.k,t.add(1,t.mul(this.cosTheta,this.cosTheta))))})),t.func("rayIntersectSphere",[t.vec3("ro"),t.vec3("rd"),t.float("rad")],(function(){this.$l.b=t.dot(this.ro,this.rd),this.$l.c=t.sub(t.dot(this.ro,this.ro),t.mul(this.rad,this.rad)),this.$if(t.and(t.greaterThan(this.c,0),t.greaterThan(this.b,0)),(function(){this.$return(t.float(-1))})),this.$l.bb=t.mul(this.b,this.b),this.$l.discr=t.sub(this.bb,this.c),this.$if(t.lessThan(this.discr,0),(function(){this.$return(t.float(-1))})),this.$if(t.greaterThan(this.discr,this.bb),(function(){this.$return(t.sub(t.sqrt(this.discr),this.b))})),this.$return(t.sub(t.neg(t.sqrt(this.discr)),this.b))})),t.func("getScatteringValues",[t.vec3("pos"),t.vec3("rayleighScattering").out(),t.float("mieScattering").out(),t.vec3("extinction").out()],(function(){this.$l.altitudeKM=t.mul(t.sub(t.length(this.pos),Ya._groundRadiusMM),1e3),this.$l.rayleighDensity=t.exp(t.div(this.altitudeKM,-8)),this.$l.mieDensity=t.exp(t.div(this.altitudeKM,-1.2)),this.rayleighScattering=t.mul(t.vec3(...Ya._rayleighScatteringBase),this.rayleighDensity),this.$l.rayleighAbsorption=t.mul(Ya._rayleighAbsorptionBase,this.rayleighDensity),this.mieScattering=t.mul(Ya._mieScatteringBase,this.mieDensity),this.$l.mieAbsorption=t.mul(Ya._mieAbsorptionBase,this.mieDensity),this.$l.ozoneAbsorption=t.mul(t.vec3(...Ya._ozoneAbsorptionBase),t.max(0,t.sub(1,t.div(t.abs(t.sub(this.altitudeKM,25)),15)))),this.extinction=t.add(this.rayleighScattering,t.vec3(this.rayleighAbsorption),t.vec3(this.mieScattering),t.vec3(this.mieAbsorption),this.ozoneAbsorption)}))}static prepare(t){const e=this;this._vertexLayout||(this._vertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]})),this._renderStates||(this._renderStates=t.createRenderStateSet(),this._renderStates.useRasterizerState().setCullMode("none"),this._renderStates.useDepthState().enableTest(!1).enableWrite(!1)),this._programAerialPerspectiveLut||(this._programAerialPerspectiveLut=t.buildRenderProgram({vertex(t){e.commonVertexShader.call(this)},fragment(t){this.$outputs.outColor=t.vec4(),this.sunAltitude=t.float().uniform(0),this.tLut=t.tex2D().uniform(0),this.msLut=t.tex2D().uniform(0),this.maxDistance=t.float().uniform(0),e.commonFunctions.call(this),t.func("getValFromTLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,e._groundRadiusMM),t.sub(e._atmosphereRadiusMM,e._groundRadiusMM))))),this.$return(t.textureSampleLevel(this.tLut,this.uv,0).rgb)})),t.func("getValFromMSLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,e._groundRadiusMM),t.sub(e._atmosphereRadiusMM,e._groundRadiusMM))))),this.$return(t.textureSampleLevel(this.msLut,this.uv,0).rgb)})),t.func("raymarchScattering",[t.vec3("pos"),t.vec3("rayDir"),t.vec3("sunDir"),t.float("tMax")],(function(){this.$l.cosTheta=t.dot(this.rayDir,this.sunDir),this.$l.miePhaseValue=this.getMiePhase(this.cosTheta),this.$l.rayleighPhaseValue=this.getRayleighPhase(t.neg(this.cosTheta)),this.$l.lum=t.vec3(0),this.$l.transmittance=t.vec3(1),this.$l.t=t.float(0),this.$for(t.int("i"),0,e._scatteringSteps,(function(){this.$l.newT=t.mul(t.div(t.add(t.float(this.i),.3),e._scatteringSteps),this.tMax),this.$l.dt=t.sub(this.newT,this.t),this.t=this.newT,this.$l.newPos=t.add(this.pos,t.mul(this.rayDir,this.t)),this.$l.rayleighScattering=t.vec3(),this.$l.extinction=t.vec3(),this.$l.mieScattering=t.float(),this.getScatteringValues(this.newPos,this.rayleighScattering,this.mieScattering,this.extinction),this.$l.sampleTransmittance=t.exp(t.mul(t.neg(this.dt),this.extinction)),this.$l.sunTransmittance=this.getValFromTLUT(this.newPos,this.sunDir),this.$l.psiMS=this.getValFromMSLUT(this.newPos,this.sunDir),this.$l.rayleighInScattering=t.mul(this.rayleighScattering,t.add(t.mul(this.sunTransmittance,this.rayleighPhaseValue),this.psiMS)),this.$l.mieInScattering=t.mul(t.add(t.mul(this.sunTransmittance,this.miePhaseValue),this.psiMS),this.mieScattering),this.$l.inScattering=t.add(this.rayleighInScattering,this.mieInScattering),this.$l.scatteringIntegral=t.div(t.sub(this.inScattering,t.mul(this.inScattering,this.sampleTransmittance)),this.extinction),this.lum=t.add(this.lum,t.mul(this.scatteringIntegral,this.transmittance)),this.transmittance=t.mul(this.transmittance,this.sampleTransmittance)})),this.$return(this.lum)})),t.main((function(){this.$l.slice=t.clamp(t.floor(t.div(this.$inputs.uv.x,1/Ya._aerialPerspectiveSliceZ)),0,t.sub(Ya._aerialPerspectiveSliceZ,1)),this.$l.sliceU=t.clamp(t.div(t.sub(this.$inputs.uv.x,t.mul(this.slice,1/Ya._aerialPerspectiveSliceZ)),1/Ya._aerialPerspectiveSliceZ),0,1),this.$l.horizonAngle=t.sub(t.mul(this.sliceU,2*Math.PI),Math.PI),this.$l.zenithAngle=t.mul(this.$inputs.uv.y,Math.PI/2),this.$l.rayDir=t.vec3(t.mul(t.cos(this.zenithAngle),t.sin(this.horizonAngle)),t.sin(this.zenithAngle),t.mul(t.neg(t.cos(this.zenithAngle)),t.cos(this.horizonAngle))),this.$l.atmoDist=this.rayIntersectSphere(this.viewPos,this.rayDir,Ya._atmosphereRadiusMM),this.$l.groundDist=this.rayIntersectSphere(this.viewPos,this.rayDir,Ya._groundRadiusMM),this.$l.tMax=t.float(),this.$if(t.lessThan(this.groundDist,0),(function(){this.tMax=this.atmoDist})).$else((function(){this.tMax=this.groundDist})),this.tMax=this.atmoDist,this.$l.maxDistanceMM=t.mul(this.maxDistance,1e-6),this.$l.sliceDist=t.mul(this.maxDistanceMM,t.div(this.slice,Ya._aerialPerspectiveSliceZ)),this.tMax=t.min(this.tMax,this.sliceDist),this.$l.sunDir=t.vec3(0,t.sin(this.sunAltitude),t.neg(t.cos(this.sunAltitude))),this.$l.lum=this.raymarchScattering(this.viewPos,this.rayDir,this.sunDir,this.tMax);const i=1e3*(e._viewPos.y-e._groundRadiusMM),s=Math.exp(-i/8),r=Math.exp(-i/1.2);this.$l.extinction=t.vec3(-((e._rayleighScatteringBase[0]+e._rayleighAbsorptionBase)*s+(e._mieScatteringBase+e._mieAbsorptionBase)*r),-((e._rayleighScatteringBase[1]+e._rayleighAbsorptionBase)*s+(e._mieScatteringBase+e._mieAbsorptionBase)*r),-((e._rayleighScatteringBase[2]+e._rayleighAbsorptionBase)*s+(e._mieScatteringBase+e._mieAbsorptionBase)*r)),this.$l.t=t.exp(t.mul(this.extinction,this.tMax)),this.$outputs.outColor=t.vec4(this.lum,t.dot(this.t,t.vec3(1/3,1/3,1/3)))}))}}),this._bindgroupAerialPerspectiveLut=t.createBindGroup(this._programAerialPerspectiveLut.bindGroupLayouts[0])),this._programSkyViewLut||(this._programSkyViewLut=t.buildRenderProgram({vertex(t){e.commonVertexShader.call(this)},fragment(t){this.$outputs.outColor=t.vec4(),this.sunAltitude=t.float().uniform(0),this.tLut=t.tex2D().uniform(0),this.msLut=t.tex2D().uniform(0),e.commonFunctions.call(this),t.func("getValFromTLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,e._groundRadiusMM),t.sub(e._atmosphereRadiusMM,e._groundRadiusMM))))),this.$return(t.textureSampleLevel(this.tLut,this.uv,0).rgb)})),t.func("getValFromMSLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,e._groundRadiusMM),t.sub(e._atmosphereRadiusMM,e._groundRadiusMM))))),this.$return(t.textureSampleLevel(this.msLut,this.uv,0).rgb)})),t.func("raymarchScattering",[t.vec3("pos"),t.vec3("rayDir"),t.vec3("sunDir"),t.float("tMax")],(function(){this.$l.cosTheta=t.dot(this.rayDir,this.sunDir),this.$l.miePhaseValue=this.getMiePhase(this.cosTheta),this.$l.rayleighPhaseValue=this.getRayleighPhase(t.neg(this.cosTheta)),this.$l.lum=t.vec3(0),this.$l.transmittance=t.vec3(1),this.$l.t=t.float(0),this.$for(t.int("i"),0,e._scatteringSteps,(function(){this.$l.newT=t.mul(t.div(t.add(t.float(this.i),.3),e._scatteringSteps),this.tMax),this.$l.dt=t.sub(this.newT,this.t),this.t=this.newT,this.$l.newPos=t.add(this.pos,t.mul(this.rayDir,this.t)),this.$l.rayleighScattering=t.vec3(),this.$l.extinction=t.vec3(),this.$l.mieScattering=t.float(),this.getScatteringValues(this.newPos,this.rayleighScattering,this.mieScattering,this.extinction),this.$l.sampleTransmittance=t.exp(t.mul(t.neg(this.dt),this.extinction)),this.$l.sunTransmittance=this.getValFromTLUT(this.newPos,this.sunDir),this.$l.psiMS=this.getValFromMSLUT(this.newPos,this.sunDir),this.$l.rayleighInScattering=t.mul(this.rayleighScattering,t.add(t.mul(this.sunTransmittance,this.rayleighPhaseValue),this.psiMS)),this.$l.mieInScattering=t.mul(t.add(t.mul(this.sunTransmittance,this.miePhaseValue),this.psiMS),this.mieScattering),this.$l.inScattering=t.add(this.rayleighInScattering,this.mieInScattering),this.$l.scatteringIntegral=t.div(t.sub(this.inScattering,t.mul(this.inScattering,this.sampleTransmittance)),this.extinction),this.lum=t.add(this.lum,t.mul(this.scatteringIntegral,this.transmittance)),this.transmittance=t.mul(this.transmittance,this.sampleTransmittance)})),this.$return(this.lum)})),t.main((function(){this.$l.azimuthAngle=t.mul(t.sub(this.$inputs.uv.x,.5),2*Math.PI),this.$l.adjV=t.float(),this.$if(t.lessThan(this.$inputs.uv.y,.5),(function(){this.$l.coord=t.sub(1,t.mul(this.$inputs.uv.y,2)),this.adjV=t.neg(t.mul(this.coord,this.coord))})).$else((function(){this.$l.coord=t.sub(t.mul(this.$inputs.uv.y,2),1),this.adjV=t.mul(this.coord,this.coord)})),this.$l.height=t.length(this.viewPos),this.$l.up=t.div(this.viewPos,this.height),this.$l.horizonAngle=t.sub(t.acos(t.clamp(t.div(t.sqrt(t.sub(t.mul(this.height,this.height),t.mul(e._groundRadiusMM,e._groundRadiusMM))),this.height),-1,1)),.5*Math.PI),this.$l.altitudeAngle=t.sub(t.mul(this.adjV,.5*Math.PI),this.horizonAngle),this.$l.cosAltitude=t.cos(this.altitudeAngle),this.$l.rayDir=t.vec3(t.mul(this.cosAltitude,t.sin(this.azimuthAngle)),t.sin(this.altitudeAngle),t.mul(t.neg(this.cosAltitude),t.cos(this.azimuthAngle))),this.$l.sunDir=t.vec3(0,t.sin(this.sunAltitude),t.neg(t.cos(this.sunAltitude))),this.$l.atmoDist=this.rayIntersectSphere(this.viewPos,this.rayDir,e._atmosphereRadiusMM),this.$l.groundDist=this.rayIntersectSphere(this.viewPos,this.rayDir,e._groundRadiusMM),this.$l.tMax=t.float(),this.$if(t.lessThan(this.groundDist,0),(function(){this.tMax=this.atmoDist})).$else((function(){this.tMax=this.groundDist})),this.$l.lum=this.raymarchScattering(this.viewPos,this.rayDir,this.sunDir,this.tMax),this.$outputs.outColor=t.vec4(this.lum,1)}))}}),this._bindgroupSkyViewLut=t.createBindGroup(this._programSkyViewLut.bindGroupLayouts[0])),this._programMultiScatteringLut||(this._programMultiScatteringLut=t.buildRenderProgram({vertex(t){e.commonVertexShader.call(this)},fragment(t){this.$outputs.outColor=t.vec4(),this.tLut=t.tex2D().uniform(0),e.commonFunctions.call(this),t.func("getValFromTLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,e._groundRadiusMM),t.sub(e._atmosphereRadiusMM,e._groundRadiusMM))))),this.$return(t.textureSampleLevel(this.tLut,this.uv,0).rgb)})),t.func("getSphericalDir",[t.float("theta"),t.float("phi")],(function(){this.$l.cosPhi=t.cos(this.phi),this.$l.sinPhi=t.sin(this.phi),this.$l.cosTheta=t.cos(this.theta),this.$l.sinTheta=t.sin(this.theta),this.$return(t.vec3(t.mul(this.sinPhi,this.sinTheta),this.cosPhi,t.mul(this.sinPhi,this.cosTheta)))})),t.func("getMultiScatteringValues",[t.vec3("pos"),t.vec3("sunDir"),t.vec3("lumTotal").out(),t.vec3("fms").out()],(function(){this.lumTotal=t.vec3(0),this.fms=t.vec3(0),this.$l.invSamples=t.div(t.float(1),t.mul(e._sqrtSamples,e._sqrtSamples)),this.$for(t.int("i"),0,e._sqrtSamples,(function(){this.$for(t.int("j"),0,e._sqrtSamples,(function(){this.$l.theta=t.div(t.mul(t.add(t.float(this.i),.5),Math.PI),e._sqrtSamples),this.$l.c=t.sub(1,t.div(t.mul(t.add(t.float(this.j),.5),2),e._sqrtSamples)),this.$l.phi=t.acos(t.clamp(this.c,-1,1)),this.$l.rayDir=this.getSphericalDir(this.theta,this.phi),this.$l.atmoDist=this.rayIntersectSphere(this.pos,this.rayDir,e._atmosphereRadiusMM),this.$l.groundDist=this.rayIntersectSphere(this.pos,this.rayDir,e._groundRadiusMM),this.$l.tMax=this.atmoDist,this.$if(t.greaterThan(this.groundDist,0),(function(){this.tMax=this.groundDist})),this.$l.cosTheta=t.dot(this.rayDir,this.sunDir),this.$l.miePhaseValue=this.getMiePhase(this.cosTheta),this.$l.rayleighPhaseValue=this.getRayleighPhase(t.neg(this.cosTheta)),this.$l.lum=t.vec3(0),this.$l.lumFactor=t.vec3(0),this.$l.transmittance=t.vec3(1),this.$l.t=t.float(0),this.$for(t.int("stepI"),0,e._multiScatteringSteps,(function(){this.$l.newT=t.mul(t.div(t.add(t.float(this.stepI),.3),e._multiScatteringSteps),this.tMax),this.$l.dt=t.sub(this.newT,this.t),this.t=this.newT,this.$l.newPos=t.add(this.pos,t.mul(this.rayDir,this.t)),this.$l.rayleighScattering=t.vec3(),this.$l.extinction=t.vec3(),this.$l.mieScattering=t.float(),this.getScatteringValues(this.newPos,this.rayleighScattering,this.mieScattering,this.extinction),this.$l.sampleTransmittance=t.exp(t.mul(t.neg(this.dt),this.extinction)),this.$l.scatteringNoPhase=t.add(this.rayleighScattering,t.vec3(this.mieScattering)),this.$l.scatteringF=t.div(t.sub(this.scatteringNoPhase,t.mul(this.scatteringNoPhase,this.sampleTransmittance)),this.extinction),this.lumFactor=t.add(this.lumFactor,t.mul(this.transmittance,this.scatteringF)),this.$l.sunTransmittance=this.getValFromTLUT(this.newPos,this.sunDir),this.$l.rayleighInscattering=t.mul(this.rayleighScattering,this.rayleighPhaseValue),this.$l.mieInscattering=t.mul(this.mieScattering,this.miePhaseValue),this.$l.inscattering=t.mul(t.add(this.rayleighInscattering,t.vec3(this.mieInscattering)),this.sunTransmittance),this.$l.scatteringIntegral=t.div(t.sub(this.inscattering,t.mul(this.inscattering,this.sampleTransmittance)),this.extinction),this.lum=t.add(this.lum,t.mul(this.scatteringIntegral,this.transmittance)),this.transmittance=t.mul(this.transmittance,this.sampleTransmittance)})),this.$if(t.greaterThan(this.groundDist,0),(function(){this.$l.hitPos=t.add(this.pos,t.mul(this.rayDir,this.groundDist)),this.$if(t.greaterThan(t.dot(this.pos,this.sunDir),0),(function(){this.hitPos=t.mul(t.normalize(this.hitPos),e._groundRadiusMM),this.lum=t.add(this.lum,t.mul(this.transmittance,t.vec3(e._groundAlbedo),this.getValFromTLUT(this.hitPos,this.sunDir)))}))})),this.fms=t.add(this.fms,t.mul(this.lumFactor,this.invSamples)),this.lumTotal=t.add(this.lumTotal,t.mul(this.lum,this.invSamples))}))}))})),t.main((function(){this.$l.sunCosTheta=t.sub(t.mul(this.$inputs.uv.x,2),1),this.$l.sunTheta=t.acos(t.clamp(this.sunCosTheta,-1,1)),this.$l.height=t.mix(e._groundRadiusMM,e._atmosphereRadiusMM,this.$inputs.uv.y),this.$l.pos=t.vec3(0,this.height,0),this.$l.sunDir=t.normalize(t.vec3(0,this.sunCosTheta,t.neg(t.sin(this.sunTheta)))),this.$l.lum=t.vec3(),this.$l.fms=t.vec3(),this.getMultiScatteringValues(this.pos,this.sunDir,this.lum,this.fms),this.$l.psi=t.div(this.lum,t.sub(1,this.fms)),this.$outputs.outColor=t.vec4(this.psi,1)}))}})),this._bindgroupMultiScatteringLut=t.createBindGroup(this._programMultiScatteringLut.bindGroupLayouts[0]),this._programTransmittanceLut||(this._programTransmittanceLut=t.buildRenderProgram({vertex(t){e.commonVertexShader.call(this)},fragment(t){this.$outputs.outColor=t.vec4(),e.commonFunctions.call(this),t.func("getSunTransmittance",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$if(t.greaterThan(this.rayIntersectSphere(this.pos,this.sunDir,e._groundRadiusMM),0),(function(){this.$return(t.vec3(0))})),this.$l.atmoDist=this.rayIntersectSphere(this.pos,this.sunDir,e._atmosphereRadiusMM),this.$l.t=t.float(0),this.$l.transmittance=t.vec3(1),this.$for(t.int("i"),0,e._sunTransmittanceSteps,(function(){this.$l.newT=t.mul(t.div(t.add(t.float(this.i),.3),e._sunTransmittanceSteps),this.atmoDist),this.$l.dt=t.sub(this.newT,this.t),this.t=this.newT,this.$l.newPos=t.add(this.pos,t.mul(this.sunDir,this.t)),this.$l.rayleighScattering=t.vec3(),this.$l.extinction=t.vec3(),this.$l.mieScattering=t.float(),this.getScatteringValues(this.newPos,this.rayleighScattering,this.mieScattering,this.extinction),this.transmittance=t.mul(this.transmittance,t.exp(t.mul(this.extinction,t.neg(this.dt))))})),this.$return(this.transmittance)})),t.main((function(){this.$l.sunCosTheta=t.sub(t.mul(this.$inputs.uv.x,2),1),this.$l.sunTheta=t.acos(t.clamp(this.sunCosTheta,-1,1)),this.$l.height=t.mix(e._groundRadiusMM,e._atmosphereRadiusMM,this.$inputs.uv.y),this.$l.pos=t.vec3(0,this.height,0),this.$l.sunDir=t.normalize(t.vec3(0,this.sunCosTheta,t.neg(t.sin(this.sunTheta)))),this.$outputs.outColor=t.vec4(this.getSunTransmittance(this.pos,this.sunDir),1)}))}})),this._bindgroupTransmittanceLut=t.createBindGroup(this._programTransmittanceLut.bindGroupLayouts[0])}}class qa{static FOG_TYPE_NONE=0;static FOG_TYPE_LINEAR=1;static FOG_TYPE_EXP=2;static FOG_TYPE_EXP2=3;static FOG_TYPE_SCATTER=4;static BILLBOARD_SPHERICAL=1;static BILLBOARD_SYLINDRAL=2;static USAGE_VERTEX_COLOR="usage_VertexColor";static USAGE_WORLD_MATRIX="usage_WorldMatrix";static USAGE_BONE_MATRICIES="usage_BoneMatrices";static USAGE_INV_BIND_MATRIX="usage_InvBindMatrix";static USAGE_BONE_TEXTURE_SIZE="usage_BoneTextureSize";static USAGE_WORLD_POSITION="usage_WorldPosition";static USAGE_WORLD_NORMAL="usage_WorldNormal";static USAGE_WORLD_TANGENT="usage_WorldTangent";static USAGE_WORLD_BINORMAL="usage_WorldBinormal";static _lightUniformShadow={light:{envLightStrength:1,shadowCascades:1,positionAndRange:new T,directionAndCutoff:new T,diffuseAndIntensity:new T,cascadeDistances:new T,depthBiasValues:new T,shadowCameraParams:new T,depthBiasScales:new T,shadowMatrices:new Float32Array(64)}};static _fogUniforms={fog:{fogType:0,fogColor:null,fogParams:null}};static prepareFragmentShader(t,e){this.setupGlobalUniforms(t,e)}static prepareVertexShader(t,e){this.setupGlobalUniforms(t,e),this.prepareVertexShaderCommon(t,e)}static setupGlobalUniforms(t,e){const i=t.getGlobalScope(),s=t.defineStruct([t.vec4("position"),t.vec4("clipPlane"),t.mat4("viewProjectionMatrix"),t.mat4("viewMatrix"),t.mat4("rotationMatrix"),t.mat4("projectionMatrix"),t.vec4("params"),t.float("worldUnit")]);if(e.renderPass.type===ka){const e=t.defineStruct([t.vec4("positionAndRange"),t.vec4("directionCutoff"),t.mat4("viewMatrix"),t.vec4("depthBias"),t.int("lightType")]),r=t.defineStruct([s("camera"),e("light")]);i.global=r().uniform(0)}else if(e.renderPass.type===Xa){const e=t.defineStruct([s("camera")]);i.global=e().uniform(0)}else if(e.renderPass.type===za){const r=!e.currentShadowLight,a=t.defineStruct([t.int("fogType"),t.vec4("fogColor"),t.vec4("fogParams")]),n=e.currentShadowLight?t.defineStruct([t.int("shadowCascades"),t.vec4("positionAndRange"),t.vec4("directionAndCutoff"),t.vec4("diffuseAndIntensity"),t.vec4("cascadeDistances"),t.vec4("depthBiasValues"),t.vec4("shadowCameraParams"),t.vec4("depthBiasScales"),t.vec4[16]("shadowMatrices"),t.float("envLightStrength")]):t.defineStruct([t.float("envLightStrength"),t.vec4("clusterParams"),t.ivec4("countParams"),t.ivec2("lightIndexTexSize")]),o=t.defineStruct([s("camera"),n("light"),a("fog")]);if(i.global=o().uniform(0),r&&(i.lightBuffer=t.vec4[768]().uniformBuffer(0),i.lightIndexTex=("webgl"===t.getDevice().type?t.tex2D():t.utex2D()).uniform(0)),e.applyFog&&e.scene.env.sky.drawScatteredFog(e)&&(i.aerialPerspectiveLUT=t.tex2D().uniform(0)),e.currentShadowLight){const i=t.getGlobalScope(),s=e.shadowMapInfo.get(e.currentShadowLight),r=s.shadowMap.isTextureCube()?s.shadowMap.isDepth()?i.$builder.texCubeShadow():i.$builder.texCube():s.shadowMap.isTexture2D()?s.shadowMap.isDepth()?i.$builder.tex2DShadow():i.$builder.tex2D():s.shadowMap.isDepth()?i.$builder.tex2DArrayShadow():i.$builder.tex2DArray();s.shadowMap.isDepth()||Y.instance.device.getDeviceCaps().textureCaps.getTextureFormatInfo(s.shadowMap.format).filterable||r.sampleType("unfilterable-float"),i.shadowMap=r.uniform(0)}e.drawEnvLight&&e.env.light.envLight.initShaderBindings(t)}}static prepareVertexShaderCommon(t,e){const i=e.instanceData?.worldMatrices?.length>1,s=!!e.target?.getBoneMatrices(),r=t.getGlobalScope();if(i){const e=Y.instance.device.getDeviceCaps().shaderCaps.maxUniformBufferSize>>6;r.instanceBufferOffset=t.uint().uniform(1),r.worldMatrix=t.mat4[e]().uniformBuffer(3),t.getReflection().tag(qa.USAGE_WORLD_MATRIX,(()=>r.worldMatrix.at(t.add(r.instanceBufferOffset,t.uint(r.$builtins.instanceIndex)))))}else r.worldMatrix=t.mat4().uniform(1).tag(qa.USAGE_WORLD_MATRIX);s&&(r.boneMatrices=t.tex2D().uniform(1).sampleType("unfilterable-float").tag(qa.USAGE_BONE_MATRICIES),r.invBindMatrix=t.mat4().uniform(1).tag(qa.USAGE_INV_BIND_MATRIX),r.boneTextureSize=t.int().uniform(1).tag(qa.USAGE_BONE_TEXTURE_SIZE))}static setCameraUniforms(t,e,i){const s=e.camera.getWorldPosition(),r={position:new T(s.x,s.y,s.z,e.camera.clipPlane?1:0),clipPlane:e.camera.clipPlane??T.zero(),viewProjectionMatrix:e.camera.viewProjectionMatrix,viewMatrix:e.camera.viewMatrix,rotationMatrix:e.camera.getRotationMatrix(),projectionMatrix:e.camera.getProjectionMatrix(),worldUnit:e.scene.worldUnit,params:new T(e.camera.getNearPlane(),e.camera.getFarPlane(),e.flip?-1:1,i?0:1)};t.setValue("global",{camera:r})}static setLightUniformsShadowMap(t,e,i){if(i){const s=e.shadowMapInfo.get(i);t.setValue("global",{light:{positionAndRange:i.positionAndRange,directionCutoff:i.directionAndCutoff,viewMatrix:i.viewMatrix,depthBias:s.depthBiasValues[0],lightType:i.lightType}})}}static setFogUniforms(t,e,i,s,r){this._fogUniforms.fog.fogColor=i,this._fogUniforms.fog.fogParams=s,this._fogUniforms.fog.fogType=e,t.setValue("global",this._fogUniforms),r&&t.setTexture("aerialPerspectiveLUT",r)}static setLightUniforms(t,e,i,s,r,a){t.setValue("global",{light:{clusterParams:i,countParams:s,envLightStrength:e.env.light.strength??0,lightIndexTexSize:new Int32Array([a.width,a.height])}}),t.setBuffer("lightBuffer",r),t.setTexture("lightIndexTex",a),e.drawEnvLight&&e.env.light.envLight.updateBindGroup(t)}static setLightUniformsShadow(t,e,i){const s=e.shadowMapInfo.get(i);this._lightUniformShadow.light.envLightStrength=e.env?.light.strength??0,this._lightUniformShadow.light.shadowCascades=s.numShadowCascades,this._lightUniformShadow.light.positionAndRange.set(i.positionAndRange),this._lightUniformShadow.light.directionAndCutoff.set(i.directionAndCutoff),this._lightUniformShadow.light.diffuseAndIntensity.set(i.diffuseAndIntensity),this._lightUniformShadow.light.cascadeDistances.set(s.cascadeDistances),this._lightUniformShadow.light.depthBiasValues.set(s.depthBiasValues[0]),this._lightUniformShadow.light.shadowCameraParams.set(s.cameraParams),this._lightUniformShadow.light.depthBiasScales.set(s.depthBiasScales),this._lightUniformShadow.light.shadowMatrices.set(s.shadowMatrices),t.setValue("global",this._lightUniformShadow),t.setTexture("shadowMap",s.shadowMap,s.shadowMapSampler),e.drawEnvLight&&e.env.light.envLight.updateBindGroup(t)}static getEnvLightStrength(t){return t.global.light.envLightStrength}static getCameraPosition(t){return t.global.camera.position.xyz}static discardIfClipped(t){const e="lib_discardIfClippped",i=t.$builder,s=this;i.func(e,[],(function(){this.$if(i.notEqual(s.getCameraClipPlaneFlag(this),0),(function(){this.$l.worldPos=s.getWorldPosition(this),this.$l.clipPlane=s.getCameraClipPlane(this),this.$if(i.greaterThan(i.add(i.dot(this.worldPos.xyz,this.clipPlane.xyz),this.clipPlane.w),0),(function(){i.discard()}))}))})),i.getGlobalScope()[e]()}static getCameraClipPlaneFlag(t){return t.global.camera.position.w}static getWorldUnit(t){return t.global.camera.worldUnit}static getCameraClipPlane(t){return t.global.camera.clipPlane}static getCameraParams(t){return t.global.camera.params}static getFogColor(t){return t.global.fog.fogColor}static getClusterParams(t){return t.global.light.clusterParams}static getCountParams(t){return t.global.light.countParams}static getClusteredLightIndexTexture(t){return t.lightIndexTex}static getFogType(t){return t.global.fog.fogType}static getAerialPerspectiveLUT(t){return t.aerialPerspectiveLUT}static getFogParams(t){return t.global.fog.fogParams}static computeFogFactor(t,e,i,s){const r=t.$builder,a="lib_applyFog",n=this;return r.func(a,[r.vec3("viewDir"),r.int("fogType"),r.vec4("fogParams")],(function(){this.$l.distance=r.length(this.viewDir),this.$l.top=r.max(this.viewDir.y,1e-4),this.$l.distance=r.mul(this.$l.distance,r.min(1,r.div(this.fogParams.z,this.top))),this.$if(r.equal(this.fogType,n.FOG_TYPE_LINEAR),(function(){this.$return(r.clamp(r.div(r.sub(this.distance,this.fogParams.x),r.sub(this.fogParams.y,this.fogParams.x)),0,1))})).$elseif(r.equal(this.fogType,n.FOG_TYPE_EXP),(function(){this.$l.e=r.mul(this.distance,this.fogParams.w),this.$return(r.sub(1,r.div(1,r.exp(this.e))))})).$elseif(r.equal(this.fogType,n.FOG_TYPE_EXP2),(function(){this.$l.e=r.mul(this.distance,this.fogParams.w),this.$return(r.sub(1,r.div(1,r.exp(r.mul(this.e,this.e)))))})).$else((function(){this.$return(0)}))})),r.getGlobalScope()[a](e,i,s)}static computeFogFactorForType(t,e,i,s){const r=t.$builder,a="lib_applyFog";return r.func(a,[r.vec3("viewDir"),r.vec4("fogParams")],(function(){this.$l.distance=r.length(this.viewDir),this.$l.top=r.max(this.viewDir.y,1e-4),this.$l.distance=r.mul(this.$l.distance,r.min(1,r.div(this.fogParams.z,this.top))),"linear"===s?this.$return(r.clamp(r.div(r.sub(this.distance,this.fogParams.x),r.sub(this.fogParams.y,this.fogParams.x)),0,1)):"exp"===s?(this.$l.e=r.mul(this.distance,this.fogParams.w),this.$return(r.sub(1,r.div(1,r.exp(this.e))))):"exp2"===s?(this.$l.e=r.mul(this.distance,this.fogParams.w),this.$return(r.sub(1,r.div(1,r.exp(r.mul(this.e,this.e)))))):this.$return(0)})),r.getGlobalScope()[a](e,i)}static getWorldMatrix(t){return t.$query(qa.USAGE_WORLD_MATRIX)}static getViewProjectionMatrix(t){return t.global.camera.viewProjectionMatrix}static getCameraRotationMatrix(t){return t.global.camera.rotationMatrix}static getWorldPosition(t){return t.$query(qa.USAGE_WORLD_POSITION)}static getWorldNormal(t){return t.$query(qa.USAGE_WORLD_NORMAL)}static getWorldTangent(t){return t.$query(qa.USAGE_WORLD_TANGENT)}static getWorldBinormal(t){return t.$query(qa.USAGE_WORLD_BINORMAL)}static getCascadeDistances(t){return t.global.light.cascadeDistances}static getDepthBiasValues(t){return t.global.light.depthBiasValues}static getShadowCameraParams(t){return t.global.light.shadowCameraParams}static getDepthBiasScales(t){return t.global.light.depthBiasScales}static getNumLights(t){return t.global.light.numLights}static getLightTypeForShadow(t){return t.global.light.lightType}static getLightPositionAndRangeForShadow(t){return t.global.light.positionAndRange}static getLightViewMatrixForShadow(t){return t.global.light.viewMatrix}static calculateShadowSpaceVertex(t,e=0){const i=t.$builder,s=qa.getWorldPosition(t);return i.vec4(i.dot(t.global.light.shadowMatrices.at(i.add(i.mul(e,4),0)),s),i.dot(t.global.light.shadowMatrices.at(i.add(i.mul(e,4),1)),s),i.dot(t.global.light.shadowMatrices.at(i.add(i.mul(e,4),2)),s),i.dot(t.global.light.shadowMatrices.at(i.add(i.mul(e,4),3)),s))}static getLightPositionAndRange(t,e){return t.lightBuffer.at(t.$builder.mul(e,3))}static getLightDirectionAndCutoff(t,e){return t.lightBuffer.at(t.$builder.add(t.$builder.mul(e,3),1))}static getLightColorAndIntensity(t,e){return t.lightBuffer.at(t.$builder.add(t.$builder.mul(e,3),2))}static ftransform(t,e=0){const i=t.$builder,s="lib_ftransform",r=this;i.func(s,[],(function(){const t=r.getViewProjectionMatrix(this);if(0===e)this.$l.worldMatrix=this.$query(qa.USAGE_WORLD_MATRIX);else{if(this.$l.rotMat=r.getCameraRotationMatrix(this),this.$l.wMat=this.$query(qa.USAGE_WORLD_MATRIX),e===r.BILLBOARD_SYLINDRAL)this.$l.xaxis=this.rotMat[0].xyz,this.$l.xscale=i.length(this.wMat[0]),this.$l.yaxis=i.vec3(0,1,0),this.$l.yscale=i.length(this.wMat[1]),this.$l.zaxis=i.cross(this.xaxis,this.yaxis),this.$l.xaxis=i.cross(this.yaxis,this.zaxis),this.$l.zscale=i.length(this.wMat[2]);else{if(e!==r.BILLBOARD_SPHERICAL)throw new Error(`ftransform(): invalid billboard mode: ${e}`);this.$l.xaxis=this.rotMat[0].xyz,this.$l.xscale=i.length(this.wMat[0]),this.$l.yaxis=this.rotMat[1].xyz,this.$l.yscale=i.length(this.wMat[1]),this.$l.zaxis=this.rotMat[2].xyz,this.$l.zscale=i.length(this.wMat[2])}this.$l.m0=i.vec4(i.mul(this.xaxis,this.xscale),0),this.$l.m1=i.vec4(i.mul(this.yaxis,this.yscale),0),this.$l.m2=i.vec4(i.mul(this.zaxis,this.zscale),0),this.$l.worldMatrix=i.mat4(this.m0,this.m1,this.m2,this.wMat[3])}const s=i.getGlobalScope().$getVertexAttrib("position");this.$query(qa.USAGE_BONE_MATRICIES)&&(this.$l.skinMatrix=r.getSkinMatrix(this)),this.$l.pos=i.vec4(s.xyz,1),this.$l.skinMatrix&&(this.$l.pos=i.mul(this.$l.skinMatrix,this.$l.pos),this.$l.pos=i.div(this.$l.pos,this.$l.pos.w)),this.$outputs.worldPosition=i.mul(this.worldMatrix,this.$l.pos).tag(qa.USAGE_WORLD_POSITION),r.setClipSpacePosition(this,i.mul(t,this.$outputs.worldPosition));const a=i.getGlobalScope().$getVertexAttrib("normal");if(a){this.$l.norm=i.vec4(a.xyz,0),this.$l.skinMatrix&&(this.$l.norm=i.mul(this.$l.skinMatrix,this.$l.norm)),this.$outputs.worldNormal=i.normalize(i.mul(this.worldMatrix,this.$l.norm).xyz).tag(qa.USAGE_WORLD_NORMAL);const t=i.getGlobalScope().$getVertexAttrib("tangent");t&&(this.$l.tangent=i.vec4(t.xyz,0),this.$l.skinMatrix&&(this.$l.tangent=i.mul(this.$l.skinMatrix,this.$l.tangent)),this.$outputs.worldTangent=i.normalize(i.mul(this.worldMatrix,this.$l.tangent).xyz).tag(qa.USAGE_WORLD_TANGENT),this.$outputs.worldBinormal=i.normalize(i.mul(i.cross(this.$outputs.worldNormal,this.$outputs.worldTangent),t.w)).tag(qa.USAGE_WORLD_BINORMAL))}})),i.getGlobalScope()[s]()}static setClipSpacePosition(t,e){const i=t.$builder,s=this.getCameraParams(t);t.$builtins.position=s?i.mul(e,i.vec4(1,s.z,1,1)):e}static getSkinMatrix(t){const e=t.$builder,i="lib_getBoneMatrixFromTexture";e.func(i,[e.int("boneIndex")],(function(){const t=this.$query(qa.USAGE_BONE_MATRICIES);this.$l.w=e.float(this.$query(qa.USAGE_BONE_TEXTURE_SIZE)),this.$l.pixelIndex=e.float(e.mul(this.boneIndex,4)),this.$l.xIndex=e.mod(this.pixelIndex,this.w),this.$l.yIndex=e.floor(e.div(this.pixelIndex,this.w)),this.$l.u1=e.div(e.add(this.xIndex,.5),this.w),this.$l.u2=e.div(e.add(this.xIndex,1.5),this.w),this.$l.u3=e.div(e.add(this.xIndex,2.5),this.w),this.$l.u4=e.div(e.add(this.xIndex,3.5),this.w),this.$l.v=e.div(e.add(this.yIndex,.5),this.w),"webgl"!==Y.instance.device.type?(this.$l.row1=e.textureSampleLevel(t,e.vec2(this.u1,this.v),0),this.$l.row2=e.textureSampleLevel(t,e.vec2(this.u2,this.v),0),this.$l.row3=e.textureSampleLevel(t,e.vec2(this.u3,this.v),0),this.$l.row4=e.textureSampleLevel(t,e.vec2(this.u4,this.v),0)):(this.$l.row1=e.textureSample(t,e.vec2(this.u1,this.v)),this.$l.row2=e.textureSample(t,e.vec2(this.u2,this.v)),this.$l.row3=e.textureSample(t,e.vec2(this.u3,this.v)),this.$l.row4=e.textureSample(t,e.vec2(this.u4,this.v))),this.$return(e.mat4(this.row1,this.row2,this.row3,this.row4))}));const s="lib_getSkinningMatrix";return e.func(s,[],(function(){const t=this.$query(qa.USAGE_INV_BIND_MATRIX),s=e.getGlobalScope().$getVertexAttrib("blendIndices"),r=e.getGlobalScope().$getVertexAttrib("blendWeights");this.$l.m0=e.getGlobalScope()[i](e.int(s[0])),this.$l.m1=e.getGlobalScope()[i](e.int(s[1])),this.$l.m2=e.getGlobalScope()[i](e.int(s[2])),this.$l.m3=e.getGlobalScope()[i](e.int(s[3])),this.$l.m=e.add(e.mul(this.m0,r.x),e.mul(this.m1,r.y),e.mul(this.m2,r.z),e.mul(this.m3,r.w)),this.$return(e.mul(t,this.m))})),e.getGlobalScope()[s]()}static applyFog(t,e,i){if(i.applyFog){const s=t.$builder;if(i.env.sky.drawScatteredFog(i)){const i="applyAerialPerspective";s.func(i,[s.vec4("color").inout()],(function(){this.$l.viewDir=s.sub(qa.getWorldPosition(this).xyz,qa.getCameraPosition(this)),this.viewDir.y=s.max(this.viewDir.y,0),this.$l.distance=s.mul(s.length(this.viewDir),qa.getWorldUnit(this)),this.$l.sliceDist=s.div(s.mul(qa.getCameraParams(this).y,qa.getWorldUnit(this)),Ya.aerialPerspectiveSliceZ),this.$l.slice0=s.floor(s.div(this.distance,this.sliceDist)),this.$l.slice1=s.add(this.slice0,1),this.$l.factor=s.sub(s.div(this.distance,this.sliceDist),this.slice0),this.$l.viewNormal=s.normalize(this.viewDir),this.$l.zenithAngle=s.asin(this.viewNormal.y),this.$l.horizonAngle=s.atan2(this.viewNormal.z,this.viewNormal.x),this.$l.u0=s.div(s.add(this.slice0,s.div(this.horizonAngle,2*Math.PI)),Ya.aerialPerspectiveSliceZ),this.$l.u1=s.add(this.u0,1/Ya.aerialPerspectiveSliceZ),this.$l.v=s.div(this.zenithAngle,Math.PI/2),this.$l.t0=s.textureSampleLevel(qa.getAerialPerspectiveLUT(this),s.vec2(this.u0,this.v),0),this.$l.t1=s.textureSampleLevel(qa.getAerialPerspectiveLUT(this),s.vec2(this.u1,this.v),0),this.$l.t=s.mix(this.t0,this.t1,this.factor),this.color=s.vec4(s.add(s.mul(this.color.rgb,this.factor),this.t.rgb),this.color.a)})),t[i](e)}else{const i="applyFog";s.func(i,[s.vec4("color").inout()],(function(){this.$l.viewDir=s.sub(qa.getWorldPosition(this).xyz,qa.getCameraPosition(this)),this.$l.fogFactor=qa.computeFogFactor(this,this.viewDir,qa.getFogType(this),qa.getFogParams(this)),this.color=s.vec4(s.mix(this.color.rgb,qa.getFogColor(this).rgb,s.mul(this.fogFactor,this.color.a,this.color.a)),this.color.a)})),t[i](e)}}}}function ja(t,e,i){const s=t.$builder;return i=i||qa.getCameraParams(t),s.div(s.sub(i.y,s.div(s.mul(i.x,i.y),e)),s.sub(i.y,i.x))}function Za(t,e,i){const s=t.$builder;return i=i||qa.getCameraParams(t),s.div(s.mul(i.x,i.y),s.mix(i.y,i.x,e))}function Ka(t,e,i){const s=t.$builder;return i=i||qa.getCameraParams(t),s.div(i.x,s.mix(i.y,i.x,e))}function Qa(t,e){const i=t.$builder;if(!e||!e.$typeinfo.isPrimitiveType()||e.$typeinfo.primitiveType!==At.F32VEC4)throw new Error("decodeNormalizedFloatFromRGBA() failed: parameter type must be vec4");if(!(t&&t instanceof Aa))throw new Error("decodeNormalizedFloatFromRGBA() failed: decodeNormalizedFloatFromRGBA() must be called inside a function");const s="lib_DecodeNormalizedFloatFromRGBA";return i.func(s,[i.vec4("value")],(function(){this.$l.bitShift=i.vec4(1/16777216,1/65536,1/256,1),this.$return(i.dot(this.value,this.bitShift))})),t[s](e)}function Ja(t,e){const i=t.$builder,s="lib_EncodeNormalizedFloatToRGBA";return i.func(s,[i.float("value")],(function(){this.$l.bitShift=i.vec4(16777216,65536,256,1),this.$l.bitMask=i.vec4(0,1/256,1/256,1/256),this.$l.t=i.fract(i.mul(this.value,this.bitShift)),this.$return(i.sub(this.t,i.mul(this.t.xxyz,this.bitMask)))})),i.getGlobalScope()[s](e)}function tn(t,e){const i=t.$builder,s="lib_Decode2HalfFromRGBA";return i.func(s,[i.vec4("value")],(function(){this.$return(i.vec2(i.add(this.value.x,i.div(this.value.y,255)),i.add(this.value.z,i.div(this.value.w,255))))})),i.getGlobalScope()[s](e)}function en(t,e){const i=t.$builder,s="lib_EncodeColorOutput";return i.func(s,[i.vec4("outputColor")],(function(){const t=qa.getCameraParams(this);this.$if(i.notEqual(t.w,0),(function(){this.$return(i.vec4(sn(this,this.outputColor.rgb),this.outputColor.w))})).$else((function(){this.$return(this.outputColor)}))})),i.getGlobalScope()[s](e)}function sn(t,e){const i=t.$builder,s="lib_linearToGamma";return i.func(s,[i.vec3("color")],(function(){this.$return(i.max(i.sub(i.mul(i.pow(this.color,i.vec3(.416666667)),1.055),i.vec3(.055)),i.vec3(0)))})),i.getGlobalScope()[s](e)}new g(0,0,-1),new g(0,-1,0),new g(1,0,0),new g(0,0,1),new g(0,-1,0),new g(-1,0,0),new g(1,0,0),new g(0,0,1),new g(0,1,0),new g(1,0,0),new g(0,0,-1),new g(0,-1,0),new g(1,0,0),new g(0,-1,0),new g(0,0,1),new g(-1,0,0),new g(0,-1,0),new g(0,0,-1);class rn{_vertexLayout;_vertexLayoutOptions;_primitiveType;_indexStart;_indexCount;_defaultIndexCount;_vertexLayoutDirty;static _nextId=0;_id;_bbox;_bboxChangeCallback;constructor(){this._vertexLayout=null,this._vertexLayoutOptions={vertexBuffers:[]},this._primitiveType="triangle-list",this._indexStart=0,this._indexCount=null,this._defaultIndexCount=0,this._vertexLayoutDirty=!1,this._id=++rn._nextId,this._bbox=null,this._bboxChangeCallback=[]}get id(){return this._id}addBoundingboxChangeCallback(t){t&&this._bboxChangeCallback.push(t)}removeBoundingboxChangeCallback(t){const e=this._bboxChangeCallback.indexOf(t);e>=0&&this._bboxChangeCallback.splice(e,1)}get primitiveType(){return this._primitiveType}set primitiveType(t){this._primitiveType=t}get indexStart(){return this._indexStart}set indexStart(t){this._indexStart=t}get indexCount(){return this._indexCount=this._indexCount??this.calcDefaultIndexCount(),this._indexCount}set indexCount(t){this._indexCount=t}removeVertexBuffer(t){for(let e=0;e<this._vertexLayoutOptions.vertexBuffers.length;e++){const i=this._vertexLayoutOptions.vertexBuffers[e];i?.buffer===t&&(i[e]=null,this._vertexLayoutDirty=!0)}}getVertexBuffer(t){return this.checkVertexLayout(),this._vertexLayout.getVertexBuffer(t)}getVertexBufferInfo(t){return this.checkVertexLayout(),this._vertexLayout.getVertexBufferInfo(t)}createAndSetVertexBuffer(t,e,i){const s=Y.instance.device.createVertexBuffer(t,e);return this.setVertexBuffer(s,i)}setVertexBuffer(t,e){return this._vertexLayoutOptions.vertexBuffers.push({buffer:t,stepMode:e}),this._vertexLayoutDirty=!0,t}createAndSetIndexBuffer(t,e){const i=Y.instance.device.createIndexBuffer(t,{dynamic:!!e,managed:!e});return this.setIndexBuffer(i),i}setIndexBuffer(t){this._vertexLayoutOptions.indexBuffer!==t&&(this._vertexLayoutOptions.indexBuffer=t,this._vertexLayoutDirty=!0)}getIndexBuffer(){return this._vertexLayoutOptions.indexBuffer}draw(){this.checkVertexLayout(),this.indexCount>0&&this._vertexLayout?.draw(this._primitiveType,this._indexStart,this.indexCount)}drawInstanced(t){this.checkVertexLayout(),this.indexCount>0&&this._vertexLayout?.drawInstanced(this._primitiveType,this._indexStart,this.indexCount,t)}dispose(){if(this._vertexLayout){const t=this._vertexLayout.vertexBuffers;for(const e in t)t[e]?.buffer?.dispose();this._vertexLayout.indexBuffer?.dispose(),this._vertexLayout.dispose(),this._vertexLayout=null}this._indexCount=null,this._indexStart=0}getBoundingVolume(){return this._bbox}setBoundingVolume(t){if(t!==this._bbox){this._bbox=t;for(const t of this._bboxChangeCallback)t()}}raycast(t){const e=this.getBoundingVolume()?.toAABB();return e?t.bboxIntersectionTestEx(e):null}checkVertexLayout(){this._vertexLayoutDirty&&(this._vertexLayout?.dispose(),this._vertexLayout=Y.instance.device.createVertexLayout(this._vertexLayoutOptions),this._vertexLayoutDirty=!1)}calcDefaultIndexCount(){const t=this.getIndexBuffer();if(t)return Math.max(0,t.length-this._indexStart);const e=this.getVertexBufferInfo("position");return e?Math.max(0,Math.floor((e.buffer.byteLength-e.drawOffset)/e.stride)-this._indexStart):0}}class an{_hash;_renderStates;_srgbOut;_flip;_viewport;_scissor;_destRect;_offsetParams;constructor(){this._hash=null,this._renderStates=null,this._srgbOut=!1,this._flip=!1,this._viewport=null,this._scissor=null,this._destRect=null,this._offsetParams=new T}get viewport(){return this._viewport}set viewport(t){this._viewport=t??null}get scissor(){return this._scissor}set scissor(t){this._scissor=t??null}get destRect(){return this._destRect}set destRect(t){!!this._destRect!=!!t&&this.invalidateHash(),this._destRect=t??null}get srgbOut(){return this._srgbOut}set srgbOut(t){this._srgbOut!==!!t&&(this._srgbOut=!!t,this.invalidateHash())}get renderStates(){return this._renderStates}set renderStates(t){this._renderStates=t}get hash(){return this._hash||(this._hash=`${this.constructor.name}:${this._srgbOut?1:0}:${this._flip?1:0}:${this._destRect?1:0}:${this.calcHash()}`),this._hash}invalidateHash(){this._hash=null}readTexel(t,e,i,s,r,a){const n=t.$builder;if("float"===a)switch(e){case"2d":case"cube":return Y.instance.device.getDeviceCaps().shaderCaps.supportShaderTextureLod?n.textureSampleLevel(i,s,0):n.textureSample(i,s);case"2d-array":return n.textureArraySampleLevel(i,s,r,0);default:return null}else switch(e){case"2d":return n.textureLoad(i,n.ivec2(n.mul(n.vec2(n.textureDimensions(i,0)),s)),0);case"cube":throw new Error("Integer format cube texture not supported");case"2d-array":return n.textureArrayLoad(i,n.ivec2(n.mul(n.vec2(n.textureDimensions(i,0)),s)),r,0);default:return null}}writeTexel(t,e,i,s){return s}setup(t,e){}setUniforms(t,e){}blit2D(t,e,i){const s=Y.instance.device,r=!e&&"webgpu"===s.type,a=cn("2d",this,i?"linear"===i.magFilter||"linear"===i.minFilter||"linear"===i.mipFilter:t.isFilterable(),t.isIntegerFormat()?t.isSignedFormat()?"int":"uint":"float",r);if(a.bindGroup.setTexture("srcTex",t,i),this._destRect){const t=this._viewport?.[2]??e?.getWidth()??s.getBackBufferWidth(),i=this._viewport?.[3]??e?.getHeight()??s.getBackBufferHeight();this._offsetParams.setXYZW(this._destRect[2]/t,this._destRect[3]/i,(this._destRect[2]+2*this._destRect[0])/t-1,(this._destRect[3]+2*this._destRect[1])/i-1),a.bindGroup.setValue("scaleBias",this._offsetParams)}this.setUniforms(a.bindGroup,t),s.setFramebuffer(e??null),s.setViewport(this._viewport),s.setScissor(this._scissor),s.setProgram(a.program),s.setBindGroup(0,a.bindGroup),s.setRenderStates(this._renderStates??ln()),un().draw()}blit2DArray(t,e,i,s){const r=Y.instance.device,a=!e&&"webgpu"===r.type,n=cn("2d-array",this,s?"linear"===s.magFilter||"linear"===s.minFilter||"linear"===s.mipFilter:t.isFilterable(),t.isIntegerFormat()?t.isSignedFormat()?"int":"uint":"float",a);n.bindGroup.setTexture("srcTex",t,s),n.bindGroup.setValue("srcLayer",i),this.setUniforms(n.bindGroup,t),r.setFramebuffer(e??null),r.setViewport(this._viewport),r.setScissor(this._scissor),r.setProgram(n.program),r.setBindGroup(0,n.bindGroup),r.setRenderStates(this._renderStates??ln()),un().draw()}blitCubeMap(t,e,i,s){const r=Y.instance.device,a=!e&&"webgpu"===r.type,n=cn("cube",this,s?"linear"===s.magFilter||"linear"===s.minFilter||"linear"===s.mipFilter:t.isFilterable(),t.isIntegerFormat()?t.isSignedFormat()?"int":"uint":"float",a);n.bindGroup.setTexture("srcTex",t,s),n.bindGroup.setValue("texelSize",1/t.width),n.bindGroup.setValue("cubeFace",i),this.setUniforms(n.bindGroup,t),r.setFramebuffer(e??null),r.setViewport(this._viewport),r.setScissor(this._scissor),r.setProgram(n.program),r.setBindGroup(0,n.bindGroup),r.setRenderStates(this._renderStates??ln()),un().draw()}blit(t,e,i,s){const r=Y.instance.device;if(r.pushDeviceStates(),e){const a=e.isFramebuffer()?e:r.createFrameBuffer([e],null),n=e.isFramebuffer()?e.getColorAttachments()?.[0]:e;if(t.isTexture2D()){if(!n?.isTexture2D()&&!n?.isTexture2DArray())throw new Error("Blitter.blit() failed: invalid destination texture type");n.isTexture2DArray()&&a.setColorAttachmentLayer(0,i||0),this.blit2D(t,a,s)}else if(t.isTexture2DArray()){if(!n?.isTexture2D()&&!n.isTexture2DArray())throw new Error("Blitter.blit() failed: invalid destination texture type");if(n.isTexture2D())this.blit2DArray(t,a,i||0,s);else{if(n.depth!==t.depth)throw new Error("Blitter.blit() failed: can not blit between texture 2d arrays with different array size");for(let e=0;e<t.depth;e++)a.setColorAttachmentLayer(0,e),this.blit2DArray(t,a,e,i)}}else{if(!t.isTextureCube())throw new Error("Blitter.blit() failed: invalid texture type");if(!n.isTextureCube()&&!n.isTexture2D())throw new Error("Blitter.blit() failed: invalid destination texture type");if(n.isTextureCube())for(let e=0;e<6;e++)a.setColorAttachmentCubeFace(0,e),this.blitCubeMap(t,a,e,i);else this.blitCubeMap(t,a,i||0,s)}a&&a!==e&&a.dispose()}else if(t.isTexture2D())this.blit2D(t,null,s);else if(t.isTexture2DArray())this.blit2DArray(t,null,i||0,s);else{if(!t.isTextureCube())throw new Error("Blitter.blit() failed: invalid texture type");this.blitCubeMap(t,null,i||0,s)}r.popDeviceStates()}}const nn={};let on=null,hn=null;function un(){if(!on){on=new rn;const t=Y.instance.device.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]));on.setVertexBuffer(t),on.indexCount=4,on.indexStart=0,on.primitiveType="triangle-strip"}return on}function ln(){return hn||(hn=Y.instance.device.createRenderStateSet(),hn.useDepthState().enableTest(!1).enableWrite(!1),hn.useRasterizerState().setCullMode("none")),hn}function cn(t,e,i,s,r){const a=`${t}:${e.hash}:${i}:${s}:${r?1:0}`;let n=nn[a];return void 0===n&&(n=function(t,e,i,s,r,a){const n=Y.instance.device.buildRenderProgram({vertex(i){this.$inputs.pos=i.vec2().attrib("position"),this.$outputs.uv=i.vec2(),a&&(this.scaleBias=i.vec4().uniform(0)),e.setup(this,t),i.main((function(){this.$builtins.position=i.vec4(this.$inputs.pos,1,1),this.$outputs.uv="cube"===t?i.mul(i.vec2(1,-1),this.$inputs.pos.xy):i.add(i.mul(this.$inputs.pos.xy,.5),i.vec2(.5)),"webgpu"===Y.instance.device.type&&(this.$builtins.position.y=i.neg(this.$builtins.position.y)),a&&(this.$l.xy=i.add(i.mul(this.$builtins.position.xy,this.scaleBias.xy),this.scaleBias.zw),this.$builtins.position=i.vec4(this.xy,1,1))}))},fragment(a){switch(t){case"2d":this.srcTex="int"===s?a.itex2D().sampleType("sint").uniform(0):"uint"===s?a.utex2D().sampleType("uint").uniform(0):a.tex2D().sampleType(i?"float":"unfilterable-float").uniform(0);break;case"2d-array":this.srcTex="int"===s?a.itex2DArray().sampleType("sint").uniform(0):"uint"===s?a.utex2DArray().sampleType("uint").uniform(0):a.tex2DArray().sampleType(i?"float":"unfilterable-float").uniform(0),this.srcLayer=a.int().uniform(0);break;case"cube":this.srcTex="int"===s?a.itexCube().sampleType("sint").uniform(0):"uint"===s?a.utexCube().sampleType("uint").uniform(0):a.texCube().sampleType(i?"float":"unfilterable-float").uniform(0),this.texelSize=a.float().uniform(0),this.cubeFace=a.int().uniform(0);break;default:throw new Error(`invalid blit type: ${t}`)}this.$outputs.outColor=a.vec4(),e.setup(this,t),a.main((function(){"cube"===t?(this.uv=a.vec3(),this.$if(a.equal(this.cubeFace,0),(function(){this.uv=a.vec3(1,this.$inputs.uv.y,a.neg(this.$inputs.uv.x))})).$elseif(a.equal(this.cubeFace,1),(function(){this.uv=a.vec3(-1,this.$inputs.uv.y,this.$inputs.uv.x)})).$elseif(a.equal(this.cubeFace,2),(function(){this.uv=a.vec3(this.$inputs.uv.x,1,a.neg(this.$inputs.uv.y))})).$elseif(a.equal(this.cubeFace,3),(function(){this.uv=a.vec3(this.$inputs.uv.x,-1,this.$inputs.uv.y)})).$elseif(a.equal(this.cubeFace,4),(function(){this.uv=a.vec3(this.$inputs.uv.x,this.$inputs.uv.y,1)})).$else((function(){this.uv=a.vec3(a.neg(this.$inputs.uv.x),this.$inputs.uv.y,-1)}))):this.uv=this.$inputs.uv,r&&(this.uv.y=a.sub(1,this.uv.y)),this.$l.outTexel=e.filter(this,t,this.srcTex,this.uv,"2d"===t?null:this.srcLayer,s),this.$outputs.outColor=e.writeTexel(this,t,this.$inputs.uv,this.outTexel),e.srgbOut&&(this.$outputs.outColor=a.vec4(sn(this,this.$outputs.outColor.rgb),this.$outputs.outColor.a))}))}});return n?{program:n,bindGroup:Y.instance.device.createBindGroup(n.bindGroupLayouts[0])}:null}(t,e,i,s,r,!!e.destRect)||null,nn[a]=n),n}class dn extends an{filter(t,e,i,s,r,a){return this.readTexel(t,e,i,s,r,a)}calcHash(){return""}}new g(0,0,-1),new g(0,-1,0),new g(1,0,0),new g(0,0,1),new g(0,-1,0),new g(-1,0,0),new g(1,0,0),new g(0,0,1),new g(0,1,0),new g(1,0,0),new g(0,0,-1),new g(0,-1,0),new g(1,0,0),new g(0,-1,0),new g(0,0,1),new g(-1,0,0),new g(0,-1,0),new g(0,0,-1);class pn extends F{constructor(t,e){super(t,e)}behindPlane(t){return this.toAABB().behindPlane(t)}clone(){return new pn(this)}transform(t){return new pn(F.transform(this,t))}outsideFrustum(t){return(t instanceof L?this.getClipStateWithFrustum(t):this.getClipState(t))===c.NOT_CLIPPED}toAABB(){return this}}class _n extends rn{_options;constructor(t){super(),this._options=this.createDefaultOptions(),this.create(t)}create(t){return t&&(this._options=this.createDefaultOptions(),Object.assign(this._options,t)),this._create()}createDefaultOptions(){return{needNormal:!0,needTangent:!1,needUV:!0}}}class mn extends _n{constructor(t){super(t)}createDefaultOptions(){const t=super.createDefaultOptions();return t.size=1,t}_createArrays(t,e,i,s,r,a,n,o,h,u){const l=this._options.needTangent,c=this._options.needNormal||l,d=this._options.needUV,p=d?[0,0,0,1,1,1,1,0]:null,_=[r,h,n,r,h,u,o,h,u,o,h,n],m=c?[0,1,0,0,1,0,0,1,0,0,1,0]:null,f=[r,h,u,r,a,u,o,a,u,o,h,u],g=c?[0,0,1,0,0,1,0,0,1,0,0,1]:null,x=[o,h,u,o,a,u,o,a,n,o,h,n],T=c?[1,0,0,1,0,0,1,0,0,1,0,0]:null,b=[o,h,n,o,a,n,r,a,n,r,h,n],E=c?[0,0,-1,0,0,-1,0,0,-1,0,0,-1]:null,y=[r,h,n,r,a,n,r,a,u,r,h,u],v=c?[-1,0,0,-1,0,0,-1,0,0,-1,0,0]:null,S=[r,a,u,r,a,n,o,a,n,o,a,u],w=c?[0,-1,0,0,-1,0,0,-1,0,0,-1,0]:null;s&&s.push(0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23),t&&t.push(..._,...f,...x,...b,...y,...S),c&&e&&e.push(...m,...g,...T,...E,...v,...w),d&&i&&i.push(...p,...p,...p,...p,...p,...p),this.primitiveType="triangle-list"}_create(){const t=this._options.needNormal,e=this._options.needUV,i=this._options.sizeX??this._options.size??1,s=this._options.sizeY??this._options.size??1,r=this._options.sizeZ??this._options.size??1,a=-(this._options.anchorX??0)*i,n=a+i,o=-(this._options.anchorY??0)*s,h=o+s,u=-(this._options.anchorZ??0)*r,l=u+r,c=[],d=[],p=t?[]:null,_=e?[]:null;return this._createArrays(c,p,_,d,a,o,u,n,h,l),this.createAndSetVertexBuffer("position_f32x3",new Float32Array(c)),p&&this.createAndSetVertexBuffer("normal_f32x3",new Float32Array(p)),_&&this.createAndSetVertexBuffer("tex0_f32x2",new Float32Array(_)),this.createAndSetIndexBuffer(new Uint16Array(d)),this.setBoundingVolume(new pn(new g(a,o,u),new g(n,h,l))),this.indexCount=d.length,!0}}class fn extends _n{constructor(t){super(t)}createDefaultOptions(){const t=super.createDefaultOptions();return t.size=1,t.needNormal=!1,t.needTangent=!1,t.needUV=!1,t}_createArrays(t,e,i,s,r,a,n,o){const h=[i,n,r,i,n,o,a,n,o,a,n,r],u=[i,s,o,i,s,r,a,s,r,a,s,o];e&&e.push(0,1,1,2,2,3,3,0,0,5,1,4,2,7,3,6,6,5,5,4,4,7,7,6),t&&t.push(...h,...u),this.primitiveType="line-list"}_create(){const t=this._options.sizeX??this._options.size??1,e=this._options.sizeY??this._options.size??1,i=this._options.sizeZ??this._options.size??1,s=-(this._options.anchorX??0)*t,r=s+t,a=-(this._options.anchorY??0)*e,n=a+e,o=-(this._options.anchorZ??0)*i,h=o+i,u=[],l=[];return this._createArrays(u,l,s,a,o,r,n,h),this.createAndSetVertexBuffer("position_f32x3",new Float32Array(u)),this.createAndSetIndexBuffer(new Uint16Array(l)),this.setBoundingVolume(new pn(new g(s,a,o),new g(r,n,h))),this.indexCount=l.length,!0}}class gn extends _n{constructor(t){super(t)}createDefaultOptions(){const t=super.createDefaultOptions();return t.numSlices=40,t.numSegments=16,t.outerRadius=10,t.innerRadius=3,t.radialDetail=20,t}_createArrays(t,e,i,s){this.primitiveType="triangle-list";const r=this._options.numSlices,a=this._options.numSegments,n=this._options.outerRadius,o=this._options.innerRadius;for(let s=0;s<=r;s++){const h=s%r/r*Math.PI*2,u=n*Math.cos(h),l=0,c=n*Math.sin(h);for(let h=0;h<=a;h++){const d=h%a/a*Math.PI*2,p=s*(a+1)+h,_=1+o*Math.cos(d)/n,m=o*Math.sin(d);t[3*p+0]=u*_,t[3*p+1]=l*_+m,t[3*p+2]=c*_;const f=t[3*p+0]-u,g=t[3*p+1]-l,x=t[3*p+2]-c,T=Math.sqrt(f*f+g*g+x*x);e[3*p+0]=f/T,e[3*p+1]=g/T,e[3*p+2]=x/T,i[2*p+0]=h/a,i[2*p+1]=s/r}}for(let t=0;t<r;t++)for(let e=0;e<a;e++)s.push(t*(a+1)+e),s.push((t+1)*(a+1)+e+1),s.push((t+1)*(a+1)+e),s.push(t*(a+1)+e),s.push(t*(a+1)+e+1),s.push((t+1)*(a+1)+e+1)}_create(){const t=[],e=[],i=[],s=[];this._createArrays(t,i,s,e),this.createAndSetVertexBuffer("position_f32x3",new Float32Array(t)),this.createAndSetVertexBuffer("normal_f32x3",new Float32Array(i)),this.createAndSetVertexBuffer("tex0_f32x2",new Float32Array(s)),this.createAndSetIndexBuffer(new Uint16Array(e));const r=this._options.outerRadius+this._options.innerRadius,a=this._options.innerRadius;return this.setBoundingVolume(new pn(new g(-r,-a,-r),new g(r,a,r))),this.indexCount=e.length,!0}}class xn extends _n{constructor(t){super(t)}createDefaultOptions(){const t=super.createDefaultOptions();return t.size=1,t}_createArrays(t,e,i,s,r,a){i?.push(0,1,0,0,1,0,1,1),t?.push(0,0,a,r,0,a,r,0,0,0,0,0),s?.push(0,1,2,0,2,3),e?.push(0,1,0,0,1,0,0,1,0,0,1,0),this.primitiveType="triangle-list"}_create(){const t=this._options.needNormal,e=this._options.needUV,i=Math.abs(this._options.sizeX||this._options.size)||1,s=Math.abs(this._options.sizeY||this._options.size)||1,r=[],a=[],n=t?[]:null,o=e?[]:null;return this._createArrays(r,n,o,a,i,s),this.createAndSetVertexBuffer("position_f32x3",new Float32Array(r)),n&&this.createAndSetVertexBuffer("normal_f32x3",new Float32Array(n)),o&&this.createAndSetVertexBuffer("tex0_f32x2",new Float32Array(o)),this.createAndSetIndexBuffer(new Uint16Array(a)),this.setBoundingVolume(new pn(new g(0,0,0),new g(i,0,s))),this.indexCount=a.length,!0}}class Tn{_parent;_children;_position;_scaling;_rotation;_localMatrix;_worldMatrix;_worldMatrixDet;_invWorldMatrix;_tmpLocalMatrix;_tmpWorldMatrix;_transformTag;constructor(){this._parent=null,this._children=[];const t=()=>{this._onTransformChanged(!0)};this._position=new x(0,0,0),this._position.callback=t,this._scaling=new x(1,1,1),this._scaling.callback=t,this._rotation=new E,this._rotation.callback=t,this._worldMatrix=null,this._worldMatrixDet=null,this._invWorldMatrix=null,this._localMatrix=null,this._transformTag=0,this._tmpLocalMatrix=v.identity(),this._tmpWorldMatrix=v.identity()}get parent(){return this._parent}set parent(t){(t=t||null)!==this._parent&&this._setParent(t)}get children(){return this._children}resetTransform(){return this._position.setXYZ(0,0,0),this._rotation.identity(),this._scaling.setXYZ(1,1,1),this}get position(){return this._position}set position(t){this._position.setXYZ(t[0],t[1],t[2])}worldToThis(t,e){return t instanceof g?(e=e||new g,this.invWorldMatrix.transformPointAffine(t,e),e):(e=e||new T,this.invWorldMatrix.transformAffine(t,e),e)}otherToThis(t,e,i){return this.worldToThis(t.thisToWorld(e,i),i)}thisToWorld(t,e){return t instanceof g?(e=e||new g,this.worldMatrix.transformPointAffine(t,e),e):(e=e||new T,this.worldMatrix.transformAffine(t,e),e)}thisToOther(t,e,i){return t.worldToThis(this.thisToWorld(e,i),i)}getWorldPosition(){return new g(this.worldMatrix.m03,this.worldMatrix.m13,this.worldMatrix.m23)}moveBy(t){return this._position.addBy(t),this}scaleBy(t){return this._scaling.mulBy(t),this}get scale(){return this._scaling}set scale(t){this._scaling.setXYZ(t[0],t[1],t[2])}get rotation(){return this._rotation}set rotation(t){this._rotation.setXYZW(t[0],t[1],t[2],t[3])}setLocalTransform(t){return t.decompose(this._scaling,this._rotation,this._position),this}get localMatrix(){return this._localMatrix||(this._localMatrix=this._tmpLocalMatrix,this._localMatrix.scaling(this._scaling).rotateLeft(new v(this._rotation)).translateLeft(this._position)),this._localMatrix}get worldMatrix(){return this._worldMatrix||(this._worldMatrix=this._tmpWorldMatrix,this._parent?v.multiplyAffine(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this._worldMatrix.set(this.localMatrix)),this._worldMatrix}get worldMatrixDet(){return null===this._worldMatrixDet&&(this._worldMatrixDet=this.worldMatrix.det()),this._worldMatrixDet}get invWorldMatrix(){return this._invWorldMatrix||(this._invWorldMatrix=v.invertAffine(this.worldMatrix)),this._invWorldMatrix}lookAt(t,e,i){return v.lookAt(t,e,i).decompose(this._scaling,this._rotation,this._position),this}reparent(t){return this.parent=t,this}getTag(){return this._transformTag}_onTransformChanged(t){if(t&&(this._localMatrix=null),this._worldMatrix){this._worldMatrix=null,this._invWorldMatrix=null,this._transformTag++;for(const t of this._children)t._onTransformChanged(!1)}this._worldMatrixDet=null}_setParent(t){this._parent!==t&&(this._parent&&this._parent._children.splice(this._parent._children.indexOf(this),1),this._parent=t,this._parent&&this._parent._children.push(this),this._onTransformChanged(!1))}}class bn extends Tn{static CLIP_INHERITED=-1;static CLIP_DISABLED=0;static CLIP_ENABLED=1;static SHOW_INHERITED=-1;static SHOW_HIDE=0;static SHOW_DEFAULT=1;static PICK_INHERITED=-1;static PICK_DISABLED=0;static PICK_ENABLED=1;static BBOXDRAW_INHERITED=-1;static BBOXDRAW_DISABLED=0;static BBOXDRAW_LOCAL=1;static BBOXDRAW_WORLD=2;_clipMode;_renderOrder;_boxDrawMode;_visible;_pickMode;_name;_scene;_bv;_bvDirty;_bvWorld;constructor(t){super(),this._scene=t,this._name="",this._bv=null,this._bvWorld=null,this._bvDirty=!0,this._clipMode=bn.CLIP_ENABLED,this._boxDrawMode=bn.BBOXDRAW_DISABLED,this._visible=bn.SHOW_DEFAULT,this._pickMode=bn.PICK_DISABLED,t&&this!==t.rootNode&&this.reparent(t.rootNode)}get name(){return this._name}set name(t){this._name=t||""}get scene(){return this._scene}get attached(){return!!this._scene?.rootNode?.isParentOf(this)}hasChild(t){return this._children.indexOf(t)>=0}removeChildren(){for(;this._children.length;)this._children[0].remove()}isParentOf(t){for(;t&&t!==this;)t=t.parent;return t===this}remove(){return this.parent=null,this}traverse(t,e){if(e){for(let i=this._children.length-1;i>=0;i--)this._children[i].traverse(t,e);t.visit(this)}else{t.visit(this);for(const e of this._children)e.traverse(t)}}iterate(t){t(this);for(const e of this._children)e.iterate(t)}isGraphNode(){return!1}isLight(){return!1}isMesh(){return!1}isTerrain(){return!1}isCamera(){return!1}isPunctualLight(){return!1}dispose(){this.remove(),this.removeChildren()}computeBoundingVolume(t){return t}getBoundingVolume(){return this._bvDirty&&(this._bv=this.computeBoundingVolume(this._bv)||null,this._bvDirty=!1),this._bv}setBoundingVolume(t){t!==this._bv&&(this._bv=t,this.invalidateBoundingVolume())}getWorldBoundingVolume(){return this._bvWorld||(this._bvWorld=this.getBoundingVolume()?.transform(this.worldMatrix)??null),this._bvWorld}invalidateBoundingVolume(){this._bvDirty=!0,this.invalidateWorldBoundingVolume()}invalidateWorldBoundingVolume(){this._bvWorld=null,this._scene?.invalidateNodePlacement(this)}get computedClipMode(){if(this._clipMode===bn.CLIP_INHERITED){let t=this.parent;for(;t&&!t.isGraphNode();)t=t.parent;return t?.computedClipMode??bn.CLIP_ENABLED}return this._clipMode}get clipMode(){return this._clipMode}set clipMode(t){this._clipMode=t}get hidden(){if(this._visible===bn.SHOW_INHERITED){let t=this.parent;for(;t&&!t.isGraphNode();)t=t.parent;return t?.hidden??!1}return this._visible===bn.SHOW_HIDE}get showState(){return this._visible}set showState(t){if(t!==this._visible){const e=this.hidden;this._visible=t,e!==this.hidden&&this.notifyHiddenChanged()}}get pickable(){if(this._pickMode===bn.PICK_INHERITED){let t=this.parent;for(;t&&!t.isGraphNode();)t=t.parent;return t?.pickable??!1}return this._pickMode!==bn.PICK_DISABLED}get pickMode(){return this._pickMode}set pickMode(t){this._pickMode=t}get computedBoundingBoxDrawMode(){if(this._boxDrawMode===bn.BBOXDRAW_INHERITED){let t=this.parent;for(;t&&!t.isGraphNode();)t=t.parent;return t?.computedBoundingBoxDrawMode??bn.BBOXDRAW_DISABLED}return this._boxDrawMode}get boundingBoxDrawMode(){return this._boxDrawMode}set boundingBoxDrawMode(t){this._boxDrawMode=t}_setParent(t){if(t!==this._parent){const e=this.attached?this.scene:null,i=t?.attached?t.scene:null,s=e&&e!==i,r=i&&e!==i;s&&this._willDetach(),r&&this._willAttach(),super._setParent(t),s&&this._detached(),r&&this._attached()}}_onTransformChanged(t){super._onTransformChanged(t),this.invalidateWorldBoundingVolume()}_willAttach(){}_attached(){}_willDetach(){}_detached(){}notifyHiddenChanged(){this._visibleChanged();for(const t of this._children)t.isGraphNode()&&t.showState===bn.SHOW_INHERITED&&t.notifyHiddenChanged()}_visibleChanged(){}}class En extends bn{constructor(t){super(t),this._renderOrder=0}get renderOrder(){return this._renderOrder}set renderOrder(t){this._renderOrder=t}getName(){return this._name}isGraphNode(){return!0}getXForm(){return this}getBoneMatrices(){return null}getInvBindMatrix(){return null}getSortDistance(t){const e=t.worldMatrix,i=this.worldMatrix,s=e.m03-i.m03,r=e.m13-i.m13,a=e.m23-i.m23;return s*s+r*r*a*a}isBatchable(){return!1}}var yn;!function(t){t[t.PPP=0]="PPP",t[t.PPN=1]="PPN",t[t.PNP=2]="PNP",t[t.PNN=3]="PNN",t[t.NPP=4]="NPP",t[t.NPN=5]="NPN",t[t.NNP=6]="NNP",t[t.NNN=7]="NNN"}(yn||(yn={}));class vn{_chunk;_position;_references;_nodes;_box;_boxLoosed;constructor(){this._chunk=null,this._position=0,this._references=0,this._nodes=[],this._box=null,this._boxLoosed=null}getNodes(){return this._nodes}getLevel(){return this._chunk.getLevel()}addNode(t){t&&this._nodes.indexOf(t)<0&&this._nodes.push(t)}removeNode(t){const e=this._nodes.indexOf(t);e>=0&&this._nodes.splice(e,1)}clearNodes(){this._nodes=[]}setChunk(t){console.assert(!!t,"Invalid chunk"),this._chunk=t}getChunk(){return this._chunk}setPosition(t){this._position=t}getPosition(){return this._position}invalidateBox(){this._box=null,this.getParent()?.invalidateBox()}getBox(){if(null===this._box){const t=new F;t.beginExtend();for(let e=0;e<8;e++){const i=this.getChild(e);if(i){const e=i.getBox();e&&(t.extend(e.minPoint),t.extend(e.maxPoint))}}for(const e of this._nodes)if(!e.isLight()){const i=e.getWorldBoundingVolume()?.toAABB();i&&(t.extend(i.minPoint),t.extend(i.maxPoint))}t.isValid()&&(this._box=t)}return this._box}getBoxLoosed(){if(null===this._boxLoosed){console.assert(!!this._chunk,"Invalid chunk");const t=this._chunk.getDimension(),e=this._chunk.getNodeSize(),i=.5*this._chunk.getWorldSize(),s=this._position%t,r=Math.floor(this._position/t)%t,a=Math.floor(Math.floor(this._position/t)/t),n=new g(s-.5,r-.5,a-.5).scaleBy(e).subBy(new g(i,i,i)),o=new g(n.x+2*e,n.y+2*e,n.z+2*e);this._boxLoosed=new F(n,o)}return this._boxLoosed}getMinPoint(){console.assert(!!this._chunk,"Invalid chunk");const t=this._chunk.getDimension(),e=this._chunk.getNodeSize(),i=.5*this._chunk.getWorldSize(),s=this._position%t,r=Math.floor(this._position/t)%t,a=Math.floor(Math.floor(this._position/t)/t);return new g(s,r,a).scaleBy(e).subBy(new g(i,i,i))}getMaxPoint(){console.assert(!!this._chunk,"Invalid chunk");const t=this._chunk.getDimension(),e=this._chunk.getNodeSize(),i=.5*this._chunk.getWorldSize(),s=this._position%t+1,r=Math.floor(this._position/t)%t+1,a=Math.floor(Math.floor(this._position/t)/t)+1;return new g(s,r,a).scaleBy(e).subBy(new g(i,i,i))}getMinPointLoosed(){const t=.5*this._chunk.getNodeSize();return this.getMinPoint().subBy(new g(t,t,t))}getMaxPointLoosed(){const t=.5*this._chunk.getNodeSize();return this.getMaxPoint().addBy(new g(t,t,t))}getReference(){return this._references}getChild(t){console.assert(!!this._chunk,"Invalid chunk");const e=this._chunk.getNext();return e?e.getNode(this._chunk.getChildIndex(this._position,t)):null}getOrCreateChild(t){console.assert(!!this._chunk,"Invalid chunk");const e=this._chunk.getNext();return e?e.getOrCreateNode(this._chunk.getChildIndex(this._position,t)):null}getParent(){console.assert(!!this._chunk,"Invalid chunk");const t=this._chunk.getPrev();return t?t.getNode(this._chunk.getParentIndex(this._position)):null}getOrCreateParent(){console.assert(!!this._chunk,"Invalid chunk");const t=this._chunk.getPrev();return t?t.getOrCreateNode(this._chunk.getParentIndex(this._position)):null}createChildren(){this.getOrCreateChild(yn.PPP),this.getOrCreateChild(yn.PPN),this.getOrCreateChild(yn.PNP),this.getOrCreateChild(yn.PNN),this.getOrCreateChild(yn.NPP),this.getOrCreateChild(yn.NPN),this.getOrCreateChild(yn.NNP),this.getOrCreateChild(yn.NNN)}tidy(){this._references=8;for(let t=0;t<8;t++){const e=this.getChild(t);e&&!e.tidy()||--this._references}return 0===this._nodes.length&&0===this._references&&(this._chunk.freeNodeByIndex(this._position),!0)}traverse(t){if(t.visit(this))for(let e=0;e<8;e++){const i=this.getChild(e);i&&i.traverse(t)}}}class Sn{_level;_dimension;_nodeSize;_prev;_next;_octree;_nodeMap;constructor(t){this._octree=t,this._level=0,this._dimension=0,this._nodeSize=0,this._next=null,this._prev=null,this._nodeMap=new Map}getNode(t){return this._nodeMap.get(t)||null}getOrCreateNode(t){let e=this.getNode(t);return e||(e=new vn,e.setChunk(this),e.setPosition(t),this._nodeMap.set(t,e)),e}getOrCreateNodeChain(t){const e=this.getOrCreateNode(t);return this._prev&&this._prev.getOrCreateNodeChain(this.getParentIndex(t)),e}freeNodeByIndex(t){const e=this._nodeMap.get(t);e&&(e.clearNodes(),this._nodeMap.delete(t))}freeNode(t){t&&(console.assert(t.getChunk()===this,"Invalid chunk"),this.freeNodeByIndex(t.getPosition()))}clearNodes(){for(const t of this._nodeMap.keys())this._nodeMap.get(t).clearNodes(),this._nodeMap.delete(t)}getChildIndex(t,e){const i=this._dimension;let s=t%i*2,r=Math.floor(t/i)%i*2,a=2*Math.floor(Math.floor(t/i)/i);switch(e){case yn.PPP:++s,++r,++a;break;case yn.PPN:++s,++r;break;case yn.PNP:++s,++a;break;case yn.PNN:++s;break;case yn.NPP:++r,++a;break;case yn.NPN:++r;break;case yn.NNP:++a;break;case yn.NNN:break;default:return console.assert(!1,"getChildIndex: Got invalid index"),0}const n=2*i;return a*n*n+r*n+s}getParentIndex(t){const e=this._dimension,i=e>>1;return(t%e>>1)+(Math.floor(t/e)%e>>1)*i+(Math.floor(Math.floor(t/e)/e)>>1)*i*i}getNodeSize(){return this._nodeSize}getWorldSize(){return this._octree.getRootSize()}getDimension(){return this._dimension}getLevel(){return this._level}empty(){return 0===this._nodeMap.size}getNext(){return this._next}getPrev(){return this._prev}getOctree(){return this._octree}setLevel(t){this._level=t}setDimension(t){this._dimension=t}setNodeSize(t){this._nodeSize=t}setNext(t){this._next=t}setPrev(t){this._prev=t}}class wn{_scene;_chunks;_rootSize;_leafSize;_rootNode;_nodeMap;constructor(t,e=4096,i=64){this._scene=t,this._chunks=[],this._rootSize=0,this._leafSize=0,this._rootNode=null,this._nodeMap=new WeakMap,this.initialize(e,i)}initialize(t,e){console.assert(t>=e&&e>0,"Invalid rootSize or leafSize for octree"),this.finalize(),this._rootSize=t,this._leafSize=e;let i=1;for(;t>=2*e;e*=2,++i);for(let e=0;e<i;++e,t*=.5){const i=new Sn(this);i.setLevel(e),i.setNodeSize(t),i.setDimension(1<<e),this._chunks.push(i),e>0&&(this._chunks[e-1].setNext(i),i.setPrev(this._chunks[e-1]))}}finalize(){this._chunks=[],this._rootSize=0,this._leafSize=0,this._rootNode=null,this._nodeMap=new WeakMap}getScene(){return this._scene}getRootSize(){return this._rootSize}getLeafSize(){return this._leafSize}locateNodeChain(t,e,i){let s=this._chunks.length-1;for(;s&&this._chunks[s].getNodeSize()<4*i;)--s;const r=this._chunks[s].getDimension(),a=1/this._chunks[s].getNodeSize();let n=Math.floor((e.x+.5*this._rootSize)*a),o=Math.floor((e.y+.5*this._rootSize)*a),h=Math.floor((e.z+.5*this._rootSize)*a);(n>=r||o>=r||h>=r)&&(s=0,n=0,o=0,h=0);const u=n+o*r+h*r*r;return t&&t.getChunk().getLevel()===s&&t.getPosition()===u?t:this._chunks[s].getOrCreateNodeChain(u)}getRootNode(){return this._rootNode||(this._rootNode=this._chunks[0].getOrCreateNode(0)),this._rootNode}getNumChunks(){return this._chunks.length}getChunk(t){return this._chunks[t]}placeNode(t){const e=this._nodeMap.get(t)||null;let i=this.getRootNode();if(t.computedClipMode===En.CLIP_ENABLED){const s=t.getWorldBoundingVolume()?.toAABB();if(s&&s.isValid()){const t=s.center,r=s.extents,a=Math.max(Math.max(r.x,r.y),r.z);i=this.locateNodeChain(e,t,a)||this.getRootNode()}}e!==i&&(e?.removeNode(t),i?.addNode(t),this._nodeMap.set(t,i),e?.invalidateBox(),i?.invalidateBox())}removeNode(t){if(t.isGraphNode()){const e=this._nodeMap.get(t)||null;e&&(e.removeNode(t),e.invalidateBox(),this._nodeMap.delete(t))}}}class Cn{_primaryCamera;_camera;_skipClipTest;_renderQueue;_renderPass;constructor(t,e,i,s){this._primaryCamera=s,this._camera=e,this._renderQueue=i,this._skipClipTest=!1,this._renderPass=t}get camera(){return this._camera}set camera(t){this._camera=t||null}get primaryCamera(){return this._primaryCamera}get renderPass(){return this._renderPass}get renderQueue(){return this._renderQueue}get frustum(){return this._camera?.frustum||null}push(t,e,i){this.renderQueue.push(t,e,i)}visit(t){return t instanceof vn?this.visitOctreeNode(t):t.isMesh()?this.visitMesh(t):t.isTerrain()?this.visitTerrain(t):t.isPunctualLight()?this.visitPunctualLight(t):void 0}visitPunctualLight(t){if(!t.hidden){if(this.getClipStateWithNode(t)!==c.NOT_CLIPPED)return this.renderQueue.pushLight(t),!0}return!1}visitTerrain(t){if(!t.hidden&&(t.castShadow||this._renderPass.type!==ka)){if(this.getClipStateWithNode(t)!==c.NOT_CLIPPED)return t.cull(this)>0}return!1}visitMesh(t){if(!t.hidden&&(t.castShadow||this._renderPass.type!==ka)){if(this.getClipStateWithNode(t)!==c.NOT_CLIPPED)return this.push(this._camera,t,t.renderOrder),!0}return!1}visitOctreeNode(t){const e=t.getLevel()>0?this.getClipStateWithAABB(t.getBoxLoosed()):c.CLIPPED;if(e!==c.NOT_CLIPPED){const i=this._skipClipTest;this._skipClipTest=e===c.A_INSIDE_B;const s=t.getNodes();for(let t=0;t<s.length;t++)this.visit(s[t]);return this._skipClipTest=i,!0}return!1}getClipStateWithNode(t){let e;if(this._skipClipTest)e=c.A_INSIDE_B;else if(t.computedClipMode===En.CLIP_DISABLED)e=c.CLIPPED;else{const i=t.getWorldBoundingVolume();e=i?this.getClipStateWithAABB(i.toAABB()):c.CLIPPED}return e}getClipStateWithAABB(t){return this.camera.clipMask?t.getClipStateWithFrustumMask(this.frustum,this.camera.clipMask):t.getClipStateWithFrustum(this.frustum)}}class An{_bindGroups;_frameStamp;constructor(){this._bindGroups=[],this._frameStamp=-1}apply(t,e,i){const s=Y.instance.device,r=s.getDeviceCaps().shaderCaps.maxUniformBufferSize;if(s.frameInfo.frameCounter!==this._frameStamp){this._frameStamp=s.frameInfo.frameCounter;for(const t of this._bindGroups)t.freeSize=r}let a=-1;for(let t=0;t<this._bindGroups.length;t++)if(this._bindGroups[t].freeSize>=64*i.length){a=t;break}if(a<0){const i=Rn.getProgramByHashIndex(t,e),n=i?.bindGroupLayouts[3]?s.createBindGroup(i.bindGroupLayouts[3]):null;this._bindGroups.push({bindGroup:n,freeSize:r}),a=this._bindGroups.length-1}const n=this._bindGroups[a],o=(r-n.freeSize)/64;for(const t of i)n.bindGroup.setRawData("worldMatrix",r-n.freeSize,t),n.freeSize-=64;return s.setBindGroup(3,n.bindGroup),o}}class Rn{static _debugChannel="";static _nextId=0;static _programMap={};static _drawableTimestamps=new WeakMap;static _drawableIterators=new WeakMap;static _drawableLRU=new s;static _materialTimestamps=new WeakMap;static _materialIterators=new WeakMap;static _materialLRU=new s;static _gcOptions={disabled:!1,drawableCountThreshold:500,materialCountThreshold:200,inactiveTimeDuration:3e4};static _boneMatrixTextureSampler=null;static _instanceBindGroupPool=new An;static _drawableBindGroupMap=new WeakMap;_hash;_renderStateSet;_bindGroupMap;_optionTag;_materialBindGroup;_id;constructor(){this._id=++Rn._nextId,this._hash=[],this._renderStateSet=null,this._bindGroupMap={},this._optionTag=0,this._materialBindGroup=null}static get debugChannel(){return this._debugChannel}static set debugChannel(t){this._debugChannel=t}get id(){return this._id}getHash(t){return void 0===this._hash[t]&&(this._hash[t]=this.createHash(t)),this._hash[t]}get stateSet(){return this._renderStateSet||(this._renderStateSet=this.createRenderStateSet()),this._renderStateSet}set stateSet(t){this._renderStateSet=t}isTransparent(){return!1}supportLighting(){return!0}draw(t,e){this.beginDraw(e)&&(e.instanceData?.worldMatrices.length>1?t.drawInstanced(e.instanceData.worldMatrices.length):t.draw(),this.endDraw())}beginDraw(t){const e=t.instanceData?.worldMatrices?.length||1,i=Y.instance.device,s=this.getOrCreateProgram(t);if(s){const r=s.hash;return s.programs[t.renderPass.type]?(this._materialBindGroup=this.applyMaterialBindGroups(t,r),e>1?this.applyInstanceBindGroups(t,r):this.applyDrawableBindGroups(t,r),t.renderPass.applyRenderStates(i,this.stateSet,t),i.setProgram(s.programs[t.renderPass.type]),Rn._drawableTimestamps.set(t.target,t.timestamp),Rn.lruPutDrawable(t.target),Rn._materialTimestamps.set(this,t.timestamp),Rn.lruPutMaterial(this),!0):null}return!1}endDraw(){this._materialBindGroup=null}getMaterialBindGroup(){return this._materialBindGroup}applyUniforms(t,e,i){i&&this._applyUniforms(t,e)}getOrCreateProgram(t){const e=Rn._programMap,i=t.renderPass.type,s=`${Rn.debugChannel}:${this.getHash(i)}:${!!t.target.getBoneMatrices()}:${Number(!!(t.instanceData?.worldMatrices.length>1))}:${t.renderPassHash}`;let r=e[s];if(!r||!r.programs[i]||r.programs[i].disposed){console.time(s);const a=this.createProgram(t);console.timeEnd(s),r||(r={programs:[null,null,null],hash:s},e[s]=r),r.programs[i]=a}return r||null}dispose(){this.clearBindGroupCache()}static setGCOptions(t){this._gcOptions=Object.assign({},this._gcOptions,t||{})}static getGCOptions(){return this._gcOptions}static garbageCollect(t){let e=0;for(t-=this._gcOptions.inactiveTimeDuration;this._drawableLRU.length>this._gcOptions.drawableCountThreshold;){const i=this._drawableLRU.begin();if(!(this._drawableTimestamps.get(i.data)<t))break;{const t=this._drawableBindGroupMap.get(i.data);if(t)for(const i in t)for(const s of t[i].bindGroup)s&&(this.bindGroupGarbageCollect(s),e++);this._drawableBindGroupMap.delete(i.data),this._drawableIterators.delete(i.data),this._drawableLRU.remove(i)}}for(;this._materialLRU.length>this._gcOptions.materialCountThreshold;){const i=this._materialLRU.begin(),s=i.data;if(!(this._materialTimestamps.get(s)<t&&s._bindGroupMap))break;e+=s.clearBindGroupCache(),this._materialIterators.delete(s),this._materialLRU.remove(i)}return e>0&&this._gcOptions.verbose&&console.log(`INFO: ${e} bind groups have been garbage collected`),e}optionChanged(t){this._optionTag++,t&&(this._hash=[])}static getProgramByHashIndex(t,e){return this._programMap[t].programs[e]}applyMaterialBindGroups(t,e){const i=t.renderPass.type;let s=this._bindGroupMap[e];if(!s){const t=[za,ka,Xa].map((t=>{const i=Rn._programMap[e].programs[t];return i?.bindGroupLayouts[2]?Y.instance.device.createBindGroup(i.bindGroupLayouts[2]):null}));s=this._bindGroupMap[e]={materialBindGroup:t,bindGroupTag:[0,0,0],materialTag:[-1,-1,-1]}}const r=s.materialBindGroup[i];return r?(this.applyUniforms(r,t,s.materialTag[i]<this._optionTag||s.bindGroupTag[i]!==r.cid),s.materialTag[i]=this._optionTag,s.bindGroupTag[i]=r.cid,Y.instance.device.setBindGroup(2,r)):Y.instance.device.setBindGroup(2,null),r}getDrawableBindGroup(t,e){let i=Rn._drawableBindGroupMap.get(t.target);i||(i={},Rn._drawableBindGroupMap.set(t.target,i));let s=i[e];if(!s){const t=[za,ka,Xa].map((t=>{const i=Rn._programMap[e].programs[t];return i?.bindGroupLayouts[1]?Y.instance.device.createBindGroup(i.bindGroupLayouts[1]):null}));s=i[e]={bindGroup:t,bindGroupTag:[0,0,0],xformTag:[-1,-1,-1]}}return s}applyInstanceBindGroups(t,e){const i=t.renderPass.type,s=Rn._instanceBindGroupPool.apply(e,i,t.instanceData.worldMatrices),r=this.getDrawableBindGroup(t,e).bindGroup?.[i];r?(r.setValue("instanceBufferOffset",s),Y.instance.device.setBindGroup(1,r)):Y.instance.device.setBindGroup(1,null)}applyDrawableBindGroups(t,e){const i=Y.instance.device,s=t.renderPass.type,r=this.getDrawableBindGroup(t,e);if(r.bindGroup){const e=r.bindGroup[s];(r.xformTag[s]<t.target.getXForm().getTag()||r.bindGroupTag[s]!==e.cid)&&(e.setValue("worldMatrix",t.target.getXForm().worldMatrix),r.xformTag[s]=t.target.getXForm().getTag(),r.bindGroupTag[s]=e.cid);const a=t.target.getBoneMatrices();a&&(Rn._boneMatrixTextureSampler||(Rn._boneMatrixTextureSampler=i.createSampler({magFilter:"nearest",minFilter:"nearest",mipFilter:"none"})),e.setTexture("boneMatrices",a),e.setValue("boneTextureSize",a.width),e.setValue("invBindMatrix",t.target.getInvBindMatrix())),i.setBindGroup(1,e)}else i.setBindGroup(1,null)}createHash(t){return`${this.constructor.name}|${this._createHash(t)}`}clearBindGroupCache(){let t=0;for(const e in this._bindGroupMap)for(const i of this._bindGroupMap[e].materialBindGroup)i&&(Rn.bindGroupGarbageCollect(i),t++);return this._bindGroupMap={},t}static bindGroupGarbageCollect(t){const e=t.getLayout();for(const i of e.entries)if(i.buffer){const e=t.getBuffer(i.name);e&&(e.dispose(),t.setBuffer(i.name,null))}}static lruPutDrawable(t){const e=this._drawableIterators.get(t);e&&this._drawableLRU.remove(e),this._drawableIterators.set(t,this._drawableLRU.append(t))}static lruPutMaterial(t){const e=this._materialIterators.get(t);e&&this._materialLRU.remove(e),this._materialIterators.set(t,this._materialLRU.append(t))}createProgram(t){const e=new ba(Y.instance.device);return this._createProgram(e,t)}createRenderStateSet(){return Y.instance.device.createRenderStateSet()}_createProgram(t,e){return null}_applyUniforms(t,e){}_createHash(t){return""}}const Mn=[za,ka,Xa];function $n(t,...e){let i=t;for(const t of e)i=t(i);return i}class Nn extends Rn{static FEATURE_ALPHATEST="mm_alphatest";static FEATURE_ALPHABLEND="mm_alphablend";static FEATURE_ALPHATOCOVERAGE="mm_alphatocoverage";_features;_featureStates;_featureIndex;_alphaCutoff;_blendMode;_opacity;constructor(){super(),this._features=new Map,this._featureStates=[],this._featureStates[za]=[],this._featureStates[ka]=[],this._featureStates[Xa]=[],this._featureIndex=0,this._alphaCutoff=0,this._blendMode="none",this._opacity=1}get alphaCutoff(){return this._alphaCutoff}set alphaCutoff(t){this._alphaCutoff!==t&&(this.useFeature(Nn.FEATURE_ALPHATEST,t>0),this._alphaCutoff=t,this.optionChanged(!1))}get alphaToCoverage(){return this.featureUsed(Nn.FEATURE_ALPHATOCOVERAGE,za)}set alphaToCoverage(t){this.useFeature(Nn.FEATURE_ALPHATOCOVERAGE,!!t,za)}get blendMode(){return this._blendMode}set blendMode(t){this._blendMode!==t&&(this._blendMode=t,this.useFeature(Nn.FEATURE_ALPHABLEND,"none"!==this._blendMode||this._opacity<1,za))}get opacity(){return this._opacity}set opacity(t){t=t<0?0:t>1?1:t,this._opacity!==t&&(this._opacity=t,this.useFeature(Nn.FEATURE_ALPHABLEND,this._opacity<1,za),this.optionChanged(!1))}updateBlendingState(t){const e=this.featureUsed(Nn.FEATURE_ALPHABLEND,t.renderPass.type),i=this.featureUsed(Nn.FEATURE_ALPHATOCOVERAGE,t.renderPass.type);if(e||i){const t=this.stateSet.useBlendingState();e?(t.enable(!0),"additive"===this._blendMode?(t.setBlendEquation("add","add"),t.setBlendFunc("one","one")):"max"===this._blendMode?(t.setBlendEquation("max","add"),t.setBlendFuncRGB("one","one"),t.setBlendFuncAlpha("zero","one")):"min"===this._blendMode?(t.setBlendEquation("min","add"),t.setBlendFuncRGB("one","one"),t.setBlendFuncAlpha("zero","one")):(t.setBlendEquation("add","add"),t.setBlendFunc("one","inv-src-alpha"))):t.enable(!1),t.enableAlphaToCoverage(i)}else this.stateSet.blendingState?.enabled&&!e&&this.stateSet.defaultBlendingState()}applyUniformValues(t,e){this.featureUsed(Nn.FEATURE_ALPHATEST,e.renderPass.type)&&t.setValue("kkAlphaCutoff",this._alphaCutoff),this.featureUsed(Nn.FEATURE_ALPHABLEND,e.renderPass.type)&&t.setValue("kkOpacity",this._opacity)}isTransparent(){return"none"!==this._blendMode||this._opacity<1}beginDraw(t){return this.updateBlendingState(t),super.beginDraw(t)}createProgram(t){const e=new ba(Y.instance.device);if(t.renderPass.type===ka){const i=t.shadowMapInfo.get(t.renderPass.light);e.emulateDepthClamp=!!i.depthClampEnabled}return this._createProgram(e,t)}featureUsed(t,e){const i=this._features.get(t);return this._featureStates[e][i]}useFeature(t,e,i){"number"==typeof(i=i??Mn)&&(i=[i]);let s=this._features.get(t);void 0===s&&(s=this._featureIndex++,this._features.set(t,s));let r=!1;for(const t of i)t!==za&&t!==ka&&t!==Xa&&console.error(`useFeature(): invalid render pass type: ${t}`),this._featureStates[t][s]!==e&&(this._featureStates[t][s]=e,r=!0);r&&this.optionChanged(!0)}_createHash(t){return this._featureStates[t].join("")}_applyUniforms(t,e){this.applyUniformValues(t,e)}needFragmentColor(t){return t.renderPass.type===za||this._alphaCutoff>0||this.alphaToCoverage}transformVertexAndNormal(t){qa.ftransform(t)}vertexShader(t,e){const i=t.$builder;qa.prepareVertexShader(i,e),e.target.getBoneMatrices()&&(t.$inputs.kkBlendIndices=i.vec4().attrib("blendIndices"),t.$inputs.kkBlendWeights=i.vec4().attrib("blendWeights"))}fragmentShader(t,e){const i=t.$builder;qa.prepareFragmentShader(i,e),this._alphaCutoff>0&&(t.$g.kkAlphaCutoff=i.float().uniform(2)),e.renderPass.type===za&&this.isTransparent()&&(t.$g.kkOpacity=i.float().uniform(2))}_createProgram(t,e){const i=this,s=t.buildRenderProgram({vertex(t){t.main((function(){i.vertexShader(this,e)}))},fragment(t){this.$outputs.zFragmentOutput=t.vec4(),t.main((function(){i.fragmentShader(this,e)}))}});return s}outputFragmentColor(t,e,i){const s=t.$builder,r=this;s.func("zOutputFragmentColor",e?[s.vec4("color")]:[],(function(){if(this.$l.outColor=e?this.color:s.vec4(),i.renderPass.type===za)qa.discardIfClipped(this),r.isTransparent()||this.kkAlphaCutoff||r.alphaToCoverage?this.kkOpacity&&(this.outColor.a=s.mul(this.outColor.a,this.kkOpacity)):this.outColor.a=1,this.kkAlphaCutoff&&this.$if(s.lessThan(this.outColor.a,this.kkAlphaCutoff),(function(){s.discard()})),r.isTransparent()&&(this.outColor=s.vec4(s.mul(this.outColor.rgb,this.outColor.a),this.outColor.a)),qa.applyFog(this,this.outColor,i),this.$outputs.zFragmentOutput=en(this,this.outColor);else if(i.renderPass.type===Xa)e&&this.$if(s.lessThan(this.outColor.a,this.kkAlphaCutoff),(function(){s.discard()})),qa.discardIfClipped(this),this.$l.kkDepth=Ka(this,this.$builtins.fragCoord.z),"webgl"===Y.instance.device.type?this.$outputs.zFragmentOutput=Ja(this,this.kkDepth):this.$outputs.zFragmentOutput=s.vec4(this.kkDepth,0,0,1);else{e&&this.$if(s.lessThan(this.outColor.a,this.kkAlphaCutoff),(function(){s.discard()})),qa.discardIfClipped(this);const t=i.shadowMapInfo.get(i.renderPass.light);this.$outputs.zFragmentOutput=t.impl.computeShadowMapDepth(t,this)}})),e?s.getGlobalScope().zOutputFragmentColor(e):s.getGlobalScope().zOutputFragmentColor()}}class Dn extends Nn{static FEATURE_DOUBLE_SIDED_LIGHTING="lm_doublesided_lighting";static FEATURE_VERTEX_NORMAL="lm_vertexnormal";static FEATURE_VERTEX_TANGENT="lm_vertextangent";static FEATURE_NORMAL_TEXTURE="lm_normaltexture";static FEATURE_NORMAL_TEXCOORD_INDEX="lm_normaltexcoord";static FEATURE_NORMAL_TEXTURE_MATRIX="lm_normal_texture_matrix";static FEATURE_OBJECT_SPACE_NORMALMAP="lm_objectspace_normalmap";_normalTexture;_normalSampler;_normalTexCoordIndex;_normalTexCoordMatrix;_normalScale;constructor(){super(),this._normalTexture=null,this._normalSampler=null,this._normalTexCoordIndex=0,this._normalTexCoordMatrix=null,this._normalScale=1,this.useFeature(Dn.FEATURE_VERTEX_NORMAL,!0)}get normalScale(){return this._normalScale}set normalScale(t){t!==this._normalScale&&(this._normalScale=t,this.optionChanged(!1))}get normalMapMode(){return this.featureUsed(Dn.FEATURE_OBJECT_SPACE_NORMALMAP,za)}set normalMapMode(t){this.useFeature(Dn.FEATURE_OBJECT_SPACE_NORMALMAP,t,za)}get doubleSidedLighting(){return this.featureUsed(Dn.FEATURE_DOUBLE_SIDED_LIGHTING,za)}set doubleSidedLighting(t){this.useFeature(Dn.FEATURE_DOUBLE_SIDED_LIGHTING,!!t,za)}get vertexNormal(){return this.featureUsed(Dn.FEATURE_VERTEX_NORMAL,za)}set vertexNormal(t){this.useFeature(Dn.FEATURE_VERTEX_NORMAL,!!t)}get vertexTangent(){return this.featureUsed(Dn.FEATURE_VERTEX_TANGENT,za)}set vertexTangent(t){this.useFeature(Dn.FEATURE_VERTEX_TANGENT,!!t)}get normalTexture(){return this._normalTexture}set normalTexture(t){this._normalTexture!==t&&(this.useFeature(Dn.FEATURE_NORMAL_TEXTURE,!!t),t&&(this.useFeature(Dn.FEATURE_NORMAL_TEXCOORD_INDEX,this._normalTexCoordIndex),this.useFeature(Dn.FEATURE_NORMAL_TEXTURE_MATRIX,!!this._normalTexCoordMatrix)),this._normalTexture=t??null,this.optionChanged(!1))}get normalTextureSampler(){return this._normalSampler}set normalTextureSampler(t){this._normalSampler=t??null}get normalTexCoordIndex(){return this._normalTexCoordIndex}set normalTexCoordIndex(t){t!==this._normalTexCoordIndex&&(this._normalTexCoordIndex=t,this._normalTexture&&this.useFeature(Dn.FEATURE_NORMAL_TEXCOORD_INDEX,this._normalTexCoordIndex))}get normalTexMatrix(){return this._normalTexCoordMatrix}set normalTexMatrix(t){t!==this._normalTexCoordMatrix&&(this._normalTexCoordMatrix=t,this._normalTexture&&this.useFeature(Dn.FEATURE_NORMAL_TEXTURE_MATRIX,!!this._normalTexCoordMatrix),this.optionChanged(!1))}calculateViewVector(t){const e=t.$builder;return e.normalize(e.sub(qa.getCameraPosition(t),qa.getWorldPosition(t).xyz))}calculateReflectionVector(t,e,i){const s=t.$builder;return s.reflect(s.neg(i),e)}calculateNormal(t,e){const i=t.$builder,s=this,r=[],a=[],n=qa.getWorldNormal(t),o=qa.getWorldTangent(t),h=qa.getWorldBinormal(t);return n&&(a.push(i.vec3("worldNormal")),r.push(n),o&&(a.push(i.vec3("worldTangent"),i.vec3("worldBinormal")),r.push(o,h))),i.func("kkCalculateNormal",a,(function(){const r=qa.getWorldPosition(this).xyz;if(this.$l.uv=s.featureUsed(Dn.FEATURE_NORMAL_TEXTURE,e.renderPass.type)?t.$inputs.kkNormalTexCoord??i.vec2(0):s.featureUsed(Dn.FEATURE_NORMAL_TEXTURE,e.renderPass.type)?t.$inputs.kkAlbedoTexCoord??i.vec2(0):i.vec2(0),this.$l.TBN=i.mat3(),n?o?this.TBN=i.mat3(i.normalize(this.worldTangent),i.normalize(this.worldBinormal),i.normalize(this.worldNormal)):(this.$l.uv_dx=i.dpdx(i.vec3(this.uv,0)),this.$l.uv_dy=i.dpdy(i.vec3(this.uv,0)),this.$if(i.lessThanEqual(i.add(i.length(this.uv_dx),i.length(this.uv_dy)),1e-6),(function(){this.uv_dx=i.vec3(1,0,0),this.uv_dy=i.vec3(0,1,0)})),this.$l.t_=i.div(i.sub(i.mul(i.dpdx(r),this.uv_dy.y),i.mul(i.dpdy(r),this.uv_dx.y)),i.sub(i.mul(this.uv_dx.x,this.uv_dy.y),i.mul(this.uv_dx.y,this.uv_dy.x))),this.$l.ng=i.normalize(this.worldNormal),this.$l.t=i.normalize(i.sub(this.t_,i.mul(this.ng,i.dot(this.ng,this.t_)))),this.$l.b=i.cross(this.ng,this.t),s.doubleSidedLighting&&this.$if(i.not(this.$builtins.frontFacing),(function(){this.t=i.mul(this.t,-1),this.b=i.mul(this.b,-1),this.ng=i.mul(this.ng,-1)})),this.TBN=i.mat3(this.t,this.b,this.ng)):(this.$l.uv_dx=i.dpdx(i.vec3(this.uv,0)),this.$l.uv_dy=i.dpdy(i.vec3(this.uv,0)),this.$if(i.lessThanEqual(i.add(i.length(this.uv_dx),i.length(this.uv_dy)),1e-6),(function(){this.uv_dx=i.vec3(1,0,0),this.uv_dy=i.vec3(0,1,0)})),this.$l.t_=i.div(i.sub(i.mul(i.dpdx(r),this.uv_dy.y),i.mul(i.dpdy(r),this.uv_dx.y)),i.sub(i.mul(this.uv_dx.x,this.uv_dy.y),i.mul(this.uv_dx.y,this.uv_dy.x))),this.$l.ng=i.normalize(i.cross(i.dpdx(r),i.dpdy(r))),this.$l.t=i.normalize(i.sub(this.t_,i.mul(this.ng,i.dot(this.ng,this.t_)))),this.$l.b=i.cross(this.ng,this.t),s.doubleSidedLighting&&this.$if(i.not(this.$builtins.frontFacing),(function(){this.t=i.mul(this.t,-1),this.b=i.mul(this.b,-1),this.ng=i.mul(this.ng,-1)})),this.TBN=i.mat3(this.t,this.b,this.ng)),s.featureUsed(Dn.FEATURE_NORMAL_TEXTURE,e.renderPass.type))if("object-space"===s.normalMapMode){const t=i.sub(i.mul(i.textureSample(this.kkNormalTexture,this.uv).rgb,2),i.vec3(1)),e=i.mul(t,i.vec3(i.vec3(this.kkNormalScale).xx,1));this.$return(i.normalize(e))}else{const t=i.sub(i.mul(i.textureSample(this.kkNormalTexture,this.uv).rgb,2),i.vec3(1)),e=i.mul(t,i.vec3(i.vec3(this.kkNormalScale).xx,1));this.$return(i.normalize(i.mul(this.TBN,e)))}else this.$return(this.TBN[2])})),i.getGlobalScope().kkCalculateNormal(...r)}calculateNormalAndTBN(t,e){const i=t.$builder,s=i.defineStruct([i.mat3("TBN"),i.vec3("normal")]),r=this,a=[],n=[],o=qa.getWorldNormal(t),h=qa.getWorldTangent(t),u=qa.getWorldBinormal(t);return o&&(n.push(i.vec3("worldNormal")),a.push(o),h&&(n.push(i.vec3("worldTangent"),i.vec3("worldBinormal")),a.push(h,u))),i.func("kkCalculateNormalAndTBN",n,(function(){const a=qa.getWorldPosition(this).xyz;if(this.$l.uv=r.featureUsed(Dn.FEATURE_NORMAL_TEXTURE,e.renderPass.type)?t.$inputs.kkNormalTexCoord??i.vec2(0):r.featureUsed(Dn.FEATURE_NORMAL_TEXTURE,e.renderPass.type)?t.$inputs.kkAlbedoTexCoord??i.vec2(0):i.vec2(0),this.$l.TBN=i.mat3(),o?h?this.TBN=i.mat3(i.normalize(this.worldTangent),i.normalize(this.worldBinormal),i.normalize(this.worldNormal)):(this.$l.uv_dx=i.dpdx(i.vec3(this.uv,0)),this.$l.uv_dy=i.dpdy(i.vec3(this.uv,0)),this.$if(i.lessThanEqual(i.add(i.length(this.uv_dx),i.length(this.uv_dy)),1e-6),(function(){this.uv_dx=i.vec3(1,0,0),this.uv_dy=i.vec3(0,1,0)})),this.$l.t_=i.div(i.sub(i.mul(i.dpdx(a),this.uv_dy.y),i.mul(i.dpdy(a),this.uv_dx.y)),i.sub(i.mul(this.uv_dx.x,this.uv_dy.y),i.mul(this.uv_dx.y,this.uv_dy.x))),this.$l.ng=i.normalize(this.worldNormal),this.$l.t=i.normalize(i.sub(this.t_,i.mul(this.ng,i.dot(this.ng,this.t_)))),this.$l.b=i.cross(this.ng,this.t),r.doubleSidedLighting&&this.$if(i.not(this.$builtins.frontFacing),(function(){this.t=i.mul(this.t,-1),this.b=i.mul(this.b,-1),this.ng=i.mul(this.ng,-1)})),this.TBN=i.mat3(this.t,this.b,this.ng)):(this.$l.uv_dx=i.dpdx(i.vec3(this.uv,0)),this.$l.uv_dy=i.dpdy(i.vec3(this.uv,0)),this.$if(i.lessThanEqual(i.add(i.length(this.uv_dx),i.length(this.uv_dy)),1e-6),(function(){this.uv_dx=i.vec3(1,0,0),this.uv_dy=i.vec3(0,1,0)})),this.$l.t_=i.div(i.sub(i.mul(i.dpdx(a),this.uv_dy.y),i.mul(i.dpdy(a),this.uv_dx.y)),i.sub(i.mul(this.uv_dx.x,this.uv_dy.y),i.mul(this.uv_dx.y,this.uv_dy.x))),this.$l.ng=i.normalize(i.cross(i.dpdx(a),i.dpdy(a))),this.$l.t=i.normalize(i.sub(this.t_,i.mul(this.ng,i.dot(this.ng,this.t_)))),this.$l.b=i.cross(this.ng,this.t),r.doubleSidedLighting&&this.$if(i.not(this.$builtins.frontFacing),(function(){this.t=i.mul(this.t,-1),this.b=i.mul(this.b,-1),this.ng=i.mul(this.ng,-1)})),this.TBN=i.mat3(this.t,this.b,this.ng)),r.featureUsed(Dn.FEATURE_NORMAL_TEXTURE,e.renderPass.type))if("object-space"===r.normalMapMode){const t=i.sub(i.mul(i.textureSample(this.kkNormalTexture,this.uv).rgb,2),i.vec3(1)),e=i.mul(t,i.vec3(i.vec3(this.kkNormalScale).xx,1));this.$return(s(this.TBN,i.normalize(e)))}else{const t=i.sub(i.mul(i.textureSample(this.kkNormalTexture,this.uv).rgb,2),i.vec3(1)),e=i.mul(t,i.vec3(i.vec3(this.kkNormalScale).xx,1));this.$return(s(this.TBN,i.normalize(i.mul(this.TBN,e))))}else this.$return(s(this.TBN,this.TBN[2]))})),i.getGlobalScope().kkCalculateNormalAndTBN(...a)}applyUniformValues(t,e){super.applyUniformValues(t,e),this.needFragmentColor(e)&&this.featureUsed(Dn.FEATURE_NORMAL_TEXTURE,e.renderPass.type)&&(t.setValue("kkNormalScale",this._normalScale),t.setTexture("kkNormalTexture",this._normalTexture,this._normalSampler),this.featureUsed(Dn.FEATURE_NORMAL_TEXTURE_MATRIX,e.renderPass.type)&&t.setValue("kkNormalTextureMatrix",this._normalTexCoordMatrix))}needCalculateEnvLight(t){return t.drawEnvLight}getEnvLightIrradiance(t,e,i){return this.needCalculateEnvLight?i.env.light.envLight.hasIrradiance()?t.$builder.mul(i.env.light.envLight.getIrradiance(t,e).rgb,qa.getEnvLightStrength(t)):t.$builder.vec3(0):(console.warn("getEnvLightIrradiance(): No need to calculate environment lighting"),t.$builder.vec3(0))}getEnvLightRadiance(t,e,i,s){return this.needCalculateEnvLight?s.env.light.envLight.hasRadiance()?t.$builder.mul(s.env.light.envLight.getRadiance(t,e,i).rgb,qa.getEnvLightStrength(t)):t.$builder.vec3(0):(console.warn("getEnvLightRadiance(): No need to calculate environment lighting"),t.$builder.vec3(0))}needCalucateShadow(t){return!!t.currentShadowLight}calculateShadow(t,e,i){const s=t.$builder;if(!this.needCalucateShadow(i))return console.warn("calculateShadow(): No need to calculate shadow"),s.float(1);const r=i.shadowMapInfo.get(i.currentShadowLight),a="lm_calculateCSM";return s.func(a,[s.float("NoL")],(function(){if(r.numShadowCascades>1){this.$l.shadowCascades=this.global.light.shadowCascades,this.$l.shadowBound=s.vec4(0,0,1,1),this.$l.linearDepth=Za(this,this.$builtins.fragCoord.z),this.$l.splitDistances=qa.getCascadeDistances(this),this.$l.comparison=s.vec4(s.greaterThan(s.vec4(this.linearDepth),this.splitDistances)),this.$l.cascadeFlags=s.vec4(s.float(s.greaterThan(this.shadowCascades,0)),s.float(s.greaterThan(this.shadowCascades,1)),s.float(s.greaterThan(this.shadowCascades,2)),s.float(s.greaterThan(this.shadowCascades,3))),this.$l.split=s.int(s.dot(this.comparison,this.cascadeFlags)),"webgl"===Y.instance.device.type?(this.$l.shadowVertex=s.vec4(),this.$for(s.int("cascade"),0,4,(function(){this.$if(s.equal(this.cascade,this.split),(function(){this.shadowVertex=qa.calculateShadowSpaceVertex(this,this.cascade),this.$break()}))}))):this.$l.shadowVertex=qa.calculateShadowSpaceVertex(this,this.split);const e=i.shadowMapInfo.get(i.currentShadowLight);this.$l.shadow=e.impl.computeShadowCSM(e,this,this.shadowVertex,this.NoL,this.split),this.$l.shadowDistance=qa.getShadowCameraParams(t).w,this.shadow=s.mix(this.shadow,1,s.smoothStep(s.mul(this.shadowDistance,.8),this.shadowDistance,s.distance(qa.getCameraPosition(this),qa.getWorldPosition(this).xyz))),this.$return(this.shadow)}else{this.$l.shadowVertex=qa.calculateShadowSpaceVertex(this);const e=i.shadowMapInfo.get(i.currentShadowLight);this.$l.shadow=e.impl.computeShadow(e,this,this.shadowVertex,this.NoL),this.$l.shadowDistance=qa.getShadowCameraParams(t).w,this.shadow=s.mix(this.shadow,1,s.smoothStep(s.mul(this.shadowDistance,.8),this.shadowDistance,s.distance(qa.getCameraPosition(this),qa.getWorldPosition(this).xyz))),this.$return(this.shadow)}})),s.getGlobalScope()[a](e)}getClusterIndex(t,e){const i=t.$builder,s="lm_getClusterIndex";return i.func(s,[i.vec3("fragCoord")],(function(){const t=qa.getClusterParams(this),e=qa.getCountParams(this);this.$l.zTile=i.int(i.max(i.add(i.mul(i.log2(Za(this,this.fragCoord.z)),t.z),t.w),0)),this.$l.f=i.vec2(this.fragCoord.x,i.sub(t.y,i.add(this.fragCoord.y,1))),this.$l.xyTile=i.ivec2(i.div(this.f,i.div(t.xy,i.vec2(e.xy)))),this.$return(i.ivec3(this.xyTile,this.zTile))})),i.getGlobalScope()[s](e)}calculatePointLightAttenuation(t,e){const i=t.$builder,s="lm_calculatePointLightAttenuation";return i.func(s,[i.vec4("posRange")],(function(){this.$l.dist=i.distance(this.posRange.xyz,qa.getWorldPosition(this).xyz),this.$l.falloff=i.max(0,i.sub(1,i.div(this.dist,this.posRange.w))),this.$return(i.mul(this.falloff,this.falloff))})),i.getGlobalScope()[s](e)}calculateSpotLightAttenuation(t,e,i){const s=t.$builder,r="lm_calculateSpotLightAttenuation";return s.func(r,[s.vec4("posRange"),s.vec4("dirCutoff")],(function(){this.$l.dist=s.distance(this.posRange.xyz,qa.getWorldPosition(this).xyz),this.$l.falloff=s.max(0,s.sub(1,s.div(this.dist,this.posRange.w))),this.$l.spotFactor=s.dot(s.normalize(s.sub(qa.getWorldPosition(this).xyz,this.posRange.xyz)),this.dirCutoff.xyz),this.spotFactor=s.smoothStep(this.dirCutoff.w,s.mix(this.dirCutoff.w,1,.5),this.spotFactor),this.$return(s.mul(this.spotFactor,this.falloff,this.falloff))})),s.getGlobalScope()[r](e,i)}calculateLightAttenuation(t,e,i,s){const r=t.$builder;return t.$choice(r.equal(e,1),r.float(1),t.$choice(r.equal(e,Wa),this.calculatePointLightAttenuation(t,i),this.calculateSpotLightAttenuation(t,i,s)))}calculateLightDirection(t,e,i,s){const r=t.$builder;return t.$choice(r.equal(e,1),r.neg(s.xyz),r.normalize(r.sub(i.xyz,qa.getWorldPosition(t).xyz)))}forEachLight(t,e,i){const s=t.$builder,r=this;if(e.currentShadowLight){const e=t.global.light.positionAndRange,r=t.global.light.directionAndCutoff,a=t.global.light.diffuseAndIntensity;t.$scope((function(){const n=t.$choice(s.lessThan(e.w,0),s.int(1),t.$choice(s.lessThan(r.w,0),s.int(Wa),s.int(3)));i.call(this,n,e,r,a,!0)}))}else t.$scope((function(){const t=qa.getCountParams(this);this.$l.cluster=r.getClusterIndex(this,this.$builtins.fragCoord.xyz),this.$l.clusterIndex=s.add(this.cluster.x,s.mul(this.cluster.y,t.x),s.mul(this.cluster.z,t.x,t.y)),this.$l.texSize=this.global.light.lightIndexTexSize,"webgl"===s.getDevice().type?(this.$l.texCoordX=s.div(s.add(s.mod(s.float(this.clusterIndex),s.float(this.texSize.x)),.5),s.float(this.texSize.x)),this.$l.texCoordY=s.div(s.add(s.float(s.div(this.clusterIndex,this.texSize.x)),.5),s.float(this.texSize.y)),this.$l.samp=s.textureSample(qa.getClusteredLightIndexTexture(this),s.vec2(this.texCoordX,this.texCoordY))):(this.$l.texCoordX=s.mod(this.clusterIndex,this.texSize.x),this.$l.texCoordY=s.div(this.clusterIndex,this.texSize.x),this.$l.samp=s.textureLoad(qa.getClusteredLightIndexTexture(this),s.ivec2(this.texCoordX,this.texCoordY),0)),"webgl"===s.getDevice().type?this.$for(s.int("i"),0,4,(function(){this.$l.k=this.samp.at(this.i),this.$l.lights=s.int[2](),this.$l.lights[0]=s.int(s.mod(this.k,256)),this.$l.lights[1]=s.int(s.div(this.k,256)),this.$for(s.int("k"),0,2,(function(){this.$l.li=this.lights.at(this.k),this.$if(s.greaterThan(this.li,0),(function(){this.$for(s.int("j"),1,256,(function(){this.$if(s.equal(this.j,this.li),(function(){this.$l.positionRange=qa.getLightPositionAndRange(this,this.j),this.$l.directionCutoff=qa.getLightDirectionAndCutoff(this,this.j),this.$l.diffuseIntensity=qa.getLightColorAndIntensity(this,this.j),this.$l.lightType=this.$choice(s.lessThan(this.positionRange.w,0),s.int(1),this.$choice(s.lessThan(this.directionCutoff.w,0),s.int(Wa),s.int(3))),this.$scope((function(){i.call(this,this.lightType,this.positionRange,this.directionCutoff,this.diffuseIntensity,!1)})),this.$break()}))}))}))}))})):this.$for(s.uint("i"),0,4,(function(){this.$for(s.uint("k"),0,4,(function(){this.$l.c=s.compAnd(s.sar(this.samp.at(this.i),s.mul(this.k,8)),255),this.$if(s.greaterThan(this.c,0),(function(){this.$l.positionRange=qa.getLightPositionAndRange(this,this.c),this.$l.directionCutoff=qa.getLightDirectionAndCutoff(this,this.c),this.$l.diffuseIntensity=qa.getLightColorAndIntensity(this,this.c),this.$l.lightType=this.$choice(s.lessThan(this.positionRange.w,0),s.int(1),this.$choice(s.lessThan(this.directionCutoff.w,0),s.int(Wa),s.int(3))),this.$scope((function(){i.call(this,this.lightType,this.positionRange,this.directionCutoff,this.diffuseIntensity,!1)}))}))}))}))}))}vertexShader(t,e){super.vertexShader(t,e);const i=t.$builder;if(this.needFragmentColor(e)&&(this.vertexNormal&&(t.$inputs.normal=i.vec3().attrib("normal")),this.vertexTangent&&(t.$inputs.tangent=i.vec4().attrib("tangent")),this.featureUsed(Dn.FEATURE_NORMAL_TEXTURE,e.renderPass.type))){const s=`texCoord${this.normalTexCoordIndex}`;t.$getVertexAttrib(s)||(t.$inputs[s]=i.vec2().attrib(s)),this.featureUsed(Dn.FEATURE_NORMAL_TEXTURE_MATRIX,e.renderPass.type)?(t.$g.kkNormalTextureMatrix=i.mat4().uniform(2),t.$outputs.kkNormalTexCoord=i.mul(t.kkNormalTextureMatrix,i.vec4(t.$inputs[s],0,1)).xy):t.$outputs.kkNormalTexCoord=t.$inputs[s]}}fragmentShader(t,e){super.fragmentShader(t,e);const i=t.$builder;this.featureUsed(Dn.FEATURE_NORMAL_TEXTURE,e.renderPass.type)&&(t.$g.kkNormalTexture=i.tex2D().uniform(2),t.$g.kkNormalScale=i.float().uniform(2))}supportLighting(){return!0}}function In(t){if(t.albedoColorMixed)return t;const e="z-feature-albedo-map",i="z-feature-albedo-texcoord-index",s="z-feature-albedo-texcoord-matrix";return class extends t{static albedoColorMixed=!0;_albedoColor;_albedoTexture;_albedoSampler;_albedoTexCoordIndex;_albedoTexCoordMatrix;constructor(...t){super(...t),this._albedoColor=T.one(),this._albedoTexture=null,this._albedoSampler=null,this._albedoTexCoordIndex=0,this._albedoTexCoordMatrix=null}get albedoColor(){return this._albedoColor}set albedoColor(t){this._albedoColor.set(t),this.optionChanged(!1)}get albedoTexCoordIndex(){return this._albedoTexCoordIndex}set albedoTexCoordIndex(t){t!==this._albedoTexCoordIndex&&(this._albedoTexCoordIndex=t,this._albedoTexture&&this.useFeature(i,this._albedoTexCoordIndex))}get albedoTexture(){return this._albedoTexture}set albedoTexture(t){this._albedoTexture!==t&&(this.useFeature(e,!!t),t&&(this.useFeature(i,this._albedoTexCoordIndex),this.useFeature(s,!!this._albedoTexCoordMatrix)),this._albedoTexture=t??null,this.optionChanged(!1))}get albedoTextureSampler(){return this._albedoSampler}set albedoTextureSampler(t){this._albedoSampler=t??null}get albedoTexMatrix(){return this._albedoTexCoordMatrix}set albedoTexMatrix(t){t!==this._albedoTexCoordMatrix&&(this._albedoTexCoordMatrix=t,this._albedoTexture&&this.useFeature(s,!!this._albedoTexCoordMatrix),this.optionChanged(!1))}calculateAlbedoColor(t,i){if(!this.needFragmentColor(i))throw new Error("mixinAlbedoColor.calculateAlbedoColor(): No need to calculate albedo color, make sure needFragmentColor() returns true");const s=t.$builder;let r=t.kkAlbedo;return this.featureUsed(e,i.renderPass.type)&&(r=s.mul(r,s.textureSample(t.kkAlbedoTex,t.$inputs.kkAlbedoTexCoord))),r}vertexShader(t,i){if(super.vertexShader(t,i),this.needFragmentColor(i)){const r=t.$builder;if(this.featureUsed(e,i.renderPass.type)){const e=`texCoord${this.albedoTexCoordIndex}`;t.$getVertexAttrib(e)||(t.$inputs[e]=r.vec2().attrib(e)),this.featureUsed(s,i.renderPass.type)?(t.$g.kkAlbedoTextureMatrix=r.mat4().uniform(2),t.$outputs.kkAlbedoTexCoord=r.mul(t.kkAlbedoTextureMatrix,r.vec4(t.$inputs[e],0,1)).xy):t.$outputs.kkAlbedoTexCoord=t.$inputs[e]}}}fragmentShader(t,i){if(super.fragmentShader(t,i),this.needFragmentColor(i)){const s=t.$builder;t.$g.kkAlbedo=s.vec4().uniform(2),this.featureUsed(e,i.renderPass.type)&&(t.$g.kkAlbedoTex=s.tex2D().uniform(2))}}applyUniformValues(t,i){super.applyUniformValues(t,i),this.needFragmentColor(i)&&(t.setValue("kkAlbedo",this._albedoColor),this.featureUsed(e,i.renderPass.type)&&(t.setTexture("kkAlbedoTex",this._albedoTexture,this._albedoSampler),this.featureUsed(s,i.renderPass.type)&&t.setValue("kkAlbedoTextureMatrix",this._albedoTexCoordMatrix)))}}}function Ln(t){if(t.vertexColorMixed)return t;const e="z-feature-vertex-color";return class extends t{static vertexColorMixed=!0;constructor(...t){super(...t)}get vertexColor(){return this.featureUsed(e,za)}set vertexColor(t){this.useFeature(e,!!t)}vertexShader(t,e){if(super.vertexShader(t,e),this.needFragmentColor(e)&&this.vertexColor){if(t.$getVertexAttrib("diffuse"))throw new Error("mixinVertexColor.vertexShader(): diffuse vertex stream already defined");t.$inputs.zDiffuse=t.$builder.vec4().attrib("diffuse"),t.$outputs.zOutDiffuse=t.$inputs.zDiffuse}}getVertexColor(t,e){if(!this.needFragmentColor(e))throw new Error("mixinVertexColor.getVertexColor(): No need to calculate albedo color, make sure needFragmentColor() returns true");return"fragment"===t.$builder.shaderKind?t.$inputs.zOutDiffuse:t.$inputs.zDiffuse}}}$n(Dn,Ln,In);$n(Dn,Ln,In);$n(Nn,Ln,In);function Fn(t,e,i,s){const r=t.$builder,a="fresnelSchlick";return r.func(a,[r.float("VdotH"),r.vec3("F0"),r.vec3("F90")],(function(){this.$return(r.add(this.F0,r.mul(r.sub(this.F90,this.F0),r.pow(r.clamp(r.sub(1,this.VdotH),0,1),5))))})),r.getGlobalScope()[a](e,i,s)}function Pn(t,e,i){const s=t.$builder,r="distributionGGX";return s.func(r,[s.float("NdotH"),s.float("roughness")],(function(){this.$l.a2=s.mul(this.roughness,this.roughness),this.$l.NdotH2=s.mul(this.NdotH,this.NdotH),this.$l.num=this.a2,this.$l.denom=s.add(s.mul(this.NdotH2,s.sub(this.a2,1)),1),this.denom=s.mul(s.mul(3.14159265,this.denom),this.denom),this.$return(s.div(this.num,this.denom))})),s.getGlobalScope()[r](e,i)}function Bn(t,e,i,s){const r=t.$builder,a="visGGX";return r.func(a,[r.float("NdotV"),r.float("NdotL"),r.float("roughness")],(function(){this.$l.a2=r.mul(this.roughness,this.roughness),this.$l.ggxV=r.mul(this.NdotL,r.sqrt(r.add(r.mul(this.NdotV,this.NdotV,r.sub(1,this.a2)),this.a2))),this.$l.ggxL=r.mul(this.NdotV,r.sqrt(r.add(r.mul(this.NdotL,this.NdotL,r.sub(1,this.a2)),this.a2))),this.$l.ggx=r.add(this.ggxV,this.ggxL),this.$if(r.greaterThan(this.ggx,0),(function(){this.$return(r.div(.5,this.ggx))})).$else((function(){this.$return(r.float(0))}))})),r.getGlobalScope()[a](e,i,s)}function On(t,e,i,s,r,a){const n=t.$builder,o="pbrDirectSheenLighting";return n.func(o,[n.float("NdotV"),n.float("NdotL"),n.float("NdotH"),n.vec3("sheenColor"),n.float("sheenRoughness")],(function(){this.$l.D=function(t,e,i){const s="lib_DCharlie",r=t.$builder;return r.func(s,[r.float("NdotH"),r.float("sheenRoughness")],(function(){this.$l.alphaG=r.mul(this.sheenRoughness,this.sheenRoughness),this.$l.invR=r.div(1,this.alphaG),this.$l.cos2h=r.mul(this.NdotH,this.NdotH),this.$l.sin2h=r.max(r.sub(1,this.cos2h),.0078125),this.$return(r.div(r.mul(r.add(this.invR,2),r.pow(this.sin2h,r.mul(this.invR,.5))),2*Math.PI))})),r.getGlobalScope()[s](e,i)}(this,this.NdotH,this.sheenRoughness),this.$l.V=function(t,e,i){const s="lib_VAshikhmin",r=t.$builder;return r.func(s,[r.float("NdotL"),r.float("NdotV")],(function(){this.$return(r.clamp(r.div(1,r.mul(r.sub(r.add(this.NdotL,this.NdotV),r.mul(this.NdotL,this.NdotV)),4)),0,1))})),r.getGlobalScope()[s](e,i)}(this,this.NdotL,this.NdotV),this.$return(n.mul(this.sheenColor,this.D,this.V))})),n.getGlobalScope()[o](e,i,s,r,a)}const Un=Xt.getCachedTypeInfo(At.F32),Vn=Xt.getCachedTypeInfo(At.F32VEC3),Gn=Xt.getCachedTypeInfo(At.F32VEC4),zn=Xt.getCachedTypeInfo(At.MAT3),kn=v.identity(),Xn="albedo",Wn="normal",Hn="emissive",Yn="occlusion",qn="specular",jn="specularColor",Zn="metallic",Kn="sheenColor",Qn="sheenRoughness",Jn="sheenLut",to="clearcoatIntensity",eo="clearcoatRoughness",io="clearcoatNormal";class so{static funcNameBRDFEnvConstantAmbient="libLM_envConstantAmbient";static funcNameBRDFEnvHemispheric="libLM_envHemispheric";static uniformAlbedoColor="libLM_USAGE_albedoColor";static uniformNormalScale="libLM_USAGE_normalScale";static uniformEmissiveFactor="libLM_USAGE_emissiveFactor";static funcNameCalcAlbedo="libLM_calcAlbedo";_doubleSideLighting;_albedo;_normalScale;_normalMapMode;_emissiveFactor;_hash;_hashVersion;_uniformVersion;_bindGroupTagList;_texCoordChannels;_textureOptions;_surfaceDataType;constructor(){this._albedo=T.one(),this._doubleSideLighting=!0,this._normalScale=1,this._normalMapMode="tangent-space",this._emissiveFactor=new T(0,0,0,1),this._hash=null,this._hashVersion=0,this._uniformVersion=0,this._bindGroupTagList=new WeakMap,this._texCoordChannels=[],this._textureOptions={},this._surfaceDataType=null}getSurfaceDataType(t){return this.createSurfaceDataType(t)}get doubleSideLighting(){return this._doubleSideLighting}set doubleSideLighting(t){this._doubleSideLighting!==!!t&&(this._doubleSideLighting=!!t,this.optionChanged(!0))}get albedo(){return this._albedo}set albedo(t){t.equalsTo(this._albedo)||(this._albedo.set(t),this.optionChanged(!1))}get albedoMap(){return this._textureOptions[Xn]?.texture??null}get albedoSampler(){return this._textureOptions[Xn]?.sampler??null}get albedoMapTexCoord(){return this._textureOptions[Xn]?.texCoordIndex??null}getTexCoordTransform(t){return this._texCoordChannels[t]?.transform??null}setTexCoordTransform(t,e){this._texCoordChannels[t]?(this._texCoordChannels[t].transform=e??kn,this.optionChanged(!1)):console.error(`setTexCoordTransform(): texCoordIndex ${t} not in use`)}setAlbedoMap(t,e,i,s){this.setTextureOptions(Xn,t,e,i,s)}get normalMap(){return this._textureOptions[Wn]?.texture??null}get normalSampler(){return this._textureOptions[Wn]?.sampler??null}get normalMapTexCoord(){return this._textureOptions[Wn]?.texCoordIndex??null}setNormalMap(t,e,i,s){this.setTextureOptions(Wn,t,e,i,s)}get normalScale(){return this._normalScale}set normalScale(t){t!==this._normalScale&&(this._normalScale=t,this.normalMap&&this.optionChanged(!1))}get emissiveMap(){return this._textureOptions[Hn]?.texture??null}get emissiveSampler(){return this._textureOptions[Hn]?.sampler??null}get emissiveMapTexCoord(){return this._textureOptions[Hn]?.texCoordIndex??null}setEmissiveMap(t,e,i,s){this.setTextureOptions(Hn,t,e,i,s)}get emissiveColor(){return this._emissiveFactor.xyz()}set emissiveColor(t){t.x===this._emissiveFactor.x&&t.y===this._emissiveFactor.y&&t.z===this._emissiveFactor.z||(this._emissiveFactor.x=t.x,this._emissiveFactor.y=t.y,this._emissiveFactor.z=t.z,this.optionChanged(!1))}get emissiveStrength(){return this._emissiveFactor.w}set emissiveStrength(t){this._emissiveFactor.w!==t&&(this._emissiveFactor.w=t,this.optionChanged(!1))}setTextureOptions(t,e,i,s,r){e=e??null;let a=this._textureOptions[t];if(!e)return void(a&&(delete this._textureOptions[t],this.optionChanged(!0)));a||(a={texture:null,texCoordIndex:null,sampler:null},this._textureOptions[t]=a),i=i??null,r=r||kn;let n=!1,o=!1;a.texture!==e&&(o||=!a.texture||!e,a.texture=e),a.sampler!==i&&(n||=!!a.texture,a.sampler=i);const h=this.addTexCoordChannel(s,r);return h!==a.texCoordIndex&&(a.texCoordIndex=h,n||=!!a.texture),(n||o)&&this.optionChanged(o),h}calculateHash(){return`${this._texCoordChannels.map((t=>t.srcLocation)).join("")}_${this.albedoMap?this.albedoMapTexCoord+1:0}_${this.normalMap?`${this.normalMapTexCoord+1}:${"tangent-space"===this._normalMapMode?1:0}`:0}_${this.emissiveMap?this.emissiveMapTexCoord+1:0}`}setupUniforms(t,e){const i=t.$builder,s=this;if("vertex"===i.shaderKind)for(let e=0;e<s._texCoordChannels.length;e++)t[`lm_texTransform${e}`]=i.mat4().uniform(2);else t.lm_albedo=i.vec4().uniform(2).tag(so.uniformAlbedoColor),this.normalMap&&(t.lm_normalScale=i.float().uniform(2).tag(so.uniformNormalScale)),t.lm_emissiveFactor=i.vec4().uniform(2).tag(so.uniformEmissiveFactor),t.surfaceData=i.defineStructByType(s.getSurfaceDataType(e.drawEnvLight?e.env.light.envLight:null))(),this.setupTextureUniforms(t)}applyUniforms(t,e){for(let e=0;e<this._texCoordChannels.length;e++)t.setValue(`lm_texTransform${e}`,this._texCoordChannels[e].transform);t.setValue("lm_albedo",this._albedo),this.normalMap&&t.setValue("lm_normalScale",this._normalScale),t.setValue("lm_emissiveFactor",this._emissiveFactor),this.applyTextureUniforms(t)}getSurfaceData(t,e,i,s,r,a){const n="lib_getSurfaceData",o=t.$builder,h=this,u=[i.xyz],l=[o.vec3("worldPos")];s&&(l.push(o.vec3("worldNormal")),u.push(s),r&&(l.push(o.vec3("worldTangent"),o.vec3("worldBinormal")),u.push(r,a))),o.func(n,l,(function(){this.$l.normalInfo=h.calculateNormal(this,this.worldPos,s?this.worldNormal:null,r?this.worldTangent:null,r?this.worldBinormal:null),this.surfaceData.TBN=this.normalInfo.TBN,this.surfaceData.normal=this.normalInfo.normal,this.surfaceData.viewVec=o.normalize(o.sub(qa.getCameraPosition(this),this.worldPos)),this.surfaceData.NdotV=o.clamp(o.dot(this.surfaceData.normal,this.surfaceData.viewVec),1e-4,1),this.surfaceData.diffuse=h.calculateAlbedo(this),this.surfaceData.accumDiffuse=o.vec3(0),this.surfaceData.accumSpecular=o.vec3(0),this.surfaceData.accumEmissive=h.calculateEmissive(this),this.surfaceData.accumColor=o.vec3(0),h.fillSurfaceData(this,e)})),o.getGlobalScope()[n](...u)}getTextureUniformName(t){return`lm_${t}_Map`}calculateTexCoord(t,e){return t.$builder.mul(t[`lm_texTransform${e}`],t.$builder.vec4(t.$inputs[`texcoord${this._texCoordChannels[e].srcLocation}`],0,1)).xy}calculateTexCoordNoInput(t,e,i){return t.$builder.mul(t[`lm_texTransform${e}`],t.$builder.vec4(i,0,1)).xy}calculateEmissive(t){const e=t.$builder,i=t[this.getTextureUniformName(Hn)],s=t.$query(so.uniformEmissiveFactor);if(s){const r=e.mul(s.rgb,s.a);if(i){const s=t.$inputs[`texcoord${this.emissiveMapTexCoord}`];return e.mul(e.textureSample(i,s).rgb,r).rgb}return r}return e.vec3(0)}calculateAlbedo(t){const e=this,i=t.$builder;return i.func(so.funcNameCalcAlbedo,[],(function(){const s=this[e.getTextureUniformName(Xn)],r=s&&this.$inputs[`texcoord${e.albedoMapTexCoord}`],a=t.$query(qa.USAGE_VERTEX_COLOR);let n=t.$query(so.uniformAlbedoColor);if(s&&r){const t=i.textureSample(s,r);n=i.mul(n,t)}a&&(n=i.mul(n,a)),this.$return(n)})),i.getGlobalScope()[so.funcNameCalcAlbedo]()}sampleNormalMapWithTBN(t,e,i,s,r){const a=t.$builder,n=a.sub(a.mul(a.textureSample(e,i).rgb,2),a.vec3(1)),o=a.mul(n,a.vec3(a.vec3(s).xx,1));return a.normalize(a.mul(r,o))}sampleNormalMap(t,e,i,s){const r=t.$builder,a=r.sub(r.mul(r.textureSample(e,i).rgb,2),r.vec3(1)),n=r.mul(a,r.vec3(r.vec3(s).xx,1));return r.normalize(n)}calculateNormalWithTBN(t,e,i){return this.normalMap?"tangent-space"===this._normalMapMode?this.sampleNormalMapWithTBN(t,t[this.getTextureUniformName(Wn)],e,t.$query(so.uniformNormalScale)||t.$builder.float(1),i):this.sampleNormalMap(t,t[this.getTextureUniformName(Wn)],e,t.$query(so.uniformNormalScale)||t.$builder.float(1)):i[2]}calculateNormal(t,e,i,s,r){const a=t.$builder,n=this.normalMap?t.$inputs[`texcoord${this.normalMapTexCoord}`]??a.vec2(0):this.albedoMap?t.$inputs[`texcoord${this.albedoMapTexCoord}`]??a.vec2(0):a.vec2(0);let o;return o=i?s?a.mat3(a.normalize(s),a.normalize(r),a.normalize(i)):function(t,e,i,s,r){const a="lib_calculateTBNWithNormal",n=t.$builder;return n.func(a,[n.vec3("posW"),n.vec3("normalW"),n.vec2("uv")],(function(){this.$l.uv_dx=n.dpdx(n.vec3(this.uv,0)),this.$l.uv_dy=n.dpdy(n.vec3(this.uv,0)),this.$if(n.lessThanEqual(n.add(n.length(this.uv_dx),n.length(this.uv_dy)),1e-6),(function(){this.uv_dx=n.vec3(1,0,0),this.uv_dy=n.vec3(0,1,0)})),this.$l.t_=n.div(n.sub(n.mul(n.dpdx(this.posW),this.uv_dy.y),n.mul(n.dpdy(this.posW),this.uv_dx.y)),n.sub(n.mul(this.uv_dx.x,this.uv_dy.y),n.mul(this.uv_dx.y,this.uv_dy.x))),this.$l.ng=n.normalize(this.normalW),this.$l.t=n.normalize(n.sub(this.t_,n.mul(this.ng,n.dot(this.ng,this.t_)))),this.$l.b=n.cross(this.ng,this.t),r&&this.$if(n.not(this.$builtins.frontFacing),(function(){this.t=n.mul(this.t,-1),this.b=n.mul(this.b,-1),this.ng=n.mul(this.ng,-1)})),this.$return(n.mat3(this.t,this.b,this.ng))})),n.getGlobalScope()[a](e,i,s)}(t,e,i,n,this._doubleSideLighting):function(t,e,i,s){const r="lib_calculateTBN",a=t.$builder;return a.func(r,[a.vec3("posW"),a.vec2("uv")],(function(){this.$l.uv_dx=a.dpdx(a.vec3(this.uv,0)),this.$l.uv_dy=a.dpdy(a.vec3(this.uv,0)),this.$if(a.lessThanEqual(a.add(a.length(this.uv_dx),a.length(this.uv_dy)),1e-6),(function(){this.uv_dx=a.vec3(1,0,0),this.uv_dy=a.vec3(0,1,0)})),this.$l.t_=a.div(a.sub(a.mul(a.dpdx(this.posW),this.uv_dy.y),a.mul(a.dpdy(this.posW),this.uv_dx.y)),a.sub(a.mul(this.uv_dx.x,this.uv_dy.y),a.mul(this.uv_dx.y,this.uv_dy.x))),this.$l.ng=a.normalize(a.cross(a.dpdx(this.posW),a.dpdy(this.posW))),this.$l.t=a.normalize(a.sub(this.t_,a.mul(this.ng,a.dot(this.ng,this.t_)))),this.$l.b=a.cross(this.ng,this.t),s&&this.$if(a.not(this.$builtins.frontFacing),(function(){this.t=a.mul(this.t,-1),this.b=a.mul(this.b,-1),this.ng=a.mul(this.ng,-1)})),this.$return(a.mat3(this.t,this.b,this.ng))})),a.getGlobalScope()[r](e.xyz,i)}(t,e,n,this._doubleSideLighting),this.calculatePixelNormal(t,o)}finalComposite(t){const e="lib_finalComposite",i=t.$builder,s=this;return i.func(e,[],(function(){this.surfaceData.accumColor=i.add(this.surfaceData.accumDiffuse,this.surfaceData.accumSpecular,this.surfaceData.accumEmissive),s.compositeSurfaceData(this),this.$return(Rn.debugChannel?this.surfaceData.debugColor:i.vec4(this.surfaceData.accumColor,this.surfaceData.diffuse.a))})),i.getGlobalScope()[e]()}getHash(){return null===this._hash&&(this._hash=`${this.constructor.name}_${this.calculateHash()}`),this._hash}peekHash(){return this._hash}compositeSurfaceData(t){const e=t.$builder;switch(Rn.debugChannel){case"normal":t.surfaceData.debugColor=e.vec4(e.add(e.mul(t.surfaceData.TBN[2],.5),e.vec3(.5)),1);break;case"tangent":t.surfaceData.debugColor=e.vec4(e.add(e.mul(t.surfaceData.TBN[0],.5),e.vec3(.5)),1);break;case"binormal":t.surfaceData.debugColor=e.vec4(e.add(e.mul(t.surfaceData.TBN[1],.5),e.vec3(.5)),1);break;case"shadingNormal":t.surfaceData.debugColor=e.vec4(e.add(e.mul(t.surfaceData.normal,.5),e.vec3(.5)),1)}}createSurfaceDataType(t){const e=Rn.debugChannel?[{name:"debugColor",type:Gn}]:[];return new Wt("","default",[{name:"diffuse",type:Gn},{name:"normal",type:Vn},{name:"viewVec",type:Vn},{name:"NdotV",type:Un},{name:"TBN",type:zn},{name:"accumDiffuse",type:Vn},{name:"accumSpecular",type:Vn},{name:"accumEmissive",type:Vn},{name:"accumColor",type:Vn},...e])}isTextureUsed(t){return!!this._textureOptions[t]?.texture}fillSurfaceData(t,e){Rn.debugChannel&&(t.surfaceData.debugColor=t.$builder.vec4(t.surfaceData.diffuse.rgb,1))}applyTextureUniforms(t){for(const e in this._textureOptions)if(this.isTextureUsed(e)){const i=this.getTextureUniformName(e),s=this._textureOptions[e];t.setTexture(i,s.texture,s.sampler)}}setupTextureUniforms(t){const e=t.$builder;for(const i in this._textureOptions)if(this.isTextureUsed(i)){const s=this.getTextureUniformName(i),r=this._textureOptions[i].texture;let a;if(r.isTexture2D())a=e.tex2D().uniform(2);else if(r.isTextureCube())a=e.texCube().uniform(2);else if(r.isTexture3D())a=e.tex3D().uniform(2);else if(r.isTexture2DArray())a=e.tex2DArray().uniform(2);else{if(!r.isTextureVideo())throw new Error("Unsupported light model texture type");a=e.texExternal().uniform(2)}r.isFilterable()||a.sampleType("unfilterable-float"),t[s]=a}}addTexCoordChannel(t,e){e=e||v.identity();let i=this._texCoordChannels.findIndex((i=>i.srcLocation===t&&i.transform.equalsTo(e)));return i<0&&(i=this._texCoordChannels.length,this._texCoordChannels.push({srcLocation:t,transform:new v(e)})),i}calculatePixelNormal(t,e){const i=this.calculateNormalWithTBN(t,t.$inputs[`texcoord${this.normalMapTexCoord}`],e),s=t.$builder;return s.defineStruct([s.mat3("TBN"),s.vec3("normal")])(e,i)}optionChanged(t){this._uniformVersion++,t&&(this._hash=null,this._surfaceDataType=null,this._hashVersion++)}isTexCoordIndexUsed(t){return"number"==typeof this._texCoordChannels[t]?.srcLocation}isTexCoordSrcLocationUsed(t){return this._texCoordChannels.findIndex((e=>e.srcLocation===t))>=0}getTexCoordSrcLocation(t){return this._texCoordChannels[t].srcLocation}isNormalUsed(){return!0}applyUniformsIfOutdated(t,e){const i=this._bindGroupTagList.get(t);i&&i[0]===this._uniformVersion&&i[1]===t.cid||(i?(i[0]=this._uniformVersion,i[1]=t.cid):this._bindGroupTagList.set(t,[this._uniformVersion,t.cid]),this.applyUniforms(t,e))}}class ro extends so{static funcNameBRDFEnvIBL="lib_lambertLM_envIBL";static funcNameBRDFDirect="lib_lambertLM_direct";supportLighting(){return!0}envBRDF(t,e){const i=e.$builder;t?.hasIrradiance()&&(e.surfaceData.accumDiffuse=i.add(e.surfaceData.accumDiffuse,i.mul(t.getIrradiance(e,e.surfaceData.normal).rgb,e.surfaceData.diffuse.rgb,qa.getEnvLightStrength(e))))}directBRDF(t,e,i){const s=t.$builder;s.func(ro.funcNameBRDFDirect,[s.vec3("attenuation")],(function(){this.surfaceData.accumDiffuse=s.add(this.surfaceData.accumDiffuse,s.mul(this.surfaceData.diffuse.rgb,this.attenuation))})),s.getGlobalScope()[ro.funcNameBRDFDirect](i)}}class ao extends so{static funcNameCalcPBRLight="lib_PBRLM_calcPBRLight";static funcNameIllumEnvLight="lib_PBRLM_illumEnvLight_pbr";static uniformF0="PBRLM_f0";static uniformOcclusionStrength="PBRLM_occlusionStrength";static uniformSheenFactor="lib_PBRLM_sheenFactor";static uniformClearcoatFactor="lib_PBRLM_clearcoatFactor";static uniformClearcoatNormalScale="lib_PBRLM_clearcoatNormalScale";static ggxLut=null;_f0;_occlusionStrength;_sheen;_sheenFactor;_clearcoat;_clearcoatFactor;static getGGXLUT(){return this.ggxLut||(this.ggxLut=this.createGGXLUT(Y.instance.device,1024)),this.ggxLut}static createGGXLUT(t,e){const i=t.buildRenderProgram({vertex(e){this.$inputs.pos=e.vec2().attrib("position"),this.$outputs.uv=e.vec2(),e.main((function(){this.$builtins.position=e.vec4(this.$inputs.pos,0,1),this.$outputs.uv=e.add(e.mul(this.$inputs.pos.xy,.5),e.vec2(.5)),"webgpu"===t.type&&(this.$builtins.position.y=e.neg(this.$builtins.position.y))}))},fragment(e){this.$outputs.color=e.vec4();const i=1024;"webgl"===t.type?(e.func("radicalInverse_VdC",[e.int("bits")],(function(){this.$l.rand=e.float(0),this.$l.denom=e.float(1),this.$l.invBase=e.float(.5),this.$l.n=this.bits,this.$for(e.int("i"),0,32,(function(){this.denom=e.mul(this.denom,2),this.rand=e.add(this.rand,e.div(e.mod(e.float(this.n),2),this.denom)),this.n=e.div(this.n,2),this.$if(e.equal(this.n,0),(function(){this.$break()}))})),this.$return(this.rand)})),e.func("hammersley2d",[e.int("i"),e.int("N")],(function(){this.$return(e.vec2(e.div(e.float(this.i),e.float(this.N)),this.radicalInverse_VdC(this.i)))}))):(e.func("radicalInverse_VdC",[e.uint("bits")],(function(){this.$l.n=this.bits,this.n=e.compOr(e.sal(this.n,16),e.sar(this.n,16)),this.n=e.compOr(e.sal(e.compAnd(this.n,1431655765),1),e.sar(e.compAnd(this.n,2863311530),1)),this.n=e.compOr(e.sal(e.compAnd(this.n,858993459),2),e.sar(e.compAnd(this.n,3435973836),2)),this.n=e.compOr(e.sal(e.compAnd(this.n,252645135),4),e.sar(e.compAnd(this.n,4042322160),4)),this.n=e.compOr(e.sal(e.compAnd(this.n,16711935),8),e.sar(e.compAnd(this.n,4278255360),8)),this.$return(e.mul(e.float(this.n),2.3283064365386963e-10))})),e.func("hammersley2d",[e.int("i"),e.int("N")],(function(){this.$return(e.vec2(e.div(e.float(this.i),e.float(this.N)),this.radicalInverse_VdC(e.uint(this.i))))}))),e.func("generateTBN",[e.vec3("normal")],(function(){this.$l.bitangent=e.vec3(0,1,0),this.$l.NoU=this.normal.y,this.$l.epsl=1e-7,this.$if(e.lessThanEqual(e.sub(1,e.abs(this.normal.y)),this.epsl),(function(){this.bitangent=this.$choice(e.greaterThan(this.normal.y,0),e.vec3(0,0,1),e.vec3(0,0,-1))})),this.$l.tangent=e.normalize(e.cross(this.bitangent,this.normal)),this.bitangent=e.cross(this.normal,this.tangent),this.$return(e.mat3(this.tangent,this.bitangent,this.normal))})),e.func("D_Charlie",[e.float("sheenRoughness"),e.float("NdotH")],(function(){this.$l.roughness=e.max(this.sheenRoughness,1e-6),this.$l.invR=e.div(1,this.roughness),this.$l.cos2h=e.mul(this.NdotH,this.NdotH),this.$l.sin2h=e.sub(1,this.cos2h),this.$return(e.div(e.mul(e.add(this.invR,2),e.pow(this.sin2h,e.mul(this.invR,.5))),2*Math.PI))})),e.func("smithGGXCorrelated",[e.float("NoV"),e.float("NoL"),e.float("roughness")],(function(){this.$l.a2=e.mul(this.roughness,this.roughness,this.roughness,this.roughness),this.$l.GGXV=e.mul(this.NoL,e.sqrt(e.add(e.mul(this.NoV,this.NoV,e.sub(1,this.a2)),this.a2))),this.$l.GGXL=e.mul(this.NoV,e.sqrt(e.add(e.mul(this.NoL,this.NoL,e.sub(1,this.a2)),this.a2))),this.$return(e.div(.5,e.add(this.GGXV,this.GGXL)))})),e.func("V_Ashikhmin",[e.float("NdotL"),e.float("NdotV")],(function(){this.$return(e.clamp(e.div(1,e.mul(e.sub(e.add(this.NdotL,this.NdotV),e.mul(this.NdotL,this.NdotV)),4)),0,1))})),e.func("importanceSample",[e.vec2("xi"),e.vec3("normal"),e.float("roughness"),e.vec3("ggx").out(),e.vec3("charlie").out()],(function(){this.$l.alphaRoughness=e.mul(this.roughness,this.roughness),this.$l.cosTheta=e.clamp(e.sqrt(e.div(e.sub(1,this.xi.y),e.add(1,e.mul(e.sub(e.mul(this.alphaRoughness,this.alphaRoughness),1),this.xi.y)))),0,1),this.$l.sinTheta=e.sqrt(e.sub(1,e.mul(this.cosTheta,this.cosTheta))),this.$l.phi=e.mul(this.xi.x,2*Math.PI),this.$l.TBN=this.generateTBN(this.normal),this.$l.localSpaceDir=e.normalize(e.vec3(e.mul(this.sinTheta,e.cos(this.phi)),e.mul(this.sinTheta,e.sin(this.phi)),this.cosTheta)),this.ggx=e.mul(this.TBN,this.localSpaceDir),this.sinTheta=e.pow(this.xi.y,e.div(this.alphaRoughness,e.add(e.mul(this.alphaRoughness,2),1))),this.cosTheta=e.sqrt(e.sub(1,e.mul(this.sinTheta,this.sinTheta))),this.localSpaceDir=e.normalize(e.vec3(e.mul(this.sinTheta,e.cos(this.phi)),e.mul(this.sinTheta,e.sin(this.phi)),this.cosTheta)),this.charlie=e.mul(this.TBN,this.localSpaceDir)})),e.func("integrateBRDF",[e.float("NoV"),e.float("roughness")],(function(){this.$l.V=e.vec3(e.sub(1,e.mul(this.NoV,this.NoV)),0,this.NoV),this.$l.a=e.float(0),this.$l.b=e.float(0),this.$l.c=e.float(0),this.$l.n=e.vec3(0,0,1),this.$for(e.int("i"),0,i,(function(){this.$l.xi=this.hammersley2d(this.i,i),this.$l.ggxSample=e.vec3(),this.$l.charlieSample=e.vec3(),this.importanceSample(this.xi,this.n,this.roughness,this.ggxSample,this.charlieSample),this.$l.ggxL=e.normalize(e.reflect(e.neg(this.V),this.ggxSample.xyz)),this.$l.ggxNoL=e.clamp(this.ggxL.z,0,1),this.$l.ggxNoH=e.clamp(this.ggxSample.z,0,1),this.$l.ggxVoH=e.clamp(e.dot(this.V,this.ggxSample.xyz),0,1),this.$l.charlieL=e.normalize(e.reflect(e.neg(this.V),this.charlieSample.xyz)),this.$l.charlieNoL=e.clamp(this.charlieL.z,0,1),this.$l.charlieNoH=e.clamp(this.charlieSample.z,0,1),this.$l.charlieVoH=e.clamp(e.dot(this.V,this.charlieSample.xyz),0,1),this.$if(e.greaterThan(this.ggxNoL,0),(function(){this.$l.pdf=e.div(e.mul(this.smithGGXCorrelated(this.NoV,this.ggxNoL,this.roughness),this.ggxVoH,this.ggxNoL),this.ggxNoH),this.$l.Fc=e.pow(e.sub(1,this.ggxVoH),5),this.a=e.add(this.a,e.mul(e.sub(1,this.Fc),this.pdf)),this.b=e.add(this.b,e.mul(this.Fc,this.pdf))})),this.$if(e.greaterThan(this.charlieNoL,0),(function(){this.$l.sheenDistribution=this.D_Charlie(this.roughness,this.charlieNoH),this.$l.sheenVis=this.V_Ashikhmin(this.charlieNoL,this.NoV),this.c=e.add(this.c,e.mul(this.sheenVis,this.sheenDistribution,this.charlieNoL,this.charlieVoH))}))})),this.$return(e.div(e.vec3(e.mul(this.a,4),e.mul(this.b,4),e.mul(this.c,8*Math.PI)),i))})),e.main((function(){this.$outputs.color=e.vec4(this.integrateBRDF(this.$inputs.uv.x,this.$inputs.uv.y),1)}))}}),s=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]}),r=t.createRenderStateSet();r.useRasterizerState().setCullMode("none"),r.useDepthState().enableTest(!1).enableWrite(!1);const a=t.createTexture2D("rgba8unorm",e,e,{samplerOptions:{mipFilter:"none"}});a.name="GGXLUT";const n=t.createFrameBuffer([a],null);return t.pushDeviceStates(),t.setProgram(i),t.setVertexLayout(s),t.setRenderStates(r),t.setFramebuffer(n),t.draw("triangle-strip",0,4),t.popDeviceStates(),n.dispose(),s.dispose(),i.dispose(),a}constructor(){super(),this._f0=new T(.04,.04,.04,1.5),this._sheen=!1,this._sheenFactor=T.zero(),this._clearcoat=!1,this._clearcoatFactor=new T(0,0,1,0),this._occlusionStrength=1}get ior(){return this._f0.w}set ior(t){if(t!==this._f0.w){let e=(t-1)/(t+1);e*=e,this._f0.setXYZW(e,e,e,t),this.optionChanged(!1)}}get occlusionStrength(){return this._occlusionStrength}set occlusionStrength(t){this._occlusionStrength!==t&&(this._occlusionStrength=t,this.occlusionMap&&this.optionChanged(!1))}get occlusionMap(){return this._textureOptions[Yn]?.texture??null}get occlusionSampler(){return this._textureOptions[Yn]?.sampler??null}get occlusionMapTexCoord(){return this._textureOptions[Yn]?.texCoordIndex??null}setOcclusionMap(t,e,i,s){this.setTextureOptions(Yn,t,e,i,s)}get useSheen(){return this._sheen}set useSheen(t){this._sheen!==!!t&&(this._sheen=!!t,this.optionChanged(!0))}get sheenColorFactor(){return this._sheenFactor.xyz()}set sheenColorFactor(t){t.x===this._sheenFactor.x&&t.y===this._sheenFactor.y&&t.z===this._sheenFactor.z||(this._sheenFactor.x=t.x,this._sheenFactor.y=t.y,this._sheenFactor.z=t.z,this._sheen&&this.optionChanged(!1))}get sheenRoughnessFactor(){return this._sheenFactor.w}set sheenRoughnessFactor(t){t!==this._sheenFactor.w&&(this._sheenFactor.w=t,this._sheen&&this.optionChanged(!1))}get sheenLut(){return this._textureOptions[Jn]?.texture??null}setSheenLut(t){this.setTextureOptions(Jn,t,null,0,null)}get sheenColorMap(){return this._textureOptions[Kn]?.texture??null}get sheenColorSampler(){return this._textureOptions[Kn]?.sampler??null}get sheenColorMapTexCoord(){return this._textureOptions[Kn]?.texCoordIndex??null}setSheenColorMap(t,e,i,s){this.setTextureOptions(Kn,t,e,i,s)}get sheenRoughnessMap(){return this._textureOptions[Qn]?.texture??null}get sheenRoughnessSampler(){return this._textureOptions[Qn]?.sampler??null}get sheenRoughnessMapTexCoord(){return this._textureOptions[Qn]?.texCoordIndex??null}setSheenRoughnessMap(t,e,i,s){this.setTextureOptions(Qn,t,e,i,s)}get useClearcoat(){return this._clearcoat}set useClearcoat(t){this._clearcoat!==!!t&&(this._clearcoat=!!t,this.optionChanged(!0))}get clearcoatIntensity(){return this._clearcoatFactor.x}set clearcoatIntensity(t){t!==this._clearcoatFactor.x&&(this._clearcoatFactor.x=t,this._clearcoat&&this.optionChanged(!1))}get clearcoatRoughnessFactor(){return this._clearcoatFactor.y}set clearcoatRoughnessFactor(t){t!==this._clearcoatFactor.y&&(this._clearcoatFactor.y=t,this._clearcoat&&this.optionChanged(!1))}get clearcoatNormalScale(){return this._clearcoatFactor.z}set clearcoatNormalScale(t){t!==this._clearcoatFactor.z&&(this._clearcoatFactor.z=t,this._clearcoat&&this.optionChanged(!1))}get clearcoatIntensityMap(){return this._textureOptions[to]?.texture??null}get clearcoatIntensitySampler(){return this._textureOptions[to]?.sampler??null}get clearcoatIntensityMapTexCoord(){return this._textureOptions[to]?.texCoordIndex??null}setClearcoatIntensityMap(t,e,i,s){this.setTextureOptions(to,t,e,i,s)}get clearcoatRoughnessMap(){return this._textureOptions[eo]?.texture??null}get clearcoatRoughnessSampler(){return this._textureOptions[eo]?.sampler??null}get clearcoatRoughnessMapTexCoord(){return this._textureOptions[eo]?.texCoordIndex??null}setClearcoatRoughnessMap(t,e,i,s){this.setTextureOptions(eo,t,e,i,s)}get clearcoatNormalMap(){return this._textureOptions[io]?.texture??null}get clearcoatNormalSampler(){return this._textureOptions[io]?.sampler??null}get clearcoatNormalMapTexCoord(){return this._textureOptions[io]?.texCoordIndex??null}setClearcoatNormalMap(t,e,i,s){this.setTextureOptions(io,t,e,i,s)}calculateHash(){const t=this.occlusionMap?this.occlusionMapTexCoord+1:0,e=this.clearcoatIntensityMap?this.clearcoatIntensityMapTexCoord+1:0,i=this.clearcoatRoughnessMap?this.clearcoatRoughnessMapTexCoord+1:0,s=this.clearcoatNormalMap?this.clearcoatNormalMapTexCoord+1:0,r=this.useClearcoat?`(${e}-${i}-${s})`:"",a=this.sheenColorMap?this.sheenColorMapTexCoord+1:0,n=this.sheenRoughnessMap?this.sheenRoughnessMapTexCoord+1:0,o=this.useSheen?`(${a}-${n})`:"";return`${super.calculateHash()}_${t}_${o}_${r}`}setupUniforms(t,e){super.setupUniforms(t,e),"fragment"===t.$builder.shaderKind&&(e.drawEnvLight&&(t.ggxLut=t.$builder.tex2D().uniform(2)),t.lm_f0=t.$builder.vec4().uniform(2).tag(ao.uniformF0),this.occlusionMap&&(t.lm_occlusionStrength=t.$builder.float().uniform(2).tag(ao.uniformOcclusionStrength)),this._sheen&&(t.lm_sheenFactor=t.$builder.vec4().uniform(2).tag(ao.uniformSheenFactor)),this._clearcoat&&(t.lm_clearcoatFactor=t.$builder.vec4().uniform(2).tag(ao.uniformClearcoatFactor)))}applyUniforms(t,e){super.applyUniforms(t,e),e.drawEnvLight&&t.setTexture("ggxLut",ao.getGGXLUT()),t.setValue("lm_f0",this._f0),this.occlusionMap&&t.setValue("lm_occlusionStrength",this._occlusionStrength),this._sheen&&t.setValue("lm_sheenFactor",this._sheenFactor),this._clearcoat&&t.setValue("lm_clearcoatFactor",this._clearcoatFactor)}createSurfaceDataType(t){const e=super.createSurfaceDataType(t),i=[{name:"metallic",type:Un},{name:"roughness",type:Un},{name:"f0",type:Gn},{name:"f90",type:Vn},{name:"occlusion",type:Gn},{name:"irradiance",type:Vn},{name:"radiance",type:Vn}];return t&&i.push({name:"ggxLutSample",type:Gn}),this._sheen&&i.push({name:"sheenColor",type:Vn},{name:"sheenRoughness",type:Un},{name:"sheenAlbedoScaling",type:Un},{name:"sheenContrib",type:Vn}),this._clearcoat&&(i.push({name:"clearcoatFactor",type:Gn},{name:"clearcoatNormal",type:Vn},{name:"clearcoatNdotV",type:Un},{name:"clearcoatFresnel",type:Vn},{name:"clearcoatContrib",type:Vn},{name:"radianceClearcoat",type:Vn}),t&&i.push({name:"clearcoatGGXLutSample",type:Gn})),i.length>0?e.extends("",i):e}fillSurfaceData(t,e){super.fillSurfaceData(t,e);const i="lib_fillSurfaceDataPBRCommon",s=t.$builder,r=this;s.func(i,[],(function(){this.surfaceData.f0=this.$query(ao.uniformF0),this.surfaceData.f90=s.vec3(1);const t=qa.getEnvLightStrength(this);if(r.occlusionMap){const e=this.$query(ao.uniformOcclusionStrength),i=this.$inputs[`texcoord${r.occlusionMapTexCoord??r.albedoMapTexCoord}`];this.surfaceData.occlusion=s.textureSample(this[r.getTextureUniformName(Yn)],i),this.surfaceData.occlusion.r=s.mul(s.add(s.mul(e,s.sub(this.surfaceData.occlusion.r,1)),1),t)}else this.surfaceData.occlusion=s.vec4(t);if(r.useClearcoat){if(this.surfaceData.clearcoatFactor=this.$query(ao.uniformClearcoatFactor),r.clearcoatNormalMap){const t=this[r.getTextureUniformName(io)],e=this.$inputs[`texcoord${r.clearcoatNormalMapTexCoord??r.albedoMapTexCoord}`];this.$l.ccNormal=s.sub(s.mul(s.textureSample(t,e).rgb,2),s.vec3(1)),this.ccNormal=s.mul(this.ccNormal,s.vec3(this.surfaceData.clearcoatFactor.z,this.surfaceData.clearcoatFactor.z,1)),this.surfaceData.clearcoatNormal=s.normalize(s.mul(this.surfaceData.TBN,this.ccNormal)),this.surfaceData.clearcoatNdotV=s.clamp(s.dot(this.surfaceData.clearcoatNormal,this.surfaceData.viewVec),1e-4,1)}else this.surfaceData.clearcoatNormal=this.surfaceData.TBN[2],this.surfaceData.clearcoatNdotV=this.surfaceData.NdotV;if(r.clearcoatIntensityMap){const t=this[r.getTextureUniformName(to)],e=this.$inputs[`texcoord${r.clearcoatIntensityMapTexCoord??r.albedoMapTexCoord}`];this.surfaceData.clearcoatFactor.x=s.mul(this.surfaceData.clearcoatFactor.x,s.textureSample(t,e).r)}if(r.clearcoatRoughnessMap){const t=this[r.getTextureUniformName(eo)],e=this.$inputs[`texcoord${r.clearcoatRoughnessMapTexCoord??r.albedoMapTexCoord}`];this.surfaceData.clearcoatFactor.y=s.mul(this.surfaceData.clearcoatFactor.y,s.textureSample(t,e).g)}this.surfaceData.clearcoatFactor.y=s.clamp(this.surfaceData.clearcoatFactor.y,0,1),this.surfaceData.clearcoatContrib=s.vec3(0),e&&(this.surfaceData.clearcoatGGXLutSample=s.clamp(s.textureSample(this.ggxLut,s.vec2(this.surfaceData.NdotV,this.surfaceData.clearcoatFactor.y)),s.vec4(0),s.vec4(1)))}if(r._sheen){if(this.$l.sheenColor=this.$query(ao.uniformSheenFactor).rgb,this.$l.sheenRoughness=this.$query(ao.uniformSheenFactor).a,r.sheenColorMap){const t=this[r.getTextureUniformName(Kn)],e=this.$inputs[`texcoord${r.sheenColorMapTexCoord??r.albedoMapTexCoord}`];this.$l.sheenColor=s.mul(this.$l.sheenColor,s.textureSample(t,e).rgb)}if(r.sheenRoughnessMap){const t=this[r.getTextureUniformName(Qn)],e=this.$inputs[`texcoord${r.sheenRoughnessMapTexCoord??r.albedoMapTexCoord}`];this.$l.sheenRoughness=s.mul(this.$l.sheenRoughness,s.textureSample(t,e).a)}if(r.sheenLut){const t=this[r.getTextureUniformName(Jn)];this.$l.sheenDFG=s.textureSample(t,s.vec2(this.surfaceData.NdotV,this.sheenRoughness)).b}else this.$l.sheenDFG=.157;this.surfaceData.sheenAlbedoScaling=s.sub(1,s.mul(s.max(s.max(this.sheenColor.r,this.sheenColor.g),this.sheenColor.b),this.sheenDFG)),this.surfaceData.sheenColor=this.sheenColor,this.surfaceData.sheenRoughness=this.sheenRoughness,this.surfaceData.sheenContrib=s.vec3(0)}})),s.getGlobalScope()[i]()}iblSpecular(t,e,i,s,r,a,n){const o=t.$builder,h="lib_PBRLM_iblspecular_pbr";return o.func(h,[o.vec4("brdf"),o.vec3("f0"),o.vec3("radiance"),o.float("NdotV"),o.float("roughness"),o.float("specularWeight")],(function(){this.$l.f_ab=this.brdf.rg,this.$l.Fr=o.sub(o.max(o.vec3(o.sub(1,this.roughness)),this.f0),this.f0),this.$l.k_S=o.add(this.f0,o.mul(this.Fr,o.pow(o.sub(1,this.NdotV),5))),this.$l.FssEss=o.add(o.mul(this.k_S,this.f_ab.x),o.vec3(this.f_ab.y)),this.$return(o.mul(this.radiance,this.FssEss,this.specularWeight))})),o.getGlobalScope()[h](e,i,s,r,a,n)}iblDiffuse(t,e,i,s,r,a,n,o){const h=t.$builder,u="lib_PBRLM_ibldiffuse_pbr";return h.func(u,[h.vec4("brdf"),h.vec3("f0"),h.vec3("diffuse"),h.vec3("irradiance"),h.float("NdotV"),h.float("roughness"),h.float("specularWeight")],(function(){this.$l.f_ab=this.brdf.rg,this.$l.Fr=h.sub(h.max(h.vec3(h.sub(1,this.roughness)),this.f0),this.f0),this.$l.k_S=h.add(this.f0,h.mul(this.Fr,h.pow(h.sub(1,this.NdotV),5))),this.$l.FssEss=h.add(h.mul(this.k_S,this.f_ab.x,this.specularWeight),h.vec3(this.f_ab.y)),this.$l.Ems=h.sub(1,h.add(this.f_ab.x,this.f_ab.y)),this.$l.F_avg=h.mul(h.add(this.f0,h.div(h.sub(h.vec3(1),this.f0),21)),this.specularWeight),this.$l.FmsEms=h.div(h.mul(this.FssEss,this.F_avg,this.Ems),h.sub(h.vec3(1),h.mul(this.F_avg,this.Ems))),this.$l.k_D=h.mul(this.diffuse,h.add(h.sub(h.vec3(1),this.FssEss),this.FmsEms)),this.$return(h.mul(h.add(this.FmsEms,this.k_D),this.irradiance))})),h.getGlobalScope()[u](e,i,s,r,a,n,o)}illumEnvLight(t,e){const i=t.$builder,s=this;i.func(ao.funcNameIllumEnvLight,[],(function(){e.hasRadiance()&&(this.$l.iblSpecular=s.iblSpecular(this,this.surfaceData.ggxLutSample,this.surfaceData.f0.rgb,this.surfaceData.radiance,this.surfaceData.NdotV,this.surfaceData.roughness,this.surfaceData.specularWeight),this.surfaceData.accumSpecular=i.add(this.surfaceData.accumSpecular,i.mul(this.iblSpecular,this.surfaceData.occlusion.r))),e.hasIrradiance()&&(this.$l.iblDiffuse=s.iblDiffuse(this,this.surfaceData.ggxLutSample,this.surfaceData.f0.rgb,this.surfaceData.diffuse.rgb,this.surfaceData.irradiance,this.surfaceData.NdotV,this.surfaceData.roughness,this.surfaceData.specularWeight),this.surfaceData.accumDiffuse=i.add(this.surfaceData.accumDiffuse,i.mul(this.iblDiffuse,this.surfaceData.occlusion.r))),s._clearcoat&&(this.$l.ccSpecular=s.iblSpecular(this,this.surfaceData.ggxLutSample,this.surfaceData.f0.rgb,this.surfaceData.radianceClearcoat,this.surfaceData.clearcoatNdotV,this.surfaceData.clearcoatFactor.y,1),this.surfaceData.clearcoatContrib=i.add(this.surfaceData.clearcoatContrib,i.mul(this.ccSpecular,this.surfaceData.occlusion.r))),e.hasIrradiance()&&s._sheen&&(this.$l.refl=i.reflect(i.neg(this.surfaceData.viewVec),this.surfaceData.normal),this.$l.sheenEnvSample=e.getRadiance(this,this.refl,this.surfaceData.sheenRoughness),this.$l.sheenBRDF=i.textureSample(this.ggxLut,i.clamp(i.vec2(this.surfaceData.NdotV,this.surfaceData.sheenRoughness),i.vec2(0),i.vec2(1))).b,this.$l.sheenLighting=i.mul(this.surfaceData.sheenColor.rgb,this.iblDiffuse,this.sheenBRDF),this.surfaceData.sheenContrib=i.add(this.surfaceData.sheenContrib,i.mul(this.sheenLighting,this.surfaceData.occlusion.r)))})),i.getGlobalScope()[ao.funcNameIllumEnvLight]()}supportLighting(){return!0}envBRDF(t,e){this.illumEnvLight(e,t)}directBRDF(t,e,i){const s=this,r=t.$builder;r.func(ao.funcNameCalcPBRLight,[r.vec3("lightDir"),r.vec3("attenuation")],(function(){this.$l.L=r.neg(this.lightDir),this.$l.halfVec=r.normalize(r.sub(this.surfaceData.viewVec,this.lightDir)),this.$l.NdotH=r.clamp(r.dot(this.surfaceData.normal,this.halfVec),0,1),this.$l.NdotL=r.clamp(r.dot(this.surfaceData.normal,this.L),0,1),this.$l.VdotH=r.clamp(r.dot(this.surfaceData.viewVec,this.halfVec),0,1),this.$l.outSpecular=r.vec3(),this.$l.outDiffuse=r.vec3(),this.$l.F=Fn(this,this.VdotH,this.surfaceData.f0.rgb,this.surfaceData.f90),function(t,e,i,s,r,a,n,o,h,u){const l=t.$builder,c="pbrDirectLighting";l.func(c,[l.vec3("diffuse"),l.float("NdotV"),l.float("NdotH"),l.float("NdotL"),l.vec3("F"),l.float("roughness"),l.float("specularWeight"),l.vec3("outSpecular").out(),l.vec3("outDiffuse").out()],(function(){this.$l.alphaRoughness=l.mul(this.roughness,this.roughness),this.$l.D=Pn(this,this.NdotH,this.alphaRoughness),this.$l.V=Bn(this,this.NdotV,this.NdotL,this.alphaRoughness),this.outSpecular=l.mul(this.D,this.V,this.F,this.specularWeight),this.outDiffuse=l.mul(l.sub(l.vec3(1),l.mul(this.F,this.specularWeight)),l.div(this.diffuse,Math.PI))})),l.getGlobalScope()[c](e,i,s,r,a,n,o,h,u)}(this,this.surfaceData.diffuse.rgb,this.surfaceData.NdotV,this.NdotH,this.NdotL,this.F,this.surfaceData.roughness,this.surfaceData.specularWeight,this.outSpecular,this.outDiffuse),this.surfaceData.accumSpecular=r.add(this.surfaceData.accumSpecular,r.mul(this.outSpecular,this.attenuation)),this.surfaceData.accumDiffuse=r.add(this.surfaceData.accumDiffuse,r.mul(this.outDiffuse,this.attenuation)),s._sheen&&(this.$l.sheenLighting=On(this,this.surfaceData.NdotV,this.NdotL,this.NdotH,this.surfaceData.sheenColor,this.surfaceData.sheenRoughness),this.surfaceData.sheenContrib=r.add(this.surfaceData.sheenContrib,r.mul(this.sheenLighting,this.attenuation))),s._clearcoat&&(this.$l.ccNdotH=r.clamp(r.dot(this.surfaceData.clearcoatNormal,this.halfVec),0,1),this.$l.ccNdotL=r.clamp(r.dot(this.surfaceData.clearcoatNormal,this.L),0,1),this.$l.ccLighting=function(t,e,i,s,r,a){const n=t.$builder,o="pbrDirectClearcoatLighting";return n.func(o,[n.float("NdotV"),n.float("NdotH"),n.float("NdotL"),n.vec3("F"),n.float("clearcoatRoughness")],(function(){this.$l.ccRoughness=n.mul(this.clearcoatRoughness,this.clearcoatRoughness),this.$l.ccD=Pn(this,this.NdotH,this.ccRoughness),this.$l.ccV=Bn(this,this.NdotV,this.NdotL,this.ccRoughness),this.$return(n.mul(this.ccD,this.ccV,this.F))})),n.getGlobalScope()[o](e,i,s,r,a)}(this,this.surfaceData.clearcoatNdotV,this.ccNdotH,this.ccNdotL,this.F,this.surfaceData.clearcoatFactor.y),this.surfaceData.clearcoatContrib=r.add(this.surfaceData.clearcoatContrib,r.mul(this.ccLighting,this.attenuation)))})),r.getGlobalScope()[ao.funcNameCalcPBRLight](e,i)}compositeSurfaceData(t){const e=t.$builder;switch(Rn.debugChannel){case"pbrBase":break;case"pbrMetallic":t.surfaceData.debugColor=e.vec4(t.surfaceData.metallic,t.surfaceData.metallic,t.surfaceData.metallic,1);break;case"pbrRoughness":t.surfaceData.debugColor=e.vec4(t.surfaceData.roughness,t.surfaceData.roughness,t.surfaceData.roughness,1);break;case"pbrMetallicRoughness":t.surfaceData.debugColor=e.vec4(e.add(t.surfaceData.accumDiffuse,t.surfaceData.accumSpecular),1);break;case"pbrSheen":this._sheen?t.surfaceData.debugColor=e.vec4(t.surfaceData.sheenContrib,1):t.surfaceData.debugColor=e.vec4(0,0,0,1);break;case"pbrSheenColor":this._sheen?t.surfaceData.debugColor=e.vec4(t.surfaceData.sheenColor,1):t.surfaceData.debugColor=e.vec4(0,0,0,1);break;case"pbrSheenRoughness":this._sheen?t.surfaceData.debugColor=e.vec4(t.surfaceData.sheenRoughness,t.surfaceData.sheenRoughness,t.surfaceData.sheenRoughness,1):t.surfaceData.debugColor=e.vec4(0,0,0,1);break;case"pbrSheenAlbedoScaling":this._sheen?t.surfaceData.debugColor=e.vec4(t.surfaceData.sheenAlbedoScaling,t.surfaceData.sheenAlbedoScaling,t.surfaceData.sheenAlbedoScaling,1):t.surfaceData.debugColor=e.vec4(0,0,0,1);break;default:this._sheen&&(t.surfaceData.accumColor=e.add(e.mul(t.surfaceData.accumColor,t.surfaceData.sheenAlbedoScaling),t.surfaceData.sheenContrib)),this._clearcoat&&(t.surfaceData.accumColor=e.add(e.mul(t.surfaceData.accumColor,e.sub(e.vec3(1),e.mul(t.surfaceData.clearcoatFresnel,t.surfaceData.clearcoatFactor.x))),e.mul(t.surfaceData.clearcoatContrib,t.surfaceData.clearcoatFactor.x)))}super.compositeSurfaceData(t)}}class no extends ao{static uniformMetallic="lib_PBRLM_metallic";static uniformRoughness="lib_PBRLM_roughness";static uniformSpecularFactor="lib_PBRLM_specularFactor";_metallic;_roughness;_metallicIndex;_roughnessIndex;_specularFactor;constructor(){super(),this._metallic=1,this._roughness=1,this._metallicIndex=2,this._roughnessIndex=1,this._specularFactor=T.one()}get metallic(){return this._metallic}set metallic(t){t!==this._metallic&&(this._metallic=t,this.optionChanged(!1))}get roughness(){return this._roughness}set roughness(t){t!==this._roughness&&(this._roughness=t,this.optionChanged(!1))}get metallicIndex(){return this._metallicIndex}set metallicIndex(t){this._metallicIndex!==t&&(this._metallicIndex=t,this.optionChanged(!0))}get roughnessIndex(){return this._roughnessIndex}set roughnessIndex(t){this._roughnessIndex!==t&&(this._roughnessIndex=t,this.optionChanged(!0))}get metallicMap(){return this._textureOptions[Zn]?.texture??null}get metallicSampler(){return this._textureOptions[Zn]?.sampler??null}get metallicMapTexCoord(){return this._textureOptions[Zn]?.texCoordIndex??null}setMetallicMap(t,e,i,s){this.setTextureOptions(Zn,t,e,i,s)}get specularFactor(){return this._specularFactor}set specularFactor(t){t.equalsTo(this._specularFactor)||(this._specularFactor.set(t),this.optionChanged(!0))}get specularMap(){return this._textureOptions[qn]?.texture??null}get specularSampler(){return this._textureOptions[qn]?.sampler??null}get specularMapTexCoord(){return this._textureOptions[qn]?.texCoordIndex??null}setSpecularMap(t,e,i,s){this.setTextureOptions(qn,t,e,i,s)}get specularColorMap(){return this._textureOptions[jn]?.texture??null}get specularColorSampler(){return this._textureOptions[jn]?.sampler??null}get specularColorMapTexCoord(){return this._textureOptions[jn]?.texCoordIndex??null}setSpecularColorMap(t,e,i,s){this.setTextureOptions(jn,t,e,i,s)}applyUniforms(t,e){super.applyUniforms(t,e),t.setValue("lm_pbrMetallic",this._metallic),t.setValue("lm_pbrRoughness",this._roughness),t.setValue("lm_pbrSpecularFactor",this._specularFactor)}calculateHash(){const t=this.metallicMap?`${this.metallicMapTexCoord+1}_${this._metallicIndex}_${this._roughnessIndex}`:"0",e=this.specularMap?`${this.specularMapTexCoord+1}`:"0",i=this.specularColorMap?`${this.specularColorMapTexCoord+1}`:"0";return`${super.calculateHash()}_${t}_${e}_${i}`}setupUniforms(t,e){super.setupUniforms(t,e),"fragment"===t.$builder.shaderKind&&(t.lm_pbrMetallic=t.$builder.float().uniform(2).tag(no.uniformMetallic),t.lm_pbrRoughness=t.$builder.float().uniform(2).tag(no.uniformRoughness),t.lm_pbrSpecularFactor=t.$builder.vec4().uniform(2).tag(no.uniformSpecularFactor))}fillSurfaceData(t,e){const i="lib_fillSurfaceDataMR",s=this,r=t.$builder;super.fillSurfaceData(t,e),r.func(i,[],(function(){const t=s.metallicMap?this[s.getTextureUniformName(Zn)]:null,i=s.specularMap?this[s.getTextureUniformName(qn)]:null,a=s.specularColorMap?this[s.getTextureUniformName(jn)]:null,n=this.$query(no.uniformMetallic),o=this.$query(no.uniformRoughness);if(t){const e=this.$inputs[`texcoord${s.metallicMapTexCoord??s.albedoMapTexCoord}`];this.$l.t=r.textureSample(t,e);const i=this.t["xyzw"[s._metallicIndex]||"z"],a=this.t["xyzw"[s._roughnessIndex]||"y"];this.surfaceData.metallic=n?r.mul(i,n):i,this.surfaceData.roughness=o?r.mul(a,o):a}else this.surfaceData.metallic=n,this.surfaceData.roughness=o;e&&(this.surfaceData.ggxLutSample=r.textureSample(this.ggxLut,r.vec2(this.surfaceData.NdotV,this.surfaceData.roughness)));const h=this.$query(no.uniformSpecularFactor);if(this.$l.specularColorFactor=h.rgb,this.surfaceData.specularWeight=h.a,a){const t=this.$inputs[`texcoord${s.specularColorMapTexCoord??s.albedoMapTexCoord}`];this.specularColorFactor=r.mul(this.specularColorFactor,r.textureSample(a,t).rgb)}if(i){const t=this.$inputs[`texcoord${s.specularMapTexCoord??s.albedoMapTexCoord}`];this.surfaceData.specularWeight=r.mul(this.surfaceData.specularWeight,r.textureSample(i,t).a)}this.surfaceData.f0=r.vec4(r.mix(r.min(r.mul(this.surfaceData.f0.rgb,this.specularColorFactor),r.vec3(1)),this.surfaceData.diffuse.rgb,this.surfaceData.metallic),this.surfaceData.f0.a),this.surfaceData.diffuse=r.vec4(r.mix(this.surfaceData.diffuse.rgb,r.vec3(0),this.surfaceData.metallic),this.surfaceData.diffuse.a),s._clearcoat&&(this.surfaceData.clearcoatFresnel=Fn(this,this.surfaceData.clearcoatNdotV,this.surfaceData.f0.rgb,this.surfaceData.f90)),e?.hasIrradiance()?this.surfaceData.irradiance=e.getIrradiance(this,this.surfaceData.normal):this.surfaceData.irradiance=r.vec3(0),e?.hasRadiance()?(this.$l.refl=r.reflect(r.neg(this.surfaceData.viewVec),this.surfaceData.normal),this.surfaceData.radiance=e.getRadiance(this,this.refl,this.surfaceData.roughness),s.useClearcoat&&(this.$l.ccRefl=r.reflect(r.neg(this.surfaceData.viewVec),this.surfaceData.clearcoatNormal),this.surfaceData.radianceClearcoat=e.getRadiance(this,this.ccRefl,this.surfaceData.clearcoatFactor.y))):(this.surfaceData.radiance=r.vec3(0),s.useClearcoat&&(this.surfaceData.radianceClearcoat=r.vec3(0)))})),r.getGlobalScope()[i]()}createSurfaceDataType(t){return super.createSurfaceDataType(t).extends("",[{name:"specularWeight",type:Un}])}isTextureUsed(t){return!!(this._sheen||t!==Kn&&t!==Qn)&&super.isTextureUsed(t)}}class oo{_itemLists;_renderPass;_shadowedLightList;_unshadowedLightList;_sunLight;constructor(t){this._itemLists={},this._renderPass=t,this._shadowedLightList=[],this._unshadowedLightList=[],this._sunLight=null}get sunLight(){return this._sunLight}set sunLight(t){this._sunLight=t}get renderPass(){return this._renderPass}get items(){return this._itemLists}get shadowedLights(){return this._shadowedLightList}get unshadowedLights(){return this._unshadowedLightList}getMaxBatchSize(){return Y.instance.device.getDeviceCaps().shaderCaps.maxUniformBufferSize/64}pushLight(t){t.castShadow?this._shadowedLightList.push(t):this._unshadowedLightList.push(t),t.isDirectionLight()&&t.sunLight&&(this.sunLight=t)}push(t,e,i){if(e){let s=this._itemLists[i];s||(s={opaqueList:[],opaqueInstanceList:{},transList:[],transInstanceList:{}},this._itemLists[i]=s);const r=e.isTransparency(),a=r?s.transList:s.opaqueList;if(e.isBatchable()){const i=r?s.transInstanceList:s.opaqueInstanceList,n=e.getInstanceId(this._renderPass),o=i[n];void 0===o||a[o].instanceData.worldMatrices.length===this.getMaxBatchSize()?(i[n]=a.length,a.push({drawable:e,sortDistance:e.getSortDistance(t),instanceData:{worldMatrices:[e.getXForm().worldMatrix],hash:n}})):a[o].instanceData.worldMatrices.push(e.getXForm().worldMatrix)}else a.push({drawable:e,sortDistance:e.getSortDistance(t),instanceData:null})}}clear(){this._itemLists={},this._shadowedLightList=[],this._unshadowedLightList=[],this._sunLight=null}sortItems(){for(const t of Object.values(this._itemLists))t.opaqueList.sort(((t,e)=>t.sortDistance-e.sortDistance)),t.transList.sort(((t,e)=>e.sortDistance-t.sortDistance))}encodeInstanceColor(t,e){e[0]=(t>>24&255)/255,e[1]=(t>>16&255)/255,e[2]=(t>>8&&255)/255,e[3]=(t>>0&&255)/255}setInstanceColors(){const t=[];let e=0;for(const i in this._itemLists){const s=this._itemLists[i];for(const i of s.opaqueList)if(i.instanceColor){i.instanceData.instanceColorList=[];for(let s=0;s<i.instanceData.worldMatrices.length;s++){const s=i.drawable.getInstanceColor();this.encodeInstanceColor(e,s),t[e]=i.drawable.getPickTarget(),i.instanceData.instanceColorList.push(s),e++}}}return t}}class ho{_type;_globalBindGroups;_clearColor;_clearDepth;_clearStencil;constructor(t){this._type=t,this._clearColor=new T(0,0,0,1),this._clearDepth=1,this._clearStencil=0,this._globalBindGroups={}}get clearColor(){return this._clearColor}set clearColor(t){this._clearColor=t??null}get clearDepth(){return this._clearDepth}set clearDepth(t){this._clearDepth=t??null}get clearStencil(){return this._clearStencil}set clearStencil(t){this._clearStencil=t??null}get type(){return this._type}isAutoFlip(){return!(!Y.instance.device.getFramebuffer()||"webgpu"!==Y.instance.device.type)}render(t,e,i){t.renderPass=this,this.drawScene(t,e??t.camera,i)}applyRenderStates(t,e,i){t.setRenderStates(e)}getGlobalBindGroupInfo(t){const e=this.getGlobalBindGroupHash(t);let i=this._globalBindGroups[e];if(!i){const s=Y.instance.device.programBuilder.buildRender({vertex(e){qa.prepareVertexShader(e,t),e.main((function(){}))},fragment(e){qa.prepareFragmentShader(e,t),e.main((function(){}))}});i={bindGroup:Y.instance.device.createBindGroup(s[2][0]),layout:s[2][0]},this._globalBindGroups[e]=i}return i.bindGroup.disposed&&i.bindGroup.reload(),i}dispose(){for(const t in this._globalBindGroups)Rn.bindGroupGarbageCollect(this._globalBindGroups[t].bindGroup);this._globalBindGroups={}}getGlobalBindGroupHash(t){return`${this.constructor.name}:${this._getGlobalBindGroupHash(t)}`}drawScene(t,e,i){const s=Y.instance.device;if(this.clearFramebuffer(),i=i??this.cullScene(t,e)){const e=s.isWindingOrderReversed();s.reverseVertexWindingOrder(this.isAutoFlip()?!e:e),this.renderItems(t,i),s.reverseVertexWindingOrder(e)}}cullScene(t,e){if(e){const i=new oo(this),s=new Cn(this,e,i,t.primaryCamera);return t.scene.octree?t.scene.octree.getRootNode().traverse(s):t.scene.rootNode.traverse(s),i}return null}drawItem(t,e,i,s){const r=s!==e.drawable.getXForm().worldMatrixDet<0;r&&t.reverseVertexWindingOrder(!t.isWindingOrderReversed()),e.drawable.draw(i),r&&t.reverseVertexWindingOrder(!t.isWindingOrderReversed())}clearFramebuffer(){Y.instance.device.clearFrameBuffer(this._clearColor,this._clearDepth,this._clearStencil)}}class uo extends ho{_overridenState;_overridenStateTrans;_shadowMapHash;constructor(){super(za),this._overridenState=null,this._overridenStateTrans=null,this._shadowMapHash=null}applyRenderStates(t,e,i){const s=i.userData;if(s){const t=s.depthState,i=s.blendingState;s.copyFrom(e),s.useBlendingState(i),t&&s.useDepthState(t),e=s}t.setRenderStates(e)}get overridenState(){return this._overridenState||(this._overridenState=Y.instance.device.createRenderStateSet(),this._overridenState.useBlendingState().enable(!0).setBlendFunc("one","one")),this._overridenState}get overridenStateTrans(){return this._overridenStateTrans||(this._overridenStateTrans=Y.instance.device.createRenderStateSet(),this._overridenStateTrans.useBlendingState().enable(!0).setBlendFunc("one","inv-src-alpha"),this._overridenStateTrans.useDepthState().enableTest(!0).enableWrite(!1)),this._overridenStateTrans}_getGlobalBindGroupHash(t){return`${this._shadowMapHash}:${t.env.getHash(t)}`}renderLightPass(t,e,i,s,r,a,n){const o=Y.instance.device,h=!n;i.drawEnvLight=h&&"none"!==i.env.light.type&&(i.env.light.envLight.hasRadiance()||i.env.light.envLight.hasIrradiance()),i.renderPassHash=this.getGlobalBindGroupHash(i);const u=this.getGlobalBindGroupInfo(i);qa.setCameraUniforms(u.bindGroup,i,!!o.getFramebuffer()),i.currentShadowLight?qa.setLightUniformsShadow(u.bindGroup,i,r[0]):qa.setLightUniforms(u.bindGroup,i,i.clusteredLight.clusterParam,i.clusteredLight.countParam,i.clusteredLight.lightBuffer,i.clusteredLight.lightIndexTexture),i.applyFog&&qa.setFogUniforms(u.bindGroup,i.env.sky.mappedFogType,h?i.env.sky.fogColor:T.zero(),i.env.sky.fogParams,i.env.sky.getAerialPerspectiveLUT(i)),o.setBindGroup(0,u.bindGroup),n?i.userData=this.overridenState:a&&(i.userData=this.overridenStateTrans);const l=i.camera.worldMatrixDet<0;for(const t of s)n&&t.drawable.isUnlit()||(i.instanceData=t.instanceData,i.target=t.drawable,this.drawItem(o,t,i,l))}renderItems(t,e){t.applyFog=!1,t.target=null,t.renderPassHash=null,t.env=t.scene.env,t.drawEnvLight=!1,t.flip=this.isAutoFlip(),e.sortItems();const i=Object.keys(e.items).map((t=>Number(t))).sort(((t,e)=>t-e));for(let s=0;s<2;s++){t.applyFog=1===s&&"none"!==t.env.sky.fogType;for(const r of i){const i=e.items[r],a=[i.opaqueList,i.transList][s];let n=0;if(t.shadowMapInfo)for(const i of t.shadowMapInfo.keys())t.currentShadowLight=i,this._shadowMapHash=t.shadowMapInfo.get(i).shaderHash,this.renderLightPass(t.camera,e,t,a,[i],s>0,n>0),n++;(0===n||e.unshadowedLights.length>0)&&(t.currentShadowLight=null,this._shadowMapHash="",this.renderLightPass(t.camera,e,t,a,e.unshadowedLights,s>0,n>0))}0===s&&(t.env.sky.skyWorldMatrix=t.scene.rootNode.worldMatrix,t.env.sky.renderSky(t)),t.compositor?.drawPostEffects(t,0===s,t.linearDepthTexture),0===s&&t.env.sky.renderFog(t)}}}class lo extends ho{_currentLight;_stateOverriden;constructor(){super(ka),this._currentLight=null,this._stateOverriden=null}get light(){return this._currentLight}set light(t){this._currentLight=t}get stateOverriden(){return this._stateOverriden||(this._stateOverriden=Y.instance.device.createRenderStateSet(),this._stateOverriden.useRasterizerState().setCullMode("none")),this._stateOverriden}applyRenderStates(t,e,i){const s=this.stateOverriden,r=s.rasterizerState;s.copyFrom(e),s.useRasterizerState(r),t.setRenderStates(s)}_getGlobalBindGroupHash(t){return t.shadowMapInfo.get(this.light).shaderHash}renderItems(t,e){t.target=null,t.drawEnvLight=!1,t.env=null,t.applyFog=!1,t.renderPassHash=null,t.flip=this.isAutoFlip();const i=Y.instance.device,s=this.getGlobalBindGroupInfo(t).bindGroup;i.setBindGroup(0,s),qa.setLightUniformsShadowMap(s,t,this._currentLight),qa.setCameraUniforms(s,t,!0),t.renderPassHash=this.getGlobalBindGroupHash(t);const r=t.camera.worldMatrixDet<0;for(const s of Object.keys(e.items).map((t=>Number(t))).sort(((t,e)=>t-e))){const a=e.items[s];for(const e of a.opaqueList)t.instanceData=e.instanceData,t.target=e.drawable,this.drawItem(i,e,t,r)}}}class co extends ho{constructor(){super(Xa)}_getGlobalBindGroupHash(t){return""}renderItems(t,e){t.target=null,t.applyFog=!1,t.drawEnvLight=!1,t.env=null,t.renderPassHash=null,t.flip=this.isAutoFlip();const i=Y.instance.device,s=this.getGlobalBindGroupInfo(t).bindGroup;i.setBindGroup(0,s),qa.setCameraUniforms(s,t,!0),t.renderPassHash=this.getGlobalBindGroupHash(t);const r=t.camera.worldMatrixDet<0;for(const s of Object.keys(e.items).map((t=>Number(t))).sort(((t,e)=>t-e))){const a=e.items[s];for(const e of a.opaqueList)t.instanceData=e.instanceData,t.target=e.drawable,this.drawItem(i,e,t,r)}}}function po(t,e){const i=t.$builder,s="lib_noise3d";return i.func(s,[i.vec3("p")],(function(){this.$l.p3=i.fract(i.mul(this.p,.1031)),this.$l.p3=i.add(this.p3,i.vec3(i.dot(this.p3,i.add(this.p3.yzx,i.vec3(33.33))))),this.$return(i.fract(i.mul(i.add(this.p3.x,this.p3.y),this.p3.z)))})),i.getGlobalScope()[s](e)}function _o(t,e){const i=t.$builder,s="lib_smoothNoise3D";return i.func(s,[i.vec3("p")],(function(){this.$l.cell=i.floor(this.p),this.$l.local=i.fract(this.p),this.$l.local=i.mul(this.local,i.mul(this.local,i.sub(i.vec3(3),i.mul(this.local,2)))),this.$l.ldb=po(this,this.cell),this.$l.rdb=po(this,i.add(this.cell,i.vec3(1,0,0))),this.$l.ldf=po(this,i.add(this.cell,i.vec3(0,0,1))),this.$l.rdf=po(this,i.add(this.cell,i.vec3(1,0,1))),this.$l.lub=po(this,i.add(this.cell,i.vec3(0,1,0))),this.$l.rub=po(this,i.add(this.cell,i.vec3(1,1,0))),this.$l.luf=po(this,i.add(this.cell,i.vec3(0,1,1))),this.$l.ruf=po(this,i.add(this.cell,i.vec3(1,1,1))),this.$return(i.mix(i.mix(i.mix(this.ldb,this.rdb,this.local.x),i.mix(this.ldf,this.rdf,this.local.x),this.local.z),i.mix(i.mix(this.lub,this.rub,this.local.x),i.mix(this.luf,this.ruf,this.local.x),this.local.z),this.local.y))})),i.getGlobalScope()[s](e)}new F,new f(0,0),v.identity(),v.rotationZ(270*Math.PI/180),v.rotationZ(90*Math.PI/180),v.rotationZ(180*Math.PI/180),new f(2,2),new f(1,2);class mo extends bn{_projMatrix;_viewMatrix;_viewProjMatrix;_rotationMatrix;_invViewProjMatrix;_clipPlane;_controller;_frustum;_frustumV;_dirty;_sampleCount;_framebuffer;_viewport;_scissor;_clearColor;_clipMask;constructor(t,e){super(t),this._projMatrix=e||v.identity(),this._viewMatrix=v.identity(),this._viewProjMatrix=v.identity(),this._invViewProjMatrix=v.identity(),this._clipPlane=null,this._dirty=!0,this._controller=null,this._framebuffer=null,this._viewport=null,this._scissor=null,this._clearColor=new T(0,0,0,1),this._clipMask=0,this._sampleCount=1,this._frustum=null,this._frustumV=null}get clipPlane(){return this._clipPlane}set clipPlane(t){this._clipPlane=t,this._invalidate(!1)}get sampleCount(){return this._sampleCount}set sampleCount(t){1!==t&&4!==t?console.error(`Invalid sample count: ${t}`):this._sampleCount=t}get clipMask(){return this._clipMask}set clipMask(t){this._clipMask=t}get framebuffer(){return this._framebuffer}set framebuffer(t){this._framebuffer=t??null}get viewport(){return this._viewport?[...this._viewport]:null}set viewport(t){this._viewport=t?.slice()??null}get scissor(){return this._scissor?[...this._scissor]:null}set scissor(t){this._scissor=t?.slice()??null}get clearColor(){return this._clearColor}set clearColor(t){t?this._clearColor.set(t):this._clearColor=null}handleEvent(t,e){let i=!1;return this._controller&&("pointerdown"===(e=e??t.type)?i=this._controller.onMouseDown(t):"pointerup"===e?i=this._controller.onMouseUp(t):"pointermove"===e?i=this._controller.onMouseMove(t):"wheel"===e?i=this._controller.onMouseWheel(t):"keydown"===e?i=this._controller.onKeyDown(t):"keyup"===e&&(i=this._controller.onKeyUp(t)),i&&t.preventDefault()),i}lookAt(t,e,i){return this.setLocalTransform(v.lookAt(t,e,i))}lookAtCubeFace(t,e){return this.setLocalTransform(v.lookAtCubeFace(t,e??this.position))}setPerspective(t,e,i,s){return this._projMatrix.perspective(t,e,i,s),this._invalidate(!0),this}setOrtho(t,e,i,s,r,a){return this._projMatrix.ortho(t,e,i,s,r,a),this._invalidate(!0),this}setProjectionMatrix(t){t&&t!==this._projMatrix&&(this._projMatrix.set(t),this._invalidate(!0))}getProjectionMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._projMatrix}getRotationMatrix(){const t=new v;this.worldMatrix.decompose(null,t,null);const e=t.getRow(0).xyz().scaleBy(-1),i=t.getRow(1).xyz(),s=t.getRow(2).xyz().scaleBy(-1);return t.setRow(0,new T(e.x,e.y,e.z,0)),t.setRow(1,new T(i.x,i.y,i.z,0)),t.setRow(2,new T(s.x,s.y,s.z,0)),t}get viewMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._viewMatrix}get viewProjectionMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._viewProjMatrix}get invViewProjectionMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._invViewProjMatrix}get frustum(){return this._dirty&&(this._dirty=!1,this._compute()),this._frustum}get frustumViewSpace(){return this._dirty&&(this._dirty=!1,this._compute()),this._frustumV||(this._frustumV=new L(this._projMatrix)),this._frustumV}get controller(){return this._controller||null}set controller(t){this.setController(t)}isCamera(){return!0}getNearPlane(){return this._projMatrix.getNearPlane()}getFarPlane(){return this._projMatrix.getFarPlane()}getFOV(){return this._projMatrix.getFov()}getTanHalfFovy(){return this._projMatrix.getTanHalfFov()}getAspect(){return this._projMatrix.getAspect()}render(t,e,i){const s=Y.instance.device;s.pushDeviceStates(),s.reverseVertexWindingOrder(!1),s.setFramebuffer(this._framebuffer),Xo.setClearColor(this._clearColor),Xo.renderScene(t,this,e,i),s.popDeviceStates()}updateController(){this._controller?.update()}resetController(){this._controller?.reset()}setController(t){if(this._controller!==t){if(t&&t._getCamera()&&t._getCamera()!==this)throw new Error("Camera.setController failed: one camera controller object cannot be assigned to multiple camera");this._controller?._setCamera(null),this._controller=t,this._controller?._setCamera(this)}return this}_invalidate(t){this._dirty=!0,t&&(this._frustumV=null)}_compute(){this._computeProj(),v.invertAffine(this.worldMatrix,this._viewMatrix),v.multiply(this._projMatrix,this._viewMatrix,this._viewProjMatrix),v.invert(this._viewProjMatrix,this._invViewProjMatrix),this._frustum?this._frustum.initWithMatrix(this._viewProjMatrix):this._frustum=new L(this._viewProjMatrix)}_computeProj(){}_onTransformChanged(t){super._onTransformChanged(t),this._invalidate(!1)}dispose(){this.setController(null),this._projMatrix=null,this._viewMatrix=null,this._viewProjMatrix=null}}const fo={linear:qa.FOG_TYPE_LINEAR,exp:qa.FOG_TYPE_EXP,exp2:qa.FOG_TYPE_EXP2,scatter:qa.FOG_TYPE_SCATTER,none:qa.FOG_TYPE_NONE},go=v.identity();class xo{static _defaultSunDir=g.one().inplaceNormalize();_skyType;_skyColor;_skyboxTexture;_updateRadianceMaps;_radianceMapDirty;_scatterSkyboxFramebuffer;_scatterSkyboxTextureWidth;_radianceMap;_radianceMapWidth;_irradianceMap;_irradianceMapWidth;_fogType;_fogColor;_fogParams;_cloudy;_cloudIntensity;_wind;_nearestSampler;_programSky;_bindgroupSky;_programFog;_bindgroupFog;_programFogScatter;_bindgroupFogScatter;_vertexLayout;_primitiveSky;_skyWorldMatrix;_renderStatesSky;_renderStatesSkyNoDepthTest;_renderStatesFog;_renderStatesFogScatter;_lastSunDir;constructor(){this._skyType="scatter",this._updateRadianceMaps=!0,this._radianceMapDirty=!0,this._skyColor=T.zero(),this._skyboxTexture=null,this._scatterSkyboxFramebuffer=null,this._scatterSkyboxTextureWidth=256,this._radianceMap=null,this._radianceMapWidth=128,this._irradianceMap=null,this._irradianceMapWidth=64,this._fogType="none",this._fogColor=T.one(),this._fogParams=new T(1,100,50,.002),this._cloudy=.6,this._cloudIntensity=40,this._wind=f.zero(),this._nearestSampler=null,this._programSky={},this._bindgroupSky={},this._programFog=null,this._bindgroupFog=null,this._programFogScatter=null,this._bindgroupFogScatter=null,this._vertexLayout=null,this._primitiveSky=null,this._renderStatesSky=null,this._renderStatesSkyNoDepthTest=null,this._renderStatesFog=null,this._renderStatesFogScatter=null,this._skyWorldMatrix=go,this._lastSunDir=g.zero()}getHash(t){return t.applyFog?"none"===this._fogType?"0":this.drawScatteredFog(t)?"1":"2":""}get skyType(){return this._skyType}set skyType(t){t!==this._skyType&&(this._skyType=t,this.invalidateIBLMaps())}get autoUpdateIBLMaps(){return this._updateRadianceMaps}set autoUpdateIBLMaps(t){this._updateRadianceMaps!==!!t&&(this._updateRadianceMaps=!!t,this._updateRadianceMaps&&this.invalidateIBLMaps())}get skyColor(){return this._skyColor}set skyColor(t){t.equalsTo(this._skyColor)||(this._skyColor.set(t),this.invalidateIBLMaps())}get cloudy(){return this._cloudy}set cloudy(t){t!==this._cloudy&&"scatter"===this._skyType&&(this._cloudy=t,this.invalidateIBLMaps())}get cloudIntensity(){return this._cloudIntensity}set cloudIntensity(t){t!==this._cloudIntensity&&"scatter"===this._skyType&&(this._cloudIntensity=t,this.invalidateIBLMaps())}get wind(){return this._wind}set wind(t){this._wind.set(t)}get radianceMap(){return this._radianceMap||(this._radianceMap=Y.instance.device.createCubeTexture("rgba16f",this._radianceMapWidth),this._radianceMap.name="SkyRadianceMap"),this._radianceMap}get irradianceMap(){return this._irradianceMap||(this._irradianceMap=Y.instance.device.createCubeTexture("rgba16f",this._irradianceMapWidth,{samplerOptions:{mipFilter:"none"}}),this._irradianceMap.name="SkyIrradianceMap"),this._irradianceMap}get skyboxTexture(){return this._skyboxTexture}set skyboxTexture(t){t!==this._skyboxTexture&&(this._skyboxTexture=t,"skybox"===this._skyType&&this.invalidateIBLMaps())}get skyWorldMatrix(){return this._skyWorldMatrix}set skyWorldMatrix(t){(t=t??go)!==this._skyWorldMatrix&&(this._skyWorldMatrix=t,this.invalidateIBLMaps())}get mappedFogType(){return fo[this._fogType]}get fogType(){return this._fogType}set fogType(t){this._fogType=t}get fogStart(){return this._fogParams.x}set fogStart(t){this._fogParams.x=t}get fogEnd(){return this._fogParams.y}set fogEnd(t){this._fogParams.y=t}get fogTop(){return this._fogParams.z}set fogTop(t){this._fogParams.z=t}get fogDensity(){return this._fogParams.w}set fogDensity(t){this._fogParams.w=t}get fogColor(){return this._fogColor}set fogColor(t){this._fogColor.set(t)}get fogParams(){return this._fogParams}set fogParams(t){this._fogParams.set(t)}invalidateIBLMaps(){this._radianceMapDirty=!0}drawScatteredFog(t){return t.sunLight&&"scatter"===this._fogType}getAerialPerspectiveLUT(t){if(this.drawScatteredFog(t)){const e=xo._getSunDir(t.sunLight),i=Math.PI/2-Math.acos(Math.max(-1,Math.min(1,e.y))),s=t.camera.getFarPlane()*t.scene.worldUnit;return Ya.getAerialPerspectiveLut(i,s)}return null}updateIBLMaps(t){const e=Y.instance.device;let i=null;if("skybox"===this._skyType&&this._skyboxTexture)i=this._skyboxTexture;else{if(!this._scatterSkyboxFramebuffer){const t=e.getDeviceCaps().textureCaps,i=t.supportHalfFloatColorBuffer&&t.supportLinearHalfFloatTexture?"rgba16f":t.supportFloatColorBuffer&&t.supportLinearFloatTexture?"rgba32f":"rgba8unorm",s=e.createCubeTexture(i,this._scatterSkyboxTextureWidth);s.name="BakedSkyboxTexture",this._scatterSkyboxFramebuffer=e.createFrameBuffer([s],null),this._radianceMapDirty=!0}const s=new mo(null);s.setPerspective(Math.PI/2,1,1,20);const r=e.getRenderStates();e.pushDeviceStates(),e.setFramebuffer(this._scatterSkyboxFramebuffer);for(const e of[d.PX,d.NX,d.PY,d.NY,d.PZ,d.NZ])s.lookAtCubeFace(e),this._scatterSkyboxFramebuffer.setColorAttachmentCubeFace(0,e),this._renderSky(s,!1,t,!0,!1);e.popDeviceStates(),e.setRenderStates(r),i=this._scatterSkyboxFramebuffer.getColorAttachments()[0]}tt(i,"ggx",this.radianceMap),tt(i,"lambertian",this.irradianceMap)}renderFog(t){const e=t.camera,i=t.linearDepthTexture,s=Y.instance.device,r=s.getRenderStates();this._prepareSkyBox(s);const a=t.sunLight;if("scatter"===this._fogType&&!a)return void console.error("Cannot render scattering fog without sun light");const n="scatter"===this._fogType?this._programFogScatter:this._programFog,o="scatter"===this._fogType?this._renderStatesFogScatter:this._renderStatesFog;if(n&&i){const h="scatter"===this._fogType?this._bindgroupFogScatter:this._bindgroupFog;if(h.setTexture("depthTex",i,this._nearestSampler),h.setValue("rt",s.getFramebuffer()?1:0),h.setValue("invProjViewMatrix",e.invViewProjectionMatrix),h.setValue("cameraNearFar",new f(e.getNearPlane(),e.getFarPlane())),h.setValue("cameraPosition",e.getWorldPosition()),h.setValue("srgbOut",s.getFramebuffer()?0:1),"scatter"===this._fogType){const e=a?a.directionAndCutoff.xyz().scaleBy(-1):xo._defaultSunDir,i=Math.PI/2-Math.acos(Math.max(-1,Math.min(1,e.y))),s=t.camera.getFarPlane()*t.scene.worldUnit;h.setTexture("apLut",Ya.getAerialPerspectiveLut(i,s)),h.setValue("sliceDist",s/Ya.aerialPerspectiveSliceZ),h.setValue("sunDir",e),h.setValue("worldScale",t.scene.worldUnit)}else h.setValue("fogType",this.mappedFogType),h.setValue("fogColor",this._fogColor),h.setValue("fogParams",this._fogParams);s.setProgram(n),s.setBindGroup(0,h),s.setVertexLayout(this._vertexLayout),s.setRenderStates(o),s.draw("triangle-strip",0,4),s.setRenderStates(r)}}renderSky(t){const e=xo._getSunDir(t.sunLight);e.equalsTo(this._lastSunDir)||(this._radianceMapDirty=!0),this._renderSky(t.camera,!0,e,!1,"scatter"===this._skyType&&this._cloudy>0),this._radianceMapDirty&&"ibl"===t.env.light.type&&(!t.env.light.radianceMap||t.env.light.radianceMap!==this._radianceMap&&t.env.light.irradianceMap!==this._irradianceMap||(this._radianceMapDirty=!1,this._lastSunDir.set(e),this.updateIBLMaps(e)))}_renderSky(t,e,i,s,r){const a=Y.instance.device,n=a.getRenderStates();this._prepareSkyBox(a),"scatter"===this._skyType?this._drawScattering(t,i,e,s,r):"skybox"===this._skyType&&this._skyboxTexture?this._drawSkybox(t,e):this._drawSkyColor(t,e),a.setRenderStates(n)}_drawSkyColor(t,e){const i=Y.instance.device,s=this._bindgroupSky.color;s.setValue("viewProjMatrix",t.viewProjectionMatrix),s.setValue("worldMatrix",this._skyWorldMatrix),s.setValue("cameraPos",t.getWorldPosition()),s.setValue("color",this._skyColor),s.setValue("srgbOut",i.getFramebuffer()?0:1),i.setProgram(this._programSky.color),i.setBindGroup(0,s),i.setRenderStates(e?this._renderStatesSky:this._renderStatesSkyNoDepthTest),this._primitiveSky.draw()}_drawSkybox(t,e){const i=Y.instance.device,s=this._bindgroupSky.skybox;s.setTexture("skyCubeMap",this._skyboxTexture),s.setValue("flip",i.getFramebuffer()&&"webgpu"===i.type?new T(1,-1,1,1):new T(1,1,1,1)),s.setValue("viewProjMatrix",t.viewProjectionMatrix),s.setValue("worldMatrix",this._skyWorldMatrix),s.setValue("cameraPos",t.getWorldPosition()),s.setValue("srgbOut",i.getFramebuffer()?0:1),i.setProgram(this._programSky.skybox),i.setBindGroup(0,s),i.setRenderStates(e?this._renderStatesSky:this._renderStatesSkyNoDepthTest),this._primitiveSky.draw()}_drawScattering(t,e,i,s,r){const a=Y.instance.device,n=Math.PI/2-Math.acos(Math.max(-1,Math.min(1,e.y))),o=Ya.getTransmittanceLut(),h=Ya.getSkyViewLut(n),u=r?this._programSky.scatter:this._programSky["scatter-nocloud"],l=r?this._bindgroupSky.scatter:this._bindgroupSky["scatter-nocloud"];l.setValue("sunDir",e),l.setValue("flip",a.getFramebuffer()&&"webgpu"===a.type?new T(1,-1,1,1):new T(1,1,1,1)),l.setValue("viewProjMatrix",t.viewProjectionMatrix),l.setValue("worldMatrix",this._skyWorldMatrix),l.setValue("cameraPos",t.getWorldPosition()),l.setValue("srgbOut",a.getFramebuffer()?0:1),l.setTexture("tLut",o),l.setTexture("skyLut",h),r&&(l.setValue("cloudy",this._cloudy),l.setValue("cloudIntensity",this._cloudIntensity),l.setValue("time",.001*a.frameInfo.elapsedOverall),l.setValue("velocity",this._wind)),l.setValue("drawGround",s?1:0),a.setProgram(u),a.setBindGroup(0,l),a.setRenderStates(i?this._renderStatesSky:this._renderStatesSkyNoDepthTest),this._primitiveSky.draw()}_prepareSkyBox(t){this._programFogScatter||(this._programFogScatter=t.buildRenderProgram({label:"FogScatter",vertex(e){this.rt=e.int().uniform(0),this.$inputs.pos=e.vec2().attrib("position"),this.$outputs.uv=e.vec2(),e.main((function(){this.$builtins.position=e.vec4(this.$inputs.pos,1,1),this.$outputs.uv=e.add(e.mul(this.$inputs.pos.xy,.5),e.vec2(.5)),"webgpu"===t.type&&this.$if(e.notEqual(this.rt,0),(function(){this.$builtins.position.y=e.neg(this.$builtins.position.y)}))}))},fragment(e){this.depthTex=e.tex2D().sampleType("unfilterable-float").uniform(0),this.invProjViewMatrix=e.mat4().uniform(0),this.cameraNearFar=e.vec2().uniform(0),this.cameraPosition=e.vec3().uniform(0),this.apLut=e.tex2D().uniform(0),this.worldScale=e.float().uniform(0),this.sliceDist=e.float().uniform(0),this.sunDir=e.vec3().uniform(0),this.srgbOut=e.int().uniform(0),this.$outputs.outColor=e.vec4(),e.main((function(){this.$l.depthValue=e.textureSample(this.depthTex,this.$inputs.uv),"webgl"===t.type?this.$l.linearDepth=Qa(this,this.depthValue):this.$l.linearDepth=this.depthValue.r,this.$l.nonLinearDepth=e.div(e.sub(e.div(this.cameraNearFar.x,this.linearDepth),this.cameraNearFar.y),e.sub(this.cameraNearFar.x,this.cameraNearFar.y)),this.$l.clipSpacePos=e.vec4(e.sub(e.mul(this.$inputs.uv,2),e.vec2(1)),e.sub(e.mul(this.nonLinearDepth,2),1),1),this.$l.hPos=e.mul(this.invProjViewMatrix,this.clipSpacePos),this.$l.hPos=e.div(this.$l.hPos,this.$l.hPos.w),this.$l.viewDir=e.sub(this.hPos.xyz,this.cameraPosition),this.viewDir.y=e.max(0,this.viewDir.y),this.$l.distance=e.mul(e.length(this.viewDir),this.worldScale),this.$l.slice0=e.floor(e.div(this.distance,this.sliceDist)),this.$l.slice1=e.add(this.slice0,1),this.$l.factor=e.sub(e.div(this.distance,this.sliceDist),this.slice0),this.$l.viewNormal=e.normalize(this.viewDir),this.$l.horizonAngle=e.acos(e.clamp(e.dot(e.normalize(this.sunDir.xz),e.normalize(this.viewNormal.xz)),0,1)),this.$l.zenithAngle=e.asin(this.viewNormal.y),this.$l.sliceU=e.max(e.div(this.horizonAngle,2*Math.PI),.5/Ya.aerialPerspectiveSliceZ),this.$l.u0=e.div(e.add(this.slice0,this.sliceU),Ya.aerialPerspectiveSliceZ),this.$l.u1=e.add(this.u0,1/Ya.aerialPerspectiveSliceZ),this.$l.v=e.div(this.zenithAngle,Math.PI/2),this.$l.t0=e.textureSampleLevel(this.apLut,e.vec2(this.u0,this.v),0),this.$l.t1=e.textureSampleLevel(this.apLut,e.vec2(this.u1,this.v),0),this.$l.t=e.mix(this.t0,this.t1,this.factor),this.$outputs.outColor=e.vec4(this.t.rgb,e.sub(1,this.t.a))}))}}),this._bindgroupFogScatter=t.createBindGroup(this._programFogScatter.bindGroupLayouts[0])),this._programFog||(this._programFog=t.buildRenderProgram({label:"Fog",vertex(e){this.rt=e.int().uniform(0),this.$inputs.pos=e.vec2().attrib("position"),this.$outputs.uv=e.vec2(),e.main((function(){this.$builtins.position=e.vec4(this.$inputs.pos,1,1),this.$outputs.uv=e.add(e.mul(this.$inputs.pos.xy,.5),e.vec2(.5)),"webgpu"===t.type&&this.$if(e.notEqual(this.rt,0),(function(){this.$builtins.position.y=e.neg(this.$builtins.position.y)}))}))},fragment(e){this.depthTex=e.tex2D().sampleType("unfilterable-float").uniform(0),this.invProjViewMatrix=e.mat4().uniform(0),this.cameraNearFar=e.vec2().uniform(0),this.cameraPosition=e.vec3().uniform(0),this.fogType=e.int().uniform(0),this.fogColor=e.vec4().uniform(0),this.fogParams=e.vec4().uniform(0),this.srgbOut=e.int().uniform(0),this.$outputs.outColor=e.vec4(),e.main((function(){this.$l.depthValue=e.textureSample(this.depthTex,this.$inputs.uv),"webgl"===t.type?this.$l.linearDepth=Qa(this,this.depthValue):this.$l.linearDepth=this.depthValue.r,this.$l.nonLinearDepth=e.div(e.sub(e.div(this.cameraNearFar.x,this.linearDepth),this.cameraNearFar.y),e.sub(this.cameraNearFar.x,this.cameraNearFar.y)),this.$l.clipSpacePos=e.vec4(e.sub(e.mul(this.$inputs.uv,2),e.vec2(1)),e.sub(e.mul(this.nonLinearDepth,2),1),1),this.$l.hPos=e.mul(this.invProjViewMatrix,this.clipSpacePos),this.$l.hPos=e.div(this.$l.hPos,this.$l.hPos.w),this.$l.viewDir=e.sub(this.hPos.xyz,this.cameraPosition),this.$l.fogFactor=qa.computeFogFactor(this,this.viewDir,this.fogType,this.fogParams),this.$l.color=e.mul(this.fogColor.rgb,this.fogFactor),this.$if(e.equal(this.srgbOut,0),(function(){this.$outputs.outColor=e.vec4(this.color,this.fogFactor)})).$else((function(){this.$outputs.outColor=e.vec4(sn(this,this.color),this.fogFactor)}))}))}}),this._bindgroupFog=t.createBindGroup(this._programFog.bindGroupLayouts[0])),this._programSky.color||(this._programSky.color=t.buildRenderProgram({label:"SolidColorSky",vertex(t){this.$inputs.pos=t.vec3().attrib("position"),this.worldMatrix=t.mat4().uniform(0),this.viewProjMatrix=t.mat4().uniform(0),this.cameraPos=t.vec3().uniform(0),t.main((function(){this.$l.worldDirection=t.mul(this.worldMatrix,t.vec4(this.$inputs.pos,0)).xyz,this.$builtins.position=t.mul(this.viewProjMatrix,t.vec4(t.add(this.worldDirection,this.cameraPos),1)),this.$builtins.position.z=this.$builtins.position.w}))},fragment(t){this.$outputs.outColor=t.vec4(),this.color=t.vec4().uniform(0),this.srgbOut=t.int().uniform(0),t.main((function(){this.$if(t.equal(this.srgbOut,0),(function(){this.$outputs.outColor=t.vec4(this.color.rgb,1)})).$else((function(){this.$outputs.outColor=t.vec4(sn(this,this.color.rgb),1)}))}))}}),this._bindgroupSky.color=t.createBindGroup(this._programSky.color.bindGroupLayouts[0])),this._programSky.scatter||(this._programSky.scatter=xo._createScatterProgram(t,!0),this._bindgroupSky.scatter=t.createBindGroup(this._programSky.scatter.bindGroupLayouts[0])),this._programSky["scatter-nocloud"]||(this._programSky["scatter-nocloud"]=xo._createScatterProgram(t,!1),this._bindgroupSky["scatter-nocloud"]=t.createBindGroup(this._programSky["scatter-nocloud"].bindGroupLayouts[0])),this._programSky.skybox||(this._programSky.skybox=t.buildRenderProgram({label:"SkyBoxSky",vertex(t){this.$inputs.pos=t.vec3().attrib("position"),this.$outputs.texCoord=t.vec3(),this.worldMatrix=t.mat4().uniform(0),this.viewProjMatrix=t.mat4().uniform(0),this.cameraPos=t.vec3().uniform(0),this.flip=t.vec4().uniform(0),t.main((function(){this.$outputs.texCoord=this.$inputs.pos,this.$l.worldPos=t.add(this.cameraPos,t.mul(this.worldMatrix,t.vec4(this.$inputs.pos,0)).xyz),this.$builtins.position=t.mul(this.viewProjMatrix,t.vec4(this.worldPos,1),this.flip),this.$builtins.position.z=this.$builtins.position.w}))},fragment(t){this.$outputs.outColor=t.vec4(),this.skyCubeMap=t.texCube().uniform(0),this.srgbOut=t.int().uniform(0),t.main((function(){this.$l.texCoord=t.normalize(this.$inputs.texCoord),this.$l.color=t.textureSampleLevel(this.skyCubeMap,this.texCoord,0).rgb,this.$if(t.equal(this.srgbOut,0),(function(){this.$outputs.outColor=t.vec4(this.color,1)})).$else((function(){this.$outputs.outColor=t.vec4(sn(this,this.color),1)}))}))}}),this._bindgroupSky.skybox=t.createBindGroup(this._programSky.skybox.bindGroupLayouts[0])),this._renderStatesSky||(this._renderStatesSky=t.createRenderStateSet(),this._renderStatesSky.useDepthState().enableTest(!0).enableWrite(!1).setCompareFunc("le"),this._renderStatesSky.useRasterizerState().setCullMode("none")),this._renderStatesSkyNoDepthTest||(this._renderStatesSkyNoDepthTest=t.createRenderStateSet(),this._renderStatesSkyNoDepthTest.useDepthState().enableTest(!1).enableWrite(!1),this._renderStatesSkyNoDepthTest.useRasterizerState().setCullMode("none")),this._renderStatesFog||(this._renderStatesFog=t.createRenderStateSet(),this._renderStatesFog.useRasterizerState().setCullMode("none"),this._renderStatesFog.useBlendingState().enable(!0).setBlendFunc("one","inv-src-alpha"),this._renderStatesFog.useDepthState().enableTest(!1).enableWrite(!1)),this._renderStatesFogScatter||(this._renderStatesFogScatter=t.createRenderStateSet(),this._renderStatesFogScatter.useRasterizerState().setCullMode("none"),this._renderStatesFogScatter.useBlendingState().enable(!0).setBlendFunc("one","inv-src-alpha"),this._renderStatesFogScatter.useDepthState().enableTest(!0).enableWrite(!1).setCompareFunc("gt")),this._nearestSampler||(this._nearestSampler=t.createSampler({magFilter:"nearest",minFilter:"nearest",mipFilter:"none",addressU:"clamp",addressV:"clamp"})),this._vertexLayout||(this._vertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]})),this._primitiveSky||(this._primitiveSky=new mn({size:8,anchorX:.5,anchorY:.5,anchorZ:.5}))}static _getSunDir(t){return t?.directionAndCutoff.xyz().scaleBy(-1)??xo._defaultSunDir}static _createScatterProgram(t,e){return t.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec3().attrib("position"),this.worldMatrix=t.mat4().uniform(0),this.viewProjMatrix=t.mat4().uniform(0),this.cameraPos=t.vec3().uniform(0),this.flip=t.vec4().uniform(0),t.main((function(){this.$outputs.worldDirection=t.mul(this.worldMatrix,t.vec4(this.$inputs.pos,0)).xyz,this.$builtins.position=t.mul(this.viewProjMatrix,t.vec4(t.add(this.$outputs.worldDirection,this.cameraPos),1),this.flip),this.$builtins.position.z=this.$builtins.position.w}))},fragment(t){this.$outputs.outColor=t.vec4(),this.tLut=t.tex2D().uniform(0),this.skyLut=t.tex2D().uniform(0),this.sunDir=t.vec3().uniform(0),e&&(this.cloudy=t.float().uniform(0),this.cloudIntensity=t.float().uniform(0),this.time=t.float().uniform(0),this.velocity=t.vec2().uniform(0)),this.drawGround=t.int().uniform(0),this.srgbOut=t.int().uniform(0),this.viewPos=t.vec3(Ya.viewPosition.x,Ya.viewPosition.y,Ya.viewPosition.z),t.func("getMiePhase",[t.float("cosTheta")],(function(){this.$l.g=t.float(.8),this.$l.scale=t.float(3/(8*Math.PI)),this.$l.gg=t.mul(this.g,this.g),this.$l.num=t.mul(t.sub(1,this.gg),t.add(t.mul(this.cosTheta,this.cosTheta),1)),this.$l.denom=t.mul(t.add(2,this.gg),t.pow(t.sub(t.add(1,this.gg),t.mul(this.g,this.cosTheta,2)),1.5)),this.$return(t.div(t.mul(this.scale,this.num),this.denom))})),t.func("noise",[t.vec3("p"),t.float("t")],(function(){this.p2=t.mul(this.p,.25),this.f=t.mul(_o(this,this.p2),.5),this.p2=t.mul(this.p2,3.02),this.p2.y=t.sub(this.p2.y,t.mul(this.t,.02)),this.f=t.add(this.f,t.mul(_o(this,this.p2),.25)),this.p2=t.mul(this.p2,3.03),this.p2.y=t.add(this.p2.y,t.mul(this.t,.01)),this.f=t.add(this.f,t.mul(_o(this,this.p2),.125)),this.p2=t.mul(this.p2,3.02),this.f=t.add(this.f,t.mul(_o(this,this.p2),.0625)),this.p2=t.mul(this.p2,3.01),this.f=t.add(this.f,t.mul(_o(this,this.p2),.03125)),this.p2=t.mul(this.p2,3.01),this.f=t.add(this.f,t.mul(_o(this,this.p2),.015625)),this.$return(this.f)})),t.func("getValFromSkyLUT",[t.vec3("rayDir"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.viewPos),this.$l.up=t.div(this.viewPos,this.height),this.$l.c=t.div(t.sqrt(t.sub(t.mul(this.height,this.height),t.mul(Ya.groundRadius,Ya.groundRadius))),this.height),this.$l.horizonAngle=t.acos(t.clamp(this.c,-1,1)),this.$l.altitudeAngle=t.sub(this.horizonAngle,t.acos(t.dot(this.rayDir,this.up))),this.$l.azimuthAngle=t.float(),this.$if(t.greaterThan(t.abs(this.altitudeAngle),.5*Math.PI-1e-4),(function(){this.azimuthAngle=0})).$else((function(){this.$l.right=t.cross(this.sunDir,this.up),this.$l.forward=t.cross(this.up,this.right),this.$l.projectedDir=t.normalize(t.sub(this.rayDir,t.mul(this.up,t.dot(this.rayDir,this.up)))),this.$l.sinTheta=t.dot(this.projectedDir,this.right),this.$l.cosTheta=t.dot(this.projectedDir,this.forward),this.azimuthAngle=t.add(t.atan2(this.sinTheta,this.cosTheta),Math.PI)})),this.$l.v=t.add(.5,t.mul(.5,t.sign(this.altitudeAngle),t.sqrt(t.mul(t.abs(this.altitudeAngle),2/Math.PI)))),this.$l.uv=t.vec2(t.div(this.azimuthAngle,2*Math.PI),this.v),this.$return(t.textureSampleLevel(this.skyLut,this.uv,0).rgb)})),t.func("sunWithBloom",[t.vec3("rayDir"),t.vec3("sunDir")],(function(){this.$l.sunSolidAngle=.53*Math.PI/180,this.$l.minSunCosTheta=t.cos(this.sunSolidAngle),this.$l.cosTheta=t.dot(this.rayDir,this.sunDir),this.$if(t.greaterThanEqual(this.cosTheta,this.minSunCosTheta),(function(){this.$return(t.vec3(1))})),this.$l.offset=t.sub(this.minSunCosTheta,this.cosTheta),this.$l.gaussianBloom=t.mul(t.exp(t.mul(this.offset,-5e4)),.5),this.$l.invBloom=t.mul(t.div(1,t.add(.02,t.mul(this.offset,300))),.01),this.$return(t.vec3(t.add(this.gaussianBloom,this.invBloom)))})),t.func("rayIntersectSphere",[t.vec3("ro"),t.vec3("rd"),t.float("rad")],(function(){this.$l.b=t.dot(this.ro,this.rd),this.$l.c=t.sub(t.dot(this.ro,this.ro),t.mul(this.rad,this.rad)),this.$if(t.and(t.greaterThan(this.c,0),t.greaterThan(this.b,0)),(function(){this.$return(t.float(-1))})),this.$l.bb=t.mul(this.b,this.b),this.$l.discr=t.sub(this.bb,this.c),this.$if(t.lessThan(this.discr,0),(function(){this.$return(t.float(-1))})),this.$if(t.greaterThan(this.discr,this.bb),(function(){this.$return(t.sub(t.sqrt(this.discr),this.b))})),this.$return(t.sub(t.neg(t.sqrt(this.discr)),this.b))})),t.func("getValFromTLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,Ya.groundRadius),t.sub(Ya.atmosphereRadius,Ya.groundRadius))))),this.$return(t.textureSampleLevel(this.tLut,this.uv,0).rgb)})),t.main((function(){this.$l.rayDir=t.normalize(this.$inputs.worldDirection),this.$l.sunIntensity=t.sqrt(t.max(0,t.mul(this.sunDir.y,this.rayDir.y))),e&&(this.$l.noiseValue=t.float(),this.$if(t.lessThanEqual(this.rayDir.y,0),(function(){this.noiseValue=0})).$else((function(){this.$l.tMin=t.div(3e3,this.rayDir.y),this.$l.cloudPoint=t.mul(this.rayDir,this.tMin),this.speed=t.mul(t.vec3(this.velocity.x,0,this.velocity.y),this.time),this.$l.noiseScale=t.float(4e-4),this.noiseValue=this.noise(t.mul(t.add(this.cloudPoint,this.speed),this.noiseScale),this.time),this.noiseValue=t.add(this.noiseValue,this.cloudy),this.noiseValue=t.smoothStep(1,t.add(1,this.cloudy),this.noiseValue)})),this.$l.sunColor=t.mul(this.getValFromSkyLUT(this.sunDir,this.sunDir),this.sunIntensity),this.$l.cloudColor=t.mul(this.sunColor.rgb,t.mul(this.noiseValue,this.cloudIntensity))),this.$l.skyRayDir=this.$choice(t.equal(this.drawGround,0),t.normalize(t.vec3(this.rayDir.x,t.max(0,this.rayDir.y),this.rayDir.z)),this.rayDir),this.$l.lum=this.getValFromSkyLUT(this.skyRayDir,this.sunDir),this.$l.sunLum=this.sunWithBloom(this.rayDir,this.sunDir),this.sunLum=t.smoothStep(t.vec3(.002),t.vec3(1),this.sunLum),this.$if(t.greaterThan(t.length(this.sunLum),0),(function(){this.$if(t.greaterThanEqual(this.rayIntersectSphere(this.viewPos,this.rayDir,Ya.groundRadius),0),(function(){this.sunLum=t.vec3(0)})).$else((function(){this.sunLum=t.mul(this.sunLum,this.getValFromTLUT(this.viewPos,this.sunDir))}))})),e?(this.lum=t.add(this.lum,this.sunLum),this.$l.vfactor=t.clamp(t.div(t.sub(this.rayDir.y,.01),t.sub(.03,.01)),0,1),this.$l.factor=t.clamp(t.mul(this.noiseValue,this.vfactor),0,1),this.$l.color=t.mix(this.lum,this.cloudColor,this.factor)):this.$l.color=this.lum,this.color=t.mul(this.color,8),this.color=t.pow(this.color,t.vec3(1.3)),this.color=t.div(this.color,t.add(t.mul(t.smoothStep(0,.2,t.clamp(this.sunDir.y,0,1)),2),.15)),this.$if(t.equal(this.srgbOut,0),(function(){this.$outputs.outColor=t.vec4(this.color,1)})).$else((function(){this.$outputs.outColor=t.vec4(sn(this,this.color),1)}))}))}})}}class To{static _ownDepthTextures=new Set;static _variantWidth=0;static _variantHeight=0;static _releaseFuncs=new Map;static _cachedFrameBuffers={};static getFramebufferFixedSize(t,e,i,s,r,a,n,o,h=1){return this.getFramebuffer(t,e,i,s,r,a,n,o,!1,h)}static getFramebufferVariantSize(t,e,i,s,r,a,n,o,h=1){return this.getFramebuffer(t,e,i,s,r,a,n,o,!0,h)}static getFramebufferFixedSizeWithDepth(t,e,i,s,r,a=1){return this.getFramebufferWithDepth(t,e,i,s,r,!1,a)}static getFramebufferVariantSizeWithDepth(t,e,i,s,r,a=1){return this.getFramebufferWithDepth(t,e,i,s,r,!0,a)}static getFramebuffer(t,e,i,s,r,a,n,o,h,u){!h||t===this._variantWidth&&e===this._variantHeight||(this.purgeVariantFramebuffers(),this._variantWidth=t,this._variantHeight=e),"2darray"!==a&&"2darray"!==n&&(i=1);const l=Y.instance.device;"webgl"===l.type&&(u=1);const c=h?"":`${t}x${e}`,d=`${s??""}:${r??""}:${s?a:""}:${i}:${r?n:""}:${s&&o?1:0}:${u}`,p=this._cachedFrameBuffers[c],_=p?.get(null)?.[d];let m=null;if(_&&0!==_.length)m=_.pop();else{let h=null;const c=o?{}:{samplerOptions:{mipFilter:"none"}};if(s)switch(a){case"2d":h=l.createTexture2D(s,t,e,c);break;case"2darray":h=l.createTexture2DArray(s,t,e,i,c);break;case"cube":h=l.createCubeTexture(s,t,c)}let d=null;if(r)switch(n){case"2d":d=l.createTexture2D(r,t,e);break;case"2darray":d=l.createTexture2DArray(r,t,e,i);break;case"cube":d=l.createCubeTexture(r,t)}m=l.createFrameBuffer(h?[h]:[],d,{sampleCount:u,ignoreDepthStencil:!1}),this._ownDepthTextures.add(d)}return this._releaseFuncs.set(m,h?this.releaseWithoutDepthTexVariantSize:this.releaseWithoutDepthTexFixedSize),m}static getFramebufferWithDepth(t,e,i,s,r,a,n){!a||t.width===this._variantWidth&&t.height===this._variantHeight||(this.purgeVariantFramebuffers(),this._variantWidth=t.width,this._variantHeight=t.height),i&&"2darray"===s||(e=1);const o=Y.instance.device;"webgl"===o.type&&(n=1);const h=a?"":`${t.width}x${t.height}`,u=`${i??""}:${t.format}:${i?s:""}:${e}:${t.target}:${i&&r?1:0}:${n}`,l=this._cachedFrameBuffers[h],c=l?.get(t)?.[u];let d=null;if(c&&0!==c.length)d=c.pop();else{let a=null;const u=r?{}:{samplerOptions:{mipFilter:"none"}};if(i)switch(s){case"2d":a=o.createTexture2D(i,t.width,t.height,u);break;case"2darray":a=o.createTexture2DArray(i,t.width,t.height,e,u);break;case"cube":a=o.createCubeTexture(i,t.width,u)}d=o.createFrameBuffer([a],t,{sampleCount:n,ignoreDepthStencil:!1}),t.on("disposed",(()=>{const e=this._cachedFrameBuffers[h],i=e?.get(t);if(i){for(const t in i){const e=i[t].indexOf(d);e>=0&&(i[t].splice(e,1),0===i[t].length&&delete i[t])}0===Object.getOwnPropertyNames(i).length&&e.delete(t)}d.getColorAttachments()[0]?.dispose(),d.dispose()}))}return this._releaseFuncs.set(d,a?this.releaseWithDepthTexVariantSize:this.releaseWithDepthTexFixedSize),d}static releaseFramebuffer(t){const e=this._releaseFuncs.get(t);e&&(e.call(this,t),this._releaseFuncs.delete(t))}static releaseWithDepthTexFixedSize(t){this.releaseFrameBufferInternal(t,t.getDepthAttachment(),!0)}static releaseWithDepthTexVariantSize(t){this.releaseFrameBufferInternal(t,t.getDepthAttachment(),!1)}static releaseWithoutDepthTexFixedSize(t){this.releaseFrameBufferInternal(t,null,!0)}static releaseWithoutDepthTexVariantSize(t){this.releaseFrameBufferInternal(t,null,!1)}static releaseFrameBufferInternal(t,e,i){const s=t.getDepthAttachment()??t.getColorAttachments()[0],r=i?`${s.width}x${s.height}`:"";let a=this._cachedFrameBuffers[r];a||(a=new Map,this._cachedFrameBuffers[r]=a);const n=t.getColorAttachments()[0],o=t.getDepthAttachment(),h=n?.isTexture2DArray()?n.depth:o?.isTexture2DArray()?o.depth:1,u=`${n?.format??""}:${o?.format??""}:${n?n.target:""}:${h}:${o?o.target:""}:${n?.mipLevelCount>1?1:0}:${t.getSampleCount()}`;let l=a.get(e);l||(l={},a.set(e,l));let c=l[u];c||(c=[],l[u]=c),c.push(t)}static purgeVariantFramebuffers(){const t=this._cachedFrameBuffers[""];t?.forEach(((t,e)=>{for(const e in t)t[e].forEach((t=>{t.getColorAttachments()[0].dispose(),t.dispose()}));this._ownDepthTextures.has(e)&&(this._ownDepthTextures.delete(e),e?.dispose())})),t?.clear()}}class bo{_resourceDirty;constructor(){this._resourceDirty=!0}invalidateResource(){this._resourceDirty=!0}updateResources(t){this.doUpdateResources(t)}}const Eo=[[.511749,.547686],[.58929,.257224],[.165018,.57663],[.407692,.742285],[.707012,.646523],[.31463,.466825],[.801257,.485186],[.418136,.146517],[.579889,.0368284],[.79801,.140114],[-.0413185,.371455],[-.0529108,.627352],[.0821375,.882071],[.17308,.301207],[-.120452,.867216],[.371096,.916454],[-.178381,.146101],[-.276489,.550525],[.12542,.126643],[-.296654,.286879],[.261744,-.00604975],[-.213417,.715776],[.425684,-.153211],[-.480054,.321357],[-.0717878,-.0250567],[-.328775,-.169666],[-.394923,.130802],[-.553681,-.176777],[-.722615,.120616],[-.693065,.309017],[.603193,.791471],[-.0754941,-.297988],[.109303,-.156472],[.260605,-.280111],[.129731,-.487954],[-.537315,.520494],[-.42758,.800607],[.77309,-.0728102],[.908777,.328356],[.985341,.0759158],[.947536,-.11837],[-.103315,-.610747],[.337171,-.584],[.210919,-.720055],[.41894,-.36769],[-.254228,-.49368],[-.428562,-.404037],[-.831732,-.189615],[-.922642,.0888026],[-.865914,.427795],[.706117,-.311662],[.545465,-.520942],[-.695738,.664492],[.389421,-.899007],[.48842,-.708054],[.760298,-.62735],[-.390788,-.707388],[-.591046,-.686721],[-.769903,-.413775],[-.604457,-.502571],[-.557234,.00451362],[.147572,-.924353],[-.0662488,-.892081],[.863832,-.4072]];function yo(t){return t.$builder.div(1,qa.getShadowCameraParams(t).z)}function vo(t,e){const i="lib_computeShadowMapDepth",s=t.$builder;return s.func(i,[],(function(){ht(e)?this.$return(s.vec4(s.emulateDepthClamp?s.clamp(t.$inputs.clamppedDepth,0,1):t.$builtins.fragCoord.z,0,0,1)):(this.$l.depth=s.float(),this.$l.lightType=qa.getLightTypeForShadow(this),this.$if(s.equal(this.lightType,1),(function(){this.depth=s.emulateDepthClamp?s.clamp(this.$inputs.clamppedDepth,0,1):this.$builtins.fragCoord.z})).$elseif(s.equal(this.lightType,Wa),(function(){this.$l.lightSpacePos=s.mul(qa.getLightViewMatrixForShadow(this),qa.getWorldPosition(this)),this.depth=s.clamp(s.div(s.length(this.lightSpacePos.xyz),qa.getLightPositionAndRangeForShadow(this).w),0,1)})).$else((function(){this.$l.lightSpacePos=s.mul(qa.getLightViewMatrixForShadow(this),qa.getWorldPosition(this)),this.depth=s.clamp(s.div(s.neg(this.lightSpacePos.z),qa.getLightPositionAndRangeForShadow(this).w),0,1)})),this.$return("rgba8unorm"===e?Ja(this,this.depth):s.vec4(this.depth,0,0,1)))})),s.getGlobalScope()[i]()}function So(t,e){const i="lib_computeReceiverPlaneDepthBias",s=t.$builder;return s.func(i,[s.vec4("coords")],(function(){this.$l.dx=s.dpdx(this.coords),this.$l.dy=s.dpdy(this.coords),this.$l.biasMultiply=s.float(1),this.$l.uv=s.vec2(s.sub(s.mul(this.dy.y,this.dx.z),s.mul(this.dx.y,this.dy.z)),s.sub(s.mul(this.dx.x,this.dy.z),s.mul(this.dy.x,this.dx.z))),this.$l.uv=s.mul(this.$l.uv,s.div(this.biasMultiply,s.sub(s.mul(this.dx.x,this.dy.y),s.mul(this.dx.y,this.dy.x)))),this.$l.minFractionalError=s.float(.01),this.$l.fractionalSamplingError=s.dot(s.vec2(yo(this)),s.abs(this.$l.uv)),this.$l.staticBias=s.min(this.$l.fractionalSamplingError,this.$l.minFractionalError),this.$return(s.vec3(this.$l.uv,this.$l.staticBias))})),s.getGlobalScope()[i](e)}function wo(t,e,i,s,r,a){const n=a?"lib_sampleShadowMapCascadePCF":"lib_sampleShadowMapPCF",o=t.$builder,h=ht(e);return o.func(n,[o.vec2("coords"),o.float("z"),o.vec2("offset"),...a?[o.int("cascade")]:[]],(function(){const t=this.z,i=o.add(this.coords,this.offset);h?this.$return(a&&"webgl"!==Y.instance.device.type?o.textureArraySampleCompareLevel(this.shadowMap,i,this.cascade,t):o.textureSampleCompareLevel(this.shadowMap,i,t)):(this.$l.shadowTex=a&&"webgl"!==Y.instance.device.type?o.textureArraySampleLevel(this.shadowMap,i,this.cascade,0):o.textureSampleLevel(this.shadowMap,i,0),"rgba8unorm"===e&&(this.shadowTex.x=Qa(this,this.shadowTex)),this.$return(o.step(t,this.shadowTex.x)))})),o.getGlobalScope()[n](i,r,s,...a?[a]:[])}function Co(t,e,i,s,r,a){const n="lib_sampleShadowMap",o=t.$builder,h=ht(i);return o.func(n,[e===Wa?o.vec3("coords"):o.vec2("coords"),o.float("z"),...a?[o.int("cascade")]:[]],(function(){e===Wa?h?this.$return(o.clamp(o.textureSampleCompareLevel(this.shadowMap,this.coords,this.z),0,1)):(this.$l.shadowTex=o.textureSampleLevel(this.shadowMap,this.coords,0),"rgba8unorm"===i&&(this.shadowTex.x=Qa(this,this.shadowTex)),this.$return(o.step(this.z,this.shadowTex.x))):h?this.$return(a&&"webgl"!==Y.instance.device.type?o.textureArraySampleCompareLevel(this.shadowMap,this.coords,this.cascade,this.z):o.textureSampleCompareLevel(this.shadowMap,this.coords,this.z)):(this.$l.shadowTex=a&&"webgl"!==Y.instance.device.type?o.textureArraySampleLevel(this.shadowMap,this.coords,this.cascade,0):o.textureSampleLevel(this.shadowMap,this.coords,0),"rgba8unorm"===i&&(this.shadowTex.x=Qa(this,this.shadowTex)),this.$return(o.step(this.z,this.shadowTex.x)))})),a?o.getGlobalScope()[n](s,r,a):o.getGlobalScope()[n](s,r)}function Ao(t,e,i){const s="lib_chebyshevUpperBound",r=t.$builder;return r.func(s,[r.float("distance"),r.vec2("occluder")],(function(){this.$l.shadow=r.float(1),this.$l.test=r.step(this.distance,this.occluder.x),this.$if(r.notEqual(this.test,1),(function(){this.$l.d=r.sub(this.distance,this.occluder.x),this.$l.variance=r.max(r.mul(this.occluder.y,this.occluder.y),0);const t=qa.getDepthBiasValues(this).z;this.shadow=r.div(this.variance,r.add(this.variance,r.mul(this.d,this.d))),this.shadow=r.clamp(r.div(r.sub(this.shadow,t),r.sub(1,t)),0,1)})),this.$return(this.shadow)})),r.getGlobalScope()[s](e,i)}function Ro(t,e,i,s,r){const a="lib_filterShadowVSM",n=t.$builder;return n.func(a,[n.vec4("texCoord"),...r?[n.int("cascade")]:[]],(function(){e===Wa?(this.$l.shadowTex=n.textureSampleLevel(this.shadowMap,this.texCoord.xyz,0),this.$return(Ao(this,this.texCoord.w,"rgba8unorm"===i?tn(this,this.shadowTex):this.shadowTex.rg))):("webgl"!==Y.instance.device.type&&r?this.$l.shadowTex=n.textureArraySampleLevel(this.shadowMap,this.texCoord.xy,this.cascade,0):this.$l.shadowTex=n.textureSampleLevel(this.shadowMap,this.texCoord.xy,0),this.$return(Ao(this,this.texCoord.z,"rgba8unorm"===i?tn(this,this.shadowTex):this.shadowTex.rg)))})),n.getGlobalScope()[a](s,...r?[r]:[])}function Mo(t,e,i,s,r){const a="lib_filterShadowESM",n=t.$builder;return n.func(a,[e===Wa?n.vec3("shadowVertex"):n.vec4("shadowVertex"),...r?[n.int("cascade")]:[]],(function(){e===Wa?(this.$l.depth=n.div(n.length(this.shadowVertex.xyz),qa.getLightPositionAndRangeForShadow(this).w),this.$l.shadowTex=n.textureSampleLevel(this.shadowMap,this.shadowVertex.xyz,0),"rgba8unorm"===i&&(this.shadowTex.x=Qa(this,this.shadowTex))):(r&&"webgl"!==Y.instance.device.type?this.$l.shadowTex=n.textureArraySampleLevel(this.shadowMap,this.shadowVertex.xy,this.cascade,0):this.$l.shadowTex=n.textureSampleLevel(this.shadowMap,this.shadowVertex.xy,0),"rgba8unorm"===i&&(this.shadowTex.x=Qa(this,this.shadowTex)),3===e?(this.$l.nearFar=qa.getShadowCameraParams(this).xy,this.$l.depth=Ka(this,this.shadowVertex.z,this.nearFar)):this.$l.depth=this.shadowVertex.z);const t=qa.getDepthBiasValues(this).z;this.$return(n.clamp(n.exp(n.min(87,n.mul(t,n.sub(this.shadowTex.x,this.depth)))),0,1))})),n.getGlobalScope()[a](s,...r?[r]:[])}function $o(t,e,i,s,r,a,n){const o=`lib_filterShadowPCF${s}x${s}`,h=t.$builder;return h.func(o,[h.vec4("texCoord"),...a?[h.vec3("receiverPlaneDepthBias")]:[],...n?[h.int("cascade")]:[]],(function(){this.$l.lightDepth=this.texCoord.z,a&&(this.lightDepth=h.sub(this.lightDepth,this.receiverPlaneDepthBias.z));const t=yo(this);this.$l.uv=h.add(h.mul(this.texCoord.xy,h.vec2(function(t){return qa.getShadowCameraParams(t).z}(this))),h.vec2(0)),this.$l.st=h.fract(this.uv),this.$l.baseUV=h.sub(h.floor(this.uv),h.vec2(.5)),this.baseUV=h.mul(this.baseUV,t),this.$l.shadow=h.float(0),3===s?(this.$l.uvw0=h.sub(h.vec2(3),h.mul(2,this.st)),this.$l.uvw1=h.add(h.vec2(1),h.mul(2,this.st)),this.$l.u=h.mul(h.vec2(h.sub(h.div(h.sub(2,this.st.x),this.uvw0.x),1),h.add(h.div(this.st.x,this.uvw1.x),1)),t),this.$l.v=h.mul(h.vec2(h.sub(h.div(h.sub(2,this.st.y),this.uvw0.y),1),h.add(h.div(this.st.y,this.uvw1.y),1)),t),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.x,this.v.x),this.lightDepth,this.cascade),this.uvw0.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.y,this.v.x),this.lightDepth,this.cascade),this.uvw1.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.x,this.v.y),this.lightDepth,this.cascade),this.uvw0.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.y,this.v.y),this.lightDepth,this.cascade),this.uvw1.x,this.uvw1.y)),this.shadow=h.div(this.shadow,16)):5===s?(this.$l.uvw0=h.sub(h.vec2(4),h.mul(this.st,3)),this.$l.uvw1=h.vec2(7),this.$l.uvw2=h.add(h.vec2(1),h.mul(this.st,3)),this.$l.u=h.mul(h.vec3(h.sub(h.div(h.sub(3,h.mul(this.st.x,2)),this.uvw0.x),2),h.div(h.add(this.st.x,3),this.uvw1.x),h.add(h.div(this.st.x,this.uvw2.x),2)),t),this.$l.v=h.mul(h.vec3(h.sub(h.div(h.sub(3,h.mul(this.st.y,2)),this.uvw0.y),2),h.div(h.add(this.st.y,3),this.uvw1.y),h.add(h.div(this.st.y,this.uvw2.y),2)),t),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.x,this.v.x),this.lightDepth,this.cascade),this.uvw0.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.y,this.v.x),this.lightDepth,this.cascade),this.uvw1.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.z,this.v.x),this.lightDepth,this.cascade),this.uvw2.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.x,this.v.y),this.lightDepth,this.cascade),this.uvw0.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.y,this.v.y),this.lightDepth,this.cascade),this.uvw1.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.z,this.v.y),this.lightDepth,this.cascade),this.uvw2.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.x,this.v.z),this.lightDepth,this.cascade),this.uvw0.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.y,this.v.z),this.lightDepth,this.cascade),this.uvw1.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.vec2(this.u.z,this.v.z),this.lightDepth,this.cascade),this.uvw2.x,this.uvw2.y)),this.shadow=h.div(this.shadow,144)):7===s&&(this.$l.uvw0=h.sub(h.mul(this.st,5),h.vec2(6)),this.$l.uvw1=h.sub(h.mul(this.st,11),h.vec2(28)),this.$l.uvw2=h.sub(h.mul(this.st,-11),h.vec2(17)),this.$l.uvw3=h.sub(h.mul(this.st,-5),1),this.$l.u=h.vec4(h.sub(h.div(h.sub(h.mul(this.st.x,4),5),this.uvw0.x),3),h.sub(h.div(h.sub(h.mul(this.st.x,4),16),this.uvw1.x),1),h.add(h.div(h.sub(h.mul(this.st.x,-7),5),this.uvw2.x),1),h.add(h.div(h.neg(this.st.x),this.uvw3.x),3)),this.$l.v=h.vec4(h.sub(h.div(h.sub(h.mul(this.st.y,4),5),this.uvw0.y),3),h.sub(h.div(h.sub(h.mul(this.st.y,4),16),this.uvw1.y),1),h.add(h.div(h.sub(h.mul(this.st.y,-7),5),this.uvw2.y),1),h.add(h.div(h.neg(this.st.y),this.uvw3.y),3)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.x),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.x),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.x),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.x),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.y),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.y),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.y),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.y),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.z),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.z),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.z),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.z),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.w),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw3.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.w),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw3.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.w),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw3.y)),this.shadow=h.add(this.shadow,h.mul(wo(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.w),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw3.y)),this.shadow=h.div(this.shadow,2704)),this.$return(this.shadow)})),h.getGlobalScope()[o](r,...a?[a]:[],...n?[n]:[])}function No(t,e,i,s,r,a,n){const o="lib_filterShadowPoissonDisc",h=t.$builder;return h.func(o,[h.vec4("texCoord"),...a?[h.vec3("receiverPlaneDepthBias")]:[],...n?[h.int("cascade")]:[]],(function(){this.$l.lightDepth=this.texCoord.z,a&&(this.lightDepth=h.sub(this.lightDepth,this.receiverPlaneDepthBias.z)),this.$l.duv=h.vec2(),this.$l.filterRadius=h.mul(yo(this),function(t){return qa.getDepthBiasValues(t).z}(this)),this.$l.matrix=function(t,e){const i="lib_getRandomRotationMatrix",s=t.$builder;return s.func(i,[s.vec2("fragCoord")],(function(){this.$l.randomAngle=s.mul(function(t,e){const i=t.$builder;return i.fract(i.mul(52.9829189,i.fract(i.dot(e,i.vec2(.06711056,.00583715)))))}(this,e),2*Math.PI),this.$l.randomBase=s.vec2(s.cos(this.randomAngle),s.sin(this.randomAngle)),this.$return(s.mat2(this.randomBase.x,this.randomBase.y,s.neg(this.randomBase.y),this.randomBase.x))})),s.getGlobalScope()[i](e)}(this,this.$builtins.fragCoord.xy),this.$l.shadow=h.float(0);for(let t=0;t<s;t++){this.duv=h.mul(this.matrix,h.mul(h.vec2(Eo[t][0],Eo[t][1]),this.filterRadius));const s=a?h.add(this.lightDepth,h.dot(this.duv,this.receiverPlaneDepthBias.xy)):this.lightDepth;this.shadow=h.add(this.shadow,Co(this,e,i,h.add(this.texCoord.xy,this.duv),s,this.cascade))}this.shadow=h.div(this.shadow,s),this.$return(this.shadow)})),h.getGlobalScope()[o](r,...a?[a]:[],...n?[n]:[])}class Do extends bo{static instance=new Do;constructor(){super()}resourceDirty(){return!1}getType(){return"hard"}getShadowMapBorder(t){return 0}getShadowMap(t){return this.useNativeShadowMap(t)?t.shadowMapFramebuffer.getDepthAttachment():t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(this.useNativeShadowMap(t))||null}postRenderShadowMap(){}releaseTemporalResources(t){}getDepthScale(){return 1}setDepthScale(t){}getShaderHash(){return""}getShadowMapColorFormat(t){if(this.useNativeShadowMap(t))return null;{const t=Y.instance.device;return"webgl"===t.type?t.getDeviceCaps().textureCaps.supportFloatColorBuffer?"rgba32f":t.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"rgba16f":"rgba8unorm":"r32f"}}getShadowMapDepthFormat(t){return"webgl"===Y.instance.device.type?"d24s8":"d32f"}computeShadowMapDepth(t,e){return vo(e,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const a="lib_computeShadowCSM",n=e.$builder,o=this;return n.func(a,[n.vec4("shadowVertex"),n.float("NdotL"),n.int("split")],(function(){const e="rgba8unorm"!==t.shadowMap.format;this.$l.shadowCoord=n.div(this.shadowVertex.xyz,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord.xyz,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$if(this.inShadow,(function(){this.$l.shadowBias=zo.computeShadowBiasCSM(t,this,this.NdotL,this.split),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),o.useNativeShadowMap(t)?t.shadowMap.isTexture2DArray()?this.shadow=n.textureArraySampleCompareLevel(this.shadowMap,this.shadowCoord.xy,this.split,this.shadowCoord.z):this.shadow=n.textureSampleCompareLevel(this.shadowMap,this.shadowCoord.xy,this.shadowCoord.z):(t.shadowMap.isTexture2DArray()?this.$l.shadowTex=n.textureArraySampleLevel(this.shadowMap,this.shadowCoord.xy,this.split,0):this.$l.shadowTex=n.textureSampleLevel(this.shadowMap,this.shadowCoord.xy,0),e||(this.shadowTex.x=Qa(this,this.shadowTex)),this.shadow=n.step(this.shadowCoord.z,this.shadowTex.x))})),this.$return(this.shadow)})),n.getGlobalScope()[a](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",a=e.$builder,n=this;return a.func(r,[a.vec4("shadowVertex"),a.float("NdotL")],(function(){const e="rgba8unorm"!==t.shadowMap.format;t.lightType===Wa?(this.$l.dir=a.sub(this.shadowVertex.xyz,qa.getLightPositionAndRangeForShadow(this).xyz),n.useNativeShadowMap(t)?(this.$l.nearFar=qa.getShadowCameraParams(this).xy,this.$l.maxZ=a.max(a.max(a.abs(this.dir.x),a.abs(this.dir.y)),a.abs(this.dir.z)),this.$l.distance=ja(this,this.maxZ,this.nearFar),this.$l.shadowBias=zo.computeShadowBias(t,this,a.div(this.maxZ,qa.getLightPositionAndRangeForShadow(this).w),this.NdotL,!0),this.$return(a.textureSampleCompareLevel(this.shadowMap,this.dir,a.sub(this.distance,this.shadowBias)))):(this.$l.distance=a.div(a.length(this.dir),qa.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=zo.computeShadowBias(t,this,this.distance,this.NdotL,!0),this.$l.shadowTex=a.textureSampleLevel(this.shadowMap,this.dir,0),e||(this.shadowTex.x=Qa(this,this.shadowTex)),this.distance=a.sub(this.distance,this.shadowBias),this.$return(a.step(this.distance,this.shadowTex.x)))):(this.$l.shadowCoord=a.div(this.shadowVertex.xyz,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord.xyz,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$if(this.inShadow,(function(){n.useNativeShadowMap(t)?(this.$l.shadowBias=zo.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.shadow=a.textureSampleCompareLevel(this.shadowMap,this.shadowCoord.xy,this.shadowCoord.z)):(3===t.lightType?(this.$l.nearFar=qa.getShadowCameraParams(this).xy,this.shadowCoord.z=Ka(this,this.shadowCoord.z,this.nearFar),this.$l.shadowBias=zo.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!0)):this.$l.shadowBias=zo.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.$l.shadowTex=a.textureSampleLevel(this.shadowMap,this.shadowCoord.xy,0),e||(this.shadowTex.x=Qa(this,this.shadowTex)),this.shadow=a.step(this.shadowCoord.z,this.shadowTex.x))})),this.$return(this.shadow))})),a.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return"webgl"!==Y.instance.device.type}}class Io extends an{_phase;_kernelSize;_sigma;_blurSize;_logSpace;_logSpaceMultiplier;_depthTex;_depthCutoff;constructor(t,e,i,s){super(),this._phase=t,this._kernelSize=e,this._sigma=i,this._blurSize=s,this._logSpace=!1,this._logSpaceMultiplier=1,this._depthTex=null,this._depthCutoff=.7}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}get kernelSize(){return this._kernelSize}set kernelSize(t){this._kernelSize!==t&&(this._kernelSize=t,this.invalidateHash())}get logSpace(){return this._logSpace}set logSpace(t){this._logSpace!==!!t&&(this._logSpace=!!t,this.invalidateHash())}get logSpaceMultiplier(){return this._logSpaceMultiplier}set logSpaceMultiplier(t){this._logSpaceMultiplier=t}get depthTexture(){return this._depthTex}set depthTexture(t){this._depthTex!==t&&(t&&this._depthTex||this.invalidateHash(),this._depthTex=t)}get depthCutoff(){return this._depthCutoff}set depthCutoff(t){this._depthCutoff=t}setup(t,e){const i=t.$builder;if("fragment"===i.shaderKind){if(this._depthTex&&(t.depthTex=i.tex2D().sampleType("unfilterable-float").uniform(0),t.depthCutoff=i.float().uniform(0)),t.sigma=i.float().uniform(0),t.blurSize=i.float().uniform(0),this._logSpace&&"horizonal"===this._phase&&(t.multiplier=i.float().uniform(0)),"horizonal"!==this._phase&&"vertical"!==this._phase)throw new Error(`GaussianBlurFilter.setupFilter() failed: invalid phase: ${this._phase}`);if(!Number.isInteger(this._kernelSize)||this._kernelSize<0||0==(1&this._kernelSize))throw new Error(`GaussianBlurFilter.setupFilter() failed: invalid kernel size: ${this._kernelSize}`);t.blurMultiplyVec="cube"===e?"horizonal"===this._phase?i.vec3(1,0,0):i.vec3(0,1,0):"horizonal"===this._phase?i.vec2(1,0):i.vec2(0,1),t.numBlurPixelsPerSide=i.float((this._kernelSize+1)/2)}}setUniforms(t){t.setValue("sigma",this._sigma),t.setValue("blurSize",this._blurSize),this._logSpace&&"horizonal"===this._phase&&t.setValue("multiplier",this._logSpaceMultiplier),this._depthTex&&(t.setTexture("depthTex",this._depthTex),t.setValue("depthCutoff",this._depthCutoff))}filter(t,e,i,s,r,a){const n=this,o=t.$builder;return n._depthTex&&o.func("getLinearDepth",[o.vec2("uv")],(function(){this.$l.depthValue=o.textureSample(this.depthTex,this.uv),"webgl"===o.getDevice().type?this.$return(Qa(this,this.depthValue)):this.$return(this.depthValue.r)})),t.incrementalGaussian=o.vec3(),t.incrementalGaussian.x=o.div(1,o.mul(t.sigma,Math.sqrt(2*Math.PI))),t.incrementalGaussian.y=o.exp(o.div(-.5,o.mul(t.sigma,t.sigma))),t.incrementalGaussian.z=o.mul(t.incrementalGaussian.y,t.incrementalGaussian.y),t.coefficientSum=o.float(0),t.minExpValue=o.vec4(87,87,87,87),t.d0=n.readTexel(t,e,i,s,r,a),n._logSpace?t.avgValue=o.vec4(t.incrementalGaussian.x):t.avgValue=o.mul(n.readTexel(t,e,i,s,r,a),t.incrementalGaussian.x),n._depthTex&&(t.centerDepth=t.getLinearDepth(s)),t.coefficientSum=o.add(t.coefficientSum,t.incrementalGaussian.x),t.incrementalGaussian=o.vec3(o.mul(t.incrementalGaussian.xy,t.incrementalGaussian.yz),t.incrementalGaussian.z),t.$for(o.float("i"),1,t.numBlurPixelsPerSide,(function(){this.$l.uv1=o.sub(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),this.$l.d1=o.vec4(),n._depthTex?(this.$l.depth1=this.getLinearDepth(this.uv1),this.$l.test1=o.lessThan(o.abs(o.sub(this.depth1,this.centerDepth)),this.depthCutoff)):this.$l.test1=!0,this.$if(this.test1,(function(){this.d1=n.readTexel(t,e,i,this.uv1,r,a)})),this.$l.uv2=o.add(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),this.$l.d2=o.vec4(),n._depthTex?(this.$l.depth2=this.getLinearDepth(this.uv2),this.$l.test2=o.lessThan(o.abs(o.sub(this.depth2,this.centerDepth)),this.depthCutoff)):this.$l.test2=!0,this.$if(this.test2,(function(){this.d2=n.readTexel(t,e,i,o.add(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),r,a)})),n._logSpace?"horizonal"===n._phase?(this.$if(this.test1,(function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.mul(o.sub(this.d1,this.d0),this.multiplier))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)})),this.$if(this.test2,(function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.mul(o.sub(this.d2,this.d0),this.multiplier))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)}))):(this.$if(this.test1,(function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.sub(this.d1,this.d0))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)})),this.$if(this.test2,(function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.sub(this.d2,this.d0))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)}))):(this.$if(this.test1,(function(){this.avgValue=o.add(this.avgValue,o.mul(this.d1,this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)})),this.$if(this.test2,(function(){this.avgValue=o.add(this.avgValue,o.mul(this.d2,this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)}))),this.incrementalGaussian=o.vec3(o.mul(this.incrementalGaussian.xy,this.incrementalGaussian.yz),this.incrementalGaussian.z)})),t.$l.outColor=o.div(t.avgValue,t.coefficientSum),n._logSpace&&("horizonal"===n._phase?t.outColor=o.add(o.mul(t.multiplier,t.d0),o.log(t.outColor)):t.outColor=o.add(t.d0,o.log(t.outColor))),t.outColor}calcHash(){return`${this._depthTex?1:0}-${this._phase}-${this._kernelSize}-${Number(!!this._logSpace)}`}}class Lo extends Io{_packFloat;get packFloat(){return this._packFloat}set packFloat(t){this._packFloat!==!!t&&(this._packFloat=!!t,this.invalidateHash())}readTexel(t,e,i,s,r,a){const n=t.$builder,o=super.readTexel(t,e,i,s,r,a);return this.packFloat?n.vec4(Qa(t,o),0,0,1):o}writeTexel(t,e,i,s){const r=super.writeTexel(t,e,i,s);return this.packFloat?Ja(t,r.r):r}calcHash(){return`${super.calcHash()}-${Number(this.packFloat)}`}}class Fo extends bo{_depthScale;_blur;_kernelSize;_blurSize;_logSpace;_blitterH;_blitterV;_mipmap;constructor(t,e,i){super(),this._blur=!0,this._depthScale=i??500,this._kernelSize=t??5,this._blurSize=e??1,this._logSpace=!0,this._mipmap=!0,this._blitterH=new Lo("horizonal",this._kernelSize,4,1/1024),this._blitterV=new Lo("vertical",this._kernelSize,4,1/1024)}resourceDirty(){return this._resourceDirty}get blur(){return this._blur}set blur(t){this._blur!==!!t&&(this._blur=!!t,this._resourceDirty=!0)}get mipmap(){return this._mipmap}set mipmap(t){this._mipmap!==!!t&&(this._mipmap=!!t,this._blur&&(this._resourceDirty=!0))}get kernelSize(){return this._kernelSize}set kernelSize(t){this._kernelSize=t}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}get logSpace(){return this._logSpace}set logSpace(t){this._logSpace=!!t}getType(){return"esm"}getShadowMapBorder(t){return this._blur?Math.ceil((this._kernelSize+1)/2*this._blurSize):0}getShadowMap(t){const e=t.implData;return e?e.blurFramebuffer2.getColorAttachments()[0]:t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){t.implData={blurFramebuffer:null,blurFramebuffer2:null};const e=this.getShadowMapColorFormat(t),i=t.shadowMapFramebuffer.getColorAttachments()[0].target,s=t.shadowMapFramebuffer.getColorAttachments()[0].width,r=t.shadowMapFramebuffer.getColorAttachments()[0].height;this._blur&&(t.implData={blurFramebuffer:To.getFramebufferFixedSize(s,r,t.numShadowCascades,e,null,i,null,!1),blurFramebuffer2:To.getFramebufferFixedSize(s,r,t.numShadowCascades,e,null,i,null,this._mipmap)}),t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(!1)??null}postRenderShadowMap(t){if(t.implData){const e=t.implData,i=t.shadowMapFramebuffer.getColorAttachments()[0];this._blitterH.blurSize=this._blurSize/i.width,this._blitterH.kernelSize=this._kernelSize,this._blitterH.logSpace=this._logSpace,this._blitterH.packFloat="rgba8unorm"===i.format,this._blitterV.blurSize=this._blurSize/i.height,this._blitterV.kernelSize=this._kernelSize,this._blitterV.logSpace=this._logSpace,this._blitterV.packFloat="rgba8unorm"===i.format,this._blitterH.blit(i,e.blurFramebuffer),this._blitterV.blit(e.blurFramebuffer.getColorAttachments()[0],e.blurFramebuffer2)}}releaseTemporalResources(t){const e=t.implData;e&&(To.releaseFramebuffer(e.blurFramebuffer),To.releaseFramebuffer(e.blurFramebuffer2))}getDepthScale(){return this._depthScale}setDepthScale(t){this._depthScale=t}getShaderHash(){return""}getShadowMapColorFormat(t){const e=Y.instance.device;return e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"webgl"===e.type?"rgba16f":"r16f":e.getDeviceCaps().textureCaps.supportFloatColorBuffer?"webgl"===e.type?"rgba32f":"r32f":"rgba8unorm"}getShadowMapDepthFormat(t){return"d24s8"}computeShadowMapDepth(t,e){return vo(e,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const a="lib_computeShadowCSM",n=e.$builder;return n.func(a,[n.vec4("shadowVertex"),n.float("NdotL"),n.int("split")],(function(){this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$if(this.inShadow,(function(){this.shadow=Mo(this,t.lightType,t.shadowMap.format,this.shadowCoord,this.split)})),this.$return(this.shadow)})),n.getGlobalScope()[a](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",a=e.$builder;return a.func(r,[a.vec4("shadowVertex"),a.float("NdotL")],(function(){t.lightType===Wa?(this.$l.dir=a.sub(this.shadowVertex.xyz,qa.getLightPositionAndRangeForShadow(this).xyz),this.$return(Mo(this,Wa,t.shadowMap.format,this.dir))):(this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$if(this.inShadow,(function(){this.shadow=Mo(this,t.lightType,t.shadowMap.format,this.shadowCoord)})),this.$return(this.shadow))})),a.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return!1}}class Po extends an{_phase;_packFloat;_blurSize;_kernelSize;constructor(t,e,i,s){super(),this._phase=t,this._blurSize=i,this._kernelSize=e,this._packFloat=s}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}get kernelSize(){return this._kernelSize}set kernelSize(t){t!==this._kernelSize&&(this._kernelSize=t,this.invalidateHash())}get packFloat(){return this._packFloat}set packFloat(t){this._packFloat!==!!t&&(this._packFloat=!!t,this.invalidateHash())}setup(t,e){const i=t.$builder;"fragment"===i.shaderKind&&(t.blurSize=i.float().uniform(0),t.blurMultiplyVec="cube"===e?"horizonal"===this._phase?i.vec3(1,0,0):i.vec3(0,1,0):"horizonal"===this._phase?i.vec2(1,0):i.vec2(0,1),t.numBlurPixelsPerSide=i.float((this._kernelSize+1)/2),t.weight=i.float(1/(this._kernelSize*this._kernelSize)))}setUniforms(t){t.setValue("blurSize",this._blurSize)}readTexel(t,e,i,s,r,a){const n=t.$builder,o=super.readTexel(t,e,i,s,r,a);return this._packFloat?"horizonal"===this._phase?n.vec4(Qa(t,o)):n.vec4(tn(t,o),0,0):o}writeTexel(t,e,i,s){const r=super.writeTexel(t,e,i,s);return this._packFloat?function(t,e,i){const s=t.$builder,r="lib_Encode2HalfToRGBA";return s.func(r,[s.float("a"),s.float("b")],(function(){this.$l.t=s.vec4(this.a,s.fract(s.mul(this.a,255)),this.b,s.fract(s.mul(this.b,255))),this.$return(s.vec4(s.sub(this.t.x,s.div(this.t.y,255)),this.t.y,s.sub(this.t.z,s.div(this.t.w,255)),this.t.w))})),s.getGlobalScope()[r](e,i)}(t,r.x,r.y):r}filter(t,e,i,s,r,a){const n=this,o=t.$builder;return t.d0=n.readTexel(t,e,i,s,r,a),t.mean=o.float(0),t.squaredMean=o.float(0),t.$for(o.float("i"),1,t.numBlurPixelsPerSide,(function(){this.d1=n.readTexel(this,e,i,o.sub(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),r,a),this.d2=n.readTexel(this,e,i,o.add(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),r,a),this.mean=o.add(this.mean,this.d1.x),this.mean=o.add(this.mean,this.d2.x),"horizonal"===n._phase?(this.squaredMean=o.add(this.squaredMean,o.mul(this.d1.x,this.d1.x)),this.squaredMean=o.add(this.squaredMean,o.mul(this.d2.x,this.d2.x))):(this.squaredMean=o.add(this.squaredMean,o.dot(this.d1.xy,this.d1.xy)),this.squaredMean=o.add(this.squaredMean,o.dot(this.d2.xy,this.d2.xy)))})),t.mean=o.div(t.mean,n._kernelSize),t.squaredMean=o.div(t.squaredMean,n._kernelSize),t.stdDev=o.sqrt(o.max(0,o.sub(t.squaredMean,o.mul(t.mean,t.mean)))),o.vec4(t.mean,t.stdDev,0,1)}calcHash(){return`${this._phase}-${this._kernelSize}-${Number(this._packFloat)}`}}class Bo extends bo{_blur;_kernelSize;_blurSize;_blitterH;_blitterV;_mipmap;_darkness;constructor(t,e,i){super(),this._blur=!0,this._kernelSize=t??5,this._blurSize=e??1,this._darkness=i??0,this._mipmap=!0,this._blitterH=new Po("horizonal",this._kernelSize,1/1024,!1),this._blitterV=new Po("vertical",this._kernelSize,1/1024,!1)}resourceDirty(){return this._resourceDirty}get blur(){return this._blur}set blur(t){this._blur!==!!t&&(this._blur=!!t,this._resourceDirty=!0)}get mipmap(){return this._mipmap}set mipmap(t){this._mipmap!==!!t&&(this._mipmap=!!t,this._blur&&(this._resourceDirty=!0))}get kernelSize(){return this._kernelSize}set kernelSize(t){this._kernelSize=t}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}getDepthScale(){return this._darkness}setDepthScale(t){this._darkness=t}getType(){return"vsm"}getShadowMapBorder(t){return this._blur?Math.ceil((this._kernelSize+1)/2*this._blurSize):0}getShadowMap(t){const e=t.implData;return e?e.blurFramebuffer2.getColorAttachments()[0]:t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){const e=this.getShadowMapColorFormat(t),i=t.shadowMapFramebuffer.getColorAttachments()[0].target,s=t.shadowMapFramebuffer.getColorAttachments()[0].width,r=t.shadowMapFramebuffer.getColorAttachments()[0].height;this._blur&&(t.implData={blurFramebuffer:To.getFramebufferFixedSize(s,r,t.numShadowCascades,e,null,i,null,!1),blurFramebuffer2:To.getFramebufferFixedSize(s,r,t.numShadowCascades,e,null,i,null,this._mipmap)}),t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(!1)??null}postRenderShadowMap(t){if(this._blur){const e=t.implData;this._blitterH.blurSize=this._blurSize/t.shadowMap.width,this._blitterH.kernelSize=this._kernelSize,this._blitterH.packFloat="rgba8unorm"===t.shadowMap.format,this._blitterV.blurSize=this._blurSize/t.shadowMap.height,this._blitterV.kernelSize=this._kernelSize,this._blitterV.packFloat="rgba8unorm"===t.shadowMap.format,this._blitterH.blit(t.shadowMapFramebuffer.getColorAttachments()[0],e.blurFramebuffer),this._blitterV.blit(e.blurFramebuffer.getColorAttachments()[0],e.blurFramebuffer2)}}releaseTemporalResources(t){const e=t.implData;e&&(To.releaseFramebuffer(e.blurFramebuffer),To.releaseFramebuffer(e.blurFramebuffer2))}getShaderHash(){return""}getShadowMapColorFormat(t){const e=Y.instance.device;return e.getDeviceCaps().textureCaps.supportFloatColorBuffer&&e.getDeviceCaps().textureCaps.supportLinearFloatTexture?"webgl"===e.type?"rgba32f":"rg32f":e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer&&e.getDeviceCaps().textureCaps.supportLinearHalfFloatTexture?"webgl"===e.type?"rgba16f":"rg16f":"rgba8unorm"}getShadowMapDepthFormat(t){return"d24s8"}computeShadowMapDepth(t,e){return vo(e,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const a="lib_computeShadowCSM",n=e.$builder;return n.func(a,[n.vec4("shadowVertex"),n.float("NdotL"),n.int("split")],(function(){this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$if(this.inShadow,(function(){this.$l.shadowBias=zo.computeShadowBiasCSM(t,this,this.NdotL,this.split),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),this.shadow=Ro(this,t.lightType,t.shadowMap.format,this.shadowCoord,this.split)})),this.$return(this.shadow)})),n.getGlobalScope()[a](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",a=e.$builder;return a.func(r,[a.vec4("shadowVertex"),a.float("NdotL")],(function(){t.lightType===Wa?(this.$l.dir=a.sub(this.shadowVertex.xyz,qa.getLightPositionAndRangeForShadow(this).xyz),this.$l.distance=a.div(a.length(this.dir),qa.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=zo.computeShadowBias(t,this,this.distance,this.NdotL,!0),this.$l.coord=a.vec4(this.dir,a.sub(this.distance,this.shadowBias)),this.$return(Ro(this,t.lightType,t.shadowMap.format,this.coord))):(this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$if(this.inShadow,(function(){3===t.lightType?(this.$l.nearFar=qa.getShadowCameraParams(this).xy,this.shadowCoord.z=Ka(this,this.shadowCoord.z,this.nearFar),this.$l.shadowBias=zo.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!0)):this.$l.shadowBias=zo.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.shadow=Ro(this,t.lightType,t.shadowMap.format,this.shadowCoord)})),this.$return(this.shadow))})),a.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return!1}}class Oo extends bo{_tapCount;_sampleRadius;_shadowSampler;constructor(t,e){super(),this._tapCount=t??3,this._sampleRadius=e??1,this._shadowSampler=null}get tapCount(){return this._tapCount}set tapCount(t){this._tapCount=t}getType(){return"pcf-pd"}dispose(){this._shadowSampler=null}resourceDirty(){return!1}getShadowMapBorder(t){return this._sampleRadius+1}getShadowMap(t){return this.useNativeShadowMap(t)?t.shadowMapFramebuffer.getDepthAttachment():t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(this.useNativeShadowMap(t))||null}postRenderShadowMap(){}releaseTemporalResources(t){}getDepthScale(){return this._sampleRadius}setDepthScale(t){this._sampleRadius=t}getShaderHash(){return`${this._tapCount}`}getShadowMapColorFormat(t){if(this.useNativeShadowMap(t))return null;{const t=Y.instance.device;return t.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"webgl"===t.type?"rgba16f":"r16f":t.getDeviceCaps().textureCaps.supportFloatColorBuffer?"webgl"===t.type?"rgba32f":"r32f":"rgba8unorm"}}getShadowMapDepthFormat(t){return"webgl"===Y.instance.device.type?"d24s8":"d32f"}computeShadowMapDepth(t,e){return vo(e,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const a="lib_computeShadowCSM",n=e.$builder,o=this;return n.func(a,[n.vec4("shadowVertex"),n.float("NdotL"),n.int("split")],(function(){this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$l.receiverPlaneDepthBias=So(this,this.shadowCoord),this.$if(this.inShadow,(function(){this.$l.shadowBias=zo.computeShadowBiasCSM(t,this,this.NdotL,this.split),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),this.shadow=No(this,t.lightType,t.shadowMap.format,o._tapCount,this.shadowCoord,this.receiverPlaneDepthBias,this.split)})),this.$return(this.shadow)})),n.getGlobalScope()[a](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",a=e.$builder,n=this;return a.func(r,[a.vec4("shadowVertex"),a.float("NdotL")],(function(){t.lightType===Wa?(this.$l.dir=a.sub(this.shadowVertex.xyz,qa.getLightPositionAndRangeForShadow(this).xyz),n.useNativeShadowMap(t)?(this.$l.nearFar=qa.getShadowCameraParams(this).xy,this.$l.maxZ=a.max(a.max(a.abs(this.dir.x),a.abs(this.dir.y)),a.abs(this.dir.z)),this.$l.distance=ja(this,this.maxZ,this.nearFar),this.$l.shadowBias=zo.computeShadowBias(t,this,a.div(this.maxZ,qa.getLightPositionAndRangeForShadow(this).w),this.NdotL,!0),this.$return(n.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias))):(this.$l.distance=a.div(a.length(this.dir),qa.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=zo.computeShadowBias(t,this,this.distance,this.NdotL,!0),this.$return(n.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias)))):(this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$l.receiverPlaneDepthBias=So(this,this.shadowCoord),this.$if(this.inShadow,(function(){this.$l.shadowBias=zo.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.shadow=No(this,t.lightType,t.shadowMap.format,n._tapCount,this.shadowCoord,this.receiverPlaneDepthBias)})),this.$return(this.shadow))})),a.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return"webgl"!==Y.instance.device.type}sampleShadowMap(t,e,i,s,r){const a="lib_sampleShadowMap",n=e.$builder,o=this;return n.func(a,[n.vec3("coords"),n.float("z"),n.float("bias")],(function(){const e="rgba8unorm"!==t.shadowMap.format;o.useNativeShadowMap(t)?this.$return(n.clamp(n.textureSampleCompareLevel(this.shadowMap,this.coords,n.sub(this.z,this.bias)),0,1)):(this.$l.shadowTex=n.textureSampleLevel(this.shadowMap,this.coords,0),e||(this.shadowTex.x=Qa(this,this.shadowTex)),this.$l.distance=n.sub(this.z,this.bias),this.$return(n.step(this.distance,this.shadowTex.x)))})),n.getGlobalScope()[a](i,s,r)}sampleShadowMapCSM(t,e,i,s,r,a){const n="lib_sampleShadowMapCSM",o=e.$builder,h=this;return o.func(n,[o.vec4("coords"),o.int("split"),o.float("z"),o.float("bias")],(function(){const e="rgba8unorm"!==t.shadowMap.format;this.$l.distance=o.sub(this.z,this.bias),h.useNativeShadowMap(t)?t.shadowMap.isTexture2DArray()?this.$return(o.clamp(o.textureArraySampleCompareLevel(this.shadowMap,this.coords.xy,this.split,this.distance),0,1)):this.$return(o.clamp(o.textureSampleCompareLevel(this.shadowMap,this.coords.xy,this.distance),0,1)):(t.shadowMap.isTexture2DArray()?this.$l.shadowTex=o.textureArraySampleLevel(this.shadowMap,this.coords.xy,this.split,0):this.$l.shadowTex=o.textureSampleLevel(this.shadowMap,this.coords.xy,0),e||(this.shadowTex.x=Qa(this,this.shadowTex)),this.$return(o.step(this.distance,this.shadowTex.x)))})),o.getGlobalScope()[n](i,s,r,a)}}class Uo extends bo{_kernelSize;_shadowSampler;constructor(t){super(),this._kernelSize=t??5,this._shadowSampler=null}get kernelSize(){return this._kernelSize}set kernelSize(t){t=3!==t&&5!==t&&7!==t?5:t,this._kernelSize=t}getType(){return"pcf-opt"}dispose(){this._shadowSampler=null}resourceDirty(){return!1}getShadowMapBorder(t){return this._kernelSize}getShadowMap(t){return this.useNativeShadowMap(t)?t.shadowMapFramebuffer.getDepthAttachment():t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(this.useNativeShadowMap(t))||null}postRenderShadowMap(){}releaseTemporalResources(t){}getDepthScale(){return 1}setDepthScale(t){}getShaderHash(){return`${this._kernelSize}`}getShadowMapColorFormat(t){return this.useNativeShadowMap(t)?null:"rgba8unorm"}getShadowMapDepthFormat(t){return"webgl"===Y.instance.device.type?"d24s8":"d32f"}computeShadowMapDepth(t,e){return vo(e,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const a="lib_computeShadowCSM",n=e.$builder,o=this;return n.func(a,[n.vec4("shadowVertex"),n.float("NdotL"),n.int("split")],(function(){this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$l.receiverPlaneDepthBias=So(this,this.shadowCoord),this.$if(this.inShadow,(function(){this.$l.shadowBias=zo.computeShadowBiasCSM(t,this,this.NdotL,this.split),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),this.shadow=$o(this,t.lightType,t.shadowMap.format,o._kernelSize,this.shadowCoord,this.receiverPlaneDepthBias,this.split)})),this.$return(this.shadow)})),n.getGlobalScope()[a](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",a=e.$builder,n=this;return a.func(r,[a.vec4("shadowVertex"),a.float("NdotL")],(function(){t.lightType===Wa?(this.$l.dir=a.sub(this.shadowVertex.xyz,qa.getLightPositionAndRangeForShadow(this).xyz),n.useNativeShadowMap(t)?(this.$l.nearFar=qa.getShadowCameraParams(this).xy,this.$l.maxZ=a.max(a.max(a.abs(this.dir.x),a.abs(this.dir.y)),a.abs(this.dir.z)),this.$l.distance=ja(this,this.maxZ,this.nearFar),this.$l.shadowBias=zo.computeShadowBias(t,this,a.div(this.maxZ,qa.getLightPositionAndRangeForShadow(this).w),this.NdotL,!0),this.$return(n.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias))):(this.$l.distance=a.div(a.length(this.dir),qa.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=zo.computeShadowBias(t,this,this.distance,this.NdotL,!0),this.$return(n.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias)))):(this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$l.receiverPlaneDepthBias=So(this,this.shadowCoord),this.$if(this.inShadow,(function(){this.$l.shadowBias=zo.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.shadow=$o(this,t.lightType,t.shadowMap.format,n._kernelSize,this.shadowCoord,this.receiverPlaneDepthBias)})),this.$return(this.shadow))})),a.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return"webgl"!==Y.instance.device.type}sampleShadowMap(t,e,i,s,r){const a="lib_sampleShadowMap",n=e.$builder,o=this;return n.func(a,[n.vec3("coords"),n.float("z"),n.float("bias")],(function(){const e="rgba8unorm"!==t.shadowMap.format;o.useNativeShadowMap(t)?this.$return(n.clamp(n.textureSampleCompareLevel(this.shadowMap,this.coords,n.sub(this.z,this.bias)),0,1)):(this.$l.shadowTex=n.textureSampleLevel(this.shadowMap,this.coords,0),e||(this.shadowTex.x=Qa(this,this.shadowTex)),this.$l.distance=n.sub(this.z,this.bias),this.$return(n.step(this.distance,this.shadowTex.x)))})),n.getGlobalScope()[a](i,s,r)}sampleShadowMapCSM(t,e,i,s,r,a){const n="lib_sampleShadowMapCSM",o=e.$builder,h=this;return o.func(n,[o.vec4("coords"),o.int("split"),o.float("z"),o.float("bias")],(function(){const e="rgba8unorm"!==t.shadowMap.format;this.$l.distance=o.sub(this.z,this.bias),h.useNativeShadowMap(t)?t.shadowMap.isTexture2DArray()?this.$return(o.clamp(o.textureArraySampleCompareLevel(this.shadowMap,this.coords.xy,this.split,this.distance),0,1)):this.$return(o.clamp(o.textureSampleCompareLevel(this.shadowMap,this.coords.xy,this.distance),0,1)):(t.shadowMap.isTexture2DArray()?this.$l.shadowTex=o.textureArraySampleLevel(this.shadowMap,this.coords.xy,this.split,0):this.$l.shadowTex=o.textureSampleLevel(this.shadowMap,this.coords.xy,0),e||(this.shadowTex.x=Qa(this,this.shadowTex)),this.$return(o.step(this.distance,this.shadowTex.x)))})),o.getGlobalScope()[n](i,s,r,a)}}const Vo=new v,Go=new L(v.identity());class zo{static _snapMatrix=new v;static _target=new g;static _up=new g;static _frustumMin=new g;static _frustumMax=new g;static _frustumCenter=new g;static _lightCameras=new WeakMap;static _shadowMapParams=[];_light;_config;_resourceDirty;_shadowMode;_shadowDistance;_impl;_pdSampleCount;_pdSampleRadius;_pcfKernelSize;_vsmBlurKernelSize;_vsmBlurRadius;_vsmDarkness;_esmBlur;_esmBlurKernelSize;_esmBlurRadius;_esmDepthScale;constructor(t){this._light=t,this._config={shadowMapSize:1024,numCascades:1,splitLambda:.5,depthBias:.05,normalBias:.05,nearClip:1},this._resourceDirty=!0,this._shadowMode="hard",this._shadowDistance=2e3,this._impl=null,this._pdSampleCount=12,this._pdSampleRadius=4,this._pcfKernelSize=5,this._vsmBlurKernelSize=5,this._vsmBlurRadius=4,this._vsmDarkness=.3,this._esmBlur=!0,this._esmBlurKernelSize=5,this._esmBlurRadius=4,this._esmDepthScale=200,this.applyMode(this._shadowMode)}get light(){return this._light}get shadowMapSize(){return this._config.shadowMapSize}set shadowMapSize(t){!Number.isInteger(t)||t<1?console.error(`invalid shadow map size: ${t}`):this._config.shadowMapSize!==t&&(this._config.shadowMapSize=t,this._resourceDirty=!0)}get shadowDistance(){return this._shadowDistance}set shadowDistance(t){this._shadowDistance=Math.max(0,t)}get numShadowCascades(){return this._config.numCascades}set numShadowCascades(t){1===t||2===t||3===t||4===t?!this._light.isDirectionLight()&&t>1?console.error("only directional light can have more than one shadow cascades"):t!==this._config.numCascades&&(this._config.numCascades=t,this._resourceDirty=!0):console.error(`invalid shadow cascade number: ${t}`)}get splitLambda(){return this._config.splitLambda}set splitLambda(t){this._config.splitLambda!==t&&(this._config.splitLambda=t)}get depthBias(){return this._config.depthBias}set depthBias(t){this._config.depthBias=t}get normalBias(){return this._config.normalBias}set normalBias(t){this._config.normalBias=t}get nearClip(){return this._config.nearClip}set nearClip(t){this._config.nearClip!==t&&(this._config.nearClip=t)}get mode(){return this._shadowMode}set mode(t){t!==this._shadowMode&&(this._shadowMode=t,this.applyMode(this._shadowMode))}getShaderHash(t){return`${t.impl.constructor.name}_${t.impl.getShaderHash()}_${t.lightType}_${t.shadowMap.target}_${Number(t.numShadowCascades>1)}_${Number(Y.instance.device.getDeviceCaps().textureCaps.getTextureFormatInfo(t.shadowMap.format).filterable)}`}get pdSampleCount(){return this._pdSampleCount}set pdSampleCount(t){(t=Math.min(Math.max(1,Number(t)>>0),64))!==this._pdSampleCount&&(this._pdSampleCount=t,this.asPCFPD()&&(this.asPCFPD().tapCount=this._pdSampleCount))}get pdSampleRadius(){return this._pdSampleRadius}set pdSampleRadius(t){(t=Math.max(0,Number(t)>>0))!==this._pdSampleRadius&&(this._pdSampleRadius=t,this.asPCFPD()?.setDepthScale(this._pdSampleRadius))}get pcfKernelSize(){return this._pcfKernelSize}set pcfKernelSize(t){(t=3!==t&&5!==t&&7!==t?5:t)!==this._pcfKernelSize&&(this._pcfKernelSize=t,this.asPCFOPT()&&(this.asPCFOPT().kernelSize=this._pcfKernelSize))}get vsmBlurKernelSize(){return this._vsmBlurKernelSize}set vsmBlurKernelSize(t){(t=1|Math.max(3,Number(t)>>0))!==this._vsmBlurKernelSize&&(this._vsmBlurKernelSize=t,this.asVSM()&&(this.asVSM().kernelSize=this._vsmBlurKernelSize))}get vsmBlurRadius(){return this._vsmBlurRadius}set vsmBlurRadius(t){(t=Math.max(0,Number(t)||0))!==this._vsmBlurRadius&&(this._vsmBlurRadius=t,this.asVSM()&&(this.asVSM().blurSize=this._vsmBlurRadius))}get vsmDarkness(){return this._vsmDarkness}set vsmDarkness(t){(t=Math.min(.999,Math.max(0,Number(t)||0)))!==this._vsmDarkness&&(this._vsmDarkness=t,this.asVSM()?.setDepthScale(this._vsmDarkness))}get esmBlur(){return this._esmBlur}set esmBlur(t){!!t!==this.esmBlur&&(this._esmBlur=!!t,this.asESM()&&(this.asESM().blur=this._esmBlur))}get esmBlurKernelSize(){return this._esmBlurKernelSize}set esmBlurKernelSize(t){(t=1|Math.max(3,Number(t)>>0))!==this._esmBlurKernelSize&&(this._esmBlurKernelSize=t,this.asESM()&&(this.asESM().kernelSize=this._esmBlurKernelSize))}get esmBlurRadius(){return this._esmBlurRadius}set esmBlurRadius(t){(t=Math.max(0,Number(t)||0))!==this._esmBlurRadius&&(this._esmBlurRadius=t,this.asESM()&&(this.asESM().blurSize=this._esmBlurRadius))}get esmDepthScale(){return this._esmDepthScale}set esmDepthScale(t){(t=Math.max(0,Number(t)||0))!==this._esmDepthScale&&(this._esmDepthScale=t,this.asESM()?.setDepthScale(this._esmDepthScale))}computeShadowMapDepth(t,e){return this._impl.computeShadowMapDepth(t,e)}computeShadow(t,e,i,s){return this._impl.computeShadow(t,e,i,s)}computeShadowCSM(t,e,i,s,r){return this._impl.computeShadowCSM(t,e,i,s,r)}static releaseTemporalResources(t){if(t.shadowMapInfo){for(const e of t.shadowMapInfo.keys()){const i=t.shadowMapInfo.get(e);To.releaseFramebuffer(i.shadowMapFramebuffer),i.impl.releaseTemporalResources(i),i.lightType=0,i.depthClampEnabled=!1,i.shaderHash="",i.numShadowCascades=1,i.shadowMapFramebuffer=null,i.impl=null,i.shadowMap=null,i.shadowMapSampler=null,i.implData=null,this._shadowMapParams.push(i)}t.shadowMapInfo=null}}static computeShadowBias(t,e,i,s,r){const a=e.$builder,n=qa.getDepthBiasValues(e);if(1===t.lightType)return a.dot(a.mul(n.xy,a.vec2(1,a.sub(1,s))),a.vec2(1,1));{const t=qa.getShadowCameraParams(e).xy,o=r?i:Ka(e,i,t),h=a.mix(1,n.w,o);return a.dot(a.mul(n.xy,a.vec2(1,a.sub(1,s)),h),a.vec2(1,1))}}static computeShadowBiasCSM(t,e,i,s){const r=e.$builder,a=qa.getDepthBiasValues(e),n=r.vec4(r.float(r.equal(s,0)),r.float(r.equal(s,1)),r.float(r.equal(s,2)),r.float(r.equal(s,3))),o=r.dot(qa.getDepthBiasScales(e),n);return r.dot(r.mul(a.xy,r.vec2(1,r.sub(1,i)),o),r.vec2(1,1))}isTextureInvalid(t,e,i,s,r){return t&&(t.target!==e||t.format!==i||t.width!==s||t.height!==r||t.depth!==this.numShadowCascades)}createTexture(t,e,i,s,r){const a=Y.instance.device,n={samplerOptions:{mipFilter:"none"}};switch(t){case"2d":return a.createTexture2D(e,i,s,n);case"cube":return a.createCubeTexture(e,i,n);case"2darray":return a.createTexture2DArray(e,i,s,r,n);default:return null}}updateResources(t){const e=Y.instance.device,i=t.impl.getShadowMapColorFormat(t),s=t.impl.getShadowMapDepthFormat(t),r=t.numShadowCascades,a=r>1&&"webgl"!==e.type,n=r>1&&!a?2*this._config.shadowMapSize:this._config.shadowMapSize,o=r>2&&!a?2*this._config.shadowMapSize:this._config.shadowMapSize,h=a?"2darray":this._light.isPointLight()?"cube":"2d",u="webgl"===e.type?"2d":h;t.shadowMapFramebuffer=To.getFramebufferFixedSize(n,o,r,i,s,h,u,!1,1),t.impl=this._impl,this._impl.updateResources(t)}createLightCameraPoint(t){t.reparent(t.scene.rootNode),t.resetTransform(),t.setPerspective(Math.PI/2,1,this._config.nearClip,Math.min(this._shadowDistance,this._light.range)),t.position.set(this._light.positionAndRange.xyz())}createLightCameraSpot(t){t.reparent(this._light),t.resetTransform(),t.setPerspective(2*this._light.cutoff,1,this._config.nearClip,Math.min((this._shadowDistance,this._light).range))}createLightCameraDirectional(t,e,i,s,r){let a=e.frustumViewSpace;this._shadowDistance<e.getFarPlane()&&(Vo.set(e.getProjectionMatrix()),Vo.setNearFar(Vo.getNearPlane(),this._shadowDistance),Go.initWithMatrix(Vo),a=Go),r=r||0;const n=(this.shadowMapSize-2*r)/this.shadowMapSize,o=zo._frustumMin,h=zo._frustumMax,u=zo._frustumCenter,l=zo._target,c=zo._up;o.setXYZ(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),h.setXYZ(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),a.corners.forEach((t=>{o.inplaceMin(t),h.inplaceMax(t)}));let d=.5*g.distance(o,h)*n;const p=e.thisToWorld(g.add(o,h,u).scaleBy(.5),u),_=.5*t.diagonalLength*n;if(_<d&&(d=_,g.add(t.minPoint,t.maxPoint,p).scaleBy(.5)),l.setXYZ(p.x+this._light.directionAndCutoff.x,p.y+this._light.directionAndCutoff.y,p.z+this._light.directionAndCutoff.z),c.setXYZ(0,1,0),i.lookAt(p,l,c),i.position.set(p),i.setOrtho(-d,d,-d,d,-d,d),p.setXYZ(0,0,0),i.viewProjectionMatrix.transformPointP(p,p),s){const t=p.x*this.shadowMapSize*.5,e=p.y*this.shadowMapSize*.5,i=Math.round(t),r=Math.round(e);p.setXYZ(2*(i-t)/this.shadowMapSize,2*(r-e)/this.shadowMapSize,0),s.translation(p)}}static fetchShadowMapParams(){return this._shadowMapParams.length>0?this._shadowMapParams.pop():{lightType:0,depthClampEnabled:!1,shaderHash:"",cameraParams:new T,cascadeDistances:new T,depthBiasScales:new T,depthBiasValues:[new T,new T,new T,new T],numShadowCascades:1,shadowMatrices:new Float32Array(64),shadowMap:null,shadowMapSampler:null,shadowMapFramebuffer:null,impl:null,implData:null}}static fetchCameraForScene(t){const e=this._lightCameras.get(t);if(e&&0!==e.length){const i=e.pop();return i.parent=t.rootNode,i.resetTransform(),i.clipMask=0,i}return new mo(t)}static releaseCamera(t){let e=this._lightCameras.get(t.scene);e||(e=[],this._lightCameras.set(t.scene,e)),t.remove(),e.push(t)}calcSplitDistances(t,e,i){const s=[0,0,0,0,0];for(let r=0;r<=i;++r){const a=r/i,n=t*Math.pow(e/t,a),o=t+(e-t)*a;s[r]=n*this._config.splitLambda+o*(1-this._config.splitLambda)}return s}calcDepthBiasParams(t,e,i,s,r,a){const n=Math.min(t.getProjectionMatrix().getNearPlaneWidth(),t.getProjectionMatrix().getNearPlaneHeight()),o=Math.min(t.getProjectionMatrix().getFarPlaneWidth(),t.getProjectionMatrix().getFarPlaneHeight()),h=n/e/2;a.setXYZW(i*h,s*h,r,o/n)}postRenderShadowMap(t){this._impl.postRenderShadowMap(t)}render(t,e){t.shadowMapInfo||(t.shadowMapInfo=new Map);const i=zo.fetchShadowMapParams();i.impl=this._impl,i.lightType=this.light.lightType,i.numShadowCascades=1===i.lightType?this._config.numCascades:1,t.shadowMapInfo.set(this.light,i);const s=t.scene,r=t.camera;e.light=this._light,this.updateResources(i),i.shaderHash=this.getShaderHash(i);const a=Y.instance.device,n=i.shadowMapFramebuffer;i.depthClampEnabled=!1,e.clearColor=n.getColorAttachments()[0]?n.getColorAttachments()[0].isFloatFormat()?new T(1,1,1,1):new T(0,0,0,1):null;const o=this._impl.getDepthScale();if(this._light.isPointLight()){const r=zo.fetchCameraForScene(s);this.createLightCameraPoint(r),this.calcDepthBiasParams(r,this._config.shadowMapSize,this._config.depthBias,this._config.normalBias,o,i.depthBiasValues[0]),i.cameraParams.setXYZW(r.getNearPlane(),r.getFarPlane(),this._config.shadowMapSize,this._shadowDistance),a.setFramebuffer(n),i.shadowMatrices.set(v.transpose(r.viewMatrix));for(const i of[d.PX,d.NX,d.PY,d.NY,d.PZ,d.NZ])r.lookAtCubeFace(i),n.setColorAttachmentCubeFace(0,i),n.setDepthAttachmentCubeFace(i),t.camera=r,e.render(t);i.shadowMatrices.set(v.identity()),zo.releaseCamera(r)}else if(this._config.numCascades>1){const h=this.calcSplitDistances(r.getNearPlane(),Math.min(this._shadowDistance,r.getFarPlane()),this._config.numCascades),u=zo.fetchCameraForScene(s),l=zo.fetchCameraForScene(s),c=zo.fetchCameraForScene(s);c.clipMask=F.ClipLeft|F.ClipRight|F.ClipBottom|F.ClipTop,u.reparent(r),i.depthClampEnabled=Y.instance.device.getDeviceCaps().shaderCaps.supportFragmentDepth;for(let s=0;s<this._config.numCascades;s++){u.setPerspective(r.getFOV(),r.getAspect(),h[s],h[s+1]);const d=zo._snapMatrix,p=i.impl.getShadowMapBorder(i);this.createLightCameraDirectional(t.scene.boundingBox,u,l,d,p),this.createLightCameraDirectional(t.scene.boundingBox,u,c,null,p),this.calcDepthBiasParams(l,this._config.shadowMapSize,this._config.depthBias,this._config.normalBias,o,i.depthBiasValues[s]),i.depthBiasScales[s]=1,i.cameraParams.setXYZW(l.getNearPlane(),l.getFarPlane(),this._config.shadowMapSize,this._shadowDistance);let _=null;if(n.getColorAttachments()[0]?.isTexture2DArray()||n.getDepthAttachment()?.isTexture2DArray())l.setProjectionMatrix(v.multiply(d,l.getProjectionMatrix())),n.setColorAttachmentLayer(0,s),n.setDepthAttachmentLayer(s);else{const t=this._config.numCascades>2?2:1,e=this._config.numCascades>1?2:1,i=new v,r=s%2,n=s>>1;i.setRowXYZW(0,1.5-.5*e,0,0,0),i.setRowXYZW(1,0,1.5-.5*t,0,0),i.setRowXYZW(2,0,0,1,0),i.setRowXYZW(3,r-.5*e+.5,n-.5*t+.5,0,1),l.setProjectionMatrix(v.multiply(i,v.multiply(d,l.getProjectionMatrix()))),_="webgpu"===a.type?[r*this._config.shadowMapSize,(t-1-n)*this._config.shadowMapSize,this._config.shadowMapSize,this._config.shadowMapSize]:[r*this._config.shadowMapSize,n*this._config.shadowMapSize,this._config.shadowMapSize,this._config.shadowMapSize]}a.setFramebuffer(n),a.setScissor(_),t.camera=l,e.render(t,c),i.shadowMatrices.set(v.transpose(l.viewProjectionMatrix),16*s),i.cascadeDistances[s]=h[s+1]}zo.releaseCamera(u),zo.releaseCamera(l),zo.releaseCamera(c)}else{const h=zo.fetchCameraForScene(s),u=zo._snapMatrix;h.clipMask=F.ClipLeft|F.ClipRight|F.ClipBottom|F.ClipTop,this._light.isDirectionLight()?this.createLightCameraDirectional(t.scene.boundingBox,r,h,u,i.impl.getShadowMapBorder(i)):this.createLightCameraSpot(h),this.calcDepthBiasParams(h,this._config.shadowMapSize,this._config.depthBias,this._config.normalBias,o,i.depthBiasValues[0]),i.cameraParams.setXYZW(h.getNearPlane(),h.getFarPlane(),this._config.shadowMapSize,this._shadowDistance),a.setFramebuffer(n),h.setProjectionMatrix(v.multiply(u,h.getProjectionMatrix())),t.camera=h,e.render(t),i.shadowMatrices.set(v.transpose(h.viewProjectionMatrix)),zo.releaseCamera(h)}t.camera=r,this.postRenderShadowMap(i)}applyMode(t){"hard"===t||"vsm"===t||"esm"===t||"pcf-pd"===t||"pcf-opt"===t?(this._impl=null,"hard"===t?this._impl=new Do:"vsm"===t?this._impl=new Bo(this._vsmBlurKernelSize,this._vsmBlurRadius,this._vsmDarkness):"esm"===t?this._impl=new Fo(this._esmBlurKernelSize,this._esmBlurRadius,this._esmDepthScale):"pcf-pd"===t?this._impl=new Oo(this._pdSampleCount,this._pdSampleRadius):"pcf-opt"===t&&(this._impl=new Uo(this._pcfKernelSize))):console.error(`ShadowMapper.setShadowMode() failed: invalid mode: ${t}`)}asVSM(){return"vsm"===this._impl?.getType()?this._impl:null}asESM(){return"esm"===this._impl?.getType()?this._impl:null}asPCFPD(){return"pcf-pd"===this._impl?.getType()?this._impl:null}asPCFOPT(){return"pcf-opt"===this._impl?.getType()?this._impl:null}}class ko{_tileCountX;_tileCountY;_tileCountZ;_lights;_lightIndexTexture;_lightIndexFramebuffer;_lightIndexProgram;_bindGroup;_lightIndexVertexLayout;_lightIndexRenderStates;_lightBuffer;_sizeParam;_countParam;_clusterParam;constructor(){this._tileCountX=16,this._tileCountY=16,this._tileCountZ=32,this._lights=new Float32Array(3072),this._lightIndexTexture=null,this._lightIndexFramebuffer=null,this._lightIndexProgram=null,this._lightBuffer=null,this._bindGroup=null,this._lightIndexVertexLayout=null,this._lightIndexRenderStates=null,this._sizeParam=new T,this._countParam=new Int32Array(4),this._clusterParam=new T}get lightBuffer(){return this._lightBuffer}get clusterParam(){return this._clusterParam}get countParam(){return this._countParam}get lightIndexTexture(){return this._lightIndexTexture}createVertexLayout(t,e,i){let s;if("webgl"===t.type){const r=new Float32Array(this._tileCountX*this._tileCountY*this._tileCountZ*3);for(let t=0;t<r.length;t++){const s=t%e,a=Math.floor(t/e);r[3*t+0]=2*(s+.5)/e-1,r[3*t+1]=2*(a+.5)/i-1,r[3*t+2]=t}s=t.createVertexBuffer("position_f32x3",r)}else{const r=new Float32Array(this._tileCountX*this._tileCountY*this._tileCountZ*2);for(let t=0;t<r.length;t++){const s=t%e,a=Math.floor(t/e);r[2*t+0]=2*(s+.5)/e-1,r[2*t+1]=2*(a+.5)/i-1}s=t.createVertexBuffer("position_f32x2",r)}this._lightIndexVertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:s}]})}createRenderState(t){this._lightIndexRenderStates=t.createRenderStateSet(),this._lightIndexRenderStates.useDepthState().enableTest(!1).enableWrite(!1),this._lightIndexRenderStates.useRasterizerState().setCullMode("none")}createProgram(t){const e="webgl"===t.type;this._lightIndexProgram=t.buildRenderProgram({vertex(t){this.$inputs.pos=(e?t.vec3():t.vec2()).attrib("position"),this.$outputs.value=e?t.vec4():t.uvec4(),this.invProjMatrix=t.mat4().uniform(0),this.viewMatrix=t.mat4().uniform(0),this.sizeParam=t.vec4().uniform(0),this.countParam=t.ivec4().uniform(0),this.lightBuffer=t.vec4[768]().uniformBuffer(0),t.func("lineIntersectionToZPlane",[t.vec3("a"),t.vec3("b"),t.float("zDistance")],(function(){this.$l.normal=t.vec3(0,0,1),this.$l.ab=t.sub(this.b,this.a),this.$l.t=t.div(t.sub(this.zDistance,t.dot(this.normal,this.a)),t.dot(this.normal,this.ab)),this.$return(t.add(this.a,t.mul(this.t,this.ab)))})),t.func("clipToView",[t.vec4("clip")],(function(){this.$l.view=t.mul(this.invProjMatrix,this.clip),this.$return(t.div(this.view,this.view.w))})),t.func("screenToView",[t.vec4("screen")],(function(){this.$l.texCoord=t.div(this.screen.xy,this.sizeParam.xy),this.$l.clip=t.vec4(t.sub(t.mul(t.vec2(this.texCoord.x,t.sub(1,this.texCoord.y)),2),t.vec2(1)),this.screen.z,this.screen.w),this.$return(this.clipToView(this.clip))})),t.func("sphereIntersectsAABB",[t.vec4("sphere"),t.vec3("aabbMin"),t.vec3("aabbMax")],(function(){this.$l.dmin=t.float(0),this.$if(t.lessThanEqual(this.sphere.w,0),(function(){this.$return(!0)})),this.$for(t.int("i"),0,3,(function(){this.$if(t.lessThan(this.sphere.at(this.i),this.aabbMin.at(this.i)),(function(){this.$l.delta=t.sub(this.sphere.at(this.i),this.aabbMin.at(this.i)),this.dmin=t.add(this.dmin,t.mul(this.delta,this.delta))})).$elseif(t.greaterThan(this.sphere.at(this.i),this.aabbMax.at(this.i)),(function(){this.$l.delta=t.sub(this.sphere.at(this.i),this.aabbMax.at(this.i)),this.dmin=t.add(this.dmin,t.mul(this.delta,this.delta))}))})),this.$if(t.lessThanEqual(this.dmin,t.mul(this.sphere.w,this.sphere.w)),(function(){this.$return(!0)})),this.$return(!1)})),t.main((function(){"webgpu"!==t.getDevice().type&&(this.$builtins.pointSize=1),this.$builtins.position=t.vec4(this.$inputs.pos.xy,0,1),"webgpu"===t.getDevice().type&&(this.$builtins.position=t.mul(this.$builtins.position,t.vec4(1,-1,1,1))),this.$l.tileIndex=e?t.int(this.$inputs.pos.z):t.int(this.$builtins.vertexIndex),this.$l.tileSize=t.div(this.sizeParam.xy,t.vec2(this.countParam.xy)),this.$l.zIndex=t.div(this.tileIndex,t.mul(this.countParam.x,this.countParam.y)),this.$l.yIndex=t.div(t.sub(this.tileIndex,t.mul(this.zIndex,this.countParam.x,this.countParam.y)),this.countParam.x),this.$l.xIndex=t.sub(this.tileIndex,t.add(t.mul(this.zIndex,this.countParam.x,this.countParam.y),t.mul(this.yIndex,this.countParam.x))),this.$l.maxPoint_sS=t.vec4(t.mul(t.vec2(t.float(t.add(this.xIndex,1)),t.float(t.add(this.yIndex,1))),this.tileSize),0,1),this.$l.minPoint_sS=t.vec4(t.mul(t.vec2(t.float(this.xIndex),t.float(this.yIndex)),this.tileSize),0,1),this.$l.maxPoint_vS=this.screenToView(this.maxPoint_sS).xyz,this.$l.minPoint_vS=this.screenToView(this.minPoint_sS).xyz,this.$l.tileNear=t.mul(t.neg(this.sizeParam.z),t.pow(t.div(this.sizeParam.w,this.sizeParam.z),t.div(t.float(this.zIndex),t.float(this.countParam.z)))),this.$l.tileFar=t.mul(t.neg(this.sizeParam.z),t.pow(t.div(this.sizeParam.w,this.sizeParam.z),t.div(t.add(t.float(this.zIndex),1),t.float(this.countParam.z)))),this.$l.eyePos=t.vec3(0),this.$l.minPointNear=this.lineIntersectionToZPlane(this.eyePos,this.minPoint_vS,this.tileNear),this.$l.minPointFar=this.lineIntersectionToZPlane(this.eyePos,this.minPoint_vS,this.tileFar),this.$l.maxPointNear=this.lineIntersectionToZPlane(this.eyePos,this.maxPoint_vS,this.tileNear),this.$l.maxPointFar=this.lineIntersectionToZPlane(this.eyePos,this.maxPoint_vS,this.tileFar),this.$l.aabbMin=t.min(t.min(this.minPointNear,this.minPointFar),t.min(this.maxPointNear,this.maxPointFar)),this.$l.aabbMax=t.max(t.max(this.minPointNear,this.minPointFar),t.max(this.maxPointNear,this.maxPointFar)),this.$l.n=t.int(0),e?(this.$l.lightIndices=t.float[8](),this.$for(t.int("i"),0,8,(function(){this.lightIndices.setAt(this.i,0)})),this.$for(t.int("i"),1,256,(function(){this.$if(t.equal(this.i,this.countParam.w),(function(){this.$break()})),this.$l.light=this.lightBuffer.at(t.mul(this.i,3)),this.$l.lightPos=t.mul(this.viewMatrix,t.vec4(this.light.xyz,1)),this.$l.lightPos.w=this.light.w,this.$if(this.sphereIntersectsAABB(this.lightPos,this.aabbMin,this.aabbMax),(function(){this.$for(t.int("j"),0,8,(function(){this.$if(t.equal(this.j,this.n),(function(){this.lightIndices.setAt(this.j,t.float(this.i)),this.n=t.add(this.n,1),this.$break()}))})),this.$if(t.equal(this.n,8),(function(){this.$break()}))}))})),this.$outputs.value.r=t.add(t.mul(this.lightIndices[0],256),this.lightIndices[1]),this.$outputs.value.g=t.add(t.mul(this.lightIndices[2],256),this.lightIndices[3]),this.$outputs.value.b=t.add(t.mul(this.lightIndices[4],256),this.lightIndices[5]),this.$outputs.value.a=t.add(t.mul(this.lightIndices[6],256),this.lightIndices[7])):(this.$l.lightIndex=[t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0)],this.$for(t.uint("i"),1,t.uint(this.countParam.w),(function(){this.$l.light=this.lightBuffer.at(t.mul(this.i,3)),this.$l.lightPos=t.mul(this.viewMatrix,t.vec4(this.light.xyz,1)),this.$l.lightPos.w=this.light.w,this.$if(this.sphereIntersectsAABB(this.lightPos,this.aabbMin,this.aabbMax),(function(){this.lightIndex.setAt(this.n,this.i),this.n=t.add(this.n,1),this.$if(t.equal(this.n,16),(function(){this.$break()}))}))})),this.$l.r=t.add(t.sal(this.lightIndex[0],24),t.sal(this.lightIndex[1],16),t.sal(this.lightIndex[2],8),this.lightIndex[3]),this.$l.g=t.add(t.sal(this.lightIndex[4],24),t.sal(this.lightIndex[5],16),t.sal(this.lightIndex[6],8),this.lightIndex[7]),this.$l.b=t.add(t.sal(this.lightIndex[8],24),t.sal(this.lightIndex[9],16),t.sal(this.lightIndex[10],8),this.lightIndex[11]),this.$l.a=t.add(t.sal(this.lightIndex[12],24),t.sal(this.lightIndex[13],16),t.sal(this.lightIndex[14],8),this.lightIndex[15]),this.$outputs.value=t.uvec4(this.r,this.g,this.b,this.a))}))},fragment(t){this.$outputs.color=e?t.vec4():t.uvec4(),t.main((function(){this.$outputs.color=this.$inputs.value}))}}),this._bindGroup=t.createBindGroup(this._lightIndexProgram.bindGroupLayouts[0]),this._lightBuffer?.dispose();const i=this._lightIndexProgram.getBindingInfo("lightBuffer").type;this._lightBuffer=t.createStructuredBuffer(i,{usage:"uniform"})}createLightIndexTexture(t){const e=Math.log2(this._tileCountX*this._tileCountY*this._tileCountZ),i=e+1>>>1,s=2<<i-1,r=2<<e-i-1;if(s*r!=this._tileCountX*this._tileCountY*this._tileCountZ)throw new Error("Internal error");this._lightIndexTexture=t.createTexture2D("webgl"===t.type?"rgba32f":"rgba32ui",s,r,{samplerOptions:{mipFilter:"none"}}),this._lightIndexTexture.name="ClusterLightIndex",this._lightIndexFramebuffer?.dispose(),this._lightIndexFramebuffer=t.createFrameBuffer([this._lightIndexTexture],null)}calculateLightIndex(t,e){const i=this.getVisibleLights(e,this._lights),s=Y.instance.device;this._lightIndexTexture||this.createLightIndexTexture(s),this._lightIndexProgram||this.createProgram(s),this._lightIndexVertexLayout||this.createVertexLayout(s,this._lightIndexTexture.width,this._lightIndexTexture.height),this._lightIndexRenderStates||this.createRenderState(s);const r=s.getViewport(),a=s.screenToDevice(r.width),n=s.screenToDevice(r.height),o=this._tileCountZ/Math.log2(t.getFarPlane()/t.getNearPlane()),h=-this._tileCountZ*Math.log2(t.getNearPlane())/Math.log2(t.getFarPlane()/t.getNearPlane());if(this._clusterParam.setXYZW(a,n,o,h),s.pushDeviceStates(),s.setFramebuffer(this._lightIndexFramebuffer),i>0){this._lightBuffer.bufferSubData(0,this._lights),this._sizeParam.setXYZW(a,n,t.getNearPlane(),t.getFarPlane()),this._countParam[0]=this._tileCountX,this._countParam[1]=this._tileCountY,this._countParam[2]=this._tileCountZ,this._countParam[3]=i+1,this._bindGroup.setValue("invProjMatrix",v.invert(t.getProjectionMatrix())),this._bindGroup.setValue("viewMatrix",t.viewMatrix),this._bindGroup.setValue("sizeParam",this._sizeParam),this._bindGroup.setValue("countParam",this._countParam),this._bindGroup.setBuffer("lightBuffer",this._lightBuffer),s.setProgram(this._lightIndexProgram),s.setVertexLayout(this._lightIndexVertexLayout),s.setBindGroup(0,this._bindGroup);const e=s.getRenderStates();s.setRenderStates(this._lightIndexRenderStates),s.draw("point-list",0,this._tileCountX*this._tileCountY*this._tileCountZ),s.setRenderStates(e)}else s.clearFrameBuffer(new T(0,0,0,0),1,0);s.popDeviceStates()}getVisibleLights(t,e){const i=Math.min(t.unshadowedLights.length,Ha);for(let s=1;s<=i;s++){const i=t.unshadowedLights[s-1];e.set(i.positionAndRange,12*s),e.set(i.directionAndCutoff,12*s+4),e.set(i.diffuseAndIntensity,12*s+8)}return i}}class Xo{static _scenePass=new uo;static _depthPass=new co;static _shadowMapPass=new lo;static _enableDepthPass=!1;static _clusters=[];static setClearColor(t){this._scenePass.clearColor=t}static getClusteredLight(){return this._clusters.length>0?this._clusters.pop():new ko}static freeClusteredLight(t){this._clusters.push(t)}static renderScene(t,e,i,s){const r=Y.instance.device,a={scene:t,primaryCamera:e,camera:e,compositor:i?.needDrawPostEffects()?i:null,timestamp:r.frameInfo.frameTimestamp,logger:s,target:null,renderPass:null,renderPassHash:null,applyFog:!1,flip:!1,drawEnvLight:!1,env:null};t.frameUpdate(),e&&!r.isContextLost()&&this._renderScene(a)}static _renderSceneDepth(t,e,i){const s=Y.instance.device;s.pushDeviceStates(),s.setFramebuffer(i),this._depthPass.clearColor="webgl"===s.type?new T(0,0,0,1):new T(1,1,1,1),this._depthPass.render(t,null,e),s.popDeviceStates()}static _renderScene(t){const e=Y.instance.device,i=t.camera.viewport,s=t.camera.scissor,r=e.getFramebuffer(),a=e.getDrawingBufferWidth(),n=e.getDrawingBufferHeight();t.depthFormat="d24s8",t.viewportX=r?i?.[0]??0:e.screenToDevice(i?.[0]??0),t.viewportY=r?i?.[1]??0:e.screenToDevice(i?.[1]??0),t.viewportWidth=r?i?.[2]??r.getWidth():i?e.screenToDevice(i[2]):e.getDrawingBufferWidth(),t.viewportHeight=r?i?.[3]??r.getHeight():i?e.screenToDevice(i[3]):e.getDrawingBufferHeight(),t.defaultViewport=!r&&!i;const o=i&&!e.getDeviceCaps().miscCaps.supportOversizedViewport&&(t.viewportX<0||t.viewportY<0||t.viewportX+t.viewportWidth>a||t.viewportY+t.viewportHeight>n),h=e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"rgba16f":"rgba8unorm";let u=null,l=null;const c=this._scenePass.cullScene(t,t.camera);t.sunLight=c.sunLight,t.clusteredLight=this.getClusteredLight(),t.clusteredLight.calculateLightIndex(t.camera,c),this.renderShadowMaps(t,c.shadowedLights);const d=t.compositor?1:t.primaryCamera.sampleCount;if(this._enableDepthPass||o||t.scene.env.needSceneDepthTexture()||t.compositor?.requireLinearDepth()){const s="webgl"===e.type?"rgba8unorm":"r32f";if(r||i){const e=r?.getDepthAttachment();l=e?.isTexture2D()?To.getFramebufferFixedSizeWithDepth(e,1,s,"2d",!1):To.getFramebufferFixedSize(t.viewportWidth,t.viewportHeight,1,s,t.depthFormat,"2d","2d",!1)}else l=To.getFramebufferVariantSize(a,n,1,s,t.depthFormat,"2d","2d",!1);this._renderSceneDepth(t,c,l),t.linearDepthTexture=l.getColorAttachments()[0],t.depthTexture=l.getDepthAttachment(),u=t.depthTexture===r?.getDepthAttachment()?r:t.defaultViewport?To.getFramebufferVariantSize(t.depthTexture.width,t.depthTexture.height,1,h,t.depthFormat,"2d","2d",!1,d):To.getFramebufferFixedSize(t.depthTexture.width,t.depthTexture.height,1,h,t.depthFormat,"2d","2d",!1,d)}else t.linearDepthTexture=null,t.depthTexture=null,u=i?To.getFramebufferFixedSize(t.viewportWidth,t.viewportHeight,1,h,t.depthFormat,"2d","2d",!1,d):r;if(u&&u!==r?(e.pushDeviceStates(),e.setFramebuffer(u)):(e.setViewport(i),e.setScissor(s)),this._scenePass.clearDepth=1,this._scenePass.clearStencil=0,t.compositor?.begin(t),this._scenePass.render(t,null,c),t.compositor?.end(t),u&&u!==r){const a=new dn;o?a.destRect=[t.viewportX,t.viewportY,t.viewportWidth,t.viewportHeight]:a.viewport=i,a.scissor=s,a.srgbOut=!r;const n=u.getColorAttachments()[0];a.blit(n,r??null,e.createSampler({magFilter:"nearest",minFilter:"nearest",mipFilter:"none"})),e.popDeviceStates()}l&&To.releaseFramebuffer(l),u&&u!==r&&To.releaseFramebuffer(u),zo.releaseTemporalResources(t),this.freeClusteredLight(t.clusteredLight)}static renderShadowMaps(t,e){t.renderPass=this._shadowMapPass,Y.instance.device.pushDeviceStates();for(const i of e)i.shadow.render(t,this._shadowMapPass);Y.instance.device.popDeviceStates()}}class Wo{isIBL(){return!1}isConstant(){return!1}isHemispheric(){return!1}}class Ho extends Wo{static USAGE_IBL_RADIANCE_MAP="usage_ibl_radiance_map";static USAGE_IBL_RADIANCE_MAP_MAX_LOD="usage_ibl_radiance_map_maxlod";static USAGE_IBL_IRRADIANCE_MAP="usage_ibl_irradiance_map";_radianceMap;_irradianceMap;constructor(t,e){super(),this._radianceMap=t||null,this._irradianceMap=e||null}getType(){return"ibl"}get radianceMap(){return this._radianceMap}set radianceMap(t){this._radianceMap=t}get irradianceMap(){return this._irradianceMap}set irradianceMap(t){this._irradianceMap=t}initShaderBindings(t){"fragment"===t.shaderKind&&(t.getGlobalScope().iblRadianceMap=t.texCube().uniform(0).tag(Ho.USAGE_IBL_RADIANCE_MAP),t.getGlobalScope().iblIrradianceMap=t.texCube().uniform(0).tag(Ho.USAGE_IBL_IRRADIANCE_MAP),t.getGlobalScope().radianceMaxLod=t.float("radianceMaxLod").uniform(0).tag(Ho.USAGE_IBL_RADIANCE_MAP_MAX_LOD))}updateBindGroup(t){this._radianceMap&&(t.setValue("radianceMaxLod",this._radianceMap.mipLevelCount-1),t.setTexture("iblRadianceMap",this._radianceMap)),this._irradianceMap&&t.setTexture("iblIrradianceMap",this._irradianceMap)}getRadiance(t,e,i){const s=t.$builder;return Y.instance.device.getDeviceCaps().shaderCaps.supportShaderTextureLod?s.textureSampleLevel(t.iblRadianceMap,e,s.mul(i,t.radianceMaxLod)).rgb:s.textureSample(t.iblRadianceMap,e).rgb}getIrradiance(t,e){return t.$builder.textureSampleLevel(t.iblIrradianceMap,e,0).rgb}hasRadiance(){return!!this._radianceMap}hasIrradiance(){return!!this._irradianceMap}isIBL(){return!0}}class Yo extends Wo{static USAGE_CONSTANT_AMBIENT_LIGHTING="usage_env_constant_ambient";static funcNameGetAmbient="lib_getConstantAmbient";_ambientColor;constructor(t){super(),this._ambientColor=t?new T(t):new T(0,0,0,1)}get ambientColor(){return this._ambientColor}set ambientColor(t){t&&this._ambientColor.set(t)}getType(){return"constant"}initShaderBindings(t){"fragment"===t.shaderKind&&(t.getGlobalScope().ambientLight=t.vec4().uniform(0).tag(Yo.USAGE_CONSTANT_AMBIENT_LIGHTING))}updateBindGroup(t){t.setValue("ambientLight",this._ambientColor)}getRadiance(t,e,i){return null}getIrradiance(t,e){return t.ambientLight.rgb}hasRadiance(){return!1}hasIrradiance(){return!0}isConstant(){return!0}}class qo extends Wo{static USAGE_CONSTANT_AMBIENT_UP="usage_env_ambient_up";static USAGE_CONSTANT_AMBIENT_DOWN="usage_env_ambient_down";static funcNameGetAmbient="lib_getConstantAmbient";_ambientUp;_ambientDown;constructor(t,e){super(),this._ambientUp=new T(t),this._ambientDown=new T(e)}get ambientUp(){return this._ambientUp}set ambientUp(t){t&&this._ambientUp.set(t)}get ambientDown(){return this._ambientDown}set ambientDown(t){t&&this._ambientDown.set(t)}getType(){return"hemisphere"}initShaderBindings(t){"fragment"===t.shaderKind&&(t.getGlobalScope().ambientUp=t.vec4().uniform(0).tag(qo.USAGE_CONSTANT_AMBIENT_UP),t.getGlobalScope().ambientDown=t.vec4().uniform(0).tag(qo.USAGE_CONSTANT_AMBIENT_DOWN))}updateBindGroup(t){t.setValue("ambientUp",this._ambientUp),t.setValue("ambientDown",this._ambientDown)}getRadiance(t,e,i){return null}getIrradiance(t,e){const i=t.$builder,s=i.add(i.mul(e.y,.5),.5);return i.mix(t.ambientDown,t.ambientUp,s).rgb}hasRadiance(){return!1}hasIrradiance(){return!0}isHemispheric(){return!0}}function jo(t,e,i){const s=i.drawEnvLight?i.env.light.envLight:null,r="stdmat_illumPointLight",a="stdmat_illumDirectionalLight",n="stdmat_illumSpotLight",o="stdmat_illumDirectionalShadowLight",h="stdmat_illumPointShadowLight",u="stdmat_illumCascadedShadowLight",l="stdmat_illumUnshadowedLights",c="stdmat_getClusterIndex",d="stdmat_illumOneLight",p="stdmat_computeLighting",_=t.$builder;if(!(t&&t instanceof Aa))throw new Error("forwardComputeLighting() failed: forwardComputeLighting() must be called inside a function");if(i.renderPass.type!==za)throw new Error(`forwardComputeLighting() failed: invalid render pass type: ${i.renderPass.type}`);function m(t,...e){_.func(r,[_.vec4("lightPositionRange"),_.vec4("lightDirectionCutoff"),_.vec3("lightDir"),_.vec3("attenuation")],(function(){this.$l.dist=_.distance(this.lightPositionRange.xyz,qa.getWorldPosition(this).xyz),this.$l.a=_.div(1,_.add(1,_.mul(this.dist,this.dist))),this.$l.falloff=_.mul(this.a,_.clamp(_.sub(1,_.div(this.dist,this.lightPositionRange.w)),0,1)),this.$if(_.greaterThan(this.falloff,0),(function(){t.directBRDF(this,this.lightDir,_.mul(this.attenuation,this.falloff))}))})),_.getGlobalScope()[r](...e)}function f(t,...e){_.func(a,[_.vec4("lightPositionRange"),_.vec4("lightDirectionCutoff"),_.vec3("lightDir"),_.vec3("attenuation")],(function(){t.directBRDF(this,this.lightDir,this.attenuation)})),_.getGlobalScope()[a](...e)}function g(t,...e){_.func(n,[_.vec4("lightPositionRange"),_.vec4("lightDirectionCutoff"),_.vec3("lightDir"),_.vec3("attenuation")],(function(){this.$l.spotFactor=_.dot(this.lightDir,this.lightDirectionCutoff.xyz),this.spotFactor=_.smoothStep(this.lightDirectionCutoff.w,_.mix(this.lightDirectionCutoff.w,1,.5),this.spotFactor),this.$if(_.greaterThan(this.spotFactor,0),(function(){m(t,this.lightPositionRange,this.lightDirectionCutoff,this.lightDir,_.mul(this.attenuation,this.spotFactor))}))})),_.getGlobalScope()[n](...e)}function x(t,e,i,...s){"number"==typeof e?1===e?f(i,...s):e===Wa?m(i,...s):3===e&&g(i,...s):t.$if(_.equal(e,1),(function(){f(i,...s)})).$elseif(_.equal(e,Wa),(function(){m(i,...s)})).$elseif(_.equal(e,3),(function(){g(i,...s)}))}function T(t,e,i,s){_.func(d,[_.vec4("positionRange"),_.vec4("directionCutoff"),_.vec4("diffuseIntensity")],(function(){this.$l.lightcolor=_.mul(this.diffuseIntensity.xyz,this.diffuseIntensity.w),this.$l.lightDir=_.vec3(),this.$l.nl=_.float(),this.$l.NdotL=_.float(),this.$l.lightType=_.int(),this.$if(_.lessThan(this.positionRange.w,0),(function(){this.lightDir=this.directionCutoff.xyz,this.nl=_.dot(this.surfaceData.normal,this.lightDir),this.NdotL=_.clamp(_.neg(this.nl),0,1),this.lightType=1})).$else((function(){this.lightDir=_.sub(qa.getWorldPosition(this).xyz,this.positionRange.xyz),this.$if(_.greaterThan(_.length(this.lightDir),this.positionRange.w),(function(){this.$return()})),this.lightDir=_.normalize(this.lightDir),this.nl=_.dot(this.surfaceData.normal,this.lightDir),this.NdotL=_.clamp(_.neg(this.nl),0,1),this.$if(_.lessThan(this.directionCutoff.w,0),(function(){this.lightType=Wa})).$else((function(){this.lightType=3}))})),this.$if(_.greaterThan(this.NdotL,0),(function(){x(this,this.lightType,t,this.positionRange,this.directionCutoff,this.lightDir,_.mul(this.lightcolor,this.NdotL))}))})),_.getGlobalScope()[d](e,i,s)}function b(t){_.func(l,[],(function(){const e=qa.getCountParams(this);var i;this.$l.cluster=(i=this.$builtins.fragCoord.xyz,_.func(c,[_.vec3("fragCoord")],(function(){const t=qa.getClusterParams(this),e=qa.getCountParams(this);this.$l.zTile=_.int(_.max(_.add(_.mul(_.log2(Za(this,this.fragCoord.z)),t.z),t.w),0)),this.$l.f=_.vec2(this.fragCoord.x,_.sub(t.y,_.add(this.fragCoord.y,1))),this.$l.xyTile=_.ivec2(_.div(this.f,_.div(t.xy,_.vec2(e.xy)))),this.$return(_.ivec3(this.xyTile,this.zTile))})),_.getGlobalScope()[c](i)),this.$l.clusterIndex=_.add(this.cluster.x,_.mul(this.cluster.y,e.x),_.mul(this.cluster.z,e.x,e.y)),this.$l.texSize=this.global.light.lightIndexTexSize,"webgl"===_.getDevice().type?(this.$l.texCoordX=_.div(_.add(_.mod(_.float(this.clusterIndex),_.float(this.texSize.x)),.5),_.float(this.texSize.x)),this.$l.texCoordY=_.div(_.add(_.float(_.div(this.clusterIndex,this.texSize.x)),.5),_.float(this.texSize.y)),this.$l.samp=_.textureSample(qa.getClusteredLightIndexTexture(this),_.vec2(this.texCoordX,this.texCoordY))):(this.$l.texCoordX=_.mod(this.clusterIndex,this.texSize.x),this.$l.texCoordY=_.div(this.clusterIndex,this.texSize.x),this.$l.samp=_.textureLoad(qa.getClusteredLightIndexTexture(this),_.ivec2(this.texCoordX,this.texCoordY),0)),"webgl"===_.getDevice().type?this.$for(_.int("i"),0,4,(function(){this.$l.k=this.samp.at(this.i),this.$l.lights=_.int[2](),this.$l.lights[0]=_.int(_.mod(this.k,256)),this.$l.lights[1]=_.int(_.div(this.k,256)),this.$for(_.int("k"),0,2,(function(){this.$l.li=this.lights.at(this.k),this.$if(_.greaterThan(this.li,0),(function(){this.$for(_.int("j"),1,256,(function(){this.$if(_.equal(this.j,this.li),(function(){this.$l.positionRange=qa.getLightPositionAndRange(this,this.j),this.$l.directionCutoff=qa.getLightDirectionAndCutoff(this,this.j),this.$l.diffuseIntensity=qa.getLightColorAndIntensity(this,this.j),T(t,this.positionRange,this.directionCutoff,this.diffuseIntensity),this.$break()}))}))}))}))})):this.$for(_.uint("i"),0,4,(function(){this.$for(_.uint("k"),0,4,(function(){this.$l.c=_.compAnd(_.sar(this.samp.at(this.i),_.mul(this.k,8)),255),this.$if(_.greaterThan(this.c,0),(function(){this.$l.positionRange=qa.getLightPositionAndRange(this,this.c),this.$l.directionCutoff=qa.getLightDirectionAndCutoff(this,this.c),this.$l.diffuseIntensity=qa.getLightColorAndIntensity(this,this.c),T(t,this.positionRange,this.directionCutoff,this.diffuseIntensity)}))}))}))})),_.getGlobalScope()[l]()}return _.func(p,[],(function(){const r=qa.getWorldPosition(this),a=qa.getWorldNormal(this),n=qa.getWorldTangent(this),l=qa.getWorldBinormal(this);if(e.getSurfaceData(this,s,r,a,n,l),qa.discardIfClipped(this),e.supportLighting())if(s&&e.envBRDF(s,this),i.currentShadowLight){const s=i.shadowMapInfo.get(i.currentShadowLight);s.numShadowCascades>1?function(e){_.func(u,[],(function(){this.$l.shadowCascades=this.global.light.shadowCascades,this.$l.positionRange=this.global.light.positionAndRange,this.$l.directionCutoff=this.global.light.directionAndCutoff,this.$l.diffuseIntensity=this.global.light.diffuseAndIntensity,this.$l.lightcolor=_.mul(this.diffuseIntensity.xyz,this.diffuseIntensity.w),this.$l.lightDir=_.vec3(),this.lightDir=this.directionCutoff.xyz,this.$l.nl=_.dot(this.surfaceData.normal,this.lightDir),this.$l.NdotL=_.clamp(_.neg(this.nl),0,1),this.$l.shadowBound=_.vec4(0,0,1,1),this.$l.linearDepth=Za(this,this.$builtins.fragCoord.z),this.$l.splitDistances=qa.getCascadeDistances(this),this.$l.comparison=_.vec4(_.greaterThan(_.vec4(this.linearDepth),this.splitDistances)),this.$l.cascadeFlags=_.vec4(_.float(_.greaterThan(this.shadowCascades,0)),_.float(_.greaterThan(this.shadowCascades,1)),_.float(_.greaterThan(this.shadowCascades,2)),_.float(_.greaterThan(this.shadowCascades,3))),this.$l.split=_.int(_.dot(this.comparison,this.cascadeFlags)),this.$l.shadowVertex=_.vec4(),"webgl"===Y.instance.device.type?this.$for(_.int("cascade"),0,4,(function(){this.$if(_.equal(this.cascade,this.split),(function(){this.shadowVertex=qa.calculateShadowSpaceVertex(this,this.cascade),this.$break()}))})):this.shadowVertex=qa.calculateShadowSpaceVertex(this,this.split);const s=i.shadowMapInfo.get(i.currentShadowLight);this.$l.shadow=s.impl.computeShadowCSM(s,this,this.shadowVertex,this.NdotL,this.split),this.$l.shadowDistance=qa.getShadowCameraParams(t).w,this.shadow=_.mix(this.shadow,1,_.smoothStep(_.mul(this.shadowDistance,.8),this.shadowDistance,_.distance(qa.getCameraPosition(this),qa.getWorldPosition(this).xyz))),this.$if(_.greaterThan(this.NdotL,0),(function(){this.$l.attenuation=_.mul(_.mul(this.lightcolor,this.NdotL),_.vec3(this.shadow)),x(this,1,e,this.positionRange,this.directionCutoff,this.lightDir,this.attenuation)}))})),_.getGlobalScope()[u]()}(e):s.shadowMap.isTextureCube()?function(e){_.func(h,[],(function(){const s=qa.getWorldPosition(this);this.$l.positionRange=t.global.light.positionAndRange,this.$l.directionCutoff=t.global.light.directionAndCutoff,this.$l.diffuseIntensity=t.global.light.diffuseAndIntensity,this.$l.lightcolor=_.mul(this.diffuseIntensity.xyz,this.diffuseIntensity.w),this.$l.lightDir=_.sub(s.xyz,this.positionRange.xyz),this.$if(_.greaterThan(_.length(this.lightDir),this.positionRange.w),(function(){this.$return()})),this.lightDir=_.normalize(this.lightDir),this.$l.nl=_.dot(this.surfaceData.normal,this.lightDir),this.$l.NdotL=_.clamp(_.neg(this.nl),0,1),this.shadowBound=_.vec4(0,0,1,1),this.shadowVertex=qa.calculateShadowSpaceVertex(this);const r=i.shadowMapInfo.get(i.currentShadowLight);this.$l.shadow=r.impl.computeShadow(r,this,this.shadowVertex,this.NdotL),this.$l.shadowDistance=qa.getShadowCameraParams(t).w,this.shadow=_.mix(this.shadow,1,_.smoothStep(_.mul(this.shadowDistance,.8),this.shadowDistance,_.distance(qa.getCameraPosition(this),qa.getWorldPosition(this).xyz))),this.$if(_.greaterThan(this.NdotL,0),(function(){this.$l.attenuation=_.mul(_.mul(this.lightcolor,this.NdotL),_.vec3(this.shadow)),x(this,Wa,e,this.positionRange,this.directionCutoff,this.lightDir,this.attenuation)}))})),_.getGlobalScope()[h]()}(e):function(e,s){_.func(o,[],(function(){this.$l.positionRange=t.global.light.positionAndRange,this.$l.directionCutoff=t.global.light.directionAndCutoff,this.$l.diffuseIntensity=t.global.light.diffuseAndIntensity,this.$l.lightcolor=_.mul(this.diffuseIntensity.xyz,this.diffuseIntensity.w),this.$l.lightDir=_.vec3(),this.$l.nl=_.float(),this.$l.NdotL=_.float(),1===e?(this.lightDir=this.directionCutoff.xyz,this.nl=_.dot(this.surfaceData.normal,this.lightDir),this.NdotL=_.clamp(_.neg(this.nl),0,1)):(this.lightDir=_.sub(qa.getWorldPosition(this).xyz,this.positionRange.xyz),this.lightDir=_.normalize(this.lightDir),this.nl=_.dot(this.surfaceData.normal,this.lightDir),this.NdotL=_.clamp(_.neg(this.nl),0,1)),this.shadowVertex=qa.calculateShadowSpaceVertex(this);const r=i.shadowMapInfo.get(i.currentShadowLight);this.$l.shadow=r.impl.computeShadow(r,this,this.shadowVertex,this.NdotL),this.$l.shadowDistance=qa.getShadowCameraParams(t).w,this.shadow=_.mix(this.shadow,1,_.smoothStep(_.mul(this.shadowDistance,.8),this.shadowDistance,_.distance(qa.getCameraPosition(this),qa.getWorldPosition(this).xyz))),1!==e&&this.$if(_.greaterThan(_.length(this.lightDir),this.positionRange.w),(function(){this.$return()})),this.$if(_.greaterThan(this.NdotL,0),(function(){this.$l.attenuation=_.mul(_.mul(this.lightcolor,this.NdotL),_.vec3(this.shadow)),x(this,e,s,this.positionRange,this.directionCutoff,this.lightDir,this.attenuation)}))})),_.getGlobalScope()[o]()}(s.lightType,e)}else b(e);this.$return(e.finalComposite(this))})),_.getGlobalScope()[p]()}const Zo={FRAGMENT_SHADER(t,e){qa.prepareFragmentShader(t.$builder,e)},VERTEX_SHADER(t,e){qa.prepareVertexShader(t.$builder,e)},FTRANSFORM(t){qa.ftransform(t)},DEFINE_VERTEX_COLOR:t=>t.tag(qa.USAGE_VERTEX_COLOR),DEFINE_WORLD_NORMAL:t=>t.tag(qa.USAGE_WORLD_NORMAL),DEFINE_WORLD_TANGENT:t=>t.tag(qa.USAGE_WORLD_TANGENT),DEFINE_WORLD_BINORMAL:t=>t.tag(qa.USAGE_WORLD_BINORMAL),DEFINE_WORLD_POSITION:t=>t.tag(qa.USAGE_WORLD_POSITION),FRAGMENT_OUTPUT:(t,e)=>en(t,e),GET_WORLD_MATRIX:t=>qa.getWorldMatrix(t),GET_VIEW_PROJ_MATRIX:t=>qa.getViewProjectionMatrix(t),GET_ENVLIGHT_STRENGTH:t=>qa.getEnvLightStrength(t),GET_CAMERA_POSITION:t=>qa.getCameraPosition(t),GET_CAMERA_PARAMS:t=>qa.getCameraParams(t),GET_WORLD_POSITION:t=>qa.getWorldPosition(t),GET_WORLD_NORMAL:t=>qa.getWorldNormal(t),GET_WORLD_TANGENT:t=>qa.getWorldTangent(t),GET_WORLD_BINORMAL:t=>qa.getWorldBinormal(t),SET_CLIP_SPACE_POSITION(t,e){qa.setClipSpacePosition(t,e)},DISCARD_IF_CLIPPED(t){qa.discardIfClipped(t)},APPLY_FOG(t,e,i){if(i.applyFog){const s=t.$builder;if(i.env.sky.drawScatteredFog(i)){const i="applyAerialPerspective";s.func(i,[s.vec4("color").inout()],(function(){this.$l.viewDir=s.sub(qa.getWorldPosition(this).xyz,qa.getCameraPosition(this)),this.viewDir.y=s.max(this.viewDir.y,0),this.$l.distance=s.mul(s.length(this.viewDir),qa.getWorldUnit(this)),this.$l.sliceDist=s.div(s.mul(qa.getCameraParams(this).y,qa.getWorldUnit(this)),Ya.aerialPerspectiveSliceZ),this.$l.slice0=s.floor(s.div(this.distance,this.sliceDist)),this.$l.slice1=s.add(this.slice0,1),this.$l.factor=s.sub(s.div(this.distance,this.sliceDist),this.slice0),this.$l.viewNormal=s.normalize(this.viewDir),this.$l.zenithAngle=s.asin(this.viewNormal.y),this.$l.horizonAngle=s.atan2(this.viewNormal.z,this.viewNormal.x),this.$l.u0=s.div(s.add(this.slice0,s.div(this.horizonAngle,2*Math.PI)),Ya.aerialPerspectiveSliceZ),this.$l.u1=s.add(this.u0,1/Ya.aerialPerspectiveSliceZ),this.$l.v=s.div(this.zenithAngle,Math.PI/2),this.$l.t0=s.textureSampleLevel(qa.getAerialPerspectiveLUT(this),s.vec2(this.u0,this.v),0),this.$l.t1=s.textureSampleLevel(qa.getAerialPerspectiveLUT(this),s.vec2(this.u1,this.v),0),this.$l.t=s.mix(this.t0,this.t1,this.factor),this.color=s.vec4(s.add(s.mul(this.color.rgb,this.factor),this.t.rgb),this.color.a)})),t[i](e)}else{const i="applyFog";s.func(i,[s.vec4("color").inout()],(function(){this.$l.viewDir=s.sub(qa.getWorldPosition(this).xyz,qa.getCameraPosition(this)),this.$l.fogFactor=qa.computeFogFactor(this,this.viewDir,qa.getFogType(this),qa.getFogParams(this)),this.color=s.vec4(s.mix(this.color.rgb,qa.getFogColor(this).rgb,s.mul(this.fogFactor,this.color.a,this.color.a)),this.color.a)})),t[i](e)}}}};class Ko extends Rn{_vertexColor;_hasNormal;_useTangent;_alphaBlend;_alphaCutoff;_opacity;_lightModel;constructor(){super(),this._vertexColor=!1,this._useTangent=!1,this._hasNormal=!0,this._alphaBlend=!1,this._alphaCutoff=0,this._opacity=1,this._lightModel=null}get lightModel(){return this._lightModel}set lightModel(t){this._lightModel=t||null}get vertexColor(){return this._vertexColor}set vertexColor(t){this._vertexColor!==!!t&&(this._vertexColor=!!t,this.optionChanged(!0))}get vertexTangent(){return this._useTangent}set vertexTangent(t){this._useTangent!==!!t&&(this._useTangent=!!t,this.optionChanged(!0))}get vertexNormal(){return this._hasNormal}set vertexNormal(t){this._hasNormal!==!!t&&(this._hasNormal=!!t,this.optionChanged(!0))}get alphaBlend(){return this._alphaBlend}set alphaBlend(t){if(this._alphaBlend!==!!t){this._alphaBlend=!!t;const e=this._alphaBlend||this._opacity<1;e&&!this.stateSet.blendingState?.enabled?this.stateSet.useBlendingState().enable(!0).setBlendFunc("one","inv-src-alpha"):this.stateSet.blendingState?.enabled&&!e&&this.stateSet.defaultBlendingState(),this.optionChanged(!0)}}get alphaCutoff(){return this._alphaCutoff}set alphaCutoff(t){this._alphaCutoff!==t&&(this.optionChanged(0===this._alphaCutoff||0===t),this._alphaCutoff=t)}get opacity(){return this._opacity}set opacity(t){if(t=t<0?0:t>1?1:t,this._opacity!==t){this.optionChanged(1===this._opacity||1===t),this._opacity=t;const e=this._alphaBlend||this._opacity<1;e&&!this.stateSet.blendingState?.enabled?this.stateSet.useBlendingState().enable(!0).setBlendFunc("one","inv-src-alpha"):this.stateSet.blendingState?.enabled&&!e&&this.stateSet.defaultBlendingState()}}isTransparent(){return this._alphaBlend||this._opacity<1}supportLighting(){return!!this._lightModel&&this._lightModel.supportLighting()}applyUniforms(t,e,i){super.applyUniforms(t,e,i),(e.renderPass.type===za||this._alphaCutoff>0)&&this._lightModel?.applyUniformsIfOutdated(t,e)}getTexCoordTransform(t){return this._lightModel?.getTexCoordTransform(t)??null}setTexCoordTransform(t,e){this._lightModel?.setTexCoordTransform(t,e)}_applyUniforms(t,e){this._alphaCutoff>0&&t.setValue("alphaCutoff",this._alphaCutoff),(this._alphaBlend||this._opacity<1)&&t.setValue("opacity",this._opacity)}getHash(t){return(void 0===this._hash[t]||this._lightModel&&!this._lightModel.peekHash())&&(this._hash[t]=this.createHash(t)),this._hash[t]}_createHash(t){return t===za||this._alphaCutoff>0?`|${Number(!!this._vertexColor)}|${Number(!!this._useTangent)}|${Number(!!this._hasNormal)}|${Number(this._opacity<1||this._alphaBlend)}|${Number(this._alphaCutoff>0)}|${this._lightModel?.getHash()||""}`:""}_createProgram(t,e){const i=this,s=i._hasNormal&&e.renderPass.type===za&&i._lightModel?.isNormalUsed();if(e.renderPass.type===ka){const i=e.shadowMapInfo.get(e.renderPass.light);t.emulateDepthClamp=!!i.depthClampEnabled}const r=e.renderPass.type===za||i._alphaCutoff>0;return t.buildRenderProgram({label:e.target?.getName()??"",vertex(){if(Zo.VERTEX_SHADER(this,e),this.$inputs.pos=t.vec3().attrib("position"),e.target.getBoneMatrices()&&(this.$inputs.blendIndices=t.vec4().attrib("blendIndices"),this.$inputs.blendWeights=t.vec4().attrib("blendWeights")),r){s&&(this.$inputs.normal=t.vec3().attrib("normal")),i._vertexColor&&(this.$inputs.vertexColor=t.vec4().attrib("diffuse"));for(let e=0;e<Y.instance.device.getDeviceCaps().miscCaps.maxTexCoordIndex;e++)i._lightModel?.isTexCoordSrcLocationUsed(e)&&(this.$inputs[`texcoord${e}`]=t.vec2().attrib(`texCoord${e}`));s&&i._useTangent&&(this.$inputs.tangent=t.vec4().attrib("tangent")),i._lightModel?.setupUniforms(this,e)}t.main((function(){if(Zo.FTRANSFORM(this),e.renderPass.type===za||i._alphaCutoff>0){i._vertexColor&&(this.$outputs.outVertexColor=Zo.DEFINE_VERTEX_COLOR(this.$inputs.vertexColor));for(let t=0;t<Y.instance.device.getDeviceCaps().miscCaps.maxTexCoordIndex;t++)i._lightModel?.isTexCoordIndexUsed(t)&&(this.$outputs[`texcoord${t}`]=i._lightModel.calculateTexCoord(this,t))}}))},fragment(){if(Zo.FRAGMENT_SHADER(this,e),i._alphaCutoff>0&&(this.alphaCutoff=t.float().uniform(2)),r&&i._lightModel?.setupUniforms(this,e),e.renderPass.type===za){const s=i._alphaBlend||i._opacity<1;s&&(this.opacity=t.float().uniform(2)),this.$outputs.outColor=t.vec4(),t.main((function(){this.$l.litColor=i._lightModel?jo(this,i._lightModel,e):t.vec4(1),Zo.DISCARD_IF_CLIPPED(this),s||0!==i._alphaCutoff?s&&(this.litColor.a=t.mul(this.litColor.a,this.opacity)):this.litColor.a=1,i._alphaCutoff>0&&this.$if(t.lessThan(this.litColor.a,this.alphaCutoff),(function(){t.discard()})),this.litColor=t.vec4(t.mul(this.litColor.rgb,this.litColor.a),this.litColor.a),Zo.APPLY_FOG(this,this.litColor,e),this.$outputs.outColor=Zo.FRAGMENT_OUTPUT(this,this.litColor)}))}else if(e.renderPass.type===Xa)this.$outputs.outColor=t.vec4(),t.main((function(){Zo.DISCARD_IF_CLIPPED(this),i._alphaCutoff>0&&(this.$l.albedoColor=i._lightModel.calculateAlbedo(this),this.$if(t.lessThan(this.albedoColor.a,this.alphaCutoff),(function(){t.discard()}))),this.$l.depth=Ka(this,this.$builtins.fragCoord.z),"webgl"===Y.instance.device.type?this.$outputs.outColor=Ja(this,this.depth):this.$outputs.outColor=t.vec4(this.depth,0,0,1)}));else{if(e.renderPass.type!==ka)throw new Error(`unknown render pass type: ${e.renderPass.type}`);this.$outputs.outColor=t.vec4(),t.main((function(){Zo.DISCARD_IF_CLIPPED(this),i._alphaCutoff>0&&(this.$l.albedoColor=i._lightModel.calculateAlbedo(this),this.$if(t.lessThan(this.albedoColor.a,this.alphaCutoff),(function(){t.discard()})));const s=e.shadowMapInfo.get(e.renderPass.light);this.$outputs.outColor=s.impl.computeShadowMapDepth(s,this)}))}}})}}class Qo extends Ko{constructor(){super(),this.lightModel=new no}get GGXLUT(){return no.getGGXLUT()}}let Jo=null,th=null;class eh{_octree;constructor(t){this._octree=t}visit(t){t instanceof En&&this._octree.placeNode(t)}}class ih{_ray;_rayLocal;_intersected;_intersectedDist;constructor(t,e){this._ray=t,this._rayLocal=new G,this._intersected=null,this._intersectedDist=e}get intersected(){return this._intersected}get intersectedDist(){return this._intersectedDist}get intersectedPoint(){return g.add(this._ray.origin,g.scale(this._ray.direction,this._intersectedDist))}visit(t){return t instanceof vn?this.visitOctreeNode(t):t.isMesh()?this.visitMesh(t):!!t.isTerrain()&&this.visitTerrain(t)}visitTerrain(t){if(!t.hidden&&t.pickable){this._ray.transform(t.invWorldMatrix,this._rayLocal);const e=t.rayIntersect(this._rayLocal);if(null!==e&&e<this._intersectedDist)return this._intersectedDist=e,this._intersected=t,!0}return!1}visitMesh(t){if(!t.hidden&&t.pickable){this._ray.transform(t.invWorldMatrix,this._rayLocal);const e=t.primitive.raycast(this._rayLocal);if(null!==e&&e<this._intersectedDist)return this._intersectedDist=e,this._intersected=t.getPickTarget()??t,!0}return!1}visitOctreeNode(t){if(0===t.getLevel()||null!==this._ray.bboxIntersectionTest(t.getBoxLoosed())){const e=t.getNodes();for(let t=0;t<e.length;t++)this.visit(e[t]);return!0}return!1}}class sh{_envLight;_ambientColor;_ambientDown;_ambientUp;_radianceMap;_irradianceMap;_strength;constructor(){this._envLight=new Ho,this._ambientColor=new T(.2,.2,.2,1),this._ambientDown=new T(.2,.2,.2,1),this._ambientUp=new T(.3,.5,.8,1),this._radianceMap=null,this._irradianceMap=null,this._strength=1}getHash(t){return t.drawEnvLight?`${this.type}:${this._envLight.hasRadiance()?"1":"0"}:${this._envLight.hasIrradiance()?"1":"0"}`:"none"}get envLight(){return this._envLight}get strength(){return this._strength}set strength(t){this._strength=t}get ambientColor(){return this._ambientColor.clone()}set ambientColor(t){this._ambientColor.set(t),"constant"===this.type&&(this._envLight.ambientColor=this._ambientColor)}get ambientUp(){return this._ambientUp.clone()}set ambientUp(t){this._ambientUp.set(t),"hemisphere"===this.type&&(this._envLight.ambientUp=this._ambientUp)}get ambientDown(){return this._ambientDown.clone()}set ambientDown(t){this._ambientDown.set(t),"hemisphere"===this.type&&(this._envLight.ambientDown=this._ambientDown)}get radianceMap(){return this._radianceMap}set radianceMap(t){this._radianceMap=t??null,"ibl"===this.type&&(this._envLight.radianceMap=this._radianceMap)}get irradianceMap(){return this._irradianceMap}set irradianceMap(t){this._irradianceMap=t??null,"ibl"===this.type&&(this._envLight.irradianceMap=this._irradianceMap)}get type(){return this._envLight?.getType()??"none"}set type(t){switch(t){case"none":this._envLight=null;break;case"ibl":this._envLight?.getType()!==t&&(this._envLight=new Ho(this._radianceMap,this._irradianceMap));break;case"constant":this._envLight?.getType()!==t&&(this._envLight=new Yo(this._ambientColor));break;case"hemisphere":this._envLight?.getType()!==t&&(this._envLight=new qo(this._ambientUp,this._ambientDown))}}}class rh{_sky;_light;constructor(){this._sky=new xo,this._light=new sh}get sky(){return this._sky}get light(){return this._light}getHash(t){return`${this.light?.getHash(t)}:${this._sky?.getHash(t)}`}needSceneDepthTexture(){return"none"!==this._sky.fogType}}class ah{static NAME="sceneupdate";scene;type=ah.NAME;constructor(t){this.scene=t}}class nh extends(e(Object)()){static _nextId=0;_rootNode;_octree;_nodePlaceList;_env;_updateEvent;_updateFrame;_worldUnit;_animationSet;_id;constructor(){super(),this._id=++nh._nextId,this._octree=new wn(this,2048,64),this._nodePlaceList=new Set,this._env=new rh,this._updateEvent=new ah(this),this._updateFrame=-1,this._worldUnit=1,this._animationSet=[],this._rootNode=new bn(this)}get animationSet(){return this._animationSet}get id(){return this._id}get worldUnit(){return this._worldUnit}set worldUnit(t){this._worldUnit=t}get rootNode(){return this._rootNode}get octree(){return this.updateNodePlacement(this._octree,this._nodePlaceList),this._octree}get boundingBox(){return this.updateNodePlacement(this._octree,this._nodePlaceList),this._octree.getRootNode().getBox()||this._octree.getRootNode().getBoxLoosed()}get env(){return this._env}dispose(){this._rootNode=null}raycast(t,e,i){const s=t.viewport?t.viewport[2]:Y.instance.device.getViewport().width,r=t.viewport?t.viewport[3]:Y.instance.device.getViewport().height,a=this.constructRay(t,s,r,e,i),n=new ih(a,t.getFarPlane());return this.octree.getRootNode().traverse(n),n.intersected?{node:n.intersected,dist:n.intersectedDist,point:n.intersectedPoint}:null}constructRay(t,e,i,s,r,a){const n=new T(2*s/e-1,1-2*r/i,1,1),o=t.invViewProjectionMatrix.transform(n);o.scaleBy(1/o.w);let h=t.getWorldPosition(),u=g.sub(o.xyz(),h).inplaceNormalize();return a&&(h=a.transformPointAffine(h),u=a.transformVectorAffine(u)),new G(h,u)}invalidateNodePlacement(t){this._nodePlaceList.add(t)}_xformChanged(t){this._nodePlaceList.add(t)}frameUpdate(){const t=Y.instance.device.frameInfo;if(t.frameCounter!==this._updateFrame){this._updateFrame=t.frameCounter,Rn.getGCOptions().disabled||Rn.garbageCollect(t.frameTimestamp);for(const t of this._animationSet)t.update();"ibl"===this.env.light.type&&(this.env.light.radianceMap?this.env.light.radianceMap===this.env.sky.radianceMap&&"none"===this.env.sky.skyType&&(this.env.light.radianceMap=null):"none"!==this.env.sky.skyType&&(this.env.light.radianceMap=this.env.sky.radianceMap),this.env.light.irradianceMap?this.env.light.irradianceMap===this.env.sky.irradianceMap&&"none"===this.env.sky.skyType&&(this.env.light.irradianceMap=null):"none"!==this.env.sky.skyType&&(this.env.light.irradianceMap=this.env.sky.irradianceMap)),this.dispatchEvent(this._updateEvent),this.updateNodePlacement(this._octree,this._nodePlaceList)}}updateNodePlacement(t,e){function i(s,r){s.isGraphNode()&&(r&&!s.hidden?t.placeNode(s):t.removeNode(s));for(const t of s.children)t.isGraphNode()&&i(t,r);e.delete(s)}if(e.size>0){for(;e.size>0;){const s=e.keys().next().value;t?i(s,s.attached):e.delete(s)}if(t){const e=t.getRootNode().getBox();if(e){const i=Math.max(Math.abs(e.minPoint.x),Math.abs(e.minPoint.y),Math.abs(e.minPoint.z),Math.abs(e.maxPoint.x),Math.abs(e.maxPoint.y),Math.abs(e.maxPoint.z)),r=(s=2*i,s--,s|=s>>1,s|=s>>2,s|=s>>4,s|=s>>8,s|=s>>16,++s);if(r>t.getRootSize()){t.initialize(r,t.getLeafSize());const e=new eh(t);this._rootNode.traverse(e)}}}}var s}}class oh extends En{_type;_intensity;_positionRange;_directionCutoff;_diffuseIntensity;constructor(t,e){super(t),this._intensity=1,this._type=e,this._positionRange=null,this._directionCutoff=null,this._diffuseIntensity=null}get lightType(){return this._type}get intensity(){return this._intensity}set intensity(t){this.setIntensity(t)}get positionAndRange(){return this._positionRange||this.computeUniforms(),this._positionRange}get directionAndCutoff(){return this._directionCutoff||this.computeUniforms(),this._directionCutoff}get diffuseAndIntensity(){return this._diffuseIntensity||this.computeUniforms(),this._diffuseIntensity}get viewMatrix(){return this.invWorldMatrix}get viewProjMatrix(){return null}setIntensity(t){return this._intensity!==t&&(this._intensity=t,this.invalidateUniforms()),this}invalidateUniforms(){this._positionRange=null,this._directionCutoff=null,this._diffuseIntensity=null}isLight(){return!0}isPunctualLight(){return!1}isDirectionLight(){return!1}isPointLight(){return!1}isSpotLight(){return!1}}class hh extends oh{_color;_castShadow;_lightViewProjectionMatrix;_shadowMapper;constructor(t,e){super(t,e),this._color=T.one(),this._castShadow=!1,this._lightViewProjectionMatrix=v.identity(),this._shadowMapper=new zo(this)}get color(){return this._color}set color(t){this.setColor(t)}setColor(t){return this._color.set(t),this.invalidateUniforms(),this}get castShadow(){return this._castShadow}set castShadow(t){this.setCastShadow(t)}setCastShadow(t){return this._castShadow=t,this}get viewProjMatrix(){return this._lightViewProjectionMatrix}set viewProjMatrix(t){this.setLightViewProjectionMatrix(t)}get shadow(){return this._shadowMapper}setLightViewProjectionMatrix(t){return this._lightViewProjectionMatrix.set(t),this}isPunctualLight(){return!0}_onTransformChanged(t){super._onTransformChanged(t),this.invalidateUniforms()}}class uh extends hh{static _currentSunLight=null;_sunLight;constructor(t){super(t,1),uh._currentSunLight?this._sunLight=!1:(uh._currentSunLight=this,this._sunLight=!0)}get sunLight(){return this._sunLight}set sunLight(t){!!t!==this._sunLight&&(this._sunLight=!!t,this._sunLight?(uh._currentSunLight._sunLight=!1,uh._currentSunLight=this):uh._currentSunLight=null),this._sunLight=!!t}isDirectionLight(){return!0}computeBoundingVolume(t){return null}computeUniforms(){const t=this.worldMatrix.getRow(3),e=this.worldMatrix.getRow(2).scaleBy(-1);this._positionRange=new T(t.x,t.y,t.z,-1),this._directionCutoff=new T(e.x,e.y,e.z,0),this._diffuseIntensity=new T(this.color.x,this.color.y,this.color.z,this.intensity)}}class lh extends En{_primitive;_material;_castShadow;_bboxChangeCallback;_animatedBoundingBox;_boneMatrices;_invBindMatrix;_instanceHash;_batchable;_boundingBoxNode;_instanceColor;constructor(t,e,i){super(t),this._primitive=null,this._material=null,this._castShadow=!0,this._animatedBoundingBox=null,this._boneMatrices=null,this._invBindMatrix=null,this._instanceHash=null,this._boundingBoxNode=null,this._instanceColor=T.zero(),this._batchable="webgl"!==Y.instance.deviceType,this._bboxChangeCallback=this._onBoundingboxChange.bind(this),this.primitive=e??null,this.material=i??lh._getDefaultMaterial()}getName(){return this._name}getInstanceId(t){return`${this._instanceHash}:${this.worldMatrixDet>=0}`}getInstanceColor(){return this._instanceColor}getPickTarget(){return this}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t}get primitive(){return this._primitive}set primitive(t){t!==this._primitive&&(this._primitive&&this._primitive.removeBoundingboxChangeCallback(this._bboxChangeCallback),this._primitive=t||null,this._primitive&&this._primitive.addBoundingboxChangeCallback(this._bboxChangeCallback),this._instanceHash=this._primitive&&this._material?`${this.constructor.name}:${this._scene.id}:${this._primitive.id}:${this._material.id}`:null,this.invalidateBoundingVolume())}get material(){return this._material}set material(t){this._material!==t&&(this._material=t,this._instanceHash=this._primitive&&this._material?`${this.constructor.name}:${this._scene.id}:${this._primitive.id}:${this._material.id}`:null)}get drawBoundingBox(){return!!this._boundingBoxNode}set drawBoundingBox(t){!!this._boundingBoxNode!=!!t&&(t?(lh._defaultBoxFrame||(lh._defaultBoxFrame=new fn({size:1})),this._boundingBoxNode=new lh(this._scene,lh._defaultBoxFrame).reparent(this),this._boundingBoxNode.scale.set(this.getBoundingVolume().toAABB().size),this._boundingBoxNode.position.set(this.getBoundingVolume().toAABB().minPoint)):(this._boundingBoxNode.remove(),this._boundingBoxNode=null))}isMesh(){return!0}setAnimatedBoundingBox(t){this._animatedBoundingBox=t,this.invalidateBoundingVolume()}setBoneMatrices(t){this._boneMatrices=t}setInvBindMatrix(t){this._invBindMatrix=t}isBatchable(){return this._batchable&&!this._boneMatrices}dispose(){this._primitive=null,this._material=null,super.dispose()}isTransparency(){return!!this.material?.isTransparent()}isUnlit(){return!this.material?.supportLighting()}draw(t){this.material.draw(this.primitive,t)}getBoneMatrices(){return this._boneMatrices}getInvBindMatrix(){return this._invBindMatrix}getXForm(){return this}computeBoundingVolume(t){let e;if(this._animatedBoundingBox)e=this._animatedBoundingBox;else{const t=this.primitive;e=t?t.getBoundingVolume():null}return e&&this._boundingBoxNode&&(this._boundingBoxNode.scale.set(e.toAABB().size),this._boundingBoxNode.position.set(e.toAABB().minPoint)),e}_onBoundingboxChange(){this.invalidateBoundingVolume()}static _defaultMaterial=null;static _defaultBoxFrame=null;static _getDefaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=new Ko,this._defaultMaterial.lightModel=new ro),this._defaultMaterial}}class ch extends mo{_near;_far;_fovY;_aspect;_window;constructor(t,e,i,s,r){super(t),this._fovY=e,this._aspect=i,this._near=s,this._far=r,this._window=null,this._invalidate(!0)}get window(){return this._window}set window(t){this._window=t??null,this._invalidate(!0)}get near(){return this._near}set near(t){t!==this._near&&(this._near=t,this._invalidate(!0))}get far(){return this._far}set far(t){t!==this._far&&(this._far=t,this._invalidate(!0))}get fovY(){return this._fovY}set fovY(t){t!==this._fovY&&(this._fovY=t,this._invalidate(!0))}get aspect(){return this._aspect}set aspect(t){t!==this._aspect&&(this._aspect=t,this._invalidate(!0))}setPerspective(t,e,i,s){return this._aspect=e,this._fovY=t,this._near=i,this._far=s,this._invalidate(!0),this}setOrtho(t,e,i,s,r,a){throw new Error("setOrtho() not allowed on PerspectiveCamera")}setProjectionMatrix(t){if(!t||t===this._projMatrix||!t.isPerspective())throw new Error("PerspectiveCamera.setProjectionMatrix(): param is not a perspective projection matrix");t.getFov(),this._aspect=t.getAspect(),this._fovY=t.getFov(),this._near=t.getNearPlane(),this._far=t.getFarPlane(),this._invalidate(!0)}_computeProj(){const t=this._near*Math.tan(.5*this._fovY),e=t*this._aspect;let i=-e,s=e,r=t,a=-t;if(this._window){const t=s-i,e=r-a;i+=t*this._window[0],a+=e*this._window[1],s=i+t*this._window[2],r=a+e*this._window[3]}this._projMatrix.frustum(i,s,a,r,this._near,this._far)}}class dh{_camera;constructor(){this._camera=null,this.reset()}_getCamera(){return this._camera}_setCamera(t){this._camera!==t&&(this._camera=t,this.reset())}reset(){}onMouseDown(t){return this._onMouseDown(t)}onMouseUp(t){return this._onMouseUp(t)}onMouseWheel(t){return this._onMouseWheel(t)}onMouseMove(t){return this._onMouseMove(t)}onKeyDown(t){return this._onKeyDown(t)}onKeyUp(t){return this._onKeyUp(t)}update(){}_onMouseDown(t){return!1}_onMouseUp(t){return!1}_onMouseWheel(t){return!1}_onMouseMove(t){return!1}_onKeyDown(t){return!1}_onKeyUp(t){return!1}}class ph extends dh{options;mouseDown;lastMouseX;lastMouseY;rotateX;rotateY;eyePos;upVector;xVector;target;direction;quat;scale;constructor(t){super(),this.options=Object.assign({distance:1,damping:.1,moveSpeed:.2,rotateSpeed:.01,zoomSpeed:1},t||{}),this.rotateX=0,this.rotateY=0,this.eyePos=new g,this.upVector=g.axisPY(),this.xVector=new g,this.target=new g,this.direction=new g,this.quat=new b,this.scale=1}reset(){this.mouseDown=!1,this.lastMouseX=0,this.lastMouseY=0,this.rotateX=0,this.rotateY=0,this.scale=1,this._loadCameraParams()}_onMouseDown(t){return 0===t.button&&(this.mouseDown=!0,this.lastMouseX=t.offsetX,this.lastMouseY=t.offsetY,this.rotateX=0,this.rotateY=0,!0)}_onMouseUp(t){return!(0!==t.button||!this.mouseDown)&&(this.mouseDown=!1,!0)}_onMouseWheel(t){console.log(`wheel deltaX: ${t.deltaX}`),console.log(`wheel deltaY: ${t.deltaY}`);const e=Math.pow(.9,Math.abs(this.options.zoomSpeed));return t.deltaY>0?this.scale/=e:this.scale*=e,!0}_onMouseMove(t){if(this.mouseDown){const e=t.offsetX-this.lastMouseX,i=t.offsetY-this.lastMouseY;return this.lastMouseX=t.offsetX,this.lastMouseY=t.offsetY,this.rotateX-=i*this.options.rotateSpeed,this.rotateY-=e*this.options.rotateSpeed,!0}return!1}_loadCameraParams(){if(this._getCamera()){const t=this._getCamera().worldMatrix;t.decomposeLookAt(this.eyePos,this.target),g.normalize(g.sub(this.eyePos,this.target),this.direction),g.sub(this.eyePos,g.scale(this.direction,this.options.distance),this.target),this.xVector.setXYZ(t[0],t[1],t[2])}}setOptions(t){t&&Object.assign(this.options,t),this.reset()}update(){this._getCamera()&&(b.fromAxisAngle(this.xVector,this.rotateX,this.quat),this.quat.transform(this.eyePos.subBy(this.target),this.eyePos),b.fromEulerAngle(0,this.rotateY,0,"XYZ",this.quat),this.quat.transform(this.eyePos,this.eyePos),this.quat.transform(this.xVector,this.xVector).inplaceNormalize(),g.normalize(this.eyePos,this.direction).inplaceNormalize(),g.cross(this.direction,this.xVector,this.upVector).inplaceNormalize(),g.add(this.target,g.scale(this.direction,this.options.distance*this.scale),this.eyePos),this._getCamera().lookAt(this.eyePos,this.target,this.upVector),this.mouseDown?(this.rotateX=0,this.rotateY=0):(this.rotateX*=1-this.options.damping,this.rotateY*=1-this.options.damping,Math.abs(this.rotateX)<1e-4&&(this.rotateX=0),Math.abs(this.rotateY)<1e-4&&(this.rotateY=0)))}}class _h{_outputTexture;_quadVertexLayout;_quadRenderStateSet;_enabled;_opaque;_intermediateFramebuffers;constructor(){this._outputTexture=null,this._quadVertexLayout=null,this._quadRenderStateSet=null,this._enabled=!0,this._opaque=!1,this._intermediateFramebuffers={}}get enabled(){return this._enabled}set enabled(t){this._enabled=!!t}get opaque(){return this._opaque}needFlip(t){return"webgpu"===t.type&&!!t.getFramebuffer()}addIntermediateFramebuffer(t,e){if(this._intermediateFramebuffers[t])throw new Error(`Intermediate framebuffer already exists: ${t}`);this._intermediateFramebuffers[t]={depth:e,framebuffer:null}}getIntermediateFramebuffer(t,e,i,s){const r=this._intermediateFramebuffers[t];if(!r)return null;const a=Y.instance.device,n=a.getFramebuffer().getDepthAttachment();if(r.framebuffer){const t=r.framebuffer.getColorAttachments()[0],a=r.framebuffer.getDepthAttachment();t.width===i&&t.height===s&&t.format===e||(r.framebuffer.dispose(),t.dispose(),a&&a!==n&&a.dispose(),r.framebuffer=null)}if(!r.framebuffer){const o=a.createTexture2D(e,i,s,{samplerOptions:{mipFilter:"none"}});o.name=`Intermediate-<${t}>`;let h=null;"current"===r.depth?h=n:"temporal"===r.depth&&(h=a.createTexture2D("d24s8",i,s),h.name=`Intermediate-<${t}>-depth`),r.framebuffer=a.createFrameBuffer([o],h)}return r.framebuffer}dispose(){this._quadVertexLayout?.dispose(),this._quadVertexLayout=null,this._quadRenderStateSet=null;for(const t in this._intermediateFramebuffers){const e=this._intermediateFramebuffers[t];if(e){const t=e.framebuffer.getColorAttachments()[0];e.framebuffer.dispose(),t.dispose()}}this._intermediateFramebuffers={}}drawFullscreenQuad(t){!function(t){const e=Y.instance.device;Jo||(Jo=e.createVertexLayout({vertexBuffers:[{buffer:e.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]})),th||(th=e.createRenderStateSet(),th.useRasterizerState().setCullMode("none"),th.useDepthState().enableTest(!1).enableWrite(!1));const i=e.getRenderStates();e.setRenderStates(t??th),e.setVertexLayout(Jo),e.draw("triangle-strip",0,4),e.setRenderStates(i)}(t)}createVertexLayout(t){return t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]})}createRenderStates(t){const e=t.createRenderStateSet();return e.useRasterizerState().setCullMode("none"),e.useDepthState().enableTest(!1).enableWrite(!1),e}}class mh extends _h{static _nearestSampler=null;static _programTonemap=null;_bindgroupTonemap;_exposure;constructor(){super(),this._bindgroupTonemap=null,this._opaque=!1,this._exposure=1}get exposure(){return this._exposure}set exposure(t){this._exposure=t}requireLinearDepthTexture(){return!1}requireDepthAttachment(){return!1}apply(t,e,i,s){const r=Y.instance.device;this._prepare(r,e),this._tonemap(r,e,s)}_tonemap(t,e,i){this._bindgroupTonemap.setValue("srgbOut",i?1:0),this._bindgroupTonemap.setValue("exposure",this._exposure),this._bindgroupTonemap.setValue("flip",this.needFlip(t)?1:0),this._bindgroupTonemap.setTexture("tex",e,mh._nearestSampler),t.setProgram(mh._programTonemap),t.setBindGroup(0,this._bindgroupTonemap),this.drawFullscreenQuad()}_prepare(t,e){mh._programTonemap||(mh._programTonemap=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))},fragment(t){this.srgbOut=t.int().uniform(0),this.exposure=t.float().uniform(0),this.tex=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.func("RRTAndODTFit",[t.vec3("v")],(function(){this.$l.a=t.sub(t.mul(this.v,t.add(this.v,t.vec3(.0245786))),t.vec3(90537e-9)),this.$l.b=t.add(t.mul(this.v,t.add(t.mul(this.v,.983729),t.vec3(.432951))),t.vec3(.238081)),this.$return(t.div(this.a,this.b))})),t.main((function(){this.$l.vSample=t.textureSample(this.tex,this.$inputs.uv),this.$l.ACESInputMat=t.mat3(.59719,.076,.0284,.35458,.90834,.13383,.04823,.01566,.83777),this.$l.ACESOutputMat=t.mat3(1.60475,-.10208,-.00327,-.53108,1.10813,-.07276,-.07367,-.00605,1.07602),this.$l.color=t.mul(this.vSample.rgb,t.div(this.exposure,.6)),this.color=t.mul(this.ACESInputMat,this.color),this.color=this.RRTAndODTFit(this.color),this.color=t.mul(this.ACESOutputMat,this.color),this.color=t.clamp(this.color,t.vec3(0),t.vec3(1)),this.$if(t.notEqual(this.srgbOut,0),(function(){this.$l.color=sn(this,this.color)})),this.$outputs.outColor=t.vec4(this.color,1)}))}})),this._bindgroupTonemap||(this._bindgroupTonemap=t.createBindGroup(mh._programTonemap.bindGroupLayouts[0])),mh._nearestSampler||(mh._nearestSampler=t.createSampler({magFilter:"nearest",minFilter:"nearest",mipFilter:"none",addressU:"clamp",addressV:"clamp"}))}dispose(){super.dispose(),this._bindgroupTonemap?.dispose(),this._bindgroupTonemap=null}}class fh extends _h{static _program=null;static _sampler=null;_bindgroup;_invTexSize;constructor(){super(),this._opaque=!1,this._bindgroup=null,this._invTexSize=new f}dispose(){super.dispose(),this._bindgroup?.dispose(),this._bindgroup=null}requireLinearDepthTexture(){return!1}requireDepthAttachment(){return!1}apply(t,e,i,s){const r=Y.instance.device;this._prepare(r),this._invTexSize.setXY(1/e.width,1/e.height),this._bindgroup.setTexture("srcTex",e,fh._sampler),this._bindgroup.setValue("flip",this.needFlip(r)?1:0),this._bindgroup.setValue("srgbOut",s?1:0),this._bindgroup.setValue("invTexSize",this._invTexSize),r.setProgram(fh._program),r.setBindGroup(0,this._bindgroup),this.drawFullscreenQuad()}_prepare(t){fh._program||(fh._program=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))},fragment(t){this.srcTex=t.tex2D().uniform(0),this.srgbOut=t.int().uniform(0),this.invTexSize=t.vec2().uniform(0),this.$outputs.outColor=t.vec4(),t.func("getLuma",[t.vec3("vSample")],(function(){this.$return(t.dot(this.vSample,t.vec3(.299,.587,.114)))})),t.func("FXAA",[t.vec2("uv")],(function(){this.$l.posM=this.uv,this.$l.rgbyM=t.textureSampleLevel(this.srcTex,this.uv,0),this.$l.lumaM=this.getLuma(this.rgbyM.rgb),this.$l.lumaN=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(0,-1),this.invTexSize)),0).rgb),this.$l.lumaW=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(-1,0),this.invTexSize)),0).rgb),this.$l.lumaE=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(1,0),this.invTexSize)),0).rgb),this.$l.lumaS=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(0,1),this.invTexSize)),0).rgb),this.$l.rangeMin=t.min(this.lumaM,t.min(t.min(this.lumaN,this.lumaW),t.min(this.lumaS,this.lumaE))),this.$l.rangeMax=t.max(this.lumaM,t.max(t.max(this.lumaN,this.lumaW),t.max(this.lumaS,this.lumaE))),this.$l.range=t.sub(this.rangeMax,this.rangeMin),this.$if(t.lessThan(this.range,t.max(1/16,t.div(this.rangeMax,8))),(function(){this.$return(this.rgbyM)})),this.$l.lumaNW=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(-1,-1),this.invTexSize)),0).rgb),this.$l.lumaNE=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(1,-1),this.invTexSize)),0).rgb),this.$l.lumaSW=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(-1,1),this.invTexSize)),0).rgb),this.$l.lumaSE=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(1,1),this.invTexSize)),0).rgb),this.$l.lumaNS=t.add(this.lumaN,this.lumaS),this.$l.lumaWE=t.add(this.lumaW,this.lumaE),this.$l.subpixRcpRange=t.div(1,this.range),this.$l.subpixNSWE=t.add(this.lumaNS,this.lumaWE),this.$l.edgeHorz1=t.add(t.mul(-2,this.lumaM),this.lumaNS),this.$l.edgeVert1=t.add(t.mul(-2,this.lumaM),this.lumaWE),this.$l.lumaNESE=t.add(this.lumaNE,this.lumaSE),this.$l.lumaNWNE=t.add(this.lumaNW,this.lumaNE),this.$l.edgeHorz2=t.add(t.mul(-2,this.lumaE),this.lumaNESE),this.$l.edgeVert2=t.add(t.mul(-2,this.lumaN),this.lumaNWNE),this.$l.lumaNWSW=t.add(this.lumaNW,this.lumaSW),this.$l.lumaSWSE=t.add(this.lumaSW,this.lumaSE),this.$l.edgeHorz4=t.add(t.mul(t.abs(this.edgeHorz1),2),t.abs(this.edgeHorz2)),this.$l.edgeVert4=t.add(t.mul(t.abs(this.edgeVert1),2),t.abs(this.edgeVert2)),this.$l.edgeHorz3=t.add(t.mul(-2,this.lumaW),this.lumaNWSW),this.$l.edgeVert3=t.add(t.mul(-2,this.lumaS),this.lumaSWSE),this.$l.edgeHorz=t.add(t.abs(this.edgeHorz3),this.edgeHorz4),this.$l.edgeVert=t.add(t.abs(this.edgeVert3),this.edgeVert4),this.$l.subpixNWSWNESE=t.add(this.lumaNWSW,this.lumaNESE),this.$l.lengthSign=this.invTexSize.x,this.$l.horzSpan=t.greaterThanEqual(this.edgeHorz,this.edgeVert),this.$l.subpixA=t.add(t.mul(this.subpixNSWE,2),this.subpixNWSWNESE),this.$if(t.not(this.horzSpan),(function(){this.lumaN=this.lumaW,this.lumaS=this.lumaE})).$else((function(){this.lengthSign=this.invTexSize.y})),this.$l.subpixB=t.sub(t.div(this.subpixA,12),this.lumaM),this.$l.gradientN=t.sub(this.lumaN,this.lumaM),this.$l.gradientS=t.sub(this.lumaS,this.lumaM),this.$l.lumaNN=t.add(this.lumaN,this.lumaM),this.$l.lumaSS=t.add(this.lumaS,this.lumaM),this.$l.pairN=t.greaterThanEqual(t.abs(this.gradientN),t.abs(this.gradientS)),this.$l.gradient=t.max(t.abs(this.gradientN),t.abs(this.gradientS)),this.$if(this.pairN,(function(){this.lengthSign=t.neg(this.lengthSign)})),this.$l.subpixC=t.clamp(t.mul(t.abs(this.subpixB),this.subpixRcpRange),0,1),this.$l.posB=this.posM,this.$l.offNP=t.vec2(),this.$if(t.not(this.horzSpan),(function(){this.offNP.x=0,this.offNP.y=this.invTexSize.y,this.posB.x=t.add(this.posB.x,t.mul(this.lengthSign,.5))})).$else((function(){this.offNP.x=this.invTexSize.x,this.offNP.y=0,this.posB.y=t.add(this.posB.y,t.mul(this.lengthSign,.5))})),this.$l.posN=t.sub(this.posB,this.offNP),this.$l.posP=t.add(this.posB,this.offNP),this.$l.subpixD=t.add(t.mul(-2,this.subpixC),3),this.$l.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN,0).rgb),this.$l.subpixE=t.mul(this.subpixC,this.subpixC),this.$l.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP,0).rgb),this.$if(t.not(this.pairN),(function(){this.lumaNN=this.lumaSS})),this.$l.gradientScaled=t.div(this.gradient,4),this.$l.lumaMM=t.sub(this.lumaM,t.mul(this.lumaNN,.5)),this.$l.subpixF=t.mul(this.subpixD,this.subpixE),this.$l.lumaMLTZero=t.lessThan(this.lumaMM,0),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5)),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5)),this.$l.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.$l.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),(function(){this.posN=t.sub(this.posN,t.mul(this.offNP,1.5))})),this.$l.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),(function(){this.posP=t.add(this.posP,t.mul(this.offNP,1.5))})),this.$if(this.doneNP,(function(){this.$if(t.not(this.doneN),(function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))})),this.$if(t.not(this.doneP),(function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))})),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),(function(){this.posN=t.sub(this.posN,t.mul(this.offNP,2))})),this.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),(function(){this.posP=t.add(this.posP,t.mul(this.offNP,2))})),this.$if(this.doneNP,(function(){this.$if(t.not(this.doneN),(function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))})),this.$if(t.not(this.doneP),(function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))})),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),(function(){this.posN=t.sub(this.posN,t.mul(this.offNP,2))})),this.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),(function(){this.posP=t.add(this.posP,t.mul(this.offNP,2))})),this.$if(this.doneNP,(function(){this.$if(t.not(this.doneN),(function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))})),this.$if(t.not(this.doneP),(function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))})),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),(function(){this.posN=t.sub(this.posN,t.mul(this.offNP,4))})),this.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),(function(){this.posP=t.add(this.posP,t.mul(this.offNP,4))})),this.$if(this.doneNP,(function(){this.$if(t.not(this.doneN),(function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))})),this.$if(t.not(this.doneP),(function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))})),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),(function(){this.posN=t.sub(this.posN,t.mul(this.offNP,2))})),this.$if(t.not(this.doneP),(function(){this.posP=t.add(this.posP,t.mul(this.offNP,2))}))}))}))}))})),this.$l.dstN=t.sub(this.posM.x,this.posN.x),this.$l.dstP=t.sub(this.posP.x,this.posM.x),this.$if(t.not(this.horzSpan),(function(){this.dstN=t.sub(this.posM.y,this.posN.y),this.dstP=t.sub(this.posP.y,this.posM.y)})),this.$l.goodSpanN=t.notEqual(t.lessThan(this.lumaEndN,0),this.lumaMLTZero),this.$l.spanLength=t.add(this.dstP,this.dstN),this.$l.goodSpanP=t.notEqual(t.lessThan(this.lumaEndP,0),this.lumaMLTZero),this.$l.spanLengthRcp=t.div(1,this.spanLength),this.$l.directionN=t.lessThan(this.dstN,this.dstP),this.$l.dst=t.min(this.dstN,this.dstP),this.$l.goodSpan=this.$choice(this.directionN,this.goodSpanN,this.goodSpanP),this.$l.subpixG=t.mul(this.subpixF,this.subpixF),this.$l.pixelOffset=t.add(t.mul(this.dst,t.neg(this.spanLengthRcp)),.5),this.$l.subpixH=t.mul(this.subpixG,.75),this.$l.pixelOffsetGood=this.$choice(this.goodSpan,this.pixelOffset,0),this.$l.pixelOffsetSubpix=t.max(this.pixelOffsetGood,this.subpixH),this.$if(t.not(this.horzSpan),(function(){this.posM.x=t.add(this.posM.x,t.mul(this.pixelOffsetSubpix,this.lengthSign))})).$else((function(){this.posM.y=t.add(this.posM.y,t.mul(this.pixelOffsetSubpix,this.lengthSign))})),this.$return(t.textureSampleLevel(this.srcTex,this.posM,0).xyzw)})),t.main((function(){this.$l.color=this.FXAA(this.$inputs.uv),this.$if(t.equal(this.srgbOut,0),(function(){this.$outputs.outColor=this.color})).$else((function(){this.$outputs.outColor=t.vec4(sn(this,this.color.rgb),this.color.a)}))}))}})),fh._sampler||(fh._sampler=t.createSampler({magFilter:"linear",minFilter:"linear",mipFilter:"none",addressU:"clamp",addressV:"clamp"})),this._bindgroup||(this._bindgroup=t.createBindGroup(fh._program.bindGroupLayouts[0]))}}class gh{_postEffectsOpaque;_postEffectsTransparency;static _blitSampler=null;static _blitProgram=null;static _blitBindgroup=null;static _blitRenderStates=null;static _blitVertexLayout=null;constructor(){this._postEffectsOpaque=[],this._postEffectsTransparency=[]}requireLinearDepth(){for(const t of this._postEffectsOpaque)if(t.requireLinearDepthTexture())return!0;for(const t of this._postEffectsTransparency)if(t.requireLinearDepthTexture())return!0;return!1}appendPostEffect(t){if(t){if(this._postEffectsOpaque.indexOf(t)>=0||this._postEffectsTransparency.indexOf(t)>=0)return void console.error("Posteffect cannot be added to same compositor multiple times");(t.opaque?this._postEffectsOpaque:this._postEffectsTransparency).push(t)}}removePostEffect(t){for(const e of[this._postEffectsOpaque,this._postEffectsTransparency]){const i=e.indexOf(t);if(i>=0)return void e.splice(i,1)}}getPostEffects(){return[...this._postEffectsOpaque,...this._postEffectsTransparency]}begin(t){const e=Y.instance.device,i=e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"rgba16f":"rgba8unorm",s=e.getFramebuffer(),r=s?.getDepthAttachment();let a,n,o=null;t.primaryCamera.sampleCount>1&&(o=r?To.getFramebufferVariantSizeWithDepth(r,1,i,"2d",!1,t.primaryCamera.sampleCount):To.getFramebufferVariantSize(t.viewportWidth,t.viewportHeight,1,i,t.depthFormat,"2d","2d",!1,t.primaryCamera.sampleCount)),a=t.defaultViewport?[r?To.getFramebufferVariantSizeWithDepth(r,1,i,"2d",!1,1):To.getFramebufferVariantSize(t.viewportWidth,t.viewportHeight,1,i,t.depthFormat,"2d","2d",!1,1),r?To.getFramebufferVariantSizeWithDepth(r,1,i,"2d",!1,1):To.getFramebufferVariantSize(t.viewportWidth,t.viewportHeight,1,i,t.depthFormat,"2d","2d",!1,1)]:[r?To.getFramebufferFixedSizeWithDepth(r,1,i,"2d",!1,4):To.getFramebufferFixedSize(t.viewportWidth,t.viewportHeight,1,i,t.depthFormat,"2d","2d",!1,4),r?To.getFramebufferFixedSizeWithDepth(r,1,i,"2d",!1,4):To.getFramebufferFixedSize(t.viewportWidth,t.viewportHeight,1,i,t.depthFormat,"2d","2d",!1,4)],o?(n=3,e.setFramebuffer(o)):(n=0,e.setFramebuffer(a[n])),e.setViewport(null),e.setScissor(null),t.compositorContex={finalFramebuffer:s,pingpongFramebuffers:a,msFramebuffer:o,writeIndex:n}}drawPostEffects(t,e,i){const s=e?this._postEffectsOpaque:this._postEffectsTransparency;if(s.length>0){const r=Y.instance.device;for(let a=0;a<s.length;a++){const n=s[a];if(!n.enabled)continue;const o=r.getFramebuffer().getColorAttachments()[0];this.isLastPostEffect(e,a)&&(!n.requireDepthAttachment()||!!t.compositorContex.finalFramebuffer)?(r.setFramebuffer(t.compositorContex.finalFramebuffer),r.setViewport(null),r.setScissor(null)):(t.compositorContex.writeIndex=(1+t.compositorContex.writeIndex)%2,r.setFramebuffer(t.compositorContex.pingpongFramebuffers[t.compositorContex.writeIndex]),r.setViewport(null),r.setScissor(null)),n.apply(t,o,i,!r.getFramebuffer())}}}end(t){const e=Y.instance.device;if(e.getFramebuffer()!==t.compositorContex.finalFramebuffer){const i=e.getFramebuffer().getColorAttachments()[0];e.setFramebuffer(t.compositorContex.finalFramebuffer),e.setViewport(null),e.setScissor(null),gh._blit(e,i,!t.compositorContex.finalFramebuffer)}To.releaseFramebuffer(t.compositorContex.pingpongFramebuffers[0]),To.releaseFramebuffer(t.compositorContex.pingpongFramebuffers[1]),t.compositorContex.msFramebuffer&&To.releaseFramebuffer(t.compositorContex.msFramebuffer),t.compositorContex=null}isLastPostEffect(t,e){const i=t?this._postEffectsOpaque:this._postEffectsTransparency;for(let t=e;t<i.length;t++)if(i[t].enabled)return!1;if(t)for(let t=0;t<this._postEffectsTransparency.length;t++)if(this._postEffectsTransparency[t].enabled)return!1;return!0}needDrawPostEffects(){for(let t=0;t<this._postEffectsOpaque.length;t++)if(this._postEffectsOpaque[t].enabled)return!0;for(let t=0;t<this._postEffectsTransparency.length;t++)if(this._postEffectsTransparency[t].enabled)return!0;return!1}static _blit(t,e,i){this._blitProgram||(this._blitProgram=t.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),this.flip=t.int().uniform(0),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))},fragment(t){this.srcTex=t.tex2D().sampleType("unfilterable-float").uniform(0),this.srgbOutput=t.int().uniform(0),this.$outputs.outColor=t.vec4(),t.main((function(){this.$outputs.outColor=t.textureSample(this.srcTex,this.$inputs.uv),this.$if(t.notEqual(this.srgbOutput,0),(function(){this.$outputs.outColor=t.vec4(sn(this,this.$outputs.outColor.rgb),1)}))}))}}),this._blitBindgroup=t.createBindGroup(this._blitProgram.bindGroupLayouts[0]),this._blitVertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]}),this._blitSampler=t.createSampler({minFilter:"nearest",magFilter:"nearest",mipFilter:"none",addressU:"clamp",addressV:"clamp"}),this._blitRenderStates=t.createRenderStateSet(),this._blitRenderStates.useRasterizerState().setCullMode("none"),this._blitRenderStates.useDepthState().enableTest(!1).enableWrite(!1)),this._blitBindgroup.setTexture("srcTex",e,this._blitSampler),this._blitBindgroup.setValue("srgbOutput",i?1:0),this._blitBindgroup.setValue("flip","webgpu"===t.type&&t.getFramebuffer()?1:0),t.setRenderStates(this._blitRenderStates),t.setProgram(this._blitProgram),t.setBindGroup(0,this._blitBindgroup),t.setVertexLayout(this._blitVertexLayout),t.draw("triangle-strip",0,4)}}var xh;function Th(t){return!(!t||!t.texStorage2D)}!function(t){t[t.READ_BUFFER=3074]="READ_BUFFER",t[t.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",t[t.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",t[t.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",t[t.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",t[t.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",t[t.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",t[t.COLOR=6144]="COLOR",t[t.DEPTH=6145]="DEPTH",t[t.STENCIL=6146]="STENCIL",t[t.RED=6403]="RED",t[t.RGB8=32849]="RGB8",t[t.RGBA8=32856]="RGBA8",t[t.RGB10_A2=32857]="RGB10_A2",t[t.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",t[t.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",t[t.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",t[t.TEXTURE_3D=32879]="TEXTURE_3D",t[t.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",t[t.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",t[t.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",t[t.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",t[t.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",t[t.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",t[t.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",t[t.MIN=32775]="MIN",t[t.MAX=32776]="MAX",t[t.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",t[t.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",t[t.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",t[t.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",t[t.CURRENT_QUERY=34917]="CURRENT_QUERY",t[t.QUERY_RESULT=34918]="QUERY_RESULT",t[t.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",t[t.STREAM_READ=35041]="STREAM_READ",t[t.STREAM_COPY=35042]="STREAM_COPY",t[t.STATIC_READ=35045]="STATIC_READ",t[t.STATIC_COPY=35046]="STATIC_COPY",t[t.DYNAMIC_READ=35049]="DYNAMIC_READ",t[t.DYNAMIC_COPY=35050]="DYNAMIC_COPY",t[t.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",t[t.DRAW_BUFFER0=34853]="DRAW_BUFFER0",t[t.DRAW_BUFFER1=34854]="DRAW_BUFFER1",t[t.DRAW_BUFFER2=34855]="DRAW_BUFFER2",t[t.DRAW_BUFFER3=34856]="DRAW_BUFFER3",t[t.DRAW_BUFFER4=34857]="DRAW_BUFFER4",t[t.DRAW_BUFFER5=34858]="DRAW_BUFFER5",t[t.DRAW_BUFFER6=34859]="DRAW_BUFFER6",t[t.DRAW_BUFFER7=34860]="DRAW_BUFFER7",t[t.DRAW_BUFFER8=34861]="DRAW_BUFFER8",t[t.DRAW_BUFFER9=34862]="DRAW_BUFFER9",t[t.DRAW_BUFFER10=34863]="DRAW_BUFFER10",t[t.DRAW_BUFFER11=34864]="DRAW_BUFFER11",t[t.DRAW_BUFFER12=34865]="DRAW_BUFFER12",t[t.DRAW_BUFFER13=34866]="DRAW_BUFFER13",t[t.DRAW_BUFFER14=34867]="DRAW_BUFFER14",t[t.DRAW_BUFFER15=34868]="DRAW_BUFFER15",t[t.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",t[t.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",t[t.SAMPLER_3D=35679]="SAMPLER_3D",t[t.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",t[t.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",t[t.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",t[t.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",t[t.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",t[t.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",t[t.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",t[t.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",t[t.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",t[t.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",t[t.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",t[t.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",t[t.SRGB=35904]="SRGB",t[t.SRGB8=35905]="SRGB8",t[t.SRGB_ALPHA=35906]="SRGB_ALPHA",t[t.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",t[t.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",t[t.RGBA32F=34836]="RGBA32F",t[t.RGB32F=34837]="RGB32F",t[t.RGBA16F=34842]="RGBA16F",t[t.RGB16F=34843]="RGB16F",t[t.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",t[t.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",t[t.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",t[t.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",t[t.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",t[t.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",t[t.R11F_G11F_B10F=35898]="R11F_G11F_B10F",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.RGB9_E5=35901]="RGB9_E5",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",t[t.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",t[t.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",t[t.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",t[t.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",t[t.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",t[t.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",t[t.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",t[t.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",t[t.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",t[t.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",t[t.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",t[t.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",t[t.RGBA32UI=36208]="RGBA32UI",t[t.RGB32UI=36209]="RGB32UI",t[t.RGBA16UI=36214]="RGBA16UI",t[t.RGB16UI=36215]="RGB16UI",t[t.RGBA8UI=36220]="RGBA8UI",t[t.RGB8UI=36221]="RGB8UI",t[t.RGBA32I=36226]="RGBA32I",t[t.RGB32I=36227]="RGB32I",t[t.RGBA16I=36232]="RGBA16I",t[t.RGB16I=36233]="RGB16I",t[t.RGBA8I=36238]="RGBA8I",t[t.RGB8I=36239]="RGB8I",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",t[t.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",t[t.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",t[t.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",t[t.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",t[t.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",t[t.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",t[t.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",t[t.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",t[t.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",t[t.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",t[t.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",t[t.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",t[t.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",t[t.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",t[t.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",t[t.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",t[t.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",t[t.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",t[t.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",t[t.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",t[t.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",t[t.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",t[t.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",t[t.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",t[t.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",t[t.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",t[t.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",t[t.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",t[t.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",t[t.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",t[t.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",t[t.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",t[t.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",t[t.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",t[t.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",t[t.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",t[t.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",t[t.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",t[t.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",t[t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",t[t.MAX_SAMPLES=36183]="MAX_SAMPLES",t[t.HALF_FLOAT=5131]="HALF_FLOAT",t[t.RG=33319]="RG",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.R8=33321]="R8",t[t.RG8=33323]="RG8",t[t.R16F=33325]="R16F",t[t.R32F=33326]="R32F",t[t.RG16F=33327]="RG16F",t[t.RG32F=33328]="RG32F",t[t.R8I=33329]="R8I",t[t.R8UI=33330]="R8UI",t[t.R16I=33331]="R16I",t[t.R16UI=33332]="R16UI",t[t.R32I=33333]="R32I",t[t.R32UI=33334]="R32UI",t[t.RG8I=33335]="RG8I",t[t.RG8UI=33336]="RG8UI",t[t.RG16I=33337]="RG16I",t[t.RG16UI=33338]="RG16UI",t[t.RG32I=33339]="RG32I",t[t.RG32UI=33340]="RG32UI",t[t.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",t[t.R8_SNORM=36756]="R8_SNORM",t[t.RG8_SNORM=36757]="RG8_SNORM",t[t.RGB8_SNORM=36758]="RGB8_SNORM",t[t.RGBA8_SNORM=36759]="RGBA8_SNORM",t[t.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",t[t.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",t[t.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",t[t.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",t[t.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",t[t.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",t[t.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",t[t.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",t[t.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",t[t.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",t[t.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",t[t.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",t[t.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",t[t.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",t[t.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",t[t.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",t[t.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",t[t.UNIFORM_TYPE=35383]="UNIFORM_TYPE",t[t.UNIFORM_SIZE=35384]="UNIFORM_SIZE",t[t.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",t[t.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",t[t.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",t[t.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",t[t.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",t[t.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",t[t.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",t[t.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",t[t.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",t[t.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",t[t.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",t[t.INVALID_INDEX=4294967295]="INVALID_INDEX",t[t.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",t[t.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",t[t.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",t[t.OBJECT_TYPE=37138]="OBJECT_TYPE",t[t.SYNC_CONDITION=37139]="SYNC_CONDITION",t[t.SYNC_STATUS=37140]="SYNC_STATUS",t[t.SYNC_FLAGS=37141]="SYNC_FLAGS",t[t.SYNC_FENCE=37142]="SYNC_FENCE",t[t.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",t[t.UNSIGNALED=37144]="UNSIGNALED",t[t.SIGNALED=37145]="SIGNALED",t[t.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",t[t.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",t[t.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",t[t.WAIT_FAILED=37149]="WAIT_FAILED",t[t.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",t[t.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",t[t.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",t[t.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",t[t.SAMPLER_BINDING=35097]="SAMPLER_BINDING",t[t.RGB10_A2UI=36975]="RGB10_A2UI",t[t.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",t[t.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",t[t.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",t[t.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",t[t.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",t[t.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",t[t.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",t[t.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",t[t.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",t[t.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",t[t.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",t[t.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN",t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_COLOR=768]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",t[t.SRC_ALPHA=770]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=772]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",t[t.DST_COLOR=774]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",t[t.FUNC_ADD=32774]="FUNC_ADD",t[t.FUNC_MIN=32775]="FUNC_MIN",t[t.FUNC_MAX=32776]="FUNC_MAX",t[t.BLEND_EQUATION=32777]="BLEND_EQUATION",t[t.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",t[t.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",t[t.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",t[t.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",t[t.BLEND_DST_RGB=32968]="BLEND_DST_RGB",t[t.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",t[t.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",t[t.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",t[t.CONSTANT_COLOR=32769]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",t[t.BLEND_COLOR=32773]="BLEND_COLOR",t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",t[t.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",t[t.STREAM_DRAW=35040]="STREAM_DRAW",t[t.STATIC_DRAW=35044]="STATIC_DRAW",t[t.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",t[t.BUFFER_SIZE=34660]="BUFFER_SIZE",t[t.BUFFER_USAGE=34661]="BUFFER_USAGE",t[t.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK",t[t.FRONT_AND_BACK=1032]="FRONT_AND_BACK",t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.CULL_FACE=2884]="CULL_FACE",t[t.BLEND=3042]="BLEND",t[t.DITHER=3024]="DITHER",t[t.STENCIL_TEST=2960]="STENCIL_TEST",t[t.DEPTH_TEST=2929]="DEPTH_TEST",t[t.SCISSOR_TEST=3089]="SCISSOR_TEST",t[t.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",t[t.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",t[t.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",t[t.NO_ERROR=0]="NO_ERROR",t[t.INVALID_ENUM=1280]="INVALID_ENUM",t[t.INVALID_VALUE=1281]="INVALID_VALUE",t[t.INVALID_OPERATION=1282]="INVALID_OPERATION",t[t.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",t[t.CW=2304]="CW",t[t.CCW=2305]="CCW",t[t.LINE_WIDTH=2849]="LINE_WIDTH",t[t.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",t[t.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",t[t.CULL_FACE_MODE=2885]="CULL_FACE_MODE",t[t.FRONT_FACE=2886]="FRONT_FACE",t[t.DEPTH_RANGE=2928]="DEPTH_RANGE",t[t.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",t[t.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",t[t.DEPTH_FUNC=2932]="DEPTH_FUNC",t[t.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",t[t.STENCIL_FUNC=2962]="STENCIL_FUNC",t[t.STENCIL_FAIL=2964]="STENCIL_FAIL",t[t.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",t[t.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",t[t.STENCIL_REF=2967]="STENCIL_REF",t[t.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",t[t.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",t[t.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",t[t.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",t[t.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",t[t.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",t[t.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",t[t.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",t[t.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",t[t.VIEWPORT=2978]="VIEWPORT",t[t.SCISSOR_BOX=3088]="SCISSOR_BOX",t[t.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",t[t.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",t[t.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",t[t.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",t[t.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",t[t.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",t[t.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",t[t.RED_BITS=3410]="RED_BITS",t[t.GREEN_BITS=3411]="GREEN_BITS",t[t.BLUE_BITS=3412]="BLUE_BITS",t[t.ALPHA_BITS=3413]="ALPHA_BITS",t[t.DEPTH_BITS=3414]="DEPTH_BITS",t[t.STENCIL_BITS=3415]="STENCIL_BITS",t[t.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",t[t.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",t[t.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",t[t.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",t[t.SAMPLES=32937]="SAMPLES",t[t.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",t[t.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",t[t.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",t[t.DONT_CARE=4352]="DONT_CARE",t[t.FASTEST=4353]="FASTEST",t[t.NICEST=4354]="NICEST",t[t.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.ALPHA=6406]="ALPHA",t[t.RGB=6407]="RGB",t[t.RGBA=6408]="RGBA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",t[t.VERTEX_SHADER=35633]="VERTEX_SHADER",t[t.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",t[t.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",t[t.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",t[t.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",t[t.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",t[t.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",t[t.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",t[t.SHADER_TYPE=35663]="SHADER_TYPE",t[t.DELETE_STATUS=35712]="DELETE_STATUS",t[t.LINK_STATUS=35714]="LINK_STATUS",t[t.VALIDATE_STATUS=35715]="VALIDATE_STATUS",t[t.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",t[t.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",t[t.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",t[t.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",t[t.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",t[t.NEVER=512]="NEVER",t[t.LESS=513]="LESS",t[t.EQUAL=514]="EQUAL",t[t.LEQUAL=515]="LEQUAL",t[t.GREATER=516]="GREATER",t[t.NOTEQUAL=517]="NOTEQUAL",t[t.GEQUAL=518]="GEQUAL",t[t.ALWAYS=519]="ALWAYS",t[t.KEEP=7680]="KEEP",t[t.REPLACE=7681]="REPLACE",t[t.INCR=7682]="INCR",t[t.DECR=7683]="DECR",t[t.INVERT=5386]="INVERT",t[t.INCR_WRAP=34055]="INCR_WRAP",t[t.DECR_WRAP=34056]="DECR_WRAP",t[t.VENDOR=7936]="VENDOR",t[t.RENDERER=7937]="RENDERER",t[t.VERSION=7938]="VERSION",t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9729]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",t[t.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",t[t.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",t[t.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",t[t.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",t[t.TEXTURE=5890]="TEXTURE",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",t[t.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",t[t.TEXTURE0=33984]="TEXTURE0",t[t.TEXTURE1=33985]="TEXTURE1",t[t.TEXTURE2=33986]="TEXTURE2",t[t.TEXTURE3=33987]="TEXTURE3",t[t.TEXTURE4=33988]="TEXTURE4",t[t.TEXTURE5=33989]="TEXTURE5",t[t.TEXTURE6=33990]="TEXTURE6",t[t.TEXTURE7=33991]="TEXTURE7",t[t.TEXTURE8=33992]="TEXTURE8",t[t.TEXTURE9=33993]="TEXTURE9",t[t.TEXTURE10=33994]="TEXTURE10",t[t.TEXTURE11=33995]="TEXTURE11",t[t.TEXTURE12=33996]="TEXTURE12",t[t.TEXTURE13=33997]="TEXTURE13",t[t.TEXTURE14=33998]="TEXTURE14",t[t.TEXTURE15=33999]="TEXTURE15",t[t.TEXTURE16=34e3]="TEXTURE16",t[t.TEXTURE17=34001]="TEXTURE17",t[t.TEXTURE18=34002]="TEXTURE18",t[t.TEXTURE19=34003]="TEXTURE19",t[t.TEXTURE20=34004]="TEXTURE20",t[t.TEXTURE21=34005]="TEXTURE21",t[t.TEXTURE22=34006]="TEXTURE22",t[t.TEXTURE23=34007]="TEXTURE23",t[t.TEXTURE24=34008]="TEXTURE24",t[t.TEXTURE25=34009]="TEXTURE25",t[t.TEXTURE26=34010]="TEXTURE26",t[t.TEXTURE27=34011]="TEXTURE27",t[t.TEXTURE28=34012]="TEXTURE28",t[t.TEXTURE29=34013]="TEXTURE29",t[t.TEXTURE30=34014]="TEXTURE30",t[t.TEXTURE31=34015]="TEXTURE31",t[t.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",t[t.REPEAT=10497]="REPEAT",t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",t[t.FLOAT_VEC2=35664]="FLOAT_VEC2",t[t.FLOAT_VEC3=35665]="FLOAT_VEC3",t[t.FLOAT_VEC4=35666]="FLOAT_VEC4",t[t.INT_VEC2=35667]="INT_VEC2",t[t.INT_VEC3=35668]="INT_VEC3",t[t.INT_VEC4=35669]="INT_VEC4",t[t.BOOL=35670]="BOOL",t[t.BOOL_VEC2=35671]="BOOL_VEC2",t[t.BOOL_VEC3=35672]="BOOL_VEC3",t[t.BOOL_VEC4=35673]="BOOL_VEC4",t[t.FLOAT_MAT2=35674]="FLOAT_MAT2",t[t.FLOAT_MAT3=35675]="FLOAT_MAT3",t[t.FLOAT_MAT4=35676]="FLOAT_MAT4",t[t.SAMPLER_2D=35678]="SAMPLER_2D",t[t.SAMPLER_CUBE=35680]="SAMPLER_CUBE",t[t.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",t[t.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",t[t.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",t[t.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",t[t.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",t[t.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",t[t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",t[t.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",t[t.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",t[t.COMPILE_STATUS=35713]="COMPILE_STATUS",t[t.LOW_FLOAT=36336]="LOW_FLOAT",t[t.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",t[t.HIGH_FLOAT=36338]="HIGH_FLOAT",t[t.LOW_INT=36339]="LOW_INT",t[t.MEDIUM_INT=36340]="MEDIUM_INT",t[t.HIGH_INT=36341]="HIGH_INT",t[t.FRAMEBUFFER=36160]="FRAMEBUFFER",t[t.RENDERBUFFER=36161]="RENDERBUFFER",t[t.RGBA4=32854]="RGBA4",t[t.RGB5_A1=32855]="RGB5_A1",t[t.RGB565=36194]="RGB565",t[t.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",t[t.STENCIL_INDEX8=36168]="STENCIL_INDEX8",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t[t.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",t[t.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",t[t.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",t[t.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",t[t.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",t[t.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",t[t.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",t[t.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",t[t.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",t[t.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",t[t.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",t[t.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",t[t.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",t[t.NONE=0]="NONE",t[t.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",t[t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",t[t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",t[t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",t[t.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",t[t.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",t[t.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",t[t.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",t[t.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",t[t.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",t[t.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",t[t.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",t[t.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",t[t.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",t[t.TEXTURE_MAX_ANISOTROPY=34046]="TEXTURE_MAX_ANISOTROPY",t[t.MAX_TEXTURE_MAX_ANISOTROPY=34047]="MAX_TEXTURE_MAX_ANISOTROPY"}(xh||(xh={}));class bh extends Error{static errorToString={[xh.NO_ERROR]:"NO_ERROR",[xh.INVALID_ENUM]:"INVALID_ENUM",[xh.INVALID_VALUE]:"INVALID_VALUE",[xh.INVALID_OPERATION]:"INVALID_OPERATION",[xh.INVALID_FRAMEBUFFER_OPERATION]:"INVALID_FRAMEBUFFER_OPERATION",[xh.OUT_OF_MEMORY]:"OUT_OF_MEMORY",[xh.CONTEXT_LOST_WEBGL]:"CONTEXT_LOST_WEBGL"};code;constructor(t){super(bh.errorToString[t]),this.code=t}}const Eh={add:xh.FUNC_ADD,subtract:xh.FUNC_SUBTRACT,"reverse-subtract":xh.FUNC_REVERSE_SUBTRACT,max:xh.FUNC_MAX,min:xh.FUNC_MIN},yh={[xh.FUNC_ADD]:"add",[xh.FUNC_SUBTRACT]:"subtract",[xh.FUNC_REVERSE_SUBTRACT]:"reverse-subtract",[xh.FUNC_MAX]:"max",[xh.FUNC_MIN]:"min"},vh={zero:xh.ZERO,one:xh.ONE,"src-alpha":xh.SRC_ALPHA,"inv-src-alpha":xh.ONE_MINUS_SRC_ALPHA,"src-alpha-saturate":xh.BLEND,"dst-alpha":xh.DST_ALPHA,"inv-dst-alpha":xh.ONE_MINUS_DST_ALPHA,"src-color":xh.SRC_COLOR,"inv-src-color":xh.ONE_MINUS_SRC_COLOR,"dst-color":xh.DST_COLOR,"inv-dst-color":xh.ONE_MINUS_DST_COLOR,"const-color":xh.CONSTANT_COLOR,"inv-const-color":xh.ONE_MINUS_CONSTANT_COLOR,"const-alpha":xh.CONSTANT_ALPHA,"inv-const-alpha":xh.ONE_MINUS_CONSTANT_ALPHA},Sh={[xh.ZERO]:"zero",[xh.ONE]:"one",[xh.SRC_ALPHA]:"src-alpha",[xh.ONE_MINUS_SRC_ALPHA]:"inv-src-alpha",[xh.SRC_ALPHA_SATURATE]:"src-alpha-saturate",[xh.DST_ALPHA]:"dst-alpha",[xh.ONE_MINUS_DST_ALPHA]:"inv-dst-alpha",[xh.SRC_COLOR]:"src-color",[xh.ONE_MINUS_SRC_COLOR]:"inv-src-color",[xh.DST_COLOR]:"dst-color",[xh.ONE_MINUS_DST_COLOR]:"inv-dst-color",[xh.CONSTANT_COLOR]:"const-color",[xh.ONE_MINUS_CONSTANT_COLOR]:"inv-const-color",[xh.CONSTANT_ALPHA]:"const-alpha",[xh.ONE_MINUS_CONSTANT_ALPHA]:"inv-const-alpha"},wh={none:xh.NONE,front:xh.FRONT,back:xh.BACK},Ch={[xh.NONE]:"none",[xh.FRONT]:"front",[xh.BACK]:"back"};xh.CW,xh.CCW,xh.CW,xh.CCW;const Ah={keep:xh.KEEP,zero:xh.ZERO,replace:xh.REPLACE,incr:xh.INCR,"incr-wrap":xh.INCR_WRAP,decr:xh.DECR,"decr-wrap":xh.DECR_WRAP,invert:xh.INVERT},Rh={[xh.KEEP]:"keep",[xh.ZERO]:"zero",[xh.REPLACE]:"replace",[xh.INCR]:"incr",[xh.INCR_WRAP]:"incr-wrap",[xh.DECR]:"decr",[xh.DECR_WRAP]:"decr-wrap",[xh.INVERT]:"invert"},Mh={always:xh.ALWAYS,le:xh.LEQUAL,ge:xh.GEQUAL,lt:xh.LESS,gt:xh.GREATER,eq:xh.EQUAL,ne:xh.NOTEQUAL,never:xh.NEVER},$h={[xh.NONE]:null,[xh.ALWAYS]:"always",[xh.LEQUAL]:"le",[xh.GEQUAL]:"ge",[xh.LESS]:"lt",[xh.GREATER]:"gt",[xh.EQUAL]:"eq",[xh.NOTEQUAL]:"ne",[xh.NEVER]:"never"},Nh={repeat:xh.REPEAT,"mirrored-repeat":xh.MIRRORED_REPEAT,clamp:xh.CLAMP_TO_EDGE},Dh={[At.BOOL]:xh.BOOL,[At.BVEC2]:xh.BOOL_VEC2,[At.BVEC3]:xh.BOOL_VEC3,[At.BVEC4]:xh.BOOL_VEC4,[At.F32]:xh.FLOAT,[At.F32VEC2]:xh.FLOAT_VEC2,[At.F32VEC3]:xh.FLOAT_VEC3,[At.F32VEC4]:xh.FLOAT_VEC4,[At.I8]:xh.BYTE,[At.I16]:xh.SHORT,[At.I32]:xh.INT,[At.I32VEC2]:xh.INT_VEC2,[At.I32VEC3]:xh.INT_VEC3,[At.I32VEC4]:xh.INT_VEC4,[At.U8]:xh.UNSIGNED_BYTE,[At.U8_NORM]:xh.UNSIGNED_BYTE,[At.I8_NORM]:xh.BYTE,[At.U16]:xh.UNSIGNED_SHORT,[At.U16_NORM]:xh.UNSIGNED_SHORT,[At.I16_NORM]:xh.SHORT,[At.U32]:xh.UNSIGNED_INT,[At.U32VEC2]:xh.UNSIGNED_INT_VEC2,[At.U32VEC3]:xh.UNSIGNED_INT_VEC3,[At.U32VEC4]:xh.UNSIGNED_INT_VEC4},Ih={"triangle-list":xh.TRIANGLES,"triangle-strip":xh.TRIANGLE_STRIP,"triangle-fan":xh.TRIANGLE_FAN,"line-list":xh.LINES,"line-strip":xh.LINE_STRIP,"point-list":xh.POINTS},Lh={"2d":xh.TEXTURE_2D,"3d":xh.TEXTURE_3D,cube:xh.TEXTURE_CUBE_MAP,"2darray":xh.TEXTURE_2D_ARRAY},Fh={[d.PX]:xh.TEXTURE_CUBE_MAP_POSITIVE_X,[d.NX]:xh.TEXTURE_CUBE_MAP_NEGATIVE_X,[d.PY]:xh.TEXTURE_CUBE_MAP_POSITIVE_Y,[d.NY]:xh.TEXTURE_CUBE_MAP_NEGATIVE_Y,[d.PZ]:xh.TEXTURE_CUBE_MAP_POSITIVE_Z,[d.NZ]:xh.TEXTURE_CUBE_MAP_NEGATIVE_Z};function Ph(t){switch(t){case"nearest":return xh.NEAREST;case"linear":return xh.LINEAR;default:return xh.NONE}}function Bh(t,e){switch(t){case"nearest":switch(e){case"none":return xh.NEAREST;case"nearest":return xh.NEAREST_MIPMAP_NEAREST;case"linear":return xh.NEAREST_MIPMAP_LINEAR}break;case"linear":switch(e){case"none":return xh.LINEAR;case"nearest":return xh.LINEAR_MIPMAP_NEAREST;case"linear":return xh.LINEAR_MIPMAP_LINEAR}}return xh.NONE}let Oh=0;class Uh extends(e(Object)()){_device;_object;_uid;_cid;_name;_restoreHandler;constructor(t){var e;super(),this._device=t,this._object=null,this._uid=++Oh,this._cid=1,this._name=`${e=this,e.isTexture2D()?"texture_2d":e.isTexture2DArray()?"texture_2darray":e.isTexture3D()?"texture_3d":e.isTextureCube()?"texture_cube":e.isTextureVideo()?"texture_video":e.isBuffer()?"buffer":e.isFramebuffer()?"framebuffer":e.isProgram()?"program":e.isSampler()?"sampler":e.isVertexLayout()?"vbo":"unknown"}#${this._uid}`,this._restoreHandler=null,this._device.addGPUObject(this)}get device(){return this._device}get object(){return this._object}get disposed(){return!this._object}get restoreHandler(){return this._restoreHandler}set restoreHandler(t){this._restoreHandler=t}get uid(){return this._uid}get cid(){return this._cid}get name(){return this._name}set name(t){if(t!==this._name){const e=new bt(this,this._name);this._name=t,this._device.dispatchEvent(e)}}isVertexLayout(){return!1}isFramebuffer(){return!1}isSampler(){return!1}isTexture(){return!1}isTexture2D(){return!1}isTexture2DArray(){return!1}isTexture3D(){return!1}isTextureCube(){return!1}isTextureVideo(){return!1}isProgram(){return!1}isBuffer(){return!1}isBindGroup(){return!1}dispose(){this.disposed||this._device.disposeObject(this,!0)}async reload(){if(this.disposed){const t=this._device.restoreObject(this);return this._cid++,t}}destroy(){throw new Error("Abstract function call: destroy()")}async restore(){throw new Error("Abstract function call: restore()")}}class Vh extends Uh{_target;_memCost;_flags;_width;_height;_depth;_format;_mipLevelCount;_samplerOptions;_webgl1fallback;constructor(t,e){super(t),this._target=e||"2d",this._memCost=0,this._flags=0,this._width=0,this._height=0,this._depth=1,this._format="unknown",this._mipLevelCount=0,this._samplerOptions=null,this._webgl1fallback=!1}get target(){return this._target}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get mipLevelCount(){return this._mipLevelCount}get samplerOptions(){return this._samplerOptions}set samplerOptions(t){const e=this.getTextureCaps().getTextureFormatInfo(this._format);this._samplerOptions=t?Object.assign({},this._getSamplerOptions(e,!!t.compare),t):null}get isWebGL1Fallback(){return this._webgl1fallback}isFilterable(){return!!this.getTextureCaps().getTextureFormatInfo(this._format)?.filterable&&!!(this.device.isWebGL2||u(this._width)||u(this._height))}destroy(){this._object&&(this._device.context.deleteTexture(this._object),this._object=null,this._device.updateVideoMemoryCost(-this._memCost),this._memCost=0)}async restore(){this._object||this._device.isContextLost()||this.init()}isTexture(){return!0}getTextureCaps(){return this._device.getDeviceCaps().textureCaps}isSRGBFormat(){return t=this._format,!!(512&nt[t]);var t}isFloatFormat(){return ut(this._format)}isIntegerFormat(){return lt(this._format)}isSignedFormat(){return ct(this._format)}isCompressedFormat(){return dt(this._format)}isDepth(){return ht(this._format)}getDefaultSampler(t){const e=this.getTextureCaps().getTextureFormatInfo(this._format);return this._device.createSampler(this._samplerOptions&&!this._samplerOptions.compare==!t?this._samplerOptions:this._getSamplerOptions(e,t))}allocInternal(t,e,i,s,r){if(this._device.isWebGL2||u(e)&&u(i)?this._webgl1fallback=!1:(r=1,this._webgl1fallback=!0),this._device.setCurrentSamplerForTexture(this,null),0===r)r=this._calcMipLevelCount(t,e,i,s);else if(1!==r){let t=Math.max(e,i);this.isTexture3D()&&(t=Math.max(t,s));const a=Math.floor(Math.log2(t))+1;(!Number.isInteger(r)||r<0||r>a)&&(r=a)}if(this._object&&(this._format!==t||this._width!==e||this._height!==i||this._depth,this._mipLevelCount!==r)){const t=this._object;this._device.runNextFrame((()=>{this._device.context.deleteTexture(t)})),this._object=null}if(!this._object&&(this._format=t,this._width=e,this._height=i,this._depth=s,this._mipLevelCount=r,!this._device.isContextLost())){this._object=this._device.context.createTexture();const t=this._device.context;t.bindTexture(Lh[this._target],this._object);const e=this.getTextureCaps().getTextureFormatInfo(this._format);if(Th(t)&&!this.isTextureVideo())this.isTexture3D()||this.isTexture2DArray()?t.texStorage3D(Lh[this._target],this._mipLevelCount,e.glInternalFormat,this._width,this._height,this._depth):t.texStorage2D(Lh[this._target],this._mipLevelCount,e.glInternalFormat,this._width,this._height),this._device.context.texParameteri(Lh[this._target],xh.TEXTURE_BASE_LEVEL,0),this._device.context.texParameteri(Lh[this._target],xh.TEXTURE_MAX_LEVEL,this._mipLevelCount-1);else{let t=this._width,i=this._height;const s=dt(this._format),a=function(t){return(983040&nt[t])>>16}(this._format),n=function(t){return(15728640&nt[t])>>20}(this._format),o=pt(this._format);for(let h=0;h<r;h++){const r=s?new Uint8Array(Math.ceil(t/a)*Math.ceil(i/n)*o):null;if(r?.fill(255),this.isTextureCube())for(let a=0;a<6;a++){const n=Fh[a];s?this._device.context.compressedTexImage2D(n,h,e.glInternalFormat,t,i,0,r):this._device.context.texImage2D(n,h,e.glInternalFormat,t,i,0,e.glFormat,e.glType[0],null)}else s?this._device.context.compressedTexImage2D(Lh[this._target],h,e.glInternalFormat,t,i,0,r):this._device.context.texImage2D(Lh[this._target],h,e.glInternalFormat,t,i,0,e.glFormat,e.glType[0],null);t=Math.max(t>>1,1),i=Math.max(i>>1,1)}}const i=this.isTextureCube()?6:1,s=this.getTextureCaps().calcMemoryUsage(this._format,e.glType[0],this._width*this._height*this._depth*i);this._device.updateVideoMemoryCost(s-this._memCost),this._memCost=s}}_calcMipLevelCount(t,e,i,s){if(ht(t)||this.isTextureVideo())return 1;if(this._flags&bs.TF_NO_MIPMAP)return 1;if(!(this._device.isWebGL2||u(e)&&u(i)))return 1;const r=this.getTextureCaps().getTextureFormatInfo(t);if(!r||!r.renderable)return 1;let a=Math.max(e,i);return this.isTexture3D()&&(a=Math.max(a,s)),Math.floor(Math.log2(a))+1}_getSamplerOptions(t,e){const i=this.isDepth()&&e,s=t.filterable||i;return{addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:s?"linear":"nearest",minFilter:s?"linear":"nearest",mipFilter:this._mipLevelCount>1?s?"linear":"nearest":"none",compare:i?"le":null}}}class Gh extends Vh{constructor(t){super(t,"2d")}isTexture2D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._mipLevelCount)}update(t,e,i,s,r){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const a=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.context.bindTexture(Lh[this._target],this._object),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texSubImage2D(Lh[this._target],0,e,i,s,r,a.glFormat,a.glType[0],t),this._mipLevelCount>1&&this.generateMipmaps()}updateFromElement(t,e,i,s,r,a,n){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format);if(this._device.context.bindTexture(Lh[this._target],this._object),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===s&&0===r&&a===t.width&&n===t.height)this._device.context.texSubImage2D(Lh[this._target],0,e,i,o.glFormat,o.glType[0],t);else{const h=document.createElement("canvas");h.width=a,h.height=n;h.getContext("2d").drawImage(t,s,r,a,n,0,0,a,n),this._device.context.texSubImage2D(Lh[this._target],0,e,i,o.glFormat,o.glType[0],h),h.width=0,h.height=0}this._mipLevelCount>1&&this.generateMipmaps()}async readPixels(t,e,i,s,r,a,n){if(0!==r)throw new Error("Texture2D.readPixels(): parameter 'faceOrLayer' must be 0");if(a>=this.mipLevelCount||a<0)throw new Error(`Texture2D.readPixels(): invalid miplevel: ${a}`);if(!this.device.isContextLost()&&!this.disposed){const r=this._device.createFrameBuffer([this],null);r.setColorAttachmentMipLevel(0,a),r.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(r),await this._device.readPixels(0,t,e,i,s,n),this._device.popDeviceStates(),r.dispose()}}readPixelsToBuffer(t,e,i,s,r,a,n){if(0!==r)throw new Error("Texture2D.readPixelsToBuffer(): parameter 'faceOrLayer' must be 0");if(a>=this.mipLevelCount||a<0)throw new Error(`Texture2D.readPixelsToBuffer(): invalid miplevel: ${a}`);if(!this.device.isContextLost()&&!this.disposed){const r=this._device.createFrameBuffer([this],null);r.setColorAttachmentMipLevel(0,a),r.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(r),this._device.readPixelsToBuffer(0,t,e,i,s,n),this._device.popDeviceStates(),r.dispose()}}loadFromElement(t,e,i){if(this._flags=Number(i)||0,this._flags&bs.TF_WRITABLE)console.error(new Error("webgl device does not support storage texture"));else{const i=e?"rgba8unorm-srgb":"rgba8unorm";this.loadImage(t,i)}}createEmpty(t,e,i,s){this._flags=Number(s)||0,this._flags&bs.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,i,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Lh[this._target];this._device.context.bindTexture(t,this._object),this._device.context.generateMipmap(t)}}createWithMipmapData(t,e,i){t.isCubemap||t.isVolume?console.error("loading 2d texture with mipmap data failed: data is not 2d texture"):(this._flags=Number(i)||0,this._flags&bs.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadLevels(t,e))}loadEmpty(t,e,i,s){this.allocInternal(t,e,i,1,s),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(t,e){let i=e?ot(t.format):t.format,s=!1;"bgra8unorm"===i?(i="rgba8unorm",s=!0):"bgra8unorm-srgb"===i&&(i="rgba8unorm-srgb",s=!0);const r=t.width,a=t.height,n=t.mipLevels;if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(i,r,a,1,n),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format),i=Lh[this._target];this._device.context.bindTexture(i,this._object),this.device.clearErrors();for(let r=0;r<this._mipLevelCount;r++){if(t.isCompressed)this._device.context.compressedTexSubImage2D(i,r,0,0,t.mipDatas[0][r].width,t.mipDatas[0][r].height,e.glInternalFormat,t.mipDatas[0][r].data);else{if(s)for(let e=0;e<t.mipDatas[0][r].width*t.mipDatas[0][r].height;e++){const i=t.mipDatas[0][r].data[4*e];t.mipDatas[0][r].data[4*e]=t.mipDatas[0][r].data[4*e+2],t.mipDatas[0][r].data[4*e+2]=i}this._device.context.texSubImage2D(i,r,0,0,t.mipDatas[0][r].width,t.mipDatas[0][r].height,e.glFormat,e.glType[0],t.mipDatas[0][r].data)}const a=this.device.getError();if(a)return void console.error(a)}}}else console.warn("No s3tc compression format support")}loadImage(t,e){if(this.allocInternal(e,Number(t.width),Number(t.height),1,0),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format);this.device.clearErrors();const i=Lh[this._target];this._device.context.bindTexture(i,this._object),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,4),this._device.context.texSubImage2D(i,0,0,0,e.glFormat,e.glType[0],t);const s=this.device.getError();s&&console.error(s),this._mipLevelCount>1&&this.generateMipmaps()}}}class zh extends Vh{constructor(t){if(!t.isWebGL2)throw new Error("device does not support 2d texture array");super(t,"2darray")}isTexture2DArray(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(t,e,i,s,r,a,n){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format),h=this._device.context;h.bindTexture(Lh[this._target],this._object),h.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),h.texSubImage3D(Lh[this._target],0,e,i,s,r,a,n,o.glFormat,o.glType[0],t),this._mipLevelCount>1&&this.generateMipmaps()}createWithMipmapData(t,e){t.arraySize?(this._flags=Number(e)||0,this._flags&bs.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(t)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}loadLevels(t){const e=t.format,i=t.width,s=t.height,r=1!==t.mipLevels||this._flags&bs.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,i,s,1);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(e,i,s,t.arraySize,r),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format),i=this._device.context;i.bindTexture(Lh[this._target],this._object),this.device.clearErrors();for(let s=0;s<t.arraySize;s++){if(t.mipDatas[s].length!==t.mipLevels)return void console.log("Texture2DArray.loadLevels() failed: Invalid texture data");for(let r=0;r<t.mipLevels;r++){t.isCompressed?i.compressedTexSubImage3D(i.TEXTURE_2D_ARRAY,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glInternalFormat,t.mipDatas[s][r].data):i.texSubImage3D(i.TEXTURE_2D_ARRAY,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glFormat,e.glType[0],t.mipDatas[s][r].data);const a=this.device.getError();if(a)return void console.error(a)}}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture2DArray.loadLevels(): No s3tc compression format support")}updateFromElement(t,e,i,s,r,a,n,o){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const h=this.getTextureCaps().getTextureFormatInfo(this._format),u=this._device.context;if(u.bindTexture(Lh[this._target],this._object),u.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===r&&0===a&&n===t.width&&o===t.height)u.texSubImage3D(Lh[this._target],0,e,i,s,n,o,1,h.glFormat,h.glType[0],t);else{const l=document.createElement("canvas");l.width=n,l.height=o;l.getContext("2d").drawImage(t,r,a,n,o,0,0,n,o),u.texSubImage3D(Lh[this._target],0,e,i,s,n,o,1,h.glFormat,h.glType[0],l),l.width=0,l.height=0}this._mipLevelCount>1&&this.generateMipmaps()}createEmpty(t,e,i,s,r){this._flags=Number(r)||0,this._flags&bs.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,i,s,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Lh[this._target];this._device.context.bindTexture(t,this._object),this._device.context.generateMipmap(t)}}readPixels(t,e,i,s,r,a,n){if(r<0||r>=this._depth)throw new Error(`Texture2DArray.readPixels(): invalid layer: ${r}`);if(a<0||a>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixels(): invalid miplevel: ${a}`);return new Promise((o=>{const h=this._device.createFrameBuffer([this],null);h.setColorAttachmentLayer(0,r),h.setColorAttachmentMipLevel(0,a),h.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(h),this._device.readPixels(0,t,e,i,s,n).then((()=>{h.dispose(),o()})),this._device.popDeviceStates()}))}readPixelsToBuffer(t,e,i,s,r,a,n){if(r<0||r>=this._depth)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid layer: ${r}`);if(a<0||a>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid miplevel: ${a}`);const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentLayer(0,r),o.setColorAttachmentMipLevel(0,a),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,t,e,i,s,n),this._device.popDeviceStates(),o.dispose()}loadEmpty(t,e,i,s,r){this.allocInternal(t,e,i,s,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}}class kh extends Vh{constructor(t){if(!t.isWebGL2)throw new Error("device does not support 3D texture");super(t,"3d")}get depth(){return this._depth}isTexture3D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(t,e,i,s,r,a,n){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format),h=this._device.context;h.bindTexture(Lh[this._target],this._object),h.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),h.texSubImage3D(Lh[this._target],0,e,i,s,r,a,n,o.glFormat,o.glType[0],t)}createEmpty(t,e,i,s,r){this._flags=Number(r)||0,this._flags&bs.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,i,s,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Lh[this._target];this._device.context.bindTexture(t,this._object),this._device.context.generateMipmap(t)}}readPixels(t,e,i,s,r,a,n){if(0!==a)throw new Error("Texture3D.readPixels(): parameter mipLevel must be 0");return new Promise((a=>{const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentLayer(0,r),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixels(0,t,e,i,s,n).then((()=>{o.dispose(),a()})),this._device.popDeviceStates()}))}readPixelsToBuffer(t,e,i,s,r,a,n){if(0!==a)throw new Error("Texture3D.readPixelsToBuffer(): parameter mipLevel must be 0");const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentLayer(0,r),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,t,e,i,s,n),this._device.popDeviceStates(),o.dispose()}createWithMipmapData(t,e){t.arraySize?(this._flags=Number(e)||0,this._flags&bs.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(t)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}loadLevels(t){const e=t.format,i=t.width,s=t.height,r=t.depth,a=1!==t.mipLevels||this._flags&bs.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,i,s,r);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(e,i,s,t.arraySize,a),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format),i=this._device.context;i.bindTexture(Lh[this._target],this._object),this.device.clearErrors();for(let s=0;s<r;s++){if(t.mipDatas[s].length!==t.mipLevels)return void console.log("Texture2DArray.loadLevels() failed: Invalid texture data");for(let r=0;r<t.mipLevels;r++){t.isCompressed?i.compressedTexSubImage3D(i.TEXTURE_3D,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glInternalFormat,t.mipDatas[s][r].data):i.texSubImage3D(i.TEXTURE_3D,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glFormat,e.glType[0],t.mipDatas[s][r].data);const a=this.device.getError();if(a)return void console.error(a)}}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture2DArray.loadLevels(): No s3tc compression format support")}loadEmpty(t,e,i,s,r){this.allocInternal(t,e,i,s,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}}class Xh extends Vh{constructor(t){super(t,"cube")}init(){this.loadEmpty(this._format,this._width,this._mipLevelCount)}update(t,e,i,s,r,a){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const n=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.context.bindTexture(Lh[this._target],this._object),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texSubImage2D(Fh[a],0,e,i,s,r,n.glFormat,n.glType[0],t),this._mipLevelCount>1&&this.generateMipmaps()}updateFromElement(t,e,i,s,r,a,n,o){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const h=this.getTextureCaps().getTextureFormatInfo(this._format);if(this._device.context.bindTexture(Lh[this._target],this._object),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===r&&0===a&&n===t.width&&o===t.height)this._device.context.texSubImage2D(Fh[s],0,e,i,h.glFormat,h.glType[0],t);else{const s=document.createElement("canvas");s.width=n,s.height=o;s.getContext("2d").drawImage(t,r,a,n,o,0,0,n,o),this._device.context.texSubImage2D(Lh[this._target],0,e,i,h.glFormat,h.glType[0],s),s.width=0,s.height=0}this._mipLevelCount>1&&this.generateMipmaps()}createEmpty(t,e,i){this._flags=Number(i)||0,this._flags&bs.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,0)}readPixels(t,e,i,s,r,a,n){if(a<0||a>=this.mipLevelCount)throw new Error(`TextureCube.readPixels(): invalid miplevel: ${a}`);return new Promise((o=>{const h=this._device.createFrameBuffer([this],null);h.setColorAttachmentCubeFace(0,r),h.setColorAttachmentMipLevel(0,a),h.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(h),this._device.readPixels(0,t,e,i,s,n).then((()=>{h.dispose(),o()})),this._device.popDeviceStates()}))}readPixelsToBuffer(t,e,i,s,r,a,n){if(a<0||a>=this.mipLevelCount)throw new Error(`TextureCube.readPixels(): invalid miplevel: ${a}`);const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentCubeFace(0,r),o.setColorAttachmentMipLevel(0,a),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,t,e,i,s,n),this._device.popDeviceStates(),o.dispose()}isTextureCube(){return!0}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Lh[this._target];this._device.context.bindTexture(t,this._object),this._device.context.generateMipmap(t)}}createWithMipmapData(t,e,i){t.isCubemap?(this._flags=Number(i)||0,this._flags&bs.TF_WRITABLE?console.error("webgl device does not support storage texture"):this.loadLevels(t,e)):console.error("loading cubmap with mipmap data failed: data is not cubemap")}loadEmpty(t,e,i){this.allocInternal(t,e,e,1,i),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadImages(t,e){const i=t[0].width,s=t[0].height;if(6===t.length){for(let e=1;e<6;e++)if(t[e].width!==i||t[e].height!==s)return void console.error(new Error("cubemap face images must have identical sizes"));if(0!==i&&0!==s&&(this.allocInternal(e,i,s,1,0),!this._device.isContextLost())){this.device.clearErrors(),this._device.context.bindTexture(Lh[this._target],this._object);const e=this.getTextureCaps().getTextureFormatInfo(this._format);for(let i=0;i<6;i++){this._device.context.texSubImage2D(Fh[i],0,0,0,e.glFormat,e.glType[0],t[i]);const s=this.device.getError();if(s)return void console.error(s)}this._mipLevelCount>1&&this.generateMipmaps()}}else console.error(new Error("cubemap face list must have 6 images"))}loadLevels(t,e){const i=e?ot(t.format):t.format,s=t.width,r=t.height,a=t.mipLevels;if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(i,s,r,1,a),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.context.bindTexture(Lh[this._target],this._object),this.device.clearErrors();for(let i=0;i<6;i++){const s=Fh[i];if(this._mipLevelCount>1&&t.mipDatas[i].length!==this._mipLevelCount)return void console.log("invalid texture data");for(let r=0;r<this._mipLevelCount;r++){t.isCompressed?this._device.context.compressedTexSubImage2D(s,r,0,0,t.mipDatas[i][r].width,t.mipDatas[i][r].height,e.glInternalFormat,t.mipDatas[i][r].data):this._device.context.texSubImage2D(s,r,0,0,t.mipDatas[i][r].width,t.mipDatas[i][r].height,e.glFormat,e.glType[0],t.mipDatas[i][r].data);const a=this.device.getError();if(a)return void console.error(a)}}}}else console.warn("No s3tc compression format support")}}class Wh extends Vh{_source;_callbackId;constructor(t,e){super(t,"2d"),this._source=null,this._callbackId=null,this._format="unknown",this.loadFromElement(e)}isTextureVideo(){return!0}get source(){return this._source}destroy(){this._source&&null!==this._callbackId&&this._source.cancelVideoFrameCallback(this._callbackId),super.destroy()}init(){this.loadElement(this._source)}loadFromElement(t){this._flags=bs.TF_NO_MIPMAP,this.loadElement(t)}generateMipmaps(){}readPixels(t,e,i,s,r,a,n){throw new Error("Video texture does not support readPixels()")}readPixelsToBuffer(t,e,i,s,r,a,n){throw new Error("Video texture does not support readPixelsToBuffer()")}updateVideoFrame(){return!(!(this.object&&this._source.currentTime>0)||this._source.requestVideoFrameCallback)&&(this.update(),!0)}update(){if(this.allocInternal("rgba8unorm",this._source.videoWidth,this._source.videoHeight,1,1),!this._device.isContextLost()){const t=Lh[this._target],e=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.context.bindTexture(t,this._object),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texImage2D(t,0,e.glInternalFormat,e.glFormat,e.glType[0],this._source)}}loadElement(t){if(this._source&&null!==this._callbackId&&(this._source.cancelVideoFrameCallback(this._callbackId),this._callbackId=null),this._source=t,this._source?.requestVideoFrameCallback){const t=this;t._callbackId=this._source.requestVideoFrameCallback((function e(){t._object&&(t.update(),t._callbackId=t._source.requestVideoFrameCallback(e))}))}this.allocInternal("rgba8unorm",Math.max(this._source.videoWidth,1),Math.max(this._source.videoHeight,1),1,1)}}class Hh extends Uh{_vertexData;_dirty;constructor(t,e){super(t),this._vertexData=new Ms,this._dirty=!1;for(const t of e.vertexBuffers)this._vertexData.setVertexBuffer(t.buffer,t.stepMode);e.indexBuffer&&this._vertexData.setIndexBuffer(e.indexBuffer),this.load()}destroy(){this._object&&this._device.vaoExt&&this._device.vaoExt.deleteVertexArray(this._object),this._object=null}async restore(){this._device.isContextLost()||this.load()}get vertexBuffers(){return this._vertexData.vertexBuffers}get indexBuffer(){return this._vertexData.indexBuffer}setDrawOffset(t,e){for(const i of this._vertexData.vertexBuffers)i?.buffer===t&&i.drawOffset!==e&&(i.drawOffset=e,this._dirty=!0)}getVertexBuffer(t){return this._vertexData.getVertexBuffer(t)}getVertexBufferInfo(t){return this._vertexData.getVertexBufferInfo(t)}getIndexBuffer(){return this._vertexData.getIndexBuffer()}bind(){this._object&&this._device.vaoExt?(this._device.vaoExt.bindVertexArray(this._object),this._dirty&&(this._dirty=!1,this.bindBuffers())):this.bindBuffers()}draw(t,e,i){this._device.setVertexLayout(this),this._device.draw(t,e,i)}drawInstanced(t,e,i,s){this._device.setVertexLayout(this),this._device.drawInstanced(t,e,i,s)}isVertexLayout(){return!0}load(){this._device.isContextLost()||(this._device.vaoExt?this._object||(this._object=this._device.vaoExt.createVertexArray(),this._device.vaoExt.bindVertexArray(this._object),this.bindBuffers(),this._device.vaoExt.bindVertexArray(null)):this._object={})}bindBuffers(){const t=this._vertexData.vertexBuffers,e=this._device.context;for(let i=0;i<t.length;i++){const s=t[i],r=s?.buffer;r?(r.disposed&&r.reload(),e.bindBuffer(xh.ARRAY_BUFFER,r.object),e.enableVertexAttribArray(i),"instance"===s.stepMode&&this._device.instancedArraysExt?(e.vertexAttribPointer(i,s.type.cols,Dh[s.type.scalarType],s.type.normalized,s.stride,s.offset),this._device.instancedArraysExt.vertexAttribDivisor(i,1)):e.vertexAttribPointer(i,s.type.cols,Dh[s.type.scalarType],s.type.normalized,s.stride,s.drawOffset+s.offset)):e.disableVertexAttribArray(i)}this._vertexData.indexBuffer?.disposed&&this._vertexData.indexBuffer.reload(),e.bindBuffer(xh.ELEMENT_ARRAY_BUFFER,this._vertexData.indexBuffer?this._vertexData.indexBuffer.object:null)}}class Yh extends Uh{_size;_usage;_systemMemoryBuffer;_systemMemory;_memCost;constructor(t,e,i,s=!1){if(super(t),e&bs.BF_VERTEX&&e&bs.BF_INDEX)throw new Error("buffer usage must not have Vertex and Index simultaneously");if(!(t.isWebGL2||e&bs.BF_VERTEX||e&bs.BF_INDEX||e&bs.BF_UNIFORM))throw new Error("no Vertex or Index or Uniform usage set when creating buffer");if(t.isWebGL2&&!(e&~bs.DYNAMIC))throw new Error("buffer usage not set when creating buffer");if(e&bs.DYNAMIC&&e&bs.MANAGED)throw new Error("buffer usage DYNAMIC and MANAGED can not be both set");if(this._object=null,this._memCost=0,this._usage=e,this._size="number"==typeof i?i:i.byteLength,this._size<=0)throw new Error("can not create buffer with zero size");this._systemMemory=!!s,this._systemMemory||this._usage&bs.MANAGED?(this._systemMemoryBuffer=new Uint8Array(this._size),i&&"number"!=typeof i&&this._systemMemoryBuffer.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength))):this._systemMemoryBuffer=null,this._systemMemory||this.load(this._systemMemoryBuffer||("number"==typeof i?null:i))}get byteLength(){return this._size}get systemMemoryBuffer(){return this._systemMemoryBuffer?.buffer||null}get usage(){return this._usage}bufferSubData(t,e,i,s){if(i=Number(i)||0,t=Number(t)||0,i+(s=Number(s)||e.length-i)>e.length)throw new Error("bufferSubData() failed: source buffer is too small");if(t+s*e.BYTES_PER_ELEMENT>this.byteLength)throw new Error("bufferSubData() failed: dest buffer is too small");if((this._systemMemory||this._usage&bs.MANAGED)&&this._systemMemoryBuffer.set(new Uint8Array(e.buffer,e.byteOffset+i*e.BYTES_PER_ELEMENT,s*e.BYTES_PER_ELEMENT),t),!this._systemMemory&&!this.device.isContextLost()){let r;if(this.disposed&&this.reload(),this._device.isWebGL2||0===i&&s===e.length||(e=e.subarray(i,i+s)),this._device.vaoExt?.bindVertexArray(null),this._usage&bs.BF_INDEX)r=xh.ELEMENT_ARRAY_BUFFER;else if(this._usage&bs.BF_VERTEX)r=xh.ARRAY_BUFFER;else if(this._usage&bs.BF_UNIFORM)r=xh.UNIFORM_BUFFER;else{if(!(this._usage&(bs.BF_READ|bs.BF_WRITE)))throw new Error("Invalid buffer usage");r=xh.COPY_WRITE_BUFFER}this._device.context.bindBuffer(r,this._object),this._device.isWebGL2?this._device.context.bufferSubData(r,t,e,i,s):this._device.context.bufferSubData(r,t,e)}}async getBufferSubData(t,e,i){return this.disposed&&this.reload(),this._getBufferData(t,e,i)}async _getBufferData(t,e,i){if(e=Number(e)||0,i=Number(i)||this.byteLength-e,e<0||e+i>this.byteLength)throw new Error("data query range out of bounds");if(t&&t.byteLength<i)throw new Error("no enough space for querying buffer data");if(t=t||new Uint8Array(i),this._systemMemoryBuffer)t.set(new Uint8Array(this._systemMemoryBuffer,e,i));else{const s=this._device.context;if(Th(s)){const t=s.fenceSync(xh.SYNC_GPU_COMMANDS_COMPLETE,0);s.flush(),await this.clientWaitAsync(s,t,0,10),s.deleteSync(t)}let r;if(this._device.vaoExt?.bindVertexArray(null),this._usage&bs.BF_INDEX)r=xh.ELEMENT_ARRAY_BUFFER;else if(this._usage&bs.BF_VERTEX)r=xh.ARRAY_BUFFER;else if(this._usage&bs.BF_UNIFORM)r=xh.UNIFORM_BUFFER;else{if(!(this._usage&(bs.BF_READ|bs.BF_WRITE)))throw new Error("Invalid buffer usage");r=xh.COPY_READ_BUFFER}s.bindBuffer(r,this._object),s.getBufferSubData(r,e,t,0,i),s.bindBuffer(r,null)}return t}async restore(){this._systemMemory||this._object||this._device.isContextLost()||this.load(this._systemMemoryBuffer)}destroy(){!this._systemMemory&&this._object&&(this._device.context.deleteBuffer(this._object),this._object=null,this._device.updateVideoMemoryCost(-this._memCost),this._memCost=0)}isBuffer(){return!0}load(t){if(!this._device.isContextLost()){this._object||(this._object=this._device.context.createBuffer()),this._device.vaoExt?.bindVertexArray(null);let e,i=this._usage&bs.DYNAMIC?xh.DYNAMIC_DRAW:xh.STATIC_DRAW;if(this._usage&bs.BF_INDEX)e=xh.ELEMENT_ARRAY_BUFFER;else if(this._usage&bs.BF_VERTEX)e=xh.ARRAY_BUFFER;else if(this._usage&bs.BF_UNIFORM)e=xh.UNIFORM_BUFFER;else if(this._usage&bs.BF_READ)e=xh.COPY_READ_BUFFER,i=xh.STREAM_READ;else{if(!(this._usage&bs.BF_WRITE))throw new Error(`WebGLGPUBuffer.load() failed: invalid buffer usage: ${this._usage}`);e=xh.COPY_WRITE_BUFFER}this._device.context.bindBuffer(e,this._object),t?this._device.context.bufferData(e,t,i):this._device.context.bufferData(e,this._size+15&-16,i)}this._device.updateVideoMemoryCost(this._size-this._memCost),this._memCost=this._size}async clientWaitAsync(t,e,i,s){return new Promise(((r,a)=>{!function n(){const o=t.clientWaitSync(e,i,0);o!=t.WAIT_FAILED?o!=t.TIMEOUT_EXPIRED?r():setTimeout(n,s):a()}()}))}}const qh=Xt.getCachedTypeInfo(At.U16),jh=Xt.getCachedTypeInfo(At.U32);class Zh extends Yh{indexType;length;constructor(t,e,i){if(!(e instanceof Uint16Array||e instanceof Uint32Array))throw new Error("invalid index data");super(t,bs.BF_INDEX|i,e),this.indexType=e instanceof Uint16Array?qh:jh,this.length=e.length}}class Kh extends Uh{_options;_needBindBuffers;_drawTags;_lastDrawTag;_status;_statusAA;_width;_height;_isMRT;_drawBuffers;_depthAttachmentTarget;_colorAttachmentsAA;_depthAttachmentAA;_intermediateAttachments;_framebufferAA;constructor(t,e,i,s){if(super(t),e.length>0&&e.findIndex((t=>!t))>=0)throw new Error("WebGLFramebuffer(): invalid color attachments");if(this._object=null,this._framebufferAA=null,this._colorAttachmentsAA=null,this._depthAttachmentAA=null,this._intermediateAttachments=null,this._needBindBuffers=!1,this._drawTags=0,this._lastDrawTag=-1,this._status=0,this._statusAA=0,this._options={colorAttachments:e?.length>0?e.map((t=>({texture:t,face:0,layer:0,level:0,generateMipmaps:!0}))):null,depthAttachment:i?{texture:i,face:0,layer:0,level:0,generateMipmaps:!1}:null,sampleCount:"webgl"===t.type?1:s?.sampleCount??1,ignoreDepthStencil:s?.ignoreDepthStencil??!1},!this._options.colorAttachments&&!this._options.depthAttachment)throw new Error("WebGLFramebuffer(): colorAttachments or depthAttachment must be specified");if(this._width=this._options.colorAttachments?this._options.colorAttachments[0].texture.width:this._options.depthAttachment.texture.width,this._height=this._options.colorAttachments?this._options.colorAttachments[0].texture.height:this._options.depthAttachment.texture.height,this._options.colorAttachments&&this._options.colorAttachments.findIndex((t=>t.texture.width!==this._width||t.texture.height!==this._height))>=0||this._options.depthAttachment&&(this._options.depthAttachment.texture.width!==this._width||this._options.depthAttachment.texture.height!==this._height))throw new Error("WebGLFramebuffer(): attachment textures must have same width and height");if(this._drawBuffers=this._options.colorAttachments?.map(((t,e)=>xh.COLOR_ATTACHMENT0+e))??[],this._isMRT=this._drawBuffers.length>1,this._options.depthAttachment){const t=this._options.depthAttachment.texture.format;this._depthAttachmentTarget=function(t){return!!(32&nt[t])}(t)?xh.DEPTH_STENCIL_ATTACHMENT:xh.DEPTH_ATTACHMENT}else this._depthAttachmentTarget=xh.NONE;this._init()}tagDraw(){this._drawTags++}isMRT(){return this._isMRT}getWidth(){const t=this._options.colorAttachments?.[0]??this._options.depthAttachment;return Math.max(t.texture.width>>t.level,1)}getHeight(){const t=this._options.colorAttachments?.[0]??this._options.depthAttachment;return Math.max(t.texture.height>>t.level,1)}async restore(){if(!this._object&&!this._device.isContextLost()&&(this._options?.depthAttachment?.texture?.disposed&&await this._options.depthAttachment.texture.reload(),this._options?.colorAttachments))for(const t of this._options.colorAttachments)t?.texture?.disposed&&await t.texture.reload();this._init()}destroy(){if(this._object){if(this._device.context.deleteFramebuffer(this._object),this._object=null,this._colorAttachmentsAA){for(const t of this._colorAttachmentsAA)this._device.context.deleteRenderbuffer(t);this._colorAttachmentsAA=null}if(this._depthAttachmentAA&&(this._device.context.deleteRenderbuffer(this._depthAttachmentAA),this._depthAttachmentAA=null),this._framebufferAA&&(this._device.context.deleteFramebuffer(this._framebufferAA),this._framebufferAA=null),this._intermediateAttachments){for(const t of this._intermediateAttachments)for(const e of t[1])e&&this._device.context.deleteTexture(e.texture);this._intermediateAttachments=null}}}setColorAttachmentGenerateMipmaps(t,e){const i=this._options.colorAttachments?.[t];i&&(i.generateMipmaps=!!e)}setColorAttachmentCubeFace(t,e){const i=this._options.colorAttachments?.[t];i&&i.face!==e&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),i.face=e,this.bind()):i.face=e)}setColorAttachmentMipLevel(t,e){const i=this._options.colorAttachments?.[t];i&&i.level!==e&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),i.level=e,this.bind()):i.level=e)}setColorAttachmentLayer(t,e){const i=this._options.colorAttachments?.[t];i&&i.layer!==e&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),i.layer=e,this.bind()):i.layer=e)}setDepthAttachmentCubeFace(t){const e=this._options.depthAttachment;e&&e.face!==t&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),e.face=t,this.bind()):e.face=t)}setDepthAttachmentLayer(t){const e=this._options.depthAttachment;e&&e.layer!==t&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),e.layer=t,this.bind()):e.layer=t)}getDepthAttachment(){return this._options?.depthAttachment?.texture||null}getColorAttachments(){return this._options.colorAttachments?.map((t=>t.texture||null))||[]}bind(){if(this._object){if(this._device.context._currentFramebuffer=this,this._lastDrawTag=-1,this._needBindBuffers&&(this._needBindBuffers=!1,!this._bindBuffersAA()||!this._bindBuffers()))return this._device.context.bindFramebuffer(xh.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null,!1;this._device.context.bindFramebuffer(xh.FRAMEBUFFER,this._framebufferAA||this._object);const t=this._device.drawBuffersExt;return t?t.drawBuffers(this._drawBuffers):this._isMRT&&console.error("device does not support multiple framebuffer color attachments"),this._device.setViewport(null),this._device.setScissor(null),!0}return!1}unbind(){if(this._device.context._currentFramebuffer===this){this._updateMSAABuffer(),this._device.context.bindFramebuffer(xh.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null,this._device.setViewport(),this._device.setScissor();const t=this._device.drawBuffersExt;if(t&&t.drawBuffers([xh.BACK]),this._options.colorAttachments)for(const t of this._options.colorAttachments){const e=t.texture;if(t.level>0){const i=this._intermediateAttachments?.get(e)?.[t.level];if(i){const s=this._device.context.createFramebuffer();this._device.context.bindFramebuffer(xh.FRAMEBUFFER,s),this._device.context.framebufferTexture2D(xh.FRAMEBUFFER,xh.COLOR_ATTACHMENT0,xh.TEXTURE_2D,i.texture,0),e.isTexture2D()?(this._device.context.bindTexture(xh.TEXTURE_2D,e.object),this._device.context.copyTexSubImage2D(xh.TEXTURE_2D,t.level,0,0,0,0,i.width,i.height)):e.isTextureCube()&&(this._device.context.bindTexture(xh.TEXTURE_CUBE_MAP,e.object),this._device.context.copyTexSubImage2D(Fh[t.face??d.PX],t.level,0,0,0,0,i.width,i.height)),this._device.context.bindFramebuffer(xh.FRAMEBUFFER,null),this._device.context.deleteFramebuffer(s)}}t.generateMipmaps&&e.mipLevelCount>1&&e.generateMipmaps()}}}_updateMSAABuffer(){if(this._options.sampleCount>1&&this._lastDrawTag!==this._drawTags){const t=this._device.context;t.bindFramebuffer(xh.READ_FRAMEBUFFER,this._framebufferAA),t.bindFramebuffer(xh.DRAW_FRAMEBUFFER,this._object);let e=0;this._options.ignoreDepthStencil||this._depthAttachmentTarget===xh.NONE||(e=xh.DEPTH_BUFFER_BIT|(this._depthAttachmentTarget===xh.DEPTH_STENCIL_ATTACHMENT?xh.STENCIL_BUFFER_BIT:0));for(let i=0;i<this._drawBuffers.length;i++){for(let t=0;t<this._drawBuffers.length;t++)this._drawBuffers[t]=t===i?xh.COLOR_ATTACHMENT0+i:xh.NONE;t.readBuffer(this._drawBuffers[i]),t.drawBuffers(this._drawBuffers),t.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,xh.COLOR_BUFFER_BIT|e,xh.NEAREST),e=0}0!==e&&t.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,e,xh.NEAREST);for(let t=0;t<this._drawBuffers.length;t++)this._drawBuffers[t]=xh.COLOR_ATTACHMENT0+t;t.bindFramebuffer(xh.READ_FRAMEBUFFER,null),t.bindFramebuffer(xh.DRAW_FRAMEBUFFER,null),this._lastDrawTag=this._drawTags}}_load(){if(!this._device.isContextLost()){do{if(this._options.sampleCount>1&&(this._framebufferAA=this._device.context.createFramebuffer(),this._colorAttachmentsAA=[],this._depthAttachmentAA=null,!this._bindBuffersAA())){this.dispose();break}this._object=this._device.context.createFramebuffer(),this._device.context.bindFramebuffer(xh.FRAMEBUFFER,this._object),this._bindBuffers()||this.dispose()}while(0);this._lastDrawTag=-1,this._device.context.bindFramebuffer(xh.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null}}_bindAttachment(t,e){if(e.texture){let i=null;if("webgl"===this.device.type&&e.level>0){this._intermediateAttachments||(this._intermediateAttachments=new Map);let t=this._intermediateAttachments.get(e.texture);if(t||(t=[],this._intermediateAttachments.set(e.texture,t)),t[e.level])i=t[e.level].texture;else{let s=e.texture.width,r=e.texture.height,a=e.level;for(;a-- >0;)s=Math.max(s>>1,1),r=Math.max(r>>1,1);const n=this.device.getDeviceCaps().textureCaps.getTextureFormatInfo(e.texture.format);i=this._device.context.createTexture(),this._device.context.bindTexture(xh.TEXTURE_2D,i),this._device.context.texImage2D(xh.TEXTURE_2D,0,n.glInternalFormat,s,r,0,n.glFormat,n.glType[0],null),t[e.level]={texture:i,width:s,height:r}}}if(i)this._device.context.framebufferTexture2D(xh.FRAMEBUFFER,t,xh.TEXTURE_2D,i,0);else if(e.texture.isTexture2D())i?this._device.context.framebufferRenderbuffer(xh.FRAMEBUFFER,t,xh.RENDERBUFFER,i):this._device.context.framebufferTexture2D(xh.FRAMEBUFFER,t,xh.TEXTURE_2D,e.texture.object,e.level??0);else if(e.texture.isTextureCube())this._device.context.framebufferTexture2D(xh.FRAMEBUFFER,t,Fh[e.face??d.PX],e.texture.object,e.level??0);else{if(!e.texture.isTexture2DArray()&&!e.texture.isTexture3D())return!1;this._device.context.framebufferTextureLayer(xh.FRAMEBUFFER,t,e.texture.object,e.level??0,e.layer??0)}return!0}return!1}_bindBuffers(){if(!this._object)return!1;if(this._device.context.bindFramebuffer(xh.FRAMEBUFFER,this._object),this._depthAttachmentTarget!==xh.NONE&&!this._bindAttachment(this._depthAttachmentTarget,this._options.depthAttachment))return!1;for(let t=0;t<this._options.colorAttachments?.length;t++){const e=this._options.colorAttachments[t];if(e.texture&&!this._bindAttachment(xh.COLOR_ATTACHMENT0+t,e))return!1}if(0===this._status){const t=this._device.context.checkFramebufferStatus(xh.FRAMEBUFFER);t!==xh.FRAMEBUFFER_COMPLETE?(console.error(`Framebuffer not complete: ${t}`),this._status=2):this._status=1}return 1===this._status}_createRenderbufferAA(t){const e=this._device.context.createRenderbuffer(),i=this.device.getDeviceCaps().textureCaps.getTextureFormatInfo(t.format);return this._device.context.bindRenderbuffer(xh.RENDERBUFFER,e),this._device.context.renderbufferStorageMultisample(xh.RENDERBUFFER,this._options.sampleCount,i.glInternalFormat,this._options.depthAttachment.texture.width,this._options.depthAttachment.texture.height),e}_bindBuffersAA(){if(!this._framebufferAA)return!0;this._device.context.bindFramebuffer(xh.FRAMEBUFFER,this._framebufferAA),this._depthAttachmentTarget!==xh.NONE&&(this._depthAttachmentAA||(this._depthAttachmentAA=this._createRenderbufferAA(this._options.depthAttachment.texture)),this._device.context.framebufferRenderbuffer(xh.FRAMEBUFFER,this._depthAttachmentTarget,xh.RENDERBUFFER,this._depthAttachmentAA));for(let t=0;t<this._options.colorAttachments?.length;t++){this._options.colorAttachments[t].texture&&(this._colorAttachmentsAA[t]||(this._colorAttachmentsAA[t]=this._createRenderbufferAA(this._options.colorAttachments[t].texture)),this._device.context.framebufferRenderbuffer(xh.FRAMEBUFFER,xh.COLOR_ATTACHMENT0+t,xh.RENDERBUFFER,this._colorAttachmentsAA[t]))}if(0===this._statusAA){const t=this._device.context.checkFramebufferStatus(xh.FRAMEBUFFER);t!==xh.FRAMEBUFFER_COMPLETE?(console.error(`Framebuffer not complete: ${t}`),this._statusAA=2):this._statusAA=1}return 1===this._statusAA}_init(){if(1!==this._options.sampleCount&&4!==this._options.sampleCount)throw new Error(`WebGLFramebuffer(): Sample should be 1 or 4, got ${this._options.sampleCount}`);if(this._options.sampleCount>1&&!this._device.getDeviceCaps().framebufferCaps.supportMultisampledFramebuffer)throw new Error("WebGLFramebuffer(): Multisampled frame buffer not supported");this._load()}isFramebuffer(){return!0}getSampleCount(){return this._options.sampleCount}}class Qh{static _defaultState;static _currentState;apply(t,e){const i=this.constructor;(e||i._currentState!==this)&&this._apply(t),i._currentState=this}static get defaultState(){return Qh._defaultState}static applyDefaults(t,e){(e||this._currentState!==this._defaultState)&&this._defaultState.apply(t,e)}}class Jh extends Qh{static _defaultState=new Jh;static _currentState=null;redMask;greenMask;blueMask;alphaMask;constructor(){super(),this.redMask=this.greenMask=this.blueMask=this.alphaMask=!0}clone(){return(new Jh).setColorMask(this.redMask,this.greenMask,this.blueMask,this.alphaMask)}setColorMask(t,e,i,s){return this.redMask=t,this.greenMask=e,this.blueMask=i,this.alphaMask=s,this}_apply(t){t.colorMask(this.redMask,this.greenMask,this.blueMask,this.alphaMask)}}class tu extends Qh{static _defaultState=new tu;static _currentState=null;_srcBlendRGB;_dstBlendRGB;_srcBlendAlpha;_dstBlendAlpha;_rgbEquation;_alphaEquation;enabled;alphaToCoverageEnabled;constructor(){super(),this.enabled=!1,this.alphaToCoverageEnabled=!1,this.srcBlendRGB="one",this.dstBlendRGB="zero",this.srcBlendAlpha="one",this.dstBlendAlpha="zero",this.rgbEquation="add",this.alphaEquation="add"}clone(){const t=new tu;return t.enable(this.enabled),t.enableAlphaToCoverage(this.alphaToCoverageEnabled),t.setBlendFuncRGB(this.srcBlendRGB,this.dstBlendRGB),t.setBlendFuncAlpha(this.srcBlendAlpha,this.dstBlendAlpha),t.setBlendEquation(this.rgbEquation,this.alphaEquation),t}get srcBlendRGB(){return Sh[this._srcBlendRGB]}set srcBlendRGB(t){this._srcBlendRGB=vh[t]}get dstBlendRGB(){return Sh[this._dstBlendRGB]}set dstBlendRGB(t){this._dstBlendRGB=vh[t]}get srcBlendAlpha(){return Sh[this._srcBlendAlpha]}set srcBlendAlpha(t){this._srcBlendAlpha=vh[t]}get dstBlendAlpha(){return Sh[this._dstBlendAlpha]}set dstBlendAlpha(t){this._dstBlendAlpha=vh[t]}get rgbEquation(){return yh[this._rgbEquation]}set rgbEquation(t){this._rgbEquation=Eh[t]}get alphaEquation(){return yh[this._alphaEquation]}set alphaEquation(t){this._alphaEquation=Eh[t]}enable(t){return this.enabled=!!t,this}enableAlphaToCoverage(t){return this.alphaToCoverageEnabled=!!t,this}setBlendFunc(t,e){return this.srcBlendRGB=t,this.dstBlendRGB=e,this.srcBlendAlpha=t,this.dstBlendAlpha=e,this}setBlendFuncRGB(t,e){return this.srcBlendRGB=t,this.dstBlendRGB=e,this}setBlendFuncAlpha(t,e){return this.srcBlendAlpha=t,this.dstBlendAlpha=e,this}setBlendEquation(t,e){return this.rgbEquation=t,this.alphaEquation=e,this}_apply(t){this.enabled?(t.enable(xh.BLEND),t.blendEquationSeparate(this._rgbEquation,this._alphaEquation),this._srcBlendRGB===this._srcBlendAlpha&&this._dstBlendRGB===this._dstBlendAlpha?t.blendFunc(this._srcBlendRGB,this._dstBlendRGB):t.blendFuncSeparate(this._srcBlendRGB,this._dstBlendRGB,this._srcBlendAlpha,this._dstBlendAlpha)):t.disable(xh.BLEND),this.alphaToCoverageEnabled?t.enable(xh.SAMPLE_ALPHA_TO_COVERAGE):t.disable(xh.SAMPLE_ALPHA_TO_COVERAGE)}}class eu extends Qh{static _defaultState=new eu;static _currentState=null;_cullMode;constructor(){super(),this.cullMode="back"}clone(){return(new eu).setCullMode(this.cullMode)}get cullMode(){return Ch[this._cullMode]}set cullMode(t){this._cullMode=wh[t]}setCullMode(t){return this.cullMode=t,this}get depthClampEnabled(){return!1}set depthClampEnabled(t){this.enableDepthClamp(t)}enableDepthClamp(t){return t&&console.error("Depth clamp not supported"),this}_apply(t){"none"==this.cullMode?t.disable(xh.CULL_FACE):(t.enable(xh.CULL_FACE),t.cullFace(this._cullMode))}}class iu extends Qh{static _defaultState=new iu;static _currentState=null;testEnabled;writeEnabled;_compareFunc;constructor(){super(),this.testEnabled=!0,this.writeEnabled=!0,this.compareFunc="le"}clone(){const t=new iu;return t.enableTest(this.testEnabled),t.enableWrite(this.writeEnabled),t.setCompareFunc(this.compareFunc),t}get compareFunc(){return $h[this._compareFunc]}set compareFunc(t){this._compareFunc=Mh[t]}enableTest(t){return this.testEnabled=t,this}enableWrite(t){return this.writeEnabled=t,this}setCompareFunc(t){return this.compareFunc=t,this}_apply(t){this.testEnabled?(t.enable(xh.DEPTH_TEST),t.depthFunc(this._compareFunc)):t.disable(xh.DEPTH_TEST),t.depthMask(this.writeEnabled)}}class su extends Qh{static _defaultState=new su;static _currentState=null;enabled;writeMask;ref;readMask;_failOp;_failOpBack;_zFailOp;_zFailOpBack;_passOp;_passOpBack;_func;_funcBack;constructor(){super(),this.enabled=!1,this.failOp=this.failOpBack="keep",this.zFailOp=this.zFailOpBack="keep",this.passOp=this.passOpBack="keep",this.func=this.funcBack="always",this.ref=0,this.writeMask=4294967295,this.readMask=4294967295}clone(){const t=new su;return t.enable(this.enabled),t.setWriteMask(this.writeMask),t.setFrontOp(this.failOp,this.zFailOp,this.passOp),t.setBackOp(this.failOpBack,this.zFailOpBack,this.passOpBack),t.setFrontCompareFunc(this.func),t.setBackCompareFunc(this.funcBack),t.setReference(this.ref),t.setReadMask(this.readMask),t}get failOp(){return Rh[this._failOp]}set failOp(t){this._failOp=Ah[t]}get failOpBack(){return Rh[this._failOpBack]}set failOpBack(t){this._failOpBack=Ah[t]}get zFailOp(){return Rh[this._zFailOp]}set zFailOp(t){this._zFailOp=Ah[t]}get zFailOpBack(){return Rh[this._zFailOpBack]}set zFailOpBack(t){this._zFailOpBack=Ah[t]}get passOp(){return Rh[this._passOp]}set passOp(t){this._passOp=Ah[t]}get passOpBack(){return Rh[this._passOpBack]}set passOpBack(t){this._passOpBack=Ah[t]}get func(){return $h[this._func]}set func(t){this._func=Mh[t]}get funcBack(){return $h[this._funcBack]}set funcBack(t){this._funcBack=Mh[t]}enable(t){return this.enabled=t,this}setWriteMask(t){return this.writeMask=t,this}setFrontOp(t,e,i){return this.failOp=t,this.zFailOp=e,this.passOp=i,this}setBackOp(t,e,i){return this.failOpBack=t,this.zFailOpBack=e,this.passOpBack=i,this}setFrontCompareFunc(t){return this.func=t,this}setBackCompareFunc(t){return this.funcBack=t,this}setReference(t){return this.ref=t,this}setReadMask(t){return this.readMask=t,this}_apply(t){this.enabled?(t.enable(xh.STENCIL_TEST),t.stencilMaskSeparate(xh.FRONT,this.writeMask),t.stencilMaskSeparate(xh.BACK,this.writeMask),t.stencilFuncSeparate(xh.FRONT,this._func,this.ref,this.readMask),t.stencilFuncSeparate(xh.BACK,this._funcBack,this.ref,this.readMask),t.stencilOpSeparate(xh.FRONT,this._failOp,this._zFailOp,this._passOp),t.stencilOpSeparate(xh.BACK,this._failOpBack,this._zFailOpBack,this._passOpBack)):t.disable(xh.STENCIL_TEST)}}class ru{_gl;colorState;blendingState;rasterizerState;depthState;stencilState;constructor(t){this._gl=t,this.colorState=null,this.blendingState=null,this.rasterizerState=null,this.depthState=null,this.stencilState=null}copyFrom(t){this.colorState=t.colorState,this.blendingState=t.blendingState,this.rasterizerState=t.rasterizerState,this.depthState=t.depthState,this.stencilState=t.stencilState}apply(t){const e=this._gl;this.colorState?this.colorState.apply(e,t):Jh.applyDefaults(e,t),this.blendingState?this.blendingState.apply(e,t):tu.applyDefaults(e,t),this.rasterizerState?this.rasterizerState.apply(e,t):eu.applyDefaults(e,t),this.depthState?this.depthState.apply(e,t):iu.applyDefaults(e,t),this.stencilState?this.stencilState.apply(e,t):su.applyDefaults(e,t)}useColorState(t){return this.colorState=t??this.colorState??new Jh}defaultColorState(){this.colorState=null}useBlendingState(t){return this.blendingState=t??this.blendingState??new tu}defaultBlendingState(){this.blendingState=null}useRasterizerState(t){return this.rasterizerState=t??this.rasterizerState??new eu}defaultRasterizerState(){this.rasterizerState=null}useDepthState(t){return this.depthState=t??this.depthState??new iu}defaultDepthState(){this.depthState=null}useStencilState(t){return this.stencilState=t??this.stencilState??new su}defaultStencilState(){this.stencilState=null}static applyDefaults(t,e){Jh.applyDefaults(t,e),tu.applyDefaults(t,e),eu.applyDefaults(t,e),iu.applyDefaults(t,e),su.applyDefaults(t,e)}}var au;!function(t){t[t.QUERY_STATE_NONE=0]="QUERY_STATE_NONE",t[t.QUERY_STATE_QUERYING=1]="QUERY_STATE_QUERYING",t[t.QUERY_STATE_FINISHED=2]="QUERY_STATE_FINISHED"}(au||(au={}));class nu{_device;_query;_state;_timerQuery;_gpuTime;constructor(t){this._device=t,this._state=0,this._gpuTime=null;const e=this._device.context;if(Th(e)){const t=e.getExtension("EXT_disjoint_timer_query_webgl2");t&&(this._timerQuery={createQuery:e.createQuery.bind(e),deleteQuery:e.deleteQuery.bind(e),beginQuery:e.beginQuery.bind(e),endQuery:e.endQuery.bind(e),isQuery:e.isQuery.bind(e),getQuery:e.getQuery.bind(e),getQueryObject:e.getQueryParameter.bind(e),queryCounter:t.queryCounterEXT.bind(t)})}else{const t=e.getExtension("EXT_disjoint_timer_query");t&&(this._timerQuery={createQuery:t.createQueryEXT.bind(t),deleteQuery:t.deleteQueryEXT.bind(t),beginQuery:t.beginQueryEXT.bind(t),endQuery:t.endQueryEXT.bind(t),isQuery:t.isQueryEXT.bind(t),getQuery:t.getQueryEXT.bind(t),getQueryObject:t.getQueryObjectEXT.bind(t),queryCounter:t.queryCounterEXT.bind(t)})}this._query=this._timerQuery?this._timerQuery.createQuery():null}get gpuTimerSupported(){return!!this._query}begin(){1===this._state&&this.end(),this._query&&this._timerQuery.beginQuery(35007,this._query),this._gpuTime=null,this._state=1}end(){1===this._state&&(this._query&&this._timerQuery.endQuery(35007),this._state=2)}ended(){return 1!==this._state}elapsed(){if(2===this._state&&null===this._gpuTime&&this._query&&this._timerQuery.getQueryObject(this._query,xh.QUERY_RESULT_AVAILABLE)){this._device.context.getParameter(36795)||(this._gpuTime=Number(this._timerQuery.getQueryObject(this._query,xh.QUERY_RESULT))/1e6)}return this._gpuTime}}class ou{_isWebGL2;_extDrawBuffers;_extFloatBlending;maxDrawBuffers;maxColorAttachmentBytesPerSample;supportMultisampledFramebuffer;supportFloatBlending;supportDepth32float;supportDepth32floatStencil8;constructor(t){this._isWebGL2=Th(t),this._extDrawBuffers=this._isWebGL2?null:t.getExtension("WEBGL_draw_buffers"),this._extFloatBlending=t.getExtension("EXT_float_blend"),this.maxDrawBuffers=this._isWebGL2||this._extDrawBuffers?Math.min(t.getParameter(xh.MAX_COLOR_ATTACHMENTS),t.getParameter(xh.MAX_DRAW_BUFFERS)):1,this.maxColorAttachmentBytesPerSample=16*this.maxDrawBuffers,this.supportMultisampledFramebuffer=Th(t),this.supportFloatBlending=!!this._extFloatBlending,this.supportDepth32float=this._isWebGL2,this.supportDepth32floatStencil8=this._isWebGL2}}class hu{_isWebGL2;_extIndexUint32;_extBlendMinMax;supportOversizedViewport;supportBlendMinMax;support32BitIndex;supportDepthClamp;maxBindGroups;maxTexCoordIndex;constructor(t){this._isWebGL2=Th(t),this._extBlendMinMax=null,this._extIndexUint32=Th?t.getExtension("OES_element_index_uint"):null,this._isWebGL2?(this.supportBlendMinMax=!0,this.support32BitIndex=!0):(this._extBlendMinMax=t.getExtension("EXT_blend_minmax"),this.supportBlendMinMax=!!this._extBlendMinMax,this.support32BitIndex=!!this._extIndexUint32),this.supportOversizedViewport=!0,this.supportDepthClamp=!1,this.maxBindGroups=4,this.maxTexCoordIndex=8}}class uu{_extFragDepth;_extStandardDerivatives;_extShaderTextureLod;supportFragmentDepth;supportStandardDerivatives;supportShaderTextureLod;supportHighPrecisionFloat;supportHighPrecisionInt;maxUniformBufferSize;uniformBufferOffsetAlignment;constructor(t){this._extFragDepth=null,this._extStandardDerivatives=null,Th(t)?(this.supportFragmentDepth=!0,this.supportStandardDerivatives=!0,this.supportShaderTextureLod=!0,this.supportHighPrecisionFloat=!0,this.maxUniformBufferSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE)||16384,this.uniformBufferOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT)||256):(this._extFragDepth=t.getExtension("EXT_frag_depth"),this.supportFragmentDepth=!!this._extFragDepth,this._extStandardDerivatives=t.getExtension("OES_standard_derivatives"),this.supportStandardDerivatives=!!this._extStandardDerivatives,this._extShaderTextureLod=t.getExtension("EXT_shader_texture_lod"),this.supportShaderTextureLod=!!this._extShaderTextureLod,this.supportHighPrecisionFloat=t.getShaderPrecisionFormat&&!!t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT)?.precision&&!!t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT)?.precision,this.maxUniformBufferSize=0,this.uniformBufferOffsetAlignment=1)}}class lu{_isWebGL2;_extS3TC;_extS3TCSRGB;_extTextureFilterAnisotropic;_extDepthTexture;_extSRGB;_extTextureFloat;_extTextureFloatLinear;_extTextureHalfFloat;_extTextureHalfFloatLinear;_textureFormatInfos;maxTextureSize;maxCubeTextureSize;npo2Mipmapping;npo2Repeating;supportS3TC;supportS3TCSRGB;supportDepthTexture;support3DTexture;supportSRGBTexture;supportFloatTexture;supportLinearFloatTexture;supportHalfFloatTexture;supportLinearHalfFloatTexture;supportAnisotropicFiltering;supportFloatColorBuffer;supportHalfFloatColorBuffer;supportFloatBlending;constructor(t){this._isWebGL2=Th(t),this._extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.supportAnisotropicFiltering=!!this._extTextureFilterAnisotropic,this._isWebGL2?this.supportDepthTexture=!0:(this._extDepthTexture=t.getExtension("WEBGL_depth_texture"),this.supportDepthTexture=!!this._extDepthTexture),this.support3DTexture=this._isWebGL2,this._extSRGB=this._isWebGL2?null:t.getExtension("EXT_sRGB"),this.supportSRGBTexture=this._isWebGL2||!!this._extSRGB,this._isWebGL2?this.supportFloatTexture=!0:(this._extTextureFloat=t.getExtension("OES_texture_float"),this.supportFloatTexture=!!this._extTextureFloat),this._extTextureFloatLinear=t.getExtension("OES_texture_float_linear"),this.supportLinearFloatTexture=!!this._extTextureFloatLinear,this._isWebGL2?(this.supportHalfFloatTexture=!0,this.supportLinearHalfFloatTexture=!0):(this._extTextureHalfFloat=t.getExtension("OES_texture_half_float"),this.supportHalfFloatTexture=!!this._extTextureHalfFloat,this._extTextureHalfFloatLinear=t.getExtension("OES_texture_half_float_linear"),this.supportLinearHalfFloatTexture=!!this._extTextureHalfFloatLinear),this._isWebGL2?t.getExtension("EXT_color_buffer_float")?(this.supportHalfFloatColorBuffer=!0,this.supportFloatColorBuffer=!0):t.getExtension("EXT_color_buffer_half_float")?(this.supportHalfFloatColorBuffer=!0,this.supportFloatColorBuffer=!1):(this.supportHalfFloatColorBuffer=!1,this.supportFloatColorBuffer=!1):(this.supportFloatColorBuffer=!!t.getExtension("WEBGL_color_buffer_float"),this.supportHalfFloatColorBuffer=!!t.getExtension("EXT_color_buffer_half_float")),this.supportFloatBlending=this.supportFloatColorBuffer&&!!t.getExtension("EXT_float_blend"),this._extS3TC=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),this.supportS3TC=!!this._extS3TC,this._extS3TCSRGB=t.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.supportS3TCSRGB=!!this._extS3TCSRGB,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._isWebGL2?(this.npo2Mipmapping=!0,this.npo2Repeating=!0):(this.npo2Mipmapping=!1,this.npo2Repeating=!1),this._textureFormatInfos={rgba8unorm:{glFormat:t.RGBA,glInternalFormat:this._isWebGL2?t.RGBA8:t.RGBA,glType:[t.UNSIGNED_BYTE,t.UNSIGNED_SHORT_4_4_4_4,t.UNSIGNED_SHORT_5_5_5_1],filterable:!0,renderable:!0,compressed:!1}},this.supportS3TC&&(this._textureFormatInfos.dxt1={glFormat:t.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos.dxt3={glFormat:t.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos.dxt5={glFormat:t.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0}),this.supportS3TCSRGB&&(this._textureFormatInfos["dxt1-srgb"]={glFormat:t.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos["dxt3-srgb"]={glFormat:t.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos["dxt5-srgb"]={glFormat:t.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0}),Th(t)?(this._textureFormatInfos.r8unorm={glFormat:t.RED,glInternalFormat:t.R8,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1},this._textureFormatInfos.r8snorm={glFormat:t.RED,glInternalFormat:t.R8_SNORM,glType:[t.BYTE],filterable:!0,renderable:!1,compressed:!1},this._textureFormatInfos.r16f={glFormat:t.RED,glInternalFormat:t.R16F,glType:[t.HALF_FLOAT,t.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1},this._textureFormatInfos.r32f={glFormat:t.RED,glInternalFormat:t.R32F,glType:[t.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1},this._textureFormatInfos.r8ui={glFormat:t.RED_INTEGER,glInternalFormat:t.R8UI,glType:[t.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.r8i={glFormat:t.RED_INTEGER,glInternalFormat:t.R8I,glType:[t.BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.r16ui={glFormat:t.RED_INTEGER,glInternalFormat:t.R16UI,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.r16i={glFormat:t.RED_INTEGER,glInternalFormat:t.R16I,glType:[t.SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.r32ui={glFormat:t.RED_INTEGER,glInternalFormat:t.R32UI,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.r32i={glFormat:t.RED_INTEGER,glInternalFormat:t.R32I,glType:[t.INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg8unorm={glFormat:t.RG,glInternalFormat:t.RG8,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1},this._textureFormatInfos.rg8snorm={glFormat:t.RG,glInternalFormat:t.RG8_SNORM,glType:[t.BYTE],filterable:!0,renderable:!1,compressed:!1},this._textureFormatInfos.rg16f={glFormat:t.RG,glInternalFormat:t.RG16F,glType:[t.HALF_FLOAT,t.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1},this._textureFormatInfos.rg32f={glFormat:t.RG,glInternalFormat:t.RG32F,glType:[t.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1},this._textureFormatInfos.rg8ui={glFormat:t.RG,glInternalFormat:t.RG8UI,glType:[t.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg8i={glFormat:t.RG,glInternalFormat:t.RG8I,glType:[t.BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg16ui={glFormat:t.RG,glInternalFormat:t.RG16UI,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg16i={glFormat:t.RG,glInternalFormat:t.RG16I,glType:[t.SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg32ui={glFormat:t.RG,glInternalFormat:t.RG32UI,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg32i={glFormat:t.RG,glInternalFormat:t.RG32I,glType:[t.INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos["rgba8unorm-srgb"]={glFormat:t.RGBA,glInternalFormat:t.SRGB8_ALPHA8,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1},this._textureFormatInfos.rgba8snorm={glFormat:t.RGBA,glInternalFormat:t.RGBA8_SNORM,glType:[t.BYTE],filterable:!0,renderable:!1,compressed:!1},this._textureFormatInfos.rgba16f={glFormat:t.RGBA,glInternalFormat:t.RGBA16F,glType:[t.HALF_FLOAT,t.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1},this._textureFormatInfos.rgba32f={glFormat:t.RGBA,glInternalFormat:t.RGBA32F,glType:[t.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1},this._textureFormatInfos.rgba8ui={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA8UI,glType:[t.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rgba8i={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA8I,glType:[t.BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rgba16ui={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA16UI,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rgba16i={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA16I,glType:[t.SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rgba32ui={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA32UI,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rgba32i={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA32I,glType:[t.INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg11b10uf={glFormat:t.RGB,glInternalFormat:t.R11F_G11F_B10F,glType:[t.UNSIGNED_INT_10F_11F_11F_REV],filterable:!0,renderable:!1,compressed:!1},this._textureFormatInfos.d16={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT16,glType:[t.UNSIGNED_SHORT,t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d24={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT24,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d32f={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT32F,glType:[t.FLOAT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d24s8={glFormat:t.DEPTH_STENCIL,glInternalFormat:t.DEPTH24_STENCIL8,glType:[t.UNSIGNED_INT_24_8],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d32fs8={glFormat:t.DEPTH_STENCIL,glInternalFormat:t.DEPTH32F_STENCIL8,glType:[t.FLOAT_32_UNSIGNED_INT_24_8_REV],filterable:!1,renderable:!0,compressed:!1}):(this.supportFloatTexture&&(this._textureFormatInfos.rgba32f={glFormat:t.RGBA,glInternalFormat:t.RGBA,glType:[t.FLOAT,t.UNSIGNED_BYTE,t.UNSIGNED_SHORT_4_4_4_4,t.UNSIGNED_SHORT_5_5_5_1],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1}),this.supportHalfFloatTexture&&(this._textureFormatInfos.rgba16f={glFormat:t.RGBA,glInternalFormat:t.RGBA,glType:[this._extTextureHalfFloat.HALF_FLOAT_OES,t.UNSIGNED_BYTE,t.UNSIGNED_SHORT_4_4_4_4,t.UNSIGNED_SHORT_5_5_5_1],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1}),this.supportSRGBTexture&&(this._textureFormatInfos["rgba8unorm-srgb"]={glFormat:this._extSRGB.SRGB_ALPHA_EXT,glInternalFormat:this._extSRGB.SRGB_ALPHA_EXT,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!1,compressed:!1}),this.supportDepthTexture&&(this._textureFormatInfos.d16={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d24={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d24s8={glFormat:t.DEPTH_STENCIL,glInternalFormat:t.DEPTH_STENCIL,glType:[this._extDepthTexture.UNSIGNED_INT_24_8_WEBGL],filterable:!1,renderable:!0,compressed:!1}))}calcMemoryUsage(t,e,i){switch(t){case"d16":case"d24":case"d24s8":case"d32f":return e===xh.UNSIGNED_SHORT?2*i:4*i;case"d32fs8":case"rg32f":case"rg32i":case"rg32ui":case"rgba16i":case"rgba16ui":return 8*i;case"dxt1":case"dxt1-srgb":return i/2;case"dxt3":case"dxt3-srgb":case"dxt5":case"dxt5-srgb":case"r8unorm":case"r8snorm":case"r8i":case"r8ui":return i;case"r16f":return e===xh.HALF_FLOAT?2*i:4*i;case"r16i":case"r16ui":case"rg8unorm":case"rg8snorm":case"rg8i":case"rg8ui":return 2*i;case"r32f":case"r32i":case"r32ui":case"rg16i":case"rg16ui":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8i":case"rgba8ui":return 4*i;case"rg16f":return e===xh.HALF_FLOAT?4*i:8*i;case"rgba16f":return e===xh.HALF_FLOAT?8*i:16*i;case"rgba32f":case"rgba32i":case"rgba32ui":return 16*i;default:return 0}}getTextureFormatInfo(t){return this._textureFormatInfos[t]}}class cu extends Yh{_structure;_data;constructor(t,e,i,s){if(!e?.isStructType())throw new Error("invalid structure type");if(i&bs.BF_INDEX)throw new Error("structured buffer must not have Index usage flag");if(i&bs.BF_READ||i&bs.BF_WRITE)throw new Error("structured buffer must not have Read or Write usage flags");if(i&bs.BF_VERTEX){if(1!==e.structMembers.length||!e.structMembers[0].type.isArrayType())throw new Error("structured buffer for vertex usage must have only one array member");if(!cu.isValidArrayElementType(e.structMembers[0].type.elementType))throw new Error("invalid vertex data type when creating vertex buffer")}const r=e.toBufferLayout(0,e.layout);if(s&&r.byteSize!==s.byteLength)throw new Error(`create structured buffer failed: invalid source size: ${s.byteLength}, should be ${r.byteSize}`);const a=!t.isWebGL2&&0!=(i&bs.BF_UNIFORM);super(t,i,s||r.byteSize,a),this._data=new Ga(r,a?this.systemMemoryBuffer:this),this._structure=e}set(t,e){this._data.set(t,e)}get structure(){return this._structure}set structure(t){if(t&&!t.isCompatibleType(this._structure)){const e=t.toBufferLayout(0,t.layout);if(e.byteSize>this.byteLength)throw new Error(`set structure type failed: new structure type is too large: ${e.byteSize}`);this._data=new Ga(e,this),this._structure=t}}getUniformData(){return this._data}static isValidArrayElementType(t){if(t.isPrimitiveType())return t.scalarType!==At.BOOL&&!t.isMatrixType();if(t.isStructType()){for(const e of t.structMembers)if(!e.type.isPrimitiveType()||e.type.scalarType===At.BOOL||e.type.isMatrixType())return!1;return!0}return!1}}class du extends Uh{_layout;_resources;constructor(t,e){super(t),this._device=t,this._layout=e,this._resources={},this._object={}}getLayout(){return this._layout}getBuffer(t){return this._getBuffer(t,!0)}setBuffer(t,e){const i=this._layout.nameMap?.[t]??t;for(const s of this._layout.entries)if(s.name===i)return void(s.buffer?!e||e.usage&bs.BF_UNIFORM?e!==this._resources[s.name]&&(this._resources[s.name]=e):console.log(`setBuffer() failed: buffer resource '${t}' must be type '${s.buffer.type}'`):console.log(`setBuffer() failed: resource '${t}' is not buffer`));console.log(`setBuffer() failed: no buffer resource named '${t}'`)}setRawData(t,e,i,s,r){const a=this._layout.nameMap?.[t];if(a)this.setRawData(a,e,i,s,r);else{const a=this._getBuffer(t,!1);a?a.bufferSubData(e,i,s,r):console.log(`set(): no uniform buffer named '${t}'`)}}setValue(t,e){const i=this._layout.nameMap?.[t];if(i)this.setValue(i,{[t]:e});else{const i=this._getBuffer(t,!1);if(i){if(!(i instanceof cu))throw new Error(`BindGroup.setValue() failed: '${t}' is not structured buffer`);if(e?.BYTES_PER_ELEMENT)i.bufferSubData(0,e);else for(const t in e)i.set(t,e[t])}else console.log(`set(): no uniform buffer named '${t}'`)}}setTextureView(t,e,i,s,r,a){throw new Error("setTextureView() not supported for webgl device")}getTexture(t){if(this._findTextureLayout(t))return this._resources[t]?.[0]||null;throw new Error(`getTexture() failed:${t} is not a texture`)}setTexture(t,e,i){const s=this._findTextureLayout(t);s?this._resources[t]=[e,i||e.getDefaultSampler(!!s.texture?.autoBindSamplerComparison)]:console.log(`setTexture() failed: no texture uniform named '${t}'`)}setSampler(t,e){}apply(t,e){const i=this._device.isWebGL2;let s=0;for(let r=0;r<this._layout.entries.length;r++){const a=this._layout.entries[r],n=this._resources[a.name];if(n instanceof cu)if(i)if(a.buffer.hasDynamicOffset){const i=e?.[s]||0;s++,t.setBlock(a.type.structName,n,i)}else t.setBlock(a.type.structName,n,0);else t.setUniform(a.name,n.getUniformData().uniforms);else Array.isArray(n)&&(n[0].isTextureVideo()&&n[0].updateVideoFrame(),t.setUniform(a.name,n))}}destroy(){this._resources={},this._object=null}async restore(){this._object={}}isBindGroup(){return!0}_getBuffer(t,e=!1){const i=this._layout.nameMap?.[t]??t;for(const t of this._layout.entries)if(t.buffer&&t.name===i){let i=this._resources[t.name];return i||e||(i=this._device.createStructuredBuffer(t.type,{usage:"uniform"}),this._resources[t.name]=i),i}return null}_findTextureLayout(t){for(const e of this._layout.entries)if((e.texture||e.storageTexture||e.externalTexture)&&e.name===t)return e;return null}}class pu extends Uh{_vs;_fs;_unitCounter;_uniformSetters;_uniformInfo;_blockInfo;_bindGroupLayouts;_vertexAttributes;_error;_vertexShader;_fragmentShader;constructor(t,e,i,s,r){super(t),this._object=this._device.context.createProgram(),this._unitCounter=0,this._uniformSetters=null,this._uniformInfo=null,this._blockInfo=null,this._error="",this._vertexShader=null,this._fragmentShader=null,this._vs=e,this._fs=i,this._bindGroupLayouts=[...s],this._vertexAttributes=[...r],this.load()}get type(){return"render"}getCompileError(){return this._error}getShaderSource(t){switch(t){case"vertex":return this._vs;case"fragment":return this._fs;case"compute":return null}}getBindingInfo(t){for(let e=0;e<this._bindGroupLayouts.length;e++){const i=this._bindGroupLayouts[e],s=i.nameMap?.[t]??t;for(let t=0;t<i.entries.length;t++){const r=i.entries[t];if(r.name===s)return{group:e,binding:t,type:r.type}}}return null}get bindGroupLayouts(){return this._bindGroupLayouts}get vertexAttributes(){return this._vertexAttributes}setUniform(t,e){const i=this._uniformSetters[t];if(i)i(e);else{const i=Object.getPrototypeOf(e);i===Object.getPrototypeOf({})?this._setUniformStruct(t,e):i==Object.getPrototypeOf([])&&this._setUniformArray(t,e)}}setBlock(t,e,i){const s=this._blockInfo[t];s?i?this._device.context.bindBufferRange(xh.UNIFORM_BUFFER,s.index,e.object,i,e.byteLength-i):this._device.context.bindBufferBase(xh.UNIFORM_BUFFER,s.index,e.object):console.error(`Block not found: ${t}`)}destroy(){this._object&&(this._device.context.deleteProgram(this._object),this._object=null,this._unitCounter=0,this._uniformSetters=null,this._uniformInfo=null,this._blockInfo=null,this._error="",this._vertexShader=null,this._fragmentShader=null)}async restore(){this._object||this._device.isContextLost()||this.load()}isProgram(){return!0}use(){if(this!==this._device.context._currentProgram){if(!this.checkLoad())return!1;this._device.context._currentProgram=this,this._device.context.useProgram(this._object)}return!0}createUniformBuffer(t){const e=this.getBindingInfo(t)?.type;return e?this.device.createStructuredBuffer(e,{usage:"uniform"}):null}_setUniformStruct(t,e){for(const i in e)this.setUniform(`${t}.${i}`,e[i])}_setUniformArray(t,e){for(let i=0;i<e.length;i++)this.setUniform(`${t}[${i}]`,e[i])}load(){if(this._device.isContextLost())return;const t=this._device.context;this._error=null,this._uniformSetters={},this._object||(this._object=this._device.context.createProgram()),this._vertexShader=t.createShader(xh.VERTEX_SHADER),t.attachShader(this._object,this._vertexShader),t.shaderSource(this._vertexShader,this._vs),t.compileShader(this._vertexShader),this._fragmentShader=t.createShader(xh.FRAGMENT_SHADER),t.attachShader(this._object,this._fragmentShader),t.shaderSource(this._fragmentShader,this._fs),t.compileShader(this._fragmentShader);for(let e=0;e<As.length;e++)t.bindAttribLocation(this._object,e,As[e]);t.linkProgram(this._object)}checkLoad(){if(!this._object)return!1;if(this._vertexShader){const t=this._device.context;if(this._device.isContextLost()||t.getProgramParameter(this._object,xh.LINK_STATUS)||(t.getShaderParameter(this._vertexShader,xh.COMPILE_STATUS)?t.getShaderParameter(this._fragmentShader,xh.COMPILE_STATUS)?(this._error=t.getProgramInfoLog(this._object),console.error(new Error(`Load program failed: \n${this._error}`))):(this._error=t.getShaderInfoLog(this._fragmentShader),console.error(new Error(`Compile shader failed: ${this._error}`))):(this._error=t.getShaderInfoLog(this._vertexShader),console.error(new Error(`Compile shader failed: ${this._error}`)))),t.deleteShader(this._vertexShader),this._vertexShader=null,t.deleteShader(this._fragmentShader),this._fragmentShader=null,this._error)return t.deleteProgram(this._object),this._object=null,!1;this._uniformSetters=this.createUniformSetters()}return!0}createUniformSetter(t){const e=t.location,i=t.isArray;switch(t.type){case xh.FLOAT:return this.getUniformSetterfv(e);case xh.FLOAT_VEC2:return this.getUniformSetter2fv(e);case xh.FLOAT_VEC3:return this.getUniformSetter3fv(e);case xh.FLOAT_VEC4:return this.getUniformSetter4fv(e);case xh.INT:return this.getUniformSetteriv(e);case xh.INT_VEC2:return this.getUniformSetter2iv(e);case xh.INT_VEC3:return this.getUniformSetter3iv(e);case xh.INT_VEC4:return this.getUniformSetter4iv(e);case xh.UNSIGNED_INT:return this.getUniformSetteruiv(e);case xh.UNSIGNED_INT_VEC2:return this.getUniformSetter2uiv(e);case xh.UNSIGNED_INT_VEC3:return this.getUniformSetter3uiv(e);case xh.UNSIGNED_INT_VEC4:return this.getUniformSetter4uiv(e);case xh.BOOL:return this.getUniformSetteriv(e);case xh.BOOL_VEC2:return this.getUniformSetter2iv(e);case xh.BOOL_VEC3:return this.getUniformSetter3iv(e);case xh.BOOL_VEC4:return this.getUniformSetter4iv(e);case xh.FLOAT_MAT2:return this.getUniformSetterMatrix2(e);case xh.FLOAT_MAT2x3:return this.getUniformSetterMatrix23(e);case xh.FLOAT_MAT2x4:return this.getUniformSetterMatrix24(e);case xh.FLOAT_MAT3:return this.getUniformSetterMatrix3(e);case xh.FLOAT_MAT3x2:return this.getUniformSetterMatrix32(e);case xh.FLOAT_MAT3x4:return this.getUniformSetterMatrix34(e);case xh.FLOAT_MAT4:return this.getUniformSetterMatrix4(e);case xh.FLOAT_MAT4x2:return this.getUniformSetterMatrix42(e);case xh.FLOAT_MAT4x3:return this.getUniformSetterMatrix43(e);case xh.SAMPLER_2D:case xh.SAMPLER_2D_SHADOW:case xh.INT_SAMPLER_2D:case xh.UNSIGNED_INT_SAMPLER_2D:{const s=this._unitCounter;if(this._unitCounter+=t.size,!i)return this.getSamplerSetter(e,xh.TEXTURE_2D,s)}case xh.SAMPLER_2D_ARRAY:case xh.SAMPLER_2D_ARRAY_SHADOW:case xh.INT_SAMPLER_2D_ARRAY:case xh.UNSIGNED_INT_SAMPLER_2D_ARRAY:{const s=this._unitCounter;if(this._unitCounter+=t.size,!i)return this.getSamplerSetter(e,xh.TEXTURE_2D_ARRAY,s)}case xh.SAMPLER_CUBE:case xh.SAMPLER_CUBE_SHADOW:case xh.INT_SAMPLER_CUBE:case xh.UNSIGNED_INT_SAMPLER_CUBE:{const s=this._unitCounter;if(this._unitCounter+=t.size,!i)return this.getSamplerSetter(e,xh.TEXTURE_CUBE_MAP,s)}case xh.SAMPLER_3D:case xh.INT_SAMPLER_3D:case xh.UNSIGNED_INT_SAMPLER_3D:{const s=this._unitCounter;if(this._unitCounter+=t.size,!i)return this.getSamplerSetter(e,xh.TEXTURE_3D,s)}}return console.error(`Error: unsupported uniform type: ${t.name}`),null}createUniformSetters(){const t={},e=this._device.context,i=e.getProgramParameter(this._object,xh.ACTIVE_UNIFORMS);this._uniformInfo=[];for(let s=0;s<i;s++){const i=e.getActiveUniform(this._object,s);let r=i.name,a=!1;if(r.startsWith("gl_")||r.startsWith("webgl_"))this._uniformInfo.push(null);else{"[0]"===r.substr(-3)&&(r=r.substr(0,r.length-3),a=!0);const n=i.size,o=i.type,h=-1,u=0,l=e.getUniformLocation(this._object,i.name),c=null,{ctor:d,elementSize:p}=this.getTypedArrayInfo(i.type),_={index:s,name:r,size:n,type:o,blockIndex:h,offset:u,isArray:a,location:l,view:c,viewCtor:d,viewElementSize:p};this._uniformInfo.push(_),l&&(t[r]=this.createUniformSetter(_))}}if(Th(e)){this._blockInfo={};const t=e.getProgramParameter(this._object,xh.ACTIVE_UNIFORM_BLOCKS);for(let i=0;i<t;i++){const t=e.getActiveUniformBlockName(this._object,i),s=e.getUniformBlockIndex(this._object,t),r=!!e.getActiveUniformBlockParameter(this._object,i,xh.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER),a=!!e.getActiveUniformBlockParameter(this._object,i,xh.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER),n=r||a,o=e.getActiveUniformBlockParameter(this._object,i,xh.UNIFORM_BLOCK_DATA_SIZE),h=e.getActiveUniformBlockParameter(this._object,i,xh.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES);this._blockInfo[t]={index:s,used:n,size:o,uniformIndices:h},e.uniformBlockBinding(this._object,s,s)}}return t}getUniformSetterf(t){return e=>{this._device.context.uniform1f(t,e)}}getUniformSetterfv(t){return e=>{this._device.context.uniform1fv(t,e)}}getUniformSetter2fv(t){return e=>{this._device.context.uniform2fv(t,e)}}getUniformSetter3fv(t){return e=>{this._device.context.uniform3fv(t,e)}}getUniformSetter4fv(t){return e=>{this._device.context.uniform4fv(t,e)}}getUniformSetteri(t){return e=>{this._device.context.uniform1i(t,e)}}getUniformSetteriv(t){return e=>{this._device.context.uniform1iv(t,e)}}getUniformSetter2iv(t){return e=>{this._device.context.uniform2iv(t,e)}}getUniformSetter3iv(t){return e=>{this._device.context.uniform3iv(t,e)}}getUniformSetter4iv(t){return e=>{this._device.context.uniform4iv(t,e)}}getUniformSetterui(t){return e=>{this._device.context.uniform1ui(t,e)}}getUniformSetteruiv(t){return e=>{this._device.context.uniform1uiv(t,e)}}getUniformSetter2uiv(t){return e=>{this._device.context.uniform2uiv(t,e)}}getUniformSetter3uiv(t){return e=>{this._device.context.uniform3uiv(t,e)}}getUniformSetter4uiv(t){return e=>{this._device.context.uniform4uiv(t,e)}}getUniformSetterMatrix2(t){return e=>{this._device.context.uniformMatrix2fv(t,!1,e)}}getUniformSetterMatrix23(t){return e=>{this._device.context.uniformMatrix2x3fv(t,!1,e)}}getUniformSetterMatrix24(t){return e=>{this._device.context.uniformMatrix2x4fv(t,!1,e)}}getUniformSetterMatrix32(t){return e=>{this._device.context.uniformMatrix3x2fv(t,!1,e)}}getUniformSetterMatrix3(t){return e=>{this._device.context.uniformMatrix3fv(t,!1,e)}}getUniformSetterMatrix34(t){return e=>{this._device.context.uniformMatrix3x4fv(t,!1,e)}}getUniformSetterMatrix42(t){return e=>{this._device.context.uniformMatrix4x2fv(t,!1,e)}}getUniformSetterMatrix43(t){return e=>{this._device.context.uniformMatrix4x3fv(t,!1,e)}}getUniformSetterMatrix4(t){return e=>{this._device.context.uniformMatrix4fv(t,!1,e)}}getSamplerSetter(t,e,i){const s=this._device.context;return Th(s)?r=>{const a=r?.[0].object??null,n=r?.[1].object??null;s.uniform1i(t,i),s.activeTexture(this._device.context.TEXTURE0+i),s.bindTexture(e,a),s.bindSampler(i,n)}:r=>{const a=r?.[0]??null,n=r?.[1]??null;s.uniform1i(t,i),s.activeTexture(this._device.context.TEXTURE0+i),s.bindTexture(e,r?.[0]?.object||null),a&&n&&this._device.getCurrentSamplerForTexture(a)!==n&&(a.isWebGL1Fallback,this._device.setCurrentSamplerForTexture(a,n),s.texParameteri(e,xh.TEXTURE_WRAP_S,Nh[n.addressModeU]),s.texParameteri(e,xh.TEXTURE_WRAP_T,Nh[n.addressModeV]),s.texParameteri(e,xh.TEXTURE_MAG_FILTER,Ph(n.magFilter)),s.texParameteri(e,xh.TEXTURE_MIN_FILTER,Bh(n.minFilter,a.isWebGL1Fallback?"none":n.mipFilter)),this._device.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&s.texParameterf(e,xh.TEXTURE_MAX_ANISOTROPY,n.maxAnisotropy))}}getTypedArrayInfo(t){let e=null,i=0;switch(t){case xh.INT:e=Int32Array,i=4;break;case xh.INT_VEC2:e=Int32Array,i=8;break;case xh.INT_VEC3:e=Int32Array,i=12;break;case xh.INT_VEC4:e=Int32Array,i=16;break;case xh.UNSIGNED_INT:case xh.BOOL:e=Uint32Array,i=4;break;case xh.UNSIGNED_INT_VEC2:case xh.BOOL_VEC2:e=Uint32Array,i=8;break;case xh.UNSIGNED_INT_VEC3:case xh.BOOL_VEC3:e=Uint32Array,i=12;break;case xh.UNSIGNED_INT_VEC4:case xh.BOOL_VEC4:e=Uint32Array,i=16;break;case xh.FLOAT:e=Float32Array,i=4;break;case xh.FLOAT_VEC2:e=Float32Array,i=8;break;case xh.FLOAT_VEC3:e=Float32Array,i=12;break;case xh.FLOAT_VEC4:case xh.FLOAT_MAT2:e=Float32Array,i=16;break;case xh.FLOAT_MAT2x3:case xh.FLOAT_MAT3x2:e=Float32Array,i=24;break;case xh.FLOAT_MAT2x4:case xh.FLOAT_MAT4x2:e=Float32Array,i=32;break;case xh.FLOAT_MAT3:e=Float32Array,i=36;break;case xh.FLOAT_MAT3x4:case xh.FLOAT_MAT4x3:e=Float32Array,i=48;break;case xh.FLOAT_MAT4:e=Float32Array,i=64}return{ctor:e,elementSize:i}}}class _u extends Uh{_options;constructor(t,e){super(t),this._options=Object.assign({addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:"nearest",minFilter:"nearest",mipFilter:"none",lodMin:0,lodMax:32,compare:null,maxAnisotropy:1},e||{}),this._load()}get addressModeU(){return this._options.addressU}get addressModeV(){return this._options.addressV}get addressModeW(){return this._options.addressW}get magFilter(){return this._options.magFilter}get minFilter(){return this._options.minFilter}get mipFilter(){return this._options.mipFilter}get lodMin(){return this._options.lodMin}get lodMax(){return this._options.lodMax}get compare(){return this._options.compare}get maxAnisotropy(){return this._options.maxAnisotropy}destroy(){this._object&&Th(this._device.context)&&this._device.context.deleteSampler(this._object),this._object=null}async restore(){this._object||this._device.isContextLost()||this._load()}apply(t){if(t?.object&&!this._device.isWebGL2&&!this._device.isContextLost()){const e=this._device.context,i=Lh[t.target];e.bindTexture(i,t.object),e.texParameteri(i,xh.TEXTURE_WRAP_S,Nh[this._options.addressU]),e.texParameteri(i,xh.TEXTURE_WRAP_T,Nh[this._options.addressV]),e.texParameteri(i,xh.TEXTURE_MAG_FILTER,Ph(this._options.magFilter)),e.texParameteri(i,xh.TEXTURE_MIN_FILTER,Bh(this._options.minFilter,this._options.mipFilter)),this._device.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&e.texParameterf(i,xh.TEXTURE_MAX_ANISOTROPY,this._options.maxAnisotropy)}}_load(){if(!Th(this._device.context))return this._object={},!0;if(!this._device.isContextLost()){const t=this._device.context;this._object||(this._object=t.createSampler()),t.samplerParameteri(this._object,xh.TEXTURE_WRAP_S,Nh[this._options.addressU]),t.samplerParameteri(this._object,xh.TEXTURE_WRAP_T,Nh[this._options.addressV]),t.samplerParameteri(this._object,xh.TEXTURE_WRAP_R,Nh[this._options.addressW]),t.samplerParameteri(this._object,xh.TEXTURE_MAG_FILTER,Ph(this._options.magFilter)),t.samplerParameteri(this._object,xh.TEXTURE_MIN_FILTER,Bh(this._options.minFilter,this._options.mipFilter)),t.samplerParameterf(this._object,xh.TEXTURE_MIN_LOD,this._options.lodMin),t.samplerParameterf(this._object,xh.TEXTURE_MAX_LOD,this._options.lodMax),null===this._options.compare?t.samplerParameteri(this._object,xh.TEXTURE_COMPARE_MODE,xh.NONE):(t.samplerParameteri(this._object,xh.TEXTURE_COMPARE_MODE,xh.COMPARE_REF_TO_TEXTURE),t.samplerParameteri(this._object,xh.TEXTURE_COMPARE_FUNC,Mh[this._options.compare])),this._device.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&t.samplerParameterf(this._object,xh.TEXTURE_MAX_ANISOTROPY,this._options.maxAnisotropy)}return!0}isSampler(){return!0}}class mu{_device;_samplers;constructor(t){this._device=t,this._samplers={}}fetchSampler(t){const e=this.hash(t);let i=this._samplers[e];return i||(i=this.createSampler(t),this._samplers[e]=i),i}hash(t){return`${t.addressU?String(t.addressU):""}:${t.addressV?String(t.addressV):""}:${t.addressW?String(t.addressW):""}:${t.magFilter?String(t.magFilter):""}:${t.minFilter?String(t.minFilter):""}:${t.mipFilter?String(t.mipFilter):""}:${t.lodMin?String(t.lodMin):""}:${t.lodMax?String(t.lodMax):""}:${t.compare?String(t.compare):""}:${t.maxAnisotropy?String(t.maxAnisotropy):""}`}createSampler(t){return new _u(this._device,t)}}const fu=Xt.getCachedTypeInfo(At.U16),gu=new Int32Array(4),xu=new Uint32Array(4);let Tu=null,bu=null;const Eu=e(class extends Va{_context;_msaaSampleCount;_loseContextExtension;_contextLost;_isRendering;_dpr;_reverseWindingOrder;_deviceCaps;_vaoExt;_instancedArraysExt;_drawBuffersExt;_currentProgram;_currentVertexData;_currentStateSet;_currentBindGroups;_currentBindGroupOffsets;_currentViewport;_currentScissorRect;_samplerCache;_textureSamplerMap;constructor(t,e,i){super(e,t),this._dpr=Math.max(1,Math.floor(i?.dpr??window.devicePixelRatio)),this._isRendering=!1,this._msaaSampleCount=i?.msaa?4:1;let s=null;if(s=this.canvas.getContext(t===vu?"webgl":"webgl2",{antialias:!!i?.msaa,depth:!0,stencil:!0,premultipliedAlpha:!1}),!s)throw new Error("Invalid argument or no webgl support");this._contextLost=!1,this._reverseWindingOrder=!1,this._deviceCaps=null,this._context=s,this._currentProgram=null,this._currentVertexData=null,this._currentStateSet=null,this._currentBindGroups=[],this._currentBindGroupOffsets=[],this._currentViewport=null,this._currentScissorRect=null,this._samplerCache=new mu(this),this._textureSamplerMap=new WeakMap,this._loseContextExtension=this._context.getExtension("WEBGL_lose_context"),this.canvas.addEventListener("webglcontextlost",(t=>{this._contextLost=!0,t.preventDefault(),this.handleContextLost()}),!1),this.canvas.addEventListener("webglcontextrestored",(t=>{this._contextLost=!1,this.handleContextRestored()}),!1)}get context(){return this._context}getFrameBufferSampleCount(){return this.getFramebuffer()?.getSampleCount()??this._msaaSampleCount}get isWebGL2(){return this._context&&Th(this._context)}get drawingBufferWidth(){return this.getDrawingBufferWidth()}get drawingBufferHeight(){return this.getDrawingBufferHeight()}get clientWidth(){return this.canvas.clientWidth}get clientHeight(){return this.canvas.clientHeight}getScale(){return this._dpr}isContextLost(){return this._context.isContextLost()}getDeviceCaps(){return this._deviceCaps}get vaoExt(){return this._vaoExt}get instancedArraysExt(){return this._instancedArraysExt}get drawBuffersExt(){return this._drawBuffersExt}getDrawingBufferWidth(){return this._context._currentFramebuffer?.getWidth()||this._context.drawingBufferWidth}getDrawingBufferHeight(){return this._context._currentFramebuffer?.getHeight()||this._context.drawingBufferHeight}getBackBufferWidth(){return this.canvas.width}getBackBufferHeight(){return this.canvas.height}async initContext(){this.initContextState(),this.on("resize",(t=>{const e=Math.max(1,Math.round(this.canvas.clientWidth*this._dpr)),i=Math.max(1,Math.round(this.canvas.clientHeight*this._dpr));e===this.canvas.width&&i===this.canvas.height||(this.canvas.width=e,this.canvas.height=i,this.setViewport(this._currentViewport),this.setScissor(this._currentScissorRect))})),this.dispatchEvent(new gt(this.canvas.clientWidth,this.canvas.clientHeight))}clearFrameBuffer(t,e,i){const s=this._context,r=t?s.COLOR_BUFFER_BIT:0,a="number"==typeof e?s.DEPTH_BUFFER_BIT:0,n="number"==typeof i?s.STENCIL_BUFFER_BIT:0;if(r||a||n){if(iu.applyDefaults(this._context),Th(s)&&s._currentFramebuffer){if(a||n){s._currentFramebuffer.getDepthAttachment()&&s.clearBufferfi(xh.DEPTH_STENCIL,0,e||1,i||0)}if(r){const e=s._currentFramebuffer.getColorAttachments();for(let i=0;i<e.length;i++)lt(e[i].format)?ct(e[i].format)?(gu[0]=t[0],gu[1]=t[1],gu[2]=t[2],gu[3]=t[3],s.clearBufferiv(xh.COLOR,i,gu)):(xu[0]=t[0],xu[1]=t[1],xu[2]=t[2],xu[3]=t[3],s.clearBufferuiv(xh.COLOR,i,xu)):s.clearBufferfv(xh.COLOR,i,t)}}else s.clearColor(t[0],t[1],t[2],t[3]),s.clearDepth(e),s.clearStencil(i),s.clear(r|a|n);s._currentFramebuffer?.tagDraw()}}createGPUTimer(){return new nu(this)}createRenderStateSet(){return new ru(this._context)}createSampler(t){return this._samplerCache.fetchSampler(t)}createTextureFromMipmapData(t,e,i){if(!t)return console.error("Device.createTextureFromMipmapData() failed: invalid data"),null;if(t.isCubemap){const s=new Xh(this);return s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s}if(t.isVolume){const e=new kh(this);return e.createWithMipmapData(t,this.parseTextureOptions(i)),e}if(t.isArray){const e=new zh(this);return e.createWithMipmapData(t,this.parseTextureOptions(i)),e}{const s=new Gh(this);return s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s}}createTexture2D(t,e,i,s){const r=s?.texture??new Gh(this);return r.isTexture2D()?(r.createEmpty(t,e,i,this.parseTextureOptions(s)),r.samplerOptions=s?.samplerOptions??null,r):(console.error("createTexture2D() failed: options.texture must be 2d texture"),null)}createTexture2DFromMipmapData(t,e,i){const s=i?.texture??new Gh(this);return s.isTexture2D()?(s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createTexture2DFromMipmapData() failed: options.texture must be 2d texture"),null)}createTexture2DFromImage(t,e,i){const s=i?.texture??new Gh(this);return s.isTexture2D()?(s.loadFromElement(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createTexture2DFromImage() failed: options.texture must be 2d texture"),null)}createTexture2DArray(t,e,i,s,r){const a=r?.texture??new zh(this);return a.isTexture2DArray()?(a.createEmpty(t,e,i,s,this.parseTextureOptions(r)),a.samplerOptions=r?.samplerOptions??null,a):(console.error("createTexture2DArray() failed: options.texture must be 2d array texture"),null)}createTexture2DArrayFromImages(t,e,i){if(!t||0===t.length)return console.error("createTexture2DArrayFromImages() failed: Invalid image elements"),null;let s=0,r=0;for(const e of t)if(0===s||0===r)s=e.width,r=e.height;else if(s!==e.width||r!==e.height)return console.error("createTexture2DArrayFromImages() failed: Image elements must have the same size"),null;if(i?.texture&&!i.texture.isTexture2DArray())return console.error("createTexture2DArrayFromImages() failed: options.texture must be 2d array texture"),null;let a=i?.texture;if(a){if(a.depth!==t.length)return console.error("createTexture2DArrayFromImages() failed: Layer count of options.texture not match the given image elements"),null;if(a.width!==s||a.height!==r)return console.error("createTexture2DArrayFromImages() failed: Size of options.texture not match the given image elements"),null}else{a=this.createTexture2DArray(e?"rgba8unorm-srgb":"rgba8unorm",s,r,t.length,i);for(let e=0;e<t.length;e++)a.updateFromElement(t[e],0,0,e,0,0,s,r)}return a.samplerOptions=i?.samplerOptions??null,a}createTexture3D(t,e,i,s,r){if(!this.isWebGL2)return console.error("device does not support 3d texture"),null;const a=r?.texture??new kh(this);return a.isTexture3D()?(a.createEmpty(t,e,i,s,this.parseTextureOptions(r)),a.samplerOptions=r?.samplerOptions??null,a):(console.error("createTexture3D() failed: options.texture must be 3d texture"),null)}createCubeTexture(t,e,i){const s=i?.texture??new Xh(this);return s.isTextureCube()?(s.createEmpty(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createCubeTexture() failed: options.texture must be cube texture"),null)}createCubeTextureFromMipmapData(t,e,i){const s=i?.texture??new Xh(this);return s.isTextureCube()?(s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createCubeTextureFromMipmapData() failed: options.texture must be cube texture"),null)}createTexture2DArrayFromMipmapData(t,e){const i=e?.texture??new zh(this);return i.isTexture2DArray()?(i.createWithMipmapData(t,this.parseTextureOptions(e)),i.samplerOptions=e?.samplerOptions??null,i):(console.error("createTexture2DArrayFromMipmapData() failed: options.texture must be 2d array texture"),null)}createTextureVideo(t,e){const i=new Wh(this,t);return i.samplerOptions=e??null,i}createGPUProgram(t){if("compute"===t.type)throw new Error("device does not support compute shader");const e=t.params;return new pu(this,e.vs,e.fs,e.bindGroupLayouts,e.vertexAttributes)}createBindGroup(t){return new du(this,t)}createBuffer(t,e){return new Yh(this,this.parseBufferOptions(e),t)}createIndexBuffer(t,e){return new Zh(this,t,this.parseBufferOptions(e,"index"))}createStructuredBuffer(t,e,i){return new cu(this,t,this.parseBufferOptions(e),i)}createVertexLayout(t){return new Hh(this,t)}createFrameBuffer(t,e,i){this.pushDeviceStates();const s=new Kh(this,t,e,i);return this.popDeviceStates(),s}setBindGroup(t,e,i){if(i&&!Th(this._context))throw new Error("setBindGroup(): no dynamic offset buffer support for WebGL1 device");this._currentBindGroups[t]=e,this._currentBindGroupOffsets[t]=i||null}getBindGroup(t){return[this._currentBindGroups[t],this._currentBindGroupOffsets[t]]}setViewport(t){null==t||!Array.isArray(t)&&t.default?this._currentViewport={x:0,y:0,width:this.deviceToScreen(this.drawingBufferWidth),height:this.deviceToScreen(this.drawingBufferHeight),default:!0}:Array.isArray(t)?this._currentViewport={x:t[0],y:t[1],width:t[2],height:t[3],default:!1}:this._currentViewport=Object.assign({default:!1},t),this._context.viewport(this.screenToDevice(this._currentViewport.x),this.screenToDevice(this._currentViewport.y),this.screenToDevice(this._currentViewport.width),this.screenToDevice(this._currentViewport.height))}getViewport(){return Object.assign({},this._currentViewport)}setScissor(t){null==t||!Array.isArray(t)&&t.default?this._currentScissorRect={x:0,y:0,width:this.deviceToScreen(this.drawingBufferWidth),height:this.deviceToScreen(this.drawingBufferHeight),default:!0}:Array.isArray(t)?this._currentScissorRect={x:t[0],y:t[1],width:t[2],height:t[3],default:!1}:this._currentScissorRect=Object.assign({default:!1},t),this._context.scissor(this.screenToDevice(this._currentScissorRect.x),this.screenToDevice(this._currentScissorRect.y),this.screenToDevice(this._currentScissorRect.width),this.screenToDevice(this._currentScissorRect.height))}getScissor(){return Object.assign({},this._currentScissorRect)}setProgram(t){this._currentProgram=t}getProgram(){return this._currentProgram}setVertexLayout(t){this._currentVertexData=t}getVertexLayout(){return this._currentVertexData}setRenderStates(t){this._currentStateSet=t}getRenderStates(){return this._currentStateSet}setFramebuffer(t){t!==this._context._currentFramebuffer&&(this._context._currentFramebuffer?.unbind(),t?.bind())}getFramebuffer(){return this._context._currentFramebuffer??null}reverseVertexWindingOrder(t){this._reverseWindingOrder!==!!t&&(this._reverseWindingOrder=!!t,this._context.frontFace(t?this._context.CW:this._context.CCW))}isWindingOrderReversed(){return!!this._reverseWindingOrder}flush(){this.context.flush()}async readPixels(t,e,i,s,r,a){const n=this.getFramebuffer(),o=n?n.getColorAttachments()[t]:null,h=o?o.format:"rgba8unorm";let u=xh.NONE,l=xh.NONE;const c=pt(h);if(u=this.context.getParameter(xh.IMPLEMENTATION_COLOR_READ_FORMAT),l=this.context.getParameter(xh.IMPLEMENTATION_COLOR_READ_TYPE),(u!==xh.RGBA||l!==xh.UNSIGNED_BYTE&&l!==xh.FLOAT)&&!Th(this.context))throw new Error(`readPixels() failed: invalid format: ${h}`);const d=s*r*c;if(a.byteLength<d)throw new Error(`readPixels() failed: destination buffer must have at least ${d} bytes`);if(Th(this.context)){const o=this.createBuffer(d,{usage:"read",managed:!1});this.context.bindBuffer(xh.PIXEL_PACK_BUFFER,o.object),this.context.readBuffer(n?xh.COLOR_ATTACHMENT0+t:xh.COLOR_ATTACHMENT0),this.flush(),this.context.readPixels(e,i,s,r,u,l,0),this.context.bindBuffer(xh.PIXEL_PACK_BUFFER,null);const h=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);await o.getBufferSubData(h),o.dispose()}else this.context.readPixels(e,i,s,r,u,l,a)}readPixelsToBuffer(t,e,i,s,r,a){const n=this.getFramebuffer(),o=n?n.getColorAttachments()[t]:null,h=o?o.format:"rgba8unorm";let u=xh.NONE,l=xh.NONE;if(!Th(this.context))throw new Error("readPixels() failed: readPixels() requires webgl2 device");if(dt(h)||ht(h))throw new Error(`readPixels() failed: invalid format: ${h}`);const c=function(t){return!!(1&nt[t])}(h),d=function(t){return!!(2&nt[t])}(h),p=function(t){return!!(4&nt[t])}(h),_=function(t){return!!(8&nt[t])}(h),m=(c?1:0)+(d?1:0)+(p?1:0)+(_?1:0),f=pt(h)/m,g=lt(h),x=ut(h),T=ct(h);c&&d&&p&&_?u=g?xh.RGBA_INTEGER:xh.RGBA:c&&d?u=g?xh.RG_INTEGER:xh.RG:c&&(u=g?xh.RED_INTEGER:xh.RED),1===f?l=T?xh.BYTE:xh.UNSIGNED_BYTE:2===f?l=x?xh.HALF_FLOAT:T?xh.SHORT:xh.UNSIGNED_SHORT:4===f&&(l=x?xh.FLOAT:T?xh.INT:xh.UNSIGNED_INT),this.context.bindBuffer(xh.PIXEL_PACK_BUFFER,a.object),this.context.readBuffer(n?xh.COLOR_ATTACHMENT0+t:xh.COLOR_ATTACHMENT0),this.flush(),this.context.readPixels(e,i,s,r,u,l,0),this.context.bindBuffer(xh.PIXEL_PACK_BUFFER,null)}looseContext(){this.context.isContextLost()||this._loseContextExtension?.loseContext()}restoreContext(){if(this.context.isContextLost()){this.clearErrors(),this._loseContextExtension?.restoreContext();const t=this.getError();t&&console.log(t)}}onBeginFrame(){return this._contextLost&&(this._context.isContextLost()||(this._contextLost=!1,this.handleContextRestored())),!this._contextLost}onEndFrame(){}_draw(t,e,i){if(this._currentVertexData){if(this._currentVertexData.bind(),this._currentProgram){if(!this._currentProgram.use())return;for(let t=0;t<this._currentProgram.bindGroupLayouts.length;t++){const e=this._currentBindGroups[t];if(!e)return void console.error(`Missing bind group (${t}) when drawing with program '${this._currentProgram.name}'`);{const i=this._currentBindGroupOffsets[t];e.apply(this._currentProgram,i)}}}this._currentStateSet?this._currentStateSet.apply():ru.applyDefaults(this._context);const s=this._currentVertexData.indexBuffer;s?this.context.drawElements(Ih[t],i,Dh[s.indexType.primitiveType],e*(s.indexType===fu?2:4)):this.context.drawArrays(Ih[t],e,i),this._context._currentFramebuffer?.tagDraw()}}_drawInstanced(t,e,i,s){if(this.instancedArraysExt&&this._currentVertexData){if(this._currentVertexData.bind(),this._currentProgram){if(!this._currentProgram.use())return;for(let t=0;t<this._currentBindGroups.length;t++){const e=this._currentBindGroups[t];if(e){const i=this._currentBindGroupOffsets[t];e.apply(this._currentProgram,i)}}}this._currentStateSet?.apply();const r=this._currentVertexData.indexBuffer;r?this.instancedArraysExt.drawElementsInstanced(Ih[t],i,Dh[r.indexType.primitiveType],e*(r.indexType===fu?2:4),s):this.instancedArraysExt.drawArraysInstanced(Ih[t],e,i,s),this._context._currentFramebuffer?.tagDraw()}}_compute(){throw new Error("WebGL device does not support compute shader")}createInstancedArraysEXT(){const t=this._context;if(Th(t))return{vertexAttribDivisor:t.vertexAttribDivisor.bind(t),drawArraysInstanced:t.drawArraysInstanced.bind(t),drawElementsInstanced:t.drawElementsInstanced.bind(t)};{const e=t.getExtension("ANGLE_instanced_arrays");return e?{vertexAttribDivisor:e.vertexAttribDivisorANGLE.bind(e),drawArraysInstanced:e.drawArraysInstancedANGLE.bind(e),drawElementsInstanced:e.drawElementsInstancedANGLE.bind(e)}:null}}createDrawBuffersEXT(){const t=this._context;if(Th(t))return{drawBuffers:t.drawBuffers.bind(t)};{const e=t.getExtension("WEBGL_draw_buffers");return e?{drawBuffers:e.drawBuffersWEBGL.bind(e)}:null}}createVertexArrayObjectEXT(){const t=this._context;if(Th(t))return{createVertexArray:t.createVertexArray.bind(t),bindVertexArray:t.bindVertexArray.bind(t),deleteVertexArray:t.deleteVertexArray.bind(t),isVertexArray:t.isVertexArray.bind(t)};{const e=t.getExtension("OES_vertex_array_object");return e?{createVertexArray:e.createVertexArrayOES.bind(e),bindVertexArray:e.bindVertexArrayOES.bind(e),deleteVertexArray:e.deleteVertexArrayOES.bind(e),isVertexArray:e.isVertexArrayOES.bind(e)}:null}}handleContextLost(){this._isRendering=this.isRendering,this.exitLoop(),console.log("handle context lost"),this.invalidateAll(),this.dispatchEvent(new mt)}handleContextRestored(){console.log("handle context restored"),this.initContextState(),this._textureSamplerMap=new WeakMap,this._currentProgram=null,this._currentVertexData=null,this._currentStateSet=null,this._currentBindGroups=[],this._currentBindGroupOffsets=[],this._currentViewport=null,this._currentScissorRect=null,this._samplerCache=new mu(this),this._isRendering&&(this._isRendering=!1,this.reloadAll().then((()=>{this.dispatchEvent(new ft),this.runLoop(this.runLoopFunction)})))}initContextState(){this._deviceCaps={miscCaps:new hu(this._context),framebufferCaps:new ou(this._context),shaderCaps:new uu(this._context),textureCaps:new lu(this._context)},this._vaoExt=this.createVertexArrayObjectEXT(),this._instancedArraysExt=this.createInstancedArraysEXT(),this._drawBuffersExt=this.createDrawBuffersEXT(),this._context.pixelStorei(xh.UNPACK_COLORSPACE_CONVERSION_WEBGL,xh.NONE),this._context.pixelStorei(xh.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),this.setViewport(null),this.setScissor(null),this._context.enable(xh.SCISSOR_TEST),this.enableGPUTimeRecording(!0),this._context._currentFramebuffer=void 0,this._context._currentProgram=void 0}clearErrors(){for(;this._context.getError(););}getCurrentSamplerForTexture(t){return this._textureSamplerMap.get(t)}setCurrentSamplerForTexture(t,e){this._textureSamplerMap.set(t,e)}getError(t){const e=this._context.getError(),i=e===xh.NO_ERROR?null:new bh(e);if(i&&t)throw i;return i}})();async function yu(t,e,i){try{const s=new Eu(t,e,i);return await s.initContext(),s.setViewport(),s.setScissor(),s}catch(t){return console.error(t),null}}const vu={typeName:()=>"webgl",supported(){if(null===Tu){const t=document.createElement("canvas"),e=t.getContext("webgl");Tu=!!e,t.width=0,t.height=0}return Tu},async createDevice(t,e){return yu(this,t,e)}},Su=new Y({backend:{typeName:()=>"webgl2",supported(){if(null===bu){const t=document.createElement("canvas"),e=t.getContext("webgl2");bu=!!e,t.width=0,t.height=0}return bu},async createDevice(t,e){return yu(this,t,e)}},canvas:document.querySelector("#my-canvas")});Su.ready().then((function(){const t=new nh;t.env.light.strength=.4;const e=new uh(t);e.rotation.fromEulerAngle(-Math.PI/4,Math.PI/4,0,"ZYX"),e.castShadow=!0,e.shadow.mode="pcf-opt";const i=new Qo;i.lightModel.metallic=.1,i.lightModel.roughness=.9;new lh(t,new mn({size:10}),i).position.setXYZ(16,0,-12);const s=new lh(t,new xn({size:60}),i);s.position.x=-30,s.position.z=-30;new lh(t,new gn,i).position.setXYZ(0,3,0);const r=new gh;r.appendPostEffect(new mh);const a=new fh,n=new ch(t,Math.PI/3,Su.device.canvas.width/Su.device.canvas.height,1,600);n.lookAt(new g(0,40,60),new g(0,0,0),new g(0,1,0)),n.controller=new ph({distance:n.getWorldPosition().magnitude}),Su.inputManager.use(n.handleEvent.bind(n)),Su.on("tick",(function(){n.updateController();const e=Su.device.deviceToScreen(Su.device.canvas.width),i=Su.device.deviceToScreen(Su.device.canvas.height);r.appendPostEffect(a),n.viewport=[0,0,e,i>>1],n.aspect=n.viewport[2]/n.viewport[3],n.render(t,r),r.removePostEffect(a),n.viewport=[0,i>>1,e,i-(i>>1)],n.aspect=n.viewport[2]/n.viewport[3],n.render(t,r)})),Su.run()}));
//# sourceMappingURL=tut-30.js.map
