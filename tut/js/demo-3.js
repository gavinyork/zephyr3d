const t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32",transparent:"rgba(0,0,0,0)"};class e{static _tempElement=null;_urlResolver;_crossOrigin;_headers;constructor(){this._urlResolver=null,this._crossOrigin="",this._headers={}}get urlResolver(){return this._urlResolver}set urlResolver(t){this._urlResolver=t}get crossOrigin(){return this._crossOrigin}set crossOrigin(t){this._crossOrigin=t}get headers(){return this._headers}set headers(t){this._headers=t}resolveURL(t){return e._tempElement||(e._tempElement=document.createElement("a")),e._tempElement.href=t,e._tempElement.href}async request(t){return(t=this._urlResolver?this._urlResolver(t):this.resolveURL(t))?fetch(t,{credentials:"anonymous"===this._crossOrigin?"same-origin":"include",headers:this._headers||{}}):null}async requestText(t){const e=await this.request(t);if(!e.ok)throw new Error(`Asset download failed: ${t}`);return e.text()}async requestArrayBuffer(t){const e=await this.request(t);if(!e.ok)throw new Error(`Asset download failed: ${t}`);return e.arrayBuffer()}async requestBlob(t){const e=await this.requestArrayBuffer(t);return new Blob([e])}}function i(t,...e){let i=t;for(const t of e)i=t(i);return i}function s(t){return function(){return class extends t{_listeners;constructor(...t){super(...t),this._listeners=null}on(t,e,i){this._listeners=this._internalAddEventListener(this._listeners,t,e,{context:i})}once(t,e,i){this._listeners=this._internalAddEventListener(this._listeners,t,e,{context:i,once:!0})}off(t,e){this._internalRemoveEventListener(this._listeners,t,e)}dispatchEvent(t,e){this._invokeLocalListeners(t,e)}_internalAddEventListener(t,e,i,s){if("string"!=typeof e)return;t||(t={});const r=i,n={once:!!s?.once,context:s?.context};let a=t[e];return a||(t[e]=a=[]),a.push({handler:r,options:n,removed:!1}),t}_internalRemoveEventListener(t,e,i){if("string"!=typeof e||!t)return;const s=i,r=t[e];if(r)for(let t=0;t<r.length;t++){if(r[t].handler===s){r.splice(t,1);break}}0===r.length&&delete t[e]}_invokeLocalListeners(t,e){if(!this._listeners)return;const i=this._listeners[e??t?.type];if(i&&i.length>0){const e=i.slice();for(const i of e)i.handler.call(i.options?.context||this,t),i.options.once&&(i.removed=!0);for(let t=i.length-1;t>=0;t--)i[t].removed&&i.splice(t,1)}}}}}const r=new ArrayBuffer(4),n=new Float32Array(r),a=new Uint32Array(r);function o(t){return n[0]=t,n[0]}function h(t){return t%1==0&&t>=0&&0==(t&t-1)}function l(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function u(t){n[0]=t;let e,i=a[0];const s=(2147483648&i)>>>16;if(i&=2147483647,i>=1199570944)e=31744|(i>2139095040?512|i>>>13&1023:0);else if(i<=855638016)e=0;else if(i<947912704){const t=125-(i>>>23);i=8388608|8388607&i,e=i>>>t+1;e+=i>>>t&1&(e|(0!=(i&(1<<t)-1)?1:0))}else i+=3355443200,e=i+4095+(i>>>13&1)>>>13&32767;return e|s}function c(t,e,i){const s=[],r=[];n[0]=t,s[0]=a[0],n[0]=e,s[1]=a[0],n[0]=i,s[2]=a[0];for(let t=0;t<2;t++){const e=2147483648&s[t];let i=2147483647&s[t];if(2139095040==(2139095040&i))r[t]=1984,0!=(8388607&i)?r[t]=2047:e&&(r[t]=0);else if(e||i<897581056)r[t]=0;else if(i>1199439872)r[t]=1983;else{if(i<947912704){i=(8388608|8388607&i)>>>113-(i>>>23)}else i+=3355443200;r[t]=i+65535+(i>>>17&1)>>>17&2047}}const o=2147483648&s[2];let h=2147483647&s[2];if(2139095040==(2139095040&h))r[2]=992,8388607&h?r[2]=1023:(o||h<905969664)&&(r[2]=0);else if(o)r[2]=0;else if(h>1199308800)r[2]=991;else{if(h<947912704){h=(8388608|8388607&h)>>>113-(h>>>23)}else h+=3355443200;r[2]=h+131071+(h>>>18&1)>>>18&1023}return 2047&r[0]|(2047&r[1])<<11|(1023&r[2])<<22}var d,p,m;!function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.TOP=3]="TOP",t[t.FRONT=4]="FRONT",t[t.BACK=5]="BACK"}(d||(d={})),function(t){t[t.NOT_CLIPPED=0]="NOT_CLIPPED",t[t.A_INSIDE_B=1]="A_INSIDE_B",t[t.B_INSIDE_A=2]="B_INSIDE_A",t[t.CLIPPED=2]="CLIPPED"}(p||(p={})),function(t){t[t.PX=0]="PX",t[t.NX=1]="NX",t[t.PY=2]="PY",t[t.NY=3]="NY",t[t.PZ=4]="PZ",t[t.NZ=5]="NZ"}(m||(m={}));const f=new Float32Array([1,0,0,0,1,0,0,0,1]),_=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class g extends Float32Array{equalsTo(t,e){if(!t||this.length!==t.length)return!1;if(this===t)return!0;for(let i=0;i<this.length;i++){const s=this[i],r=t[i],n=e??1e-4*Math.max(1,Math.abs(s),Math.abs(r));if(Math.abs(s-r)>n)return!1}return!0}toString(){const t=[...this].map((t=>t.toFixed(3)));return`${this.constructor.name}{${t.join(",")}}`}isNaN(){for(let t=0;t<this.length;t++)if(Number.isNaN(this[t]))return!0;return!1}setRandom(t,e){for(let i=0;i<this.length;i++)this[i]=t+(e-t)*Math.random()}}class x extends g{constructor(t,e){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,2);else if(super(2),"number"==typeof t&&"number"==typeof e)this[0]=t,this[1]=e;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=2)this[0]=t[0],this[1]=t[1];else if(void 0!==t)throw new Error("Vector2.constructor(): invalid arguments")}clone(){return new x(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]}setXY(t,e){return this[0]=t,this[1]=e,this}setAndNormalize(t,e){const i=Math.sqrt(t*t+e*e);return this.setXY(t/i,e/i)}subBy(t){return x.sub(this,t,this)}addBy(t){return x.add(this,t,this)}mulBy(t){return x.mul(this,t,this)}divBy(t){return x.div(this,t,this)}scaleBy(t){return x.scale(this,t,this)}inplaceNormalize(){return x.normalize(this,this)}inplaceInverse(){return x.inverse(this,this)}inplaceMin(t){return x.min(this,t,this)}inplaceMax(t){return x.max(this,t,this)}static zero(){return new x(0,0)}static one(){return new x(1,1)}static axisPX(){return new x(1,0)}static axisNX(){return new x(-1,0)}static axisPY(){return new x(0,1)}static axisNY(){return new x(0,-1)}static distance(t,e){return Math.sqrt(this.distanceSq(t,e))}static distanceSq(t,e){const i=t.x-e.x,s=t.y-e.y;return i*i+s*s}static normalize(t,e){const i=t.magnitude,s=t.x/i,r=t.y/i;return(e||new x).setXY(s,r)}static inverse(t,e){const i=1/t.x,s=1/t.y;return(e||new x).setXY(i,s)}static sub(t,e,i){const s=t.x-e.x,r=t.y-e.y;return(i||new x).setXY(s,r)}static add(t,e,i){const s=t.x+e.x,r=t.y+e.y;return(i||new x).setXY(s,r)}static mul(t,e,i){const s=t.x*e.x,r=t.y*e.y;return(i||new x).setXY(s,r)}static div(t,e,i){const s=t.x/e.x,r=t.y/e.y;return(i||new x).setXY(s,r)}static scale(t,e,i){const s=t.x*e,r=t.y*e;return(i||new x).setXY(s,r)}static min(t,e,i){const s=t.x<e.x?t.x:e.x,r=t.y<e.y?t.y:e.y;return(i||new x).setXY(s,r)}static max(t,e,i){const s=t.x>e.x?t.x:e.x,r=t.y>e.y?t.y:e.y;return(i||new x).setXY(s,r)}static abs(t,e){const i=t.x<0?-t.x:t.x,s=t.y<0?-t.y:t.y;return(e||new x).setXY(i,s)}static dot(t,e){return t.x*e.x+t.y*e.y}static cross(t,e){return t.x*e.y-t.y*e.x}}class b extends g{constructor(t,e,i){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,3);else if(super(3),"number"==typeof t&&"number"==typeof e&&"number"==typeof i)this[0]=t,this[1]=e,this[2]=i;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=3)this[0]=t[0],this[1]=t[1],this[2]=t[2];else if(void 0!==t)throw new Error("Vector3.constructor(): invalid arguments")}clone(){return new b(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]}xy(){return new x(this.x,this.y)}setXYZ(t,e,i){return this[0]=t,this[1]=e,this[2]=i,this}setAndNormalize(t,e,i){const s=Math.sqrt(t*t+e*e+i*i);return this.setXYZ(t/s,e/s,i/s)}subBy(t){return b.sub(this,t,this)}addBy(t){return b.add(this,t,this)}mulBy(t){return b.mul(this,t,this)}divBy(t){return b.div(this,t,this)}scaleBy(t){return b.scale(this,t,this)}inplaceNormalize(){return b.normalize(this,this)}inplaceInverse(){return b.inverse(this,this)}inplaceMin(t){return b.min(this,t,this)}inplaceMax(t){return b.max(this,t,this)}static zero(){return new b(0,0,0)}static one(){return new b(1,1,1)}static axisPX(){return new b(1,0,0)}static axisNX(){return new b(-1,0,0)}static axisPY(){return new b(0,1,0)}static axisNY(){return new b(0,-1,0)}static axisPZ(){return new b(0,0,1)}static axisNZ(){return new b(0,0,-1)}static distance(t,e){return Math.sqrt(this.distanceSq(t,e))}static distanceSq(t,e){const i=t.x-e.x,s=t.y-e.y,r=t.z-e.z;return i*i+s*s+r*r}static normalize(t,e){const i=t.magnitude,s=t.x/i,r=t.y/i,n=t.z/i;return(e||new b).setXYZ(s,r,n)}static inverse(t,e){const i=1/t.x,s=1/t.y,r=1/t.z;return(e||new b).setXYZ(i,s,r)}static sub(t,e,i){const s=t.x-e.x,r=t.y-e.y,n=t.z-e.z;return(i||new b).setXYZ(s,r,n)}static add(t,e,i){const s=t.x+e.x,r=t.y+e.y,n=t.z+e.z;return(i||new b).setXYZ(s,r,n)}static mul(t,e,i){const s=t.x*e.x,r=t.y*e.y,n=t.z*e.z;return(i||new b).setXYZ(s,r,n)}static div(t,e,i){const s=t.x/e.x,r=t.y/e.y,n=t.z/e.z;return(i||new b).setXYZ(s,r,n)}static scale(t,e,i){const s=t.x*e,r=t.y*e,n=t.z*e;return(i||new b).setXYZ(s,r,n)}static min(t,e,i){const s=t.x<e.x?t.x:e.x,r=t.y<e.y?t.y:e.y,n=t.z<e.z?t.z:e.z;return(i||new b).setXYZ(s,r,n)}static max(t,e,i){const s=t.x>e.x?t.x:e.x,r=t.y>e.y?t.y:e.y,n=t.z>e.z?t.z:e.z;return(i||new b).setXYZ(s,r,n)}static abs(t,e){const i=t.x<0?-t.x:t.x,s=t.y<0?-t.y:t.y,r=t.z<0?-t.z:t.z;return(e||new b).setXYZ(i,s,r)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e,i){const s=t.y*e.z-t.z*e.y,r=t.z*e.x-t.x*e.z,n=t.x*e.y-t.y*e.x;return(i||new b).setXYZ(s,r,n)}}class w extends b{_callback;get callback(){return this._callback}set callback(t){this._callback=t}get x(){return super.x}set x(t){(t=o(t))!==super.x&&(super.x=t,this._callback&&this._callback())}get y(){return super.y}set y(t){(t=o(t))!==super.y&&(super.y=t,this._callback&&this._callback())}get z(){return super.z}set z(t){(t=o(t))!==super.z&&(super.z=t,this._callback&&this._callback())}setXYZ(t,e,i){return t=o(t),e=o(e),i=o(i),t===super.x&&e===super.y&&i===super.z||(super.setXYZ(t,e,i),this._callback&&this._callback()),this}copyWithin(t,e,i){return super.copyWithin(t,e,i),this._callback&&this._callback(),this}fill(t,e,i){return super.fill(t,e,i),this._callback&&this._callback(),this}reverse(){return super.reverse(),this._callback&&this._callback(),this}set(t,e){super.set(t,e),this._callback&&this._callback()}sort(t){return super.sort(t),this._callback&&this._callback(),this}}class T extends g{constructor(t,e,i,s){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,4);else if(super(4),"number"==typeof t&&"number"==typeof e&&"number"==typeof i&&"number"==typeof s)this[0]=t,this[1]=e,this[2]=i,this[3]=s;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=4)this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3];else if(void 0!==t)throw new Error("Vector4.constructor(): invalid arguments")}clone(){return new T(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3]}xy(){return new x(this.x,this.y)}xyz(){return new b(this.x,this.y,this.z)}setXYZW(t,e,i,s){return this[0]=t,this[1]=e,this[2]=i,this[3]=s,this}setAndNormalize(t,e,i,s){const r=Math.sqrt(t*t+e*e+i*i+s*s);return this.setXYZW(t/r,e/r,i/r,s/r)}subBy(t){return T.sub(this,t,this)}addBy(t){return T.add(this,t,this)}mulBy(t){return T.mul(this,t,this)}divBy(t){return T.div(this,t,this)}scaleBy(t){return T.scale(this,t,this)}inplaceNormalize(){return T.normalize(this,this)}inplaceInverse(){return T.inverse(this,this)}inplaceMin(t){return T.min(this,t,this)}inplaceMax(t){return T.max(this,t,this)}static zero(){return new T(0,0,0,0)}static one(){return new T(1,1,1,1)}static axisPX(){return new T(1,0,0,0)}static axisNX(){return new T(-1,0,0,0)}static axisPY(){return new T(0,1,0,0)}static axisNY(){return new T(0,-1,0,0)}static axisPZ(){return new T(0,0,1,0)}static axisNZ(){return new T(0,0,-1,0)}static axisPW(){return new T(0,0,0,1)}static axisNW(){return new T(0,0,0,-1)}static normalize(t,e){const i=t.magnitude,s=t.x/i,r=t.y/i,n=t.z/i,a=t.w/i;return(e||new T).setXYZW(s,r,n,a)}static inverse(t,e){const i=1/t.x,s=1/t.y,r=1/t.z,n=1/t.w;return(e||new T).setXYZW(i,s,r,n)}static sub(t,e,i){const s=t.x-e.x,r=t.y-e.y,n=t.z-e.z,a=t.w-e.w;return(i||new T).setXYZW(s,r,n,a)}static add(t,e,i){const s=t.x+e.x,r=t.y+e.y,n=t.z+e.z,a=t.w+e.w;return(i||new T).setXYZW(s,r,n,a)}static mul(t,e,i){const s=t.x*e.x,r=t.y*e.y,n=t.z*e.z,a=t.w*e.w;return(i||new T).setXYZW(s,r,n,a)}static div(t,e,i){const s=t.x/e.x,r=t.y/e.y,n=t.z/e.z,a=t.w/e.w;return(i||new T).setXYZW(s,r,n,a)}static scale(t,e,i){const s=t.x*e,r=t.y*e,n=t.z*e,a=t.w*e;return(i||new T).setXYZW(s,r,n,a)}static min(t,e,i){const s=t.x<e.x?t.x:e.x,r=t.y<e.y?t.y:e.y,n=t.z<e.z?t.z:e.z,a=t.w<e.w?t.w:e.w;return(i||new T).setXYZW(s,r,n,a)}static max(t,e,i){const s=t.x>e.x?t.x:e.x,r=t.y>e.y?t.y:e.y,n=t.z>e.z?t.z:e.z,a=t.w>e.w?t.w:e.w;return(i||new T).setXYZW(s,r,n,a)}static abs(t,e){const i=t.x<0?-t.x:t.x,s=t.y<0?-t.y:t.y,r=t.z<0?-t.z:t.z,n=t.w<0?-t.w:t.w;return(e||new T).setXYZW(i,s,r,n)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}}class v extends g{constructor(t,e,i,s){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,4);else if(super(4),"number"==typeof t&&"number"==typeof e&&"number"==typeof i&&"number"==typeof s)this[0]=t,this[1]=e,this[2]=i,this[3]=s;else if(t instanceof E||t instanceof S)this.fromRotationMatrix(t);else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=4)this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3];else{if(void 0!==t)throw new Error("Quaternion.constructor(): invalid arguments");this[0]=0,this[1]=0,this[2]=0,this[3]=1}}clone(){return new v(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}setXYZW(t,e,i,s){return this[0]=t,this[1]=e,this[2]=i,this[3]=s,this}scaleBy(t){return v.scale(this,t,this)}setAndNormalize(t,e,i,s){const r=Math.sqrt(t*t+e*e+i*i+s*s);return this.setXYZW(t/r,e/r,i/r,s/r)}get magnitude(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3]}identity(){return v.identity(this)}inplaceNormalize(){return v.normalize(this,this)}inplaceConjugate(){return v.conjugate(this,this)}multiplyRight(t){return v.multiply(this,t,this)}multiplyLeft(t){return v.multiply(t,this,this)}unitVectorToUnitVector(t,e){return v.unitVectorToUnitVector(t,e,this)}fromEulerAngle(t,e,i,s){return v.fromEulerAngle(t,e,i,s,this)}fromAxisAngle(t,e){return v.fromAxisAngle(t,e,this)}toAxisAngle(t){const e=2*Math.acos(this[3]),i=Math.sin(e/2);return i>1e-6?t.setXYZ(this[0]/i,this[1]/2,this[2]/i):t.setXYZ(1,0,0),e}toEulerAngles(t){t=t??new b;const e=2*(this.w*this.x+this.y*this.z),i=1-2*(this.x*this.x+this.y*this.y),s=Math.atan2(e,i),r=Math.max(-1,Math.min(1,2*(this.w*this.y-this.z*this.x))),n=Math.asin(r),a=2*(this.w*this.z+this.x*this.y),o=1-2*(this.y*this.y+this.z*this.z),h=Math.atan2(a,o);return t.setXYZ(s,n,h)}fromRotationMatrix(t){return v.fromRotationMatrix(t,this)}toMatrix3x3(t){const e=t||new E;return this.toMatrix(e),e}toMatrix4x4(t){const e=t||S.identity();return this.toMatrix(e),e}getDirectionX(t){return(t=t??new b).setXYZ(1-2*(this.y*this.y+this.z*this.z),2*(this.x*this.y+this.z*this.w),2*(this.z*this.x-this.y*this.w))}getDirectionY(t){return(t=t??new b).setXYZ(2*(this.x*this.y-this.z*this.w),1-2*(this.z*this.z+this.x*this.x),2*(this.y*this.z+this.x*this.w))}getDirectionZ(t){return(t=t??new b).setXYZ(2*(this.z*this.x+this.y*this.w),2*(this.y*this.z-this.x*this.w),1-2*(this.y*this.y+this.x*this.x))}getAxisAngle(t){t=t??new T;const e=this.w<0?-1:1,i=this.x*e,s=this.y*e,r=this.z*e,n=this.w*e,a=Math.acos(n),o=Math.sin(a);return t.setXYZW(i/o,s/o,r/o,2*a)}transform(t,e){e=e||new b;const i=2*this.x,s=2*this.y,r=2*this.z,n=this.x*i,a=this.y*s,o=this.z*r,h=this.x*s,l=this.x*r,u=this.y*r,c=this.w*i,d=this.w*s,p=this.w*r;return e.setXYZ((1-a-o)*t.x+(h-p)*t.y+(l+d)*t.z,(h+p)*t.x+(1-n-o)*t.y+(u-c)*t.z,(l-d)*t.x+(u+c)*t.y+(1-n-a)*t.z)}static scale(t,e,i){return(i=i||t).setXYZW(t.x*e,t.y*e,t.z*e,t.w*e)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static identity(t){return(t||new v).setXYZW(0,0,0,1)}static normalize(t,e){const i=t.magnitude;return(e||new v).setXYZW(t.x/i,t.y/i,t.z/i,t.w/i)}static conjugate(t,e){return(e||new v).setXYZW(-t.x,-t.y,-t.z,t.w)}static multiply(t,e,i){i=i||new v;const s=t.x*e.w+t.w*e.x+t.y*e.z-t.z*e.y,r=t.y*e.w+t.w*e.y+t.z*e.x-t.x*e.z,n=t.z*e.w+t.w*e.z+t.x*e.y-t.y*e.x,a=t.w*e.w-t.x*e.x-t.y*e.y-t.z*e.z;return i.setXYZW(s,r,n,a)}static slerp(t,e,i,s){if(s=s||new v,i<=0)return s.setXYZW(t.x,t.y,t.z,t.w);if(i>=1)return s.setXYZW(e.x,e.y,e.z,e.w);const r=this.dot(t,e),n=r<0?-1:1,a=t.x,o=t.y,h=t.z,l=t.w,u=e.x*n,c=e.y*n,d=e.z*n,p=e.w*n,m=r*n;if(m>=1)return s.setXYZW(a,o,h,l);const f=1-m*m;if(f<=Number.EPSILON){const r=1-i;return s.setAndNormalize(t.x*r+e.x*i,t.y*r+e.y*i,t.z*r+e.z*i,t.w*r+e.w*i)}const _=Math.sqrt(f),g=Math.atan2(_,m),x=Math.sin((1-i)*g)/_,b=Math.sin(i*g)/_;return s.setXYZW(a*x+u*b,o*x+c*b,h*x+d*b,l*x+p*b)}static angleBetween(t,e){const i=this.dot(t,e),s=i<-1?-1:i>1?1:i;return 2*Math.acos(Math.abs(s))}static unitVectorToUnitVector(t,e,i){i=i||new v;let s=b.dot(t,e)+1;return s<1e-6?(s=0,Math.abs(t.x)>Math.abs(t.z)?i.setAndNormalize(-t.y,t.x,0,s):i.setAndNormalize(0,-t.z,t.y,s)):i.setAndNormalize(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x,s)}static fromEulerAngle(t,e,i,s,r){r=r||new v;const n=Math.cos(t/2),a=Math.cos(e/2),o=Math.cos(i/2),h=Math.sin(t/2),l=Math.sin(e/2),u=Math.sin(i/2);switch(s){case"XYZ":return r.setXYZW(h*a*o+n*l*u,n*l*o-h*a*u,n*a*u+h*l*o,n*a*o-h*l*u);case"YXZ":return r.setXYZW(h*a*o+n*l*u,n*l*o-h*a*u,n*a*u-h*l*o,n*a*o+h*l*u);case"ZXY":return r.setXYZW(h*a*o-n*l*u,n*l*o+h*a*u,n*a*u+h*l*o,n*a*o-h*l*u);case"ZYX":return r.setXYZW(h*a*o-n*l*u,n*l*o+h*a*u,n*a*u-h*l*o,n*a*o+h*l*u);case"YZX":return r.setXYZW(h*a*o+n*l*u,n*l*o+h*a*u,n*a*u-h*l*o,n*a*o-h*l*u);case"XZY":return r.setXYZW(h*a*o-n*l*u,n*l*o-h*a*u,n*a*u+h*l*o,n*a*o+h*l*u)}}static fromAxisAngle(t,e,i){i=i||new v;const s=e/2,r=Math.sin(s);return i.setXYZW(t.x*r,t.y*r,t.z*r,Math.cos(s))}static fromRotationMatrix(t,e){e=e||new v;const i=t.m00+t.m11+t.m22;let s;return i>0?(s=.5/Math.sqrt(i+1),e.setXYZW((t.m21-t.m12)*s,(t.m02-t.m20)*s,(t.m10-t.m01)*s,.25/s)):t.m00>t.m11&&t.m00>t.m22?(s=2*Math.sqrt(1+t.m00-t.m11-t.m22),e.setXYZW(.25*s,(t.m01+t.m10)/s,(t.m02+t.m20)/s,(t.m21-t.m12)/s)):t.m11>t.m22?(s=2*Math.sqrt(1-t.m00+t.m11-t.m22),e.setXYZW((t.m10+t.m01)/s,.25*s,(t.m21+t.m12)/s,(t.m02-t.m20)/s)):(s=2*Math.sqrt(1-t.m00-t.m11+t.m22),e.setXYZW((t.m02+t.m20)/s,(t.m12+t.m21)/s,.25*s,(t.m10-t.m01)/s)),e}toMatrix(t){const e=this.x*this.x,i=this.y*this.y,s=this.z*this.z,r=this.x*this.y,n=this.z*this.w,a=this.z*this.x,o=this.y*this.w,h=this.y*this.z,l=this.x*this.w;t.m00=1-2*(i+s),t.m10=2*(r+n),t.m20=2*(a-o),t.m01=2*(r-n),t.m11=1-2*(s+e),t.m21=2*(h+l),t.m02=2*(a+o),t.m12=2*(h-l),t.m22=1-2*(i+e)}}class y extends v{_callback;get callback(){return this._callback}set callback(t){this._callback=t}get x(){return super.x}set x(t){(t=o(t))!==super.x&&(super.x=t,this._callback&&this._callback())}get y(){return super.y}set y(t){(t=o(t))!==super.y&&(super.y=t,this._callback&&this._callback())}get z(){return super.z}set z(t){(t=o(t))!==super.z&&(super.z=t,this._callback&&this._callback())}get w(){return super.w}set w(t){(t=o(t))!==super.w&&(super.w=t,this._callback&&this._callback())}setXYZW(t,e,i,s){return t=o(t),e=o(e),i=o(i),s=o(s),t===super.x&&e===super.y&&i===super.z&&s===super.w||(super.setXYZW(t,e,i,s),this._callback&&this._callback()),this}copyWithin(t,e,i){return super.copyWithin(t,e,i),this._callback&&this._callback(),this}fill(t,e,i){return super.fill(t,e,i),this._callback&&this._callback(),this}reverse(){return super.reverse(),this._callback&&this._callback(),this}set(t,e){super.set(t,e),this._callback&&this._callback()}sort(t){return super.sort(t),this._callback&&this._callback(),this}}class E extends g{constructor(t,e,i,s,r,n,a,o,h){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,9);else if(super(9),"number"==typeof t)this[0]=t,this[1]=e,this[2]=i,this[3]=s,this[4]=r,this[5]=n,this[6]=a,this[7]=o,this[8]=h;else if(t instanceof v)t.toMatrix3x3(this);else if(t instanceof S)this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[4],this[4]=t[5],this[5]=t[6],this[6]=t[8],this[7]=t[9],this[8]=t[10];else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=9)this.set(t);else{if(void 0!==t)throw new Error("Matrix3x4.constructor(): invalid arguments");this.identity()}}clone(){return new E(this)}get m00(){return this[0]}set m00(t){this[0]=t}get m10(){return this[1]}set m10(t){this[1]=t}get m20(){return this[2]}set m20(t){this[2]=t}get m01(){return this[3]}set m01(t){this[3]=t}get m11(){return this[4]}set m11(t){this[4]=t}get m21(){return this[5]}set m21(t){this[5]=t}get m02(){return this[6]}set m02(t){this[6]=t}get m12(){return this[7]}set m12(t){this[7]=t}get m22(){return this[8]}set m22(t){this[8]=t}getRow(t,e){return(e||new b).setXYZ(this[3*t],this[3*t+1],this[3*t+2])}setRow(t,e){return this[3*t]=e.x,this[3*t+1]=e.y,this[3*t+2]=e.z,this}setRowXYZ(t,e,i,s){return this[3*t]=e,this[3*t+1]=i,this[3*t+2]=s,this}getCol(t,e){return(e||new b).setXYZ(this[t],this[3+t],this[6+t])}setCol(t,e){return this[t]=e.x,this[3+t]=e.y,this[6+t]=e.z,this}setColXYZ(t,e,i,s){return this[t]=e,this[3+t]=i,this[6+t]=s,this}static add(t,e,i){i=i||new E;for(let s=0;s<9;s++)i[s]=t[s]+e[s];return i}static sub(t,e,i){i=i||new E;for(let s=0;s<9;s++)i[s]=t[s]-e[s];return i}static mul(t,e,i){i=i||new E;for(let s=0;s<9;s++)i[s]=t[s]*e[s];return i}static div(t,e,i){i=i||new E;for(let s=0;s<9;s++)i[s]=t[s]/e[s];return i}static scale(t,e,i){i=i||new E;for(let s=0;s<9;s++)i[s]=t[s]*e;return i}static identity(t){return(t=t||new E).set(f),t}static transpose(t,e){return t===(e=e||new E)?([e[1],e[3]]=[e[3],e[1]],[e[2],e[6]]=[e[6],e[2]],[e[5],e[7]]=[e[7],e[5]]):(e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]),e}static invert(t,e){e=e||new E;const i=t[0],s=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],u=t[8],c=u*a-o*l,d=o*h-u*n,p=l*n-h*a,m=1/(i*c+s*d+r*p);return e[0]=c*m,e[1]=(r*l-u*s)*m,e[2]=(o*s-r*a)*m,e[3]=d*m,e[4]=(u*i-r*h)*m,e[5]=(r*n-o*i)*m,e[6]=p*m,e[7]=(s*h-l*i)*m,e[8]=(a*i-s*n)*m,e}static rotationX(t,e){e=e||new E;const i=Math.cos(t),s=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=i,e[5]=s,e[6]=0,e[7]=-s,e[8]=i,e}static rotationY(t,e){e=e||new E;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=0,e[2]=-s,e[3]=0,e[4]=1,e[5]=0,e[6]=s,e[7]=0,e[8]=i,e}static rotationZ(t,e){e=e||new E;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=-s,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}static rotation(t,e,i){i=i||new E;let s=t.x,r=t.y,n=t.z;const a=Math.sqrt(s*s+r*r+n*n);s/=a,r/=a,n/=a;const o=s*s,h=r*r,l=n*n,u=Math.cos(e),c=Math.sin(e),d=1-u;return i[0]=o+(1-o)*u,i[1]=s*r*d+n*c,i[2]=s*n*d-r*c,i[3]=s*r*d-n*c,i[4]=h+(1-h)*u,i[5]=r*n*d+s*c,i[6]=s*n*d+r*c,i[7]=r*n*d-s*c,i[8]=l+(1-l)*u,i}static multiply(t,e,i){i=i||new E;const s=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],u=t[7],c=t[8],d=e[0],p=e[1],m=e[2],f=e[3],_=e[4],g=e[5],x=e[6],b=e[7],w=e[8];return i[0]=s*d+a*p+l*m,i[1]=r*d+o*p+u*m,i[2]=n*d+h*p+c*m,i[3]=s*f+a*_+l*g,i[4]=r*f+o*_+u*g,i[5]=n*f+h*_+c*g,i[6]=s*x+a*b+l*w,i[7]=r*x+o*b+u*w,i[8]=n*x+h*b+c*w,i}subBy(t){return E.sub(this,t,this)}addBy(t){return E.add(this,t,this)}mulBy(t){return E.mul(this,t,this)}divBy(t){return E.div(this,t,this)}scaleBy(t){return E.scale(this,t,this)}identity(){return E.identity(this)}inplaceInvert(){return E.invert(this,this)}transpose(){return E.transpose(this,this)}multiplyRight(t){return E.multiply(this,t,this)}multiplyLeft(t){return E.multiply(t,this,this)}rotationX(t){return E.rotationX(t,this)}rotationY(t){return E.rotationY(t,this)}rotationZ(t){return E.rotationZ(t,this)}rotation(t,e){return E.rotation(t,e,this)}transform(t,e){return(e=e||new b).setXYZ(this[0]*t[0]+this[3]*t[1]+this[6]*t[2],this[1]*t[0]+this[4]*t[1]+this[7]*t[2],this[2]*t[0]+this[5]*t[1]+this[8]*t[2])}transformPoint(t,e){return this.transform(t,e)}transformVector(t,e){return this.transform(t,e)}}class S extends g{constructor(t,e,i,s,r,n,a,o,h,l,u,c,d,p,m,f){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,16);else if(super(16),"number"==typeof t)this[0]=t,this[1]=e,this[2]=i,this[3]=s,this[4]=r,this[5]=n,this[6]=a,this[7]=o,this[8]=h,this[9]=l,this[10]=u,this[11]=c,this[12]=d,this[13]=p,this[14]=m,this[15]=f;else if(t instanceof v)t.toMatrix4x4(this),this.m03=0,this.m13=0,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=1;else if(t instanceof E)this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=0,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=0,this.m20=t.m20,this.m21=t.m21,this.m22=t.m22,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=1;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=16)this.set(t);else{if(void 0!==t)throw new Error("Matrix4x4.constructor(): invalid arguments");this.identity()}}clone(){return new S(this)}get m00(){return this[0]}set m00(t){this[0]=t}get m10(){return this[1]}set m10(t){this[1]=t}get m20(){return this[2]}set m20(t){this[2]=t}get m30(){return this[3]}set m30(t){this[3]=t}get m01(){return this[4]}set m01(t){this[4]=t}get m11(){return this[5]}set m11(t){this[5]=t}get m21(){return this[6]}set m21(t){this[6]=t}get m31(){return this[7]}set m31(t){this[7]=t}get m02(){return this[8]}set m02(t){this[8]=t}get m12(){return this[9]}set m12(t){this[9]=t}get m22(){return this[10]}set m22(t){this[10]=t}get m32(){return this[11]}set m32(t){this[11]=t}get m03(){return this[12]}set m03(t){this[12]=t}get m13(){return this[13]}set m13(t){this[13]=t}get m23(){return this[14]}set m23(t){this[14]=t}get m33(){return this[15]}set m33(t){this[15]=t}getRow(t,e){return(e||new T).setXYZW(this[4*t],this[4*t+1],this[4*t+2],this[4*t+3])}setRow(t,e){return this[4*t]=e.x,this[4*t+1]=e.y,this[4*t+2]=e.z,this[4*t+3]=e.w,this}setRowXYZW(t,e,i,s,r){return this[4*t]=e,this[4*t+1]=i,this[4*t+2]=s,this[4*t+3]=r,this}getCol(t,e){return(e||new T).setXYZW(this[t],this[4+t],this[8+t],this[12+t])}setCol(t,e){return this[t]=e.x,this[4+t]=e.y,this[8+t]=e.z,this[12+t]=e.w,this}setColXYZW(t,e,i,s,r){return this[t]=e,this[4+t]=i,this[8+t]=s,this[12+t]=r,this}static add(t,e,i){i=i||new S;for(let s=0;s<16;s++)i[s]=t[s]+e[s];return i}static sub(t,e,i){i=i||new S;for(let s=0;s<16;s++)i[s]=t[s]-e[s];return i}static mul(t,e,i){i=i||new S;for(let s=0;s<16;s++)i[s]=t[s]*e[s];return i}static div(t,e,i){i=i||new S;for(let s=0;s<16;s++)i[s]=t[s]/e[s];return i}static scale(t,e,i){i=i||new S;for(let s=0;s<16;s++)i[s]=t[s]*e;return i}static identity(t){return(t=t||new S).set(_),t}static ortho(t,e,i,s,r,n,a){return(a=a||new S)[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(s-i),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2/(r-n),a[11]=0,a[12]=(t+e)/(t-e),a[13]=(i+s)/(i-s),a[14]=(r+n)/(r-n),a[15]=1,a}static reflection(t,e,i,s,r){return(r=r||new S).m00=1-2*t*t,r.m01=-2*t*e,r.m02=-2*t*i,r.m03=-2*t*s,r.m10=-2*t*e,r.m11=1-2*e*e,r.m12=-2*e*i,r.m13=-2*e*s,r.m20=-2*t*i,r.m21=-2*e*i,r.m22=1-2*i*i,r.m23=-2*i*s,r.m30=0,r.m31=0,r.m32=0,r.m33=1,r}static perspective(t,e,i,s,r){const n=i*Math.tan(.5*t),a=n*e;return this.frustum(-a,a,-n,n,i,s,r)}static obliqueProjection(t,e){const i=new S(t),s=S.invert(t).transform(new T(e.a>0?1:-1,e.b>0?1:-1,1,1)),r=2/(s.x*e.a+s.y*e.b+s.z*e.c+s.w*e.d);return i[2]=e.a*r-i[3],i[6]=e.b*r-i[7],i[10]=e.c*r-i[11],i[14]=e.d*r-i[15],i}static obliquePerspective(t,e){const i=new S(t),s=new T(((e.x>0?1:e.x<0?-1:0)+t.m02)/t.m00,((e.y>0?1:e.y<0?-1:0)+t.m12)/t.m11,-1,(1+t.m22)/t.m23),r=T.scale(e,2/T.dot(e,s));return i.m20=r.x,i.m21=r.y,i.m22=r.z+1,i.m23=r.w,i}static frustum(t,e,i,s,r,n,a){const o=e-t,h=s-i,l=r-n;return(a=a||new S)[0]=2*r/o,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*r/h,a[6]=0,a[7]=0,a[8]=(t+e)/o,a[9]=(s+i)/h,a[10]=(r+n)/l,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*r*n/l,a[15]=0,a}static transpose(t,e){return t===(e=e||new S)?([e[1],e[4]]=[e[4],e[1]],[e[2],e[8]]=[e[8],e[2]],[e[3],e[12]]=[e[12],e[3]],[e[6],e[9]]=[e[9],e[6]],[e[7],e[13]]=[e[13],e[7]],[e[11],e[14]]=[e[14],e[11]]):(e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]),e}static invert(t,e){e=e||new S;const i=t[0],s=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],u=t[8],c=t[9],d=t[10],p=t[11],m=t[12],f=t[13],_=t[14],g=t[15],x=d*g,b=_*p,w=h*g,T=_*l,v=h*p,y=d*l,E=r*g,C=_*n,A=r*p,M=d*n,R=r*l,F=h*n,I=u*f,D=m*c,$=a*f,L=m*o,P=a*c,N=u*o,B=i*f,O=m*s,U=i*c,k=u*s,z=i*o,V=a*s,G=x*o+T*c+v*f-(b*o+w*c+y*f),X=b*s+E*c+M*f-(x*s+C*c+A*f),W=w*s+C*o+R*f-(T*s+E*o+F*f),H=y*s+A*o+F*c-(v*s+M*o+R*c),j=1/(i*G+a*X+u*W+m*H);return e[0]=j*G,e[1]=j*X,e[2]=j*W,e[3]=j*H,e[4]=j*(b*a+w*u+y*m-(x*a+T*u+v*m)),e[5]=j*(x*i+C*u+A*m-(b*i+E*u+M*m)),e[6]=j*(T*i+E*a+F*m-(w*i+C*a+R*m)),e[7]=j*(v*i+M*a+R*u-(y*i+A*a+F*u)),e[8]=j*(I*l+L*p+P*g-(D*l+$*p+N*g)),e[9]=j*(D*n+B*p+k*g-(I*n+O*p+U*g)),e[10]=j*($*n+O*l+z*g-(L*n+B*l+V*g)),e[11]=j*(N*n+U*l+V*p-(P*n+k*l+z*p)),e[12]=j*($*d+N*_+D*h-(P*_+I*h+L*d)),e[13]=j*(U*_+I*r+O*d-(B*d+k*_+D*r)),e[14]=j*(B*h+V*_+L*r-(z*_+$*r+O*h)),e[15]=j*(z*d+P*r+k*h-(U*h+V*d+N*r)),e}static invertAffine(t,e){e=e||new S;const i=t[0],s=t[1],r=t[2],n=t[4],a=t[5],o=t[6],h=t[8],l=t[9],u=t[10],c=t[12],d=t[13],p=t[14],m=u*a-o*l,f=r*l-u*s,_=o*s-r*a,g=1/(i*m+n*f+h*_);return e[0]=g*m,e[1]=g*f,e[2]=g*_,e[3]=0,e[4]=g*(o*h-u*n),e[5]=g*(u*i-r*h),e[6]=g*(r*n-o*i),e[7]=0,e[8]=g*(n*l-h*a),e[9]=g*(h*s-i*l),e[10]=g*(i*a-n*s),e[11]=0,e[12]=g*(n*d*u+h*a*p+c*l*o-(n*l*p+h*d*o+c*a*u)),e[13]=g*(i*l*p+h*d*r+c*s*u-(i*d*u+h*s*p+c*l*r)),e[14]=g*(i*d*o+n*s*p+c*a*r-(i*a*p+n*d*r+c*s*o)),e[15]=1,e}static translation(t,e){return(e=e||new S)[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t.x,e[13]=t.y,e[14]=t.z,e[15]=1,e}static scaling(t,e){return(e=e||new S)[0]=t.x,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t.y,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t.z,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotationX(t,e){e=e||new S;const i=Math.cos(t),s=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=s,e[7]=0,e[8]=0,e[9]=-s,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotationY(t,e){e=e||new S;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=0,e[2]=-s,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=s,e[9]=0,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotationZ(t,e){e=e||new S;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=0,e[4]=-s,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotation(t,e,i){i=i||new S;let s=t.x,r=t.y,n=t.z;const a=Math.sqrt(s*s+r*r+n*n);s/=a,r/=a,n/=a;const o=s*s,h=r*r,l=n*n,u=Math.cos(e),c=Math.sin(e),d=1-u;return i[0]=o+(1-o)*u,i[1]=s*r*d+n*c,i[2]=s*n*d-r*c,i[3]=0,i[4]=s*r*d-n*c,i[5]=h+(1-h)*u,i[6]=r*n*d+s*c,i[7]=0,i[8]=s*n*d+r*c,i[9]=r*n*d-s*c,i[10]=l+(1-l)*u,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}static lookAt(t,e,i,s){s=s||new S;const r=b.normalize(b.sub(t,e)),n=b.normalize(b.cross(i,r)),a=b.normalize(b.cross(r,n));return s[0]=n.x,s[1]=n.y,s[2]=n.z,s[3]=0,s[4]=a.x,s[5]=a.y,s[6]=a.z,s[7]=0,s[8]=r.x,s[9]=r.y,s[10]=r.z,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1,s}static lookAtCubeFace(t,e,i){switch(t){case m.PX:return this.lookAt(e,new b(e.x+1,e.y,e.z),new b(0,-1,0),i);case m.NX:return this.lookAt(e,new b(e.x-1,e.y,e.z),new b(0,-1,0),i);case m.PY:return this.lookAt(e,new b(e.x,e.y+1,e.z),new b(0,0,1),i);case m.NY:return this.lookAt(e,new b(e.x,e.y-1,e.z),new b(0,0,-1),i);case m.PZ:return this.lookAt(e,new b(e.x,e.y,e.z+1),new b(0,-1,0),i);case m.NZ:return this.lookAt(e,new b(e.x,e.y,e.z-1),new b(0,-1,0),i);default:return null}}static multiply(t,e,i){i=i||new S;const s=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],u=t[7],c=t[8],d=t[9],p=t[10],m=t[11],f=t[12],_=t[13],g=t[14],x=t[15],b=e[0],w=e[1],T=e[2],v=e[3],y=e[4],E=e[5],C=e[6],A=e[7],M=e[8],R=e[9],F=e[10],I=e[11],D=e[12],$=e[13],L=e[14],P=e[15];return i[0]=s*b+o*w+c*T+f*v,i[1]=r*b+h*w+d*T+_*v,i[2]=n*b+l*w+p*T+g*v,i[3]=a*b+u*w+m*T+x*v,i[4]=s*y+o*E+c*C+f*A,i[5]=r*y+h*E+d*C+_*A,i[6]=n*y+l*E+p*C+g*A,i[7]=a*y+u*E+m*C+x*A,i[8]=s*M+o*R+c*F+f*I,i[9]=r*M+h*R+d*F+_*I,i[10]=n*M+l*R+p*F+g*I,i[11]=a*M+u*R+m*F+x*I,i[12]=s*D+o*$+c*L+f*P,i[13]=r*D+h*$+d*L+_*P,i[14]=n*D+l*$+p*L+g*P,i[15]=a*D+u*$+m*L+x*P,i}static multiplyAffine(t,e,i){i=i||new S;const s=t[0],r=t[1],n=t[2],a=t[4],o=t[5],h=t[6],l=t[8],u=t[9],c=t[10],d=t[12],p=t[13],m=t[14],f=e[0],_=e[1],g=e[2],x=e[4],b=e[5],w=e[6],T=e[8],v=e[9],y=e[10],E=e[12],C=e[13],A=e[14];return i[0]=s*f+a*_+l*g,i[1]=r*f+o*_+u*g,i[2]=n*f+h*_+c*g,i[3]=0,i[4]=s*x+a*b+l*w,i[5]=r*x+o*b+u*w,i[6]=n*x+h*b+c*w,i[7]=0,i[8]=s*T+a*v+l*y,i[9]=r*T+o*v+u*y,i[10]=n*T+h*v+c*y,i[11]=0,i[12]=s*E+a*C+l*A+d,i[13]=r*E+o*C+u*A+p,i[14]=n*E+h*C+c*A+m,i[15]=1,i}static translateRight(t,e,i){if((i=i||new S)!==t)i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12],i[13]=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13],i[14]=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14],i[15]=t[15];else{const s=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12],r=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13],n=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14];i[12]=s,i[13]=r,i[14]=n}return i}static translateLeft(t,e,i){return(i=i||new S)!==t?(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12]+e.x,i[13]=t[13]+e.y,i[14]=t[14]+e.z,i[15]=t[15]):(i[12]+=e.x,i[13]+=e.y,i[14]+=e.z),i}static scaleRight(t,e,i){return(i=i||new S)!==t?(i[0]=t[0]*e.x,i[1]=t[1]*e.x,i[2]=t[2]*e.x,i[3]=t[3]*e.x,i[4]=t[4]*e.y,i[5]=t[5]*e.y,i[6]=t[6]*e.y,i[7]=t[7]*e.y,i[8]=t[8]*e.z,i[9]=t[9]*e.z,i[10]=t[10]*e.z,i[11]=t[11]*e.z,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):(i[0]*=e.x,i[1]*=e.x,i[2]*=e.x,i[3]*=e.x,i[4]*=e.y,i[5]*=e.y,i[6]*=e.y,i[7]*=e.y,i[8]*=e.z,i[9]*=e.z,i[10]*=e.z,i[11]*=e.z),i}static scaleLeft(t,e,i){return(i=i||new S)!==t?(i[0]=t[0]*e.x,i[1]=t[1]*e.y,i[2]=t[2]*e.z,i[3]=t[3],i[4]=t[4]*e.x,i[5]=t[5]*e.y,i[6]=t[6]*e.z,i[7]=t[7],i[8]=t[8]*e.x,i[9]=t[9]*e.y,i[10]=t[10]*e.z,i[11]=t[11],i[12]=t[12]*e.x,i[13]=t[13]*e.y,i[14]=t[14]*e.z,i[15]=t[15]):(i[0]*=e.x,i[1]*=e.y,i[2]*=e.z,i[4]*=e.x,i[5]*=e.y,i[6]*=e.z,i[8]*=e.x,i[9]*=e.y,i[10]*=e.z,i[12]*=e.x,i[13]*=e.y,i[14]*=e.z),i}static rotateRight(t,e,i){i=i||new S;const s=e instanceof v?new E(e):e,r=t[0],n=t[1],a=t[2],o=t[3],h=t[4],l=t[5],u=t[6],c=t[7],d=t[8],p=t[9],m=t[10],f=t[11],_=t[12],g=t[13],x=t[14],b=t[15],w=s.m00,T=s.m10,y=s.m20,C=s.m01,A=s.m11,M=s.m21,R=s.m02,F=s.m12,I=s.m22;return i[0]=r*w+h*T+d*y,i[1]=n*w+l*T+p*y,i[2]=a*w+u*T+m*y,i[3]=o*w+c*T+f*y,i[4]=r*C+h*A+d*M,i[5]=n*C+l*A+p*M,i[6]=a*C+u*A+m*M,i[7]=o*C+c*A+f*M,i[8]=r*R+h*F+d*I,i[9]=n*R+l*F+p*I,i[10]=a*R+u*F+m*I,i[11]=o*R+c*F+f*I,i[12]=_,i[13]=g,i[14]=x,i[15]=b,i}static rotateLeft(t,e,i){i=i||new S;const s=e instanceof v?new E(e):e,r=s.m00,n=s.m10,a=s.m20,o=s.m01,h=s.m11,l=s.m21,u=s.m02,c=s.m12,d=s.m22,p=t[0],m=t[1],f=t[2],_=t[3],g=t[4],x=t[5],b=t[6],w=t[7],T=t[8],y=t[9],C=t[10],A=t[11],M=t[12],R=t[13],F=t[14],I=t[15];return i[0]=r*p+o*m+u*f,i[1]=n*p+h*m+c*f,i[2]=a*p+l*m+d*f,i[3]=_,i[4]=r*g+o*x+u*b,i[5]=n*g+h*x+c*b,i[6]=a*g+l*x+d*b,i[7]=w,i[8]=r*T+o*y+u*C,i[9]=n*T+h*y+c*C,i[10]=a*T+l*y+d*C,i[11]=A,i[12]=r*M+o*R+u*F,i[13]=n*M+h*R+c*F,i[14]=a*M+l*R+d*F,i[15]=I,i}subBy(t){return S.sub(this,t,this)}addBy(t){return S.add(this,t,this)}mulBy(t){return S.mul(this,t,this)}divBy(t){return S.div(this,t,this)}scaleBy(t){return S.scale(this,t,this)}identity(){return S.identity(this)}perspective(t,e,i,s){return S.perspective(t,e,i,s,this)}frustum(t,e,i,s,r,n){return S.frustum(t,e,i,s,r,n,this)}ortho(t,e,i,s,r,n){return S.ortho(t,e,i,s,r,n,this)}isOrtho(){return 1===this[15]}isPerspective(){return 0===this[15]}getNearPlaneWidth(){return this.isPerspective()?2*this.getNearPlane()/this[0]:2/this[0]}getNearPlaneHeight(){return this.isPerspective()?2*this.getNearPlane()/this[5]:2/this[5]}getNearPlane(){return this.isPerspective()?this[14]/(this[10]-1):(this[14]+1)/this[10]}getFarPlaneWidth(){return this.isPerspective()?this.getNearPlaneWidth()*this.getFarPlane()/this.getNearPlane():this.getNearPlaneWidth()}getFarPlaneHeight(){return this.isPerspective()?this.getNearPlaneHeight()*this.getFarPlane()/this.getNearPlane():this.getNearPlaneHeight()}getFarPlane(){return this.isPerspective()?this[14]/(this[10]+1):(this[14]-1)/this[10]}getFov(){return this.isOrtho()?0:2*Math.atan(1/this[5])}getTanHalfFov(){return this.isOrtho()?0:1/this[5]}getAspect(){return this[5]/this[0]}getLeftPlane(){return(-1-this[12])/this[0]}getRightPlane(){return(1-this[12])/this[0]}getTopPlane(){return(1-this[13])/this[5]}getBottomPlane(){return(-1-this[13])/this[5]}setNearFar(t,e){return this.isPerspective()?this.perspective(this.getFov(),this.getAspect(),t,e):(this[10]=2/(t-e),this[14]=(t+e)/(t-e)),this}translation(t){return S.translation(t,this)}scaling(t){return S.scaling(t,this)}inplaceInvert(){return S.invert(this,this)}inplaceInvertAffine(){return S.invertAffine(this,this)}transpose(){return S.transpose(this,this)}multiplyRight(t){return S.multiply(this,t,this)}multiplyRightAffine(t){return S.multiplyAffine(this,t,this)}multiplyLeft(t){return S.multiply(t,this,this)}multiplyLeftAffine(t){return S.multiplyAffine(t,this,this)}rotationX(t){return S.rotationX(t,this)}rotationY(t){return S.rotationY(t,this)}rotationZ(t){return S.rotationZ(t,this)}rotation(t,e){return S.rotation(t,e,this)}translateRight(t){return S.translateRight(this,t,this)}translateLeft(t){return S.translateLeft(this,t,this)}scaleRight(t){return S.scaleRight(this,t,this)}scaleLeft(t){return S.scaleLeft(this,t,this)}rotateRight(t){return S.rotateRight(this,t,this)}rotateLeft(t){return S.rotateLeft(this,t,this)}lookAt(t,e,i){return S.lookAt(t,e,i,this)}transformPoint(t,e){return(e=e||new T).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14],this[3]*t[0]+this[7]*t[1]+this[11]*t[2]+this[15])}transformPointP(t,e){e=e||new b;const i=this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12],s=this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13],r=this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14],n=this[3]*t[0]+this[7]*t[1]+this[11]*t[2]+this[15];return e.setXYZ(i/n,s/n,r/n)}transformPointAffine(t,e){return(e=e||new b).setXYZ(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14])}transformVector(t,e){return(e=e||new T).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2],this[1]*t[0]+this[5]*t[1]+this[9]*t[2],this[2]*t[0]+this[6]*t[1]+this[10]*t[2],this[3]*t[0]+this[7]*t[1]+this[11]*t[2])}transformVectorAffine(t,e){return(e=e||new b).setXYZ(this[0]*t[0]+this[4]*t[1]+this[8]*t[2],this[1]*t[0]+this[5]*t[1]+this[9]*t[2],this[2]*t[0]+this[6]*t[1]+this[10]*t[2])}transform(t,e){return(e=e||new T).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12]*t[3],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13]*t[3],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14]*t[3],this[3]*t[0]+this[7]*t[1]+this[11]*t[2]+this[15]*t[3])}transformAffine(t,e){return(e=e||new T).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12]*t[3],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13]*t[3],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14]*t[3],t.w)}det(){const t=this[0],e=this[1],i=this[2],s=this[3],r=this[4],n=this[5],a=this[6],o=this[7],h=this[8],l=this[9],u=this[10],c=this[11],d=this[12],p=this[13],m=this[14],f=this[15],_=u*f-m*c,g=l*f-p*c,x=l*m-p*u,b=h*f-d*c,w=h*m-u*d,T=h*p-d*l;return t*+(n*_-a*g+o*x)+e*-(r*_-a*b+o*w)+i*+(r*g-n*b+o*T)+s*-(r*x-n*w+a*T)}decompose(t,e,i){i&&i.setXYZ(this[12],this[13],this[14]);const s=this.det()<=0?-1:1,r=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),n=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6])*s,a=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]);if(t&&t.setXYZ(r,n,a),e instanceof v){const t=new E(this);t[0]/=r,t[1]/=r,t[2]/=r,t[3]/=n,t[4]/=n,t[5]/=n,t[6]/=a,t[7]/=a,t[8]/=a,e.fromRotationMatrix(t)}else e instanceof E?(e[0]=this[0]/r,e[1]=this[1]/r,e[2]=this[2]/r,e[3]=this[4]/n,e[4]=this[5]/n,e[5]=this[6]/n,e[6]=this[8]/a,e[7]=this[9]/a,e[8]=this[10]/a):e instanceof S&&(e[0]=this[0]/r,e[1]=this[1]/r,e[2]=this[2]/r,e[3]=0,e[4]=this[4]/n,e[5]=this[5]/n,e[6]=this[6]/n,e[7]=0,e[8]=this[8]/a,e[9]=this[9]/a,e[10]=this[10]/a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1);return this}decomposeLookAt(t,e,i){return t&&t.setXYZ(this[12],this[13],this[14]),i&&i.setXYZ(this[4],this[5],this[6]),e&&e.setXYZ(this[12]-this[8],this[13]-this[9],this[14]-this[10]),this}toDualQuaternion(){const t=new b,e=new v,i=new b;this.decompose(i,e,t);const s=new v(.5*this.m03,.5*this.m13,.5*this.m23,0);return{real:e,dual:v.multiply(s,e),scale:i}}}class C extends g{_px;_py;_pz;_nx;_ny;_nz;_npDirty;constructor(t,e,i,s){switch(super(4),arguments.length){case 0:this[0]=0,this[1]=1,this[2]=0,this[3]=0,this._npDirty=!0;break;case 1:this.set(t);break;case 2:this.initWithOriginNormal(t,e);break;case 3:this.initWithPoints(t,e,i);break;case 4:this.setEquation(t,e,i,s);break;default:console.log("ERROR: Plane constructor must have 0/2/3/4 arguments")}}get a(){return this[0]}set a(t){this[0]=t,this._npDirty=!0}get b(){return this[1]}set b(t){this[1]=t,this._npDirty=!0}get c(){return this[2]}set c(t){this[2]=t,this._npDirty=!0}get d(){return this[3]}set d(t){this[3]=t,this._npDirty=!0}get px(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._px}get py(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._py}get pz(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._pz}get nx(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._nx}get ny(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._ny}get nz(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._nz}assign(t){return this._npDirty=!0,super.set(t),this}setEquation(t,e,i,s){return this[0]=t,this[1]=e,this[2]=i,this[3]=s,this._npDirty=!0,this}initWithOriginNormal(t,e){return this.setEquation(e.x,e.y,e.z,-b.dot(t,e))}initWithPoints(t,e,i){const s=b.cross(b.sub(e,t),b.sub(i,t)).inplaceNormalize();return this.initWithOriginNormal(t,s)}distanceToPoint(t){return t.x*this[0]+t.y*this[1]+t.z*this[2]+this[3]}nearestPointToPoint(t,e){const i=this.distanceToPoint(t);return(e||new b).setXYZ(t.x-this[0]*i,t.y-this[1]*i,t.z-this[2]*i)}getNormal(t){return(t||new b).setXYZ(this[0],this[1],this[2])}inplaceFlip(){return C.flip(this,this)}inplaceNormalize(){return C.normalize(this,this)}static flip(t,e){return(e||new C).setEquation(-t[0],-t[1],-t[2],-t[3])}static normalize(t,e){const i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return(e||new C).setEquation(t[0]/i,t[1]/i,t[2]/i,t[3]/i)}static transform(t,e,i){const s=S.transpose(S.invertAffine(e)).transform(new T(t[0],t[1],t[2],t[3])),r=i||t;return r.setEquation(s.x,s.y,s.z,s.w),r.inplaceNormalize()}_calcNP(){this._px=this[0]>0?1:-1,this._py=this[1]>0?1:-1,this._pz=this[2]>0?1:-1,this._nx=-this._px,this._ny=-this._py,this._nz=-this._pz}}const A=[[-1,-1,-1],[-1,-1,1],[-1,1,-1],[-1,1,1],[1,-1,-1],[1,-1,1],[1,1,-1],[1,1,1]];class M{static CORNER_LEFT_TOP_NEAR=0;static CORNER_LEFT_TOP_FAR=1;static CORNER_LEFT_BOTTOM_NEAR=2;static CORNER_LEFT_BOTTOM_FAR=3;static CORNER_RIGHT_TOP_NEAR=4;static CORNER_RIGHT_TOP_FAR=5;static CORNER_RIGHT_BOTTOM_NEAR=6;static CORNER_RIGHT_BOTTOM_FAR=7;_planes;_corners;constructor(t){this._planes=null,this._corners=null,t instanceof M?(this._planes=t._planes.map((t=>new C(t))),this._corners=t._corners.map((t=>new b(t)))):this.initWithMatrix(t)}get planes(){return this._planes}get corners(){return this._corners}getCorner(t){return this.corners[t]}containsPoint(t,e=1e-6){for(const i of this.planes)if(i.distanceToPoint(t)<-e)return!1;return!0}initWithMatrix(t){this._planes=this._planes||Array.from({length:6}).map((()=>new C)),this._planes[d.LEFT].setEquation(t.m30+t.m00,t.m31+t.m01,t.m32+t.m02,t.m33+t.m03).inplaceNormalize(),this._planes[d.RIGHT].setEquation(t.m30-t.m00,t.m31-t.m01,t.m32-t.m02,t.m33-t.m03).inplaceNormalize(),this._planes[d.BOTTOM].setEquation(t.m30+t.m10,t.m31+t.m11,t.m32+t.m12,t.m33+t.m13).inplaceNormalize(),this._planes[d.TOP].setEquation(t.m30-t.m10,t.m31-t.m11,t.m32-t.m12,t.m33-t.m13).inplaceNormalize(),this._planes[d.FRONT].setEquation(t.m30+t.m20,t.m31+t.m21,t.m32+t.m22,t.m33+t.m23).inplaceNormalize(),this._planes[d.BACK].setEquation(t.m30-t.m20,t.m31-t.m21,t.m32-t.m22,t.m33-t.m23).inplaceNormalize();const e=S.invert(t),i=A.map((t=>new b(t[0],t[1],t[2])));this._corners=this._corners||[];for(let t=0;t<8;t++){const s=e.transformPoint(i[t]);this._corners[t]=s.scaleBy(1/s.w).xyz()}return this}}class R{static ClipLeft=1<<d.LEFT;static ClipRight=1<<d.RIGHT;static ClipBottom=1<<d.BOTTOM;static ClipTop=1<<d.TOP;static ClipFront=1<<d.FRONT;static ClipBack=1<<d.BACK;_minPoint;_maxPoint;constructor(t,e){t instanceof R?(this._minPoint=new b(t.minPoint),this._maxPoint=new b(t.maxPoint)):t instanceof b?(this._minPoint=new b(t),this._maxPoint=new b(e)):(this._minPoint=new b(0,0,0),this._maxPoint=new b(0,0,0))}get minPoint(){return this._minPoint}set minPoint(t){this._minPoint.set(t)}get maxPoint(){return this._maxPoint}set maxPoint(t){this._maxPoint.set(t)}get extents(){return b.sub(this._maxPoint,this._minPoint).scaleBy(.5)}get center(){return b.add(this._maxPoint,this._minPoint).scaleBy(.5)}get size(){return b.sub(this._maxPoint,this._minPoint)}get diagonalLength(){return b.sub(this._maxPoint,this._minPoint).magnitude}computePoints(){const{x:t,y:e,z:i}=this._minPoint,{x:s,y:r,z:n}=this._maxPoint;return[new b(t,e,i),new b(t,r,i),new b(s,e,i),new b(s,r,i),new b(t,e,n),new b(t,r,n),new b(s,e,n),new b(s,r,n)]}inplaceTransform(t){return R.transform(this,t,this)}beginExtend(){this._minPoint.setXYZ(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this._maxPoint.setXYZ(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)}extend(t){this._minPoint.inplaceMin(t),this._maxPoint.inplaceMax(t)}extend3(t,e,i){t<this._minPoint.x&&(this._minPoint.x=t),t>this._maxPoint.x&&(this._maxPoint.x=t),e<this._minPoint.y&&(this._minPoint.y=e),e>this._maxPoint.y&&(this._maxPoint.y=e),i<this._minPoint.z&&(this._minPoint.z=i),i>this._maxPoint.z&&(this._maxPoint.z=i)}union(t){return t&&t.isValid()&&(this.extend(t._minPoint),this.extend(t._maxPoint)),this}isValid(){return this._minPoint.x<=this._maxPoint.x&&this._minPoint.y<=this._maxPoint.y&&this._minPoint.z<=this._maxPoint.z}equalsTo(t,e){return this._minPoint.equalsTo(t._minPoint,e)&&this._maxPoint.equalsTo(t._maxPoint,e)}intersectedWithBox(t){return!(this._maxPoint.x<=t._minPoint.x||this._minPoint.x>=t._maxPoint.x||this._maxPoint.y<=t._minPoint.y||this._minPoint.y>=t._maxPoint.y||this._maxPoint.z<=t._minPoint.z||this._minPoint.z>=t._maxPoint.z)}containsPoint(t){return this._minPoint.x<=t.x&&this._maxPoint.x>=t.x&&this._minPoint.y<=t.y&&this._maxPoint.y>=t.y&&this._minPoint.z<=t.z&&this._maxPoint.z>=t.z}containsBox(t){return this._minPoint.x<=t._minPoint.x&&this._maxPoint.x>=t._maxPoint.x&&this._minPoint.y<=t._minPoint.y&&this._maxPoint.y>=t._maxPoint.y&&this._minPoint.z<=t._minPoint.z&&this._maxPoint.z>=t._maxPoint.z}getClipStateMask(t,e){let i=65535,s=0;const r=new b,n=new T,a=e&R.ClipLeft,o=e&R.ClipRight,h=e&R.ClipTop,l=e&R.ClipBottom,u=e&R.ClipFront,c=e&R.ClipBack,d=this._minPoint,m=this._maxPoint;for(let e=0;e<8;e++){let p=0;r.setXYZ(1&e?d.x:m.x,2&e?d.y:m.y,3&e?d.z:m.z),t.transformPoint(r,n),a&&n.x<-n.w?p|=R.ClipLeft:o&&n.x>n.w&&(p|=R.ClipRight),l&&n.y<-n.w?p|=R.ClipBottom:h&&n.y>n.w&&(p|=R.ClipTop),c&&n.z<-n.w?p|=R.ClipBack:u&&n.z>n.w&&(p|=R.ClipFront),i&=p,s|=p}return 0===s?p.A_INSIDE_B:0!==i?p.NOT_CLIPPED:p.CLIPPED}getClipState(t){let e=65535,i=0;const s=new b,r=new T,n=this._minPoint,a=this._maxPoint;for(let o=0;o<8;o++){let h=0;s.setXYZ(1&o?n.x:a.x,2&o?n.y:a.y,3&o?n.z:a.z),t.transformPoint(s,r),r.x<-r.w?h|=R.ClipLeft:r.x>r.w&&(h|=R.ClipRight),r.y<-r.w?h|=R.ClipBottom:r.y>r.w&&(h|=R.ClipTop),r.z<-r.w?h|=R.ClipBack:r.z>r.w&&(h|=R.ClipFront),e&=h,i|=h}return 0===i?p.A_INSIDE_B:0!==e?p.NOT_CLIPPED:p.CLIPPED}behindPlane(t){const e=.5*(this._maxPoint.x+this._minPoint.x),i=.5*(this._maxPoint.y+this._minPoint.y),s=.5*(this._maxPoint.z+this._minPoint.z),r=this._maxPoint.x-e,n=this._maxPoint.y-i,a=this._maxPoint.z-s;return t.a*(e+t.px*r)+t.b*(i+t.py*n)+t.c*(s+t.pz*a)+t.d<0}getClipStateWithFrustum(t){let e=!1;const i=.5*(this._maxPoint.x+this._minPoint.x),s=.5*(this._maxPoint.y+this._minPoint.y),r=.5*(this._maxPoint.z+this._minPoint.z),n=this._maxPoint.x-i,a=this._maxPoint.y-s,o=this._maxPoint.z-r;for(let h=0;h<6;h++){const l=t.planes[h];if(l.a*(i+l.px*n)+l.b*(s+l.py*a)+l.c*(r+l.pz*o)+l.d<0)return p.NOT_CLIPPED;l.a*(i+l.nx*n)+l.b*(s+l.ny*a)+l.c*(r+l.nz*o)+l.d<0&&(e=!0)}return e?p.CLIPPED:p.A_INSIDE_B}getClipStateWithFrustumMask(t,e){let i=!1;const s=.5*(this._maxPoint.x+this._minPoint.x),r=.5*(this._maxPoint.y+this._minPoint.y),n=.5*(this._maxPoint.z+this._minPoint.z),a=this._maxPoint.x-s,o=this._maxPoint.y-r,h=this._maxPoint.z-n;for(let l=0;l<6;l++)if(e&1<<l){const e=t.planes[l];if(e.a*(s+e.px*a)+e.b*(r+e.py*o)+e.c*(n+e.pz*h)+e.d<0)return p.NOT_CLIPPED;e.a*(s+e.nx*a)+e.b*(r+e.ny*o)+e.c*(n+e.nz*h)+e.d<0&&(i=!0)}return i?p.CLIPPED:p.A_INSIDE_B}static transform(t,e,i){const s=i||new R,r=[0,0,0],n=[0,0,0],a=t.minPoint,o=t.maxPoint;let h;for(let t=0;t<3;++t){h=t,r[t]=n[t]=e[12+t];for(let i=0;i<3;++i){const s=e[h]*a[i],l=e[h]*o[i];s<l?(r[t]+=s,n[t]+=l):(r[t]+=l,n[t]+=s),h+=4}}return s.minPoint.set(r),s.maxPoint.set(n),s}}const F=new b,I=new b,D=new b,$=new b,L=new b;class P{_origin;_direction;_ii;_ij;_ik;_ibyj;_jbyi;_kbyj;_jbyk;_ibyk;_kbyi;_c_xy;_c_xz;_c_yx;_c_yz;_c_zx;_c_zy;bboxIntersectionTest;bboxIntersectionTestEx;constructor(t,e){this._origin=t?new b(t):b.zero(),this._direction=e?new b(e):b.axisPZ(),this.prepare()}get origin(){return this._origin}get direction(){return this._direction}set(t,e){this._origin.set(t),this._direction.set(e),this.prepare()}transform(t,e){if(e)t.transformPointAffine(this._origin,e._origin),t.transformPointAffine(b.add(this._origin,this._direction),e._direction).subBy(e._origin).inplaceNormalize(),e.prepare();else{const i=t.transformPointAffine(this._origin),s=t.transformPointAffine(b.add(this._origin,this._direction)).subBy(i).inplaceNormalize();e=new P(i,s)}return e}intersectionTestTriangle(t,e,i,s){const r=this._origin,n=this._direction,a=b.sub(e,t,F),o=b.sub(i,t,I),h=b.cross(n,o,D),l=b.dot(a,h);if(s){if(l<0)return null;const e=b.sub(r,t,$),i=b.dot(e,h);if(i<0||i>l)return null;const s=b.cross(e,a,L),u=b.dot(n,s);return u<0||i+u>l?null:b.dot(o,s)/l}{if(l>-1e-4&&l<1e-4)return null;const e=1/l,i=b.sub(r,t,$),s=e*b.dot(i,h);if(s<0||s>1)return null;const u=b.cross(i,a,L),c=e*b.dot(n,u);return c<0||s+c>1?null:b.dot(o,u)*e}}qtestMMM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x<e||this._origin.y<i||this._origin.z<s||this._jbyi*e-n+this._c_xy>0||this._ibyj*i-r+this._c_yx>0||this._jbyk*s-n+this._c_zy>0||this._kbyj*i-a+this._c_yz>0||this._kbyi*e-a+this._c_xz>0||this._ibyk*s-r+this._c_zx>0)}qtestMMMEx(t){if(!this.qtestMMM(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestMMP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x<e||this._origin.y<i||this._origin.z>a||this._jbyi*e-n+this._c_xy>0||this._ibyj*i-r+this._c_yx>0||this._jbyk*a-n+this._c_zy>0||this._kbyj*i-s+this._c_yz<0||this._kbyi*e-s+this._c_xz<0||this._ibyk*a-r+this._c_zx>0)}qtestMMPEx(t){if(!this.qtestMMP(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestMPM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x<e||this._origin.y>n||this._origin.z<s||this._jbyi*e-i+this._c_xy<0||this._ibyj*n-r+this._c_yx>0||this._jbyk*s-i+this._c_zy<0||this._kbyj*n-a+this._c_yz>0||this._kbyi*e-a+this._c_xz>0||this._ibyk*s-r+this._c_zx>0)}qtestMPMEx(t){if(!this.qtestMPM(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestMPP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x<e||this._origin.y>n||this._origin.z>a||this._jbyi*e-i+this._c_xy<0||this._ibyj*n-r+this._c_yx>0||this._jbyk*a-i+this._c_zy<0||this._kbyj*n-s+this._c_yz<0||this._kbyi*e-s+this._c_xz<0||this._ibyk*a-r+this._c_zx>0)}qtestMPPEx(t){if(!this.qtestMPP(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPMM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x>r||this._origin.y<i||this._origin.z<s||this._jbyi*r-n+this._c_xy>0||this._ibyj*i-e+this._c_yx<0||this._jbyk*s-n+this._c_zy>0||this._kbyj*i-a+this._c_yz>0||this._kbyi*r-a+this._c_xz>0||this._ibyk*s-e+this._c_zx<0)}qtestPMMEx(t){if(!this.qtestPMM(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPMP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x>r||this._origin.y<i||this._origin.z>a||this._jbyi*r-n+this._c_xy>0||this._ibyj*i-e+this._c_yx<0||this._jbyk*a-n+this._c_zy>0||this._kbyj*i-s+this._c_yz<0||this._kbyi*r-s+this._c_xz<0||this._ibyk*a-e+this._c_zx<0)}qtestPMPEx(t){if(!this.qtestPMP(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPPM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x>r||this._origin.y>n||this._origin.z<s||this._jbyi*r-i+this._c_xy<0||this._ibyj*n-e+this._c_yx<0||this._jbyk*s-i+this._c_zy<0||this._kbyj*n-a+this._c_yz>0||this._kbyi*r-a+this._c_xz>0||this._ibyk*s-e+this._c_zx<0)}qtestPPMEx(t){if(!this.qtestPPM(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPPP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x>r||this._origin.y>n||this._origin.z>a||this._jbyi*r-i+this._c_xy<0||this._ibyj*n-e+this._c_yx<0||this._jbyk*a-i+this._c_zy<0||this._kbyj*n-s+this._c_yz<0||this._kbyi*r-s+this._c_xz<0||this._ibyk*a-e+this._c_zx<0)}qtestPPPEx(t){if(!this.qtestPPP(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestOMM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y<i||this._origin.z<s||this._jbyk*s-n+this._c_zy>0||this._kbyj*i-a+this._c_yz>0)}qtestOMMEx(t){if(!this.qtestOMM(t))return null;let e=(t.maxPoint.y-this._origin.y)*this._ij;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestOMP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y<i||this._origin.z>a||this._jbyk*a-n+this._c_zy>0||this._kbyj*i-s+this._c_yz<0)}qtestOMPEx(t){if(!this.qtestOMP(t))return null;let e=(t.maxPoint.y-this._origin.y)*this._ij;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestOPM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y>n||this._origin.z<s||this._jbyk*s-i+this._c_zy<0||this._kbyj*n-a+this._c_yz>0)}qtestOPMEx(t){if(!this.qtestOPM(t))return null;let e=(t.minPoint.y-this._origin.y)*this._ij;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestOPP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y>n||this._origin.z>a||this._jbyk*a-i+this._c_zy<0||this._kbyj*n-s+this._c_yz<0)}qtestOPPEx(t){if(!this.qtestOPP(t))return null;let e=(t.minPoint.y-this._origin.y)*this._ij;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestMOM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>n||this._origin.x<e||this._origin.z<s||this._kbyi*e-a+this._c_xz>0||this._ibyk*s-r+this._c_zx>0)}qtestMOMEx(t){if(!this.qtestMOM(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestMOP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>n||this._origin.x<e||this._origin.z>a||this._kbyi*e-s+this._c_xz<0||this._ibyk*a-r+this._c_zx>0)}qtestMOPEx(t){if(!this.qtestMOP(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestPOM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>n||this._origin.x>r||this._origin.z<s||this._kbyi*r-a+this._c_xz>0||this._ibyk*s-e+this._c_zx<0)}qtestPOMEx(t){if(!this.qtestPOM(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestPOP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>n||this._origin.x>r||this._origin.z>a||this._kbyi*r-s+this._c_xz<0||this._ibyk*a-e+this._c_zx<0)}qtestPOPEx(t){if(!this.qtestPOP(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestMMO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>a||this._origin.x<e||this._origin.y<i||this._jbyi*e-n+this._c_xy>0||this._ibyj*i-r+this._c_yx>0)}qtestMMOEx(t){if(!this.qtestMMO(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestMPO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>a||this._origin.x<e||this._origin.y>n||this._jbyi*e-i+this._c_xy<0||this._ibyj*n-r+this._c_yx>0)}qtestMPOEx(t){if(!this.qtestMPO(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestPMO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>a||this._origin.x>r||this._origin.y<i||this._jbyi*r-n+this._c_xy>0||this._ibyj*i-e+this._c_yx<0)}qtestPMOEx(t){if(!this.qtestPMO(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestPPO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>a||this._origin.x>r||this._origin.y>n||this._jbyi*r-i+this._c_xy<0||this._ibyj*n-e+this._c_yx<0)}qtestPPOEx(t){if(!this.qtestPPO(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestMOO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.y<i||this._origin.y>r||this._origin.z<s||this._origin.z>n)}qtestMOOEx(t){if(!this.qtestMOO(t))return null;return(t.maxPoint.x-this._origin.x)*this._ii}qtestPOO(t){const e=t.minPoint.y,i=t.minPoint.z,s=t.maxPoint.x,r=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x>s||this._origin.y<e||this._origin.y>r||this._origin.z<i||this._origin.z>n)}qtestPOOEx(t){if(!this.qtestPOO(t))return null;return(t.minPoint.x-this._origin.x)*this._ii}qtestOMO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.z;return!(this._origin.y<i||this._origin.x<e||this._origin.x>r||this._origin.z<s||this._origin.z>n)}qtestOMOEx(t){if(!this.qtestOMO(t))return null;return(t.maxPoint.y-this._origin.y)*this._ij}qtestOPO(t){const e=t.minPoint.x,i=t.minPoint.z,s=t.maxPoint.x,r=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.y>r||this._origin.x<e||this._origin.x>s||this._origin.z<i||this._origin.z>n)}qtestOPOEx(t){if(!this.qtestOPO(t))return null;return(t.minPoint.y-this._origin.y)*this._ij}qtestOOM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,n=t.maxPoint.y;return!(this._origin.z<s||this._origin.x<e||this._origin.x>r||this._origin.y<i||this._origin.y>n)}qtestOOMEx(t){if(!this.qtestOOM(t))return null;return(t.maxPoint.z-this._origin.z)*this._ik}qtestOOP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.maxPoint.x,r=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.z>n||this._origin.x<e||this._origin.x>s||this._origin.y<i||this._origin.y>r)}qtestOOPEx(t){if(!this.qtestOOP(t))return null;return(t.minPoint.z-this._origin.z)*this._ik}prepare(){const t=this._origin.x,e=this._origin.y,i=this._origin.z,s=this._direction.x,r=this._direction.y,n=this._direction.z;this._ii=1/s,this._ij=1/r,this._ik=1/n,this._ibyj=s*this._ij,this._jbyi=r*this._ii,this._jbyk=r*this._ik,this._kbyj=n*this._ij,this._ibyk=s*this._ik,this._kbyi=n*this._ii,this._c_xy=e-this._jbyi*t,this._c_xz=i-this._kbyi*t,this._c_yx=t-this._ibyj*e,this._c_yz=i-this._kbyj*e,this._c_zx=t-this._ibyk*i,this._c_zy=e-this._jbyk*i,s<0?r<0?n<0?(this.bboxIntersectionTest=this.qtestMMM,this.bboxIntersectionTestEx=this.qtestMMMEx):n>0?(this.bboxIntersectionTest=this.qtestMMP,this.bboxIntersectionTestEx=this.qtestMMPEx):(this.bboxIntersectionTest=this.qtestMMO,this.bboxIntersectionTestEx=this.qtestMMOEx):n<0?(this.bboxIntersectionTest=r>0?this.qtestMPM:this.qtestMOM,this.bboxIntersectionTestEx=r>0?this.qtestMPMEx:this.qtestMOMEx):0===r&&0===n?(this.bboxIntersectionTest=this.qtestMOO,this.bboxIntersectionTestEx=this.qtestMOOEx):0===n?(this.bboxIntersectionTest=this.qtestMPO,this.bboxIntersectionTestEx=this.qtestMPOEx):0===r?(this.bboxIntersectionTest=this.qtestMOP,this.bboxIntersectionTestEx=this.qtestMOPEx):(this.bboxIntersectionTest=this.qtestMPP,this.bboxIntersectionTestEx=this.qtestMPPEx):r<0?n<0?(this.bboxIntersectionTest=s>0?this.qtestPMM:this.qtestOMM,this.bboxIntersectionTestEx=s>0?this.qtestPMMEx:this.qtestOMMEx):0===s&&0===n?(this.bboxIntersectionTest=this.qtestOMO,this.bboxIntersectionTestEx=this.qtestOMOEx):0===n?(this.bboxIntersectionTest=this.qtestPMO,this.bboxIntersectionTestEx=this.qtestPMOEx):0===s?(this.bboxIntersectionTest=this.qtestOMP,this.bboxIntersectionTestEx=this.qtestOMPEx):(this.bboxIntersectionTest=this.qtestPMP,this.bboxIntersectionTestEx=this.qtestPMPEx):n<0?0===s&&0===r?(this.bboxIntersectionTest=this.qtestOOM,this.bboxIntersectionTestEx=this.qtestOOMEx):0===s?(this.bboxIntersectionTest=this.qtestOPM,this.bboxIntersectionTestEx=this.qtestOPMEx):0===r?(this.bboxIntersectionTest=this.qtestPOM,this.bboxIntersectionTestEx=this.qtestPOMEx):(this.bboxIntersectionTest=this.qtestPPM,this.bboxIntersectionTestEx=this.qtestPPMEx):0===s?0===r?(this.bboxIntersectionTest=this.qtestOOP,this.bboxIntersectionTestEx=this.qtestOOPEx):0===n?(this.bboxIntersectionTest=this.qtestOPO,this.bboxIntersectionTestEx=this.qtestOPOEx):(this.bboxIntersectionTest=this.qtestOPP,this.bboxIntersectionTestEx=this.qtestOPPEx):0===r&&0===n?(this.bboxIntersectionTest=this.qtestPOO,this.bboxIntersectionTestEx=this.qtestPOOEx):0===r?(this.bboxIntersectionTest=this.qtestPOP,this.bboxIntersectionTestEx=this.qtestPOPEx):0===n?(this.bboxIntersectionTest=this.qtestPPO,this.bboxIntersectionTestEx=this.qtestPPOEx):(this.bboxIntersectionTest=this.qtestPPP,this.bboxIntersectionTestEx=this.qtestPPPEx)}}const N=new v,B=new v,O=new v,U={number:1,vec2:2,vec3:3,vec4:4,quat:4};function k(t,e,i){return t<e?e:t>i?i:t}class z{_prevKey;_prevT;_inputs;_outputs;_mode;_target;_stride;_maxTime;static getTargetStride(t){return U[t]??0}constructor(t,e,i,s){this._prevKey=0,this._prevT=0,this._inputs=i,this._outputs=s,this._mode=t,this._target=e,this._stride=U[e]??Math.floor(s.length/i.length),this._maxTime=i[i.length-1]}get mode(){return this._mode}get target(){return this._target}get stride(){return this._stride}get maxTime(){return this._maxTime}slerpQuat(t,e,i,s){return v.slerp(t,e,i,s).inplaceNormalize()}interpolate(t,e){if(void 0===t)return;const i=this._inputs,s=this._outputs;if(s.length===this._stride){for(let t=0;t<this._stride;t++)e[t]=s[t];return e}let r;t=k(t%this._maxTime,i[0],i[i.length-1]),this._prevT>t&&(this._prevKey=0),this._prevT=t;for(let e=this._prevKey;e<i.length;++e)if(t<=i[e]){r=k(e,1,i.length-1);break}this._prevKey=k(r-1,0,r);const n=i[r]-i[this._prevKey],a=(t-i[this._prevKey])/n;if("quat"===this._target)return"cubicspline"===this._mode?(this.cubicSpline(this._prevKey,r,n,a,e),e):"linear"===this._mode?(this.getQuat(this._prevKey,N),this.getQuat(r,B),this.slerpQuat(N,B,a,O),e.set(O),e):this.getQuat(this._prevKey,e);switch(this._mode){case"step":return this.step(this._prevKey,e);case"cubicspline":return this.cubicSpline(this._prevKey,r,n,a,e);default:return this.linear(this._prevKey,r,a,e)}}getQuat(t,e){return e[0]=this._outputs[4*t],e[1]=this._outputs[4*t+1],e[2]=this._outputs[4*t+2],e[3]=this._outputs[4*t+3],e}step(t,e){for(let i=0;i<this._stride;i++)e[i]=this._outputs[t*this._stride+i];return e}linear(t,e,i,s){for(let r=0;r<this._stride;r++)s[r]=this._outputs[t*this._stride+r]*(1-i)+this._outputs[e*this._stride+r]*i;return s}cubicSpline(t,e,i,s,r){const n=t*this._stride*3,a=e*this._stride*3,o=this._stride,h=2*this._stride,l=s*s,u=l*s;for(let t=0;t<this._stride;t++){const e=this._outputs[n+t+o],c=i*this._outputs[a+t+0],d=i*this._outputs[n+t+h],p=this._outputs[a+t+o];r[t]=(2*u-3*l+1)*e+(u-2*l+s)*d+(-2*u+3*l)*p+(u-l)*c}return r}}class V{_bins;_maxBins;_width;_height;constructor(t,e,i=0){this._width=t,this._height=e,this._maxBins=i,this._bins=[new G(this._width,this._height)]}clear(){this._bins=[new G(this._width,this._height)]}insert(t,e){if(t>this._width||e>this._height)return null;const i=this._bins[this._bins.length-1].insert(t,e);if(i)return{x:i.x,y:i.y,width:i.width,height:i.height,binIndex:this._bins.length-1};if(0===this._maxBins||this._bins.length<this._maxBins){this._bins.push(new G(this._width,this._height));const i=this._bins[this._bins.length-1].insert(t,e);return{x:i.x,y:i.y,width:i.width,height:i.height,binIndex:this._bins.length-1}}return null}}class G{freeRects;constructor(t,e){this.freeRects=[{x:0,y:0,width:t,height:e}]}insert(t,e){const i=this.findBestFit(t,e);if(!i)return null;let s=this.freeRects.length,r=0;for(;r<s;)this.splitFreeRect(this.freeRects[r],i)&&(this.freeRects.splice(r,1),--s,--r),++r;return this.pruneFreeRects(),i}findBestFit(t,e){let i=Number.MAX_VALUE,s=null;for(const r of this.freeRects)if(r.width>=t&&r.height>=e){const n=r.width*r.height-t*e;n<i&&(s||(s={width:t,height:e}),s.x=r.x,s.y=r.y,i=n)}return s}splitFreeRect(t,e){return!(e.x>=t.x+t.width||e.x+e.width<=t.x||e.y>=t.y+t.height||e.y+e.height<=t.y)&&(e.x<t.x+t.width&&e.x+e.width>t.x&&(e.y>t.y&&e.y<t.y+t.height&&this.freeRects.push({x:t.x,y:t.y,width:t.width,height:e.y-t.y}),e.y+e.height<t.y+t.height&&this.freeRects.push({x:t.x,y:e.y+e.height,width:t.width,height:t.y+t.height-e.y-e.height})),e.y<t.y+t.height&&e.y+e.height>t.y&&(e.x>t.x&&e.x<t.x+t.width&&this.freeRects.push({x:t.x,y:t.y,width:e.x-t.x,height:t.height}),e.x+e.width<t.x+t.width&&this.freeRects.push({x:e.x+e.width,y:t.y,width:t.x+t.width-e.x-e.width,height:t.height})),!0)}pruneFreeRects(){let t=0,e=0,i=this.freeRects.length;for(;t<i;){e=t+1;const s=this.freeRects[t];for(;e<i;){const r=this.freeRects[e];if(this.isRectInRect(s,r)){this.freeRects.splice(t,1),--t,--i;break}this.isRectInRect(r,s)&&(this.freeRects.splice(e,1),--e,--i),e++}t++}}isRectInRect(t,e){return t.x>=e.x&&t.y>=e.y&&t.x+t.width<=e.x+e.width&&t.y+t.height<=e.y+e.height}}class X{_generator;constructor(t=0){this._generator=()=>{let e=t+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}}get(){return this._generator()}}class W{_app;_target;_started;_clickDistTolerance;_clickTimeTolerance;_dblclickDistTolerance;_dblclickTimeTolerance;_pointerDownHandler;_pointerUpHandler;_pointerMoveHandler;_pointerCancelHandler;_keyboardHandler;_dragHandler;_wheelHandler;_captureId;_middlewares;_lastEventDatas;constructor(t){this._app=t,this._target=t.options.canvas,this._started=!1,this._clickDistTolerance=16,this._clickTimeTolerance=400,this._dblclickDistTolerance=16,this._dblclickTimeTolerance=400,this._lastEventDatas=[],this._pointerDownHandler=this._getPointerDownHandler(),this._pointerUpHandler=this._getPointerUpHandler(),this._pointerMoveHandler=this._getPointerMoveHander(),this._pointerCancelHandler=this._getPointerCancelHandler(),this._keyboardHandler=this._getKeyboardHandler(),this._dragHandler=this._getDragHandler(),this._wheelHandler=this._getWheelHandler(),this._captureId=-1,this._middlewares=[]}start(){this._started||(this._started=!0,this._target.addEventListener("pointerdown",this._pointerDownHandler),this._target.addEventListener("pointerup",this._pointerUpHandler),this._target.addEventListener("pointermove",this._pointerMoveHandler),this._target.addEventListener("pointercancel",this._pointerCancelHandler),this._target.addEventListener("keydown",this._keyboardHandler),this._target.addEventListener("keyup",this._keyboardHandler),this._target.addEventListener("keypress",this._keyboardHandler),this._target.addEventListener("drag",this._dragHandler),this._target.addEventListener("dragenter",this._dragHandler),this._target.addEventListener("dragleave",this._dragHandler),this._target.addEventListener("dragstart",this._dragHandler),this._target.addEventListener("dragend",this._dragHandler),this._target.addEventListener("dragover",this._dragHandler),this._target.addEventListener("drop",this._dragHandler),this._target.addEventListener("wheel",this._wheelHandler))}stop(){this._started&&(this._started=!1,this._target.removeEventListener("pointerdown",this._pointerDownHandler),this._target.removeEventListener("pointerup",this._pointerUpHandler),this._target.removeEventListener("pointermove",this._pointerMoveHandler),this._target.removeEventListener("pointercancel",this._pointerCancelHandler),this._target.removeEventListener("keydown",this._keyboardHandler),this._target.removeEventListener("keyup",this._keyboardHandler),this._target.removeEventListener("keypress",this._keyboardHandler),this._target.removeEventListener("drag",this._dragHandler),this._target.removeEventListener("dragenter",this._dragHandler),this._target.removeEventListener("dragleave",this._dragHandler),this._target.removeEventListener("dragstart",this._dragHandler),this._target.removeEventListener("dragend",this._dragHandler),this._target.removeEventListener("dragover",this._dragHandler),this._target.removeEventListener("drop",this._dragHandler),this._target.removeEventListener("wheel",this._wheelHandler),this._lastEventDatas=[])}use(t){return t&&this._middlewares.push(t),this}_callMiddlewares(t,e){for(const i of this._middlewares)if(i(t,e??t.type))return!0;return!1}_getPointerCancelHandler(){const t=this;return function(e){const i=t._getPointerEventData(e.pointerId);i.lastDown=!1,i.lastClick=!1,t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getPointerMoveHander(){const t=this;return function(e){const i=t._getPointerEventData(e.pointerId);i.lastMoveX=e.offsetX,i.lastMoveY=e.offsetY,t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getPointerDownHandler(){const t=this;return function(e){"mouse"===e.pointerType&&0===e.button&&(t._captureId=e.pointerId,t._app.options.canvas.setPointerCapture(e.pointerId));const i=t._getPointerEventData(e.pointerId);i.lastDown=!0,i.lastDownX=e.offsetX,i.lastDownY=e.offsetY,i.lastDownTime=Date.now(),t._app.focus(),t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getPointerUpHandler(){const t=this;return function(e){"mouse"===e.pointerType&&0===e.button&&t._captureId===e.pointerId&&(t._app.options.canvas.releasePointerCapture(e.pointerId),t._captureId=-1);const i=t._getPointerEventData(e.pointerId);let s=!1,r=!1;const n=Date.now();if(i.lastDown&&n<=i.lastDownTime+t._clickTimeTolerance){let a=e.offsetX-i.lastDownX,o=e.offsetY-i.lastDownY;a*a+o*o<=t._clickDistTolerance&&(s=!0,i.lastClick&&n<=i.lastClickTime+t._dblclickTimeTolerance&&(a=e.offsetX-i.lastClickX,o=e.offsetY-i.lastClickY,a*a+o*o<=t._dblclickDistTolerance&&(r=!0)))}i.lastDown=!1,i.lastMoveX=e.offsetX,i.lastMoveY=e.offsetY,t._callMiddlewares(e)||t._app.dispatchEvent(e),s&&(t._callMiddlewares(e,"click")||t._app.dispatchEvent(e,"click"),r?(t._callMiddlewares(e,"dblclick")||t._app.dispatchEvent(e,"dblclick"),i.lastClick=!1):(i.lastClick=!0,i.lastClickX=e.offsetX,i.lastClickY=e.offsetY,i.lastClickTime=n))}}_getKeyboardHandler(){const t=this;return function(e){t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getDragHandler(){const t=this;return function(e){t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getWheelHandler(){const t=this;return function(e){t._callMiddlewares(e)||t._app.dispatchEvent(e)}}_getPointerEventData(t){return this._lastEventDatas[t]??(this._lastEventDatas[t]={lastClick:!1,lastClickX:0,lastClickY:0,lastClickTime:0,lastDown:!1,lastDownX:0,lastDownY:0,lastDownTime:0,lastMoveX:0,lastMoveY:0})}}class H{type="tick"}class j{width;height;type;constructor(t,e){this.type="resize",this.width=t,this.height=e}}class q extends(s(Object)()){_options;_device;_inputManager;_ready;_drawEvent;_logger;_elapsed;static _instance;constructor(t){if(super(),q._instance)throw new Error("It is not allowed to have multiple Application instances");q._instance=this,this._options={backend:t.backend,enableMSAA:t.enableMSAA??!1,pixelRatio:t.pixelRatio??window.devicePixelRatio??1,canvas:t.canvas},this._inputManager=new W(this),this._ready=!1,this._elapsed=0,this._drawEvent=new H,this._logger={log(t,e){"warn"===e?console.warn(t):"error"===e?console.error(t):"debug"===e?console.debug(t):"info"===e?console.info(t):console.log(t)}}}get inputManager(){return this._inputManager}get options(){return this._options}get timeElapsedInSeconds(){return this._elapsed}static get instance(){return this._instance}get device(){return this._device}get deviceType(){return this._options.backend.typeName()}get logger(){return this._logger}set logger(t){this._logger=t}focus(){this._device.canvas.focus()}async ready(){if(!this._ready){if(this._device=await this._options.backend.createDevice(this._options.canvas,{dpr:this._options.pixelRatio,msaa:!!this._options.enableMSAA}),!this._device)throw new Error("App.init(): create device failed");this._device.canvas.focus(),this._inputManager.start(),this._device.on("resize",(t=>{this.dispatchEvent(new j(t.width,t.height))})),this._ready=!0}}frame(){this._ready&&(this._elapsed=.001*this.device.frameInfo.elapsedFrame,this.device.setFramebuffer(null),this.device.setViewport(null),this.device.setScissor(null),this.dispatchEvent(this._drawEvent))}run(){this.device.runLoop((()=>{this.frame()}))}stop(){this.device.exitLoop()}log(t,e){this._logger?.log(t,e)}}let Y=null,Z=null;const K={},Q=[[new b(0,0,-1),new b(0,-1,0),new b(1,0,0)],[new b(0,0,1),new b(0,-1,0),new b(-1,0,0)],[new b(1,0,0),new b(0,0,1),new b(0,1,0)],[new b(1,0,0),new b(0,0,-1),new b(0,-1,0)],[new b(1,0,0),new b(0,-1,0),new b(0,0,1)],[new b(-1,0,0),new b(0,-1,0),new b(0,0,-1)]];function J(t,e){const i=q.instance.device,s=`${t}:${e}`;let r=K[s];if(!r){const n=function(t,e){const i=q.instance.device,s=i;return s.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.up=t.vec3().uniform(0),this.right=t.vec3().uniform(0),this.front=t.vec3().uniform(0),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.direction=t.mul(t.mat3(this.up,this.right,this.front),t.vec3(this.$inputs.pos,1)),"webgpu"===i.type&&(this.$builtins.position.y=t.neg(this.$builtins.position.y))}))},fragment(s){"ggx"===t&&(this.alphaG=s.float().uniform(0)),this.vFilteringInfo=s.vec2().uniform(0),this.hdrScale=s.float().uniform(0),this.inputTexture=s.texCube().uniform(0),this.NUM_SAMPLES_FLOAT=s.float(e),this.NUM_SAMPLES_FLOAT_INVERSED=s.float(1/e),this.K=s.float(4),this.$outputs.outcolor=s.vec4(),"webgl"===i.type?(s.func("radicalInverse_VdC",[s.int("bits")],(function(){this.$l.rand=s.float(0),this.$l.denom=s.float(1),this.$l.invBase=s.float(.5),this.$l.n=this.bits,this.$for(s.int("i"),0,32,(function(){this.denom=s.mul(this.denom,2),this.rand=s.add(this.rand,s.div(s.mod(s.float(this.n),2),this.denom)),this.n=s.div(this.n,2),this.$if(s.equal(this.n,0),(function(){this.$break()}))})),this.$return(this.rand)})),s.func("hammersley2d",[s.int("i"),s.int("N")],(function(){this.$return(s.vec2(s.div(s.float(this.i),s.float(this.N)),this.radicalInverse_VdC(this.i)))}))):(s.func("radicalInverse_VdC",[s.uint("bits")],(function(){this.$l.n=this.bits,this.n=s.compOr(s.sal(this.n,16),s.sar(this.n,16)),this.n=s.compOr(s.sal(s.compAnd(this.n,1431655765),1),s.sar(s.compAnd(this.n,2863311530),1)),this.n=s.compOr(s.sal(s.compAnd(this.n,858993459),2),s.sar(s.compAnd(this.n,3435973836),2)),this.n=s.compOr(s.sal(s.compAnd(this.n,252645135),4),s.sar(s.compAnd(this.n,4042322160),4)),this.n=s.compOr(s.sal(s.compAnd(this.n,16711935),8),s.sar(s.compAnd(this.n,4278255360),8)),this.$return(s.mul(s.float(this.n),2.3283064365386963e-10))})),s.func("hammersley2d",[s.int("i"),s.int("N")],(function(){this.$return(s.vec2(s.div(s.float(this.i),s.float(this.N)),this.radicalInverse_VdC(s.uint(this.i))))}))),s.func("log4",[s.float("x")],(function(){this.$return(s.mul(s.log2(this.x),.5))})),"lambertian"===t&&(s.func("hemisphereCosSample",[s.vec2("u")],(function(){this.$l.phi=s.mul(this.u.x,2*Math.PI),this.$l.cosTheta2=s.sub(1,this.u.y),this.$l.cosTheta=s.sqrt(this.cosTheta2),this.$l.sinTheta=s.sqrt(s.sub(1,this.cosTheta2)),this.$return(s.vec3(s.mul(this.sinTheta,s.cos(this.phi)),s.mul(this.sinTheta,s.sin(this.phi)),this.cosTheta))})),s.func("irradiance",[s.vec3("direction"),s.vec2("vFilteringInfo")],(function(){this.$l.n=s.normalize(this.direction),this.$l.result=s.vec3(0),this.$l.tangent=s.vec3(),this.$if(s.lessThan(s.abs(this.n.z),.999),(function(){this.tangent=s.vec3(0,0,1)})).$else((function(){this.tangent=s.vec3(1,0,0)})),this.tangent=s.normalize(s.cross(this.tangent,this.n)),this.$l.bitangent=s.cross(this.n,this.tangent),this.$l.tbn=s.mat3(this.tangent,this.bitangent,this.n),this.$l.maxLevel=this.vFilteringInfo.y,this.$l.dim0=this.vFilteringInfo.x,this.$l.omegaP=s.div(4*Math.PI,s.mul(this.dim0,this.dim0,6)),this.$for(s.int("i"),0,e,(function(){this.$l.Xi=this.hammersley2d(this.i,e),this.$l.Ls=s.normalize(this.hemisphereCosSample(this.Xi)),this.$l.Ns=s.vec3(0,0,1),this.$l.NoL=s.dot(this.Ns,this.Ls),this.$if(s.greaterThan(this.NoL,0),(function(){this.$l.pdf_inversed=s.div(Math.PI,this.NoL),this.$l.omegaS=s.mul(this.pdf_inversed,this.NUM_SAMPLES_FLOAT_INVERSED),this.$l.l=s.add(s.sub(this.log4(this.omegaS),this.log4(this.omegaP)),this.log4(this.K)),this.$l.mipLevel=s.clamp(this.l,0,this.maxLevel),this.$l.c=s.textureSampleLevel(this.inputTexture,s.mul(this.tbn,this.Ls),this.mipLevel).rgb,this.result=s.add(this.result,this.c)}))})),this.result=s.mul(this.result,this.NUM_SAMPLES_FLOAT_INVERSED),this.$return(this.result)}))),"ggx"===t&&(s.func("hemisphereImportanceSampleDggx",[s.vec2("u"),s.float("a")],(function(){this.$l.phi=s.mul(this.u.x,2*Math.PI),this.$l.cosTheta2=s.div(s.sub(1,this.u.y),s.add(s.mul(s.add(this.a,1),s.sub(this.a,1),this.u.y),1)),this.$l.cosTheta=s.sqrt(this.cosTheta2),this.$l.sinTheta=s.sqrt(s.sub(1,this.cosTheta2)),this.$return(s.vec3(s.mul(s.cos(this.phi),this.sinTheta),s.mul(s.sin(this.phi),this.sinTheta),this.cosTheta))})),s.func("normalDistributionFunction_TrowbridgeReitzGGX",[s.float("NoH"),s.float("alphaG")],(function(){this.$l.a2=s.mul(this.alphaG,this.alphaG),this.$l.d=s.add(s.mul(this.NoH,this.NoH,s.sub(this.a2,1)),1),this.$return(s.div(this.a2,s.mul(this.d,this.d,Math.PI)))})),s.func("radiance",[s.float("alphaG"),s.vec3("direction"),s.vec2("vFilteringInfo")],(function(){this.$l.n=s.normalize(this.direction),this.$if(s.equal(this.alphaG,0),(function(){this.$l.c=s.textureSampleLevel(this.inputTexture,this.n,0).rgb,this.$return(this.c)})).$else((function(){this.$l.result=s.vec3(0),this.$l.tangent=s.vec3(),this.$if(s.lessThan(s.abs(this.n.z),.999),(function(){this.tangent=s.vec3(0,0,1)})).$else((function(){this.tangent=s.vec3(1,0,0)})),this.tangent=s.normalize(s.cross(this.tangent,this.n)),this.$l.bitangent=s.cross(this.n,this.tangent),this.$l.tbn=s.mat3(this.tangent,this.bitangent,this.n),this.$l.maxLevel=this.vFilteringInfo.y,this.$l.dim0=this.vFilteringInfo.x,this.$l.omegaP=s.div(4*Math.PI,s.mul(this.dim0,this.dim0,6)),this.$l.weight=s.float(0),this.$for(s.int("i"),0,e,(function(){this.$l.Xi=this.hammersley2d(this.i,e),this.$l.H=this.hemisphereImportanceSampleDggx(this.Xi,this.alphaG),this.$l.NoV=s.float(1),this.$l.NoH=this.H.z,this.$l.NoH2=s.mul(this.H.z,this.H.z),this.$l.NoL=s.sub(s.mul(this.NoH2,2),1),this.$l.L=s.normalize(s.vec3(s.mul(this.NoH,this.H.x,2),s.mul(this.NoH,this.H.y,2),this.NoL)),this.$if(s.greaterThan(this.NoL,0),(function(){this.$l.pdf_inversed=s.div(4,this.normalDistributionFunction_TrowbridgeReitzGGX(this.NoH,this.alphaG)),this.$l.omegaS=s.mul(this.pdf_inversed,this.NUM_SAMPLES_FLOAT_INVERSED),this.$l.l=s.add(s.sub(this.log4(this.omegaS),this.log4(this.omegaP)),this.log4(this.K)),this.$l.mipLevel=s.clamp(this.l,0,this.maxLevel),this.weight=s.add(this.weight,this.NoL),this.$l.c=s.textureSampleLevel(this.inputTexture,s.mul(this.tbn,this.L),this.mipLevel).rgb,this.result=s.add(this.result,s.mul(this.c,this.NoL))}))})),this.result=s.div(this.result,this.weight),this.$return(this.result)}))}))),s.main((function(){"ggx"===t&&(this.$l.color=this.radiance(this.alphaG,this.$inputs.direction,this.vFilteringInfo)),"lambertian"===t&&(this.$l.color=this.irradiance(this.$inputs.direction,this.vFilteringInfo)),this.$outputs.outcolor=s.vec4(s.mul(this.color,this.hdrScale),1)}))}})}(t,e),a=i.createBindGroup(n.bindGroupLayouts[0]);K[s]=r={program:n,bindgroup:a}}return r}function tt(t,e,i,s,r,n,a){const o=q.instance.device,h=o.createFrameBuffer([r],null);h.setColorAttachmentMipLevel(0,i),h.setColorAttachmentGenerateMipmaps(0,!1);const{program:l,bindgroup:u}=J(t,a);u.setValue("vFilteringInfo",n),u.setValue("hdrScale",1),u.setTexture("inputTexture",s),"ggx"===t&&u.setValue("alphaG",e),o.setProgram(l),o.setBindGroup(0,u),o.setFramebuffer(h);for(let t=0;t<6;t++)h.setColorAttachmentCubeFace(0,t),o.setVertexLayout(Y),o.setRenderStates(Z),u.setValue("up",Q[t][0]),u.setValue("right",Q[t][1]),u.setValue("front",Q[t][2]),o.draw("triangle-list",0,6)}function et(t,e,i,s){if(!t||!t.isTextureCube())return void console.error("prefilterCubemap(): source texture must be cube texture");const r=q.instance.device;Y||function(){const t=q.instance.device,e=new Float32Array([1,1,-1,1,-1,-1,1,-1]),i=new Uint16Array([0,1,2,0,2,3]);Y=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",e)}],indexBuffer:t.createIndexBuffer(i)}),Z=t.createRenderStateSet(),Z.useRasterizerState().setCullMode("none"),Z.useDepthState().enableTest(!1).enableWrite(!1)}(),r.pushDeviceStates();const n=r.getRenderStates(),a=t,o=t.width,h=t.mipLevelCount,l=new x(o,h),u="ggx"===e?i.mipLevelCount:1;for(let t=0;t<u;t++){tt(e,0===t?0:Math.pow(2,t)/o,t,a,i,l,s??64)}r.popDeviceStates(),r.setRenderStates(n)}const it=16777216,st=33554432,rt=50331648,nt=67108864,at=83886080,ot=100663296,ht=117440512,lt=134217728,ut=16;function ct(t,e,i,s,r,n,a,o,h,l,u,c,d,p,m){return t|((e?1:0)|(i?2:0)|(s?4:0)|(r?8:0))|((n?ut:0)|(a?32:0))|(o?64:0)|(h?128:0)|(l?256:0)|(u?512:0)|(c?1024:0)|(d<<16|p<<20|m<<11)}const dt={unknown:0,r8unorm:ct(0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,1,1,1),r8snorm:ct(0,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,1,1,1),r16f:ct(0,!0,!1,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,2),r32f:ct(0,!0,!1,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,4),r8ui:ct(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,1),r8i:ct(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,1),r16ui:ct(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,2),r16i:ct(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,2),r32ui:ct(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,4),r32i:ct(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,4),rg8unorm:ct(0,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,1,1,2),rg8snorm:ct(0,!0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,1,1,2),rg16f:ct(0,!0,!0,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,4),rg32f:ct(0,!0,!0,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,8),rg8ui:ct(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,2),rg8i:ct(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,2),rg16ui:ct(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,4),rg16i:ct(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,4),rg32ui:ct(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,8),rg32i:ct(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,8),rgba8unorm:ct(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,1,1,4),"rgba8unorm-srgb":ct(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,1,1,4),rgba8snorm:ct(0,!0,!0,!0,!0,!1,!1,!1,!1,!0,!1,!1,1,1,4),bgra8unorm:ct(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!0,1,1,4),"bgra8unorm-srgb":ct(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!0,1,1,4),rgba16f:ct(0,!0,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1,1,1,8),rgba32f:ct(0,!0,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1,1,1,16),rgba8ui:ct(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,4),rgba8i:ct(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,4),rgba16ui:ct(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,8),rgba16i:ct(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,8),rgba32ui:ct(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,16),rgba32i:ct(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,16),rg11b10uf:ct(0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,!1,1,1,4),d16:ct(0,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,1,1,2),d24:ct(0,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,0,0,0),d32f:ct(0,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!1,1,1,4),d24s8:ct(0,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,1,1,4),d32fs8:ct(0,!1,!1,!1,!1,!0,!0,!0,!1,!0,!1,!1,1,1,5),dxt1:ct(it,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,8),"dxt1-srgb":ct(it,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,8),dxt3:ct(st,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"dxt3-srgb":ct(st,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),dxt5:ct(rt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"dxt5-srgb":ct(rt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),bc4:ct(nt,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,4,4,8),"bc4-signed":ct(nt,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,4,4,8),bc5:ct(at,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,4,4,16),"bc5-signed":ct(at,!0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,4,4,16),bc6h:ct(ot,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,!1,4,4,16),"bc6h-signed":ct(ot,!0,!0,!0,!1,!1,!1,!0,!1,!0,!1,!1,4,4,16),bc7:ct(ht,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"bc7-srgb":ct(ht,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),"astc-4x4":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"astc-4x4-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),"astc-5x4":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,5,4,16),"astc-5x4-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,5,4,16),"astc-5x5":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,5,5,16),"astc-5x5-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,5,5,16),"astc-6x5":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,6,5,16),"astc-6x5-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,6,5,16),"astc-6x6":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,6,6,16),"astc-6x6-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,6,6,16),"astc-8x5":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,5,16),"astc-8x5-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,5,16),"astc-8x6":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,6,16),"astc-8x6-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,6,16),"astc-8x8":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,8,16),"astc-8x8-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,8,16),"astc-10x5":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,5,16),"astc-10x5-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,5,16),"astc-10x6":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,6,16),"astc-10x6-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,6,16),"astc-10x8":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,8,16),"astc-10x8-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,8,16),"astc-10x10":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,10,16),"astc-10x10-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,10,16),"astc-12x10":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,12,10,16),"astc-12x10-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,12,10,16),"astc-12x12":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,12,12,16),"astc-12x12-srgb":ct(lt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,12,12,16)};function pt(t){switch(t){case"rgba8unorm":return"rgba8unorm-srgb";case"bgra8unorm":return"bgra8unorm-srgb";case"dxt1":return"dxt1-srgb";case"dxt3":return"dxt3-srgb";case"dxt5":return"dxt5-srgb";case"bc7":return"bc7-srgb";case"astc-4x4":return"astc-4x4-srgb";case"astc-5x4":return"astc-5x4-srgb";case"astc-5x5":return"astc-5x5-srgb";case"astc-6x5":return"astc-6x5-srgb";case"astc-6x6":return"astc-6x6-srgb";case"astc-8x5":return"astc-8x5-srgb";case"astc-8x6":return"astc-8x6-srgb";case"astc-8x8":return"astc-8x8-srgb";case"astc-10x5":return"astc-10x5-srgb";case"astc-10x6":return"astc-10x6-srgb";case"astc-10x8":return"astc-10x8-srgb";case"astc-10x10":return"astc-10x10-srgb";case"astc-12x10":return"astc-12x10-srgb";case"astc-12x12":return"astc-12x12-srgb";default:return t}}function mt(t){return!!(dt[t]&ut)}function ft(t){return!!(32&dt[t])}function _t(t){return!!(64&dt[t])}function gt(t){return!!(128&dt[t])}function xt(t){return!!(256&dt[t])}function bt(t){return!!(520093696&dt[t])}function wt(t){return!!(512&dt[t])}function Tt(t){return(63488&dt[t])>>11}function vt(t){return(983040&dt[t])>>16}function yt(t){return(15728640&dt[t])>>20}var Et;!function(t){t[t.Vertex=1]="Vertex",t[t.Fragment=2]="Fragment",t[t.Compute=4]="Compute"}(Et||(Et={}));class St{static NAME="devicelost";type=St.NAME}class Ct{static NAME="devicerestored";type=Ct.NAME}class At{static NAME="resize";width;height;type=At.NAME;constructor(t,e){this.width=t,this.height=e}}class Mt{static NAME="gpuobject_added";object;type=Mt.NAME;constructor(t){this.object=t}}class Rt{static NAME="gpuobject_removed";object;type=Rt.NAME;constructor(t){this.object=t}}class Ft{static NAME="gpuobject_rename";object;lastName;type=Ft.NAME;constructor(t,e){this.object=t,this.lastName=e}}function It(t,e){return t+e-1&~(e-1)}function Dt(t){if(t.isPrimitiveType())return t.isScalarType()?4:1<<Math.min(4,t.cols+1);if(t.isAtomicI32()||t.isAtomicU32())return 4;if(t.isArrayType())return t.elementType.isAnyType()?1:Dt(t.elementType);{let e=0;for(const i of t.structMembers)e=Math.max(e,Dt(i.type));return Math.max(e,16)}}function $t(t){if(t.isPrimitiveType())return t.isMatrixType()?t.rows*Dt(te.getCachedTypeInfo(t.resizeType(1,t.cols))):4*t.cols;if(t.isArrayType())return t.elementType.isAnyType()?0:t.dimension*It($t(t.elementType),Dt(t.elementType));if(t.isAtomicI32()||t.isAtomicU32())return 4;{let e=0,i=0;for(const s of t.structMembers){const t=Dt(s.type);e=It(e,t),e+=$t(s.type),i=Math.max(i,t)}return It(e,i)}}function Lt(t){if(t.isPrimitiveType()){let e;switch(t.scalarType){case Bt.U8:case Bt.U8_NORM:case Bt.I8:case Bt.I8_NORM:e=1;break;case Bt.F16:case Bt.I16:case Bt.I16_NORM:case Bt.U16:case Bt.U16_NORM:e=2;break;default:e=4}return t.rows*t.cols*e}if(t.isArrayType())return t.elementType.isAnyType()?0:t.dimension*Lt(t.elementType);if(t.isAtomicI32()||t.isAtomicU32())return 4;{let e=0;for(const i of t.structMembers)e+=Lt(i.type);return e}}function Pt(t,e,i,s){return t|e<<4|i<<7|s<<10}function Nt(t){return t.isPrimitiveType()?t.scalarType:t.isArrayType()?t.elementType.isAnyType()?null:Nt(t.elementType):Bt.U8}var Bt;!function(t){t[t.NONE=0]="NONE",t[t.F16=Pt(1,1,1,0)]="F16",t[t.F16VEC2=Pt(1,1,2,0)]="F16VEC2",t[t.F16VEC3=Pt(1,1,3,0)]="F16VEC3",t[t.F16VEC4=Pt(1,1,4,0)]="F16VEC4",t[t.F32=Pt(2,1,1,0)]="F32",t[t.F32VEC2=Pt(2,1,2,0)]="F32VEC2",t[t.F32VEC3=Pt(2,1,3,0)]="F32VEC3",t[t.F32VEC4=Pt(2,1,4,0)]="F32VEC4",t[t.BOOL=Pt(3,1,1,0)]="BOOL",t[t.BVEC2=Pt(3,1,2,0)]="BVEC2",t[t.BVEC3=Pt(3,1,3,0)]="BVEC3",t[t.BVEC4=Pt(3,1,4,0)]="BVEC4",t[t.I8=Pt(4,1,1,0)]="I8",t[t.I8VEC2=Pt(4,1,2,0)]="I8VEC2",t[t.I8VEC3=Pt(4,1,3,0)]="I8VEC3",t[t.I8VEC4=Pt(4,1,4,0)]="I8VEC4",t[t.I8_NORM=Pt(4,1,1,1)]="I8_NORM",t[t.I8VEC2_NORM=Pt(4,1,2,1)]="I8VEC2_NORM",t[t.I8VEC3_NORM=Pt(4,1,3,1)]="I8VEC3_NORM",t[t.I8VEC4_NORM=Pt(4,1,4,1)]="I8VEC4_NORM",t[t.I16=Pt(5,1,1,0)]="I16",t[t.I16VEC2=Pt(5,1,2,0)]="I16VEC2",t[t.I16VEC3=Pt(5,1,3,0)]="I16VEC3",t[t.I16VEC4=Pt(5,1,4,0)]="I16VEC4",t[t.I16_NORM=Pt(5,1,1,1)]="I16_NORM",t[t.I16VEC2_NORM=Pt(5,1,2,1)]="I16VEC2_NORM",t[t.I16VEC3_NORM=Pt(5,1,3,1)]="I16VEC3_NORM",t[t.I16VEC4_NORM=Pt(5,1,4,1)]="I16VEC4_NORM",t[t.I32=Pt(6,1,1,0)]="I32",t[t.I32VEC2=Pt(6,1,2,0)]="I32VEC2",t[t.I32VEC3=Pt(6,1,3,0)]="I32VEC3",t[t.I32VEC4=Pt(6,1,4,0)]="I32VEC4",t[t.I32_NORM=Pt(6,1,1,1)]="I32_NORM",t[t.I32VEC2_NORM=Pt(6,1,2,1)]="I32VEC2_NORM",t[t.I32VEC3_NORM=Pt(6,1,3,1)]="I32VEC3_NORM",t[t.I32VEC4_NORM=Pt(6,1,4,1)]="I32VEC4_NORM",t[t.U8=Pt(7,1,1,0)]="U8",t[t.U8VEC2=Pt(7,1,2,0)]="U8VEC2",t[t.U8VEC3=Pt(7,1,3,0)]="U8VEC3",t[t.U8VEC4=Pt(7,1,4,0)]="U8VEC4",t[t.U8_NORM=Pt(7,1,1,1)]="U8_NORM",t[t.U8VEC2_NORM=Pt(7,1,2,1)]="U8VEC2_NORM",t[t.U8VEC3_NORM=Pt(7,1,3,1)]="U8VEC3_NORM",t[t.U8VEC4_NORM=Pt(7,1,4,1)]="U8VEC4_NORM",t[t.U16=Pt(8,1,1,0)]="U16",t[t.U16VEC2=Pt(8,1,2,0)]="U16VEC2",t[t.U16VEC3=Pt(8,1,3,0)]="U16VEC3",t[t.U16VEC4=Pt(8,1,4,0)]="U16VEC4",t[t.U16_NORM=Pt(8,1,1,1)]="U16_NORM",t[t.U16VEC2_NORM=Pt(8,1,2,1)]="U16VEC2_NORM",t[t.U16VEC3_NORM=Pt(8,1,3,1)]="U16VEC3_NORM",t[t.U16VEC4_NORM=Pt(8,1,4,1)]="U16VEC4_NORM",t[t.U32=Pt(9,1,1,0)]="U32",t[t.U32VEC2=Pt(9,1,2,0)]="U32VEC2",t[t.U32VEC3=Pt(9,1,3,0)]="U32VEC3",t[t.U32VEC4=Pt(9,1,4,0)]="U32VEC4",t[t.U32_NORM=Pt(9,1,1,1)]="U32_NORM",t[t.U32VEC2_NORM=Pt(9,1,2,1)]="U32VEC2_NORM",t[t.U32VEC3_NORM=Pt(9,1,3,1)]="U32VEC3_NORM",t[t.U32VEC4_NORM=Pt(9,1,4,1)]="U32VEC4_NORM",t[t.MAT2=Pt(2,2,2,0)]="MAT2",t[t.MAT2x3=Pt(2,2,3,0)]="MAT2x3",t[t.MAT2x4=Pt(2,2,4,0)]="MAT2x4",t[t.MAT3x2=Pt(2,3,2,0)]="MAT3x2",t[t.MAT3=Pt(2,3,3,0)]="MAT3",t[t.MAT3x4=Pt(2,3,4,0)]="MAT3x4",t[t.MAT4x2=Pt(2,4,2,0)]="MAT4x2",t[t.MAT4x3=Pt(2,4,3,0)]="MAT4x3",t[t.MAT4=Pt(2,4,4,0)]="MAT4"}(Bt||(Bt={}));const Ot={[Bt.F32]:"float",[Bt.F32VEC2]:"vec2",[Bt.F32VEC3]:"vec3",[Bt.F32VEC4]:"vec4",[Bt.BOOL]:"bool",[Bt.BVEC2]:"bvec2",[Bt.BVEC3]:"bvec3",[Bt.BVEC4]:"bvec4",[Bt.I32]:"int",[Bt.I32VEC2]:"ivec2",[Bt.I32VEC3]:"ivec3",[Bt.I32VEC4]:"ivec4",[Bt.U32]:"uint",[Bt.U32VEC2]:"uvec2",[Bt.U32VEC3]:"uvec3",[Bt.U32VEC4]:"uvec4",[Bt.MAT2]:"mat2",[Bt.MAT2x3]:"mat2x3",[Bt.MAT2x4]:"mat2x4",[Bt.MAT3x2]:"mat3x2",[Bt.MAT3]:"mat3",[Bt.MAT3x4]:"mat3x4",[Bt.MAT4x2]:"mat4x2",[Bt.MAT4x3]:"mat4x3",[Bt.MAT4]:"mat4"},Ut={[Bt.F32]:"f32",[Bt.F32VEC2]:"vec2<f32>",[Bt.F32VEC3]:"vec3<f32>",[Bt.F32VEC4]:"vec4<f32>",[Bt.BOOL]:"bool",[Bt.BVEC2]:"vec2<bool>",[Bt.BVEC3]:"vec3<bool>",[Bt.BVEC4]:"vec4<bool>",[Bt.I32]:"i32",[Bt.I32VEC2]:"vec2<i32>",[Bt.I32VEC3]:"vec3<i32>",[Bt.I32VEC4]:"vec4<i32>",[Bt.U32]:"u32",[Bt.U32VEC2]:"vec2<u32>",[Bt.U32VEC3]:"vec3<u32>",[Bt.U32VEC4]:"vec4<u32>",[Bt.MAT2]:"mat2x2<f32>",[Bt.MAT2x3]:"mat2x3<f32>",[Bt.MAT2x4]:"mat2x4<f32>",[Bt.MAT3x2]:"mat3x2<f32>",[Bt.MAT3]:"mat3x3<f32>",[Bt.MAT3x4]:"mat3x4<f32>",[Bt.MAT4x2]:"mat4x2<f32>",[Bt.MAT4x3]:"mat4x3<f32>",[Bt.MAT4]:"mat4x4<f32>"},kt=16,zt=64,Vt=128,Gt=512,Xt=1024;var Wt;!function(t){t[t.TEX_1D=257]="TEX_1D",t[t.ITEX_1D=513]="ITEX_1D",t[t.UTEX_1D=1025]="UTEX_1D",t[t.TEX_2D=258]="TEX_2D",t[t.ITEX_2D=514]="ITEX_2D",t[t.UTEX_2D=1026]="UTEX_2D",t[t.TEX_2D_ARRAY=274]="TEX_2D_ARRAY",t[t.ITEX_2D_ARRAY=530]="ITEX_2D_ARRAY",t[t.UTEX_2D_ARRAY=1042]="UTEX_2D_ARRAY",t[t.TEX_3D=260]="TEX_3D",t[t.ITEX_3D=516]="ITEX_3D",t[t.UTEX_3D=1028]="UTEX_3D",t[t.TEX_CUBE=264]="TEX_CUBE",t[t.ITEX_CUBE=520]="ITEX_CUBE",t[t.UTEX_CUBE=1032]="UTEX_CUBE",t[t.TEX_CUBE_ARRAY=280]="TEX_CUBE_ARRAY",t[t.ITEX_CUBE_ARRAY=536]="ITEX_CUBE_ARRAY",t[t.UTEX_CUBE_ARRAY=1048]="UTEX_CUBE_ARRAY",t[t.TEX_MULTISAMPLED_2D=290]="TEX_MULTISAMPLED_2D",t[t.ITEX_MULTISAMPLED_2D=546]="ITEX_MULTISAMPLED_2D",t[t.UTEX_MULTISAMPLED_2D=1058]="UTEX_MULTISAMPLED_2D",t[t.TEX_STORAGE_1D=65]="TEX_STORAGE_1D",t[t.TEX_STORAGE_2D=66]="TEX_STORAGE_2D",t[t.TEX_STORAGE_2D_ARRAY=82]="TEX_STORAGE_2D_ARRAY",t[t.TEX_STORAGE_3D=68]="TEX_STORAGE_3D",t[t.TEX_DEPTH_2D=130]="TEX_DEPTH_2D",t[t.TEX_DEPTH_2D_ARRAY=146]="TEX_DEPTH_2D_ARRAY",t[t.TEX_DEPTH_CUBE=136]="TEX_DEPTH_CUBE",t[t.TEX_DEPTH_CUBE_ARRAY=152]="TEX_DEPTH_CUBE_ARRAY",t[t.TEX_DEPTH_MULTISAMPLED_2D=162]="TEX_DEPTH_MULTISAMPLED_2D",t[t.TEX_EXTERNAL=2048]="TEX_EXTERNAL"}(Wt||(Wt={}));const Ht={[Wt.TEX_1D]:"highp sampler2D",[Wt.TEX_2D]:"highp sampler2D",[Wt.TEX_CUBE]:"highp samplerCube",[Wt.TEX_EXTERNAL]:"highp sampler2D"},jt={[Wt.TEX_1D]:"highp sampler2D",[Wt.TEX_2D]:"highp sampler2D",[Wt.ITEX_1D]:"highp isampler2D",[Wt.ITEX_2D]:"highp isampler2D",[Wt.UTEX_1D]:"highp usampler2D",[Wt.UTEX_2D]:"highp usampler2D",[Wt.TEX_2D_ARRAY]:"highp sampler2DArray",[Wt.ITEX_2D_ARRAY]:"highp isampler2DArray",[Wt.UTEX_2D_ARRAY]:"highp usampler2DArray",[Wt.TEX_3D]:"highp sampler3D",[Wt.ITEX_3D]:"highp isampler3D",[Wt.UTEX_3D]:"highp usampler3D",[Wt.TEX_CUBE]:"highp samplerCube",[Wt.ITEX_CUBE]:"highp isamplerCube",[Wt.UTEX_CUBE]:"highp usamplerCube",[Wt.TEX_DEPTH_2D]:"highp sampler2DShadow",[Wt.TEX_DEPTH_2D_ARRAY]:"highp sampler2DArrayShadow",[Wt.TEX_DEPTH_CUBE]:"highp samplerCubeShadow",[Wt.TEX_EXTERNAL]:"highp sampler2D"},qt={[Wt.TEX_1D]:"texture_1d<f32>",[Wt.ITEX_1D]:"texture_1d<i32>",[Wt.UTEX_1D]:"texture_1d<u32>",[Wt.TEX_2D]:"texture_2d<f32>",[Wt.ITEX_2D]:"texture_2d<i32>",[Wt.UTEX_2D]:"texture_2d<u32>",[Wt.TEX_2D_ARRAY]:"texture_2d_array<f32>",[Wt.ITEX_2D_ARRAY]:"texture_2d_array<i32>",[Wt.UTEX_2D_ARRAY]:"texture_2d_array<u32>",[Wt.TEX_3D]:"texture_3d<f32>",[Wt.ITEX_3D]:"texture_3d<i32>",[Wt.UTEX_3D]:"texture_3d<u32>",[Wt.TEX_CUBE]:"texture_cube<f32>",[Wt.ITEX_CUBE]:"texture_cube<i32>",[Wt.UTEX_CUBE]:"texture_cube<u32>",[Wt.TEX_CUBE_ARRAY]:"texture_cube_array<f32>",[Wt.ITEX_CUBE_ARRAY]:"texture_cube_array<i32>",[Wt.UTEX_CUBE_ARRAY]:"texture_cube_array<u32>",[Wt.TEX_MULTISAMPLED_2D]:"texture_multisampled_2d<f32>",[Wt.ITEX_MULTISAMPLED_2D]:"texture_multisampled_2d<i32>",[Wt.UTEX_MULTISAMPLED_2D]:"texture_multisampled_2d<u32>",[Wt.TEX_STORAGE_1D]:"texture_storage_1d",[Wt.TEX_STORAGE_2D]:"texture_storage_2d",[Wt.TEX_STORAGE_2D_ARRAY]:"texture_storage_2d_array",[Wt.TEX_STORAGE_3D]:"texture_storage_3d",[Wt.TEX_DEPTH_2D]:"texture_depth_2d",[Wt.TEX_DEPTH_2D_ARRAY]:"texture_depth_2d_array",[Wt.TEX_DEPTH_CUBE]:"texture_depth_cube",[Wt.TEX_DEPTH_CUBE_ARRAY]:"texture_depth_cube_array",[Wt.TEX_DEPTH_MULTISAMPLED_2D]:"texture_depth_multisampled_2d",[Wt.TEX_EXTERNAL]:"texture_external"},Yt={rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",bgra8unorm:"bgra8unorm",rgba8ui:"rgba8uint",rgba8i:"rgba8sint",rgba16ui:"rgba16uint",rgba16i:"rgba16sint",rgba16f:"rgba16float",r32f:"r32float",r32ui:"r32uint",r32i:"r32sint",rg32f:"rg32float",rg32ui:"rg32uint",rg32i:"rg32sint",rgba32f:"rgba32float",rgba32ui:"rgba32uint",rgba32i:"rgba32sint"};var Zt,Kt,Qt;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SAMPLE=1]="SAMPLE",t[t.COMPARISON=2]="COMPARISON"}(Zt||(Zt={})),function(t){t.UNKNOWN="unknown",t.FUNCTION="function",t.PRIVATE="private",t.WORKGROUP="workgroup",t.UNIFORM="uniform",t.STORAGE="storage"}(Kt||(Kt={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.PLAIN=1]="PLAIN",t[t.ARRAY=2]="ARRAY",t[t.POINTER=3]="POINTER",t[t.ATOMIC_I32=4]="ATOMIC_I32",t[t.ATOMIC_U32=5]="ATOMIC_U32",t[t.TEXTURE=6]="TEXTURE",t[t.SAMPLER=7]="SAMPLER",t[t.FUNCTION=8]="FUNCTION",t[t.VOID=9]="VOID",t[t.ANY=10]="ANY"}(Qt||(Qt={}));class Jt{cls;detail;id;constructor(t,e){this.cls=t,this.detail=e,this.id=null}get typeId(){return this.id||(this.id=this.genTypeId()),this.id}isVoidType(){return!1}isAnyType(){return!1}isPrimitiveType(){return!1}haveAtomicMembers(){return!1}isStructType(){return!1}isArrayType(){return!1}isPointerType(){return!1}isAtomicI32(){return!1}isAtomicU32(){return!1}isSamplerType(){return!1}isTextureType(){return!1}isHostSharable(){return!1}isConstructible(){return!1}isStorable(){return!1}getConstructorOverloads(t){return[]}isCompatibleType(t){return t.typeId===this.typeId}}class te extends Jt{static cachedTypes={};static cachedCtorOverloads={};constructor(t){super(Qt.PLAIN,{primitiveType:t})}static getCachedTypeInfo(t){let e=this.cachedTypes[t];return e||(e=new te(t),this.cachedTypes[t]=e),e}static getCachedOverloads(t,e){let i=this.cachedCtorOverloads[t];i||(i={},this.cachedCtorOverloads[t]=i);let s=i[e];if(!s){const r=this.getCachedTypeInfo(e),n=r.toTypeName(t);if(s=[new ae(n,r,[])],r.isScalarType())s.push(new ae(n,r,[{type:this.getCachedTypeInfo(Bt.F32)}])),s.push(new ae(n,r,[{type:this.getCachedTypeInfo(Bt.I32)}])),s.push(new ae(n,r,[{type:this.getCachedTypeInfo(Bt.U32)}])),s.push(new ae(n,r,[{type:this.getCachedTypeInfo(Bt.BOOL)}]));else if(r.isVectorType()){const t={type:this.getCachedTypeInfo(r.scalarType)},e={type:this.getCachedTypeInfo(r.resizeType(1,2))},i={type:this.getCachedTypeInfo(r.resizeType(1,3))};switch(s.push(new ae(n,r,[t])),r.cols){case 2:s.push(new ae(n,r,[t,t])),s.push(new ae(n,r,[{type:he}])),s.push(new ae(n,r,[{type:me}])),s.push(new ae(n,r,[{type:xe}])),s.push(new ae(n,r,[{type:ve}]));break;case 3:s.push(new ae(n,r,[t,t,t])),s.push(new ae(n,r,[t,e])),s.push(new ae(n,r,[e,t])),s.push(new ae(n,r,[{type:le}])),s.push(new ae(n,r,[{type:fe}])),s.push(new ae(n,r,[{type:be}])),s.push(new ae(n,r,[{type:ye}]));break;case 4:s.push(new ae(n,r,[t,t,t,t])),s.push(new ae(n,r,[t,t,e])),s.push(new ae(n,r,[t,e,t])),s.push(new ae(n,r,[e,t,t])),s.push(new ae(n,r,[e,e])),s.push(new ae(n,r,[t,i])),s.push(new ae(n,r,[i,t])),s.push(new ae(n,r,[{type:ue}])),s.push(new ae(n,r,[{type:_e}])),s.push(new ae(n,r,[{type:we}])),s.push(new ae(n,r,[{type:Ee}]))}}else if(r.isMatrixType()){const t=this.getCachedTypeInfo(r.resizeType(1,r.cols));s.push(new ae(n,r,Array.from({length:r.rows}).map((()=>({type:t}))))),s.push(new ae(n,r,Array.from({length:r.rows*r.cols}).map((()=>({type:oe})))))}i[e]=s}return s}get primitiveType(){return this.detail.primitiveType}isInteger(){const t=15&this.primitiveType;return 4===t||7===t||5===t||8===t||6===t||9===t}get scalarType(){return this.resizeType(1,1)}get rows(){return this.primitiveType>>4&7}get cols(){return this.primitiveType>>7&7}get normalized(){return!!(this.primitiveType>>10&1)}getLayoutAlignment(t){return"packed"===t?1:this.isScalarType()?4:1<<Math.min(4,this.cols+1)}getLayoutSize(){return this.getSize()}getSize(){let t;switch(this.scalarType){case Bt.BOOL:case Bt.I32:case Bt.I32_NORM:case Bt.U32:case Bt.U32_NORM:case Bt.F32:t=4;break;case Bt.F16:case Bt.I16:case Bt.I16_NORM:case Bt.U16:case Bt.U16_NORM:t=2;break;default:t=1}return t*this.cols*this.rows}resizeType(t,e){return Pt(15&this.primitiveType,t,e,this.normalized?1:0)}isScalarType(){return 1===this.rows&&1===this.cols}isVectorType(){return 1===this.rows&&this.cols>1}isMatrixType(){return this.rows>1&&this.cols>1}isPrimitiveType(){return!0}isHostSharable(){return this.scalarType!==Bt.BOOL}isConstructible(){return!0}isStorable(){return!0}getConstructorOverloads(t){return te.getCachedOverloads(t,this.primitiveType)}toTypeName(t,e){if("webgpu"===t){const t=Ut[this.primitiveType];return e?`${e}: ${t}`:t}{const t=Ot[this.primitiveType];return e?`${t} ${e}`:t}}toBufferLayout(t){return null}genTypeId(){return`PRIM:${this.primitiveType}`}}class ee extends Jt{constructor(t,e,i){super(Qt.PLAIN,{layout:e||"default",structName:t,structMembers:i.map((t=>{const e=Dt(t.type),i=$t(t.type);return{name:t.name,type:t.type,alignment:e,size:i,defaultAlignment:e,defaultSize:i}}))}),"std140"===this.layout?this.calcAlignmentAndSizeSTD140():"std430"===this.layout&&this.calcAlignmentAndSizePacked()}get layout(){return this.detail.layout}get structName(){return this.detail.structName}set structName(t){this.detail.structName=t}get structMembers(){return this.detail.structMembers}haveAtomicMembers(){for(const t of this.structMembers)return!(!t.type.isStructType()||!t.type.haveAtomicMembers())||(!(!t.type.isArrayType()||!t.type.haveAtomicMembers())||(t.type.isAtomicI32()||t.type.isAtomicU32()))}extends(t,e){const i=this.structMembers.map((t=>({name:t.name,type:t.type})));return new ee(t,this.layout,[...i,...e])}isStructType(){return!0}isHostSharable(){return this.detail.structMembers.every((t=>t.type.isHostSharable()))}isConstructible(){return this.detail.structMembers.every((t=>t.type.isConstructible()))}isStorable(){return!0}getConstructorOverloads(){const t=[new ae(this.structName,this,[])];return this.isConstructible()&&t.push(new ae(this.structName,this,this.structMembers.map((t=>({type:t.type}))))),t}toTypeName(t,e){return"webgpu"===t?e?`${e}: ${this.structName}`:this.structName:e?`${this.structName} ${e}`:this.structName}getLayoutAlignment(t){if("packed"===t)return 1;let e=0;for(const i of this.structMembers)e=Math.max(e,i.type.getLayoutAlignment(t));return"std140"===t&&(e=It(e,16)),e}getLayoutSize(t){let e=0,i=0;for(const s of this.structMembers){const r=s.type.getLayoutAlignment(t);e=It(e,r),e+=s.type.getLayoutSize(t),i=Math.max(i,r)}return It(e,i)}toBufferLayout(t,e){const i={byteSize:0,entries:[]},s=t;for(const s of this.structMembers){t=It(t,s.type.getLayoutAlignment(e));const r=s.type.getLayoutSize(e);i.entries.push({name:s.name,offset:t,byteSize:r,type:Nt(s.type),subLayout:s.type.isStructType()?s.type.toBufferLayout(t,e):null,arraySize:s.type.isArrayType()?s.type.dimension:0}),t+=r}return i.byteSize="std140"===e?It(t-s,16):t-s,i}clone(t){return new ee(t||this.structName,this.layout,this.structMembers)}reset(t,e,i){this.detail={layout:e||"default",structName:t,structMembers:i.map((t=>{const e=Dt(t.type),i=$t(t.type);return{name:t.name,type:t.type,alignment:e,size:i,defaultAlignment:e,defaultSize:i}}))},"std140"===this.layout?this.calcAlignmentAndSizeSTD140():"std430"===this.layout&&this.calcAlignmentAndSizePacked(),this.id=null}genTypeId(){return`STRUCT:${this.structName}:${this.layout}:${this.structMembers.map((t=>`${t.name}(${t.type.typeId})`)).join(":")}`}calcAlignmentAndSizeSTD140(){for(const t of this.structMembers)if(t.type.isPrimitiveType()){if(t.type.isMatrixType()&&2===t.type.cols)throw new Error(`matrix${t.type.rows}x${t.type.cols} can not be used in std140 layout`)}else{if(t.type.isArrayType()&&(t.type.elementType.isAnyType()||16!==Dt(t.type.elementType)))throw new Error("array element must be 16 bytes aligned in std140 layout");t.type.isStructType()&&(t.alignment=16,t.size=It(t.defaultSize,16))}}calcAlignmentAndSizePacked(){for(const t of this.structMembers)t.alignment=(t.type,1),t.size=Lt(t.type)}}class ie extends Jt{constructor(t,e){super(Qt.ARRAY,{elementType:t,dimension:Number(e)||0})}get elementType(){return this.detail.elementType}get dimension(){return this.detail.dimension}haveAtomicMembers(){return this.elementType.isStructType()||this.elementType.isArrayType()?this.elementType.haveAtomicMembers():this.elementType.isAtomicI32()||this.elementType.isAtomicU32()}isArrayType(){return!0}isHostSharable(){return this.detail.elementType.isHostSharable()}isConstructible(){return this.dimension&&this.detail.elementType.isConstructible()}isStorable(){return!0}getConstructorOverloads(t){const e=this.toTypeName(t),i=[new ae(e,this,[])];return"webgl"!==t&&this.isConstructible()&&i.push(new ae(e,this,Array.from({length:this.dimension}).map((()=>({type:this.elementType}))))),i}toTypeName(t,e){if("webgpu"===t){const i=`array<${this.elementType.toTypeName(t)}${this.dimension?", "+this.dimension:""}>`;return e?`${e}: ${i}`:i}console.assert(!!this.dimension,"runtime-sized array not supported for webgl"),console.assert(!this.elementType.isArrayType(),"multi-dimensional arrays not supported for webgl");return`${this.elementType.toTypeName(t,e)}[${this.dimension}]`}getLayoutAlignment(t){return"packed"===t||this.elementType.isAnyType()?1:"std430"===t?this.elementType.getLayoutAlignment(t):It(this.elementType.getLayoutAlignment(t),16)}getLayoutSize(t){const e=this.elementType.isAnyType()?1:this.elementType.getLayoutAlignment(t);if("std140"===t&&15&e)throw new Error("Error: array element stride of std140 must be multiple of 16");return this.elementType.isAnyType()?0:this.dimension*It(this.elementType.getLayoutSize(t),e)}toBufferLayout(t){return null}isCompatibleType(t){return!!t.isArrayType()&&((0===this.dimension||t.dimension===this.dimension)&&this.elementType.isCompatibleType(t.elementType))}genTypeId(){return`ARRAY:(${this.elementType.typeId})[${this.dimension}]`}}class se extends Jt{writable;constructor(t,e){super(Qt.POINTER,{pointerType:t,addressSpace:e}),console.assert(t.isStorable(),"the pointee type must be storable"),this.writable=!1}get pointerType(){return this.detail.pointerType}get addressSpace(){return this.detail.addressSpace}set addressSpace(t){this.detail.addressSpace!==t&&(this.detail.addressSpace=t,this.id=null)}haveAtomicMembers(){return this.pointerType.haveAtomicMembers()}isPointerType(){return!0}toTypeName(t,e){if("webgpu"===t){const i=this.addressSpace===Kt.UNKNOWN?Kt.FUNCTION:this.addressSpace,s=i===Kt.STORAGE&&this.writable?", read_write":"",r=`ptr<${i}, ${this.pointerType.toTypeName(t)} ${s}>`;return e?`${e}: ${r}`:r}throw new Error("pointer type not supported for webgl")}toBufferLayout(t){return null}genTypeId(){return`PTR:(${this.pointerType.typeId})`}}class re extends Jt{constructor(t){super(Qt.SAMPLER,{accessMode:t})}get accessMode(){return this.detail.accessMode}isSamplerType(){return!0}isStorable(){return!0}toTypeName(t,e){if("webgpu"===t){const t=this.accessMode===Zt.SAMPLE?"sampler":"sampler_comparison";return e?`${e}: ${t}`:t}throw new Error("sampler type not supported for webgl")}toBufferLayout(t){return null}genTypeId(){return`SAMPLER:${this.accessMode}`}}class ne extends Jt{constructor(t,e,i,s){super(Qt.TEXTURE,{textureType:t,readable:i,writable:s,storageTexelFormat:e||null}),console.assert(!!qt[t],"unsupported texture type"),console.assert(!(t&zt&&!Yt[e]),"invalid texel format for storage texture")}get textureType(){return this.detail.textureType}get storageTexelFormat(){return this.detail.storageTexelFormat}get readable(){return this.detail.readable}set readable(t){this.detail.readable=!!t}get writable(){return this.detail.writable}set writable(t){this.detail.writable=!!t}isStorable(){return!0}is1DTexture(){return!!(1&this.detail.textureType)}is2DTexture(){return!!(2&this.detail.textureType)}is3DTexture(){return!!(4&this.detail.textureType)}isCubeTexture(){return!!(8&this.detail.textureType)}isArrayTexture(){return!!(this.detail.textureType&kt)}isStorageTexture(){return!!(this.detail.textureType&zt)}isDepthTexture(){return!!(this.detail.textureType&Vt)}isMultisampledTexture(){return!!(32&this.detail.textureType)}isExternalTexture(){return!!(2048&this.detail.textureType)}isIntTexture(){return!!(this.detail.textureType&Gt)}isUIntTexture(){return!!(this.detail.textureType&Xt)}isTextureType(){return!0}toTypeName(t,e){if("webgpu"===t){let t=qt[this.textureType];if(this.isStorageTexture()){t=`${t}<${Yt[this.storageTexelFormat]}, ${this.writable?this.readable?"read_write":"write":"read"}>`}return e?`${e}: ${t}`:t}{const i=("webgl"===t?Ht:jt)[this.textureType];return console.assert(!!i,"unsupported texture type"),e?`${i} ${e}`:i}}toBufferLayout(t){return null}genTypeId(){return`TEXTURE:${this.textureType}`}}class ae extends Jt{constructor(t,e,i){super(Qt.FUNCTION,{name:t,returnType:e,argTypes:i})}get name(){return this.detail.name}get returnType(){return this.detail.returnType}get argTypes(){return this.detail.argTypes}get argHash(){return this.argTypes.map((t=>t.type.typeId)).join(",")}genTypeId(){return`fn(${this.argHash}):${this.returnType.typeId}`}toBufferLayout(t){return null}toTypeName(t,e){throw new Error("not supported")}}te.getCachedTypeInfo(Bt.F16),te.getCachedTypeInfo(Bt.F16VEC2),te.getCachedTypeInfo(Bt.F16VEC3),te.getCachedTypeInfo(Bt.F16VEC4);const oe=te.getCachedTypeInfo(Bt.F32),he=te.getCachedTypeInfo(Bt.F32VEC2),le=te.getCachedTypeInfo(Bt.F32VEC3),ue=te.getCachedTypeInfo(Bt.F32VEC4);te.getCachedTypeInfo(Bt.I8),te.getCachedTypeInfo(Bt.I8VEC2),te.getCachedTypeInfo(Bt.I8VEC3),te.getCachedTypeInfo(Bt.I8VEC4),te.getCachedTypeInfo(Bt.I8_NORM),te.getCachedTypeInfo(Bt.I8VEC2_NORM),te.getCachedTypeInfo(Bt.I8VEC3_NORM),te.getCachedTypeInfo(Bt.I8VEC4_NORM),te.getCachedTypeInfo(Bt.I16),te.getCachedTypeInfo(Bt.I16VEC2),te.getCachedTypeInfo(Bt.I16VEC3),te.getCachedTypeInfo(Bt.I16VEC4),te.getCachedTypeInfo(Bt.I16_NORM),te.getCachedTypeInfo(Bt.I16VEC2_NORM),te.getCachedTypeInfo(Bt.I16VEC3_NORM),te.getCachedTypeInfo(Bt.I16VEC4_NORM);const ce=new class extends Jt{constructor(){super(Qt.ATOMIC_I32,null)}haveAtomicMembers(){return!0}isAtomicI32(){return!0}isHostSharable(){return!0}isStorable(){return!0}toTypeName(t,e){if("webgpu"===t){const t="atomic<i32>";return e?`${e}: ${t}`:t}throw new Error("atomic type not supported for webgl")}toBufferLayout(t){return null}getLayoutAlignment(t){return 4}getLayoutSize(){return this.getSize()}getSize(){return 4}genTypeId(){return"ATOMICI32"}},de=new class extends Jt{constructor(){super(Qt.ATOMIC_U32,null)}haveAtomicMembers(){return!0}isAtomicU32(){return!0}isHostSharable(){return!0}isStorable(){return!0}toTypeName(t,e){if("webgpu"===t){const t="atomic<u32>";return e?`${e}: ${t}`:t}throw new Error("atomic type not supported for webgl")}toBufferLayout(t){return null}getLayoutAlignment(t){return 4}getLayoutSize(){return this.getSize()}getSize(){return 4}genTypeId(){return"ATOMICU32"}},pe=te.getCachedTypeInfo(Bt.I32),me=te.getCachedTypeInfo(Bt.I32VEC2),fe=te.getCachedTypeInfo(Bt.I32VEC3),_e=te.getCachedTypeInfo(Bt.I32VEC4);te.getCachedTypeInfo(Bt.I32),te.getCachedTypeInfo(Bt.I32VEC2_NORM),te.getCachedTypeInfo(Bt.I32VEC3_NORM),te.getCachedTypeInfo(Bt.I32VEC4_NORM),te.getCachedTypeInfo(Bt.U8),te.getCachedTypeInfo(Bt.U8VEC2),te.getCachedTypeInfo(Bt.U8VEC3),te.getCachedTypeInfo(Bt.U8VEC4),te.getCachedTypeInfo(Bt.U8_NORM),te.getCachedTypeInfo(Bt.U8VEC2_NORM),te.getCachedTypeInfo(Bt.U8VEC3_NORM),te.getCachedTypeInfo(Bt.U8VEC4_NORM),te.getCachedTypeInfo(Bt.U16),te.getCachedTypeInfo(Bt.U16VEC2),te.getCachedTypeInfo(Bt.U16VEC3),te.getCachedTypeInfo(Bt.U16VEC4),te.getCachedTypeInfo(Bt.U16_NORM),te.getCachedTypeInfo(Bt.U16VEC2_NORM),te.getCachedTypeInfo(Bt.U16VEC3_NORM),te.getCachedTypeInfo(Bt.U16VEC4_NORM);const ge=te.getCachedTypeInfo(Bt.U32),xe=te.getCachedTypeInfo(Bt.U32VEC2),be=te.getCachedTypeInfo(Bt.U32VEC3),we=te.getCachedTypeInfo(Bt.U32VEC4);te.getCachedTypeInfo(Bt.U32_NORM),te.getCachedTypeInfo(Bt.U32VEC2_NORM),te.getCachedTypeInfo(Bt.U32VEC3_NORM),te.getCachedTypeInfo(Bt.U32VEC4_NORM);const Te=te.getCachedTypeInfo(Bt.BOOL),ve=te.getCachedTypeInfo(Bt.BVEC2),ye=te.getCachedTypeInfo(Bt.BVEC3),Ee=te.getCachedTypeInfo(Bt.BVEC4),Se=te.getCachedTypeInfo(Bt.MAT2),Ce=te.getCachedTypeInfo(Bt.MAT2x3),Ae=te.getCachedTypeInfo(Bt.MAT2x4),Me=te.getCachedTypeInfo(Bt.MAT3x2),Re=te.getCachedTypeInfo(Bt.MAT3),Fe=te.getCachedTypeInfo(Bt.MAT3x4),Ie=te.getCachedTypeInfo(Bt.MAT4x2),De=te.getCachedTypeInfo(Bt.MAT4x3),$e=te.getCachedTypeInfo(Bt.MAT4),Le=new ne(Wt.TEX_1D),Pe=new ne(Wt.ITEX_1D),Ne=new ne(Wt.UTEX_1D),Be=new ne(Wt.TEX_2D),Oe=new ne(Wt.ITEX_2D),Ue=new ne(Wt.UTEX_2D),ke=new ne(Wt.TEX_2D_ARRAY),ze=new ne(Wt.ITEX_2D_ARRAY),Ve=new ne(Wt.UTEX_2D_ARRAY),Ge=new ne(Wt.TEX_3D),Xe=new ne(Wt.ITEX_3D),We=new ne(Wt.UTEX_3D),He=new ne(Wt.TEX_CUBE),je=new ne(Wt.ITEX_CUBE),qe=new ne(Wt.UTEX_CUBE),Ye=new ne(Wt.TEX_EXTERNAL),Ze=new ne(Wt.TEX_CUBE_ARRAY),Ke=new ne(Wt.ITEX_CUBE_ARRAY),Qe=new ne(Wt.UTEX_CUBE_ARRAY),Je=new ne(Wt.TEX_MULTISAMPLED_2D),ti=new ne(Wt.ITEX_MULTISAMPLED_2D),ei=new ne(Wt.UTEX_MULTISAMPLED_2D),ii=new ne(Wt.TEX_STORAGE_1D,"rgba8unorm"),si=new ne(Wt.TEX_STORAGE_1D,"rgba8snorm"),ri=new ne(Wt.TEX_STORAGE_1D,"rgba8unorm"),ni=new ne(Wt.TEX_STORAGE_1D,"rgba8ui"),ai=new ne(Wt.TEX_STORAGE_1D,"rgba8i"),oi=new ne(Wt.TEX_STORAGE_1D,"rgba16ui"),hi=new ne(Wt.TEX_STORAGE_1D,"rgba16i"),li=new ne(Wt.TEX_STORAGE_1D,"rgba16f"),ui=new ne(Wt.TEX_STORAGE_1D,"rgba32ui"),ci=new ne(Wt.TEX_STORAGE_1D,"rgba32i"),di=new ne(Wt.TEX_STORAGE_1D,"rgba32f"),pi=new ne(Wt.TEX_STORAGE_1D,"rg32ui"),mi=new ne(Wt.TEX_STORAGE_1D,"rg32i"),fi=new ne(Wt.TEX_STORAGE_1D,"rg32f"),_i=new ne(Wt.TEX_STORAGE_1D,"r32ui"),gi=new ne(Wt.TEX_STORAGE_1D,"r32i"),xi=new ne(Wt.TEX_STORAGE_1D,"r32f"),bi=new ne(Wt.TEX_STORAGE_2D,"rgba8unorm"),wi=new ne(Wt.TEX_STORAGE_2D,"rgba8snorm"),Ti=new ne(Wt.TEX_STORAGE_2D,"bgra8unorm"),vi=new ne(Wt.TEX_STORAGE_2D,"rgba8ui"),yi=new ne(Wt.TEX_STORAGE_2D,"rgba8i"),Ei=new ne(Wt.TEX_STORAGE_2D,"rgba16ui"),Si=new ne(Wt.TEX_STORAGE_2D,"rgba16i"),Ci=new ne(Wt.TEX_STORAGE_2D,"rgba16f"),Ai=new ne(Wt.TEX_STORAGE_2D,"rgba32ui"),Mi=new ne(Wt.TEX_STORAGE_2D,"rgba32i"),Ri=new ne(Wt.TEX_STORAGE_2D,"rgba32f"),Fi=new ne(Wt.TEX_STORAGE_2D,"rg32ui"),Ii=new ne(Wt.TEX_STORAGE_2D,"rg32i"),Di=new ne(Wt.TEX_STORAGE_2D,"rg32f"),$i=new ne(Wt.TEX_STORAGE_2D,"r32ui"),Li=new ne(Wt.TEX_STORAGE_2D,"r32i"),Pi=new ne(Wt.TEX_STORAGE_2D,"r32f"),Ni=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rgba8unorm"),Bi=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rgba8snorm");new ne(Wt.TEX_STORAGE_2D_ARRAY,"bgra8unorm");const Oi=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rgba8ui"),Ui=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rgba8i"),ki=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rgba16ui"),zi=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rgba16i"),Vi=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rgba16f"),Gi=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rgba32ui"),Xi=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rgba32i"),Wi=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rgba32f"),Hi=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rg32ui"),ji=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rg32i"),qi=new ne(Wt.TEX_STORAGE_2D_ARRAY,"rg32f"),Yi=new ne(Wt.TEX_STORAGE_2D_ARRAY,"r32ui"),Zi=new ne(Wt.TEX_STORAGE_2D_ARRAY,"r32i"),Ki=new ne(Wt.TEX_STORAGE_2D_ARRAY,"r32f"),Qi=new ne(Wt.TEX_STORAGE_3D,"rgba8unorm"),Ji=new ne(Wt.TEX_STORAGE_3D,"rgba8snorm"),ts=new ne(Wt.TEX_STORAGE_3D,"bgra8unorm"),es=new ne(Wt.TEX_STORAGE_3D,"rgba8ui"),is=new ne(Wt.TEX_STORAGE_3D,"rgba8i"),ss=new ne(Wt.TEX_STORAGE_3D,"rgba16ui"),rs=new ne(Wt.TEX_STORAGE_3D,"rgba16i"),ns=new ne(Wt.TEX_STORAGE_3D,"rgba16f"),as=new ne(Wt.TEX_STORAGE_3D,"rgba32ui"),os=new ne(Wt.TEX_STORAGE_3D,"rgba32i"),hs=new ne(Wt.TEX_STORAGE_3D,"rgba32f"),ls=new ne(Wt.TEX_STORAGE_3D,"rg32ui"),us=new ne(Wt.TEX_STORAGE_3D,"rg32i"),cs=new ne(Wt.TEX_STORAGE_3D,"rg32f"),ds=new ne(Wt.TEX_STORAGE_3D,"r32ui"),ps=new ne(Wt.TEX_STORAGE_3D,"r32i"),ms=new ne(Wt.TEX_STORAGE_3D,"r32f"),fs=new ne(Wt.TEX_DEPTH_2D),_s=new ne(Wt.TEX_DEPTH_2D_ARRAY),gs=new ne(Wt.TEX_DEPTH_CUBE),xs=new ne(Wt.TEX_DEPTH_CUBE_ARRAY),bs=new ne(Wt.TEX_DEPTH_MULTISAMPLED_2D),ws=new re(Zt.SAMPLE),Ts=new re(Zt.COMPARISON),vs=new class extends Jt{constructor(){super(Qt.VOID,null)}isVoidType(){return!0}toTypeName(t,e){return"void"}genTypeId(){return"void"}toBufferLayout(t){return null}};new class extends Jt{constructor(){super(Qt.ANY,null)}isAnyType(){return!0}toTypeName(t,e){return"any"}genTypeId(){return"any"}toBufferLayout(t){return null}isCompatibleType(t){return!0}};const ys=new ee("FrexpResult","default",[{name:"sig",type:oe},{name:"exp",type:pe}]),Es=new ee("FrexpResultVec2","default",[{name:"sig",type:he},{name:"exp",type:me}]),Ss=new ee("FrexpResultVec3","default",[{name:"sig",type:le},{name:"exp",type:fe}]),Cs=new ee("FrexpResultVec4","default",[{name:"sig",type:ue},{name:"exp",type:_e}]),As=10,Ms=11,Rs=12,Fs=13,Is={position_u8normx2:[0,Bt.U8VEC2_NORM,2,"u8norm",2],position_u8normx4:[0,Bt.U8VEC4_NORM,4,"u8norm",4],position_i8normx2:[0,Bt.I8VEC2_NORM,2,"i8norm",2],position_i8normx4:[0,Bt.I8VEC4_NORM,4,"i8norm",4],position_u16x2:[0,Bt.U16VEC2,4,"u16",2],position_u16x4:[0,Bt.U16VEC4,8,"u16",4],position_i16x2:[0,Bt.I16VEC2,4,"i16",2],position_i16x4:[0,Bt.I16VEC4,8,"i16",4],position_u16normx2:[0,Bt.U16VEC2_NORM,4,"u16norm",2],position_u16normx4:[0,Bt.U16VEC4_NORM,8,"u16norm",4],position_i16normx2:[0,Bt.I16VEC2_NORM,4,"i16norm",2],position_i16normx4:[0,Bt.I16VEC4_NORM,8,"i16norm",4],position_f16x2:[0,Bt.F16VEC2,4,"f16",2],position_f16x4:[0,Bt.F16VEC4,8,"f16",4],position_f32:[0,Bt.F32,4,"f32",1],position_f32x2:[0,Bt.F32VEC2,8,"f32",2],position_f32x3:[0,Bt.F32VEC3,12,"f32",3],position_f32x4:[0,Bt.F32VEC4,16,"f32",4],position_i32:[0,Bt.I32,4,"i32",1],position_i32x2:[0,Bt.I32VEC2,8,"i32",2],position_i32x3:[0,Bt.I32VEC3,12,"i32",3],position_i32x4:[0,Bt.I32VEC4,16,"i32",4],position_u32:[0,Bt.U32,4,"u32",1],position_u32x2:[0,Bt.U32VEC2,8,"u32",2],position_u32x3:[0,Bt.U32VEC3,12,"u32",3],position_u32x4:[0,Bt.U32VEC4,16,"u32",4],normal_f16x4:[1,Bt.F16VEC4,8,"f16",4],normal_f32x3:[1,Bt.F32VEC3,12,"f32",3],normal_f32x4:[1,Bt.F32VEC4,16,"f32",4],diffuse_u8normx4:[2,Bt.U8VEC4_NORM,4,"u8norm",4],diffuse_u16x4:[2,Bt.U16VEC4,8,"u16",4],diffuse_u16normx4:[2,Bt.U16VEC4_NORM,8,"u16norm",4],diffuse_f16x4:[2,Bt.F16VEC4,8,"f16",4],diffuse_f32x3:[2,Bt.F32VEC3,12,"f32",3],diffuse_f32x4:[2,Bt.F32VEC4,16,"f32",4],diffuse_u32x3:[2,Bt.U32VEC3,12,"u32",3],diffuse_u32x4:[2,Bt.U32VEC4,16,"u32",4],tangent_f16x4:[3,Bt.F16VEC4,8,"f16",4],tangent_f32x3:[3,Bt.F32VEC3,12,"f32",3],tangent_f32x4:[3,Bt.F32VEC4,16,"f32",4],tex0_u8normx2:[4,Bt.U8VEC2_NORM,2,"u8norm",2],tex0_u8normx4:[4,Bt.U8VEC4_NORM,4,"u8norm",4],tex0_i8normx2:[4,Bt.I8VEC2_NORM,2,"i8norm",2],tex0_i8normx4:[4,Bt.I8VEC4_NORM,4,"i8norm",4],tex0_u16x2:[4,Bt.U16VEC2,4,"u16",2],tex0_u16x4:[4,Bt.U16VEC4,8,"u16",4],tex0_i16x2:[4,Bt.I16VEC2,4,"i16",2],tex0_i16x4:[4,Bt.I16VEC4,8,"i16",4],tex0_u16normx2:[4,Bt.U16VEC2_NORM,4,"u16norm",2],tex0_u16normx4:[4,Bt.U16VEC4_NORM,8,"u16norm",4],tex0_i16normx2:[4,Bt.I16VEC2_NORM,4,"i16norm",2],tex0_i16normx4:[4,Bt.I16VEC4_NORM,8,"i16norm",4],tex0_f16x2:[4,Bt.F16VEC2,4,"f16",2],tex0_f16x4:[4,Bt.F16VEC4,8,"f16",4],tex0_f32:[4,Bt.F32,4,"f32",1],tex0_f32x2:[4,Bt.F32VEC2,8,"f32",2],tex0_f32x3:[4,Bt.F32VEC3,12,"f32",3],tex0_f32x4:[4,Bt.F32VEC4,16,"f32",4],tex0_i32:[4,Bt.I32,4,"i32",1],tex0_i32x2:[4,Bt.I32VEC2,8,"i32",2],tex0_i32x3:[4,Bt.I32VEC3,12,"i32",3],tex0_i32x4:[4,Bt.I32VEC4,16,"i32",4],tex0_u32:[4,Bt.U32,4,"u32",1],tex0_u32x2:[4,Bt.U32VEC2,8,"u32",2],tex0_u32x3:[4,Bt.U32VEC3,12,"u32",3],tex0_u32x4:[4,Bt.U32VEC4,16,"u32",4],tex1_u8normx2:[5,Bt.U8VEC2_NORM,2,"u8norm",2],tex1_u8normx4:[5,Bt.U8VEC4_NORM,4,"u8norm",4],tex1_i8normx2:[5,Bt.I8VEC2_NORM,2,"i8norm",2],tex1_i8normx4:[5,Bt.I8VEC4_NORM,4,"i8norm",4],tex1_u16x2:[5,Bt.U16VEC2,4,"u16",2],tex1_u16x4:[5,Bt.U16VEC4,8,"u16",4],tex1_i16x2:[5,Bt.I16VEC2,4,"i16",2],tex1_i16x4:[5,Bt.I16VEC4,8,"i16",4],tex1_u16normx2:[5,Bt.U16VEC2_NORM,4,"u16norm",2],tex1_u16normx4:[5,Bt.U16VEC4_NORM,8,"u16norm",4],tex1_i16normx2:[5,Bt.I16VEC2_NORM,4,"i16norm",2],tex1_i16normx4:[5,Bt.I16VEC4_NORM,8,"i16norm",4],tex1_f16x2:[5,Bt.F16VEC2,4,"f16",2],tex1_f16x4:[5,Bt.F16VEC4,8,"f16",4],tex1_f32:[5,Bt.F32,4,"f32",1],tex1_f32x2:[5,Bt.F32VEC2,8,"f32",2],tex1_f32x3:[5,Bt.F32VEC3,12,"f32",3],tex1_f32x4:[5,Bt.F32VEC4,16,"f32",4],tex1_i32:[5,Bt.I32,4,"i32",1],tex1_i32x2:[5,Bt.I32VEC2,8,"i32",2],tex1_i32x3:[5,Bt.I32VEC3,12,"i32",3],tex1_i32x4:[5,Bt.I32VEC4,16,"i32",4],tex1_u32:[5,Bt.U32,4,"u32",1],tex1_u32x2:[5,Bt.U32VEC2,8,"u32",2],tex1_u32x3:[5,Bt.U32VEC3,12,"u32",3],tex1_u32x4:[5,Bt.U32VEC4,16,"u32",4],tex2_u8normx2:[6,Bt.U8VEC2_NORM,2,"u8norm",2],tex2_u8normx4:[6,Bt.U8VEC4_NORM,4,"u8norm",4],tex2_i8normx2:[6,Bt.I8VEC2_NORM,2,"i8norm",2],tex2_i8normx4:[6,Bt.I8VEC4_NORM,4,"i8norm",4],tex2_u16x2:[6,Bt.U16VEC2,4,"u16",2],tex2_u16x4:[6,Bt.U16VEC4,8,"u16",4],tex2_i16x2:[6,Bt.I16VEC2,4,"i16",2],tex2_i16x4:[6,Bt.I16VEC4,8,"i16",4],tex2_u16normx2:[6,Bt.U16VEC2_NORM,4,"u16norm",2],tex2_u16normx4:[6,Bt.U16VEC4_NORM,8,"u16norm",4],tex2_i16normx2:[6,Bt.I16VEC2_NORM,4,"i16norm",2],tex2_i16normx4:[6,Bt.I16VEC4_NORM,8,"i16norm",4],tex2_f16x2:[6,Bt.F16VEC2,4,"f16",2],tex2_f16x4:[6,Bt.F16VEC4,8,"f16",4],tex2_f32:[6,Bt.F32,4,"f32",1],tex2_f32x2:[6,Bt.F32VEC2,8,"f32",2],tex2_f32x3:[6,Bt.F32VEC3,12,"f32",3],tex2_f32x4:[6,Bt.F32VEC4,16,"f32",4],tex2_i32:[6,Bt.I32,4,"i32",1],tex2_i32x2:[6,Bt.I32VEC2,8,"i32",2],tex2_i32x3:[6,Bt.I32VEC3,12,"i32",3],tex2_i32x4:[6,Bt.I32VEC4,16,"i32",4],tex2_u32:[6,Bt.U32,4,"u32",1],tex2_u32x2:[6,Bt.U32VEC2,8,"u32",2],tex2_u32x3:[6,Bt.U32VEC3,12,"u32",3],tex2_u32x4:[6,Bt.U32VEC4,16,"u32",4],tex3_u8normx2:[7,Bt.U8VEC2_NORM,2,"u8norm",2],tex3_u8normx4:[7,Bt.U8VEC4_NORM,4,"u8norm",4],tex3_i8normx2:[7,Bt.I8VEC2_NORM,2,"i8norm",2],tex3_i8normx4:[7,Bt.I8VEC4_NORM,4,"i8norm",4],tex3_u16x2:[7,Bt.U16VEC2,4,"u16",2],tex3_u16x4:[7,Bt.U16VEC4,8,"u16",4],tex3_i16x2:[7,Bt.I16VEC2,4,"i16",2],tex3_i16x4:[7,Bt.I16VEC4,8,"i16",4],tex3_u16normx2:[7,Bt.U16VEC2_NORM,4,"u16norm",2],tex3_u16normx4:[7,Bt.U16VEC4_NORM,8,"u16norm",4],tex3_i16normx2:[7,Bt.I16VEC2_NORM,4,"i16norm",2],tex3_i16normx4:[7,Bt.I16VEC4_NORM,8,"i16norm",4],tex3_f16x2:[7,Bt.F16VEC2,4,"f16",2],tex3_f16x4:[7,Bt.F16VEC4,8,"f16",4],tex3_f32:[7,Bt.F32,4,"f32",1],tex3_f32x2:[7,Bt.F32VEC2,8,"f32",2],tex3_f32x3:[7,Bt.F32VEC3,12,"f32",3],tex3_f32x4:[7,Bt.F32VEC4,16,"f32",4],tex3_i32:[7,Bt.I32,4,"i32",1],tex3_i32x2:[7,Bt.I32VEC2,8,"i32",2],tex3_i32x3:[7,Bt.I32VEC3,12,"i32",3],tex3_i32x4:[7,Bt.I32VEC4,16,"i32",4],tex3_u32:[7,Bt.U32,4,"u32",1],tex3_u32x2:[7,Bt.U32VEC2,8,"u32",2],tex3_u32x3:[7,Bt.U32VEC3,12,"u32",3],tex3_u32x4:[7,Bt.U32VEC4,16,"u32",4],tex4_u8normx2:[8,Bt.U8VEC2_NORM,2,"u8norm",2],tex4_u8normx4:[8,Bt.U8VEC4_NORM,4,"u8norm",4],tex4_i8normx2:[8,Bt.I8VEC2_NORM,2,"i8norm",2],tex4_i8normx4:[8,Bt.I8VEC4_NORM,4,"i8norm",4],tex4_u16x2:[8,Bt.U16VEC2,4,"u16",2],tex4_u16x4:[8,Bt.U16VEC4,8,"u16",4],tex4_i16x2:[8,Bt.I16VEC2,4,"i16",2],tex4_i16x4:[8,Bt.I16VEC4,8,"i16",4],tex4_u16normx2:[8,Bt.U16VEC2_NORM,4,"u16norm",2],tex4_u16normx4:[8,Bt.U16VEC4_NORM,8,"u16norm",4],tex4_i16normx2:[8,Bt.I16VEC2_NORM,4,"i16norm",2],tex4_i16normx4:[8,Bt.I16VEC4_NORM,8,"i16norm",4],tex4_f16x2:[8,Bt.F16VEC2,4,"f16",2],tex4_f16x4:[8,Bt.F16VEC4,8,"f16",4],tex4_f32:[8,Bt.F32,4,"f32",1],tex4_f32x2:[8,Bt.F32VEC2,8,"f32",2],tex4_f32x3:[8,Bt.F32VEC3,12,"f32",3],tex4_f32x4:[8,Bt.F32VEC4,16,"f32",4],tex4_i32:[8,Bt.I32,4,"i32",1],tex4_i32x2:[8,Bt.I32VEC2,8,"i32",2],tex4_i32x3:[8,Bt.I32VEC3,12,"i32",3],tex4_i32x4:[8,Bt.I32VEC4,16,"i32",4],tex4_u32:[8,Bt.U32,4,"u32",1],tex4_u32x2:[8,Bt.U32VEC2,8,"u32",2],tex4_u32x3:[8,Bt.U32VEC3,12,"u32",3],tex4_u32x4:[8,Bt.U32VEC4,16,"u32",4],tex5_u8normx2:[9,Bt.U8VEC2_NORM,2,"u8norm",2],tex5_u8normx4:[9,Bt.U8VEC4_NORM,4,"u8norm",4],tex5_i8normx2:[9,Bt.I8VEC2_NORM,2,"i8norm",2],tex5_i8normx4:[9,Bt.I8VEC4_NORM,4,"i8norm",4],tex5_u16x2:[9,Bt.U16VEC2,4,"u16",2],tex5_u16x4:[9,Bt.U16VEC4,8,"u16",4],tex5_i16x2:[9,Bt.I16VEC2,4,"i16",2],tex5_i16x4:[9,Bt.I16VEC4,8,"i16",4],tex5_u16normx2:[9,Bt.U16VEC2_NORM,4,"u16norm",2],tex5_u16normx4:[9,Bt.U16VEC4_NORM,8,"u16norm",4],tex5_i16normx2:[9,Bt.I16VEC2_NORM,4,"i16norm",2],tex5_i16normx4:[9,Bt.I16VEC4_NORM,8,"i16norm",4],tex5_f16x2:[9,Bt.F16VEC2,4,"f16",2],tex5_f16x4:[9,Bt.F16VEC4,8,"f16",4],tex5_f32:[9,Bt.F32,4,"f32",1],tex5_f32x2:[9,Bt.F32VEC2,8,"f32",2],tex5_f32x3:[9,Bt.F32VEC3,12,"f32",3],tex5_f32x4:[9,Bt.F32VEC4,16,"f32",4],tex5_i32:[9,Bt.I32,4,"i32",1],tex5_i32x2:[9,Bt.I32VEC2,8,"i32",2],tex5_i32x3:[9,Bt.I32VEC3,12,"i32",3],tex5_i32x4:[9,Bt.I32VEC4,16,"i32",4],tex5_u32:[9,Bt.U32,4,"u32",1],tex5_u32x2:[9,Bt.U32VEC2,8,"u32",2],tex5_u32x3:[9,Bt.U32VEC3,12,"u32",3],tex5_u32x4:[9,Bt.U32VEC4,16,"u32",4],tex6_u8normx2:[As,Bt.U8VEC2_NORM,2,"u8norm",2],tex6_u8normx4:[As,Bt.U8VEC4_NORM,4,"u8norm",4],tex6_i8normx2:[As,Bt.I8VEC2_NORM,2,"i8norm",2],tex6_i8normx4:[As,Bt.I8VEC4_NORM,4,"i8norm",4],tex6_u16x2:[As,Bt.U16VEC2,4,"u16",2],tex6_u16x4:[As,Bt.U16VEC4,8,"u16",4],tex6_i16x2:[As,Bt.I16VEC2,4,"i16",2],tex6_i16x4:[As,Bt.I16VEC4,8,"i16",4],tex6_u16normx2:[As,Bt.U16VEC2_NORM,4,"u16norm",2],tex6_u16normx4:[As,Bt.U16VEC4_NORM,8,"u16norm",4],tex6_i16normx2:[As,Bt.I16VEC2_NORM,4,"i16norm",2],tex6_i16normx4:[As,Bt.I16VEC4_NORM,8,"i16norm",4],tex6_f16x2:[As,Bt.F16VEC2,4,"f16",2],tex6_f16x4:[As,Bt.F16VEC4,8,"f16",4],tex6_f32:[As,Bt.F32,4,"f32",1],tex6_f32x2:[As,Bt.F32VEC2,8,"f32",2],tex6_f32x3:[As,Bt.F32VEC3,12,"f32",3],tex6_f32x4:[As,Bt.F32VEC4,16,"f32",4],tex6_i32:[As,Bt.I32,4,"i32",1],tex6_i32x2:[As,Bt.I32VEC2,8,"i32",2],tex6_i32x3:[As,Bt.I32VEC3,12,"i32",3],tex6_i32x4:[As,Bt.I32VEC4,16,"i32",4],tex6_u32:[As,Bt.U32,4,"u32",1],tex6_u32x2:[As,Bt.U32VEC2,8,"u32",2],tex6_u32x3:[As,Bt.U32VEC3,12,"u32",3],tex6_u32x4:[As,Bt.U32VEC4,16,"u32",4],tex7_u8normx2:[Ms,Bt.U8VEC2_NORM,2,"u8norm",2],tex7_u8normx4:[Ms,Bt.U8VEC4_NORM,4,"u8norm",4],tex7_i8normx2:[Ms,Bt.I8VEC2_NORM,2,"i8norm",2],tex7_i8normx4:[Ms,Bt.I8VEC4_NORM,4,"i8norm",4],tex7_u16x2:[Ms,Bt.U16VEC2,4,"u16",2],tex7_u16x4:[Ms,Bt.U16VEC4,8,"u16",4],tex7_i16x2:[Ms,Bt.I16VEC2,4,"i16",2],tex7_i16x4:[Ms,Bt.I16VEC4,8,"i16",4],tex7_u16normx2:[Ms,Bt.U16VEC2_NORM,4,"u16norm",2],tex7_u16normx4:[Ms,Bt.U16VEC4_NORM,8,"u16norm",4],tex7_i16normx2:[Ms,Bt.I16VEC2_NORM,4,"i16norm",2],tex7_i16normx4:[Ms,Bt.I16VEC4_NORM,8,"i16norm",4],tex7_f16x2:[Ms,Bt.F16VEC2,4,"f16",2],tex7_f16x4:[Ms,Bt.F16VEC4,8,"f16",4],tex7_f32:[Ms,Bt.F32,4,"f32",1],tex7_f32x2:[Ms,Bt.F32VEC2,8,"f32",2],tex7_f32x3:[Ms,Bt.F32VEC3,12,"f32",3],tex7_f32x4:[Ms,Bt.F32VEC4,16,"f32",4],tex7_i32:[Ms,Bt.I32,4,"i32",1],tex7_i32x2:[Ms,Bt.I32VEC2,8,"i32",2],tex7_i32x3:[Ms,Bt.I32VEC3,12,"i32",3],tex7_i32x4:[Ms,Bt.I32VEC4,16,"i32",4],tex7_u32:[Ms,Bt.U32,4,"u32",1],tex7_u32x2:[Ms,Bt.U32VEC2,8,"u32",2],tex7_u32x3:[Ms,Bt.U32VEC3,12,"u32",3],tex7_u32x4:[Ms,Bt.U32VEC4,16,"u32",4],blendweights_f16x1:[Rs,Bt.F16,2,"f16",1],blendweights_f32x1:[Rs,Bt.F32,4,"f32",1],blendweights_f16x2:[Rs,Bt.F16VEC2,4,"f16",2],blendweights_f32x2:[Rs,Bt.F32VEC2,8,"f32",2],blendweights_f16x3:[Rs,Bt.F16VEC3,6,"f16",3],blendweights_f32x3:[Rs,Bt.F32VEC3,12,"f32",3],blendweights_f16x4:[Rs,Bt.F16VEC4,8,"f16",4],blendweights_f32x4:[Rs,Bt.F32VEC4,16,"f32",4],blendindices_u16x1:[Fs,Bt.U16,2,"u16",1],blendindices_f16x1:[Fs,Bt.F16,2,"f16",1],blendindices_f32x1:[Fs,Bt.F32,4,"f32",1],blendindices_u32x1:[Fs,Bt.U32,4,"u32",1],blendindices_u16x2:[Fs,Bt.U16VEC2,4,"u16",2],blendindices_f16x2:[Fs,Bt.F16VEC2,4,"f16",2],blendindices_f32x2:[Fs,Bt.F32VEC2,8,"f32",2],blendindices_u32x2:[Fs,Bt.U32VEC2,8,"u32",2],blendindices_u16x3:[Fs,Bt.U16VEC3,6,"u16",3],blendindices_f16x3:[Fs,Bt.F16VEC3,6,"f16",3],blendindices_f32x3:[Fs,Bt.F32VEC3,12,"f32",3],blendindices_u32x3:[Fs,Bt.U32VEC3,12,"u32",3],blendindices_u16x4:[Fs,Bt.U16VEC4,8,"u16",4],blendindices_f16x4:[Fs,Bt.F16VEC4,8,"f16",4],blendindices_f32x4:[Fs,Bt.F32VEC4,16,"f32",4],blendindices_u32x4:[Fs,Bt.U32VEC4,16,"u32",4]},Ds={position:0,normal:1,diffuse:2,tangent:3,blendIndices:Fs,blendWeights:Rs,texCoord0:4,texCoord1:5,texCoord2:6,texCoord3:7,texCoord4:8,texCoord5:9,texCoord6:As,texCoord7:Ms},$s={0:"position",1:"normal",2:"diffuse",3:"tangent",[Fs]:"blendIndices",[Rs]:"blendWeights",4:"texCoord0",5:"texCoord1",6:"texCoord2",7:"texCoord3",8:"texCoord4",9:"texCoord5",[As]:"texCoord6",[Ms]:"texCoord7"};var Ls;function Ps(t){return Ds[t]}function Ns(t){return $s[t]}function Bs(t){return Is[t][2]}function Os(t){const e=t.structMembers[0].type.elementType;if(e.isStructType()){let t=0;for(const i of e.structMembers)t+=i.type.getSize();return t}return e.getSize()}function Us(t,e){const i=Ns(e);return i?function(t,e){const i=t.structMembers[0],s=i.type.elementType;if(s.isStructType()){for(const t of s.structMembers)if(t.name===e)return t.type;return null}return i.name===e?s:null}(t,i):null}function ks(t,...e){if(0===e.length)return null;if(1===e.length){const i=Is[e[0]];return new ee(null,"packed",[{name:Ns(i[0]),type:new ie(te.getCachedTypeInfo(i[1]),t)}])}{const i=new ee(null,"packed",e.map((t=>({name:Ns(Is[t][0]),type:te.getCachedTypeInfo(Is[t][1])}))));return new ee(null,"packed",[{name:"value",type:new ie(i,t)}])}}!function(t){t[t.TF_LINEAR_COLOR_SPACE=2]="TF_LINEAR_COLOR_SPACE",t[t.TF_NO_MIPMAP=4]="TF_NO_MIPMAP",t[t.TF_WRITABLE=8]="TF_WRITABLE",t[t.TF_NO_GC=16]="TF_NO_GC",t[t.BF_VERTEX=32]="BF_VERTEX",t[t.BF_INDEX=64]="BF_INDEX",t[t.BF_READ=128]="BF_READ",t[t.BF_WRITE=256]="BF_WRITE",t[t.BF_UNIFORM=512]="BF_UNIFORM",t[t.BF_STORAGE=1024]="BF_STORAGE",t[t.DYNAMIC=2048]="DYNAMIC",t[t.MANAGED=4096]="MANAGED"}(Ls||(Ls={}));const zs=function(){const t=[];for(let e=0;e<16;e++)t.push(Vs(e));return t}();function Vs(t){switch(t){case 0:return"a_position";case 1:return"a_normal";case 2:return"a_diffuse";case 3:return"a_tangent";case 4:return"a_texcoord0";case 5:return"a_texcoord1";case 6:return"a_texcoord2";case 7:return"a_texcoord3";case 8:return"a_texcoord4";case 9:return"a_texcoord5";case As:return"a_texcoord6";case Ms:return"a_texcoord7";case Fs:return"a_indices";case Rs:return"a_weight";default:return null}}function Gs(t){return t.isTexture2D()?"texture_2d":t.isTexture2DArray()?"texture_2darray":t.isTexture3D()?"texture_3d":t.isTextureCube()?"texture_cube":t.isTextureVideo()?"texture_video":t.isBuffer()?"buffer":t.isFramebuffer()?"framebuffer":t.isProgram()?"program":t.isSampler()?"sampler":t.isVertexLayout()?"vbo":"unknown"}class Xs{_vertexBuffers;_indexBuffer;_drawOffset;constructor(){this._vertexBuffers=[];for(let t=0;t<16;t++)this._vertexBuffers.push(null);this._indexBuffer=null,this._drawOffset=0}clone(){const t=new Xs;return t._vertexBuffers=this._vertexBuffers.slice(),t._indexBuffer=this._indexBuffer,t._drawOffset=this._drawOffset,t}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}getDrawOffset(){return this._drawOffset}setDrawOffset(t){t!==this._drawOffset&&(this._drawOffset=t)}getVertexBuffer(t){return this._vertexBuffers[Ps(t)]?.buffer??null}getVertexBufferInfo(t){return this._vertexBuffers[Ps(t)]??null}getIndexBuffer(){return this._indexBuffer||null}setVertexBuffer(t,e){if(!(t&&t.usage&Ls.BF_VERTEX))throw new Error("setVertexBuffer() failed: buffer is null or buffer has not Vertex usage flag");e=e||"vertex";const i=t.structure.structMembers[0].type.elementType;if(i.isStructType()){let s=0;for(const r of i.structMembers){const i=Ps(r.name);this.internalSetVertexBuffer(i,t,s,e),s+=r.size}}else{const i=Ps(t.structure.structMembers[0].name);this.internalSetVertexBuffer(i,t,0,e)}return t}removeVertexBuffer(t){let e=!1;for(let i=0;i<this._vertexBuffers.length;i++){const s=this._vertexBuffers[i];s?.buffer===t&&(this._vertexBuffers[i]=null,e=!0)}return e}setIndexBuffer(t){return t!==this._indexBuffer&&(this._indexBuffer=t||null),t}internalSetVertexBuffer(t,e,i,s){if(t<0||t>=16)throw new Error(`setVertexBuffer() failed: location out of bounds: ${t}`);i=Number(i)||0,s=s||"vertex";const r=this._vertexBuffers[t];return r&&r.buffer===e&&r.offset===i&&r.stepMode===s?null:(this._vertexBuffers[t]={buffer:e,offset:i,type:Us(e.structure,t),stride:Os(e.structure),drawOffset:0,stepMode:s},e)}}class Ws{_cpuTimer;_cpuStart;_cpuTime;_ended;constructor(){this._cpuTimer=window.performance||window.Date,this._cpuTime=null,this._ended=!1}now(){return this._cpuTimer.now()}begin(){this._cpuStart=this.now(),this._cpuTime=null,this._ended=!1}end(){this._cpuTime=this.now()-this._cpuStart,this._ended=!0}ended(){return this._ended}elapsed(){return this._cpuTime}}function Hs(t,e){return"number"==typeof e||"boolean"==typeof e||Array.isArray(e)?`${e}`:e.$ast?.toString(t)}function js(t,e){return e?.toTypeName(t)}class qs extends Error{}class Ys extends qs{value;constructor(t){super(),this.value=t}getMessage(t){return`value out of range: ${this.value}`}}class Zs extends qs{value;valueType;expectedType;constructor(t,e,i){super(),this.value=t,this.valueType=e,this.expectedType=i}getMessage(t){return`cannot convert '${"string"==typeof this.value?this.value:Hs(t,this.value)}' of type '${"string"==typeof this.valueType?this.valueType:js(t,this.valueType)}' to type ${"string"==typeof this.expectedType?this.expectedType:js(t,this.expectedType)}`}}class Ks extends qs{func;constructor(t){super(),this.func=t}getMessage(t){return`wrong argument count for function '${this.func}'`}}class Qs extends qs{func;param;constructor(t,e){super(),this.func=t,this.param=e||null}getMessage(t){return`parameter type error for function '${this.func}': ${this.param}`}}class Js extends qs{func;param;reason;constructor(t,e,i){super(),this.func=t,this.param=e||null,this.reason=i||null}getMessage(t){return`invalid parameter value for function '${this.func}'${this.param?": "+this.param:""}${this.reason?": "+this.reason:""}}`}}class tr extends qs{func;constructor(t){super(),this.func=t}getMessage(t){return`No matched overloading found for function '${this.func}'`}}class er extends qs{value;constructor(t){super(),this.value=t}getMessage(t){return`'${Hs(t,this.value)}' is not a reference type`}}class ir extends qs{value;constructor(t){super(),this.value=t}getMessage(t){return`'${Hs(t,this.value)}' is not a pointer type`}}class sr extends qs{feature;constructor(t){super(),this.feature=t}getMessage(t){return`feature not support for ${t} device: ${this.feature}`}}class rr extends qs{funcName;constructor(t){super(),this.funcName=t}getMessage(t){return`function call must be made inside a function scope: ${this.funcName}()`}}class nr extends qs{ast;text;constructor(t,e){super(),this.ast=t,this.text=e}getMessage(t){return`${this.text}: ${this.ast.toString(t)}`}}class ar extends qs{constructor(t){super(t)}getMessage(t){return`Internal error: ${this.message}`}}const or="zVSInput",hr="zVSOutput",lr="zFSInput",ur="zFSOutput",cr="zCSInput";var dr,pr;function mr(t){switch(t){case Et.Vertex:return"zVertexInput";case Et.Fragment:return"zVertexOutput";case Et.Compute:return"zComputeInput";default:return null}}function fr(t){switch(t){case Et.Vertex:return"zVSInputCpy";case Et.Fragment:return"zFSInputCpy";case Et.Compute:return"zCSInputCpy";default:return null}}function _r(t){switch(t){case Et.Vertex:return"zVSOutputCpy";case Et.Fragment:return"zFSOutputCpy";case Et.Compute:return"zCSOutputCpy";default:return null}}function gr(t){switch(t){case Et.Vertex:return or;case Et.Fragment:return lr;case Et.Compute:return cr;default:return null}}function xr(t,e){return`ch_auto_sampler_${t}${e?"_comparison":""}`}!function(t){t[t.DECLARE_TYPE_NONE=0]="DECLARE_TYPE_NONE",t[t.DECLARE_TYPE_IN=1]="DECLARE_TYPE_IN",t[t.DECLARE_TYPE_OUT=2]="DECLARE_TYPE_OUT",t[t.DECLARE_TYPE_WORKGROUP=3]="DECLARE_TYPE_WORKGROUP",t[t.DECLARE_TYPE_UNIFORM=4]="DECLARE_TYPE_UNIFORM",t[t.DECLARE_TYPE_STORAGE=5]="DECLARE_TYPE_STORAGE"}(dr||(dr={})),function(t){t[t.NONE=0]="NONE",t[t.HIGH=1]="HIGH",t[t.MEDIUM=2]="MEDIUM",t[t.LOW=3]="LOW"}(pr||(pr={}));const br={webgl:{position:{name:"gl_Position",type:new te(Bt.F32VEC4),stage:"vertex"},pointSize:{name:"gl_PointSize",type:new te(Bt.F32),stage:"vertex"},fragCoord:{name:"gl_FragCoord",type:new te(Bt.F32VEC4),stage:"fragment"},frontFacing:{name:"gl_FrontFacing",type:new te(Bt.BOOL),stage:"fragment"},fragDepth:{name:"gl_FragDepthEXT",type:new te(Bt.F32),inOrOut:"out",extension:"GL_EXT_frag_depth",stage:"fragment"}},webgl2:{vertexIndex:{name:"gl_VertexID",semantic:"vertex_index",type:new te(Bt.U32),inOrOut:"in",stage:"vertex"},instanceIndex:{name:"gl_InstanceID",semantic:"instance_index",type:new te(Bt.U32),inOrOut:"in",stage:"vertex"},position:{name:"gl_Position",type:new te(Bt.F32VEC4),stage:"vertex"},pointSize:{name:"gl_PointSize",type:new te(Bt.F32),stage:"vertex"},fragCoord:{name:"gl_FragCoord",type:new te(Bt.F32VEC4),stage:"fragment"},frontFacing:{name:"gl_FrontFacing",type:new te(Bt.BOOL),stage:"fragment"},fragDepth:{name:"gl_FragDepth",type:new te(Bt.F32),stage:"fragment"}},webgpu:{vertexIndex:{name:"zVertexId",semantic:"vertex_index",type:new te(Bt.U32),inOrOut:"in",stage:"vertex"},instanceIndex:{name:"zInstanceId",semantic:"instance_index",type:new te(Bt.U32),inOrOut:"in",stage:"vertex"},position:{name:"zPosition",semantic:"position",type:new te(Bt.F32VEC4),inOrOut:"out",stage:"vertex"},fragCoord:{name:"zFragCoord",semantic:"position",type:new te(Bt.F32VEC4),inOrOut:"in",stage:"fragment"},frontFacing:{name:"zFrontFacing",semantic:"front_facing",type:new te(Bt.BOOL),inOrOut:"in",stage:"fragment"},fragDepth:{name:"zFragDepth",semantic:"frag_depth",type:new te(Bt.F32),inOrOut:"out",stage:"fragment"},localInvocationId:{name:"zLocalInvocationId",semantic:"local_invocation_id",type:new te(Bt.U32VEC3),inOrOut:"in",stage:"compute"},globalInvocationId:{name:"zGlobalInvocationId",semantic:"global_invocation_id",type:new te(Bt.U32VEC3),inOrOut:"in",stage:"compute"},workGroupId:{name:"zWorkGroupId",semantic:"workgroup_id",type:new te(Bt.U32VEC3),inOrOut:"in",stage:"compute"},numWorkGroups:{name:"zNumWorkGroups",semantic:"num_workgroups",type:new te(Bt.U32VEC3),inOrOut:"in",stage:"compute"},sampleMaskIn:{name:"zSampleMaskIn",semantic:"sample_mask_in",type:new te(Bt.U32),inOrOut:"in",stage:"fragment"},sampleMaskOut:{name:"zSampleMaskOut",semantic:"sample_mask_out",type:new te(Bt.U32),inOrOut:"out",stage:"fragment"},sampleIndex:{name:"zSampleIndex",semantic:"sample_index",type:new te(Bt.U32),inOrOut:"in",stage:"fragment"}}};function wr(t){return t%1==0?t.toFixed(1):String(t)}function Tr(t){return String(0|t)}function vr(t){return String(t>>>0)}function yr(t){if("("===(t=t.trim())[0]&&")"===t[t.length-1]){let e=0;for(let i=1;i<t.length-1;i++)if("("===t[i])e++;else if(")"===t[i]&&(e--,e<0))break;if(e>0)throw new ar(`Invalid expression: ${t}`);if(0===e)return t.substring(1,t.length-1)}return t}class Er{isReference(){return!1}isPointer(){return!!this.getType()?.isPointerType()}getType(){return null}toWebGL(t,e){return""}toWebGL2(t,e){return""}toWGSL(t,e){return""}toString(t){return this.constructor.name}}class Sr extends Er{}class Cr extends Sr{paramAST;writable;constructor(t){super(),this.paramAST=t,this.writable=!1}getType(){return this.paramAST.getType()}markWritable(){this.paramAST instanceof Fr&&console.warn(`Write to non-output parameter ${this.paramAST.value.$str}`),this.writable=!0}isWritable(){return this.writable}getAddressSpace(){return this.paramAST.getAddressSpace()}isConstExp(){return this.paramAST.isConstExp()}isReference(){return this.paramAST.isReference()}toWebGL(t,e){return this.paramAST.toWebGL(t,e)}toWebGL2(t,e){return this.paramAST.toWebGL2(t,e)}toWGSL(t,e){return this.paramAST.toWGSL(t,e)}}class Ar extends Er{statements;constructor(){super(),this.statements=[]}toWebGL(t,e){return this.statements.filter((t=>!(t instanceof Qr)||t.isStatement)).map((i=>i.toWebGL(t,e))).join("")}toWebGL2(t,e){return this.statements.filter((t=>!(t instanceof Qr)||t.isStatement)).map((i=>i.toWebGL2(t,e))).join("")}toWGSL(t,e){return this.statements.filter((t=>!(t instanceof Qr)||t.isStatement)).map((i=>i instanceof Qr&&!i.getType().isVoidType()?`${t}_ = ${i.toWGSL("",e)}`:i.toWGSL(t,e))).join("")}}class Mr extends Ar{toWebGL(t,e){return`${t}{\n${super.toWebGL(t+" ",e)}${t}}\n`}toWebGL2(t,e){return`${t}{\n${super.toWebGL2(t+" ",e)}${t}}\n`}toWGSL(t,e){return`${t}{\n${super.toWGSL(t+" ",e)}${t}}\n`}}class Rr extends Ar{uniforms;constructor(){super(),this.uniforms=[]}findFunctions(t){const e=[];for(const i of this.statements)i instanceof tn&&i.name===t&&e.push(i);return e}toWebGL(t,e){const i=`${t}precision highp float;\n${t}precision highp int;\n`,s=`${t}#version 100\n`,r=e.types.map((i=>i.toWebGL(t,e))).join("")+this.uniforms.map((i=>i.toWebGL(t,e))).join("")+e.inputs.map((i=>i.toWebGL(t,e))).join("")+e.outputs.map((i=>i.toWebGL(t,e))).join("")+super.toWebGL(t,e);for(const t of e.builtins){const i=br.webgl[t];i.extension&&e.extensions.add(i.extension)}return s+[...e.extensions].map((e=>`${t}#extension ${e}: enable\n`)).join("")+i+e.defines.join("")+r}toWebGL2(t,e){const i=`${t}precision highp float;\n${t}precision highp int;\n`,s=`${t}#version 300 es\n`,r=e.types.map((i=>i.toWebGL2(t,e))).join("")+this.uniforms.map((i=>i.toWebGL2(t,e))).join("")+e.inputs.map((i=>i.toWebGL2(t,e))).join("")+e.outputs.map((i=>i.toWebGL2(t,e))).join("")+super.toWebGL2(t,e);for(const t of e.builtins){const i=br.webgl2[t];i.extension&&e.extensions.add(i.extension)}return s+[...e.extensions].map((e=>`${t}#extension ${e}: enable\n`)).join("")+i+e.defines.join("")+r}toWGSL(t,e){const i=e.type===Et.Vertex?[or,hr]:e.type===Et.Fragment?[lr,ur]:[cr],s=[];for(const t of e.builtins)s.push(br.webgpu[t].name);const r=Object.keys(br.webgpu).map((t=>br.webgpu[t].name));for(const t of e.types)if(t instanceof an&&i.indexOf(t.type.structName)>=0)for(let e=t.type.structMembers.length-1;e>=0;e--){const i=t.type.structMembers[e];r.indexOf(i.name)>=0&&s.indexOf(i.name)<0&&(t.type.structMembers.splice(e,1),t.prefix.splice(e,1))}return e.types=e.types.filter((t=>!(t instanceof an)||t.type.structMembers.length>0)),e.types.map((i=>i.toWGSL(t,e))).join("")+this.uniforms.map((i=>i.toWGSL(t,e))).join("")+super.toWGSL(t,e)}}class Fr extends Sr{value;ref;writable;constExp;constructor(t){super(),this.value=t,this.ref=null,this.writable=!1,this.constExp=!1}get name(){return this.value.$str}isReference(){return!0}isConstExp(){return this.constExp}markWritable(){this.writable=!0,this.constExp=!1,this.ref&&this.ref.markWritable()}isWritable(){const t=this.getType();return this.writable||t.isAtomicI32()||t.isAtomicU32()||t.isStructType()&&t.haveAtomicMembers()}getAddressSpace(){switch(this.value.$declareType){case dr.DECLARE_TYPE_UNIFORM:return Kt.UNIFORM;case dr.DECLARE_TYPE_STORAGE:return Kt.STORAGE;case dr.DECLARE_TYPE_IN:case dr.DECLARE_TYPE_OUT:return null;default:return this.value.$global?Kt.PRIVATE:Kt.FUNCTION}}getType(){return this.value.$typeinfo}toWebGL(t,e){return this.name}toWebGL2(t,e){return this.name}toWGSL(t,e){if(this.value.$declareType===dr.DECLARE_TYPE_IN){const i=fr(e.type);return e.global[i][this.name].$ast.toWGSL(t,e)}if(this.value.$declareType===dr.DECLARE_TYPE_OUT){const i=_r(e.type);return e.global[i][this.name].$ast.toWGSL(t,e)}return this.name}toString(t){return this.name}}class Ir extends Er{}class Dr extends Ir{value;constructor(t){if(super(),t.getAddressSpace()===Kt.UNIFORM)throw new nr(t,"cannot assign to uniform variable");this.value=t,this.value instanceof Qr&&(this.value.isStatement=!1)}getType(){return this.value.getType()}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isReference(){return this.value.isReference()}toWebGL(t,e){return this.value.toWebGL(t,e)}toWebGL2(t,e){return this.value.toWebGL2(t,e)}toWGSL(t,e){return this.value.toWGSL(t,e)}toString(t){return this.value.toString(t)}}class $r extends Ir{scope;field;type;constructor(t,e,i){super(),this.scope=t,this.field=e,this.type=i}getType(){return this.type}markWritable(){this.scope.markWritable()}isWritable(){return this.scope.isWritable()}isReference(){return this.scope.isReference()}toWebGL(t,e){return`${this.scope.toWebGL(t,e)}.${this.field}`}toWebGL2(t,e){return`${this.scope.toWebGL2(t,e)}.${this.field}`}toWGSL(t,e){return`${(this.scope.isPointer()?new zr(this.scope):this.scope).toWGSL(t,e)}.${this.field}`}toString(t){return`${(this.scope.isPointer()?new zr(this.scope):this.scope).toString(t)}.${this.field}`}}class Lr extends Ir{value;index;type;constructor(t,e,i){super(),this.value=t,this.index=e,this.type=i,this.index instanceof Qr&&(this.index.isStatement=!1)}getType(){return this.type}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isReference(){return this.value.isReference()}toWebGL(t,e){return`${this.value.toWebGL(t,e)}[${this.index.toWebGL(t,e)}]`}toWebGL2(t,e){return`${this.value.toWebGL2(t,e)}[${this.index.toWebGL2(t,e)}]`}toWGSL(t,e){return`${(this.value.isPointer()?new zr(this.value):this.value).toWGSL(t,e)}[${this.index.toWGSL(t,e)}]`}toString(t){return`${(this.value.isPointer()?new zr(this.value):this.value).toString(t)}[${this.index.toString(t)}]`}}class Pr extends Ir{value;constructor(t){super(),this.value=t,this.value.constExp=!0}getType(){return this.value.getType()}markWritable(){}isWritable(){return!1}isReference(){return!0}toWebGL(t,e){let i="";switch(this.value.value.$declareType){case dr.DECLARE_TYPE_IN:case dr.DECLARE_TYPE_OUT:case dr.DECLARE_TYPE_UNIFORM:case dr.DECLARE_TYPE_STORAGE:throw new Error("invalid declare type");default:i=!this.value.constExp||this.value.isWritable()||this.getType().isStructType()?"":"const "}return`${i}${this.getType().toTypeName("webgl",this.value.name)}`}toWebGL2(t,e){let i="";switch(this.value.value.$declareType){case dr.DECLARE_TYPE_IN:case dr.DECLARE_TYPE_OUT:case dr.DECLARE_TYPE_UNIFORM:case dr.DECLARE_TYPE_STORAGE:throw new Error("invalid declare type");default:i=!this.value.constExp||this.value.isWritable()||this.getType().isStructType()?"":"const "}return`${i}${this.getType().toTypeName("webgl2",this.value.name)}`}toWGSL(t,e){let i;switch(this.value.value.$declareType){case dr.DECLARE_TYPE_IN:case dr.DECLARE_TYPE_OUT:case dr.DECLARE_TYPE_UNIFORM:case dr.DECLARE_TYPE_STORAGE:throw new Error("invalid declare type");default:{const t=this.value.getAddressSpace(),e=this.getType().isPointerType()||!this.value.isWritable()&&(t===Kt.PRIVATE||t===Kt.FUNCTION),s=t===Kt.PRIVATE,r=t===Kt.STORAGE&&this.value.isWritable()?", read_write":"",n=t!==Kt.FUNCTION?`<${t}${r}>`:"";i=e?s?"const ":"let ":`var${n} `;break}}{const t=this.getType();t.isPointerType()&&(this.value.isWritable()||this.value.ref.isWritable())&&(t.writable=!0);return`${i}${t.toTypeName("webgpu",this.value.name)}`}}toString(t){return this.value.toString(t)}}class Nr extends Sr{type;args;constExp;constructor(t,e){super(),this.type=t,this.args=e,this.constExp=!0;for(const t of e){if(null==t)throw new Error("invalid constructor argument");t instanceof Qr&&(t.isStatement=!1),this.constExp&&=!(t instanceof Sr)||t.isConstExp()}}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.constExp}getAddressSpace(){return null}toWebGL(t,e){console.assert(!this.type.isArrayType(),"array constructor not supported in webgl1 device"),console.assert(this.type.isConstructible(),`type '${this.type.toTypeName("webgl")}' is not constructible`);const i=this.type.getConstructorOverloads("webgl");for(const s of i){const i=on(this.args,s);if(i){const s=i.args.map((i=>yr(i.toWebGL(t,e)))).join(",");return`${i.name}(${s})`}}throw new Error(`no matching overload function found for type ${this.type.toTypeName("webgl")}`)}toWebGL2(t,e){console.assert(this.type.isConstructible(),`type '${this.type.toTypeName("webgl2")}' is not constructible`,!0);const i=this.type.getConstructorOverloads("webgl2");for(const s of i){const i=on(this.args,s);if(i){const s=i.args.map((i=>yr(i.toWebGL2(t,e)))).join(",");return`${i.name}(${s})`}}throw new Error(`no matching overload function found for type ${this.type.toTypeName("webgl2")}`)}toWGSL(t,e){const i=this.type.getConstructorOverloads("webgpu");for(const s of i){const i=on(this.args,s);if(i){const s=i.args.map((i=>yr(i.toWGSL(t,e)))).join(",");return`${i.name}(${s})`}}throw new Error(`no matching overload function found for type ${this.type.toTypeName("webgpu")}`)}toString(t){return"constructor"}}class Br extends Sr{value;type;constructor(t,e){if(super(),this.value=t,this.type=e,"number"==typeof t){if(e.primitiveType===Bt.BOOL)throw new Zs(t,typeof t,e);if(e.primitiveType===Bt.I32&&(!Number.isInteger(t)||t<-2147483648||t>4294967295))throw new Zs(t,typeof t,e);if(t<0&&e.primitiveType===Bt.U32&&(!Number.isInteger(t)||t<0||t>4294967295))throw new Zs(t,typeof t,e)}else if(e.primitiveType!==Bt.BOOL)throw new Zs(t,typeof t,e)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return!0}getAddressSpace(){return null}toWebGL(t,e){switch(this.type.primitiveType){case Bt.F32:return wr(this.value);case Bt.I32:return Tr(this.value);case Bt.U32:return vr(this.value);case Bt.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toWebGL2(t,e){switch(this.type.primitiveType){case Bt.F32:return wr(this.value);case Bt.I32:return Tr(this.value);case Bt.U32:return`${vr(this.value)}u`;case Bt.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toWGSL(t,e){switch(this.type.primitiveType){case Bt.F32:return wr(this.value);case Bt.I32:return Tr(this.value);case Bt.U32:return`${vr(this.value)}u`;case Bt.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toString(t){return`${this.value}`}}class Or extends Sr{source;field;type;constructor(t,e,i){super(),this.source=t,this.field=e,this.type=i,this.source instanceof Qr&&(this.source.isStatement=!1)}getType(){return this.type}isReference(){return this.source.isReference()}isConstExp(){return this.source.isConstExp()}markWritable(){this.source.markWritable()}isWritable(){return this.source.isWritable()}getAddressSpace(){return this.source.getAddressSpace()}toWebGL(t,e){return`${this.source.toWebGL(t,e)}.${this.field}`}toWebGL2(t,e){return`${this.source.toWebGL2(t,e)}.${this.field}`}toWGSL(t,e){return`${(this.source.isPointer()?new zr(this.source):this.source).toWGSL(t,e)}.${this.field}`}toString(t){return`${(this.source.isPointer()?new zr(this.source):this.source).toString(t)}.${this.field}`}}class Ur extends Sr{sourceValue;castType;constructor(t,e){super(),this.sourceValue=t,this.castType=e,this.sourceValue instanceof Qr&&(this.sourceValue.isStatement=!1)}getType(){return this.castType}markWritable(){}isWritable(){return!1}isConstExp(){return this.sourceValue.isConstExp()}getAddressSpace(){return null}toWebGL(t,e){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWebGL(t,e):`${this.castType.toTypeName("webgl")}(${yr(this.sourceValue.toWebGL(t,e))})`}toWebGL2(t,e){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWebGL2(t,e):`${this.castType.toTypeName("webgl2")}(${yr(this.sourceValue.toWebGL2(t,e))})`}toWGSL(t,e){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWGSL(t,e):`${this.castType.toTypeName("webgpu")}(${yr(this.sourceValue.toWGSL(t,e))})`}toString(t){return`${this.castType.toTypeName(t)}(${yr(this.sourceValue.toString(t))})`}}class kr extends Sr{value;type;constructor(t){super(),console.assert(t.isReference(),"no pointer type for non-reference values",!0),this.value=t,this.type=new se(t.getType(),t.getAddressSpace())}getType(){return this.type}isConstExp(){return!1}markWritable(){if(this.value.getAddressSpace()===Kt.UNIFORM)throw new nr(this.value,"uniforms are not writable");this.value.markWritable()}isWritable(){return this.value.isWritable()}getAddressSpace(){return this.value.getAddressSpace()}toWebGL(t,e){throw new Error("GLSL does not support pointer type")}toWebGL2(t,e){throw new Error("GLSL does not support pointer type")}toWGSL(t,e){const i=this.value instanceof Cr?this.value.paramAST:this.value;return i instanceof zr?i.value.toWGSL(t,e):`(&${i.toWGSL(t,e)})`}toString(t){const e=this.value instanceof Cr?this.value.paramAST:this.value;return e instanceof zr?e.value.toString(t):`(&${e.toString(t)})`}}class zr extends Sr{value;constructor(t){super(),this.value=t,this.value instanceof Qr&&(this.value.isStatement=!1)}getType(){const t=this.value.getType();return t.isPointerType()?t.pointerType:t}isReference(){return!0}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isConstExp(){return!1}getAddressSpace(){return this.value instanceof Sr?this.value.getAddressSpace():null}toWebGL(t,e){return this.value.toWebGL(t,e)}toWebGL2(t,e){return this.value.toWebGL2(t,e)}toWGSL(t,e){return this.value.getType().isPointerType()?`(*${this.value.toWGSL(t,e)})`:this.value.toWGSL(t,e)}toString(t){return`*${this.value.toString(t)}`}}class Vr extends Sr{value;op;type;constructor(t,e,i){super(),this.value=t,this.op=e,this.type=i,this.value instanceof Qr&&(this.value.isStatement=!1)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.value.isConstExp()}getAddressSpace(){return null}toWebGL(t,e){return`${this.op}${this.value.toWebGL(t,e)}`}toWebGL2(t,e){return`${this.op}${this.value.toWebGL2(t,e)}`}toWGSL(t,e){const i=this.value.isPointer()?new zr(this.value):this.value;return`${this.op}${i.toWGSL(t,e)}`}toString(t){const e=this.value.isPointer()?new zr(this.value):this.value;return`${this.op}${e.toString(t)}`}}class Gr extends Sr{left;right;type;op;constructor(t,e,i,s){super(),this.left=t,this.right=e,this.op=i,this.type=s,this.left instanceof Qr&&(this.left.isStatement=!1),this.right instanceof Qr&&(this.right.isStatement=!1)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.left.isConstExp()&&this.right.isConstExp()}getAddressSpace(){return null}toWebGL(t,e){return`(${this.left.toWebGL(t,e)} ${this.op} ${this.right.toWebGL(t,e)})`}toWebGL2(t,e){return`(${this.left.toWebGL2(t,e)} ${this.op} ${this.right.toWebGL2(t,e)})`}toWGSL(t,e){const i=this.left.isPointer()?new zr(this.left):this.left,s=this.right.isPointer()?new zr(this.right):this.right;return`(${i.toWGSL(t,e)} ${this.op} ${s.toWGSL(t,e)})`}toString(t){const e=this.left.isPointer()?new zr(this.left):this.left,i=this.right.isPointer()?new zr(this.right):this.right;return`(${e.toString(t)} ${this.op} ${i.toString(t)})`}}class Xr extends Sr{source;index;type;constructor(t,e,i){super(),this.source=t,this.index=e,this.type=i,this.source instanceof Qr&&(this.source.isStatement=!1),this.index instanceof Qr&&(this.index.isStatement=!1)}getType(){return this.type}isReference(){return this.source.isReference()}markWritable(){this.source.markWritable()}isWritable(){return this.source.isWritable()}isConstExp(){return this.source.isConstExp()&&this.index.isConstExp()}getAddressSpace(){return this.source.getAddressSpace()}toWebGL(t,e){return`${this.source.toWebGL(t,e)}[${yr(this.index.toWebGL(t,e))}]`}toWebGL2(t,e){return`${this.source.toWebGL2(t,e)}[${yr(this.index.toWebGL2(t,e))}]`}toWGSL(t,e){return`${this.source.toWGSL(t,e)}[${yr(this.index.toWGSL(t,e))}]`}toString(t){return`${this.source.toString(t)}[${yr(this.index.toString(t))}]`}}class Wr extends Er{value;constructor(t){if(super(),t.getType().isVoidType())throw new Error("can not touch void type");t instanceof Qr&&(t.isStatement=!1),this.value=t}toWebGL(t,e){return`${t}${this.value.toWebGL("",e)};\n`}toWebGL2(t,e){return`${t}${this.value.toWebGL2("",e)};\n`}toWGSL(t,e){return this.value.getType().isVoidType()?`${t}${this.value.toWGSL("",e)};\n`:`${t}_ = ${this.value.toWGSL("",e)};\n`}}class Hr extends Sr{condition;first;second;type;constructor(t,e,i){super(),this.condition=t instanceof Sr?t:new Br(t,Te);let s=null,r=null;if(e instanceof Sr)s=e.getType(),this.first=e,e instanceof Qr&&(e.isStatement=!1);else if("number"==typeof e)Number.isInteger(e)||(this.first=new Br(e,oe),s=oe);else{if("boolean"!=typeof e)throw new Error("select: invalid first value");this.first=new Br(e,Te),s=Te}if(i instanceof Sr)r=i.getType(),this.second=i,i instanceof Qr&&(i.isStatement=!1);else if("number"==typeof i)Number.isInteger(i)||(this.second=new Br(i,oe),r=oe);else{if("boolean"!=typeof i)throw new Error("select: invalid second value");this.second=new Br(i,Te),r=Te}if(!s&&!r)throw new Error("select: cannot determine the value types");if(s&&r){if(!s.isCompatibleType(r))throw new Error("select: first value and second value must be the same type");this.type=s}else if(s){if(s.typeId===oe.typeId)this.second=new Br(i,oe);else if(s.typeId===pe.typeId)this.second=new Br(i,pe);else{if(s.typeId!==ge.typeId)throw new Error("select: invalid type of the second value");this.second=new Br(i,ge)}this.type=s}else{if(r.typeId===oe.typeId)this.first=new Br(e,oe);else if(r.typeId===pe.typeId)this.first=new Br(e,pe);else{if(r.typeId!==ge.typeId)throw new Error("select: invalid type of the first value");this.first=new Br(e,ge)}this.type=r}}getType(){return this.type}isConstExp(){return!1}markWritable(){}isWritable(){return!1}getAddressSpace(){return null}toWebGL(t,e){return`${t}(${this.condition.toWebGL("",e)} ? ${this.first.toWebGL("",e)} : ${this.second.toWebGL("",e)})`}toWebGL2(t,e){return`${t}(${this.condition.toWebGL2("",e)} ? ${this.first.toWebGL2("",e)} : ${this.second.toWebGL2("",e)})`}toWGSL(t,e){return`${t}select(${this.second.toWGSL("",e)}, ${this.first.toWGSL("",e)}, ${this.condition.toWGSL("",e)})`}}class jr extends Er{lvalue;rvalue;constructor(t,e){if(super(),!t.isReference())throw new Error("assignment: l-value required");if(this.lvalue=t,this.rvalue=e,this.lvalue instanceof Pr)if(this.lvalue.getType().isPointerType())if(this.rvalue instanceof Fr)this.lvalue.value.ref=this.rvalue.ref;else{if(!(this.rvalue instanceof kr))throw new nr(this.lvalue,"invalid pointer assignment");this.lvalue.value.ref=this.rvalue.value}else this.rvalue instanceof Sr&&(this.lvalue.value.constExp=this.rvalue.isConstExp());else{if(this.lvalue.getType().isPointerType())throw new nr(this.lvalue,"cannot assign to read-only variable");this.lvalue.markWritable()}this.rvalue instanceof Qr&&(this.rvalue.isStatement=!1)}getType(){return null}toWebGL(t,e){let i=null;const s=this.lvalue.getType(),r=this.checkScalarType(this.rvalue,s);if(!s.isCompatibleType(r))throw new Zs(this.rvalue instanceof Sr?this.rvalue.toString("webgl"):`${this.rvalue}`,r,s);return i="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?r.primitiveType===Bt.F32?wr(this.rvalue):String(this.rvalue):yr(this.rvalue.toWebGL(t,e)),this.lvalue instanceof Pr&&(this.lvalue.value.constExp&&=!(this.rvalue instanceof Sr)||this.rvalue.isConstExp()),`${t}${this.lvalue.toWebGL(t,e)} = ${i};\n`}toWebGL2(t,e){let i=null;const s=this.lvalue.getType(),r=this.checkScalarType(this.rvalue,s);if(!s.isCompatibleType(r))throw new Zs(this.rvalue instanceof Sr?this.rvalue.toString("webgl2"):`${this.rvalue}`,r,s);return i="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?r.primitiveType===Bt.F32?wr(this.rvalue):String(this.rvalue):yr(this.rvalue.toWebGL2(t,e)),this.lvalue instanceof Pr&&(this.lvalue.value.constExp&&=!(this.rvalue instanceof Sr)||this.rvalue.isConstExp()),`${t}${this.lvalue.toWebGL2(t,e)} = ${i};\n`}toWGSL(t,e){const i=this.lvalue.getType(),[s,r]=i.isPointerType()?[i.pointerType,!0]:[i,!1],n=this.checkScalarType(this.rvalue,s),a=n&&n.isPointerType(),o=a?n.pointerType:n;if(!s.isCompatibleType(o))throw new Zs(this.rvalue instanceof Sr?this.rvalue.toString("webgpu"):`${this.rvalue}`,n,i);if(this.lvalue instanceof Dr||this.lvalue instanceof Pr){const t=s.isStructType()?s.structName:null;if(t&&e.types.findIndex((e=>e instanceof an&&e.type.structName===t))<0)return""}let h;h="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?n.primitiveType===Bt.F32?wr(this.rvalue):String(this.rvalue):yr(this.rvalue.toWGSL(t,e));const l=this.lvalue.toWGSL(t,e);if(r&&!a){if(this.lvalue instanceof Pr)throw new Error(`rvalue must be pointer type: ${h}`);return`${t}*(${l}) = ${h};\n`}return a&&!r?`${t}${l} = *(${h});\n`:`${t}${l} = ${h};\n`}checkScalarType(t,e){if(t instanceof Sr)return t.getType();const i="boolean"==typeof t,s="number"==typeof t&&Number.isInteger(t)&&t>=-2147483648&&t<=2147483647,r="number"==typeof t&&Number.isInteger(t)&&t>=0&&t<=4294967295,n="number"==typeof t;if(!e.isPrimitiveType())return i?Te:s?pe:r?ge:oe;switch(e.primitiveType){case Bt.BOOL:return i?e:s?pe:r?ge:oe;case Bt.F32:return n?e:Te;case Bt.I32:return s?e:i?Te:r?ge:oe;case Bt.U32:return r?e:i?Te:s?pe:oe;default:return null}}}class qr extends Er{toWebGL(t,e){return`${t}discard;\n`}toWebGL2(t,e){return`${t}discard;\n`}toWGSL(t,e){return`${t}discard;\n`}}class Yr extends Er{toWebGL(t,e){return`${t}break;\n`}toWebGL2(t,e){return`${t}break;\n`}toWGSL(t,e){return`${t}break;\n`}}class Zr extends Er{toWebGL(t,e){return`${t}continue;\n`}toWebGL2(t,e){return`${t}continue;\n`}toWGSL(t,e){return`${t}continue;\n`}}class Kr extends Er{value;constructor(t){super(),this.value=t,this.value instanceof Qr&&(this.value.isStatement=!1)}toWebGL(t,e){return this.value?`${t}return ${yr(this.value.toWebGL(t,e))};\n`:`${t}return;\n`}toWebGL2(t,e){return this.value?`${t}return ${yr(this.value.toWebGL2(t,e))};\n`:`${t}return;\n`}toWGSL(t,e){return this.value?`${t}return ${yr(this.value.toWGSL(t,e))};\n`:`${t}return;\n`}}class Qr extends Sr{name;args;retType;func;isStatement;constructor(t,e,i,s,r){if(super(),this.name=t,this.args=e,this.retType=i?.returnType??r??vs,this.func=i,this.isStatement=!0,i){if(i.funcType.argTypes.length!==this.args.length)throw new ar("ASTCallFunction(): number of parameters mismatch");for(let r=0;r<this.args.length;r++){const n=i.funcType.argTypes[r];if(n.byRef){if("webgpu"===s){const i=e[r].getAddressSpace();if(i!==Kt.FUNCTION&&i!==Kt.PRIVATE)throw new Qs(t,"pointer type of function parameter must be function or private");const s=n.type;if(!s.isPointerType())throw new ar("ASTCallFunction(): invalid reference type");if(s.addressSpace===Kt.UNKNOWN)s.addressSpace=i;else if(s.addressSpace!==i)throw new Qs(t,`invalid pointer parameter address space '${i}', should be '${s.addressSpace}`)}this.args[r].markWritable()}}}for(const t of this.args)t instanceof Qr&&(t.isStatement=!1)}getType(){return this.retType}isConstExp(){return!1}markWritable(){}isWritable(){return!1}getAddressSpace(){return null}toWebGL(t,e){"dFdx"===this.name||"dFdy"===this.name||"fwidth"===this.name?e.extensions.add("GL_OES_standard_derivatives"):"texture2DLodEXT"!==this.name&&"texture2DProjLodEXT"!==this.name&&"textureCubeLodEXT"!==this.name&&"texture2DGradEXT"!==this.name&&"texture2DProjGradEXT"!==this.name&&"textureCubeGradEXT"!==this.name||e.extensions.add("GL_EXT_shader_texture_lod");const i=this.args.map((i=>yr(i.toWebGL(t,e))));return`${this.isStatement?t:""}${this.name}(${i.join(",")})${this.isStatement?";\n":""}`}toWebGL2(t,e){const i=this.args.map((i=>yr(i.toWebGL2(t,e))));return`${this.isStatement?t:""}${this.name}(${i.join(",")})${this.isStatement?";\n":""}`}toWGSL(t,e){let i=this.args;if(this.func){let t;const s=on(i,this.func.funcType);if(s&&(t=s.args),!t)throw new Error(`no matching overloading found for function '${this.name}'`);i=t.filter((t=>{const i=t.getType();return!(i.isStructType()&&e.types.findIndex((t=>t instanceof an&&t.type.structName===i.structName))<0)}))}const s=i.map((i=>yr(i.toWGSL(t,e))));return`${this.isStatement?t:""}${this.name}(${s.join(",")})${this.isStatement?";\n":""}`}toString(t){return`${this.name}(...)`}}class Jr extends Er{value;group;binding;blockName;constructor(t){super(),this.value=t,this.group=0,this.binding=0}isReference(){return!0}isPointer(){return this.value.getType().isPointerType()}toWebGL(t,e){let i="",s=!1,r=this.value.getType();switch(this.value.value.$declareType){case dr.DECLARE_TYPE_IN:e.type===Et.Vertex?(i="attribute ",e.defines.push(`#define ${this.value.name} ${Vs(e.vertexAttributes[this.value.value.$location])}\n`)):i="varying ";break;case dr.DECLARE_TYPE_OUT:e.type===Et.Vertex?i="varying ":(s=!0,e.mrt?(e.defines.push(`#define ${this.value.name} gl_FragData[${this.value.value.$location}]\n`),e.extensions.add("GL_EXT_draw_buffers")):e.defines.push(`#define ${this.value.name} gl_FragColor\n`));break;case dr.DECLARE_TYPE_UNIFORM:i="uniform ",r=e.typeReplacement?.get(this.value.value)||r;break;case dr.DECLARE_TYPE_STORAGE:throw new Error(`invalid variable declare type: ${this.value.name}`)}if(!s)return`${t}${i}${r.toTypeName("webgl",this.value.name)};\n`}toWebGL2(t,e){let i="",s=this.value.getType();switch(this.value.value.$declareType){case dr.DECLARE_TYPE_IN:i=e.type===Et.Fragment&&s.isPrimitiveType()&&s.isInteger()?"flat in ":"in ",e.type===Et.Vertex&&e.defines.push(`#define ${this.value.name} ${Vs(e.vertexAttributes[this.value.value.$location])}\n`);break;case dr.DECLARE_TYPE_OUT:i=e.type===Et.Vertex?s.isPrimitiveType()&&s.isInteger()?"flat out ":"out ":`layout(location = ${this.value.value.$location}) out `;break;case dr.DECLARE_TYPE_UNIFORM:return s.isStructType()?`${t}layout(std140) uniform ${this.blockName} { ${s.structName} ${this.value.name}; };\n`:(s=e.typeReplacement?.get(this.value.value)||s,`${t}uniform ${s.toTypeName("webgl2",this.value.name)};\n`);case dr.DECLARE_TYPE_STORAGE:throw new Error(`invalid variable declare type: ${this.value.name}`)}return`${t}${i}${this.value.getType().toTypeName("webgl2",this.value.name)};\n`}toWGSL(t,e){let i;const s=this.value.getType().isPrimitiveType()||this.value.getType().isStructType()||this.value.getType().isArrayType();switch(this.value.value.$declareType){case dr.DECLARE_TYPE_IN:case dr.DECLARE_TYPE_OUT:throw new Error("Internal error");case dr.DECLARE_TYPE_UNIFORM:i=`@group(${this.group}) @binding(${this.binding}) var${s?"<uniform>":""} `;break;case dr.DECLARE_TYPE_STORAGE:i=`@group(${this.group}) @binding(${this.binding}) var<storage, ${this.value.value.$readonly?"read":"read_write"}> `;break;case dr.DECLARE_TYPE_WORKGROUP:i="var<workgroup> ";break;default:i=`${this.value.getType().isPointerType()?"let":"var"}${this.value.value.$global&&!this.value.getType().isPointerType()?"<private>":""} `}{const s=this.value.getType(),r=s.isStructType()?s.structName:null;return r&&e.types.findIndex((t=>t instanceof an&&t.type.structName===r))<0?"":`${t}${i}${s.toTypeName("webgpu",this.value.name)};\n`}}toString(t){return this.value.toString(t)}}class tn extends Ar{name;args;isBuiltin;isMainFunc;funcType;builtins;returnType;constructor(t,e,i,s,r=!1){super(),this.name=t,this.args=e,this.funcType=s,this.builtins=[],this.isBuiltin=r,this.isMainFunc=i,this.returnType=s?s.returnType:null}toWebGL(t,e){if(this.isBuiltin)return"";{let i="";const s=[];for(const t of this.args){let e,i,r;t.paramAST instanceof Fr?(e=t.paramAST.value,i=t.paramAST.name,r=""):(e=t.paramAST.value.value,i=t.paramAST.value.name,r=`${e.$inout} `),s.push(`${r}${t.getType().toTypeName("webgl",i)}`)}return i+=`${t}${this.returnType.toTypeName("webgl")} ${this.name}(${s.join(",")}) {\n`,i+=super.toWebGL(t+"  ",e),i+=`${t}}\n`,i}}toWebGL2(t,e){if(this.isBuiltin)return"";{let i="";const s=[];for(const t of this.args){let e,i,r;t.paramAST instanceof Fr?(e=t.paramAST.value,i=t.paramAST.name,r=""):(e=t.paramAST.value.value,i=t.paramAST.value.name,r=`${e.$inout} `),s.push(`${r}${t.getType().toTypeName("webgl2",i)}`)}return i+=`${t}${this.returnType.toTypeName("webgl2")} ${this.name}(${s.join(",")}) {\n`,i+=super.toWebGL2(t+"  ",e),i+=`${t}}\n`,i}}toWGSL(t,e){if(this.isBuiltin)return"";{let i="";const s=[...this.builtins];for(const t of this.args){const i=t.paramAST instanceof Fr?t.paramAST.name:t.paramAST.value.name,r=t.paramAST instanceof Fr?t.paramAST.getType():t.paramAST.value.getType(),n=r.isPointerType()?r.pointerType:r;n.isStructType()&&e.types.findIndex((t=>t instanceof an&&t.type.structName===n.structName))<0||s.push(`${r.toTypeName("webgpu",i)}`)}let r="";if(this.isMainFunc)switch(e.type){case Et.Vertex:r="@vertex ";break;case Et.Fragment:r="@fragment ";break;case Et.Compute:r=`@compute @workgroup_size(${e.workgroupSize[0]}, ${e.workgroupSize[1]}, ${e.workgroupSize[2]}) `}const n=this.returnType.isVoidType()?null:this.returnType.toTypeName("webgpu"),a=n?` -> ${n}`:"";return i+=`${t}${r}fn ${this.name}(${s.join(",")})${a} {\n`,i+=super.toWGSL(t+"  ",e),i+=`${t}}\n`,i}}}class en extends Ar{keyword;condition;nextElse;constructor(t,e){super(),this.keyword=t,this.condition=e,this.nextElse=null,this.condition instanceof Qr&&(this.condition.isStatement=!1)}toWebGL(t,e){let i=`${t}${this.keyword} ${this.condition?"("+yr(this.condition.toWebGL(t,e))+")":""} {\n`;return i+=super.toWebGL(t+"  ",e),i+=`${t}}\n`,this.nextElse&&(i+=this.nextElse.toWebGL(t,e)),i}toWebGL2(t,e){let i=`${t}${this.keyword} ${this.condition?"("+yr(this.condition.toWebGL2(t,e))+")":""} {\n`;return i+=super.toWebGL2(t+"  ",e),i+=`${t}}\n`,this.nextElse&&(i+=this.nextElse.toWebGL2(t,e)),i}toWGSL(t,e){let i=`${t}${this.keyword} ${this.condition?"("+yr(this.condition.toWGSL(t,e))+")":""} {\n`;return i+=super.toWGSL(t+"  ",e),i+=`${t}}\n`,this.nextElse&&(i+=this.nextElse.toWGSL(t,e)),i}}class sn extends Ar{init;start;end;open;constructor(t,e,i,s){super(),this.init=t,this.start=e,this.end=i,this.open=s,this.statements=[],this.start instanceof Qr&&(this.start.isStatement=!1),this.end instanceof Qr&&(this.end.isStatement=!1)}toWebGL(t,e){const i=this.init.getType().toTypeName("webgl",this.init.name),s=yr(this.start.toWebGL(t,e)),r=yr(this.end.toWebGL(t,e)),n=this.open?"<":"<=";let a=`${t}for (${i} = ${s}; ${this.init.name} ${n} ${r}; ${this.init.name}++) {\n`;return a+=super.toWebGL(t+"  ",e),a+=`${t}}\n`,a}toWebGL2(t,e){const i=this.init.getType().toTypeName("webgl2",this.init.name),s=yr(this.start.toWebGL2(t,e)),r=yr(this.end.toWebGL2(t,e)),n=this.open?"<":"<=";let a=`${t}for (${i} = ${s}; ${this.init.name} ${n} ${r}; ${this.init.name}++) {\n`;return a+=super.toWebGL2(t+"  ",e),a+=`${t}}\n`,a}toWGSL(t,e){const i=`var ${this.init.getType().toTypeName("webgpu",this.init.name)}`,s=yr(this.start.toWGSL(t,e)),r=yr(this.end.toWGSL(t,e)),n=new Br(1,this.init.getType()).toWGSL(t,e),a=this.open?"<":"<=";let o=`${t}for (${i} = ${s}; ${this.init.name} ${a} ${r}; ${this.init.name} = ${this.init.name} + ${n}) {\n`;return o+=super.toWGSL(t+"  ",e),o+=`${t}}\n`,o}}class rn extends Ar{condition;constructor(t){super(),this.condition=t,this.condition instanceof Qr&&(this.condition.isStatement=!1)}toWebGL(t,e){throw new Error("No do-while() loop support for WebGL1.0 device")}toWebGL2(t,e){let i=`${t}do {\n`;return i+=super.toWebGL2(t+" ",e),i+=`${t}} while(${yr(this.condition.toWebGL2(t,e))});\n`,i}toWGSL(t,e){let i=`${t}loop {\n`;return i+=super.toWGSL(t+" ",e),i+=`${t}  if (!(${yr(this.condition.toWGSL(t,e))})) { break; }\n`,i+=`${t}}\n`,i}}class nn extends Ar{condition;constructor(t){super(),this.condition=t,this.condition instanceof Qr&&(this.condition.isStatement=!1)}toWebGL(t,e){let i=`${t}for(int z_tmp_counter = 0; z_tmp_counter == 0; z_tmp_counter += 0) {\n`;const s=t+"  ";return i+=`${s}if(!(${yr(this.condition.toWebGL(t,e))})){ break; }\n`,i+=super.toWebGL(s,e),i+=`${t}}\n`,i}toWebGL2(t,e){let i=`${t}while(${yr(this.condition.toWebGL2(t,e))}) {\n`;return i+=super.toWebGL2(t+"  ",e),i+=`${t}}\n`,i}toWGSL(t,e){let i=`${t}for(;${yr(this.condition.toWGSL(t,e))};) {\n`;return i+=super.toWGSL(t+"  ",e),i+=`${t}}\n`,i}}class an extends Er{type;prefix;builtin;constructor(t,e){super(),this.prefix=null,this.builtin=e,this.type=t}getType(){return this.type}toWebGL(t,e){if(this.builtin)return"";{let e=`${t}struct ${this.type.structName} {\n`;for(const i of this.type.structMembers)e+=`${t}  ${i.type.toTypeName("webgl",i.name)};\n`;return e+=`${t}};\n`,e}}toWebGL2(t,e){if(this.builtin)return"";{let e=`${t}struct ${this.type.structName} {\n`;for(const i of this.type.structMembers)e+=`${t}  ${i.type.toTypeName("webgl2",i.name)};\n`;return e+=`${t}};\n`,e}}toWGSL(t,e){if(this.builtin)return"";{let e=`${t}struct ${this.type.structName} {\n`;return e+=this.type.structMembers.map(((e,i)=>{const s=this.prefix?this.prefix[i]:"",r=e.type.getLayoutSize(this.type.layout)!==e.type.getLayoutSize("default")?`@size(${e.type.getLayoutSize(this.type.layout)}) `:"",n=i>0&&e.type.getLayoutAlignment(this.type.layout)!==e.type.getLayoutAlignment("default")?`@align(${e.type.getLayoutAlignment(this.type.layout)}) `:"";return`${t}  ${s}${n}${r}${e.type.toTypeName("webgpu",e.name)}`})).join(",\n"),e+=`\n${t}};\n`,e}}}function on(t,e){if(t.length!==e.argTypes.length)return null;const i=[];for(let s=0;s<t.length;s++){const r=!!e.argTypes[s].byRef,n=r?e.argTypes[s].type.pointerType:e.argTypes[s].type,a=t[s];if("number"==typeof a){if(r||!n.isPrimitiveType()||!n.isScalarType()||n.primitiveType===Bt.BOOL)return null;i.push(new Br(a,n))}else if("boolean"==typeof a){if(r||!n.isPrimitiveType()||n.primitiveType!==Bt.BOOL)return null;i.push(new Br(a,n))}else{if(!n.isCompatibleType(a.getType()))return null;r?(a.markWritable(),i.push(new kr(a))):i.push(a)}}return{name:e.name,args:i}}class hn{_builder;_tagList;_attribList;constructor(t){this._builder=t,this._tagList={},this._attribList={}}get vertexAttributes(){return this._builder.getVertexAttributes()}hasVertexAttribute(t){return this.vertexAttributes.indexOf(t)>=0}clear(){this._tagList={},this._attribList={}}tag(t,e){if("string"==typeof t){if(void 0===e)return this.getTag(t);this.addTag(t,e)}else for(const e of Object.keys(t))this.addTag(e,t[e])}attribute(t){return this._attribList[t]||null}setAttrib(t,e){this._attribList[t]=e}addTag(t,e){this._tagList[t]=e}getTag(t){const e=this._tagList[t];return e?e(this._builder.getGlobalScope()):null}}let ln=null;const un=new Map;function cn(t){ln=t}function dn(){return ln}function pn(t,e){return new Proxy(t,{get:function(i,s){if("symbol"==typeof s||s in i)return i[s];let r=un.get(t);r||(r={},un.set(t,r));let n=r[s];if(!n&&(e.isPrimitiveType()||e.isStructType()||e.isArrayType()||e.isAtomicI32()||e.isAtomicU32()))if("ptr"===s){const t=new se(e,Kt.FUNCTION);n=function(...e){if(1===e.length&&"string"==typeof e[0])return new _n(e[0],t);throw new Error("Invalid pointer type constructor")}}else{const t=Number(s);if(Number.isInteger(t)&&t>=0){const i=new ie(e,t);n=pn((function(...t){if(1===t.length&&"string"==typeof t[0])return new _n(t[0],i);{const e=new _n("",i);return e.$ast=new Nr(e.$typeinfo,t.map((t=>t instanceof _n?t.$ast:t))),e}}),i)}}return n&&(r[s]=n),n}})}class mn{proxy;constructor(){return this.proxy=new Proxy(this,{get:function(t,e){return"string"==typeof e?t.$get(e):void 0},set:function(t,e,i){return"string"==typeof e&&t.$set(e,i)}}),this.proxy}get $thisProxy(){return this.proxy}}let fn=0;class _n extends mn{$uid;$str;$location;$typeinfo;$global;$sampleType;$precision;$ast;$inout;$memberCache;$attrib;$tags;$_group;$declareType;$isBuffer;$readonly;$bindingSize;constructor(t,e){if(super(),!t&&e.isPointerType())throw new Error("no default constructor for pointer type");if(this.$uid=fn++,this.$str=t||"",this.$location=0,this.$global=!1,this.$typeinfo=e,this.$qualifier=null,this.$precision=pr.NONE,this.$ast=new Fr(this),this.$inout=null,this.$memberCache={},this.$attrib=null,this.$tags=[],this.$_group=null,this.$declareType=dr.DECLARE_TYPE_NONE,this.$isBuffer=!1,this.$bindingSize=0,this.$readonly=!1,e.isTextureType())if(e.isDepthTexture())this.$sampleType="depth";else{const t=function(t){switch(t.textureType){case Wt.TEX_1D:case Wt.TEX_STORAGE_1D:case Wt.TEX_2D:case Wt.TEX_STORAGE_2D:case Wt.TEX_2D_ARRAY:case Wt.TEX_STORAGE_2D_ARRAY:case Wt.TEX_3D:case Wt.TEX_STORAGE_3D:case Wt.TEX_CUBE:case Wt.TEX_EXTERNAL:return new te(Bt.F32VEC4);case Wt.TEX_DEPTH_2D_ARRAY:case Wt.TEX_DEPTH_2D:case Wt.TEX_DEPTH_CUBE:return new te(Bt.F32);case Wt.ITEX_2D_ARRAY:case Wt.ITEX_1D:case Wt.ITEX_2D:case Wt.ITEX_3D:case Wt.ITEX_CUBE:return new te(Bt.I32);case Wt.UTEX_2D_ARRAY:case Wt.UTEX_1D:case Wt.UTEX_2D:case Wt.UTEX_3D:case Wt.UTEX_CUBE:return new te(Bt.U32);default:return null}}(e);t.primitiveType===Bt.I32?this.$sampleType="sint":t.primitiveType===Bt.U32?this.$sampleType="uint":this.$sampleType="float"}}get $group(){return this.$_group}set $group(t){this.$_group=t,this.$_group}uniform(t){return this.$declareType=dr.DECLARE_TYPE_UNIFORM,this.$group=t,this.$isBuffer=!1,this}uniformBuffer(t,e=0){if(!this.$typeinfo.isPrimitiveType()&&!this.$typeinfo.isArrayType()&&!this.$typeinfo.isStructType())throw new nr(this.$ast,"only primitive type, array type or structure type can be set as uniform buffer");return this.$declareType=dr.DECLARE_TYPE_UNIFORM,this.$group=t,this.$isBuffer=!0,this.$bindingSize=e,this}workgroup(){return this.$declareType=dr.DECLARE_TYPE_WORKGROUP,this}storage(t){if(!this.$typeinfo.isHostSharable())throw new nr(this.$ast,"type cannot be declared in storage address space");return this.$declareType=dr.DECLARE_TYPE_STORAGE,this.$group=t,this.$isBuffer=!1,this.$readonly=!1,this}storageReadonly(t){return this.storage(t),this.$readonly=!0,this}storageBuffer(t,e=0){if(!(this.$typeinfo.isPrimitiveType()||this.$typeinfo.isArrayType()||this.$typeinfo.isStructType()||this.$typeinfo.isAtomicI32()||this.$typeinfo.isAtomicU32()))throw new nr(this.$ast,"only primitive type, array type or structure type can be set as storage buffer");return this.$declareType=dr.DECLARE_TYPE_STORAGE,this.$group=t,this.$isBuffer=!0,this.$bindingSize=e,this.$readonly=!1,this}storageBufferReadonly(t,e=0){return this.storageBuffer(t,e),this.$readonly=!0,this}inout(){return this.$inout="inout",this}out(){return this.$inout="out",this}attrib(t){return this.$declareType=dr.DECLARE_TYPE_IN,this.$attrib=t,this}tag(...t){return t.forEach((t=>{this.$tags.indexOf(t)<0&&this.$tags.push(t)})),this}sampleType(t){return t&&(this.$sampleType=t),this}at(t){const e=this.$ast.getType();if(!(e.isArrayType()||e.isPrimitiveType()&&(e.isVectorType()||e.isMatrixType())))throw new Error("at() function must be used with array types");let i,s=null;e.isArrayType()?(s=e.elementType,i=e.dimension):e.isVectorType()?(s=te.getCachedTypeInfo(e.resizeType(1,1)),i=e.cols):e.isMatrixType()&&(s=te.getCachedTypeInfo(e.resizeType(1,e.cols)),i=e.rows);const r=new _n("",s);if("number"==typeof t){if(!Number.isInteger(t))throw new Error("at() array index must be integer type");if(t<0||i>0&&t>=i)throw new Error("at() array index out of bounds");r.$ast=new Xr(this.$ast,new Br(t,pe),s)}else{const e=t.$ast.getType();if(!e.isPrimitiveType()||!e.isScalarType())throw new Error("at() array index must be scalar type");let i=t.$ast;e.scalarType!==Bt.I32&&e.scalarType!==Bt.U32&&(i=new Ur(i,pe)),r.$ast=new Xr(this.$ast,i,s)}return r}setAt(t,e){const i=this.$ast.getType();if(!i.isArrayType())throw new Error("setAt() function must be used with array types");if("number"==typeof t){if(!Number.isInteger(t))throw new Error("setAt() array index must be integer type");if(t<0||i.dimension>0&&t>=i.dimension)throw new Error("setAt() array index out of bounds")}ln.getCurrentScope().$ast.statements.push(new jr(new Lr(new Dr(this.$ast),"number"==typeof t?new Br(t,pe):t.$ast,i.elementType),e instanceof _n?e.$ast:e))}highp(){return this.$precision=pr.HIGH,this}mediump(){return this.$precision=pr.MEDIUM,this}lowp(){return this.$precision=pr.LOW,this}isConstructor(){return this.$ast instanceof Nr&&0===this.$ast.args.length}isVector(){const t=this.$ast.getType();return t.isPrimitiveType()&&t.isVectorType()}numComponents(){const t=this.$ast.getType();return t.isPrimitiveType()?t.cols:0}getTypeName(){return this.$ast.getType().toTypeName(ln.getDevice().type)}$get(t){if("string"==typeof t){if("$"===t[0]||t in this)return this[t];{let e=this.$memberCache[t];if(!e){const i=this.$ast?.getType()||this.$typeinfo,s=Number(t);if(Number.isNaN(s))if(i.isStructType()){const s=i.structMembers.findIndex((e=>e.name===t));if(s<0)throw new Error(`unknown struct member '${t}'`);const r=i.structMembers[s];if(r.type.isStructType()){e=ln.structInfo.structs[r.type.structName].call(ln,`${this.$str}.${t}`)}else e=new _n(`${this.$str}.${t}`,r.type);e.$ast=new Or(this.$ast,t,r.type)}else{if(!i.isPrimitiveType()||!i.isVectorType())throw new Error(`invalid index operation: ${this.$ast.toString(ln.getDevice().type)}[${t}]`);if(0===t.length||t.length>4||[...t].some((t=>"xyzw".slice(0,i.cols).indexOf(t)<0))&&[...t].some((t=>"rgba".slice(0,i.cols).indexOf(t)<0)))throw new Error(`unknown swizzle target: ${this.$ast.toString(ln.getDevice().type)}[${t}]`);const s=te.getCachedTypeInfo(i.resizeType(1,t.length));e=new _n("",s),e.$ast=new Or(this.$ast,t,s)}else if(i.isArrayType())e=this.at(s);else if(i.isPrimitiveType()&&i.isVectorType()){if(s>=i.cols)throw new Error(`component index out of bounds: ${this.$str}[${s}]`);e=this.$get("xyzw"[s])}else{if(!i.isPrimitiveType()||!i.isMatrixType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);{const t=te.getCachedTypeInfo(i.resizeType(1,i.cols));e=new _n("",t),e.$ast=new Xr(this.$ast,new Br(s,pe),t)}}this.$memberCache[t]=e}return e}}}$set(t,e){if("string"==typeof t){if("$"===t[0]||t in this)this[t]=e;else{if("number"!=typeof e&&"boolean"!=typeof e&&!(e instanceof _n))throw new Error("Invalid output value assignment");const i=this.$ast?.getType()||this.$typeinfo,s=Number(t);if(Number.isNaN(s))if(i.isStructType()){const s=i.structMembers.findIndex((e=>e.name===t));if(s<0)throw new Error(`unknown struct member '${t}`);const r=i.structMembers[s];let n;if("number"==typeof e||"boolean"==typeof e){if(!r.type.isPrimitiveType()||!r.type.isScalarType())throw new Error(`can not set struct member '${t}: invalid value type`);n=new Br(e,r.type)}else e instanceof _n&&(n=e.$ast);if(!n)throw new Error(`can not set struct member '${t}: invalid value type`);ln.getCurrentScope().$ast.statements.push(new jr(new $r(new Dr(this.$ast),t,r.type),n))}else{if(t.length>1||"xyzw".indexOf(t)<0&&"rgba".indexOf(t)<0)throw new Error(`invalid index operation: ${this.$str}[${s}]`);if(!i.isPrimitiveType()||!i.isVectorType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);const r=te.getCachedTypeInfo(i.scalarType);ln.getCurrentScope().$ast.statements.push(new jr(new $r(new Dr(this.$ast),t,r),e instanceof _n?e.$ast:e))}else if(i.isArrayType())this.setAt(s,e);else if(i.isPrimitiveType()&&i.isVectorType()){if(s>=i.cols)throw new Error(`component index out of bounds: ${this.$str}[${s}]`);this.$set("xyzw"[s],e)}else{if(!i.isPrimitiveType()||!i.isMatrixType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);{if(!(e instanceof _n))throw new Error(`invalid matrix column vector assignment: ${this.$str}[${s}]`);const t=te.getCachedTypeInfo(i.resizeType(1,i.cols));ln.getCurrentScope().$ast.statements.push(new jr(new Lr(new Dr(this.$ast),new Br(s,pe),t),e.$ast))}}}return!0}return!1}}const gn=[[oe,he,le,ue],[pe,me,fe,_e],[ge,xe,be,we],[Te,ve,ye,Ee]],xn=[Se,Ce,Ae,Me,Re,Fe,Ie,De,$e];function bn(t,e,...i){const s="webgl"===t.getDevice().type?Cn:"webgl2"===t.getDevice().type?An:Mn,r=In?.[e].overloads.filter((t=>!!(t[1]&s))).map((t=>t[0]));if(!r||0===r.length)throw new sr(`builtin shader function '${e}'`);const n=i.map((e=>t.normalizeExpValue(e))),a=t._matchFunctionOverloading(r,n);if(!a)throw new tr(e);return a}function wn(t,e){return t.$callFunction(e[0].name,e[1],e[0])}function Tn(t,e,...i){return wn(t,bn(t,e,...i))}function vn(t,e,i,s){const r=[];for(let n=0;n<xn.length;n++){const a=i||xn[n],o=s.map((t=>({type:t||xn[n]})));r.push([new tn(t,null,!1,new ae(t,a,o),!0),e])}return r}function yn(t,e,i,s,r){if(s.findIndex((t=>"number"==typeof t))<0)return[[new tn(t,null,!1,new ae(t,i,s.map((t=>({type:t})))),!0),e]];{const n=[];let a=r?1:0;for(;a<4;a++){const r="number"==typeof i?gn[i][a]:i,o=s.map((t=>"number"==typeof t?{type:gn[t][a]}:{type:t}));n.push([new tn(t,null,!1,new ae(t,r,o),!0),e])}return n}}function En(t,e,i){const s=new _n("",i);return s.$ast=new Vr(t,e,i),s}function Sn(t,e,i,s){const r=new _n("",s);return r.$ast=new Gr(t,e,i,s),r}const Cn=1,An=2,Mn=4,Rn=Cn|An,Fn=Rn|Mn,In={add_2:{overloads:[...yn("",Fn,0,[0,0]),...yn("",Fn,1,[1,1]),...yn("",Fn,2,[2,2]),...yn("",Fn,3,[3,3]),...yn("",Fn,he,[oe,he]),...yn("",Fn,he,[he,oe]),...yn("",Fn,le,[oe,le]),...yn("",Fn,le,[le,oe]),...yn("",Fn,ue,[oe,ue]),...yn("",Fn,ue,[ue,oe]),...yn("",Fn,me,[pe,me]),...yn("",Fn,me,[me,pe]),...yn("",Fn,fe,[pe,fe]),...yn("",Fn,fe,[fe,pe]),...yn("",Fn,_e,[pe,_e]),...yn("",Fn,_e,[_e,pe]),...yn("",Fn,xe,[ge,xe]),...yn("",Fn,xe,[xe,ge]),...yn("",Fn,be,[ge,be]),...yn("",Fn,be,[be,ge]),...yn("",Fn,we,[ge,we]),...yn("",Fn,we,[we,ge]),...vn("",Fn,null,[null,null])],normalizeFunc(t,e,...i){if(2===i.length&&"number"==typeof i[0]&&"number"==typeof i[1])return i[0]+i[1];const s=bn(t,e,...i);return Sn(s[1][0],s[1][1],"+",s[0].returnType)}},add:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Ks("add");let s=i[0];for(let e=1;e<i.length;e++)s=t.add_2(s,i[e]);return s}},sub:{overloads:[...yn("",Fn,0,[0,0]),...yn("",Fn,1,[1,1]),...yn("",Fn,2,[2,2]),...yn("",Fn,3,[3,3]),...yn("",Fn,he,[oe,he]),...yn("",Fn,he,[he,oe]),...yn("",Fn,le,[oe,le]),...yn("",Fn,le,[le,oe]),...yn("",Fn,ue,[oe,ue]),...yn("",Fn,ue,[ue,oe]),...yn("",Fn,me,[pe,me]),...yn("",Fn,me,[me,pe]),...yn("",Fn,fe,[pe,fe]),...yn("",Fn,fe,[fe,pe]),...yn("",Fn,_e,[pe,_e]),...yn("",Fn,_e,[_e,pe]),...yn("",Fn,xe,[ge,xe]),...yn("",Fn,xe,[xe,ge]),...yn("",Fn,be,[ge,be]),...yn("",Fn,be,[be,ge]),...yn("",Fn,we,[ge,we]),...yn("",Fn,we,[we,ge]),...vn("",Fn,null,[null,null])],normalizeFunc(t,e,...i){const s=bn(t,e,...i);return Sn(s[1][0],s[1][1],"-",s[0].returnType)}},div:{overloads:[...yn("",Fn,0,[0,0]),...yn("",Fn,1,[1,1]),...yn("",Fn,2,[2,2]),...yn("",Fn,3,[3,3]),...yn("",Fn,he,[oe,he]),...yn("",Fn,he,[he,oe]),...yn("",Fn,le,[oe,le]),...yn("",Fn,le,[le,oe]),...yn("",Fn,ue,[oe,ue]),...yn("",Fn,ue,[ue,oe]),...yn("",Fn,me,[pe,me]),...yn("",Fn,me,[me,pe]),...yn("",Fn,fe,[pe,fe]),...yn("",Fn,fe,[fe,pe]),...yn("",Fn,_e,[pe,_e]),...yn("",Fn,_e,[_e,pe]),...yn("",Fn,xe,[ge,xe]),...yn("",Fn,xe,[xe,ge]),...yn("",Fn,be,[ge,be]),...yn("",Fn,be,[be,ge]),...yn("",Fn,we,[ge,we]),...yn("",Fn,we,[we,ge])],normalizeFunc(t,e,...i){const s=bn(t,e,...i);return Sn(s[1][0],s[1][1],"/",s[0].returnType)}},mul_2:{overloads:[...yn("",Fn,0,[0,0]),...yn("",Fn,1,[1,1]),...yn("",Fn,2,[2,2]),...yn("",Fn,3,[3,3]),...yn("",Fn,he,[oe,he]),...yn("",Fn,he,[he,oe]),...yn("",Fn,le,[oe,le]),...yn("",Fn,le,[le,oe]),...yn("",Fn,ue,[oe,ue]),...yn("",Fn,ue,[ue,oe]),...yn("",Fn,me,[pe,me]),...yn("",Fn,me,[me,pe]),...yn("",Fn,fe,[pe,fe]),...yn("",Fn,fe,[fe,pe]),...yn("",Fn,_e,[pe,_e]),...yn("",Fn,_e,[_e,pe]),...yn("",Fn,xe,[ge,xe]),...yn("",Fn,xe,[xe,ge]),...yn("",Fn,be,[ge,be]),...yn("",Fn,be,[be,ge]),...yn("",Fn,we,[ge,we]),...yn("",Fn,we,[we,ge]),...vn("",Fn,null,[oe,null]),...vn("",Fn,null,[null,oe]),...yn("",Fn,Se,[Se,Se]),...yn("",Fn,Me,[Se,Me]),...yn("",Fn,Ie,[Se,Ie]),...yn("",Fn,he,[Se,he]),...yn("",Fn,he,[he,Se]),...yn("",Fn,Ce,[Ce,Se]),...yn("",Fn,Re,[Ce,Me]),...yn("",Fn,De,[Ce,Ie]),...yn("",Fn,le,[Ce,he]),...yn("",Fn,he,[le,Ce]),...yn("",Fn,Ae,[Ae,Se]),...yn("",Fn,Fe,[Ae,Me]),...yn("",Fn,$e,[Ae,Ie]),...yn("",Fn,ue,[Ae,he]),...yn("",Fn,he,[ue,Ae]),...yn("",Fn,Se,[Me,Ce]),...yn("",Fn,Me,[Me,Re]),...yn("",Fn,Ie,[Me,De]),...yn("",Fn,he,[Me,le]),...yn("",Fn,le,[he,Me]),...yn("",Fn,Ce,[Re,Ce]),...yn("",Fn,Re,[Re,Re]),...yn("",Fn,De,[Re,De]),...yn("",Fn,le,[Re,le]),...yn("",Fn,le,[le,Re]),...yn("",Fn,Ae,[Fe,Ce]),...yn("",Fn,Fe,[Fe,Re]),...yn("",Fn,$e,[Fe,De]),...yn("",Fn,ue,[Fe,le]),...yn("",Fn,le,[ue,Fe]),...yn("",Fn,Se,[Ie,Ae]),...yn("",Fn,Me,[Ie,Fe]),...yn("",Fn,Ie,[Ie,$e]),...yn("",Fn,he,[Ie,ue]),...yn("",Fn,ue,[he,Ie]),...yn("",Fn,Ce,[De,Ae]),...yn("",Fn,Re,[De,Fe]),...yn("",Fn,De,[De,$e]),...yn("",Fn,le,[De,ue]),...yn("",Fn,ue,[le,De]),...yn("",Fn,Ae,[$e,Ae]),...yn("",Fn,Fe,[$e,Fe]),...yn("",Fn,$e,[$e,$e]),...yn("",Fn,ue,[$e,ue]),...yn("",Fn,ue,[ue,$e])],normalizeFunc(t,e,...i){const s=bn(t,e,...i);return Sn(s[1][0],s[1][1],"*",s[0].returnType)}},mul:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Ks("mul");let s=i[0];for(let e=1;e<i.length;e++)s=t.mul_2(s,i[e]);return s}},mod:{overloads:[...yn("mod",Fn,0,[0,0]),...yn("mod",Fn,1,[1,1]),...yn("mod",Fn,2,[2,2]),...yn("mod",Fn,3,[3,3])],normalizeFunc(t,e,...i){const s=bn(t,e,...i),r=s[1][0].getType(),n=r.isPrimitiveType()&&(r.scalarType===Bt.I32||r.scalarType===Bt.U32);if("webgl"===t.getDevice().type&&n)throw new sr("integer modulus");return"webgpu"===t.getDevice().type||n?Sn(s[1][0],s[1][1],"%",s[0].returnType):wn(t,s)}},radians:{overloads:yn("radians",Fn,0,[0])},degrees:{overloads:yn("degrees",Fn,0,[0])},sin:{overloads:yn("sin",Fn,0,[0])},cos:{overloads:yn("cos",Fn,0,[0])},tan:{overloads:yn("tan",Fn,0,[0])},asin:{overloads:yn("asin",Fn,0,[0])},acos:{overloads:yn("acos",Fn,0,[0])},atan:{overloads:yn("atan",Fn,0,[0])},atan2:{overloads:[...yn("atan",Rn,0,[0,0]),...yn("atan2",Mn,0,[0,0])]},sinh:{overloads:yn("sinh",An|Mn,0,[0])},cosh:{overloads:yn("cosh",An|Mn,0,[0])},tanh:{overloads:yn("tanh",An|Mn,0,[0])},asinh:{overloads:yn("asinh",An,0,[0])},acosh:{overloads:yn("acosh",An,0,[0])},atanh:{overloads:yn("atanh",An,0,[0])},pow:{overloads:yn("pow",Fn,0,[0,0])},exp:{overloads:yn("exp",Fn,0,[0])},exp2:{overloads:yn("exp2",Fn,0,[0])},log:{overloads:yn("log",Fn,0,[0])},log2:{overloads:yn("log2",Fn,0,[0])},sqrt:{overloads:yn("sqrt",Fn,0,[0])},inverseSqrt:{overloads:[...yn("inversesqrt",Rn,0,[0]),...yn("inverseSqrt",Mn,0,[0])]},abs:{overloads:[...yn("abs",Fn,0,[0]),...yn("abs",An|Mn,1,[1]),...yn("abs",Mn,2,[2])]},sign:{overloads:[...yn("sign",Fn,0,[0]),...yn("sign",An,1,[1])]},floor:{overloads:yn("floor",Fn,0,[0])},ceil:{overloads:yn("ceil",Fn,0,[0])},fract:{overloads:yn("fract",Fn,0,[0])},fma:{overloads:yn("fma",Fn,0,[0,0,0]),normalizeFunc(t,e,...i){const s=bn(t,e,...i);return"webgpu"===t.getDevice().type?wn(t,s):t.add(t.mul(i[0],i[1]),i[2])}},round:{overloads:yn("round",Mn,0,[0])},trunc:{overloads:yn("trunc",Mn,0,[0])},min:{overloads:[...yn("min",Fn,0,[0,0]),...yn("min",An|Mn,1,[1,1]),...yn("min",An|Mn,2,[2,2])]},max:{overloads:[...yn("max",Fn,0,[0,0]),...yn("max",An|Mn,1,[1,1]),...yn("max",An|Mn,2,[2,2])]},clamp:{overloads:[...yn("clamp",Fn,0,[0,0,0]),...yn("clamp",An|Mn,1,[1,1,1]),...yn("clamp",An|Mn,2,[2,2,2])]},mix:{overloads:[...yn("mix",Fn,0,[0,0,0]),...yn("mix",Fn,0,[0,0,oe])]},step:{overloads:yn("step",Fn,0,[0,0])},smoothStep:{overloads:yn("smoothstep",Fn,0,[0,0,0])},isnan:{overloads:yn("isnan",An,3,[0])},isinf:{overloads:yn("isinf",An,3,[0])},length:{overloads:yn("length",Fn,oe,[0])},distance:{overloads:yn("distance",Fn,oe,[0,0])},dot:{overloads:[...yn("dot",Fn,oe,[0,0],!0),...yn("dot",Mn,pe,[1,1],!0),...yn("dot",Mn,ge,[2,2],!0)]},cross:{overloads:yn("cross",Fn,le,[le,le])},normalize:{overloads:yn("normalize",Fn,0,[0],!0)},faceForward:{overloads:[...yn("faceforward",Rn,0,[0,0,0],!0),...yn("faceForward",Mn,0,[0,0,0],!0)]},reflect:{overloads:yn("reflect",Fn,0,[0,0],!0)},refract:{overloads:yn("refract",Fn,0,[0,0,oe],!0)},frexp:{overloads:[...yn("frexp",Mn,ys,[oe]),...yn("frexp",Mn,Es,[he]),...yn("frexp",Mn,Ss,[le]),...yn("frexp",Mn,Cs,[ue])]},outerProduct:{overloads:[...yn("outerProduct",An,Se,[he,he]),...yn("outerProduct",An,Re,[le,le]),...yn("outerProduct",An,$e,[ue,ue]),...yn("outerProduct",An,Ce,[le,he]),...yn("outerProduct",An,Me,[he,le]),...yn("outerProduct",An,Ae,[ue,he]),...yn("outerProduct",An,Ie,[he,ue]),...yn("outerProduct",An,Fe,[ue,le]),...yn("outerProduct",An,De,[le,ue])]},transpose:{overloads:[...yn("transpose",An|Mn,Se,[Se]),...yn("transpose",An|Mn,Re,[Re]),...yn("transpose",An|Mn,$e,[$e]),...yn("transpose",An|Mn,Ce,[Me]),...yn("transpose",An|Mn,Me,[Ce]),...yn("transpose",An|Mn,Ae,[Ie]),...yn("transpose",An|Mn,Ie,[Ae]),...yn("transpose",An|Mn,Fe,[De]),...yn("transpose",An|Mn,De,[Fe])]},determinant:{overloads:[...yn("determinant",An|Mn,oe,[Se]),...yn("determinant",An|Mn,oe,[Re]),...yn("determinant",An|Mn,oe,[$e])]},inverse:{overloads:[...yn("inverse",An,Se,[Se]),...yn("inverse",An,Re,[Re]),...yn("inverse",An,$e,[$e])]},lessThan:{overloads:[...yn("lessThan",Fn,3,[0,0]),...yn("lessThan",Fn,3,[1,1]),...yn("lessThan",Fn,3,[2,2])],normalizeFunc(t,e,...i){const s=bn(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?Sn(s[1][0],s[1][1],"<",s[0].returnType):wn(t,s)}},lessThanEqual:{overloads:[...yn("lessThanEqual",Fn,3,[0,0]),...yn("lessThanEqual",Fn,3,[1,1]),...yn("lessThanEqual",Fn,3,[2,2])],normalizeFunc(t,e,...i){const s=bn(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?Sn(s[1][0],s[1][1],"<=",s[0].returnType):wn(t,s)}},greaterThan:{overloads:[...yn("greaterThan",Fn,3,[0,0]),...yn("greaterThan",Fn,3,[1,1]),...yn("greaterThan",Fn,3,[2,2])],normalizeFunc(t,e,...i){const s=bn(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?Sn(s[1][0],s[1][1],">",s[0].returnType):wn(t,s)}},greaterThanEqual:{overloads:[...yn("greaterThanEqual",Fn,3,[0,0]),...yn("greaterThanEqual",Fn,3,[1,1]),...yn("greaterThanEqual",Fn,3,[2,2])],normalizeFunc(t,e,...i){const s=bn(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?Sn(s[1][0],s[1][1],">=",s[0].returnType):wn(t,s)}},compEqual:{overloads:[...yn("equal",Fn,3,[0,0]),...yn("equal",Fn,3,[1,1]),...yn("equal",Fn,3,[2,2]),...yn("equal",Fn,3,[3,3])],normalizeFunc(t,e,...i){const s=bn(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?Sn(s[1][0],s[1][1],"==",s[0].returnType):wn(t,s)}},compNotEqual:{overloads:[...yn("notEqual",Fn,3,[0,0]),...yn("notEqual",Fn,3,[1,1]),...yn("notEqual",Fn,3,[2,2]),...yn("notEqual",Fn,3,[3,3])],normalizeFunc(t,e,...i){const s=bn(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?Sn(s[1][0],s[1][1],"!=",s[0].returnType):wn(t,s)}},equal:{overloads:[...yn("equal",Fn,Te,[0,0]),...yn("equal",Fn,Te,[1,1]),...yn("equal",Fn,Te,[2,2]),...yn("equal",Fn,Te,[3,3])],normalizeFunc(t,e,...i){const s=bn(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type&&r.isPrimitiveType()&&!r.isScalarType()?t.all(t.compEqual(i[0],i[1])):Sn(s[1][0],s[1][1],"==",s[0].returnType)}},notEqual:{overloads:[...yn("notEqual",Fn,Te,[0,0]),...yn("notEqual",Fn,Te,[1,1]),...yn("notEqual",Fn,Te,[2,2]),...yn("notEqual",Fn,Te,[3,3])],normalizeFunc(t,e,...i){const s=bn(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type&&r.isPrimitiveType()&&!r.isScalarType()?t.any(t.compNotEqual(i[0],i[1])):Sn(s[1][0],s[1][1],"!=",s[0].returnType)}},any:{overloads:yn("any",Fn,Te,[3],!0)},all:{overloads:yn("all",Fn,Te,[3],!0)},not:{overloads:yn("not",Fn,3,[3]),normalizeFunc(t,e,...i){const s=bn(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?En(s[1][0],"!",s[0].returnType):wn(t,s)}},neg:{overloads:[...yn("neg",Fn,0,[0]),...yn("neg",Fn,1,[1])],normalizeFunc(t,e,...i){const s=bn(t,e,...i);return En(s[1][0],"-",s[0].returnType)}},or_2:{overloads:yn("or",Fn,Te,[3,3]),normalizeFunc(t,e,...i){const s=bn(t,e,...i);return Sn(s[1][0],s[1][1],"||",s[0].returnType)}},or:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Ks("or");let s=i[0];for(let e=1;e<i.length;e++)s=t.or_2(s,i[e]);return s}},compOr:{overloads:[...yn("compOr",An|Mn,1,[1,1]),...yn("compOr",An|Mn,2,[2,2])],normalizeFunc(t,e,...i){const s=bn(t,e,...i);return Sn(s[1][0],s[1][1],"|",s[0].returnType)}},and_2:{overloads:yn("and",Fn,Te,[3,3]),normalizeFunc(t,e,...i){const s=bn(t,e,...i);return Sn(s[1][0],s[1][1],"&&",s[0].returnType)}},and:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Ks("and");let s=i[0];for(let e=1;e<i.length;e++)s=t.and_2(s,i[e]);return s}},compAnd:{overloads:[...yn("compAnd",An|Mn,1,[1,1]),...yn("compAnd",An|Mn,2,[2,2])],normalizeFunc(t,e,...i){const s=bn(t,e,...i);return Sn(s[1][0],s[1][1],"&",s[0].returnType)}},compXor:{overloads:[...yn("compXor",An|Mn,1,[1,1]),...yn("compXor",An|Mn,2,[2,2])],normalizeFunc(t,e,...i){const s=bn(t,e,...i);return Sn(s[1][0],s[1][1],"^",s[0].returnType)}},sal:{overloads:[...yn("sal",An|Mn,1,[1,2]),...yn("sal",An|Mn,2,[2,2])],normalizeFunc(t,e,...i){const s=bn(t,e,...i);return Sn(s[1][0],s[1][1],"<<",s[0].returnType)}},sar:{overloads:[...yn("sar",An|Mn,1,[1,2]),...yn("sar",An|Mn,2,[2,2])],normalizeFunc(t,e,...i){const s=bn(t,e,...i);return Sn(s[1][0],s[1][1],">>",s[0].returnType)}},arrayLength:{overloads:[],normalizeFunc(t,e,...i){if(1!==i.length)throw new Ks("arrayLength");if(!(i[0]instanceof _n))throw new Js("arrayLength","array");const s=i[0].$ast.getType(),r=s.isPointerType()?s.pointerType:s;if(!r.isArrayType()||0!==r.dimension)throw new Qs("arrayLength","array");const n=s.isArrayType()?t.addressOf(i[0]).$ast:i[0].$ast;return t.$callFunctionNoCheck(e,[n],ge)}},select:{overloads:[...yn("select",Mn,0,[0,0,Te]),...yn("select",Mn,1,[1,1,Te]),...yn("select",Mn,2,[2,2,Te]),...yn("select",Mn,3,[3,3,Te]),...yn("select",Mn,0,[0,0,3],!0),...yn("select",Mn,1,[1,1,3],!0),...yn("select",Mn,2,[2,2,3],!0),...yn("select",Mn,3,[3,3,3],!0),...yn("mix",An,0,[0,0,3]),...yn("mix",An,1,[1,1,3]),...yn("mix",An,2,[2,2,3])]},floatBitsToInt:{overloads:yn("floatBitsToInt",An,1,[0]),normalizeFunc(t,e,...i){if(1!==i.length)throw new Ks("floatBitsToInt");if(i[0]instanceof _n){if(i[0].$ast.getType().typeId!==oe.typeId)throw new Qs("floatBitsToInt","x")}else if("number"!=typeof i[0])throw new Js("floatBitsToInt","x");return"webgpu"===t.getDevice().type?t.$callFunctionNoCheck("bitcast<i32>",[i[0]instanceof _n?i[0].$ast:new Br(i[0],oe)],pe):Tn(t,e,...i)}},floatBitsToUint:{overloads:yn("floatBitsToUint",An,2,[0]),normalizeFunc(t,e,...i){if(1!==i.length)throw new Ks("floatBitsToUint");if(i[0]instanceof _n){if(i[0].$ast.getType().typeId!==oe.typeId)throw new Qs("floatBitsToUint","x")}else if("number"!=typeof i[0])throw new Js("floatBitsToUint","x");return"webgpu"===t.getDevice().type?t.$callFunctionNoCheck("bitcast<u32>",[i[0]instanceof _n?i[0].$ast:new Br(i[0],oe)],ge):Tn(t,e,...i)}},intBitsToFloat:{overloads:yn("intBitsToFloat",An,0,[1]),normalizeFunc(t,e,...i){if(1!==i.length)throw new Ks("intBitsToFloat");if(i[0]instanceof _n){if(i[0].$ast.getType().typeId!==pe.typeId)throw new Qs("intBitsToFloat","x")}else if("number"!=typeof i[0])throw new Js("intBitsToFloat","x");return"webgpu"===t.getDevice().type?t.$callFunctionNoCheck("bitcast<f32>",[i[0]instanceof _n?i[0].$ast:new Br(i[0],pe)],oe):Tn(t,e,...i)}},uintBitsToFloat:{overloads:yn("uintBitsToFloat",An,0,[2]),normalizeFunc(t,e,...i){if(1!==i.length)throw new Ks("uintBitsToFloat");if(i[0]instanceof _n){if(i[0].$ast.getType().typeId!==ge.typeId)throw new Qs("uintBitsToFloat","x")}else if("number"!=typeof i[0])throw new Js("uintBitsToFloat","x");return"webgpu"===t.getDevice().type?t.$callFunctionNoCheck("bitcast<f32>",[i[0]instanceof _n?i[0].$ast:new Br(i[0],ge)],oe):Tn(t,e,...i)}},pack4x8snorm:{overloads:yn("pack4x8snorm",Mn,ge,[ue])},unpack4x8snorm:{overloads:yn("unpack4x8snorm",Mn,ue,[ge])},pack4x8unorm:{overloads:yn("pack4x8unorm",Mn,ge,[ue])},unpack4x8unorm:{overloads:yn("unpack4x8unorm",Mn,ue,[ge])},pack2x16snorm:{overloads:[...yn("pack2x16snorm",Mn,ge,[he]),...yn("packSnorm2x16",An,ge,[he])]},unpack2x16snorm:{overloads:[...yn("unpack2x16snorm",Mn,he,[ge]),...yn("unpackSnorm2x16",An,he,[ge])]},pack2x16unorm:{overloads:[...yn("pack2x16unorm",Mn,ge,[he]),...yn("packUnorm2x16",An,ge,[he])]},unpack2x16unorm:{overloads:[...yn("unpack2x16unorm",Mn,he,[ge]),...yn("unpackUnorm2x16",An,he,[ge])]},pack2x16float:{overloads:[...yn("pack2x16float",Mn,ge,[he]),...yn("packHalf2x16",An,ge,[he])]},unpack2x16float:{overloads:[...yn("unpack2x16float",Mn,he,[ge]),...yn("unpackHalf2x16",An,he,[ge])]},matrixCompMult:{overloads:vn("matrixCompMult",Rn,null,[null,null])},dpdx:{overloads:[...yn("dFdx",Rn,0,[0]),...yn("dpdx",Mn,0,[0])]},dpdy:{overloads:[...yn("dFdy",Rn,0,[0]),...yn("dpdy",Mn,0,[0])]},fwidth:{overloads:yn("fwidth",Fn,0,[0])},dpdxCoarse:{overloads:[...yn("dpdxCoarse",Mn,0,[0]),...yn("dFdx",Rn,0,[0])]},dpdxFine:{overloads:[...yn("dpdxFine",Mn,0,[0]),...yn("dFdx",Rn,0,[0])]},dpdyCoarse:{overloads:[...yn("dpdyCoarse",Mn,0,[0]),...yn("dFdy",Rn,0,[0])]},dpdyFine:{overloads:[...yn("dpdyFine",Mn,0,[0]),...yn("dFdy",Rn,0,[0])]},textureDimensions:{overloads:[...yn("textureDimensions",Mn,ge,[Le,pe]),...yn("textureDimensions",Mn,ge,[Pe,pe]),...yn("textureDimensions",Mn,ge,[Ne,pe]),...yn("textureDimensions",Mn,xe,[Be,pe]),...yn("textureDimensions",Mn,xe,[Oe,pe]),...yn("textureDimensions",Mn,xe,[Ue,pe]),...yn("textureDimensions",Mn,xe,[ke,pe]),...yn("textureDimensions",Mn,xe,[ze,pe]),...yn("textureDimensions",Mn,xe,[Ve,pe]),...yn("textureDimensions",Mn,be,[Ge,pe]),...yn("textureDimensions",Mn,be,[Xe,pe]),...yn("textureDimensions",Mn,be,[We,pe]),...yn("textureDimensions",Mn,xe,[He,pe]),...yn("textureDimensions",Mn,xe,[je,pe]),...yn("textureDimensions",Mn,xe,[qe,pe]),...yn("textureDimensions",Mn,xe,[Ze,pe]),...yn("textureDimensions",Mn,xe,[Ke,pe]),...yn("textureDimensions",Mn,xe,[Qe,pe]),...yn("textureDimensions",Mn,xe,[Je]),...yn("textureDimensions",Mn,xe,[ti]),...yn("textureDimensions",Mn,xe,[ei]),...yn("textureDimensions",Mn,xe,[fs,pe]),...yn("textureDimensions",Mn,xe,[_s,pe]),...yn("textureDimensions",Mn,xe,[gs,pe]),...yn("textureDimensions",Mn,xe,[xs,pe]),...yn("textureDimensions",Mn,xe,[bs]),...yn("textureDimensions",Mn,ge,[ii]),...yn("textureDimensions",Mn,ge,[si]),...yn("textureDimensions",Mn,ge,[ni]),...yn("textureDimensions",Mn,ge,[ai]),...yn("textureDimensions",Mn,ge,[oi]),...yn("textureDimensions",Mn,ge,[hi]),...yn("textureDimensions",Mn,ge,[li]),...yn("textureDimensions",Mn,ge,[ui]),...yn("textureDimensions",Mn,ge,[ci]),...yn("textureDimensions",Mn,ge,[di]),...yn("textureDimensions",Mn,ge,[pi]),...yn("textureDimensions",Mn,ge,[mi]),...yn("textureDimensions",Mn,ge,[fi]),...yn("textureDimensions",Mn,ge,[_i]),...yn("textureDimensions",Mn,ge,[gi]),...yn("textureDimensions",Mn,ge,[xi]),...yn("textureDimensions",Mn,xe,[bi]),...yn("textureDimensions",Mn,xe,[wi]),...yn("textureDimensions",Mn,xe,[vi]),...yn("textureDimensions",Mn,xe,[yi]),...yn("textureDimensions",Mn,xe,[Ei]),...yn("textureDimensions",Mn,xe,[Si]),...yn("textureDimensions",Mn,xe,[Ci]),...yn("textureDimensions",Mn,xe,[Ai]),...yn("textureDimensions",Mn,xe,[Mi]),...yn("textureDimensions",Mn,xe,[Ri]),...yn("textureDimensions",Mn,xe,[Fi]),...yn("textureDimensions",Mn,xe,[Ii]),...yn("textureDimensions",Mn,xe,[Di]),...yn("textureDimensions",Mn,xe,[$i]),...yn("textureDimensions",Mn,xe,[Li]),...yn("textureDimensions",Mn,xe,[Pi]),...yn("textureDimensions",Mn,xe,[Ni]),...yn("textureDimensions",Mn,xe,[Bi]),...yn("textureDimensions",Mn,xe,[Oi]),...yn("textureDimensions",Mn,xe,[Ui]),...yn("textureDimensions",Mn,xe,[ki]),...yn("textureDimensions",Mn,xe,[zi]),...yn("textureDimensions",Mn,xe,[Vi]),...yn("textureDimensions",Mn,xe,[Gi]),...yn("textureDimensions",Mn,xe,[Xi]),...yn("textureDimensions",Mn,xe,[Wi]),...yn("textureDimensions",Mn,xe,[Hi]),...yn("textureDimensions",Mn,xe,[ji]),...yn("textureDimensions",Mn,xe,[qi]),...yn("textureDimensions",Mn,xe,[Yi]),...yn("textureDimensions",Mn,xe,[Zi]),...yn("textureDimensions",Mn,xe,[Ki]),...yn("textureDimensions",Mn,be,[Qi]),...yn("textureDimensions",Mn,be,[Ji]),...yn("textureDimensions",Mn,be,[es]),...yn("textureDimensions",Mn,be,[is]),...yn("textureDimensions",Mn,be,[ss]),...yn("textureDimensions",Mn,be,[rs]),...yn("textureDimensions",Mn,be,[ns]),...yn("textureDimensions",Mn,be,[as]),...yn("textureDimensions",Mn,be,[os]),...yn("textureDimensions",Mn,be,[hs]),...yn("textureDimensions",Mn,be,[ls]),...yn("textureDimensions",Mn,be,[us]),...yn("textureDimensions",Mn,be,[cs]),...yn("textureDimensions",Mn,be,[ds]),...yn("textureDimensions",Mn,be,[ps]),...yn("textureDimensions",Mn,be,[ms]),...yn("textureSize",An,me,[Le,pe]),...yn("textureSize",An,me,[Be,pe]),...yn("textureSize",An,me,[Pe,pe]),...yn("textureSize",An,me,[Oe,pe]),...yn("textureSize",An,me,[Ne,pe]),...yn("textureSize",An,me,[Ue,pe]),...yn("textureSize",An,me,[ke,pe]),...yn("textureSize",An,me,[ze,pe]),...yn("textureSize",An,me,[Ve,pe]),...yn("textureSize",An,me,[He,pe]),...yn("textureSize",An,me,[je,pe]),...yn("textureSize",An,me,[qe,pe]),...yn("textureSize",An,fe,[Ge,pe]),...yn("textureSize",An,fe,[Xe,pe]),...yn("textureSize",An,fe,[We,pe]),...yn("textureSize",An,me,[fs,pe]),...yn("textureSize",An,me,[gs,pe]),...yn("textureSize",An,me,[_s,pe])],normalizeFunc(t,e,...i){if(i.length<1||i.length>2)throw new Ks("textureDimensions");if(!(i[0]instanceof _n))throw new Js("textureDimensions","tex");const s=i[0].$ast.getType();if(!s.isTextureType())throw new Qs("textureDimensions","tex");if("webgpu"===t.getDevice().type){if((s.isMultisampledTexture()||s.isStorageTexture())&&void 0!==i[1])throw new Js("textureDimensions","level");return Tn(t,e,...i)}if("webgl2"===t.getDevice().type){const r=i[0],n=i[1]||0;return s.is1DTexture()?Tn(t,e,r,n).x:Tn(t,e,r,n)}}},textureGather:{overloads:[...yn("textureGather",Mn,ue,[pe,Be,ws,he]),...yn("textureGather",Mn,_e,[pe,Oe,ws,he]),...yn("textureGather",Mn,we,[pe,Ue,ws,he]),...yn("textureGather",Mn,ue,[pe,He,ws,le]),...yn("textureGather",Mn,_e,[pe,je,ws,le]),...yn("textureGather",Mn,we,[pe,qe,ws,le]),...yn("textureGather",Mn,ue,[fs,ws,he]),...yn("textureGather",Mn,ue,[gs,ws,le])]},textureArrayGather:{overloads:[...yn("textureGather",Mn,ue,[pe,ke,ws,he,pe]),...yn("textureGather",Mn,_e,[pe,ze,ws,he,pe]),...yn("textureGather",Mn,we,[pe,Ve,ws,he,pe]),...yn("textureGather",Mn,ue,[pe,Ze,ws,le,pe]),...yn("textureGather",Mn,_e,[pe,Ke,ws,le,pe]),...yn("textureGather",Mn,we,[pe,Qe,ws,le,pe]),...yn("textureGather",Mn,ue,[_s,ws,he,pe]),...yn("textureGather",Mn,ue,[xs,ws,le,pe])]},textureGatherCompare:{overloads:[...yn("textureGatherCompare",Mn,ue,[fs,Ts,he,oe]),...yn("textureGatherCompare",Mn,ue,[gs,Ts,le,oe])]},textureArrayGatherCompare:{overloads:[...yn("textureGatherCompare",Mn,ue,[_s,Ts,he,pe,oe]),...yn("textureGatherCompare",Mn,ue,[xs,Ts,le,pe,oe])]},textureLoad:{overloads:[...yn("textureLoad",Mn,ue,[Le,pe,pe]),...yn("textureLoad",Mn,_e,[Pe,pe,pe]),...yn("textureLoad",Mn,we,[Ne,pe,pe]),...yn("textureLoad",Mn,ue,[ri,pe]),...yn("textureLoad",Mn,ue,[xi,pe]),...yn("textureLoad",Mn,_e,[gi,pe]),...yn("textureLoad",Mn,we,[_i,pe]),...yn("textureLoad",Mn,ue,[fi,pe]),...yn("textureLoad",Mn,_e,[mi,pe]),...yn("textureLoad",Mn,we,[pi,pe]),...yn("textureLoad",Mn,ue,[li,pe]),...yn("textureLoad",Mn,_e,[hi,pe]),...yn("textureLoad",Mn,we,[oi,pe]),...yn("textureLoad",Mn,ue,[di,pe]),...yn("textureLoad",Mn,_e,[ci,pe]),...yn("textureLoad",Mn,we,[ui,pe]),...yn("textureLoad",Mn,_e,[ai,pe]),...yn("textureLoad",Mn,we,[ni,pe]),...yn("textureLoad",Mn,ue,[si,pe]),...yn("textureLoad",Mn,ue,[ii,pe]),...yn("textureLoad",Mn,ue,[Be,me,pe]),...yn("textureLoad",Mn,_e,[Oe,me,pe]),...yn("textureLoad",Mn,we,[Ue,me,pe]),...yn("textureLoad",Mn,ue,[Ti,me]),...yn("textureLoad",Mn,ue,[Pi,me]),...yn("textureLoad",Mn,_e,[Li,me]),...yn("textureLoad",Mn,we,[$i,me]),...yn("textureLoad",Mn,ue,[Di,me]),...yn("textureLoad",Mn,_e,[Ii,me]),...yn("textureLoad",Mn,we,[Fi,me]),...yn("textureLoad",Mn,ue,[Ci,me]),...yn("textureLoad",Mn,_e,[Si,me]),...yn("textureLoad",Mn,we,[Ei,me]),...yn("textureLoad",Mn,ue,[Ri,me]),...yn("textureLoad",Mn,_e,[Mi,me]),...yn("textureLoad",Mn,we,[Ai,me]),...yn("textureLoad",Mn,_e,[yi,me]),...yn("textureLoad",Mn,we,[vi,me]),...yn("textureLoad",Mn,ue,[wi,me]),...yn("textureLoad",Mn,ue,[bi,me]),...yn("textureLoad",Mn,ue,[Ge,fe,pe]),...yn("textureLoad",Mn,_e,[Xe,fe,pe]),...yn("textureLoad",Mn,we,[We,fe,pe]),...yn("textureLoad",Mn,ue,[ts,fe]),...yn("textureLoad",Mn,ue,[ms,fe]),...yn("textureLoad",Mn,_e,[ps,fe]),...yn("textureLoad",Mn,we,[ds,fe]),...yn("textureLoad",Mn,ue,[cs,fe]),...yn("textureLoad",Mn,_e,[us,fe]),...yn("textureLoad",Mn,we,[ls,fe]),...yn("textureLoad",Mn,ue,[ns,fe]),...yn("textureLoad",Mn,_e,[rs,fe]),...yn("textureLoad",Mn,we,[ss,fe]),...yn("textureLoad",Mn,ue,[hs,fe]),...yn("textureLoad",Mn,_e,[os,fe]),...yn("textureLoad",Mn,we,[as,fe]),...yn("textureLoad",Mn,_e,[is,fe]),...yn("textureLoad",Mn,we,[es,fe]),...yn("textureLoad",Mn,ue,[Ji,fe]),...yn("textureLoad",Mn,ue,[Qi,fe]),...yn("textureLoad",Mn,ue,[Je,me,pe]),...yn("textureLoad",Mn,_e,[ti,me,pe]),...yn("textureLoad",Mn,we,[ei,me,pe]),...yn("textureLoad",Mn,ue,[Ye,me]),...yn("textureLoad",Mn,oe,[fs,me,pe]),...yn("textureLoad",Mn,oe,[bs,me,pe]),...yn("texelFetch",An,ue,[Le,me,pe]),...yn("texelFetch",An,ue,[Be,me,pe]),...yn("texelFetch",An,ue,[Ge,fe,pe]),...yn("texelFetch",An,we,[Ye,me,pe]),...yn("texelFetch",An,ue,[Pe,me,pe]),...yn("texelFetch",An,_e,[Oe,me,pe]),...yn("texelFetch",An,_e,[Xe,fe,pe]),...yn("texelFetch",An,ue,[Ne,me,pe]),...yn("texelFetch",An,we,[Ue,me,pe]),...yn("texelFetch",An,we,[We,fe,pe])],normalizeFunc(t,e,...i){if(0===i.length)throw new Ks("textureLoad");if(!(i[0]instanceof _n))throw new Js("textureLoad","tex");const s=i[0].$ast.getType();if(!s.isTextureType())throw new Qs("textureLoad","tex");if("webgl2"===t.getDevice().type){if(3!==i.length)throw new Ks("textureLoad");if(s.is1DTexture()){if("number"==typeof i[1]){if(!Number.isInteger(i[1]))throw new Qs("textureLoad","coord")}else{if(!(i[1]instanceof _n))throw new Qs("textureLoad","coord");{const t=i[1].$ast.getType();if(!t.isPrimitiveType()||!t.isScalarType()||t.scalarType!==Bt.I32)throw new Qs("textureLoad","coord")}}i[1]=t.ivec2(i[1],0)}}else"webgpu"===t.getDevice().type&&(s.isExternalTexture()&&(i=i.slice(0,2)),s.isStorageTexture()&&(s.readable=!0));return Tn(t,e,...i)}},textureArrayLoad:{overloads:[...yn("textureLoad",Mn,ue,[ke,me,pe,pe]),...yn("textureLoad",Mn,_e,[ze,me,pe,pe]),...yn("textureLoad",Mn,we,[Ve,me,pe,pe]),...yn("textureLoad",Mn,oe,[_s,me,pe,pe]),...yn("texelFetch",An,ue,[ke,fe,pe]),...yn("texelFetch",An,_e,[ze,fe,pe]),...yn("texelFetch",An,we,[Ve,fe,pe])],normalizeFunc(t,e,...i){if("webgl2"===t.getDevice().type){if(4!==i.length)throw new Ks("textureArrayLoad");const s=i[0],r=t.ivec3(i[1],i[2]);return Tn(t,e,s,r,i[3])}return Tn(t,e,...i)}},textureStore:{overloads:[...yn("textureStore",Mn,vs,[ii,ge,ue]),...yn("textureStore",Mn,vs,[si,ge,ue]),...yn("textureStore",Mn,vs,[ni,ge,we]),...yn("textureStore",Mn,vs,[ai,ge,_e]),...yn("textureStore",Mn,vs,[oi,ge,we]),...yn("textureStore",Mn,vs,[hi,ge,_e]),...yn("textureStore",Mn,vs,[li,ge,ue]),...yn("textureStore",Mn,vs,[ui,ge,we]),...yn("textureStore",Mn,vs,[ci,ge,_e]),...yn("textureStore",Mn,vs,[di,ge,ue]),...yn("textureStore",Mn,vs,[pi,ge,we]),...yn("textureStore",Mn,vs,[mi,ge,_e]),...yn("textureStore",Mn,vs,[fi,ge,ue]),...yn("textureStore",Mn,vs,[_i,ge,we]),...yn("textureStore",Mn,vs,[gi,ge,_e]),...yn("textureStore",Mn,vs,[xi,ge,ue]),...yn("textureStore",Mn,vs,[bi,xe,ue]),...yn("textureStore",Mn,vs,[wi,xe,ue]),...yn("textureStore",Mn,vs,[vi,xe,we]),...yn("textureStore",Mn,vs,[yi,xe,_e]),...yn("textureStore",Mn,vs,[Ei,xe,we]),...yn("textureStore",Mn,vs,[Si,xe,_e]),...yn("textureStore",Mn,vs,[Ci,xe,ue]),...yn("textureStore",Mn,vs,[Ai,xe,we]),...yn("textureStore",Mn,vs,[Mi,xe,_e]),...yn("textureStore",Mn,vs,[Ri,xe,ue]),...yn("textureStore",Mn,vs,[Fi,xe,we]),...yn("textureStore",Mn,vs,[Ii,xe,_e]),...yn("textureStore",Mn,vs,[Di,xe,ue]),...yn("textureStore",Mn,vs,[$i,xe,we]),...yn("textureStore",Mn,vs,[$i,me,we]),...yn("textureStore",Mn,vs,[Li,xe,_e]),...yn("textureStore",Mn,vs,[Pi,xe,ue]),...yn("textureStore",Mn,vs,[Qi,be,ue]),...yn("textureStore",Mn,vs,[Ji,be,ue]),...yn("textureStore",Mn,vs,[es,be,we]),...yn("textureStore",Mn,vs,[is,be,_e]),...yn("textureStore",Mn,vs,[ss,be,we]),...yn("textureStore",Mn,vs,[rs,be,_e]),...yn("textureStore",Mn,vs,[ns,be,ue]),...yn("textureStore",Mn,vs,[as,be,we]),...yn("textureStore",Mn,vs,[os,be,_e]),...yn("textureStore",Mn,vs,[hs,be,ue]),...yn("textureStore",Mn,vs,[ls,be,we]),...yn("textureStore",Mn,vs,[us,be,_e]),...yn("textureStore",Mn,vs,[cs,be,ue]),...yn("textureStore",Mn,vs,[ds,be,we]),...yn("textureStore",Mn,vs,[ps,be,_e]),...yn("textureStore",Mn,vs,[ms,be,ue])],normalizeFunc(t,e,...i){if("webgpu"===t.getDevice().type){const t=i[0];if(t instanceof _n){const e=t.$ast.getType();e?.isTextureType()&&e.isStorageTexture()&&(e.writable=!0)}}return Tn(t,e,...i)}},textureArrayStore:{overloads:[...yn("textureStore",Mn,vs,[Ni,me,pe,ue]),...yn("textureStore",Mn,vs,[Bi,me,pe,ue]),...yn("textureStore",Mn,vs,[Oi,me,pe,we]),...yn("textureStore",Mn,vs,[Ui,me,pe,_e]),...yn("textureStore",Mn,vs,[ki,me,pe,we]),...yn("textureStore",Mn,vs,[zi,me,pe,_e]),...yn("textureStore",Mn,vs,[Vi,me,pe,ue]),...yn("textureStore",Mn,vs,[Gi,me,pe,we]),...yn("textureStore",Mn,vs,[Xi,me,pe,_e]),...yn("textureStore",Mn,vs,[Wi,me,pe,ue]),...yn("textureStore",Mn,vs,[Hi,me,pe,we]),...yn("textureStore",Mn,vs,[ji,me,pe,_e]),...yn("textureStore",Mn,vs,[qi,me,pe,ue]),...yn("textureStore",Mn,vs,[Yi,me,pe,we]),...yn("textureStore",Mn,vs,[Zi,me,pe,_e]),...yn("textureStore",Mn,vs,[Ki,me,pe,ue])]},textureNumLayers:{overloads:[...yn("textureNumLayers",Mn,pe,[ke]),...yn("textureNumLayers",Mn,pe,[ze]),...yn("textureNumLayers",Mn,pe,[Ve]),...yn("textureNumLayers",Mn,pe,[Ze]),...yn("textureNumLayers",Mn,pe,[Ke]),...yn("textureNumLayers",Mn,pe,[Qe]),...yn("textureNumLayers",Mn,pe,[_s]),...yn("textureNumLayers",Mn,pe,[xs]),...yn("textureNumLayers",Mn,pe,[Ki]),...yn("textureNumLayers",Mn,pe,[Zi]),...yn("textureNumLayers",Mn,pe,[Yi]),...yn("textureNumLayers",Mn,pe,[qi]),...yn("textureNumLayers",Mn,pe,[ji]),...yn("textureNumLayers",Mn,pe,[Hi]),...yn("textureNumLayers",Mn,pe,[Vi]),...yn("textureNumLayers",Mn,pe,[zi]),...yn("textureNumLayers",Mn,pe,[ki]),...yn("textureNumLayers",Mn,pe,[Wi]),...yn("textureNumLayers",Mn,pe,[Xi]),...yn("textureNumLayers",Mn,pe,[Gi]),...yn("textureNumLayers",Mn,pe,[Ui]),...yn("textureNumLayers",Mn,pe,[Bi]),...yn("textureNumLayers",Mn,pe,[Oi]),...yn("textureNumLayers",Mn,pe,[Ni])]},textureNumLevels:{overloads:[...yn("textureNumLevels",Mn,pe,[Le]),...yn("textureNumLevels",Mn,pe,[Pe]),...yn("textureNumLevels",Mn,pe,[Ne]),...yn("textureNumLevels",Mn,pe,[Be]),...yn("textureNumLevels",Mn,pe,[Oe]),...yn("textureNumLevels",Mn,pe,[Ue]),...yn("textureNumLevels",Mn,pe,[ke]),...yn("textureNumLevels",Mn,pe,[ze]),...yn("textureNumLevels",Mn,pe,[Ve]),...yn("textureNumLevels",Mn,pe,[Ge]),...yn("textureNumLevels",Mn,pe,[Xe]),...yn("textureNumLevels",Mn,pe,[We]),...yn("textureNumLevels",Mn,pe,[He]),...yn("textureNumLevels",Mn,pe,[je]),...yn("textureNumLevels",Mn,pe,[qe]),...yn("textureNumLevels",Mn,pe,[Ze]),...yn("textureNumLevels",Mn,pe,[Ke]),...yn("textureNumLevels",Mn,pe,[Qe]),...yn("textureNumLevels",Mn,pe,[fs]),...yn("textureNumLevels",Mn,pe,[_s]),...yn("textureNumLevels",Mn,pe,[gs]),...yn("textureNumLevels",Mn,pe,[xs])]},textureNumSamples:{overloads:[...yn("textureNumSamples",Mn,pe,[Je]),...yn("textureNumSamples",Mn,pe,[ti]),...yn("textureNumSamples",Mn,pe,[ei]),...yn("textureNumSamples",Mn,pe,[bs])]},textureSample:{overloads:[...yn("textureSample",Mn,ue,[Le,ws,oe]),...yn("textureSample",Mn,ue,[Be,ws,he]),...yn("textureSample",Mn,ue,[Ge,ws,le]),...yn("textureSample",Mn,ue,[He,ws,le]),...yn("textureSample",Mn,oe,[fs,ws,he]),...yn("textureSample",Mn,oe,[gs,ws,le]),...yn("textureSampleBaseClampToEdge",Mn,ue,[Ye,ws,he]),...yn("texture",An,ue,[Le,he]),...yn("texture",An,ue,[Be,he]),...yn("texture",An,ue,[Ye,he]),...yn("texture",An,ue,[fs,he]),...yn("texture",An,ue,[Ge,le]),...yn("texture",An,ue,[He,le]),...yn("texture",An,ue,[gs,le]),...yn("texture2D",Cn,ue,[Le,he]),...yn("texture2D",Cn,ue,[Be,he]),...yn("texture2D",Cn,ue,[Ye,he]),...yn("texture2D",Cn,ue,[fs,he]),...yn("textureCube",Cn,ue,[He,le]),...yn("textureCube",Cn,ue,[gs,le])],normalizeFunc(t,e,...i){if(2!==i.length)throw new Ks("textureSample");const s=i[0];if(!(s instanceof _n))throw new Qs("textureSample","texture");const r=s.$ast.getType();if(!r.isTextureType())throw new Qs("textureSample","texture");if("webgpu"===t.getDevice().type){if(r.isStorageTexture())throw new Qs("textureSample","texture");const n=t.getDefaultSampler(s,!1),a=Tn(t,e,s,n,i[1]);return a.$ast.getType().isCompatibleType(oe)?t.vec4(a):a}if(t.getDefaultSampler(s,!1),r.is1DTexture()){if(i[1]instanceof _n){const t=i[1].$ast.getType();if(!t.isPrimitiveType()||!t.isScalarType()||t.scalarType!==Bt.F32)throw new Qs("textureSample","coord")}else if("number"!=typeof i[1])throw new Qs("textureSample","coord");i[1]=t.vec2(i[1],0)}return Tn(t,e,...i)}},textureArraySample:{overloads:[...yn("textureSample",Mn,ue,[ke,ws,he,pe]),...yn("textureSample",Mn,ue,[Ze,ws,le,pe]),...yn("textureSample",Mn,oe,[_s,ws,he,pe]),...yn("textureSample",Mn,oe,[xs,ws,le,pe]),...yn("texture",An,ue,[ke,le]),...yn("texture",An,ue,[_s,le])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Ks("textureArraySample");const s=i[0];if(!(s instanceof _n))throw new Qs("textureArraySample","texture");if(!s.$ast.getType().isTextureType())throw new Qs("textureArraySample","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1),n=Tn(t,e,s,r,i[1],i[2]);return n.$ast.getType().isCompatibleType(oe)?t.vec4(n):n}{t.getDefaultSampler(s,!1);const r=i[1],n=i[2],a=t.vec3(r,t.float(n));return Tn(t,e,s,a)}}},textureSampleBias:{overloads:[...yn("textureSampleBias",Mn,ue,[Be,ws,he,oe]),...yn("textureSampleBias",Mn,ue,[Ge,ws,le,oe]),...yn("textureSampleBias",Mn,ue,[He,ws,le,oe]),...yn("texture",An,ue,[Be,he,oe]),...yn("texture",An,ue,[Ge,le,oe]),...yn("texture",An,ue,[He,le,oe]),...yn("texture2D",Cn,ue,[Be,he,oe]),...yn("textureCube",Cn,ue,[He,le,oe])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Ks("textureSampleBias");const s=i[0];if(!(s instanceof _n))throw new Qs("textureSampleBias","texture");if(!s.$ast.getType().isTextureType())throw new Qs("textureSampleBias","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return Tn(t,e,s,r,i[1],i[2])}return t.getDefaultSampler(s,!1),Tn(t,e,...i)}},textureArraySampleBias:{overloads:[...yn("textureSampleBias",Mn,ue,[ke,ws,he,pe,oe]),...yn("textureSampleBias",Mn,ue,[Ze,ws,le,pe,oe]),...yn("texture",An,ue,[ke,le,oe])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Ks("textureArraySampleBias");const s=i[0];if(!(s instanceof _n))throw new Qs("textureArraySampleBias","texture");if(!s.$ast.getType().isTextureType())throw new Qs("textureArraySampleBias","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return Tn(t,e,s,r,i[1],i[2],i[3])}if("webgl2"===t.getDevice().type){t.getDefaultSampler(s,!1);const r=i[1],n=i[2],a=t.vec3(r,t.float(n));return Tn(t,e,s,a,i[3])}}},textureSampleCompare:{overloads:[...yn("textureSampleCompare",Mn,oe,[fs,Ts,he,oe]),...yn("textureSampleCompare",Mn,oe,[gs,Ts,le,oe]),...yn("texture",An,oe,[fs,le]),...yn("texture",An,oe,[gs,ue])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Ks("textureSampleCompare");const s=i[0];if(!(s instanceof _n))throw new Qs("textureSampleCompare","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Qs("textureSampleCompare","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(i[0],!0);return Tn(t,e,s,r,i[1],i[2])}{let n;return t.getDefaultSampler(i[0],!0),n=r.isCubeTexture()||r.isArrayTexture()?t.vec4(i[1],i[2]):t.vec3(i[1],i[2]),Tn(t,e,s,n)}}},textureArraySampleCompare:{overloads:[...yn("textureSampleCompare",Mn,oe,[_s,Ts,he,pe,oe]),...yn("textureSampleCompare",Mn,oe,[xs,Ts,le,pe,oe]),...yn("texture",An,oe,[_s,ue])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Ks("textureArraySampleCompare");const s=i[0];if(!(s instanceof _n))throw new Qs("textureArraySampleCompare","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Qs("textureArraySampleCompare","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(i[0],!0);return Tn(t,e,s,r,i[1],i[2],i[3])}{t.getDefaultSampler(i[0],!0);const r=t.vec4(i[1],t.float(i[2]),i[3]);return Tn(t,e,s,r)}}},textureSampleLevel:{overloads:[...yn("textureSampleLevel",Mn,ue,[Be,ws,he,oe]),...yn("textureSampleLevel",Mn,ue,[Ge,ws,le,oe]),...yn("textureSampleLevel",Mn,ue,[He,ws,le,oe]),...yn("textureSampleLevel",Mn,ue,[Ye,ws,he]),...yn("textureSampleLevel",Mn,oe,[fs,ws,he,pe]),...yn("textureSampleLevel",Mn,oe,[gs,ws,le,pe]),...yn("textureLod",An,ue,[Be,he,oe]),...yn("textureLod",An,ue,[fs,he,oe]),...yn("textureLod",An,ue,[Ye,he,oe]),...yn("textureLod",An,ue,[Ge,le,oe]),...yn("textureLod",An,ue,[He,le,oe]),...yn("textureLod",An,ue,[gs,le,oe]),...yn("texture2DLodEXT",Cn,ue,[Be,he,oe]),...yn("texture2DLodEXT",Cn,ue,[fs,he,oe]),...yn("texture2DLodEXT",Cn,ue,[Ye,he,oe]),...yn("textureCubeLodEXT",Cn,ue,[He,le,oe]),...yn("textureCubeLodEXT",Cn,ue,[gs,le,oe])],normalizeFunc(t,e,...i){const s=i[0];if(!(s instanceof _n))throw new Qs("textureSampleLevel","texture");const r=s.$ast.getType();if(!r.isTextureType())throw new Qs("textureSampleLevel","texture");if("webgl"===t.getDevice().type&&"vertex"===t.shaderKind)return t.textureSample(s,i[1]);if("webgpu"===t.getDevice().type){if(r.isExternalTexture())return t.textureLoad(s,t.ivec2(i[1]),0);{const n=t.getDefaultSampler(s,!1),a=r.isDepthTexture()&&("number"==typeof i[2]||i[2]instanceof _n&&i[2].$ast.getType().isCompatibleType(oe))?t.int(i[2]):i[2],o=r.isExternalTexture()?Tn(t,e,s,n,i[1]):Tn(t,e,s,n,i[1],a);return o.$ast.getType().isCompatibleType(oe)?t.vec4(o):o}}return t.getDefaultSampler(s,!1),r.isExternalTexture()?Tn(t,e,i[0],i[1],0):Tn(t,e,i[0],i[1],i[2])}},textureArraySampleLevel:{overloads:[...yn("textureSampleLevel",Mn,ue,[ke,ws,he,pe,oe]),...yn("textureSampleLevel",Mn,ue,[Ze,ws,le,pe,oe]),...yn("textureSampleLevel",Mn,oe,[_s,ws,he,pe,pe]),...yn("textureSampleLevel",Mn,oe,[xs,ws,le,pe,pe]),...yn("textureLod",An,ue,[ke,le,oe])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Ks("textureArraySampleLevel");const s=i[0];if(!(s instanceof _n))throw new Qs("textureArraySampleLevel","texture");const r=s.$ast.getType();if(!r.isTextureType())throw new Qs("textureArraySampleLevel","texture");if("webgpu"===t.getDevice().type){const n=t.getDefaultSampler(s,!1),a=r.isDepthTexture()&&("number"==typeof i[3]||i[3]instanceof _n&&i[3].$ast.getType().isCompatibleType(oe))?t.int(i[3]):i[3],o=Tn(t,e,s,n,i[1],i[2],a);return o.$ast.getType().isCompatibleType(oe)?t.vec4(o):o}{t.getDefaultSampler(s,!1);const r=t.vec3(i[1],t.float(i[2]));return Tn(t,e,s,r,i[3])}}},textureSampleCompareLevel:{overloads:[...yn("textureSampleCompareLevel",Mn,oe,[fs,Ts,he,oe]),...yn("textureSampleCompareLevel",Mn,oe,[gs,Ts,le,oe]),...yn("textureLod",An,oe,[fs,le,oe]),...yn("texture",An,oe,[gs,ue])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Ks("textureSampleCompareLevel");const s=i[0];if(!(s instanceof _n))throw new Qs("textureSampleCompareLevel","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Qs("textureSampleCompareLevel","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!0);return Tn(t,e,s,r,i[1],i[2])}{let n;return t.getDefaultSampler(i[0],!0),n=r.isCubeTexture()||r.isArrayTexture()?t.vec4(i[1],i[2]):t.vec3(i[1],i[2]),r.isCubeTexture()?Tn(t,e,s,n):Tn(t,e,s,n,0)}}},textureArraySampleCompareLevel:{overloads:[...yn("textureSampleCompareLevel",Mn,oe,[_s,Ts,he,pe,oe]),...yn("textureSampleCompareLevel",Mn,oe,[xs,Ts,le,pe,oe]),...yn("texture",An,oe,[_s,ue])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Ks("textureArraySampleCompareLevel");const s=i[0];if(!(s instanceof _n))throw new Qs("textureArraySampleCompareLevel","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Qs("textureArraySampleCompareLevel","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!0);return Tn(t,e,s,r,i[1],i[2],i[3])}{t.getDefaultSampler(i[0],!0);const r=t.vec4(i[1],t.float(i[2]),i[3]);return Tn(t,e,s,r)}}},textureSampleGrad:{overloads:[...yn("textureSampleGrad",Mn,ue,[Be,ws,he,he,he]),...yn("textureSampleGrad",Mn,ue,[Ge,ws,le,le,le]),...yn("textureSampleGrad",Mn,ue,[He,ws,le,le,le]),...yn("textureGrad",An,ue,[Be,he,he,he]),...yn("textureGrad",An,ue,[Ge,le,le,le]),...yn("textureGrad",An,ue,[He,le,le,le]),...yn("texture2DGradEXT",Cn,ue,[Be,he,he,he]),...yn("textureCubeGradEXT",Cn,ue,[He,le,le,le])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Ks("textureSampleGrad");const s=i[0];if(!(s instanceof _n))throw new Qs("textureSampleGrad","texture");if(!s.$ast.getType().isTextureType())throw new Qs("textureSampleGrad","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return Tn(t,e,s,r,i[1],i[2],i[3])}return t.getDefaultSampler(s,!1),Tn(t,e,...i)}},textureArraySampleGrad:{overloads:[...yn("textureSampleGrad",Mn,ue,[ke,ws,he,pe,he,he]),...yn("textureSampleGrad",Mn,ue,[Ze,ws,le,pe,le,le]),...yn("textureGrad",An,ue,[ke,le,he,he])],normalizeFunc(t,e,...i){if(5!==i.length)throw new Ks("textureArraySampleGrad");const s=i[0];if(!(s instanceof _n))throw new Qs("textureArraySampleGrad","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isArrayTexture())throw new Qs("textureArraySampleGrad","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return Tn(t,e,s,r,i[1],i[2],i[3],i[4])}{t.getDefaultSampler(s,!1);const r=t.vec3(i[1],t.float(i[2]));return Tn(t,e,s,r,i[3],i[4])}}},storageBarrier:{overloads:yn("storageBarrier",Mn,vs,[])},workgroupBarrier:{overloads:yn("workgroupBarrier",Mn,vs,[])},atomicLoad:{overloades:[],normalizeFunc(t,e,...i){if(1!==i.length)throw new Ks(e);const s=i[0];if(!(s instanceof _n))throw new Qs(e,"ptr");if(s.$ast.getType().typeId===ce.typeId)return t.$callFunctionNoCheck(e,[new kr(s.$ast)],pe);if(s.$ast.getType().typeId===de.typeId)return t.$callFunctionNoCheck(e,[new kr(s.$ast)],ge);throw new Js(e,"ptr must be atomic type")}},atomicStore:{overloades:[],normalizeFunc(t,e,...i){if(2!==i.length)throw new Ks(e);const s=i[0],r=i[1];if(!(s instanceof _n))throw new Qs(e,"ptr");if(s.$ast.getType().typeId===ce.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Js(e,"value");return t.$callFunctionNoCheck(e,[new kr(s.$ast),new Br(r,pe)],vs)}if(r instanceof _n){if(r.$ast.getType().typeId!==pe.typeId)throw new Qs(e,"value");return t.$callFunctionNoCheck(e,[new kr(s.$ast),r.$ast],vs)}throw new Qs(e,"value")}if(s.$ast.getType().typeId===de.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Js(e,"value");return t.$callFunctionNoCheck(e,[new kr(s.$ast),new Br(r,ge)],vs)}if(r instanceof _n){if(r.$ast.getType().typeId!==ge.typeId)throw new Qs(e,"value");return t.$callFunctionNoCheck(e,[new kr(s.$ast),r.$ast],vs)}throw new Qs(e,"value")}throw new Js(e,"ptr must be atomic type")}}};for(const t of["atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange"])In[t]={overloades:[],normalizeFunc(t,e,...i){if(2!==i.length)throw new Ks(e);const s=i[0],r=i[1];if(!(s instanceof _n))throw new Qs(e,"ptr");if(s.$ast.getType().typeId===ce.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Js(e,"value");return t.$callFunctionNoCheck(e,[new kr(s.$ast),new Br(r,pe)],pe)}if(r instanceof _n){if(r.$ast.getType().typeId!==pe.typeId)throw new Qs(e,"value");return t.$callFunctionNoCheck(e,[new kr(s.$ast),r.$ast],pe)}throw new Qs(e,"value")}if(s.$ast.getType().typeId===de.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Js(e,"value");return t.$callFunctionNoCheck(e,[new kr(s.$ast),new Br(r,ge)],ge)}if(r instanceof _n){if(r.$ast.getType().typeId!==ge.typeId)throw new Qs(e,"value");return t.$callFunctionNoCheck(e,[new kr(s.$ast),r.$ast],ge)}throw new Qs(e,"value")}throw new Js(e,"ptr must be atomic type")}};const Dn={rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",rgba8uint:"rgba8ui",rgba8sint:"rgba8i",rgba16uint:"rgba16ui",rgba16sint:"rgba16i",rgba16float:"rgba16f",r32float:"r32f",r32uint:"r32ui",r32sint:"r32i",rg32float:"rg32f",rg32uint:"rg32ui",rg32sint:"rg32i",rgba32float:"rgba32f",rgba32uint:"rgba32ui",rgba32sint:"rgba32i"};function $n(t,...e){if("webgl"===this.getDevice().type){if(t.scalarType===Bt.U32)throw new sr("unsigned integer type");if(t.isMatrixType()&&t.cols!==t.rows)throw new sr("non-square matrix type")}if(1===e.length&&"string"==typeof e[0])return new _n(e[0],t);{const i=new _n("",t);return!t.isScalarType()||1!==e.length||"number"!=typeof e[0]&&"boolean"!=typeof e[0]?i.$ast=new Nr(i.$typeinfo,e.map((t=>{if("string"==typeof t)throw new Qs("vec_n");return t instanceof _n?t.$ast:t}))):i.$ast=new Br(e[0],t),i}}const Ln={float:oe,int:pe,uint:ge,bool:Te,vec2:he,ivec2:me,uvec2:xe,bvec2:ve,vec3:le,ivec3:fe,uvec3:be,bvec3:ye,vec4:ue,ivec4:_e,uvec4:we,bvec4:Ee,mat2:Se,mat2x3:Ce,mat2x4:Ae,mat3x2:Me,mat3:Re,mat3x4:Fe,mat4x2:Ie,mat4x3:De,mat4:$e},Pn={tex1D:Le,tex2D:Be,tex3D:Ge,texCube:He,tex2DShadow:fs,texCubeShadow:gs,tex2DArray:ke,tex2DArrayShadow:_s,texExternal:Ye,itex1D:Pe,itex2D:Oe,itex3D:Xe,itexCube:je,itex2DArray:ze,utex1D:Ne,utex2D:Ue,utex3D:We,utexCube:qe,utex2DArray:Ve,sampler:ws,samplerComparison:Ts};const Nn={texStorage1D:Wt.TEX_STORAGE_1D,texStorage2D:Wt.TEX_STORAGE_2D,texStorage2DArray:Wt.TEX_STORAGE_2D_ARRAY,texStorage3D:Wt.TEX_STORAGE_3D};const Bn="zVSInput_",On="zVSOutput_";class Un{_device;_workgroupSize;_scopeStack=[];_shaderType=Et.Vertex|Et.Fragment|Et.Compute;_structInfo;_uniforms;_globalScope;_builtinScope;_inputScope;_outputScope;_inputs;_outputs;_vertexAttributes;_depthRangeCorrection;_emulateDepthClamp;_lastError;_reflection;_autoStructureTypeIndex;_nameMap;constructor(t){this._device=t,this._workgroupSize=null,this._structInfo={},this._uniforms=[],this._scopeStack=[],this._globalScope=null,this._builtinScope=null,this._inputScope=null,this._outputScope=null,this._inputs=[],this._outputs=[],this._vertexAttributes=[],this._depthRangeCorrection="webgpu"===t.type,this._emulateDepthClamp=!1,this._lastError=null,this._reflection=new hn(this),this._autoStructureTypeIndex=0,this._nameMap=[]}get lastError(){return this._lastError}get shaderType(){return this._shaderType}get shaderKind(){return this._shaderType===Et.Vertex?"vertex":this._shaderType===Et.Fragment?"fragment":this._shaderType===Et.Compute?"compute":null}getGlobalScope(){return this._globalScope}get builtinScope(){return this._builtinScope}get inputScope(){return this._inputScope}get outputScope(){return this._outputScope}get depthRangeCorrection(){return this._depthRangeCorrection}get emulateDepthClamp(){return this._emulateDepthClamp}set emulateDepthClamp(t){this._emulateDepthClamp=t}getReflection(){return this._reflection}getDevice(){return this._device}reset(){this._workgroupSize=null,this._structInfo={},this._uniforms=[],this._scopeStack=[],this._globalScope=null,this._builtinScope=null,this._inputScope=null,this._outputScope=null,this._inputs=[],this._outputs=[],this._vertexAttributes=[],this._depthRangeCorrection="webgpu"===this._device.type,this._reflection=new hn(this),this._autoStructureTypeIndex=0,this._nameMap=[]}queryGlobal(t){return this.getReflection().tag(t)}pushScope(t){this._scopeStack.unshift(t)}popScope(){return this._scopeStack.shift()}getCurrentScope(){return this._scopeStack[0]}getCurrentFunctionScope(){let t=this.getCurrentScope();for(;t&&!(t instanceof jn);)t=t.$parent;return t}buildRender(t){cn(this),this._lastError=null,this.defineInternalStructs();const e=this.buildRenderSource(t);return cn(null),this.reset(),e}buildCompute(t){cn(this),this._lastError=null,this._workgroupSize=t.workgroupSize,this.defineInternalStructs();const e=this.buildComputeSource(t);return cn(null),this.reset(),e}buildRenderProgram(t){const e=this.buildRender(t);return e?this._device.createGPUProgram({type:"render",label:t.label,params:{vs:e[0],fs:e[1],bindGroupLayouts:e[2],vertexAttributes:e[3]}}):null}buildComputeProgram(t){const e=this.buildCompute(t);return e?this._device.createGPUProgram({type:"compute",params:{source:e[0],bindGroupLayouts:e[1]}}):null}func(t,e,i){this.getGlobalScope().$createFunctionIfNotExists(t,e,i)}main(t){this.getGlobalScope().$mainFunc(t)}addressOf(t){if("webgpu"!==this._device.type)throw new sr("pointer shader type");if(!t.$ast.isReference())throw new er(t);const e=new _n("",t.$ast.getType());return e.$ast=new kr(t.$ast),e}referenceOf(t){if("webgpu"!==this._device.type)throw new sr("pointer shader type");if(!t.$ast.getType().isPointerType())throw new ir(t);const e=new zr(t.$ast),i=new _n("",e.getType());return i.$ast=e,i}struct(t,e){let i=null;for(const e of[Et.Vertex,Et.Fragment,Et.Compute])if(e&this._shaderType){const s=this._structInfo[e];if(i=s?.structs[t],i)break}if(!i)throw new Js("struct","structName",`Struct type ${t} not exists`);return i.call(this,e)}isIdenticalStruct(t,e,i){if(i&&t.structName&&e.structName&&t.structName!==e.structName)return!1;if(t.structMembers.length!==e.structMembers.length)return!1;for(let i=0;i<t.structMembers.length;i++){const s=t.structMembers[i],r=e.structMembers[i];if(s.name!==r.name)return!1;if(s.type.isStructType()){if(!r.type.isStructType())return!1;if(!this.isIdenticalStruct(s.type,r.type,!0))return!1}else if(!s.type.isCompatibleType(r.type))return!1}return!0}generateStructureName(){return"zStruct"+this._autoStructureTypeIndex++}getVertexAttributes(){return this._vertexAttributes}defineHiddenStruct(t){for(const e of[Et.Vertex,Et.Fragment,Et.Compute]){let i=this._structInfo[e];if(i||(i={structs:{},types:[]},this._structInfo[e]=i),i.structs[t.structName])throw new Js("defineStruct","structName",`cannot re-define struct '${t.structName}'`);i.types.push(new an(t,!0))}}defineStruct(t,e){const i="default",s=new ee(e??"",i,t.map((t=>{if(!(t.$typeinfo.isPrimitiveType()||t.$typeinfo.isArrayType()||t.$typeinfo.isStructType()||t.$typeinfo.isAtomicI32()||t.$typeinfo.isAtomicU32()))throw new Error(`invalid struct member type: '${t.$str}'`);return{name:t.$str,type:t.$typeinfo}})));for(const t of[Et.Vertex,Et.Fragment,Et.Compute]){let e=null,r=null;const n=this._structInfo[t];if(n){if(dn().shaderType===t&&n.structs[s.structName])throw new Js("defineStruct","structName",`cannot re-define struct '${s.structName}'`);for(const t of n.types)if(!t.builtin&&this.isIdenticalStruct(t.getType(),s,!1)){e=t,r=n.structs[t.getType().structName];break}}if(e){if(e.type.layout!==i)throw new Error(`Can not redefine struct ${e.type.structName} with different layout`);return t!==dn().shaderType&&(this._structInfo[dn().shaderType]||(this._structInfo[dn().shaderType]={structs:{},types:[]}),this._structInfo[dn().shaderType].types.indexOf(e)<0&&(this._structInfo[dn().shaderType].types.push(e),this._structInfo[dn().shaderType].structs[e.getType().structName]=r)),r}}return this.internalDefineStruct(e??this.generateStructureName(),i,this._shaderType,!1,...t)}defineStructByType(t){const e=t.extends(t.structName||this.generateStructureName(),[]);for(const t of[Et.Vertex,Et.Fragment,Et.Compute]){let i=null,s=null;const r=this._structInfo[t];if(r){if(dn().shaderType===t&&r.structs[e.structName])throw new Js("defineStruct","structName",`cannot re-define struct '${e.structName}'`);for(const t of r.types)if(!t.builtin&&this.isIdenticalStruct(t.getType(),e,!1)){i=t,s=r.structs[t.getType().structName];break}}if(i){if(i.type.layout!==e.layout)throw new Error(`Can not redefine struct ${i.type.structName} with different layout`);return t!==dn().shaderType&&(this._structInfo[dn().shaderType]||(this._structInfo[dn().shaderType]={structs:{},types:[]}),this._structInfo[dn().shaderType].types.push(i),this._structInfo[dn().shaderType].structs[i.getType().structName]=s),s}}return this.internalDefineStructByType(this._shaderType,!1,e)}internalDefineStruct(t,e,i,s,...r){const n=new ee(t,e,r.map((t=>{if(!(t.$typeinfo.isPrimitiveType()||t.$typeinfo.isArrayType()||t.$typeinfo.isStructType()||t.$typeinfo.isAtomicI32()||t.$typeinfo.isAtomicU32()))throw new Error(`invalid struct member type: '${t.$str}'`);return{name:t.$str,type:t.$typeinfo}})));return this.internalDefineStructByType(i,s,n)}internalDefineStructByType(t,e,i){const s=pn((function(...t){let e;return 1===t.length&&"string"==typeof t[0]?e=new _n(t[0],i):(e=new _n("",i),e.$ast=new Nr(e.$typeinfo,t.map((t=>t instanceof _n?t.$ast:t)))),e}),i);for(const r of[Et.Vertex,Et.Fragment,Et.Compute])if(t&r){let t=this._structInfo[r];if(t||(t={structs:{},types:[]},this._structInfo[r]=t),t.structs[i.structName])throw new Js("defineStruct","structName",`cannot re-define struct '${i.structName}'`);t.types.push(new an(i,e)),t.structs[i.structName]=s}return s}getFunction(t){return this._globalScope?this._globalScope.$getFunctions(t):null}get structInfo(){return this._structInfo[this._shaderType]}getBlockName(t){return`ch_block_name_${t}`}defineBuiltinStruct(t,e){const i="in"===e?gr(t):function(t){switch(t){case Et.Vertex:return hr;case Et.Fragment:return ur;case Et.Compute:return"zCSOutput";default:return null}}(t),s="in"===e?fr(t):_r(t),r=t===Et.Vertex?"vertex":t===Et.Fragment?"fragment":"compute",n=br.webgpu,a=[],o=[];for(const t in n)n[t].stage===r&&n[t].inOrOut===e&&(a.push({name:n[t].name,type:n[t].type}),o.push(`@builtin(${n[t].semantic}) `));const h="in"===e?this._inputs:this._outputs;for(const t of h){if(!(t[1]instanceof Jr))throw new ar("defineBuiltinStruct() failed: input/output is not declare var ast node");const e=t[1].value.getType();if(!e.isPrimitiveType()&&!e.isArrayType()&&!e.isStructType())throw new Error(`invalid in/out variable type: '${t[1].value.name}'`);a.push({name:t[1].value.name,type:e}),o.push(`@location(${t[1].value.value.$location}) ${e.isPrimitiveType()&&e.isInteger()?"@interpolate(flat) ":""}`)}if(a.length>0){const r=this.findStructType(i,t);if(r)return r.getType().reset(i,"default",a),r.prefix=o,null;{const r=this.internalDefineStructByType(this._shaderType,!1,new ee(i,"default",a));this.findStructType(i,t).prefix=o;const n=this.struct(i,s);return[r,n,i,"in"===e?this.struct(i,mr(t)):n]}}return null}defineInternalStructs(){this.defineHiddenStruct(ys),this.defineHiddenStruct(Es),this.defineHiddenStruct(Ss),this.defineHiddenStruct(Cs)}array(...t){if(0===t.length)throw new Ks("array");t=t.map((t=>this.normalizeExpValue(t)));let e=!0,i=null,s=!0,r=!0,n=!0,a=!0,o=!1;for(const s of t)if(s instanceof _n){const t=s.$ast.getType();if(!t.isConstructible()){e=!1;break}i?t.isCompatibleType(i)||(e=!1):i=t}if(e){i&&i.isPrimitiveType()&&i.isScalarType()?(s=i.primitiveType===Bt.BOOL,r=i.primitiveType===Bt.F32,a=i.primitiveType===Bt.U32,n=i.primitiveType===Bt.I32):i&&(s=!1,r=!1,a=!1,n=!1,o=!0);for(const i of t){if(!(i instanceof _n)&&o){e=!1;break}"number"==typeof i?(s=!1,(0|i)===i&&(i<0?(a=!1,n=n&&i>=-2147483648):(a=a&&i<=4294967295,n=n&&i<=2147483647))):"boolean"==typeof i&&(r=!1,n=!1,a=!1)}}if(e&&!o&&(s?i=Te:n?i=pe:a?i=ge:r&&(i=oe),e=!!i),!e)throw new Qs("array");if(!i.isPrimitiveType()&&!i.isArrayType()&&!i.isStructType())throw new Qs("array");const h=new ie(i,t.length),l=new _n("",h);return l.$ast=new Nr(h,t.map((t=>{if(t instanceof _n)return t.$ast;if(!i.isPrimitiveType()||!i.isScalarType())throw new Zs(t,typeof t,i);return new Br(t,i)}))),l}discard(){this.getCurrentScope().$ast.statements.push(new qr)}tagShaderExp(t,e){if("string"==typeof e)this._reflection.tag(e,t);else if(Array.isArray(e))e.forEach((e=>this.tagShaderExp(t,e)));else for(const i of Object.keys(e))this.tagShaderExp((e=>t(e)[i]),e[i])}in(t,e,i){this._inputs[t]?this._inputScope[e]||Object.defineProperty(this._inputScope,e,{get:function(){return i},set:function(){throw new Error(`cannot assign to readonly variable: ${e}`)}}):(i.$location=t,i.$declareType=dr.DECLARE_TYPE_IN,this._inputs[t]=[e,new Jr(new Fr(i))],Object.defineProperty(this._inputScope,e,{get:function(){return i},set:function(){throw new Error(`cannot assign to readonly variable: ${e}`)}}),i.$tags.forEach((t=>this.tagShaderExp((()=>i),t))))}out(t,e,i){if(this._outputs[t])throw new Error(`output location ${t} has already been used`);i.$location=t,i.$declareType=dr.DECLARE_TYPE_OUT,this._outputs[t]=[e,new Jr(new Fr(i))];for(const s of[e,String(t)])Object.defineProperty(this._outputScope,s,{get:function(){return i},set:function(t){dn().getCurrentScope().$ast.statements.push(new jr(new Dr(i.$ast),t instanceof _n?t.$ast:t))}})}getDefaultSampler(t,e){const i=this._uniforms.findIndex((e=>e.texture?.exp===t));if(i<0)return;const s=e?"comparison":"sample";if(this._uniforms[i].texture.autoBindSampler&&this._uniforms[i].texture.autoBindSampler!==s)throw new Error("multiple sampler not supported");if(this._uniforms[i].texture.autoBindSampler=s,"webgpu"===this._device.type){const i=xr(t.$str,e);if(!this.getGlobalScope()[i])throw new Error(`failed to find sampler name ${i}`);return this.getGlobalScope()[i]}return null}normalizeExpValue(t){if(Array.isArray(t)){const e=t.map((t=>Array.isArray(t)?this.normalizeExpValue(t):t));return this.array(...e)}return t}guessExpValueType(t){const e=this.normalizeExpValue(t);if("boolean"==typeof e)return Te;if("number"==typeof e){if(Number.isInteger(e)){if(e>=-1073741824&&e<=2147483647)return pe;if(e>=0&&e<=4294967295)return ge;throw new Ys(e)}return oe}return e instanceof _n?e.$ast?.getType()||e.$typeinfo:void 0}findStructType(t,e){for(const i of[Et.Vertex,Et.Fragment,Et.Compute])if(i&e){const e=this._structInfo[i];if(e)for(const i of e.types)if(i.type.structName===t)return i}return null}findStructConstructor(t,e){for(const i of[Et.Vertex,Et.Fragment,Et.Compute])if(i&e){const e=this._structInfo[i];if(e&&e.structs?.[t])return e.structs[t]}return null}buildComputeSource(t){try{return this._lastError=null,this._shaderType=Et.Compute,this._scopeStack=[],this._globalScope=new Wn,this._builtinScope=new Vn,this._inputs=[],this._outputs=[],this._inputScope=new Gn,this._outputScope=new Xn,this._reflection.clear(),this.generate(t.compute),this.mergeUniformsCompute(this._globalScope),this.updateUniformBindings([this._globalScope],[Et.Compute]),[this.generateComputeSource(this._globalScope,this._builtinScope),this.createBindGroupLayouts(t.label)]}catch(t){return t instanceof qs?(this._lastError=t.getMessage(this._device.type),console.error(this._lastError),null):t instanceof Error?(this._lastError=t.toString(),console.error(this._lastError),null):(this._lastError=Object.prototype.toString.call(t),console.log(`Error: ${this._lastError}`),null)}}buildRenderSource(t){try{this._lastError=null,this._shaderType=Et.Vertex,this._scopeStack=[],this._globalScope=new Wn,this._builtinScope=new Vn,this._inputs=[],this._outputs=[],this._inputScope=new Gn,this._outputScope=new Xn,this._reflection.clear(),this.generate(t.vertex);const e=this._globalScope,i=this._builtinScope,s=this._inputs,r=this._outputs;this._device.type,this._shaderType=Et.Fragment,this._scopeStack=[],this._globalScope=new Wn,this._builtinScope=new Vn,this._inputs=[],this._outputs=[],this._inputScope=new Gn,this._outputScope=new Xn,this._reflection.clear(),r.forEach(((t,e)=>{this.in(e,t[0],new _n(t[1].value.name,t[1].value.getType()).tag(...t[1].value.value.$tags))})),this.generate(t.fragment);const n=this._globalScope,a=this._builtinScope,o=this._inputs,h=this._outputs;return this._device.type,this.mergeUniforms(e,n),this.updateUniformBindings([e,n],[Et.Vertex,Et.Fragment]),[this.generateRenderSource(Et.Vertex,e,i,s.map((t=>t[1])),r.map((t=>t[1]))),this.generateRenderSource(Et.Fragment,n,a,o.map((t=>t[1])),h.map((t=>t[1]))),this.createBindGroupLayouts(t.label),this._vertexAttributes]}catch(t){return t instanceof qs?(this._lastError=t.getMessage(this._device.type),console.error(this._lastError),null):t instanceof Error?(this._lastError=t.toString(),console.error(this._lastError),null):(this._lastError=Object.prototype.toString.call(t),console.log(`Error: ${this._lastError}`),null)}}generate(t){this.pushScope(this._globalScope),this._emulateDepthClamp&&this._shaderType===Et.Vertex&&(this._globalScope.$outputs.clamppedDepth=this.float().tag("CLAMPPED_DEPTH")),t&&t.call(this._globalScope,this),this.popScope(),this._globalScope.$ast.statements=[...this._globalScope.$ast.statements.filter((t=>t instanceof Jr||t instanceof jr)),...this._globalScope.$ast.statements.filter((t=>!(t instanceof Jr||t instanceof jr)))]}generateRenderSource(t,e,i,s,r){const n={type:t,mrt:t===Et.Fragment&&r.length>1,defines:[],extensions:new Set,builtins:[...i.$_usedBuiltins],types:this._structInfo[t]?.types||[],typeReplacement:new Map,inputs:s,outputs:r,global:e,vertexAttributes:this._vertexAttributes,workgroupSize:null};switch(this._device.type){case"webgl":for(const t of this._uniforms)if(t.texture){const e=t.texture.exp.$ast.getType();if(e.isTextureType()&&e.isDepthTexture()){if("comparison"===t.texture.autoBindSampler)throw new sr("depth texture comparison");"sample"===t.texture.autoBindSampler&&(e.is2DTexture()?n.typeReplacement.set(t.texture.exp,Be):e.isCubeTexture()&&n.typeReplacement.set(t.texture.exp,He))}}return e.$ast.toWebGL("",n);case"webgl2":for(const t of this._uniforms)if(t.texture){const e=t.texture.exp.$ast.getType();e.isTextureType()&&e.isDepthTexture()&&"sample"===t.texture.autoBindSampler&&(e.is2DTexture()?n.typeReplacement.set(t.texture.exp,e.isArrayTexture()?ke:Be):e.isCubeTexture()&&n.typeReplacement.set(t.texture.exp,He))}return e.$ast.toWebGL2("",n);case"webgpu":return e.$ast.toWGSL("",n);default:return null}}generateComputeSource(t,e){const i={type:Et.Compute,mrt:!1,defines:[],extensions:new Set,builtins:[...e.$_usedBuiltins],types:this._structInfo[Et.Compute]?.types||[],typeReplacement:null,inputs:[],outputs:[],global:t,vertexAttributes:[],workgroupSize:this._workgroupSize};return t.$ast.toWGSL("",i)}mergeUniformsCompute(t){const e=[];for(let t=0;t<this._uniforms.length;t++){const i=this._uniforms[t];if(i.block&&(i.block.exp.$declareType===dr.DECLARE_TYPE_UNIFORM||i.block.exp.$declareType===dr.DECLARE_TYPE_STORAGE)){if(i.block.exp.$typeinfo.isStructType()&&i.block.exp.$isBuffer)continue;e[i.group]||(e[i.group]=[]);const s=new _n(i.block.exp.$str,i.block.exp.$ast.getType());s.$declareType=i.block.exp.$declareType,s.$isBuffer=i.block.exp.$isBuffer,s.$bindingSize=i.block.exp.$bindingSize,s.$readonly=i.block.exp.$readonly,e[i.group].push({member:s,uniform:t})}}for(const i in e)if(e[i].length>0){const s=["std140","std430"],r=["ch_compute_uniform_block","ch_compute_storage_block"],n=[e[i].filter((t=>t.member.$declareType===dr.DECLARE_TYPE_UNIFORM)),e[i].filter((t=>t.member.$declareType===dr.DECLARE_TYPE_STORAGE))];for(let e=0;e<2;e++){if(0===n[e].length)continue;const a=[n[e].filter((t=>!t.member.$isBuffer)),...n[e].filter((t=>t.member.$isBuffer)).map((t=>[t]))];for(let n=0;n<a.length;n++){if(0===a[n].length)continue;const o=`${r[e]}_${i}_${n}`,h=this.generateStructureName(),l=dn().internalDefineStruct(h,s[e],Et.Compute,!1,...a[n].map((t=>t.member))),u=!(e>0)||a[n].findIndex((t=>!t.member.$readonly))<0,c=l();0===e?c.uniformBuffer(Number(i),n>0?a[n][0].member.$bindingSize:0):(c.storageBuffer(Number(i),n>0?a[n][0].member.$bindingSize:0),c.$readonly=u),t[o]=c;const d=this._uniforms.findIndex((t=>t.block?.name===o));this._uniforms[d].mask=Et.Compute;let p=this._nameMap[Number(i)];p||(p={},this._nameMap[Number(i)]=p);let m=!1;for(let t=a[n].length-1;t>=0;t--){const e=a[n][t],i=this._uniforms[e.uniform].block.exp;p[i.$str]=o,i.$str=`${o}.${i.$str}`,m||=i.$ast.isWritable()}m&&t[o].$ast.markWritable()}}}this._uniforms=this._uniforms.filter((t=>!t.block||t.block.exp.$typeinfo.isStructType()&&t.block.exp.$isBuffer))}mergeUniforms(t,e){const i=[],s=[],r=[];for(let t=0;t<this._uniforms.length;t++){const e=this._uniforms[t];if(e.block&&(e.block.exp.$declareType===dr.DECLARE_TYPE_UNIFORM||e.block.exp.$declareType===dr.DECLARE_TYPE_STORAGE)){if(e.block.exp.$typeinfo.isStructType()&&e.block.exp.$isBuffer)continue;const n=!!(e.mask&Et.Vertex),a=!!(e.mask&Et.Fragment);if(n&&a){r[e.group]||(r[e.group]=[]);const i=new _n(e.block.exp.$str,e.block.exp.$ast.getType());i.$declareType=e.block.exp.$declareType,i.$isBuffer=e.block.exp.$isBuffer,i.$bindingSize=e.block.exp.$bindingSize,i.$readonly=e.block.exp.$readonly,r[e.group].push({member:i,uniform:t})}else if(n){i[e.group]||(i[e.group]=[]);const s=new _n(e.block.exp.$str,e.block.exp.$ast.getType());s.$declareType=e.block.exp.$declareType,s.$isBuffer=e.block.exp.$isBuffer,s.$bindingSize=e.block.exp.$bindingSize,s.$readonly=e.block.exp.$readonly,i[e.group].push({member:s,uniform:t})}else if(a){s[e.group]||(s[e.group]=[]);const i=new _n(e.block.exp.$str,e.block.exp.$ast.getType());i.$declareType=e.block.exp.$declareType,i.$isBuffer=e.block.exp.$isBuffer,i.$bindingSize=e.block.exp.$bindingSize,i.$readonly=e.block.exp.$readonly,s[e.group].push({member:i,uniform:t})}}}const n=[i,s,r],a=["ch_vertex_uniform_block","ch_fragment_uniform_block","ch_shared_uniform_block"],o=["ch_vertex_storage_block","ch_fragment_storage_block","ch_shared_storage_block"],h=[Et.Vertex,Et.Fragment,Et.Vertex|Et.Fragment];for(let i=0;i<3;i++)for(const s in n[i])if(n[i][s]?.length>0){const r=[n[i][s].filter((t=>t.member.$declareType===dr.DECLARE_TYPE_UNIFORM)),n[i][s].filter((t=>t.member.$declareType===dr.DECLARE_TYPE_STORAGE))],l=[a,o],u=["std140","std430"];for(let n=0;n<2;n++){if(0===r[n].length)continue;const a=[r[n].filter((t=>!t.member.$isBuffer)),...r[n].filter((t=>t.member.$isBuffer)).map((t=>[t]))];for(let r=0;r<a.length;r++){if(0===a[r].length)continue;const o=`${l[n][i]}_${s}_${r}`,c=this.generateStructureName(),d=dn().internalDefineStruct(c,u[n],h[i],!1,...a[r].map((t=>t.member))),p=!(n>0)||a[r].findIndex((t=>!t.member.$readonly))<0;if(h[i]&Et.Vertex){const e=d();if(n>0&&!p)throw new Error("Storage buffer in vertex shader must be read-only");0===n?e.uniformBuffer(Number(s),r>0?a[r][0].member.$bindingSize:0):(e.storageBuffer(Number(s),r>0?a[r][0].member.$bindingSize:0),e.$readonly=p),t[o]=e}if(h[i]&Et.Fragment){const t=d();0===n?t.uniformBuffer(Number(s),r>0?a[r][0].member.$bindingSize:0):(t.storageBuffer(Number(s),r>0?a[r][0].member.$bindingSize:0),t.$readonly=p),e[o]=t}const m=this._uniforms.findIndex((t=>t.block?.name===o));this._uniforms[m].mask=h[i];let f=this._nameMap[Number(s)];f||(f={},this._nameMap[Number(s)]=f);let _=!1;for(let t=a[r].length-1;t>=0;t--){const e=a[r][t],i=this._uniforms[e.uniform].block.exp;f[i.$str]=o,i.$str=`${o}.${i.$str}`,_||=i.$ast.isWritable()}_&&(h[i]&Et.Vertex?t[o].$ast.markWritable():e[o].$ast.markWritable())}}}this._uniforms=this._uniforms.filter((t=>!t.block||t.block.exp.$typeinfo.isStructType()&&t.block.exp.$isBuffer))}updateUniformBindings(t,e){this._uniforms=this._uniforms.filter((t=>!!t.mask));const i=Array.from({length:4}).fill(0);for(const t of this._uniforms)t.binding=i[t.group]++;for(let i=0;i<t.length;i++){const s=t[i],r=e[i];for(const t of this._uniforms)if(t.mask&r){const e=s.$ast.uniforms,i=t.block?t.block.name:t.texture?t.texture.exp.$str:t.sampler.$str,r=e.findIndex((t=>t.value.name===i));if(r<0)throw new Error(`updateUniformBindings() failed: unable to find uniform ${i}`);e[r].binding=t.binding}}}createBindGroupLayouts(t){const e=[],i=[0,0,0,0];for(const s of this._uniforms){let r=e[s.group];r||(r={label:`${t||"unknown"}[${s.group}]`,entries:[]},this._nameMap[s.group]&&(r.nameMap=this._nameMap[s.group]),e[s.group]=r);const n={binding:s.binding,visibility:s.mask,type:null,name:""};if(s.block){n.type=s.block.exp.$typeinfo.clone(this.getBlockName(s.block.name));const t=s.block.exp.$declareType===dr.DECLARE_TYPE_STORAGE;n.buffer={type:t?s.block.exp.$readonly?"read-only-storage":"storage":"uniform",minBindingSize:s.block.bindingSize,hasDynamicOffset:!!s.block.bindingSize,uniformLayout:n.type.toBufferLayout(0,n.type.layout),dynamicOffsetIndex:s.block.bindingSize?i[s.group]++:-1},n.name=s.block.name}else if(s.texture){if(n.type=s.texture.exp.$typeinfo,!n.type.isTextureType())throw new Error("internal error");if(n.type.isStorageTexture())n.storageTexture={access:"write-only",viewDimension:n.type.is1DTexture()?"1d":"2d",format:n.type.storageTexelFormat};else if(n.type.isExternalTexture())n.externalTexture={autoBindSampler:s.texture.autoBindSampler?xr(s.texture.exp.$str,!1):null};else{const t="webgpu"===this._device.type?s.texture.exp.$sampleType:s.texture.autoBindSampler&&n.type.isDepthTexture()?"float":s.texture.exp.$sampleType;let e;e=n.type.isArrayTexture()?n.type.isCubeTexture()?"cube-array":"2d-array":n.type.is3DTexture()?"3d":n.type.isCubeTexture()?"cube":n.type.is1DTexture()?"1d":"2d",n.texture={sampleType:t,viewDimension:e,multisampled:!1,autoBindSampler:null,autoBindSamplerComparison:null},"webgpu"!==this._device.type&&"sample"!==s.texture.autoBindSampler||(n.texture.autoBindSampler=xr(s.texture.exp.$str,!1)),("webgpu"===this._device.type&&n.type.isDepthTexture()||"comparison"===s.texture.autoBindSampler)&&(n.texture.autoBindSamplerComparison=xr(s.texture.exp.$str,!0))}n.name=s.texture.exp.$str}else{if(!s.sampler)throw new ar("invalid uniform entry type");if(n.type=s.sampler.$typeinfo,!n.type.isSamplerType())throw new Error("internal error");n.sampler={type:n.type.accessMode===Zt.SAMPLE?"float"===s.sampler.$sampleType?"filtering":"non-filtering":"comparison"},n.name=s.sampler.$str}r.entries.push(n)}for(let i=0;i<e.length;i++)e[i]||(e[i]={label:`${t||"unknown"}[${i}]`,entries:[]});return e}_getFunctionOverload(t,e){const i=e.filter((t=>{if(t instanceof _n){const e=t.$ast.getType();if(e.isStructType()&&this._structInfo[this._shaderType]?.types.findIndex((t=>t.type.structName===e.structName))<0)return!1}return!0})),s=this.getGlobalScope().$getFunctions(t);return s?this._matchFunctionOverloading(s,i):null}_matchFunctionOverloading(t,e){for(const i of t){if(e.length!==i.funcType.argTypes.length)continue;const t=[];let s=!0;for(let r=0;r<e.length;r++){const n=i.funcType.argTypes[r],a=n.byRef&&n.type instanceof se?n.type.pointerType:n.type,o=e[r];if("boolean"==typeof o){if(!a.isPrimitiveType()||a.primitiveType!==Bt.BOOL){s=!1;break}t.push(new Br(o,Te))}else if("number"==typeof o){if(!a.isPrimitiveType()||!a.isScalarType()||a.scalarType===Bt.BOOL){s=!1;break}if(a.scalarType===Bt.I32){if(!Number.isInteger(o)||o<-2147483648||o>2147483647){s=!1;break}t.push(new Br(o,pe))}else if(a.scalarType===Bt.U32){if(!Number.isInteger(o)||o<0||o>4294967295){s=!1;break}t.push(new Br(o,ge))}else t.push(new Br(o,a))}else{if(!a.isCompatibleType(o.$ast.getType())){s=!1;break}t.push(o.$ast)}}if(s)return[i,t]}return null}$callFunction(t,e,i){if(this.getCurrentScope()===this.getGlobalScope())throw new rr(t);const s=new _n("",i.returnType);return s.$ast=new Qr(t,e,i,dn().getDevice().type),this.getCurrentScope().$ast.statements.push(s.$ast),s}$callFunctionNoCheck(t,e,i){if(this.getCurrentScope()===this.getGlobalScope())throw new rr(t);const s=new _n("",i);return s.$ast=new Qr(t,e,null,dn().getDevice().type,i),this.getCurrentScope().$ast.statements.push(s.$ast),s}}class kn extends mn{$_variables;$_parentScope;$_AST;$_localScope;constructor(t,e){super(),this.$_parentScope=e||null,this.$_variables={},this.$_AST=t,this.$_localScope=null}get $builder(){return dn()}get $builtins(){return dn().builtinScope}get $inputs(){return dn().inputScope}get $outputs(){return dn().outputScope}get $parent(){return this.$_parentScope}get $ast(){return this.$_AST}set $ast(t){this.$_AST=t}$getVertexAttrib(t){return this.$inputs.$getVertexAttrib(t)}get $l(){return this.$_getLocalScope()}get $g(){return this.$_getGlobalScope()}$local(t,e){const i=dn().normalizeExpValue(e);t.$global=this instanceof Wn,this.$_declare(t,i)}$touch(t){this.$ast.statements.push(new Wr(t.$ast))}$query(t){return this.$builder.getReflection().tag(t)}$_declareInternal(t,e){const i=t.$str;if(this.$_variables[i])throw new Error(`cannot re-declare variable '${i}'`);if(!(t.$ast instanceof Fr))throw new Error(`invalid variable declaration: '${t.$ast.toString(dn().getDevice().type)}'`);const s=t.$typeinfo;if(s.isPointerType()){if(!e)throw new Error(`cannot declare pointer type variable without initialization: '${t.$str}'`);if(!(e instanceof _n))throw new Error(`invalid initialization for pointer type declaration: '${t.$str}`);const i=e.$ast.getType();if(!i.isPointerType()||!s.pointerType.isCompatibleType(i.pointerType))throw new Error(`incompatible pointer type assignment: '${t.$str}'`);t.$typeinfo=i}if(this.$_registerVar(t,i),null==e)return new Jr(t.$ast);if(e instanceof _n&&e.$ast instanceof Nr&&0===e.$ast.args.length){if(!e.$ast.getType().isCompatibleType(t.$ast.getType()))throw new Zs(e,e.$ast.getType(),t.$ast.getType());return new Jr(t.$ast)}return new jr(new Pr(t.$ast),e instanceof _n?e.$ast:e)}$_findOrSetUniform(t){const e=t.$str,i={group:t.$group,binding:0,mask:0};t.$typeinfo.isTextureType()?i.texture={autoBindSampler:null,exp:t}:t.$typeinfo.isSamplerType()?i.sampler=t:i.block={name:e,bindingSize:t.$bindingSize,exp:t};let s=!1;for(const e of dn()._uniforms)if(e.group===i.group){if(i.block&&e.block&&e.block.name===i.block.name&&e.block.exp.$typeinfo.isCompatibleType(i.block.exp.$typeinfo)){e.mask|=dn().shaderType,t=e.block.exp,s=!0;break}if(i.texture&&e.texture&&i.texture.exp.$str===e.texture.exp.$str&&i.texture.exp.$typeinfo.isCompatibleType(e.texture.exp.$typeinfo)){e.mask|=dn().shaderType,t=e.texture.exp,s=!0;break}if(i.sampler&&e.sampler&&i.sampler.$str===e.sampler.$str&&i.sampler.$typeinfo.isCompatibleType(e.sampler.$typeinfo)){e.mask|=dn().shaderType,t=e.sampler,s=!0;break}}if(s||(i.mask=dn().shaderType,dn()._uniforms.push(i)),i.texture&&!i.texture.exp.$typeinfo.isStorageTexture()&&"webgpu"===dn().getDevice().type){const e=t.$typeinfo.isTextureType()&&t.$typeinfo.isDepthTexture(),s=xr(t.$str,!1),r=dn().sampler(s).uniform(i.group).sampleType(t.$sampleType);if(r.$sampleType=t.$sampleType,this.$local(r),e){const e=xr(t.$str,!0),s=dn().samplerComparison(e).uniform(i.group).sampleType(t.$sampleType);this.$local(s)}}return t}$_declare(t,e){if(this.$_variables[t.$str])throw new nr(t.$ast,"cannot re-declare variable");if(t.$declareType===dr.DECLARE_TYPE_UNIFORM||t.$declareType===dr.DECLARE_TYPE_STORAGE){const e=t.$ast.name;if(!(this instanceof Wn))throw new Error(`uniform or storage variables can only be declared within global scope: ${e}`);if(!(t.$declareType!==dr.DECLARE_TYPE_UNIFORM||t.$typeinfo.isTextureType()||t.$typeinfo.isSamplerType()||t.$typeinfo.isConstructible()&&t.$typeinfo.isHostSharable()))throw new nr(t.$ast,`type '${t.$typeinfo.toTypeName(dn().getDevice().type)}' cannot be declared in uniform address space`);if(t.$declareType===dr.DECLARE_TYPE_STORAGE){if("webgpu"!==dn().getDevice().type)throw new sr("storage buffer binding");if(!t.$typeinfo.isHostSharable())throw new nr(t.$ast,`type '${t.$typeinfo.toTypeName(dn().getDevice().type)}' cannot be declared in storage address space`)}t=this.$_findOrSetUniform(t);const i=this.$_declareInternal(t);i.group=t.$group,i.binding=0,i.blockName=dn().getBlockName(e);const s=t.$typeinfo;(s.isStructType()&&t.$isBuffer||s.isTextureType()||s.isSamplerType()||s.isStructType()&&("std140"===s.detail.layout||"std430"===s.detail.layout))&&this.$ast.uniforms.push(i),t.$tags.forEach((e=>{dn().tagShaderExp((()=>t),e)}))}else{const i=this.$_declareInternal(t,e);this.$ast.statements.push(i)}}$_registerVar(t,e){const i=e||t.$str,s={configurable:!0,get:function(){return t},set:function(e){dn().getCurrentScope().$ast.statements.push(new jr(new Dr(t.$ast),e instanceof _n?e.$ast:e))}};Object.defineProperty(this,i,s),this.$_variables[i]=t}$localGet(t){if("string"==typeof t&&("$"===t[0]||t in this))return this[t]}$localSet(t,e){return("$"===t[0]||t in this)&&(this[t]=e,!0)}$get(t){const e=this.$localGet(t);return void 0===e&&this.$_parentScope?this.$_parentScope.$thisProxy.$get(t):e}$set(t,e){if("$"===t[0])return this[t]=e,!0;{let i=this;for(;i&&!(t in i);)i=i.$_parentScope;if(i)return i[t]=e,!0;if(this.$l)return this.$l[t]=e,!0}return!1}$_getLocalScope(){return this.$_localScope||(this.$_localScope=new zn(this)),this.$_localScope}$_getGlobalScope(){return this.$builder.getGlobalScope()}}class zn extends kn{$_scope;constructor(t){super(null,null),this.$_scope=t}$get(t){return"$"===t[0]?this[t]:this.$_scope.$localGet(t)}$set(t,e){if("$"===t[0])return this[t]=e,!0;if(!(this.$_scope instanceof Wn)&&e instanceof _n&&(e.isConstructor()||e.$typeinfo.isTextureType()&&e.$ast instanceof Fr&&!e.$ast.name)&&(e.$declareType===dr.DECLARE_TYPE_UNIFORM||e.$declareType===dr.DECLARE_TYPE_STORAGE))return this.$g[t]=e,!0;if(void 0===this.$_scope.$localGet(t)){const i=dn().guessExpValueType(e);if(i.isCompatibleType(vs))throw new Error(`Cannot assign void type to '${t}'`);const s=new _n(t,i);return e instanceof _n&&!this.$_scope.$parent&&(s.$declareType=e.$declareType,s.$isBuffer=e.$isBuffer,s.$bindingSize=e.$bindingSize,s.$readonly=e.$readonly,s.$group=e.$group,s.$attrib=e.$attrib,s.$sampleType=e.$sampleType,s.$precision=e.$precision,s.tag(...e.$tags)),this.$_scope.$local(s,e),!0}return this.$_scope.$localSet(t,e)}$_getLocalScope(){return this}}class Vn extends kn{$_usedBuiltins;$_builtinVars;constructor(){super(null),this.$_usedBuiltins=new Set;if(!("webgpu"===dn().getDevice().type)){this.$_builtinVars={};const t=br[dn().getDevice().type];for(const e in t){const i=t[e];this.$_builtinVars[e]=new _n(i.name,i.type)}}const t=br[dn().getDevice().type],e=this;for(const i of Object.keys(t))Object.defineProperty(this,i,{get:function(){return e.$getBuiltinVar(i)},set:function(t){if("number"!=typeof t&&!(t instanceof _n))throw new Error("Invalid output value assignment");const s=e.$getBuiltinVar(i);dn().getCurrentScope().$ast.statements.push(new jr(new Dr(s.$ast),t instanceof _n?t.$ast:t))}})}$_getLocalScope(){return null}$getBuiltinVar(t){const e=dn();this.$_usedBuiltins.add(t);if("webgpu"===e.getDevice().type){const i=br[e.getDevice().type][t],s=i.inOrOut;if("in"===s)return e.getCurrentFunctionScope()[mr(e.shaderType)][i.name];const r="in"===s?fr(e.shaderType):_r(e.shaderType),n=e.getCurrentScope();if(!n[r]||!n[r][i.name])throw new Error(`invalid use of builtin variable ${t}`);return n[r][i.name]}return"webgl2"!==e.getDevice().type||"vertexIndex"!==t&&"instanceIndex"!==t?this.$_builtinVars[t]:e.uint(this.$_builtinVars[t])}}class Gn extends kn{$_names;$_aliases;constructor(){super(null),this.$_names={},this.$_aliases={}}$getVertexAttrib(t){const e=this.$_names[t];return e?this[e]:null}$_getLocalScope(){return null}$get(t){if("$"===t[0])return this[t];this.$_aliases[t]&&(t=this.$_aliases[t]);const e=this.$builder;if("webgpu"===e.getDevice().type){const i=e.getCurrentFunctionScope()[mr(e.shaderType)],s="vertex"===e.shaderKind?Bn:On,r=`${s}${t}`;if(i.$typeinfo.structMembers.findIndex((t=>t.name===r))<0)return;return i[`${s}${t}`]}return super.$get(t)}$set(t,e){if("$"===t[0])this[t]=e;else{if(!(e instanceof _n))throw new Error("invalid vertex input value");const i=dn().shaderType;if(i!==Et.Vertex)throw new Error(`shader input variables can only be declared in vertex shader: "${t}"`);const s=Ps(e.$attrib);if(void 0===s)throw new Error(`can not declare shader input variable: invalid vertex attribute: "${t}"`);if(dn()._vertexAttributes.indexOf(s)>=0){const i=this.$_names[e.$attrib];if(t!==i){if(this[i].$typeinfo.typeId!==e.$typeinfo.typeId)throw new Error(`can not declare shader input variable: attribute already declared with different type: "${t}"`);this.$_aliases[t]=i}return!0}if(!(e instanceof _n&&e.$ast instanceof Nr))throw new Error(`invalid shader input variable declaration: "${t}"`);const r=e.$ast.getType();if(!r.isPrimitiveType()||r.isMatrixType()||r.primitiveType===Bt.BOOL)throw new Error(`type cannot be used as pipeline input/output: ${t}`);this.$_names[e.$attrib]=t;const n=dn()._inputs.length,a=new _n(`${Bn}${t}`,r).tag(...e.$tags);dn().in(n,t,a),dn()._vertexAttributes.push(s),"webgpu"===dn().getDevice().type&&dn().findStructType(gr(i),i)&&dn().defineBuiltinStruct(i,"in")}return!0}}class Xn extends kn{constructor(){super(null)}$_getLocalScope(){return null}$set(t,e){if("$"===t[0])this[t]=e;else{const i=dn();if(!(t in this)){if(!(i.getCurrentScope()!==i.getGlobalScope()||e instanceof _n&&e.$ast instanceof Nr))throw new Error(`invalid shader output variable declaration: ${t}`);const s=e.$ast.getType();if(!s.isPrimitiveType()||s.isMatrixType()||s.primitiveType===Bt.BOOL)throw new Error(`type cannot be used as pipeline input/output: ${t}`);const r=i._outputs.length;if(i.out(r,t,new _n(`${"vertex"===i.shaderKind?On:"zFSOutput_"}${t}`,s).tag(...e.$tags)),"webgpu"===dn().getDevice().type){const t=dn().shaderType;dn().findStructType(gr(t),t)&&dn().defineBuiltinStruct(t,"out")}}if(dn().getCurrentScope()!==dn().getGlobalScope()){const i=e.$ast;i instanceof Nr&&!(i.args.length>0)||(this[t]=e)}}return!0}}class Wn extends kn{$_inputStructInfo;constructor(){super(new Rr),this.$_inputStructInfo=null}get $inputStructInfo(){return this.$_inputStructInfo||(this.$_inputStructInfo=this.$builder.defineBuiltinStruct(this.$builder.shaderType,"in")),this.$_inputStructInfo}get $inputStruct(){return this.$inputStructInfo[0]}$mainFunc(t){const e=dn();if("webgpu"===e.getDevice().type){const i=this.$inputStructInfo,s=e.shaderType===Et.Compute,r=s?null:e.defineBuiltinStruct(e.shaderType,"out");r&&this.$local(r[1]),this.$internalCreateFunction("main",i?[i[3]]:[],!0,(function(){e.shaderType===Et.Fragment&&e.emulateDepthClamp&&(this.$builtins.fragDepth=e.clamp(this.$inputs.clamppedDepth,0,1)),t?.call(this),e.shaderType===Et.Vertex&&(e.depthRangeCorrection&&(this.$builtins.position.z=e.mul(e.add(this.$builtins.position.z,this.$builtins.position.w),.5)),e.emulateDepthClamp&&(this.$outputs.clamppedDepth=e.div(this.$builtins.position.z,this.$builtins.position.w),this.$builtins.position.z=0)),s||this.$return(r[1])}))}else this.$internalCreateFunction("main",[],!0,(function(){e.shaderType===Et.Fragment&&e.emulateDepthClamp&&(this.$builtins.fragDepth=e.clamp(this.$inputs.clamppedDepth,0,1)),t?.call(this),e.shaderType===Et.Vertex&&e.emulateDepthClamp&&(this.$outputs.clamppedDepth=e.div(e.add(e.div(this.$builtins.position.z,this.$builtins.position.w),1),2),this.$builtins.position.z=0)}))}$createFunctionIfNotExists(t,e,i){this.$internalCreateFunction(t,e,!1,i)}$getFunctions(t){return this.$ast.findFunctions(t)}$getCurrentFunctionScope(){let t=dn().getCurrentScope();for(;t&&!(t instanceof jn);)t=t.$parent;return t}$internalCreateFunction(t,e,i,s){const r=dn();"webgpu"!==r.getDevice().type||i||e.push(this.$inputStruct(mr(r.shaderType))),e.forEach((e=>{if(!(e.$ast instanceof Fr))throw new Error(`${t}(): invalid function definition`);let i=e.$ast;e.$inout&&("webgpu"===dn().getDevice().type&&(e.$typeinfo=new se(e.$typeinfo,Kt.UNKNOWN)),i=new zr(e.$ast)),e.$ast=new Cr(i)}));const n=this.$getFunctions(t),a=this.$getCurrentFunctionScope(),o=new tn(t,e.map((t=>t.$ast)),i,null,!1);if(a){const t=this.$ast.statements.indexOf(a.$ast);if(t<0)throw new Error("Internal error");this.$ast.statements.splice(t,0,o)}else this.$ast.statements.push(o);new jn(this,e,o,s),o.returnType||(o.returnType=vs),o.funcType=new ae(o.name,o.returnType,e.map((t=>{const e=t.$ast;return e.paramAST instanceof zr?{type:e.paramAST.value.getType(),byRef:e.paramAST instanceof zr}:{type:e.paramAST.getType(),byRef:!1}})));for(const e of n)if(e.funcType.argHash===o.funcType.argHash){if(e.returnType.isCompatibleType(o.returnType))return void this.$ast.statements.splice(this.$ast.statements.indexOf(o),1);throw new Error(`Invalid function overloading: ${t}`)}0===n.length&&Object.defineProperty(this,t,{get:function(){if(0===this.$getFunctions(t).length)throw new Error(`function ${t} not found`);return(...e)=>{let i=null;if("webgpu"===r.getDevice().type){let t=r.getCurrentScope();for(;t&&!(t instanceof jn);)t=t.$parent;const e=t.$ast.args;i=t[e[e.length-1].paramAST.name]}const s=(i?[...e,i]:e).map((t=>r.normalizeExpValue(t))),n=r._getFunctionOverload(t,s);if(!n)throw new Error(`ERROR: no matching overloads for function ${t}`);return dn().$callFunction(t,n[1],n[0])}}})}}class Hn extends kn{constructor(t){super(new Ar,t)}$return(t){const e=this.findOwnerFunction().$ast;let i=null;const s=dn().normalizeExpValue(t);if(null!=s)if("number"==typeof s){if(e.returnType&&e.returnType.isPrimitiveType()&&e.returnType.isScalarType()&&!e.returnType.isCompatibleType(Te)&&(i=e.returnType),!i)if(Number.isInteger(s))if(s<0){if(s<-2147483648)throw new Error(`function ${e.name}: invalid return value: ${s}`);i=pe}else{if(s>4294967295)throw new Error(`function ${e.name}: invalid return value: ${s}`);i=s<=2147483647?pe:ge}else i=oe}else i="boolean"==typeof s?Te:s.$ast.getType();else i=vs;if(i.isPointerType())throw new Error("function can not return pointer type");if(e.returnType){if(!e.returnType.isCompatibleType(i))throw new Error(`function ${e.name}: return type must be ${e.returnType?.toTypeName(dn().getDevice().type)||"void"}`)}else e.returnType=i;let r=null;if(null!=s)if(s instanceof _n)r=s.$ast;else{if(!i.isPrimitiveType()||!i.isScalarType())throw new Zs(s,typeof s,i);r=new Br(s,i)}this.$ast.statements.push(new Kr(r))}$scope(t){const e=new Mr;return this.$ast.statements.push(e),new Kn(this,e,t)}$if(t,e){const i=new en("if",t instanceof _n?t.$ast:new Br(t,"number"==typeof t?oe:Te));return this.$ast.statements.push(i),new Qn(this,i,e)}$choice(t,e,i){const s=new Hr(t instanceof _n?t.$ast:t,e instanceof _n?e.$ast:e,i instanceof _n?i.$ast:i),r=new _n("",s.getType());return r.$ast=s,r}$break(){this.$ast.statements.push(new Yr)}$continue(){this.$ast.statements.push(new Zr)}$for(t,e,i,s){const r=t.$ast.getType();if(!r.isPrimitiveType()||!r.isScalarType())throw new nr(t.$ast,"invalid for range initializer type");const n=e instanceof _n?e.$ast:new Br(e,r),a=new sn(t.$ast,n,i instanceof _n?i.$ast:new Br(i,r),!0);this.$ast.statements.push(a),new Zn(this,t,i,a,s)}$do(t){if("webgl"===this.$builder.getDevice().type)throw new Error("No do-while() loop support for WebGL1.0 device");const e=new rn(null);return this.$ast.statements.push(e),new Yn(this,e,t)}$while(t,e){const i=new nn(t instanceof _n?t.$ast:new Br(t,"number"==typeof t?oe:Te));this.$ast.statements.push(i),new qn(this,i,e)}findOwnerFunction(){for(let t=this;t;t=t.$parent)if(t instanceof jn)return t;return null}}class jn extends Hn{$typeinfo;constructor(t,e,i,s){super(t),this.$ast=i;for(const t of e){if(this.$_variables[t.$str])throw new Error("Duplicate function parameter name is not allowed");this.$_registerVar(t)}dn().pushScope(this),s&&s.call(this),dn().popScope()}$isMain(){return this.$ast.isMainFunc}}class qn extends Hn{constructor(t,e,i){super(t),this.$ast=e,dn().pushScope(this),i&&i.call(this),dn().popScope()}}class Yn extends Hn{constructor(t,e,i){super(t),this.$ast=e,dn().pushScope(this),i&&i.call(this),dn().popScope()}$while(t){this.$ast.condition=t instanceof _n?t.$ast:new Br(t,"number"==typeof t?oe:Te)}}class Zn extends Hn{constructor(t,e,i,s,r){super(t),this.$ast=s,this.$_registerVar(e),dn().pushScope(this),r&&r.call(this),dn().popScope()}}class Kn extends Hn{constructor(t,e,i){super(t),this.$ast=e,dn().pushScope(this),i&&i.call(this),dn().popScope()}}class Qn extends Hn{constructor(t,e,i){super(t),this.$ast=e,dn().pushScope(this),i&&i.call(this),dn().popScope()}$elseif(t,e){const i=new en("else if",t instanceof _n?t.$ast:new Br(t,"number"==typeof t?oe:Te));return this.$ast.nextElse=i,new Qn(this.$_parentScope,i,e)}$else(t){const e=new en("else",null);this.$ast.nextElse=e,new Qn(this.$_parentScope,e,t)}}var Jn;!function(t){for(const e of Object.keys(In))t.prototype[e]=function(...t){return(In?.[e]?.normalizeFunc||Tn)(this,e,...t)}}(Un),Jn=Un,Object.keys(Ln).forEach((t=>{Jn.prototype[t]=pn((function(...e){return $n.call(this,Ln[t],...e)}),Ln[t])})),Object.keys(Pn).forEach((t=>{Jn.prototype[t]=function(e){return new _n(e,Pn[t])}})),Object.keys(Nn).forEach((t=>{Jn.prototype[t]=function(t){const e={};for(const i of Object.keys(Dn))e[i]=function(e){return new _n(e,new ne(t,Dn[i]))};return e}(Nn[t])})),Jn.prototype.atomic_int=pn((function(...t){if(t.length>1)throw new Ks("atomic_int");if(1===t.length){if("string"!=typeof t[0])throw new Qs("atomic_int","name");return new _n(t[0],ce)}{const t=new _n("",ce);return t.$ast=new Nr(t.$typeinfo,[]),t}}),ce),Jn.prototype.atomic_uint=pn((function(...t){if(t.length>1)throw new Ks("atomic_uint");if(1===t.length&&"string"==typeof t[0])return new _n(t[0],de);if(0===t.length){const t=new _n("",de);return t.$ast=new Nr(t.$typeinfo,[]),t}const e=t[0];if("number"==typeof e&&Number.isInteger(e)||e instanceof _n&&e.$ast.getType().typeId===ge.typeId){const t=new _n("",de);return t.$ast=new Nr(t.$typeinfo,[e instanceof _n?e.$ast:e]),t}return null}),de);class ta{static _canvas=null;static _context=null;static get canvas(){return this._realize(),this._canvas}static get context(){return this._realize(),this._context}static get font(){return this.context.font}static set font(t){this.context.font=t}static _realize(){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=512,this._canvas.height=512,this._canvas.style.left="-10000px",this._canvas.style.position="absolute",this._context=this._canvas.getContext("2d",{willReadFrequently:!0}),this._context.textBaseline="top",this._context.textAlign="left",this._context.fillStyle="transparent",this._context.fillRect(0,0,this._canvas.width,this._canvas.height),this._context.fillStyle="#ffffff",this._context.imageSmoothingEnabled=!0)}}class ea{static fontCache={};_name;_nameScaled;_scale;_size;_family;_top;_bottom;_topScaled;_bottomScaled;_div;constructor(t,e){this._top=0,this._bottom=0,this._size=0,this._topScaled=0,this._bottomScaled=0,this._family="",this._scale=e,this._name=t,this._nameScaled=null,this._div=document.createElement("div"),this._name&&this._normalizeFont()}static fetchFont(t,e){let i=this.fontCache[t];i||(i={},this.fontCache[t]=i);let s=i[e];return s||(s=new ea(t,e),i[e]=s),s}get fontName(){return this._name}set fontName(t){this._name=t,this._normalizeFont()}get fontNameScaled(){return this._nameScaled}get size(){return this._size}get family(){return this._family}get top(){return this._top}get bottom(){return this._bottom}get topScaled(){return this._topScaled}get bottomScaled(){return this._bottomScaled}get maxHeight(){return this._bottom-this._top+1}get maxHeightScaled(){return this._bottomScaled-this._topScaled+1}equalTo(t){return this._size===t._size&&this._family===t._family}_measureFontHeight(t){const e=ta.context.font,i=ta.context.textBaseline,s=ta.context.fillStyle;ta.context.font=t,this._div.style.font=ta.context.font;const r=this._div.style.fontSize,n=parseInt(r.substring(0,r.length-2)),a=this._div.style.fontFamily,o="bdfghijklpq|_~",h=ta.context.measureText(o);let l,u;l=0,u=n-1;const c=Math.ceil(h.width)+10,d=n+10;ta.context.clearRect(0,0,c,d),ta.context.textBaseline="top",ta.context.fillStyle="#ffffff",ta.context.fillText(o,5,5);const p=ta.context.getImageData(0,0,c,d).data;for(let t=0;t<c*d;t++)if(p[4*t+3]>0){l=Math.floor(t/c);break}for(let t=c*d-1;t>=0;t--)if(p[4*t+3]>0){u=Math.floor(t/c);break}return l-=5,u-=5,ta.context.font=e,ta.context.textBaseline=i,ta.context.fillStyle=s,{size:n,family:a,top:l,bottom:u}}_normalizeFont(){const t=this._measureFontHeight(this._name);this._nameScaled=`${Math.round(t.size*this._scale)}px ${t.family}`;const e=this._measureFontHeight(this._nameScaled);this._size=t.size,this._family=t.family,this._top=t.top,this._bottom=t.bottom,this._topScaled=e.top,this._bottomScaled=e.bottom}}class ia{static ATLAS_WIDTH=1024;static ATLAS_HEIGHT=1024;_packer;_device;_binWidth;_binHeight;_rectBorderWidth;_linearSpace;_atlasList;_atlasInfoMap;_atlasRestoreHandler;constructor(t,e,i,s,r){this._device=t,this._binWidth=e,this._binHeight=i,this._rectBorderWidth=s,this._linearSpace=!!r,this._packer=new V(this._binWidth,this._binHeight),this._atlasList=[],this._atlasInfoMap={},this._atlasRestoreHandler=null}get atlasTextureRestoreHandler(){return this._atlasRestoreHandler}set atlasTextureRestoreHandler(t){this._atlasRestoreHandler=t}getAtlasTexture(t){return this._atlasList[t]}getAtlasInfo(t){return this._atlasInfoMap[t]||null}isEmpty(){return 0===this._atlasList.length}clear(){this._packer.clear();for(const t of this._atlasList)t.dispose();this._atlasList=[],this._atlasInfoMap={}}pushCanvas(t,e,i,s,r,n){const a=this._packer.insert(r+2*this._rectBorderWidth,n+2*this._rectBorderWidth);if(a){const o=a.x+this._rectBorderWidth,h=a.y+this._rectBorderWidth;this._updateAtlasTextureCanvas(a.binIndex,e,o,h,r,n,i,s);const l={atlasIndex:a.binIndex,uMin:o/this._binWidth,vMin:h/this._binHeight,uMax:(o+r)/this._binWidth,vMax:(h+n)/this._binHeight,width:r,height:n};return this._atlasInfoMap[t]=l,l}return null}pushBitmap(t,e){const i=this._packer.insert(e.width+2*this._rectBorderWidth,e.height+2*this._rectBorderWidth);if(i){const s=i.x+this._rectBorderWidth,r=i.y+this._rectBorderWidth;this._updateAtlasTexture(i.binIndex,e,s,r);const n={atlasIndex:i.binIndex,uMin:s/this._binWidth,vMin:r/this._binHeight,uMax:(s+e.width)/this._binWidth,vMax:(r+e.height)/this._binHeight,width:e.width,height:e.height};return this._atlasInfoMap[t]=n,n}return null}_createAtlasTexture(){const t=this._device.createTexture2D("rgba8unorm",this._binWidth,this._binHeight,{samplerOptions:{mipFilter:"none"}});return t.update(new Uint8Array(t.width*t.height*4),0,0,t.width,t.height),t.restoreHandler=async()=>{t.update(new Uint8Array(t.width*t.height*4),0,0,t.width,t.height),this._atlasRestoreHandler&&await this._atlasRestoreHandler(t)},t}_updateAtlasTextureCanvas(t,e,i,s,r,n,a,o){let h=null;t===this._atlasList.length?(h=this._createAtlasTexture(),this._atlasList.push(h)):h=this._atlasList[t],h.updateFromElement(e.canvas,i,s,a,o,r,n)}_updateAtlasTexture(t,e,i,s){let r=null;if(t===this._atlasList.length?(r=this._createAtlasTexture(),this._atlasList.push(r)):r=this._atlasList[t],e instanceof ImageBitmap)r.updateFromElement(e,i,s,0,0,e.width,e.height);else{const t=new Uint8Array(e.data.buffer);r.update(t,i,s,e.width,e.height)}}}class sa extends ia{constructor(t,e,i,s){super(t,e,i,s,!0),this.atlasTextureRestoreHandler=async()=>{this.isEmpty()||this.clear()}}getGlyphInfo(t,e){if(!t||!e)return null;let i=this.getAtlasInfo(this._hash(t,e));return i||(i=this._cacheGlyph(t,e),i.width=Math.round(i.width*(e.maxHeight/e.maxHeightScaled)),i.height=e.maxHeight),i}measureStringWidth(t,e,i){let s=0;for(const r of t)s+=e+this.getCharWidth(r,i);return s}clipStringToWidth(t,e,i,s,r){let n=0,a=s;for(;a<t.length&&(n+=i+this.getCharWidth(t[a],r),!(n>e));a++);return a-s}_hash(t,e){return`${e.family}@${e.size}&${t}`}_cacheGlyph(t,e){const i=this._getGlyphBitmap(t,e);return this.pushBitmap(this._hash(t,e),i)}getCharWidth(t,e){if(!e)return 0;ta.font=e.fontNameScaled;const i=ta.context.measureText(t);let s=i.width;return 0===s?0:("number"==typeof i.actualBoundingBoxRight&&(s=Math.floor(Math.max(s,i.actualBoundingBoxRight)+.8)),s=Math.round(s*(e.maxHeight/e.maxHeightScaled)),s)}_getGlyphBitmap(t,e){if(!e)return null;ta.font=e.fontNameScaled;const i=ta.context.measureText(t);let s=i.width;if(0===s)return null;"number"==typeof i.actualBoundingBoxRight&&(s=Math.floor(Math.max(s,i.actualBoundingBoxRight)+.8));const r=e.maxHeightScaled;return ta.context.fillStyle="#fff",ta.context.clearRect(0,0,s+2,r),ta.context.fillText(t,0,-e.topScaled),ta.context.getImageData(0,0,s,r)}}class ra{static GLYPH_COUNT=1024;static glyphManager=null;static prepared=!1;static textVertexBuffer=null;static textVertexLayout=null;static textProgram=null;static textBindGroup=null;static textRenderStates=null;static textOffset=0;static textMatrix=new S;static font=null;static vertexCache=null;static colorValue=new T;static calculateTextMatrix(t,e){const i=t.getViewport(),s=S.ortho(0,i.width,0,i.height,1,100),r=S.translation(new b(0,i.height,0)).scaleRight(new b(1,-1,1));S.multiply(s,r,e)}static setFont(t,e){this.font=ea.fetchFont(e,t.getScale())||ea.fetchFont("12px arial",t.getScale())}static drawText(e,i,s,r,n){if(i.length>0){e.pushDeviceStates(),this.prepareDrawText(e),this.calculateTextMatrix(e,this.textMatrix);const a=function(e){e=e.trim().toLowerCase();let i=null;if("#"===(e=t[e]||e)[0]){const t=(e.length-1)/3,s=[17,1,.062272][t-1];i={r:parseInt(e.substring(1,1+t),16)*s/255,g:parseInt(e.substring(1+t,1+2*t),16)*s/255,b:parseInt(e.substring(1+2*t,1+3*t),16)*s/255,a:1}}else{let t;(t=e.match(/^\s*rgb\s*\(\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\s*,\s*(\d\.?\d*)\s*\)\s*$/i))?i={r:Number(t[1])/255,g:Number(t[2])/255,b:Number(t[3])/255,a:1}:(t=e.match(/^\s*rgba\s*\(\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\s*,\s*([\d*.?\d*]+)\s*,\s*(\d*\.?\d*)\s*\)\s*$/i))&&(i={r:Number(t[1])/255,g:Number(t[2])/255,b:Number(t[3])/255,a:Number(t[4])})}if(!i||Number.isNaN(i.r)||Number.isNaN(i.g)||Number.isNaN(i.b)||Number.isNaN(i.a))throw new Error(`parseColor(): invalid color '${e}'`);return i.r=Math.pow(Math.min(1,i.r),2.2),i.g=Math.pow(Math.min(1,i.g),2.2),i.b=Math.pow(Math.min(1,i.b),2.2),i.a=Math.min(1,i.a),i}(s);this.colorValue.x=a.r,this.colorValue.y=a.g,this.colorValue.z=a.b,this.colorValue.w=a.a,this.textBindGroup.setValue("flip","webgpu"===e.type&&e.getFramebuffer()?1:0),this.textBindGroup.setValue("srgbOut",e.getFramebuffer()?0:1),this.textBindGroup.setValue("textMatrix",this.textMatrix),this.textBindGroup.setValue("textColor",this.colorValue),e.setProgram(this.textProgram),e.setVertexLayout(this.textVertexLayout),e.setRenderStates(this.textRenderStates),e.setBindGroup(0,this.textBindGroup);let o=0;const h=i.length;for(;o<h;){const t=Math.min(h-o,this.GLYPH_COUNT-this.textOffset);t>0&&(r=this.drawTextNoOverflow(e,i,o,t,r,n),o+=t,this.textOffset+=t),this.GLYPH_COUNT===this.textOffset&&(this.textOffset=0,e.flush())}e.popDeviceStates()}}static drawTextNoOverflow(t,e,i,s,r,n){let a=0,o=-1,h=0;for(;h<s;h++){const s=this.glyphManager.getGlyphInfo(e[h+i],this.font)||this.glyphManager.getGlyphInfo("?",this.font);o>=0&&s.atlasIndex!==o&&(this.textVertexBuffer.bufferSubData(16*(this.textOffset+a)*4,this.vertexCache,16*(this.textOffset+a),16*(h-a)),this.textBindGroup.setTexture("tex",this.glyphManager.getAtlasTexture(o)),t.draw("triangle-list",6*(this.textOffset+a),6*(h-a)),a=h),o=s.atlasIndex;const l=16*(this.textOffset+h);this.vertexCache[l+0]=r,this.vertexCache[l+1]=n,this.vertexCache[l+2]=s.uMin,this.vertexCache[l+3]=s.vMin,this.vertexCache[l+4]=r+s.width,this.vertexCache[l+5]=n,this.vertexCache[l+6]=s.uMax,this.vertexCache[l+7]=s.vMin,this.vertexCache[l+8]=r+s.width,this.vertexCache[l+9]=n+s.height,this.vertexCache[l+10]=s.uMax,this.vertexCache[l+11]=s.vMax,this.vertexCache[l+12]=r,this.vertexCache[l+13]=n+s.height,this.vertexCache[l+14]=s.uMin,this.vertexCache[l+15]=s.vMax,r+=s.width}return this.textVertexBuffer.bufferSubData(16*(this.textOffset+a)*4,this.vertexCache,16*(this.textOffset+a),16*(h-a)),this.textBindGroup.setTexture("tex",this.glyphManager.getAtlasTexture(o)),t.draw("triangle-list",6*(this.textOffset+a),6*(h-a)),r}static prepareDrawText(t){if(!this.prepared){this.prepared=!0,this.font=this.font||ea.fetchFont("16px arial",t.getScale()),this.glyphManager=new sa(t,1024,1024,1),this.vertexCache=new Float32Array(16*this.GLYPH_COUNT),this.textVertexBuffer=t.createInterleavedVertexBuffer(["position_f32x2","tex0_f32x2"],this.vertexCache,{dynamic:!0});const e=new Uint16Array(6*this.GLYPH_COUNT);for(let t=0;t<this.GLYPH_COUNT;t++){const i=4*t;e[6*t+0]=i+0,e[6*t+1]=i+1,e[6*t+2]=i+2,e[6*t+3]=i+0,e[6*t+4]=i+2,e[6*t+5]=i+3}const i=t.createIndexBuffer(e);this.textVertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:this.textVertexBuffer}],indexBuffer:i}),this.textOffset=0,this.textProgram=t.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.$inputs.uv=t.vec2().attrib("texCoord0"),this.$outputs.uv=t.vec2(),this.flip=t.int(0).uniform(0),this.textMatrix=t.mat4().uniform(0),t.main((function(){this.$builtins.position=t.mul(this.textMatrix,t.vec4(this.$inputs.pos,-50,1)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})),this.$outputs.uv=this.$inputs.uv}))},fragment(t){this.$outputs.color=t.vec4(),this.textColor=t.vec4().uniform(0),this.tex=t.tex2D().uniform(0),this.srgbOut=t.int().uniform(0),t.main((function(){this.alpha=t.mul(t.textureSample(this.tex,this.$inputs.uv).a,this.textColor.a),this.$if(t.notEqual(this.srgbOut,0),(function(){this.$outputs.color=t.vec4(t.mul(t.pow(this.textColor.rgb,t.vec3(1/2.2)),this.alpha),this.alpha)})).$else((function(){this.$outputs.color=t.vec4(t.mul(this.textColor.rgb,this.alpha),this.alpha)}))}))}}),this.textBindGroup=t.createBindGroup(this.textProgram.bindGroupLayouts[0]),this.textRenderStates=t.createRenderStateSet(),this.textRenderStates.useBlendingState().enable(!0).setBlendFuncRGB("one","inv-src-alpha").setBlendFuncAlpha("zero","one"),this.textRenderStates.useDepthState().enableTest(!1).enableWrite(!1),this.textRenderStates.useRasterizerState().setCullMode("none")}}}class na{_memCost;_memCostThreshold;_device;_freeTextures={};_allocatedTextures=new WeakMap;_autoReleaseTextures=new Set;_freeFramebuffers={};_allocatedFramebuffers=new WeakMap;_autoReleaseFramebuffers=new Set;constructor(t,e=1073741824){this._device=t,this._memCost=0,this._memCostThreshold=e,this._freeTextures={},this._allocatedTextures=new WeakMap,this._autoReleaseTextures=new Set,this._freeFramebuffers={},this._allocatedFramebuffers=new WeakMap,this._autoReleaseFramebuffers=new Set,this._memCost=0}autoRelease(){for(const t of this._autoReleaseTextures)this.releaseTexture(t);this._autoReleaseTextures.clear();for(const t of this._autoReleaseFramebuffers)this.releaseFrameBuffer(t);this._autoReleaseFramebuffers.clear(),this._memCost>=this._memCostThreshold&&this.purge()}fetchTemporalTexture2D(t,e,i,s,r){const n=`2d:${e}:${i}:${s}:${r?1:0}`;let a=null;const o=this._freeTextures[n];return o?(a=o.pop(),0===o.length&&delete this._freeTextures[n]):(a=this._device.createTexture2D(e,i,s,r?{}:{samplerOptions:{mipFilter:"none"}}),this._memCost+=a.memCost),this._allocatedTextures.set(a,{hash:n,refcount:1,dispose:!1}),t&&this._autoReleaseTextures.add(a),a}fetchTemporalTexture2DArray(t,e,i,s,r,n){const a=`2darray:${e}:${i}:${s}:${r}:${n?1:0}`;let o=null;const h=this._freeTextures[a];return h?(o=h.pop(),0===h.length&&delete this._freeTextures[a]):(o=this._device.createTexture2DArray(e,i,s,r,n?{}:{samplerOptions:{mipFilter:"none"}}),this._memCost+=o.memCost),this._allocatedTextures.set(o,{hash:a,refcount:1,dispose:!1}),t&&this._autoReleaseTextures.add(o),o}fetchTemporalTextureCube(t,e,i,s){const r=`cube:${e}:${i}:${s?1:0}`;let n=null;const a=this._freeTextures[r];return a?(n=a.pop(),0===a.length&&delete this._freeTextures[r]):(n=this._device.createCubeTexture(e,i,s?{}:{samplerOptions:{mipFilter:"none"}}),this._memCost+=n.memCost),this._allocatedTextures.set(n,{hash:r,refcount:1,dispose:!1}),t&&this._autoReleaseTextures.add(n),n}fetchTemporalFramebuffer(t,e,i,s,r,n,a,o){const h="string"==typeof s?[this.fetchTemporalTexture2D(!1,s,e,i,n)]:s?[s]:null,l="string"==typeof r?this.fetchTemporalTexture2D(!1,r,e,i,!1):r,u=this.createTemporalFramebuffer(t,h,l,a,o);return"string"==typeof s&&this.releaseTexture(h[0]),"string"==typeof r&&this.releaseTexture(l),u}createTemporalFramebuffer(t,e,i,s,r){e=e??[];let n=`${i?.uid??0}:${s??1}:${r?1:0}`;for(const t of e)n+=`:${t.uid}`;let a=null;const o=this._freeFramebuffers[n];o?(a=o.pop(),0===o.length&&delete this._freeFramebuffers[n]):a=this._device.createFrameBuffer(e,i,{ignoreDepthStencil:r,sampleCount:s});const h=this._allocatedTextures.get(i);h&&h.refcount++;for(const t of e){const e=this._allocatedTextures.get(t);e&&e.refcount++}return this._allocatedFramebuffers.set(a,n),t&&this._autoReleaseFramebuffers.add(a),a}disposeTexture(t){this.safeReleaseTexture(t,!0)}releaseTexture(t){this._allocatedTextures.get(t)?this.safeReleaseTexture(t):console.error("ObjectPool.releaseTexture(): texture is not allocated from pool")}disposeFrameBuffer(t){this._allocatedFramebuffers.get(t)?(this.internalDisposeFrameBuffer(t),t.dispose()):console.error("ObjectPool.disposeFrameBuffer(): framebuffer is not allocated from pool")}releaseFrameBuffer(t){const e=this._allocatedFramebuffers.get(t);if(e){this.internalDisposeFrameBuffer(t);const i=this._freeFramebuffers[e];i?i.push(t):this._freeFramebuffers[e]=[t]}else console.error("ObjectPool.releaseFrameBuffer(): framebuffer is not allocated from pool")}purge(){for(const t in this._freeFramebuffers){if(this._freeFramebuffers[t])for(const e of this._freeFramebuffers[t])this.internalDisposeFrameBuffer(e),e.dispose()}this._freeFramebuffers={};for(const t in this._freeTextures){const e=this._freeTextures[t];for(const t of e)this._memCost-=t.memCost,t.dispose()}this._freeTextures={}}internalDisposeFrameBuffer(t){if(t){const e=t.getColorAttachments();if(e)for(const t of e)this.safeReleaseTexture(t);const i=t.getDepthAttachment();i&&this.safeReleaseTexture(i),this._allocatedFramebuffers.delete(t),this._autoReleaseFramebuffers.delete(t)}}safeReleaseTexture(t,e=!1){const i=this._allocatedTextures.get(t);if(i)if(i.refcount--,0===i.refcount)if(this._allocatedTextures.delete(t),this._autoReleaseTextures.delete(t),e||i.dispose)this._memCost-=t.memCost,t.dispose();else{const e=this._freeTextures[i.hash];e?e.push(t):this._freeTextures[i.hash]=[t]}else e&&(i.dispose=!0)}}class aa{_canvas;_canvasClientWidth;_canvasClientHeight;_gpuObjectList;_gpuMemCost;_disposeObjectList;_beginFrameTime;_endFrameTime;_frameInfo;_cpuTimer;_gpuTimer;_runningLoop;_fpsCounter;_runLoopFunc;_backend;_beginFrameCounter;_programBuilder;_pool;_temporalFramebuffer;_vSync;_stateStack;constructor(t,e){this._backend=e,this._gpuObjectList={textures:[],samplers:[],buffers:[],programs:[],framebuffers:[],vertexArrayObjects:[],bindGroups:[]},this._canvas=t,this._canvas.setAttribute("tabindex","1"),this._canvasClientWidth=t.clientWidth,this._canvasClientHeight=t.clientHeight,this._gpuMemCost=0,this._disposeObjectList=[],this._beginFrameTime=0,this._endFrameTime=0,this._runLoopFunc=null,this._frameInfo={frameCounter:0,frameTimestamp:0,elapsedTimeCPU:0,elapsedTimeGPU:0,elapsedFrame:0,elapsedOverall:0,FPS:0,drawCalls:0,computeCalls:0,nextFrameCall:[],nextFrameCallNext:[]},this._programBuilder=new Un(this),this._cpuTimer=new Ws,this._gpuTimer=null,this._runningLoop=null,this._fpsCounter={time:0,frame:0},this._stateStack=[],this._beginFrameCounter=0,this._pool=new na(this),this._temporalFramebuffer=!1,this._vSync=!0,this._registerEventHandlers()}get backend(){return this._backend}get videoMemoryUsage(){return this._gpuMemCost}get frameInfo(){return this._frameInfo}get isRendering(){return null!==this._runningLoop}get canvas(){return this._canvas}get type(){return this._backend.typeName()}get vSync(){return this._vSync}set vSync(t){this._vSync=!!t}get pool(){return this._pool}get runLoopFunction(){return this._runLoopFunc}get programBuilder(){return this._programBuilder}setFont(t){ra.setFont(this,t)}drawText(t,e,i,s){ra.drawText(this,t,s,e,i)}setFramebuffer(t,e,i){let s=null,r=!1;if(Array.isArray(t)){const n=t.map((t=>t.texture??t));s=this._pool.createTemporalFramebuffer(!1,n,e,i,!0);for(let e=0;e<t.length;e++){const i=t[e];s.setColorAttachmentMipLevel(e,i.texture?i.miplevel??0:0),s.setColorAttachmentLayer(e,i.texture?i.face??0:0),s.setColorAttachmentCubeFace(e,i.texture?i.layer??0:0)}r=!0}else s=t??null;const n=this.getFramebuffer();n!==s&&(this._temporalFramebuffer&&this._pool.releaseFrameBuffer(n),this._temporalFramebuffer=r,this._setFramebuffer(s))}disposeObject(t,e=!0){t&&(e&&this.removeGPUObject(t),t.disposed||(this.isContextLost()?t.destroy():this._disposeObjectList.push(t)),t.dispatchEvent(null,"disposed"))}async restoreObject(t){t&&t.disposed&&!this.isContextLost()&&(await t.restore(),t.restoreHandler&&await t.restoreHandler(t))}enableGPUTimeRecording(t){t&&!this._gpuTimer?this._gpuTimer=this.createGPUTimer():t||(this._gpuTimer?.end(),this._gpuTimer=null)}beginFrame(){if(0===this._beginFrameCounter){for(const t of this._disposeObjectList)t.destroy();this._disposeObjectList=[]}return this._beginFrameCounter++,this._beginFrameTime=this._cpuTimer.now(),this.updateFrameInfo(),this._pool.autoRelease(),this.onBeginFrame()}endFrame(){this._beginFrameCounter>0&&(this._beginFrameCounter--,0===this._beginFrameCounter&&(this._endFrameTime=this._cpuTimer.now(),this.onEndFrame()))}getVertexAttribFormat(t,e,i){return function(t,e,i){const s=Ps(t);for(const t in Is){const r=Is[t];if(r[0]===s&&r[3]===e&&r[4]===i)return t}return null}(t,e,i)}createInterleavedVertexBuffer(t,e,i){if(i&&i.usage&&"vertex"!==i.usage)return console.error("createVertexBuffer() failed: options.usage must be 'vertex' or not set"),null;let s=0;for(const e of t)s+=Bs(e);const r=ks(e.byteLength/s>>0,...t),n=Object.assign({usage:"vertex",dynamic:!1,managed:!0,storage:!1},i||{});return n.storage&&(n.dynamic=!1,n.managed=!1),n.dynamic&&(n.managed=!1),this.createStructuredBuffer(r,n,e)}createVertexBuffer(t,e,i){if(i&&i.usage&&"vertex"!==i.usage)return console.error("createVertexBuffer() failed: options.usage must be 'vertex' or not set"),null;const s=Bs(t),r=ks(e.byteLength/s>>0,t),n=Object.assign({usage:"vertex",dynamic:!1,managed:!0,storage:!1},i||{});return n.storage&&(n.dynamic=!1,n.managed=!1),n.dynamic&&(n.managed=!1),this.createStructuredBuffer(r,n,e)}draw(t,e,i){this._frameInfo.drawCalls++,this._draw(t,e,i)}drawInstanced(t,e,i,s){this._frameInfo.drawCalls++,this._drawInstanced(t,e,i,s)}compute(t,e,i){this._frameInfo.computeCalls++,this._compute(t,e,i)}runNextFrame(t){t&&this._frameInfo.nextFrameCall.push(t)}exitLoop(){null!==this._runningLoop&&(0!==this._runningLoop?cancelAnimationFrame(this._runningLoop):this.cancelNextFrame(this._runningLoop),this._runningLoop=null)}runLoop(t){if(null!==this._runningLoop)return void console.error("Device.runLoop() can not be nested");if(!t)return void console.error("Device.runLoop() argment error");const e=this;e._runLoopFunc=t,function t(){e._vSync?e._runningLoop=requestAnimationFrame(t):e._runningLoop=e.nextFrame((()=>{null!==e._runningLoop&&t()})),e.beginFrame()&&(e._runLoopFunc(e),e.endFrame())}()}pushDeviceStates(){this._stateStack.push({windowOrderReversed:this.isWindingOrderReversed(),framebuffer:this.getFramebuffer(),viewport:this.getViewport(),scissor:this.getScissor(),program:this.getProgram(),renderStateSet:this.getRenderStates(),vertexLayout:this.getVertexLayout(),bindGroups:[this.getBindGroup(0),this.getBindGroup(1),this.getBindGroup(2),this.getBindGroup(3)]})}popDeviceStates(){if(0===this._stateStack.length)console.error("Device.popDeviceStates(): stack is empty");else{const t=this._stateStack.pop();this.setFramebuffer(t.framebuffer),this.setViewport(t.viewport),this.setScissor(t.scissor),this.setProgram(t.program),this.setRenderStates(t.renderStateSet),this.setVertexLayout(t.vertexLayout),this.setBindGroup(0,...t.bindGroups[0]),this.setBindGroup(1,...t.bindGroups[1]),this.setBindGroup(2,...t.bindGroups[2]),this.setBindGroup(3,...t.bindGroups[3]),this.reverseVertexWindingOrder(t.windowOrderReversed)}}getGPUObjects(){return this._gpuObjectList}getGPUObjectById(t){for(const e of[this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.buffers,this._gpuObjectList.framebuffers,this._gpuObjectList.programs,this._gpuObjectList.vertexArrayObjects])for(const i of e)if(i.uid===t)return i;return null}screenToDevice(t){return this.getFramebuffer()?t:Math.round(t*this.getScale())}deviceToScreen(t){return this.getFramebuffer()?t:Math.round(t/this.getScale())}buildRenderProgram(t){return this._programBuilder.buildRenderProgram(t)}buildComputeProgram(t){return this._programBuilder.buildComputeProgram(t)}addGPUObject(t){const e=this.getGPUObjectList(t);e&&e.indexOf(t)<0&&(e.push(t),this.dispatchEvent(new Mt(t)))}removeGPUObject(t){const e=this.getGPUObjectList(t);if(e){const i=e.indexOf(t);i>=0&&(e.splice(i,1),this.dispatchEvent(new Rt(t)))}}updateVideoMemoryCost(t){this._gpuMemCost+=t}_onresize(){this._canvasClientWidth===this._canvas.clientWidth&&this._canvasClientHeight===this._canvas.clientHeight||(this._canvasClientWidth=this._canvas.clientWidth,this._canvasClientHeight=this._canvas.clientHeight,this.dispatchEvent(new At(this._canvasClientWidth,this._canvasClientHeight)))}_registerEventHandlers(){const t=this._canvas,e=this;window.ResizeObserver?new window.ResizeObserver((t=>{e._onresize()})).observe(t,{}):(window.MutationObserver&&new MutationObserver((function(t){t.length>0&&e._onresize()})).observe(t,{attributes:!0,attributeFilter:["style"]}),window.addEventListener("resize",(()=>{this._onresize()})))}updateFrameInfo(){this._frameInfo.frameCounter++,this._frameInfo.drawCalls=0,this._frameInfo.computeCalls=0;const t=this._beginFrameTime;if(0===this._frameInfo.frameTimestamp)this._frameInfo.frameTimestamp=t,this._frameInfo.elapsedTimeCPU=0,this._frameInfo.elapsedTimeGPU=0,this._frameInfo.elapsedFrame=0,this._frameInfo.elapsedOverall=0,this._frameInfo.FPS=0,this._fpsCounter.time=t,this._fpsCounter.frame=this._frameInfo.frameCounter,this._gpuTimer&&this._gpuTimer.begin();else{this._frameInfo.elapsedFrame=t-this._frameInfo.frameTimestamp,this._frameInfo.elapsedOverall+=this._frameInfo.elapsedFrame;let e=0,i=0;0!==this._endFrameTime&&(e=t-this._endFrameTime,i=this._endFrameTime-this._frameInfo.frameTimestamp),this._frameInfo.frameTimestamp=t,t>=this._fpsCounter.time+1e3&&(this._frameInfo.FPS=1e3*(this._frameInfo.frameCounter-this._fpsCounter.frame)/(t-this._fpsCounter.time),this._fpsCounter.time=t,this._fpsCounter.frame=this._frameInfo.frameCounter,this._frameInfo.elapsedTimeGPU=e,this._frameInfo.elapsedTimeCPU=i)}const e=this._frameInfo.nextFrameCall;this._frameInfo.nextFrameCall=this._frameInfo.nextFrameCallNext,this._frameInfo.nextFrameCallNext=e;for(const t of this._frameInfo.nextFrameCallNext)t();this._frameInfo.nextFrameCallNext.length=0}getGPUObjectList(t){let e=null;return t.isTexture()?e=this._gpuObjectList.textures:t.isSampler()?e=this._gpuObjectList.samplers:t.isBuffer()?e=this._gpuObjectList.buffers:t.isFramebuffer()?e=this._gpuObjectList.framebuffers:t.isProgram()?e=this._gpuObjectList.programs:t.isVertexLayout()?e=this._gpuObjectList.vertexArrayObjects:t.isBindGroup()&&(e=this._gpuObjectList.bindGroups),e}invalidateAll(){for(const t of[this._gpuObjectList.buffers,this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.programs,this._gpuObjectList.framebuffers,this._gpuObjectList.vertexArrayObjects,this._gpuObjectList.bindGroups])for(const e of t)this.disposeObject(e,!1);if(this.isContextLost()){for(const t of this._disposeObjectList)t.destroy();this._disposeObjectList=[]}}async reloadAll(){const t=[];for(const e of[this._gpuObjectList.buffers,this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.programs,this._gpuObjectList.framebuffers,this._gpuObjectList.vertexArrayObjects,this._gpuObjectList.bindGroups])for(const i of e.slice())t.push(i.reload());Promise.all(t)}parseTextureOptions(t){return("none"===t?.samplerOptions?.mipFilter?Ls.TF_NO_MIPMAP:0)|(t?.writable?Ls.TF_WRITABLE:0)|(t?.dynamic?Ls.DYNAMIC:0)}parseBufferOptions(t,e){let i;switch(t?.usage||e){case"uniform":i=Ls.BF_UNIFORM,t.managed=!1,t.dynamic=t.dynamic??!0;break;case"vertex":i=Ls.BF_VERTEX;break;case"index":i=Ls.BF_INDEX;break;case"read":i=Ls.BF_READ,t.managed=!1;break;case"write":i=Ls.BF_WRITE,t.managed=!1;break;default:i=0}const s=t?.storage?Ls.BF_STORAGE:0,r=t?.dynamic?Ls.DYNAMIC:0;return i|s|r|(0===r&&(t?.managed??1)?Ls.MANAGED:0)}}class oa{_cache;_buffer;_size;_uniformMap;_uniformPositions;constructor(t,e){if(this._size=t.byteSize+15&-16,this._size<=0)throw new Error(`UniformBuffer(): invalid uniform buffer byte size: ${this._size}`);this._uniformMap={},this._uniformPositions={},this._cache=e instanceof ArrayBuffer?e:null,this._buffer=e instanceof ArrayBuffer?null:e,this.init(t,0,"")}get byteLength(){return this._size}get buffer(){return this._cache}get uniforms(){return this._uniformMap}set(t,e){if(void 0!==e){const i=this._uniformMap[t];if(i)if(this._cache)if("number"==typeof e)i[0]=e;else if(e?._v)i.set(e._v);else{if("number"!=typeof e?.length)throw new Error("invalid uniform value");i.set(e)}else{const s=this._uniformPositions[t][1];if("number"==typeof e)i[0]=e,this._buffer.bufferSubData(this._uniformPositions[t][0],i);else{if(!(e.BYTES_PER_ELEMENT&&s<=e.byteLength))throw new Error("invalid uniform value");{const i=e;this._buffer.bufferSubData(this._uniformPositions[t][0],i,0,s/i.BYTES_PER_ELEMENT>>0)}}}else{if(Object.getPrototypeOf(e)!==Object.getPrototypeOf({}))throw new Error("invalid uniform value");this.setStruct(t,e)}}}setStruct(t,e){for(const i in e)this.set(`${t}.${i}`,e[i])}init(t,e,i){for(const s of t.entries)if(s.subLayout)e=this.init(s.subLayout,e,`${i}${s.name}.`);else{const t=`${i}${s.name}`;if(this._uniformPositions[t])throw new Error(`UniformBuffer(): duplicate uniform name: ${t}`);if(s.offset<e||s.byteSize<0)throw new Error("UniformBuffer(): invalid layout");this._uniformPositions[t]=[s.offset,s.byteSize];let r=null;switch(s.type){case Bt.F32:r=Float32Array;break;case Bt.U32:case Bt.BOOL:r=Uint32Array;break;case Bt.I32:r=Int32Array;break;case Bt.U16:case Bt.U16_NORM:case Bt.F16:r=Uint16Array;break;case Bt.I16:case Bt.I16_NORM:r=Int16Array;break;case Bt.U8:case Bt.U8_NORM:r=Uint8Array;break;case Bt.I8:case Bt.I8_NORM:r=Int8Array}if(!r)throw new Error(`UniformBuffer(): invalid data type for uniform: ${t}`);if(s.byteSize%r.BYTES_PER_ELEMENT)throw new Error(`UniformBuffer(): invalid byte size for uniform: ${t}`);this._cache?this._uniformMap[t]=new r(this._cache,s.offset,s.byteSize/r.BYTES_PER_ELEMENT):this._uniformMap[t]=new r(1),e=s.offset+s.byteSize}return e}}function ha(t,e){const i=t.$builder;if(!e||!e.$typeinfo.isPrimitiveType()||e.$typeinfo.primitiveType!==Bt.F32VEC4)throw new Error("decodeNormalizedFloatFromRGBA() failed: parameter type must be vec4");if(!(t&&t instanceof Hn))throw new Error("decodeNormalizedFloatFromRGBA() failed: decodeNormalizedFloatFromRGBA() must be called inside a function");const s="Z_decodeNormalizedFloatFromRGBA";return i.func(s,[i.vec4("value")],(function(){this.$l.bitShift=i.vec4(1/16777216,1/65536,1/256,1),this.$return(i.dot(this.value,this.bitShift))})),t[s](e)}function la(t,e){const i=t.$builder,s="Z_encodeNormalizedFloatToRGBA";return i.func(s,[i.float("value")],(function(){this.$l.bitShift=i.vec4(16777216,65536,256,1),this.$l.bitMask=i.vec4(0,1/256,1/256,1/256),this.$l.t=i.fract(i.mul(this.value,this.bitShift)),this.$return(i.sub(this.t,i.mul(this.t.xxyz,this.bitMask)))})),i.getGlobalScope()[s](e)}function ua(t,e){const i=t.$builder,s="Z_decode2HalfFromRGBA";return i.func(s,[i.vec4("value")],(function(){this.$return(i.vec2(i.add(this.value.x,i.div(this.value.y,255)),i.add(this.value.z,i.div(this.value.w,255))))})),i.getGlobalScope()[s](e)}function ca(t,e){const i=t.$builder,s="Z_linearToGamma";return i.func(s,[i.vec3("color")],(function(){this.$return(i.max(i.sub(i.mul(i.pow(this.color,i.vec3(.416666667)),1.055),i.vec3(.055)),i.vec3(0)))})),i.getGlobalScope()[s](e)}new b(0,0,-1),new b(0,-1,0),new b(1,0,0),new b(0,0,1),new b(0,-1,0),new b(-1,0,0),new b(1,0,0),new b(0,0,1),new b(0,1,0),new b(1,0,0),new b(0,0,-1),new b(0,-1,0),new b(1,0,0),new b(0,-1,0),new b(0,0,1),new b(-1,0,0),new b(0,-1,0),new b(0,0,-1);class da{_vertexLayout;_vertexLayoutOptions;_primitiveType;_indexStart;_indexCount;_defaultIndexCount;_vertexLayoutDirty;static _nextId=0;_id;_bbox;_bboxChangeCallback;constructor(){this._vertexLayout=null,this._vertexLayoutOptions={vertexBuffers:[]},this._primitiveType="triangle-list",this._indexStart=0,this._indexCount=null,this._defaultIndexCount=0,this._vertexLayoutDirty=!1,this._id=++da._nextId,this._bbox=null,this._bboxChangeCallback=[]}get id(){return this._id}addBoundingboxChangeCallback(t){t&&this._bboxChangeCallback.push(t)}removeBoundingboxChangeCallback(t){const e=this._bboxChangeCallback.indexOf(t);e>=0&&this._bboxChangeCallback.splice(e,1)}get primitiveType(){return this._primitiveType}set primitiveType(t){this._primitiveType=t}get indexStart(){return this._indexStart}set indexStart(t){this._indexStart=t}get indexCount(){return this._indexCount=this._indexCount??this.calcDefaultIndexCount(),this._indexCount}set indexCount(t){this._indexCount=t}getNumVertices(){const t=this.getVertexBufferInfo("position");return t?.buffer?t.buffer.byteLength/t.stride>>0:0}getNumFaces(){const t=this.getIndexBuffer(),e=t?t.byteLength>>(t.indexType.primitiveType===Bt.U16?1:2):this.getNumVertices();switch(this.primitiveType){case"line-list":return e>>1;case"point-list":return e;case"line-strip":return e-1;case"triangle-fan":case"triangle-strip":return e-2;case"triangle-list":return e/3>>0;default:return 0}}removeVertexBuffer(t){for(let e=0;e<this._vertexLayoutOptions.vertexBuffers.length;e++){const i=this._vertexLayoutOptions.vertexBuffers[e];i?.buffer===t&&(i[e]=null,this._vertexLayoutDirty=!0)}}getVertexBuffer(t){return this.checkVertexLayout(),this._vertexLayout.getVertexBuffer(t)}getVertexBufferInfo(t){return this.checkVertexLayout(),this._vertexLayout.getVertexBufferInfo(t)}createAndSetVertexBuffer(t,e,i){const s=q.instance.device.createVertexBuffer(t,e);return this.setVertexBuffer(s,i)}setVertexBuffer(t,e){return this._vertexLayoutOptions.vertexBuffers.push({buffer:t,stepMode:e}),this._vertexLayoutDirty=!0,t}createAndSetIndexBuffer(t,e){const i=q.instance.device.createIndexBuffer(t,{dynamic:!!e,managed:!e});return this.setIndexBuffer(i),i}setIndexBuffer(t){this._vertexLayoutOptions.indexBuffer!==t&&(this._vertexLayoutOptions.indexBuffer=t,this._vertexLayoutDirty=!0)}getIndexBuffer(){return this._vertexLayoutOptions.indexBuffer}draw(){this.checkVertexLayout(),this.indexCount>0&&this._vertexLayout?.draw(this._primitiveType,this._indexStart,this.indexCount)}drawInstanced(t){this.checkVertexLayout(),this.indexCount>0&&this._vertexLayout?.drawInstanced(this._primitiveType,this._indexStart,this.indexCount,t)}dispose(){if(this._vertexLayout){const t=this._vertexLayout.vertexBuffers;for(const e in t)t[e]?.buffer?.dispose();this._vertexLayout.indexBuffer?.dispose(),this._vertexLayout.dispose(),this._vertexLayout=null}this._indexCount=null,this._indexStart=0}getBoundingVolume(){return this._bbox}setBoundingVolume(t){if(t!==this._bbox){this._bbox=t;for(const t of this._bboxChangeCallback)t()}}raycast(t){const e=this.getBoundingVolume()?.toAABB();return e?t.bboxIntersectionTestEx(e):null}checkVertexLayout(){this._vertexLayoutDirty&&(this._vertexLayout?.dispose(),this._vertexLayout=q.instance.device.createVertexLayout(this._vertexLayoutOptions),this._vertexLayoutDirty=!1)}calcDefaultIndexCount(){const t=this.getIndexBuffer();if(t)return Math.max(0,t.length-this._indexStart);const e=this.getVertexBufferInfo("position");return e?Math.max(0,Math.floor((e.buffer.byteLength-e.drawOffset)/e.stride)-this._indexStart):0}}class pa{_hash;_renderStates;_srgbOut;_flip;_viewport;_scissor;_destRect;_offsetParams;constructor(){this._hash=null,this._renderStates=null,this._srgbOut=!1,this._flip=!1,this._viewport=null,this._scissor=null,this._destRect=null,this._offsetParams=new T}get viewport(){return this._viewport}set viewport(t){this._viewport=t??null}get scissor(){return this._scissor}set scissor(t){this._scissor=t??null}get destRect(){return this._destRect}set destRect(t){!!this._destRect!=!!t&&this.invalidateHash(),this._destRect=t??null}get srgbOut(){return this._srgbOut}set srgbOut(t){this._srgbOut!==!!t&&(this._srgbOut=!!t,this.invalidateHash())}get renderStates(){return this._renderStates}set renderStates(t){this._renderStates=t}get hash(){return this._hash||(this._hash=`${this.constructor.name}:${this._srgbOut?1:0}:${this._flip?1:0}:${this._destRect?1:0}:${this.calcHash()}`),this._hash}invalidateHash(){this._hash=null}readTexel(t,e,i,s,r,n){const a=t.$builder;if("float"===n)switch(e){case"2d":case"cube":return q.instance.device.getDeviceCaps().shaderCaps.supportShaderTextureLod?a.textureSampleLevel(i,s,0):a.textureSample(i,s);case"2d-array":return a.textureArraySampleLevel(i,s,r,0);default:return null}else switch(e){case"2d":return a.textureLoad(i,a.ivec2(a.mul(a.vec2(a.textureDimensions(i,0)),s)),0);case"cube":throw new Error("Integer format cube texture not supported");case"2d-array":return a.textureArrayLoad(i,a.ivec2(a.mul(a.vec2(a.textureDimensions(i,0)),s)),r,0);default:return null}}writeTexel(t,e,i,s){return s}setup(t,e){}setUniforms(t,e){}blit2D(t,e,i){const s=q.instance.device,r=!e&&"webgpu"===s.type,n=ba("2d",this,i?"linear"===i.magFilter||"linear"===i.minFilter||"linear"===i.mipFilter:t.isFilterable(),t.isIntegerFormat()?t.isSignedFormat()?"int":"uint":"float",r);if(n.bindGroup.setTexture("srcTex",t,i),this._destRect){const t=this._viewport?.[2]??e?.getWidth()??s.getBackBufferWidth(),i=this._viewport?.[3]??e?.getHeight()??s.getBackBufferHeight();this._offsetParams.setXYZW(this._destRect[2]/t,this._destRect[3]/i,(this._destRect[2]+2*this._destRect[0])/t-1,(this._destRect[3]+2*this._destRect[1])/i-1),n.bindGroup.setValue("scaleBias",this._offsetParams)}this.setUniforms(n.bindGroup,t),s.setFramebuffer(e??null),s.setViewport(this._viewport),s.setScissor(this._scissor),s.setProgram(n.program),s.setBindGroup(0,n.bindGroup),s.setRenderStates(this._renderStates??xa()),ga().draw()}blit2DArray(t,e,i,s){const r=q.instance.device,n=!e&&"webgpu"===r.type,a=ba("2d-array",this,s?"linear"===s.magFilter||"linear"===s.minFilter||"linear"===s.mipFilter:t.isFilterable(),t.isIntegerFormat()?t.isSignedFormat()?"int":"uint":"float",n);a.bindGroup.setTexture("srcTex",t,s),a.bindGroup.setValue("srcLayer",i),this.setUniforms(a.bindGroup,t),r.setFramebuffer(e??null),r.setViewport(this._viewport),r.setScissor(this._scissor),r.setProgram(a.program),r.setBindGroup(0,a.bindGroup),r.setRenderStates(this._renderStates??xa()),ga().draw()}blitCubeMap(t,e,i,s){const r=q.instance.device,n=!e&&"webgpu"===r.type,a=ba("cube",this,s?"linear"===s.magFilter||"linear"===s.minFilter||"linear"===s.mipFilter:t.isFilterable(),t.isIntegerFormat()?t.isSignedFormat()?"int":"uint":"float",n);a.bindGroup.setTexture("srcTex",t,s),a.bindGroup.setValue("texelSize",1/t.width),a.bindGroup.setValue("cubeFace",i),this.setUniforms(a.bindGroup,t),r.setFramebuffer(e??null),r.setViewport(this._viewport),r.setScissor(this._scissor),r.setProgram(a.program),r.setBindGroup(0,a.bindGroup),r.setRenderStates(this._renderStates??xa()),ga().draw()}blit(t,e,i,s){const r=q.instance.device;if(r.pushDeviceStates(),e){const n=e.isFramebuffer()?e:r.pool.createTemporalFramebuffer(!1,[e],null),a=e.isFramebuffer()?e.getColorAttachments()?.[0]:e;if(t.isTexture2D()){if(!a?.isTexture2D()&&!a?.isTexture2DArray())throw new Error("Blitter.blit() failed: invalid destination texture type");a.isTexture2DArray()&&n.setColorAttachmentLayer(0,i||0),this.blit2D(t,n,s)}else if(t.isTexture2DArray()){if(!a?.isTexture2D()&&!a.isTexture2DArray())throw new Error("Blitter.blit() failed: invalid destination texture type");if(a.isTexture2D())this.blit2DArray(t,n,i||0,s);else{if(a.depth!==t.depth)throw new Error("Blitter.blit() failed: can not blit between texture 2d arrays with different array size");for(let e=0;e<t.depth;e++)n.setColorAttachmentLayer(0,e),this.blit2DArray(t,n,e,i)}}else{if(!t.isTextureCube())throw new Error("Blitter.blit() failed: invalid texture type");if(!a.isTextureCube()&&!a.isTexture2D())throw new Error("Blitter.blit() failed: invalid destination texture type");if(a.isTextureCube())for(let e=0;e<6;e++)n.setColorAttachmentCubeFace(0,e),this.blitCubeMap(t,n,e,i);else this.blitCubeMap(t,n,i||0,s)}n&&n!==e&&r.pool.releaseFrameBuffer(n)}else if(t.isTexture2D())this.blit2D(t,null,s);else if(t.isTexture2DArray())this.blit2DArray(t,null,i||0,s);else{if(!t.isTextureCube())throw new Error("Blitter.blit() failed: invalid texture type");this.blitCubeMap(t,null,i||0,s)}r.popDeviceStates()}}const ma={};let fa=null,_a=null;function ga(){if(!fa){fa=new da;const t=q.instance.device.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]));fa.setVertexBuffer(t),fa.indexCount=4,fa.indexStart=0,fa.primitiveType="triangle-strip"}return fa}function xa(){return _a||(_a=q.instance.device.createRenderStateSet(),_a.useDepthState().enableTest(!1).enableWrite(!1),_a.useRasterizerState().setCullMode("none")),_a}function ba(t,e,i,s,r){const n=`${t}:${e.hash}:${i}:${s}:${r?1:0}`;let a=ma[n];return void 0===a&&(a=function(t,e,i,s,r,n){const a=q.instance.device.buildRenderProgram({vertex(i){this.$inputs.pos=i.vec2().attrib("position"),this.$outputs.uv=i.vec2(),n&&(this.scaleBias=i.vec4().uniform(0)),e.setup(this,t),i.main((function(){this.$builtins.position=i.vec4(this.$inputs.pos,1,1),this.$outputs.uv="cube"===t?i.mul(i.vec2(1,-1),this.$inputs.pos.xy):i.add(i.mul(this.$inputs.pos.xy,.5),i.vec2(.5)),"webgpu"===q.instance.device.type&&(this.$builtins.position.y=i.neg(this.$builtins.position.y)),n&&(this.$l.xy=i.add(i.mul(this.$builtins.position.xy,this.scaleBias.xy),this.scaleBias.zw),this.$builtins.position=i.vec4(this.xy,1,1))}))},fragment(n){switch(t){case"2d":this.srcTex="int"===s?n.itex2D().sampleType("sint").uniform(0):"uint"===s?n.utex2D().sampleType("uint").uniform(0):n.tex2D().sampleType(i?"float":"unfilterable-float").uniform(0);break;case"2d-array":this.srcTex="int"===s?n.itex2DArray().sampleType("sint").uniform(0):"uint"===s?n.utex2DArray().sampleType("uint").uniform(0):n.tex2DArray().sampleType(i?"float":"unfilterable-float").uniform(0),this.srcLayer=n.int().uniform(0);break;case"cube":this.srcTex="int"===s?n.itexCube().sampleType("sint").uniform(0):"uint"===s?n.utexCube().sampleType("uint").uniform(0):n.texCube().sampleType(i?"float":"unfilterable-float").uniform(0),this.texelSize=n.float().uniform(0),this.cubeFace=n.int().uniform(0);break;default:throw new Error(`invalid blit type: ${t}`)}this.$outputs.outColor=n.vec4(),e.setup(this,t),n.main((function(){"cube"===t?(this.uv=n.vec3(),this.$if(n.equal(this.cubeFace,0),(function(){this.uv=n.vec3(1,this.$inputs.uv.y,n.neg(this.$inputs.uv.x))})).$elseif(n.equal(this.cubeFace,1),(function(){this.uv=n.vec3(-1,this.$inputs.uv.y,this.$inputs.uv.x)})).$elseif(n.equal(this.cubeFace,2),(function(){this.uv=n.vec3(this.$inputs.uv.x,1,n.neg(this.$inputs.uv.y))})).$elseif(n.equal(this.cubeFace,3),(function(){this.uv=n.vec3(this.$inputs.uv.x,-1,this.$inputs.uv.y)})).$elseif(n.equal(this.cubeFace,4),(function(){this.uv=n.vec3(this.$inputs.uv.x,this.$inputs.uv.y,1)})).$else((function(){this.uv=n.vec3(n.neg(this.$inputs.uv.x),this.$inputs.uv.y,-1)}))):this.uv=this.$inputs.uv,r&&(this.uv.y=n.sub(1,this.uv.y)),this.$l.outTexel=e.filter(this,t,this.srcTex,this.uv,"2d"===t?null:this.srcLayer,s),this.$outputs.outColor=e.writeTexel(this,t,this.$inputs.uv,this.outTexel),e.srgbOut&&(this.$outputs.outColor=n.vec4(ca(this,this.$outputs.outColor.rgb),this.$outputs.outColor.a))}))}});return a?{program:a,bindGroup:q.instance.device.createBindGroup(a.bindGroupLayouts[0])}:null}(t,e,i,s,r,!!e.destRect)||null,ma[n]=a),a}class wa extends pa{filter(t,e,i,s,r,n){return this.readTexel(t,e,i,s,r,n)}calcHash(){return""}}new b(0,0,-1),new b(0,-1,0),new b(1,0,0),new b(0,0,1),new b(0,-1,0),new b(-1,0,0),new b(1,0,0),new b(0,0,1),new b(0,1,0),new b(1,0,0),new b(0,0,-1),new b(0,-1,0),new b(1,0,0),new b(0,-1,0),new b(0,0,1),new b(-1,0,0),new b(0,-1,0),new b(0,0,-1);class Ta extends R{constructor(t,e){super(t,e)}behindPlane(t){return this.toAABB().behindPlane(t)}clone(){return new Ta(this)}transform(t){return new Ta(R.transform(this,t))}outsideFrustum(t){return(t instanceof M?this.getClipStateWithFrustum(t):this.getClipState(t))===p.NOT_CLIPPED}toAABB(){return this}}class va extends da{_options;constructor(t){super(),this._options=this.createDefaultOptions(),this.create(t)}get options(){return this._options}create(t){return t&&(this._options=this.createDefaultOptions(),Object.assign(this._options,t)),this._create()}createDefaultOptions(){return{needNormal:!0,needTangent:!1,needUV:!0}}}class ya extends va{constructor(t){super(t)}createDefaultOptions(){const t=super.createDefaultOptions();return t.size=1,t}_createArrays(t,e,i,s,r,n,a,o,h,l){const u=this._options.needTangent,c=this._options.needNormal||u,d=this._options.needUV,p=d?[0,0,0,1,1,1,1,0]:null,m=[r,h,a,r,h,l,o,h,l,o,h,a],f=c?[0,1,0,0,1,0,0,1,0,0,1,0]:null,_=[r,h,l,r,n,l,o,n,l,o,h,l],g=c?[0,0,1,0,0,1,0,0,1,0,0,1]:null,x=[o,h,l,o,n,l,o,n,a,o,h,a],b=c?[1,0,0,1,0,0,1,0,0,1,0,0]:null,w=[o,h,a,o,n,a,r,n,a,r,h,a],T=c?[0,0,-1,0,0,-1,0,0,-1,0,0,-1]:null,v=[r,h,a,r,n,a,r,n,l,r,h,l],y=c?[-1,0,0,-1,0,0,-1,0,0,-1,0,0]:null,E=[r,n,l,r,n,a,o,n,a,o,n,l],S=c?[0,-1,0,0,-1,0,0,-1,0,0,-1,0]:null;s&&s.push(0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23),t&&t.push(...m,..._,...x,...w,...v,...E),c&&e&&e.push(...f,...g,...b,...T,...y,...S),d&&i&&i.push(...p,...p,...p,...p,...p,...p),this.primitiveType="triangle-list"}get width(){return this._options.sizeX??this._options.size??1}get height(){return this._options.sizeY??this._options.size??1}get depth(){return this._options.sizeZ??this._options.size??1}_create(){const t=this._options.needNormal,e=this._options.needUV,i=this._options.sizeX??this._options.size??1,s=this._options.sizeY??this._options.size??1,r=this._options.sizeZ??this._options.size??1,n=-.5*i,a=n+i,o=-.5*s,h=o+s,l=-.5*r,u=l+r,c=[],d=[],p=t?[]:null,m=e?[]:null;return this._createArrays(c,p,m,d,n,o,l,a,h,u),this.createAndSetVertexBuffer("position_f32x3",new Float32Array(c)),p&&this.createAndSetVertexBuffer("normal_f32x3",new Float32Array(p)),m&&this.createAndSetVertexBuffer("tex0_f32x2",new Float32Array(m)),this.createAndSetIndexBuffer(new Uint16Array(d)),this.setBoundingVolume(new Ta(new b(n,o,l),new b(a,h,u))),this.indexCount=d.length,!0}}class Ea extends va{constructor(t){super(t)}createDefaultOptions(){const t=super.createDefaultOptions();return t.size=1,t.needNormal=!1,t.needTangent=!1,t.needUV=!1,t}_createArrays(t,e,i,s,r,n,a,o){const h=[i,a,r,i,a,o,n,a,o,n,a,r],l=[i,s,o,i,s,r,n,s,r,n,s,o];e&&e.push(0,1,1,2,2,3,3,0,0,5,1,4,2,7,3,6,6,5,5,4,4,7,7,6),t&&t.push(...h,...l),this.primitiveType="line-list"}_create(){const t=this._options.sizeX??this._options.size??1,e=this._options.sizeY??this._options.size??1,i=this._options.sizeZ??this._options.size??1,s=-.5*t,r=s+t,n=-.5*e,a=n+e,o=-.5*i,h=o+i,l=[],u=[];return this._createArrays(l,u,s,n,o,r,a,h),this.createAndSetVertexBuffer("position_f32x3",new Float32Array(l)),this.createAndSetIndexBuffer(new Uint16Array(u)),this.setBoundingVolume(new Ta(new b(s,n,o),new b(r,a,h))),this.indexCount=u.length,!0}}var Sa;!function(t){t[t.PPP=0]="PPP",t[t.PPN=1]="PPN",t[t.PNP=2]="PNP",t[t.PNN=3]="PNN",t[t.NPP=4]="NPP",t[t.NPN=5]="NPN",t[t.NNP=6]="NNP",t[t.NNN=7]="NNN"}(Sa||(Sa={}));class Ca{_chunk;_position;_nodes;_box;_boxLoosed;constructor(){this._chunk=null,this._position=0,this._nodes=[],this._box=null,this._boxLoosed=null}getNodes(){return this._nodes}getLevel(){return this._chunk.getLevel()}addNode(t){t&&this._nodes.indexOf(t)<0&&(this._nodes.push(t),t.octreeNode=this)}removeNode(t){const e=this._nodes.indexOf(t);e>=0&&(this._nodes.splice(e,1),t.octreeNode=null)}clearNodes(){for(const t of this._nodes)t.octreeNode=null;this._nodes=[]}setChunk(t){console.assert(!!t,"Invalid chunk"),this._chunk=t}getChunk(){return this._chunk}setPosition(t){this._position=t}getPosition(){return this._position}getBox(){if(null===this._box){const t=new R;t.beginExtend();for(let e=0;e<8;e++){const i=this.getChild(e);if(i){const e=i.getBox();e&&(t.extend(e.minPoint),t.extend(e.maxPoint))}}t.isValid()&&(this._box=t)}return this._box}getBoxLoosed(){if(null===this._boxLoosed){console.assert(!!this._chunk,"Invalid chunk");const t=this._chunk.getDimension(),e=this._chunk.getNodeSize(),i=.5*this._chunk.getWorldSize(),s=this._position%t,r=Math.floor(this._position/t)%t,n=Math.floor(Math.floor(this._position/t)/t),a=new b(s-.5,r-.5,n-.5).scaleBy(e).subBy(new b(i,i,i)),o=new b(a.x+2*e,a.y+2*e,a.z+2*e);this._boxLoosed=new R(a,o)}return this._boxLoosed}getMinPoint(){console.assert(!!this._chunk,"Invalid chunk");const t=this._chunk.getDimension(),e=this._chunk.getNodeSize(),i=.5*this._chunk.getWorldSize(),s=this._position%t,r=Math.floor(this._position/t)%t,n=Math.floor(Math.floor(this._position/t)/t);return new b(s,r,n).scaleBy(e).subBy(new b(i,i,i))}getMaxPoint(){console.assert(!!this._chunk,"Invalid chunk");const t=this._chunk.getDimension(),e=this._chunk.getNodeSize(),i=.5*this._chunk.getWorldSize(),s=this._position%t+1,r=Math.floor(this._position/t)%t+1,n=Math.floor(Math.floor(this._position/t)/t)+1;return new b(s,r,n).scaleBy(e).subBy(new b(i,i,i))}getMinPointLoosed(){const t=.5*this._chunk.getNodeSize();return this.getMinPoint().subBy(new b(t,t,t))}getMaxPointLoosed(){const t=.5*this._chunk.getNodeSize();return this.getMaxPoint().addBy(new b(t,t,t))}getChild(t){console.assert(!!this._chunk,"Invalid chunk");const e=this._chunk.getNext();return e?e.getNode(this._chunk.getChildIndex(this._position,t)):null}getOrCreateChild(t){console.assert(!!this._chunk,"Invalid chunk");const e=this._chunk.getNext();return e?e.getOrCreateNode(this._chunk.getChildIndex(this._position,t)):null}getParent(){console.assert(!!this._chunk,"Invalid chunk");const t=this._chunk.getPrev();return t?t.getNode(this._chunk.getParentIndex(this._position)):null}getOrCreateParent(){console.assert(!!this._chunk,"Invalid chunk");const t=this._chunk.getPrev();return t?t.getOrCreateNode(this._chunk.getParentIndex(this._position)):null}createChildren(){this.getOrCreateChild(Sa.PPP),this.getOrCreateChild(Sa.PPN),this.getOrCreateChild(Sa.PNP),this.getOrCreateChild(Sa.PNN),this.getOrCreateChild(Sa.NPP),this.getOrCreateChild(Sa.NPN),this.getOrCreateChild(Sa.NNP),this.getOrCreateChild(Sa.NNN)}traverse(t){if(t.visit(this))for(let e=0;e<8;e++){const i=this.getChild(e);i&&i.traverse(t)}}}class Aa{_level;_dimension;_nodeSize;_prev;_next;_octree;_nodeMap;constructor(t){this._octree=t,this._level=0,this._dimension=0,this._nodeSize=0,this._next=null,this._prev=null,this._nodeMap=new Map}get nodeMap(){return this._nodeMap}getNode(t){return this._nodeMap.get(t)||null}getOrCreateNode(t){let e=this.getNode(t);return e||(e=new Ca,e.setChunk(this),e.setPosition(t),this._nodeMap.set(t,e)),e}getOrCreateNodeChain(t){const e=this.getOrCreateNode(t);return this._prev&&this._prev.getOrCreateNodeChain(this.getParentIndex(t)),e}clearNodes(){for(const t of this._nodeMap.keys())this._nodeMap.get(t).clearNodes(),this._nodeMap.delete(t)}getChildIndex(t,e){const i=this._dimension;let s=t%i*2,r=Math.floor(t/i)%i*2,n=2*Math.floor(Math.floor(t/i)/i);switch(e){case Sa.PPP:++s,++r,++n;break;case Sa.PPN:++s,++r;break;case Sa.PNP:++s,++n;break;case Sa.PNN:++s;break;case Sa.NPP:++r,++n;break;case Sa.NPN:++r;break;case Sa.NNP:++n;break;case Sa.NNN:break;default:return console.assert(!1,"getChildIndex: Got invalid index"),0}const a=2*i;return n*a*a+r*a+s}getParentIndex(t){const e=this._dimension,i=e>>1;return(t%e>>1)+(Math.floor(t/e)%e>>1)*i+(Math.floor(Math.floor(t/e)/e)>>1)*i*i}getNodeSize(){return this._nodeSize}getWorldSize(){return this._octree.getRootSize()}getDimension(){return this._dimension}getLevel(){return this._level}empty(){return 0===this._nodeMap.size}getNext(){return this._next}getPrev(){return this._prev}getOctree(){return this._octree}setLevel(t){this._level=t}setDimension(t){this._dimension=t}setNodeSize(t){this._nodeSize=t}setNext(t){this._next=t}setPrev(t){this._prev=t}}class Ma{_scene;_chunks;_rootSize;_leafSize;_rootNode;_nodeMap;constructor(t,e=4096,i=64){this._scene=t,this._chunks=[],this._rootSize=0,this._leafSize=0,this._rootNode=null,this._nodeMap=new WeakMap,this.initialize(e,i)}initialize(t,e){this.finalize(),this._leafSize=e,this._rootSize=Math.max(e,t);let i=1;for(;t>=2*e;e*=2,++i);for(let e=0;e<i;++e,t*=.5){const i=new Aa(this);i.setLevel(e),i.setNodeSize(t),i.setDimension(1<<e),this._chunks.push(i),e>0&&(this._chunks[e-1].setNext(i),i.setPrev(this._chunks[e-1]))}}finalize(){this._chunks.forEach((t=>t.clearNodes())),this._chunks=[],this._rootSize=0,this._leafSize=0,this._rootNode=null,this._nodeMap=new WeakMap}getScene(){return this._scene}getRootSize(){return this._rootSize}getLeafSize(){return this._leafSize}locateNodeChain(t,e,i){let s=this._chunks.length-1;for(;s&&this._chunks[s].getNodeSize()<4*i;)--s;const r=this._chunks[s].getDimension(),n=1/this._chunks[s].getNodeSize(),a=Math.floor((e.x+.5*this._rootSize)*n),o=Math.floor((e.y+.5*this._rootSize)*n),h=Math.floor((e.z+.5*this._rootSize)*n);if(a>=r||o>=r||h>=r)return null;const l=a+o*r+h*r*r;return t&&t.getChunk().getLevel()===s&&t.getPosition()===l?t:this._chunks[s].getOrCreateNodeChain(l)}getRootNode(){return this._rootNode||(this._rootNode=this._chunks[0].getOrCreateNode(0)),this._rootNode}getNumChunks(){return this._chunks.length}getChunk(t){return this._chunks[t]}placeNode(t){const e=this._nodeMap.get(t)||null;let i=this.getRootNode();if(t.clipTestEnabled){const s=t.getWorldBoundingVolume()?.toAABB();if(s&&s.isValid()){const r=s.center,n=s.extents,a=Math.max(Math.max(n.x,n.y),n.z);if(i=this.locateNodeChain(e,r,a),!i){const e=Math.max(...b.abs(s.minPoint),...b.abs(s.maxPoint));return this.resize(Math.max(2*e,4*a)),void this.placeNode(t)}}}e!==i&&(e?.removeNode(t),i?.addNode(t),this._nodeMap.set(t,i))}removeNode(t){if(t.isGraphNode()){const e=this._nodeMap.get(t)||null;e&&(e.removeNode(t),this._nodeMap.delete(t))}}resize(t){if((t=Math.max(l(t),this._leafSize))===this._rootSize)return;const e=[];for(const t of this._chunks)t.nodeMap.forEach((t=>{e.push(...t.getNodes())}));this.initialize(t,this._leafSize);for(const t of e)this.placeNode(t)}}const Ra=0,Fa="LUT_Sheen",Ia=1,Da=2,$a=3,La=255,Pa=256;class Na{_primaryCamera;_camera;_skipClipTest;_renderQueue;_renderPass;constructor(t,e,i,s){this._primaryCamera=s,this._camera=e,this._renderQueue=i,this._skipClipTest=!1,this._renderPass=t}get camera(){return this._camera}set camera(t){this._camera=t||null}get frustumCulling(){return!this._skipClipTest}set frustumCulling(t){this._skipClipTest=!t}get primaryCamera(){return this._primaryCamera}get renderPass(){return this._renderPass}get renderQueue(){return this._renderQueue}set renderQueue(t){this._renderQueue=t}get frustum(){return this._camera?.frustum||null}push(t,e){this.renderQueue.push(t,e)}pushRenderQueue(t){this.renderQueue.pushRenderQueue(t)}visit(t){return t instanceof Ca?this.visitOctreeNode(t):t.isMesh()?this.visitMesh(t):t.isTerrain()?this.visitTerrain(t):t.isPunctualLight()?this.visitPunctualLight(t):t.isBatchGroup()?this.visitBatchGroup(t):void 0}visitPunctualLight(t){if(!t.hidden){if(this.getClipStateWithNode(t)!==p.NOT_CLIPPED)return this.renderQueue.pushLight(t),!0}return!1}visitTerrain(t){if(!t.hidden&&(t.castShadow||1!==this._renderPass.type)){if(this.getClipStateWithNode(t)!==p.NOT_CLIPPED)return t.cull(this)>0}return!1}visitBatchGroup(t){if(!t.hidden){const e=t.getRenderQueue(this);return this.pushRenderQueue(e),!0}return!1}visitMesh(t){if(!t.hidden&&(t.castShadow||1!==this._renderPass.type)){if(this.getClipStateWithNode(t)!==p.NOT_CLIPPED)return this.push(this._camera,t),!0}return!1}visitOctreeNode(t){const e=t.getLevel()>0?this.getClipStateWithAABB(t.getBoxLoosed()):p.CLIPPED;if(e!==p.NOT_CLIPPED){const i=this._skipClipTest;this._skipClipTest=this._skipClipTest||e===p.A_INSIDE_B;const s=t.getNodes();for(let t=0;t<s.length;t++)this.visit(s[t]);return this._skipClipTest=i,!0}return!1}getClipStateWithNode(t){let e;if(this._skipClipTest)e=p.A_INSIDE_B;else if(t.clipTestEnabled){const i=t.getWorldBoundingVolume();e=i?this.getClipStateWithAABB(i.toAABB()):p.CLIPPED}else e=p.CLIPPED;return e}getClipStateWithAABB(t){return this.camera.clipMask?t.getClipStateWithFrustumMask(this.frustum,this.camera.clipMask):t.getClipStateWithFrustum(this.frustum)}}class Ba{static _groundAlbedo=1;static _groundRadiusMM=6.36;static _atmosphereRadiusMM=6.46;static _scatteringSteps=32;static _sunTransmittanceSteps=40;static _rayleighScatteringBase=[5.802,13.558,33.1];static _rayleighAbsorptionBase=0;static _mieScatteringBase=3.996;static _mieAbsorptionBase=4.4;static _ozoneAbsorptionBase=[.65,1.881,.085];static _multiScatteringSteps=20;static _sqrtSamples=8;static _transmittanceLutWidth=256;static _transmittanceLutHeight=64;static _multiScatteringLutWidth=32;static _multiScatteringLutHeight=32;static _skyViewLutWidth=256;static _skyViewLutHeight=256;static _vertexLayout=null;static _renderStates=null;static _programTransmittanceLut=null;static _bindgroupTransmittanceLut=null;static _programMultiScatteringLut=null;static _bindgroupMultiScatteringLut=null;static _programSkyViewLut=null;static _bindgroupSkyViewLut=null;static _transmittanceLut=null;static _multiScatteringLut=null;static _skyViewFramebuffer=null;static _programAerialPerspectiveLut=null;static _bindgroupAerialPerspectiveLut=null;static _aerialPerspectiveLut=null;static _currentSkyViewSunAltitude=0;static _currentAerialPerspectiveAltitude=0;static _currentMaxAerialPerspectiveDistance=800;static _aerialPerspectiveSliceX=32;static _aerialPerspectiveSliceY=32;static _aerialPerspectiveSliceZ=32;static _aerialPerspectiveTextureWidth=this._aerialPerspectiveSliceX*this._aerialPerspectiveSliceZ;static _aerialPerspectiveTextureHeight=this._aerialPerspectiveSliceY;static _viewPos=new b(0,this._groundRadiusMM+5e-5,0);static get aerialPerspectiveSliceZ(){return this._aerialPerspectiveSliceZ}static get groundRadius(){return this._groundRadiusMM}static get atmosphereRadius(){return this._atmosphereRadiusMM}static get viewPosition(){return this._viewPos}static getMultiScatteringLut(){const t=q.instance.device;if(!this._multiScatteringLut){this.prepare(t);const e=t.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer&&t.getDeviceCaps().textureCaps.supportLinearHalfFloatTexture?"rgba16f":"rgba8unorm";this._multiScatteringLut=t.createTexture2D(e,this._multiScatteringLutWidth,this._multiScatteringLutHeight,{samplerOptions:{mipFilter:"none"}}),this._multiScatteringLut.name="MultiScatteringLUT";const i=this.getTransmittanceLut(),s=t.createFrameBuffer([this._multiScatteringLut],null);t.pushDeviceStates(),t.setFramebuffer(s),t.setProgram(this._programMultiScatteringLut),t.setBindGroup(0,this._bindgroupMultiScatteringLut),this._bindgroupMultiScatteringLut.setValue("flip","webgpu"===t.type?1:0),this._bindgroupMultiScatteringLut.setTexture("tLut",i),this.drawQuad(t),t.popDeviceStates(),s.dispose()}return this._multiScatteringLut}static getAerialPerspectiveLut(t,e){const i=q.instance.device;if(t!==this._currentAerialPerspectiveAltitude||e!==this._currentMaxAerialPerspectiveDistance||!this._aerialPerspectiveLut){if(!this._aerialPerspectiveLut){const t=i.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer&&i.getDeviceCaps().textureCaps.supportLinearHalfFloatTexture?"rgba16f":"rgba8unorm";this._aerialPerspectiveLut||(this._aerialPerspectiveLut=i.createTexture2D(t,this._aerialPerspectiveTextureWidth,this._aerialPerspectiveTextureHeight,{samplerOptions:{mipFilter:"none"}}),this._aerialPerspectiveLut.name="AerialPerspectiveLUT")}const s=i.createFrameBuffer([this._aerialPerspectiveLut],null),r=this.getTransmittanceLut(),n=this.getMultiScatteringLut();this._currentAerialPerspectiveAltitude=t,this._currentMaxAerialPerspectiveDistance=e,i.pushDeviceStates(),i.setFramebuffer(s),i.setProgram(this._programAerialPerspectiveLut),i.setBindGroup(0,this._bindgroupAerialPerspectiveLut),this._bindgroupAerialPerspectiveLut.setValue("flip","webgpu"===i.type?1:0),this._bindgroupAerialPerspectiveLut.setValue("sunAltitude",this._currentAerialPerspectiveAltitude),this._bindgroupAerialPerspectiveLut.setValue("maxDistance",this._currentMaxAerialPerspectiveDistance),this._bindgroupAerialPerspectiveLut.setTexture("tLut",r),this._bindgroupAerialPerspectiveLut.setTexture("msLut",n),this.drawQuad(i),i.popDeviceStates(),s.dispose()}return this._aerialPerspectiveLut}static getSkyViewLut(t){const e=q.instance.device;if(t!==this._currentSkyViewSunAltitude||!this._skyViewFramebuffer){if(!this._skyViewFramebuffer){const t=e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer&&e.getDeviceCaps().textureCaps.supportLinearHalfFloatTexture?"rgba16f":"rgba8unorm",i=e.createTexture2D(t,this._skyViewLutWidth,this._skyViewLutHeight,{samplerOptions:{mipFilter:"none"}});i.name="SkyViewLut",this._skyViewFramebuffer=e.createFrameBuffer([i],null)}const i=this.getTransmittanceLut(),s=this.getMultiScatteringLut();this._currentSkyViewSunAltitude=t,e.pushDeviceStates(),e.setFramebuffer(this._skyViewFramebuffer),e.setProgram(this._programSkyViewLut),e.setBindGroup(0,this._bindgroupSkyViewLut),this._bindgroupSkyViewLut.setValue("flip","webgpu"===e.type?1:0),this._bindgroupSkyViewLut.setValue("sunAltitude",this._currentSkyViewSunAltitude),this._bindgroupSkyViewLut.setTexture("tLut",i),this._bindgroupSkyViewLut.setTexture("msLut",s),this.drawQuad(e),e.popDeviceStates()}return this._skyViewFramebuffer.getColorAttachments()[0]}static getTransmittanceLut(){const t=q.instance.device;if(!this._transmittanceLut){this.prepare(t);const e=t.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer&&t.getDeviceCaps().textureCaps.supportLinearHalfFloatTexture?"rgba16f":"rgba8unorm";this._transmittanceLut=t.createTexture2D(e,this._transmittanceLutWidth,this._transmittanceLutHeight,{samplerOptions:{mipFilter:"none"}}),this._transmittanceLut.name="TransmittanceLUT";const i=t.createFrameBuffer([this._transmittanceLut],null);t.pushDeviceStates(),t.setFramebuffer(i),t.setProgram(this._programTransmittanceLut),t.setBindGroup(0,this._bindgroupTransmittanceLut),this._bindgroupTransmittanceLut.setValue("flip","webgpu"===t.type?1:0),this.drawQuad(t),t.popDeviceStates(),i.dispose()}return this._transmittanceLut}static drawQuad(t){const e=t.getRenderStates();t.setRenderStates(this._renderStates),t.setVertexLayout(this._vertexLayout),t.draw("triangle-strip",0,4),t.setRenderStates(e)}static commonVertexShader(){const t=this.$builder;this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))}static commonFunctions(){const t=this.$builder;this.viewPos=t.vec3(Ba._viewPos.x,Ba._viewPos.y,Ba._viewPos.z),t.func("getMiePhase",[t.float("cosTheta")],(function(){this.$l.g=t.float(.8),this.$l.scale=t.float(3/(8*Math.PI)),this.$l.gg=t.mul(this.g,this.g),this.$l.num=t.mul(t.sub(1,this.gg),t.add(t.mul(this.cosTheta,this.cosTheta),1)),this.$l.denom=t.mul(t.add(2,this.gg),t.pow(t.sub(t.add(1,this.gg),t.mul(this.g,this.cosTheta,2)),1.5)),this.$return(t.div(t.mul(this.scale,this.num),this.denom))})),t.func("getRayleighPhase",[t.float("cosTheta")],(function(){this.$l.k=t.float(3/(16*Math.PI)),this.$return(t.mul(this.k,t.add(1,t.mul(this.cosTheta,this.cosTheta))))})),t.func("rayIntersectSphere",[t.vec3("ro"),t.vec3("rd"),t.float("rad")],(function(){this.$l.b=t.dot(this.ro,this.rd),this.$l.c=t.sub(t.dot(this.ro,this.ro),t.mul(this.rad,this.rad)),this.$if(t.and(t.greaterThan(this.c,0),t.greaterThan(this.b,0)),(function(){this.$return(t.float(-1))})),this.$l.bb=t.mul(this.b,this.b),this.$l.discr=t.sub(this.bb,this.c),this.$if(t.lessThan(this.discr,0),(function(){this.$return(t.float(-1))})),this.$if(t.greaterThan(this.discr,this.bb),(function(){this.$return(t.sub(t.sqrt(this.discr),this.b))})),this.$return(t.sub(t.neg(t.sqrt(this.discr)),this.b))})),t.func("getScatteringValues",[t.vec3("pos"),t.vec3("rayleighScattering").out(),t.float("mieScattering").out(),t.vec3("extinction").out()],(function(){this.$l.altitudeKM=t.mul(t.sub(t.length(this.pos),Ba._groundRadiusMM),1e3),this.$l.rayleighDensity=t.exp(t.div(this.altitudeKM,-8)),this.$l.mieDensity=t.exp(t.div(this.altitudeKM,-1.2)),this.rayleighScattering=t.mul(t.vec3(...Ba._rayleighScatteringBase),this.rayleighDensity),this.$l.rayleighAbsorption=t.mul(Ba._rayleighAbsorptionBase,this.rayleighDensity),this.mieScattering=t.mul(Ba._mieScatteringBase,this.mieDensity),this.$l.mieAbsorption=t.mul(Ba._mieAbsorptionBase,this.mieDensity),this.$l.ozoneAbsorption=t.mul(t.vec3(...Ba._ozoneAbsorptionBase),t.max(0,t.sub(1,t.div(t.abs(t.sub(this.altitudeKM,25)),15)))),this.extinction=t.add(this.rayleighScattering,t.vec3(this.rayleighAbsorption),t.vec3(this.mieScattering),t.vec3(this.mieAbsorption),this.ozoneAbsorption)}))}static prepare(t){const e=this;this._vertexLayout||(this._vertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]})),this._renderStates||(this._renderStates=t.createRenderStateSet(),this._renderStates.useRasterizerState().setCullMode("none"),this._renderStates.useDepthState().enableTest(!1).enableWrite(!1)),this._programAerialPerspectiveLut||(this._programAerialPerspectiveLut=t.buildRenderProgram({vertex(t){e.commonVertexShader.call(this)},fragment(t){this.$outputs.outColor=t.vec4(),this.sunAltitude=t.float().uniform(0),this.tLut=t.tex2D().uniform(0),this.msLut=t.tex2D().uniform(0),this.maxDistance=t.float().uniform(0),e.commonFunctions.call(this),t.func("getValFromTLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,e._groundRadiusMM),t.sub(e._atmosphereRadiusMM,e._groundRadiusMM))))),this.$return(t.textureSampleLevel(this.tLut,this.uv,0).rgb)})),t.func("getValFromMSLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,e._groundRadiusMM),t.sub(e._atmosphereRadiusMM,e._groundRadiusMM))))),this.$return(t.textureSampleLevel(this.msLut,this.uv,0).rgb)})),t.func("raymarchScattering",[t.vec3("pos"),t.vec3("rayDir"),t.vec3("sunDir"),t.float("tMax")],(function(){this.$l.cosTheta=t.dot(this.rayDir,this.sunDir),this.$l.miePhaseValue=this.getMiePhase(this.cosTheta),this.$l.rayleighPhaseValue=this.getRayleighPhase(t.neg(this.cosTheta)),this.$l.lum=t.vec3(0),this.$l.transmittance=t.vec3(1),this.$l.t=t.float(0),this.$for(t.int("i"),0,e._scatteringSteps,(function(){this.$l.newT=t.mul(t.div(t.add(t.float(this.i),.3),e._scatteringSteps),this.tMax),this.$l.dt=t.sub(this.newT,this.t),this.t=this.newT,this.$l.newPos=t.add(this.pos,t.mul(this.rayDir,this.t)),this.$l.rayleighScattering=t.vec3(),this.$l.extinction=t.vec3(),this.$l.mieScattering=t.float(),this.getScatteringValues(this.newPos,this.rayleighScattering,this.mieScattering,this.extinction),this.$l.sampleTransmittance=t.exp(t.mul(t.neg(this.dt),this.extinction)),this.$l.sunTransmittance=this.getValFromTLUT(this.newPos,this.sunDir),this.$l.psiMS=this.getValFromMSLUT(this.newPos,this.sunDir),this.$l.rayleighInScattering=t.mul(this.rayleighScattering,t.add(t.mul(this.sunTransmittance,this.rayleighPhaseValue),this.psiMS)),this.$l.mieInScattering=t.mul(t.add(t.mul(this.sunTransmittance,this.miePhaseValue),this.psiMS),this.mieScattering),this.$l.inScattering=t.add(this.rayleighInScattering,this.mieInScattering),this.$l.scatteringIntegral=t.div(t.sub(this.inScattering,t.mul(this.inScattering,this.sampleTransmittance)),this.extinction),this.lum=t.add(this.lum,t.mul(this.scatteringIntegral,this.transmittance)),this.transmittance=t.mul(this.transmittance,this.sampleTransmittance)})),this.$return(this.lum)})),t.main((function(){this.$l.slice=t.clamp(t.floor(t.div(this.$inputs.uv.x,1/Ba._aerialPerspectiveSliceZ)),0,t.sub(Ba._aerialPerspectiveSliceZ,1)),this.$l.sliceU=t.clamp(t.div(t.sub(this.$inputs.uv.x,t.mul(this.slice,1/Ba._aerialPerspectiveSliceZ)),1/Ba._aerialPerspectiveSliceZ),0,1),this.$l.horizonAngle=t.sub(t.mul(this.sliceU,2*Math.PI),Math.PI),this.$l.zenithAngle=t.mul(this.$inputs.uv.y,Math.PI/2),this.$l.rayDir=t.vec3(t.mul(t.cos(this.zenithAngle),t.sin(this.horizonAngle)),t.sin(this.zenithAngle),t.mul(t.neg(t.cos(this.zenithAngle)),t.cos(this.horizonAngle))),this.$l.atmoDist=this.rayIntersectSphere(this.viewPos,this.rayDir,Ba._atmosphereRadiusMM),this.$l.groundDist=this.rayIntersectSphere(this.viewPos,this.rayDir,Ba._groundRadiusMM),this.$l.tMax=t.float(),this.$if(t.lessThan(this.groundDist,0),(function(){this.tMax=this.atmoDist})).$else((function(){this.tMax=this.groundDist})),this.tMax=this.atmoDist,this.$l.maxDistanceMM=t.mul(this.maxDistance,1e-6),this.$l.sliceDist=t.mul(this.maxDistanceMM,t.div(this.slice,Ba._aerialPerspectiveSliceZ)),this.tMax=t.min(this.tMax,this.sliceDist),this.$l.sunDir=t.vec3(0,t.sin(this.sunAltitude),t.neg(t.cos(this.sunAltitude))),this.$l.lum=this.raymarchScattering(this.viewPos,this.rayDir,this.sunDir,this.tMax);const i=1e3*(e._viewPos.y-e._groundRadiusMM),s=Math.exp(-i/8),r=Math.exp(-i/1.2);this.$l.extinction=t.vec3(-((e._rayleighScatteringBase[0]+e._rayleighAbsorptionBase)*s+(e._mieScatteringBase+e._mieAbsorptionBase)*r),-((e._rayleighScatteringBase[1]+e._rayleighAbsorptionBase)*s+(e._mieScatteringBase+e._mieAbsorptionBase)*r),-((e._rayleighScatteringBase[2]+e._rayleighAbsorptionBase)*s+(e._mieScatteringBase+e._mieAbsorptionBase)*r)),this.$l.t=t.exp(t.mul(this.extinction,this.tMax)),this.$outputs.outColor=t.vec4(this.lum,t.dot(this.t,t.vec3(1/3,1/3,1/3)))}))}}),this._bindgroupAerialPerspectiveLut=t.createBindGroup(this._programAerialPerspectiveLut.bindGroupLayouts[0])),this._programSkyViewLut||(this._programSkyViewLut=t.buildRenderProgram({vertex(t){e.commonVertexShader.call(this)},fragment(t){this.$outputs.outColor=t.vec4(),this.sunAltitude=t.float().uniform(0),this.tLut=t.tex2D().uniform(0),this.msLut=t.tex2D().uniform(0),e.commonFunctions.call(this),t.func("getValFromTLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,e._groundRadiusMM),t.sub(e._atmosphereRadiusMM,e._groundRadiusMM))))),this.$return(t.textureSampleLevel(this.tLut,this.uv,0).rgb)})),t.func("getValFromMSLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,e._groundRadiusMM),t.sub(e._atmosphereRadiusMM,e._groundRadiusMM))))),this.$return(t.textureSampleLevel(this.msLut,this.uv,0).rgb)})),t.func("raymarchScattering",[t.vec3("pos"),t.vec3("rayDir"),t.vec3("sunDir"),t.float("tMax")],(function(){this.$l.cosTheta=t.dot(this.rayDir,this.sunDir),this.$l.miePhaseValue=this.getMiePhase(this.cosTheta),this.$l.rayleighPhaseValue=this.getRayleighPhase(t.neg(this.cosTheta)),this.$l.lum=t.vec3(0),this.$l.transmittance=t.vec3(1),this.$l.t=t.float(0),this.$for(t.int("i"),0,e._scatteringSteps,(function(){this.$l.newT=t.mul(t.div(t.add(t.float(this.i),.3),e._scatteringSteps),this.tMax),this.$l.dt=t.sub(this.newT,this.t),this.t=this.newT,this.$l.newPos=t.add(this.pos,t.mul(this.rayDir,this.t)),this.$l.rayleighScattering=t.vec3(),this.$l.extinction=t.vec3(),this.$l.mieScattering=t.float(),this.getScatteringValues(this.newPos,this.rayleighScattering,this.mieScattering,this.extinction),this.$l.sampleTransmittance=t.exp(t.mul(t.neg(this.dt),this.extinction)),this.$l.sunTransmittance=this.getValFromTLUT(this.newPos,this.sunDir),this.$l.psiMS=this.getValFromMSLUT(this.newPos,this.sunDir),this.$l.rayleighInScattering=t.mul(this.rayleighScattering,t.add(t.mul(this.sunTransmittance,this.rayleighPhaseValue),this.psiMS)),this.$l.mieInScattering=t.mul(t.add(t.mul(this.sunTransmittance,this.miePhaseValue),this.psiMS),this.mieScattering),this.$l.inScattering=t.add(this.rayleighInScattering,this.mieInScattering),this.$l.scatteringIntegral=t.div(t.sub(this.inScattering,t.mul(this.inScattering,this.sampleTransmittance)),this.extinction),this.lum=t.add(this.lum,t.mul(this.scatteringIntegral,this.transmittance)),this.transmittance=t.mul(this.transmittance,this.sampleTransmittance)})),this.$return(this.lum)})),t.main((function(){this.$l.azimuthAngle=t.mul(t.sub(this.$inputs.uv.x,.5),2*Math.PI),this.$l.adjV=t.float(),this.$if(t.lessThan(this.$inputs.uv.y,.5),(function(){this.$l.coord=t.sub(1,t.mul(this.$inputs.uv.y,2)),this.adjV=t.neg(t.mul(this.coord,this.coord))})).$else((function(){this.$l.coord=t.sub(t.mul(this.$inputs.uv.y,2),1),this.adjV=t.mul(this.coord,this.coord)})),this.$l.height=t.length(this.viewPos),this.$l.up=t.div(this.viewPos,this.height),this.$l.horizonAngle=t.sub(t.acos(t.clamp(t.div(t.sqrt(t.sub(t.mul(this.height,this.height),t.mul(e._groundRadiusMM,e._groundRadiusMM))),this.height),-1,1)),.5*Math.PI),this.$l.altitudeAngle=t.sub(t.mul(this.adjV,.5*Math.PI),this.horizonAngle),this.$l.cosAltitude=t.cos(this.altitudeAngle),this.$l.rayDir=t.vec3(t.mul(this.cosAltitude,t.sin(this.azimuthAngle)),t.sin(this.altitudeAngle),t.mul(t.neg(this.cosAltitude),t.cos(this.azimuthAngle))),this.$l.sunDir=t.vec3(0,t.sin(this.sunAltitude),t.neg(t.cos(this.sunAltitude))),this.$l.atmoDist=this.rayIntersectSphere(this.viewPos,this.rayDir,e._atmosphereRadiusMM),this.$l.groundDist=this.rayIntersectSphere(this.viewPos,this.rayDir,e._groundRadiusMM),this.$l.tMax=t.float(),this.$if(t.lessThan(this.groundDist,0),(function(){this.tMax=this.atmoDist})).$else((function(){this.tMax=this.groundDist})),this.$l.lum=this.raymarchScattering(this.viewPos,this.rayDir,this.sunDir,this.tMax),this.$outputs.outColor=t.vec4(this.lum,1)}))}}),this._bindgroupSkyViewLut=t.createBindGroup(this._programSkyViewLut.bindGroupLayouts[0])),this._programMultiScatteringLut||(this._programMultiScatteringLut=t.buildRenderProgram({vertex(t){e.commonVertexShader.call(this)},fragment(t){this.$outputs.outColor=t.vec4(),this.tLut=t.tex2D().uniform(0),e.commonFunctions.call(this),t.func("getValFromTLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,e._groundRadiusMM),t.sub(e._atmosphereRadiusMM,e._groundRadiusMM))))),this.$return(t.textureSampleLevel(this.tLut,this.uv,0).rgb)})),t.func("getSphericalDir",[t.float("theta"),t.float("phi")],(function(){this.$l.cosPhi=t.cos(this.phi),this.$l.sinPhi=t.sin(this.phi),this.$l.cosTheta=t.cos(this.theta),this.$l.sinTheta=t.sin(this.theta),this.$return(t.vec3(t.mul(this.sinPhi,this.sinTheta),this.cosPhi,t.mul(this.sinPhi,this.cosTheta)))})),t.func("getMultiScatteringValues",[t.vec3("pos"),t.vec3("sunDir"),t.vec3("lumTotal").out(),t.vec3("fms").out()],(function(){this.lumTotal=t.vec3(0),this.fms=t.vec3(0),this.$l.invSamples=t.div(t.float(1),t.mul(e._sqrtSamples,e._sqrtSamples)),this.$for(t.int("i"),0,e._sqrtSamples,(function(){this.$for(t.int("j"),0,e._sqrtSamples,(function(){this.$l.theta=t.div(t.mul(t.add(t.float(this.i),.5),Math.PI),e._sqrtSamples),this.$l.c=t.sub(1,t.div(t.mul(t.add(t.float(this.j),.5),2),e._sqrtSamples)),this.$l.phi=t.acos(t.clamp(this.c,-1,1)),this.$l.rayDir=this.getSphericalDir(this.theta,this.phi),this.$l.atmoDist=this.rayIntersectSphere(this.pos,this.rayDir,e._atmosphereRadiusMM),this.$l.groundDist=this.rayIntersectSphere(this.pos,this.rayDir,e._groundRadiusMM),this.$l.tMax=this.atmoDist,this.$if(t.greaterThan(this.groundDist,0),(function(){this.tMax=this.groundDist})),this.$l.cosTheta=t.dot(this.rayDir,this.sunDir),this.$l.miePhaseValue=this.getMiePhase(this.cosTheta),this.$l.rayleighPhaseValue=this.getRayleighPhase(t.neg(this.cosTheta)),this.$l.lum=t.vec3(0),this.$l.lumFactor=t.vec3(0),this.$l.transmittance=t.vec3(1),this.$l.t=t.float(0),this.$for(t.int("stepI"),0,e._multiScatteringSteps,(function(){this.$l.newT=t.mul(t.div(t.add(t.float(this.stepI),.3),e._multiScatteringSteps),this.tMax),this.$l.dt=t.sub(this.newT,this.t),this.t=this.newT,this.$l.newPos=t.add(this.pos,t.mul(this.rayDir,this.t)),this.$l.rayleighScattering=t.vec3(),this.$l.extinction=t.vec3(),this.$l.mieScattering=t.float(),this.getScatteringValues(this.newPos,this.rayleighScattering,this.mieScattering,this.extinction),this.$l.sampleTransmittance=t.exp(t.mul(t.neg(this.dt),this.extinction)),this.$l.scatteringNoPhase=t.add(this.rayleighScattering,t.vec3(this.mieScattering)),this.$l.scatteringF=t.div(t.sub(this.scatteringNoPhase,t.mul(this.scatteringNoPhase,this.sampleTransmittance)),this.extinction),this.lumFactor=t.add(this.lumFactor,t.mul(this.transmittance,this.scatteringF)),this.$l.sunTransmittance=this.getValFromTLUT(this.newPos,this.sunDir),this.$l.rayleighInscattering=t.mul(this.rayleighScattering,this.rayleighPhaseValue),this.$l.mieInscattering=t.mul(this.mieScattering,this.miePhaseValue),this.$l.inscattering=t.mul(t.add(this.rayleighInscattering,t.vec3(this.mieInscattering)),this.sunTransmittance),this.$l.scatteringIntegral=t.div(t.sub(this.inscattering,t.mul(this.inscattering,this.sampleTransmittance)),this.extinction),this.lum=t.add(this.lum,t.mul(this.scatteringIntegral,this.transmittance)),this.transmittance=t.mul(this.transmittance,this.sampleTransmittance)})),this.$if(t.greaterThan(this.groundDist,0),(function(){this.$l.hitPos=t.add(this.pos,t.mul(this.rayDir,this.groundDist)),this.$if(t.greaterThan(t.dot(this.pos,this.sunDir),0),(function(){this.hitPos=t.mul(t.normalize(this.hitPos),e._groundRadiusMM),this.lum=t.add(this.lum,t.mul(this.transmittance,t.vec3(e._groundAlbedo),this.getValFromTLUT(this.hitPos,this.sunDir)))}))})),this.fms=t.add(this.fms,t.mul(this.lumFactor,this.invSamples)),this.lumTotal=t.add(this.lumTotal,t.mul(this.lum,this.invSamples))}))}))})),t.main((function(){this.$l.sunCosTheta=t.sub(t.mul(this.$inputs.uv.x,2),1),this.$l.sunTheta=t.acos(t.clamp(this.sunCosTheta,-1,1)),this.$l.height=t.mix(e._groundRadiusMM,e._atmosphereRadiusMM,this.$inputs.uv.y),this.$l.pos=t.vec3(0,this.height,0),this.$l.sunDir=t.normalize(t.vec3(0,this.sunCosTheta,t.neg(t.sin(this.sunTheta)))),this.$l.lum=t.vec3(),this.$l.fms=t.vec3(),this.getMultiScatteringValues(this.pos,this.sunDir,this.lum,this.fms),this.$l.psi=t.div(this.lum,t.sub(1,this.fms)),this.$outputs.outColor=t.vec4(this.psi,1)}))}})),this._bindgroupMultiScatteringLut=t.createBindGroup(this._programMultiScatteringLut.bindGroupLayouts[0]),this._programTransmittanceLut||(this._programTransmittanceLut=t.buildRenderProgram({vertex(t){e.commonVertexShader.call(this)},fragment(t){this.$outputs.outColor=t.vec4(),e.commonFunctions.call(this),t.func("getSunTransmittance",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$if(t.greaterThan(this.rayIntersectSphere(this.pos,this.sunDir,e._groundRadiusMM),0),(function(){this.$return(t.vec3(0))})),this.$l.atmoDist=this.rayIntersectSphere(this.pos,this.sunDir,e._atmosphereRadiusMM),this.$l.t=t.float(0),this.$l.transmittance=t.vec3(1),this.$for(t.int("i"),0,e._sunTransmittanceSteps,(function(){this.$l.newT=t.mul(t.div(t.add(t.float(this.i),.3),e._sunTransmittanceSteps),this.atmoDist),this.$l.dt=t.sub(this.newT,this.t),this.t=this.newT,this.$l.newPos=t.add(this.pos,t.mul(this.sunDir,this.t)),this.$l.rayleighScattering=t.vec3(),this.$l.extinction=t.vec3(),this.$l.mieScattering=t.float(),this.getScatteringValues(this.newPos,this.rayleighScattering,this.mieScattering,this.extinction),this.transmittance=t.mul(this.transmittance,t.exp(t.mul(this.extinction,t.neg(this.dt))))})),this.$return(this.transmittance)})),t.main((function(){this.$l.sunCosTheta=t.sub(t.mul(this.$inputs.uv.x,2),1),this.$l.sunTheta=t.acos(t.clamp(this.sunCosTheta,-1,1)),this.$l.height=t.mix(e._groundRadiusMM,e._atmosphereRadiusMM,this.$inputs.uv.y),this.$l.pos=t.vec3(0,this.height,0),this.$l.sunDir=t.normalize(t.vec3(0,this.sunCosTheta,t.neg(t.sin(this.sunTheta)))),this.$outputs.outColor=t.vec4(this.getSunTransmittance(this.pos,this.sunDir),1)}))}})),this._bindgroupTransmittanceLut=t.createBindGroup(this._programTransmittanceLut.bindGroupLayouts[0])}}const Oa="Z_UniformGlobal",Ua="Z_UniformLightBuffer",ka="Z_UniformLightIndexTex",za="Z_UniformAerialPerspectiveLUT",Va="Z_UniformShadowMap",Ga="Z_UniformWorldMatrix",Xa="Z_UniformInstanceDataStride",Wa="Z_UniformInstanceData",Ha="Z_UniformInstanceDataOffset",ja="Z_UniformBoneMatrices",qa="Z_UniformBoneTexSize",Ya="Z_UniformBoneInvBindMatrix",Za="Z_UniformMorphData",Ka="Z_UniformMorphInfo";class Qa{static FOG_TYPE_NONE=0;static FOG_TYPE_LINEAR=1;static FOG_TYPE_EXP=2;static FOG_TYPE_EXP2=3;static FOG_TYPE_SCATTER=4;static BILLBOARD_SPHERICAL=1;static BILLBOARD_SYLINDRAL=2;static defaultSunDir=b.one().inplaceNormalize();static SKIN_MATRIX_NAME="Z_SkinMatrix";static _lightUniformShadow={light:{sunDir:new b,envLightStrength:1,shadowCascades:1,positionAndRange:new T,directionAndCutoff:new T,diffuseAndIntensity:new T,cascadeDistances:new T,depthBiasValues:new T,shadowCameraParams:new T,depthBiasScales:new T,shadowMatrices:new Float32Array(64)}};static _fogUniforms={fog:{fogType:0,fogColor:null,fogParams:null,apDensity:1}};static getWorldMatrixUniformName(){return Ga}static getInstanceDataUniformName(){return Wa}static getInstanceDataOffsetUniformName(){return Ha}static getInstanceDataStrideUniformName(){return Xa}static getBoneMatricesUniformName(){return ja}static getBoneTextureSizeUniformName(){return qa}static getBoneInvBindMatrixUniformName(){return Ya}static getMorphDataUniformName(){return Za}static getMorphInfoUniformName(){return Ka}static getLightBufferUniformName(){return Ua}static prepareFragmentShader(t,e){this.setupGlobalUniforms(t,e)}static prepareVertexShader(t,e){this.setupGlobalUniforms(t,e),this.prepareVertexShaderCommon(t,e)}static setupGlobalUniforms(t,e){const i=t.getGlobalScope(),s=t.defineStruct([t.vec4("position"),t.vec4("clipPlane"),t.mat4("viewProjectionMatrix"),t.mat4("viewMatrix"),t.mat4("projectionMatrix"),t.vec4("params")]);if(1===e.renderPass.type){const e=t.defineStruct([t.vec4("positionAndRange"),t.vec4("directionCutoff"),t.mat4("viewMatrix"),t.vec4("depthBias"),t.int("lightType")]),r=t.defineStruct([s("camera"),e("light")]);i[Oa]=r().uniform(0)}else if(2===e.renderPass.type||3===e.renderPass.type){const e=t.defineStruct([s("camera")]);i[Oa]=e().uniform(0)}else if(e.renderPass.type===Ra){const r=!e.currentShadowLight,n=t.defineStruct([t.int("fogType"),t.vec4("fogColor"),t.vec4("fogParams"),t.float("apDensity")]),a=e.currentShadowLight?t.defineStruct([t.vec3("sunDir"),t.int("shadowCascades"),t.vec4("positionAndRange"),t.vec4("directionAndCutoff"),t.vec4("diffuseAndIntensity"),t.vec4("cascadeDistances"),t.vec4("depthBiasValues"),t.vec4("shadowCameraParams"),t.vec4("depthBiasScales"),t.vec4[16]("shadowMatrices"),t.float("envLightStrength")]):t.defineStruct([t.vec3("sunDir"),t.float("envLightStrength"),t.vec4("clusterParams"),t.ivec4("countParams"),t.ivec2("lightIndexTexSize")]),o=t.defineStruct([s("camera"),a("light"),n("fog")]);if(i[Oa]=o().uniform(0),r&&(i[Ua]=t.vec4[768]().uniformBuffer(0),i[ka]=("webgl"===t.getDevice().type?t.tex2D():t.utex2D()).uniform(0)),"scatter"===e.applyFog&&(i[za]=t.tex2D().uniform(0)),e.currentShadowLight){const i=t.getGlobalScope(),s=e.shadowMapInfo.get(e.currentShadowLight),r=s.shadowMap.isTextureCube()?s.shadowMap.isDepth()?i.$builder.texCubeShadow():i.$builder.texCube():s.shadowMap.isTexture2D()?s.shadowMap.isDepth()?i.$builder.tex2DShadow():i.$builder.tex2D():s.shadowMap.isDepth()?i.$builder.tex2DArrayShadow():i.$builder.tex2DArray();s.shadowMap.isDepth()||e.device.getDeviceCaps().textureCaps.getTextureFormatInfo(s.shadowMap.format).filterable||r.sampleType("unfilterable-float"),i[Va]=r.uniform(0)}e.drawEnvLight&&e.env.light.envLight.initShaderBindings(t)}}static hasSkinning(t){return!!t[ja]}static hasMorphing(t){return!!t[Za]}static calculateSkinMatrix(t){if(!this.hasSkinning(t))return null;const e=t.$builder,i="Z_getBoneMatrixFromTexture";e.func(i,[e.int("boneIndex")],(function(){const t=this[ja];this.$l.w=e.float(this[qa]),this.$l.pixelIndex=e.float(e.mul(this.boneIndex,4)),this.$l.xIndex=e.mod(this.pixelIndex,this.w),this.$l.yIndex=e.floor(e.div(this.pixelIndex,this.w)),this.$l.u1=e.div(e.add(this.xIndex,.5),this.w),this.$l.u2=e.div(e.add(this.xIndex,1.5),this.w),this.$l.u3=e.div(e.add(this.xIndex,2.5),this.w),this.$l.u4=e.div(e.add(this.xIndex,3.5),this.w),this.$l.v=e.div(e.add(this.yIndex,.5),this.w),this.$l.row1=e.textureSampleLevel(t,e.vec2(this.u1,this.v),0),this.$l.row2=e.textureSampleLevel(t,e.vec2(this.u2,this.v),0),this.$l.row3=e.textureSampleLevel(t,e.vec2(this.u3,this.v),0),this.$l.row4=e.textureSampleLevel(t,e.vec2(this.u4,this.v),0),this.$return(e.mat4(this.row1,this.row2,this.row3,this.row4))}));const s="Z_getSkinningMatrix";return e.func(s,[],(function(){const s=this[Ya],r=t.$getVertexAttrib("blendIndices"),n=t.$getVertexAttrib("blendWeights");this.$l.m0=t.$g[i](e.int(r[0])),this.$l.m1=t.$g[i](e.int(r[1])),this.$l.m2=t.$g[i](e.int(r[2])),this.$l.m3=t.$g[i](e.int(r[3])),this.$l.m=e.add(e.mul(this.m0,n.x),e.mul(this.m1,n.y),e.mul(this.m2,n.z),e.mul(this.m3,n.w)),this.$return(e.mul(s,this.m))})),t.$g[s]()}static calculateMorphDelta(t,e){const i=t.$builder,s="webgl"===i.getDevice().type;if("vertex"!==i.shaderKind)throw new Error("ShaderHelper.calculateMorphDelta(): must be called at vertex stage");const r="Z_calculateMorph",n=this;i.func(r,[i.int("offset")],(function(){this.$if(i.lessThan(this.offset,0),(function(){this.$return(i.vec4(0))})),this.$l.vertexIndex=s?i.int(t.$inputs.zFakeVertexID):i.int(t.$builtins.vertexIndex);const e=t[n.getMorphInfoUniformName()];this.$l.metaData=i.ivec4(e[0]),this.$l.texWidth=i.float(this.metaData.x),this.$l.texHeight=i.float(this.metaData.y),this.$l.numVertices=this.metaData.z,this.$l.numTargets=this.metaData.w,this.$l.value=i.vec4(0),s?this.$for(i.int("i"),0,64,(function(){this.$for(i.int("j"),0,4,(function(){this.$l.index=i.add(i.mul(this.i,4),this.j),this.$if(i.greaterThanEqual(this.index,this.numTargets),(function(){this.$return(this.value)})),this.$l.weight=e.at(i.add(1,this.i)).at(this.j),this.$l.pixelIndex=i.float(i.add(this.offset,i.mul(this.index,this.numVertices),this.vertexIndex)),this.$l.xIndex=i.mod(this.pixelIndex,this.texWidth),this.$l.yIndex=i.floor(i.div(this.pixelIndex,this.texWidth)),this.$l.u=i.div(i.add(this.xIndex,.5),this.texWidth),this.$l.v=i.div(i.add(this.yIndex,.5),this.texHeight),this.$l.morphValue=i.textureSampleLevel(this[n.getMorphDataUniformName()],i.vec2(this.u,this.v),0),this.value=i.add(this.value,i.mul(this.morphValue,this.weight))}))})):this.$for(i.int("t"),0,this.numTargets,(function(){this.$l.i=i.sar(this.t,2),this.$l.j=i.compAnd(this.t,3),this.$l.weight=e.at(i.add(1,this.i)).at(this.j),this.$l.pixelIndex=i.float(i.add(this.offset,i.mul(this.t,this.numVertices),this.vertexIndex)),this.$l.xIndex=i.mod(this.pixelIndex,this.texWidth),this.$l.yIndex=i.floor(i.div(this.pixelIndex,this.texWidth)),this.$l.u=i.div(i.add(this.xIndex,.5),this.texWidth),this.$l.v=i.div(i.add(this.yIndex,.5),this.texHeight),this.$l.morphValue=i.textureSampleLevel(this[n.getMorphDataUniformName()],i.vec2(this.u,this.v),0),this.value=i.add(this.value,i.mul(this.morphValue,this.weight))})),this.$return(this.value)}));const a=65+(e>>2),o=3&e,h=t[this.getMorphInfoUniformName()][a][o];return t[r](i.int(h))}static resolveVertexPosition(t,e){const i=t.$builder;if("vertex"!==i.shaderKind)throw new Error("ShaderHelper.resolveVertexPosition(): must be called at vertex stage");const s=i.getCurrentFunctionScope();if(!s||!s.$isMain())throw new Error("ShaderHelper.resolveVertexPosition(): must be called at entry function");return e||(t.$getVertexAttrib("position")||(t.$inputs.Z_pos=i.vec3().attrib("position")),e=t.$getVertexAttrib("position")),this.hasMorphing(t)&&(e=i.add(e,this.calculateMorphDelta(t,0).xyz)),this.hasSkinning(t)?(s[this.SKIN_MATRIX_NAME]||(s[this.SKIN_MATRIX_NAME]=this.calculateSkinMatrix(s)),i.mul(t[this.SKIN_MATRIX_NAME],i.vec4(e,1)).xyz):e}static resolveVertexNormal(t,e){const i=t.$builder;if("vertex"!==i.shaderKind)throw new Error("ShaderHelper.resolveVertexNormal(): must be called in vertex stage");const s=i.getCurrentFunctionScope();if(!s||!s.$isMain())throw new Error("ShaderHelper.resolveVertexNormal(): must be called at entry function");return e||(t.$getVertexAttrib("normal")||(t.$inputs.Z_normal=i.vec3().attrib("normal")),e=t.$getVertexAttrib("normal")),this.hasMorphing(t)&&(e=i.normalize(i.add(e,this.calculateMorphDelta(t,1).xyz))),this.hasSkinning(t)?(s[this.SKIN_MATRIX_NAME]||(s[this.SKIN_MATRIX_NAME]=this.calculateSkinMatrix(s)),i.mul(t[this.SKIN_MATRIX_NAME],i.vec4(e,0)).xyz):e}static resolveVertexTangent(t,e){const i=t.$builder;if("vertex"!==i.shaderKind)throw new Error("ShaderHelper.resolveVertexTangent(): must be called in vertex stage");const s=i.getCurrentFunctionScope();if(!s||!s.$isMain())throw new Error("ShaderHelper.resolveVertexTangent(): must be called at entry function");return e||(t.$getVertexAttrib("tangent")||(t.$inputs.Z_tangent=i.vec4().attrib("tangent")),e=t.$getVertexAttrib("tangent")),this.hasMorphing(t)&&(e=i.normalize(i.add(e,i.vec4(this.calculateMorphDelta(t,2).xyz,0)))),this.hasSkinning(t)?(s[this.SKIN_MATRIX_NAME]||(s[this.SKIN_MATRIX_NAME]=this.calculateSkinMatrix(s)),i.vec4(i.mul(t[this.SKIN_MATRIX_NAME],i.vec4(e.xyz,0)).xyz,e.w)):e}static getWorldMatrix(t){const e=t.$builder;return t[Ga]??e.mat4(this.getInstancedUniform(t,0),this.getInstancedUniform(t,1),this.getInstancedUniform(t,2),this.getInstancedUniform(t,3))}static getInstancedUniform(t,e){const i=t.$builder;return t[Wa].at(i.add(i.mul(t[Xa],i.uint(t.$builtins.instanceIndex)),t[Ha],e))}static getNormalMatrix(t){return this.getWorldMatrix(t)}static vertexShaderDrawableStuff(t,e,i,s){const r=t.$builder;s?(t[Xa]=r.uint().uniform(1),t[Ha]=r.uint().uniform(1),t[Wa]=r.vec4[4096]().uniformBuffer(3)):t[Ga]=r.mat4().uniform(1),e&&(t[ja]=r.tex2D().uniform(1).sampleType("unfilterable-float"),t[Ya]=r.mat4().uniform(1),t[qa]=r.int().uniform(1)),i&&(t[Za]=r.tex2D().uniform(1).sampleType("unfilterable-float"),t[Ka]=r.vec4[67]().uniformBuffer(1))}static prepareVertexShaderCommon(t,e){this.vertexShaderDrawableStuff(t.getGlobalScope(),!!e.skinAnimation,!!e.morphAnimation,!!e.instancing)}static setCameraUniforms(t,e,i,s){const r=e.getWorldPosition(),n={position:new T(r.x,r.y,r.z,e.clipPlane?1:0),clipPlane:e.clipPlane??T.zero(),viewProjectionMatrix:e.viewProjectionMatrix,viewMatrix:e.viewMatrix,projectionMatrix:e.getProjectionMatrix(),params:new T(e.getNearPlane(),e.getFarPlane(),i?-1:1,s?0:1)};t.setValue(Oa,{camera:n})}static setLightUniformsShadowMap(t,e,i){if(i){const s=e.shadowMapInfo.get(i);t.setValue(Oa,{light:{positionAndRange:i.positionAndRange,directionCutoff:i.directionAndCutoff,viewMatrix:i.viewMatrix,depthBias:s.depthBiasValues[0],lightType:i.lightType}})}}static setFogUniforms(t,e,i,s,r,n){this._fogUniforms.fog.fogColor=i,this._fogUniforms.fog.fogParams=s,this._fogUniforms.fog.fogType=e,this._fogUniforms.fog.apDensity=r,t.setValue(Oa,this._fogUniforms),n&&t.setTexture(za,n)}static setLightUniforms(t,e,i,s,r,n){t.setValue(Oa,{light:{sunDir:e.sunLight?e.sunLight.directionAndCutoff.xyz().scaleBy(-1):this.defaultSunDir,clusterParams:i,countParams:s,envLightStrength:e.env.light.strength??0,lightIndexTexSize:new Int32Array([n.width,n.height])}}),t.setBuffer(Ua,r),t.setTexture(ka,n),e.drawEnvLight&&e.env.light.envLight.updateBindGroup(t)}static setLightUniformsShadow(t,e,i){const s=e.shadowMapInfo.get(i);this._lightUniformShadow.light.sunDir=e.sunLight?e.sunLight.directionAndCutoff.xyz().scaleBy(-1):this.defaultSunDir,this._lightUniformShadow.light.envLightStrength=e.env?.light.strength??0,this._lightUniformShadow.light.shadowCascades=s.numShadowCascades,this._lightUniformShadow.light.positionAndRange.set(i.positionAndRange),this._lightUniformShadow.light.directionAndCutoff.set(i.directionAndCutoff),this._lightUniformShadow.light.diffuseAndIntensity.set(i.diffuseAndIntensity),this._lightUniformShadow.light.cascadeDistances.set(s.cascadeDistances),this._lightUniformShadow.light.depthBiasValues.set(s.depthBiasValues[0]),this._lightUniformShadow.light.shadowCameraParams.set(s.cameraParams),this._lightUniformShadow.light.depthBiasScales.set(s.depthBiasScales),this._lightUniformShadow.light.shadowMatrices.set(s.shadowMatrices),t.setValue(Oa,this._lightUniformShadow),t.setTexture(Va,s.shadowMap,s.shadowMapSampler),e.drawEnvLight&&e.env.light.envLight.updateBindGroup(t)}static getEnvLightStrength(t){return t[Oa].light.envLightStrength}static getCameraPosition(t){return t[Oa].camera.position.xyz}static discardIfClipped(t,e){const i="Z_discardIfClippped",s=t.$builder,r=this;s.func(i,[s.vec3("worldPos")],(function(){this.$if(s.notEqual(r.getCameraClipPlaneFlag(this),0),(function(){this.$l.clipPlane=r.getCameraClipPlane(this),this.$if(s.greaterThan(s.add(s.dot(this.worldPos.xyz,this.clipPlane.xyz),this.clipPlane.w),0),(function(){s.discard()}))}))})),s.getGlobalScope()[i](e)}static getCameraClipPlaneFlag(t){return t[Oa].camera.position.w}static getCameraClipPlane(t){return t[Oa].camera.clipPlane}static getCameraParams(t){return t[Oa].camera.params}static getFogColor(t){return t[Oa].fog.fogColor}static getClusterParams(t){return t[Oa].light.clusterParams}static getCountParams(t){return t[Oa].light.countParams}static getClusteredLightIndexTexture(t){return t[ka]}static getFogType(t){return t[Oa].fog.fogType}static getAerialPerspectiveLUT(t){return t[za]}static getFogParams(t){return t[Oa].fog.fogParams}static getAPDensity(t){return t[Oa].fog.apDensity}static computeFogFactor(t,e,i,s){const r=t.$builder,n="Z_computeFogFactor",a=this;return r.func(n,[r.vec3("viewDir"),r.int("fogType"),r.vec4("fogParams")],(function(){this.$l.distance=r.length(this.viewDir),this.$l.top=r.max(this.viewDir.y,1e-4),this.$l.distance=r.mul(this.$l.distance,r.min(1,r.div(this.fogParams.z,this.top))),this.$if(r.equal(this.fogType,a.FOG_TYPE_LINEAR),(function(){this.$return(r.clamp(r.div(r.sub(this.distance,this.fogParams.x),r.sub(this.fogParams.y,this.fogParams.x)),0,1))})).$elseif(r.equal(this.fogType,a.FOG_TYPE_EXP),(function(){this.$l.e=r.mul(this.distance,this.fogParams.w),this.$return(r.sub(1,r.div(1,r.exp(this.e))))})).$elseif(r.equal(this.fogType,a.FOG_TYPE_EXP2),(function(){this.$l.e=r.mul(this.distance,this.fogParams.w),this.$return(r.sub(1,r.div(1,r.exp(r.mul(this.e,this.e)))))})).$else((function(){this.$return(0)}))})),r.getGlobalScope()[n](e,i,s)}static computeFogFactorForType(t,e,i,s){const r=t.$builder,n=`Z_computeFogFactor${s[0].toUpperCase()}${s.slice(1)}`;return r.func(n,[r.vec3("viewDir"),r.vec4("fogParams")],(function(){this.$l.distance=r.length(this.viewDir),this.$l.top=r.max(this.viewDir.y,1e-4),this.$l.distance=r.mul(this.$l.distance,r.min(1,r.div(this.fogParams.z,this.top))),"linear"===s?this.$return(r.clamp(r.div(r.sub(this.distance,this.fogParams.x),r.sub(this.fogParams.y,this.fogParams.x)),0,1)):"exp"===s?(this.$l.e=r.mul(this.distance,this.fogParams.w),this.$return(r.sub(1,r.div(1,r.exp(this.e))))):"exp2"===s?(this.$l.e=r.mul(this.distance,this.fogParams.w),this.$return(r.sub(1,r.div(1,r.exp(r.mul(this.e,this.e)))))):this.$return(0)})),r.getGlobalScope()[n](e,i)}static getViewProjectionMatrix(t){return t[Oa].camera.viewProjectionMatrix}static getViewMatrix(t){return t[Oa].camera.viewMatrix}static getProjectionMatrix(t){return t[Oa].camera.projectionMatrix}static getCascadeDistances(t){return t[Oa].light.cascadeDistances}static getDepthBiasValues(t){return t[Oa].light.depthBiasValues}static getShadowCameraParams(t){return t[Oa].light.shadowCameraParams}static getDepthBiasScales(t){return t[Oa].light.depthBiasScales}static getNumLights(t){return t[Oa].light.numLights}static getSunLightDir(t){return t[Oa].light.sunDir}static getLightTypeForShadow(t){return t[Oa].light.lightType}static getLightPositionAndRangeForShadow(t){return t[Oa].light.positionAndRange}static getLightViewMatrixForShadow(t){return t[Oa].light.viewMatrix}static calculateShadowSpaceVertex(t,e,i=0){const s=t.$builder;return s.vec4(s.dot(t[Oa].light.shadowMatrices.at(s.add(s.mul(i,4),0)),e),s.dot(t[Oa].light.shadowMatrices.at(s.add(s.mul(i,4),1)),e),s.dot(t[Oa].light.shadowMatrices.at(s.add(s.mul(i,4),2)),e),s.dot(t[Oa].light.shadowMatrices.at(s.add(s.mul(i,4),3)),e))}static getLightPositionAndRange(t,e){return t[Ua].at(t.$builder.mul(e,3))}static getLightDirectionAndCutoff(t,e){return t[Ua].at(t.$builder.add(t.$builder.mul(e,3),1))}static getLightColorAndIntensity(t,e){return t[Ua].at(t.$builder.add(t.$builder.mul(e,3),2))}static setClipSpacePosition(t,e){const i=t.$builder,s=this.getCameraParams(t);t.$builtins.position=s?i.mul(e,i.vec4(1,s.z,1,1)):e}static getGlobalUniforms(t){return t[Oa]}static getShadowMap(t){return t[Va]}static calculateShadow(t,e,i,s){const r=t.$builder,n=this,a=s.shadowMapInfo.get(s.currentShadowLight),o="Z_calculateShadow";return r.func(o,[r.vec3("worldPos"),r.float("NoL")],(function(){if(a.numShadowCascades>1){this.$l.shadowCascades=n.getGlobalUniforms(this).light.shadowCascades,this.$l.shadowBound=r.vec4(0,0,1,1),this.$l.linearDepth=n.nonLinearDepthToLinear(this,this.$builtins.fragCoord.z),this.$l.splitDistances=n.getCascadeDistances(this),this.$l.comparison=r.vec4(r.greaterThan(r.vec4(this.linearDepth),this.splitDistances)),this.$l.cascadeFlags=r.vec4(r.float(r.greaterThan(this.shadowCascades,0)),r.float(r.greaterThan(this.shadowCascades,1)),r.float(r.greaterThan(this.shadowCascades,2)),r.float(r.greaterThan(this.shadowCascades,3))),this.$l.split=r.int(r.dot(this.comparison,this.cascadeFlags)),"webgl"===s.device.type?(this.$l.shadowVertex=r.vec4(),this.$for(r.int("cascade"),0,4,(function(){this.$if(r.equal(this.cascade,this.split),(function(){this.shadowVertex=n.calculateShadowSpaceVertex(this,r.vec4(this.worldPos,1),this.cascade),this.$break()}))}))):this.$l.shadowVertex=n.calculateShadowSpaceVertex(this,r.vec4(this.worldPos,1),this.split);const e=s.shadowMapInfo.get(s.currentShadowLight);this.$l.shadow=e.impl.computeShadowCSM(e,this,this.shadowVertex,this.NoL,this.split),this.$l.shadowDistance=n.getShadowCameraParams(t).w,this.shadow=r.mix(this.shadow,1,r.smoothStep(r.mul(this.shadowDistance,.8),this.shadowDistance,r.distance(n.getCameraPosition(this),this.worldPos))),this.$return(this.shadow)}else{this.$l.shadowVertex=n.calculateShadowSpaceVertex(this,r.vec4(this.worldPos,1));const e=s.shadowMapInfo.get(s.currentShadowLight);this.$l.shadow=e.impl.computeShadow(e,this,this.shadowVertex,this.NoL),this.$l.shadowDistance=n.getShadowCameraParams(t).w,this.shadow=r.mix(this.shadow,1,r.smoothStep(r.mul(this.shadowDistance,.8),this.shadowDistance,r.distance(n.getCameraPosition(this),this.worldPos))),this.$return(this.shadow)}})),r.getGlobalScope()[o](e,i)}static applyFog(t,e,i,s){const r=t.$builder,n=this;if("scatter"===s.applyFog){const s="Z_applySkyFog";r.func(s,[r.vec3("worldPos"),r.vec4("color").inout()],(function(){this.$l.viewDir=r.sub(this.worldPos,n.getCameraPosition(this)),this.viewDir.y=r.max(this.viewDir.y,0),this.$l.distance=r.mul(r.length(this.viewDir),n.getAPDensity(this)),this.$l.sliceDist=r.div(r.mul(n.getCameraParams(this).y,n.getAPDensity(this)),Ba.aerialPerspectiveSliceZ),this.$l.slice0=r.floor(r.div(this.distance,this.sliceDist)),this.$l.slice1=r.add(this.slice0,1),this.$l.factor=r.sub(r.div(this.distance,this.sliceDist),this.slice0),this.$l.viewNormal=r.normalize(this.viewDir),this.$l.horizonAngle=r.acos(r.clamp(r.dot(r.normalize(n.getSunLightDir(this).xz),r.normalize(this.viewNormal.xz)),0,1)),this.$l.zenithAngle=r.asin(this.viewNormal.y),this.$l.sliceU=r.max(r.div(this.horizonAngle,2*Math.PI),.5/Ba.aerialPerspectiveSliceZ),this.$l.u0=r.div(r.add(this.slice0,this.sliceU),Ba.aerialPerspectiveSliceZ),this.$l.u1=r.add(this.u0,1/Ba.aerialPerspectiveSliceZ),this.$l.v=r.div(this.zenithAngle,Math.PI/2),this.$l.t0=r.textureSampleLevel(n.getAerialPerspectiveLUT(this),r.vec2(this.u0,this.v),0),this.$l.t1=r.textureSampleLevel(n.getAerialPerspectiveLUT(this),r.vec2(this.u1,this.v),0),this.$l.t=r.mix(this.t0,this.t1,this.factor),this.color=r.vec4(r.add(r.mul(this.color.rgb,this.t.a),this.t.rgb),this.color.a)})),t[s](e,i)}else if(s.applyFog){const s="Z_applyFog";r.func(s,[r.vec3("worldPos"),r.vec4("color").inout()],(function(){this.$l.viewDir=r.sub(this.worldPos,n.getCameraPosition(this)),this.$l.fogFactor=n.computeFogFactor(this,this.viewDir,n.getFogType(this),n.getFogParams(this)),this.color=r.vec4(r.mix(this.color.rgb,n.getFogColor(this).rgb,this.fogFactor),this.color.a)})),t[s](e,i)}}static linearDepthToNonLinear(t,e,i){const s=t.$builder;return i=i??this.getCameraParams(t),s.div(s.sub(i.y,s.div(s.mul(i.x,i.y),e)),s.sub(i.y,i.x))}static nonLinearDepthToLinear(t,e,i){const s=t.$builder;return i=i??this.getCameraParams(t),s.div(s.mul(i.x,i.y),s.mix(i.y,i.x,e))}static nonLinearDepthToLinearNormalized(t,e,i){const s=t.$builder;return i=i??this.getCameraParams(t),s.div(i.x,s.mix(i.y,i.x,e))}static encodeColorOutput(t,e){const i=t.$builder,s=this,r="Z_encodeColorOutput";return i.func(r,[i.vec4("outputColor")],(function(){const t=s.getCameraParams(this);this.$if(i.notEqual(t.w,0),(function(){this.$return(i.vec4(ca(this,this.outputColor.rgb),this.outputColor.w))})).$else((function(){this.$return(this.outputColor)}))})),i.getGlobalScope()[r](e)}}class Ja{static _nextId=0;static _programCache={};_states;_numPasses;_hash;_optionTag;_id;_currentHash;constructor(){this._id=++Ja._nextId,this._states={},this._numPasses=1,this._hash=[null],this._optionTag=0,this._currentHash=[]}get instanceId(){return this._id}get numPasses(){return this._numPasses}set numPasses(t){for(;this._hash.length<t;)this._hash.push(null);this._numPasses=t}getHash(t){return null===this._hash[t]&&(this._hash[t]=this.createHash(t)),this._hash[t]}getQueueType(){return 1}isTransparentPass(t){return!1}supportLighting(){return!0}supportInstancing(){return!0}isBatchable(){return!1}needSceneColor(){return!1}get coreMaterial(){return this}apply(t){for(let e=0;e<this._numPasses;e++){const i=this.calcGlobalHash(t,e);let s=this._states[i];if(!s){const r=`${this.constructor.name}:${i}`;let n=Ja._programCache[r];n||(n=this.createProgram(t,e)??null,Ja._programCache[r]=n);s={program:n,bindGroup:n.bindGroupLayouts.length>2?t.device.createBindGroup(n.bindGroupLayouts[2]):null,renderStateSet:t.device.createRenderStateSet(),materialTag:-1},this._states[i]=s}if(!s.program)return!1;this.applyUniforms(s.bindGroup,t,s.materialTag!==this._optionTag,e),s.materialTag=this._optionTag,this.updateRenderStates(e,s.renderStateSet,t),this._currentHash[e]=i}}bind(t,e){const i=this._currentHash[e],s=this._states[i];return s?!!s.program&&(t.setProgram(s.program),t.setBindGroup(2,s.bindGroup),void t.setRenderStates(s.renderStateSet)):(console.error("Material.bind() failed: state not found"),!1)}calcGlobalHash(t,e){return`${this.getHash(e)}:${Number(!!t.morphAnimation)}${Number(!!t.skinAnimation)}:${Number(!!t.instancing)}:${t.renderPassHash}`}draw(t,e,i=0){for(let s=0;s<this._numPasses;s++)this.bind(e.device,s),this.drawPrimitive(s,t,e,i)}applyUniforms(t,e,i,s){i&&this._applyUniforms(t,e,s)}optionChanged(t){if(this._optionTag++,t)for(let t=0;t<this._numPasses;t++)this._hash[t]=null}passToHash(t){return String(t)}createHash(t){return`${this.constructor.name}|${t}|${this._createHash()}`}drawPrimitive(t,e,i,s){s>0?e.drawInstanced(s):i.instanceData?e.drawInstanced(i.instanceData.numInstances):e.draw()}createProgram(t,e){const i=new Un(t.device);return this._createProgram(i,t,e)}_createProgram(t,e,i){return null}_applyUniforms(t,e,i){}updateRenderStates(t,e,i){}_createHash(){return""}get $isInstance(){return!1}get $instanceUniforms(){return null}}function to(t,...e){return i(t,...e)}let eo=0,io=0,so=0;class ro extends Ja{static INSTANCE_UNIFORMS=[];static NEXT_FEATURE_INDEX=3;static OBJECT_COLOR_UNIFORM=this.defineInstanceUniform("objectColor","vec4");_featureStates;_alphaCutoff;_blendMode;_cullMode;_opacity;_objectColor;_ctx;_materialPass;constructor(...t){super(),this._featureStates=[],this._alphaCutoff=0,this._blendMode="none",this._cullMode="back",this._opacity=1,this._objectColor=T.one(),this._ctx=null,this._materialPass=-1}uniformChanged(){this.optionChanged(!1)}static defineFeature(){const t=this.NEXT_FEATURE_INDEX;return this.NEXT_FEATURE_INDEX++,t}static defineInstanceUniform(t,e){if(this.INSTANCE_UNIFORMS.findIndex((e=>e[0]===t))>=0)throw new Error(`${this.name}.defineInstanceUniform(): ${t} was already defined`);if("float"!==e&&"vec2"!==e&&"vec3"!==e&&"vec4"!==e)throw new Error(`${this.name}.defineInstanceUniform(): invalid uniform type ${e}`);return this.INSTANCE_UNIFORMS=[...this.INSTANCE_UNIFORMS,[t,e]],this.INSTANCE_UNIFORMS.length-1}getInstancedUniform(t,e){const i=t.$builder,s=t.$builtins.instanceIndex,r=Qa.getInstanceDataUniformName(),n=Qa.getInstanceDataStrideUniformName(),a=Qa.getInstanceDataOffsetUniformName();return t[r].at(i.add(i.mul(t[n],s),4+e,t[a]))}createInstance(){if(this.$isInstance)return this.coreMaterial.createInstance();const t=this.constructor.INSTANCE_UNIFORMS,e=t.length>0?new Float32Array(4*t.length):null,i="webgl"===q.instance.device.type,s={},r=this;s.isBatchable=()=>!i&&r.supportInstancing(),s.$instanceUniforms=e,s.$isInstance=!0,s.coreMaterial=r;for(let i=0;i<t.length;i++){const[n,a]=t[i],o=r[n];switch(a){case"float":e[4*i]=Number(o),Object.defineProperty(s,n,{get:()=>e[4*i],set(t){e[4*i+0]=t,r[n]=t}});break;case"vec2":if(!(o instanceof x))throw new Error(`Instance uniform property ${n} must be of type Vector2`);e[4*i]=o.x,e[4*i+1]=o.y,Object.defineProperty(s,n,{get:()=>new x(e[4*i],e[4*i+1]),set(t){e.set(t),r[n]=t}});break;case"vec3":if(!(o instanceof b))throw new Error(`Instance uniform property ${n} must be of type Vector3`);e[4*i]=o.x,e[4*i+1]=o.y,e[4*i+2]=o.z,Object.defineProperty(s,n,{get:()=>new b(e[4*i],e[4*i+1],e[4*i+2]),set(t){e.set(t),r[n]=t}});break;case"vec4":if(!(o instanceof T))throw new Error(`Instance uniform property ${n} must be of type Vector4`);e[4*i]=o.x,e[4*i+1]=o.y,e[4*i+2]=o.z,e[4*i+3]=o.w,Object.defineProperty(s,n,{get:()=>new T(e[4*i],e[4*i+1],e[4*i+2],e[4*i+3]),set(t){e.set(t),r[n]=t}})}}return Object.setPrototypeOf(s,r),s}get drawContext(){return this._ctx}get pass(){return this._materialPass}get alphaCutoff(){return this._alphaCutoff}set alphaCutoff(t){this._alphaCutoff!==t&&(this.useFeature(eo,t>0),this._alphaCutoff=t,this.uniformChanged())}get alphaToCoverage(){return this.featureUsed(so)}set alphaToCoverage(t){this.useFeature(so,!!t)}get blendMode(){return this._blendMode}set blendMode(t){this._blendMode!==t&&(this._blendMode=t,this.useFeature(io,"none"!==this._blendMode||this._opacity<1))}get cullMode(){return this._cullMode}set cullMode(t){this._cullMode=t}get opacity(){return this._opacity}set opacity(t){t=t<0?0:t>1?1:t,this._opacity!==t&&(this._opacity=t,this.useFeature(io,"none"!==this._blendMode||this._opacity<1),this.uniformChanged())}get objectColor(){return this._objectColor}set objectColor(t){t!==this._objectColor&&(this._objectColor=t,this.uniformChanged())}supportLighting(){return!0}updateRenderStates(t,e,i){const s=3===i.renderPass.type,r=!s&&(this.featureUsed(io)||i.lightBlending),n=!s&&this.featureUsed(so);if(r||n){const t=e.useBlendingState();r?(t.enable(!0),t.setBlendFuncAlpha("zero","one"),t.setBlendEquation("add","add"),"additive"===this._blendMode||i.lightBlending?t.setBlendFuncRGB("one","one"):t.setBlendFuncRGB("one","inv-src-alpha")):t.enable(!1),t.enableAlphaToCoverage(n),t.enabled?e.useDepthState().enableTest(!0).enableWrite(!1):e.defaultDepthState()}else e.blendingState?.enabled&&!r&&(e.defaultBlendingState(),e.defaultDepthState());"back"!==this._cullMode?e.useRasterizerState().cullMode=this._cullMode:e.defaultRasterizerState(),e.defaultColorState(),e.defaultStencilState(),i.oit&&i.oit.setRenderStates(e)}applyUniformValues(t,e,i){this.featureUsed(eo)&&t.setValue("zAlphaCutoff",this._alphaCutoff),this.isTransparentPass(i)&&t.setValue("zOpacity",this._opacity),e.oit&&e.oit.applyUniforms(e,t),e.instancing||3!==e.renderPass.type||t.setValue("zObjectColor",this._objectColor)}getQueueType(){return this.isTransparentPass(0)?2:1}isTransparentPass(t){return this.featureUsed(io)}createProgram(t,e){const i=new Un(t.device);if(1===t.renderPass.type){const e=t.shadowMapInfo.get(t.renderPass.light);i.emulateDepthClamp=!!e.depthClampEnabled}return this._createProgram(i,t,e)}featureUsed(t){return this._featureStates[t]}useFeature(t,e){this._featureStates[t]!==e&&(this._featureStates[t]=e,this.optionChanged(!0))}_createHash(){return this._featureStates.map((t=>void 0===t?"":t)).join("|")}_applyUniforms(t,e,i){this.applyUniformValues(t,e,i)}needFragmentColor(t){return(t??this.drawContext).renderPass.type===Ra||this._alphaCutoff>0||this.alphaToCoverage}vertexShader(t){const e=t.$builder;Qa.prepareVertexShader(e,this.drawContext),this.drawContext.skinAnimation&&(t.$inputs.zBlendIndices=e.vec4().attrib("blendIndices"),t.$inputs.zBlendWeights=e.vec4().attrib("blendWeights")),this.drawContext.morphAnimation&&"webgl"===this.drawContext.device.type&&(t.$inputs.zFakeVertexID=e.float().attrib("texCoord7")),3===this.drawContext.renderPass.type&&this.drawContext.instancing&&(t.$outputs.zObjectColor=this.getInstancedUniform(t,ro.OBJECT_COLOR_UNIFORM))}fragmentShader(t){const e=t.$builder;Qa.prepareFragmentShader(e,this.drawContext),this._alphaCutoff>0&&(t.zAlphaCutoff=e.float().uniform(2)),this.drawContext.renderPass.type===Ra?this.isTransparentPass(this.pass)&&(t.zOpacity=e.float().uniform(2)):3!==this.drawContext.renderPass.type||this.drawContext.instancing||(t.zObjectColor=e.vec4().uniform(2))}_createProgram(t,e,i){const s=this;this._ctx=e,this._materialPass=i;const r=t.buildRenderProgram({vertex(t){t.main((function(){s.vertexShader(this)}))},fragment(t){s.drawContext.oit?s.drawContext.oit.setupFragmentOutput(this):this.$outputs.zFragmentOutput=t.vec4(),t.main((function(){s.fragmentShader(this)}))}});return r}doAlphaTest(t,e){}outputFragmentColor(t,e,i){const s=t.$builder,r=this,n="Z_outputFragmentColor";s.func(n,i?[s.vec3("worldPos"),s.vec4("color")]:[s.vec3("worldPos")],(function(){if(this.$l.outColor=i?this.color:s.vec4(),r.drawContext.renderPass.type===Ra)Qa.discardIfClipped(this,this.worldPos),r.isTransparentPass(r.pass)||this.zAlphaCutoff||r.alphaToCoverage?this.zOpacity&&(this.outColor.a=s.mul(this.outColor.a,this.zOpacity)):this.outColor.a=1,this.zAlphaCutoff&&this.$if(s.lessThan(this.outColor.a,this.zAlphaCutoff),(function(){s.discard()})),r.isTransparentPass(r.pass)&&(r.drawContext.oit&&r.drawContext.oit.outputFragmentColor(this,this.outColor)||(this.outColor=s.vec4(s.mul(this.outColor.rgb,this.outColor.a),this.outColor.a))),Qa.applyFog(this,this.worldPos,this.outColor,r.drawContext),this.$outputs.zFragmentOutput=Qa.encodeColorOutput(this,this.outColor);else if(2===r.drawContext.renderPass.type)i&&this.$if(s.lessThan(this.outColor.a,this.zAlphaCutoff),(function(){s.discard()})),Qa.discardIfClipped(this,this.worldPos),this.$l.depth=Qa.nonLinearDepthToLinearNormalized(this,this.$builtins.fragCoord.z),"webgl"===r.drawContext.device.type?this.$outputs.zFragmentOutput=la(this,this.depth):this.$outputs.zFragmentOutput=s.vec4(this.depth,0,0,1);else if(3===r.drawContext.renderPass.type)i&&this.$if(s.lessThan(this.outColor.a,this.zAlphaCutoff),(function(){s.discard()})),Qa.discardIfClipped(this,this.worldPos),this.$outputs.zFragmentOutput=r.drawContext.instancing?t.$inputs.zObjectColor:t.zObjectColor;else{i&&this.$if(s.lessThan(this.outColor.a,this.zAlphaCutoff),(function(){s.discard()})),Qa.discardIfClipped(this,this.worldPos);const t=r.drawContext.shadowMapInfo.get(r.drawContext.renderPass.light);this.$outputs.zFragmentOutput=t.impl.computeShadowMapDepth(t,this,this.worldPos)}})),i?s.getGlobalScope()[n](e,i):s.getGlobalScope()[n](e)}}function no(t){return function(e,i=!1){const s=`${t[0].toUpperCase()}${t.slice(1)}`,r=`mixinTexture${s}`;let n=0,a=0,o=0;if(e[r])return e;const h=class extends e{constructor(...t){super(...t)}vertexShader(e){if(super.vertexShader(e),i||this.needFragmentColor()){const r=e.$builder,a=this;if(this.featureUsed(n)){if(a[`${t}TexCoordIndex`]>=0){const n=`texCoord${a[`${t}TexCoordIndex`]}`;e.$getVertexAttrib(n)||(e.$inputs[n]=r.vec2().attrib(n)),this.featureUsed(o)?(e[`z${s}TextureMatrix`]=r.mat4().uniform(2),i||(e.$outputs[`z${s}TexCoord`]=r.mul(e[`z${s}TextureMatrix`],r.vec4(e.$inputs[n],0,1)).xy)):i||(e.$outputs[`z${s}TexCoord`]=e.$inputs[n])}}}}fragmentShader(t){if(super.fragmentShader(t),this.needFragmentColor()){const e=t.$builder;this.featureUsed(n)&&(t[`z${s}Tex`]=e.tex2D().uniform(2))}}applyUniformValues(e,i,r){if(super.applyUniformValues(e,i,r),this.needFragmentColor(i)&&this.featureUsed(n)){const i=this;e.setTexture(`z${s}Tex`,i[`${t}Texture`],i[`${t}TextureSampler`]),this.featureUsed(o)&&e.setValue(`z${s}TextureMatrix`,i[`${t}TexCoordMatrix`])}}};n=h.defineFeature(),a=h.defineFeature(),o=h.defineFeature();const l=h.prototype,u=`__${t}Texture`,c=`__${t}Sampler`,d=`__${t}TexCoordIndex`,p=`__${t}TexMatrix`;return l[u]=null,l[c]=null,l[d]=0,l[p]=null,l[`sample${s}Texture`]=function(t,e){const i=this[`get${s}TextureUniform`](t),r=e??this[`get${s}TexCoord`](t);return t.$builder.textureSample(i,r)},l[`get${s}TextureUniform`]=function(t){return"fragment"===t.$builder.shaderKind?t[`z${s}Tex`]:null},l[`get${s}TexCoord`]=function(t){if(l[d]<0)return null;const e=t.$builder;if("vertex"===e.shaderKind!=!!i)throw new Error(`mixinTextureProps.get${s}TexCoord(): must be called in ${i?"vertex":"fragment"} stage`);return"fragment"===t.$builder.shaderKind?t.$inputs[`z${s}TexCoord`]:this.featureUsed(o)?e.mul(t[`z${s}TextureMatrix`],e.vec4(t.$inputs[`texCoord${l[d]}`],0,1)).xy:t.$inputs[`texCoord${l[d]}`]},Object.defineProperty(l,`${t}Texture`,{get:function(){return this[u]},set:function(t){this[u]!==t&&(this[u]=t??null,this.useFeature(n,!!this[u]),this[u]&&(this.useFeature(a,this[d]),this.useFeature(o,!!this[p]),this.uniformChanged()))},enumerable:!0,configurable:!0}),Object.defineProperty(l,`${t}TextureSampler`,{get:function(){return this[c]},set:function(t){this[c]=t},enumerable:!0,configurable:!0}),Object.defineProperty(l,`${t}TexCoordMatrix`,{get:function(){return this[p]},set:function(t){this[p]!==t&&(this[p]=t,this.useFeature(o,!!this[p]))},enumerable:!0,configurable:!0}),Object.defineProperty(l,`${t}TexCoordIndex`,{get:function(){return this[d]},set:function(t){this[d]!==t&&(this[d]=t,this.useFeature(a,this[d]))},enumerable:!0,configurable:!0}),h[r]=!0,h}}function ao(t){if(t.albedoColorMixed)return t;const e=to(t,no("albedo")),i=e.defineInstanceUniform("albedoColor","vec4");return class extends e{static albedoColorMixed=!0;_albedoColor;constructor(){super(),this._albedoColor=T.one()}get albedoColor(){return this._albedoColor}set albedoColor(t){this._albedoColor.set(t),this.uniformChanged()}getUniformValueAlbedoColor(t){return this.drawContext.instancing?t.$inputs.zAlbedo:t.zAlbedo}calculateAlbedoColor(t,e){const i=t.$builder;if(!this.needFragmentColor())return console.warn("mixinAlbedoColor.calculateAlbedoColor(): No need to calculate albedo color, make sure needFragmentColor() returns true"),i.vec4(1);let s=this.getUniformValueAlbedoColor(t);return this.albedoTexture&&(s=i.mul(s,this.sampleAlbedoTexture(t,e))),s}vertexShader(t){super.vertexShader(t),this.needFragmentColor()&&this.drawContext.instancing&&(t.$outputs.zAlbedo=this.getInstancedUniform(t,i))}fragmentShader(t){if(super.fragmentShader(t),this.needFragmentColor()&&!this.drawContext.instancing){const e=t.$builder;t.zAlbedo=e.vec4().uniform(2)}}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),this.needFragmentColor(e)&&!e.instancing&&t.setValue("zAlbedo",this._albedoColor)}}}function oo(t){if(t.lightMixed)return t;const e=to(t,ao,no("normal"));let i=0,s=0;const r=class extends e{static lightMixed=!0;_normalScale;constructor(){super(),this._normalScale=1,this.useFeature(i,!0)}get normalScale(){return this._normalScale}set normalScale(t){t!==this._normalScale&&(this._normalScale=t,this.uniformChanged())}get normalMapMode(){return this.featureUsed(s)}set normalMapMode(t){this.useFeature(s,t)}get doubleSidedLighting(){return this.featureUsed(i)}set doubleSidedLighting(t){this.useFeature(i,!!t)}calculateViewVector(t,e){const i=t.$builder;return i.normalize(i.sub(Qa.getCameraPosition(t),e.xyz))}calculateReflectionVector(t,e,i){const s=t.$builder;return s.reflect(s.neg(i),e)}calculateNormal(t,e,i,s,r){const n=t.$builder,a=this,o=[e],h=[n.vec3("worldPos")];let l="Z_calculateNormal";return i&&(h.push(n.vec3("worldNormal")),o.push(i),l+="_N",s&&r&&(h.push(n.vec3("worldTangent"),n.vec3("worldBinormal")),o.push(s,r),l+="_T")),n.func(l,h,(function(){if(this.$l.uv=a.normalTexture?a.getNormalTexCoord(this)??n.vec2(0):a.albedoTexture?a.getAlbedoTexCoord(this)??n.vec2(0):n.vec2(0),this.$l.TBN=a.calculateTBN(this,this.worldPos,this.worldNormal,this.worldTangent,this.worldBinormal),a.drawContext.renderPass.type===Ra&&a.normalTexture)if("object-space"===a.normalMapMode){const t=n.sub(n.mul(n.textureSample(a.getNormalTextureUniform(this),this.uv).rgb,2),n.vec3(1)),e=n.mul(t,n.vec3(n.vec3(this.zNormalScale).xx,1));this.$return(n.normalize(e))}else{const t=n.sub(n.mul(n.textureSample(a.getNormalTextureUniform(this),this.uv).rgb,2),n.vec3(1)),e=n.mul(t,n.vec3(n.vec3(this.zNormalScale).xx,1));this.$return(n.normalize(n.mul(this.TBN,e)))}else this.$return(this.TBN[2])})),n.getGlobalScope()[l](...o)}calculateNormalAndTBN(t,e,i,s,r){const n=t.$builder,a=n.defineStruct([n.mat3("TBN"),n.vec3("normal")]),o=this,h=[e.xyz],l=[n.vec3("worldPos")];let u="Z_calculateNormalAndTBN";return i&&(l.push(n.vec3("worldNormal")),h.push(i),u+="_N",s&&r&&(l.push(n.vec3("worldTangent"),n.vec3("worldBinormal")),h.push(s,r),u+="_T")),n.func(u,l,(function(){if(this.$l.uv=o.normalTexture?o.getNormalTexCoord(this)??n.vec2(0):o.albedoTexture?o.getAlbedoTexCoord(this)??n.vec2(0):n.vec2(0),this.$l.TBN=o.calculateTBN(this,this.worldPos,this.worldNormal,this.worldTangent,this.worldBinormal),o.drawContext.renderPass.type===Ra&&o.normalTexture)if("object-space"===o.normalMapMode){const t=n.sub(n.mul(n.textureSample(o.getNormalTextureUniform(this),this.uv).rgb,2),n.vec3(1)),e=n.mul(t,n.vec3(n.vec3(this.zNormalScale).xx,1));this.$return(a(this.TBN,n.normalize(e)))}else{const t=n.sub(n.mul(n.textureSample(o.getNormalTextureUniform(this),this.uv).rgb,2),n.vec3(1)),e=n.mul(t,n.vec3(n.vec3(this.zNormalScale).xx,1));this.$return(a(this.TBN,n.normalize(n.mul(this.TBN,e))))}else this.$return(a(this.TBN,this.TBN[2]))})),n.getGlobalScope()[u](...h)}calculateTBN(t,e,i,s,r){const n=t.$builder,a=this,o=[e.xyz],h=[n.vec3("worldPos")];let l="Z_calculateTBN";return i&&(h.push(n.vec3("worldNormal")),o.push(i),l+="_N",s&&r&&(h.push(n.vec3("worldTangent"),n.vec3("worldBinormal")),o.push(s,r),l+="_T")),n.func(l,h,(function(){const t=this.worldPos;this.$l.uv=a.normalTexture?a.getNormalTexCoord(this)??n.vec2(0):a.albedoTexture?a.getAlbedoTexCoord(this)??n.vec2(0):n.vec2(0),this.$l.TBN=n.mat3(),i?s?(this.$l.ng=n.normalize(this.worldNormal),this.$l.t=n.normalize(this.worldTangent),this.$l.b=n.normalize(this.worldBinormal),a.doubleSidedLighting&&this.$if(n.not(this.$builtins.frontFacing),(function(){this.t=n.mul(this.t,-1),this.b=n.mul(this.b,-1),this.ng=n.mul(this.ng,-1)})),this.TBN=n.mat3(this.t,this.b,this.ng)):(this.$l.uv_dx=n.dpdx(n.vec3(this.uv,0)),this.$l.uv_dy=n.dpdy(n.vec3(this.uv,0)),this.$if(n.lessThanEqual(n.add(n.length(this.uv_dx),n.length(this.uv_dy)),1e-6),(function(){this.uv_dx=n.vec3(1,0,0),this.uv_dy=n.vec3(0,1,0)})),this.$l.t_=n.div(n.sub(n.mul(n.dpdx(t),this.uv_dy.y),n.mul(n.dpdy(t),this.uv_dx.y)),n.sub(n.mul(this.uv_dx.x,this.uv_dy.y),n.mul(this.uv_dx.y,this.uv_dy.x))),this.$l.ng=n.normalize(this.worldNormal),this.$l.t=n.normalize(n.sub(this.t_,n.mul(this.ng,n.dot(this.ng,this.t_)))),this.$l.b=n.cross(this.ng,this.t),a.doubleSidedLighting&&this.$if(n.not(this.$builtins.frontFacing),(function(){this.t=n.mul(this.t,-1),this.b=n.mul(this.b,-1),this.ng=n.mul(this.ng,-1)})),this.TBN=n.mat3(this.t,this.b,this.ng)):(this.$l.uv_dx=n.dpdx(n.vec3(this.uv,0)),this.$l.uv_dy=n.dpdy(n.vec3(this.uv,0)),this.$if(n.lessThanEqual(n.add(n.length(this.uv_dx),n.length(this.uv_dy)),1e-6),(function(){this.uv_dx=n.vec3(1,0,0),this.uv_dy=n.vec3(0,1,0)})),this.$l.t_=n.div(n.sub(n.mul(n.dpdx(t),this.uv_dy.y),n.mul(n.dpdy(t),this.uv_dx.y)),n.sub(n.mul(this.uv_dx.x,this.uv_dy.y),n.mul(this.uv_dx.y,this.uv_dy.x))),this.$l.ng=n.normalize(n.cross(n.dpdx(t),n.dpdy(t))),this.$l.t=n.normalize(n.sub(this.t_,n.mul(this.ng,n.dot(this.ng,this.t_)))),this.$l.b=n.cross(this.ng,this.t),a.doubleSidedLighting&&this.$if(n.not(this.$builtins.frontFacing),(function(){this.t=n.mul(this.t,-1),this.b=n.mul(this.b,-1),this.ng=n.mul(this.ng,-1)})),this.TBN=n.mat3(this.t,this.b,this.ng)),this.$return(this.TBN)})),n.getGlobalScope()[l](...o)}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),e.renderPass.type===Ra&&this.normalTexture&&t.setValue("zNormalScale",this._normalScale)}needCalculateEnvLight(){return this.drawContext.renderPass.type===Ra&&this.drawContext.drawEnvLight}getEnvLightIrradiance(t,e){return this.needCalculateEnvLight()?this.drawContext.env.light.envLight.hasIrradiance()?t.$builder.mul(this.drawContext.env.light.envLight.getIrradiance(t,e).rgb,Qa.getEnvLightStrength(t)):t.$builder.vec3(0):(console.warn("getEnvLightIrradiance(): No need to calculate environment lighting"),t.$builder.vec3(0))}getEnvLightRadiance(t,e,i){return this.needCalculateEnvLight()?this.drawContext.env.light.envLight.hasRadiance()?t.$builder.mul(this.drawContext.env.light.envLight.getRadiance(t,e,i).rgb,Qa.getEnvLightStrength(t)):t.$builder.vec3(0):(console.warn("getEnvLightRadiance(): No need to calculate environment lighting"),t.$builder.vec3(0))}needCalculateShadow(){return this.drawContext.renderPass.type===Ra&&!!this.drawContext.currentShadowLight}calculateShadow(t,e,i){const s=t.$builder;return this.needCalculateShadow()?Qa.calculateShadow(t,e,i,this.drawContext):(console.warn("calculateShadow(): No need to calculate shadow"),s.float(1))}getClusterIndex(t,e){const i=t.$builder,s="lm_getClusterIndex";return i.func(s,[i.vec3("fragCoord")],(function(){const t=Qa.getClusterParams(this),e=Qa.getCountParams(this);this.$l.zTile=i.int(i.max(i.add(i.mul(i.log2(Qa.nonLinearDepthToLinear(this,this.fragCoord.z)),t.z),t.w),0)),this.$l.f=i.vec2(this.fragCoord.x,i.sub(t.y,i.add(this.fragCoord.y,1))),this.$l.xyTile=i.ivec2(i.div(this.f,i.div(t.xy,i.vec2(e.xy)))),this.$return(i.ivec3(this.xyTile,this.zTile))})),i.getGlobalScope()[s](e)}calculatePointLightAttenuation(t,e,i){const s=t.$builder,r="Z_calculatePointLightAttenuation";return s.func(r,[s.vec3("worldPos"),s.vec4("posRange")],(function(){this.$l.dist=s.distance(this.posRange.xyz,this.worldPos),this.$l.falloff=s.max(0,s.sub(1,s.div(this.dist,this.posRange.w))),this.$return(s.mul(this.falloff,this.falloff))})),s.getGlobalScope()[r](e,i)}calculateSpotLightAttenuation(t,e,i,s){const r=t.$builder,n="Z_calculateSpotLightAttenuation";return r.func(n,[r.vec3("worldPos"),r.vec4("posRange"),r.vec4("dirCutoff")],(function(){this.$l.dist=r.distance(this.posRange.xyz,this.worldPos),this.$l.falloff=r.max(0,r.sub(1,r.div(this.dist,this.posRange.w))),this.$l.spotFactor=r.dot(r.normalize(r.sub(this.worldPos,this.posRange.xyz)),this.dirCutoff.xyz),this.spotFactor=r.smoothStep(this.dirCutoff.w,r.mix(this.dirCutoff.w,1,.5),this.spotFactor),this.$return(r.mul(this.spotFactor,this.falloff,this.falloff))})),r.getGlobalScope()[n](e,i,s)}calculateLightAttenuation(t,e,i,s,r){const n=t.$builder;return t.$choice(n.equal(e,Ia),n.float(1),t.$choice(n.equal(e,Da),this.calculatePointLightAttenuation(t,i.xyz,s),this.calculateSpotLightAttenuation(t,i.xyz,s,r)))}calculateLightDirection(t,e,i,s,r){const n=t.$builder;return t.$choice(n.equal(e,Ia),n.neg(r.xyz),n.normalize(n.sub(s.xyz,i.xyz)))}forEachLight(t,e){const i=t.$builder,s=this;if(s.drawContext.renderPass.type===Ra)if(s.drawContext.currentShadowLight){const s=Qa.getGlobalUniforms(t).light.positionAndRange,r=Qa.getGlobalUniforms(t).light.directionAndCutoff,n=Qa.getGlobalUniforms(t).light.diffuseAndIntensity;t.$scope((function(){const a=t.$choice(i.lessThan(s.w,0),i.int(Ia),t.$choice(i.lessThan(r.w,0),i.int(Da),i.int($a)));e.call(this,a,s,r,n,!0)}))}else t.$scope((function(){const r=Qa.getCountParams(this);this.$l.cluster=s.getClusterIndex(this,this.$builtins.fragCoord.xyz),this.$l.clusterIndex=i.add(this.cluster.x,i.mul(this.cluster.y,r.x),i.mul(this.cluster.z,r.x,r.y)),this.$l.texSize=Qa.getGlobalUniforms(t).light.lightIndexTexSize,"webgl"===i.getDevice().type?(this.$l.texCoordX=i.div(i.add(i.mod(i.float(this.clusterIndex),i.float(this.texSize.x)),.5),i.float(this.texSize.x)),this.$l.texCoordY=i.div(i.add(i.float(i.div(this.clusterIndex,this.texSize.x)),.5),i.float(this.texSize.y)),this.$l.samp=i.textureSample(Qa.getClusteredLightIndexTexture(this),i.vec2(this.texCoordX,this.texCoordY))):(this.$l.texCoordX=i.mod(this.clusterIndex,this.texSize.x),this.$l.texCoordY=i.div(this.clusterIndex,this.texSize.x),this.$l.samp=i.textureLoad(Qa.getClusteredLightIndexTexture(this),i.ivec2(this.texCoordX,this.texCoordY),0)),"webgl"===i.getDevice().type?this.$for(i.int("i"),0,4,(function(){this.$l.k=this.samp.at(this.i),this.$l.lights=i.int[2](),this.$l.lights[0]=i.int(i.mod(this.k,256)),this.$l.lights[1]=i.int(i.div(this.k,256)),this.$for(i.int("k"),0,2,(function(){this.$l.li=this.lights.at(this.k),this.$if(i.greaterThan(this.li,0),(function(){this.$for(i.int("j"),1,256,(function(){this.$if(i.equal(this.j,this.li),(function(){this.$l.positionRange=Qa.getLightPositionAndRange(this,this.j),this.$l.directionCutoff=Qa.getLightDirectionAndCutoff(this,this.j),this.$l.diffuseIntensity=Qa.getLightColorAndIntensity(this,this.j),this.$l.lightType=this.$choice(i.lessThan(this.positionRange.w,0),i.int(Ia),this.$choice(i.lessThan(this.directionCutoff.w,0),i.int(Da),i.int($a))),this.$scope((function(){e.call(this,this.lightType,this.positionRange,this.directionCutoff,this.diffuseIntensity,!1)})),this.$break()}))}))}))}))})):this.$for(i.uint("i"),0,4,(function(){this.$for(i.uint("k"),0,4,(function(){this.$l.c=i.compAnd(i.sar(this.samp.at(this.i),i.mul(this.k,8)),255),this.$if(i.greaterThan(this.c,0),(function(){this.$l.positionRange=Qa.getLightPositionAndRange(this,this.c),this.$l.directionCutoff=Qa.getLightDirectionAndCutoff(this,this.c),this.$l.diffuseIntensity=Qa.getLightColorAndIntensity(this,this.c),this.$l.lightType=this.$choice(i.lessThan(this.positionRange.w,0),i.int(Ia),this.$choice(i.lessThan(this.directionCutoff.w,0),i.int(Da),i.int($a))),this.$scope((function(){e.call(this,this.lightType,this.positionRange,this.directionCutoff,this.diffuseIntensity,!1)}))}))}))}))}));else console.warn("LitMaterial.forEachLight(): must be called in forward render pass")}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;this.drawContext.renderPass.type===Ra&&this.normalTexture&&(t.zNormalScale=e.float().uniform(2))}supportLighting(){return!0}};return i=r.defineFeature(),s=r.defineFeature(),r}function ho(t){if(t.vertexColorMixed)return t;let e=0;const i=class extends t{static vertexColorMixed=!0;constructor(...t){super(...t)}get vertexColor(){return this.featureUsed(e)}set vertexColor(t){this.useFeature(e,!!t)}vertexShader(t){if(super.vertexShader(t),this.needFragmentColor()&&this.vertexColor){if(t.$getVertexAttrib("diffuse"))throw new Error("mixinVertexColor.vertexShader(): diffuse vertex stream already defined");t.$inputs.zDiffuse=t.$builder.vec4().attrib("diffuse"),t.$outputs.zOutDiffuse=t.$inputs.zDiffuse}}getVertexColor(t){if(!this.needFragmentColor())throw new Error("mixinVertexColor.getVertexColor(): No need to calculate albedo color, make sure needFragmentColor() returns true");return"fragment"===t.$builder.shaderKind?t.$inputs.zOutDiffuse:t.$inputs.zDiffuse}};return e=i.defineFeature(),i}eo=ro.defineFeature(),io=ro.defineFeature(),so=ro.defineFeature();class lo extends(to(ro,oo,ho)){static FEATURE_VERTEX_NORMAL=this.defineFeature();static FEATURE_VERTEX_TANGENT=this.defineFeature();constructor(){super(),this.useFeature(lo.FEATURE_VERTEX_NORMAL,!0)}get vertexNormal(){return this.featureUsed(lo.FEATURE_VERTEX_NORMAL)}set vertexNormal(t){this.useFeature(lo.FEATURE_VERTEX_NORMAL,!!t)}get vertexTangent(){return this.featureUsed(lo.FEATURE_VERTEX_TANGENT)}set vertexTangent(t){this.useFeature(lo.FEATURE_VERTEX_TANGENT,!!t)}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$l.oPos=Qa.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(Qa.getWorldMatrix(t),e.vec4(t.oPos,1)).xyz,Qa.setClipSpacePosition(t,e.mul(Qa.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),this.vertexNormal&&(t.$l.oNorm=Qa.resolveVertexNormal(t),t.$outputs.wNorm=e.mul(Qa.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz,this.vertexTangent&&(t.$l.oTangent=Qa.resolveVertexTangent(t),t.$outputs.wTangent=e.mul(Qa.getNormalMatrix(t),e.vec4(t.oTangent.xyz,0)).xyz,t.$outputs.wBinormal=e.mul(e.cross(t.$outputs.wNorm,t.$outputs.wTangent),t.oTangent.w)))}fragmentShader(t){super.fragmentShader(t);const e=t.$builder,i=this;this.needFragmentColor()?(t.$l.albedo=this.calculateAlbedoColor(t),this.vertexColor&&(t.albedo=e.mul(t.albedo,this.getVertexColor(t))),this.drawContext.renderPass.type===Ra?(t.$l.color=e.vec3(0),t.$l.normal=this.calculateNormal(t,t.$inputs.worldPos,t.$inputs.wNorm,t.$inputs.wTangent,t.$inputs.wBinormal),this.needCalculateEnvLight()&&(t.color=e.add(t.color,this.getEnvLightIrradiance(t,t.normal))),this.forEachLight(t,(function(s,r,n,a,o){this.$l.lightAtten=i.calculateLightAttenuation(this,s,t.$inputs.worldPos,r,n),this.$l.lightDir=i.calculateLightDirection(this,s,t.$inputs.worldPos,r,n),this.$l.NoL=e.clamp(e.dot(this.normal,this.lightDir),0,1),this.$l.lightContrib=e.mul(a.rgb,a.a,this.NoL,this.lightAtten),o&&(this.$l.shadow=e.vec3(i.calculateShadow(this,t.$inputs.worldPos,this.NoL)),this.lightContrib=e.mul(this.lightContrib,this.shadow)),this.color=e.add(this.color,this.lightContrib)})),t.$l.litColor=e.mul(t.albedo,e.vec4(t.color,1)),this.outputFragmentColor(t,t.$inputs.worldPos,t.litColor)):this.outputFragmentColor(t,t.$inputs.worldPos,t.albedo)):this.outputFragmentColor(t,t.$inputs.worldPos,null)}}function uo(t){if(t.blinnPhongMixed)return t;const e=to(t,oo);return class extends e{static blinnPhongMixed=!0;_shininess;constructor(){super(),this._shininess=32}get shininess(){return this._shininess}set shininess(t){t!==this._shininess&&(this._shininess=t,this.uniformChanged())}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;this.needFragmentColor()&&(t.zShininess=e.float().uniform(2))}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),this.needFragmentColor(e)&&t.setValue("zShininess",this._shininess)}blinnPhongLight(t,e,i,s,r){const n=t.$builder,a="Z_blinnPhongLight",o=this;return n.func(a,[n.vec3("worldPos"),n.vec3("normal"),n.vec3("viewVec"),n.vec4("albedo")],(function(){o.needFragmentColor()?(o.needCalculateEnvLight()?this.$l.diffuseColor=o.getEnvLightIrradiance(this,this.normal):this.$l.diffuseColor=n.vec3(0),this.$l.specularColor=n.vec3(0),o.forEachLight(this,(function(t,e,i,s,r){this.$l.lightAtten=o.calculateLightAttenuation(this,t,this.worldPos,e,i),this.$l.lightDir=o.calculateLightDirection(this,t,this.worldPos,e,i),this.$l.NoL=n.clamp(n.dot(this.normal,this.lightDir),0,1),this.$l.halfVec=n.normalize(n.add(this.viewVec,this.lightDir)),this.$l.NoH=n.clamp(n.dot(this.normal,this.halfVec),0,1),this.$l.lightColor=n.mul(s.rgb,s.a,this.lightAtten),this.$l.diffuse=n.mul(this.lightColor,this.NoL),this.$l.specular=n.mul(this.lightColor,n.pow(this.NoH,this.zShininess)),r&&(this.$l.shadow=n.vec3(o.calculateShadow(this,this.worldPos,this.NoL)),this.diffuse=n.mul(this.diffuse,this.shadow),this.specular=n.mul(this.specular,this.shadow)),this.diffuseColor=n.add(this.diffuseColor,this.diffuse),this.specularColor=n.add(this.specularColor,this.specular)})),this.$l.litColor=n.add(n.mul(this.albedo.rgb,this.diffuseColor),this.specularColor),this.$return(this.litColor)):this.$return(this.albedo.rgb)})),n.getGlobalScope()[a](e,i,s,r)}}}class co extends(to(ro,uo,ho)){static FEATURE_VERTEX_NORMAL=this.defineFeature();static FEATURE_VERTEX_TANGENT=this.defineFeature();constructor(){super(),this.useFeature(co.FEATURE_VERTEX_NORMAL,!0)}get vertexNormal(){return this.featureUsed(co.FEATURE_VERTEX_NORMAL)}set vertexNormal(t){this.useFeature(co.FEATURE_VERTEX_NORMAL,!!t)}get vertexTangent(){return this.featureUsed(co.FEATURE_VERTEX_TANGENT)}set vertexTangent(t){this.useFeature(co.FEATURE_VERTEX_TANGENT,!!t)}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$l.oPos=Qa.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(Qa.getWorldMatrix(t),e.vec4(t.oPos,1)).xyz,Qa.setClipSpacePosition(t,e.mul(Qa.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),this.vertexNormal&&(t.$l.oNorm=Qa.resolveVertexNormal(t),t.$outputs.wNorm=e.mul(Qa.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz,this.vertexTangent&&(t.$l.oTangent=Qa.resolveVertexTangent(t),t.$outputs.wTangent=e.mul(Qa.getNormalMatrix(t),e.vec4(t.oTangent.xyz,0)).xyz,t.$outputs.wBinormal=e.mul(e.cross(t.$outputs.wNorm,t.$outputs.wTangent),t.oTangent.w)))}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;this.needFragmentColor()?(t.$l.albedo=this.calculateAlbedoColor(t),this.vertexColor&&(t.albedo=e.mul(t.albedo,this.getVertexColor(t))),this.drawContext.renderPass.type===Ra?(t.$l.normal=this.calculateNormal(t,t.$inputs.worldPos,t.$inputs.wNorm,t.$inputs.wTangent,t.$inputs.wBinormal),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),t.$l.litColor=this.blinnPhongLight(t,t.$inputs.worldPos,t.normal,t.viewVec,t.albedo),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a))):this.outputFragmentColor(t,t.$inputs.worldPos,t.albedo)):this.outputFragmentColor(t,t.$inputs.worldPos,null)}}class po extends(to(ro,ho,ao)){static FEATURE_VERTEX_COLOR="um_vertexcolor";constructor(){super()}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$l.oPos=Qa.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(Qa.getWorldMatrix(t),e.vec4(t.oPos,1)).xyz,Qa.setClipSpacePosition(t,e.mul(Qa.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1)))}fragmentShader(t){if(super.fragmentShader(t),this.needFragmentColor()){let e=this.calculateAlbedoColor(t);this.vertexColor&&(e=t.$builder.mul(e,this.getVertexColor(t))),this.outputFragmentColor(t,t.$inputs.worldPos,e)}else this.outputFragmentColor(t,t.$inputs.worldPos,null)}}const mo=new Map;function fo(t){let e=mo.get(t);return e||(e=function(t){const e=q.instance.device,i=e.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),"webgpu"===e.type&&(this.$builtins.position.y=t.neg(this.$builtins.position.y))}))},fragment(t){this.$outputs.color=t.vec4();const i=1024;"webgl"===e.type?(t.func("radicalInverse_VdC",[t.int("bits")],(function(){this.$l.rand=t.float(0),this.$l.denom=t.float(1),this.$l.invBase=t.float(.5),this.$l.n=this.bits,this.$for(t.int("i"),0,32,(function(){this.denom=t.mul(this.denom,2),this.rand=t.add(this.rand,t.div(t.mod(t.float(this.n),2),this.denom)),this.n=t.div(this.n,2),this.$if(t.equal(this.n,0),(function(){this.$break()}))})),this.$return(this.rand)})),t.func("hammersley2d",[t.int("i"),t.int("N")],(function(){this.$return(t.vec2(t.div(t.float(this.i),t.float(this.N)),this.radicalInverse_VdC(this.i)))}))):(t.func("radicalInverse_VdC",[t.uint("bits")],(function(){this.$l.n=this.bits,this.n=t.compOr(t.sal(this.n,16),t.sar(this.n,16)),this.n=t.compOr(t.sal(t.compAnd(this.n,1431655765),1),t.sar(t.compAnd(this.n,2863311530),1)),this.n=t.compOr(t.sal(t.compAnd(this.n,858993459),2),t.sar(t.compAnd(this.n,3435973836),2)),this.n=t.compOr(t.sal(t.compAnd(this.n,252645135),4),t.sar(t.compAnd(this.n,4042322160),4)),this.n=t.compOr(t.sal(t.compAnd(this.n,16711935),8),t.sar(t.compAnd(this.n,4278255360),8)),this.$return(t.mul(t.float(this.n),2.3283064365386963e-10))})),t.func("hammersley2d",[t.int("i"),t.int("N")],(function(){this.$return(t.vec2(t.div(t.float(this.i),t.float(this.N)),this.radicalInverse_VdC(t.uint(this.i))))}))),t.func("generateTBN",[t.vec3("normal")],(function(){this.$l.bitangent=t.vec3(0,1,0),this.$l.NoU=this.normal.y,this.$l.epsl=1e-7,this.$if(t.lessThanEqual(t.sub(1,t.abs(this.normal.y)),this.epsl),(function(){this.bitangent=this.$choice(t.greaterThan(this.normal.y,0),t.vec3(0,0,1),t.vec3(0,0,-1))})),this.$l.tangent=t.normalize(t.cross(this.bitangent,this.normal)),this.bitangent=t.cross(this.normal,this.tangent),this.$return(t.mat3(this.tangent,this.bitangent,this.normal))})),t.func("D_Charlie",[t.float("sheenRoughness"),t.float("NdotH")],(function(){this.$l.roughness=t.max(this.sheenRoughness,1e-6),this.$l.invR=t.div(1,this.roughness),this.$l.cos2h=t.mul(this.NdotH,this.NdotH),this.$l.sin2h=t.sub(1,this.cos2h),this.$return(t.div(t.mul(t.add(this.invR,2),t.pow(this.sin2h,t.mul(this.invR,.5))),2*Math.PI))})),t.func("smithGGXCorrelated",[t.float("NoV"),t.float("NoL"),t.float("roughness")],(function(){this.$l.a2=t.mul(this.roughness,this.roughness,this.roughness,this.roughness),this.$l.GGXV=t.mul(this.NoL,t.sqrt(t.add(t.mul(this.NoV,this.NoV,t.sub(1,this.a2)),this.a2))),this.$l.GGXL=t.mul(this.NoV,t.sqrt(t.add(t.mul(this.NoL,this.NoL,t.sub(1,this.a2)),this.a2))),this.$return(t.div(.5,t.add(this.GGXV,this.GGXL)))})),t.func("V_Ashikhmin",[t.float("NdotL"),t.float("NdotV")],(function(){this.$return(t.clamp(t.div(1,t.mul(t.sub(t.add(this.NdotL,this.NdotV),t.mul(this.NdotL,this.NdotV)),4)),0,1))})),t.func("importanceSample",[t.vec2("xi"),t.vec3("normal"),t.float("roughness"),t.vec3("ggx").out(),t.vec3("charlie").out()],(function(){this.$l.alphaRoughness=t.mul(this.roughness,this.roughness),this.$l.cosTheta=t.clamp(t.sqrt(t.div(t.sub(1,this.xi.y),t.add(1,t.mul(t.sub(t.mul(this.alphaRoughness,this.alphaRoughness),1),this.xi.y)))),0,1),this.$l.sinTheta=t.sqrt(t.sub(1,t.mul(this.cosTheta,this.cosTheta))),this.$l.phi=t.mul(this.xi.x,2*Math.PI),this.$l.TBN=this.generateTBN(this.normal),this.$l.localSpaceDir=t.normalize(t.vec3(t.mul(this.sinTheta,t.cos(this.phi)),t.mul(this.sinTheta,t.sin(this.phi)),this.cosTheta)),this.ggx=t.mul(this.TBN,this.localSpaceDir),this.sinTheta=t.pow(this.xi.y,t.div(this.alphaRoughness,t.add(t.mul(this.alphaRoughness,2),1))),this.cosTheta=t.sqrt(t.sub(1,t.mul(this.sinTheta,this.sinTheta))),this.localSpaceDir=t.normalize(t.vec3(t.mul(this.sinTheta,t.cos(this.phi)),t.mul(this.sinTheta,t.sin(this.phi)),this.cosTheta)),this.charlie=t.mul(this.TBN,this.localSpaceDir)})),t.func("integrateBRDF",[t.float("NoV"),t.float("roughness")],(function(){this.$l.V=t.vec3(t.sub(1,t.mul(this.NoV,this.NoV)),0,this.NoV),this.$l.a=t.float(0),this.$l.b=t.float(0),this.$l.c=t.float(0),this.$l.n=t.vec3(0,0,1),this.$for(t.int("i"),0,i,(function(){this.$l.xi=this.hammersley2d(this.i,i),this.$l.ggxSample=t.vec3(),this.$l.charlieSample=t.vec3(),this.importanceSample(this.xi,this.n,this.roughness,this.ggxSample,this.charlieSample),this.$l.ggxL=t.normalize(t.reflect(t.neg(this.V),this.ggxSample.xyz)),this.$l.ggxNoL=t.clamp(this.ggxL.z,0,1),this.$l.ggxNoH=t.clamp(this.ggxSample.z,0,1),this.$l.ggxVoH=t.clamp(t.dot(this.V,this.ggxSample.xyz),0,1),this.$l.charlieL=t.normalize(t.reflect(t.neg(this.V),this.charlieSample.xyz)),this.$l.charlieNoL=t.clamp(this.charlieL.z,0,1),this.$l.charlieNoH=t.clamp(this.charlieSample.z,0,1),this.$l.charlieVoH=t.clamp(t.dot(this.V,this.charlieSample.xyz),0,1),this.$if(t.greaterThan(this.ggxNoL,0),(function(){this.$l.pdf=t.div(t.mul(this.smithGGXCorrelated(this.NoV,this.ggxNoL,this.roughness),this.ggxVoH,this.ggxNoL),this.ggxNoH),this.$l.Fc=t.pow(t.sub(1,this.ggxVoH),5),this.a=t.add(this.a,t.mul(t.sub(1,this.Fc),this.pdf)),this.b=t.add(this.b,t.mul(this.Fc,this.pdf))})),this.$if(t.greaterThan(this.charlieNoL,0),(function(){this.$l.sheenDistribution=this.D_Charlie(this.roughness,this.charlieNoH),this.$l.sheenVis=this.V_Ashikhmin(this.charlieNoL,this.NoV),this.c=t.add(this.c,t.mul(this.sheenVis,this.sheenDistribution,this.charlieNoL,this.charlieVoH))}))})),this.$return(t.div(t.vec3(t.mul(this.a,4),t.mul(this.b,4),t.mul(this.c,8*Math.PI)),i))})),t.main((function(){this.$outputs.color=t.vec4(this.integrateBRDF(this.$inputs.uv.x,this.$inputs.uv.y),1)}))}}),s=e.createVertexLayout({vertexBuffers:[{buffer:e.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]}),r=e.createRenderStateSet();r.useRasterizerState().setCullMode("none"),r.useDepthState().enableTest(!1).enableWrite(!1);const n=e.createTexture2D("rgba8unorm",t,t,{samplerOptions:{mipFilter:"none"}});n.name="GGXLUT";const a=e.createFrameBuffer([n],null);return e.pushDeviceStates(),e.setProgram(i),e.setVertexLayout(s),e.setRenderStates(r),e.setFramebuffer(a),e.draw("triangle-strip",0,4),e.popDeviceStates(),a.dispose(),s.dispose(),i.dispose(),n}(t),mo.set(t,e)),e}function _o(t){if(t.pbrCommonMixed)return t;const e=to(t,no("occlusion"),no("emissive"),no("sheenColor"),no("sheenRoughness"),no("clearcoatIntensity"),no("clearcoatRoughness"),no("clearcoatNormal"),no("transmission"),no("thickness"),no("iridescence"),no("iridescenceThickness"));let i=0,s=0,r=0,n=0;const a=class extends e{static pbrCommonMixed=!0;_f0;_emissiveFactor;_occlusionStrength;_sheenFactor;_clearcoatFactor;_transmissionFactor;_thicknessFactor;_attenuationColor;_attenuationDistance;_iridescenceFactor;_sceneColorTexSize;constructor(){super(),this._f0=new T(.04,.04,.04,1.5),this._occlusionStrength=1,this._emissiveFactor=new T(0,0,0,1),this._sheenFactor=T.zero(),this._clearcoatFactor=new T(0,0,1,0),this._transmissionFactor=0,this._thicknessFactor=0,this._attenuationColor=b.one(),this._attenuationDistance=99999,this._iridescenceFactor=new T(0,1.3,100,400),this._sceneColorTexSize=new x}get ior(){return this._f0.w}set ior(t){if(t!==this._f0.w){let e=(t-1)/(t+1);e*=e,this._f0.setXYZW(e,e,e,t),this.uniformChanged()}}get transmissionFactor(){return this._transmissionFactor}set transmissionFactor(t){t!==this._transmissionFactor&&(this._transmissionFactor=t,this.uniformChanged())}get thicknessFactor(){return this._thicknessFactor}set thicknessFactor(t){this._thicknessFactor!==t&&(this._thicknessFactor=t,this.uniformChanged())}get attenuationColor(){return this._attenuationColor}set attenuationColor(t){t.equalsTo(this._attenuationColor)||(this._attenuationColor.set(t),this.uniformChanged())}get attenuationDistance(){return this._attenuationDistance}set attenuationDistance(t){t!==this._attenuationDistance&&(this._attenuationDistance=t,this.uniformChanged())}get iridescenceFactor(){return this._iridescenceFactor.x}set iridescenceFactor(t){this._iridescenceFactor.x!==t&&(this._iridescenceFactor.x=t,this.uniformChanged())}get iridescenceIor(){return this._iridescenceFactor.y}set iridescenceIor(t){this._iridescenceFactor.y!==t&&(this._iridescenceFactor.y=t,this.uniformChanged())}get iridescenceThicknessMin(){return this._iridescenceFactor.z}set iridescenceThicknessMin(t){this._iridescenceFactor.z!==t&&(this._iridescenceFactor.z=t,this.uniformChanged())}get iridescenceThicknessMax(){return this._iridescenceFactor.w}set iridescenceThicknessMax(t){this._iridescenceFactor.w!==t&&(this._iridescenceFactor.w=t,this.uniformChanged())}get occlusionStrength(){return this._occlusionStrength}set occlusionStrength(t){t!==this._occlusionStrength&&(this._occlusionStrength=t,this.uniformChanged())}get emissiveColor(){return this._emissiveFactor.xyz()}set emissiveColor(t){t.x===this._emissiveFactor.x&&t.y===this._emissiveFactor.y&&t.z===this._emissiveFactor.z||(this._emissiveFactor.x=t.x,this._emissiveFactor.y=t.y,this._emissiveFactor.z=t.z,this.uniformChanged())}get emissiveStrength(){return this._emissiveFactor.w}set emissiveStrength(t){this._emissiveFactor.w!==t&&(this._emissiveFactor.w=t,this.uniformChanged())}get transmission(){return this.featureUsed(r)}set transmission(t){this.useFeature(r,!!t)}get iridescence(){return this.featureUsed(n)}set iridescence(t){this.useFeature(n,!!t)}get clearcoat(){return this.featureUsed(s)}set clearcoat(t){this.useFeature(s,!!t)}get clearcoatIntensity(){return this._clearcoatFactor.x}set clearcoatIntensity(t){t!==this._clearcoatFactor.x&&(this._clearcoatFactor.x=t,this.uniformChanged())}get clearcoatRoughnessFactor(){return this._clearcoatFactor.y}set clearcoatRoughnessFactor(t){t!==this._clearcoatFactor.y&&(this._clearcoatFactor.y=t,this.uniformChanged())}get clearcoatNormalScale(){return this._clearcoatFactor.z}set clearcoatNormalScale(t){t!==this._clearcoatFactor.z&&(this._clearcoatFactor.z=t,this.uniformChanged())}get sheen(){return this.featureUsed(i)}set sheen(t){this.useFeature(i,!!t)}get sheenColorFactor(){return this._sheenFactor.xyz()}set sheenColorFactor(t){t.x===this._sheenFactor.x&&t.y===this._sheenFactor.y&&t.z===this._sheenFactor.z||(this._sheenFactor.x=t.x,this._sheenFactor.y=t.y,this._sheenFactor.z=t.z,this.uniformChanged())}get sheenRoughnessFactor(){return this._sheenFactor.w}set sheenRoughnessFactor(t){t!==this._sheenFactor.w&&(this._sheenFactor.w=t,this.uniformChanged())}fragmentShader(t){const e=t.$builder;super.fragmentShader(t),this.needFragmentColor()&&(t.zF0=e.vec4().uniform(2),t.zEmissiveFactor=e.vec4().uniform(2),this.occlusionTexture&&(t.zOcclusionStrength=e.float().uniform(2)),this.sheen&&(t.zSheenFactor=e.vec4().uniform(2)),this.clearcoat&&(t.zClearcoatFactor=e.vec4().uniform(2)),this.transmission&&(t.zTransmissionFactor=e.float().uniform(2),t.zThicknessFactor=e.float().uniform(2),t.zAttenuationColor=e.vec3().uniform(2),t.zAttenuationDistance=e.float().uniform(2),t.zSceneColorTex=e.tex2D().uniform(2),t.zSceneColorTexSize=e.vec2().uniform(2)),this.iridescence&&(t.zIridescenceFactor=e.vec4().uniform(2)),this.drawContext.drawEnvLight&&(t.zGGXLut=e.tex2D().uniform(2)))}needSceneColor(){return this.transmission}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),this.needFragmentColor(e)&&(t.setValue("zF0",this._f0),t.setValue("zEmissiveFactor",this._emissiveFactor),this.occlusionTexture&&t.setValue("zOcclusionStrength",this._occlusionStrength),this.sheen&&t.setValue("zSheenFactor",this._sheenFactor),this.clearcoat&&t.setValue("zClearcoatFactor",this._clearcoatFactor),this.transmission&&(t.setValue("zTransmissionFactor",this._transmissionFactor),t.setValue("zThicknessFactor",this._thicknessFactor),t.setValue("zAttenuationColor",this._attenuationColor),t.setValue("zAttenuationDistance",this._attenuationDistance),t.setTexture("zSceneColorTex",e.sceneColorTexture),this._sceneColorTexSize.setXY(e.sceneColorTexture.width,e.sceneColorTexture.height),t.setValue("zSceneColorTexSize",this._sceneColorTexSize)),this.iridescence&&t.setValue("zIridescenceFactor",this._iridescenceFactor),e.drawEnvLight&&t.setTexture("zGGXLut",fo(1024)))}getF0(t){return t.zF0}getCommonDatasStruct(t){const e=t.$builder;return e.defineStruct([e.vec4("f0"),e.vec3("f90"),e.vec4("diffuse"),e.float("metallic"),e.float("roughness"),e.float("specularWeight"),...this.sheen?[e.float("sheenAlbedoScaling"),e.vec3("sheenColor"),e.float("sheenRoughness")]:[],...this.clearcoat?[e.vec4("ccFactor"),e.vec3("ccNormal"),e.float("ccNoV"),e.float("ccFresnel")]:[],...this.transmission?[e.float("transmissionFactor"),e.float("thicknessFactor"),e.vec3("attenuationColor"),e.float("attenuationDistance")]:[],...this.iridescence?[e.vec4("iridescenceFactor"),e.vec3("iridescenceFresnel"),e.vec3("iridescenceF0")]:[]])}getCommonData(t,e,i,s,r){const n=t.$builder,a=this,o="Z_getCommonData";return n.func(o,[n.vec4("albedo"),n.vec3("normal"),n.vec3("viewVec"),n.mat3("TBN")],(function(){this.$l.data=a.getCommonDatasStruct(this)(),a.calculateCommonData(this,this.albedo,this.normal,this.viewVec,this.TBN,this.data),this.$return(this.data)})),t.$g[o](e,i,s,r)}calculateCommonData(t,e,i,s,r,n){const a=t.$builder;if(this.sheen&&(this.sheenColorTexture?n.sheenColor=a.mul(this.sampleSheenColorTexture(t).rgb,t.zSheenFactor.rgb):n.sheenColor=t.zSheenFactor.rgb,this.sheenRoughnessTexture?n.sheenRoughness=a.mul(this.sampleSheenRoughnessTexture(t).a,t.zSheenFactor.a):n.sheenRoughness=t.zSheenFactor.a,t.$l.sheenDFG=.157,n.sheenAlbedoScaling=a.sub(1,a.mul(a.max(a.max(n.sheenColor.r,n.sheenColor.g),n.sheenColor.b),t.sheenDFG))),this.clearcoat){if(this.clearcoatNormalTexture){const e=a.mul(a.sub(a.mul(this.sampleClearcoatNormalTexture(t).rgb,2),a.vec3(1)),a.vec3(t.zClearcoatFactor.zz,1));n.ccNormal=a.normalize(a.mul(r,e))}else n.ccNormal=r[2];n.ccNoV=a.clamp(a.dot(n.ccNormal,s),1e-4,1),n.ccFactor=t.zClearcoatFactor,this.clearcoatIntensityTexture&&(n.ccFactor.x=a.mul(n.ccFactor.x,this.sampleClearcoatIntensityTexture(t).r)),this.clearcoatRoughnessTexture&&(n.ccFactor.y=a.clamp(a.mul(n.ccFactor.y,this.sampleClearcoatRoughnessTexture(t).g),0,1))}this.transmission&&(this.transmissionTexture?n.transmissionFactor=a.mul(this.sampleTransmissionTexture(t).r,t.zTransmissionFactor):n.transmissionFactor=t.zTransmissionFactor,this.thicknessTexture?n.thicknessFactor=a.mul(this.sampleThicknessTexture(t).g,t.zThicknessFactor):n.thicknessFactor=t.zThicknessFactor,n.attenuationColor=t.zAttenuationColor,n.attenuationDistance=t.zAttenuationDistance),this.iridescence&&(n.iridescenceFactor=t.zIridescenceFactor,this.iridescenceTexture&&(n.iridescenceFactor.x=a.mul(this.sampleIridescenceTexture(t).r,n.iridescenceFactor.x)),this.iridescenceThicknessTexture&&(n.iridescenceFactor.w=a.mix(n.iridescenceFactor.z,n.iridescenceFactor.w,this.sampleIridescenceThicknessTexture(t).g)),n.iridescenceFresnel=this.evalIridescence(t,1,n.iridescenceFactor.y,a.clamp(a.dot(i,s),0,1),n.iridescenceFactor.w,n.f0.rgb),n.iridescenceF0=this.schlickToF0(t,n.iridescenceFresnel,a.vec3(1),a.clamp(a.dot(i,s),0,1)))}calculateEmissiveColor(t){const e=t.$builder;return this.emissiveTexture?e.mul(this.sampleEmissiveTexture(t).rgb,t.zEmissiveFactor.rgb,t.zEmissiveFactor.a):e.mul(t.zEmissiveFactor.rgb,t.zEmissiveFactor.a)}D_Charlie(t,e,i){const s="Z_DCharlie",r=t.$builder;return r.func(s,[r.float("NdotH"),r.float("sheenRoughness")],(function(){this.$l.alphaG=r.mul(this.sheenRoughness,this.sheenRoughness),this.$l.invR=r.div(1,this.alphaG),this.$l.cos2h=r.mul(this.NdotH,this.NdotH),this.$l.sin2h=r.max(r.sub(1,this.cos2h),.0078125),this.$return(r.div(r.mul(r.add(this.invR,2),r.pow(this.sin2h,r.mul(this.invR,.5))),2*Math.PI))})),t.$g[s](e,i)}V_Ashikhmin(t,e,i){const s="Z_VAshikhmin",r=t.$builder;return r.func(s,[r.float("NdotL"),r.float("NdotV")],(function(){this.$return(r.clamp(r.div(1,r.mul(r.sub(r.add(this.NdotL,this.NdotV),r.mul(this.NdotL,this.NdotV)),4)),0,1))})),t.$g[s](e,i)}getVolumeTransmissionRay(t,e,i,s,r){const n=t.$builder,a="getVolumeTransmissionRay";return n.func(a,[n.vec3("normal"),n.vec3("viewVec"),n.float("thickness"),n.float("ior")],(function(){this.$l.refractionVector=n.refract(n.neg(this.viewVec),this.normal,n.div(1,this.ior)),this.$return(n.mul(this.refractionVector,this.$inputs.modelScale,this.thickness))})),n.getGlobalScope()[a](e,i,s,r)}getTransmissionSample(t,e,i,s){const r=t.$builder,n="getTransmissionSample";return r.func(n,[r.vec2("fragCoord"),r.float("roughness"),r.float("ior")],(function(){this.$l.applyIorToRoughness=r.mul(this.roughness,r.clamp(r.sub(r.mul(this.ior,2),2),0,1)),this.$l.framebufferLod=r.mul(r.log2(this.zSceneColorTexSize.x),this.applyIorToRoughness),this.$return(r.textureSampleLevel(this.zSceneColorTex,this.fragCoord,this.framebufferLod).rgb)})),r.getGlobalScope()[n](e,i,s)}getPunctualRadianceTransmission(t,e,i,s,r,n,a,o,h){const l=t.$builder,u=this,c="getPunctualRadianceTransmission";return l.func(c,[l.vec3("normal"),l.vec3("viewVec"),l.vec3("L"),l.float("alphaRoughness"),l.vec3("f0"),l.vec3("f90"),l.vec3("baseColor"),l.float("ior")],(function(){this.$l.transmissionRoughness=l.mul(this.alphaRoughness,l.clamp(l.sub(l.mul(this.ior,2),2),0,1)),this.$l.mirrorL=l.normalize(l.add(this.L,l.mul(this.normal,l.dot(l.neg(this.L),this.normal),2))),this.$l.h=l.normalize(l.add(this.viewVec,this.mirrorL)),this.$l.D=u.distributionGGX(this,l.clamp(l.dot(this.normal,this.h),0,1),this.transmissionRoughness),this.$l.F=u.fresnelSchlick(this,l.clamp(l.dot(this.viewVec,this.h),0,1),this.f0,this.f90),this.$l.V=u.visGGX(this,l.clamp(l.dot(this.normal,this.viewVec),0,1),l.clamp(l.dot(this.normal,this.mirrorL),0,1),this.transmissionRoughness),this.$return(l.mul(l.sub(l.vec3(1),this.F),this.baseColor,this.D,this.V))})),l.getGlobalScope()[c](e,i,s,r,n,a,o,h)}applyVolumeAttenuation(t,e,i,s,r){const n=t.$builder,a="applyVolumeAttenuation";return n.func(a,[n.vec3("radiance"),n.float("transmissionDistance"),n.vec3("attenuationColor"),n.float("attenuationDistance")],(function(){this.$if(n.equal(this.attenuationDistance,0),(function(){this.$return(this.radiance)})).$else((function(){this.$l.attenuationCoefficient=n.div(n.neg(n.log(this.attenuationColor)),this.attenuationDistance),this.$l.transmittance=n.exp(n.mul(n.neg(this.attenuationCoefficient),this.transmissionDistance)),this.$return(n.mul(this.radiance,this.transmittance))}))})),n.getGlobalScope()[a](e,i,s,r)}getIBLVolumnRefraction(t,e,i,s,r,n,a,o,h,l,u,c,d){const p=t.$builder,m="getIBLVolumeRefraction",f=this;return p.func(m,[p.vec2("brdf"),p.vec3("normal"),p.vec3("viewVec"),p.float("roughness"),p.vec3("baseColor"),p.vec3("f0"),p.vec3("f90"),p.vec3("position"),p.float("ior"),p.float("thickness"),p.vec3("attenuationColor"),p.float("attenuationDistance")],(function(){this.$l.transmissionRay=f.getVolumeTransmissionRay(this,this.normal,this.viewVec,this.thickness,this.ior),this.$l.transmissionRayLength=p.length(this.transmissionRay),this.$l.refractedRayExit=p.add(this.position,this.transmissionRay),this.$l.ndcPos=p.mul(Qa.getViewProjectionMatrix(this),p.vec4(this.refractedRayExit,1)),this.$l.refractionCoords=p.add(p.mul(p.div(this.ndcPos.xy,this.ndcPos.w),.5),p.vec2(.5)),this.$l.transmittedLight=f.getTransmissionSample(this,this.refractionCoords,this.roughness,this.ior),this.$l.attColor=f.applyVolumeAttenuation(this,this.transmittedLight,this.transmissionRayLength,this.attenuationColor,this.attenuationDistance),this.$l.specularColor=p.add(p.mul(this.f0,this.brdf.x),p.mul(this.f90,this.brdf.y)),this.$return(p.mul(p.sub(p.vec3(1),this.specularColor),this.attColor,this.baseColor))})),p.getGlobalScope()[m](e,i,s,r,n,a,o,h,l,u,c,d)}directLighting(t,e,i,s,r,n,a){const o=t.$builder,h=this,l="Z_PBRDirectLighting";o.func(l,[o.vec3("L"),o.vec3("lightColor"),o.vec3("normal"),o.vec3("viewVec"),h.getCommonDatasStruct(t)("data"),o.vec3("outColor").inout()],(function(){this.$l.H=o.normalize(o.add(this.viewVec,this.L)),this.$l.NoH=o.clamp(o.dot(this.normal,this.H),0,1),this.$l.NoL=o.clamp(o.dot(this.normal,this.L),0,1),this.$l.NoV=o.clamp(o.dot(this.normal,this.viewVec),0,1),this.$if(o.greaterThan(this.NoL,0),(function(){this.$l.VoH=o.clamp(o.dot(this.viewVec,this.H),0,1),this.$l.schlickFresnel=h.fresnelSchlick(this,this.VoH,this.data.f0.rgb,this.data.f90),h.iridescence?this.$l.F=o.mix(this.schlickFresnel,this.data.iridescenceFresnel,this.data.iridescenceFactor.x):this.$l.F=this.schlickFresnel,this.$l.alphaRoughness=o.mul(this.data.roughness,this.data.roughness),this.$l.D=h.distributionGGX(this,this.NoH,this.alphaRoughness),this.$l.V=h.visGGX(this,this.NoV,this.NoL,this.alphaRoughness),this.$l.specular=o.mul(this.lightColor,this.D,this.V,this.F,this.data.specularWeight),h.sheen&&(this.specular=o.mul(this.specular,this.data.sheenAlbedoScaling)),this.outColor=o.add(this.outColor,this.specular),h.iridescence&&(this.$l.iridescenceFresnelMax=o.vec3(o.max(o.max(this.data.iridescenceFresnel.r,this.data.iridescenceFresnel.g),this.data.iridescenceFresnel.b)),this.F=o.mix(this.schlickFresnel,this.iridescenceFresnelMax,this.data.iridescenceFactor.x)),this.$l.diffuseBRDF=o.mul(o.sub(o.vec3(1),o.mul(this.F,this.data.specularWeight)),o.div(this.data.diffuse.rgb,Math.PI)),this.$l.diffuse=o.mul(this.lightColor,o.max(this.diffuseBRDF,o.vec3(0))),h.transmission&&(this.$l.transmissionRay=h.getVolumeTransmissionRay(this,this.normal,this.viewVec,this.data.thicknessFactor,this.data.f0.a),this.$l.pointToLight=o.normalize(o.sub(this.L,this.transmissionRay)),this.$l.transmittedLight=o.mul(this.lightColor,h.getPunctualRadianceTransmission(this,this.normal,this.viewVec,this.pointToLight,this.alphaRoughness,this.data.f0.rgb,this.data.f90.rgb,this.data.diffuse.rgb,this.data.f0.a)),this.transmittedLight=h.applyVolumeAttenuation(this,this.transmittedLight,o.length(this.transmissionRay),this.data.attenuationColor,this.data.attenuationDistance),this.diffuse=o.mix(this.diffuse,this.transmittedLight,this.data.transmissionFactor)),h.sheen&&(this.diffuse=o.mul(this.diffuse,this.data.sheenAlbedoScaling)),this.outColor=o.add(this.outColor,this.diffuse),h.sheen&&(this.$l.sheenD=h.D_Charlie(this,this.NoH,this.data.sheenRoughness),this.$l.sheenV=h.V_Ashikhmin(this,this.NoL,this.NoV),this.outColor=o.add(this.outColor,o.mul(this.lightColor,this.data.sheenColor,this.sheenD,this.sheenV))),h.clearcoat&&(this.alphaRoughness=o.mul(this.data.ccFactor.y,this.data.ccFactor.y),this.NoH=o.clamp(o.dot(this.data.ccNormal,this.H),0,1),this.NoL=o.clamp(o.dot(this.data.ccNormal,this.L),0,1),this.ccF0=o.vec3(o.pow(o.div(o.sub(this.data.f0.a,1),o.add(this.data.f0.a,1)),2)),this.F=h.fresnelSchlick(this,this.VoH,this.ccF0,o.vec3(1)),this.D=h.distributionGGX(this,this.NoH,this.alphaRoughness),this.V=h.visGGX(this,this.data.ccNoV,this.NoL,this.alphaRoughness),this.outColor=o.add(this.outColor,o.mul(this.D,this.V,this.F,this.data.ccFactor.x)))}))})),t.$g[l](e,i,s,r,n,a)}fresnel0ToIor(t,e){const i=t.$builder,s="Z_fresnel0ToIor";return i.func(s,[i.vec3("fresnel0")],(function(){this.$l.sqrtF0=i.sqrt(this.fresnel0),this.$return(i.div(i.add(this.sqrtF0,i.vec3(1)),i.sub(i.vec3(1),this.sqrtF0)))})),i.getGlobalScope()[s](e)}iorToFresnel0v(t,e,i){const s=t.$builder,r="Z_iorToFresnel0v";return s.func(r,[s.vec3("transmittedIor"),s.float("incidentIor")],(function(){this.$l.t=s.div(s.sub(this.transmittedIor,s.vec3(this.incidentIor)),s.add(this.transmittedIor,s.vec3(this.incidentIor))),this.$return(s.mul(this.t,this.t))})),s.getGlobalScope()[r](e,i)}iorToFresnel0(t,e,i){const s=t.$builder,r="Z_iorToFresnel0";return s.func(r,[s.float("transmittedIor"),s.float("incidentIor")],(function(){this.$l.t=s.div(s.sub(this.transmittedIor,this.incidentIor),s.add(this.transmittedIor,this.incidentIor)),this.$return(s.mul(this.t,this.t))})),s.getGlobalScope()[r](e,i)}evalSensitivity(t,e,i){const s=t.$builder,r="Z_evalSensitivity";return s.func(r,[s.float("OPD"),s.vec3("shift")],(function(){this.$l.phase=s.mul(2*Math.PI,this.OPD,1e-9),this.$l.val=s.vec3(54856e-17,44201e-17,52481e-17),this.$l.pos=s.vec3(1681e3,1795300,2208400),this.$l.va=s.vec3(43278e5,93046e5,66121e5),this.$l.xyz=s.mul(this.val,s.sqrt(s.mul(2*Math.PI,this.va)),s.cos(s.add(s.mul(this.pos,this.phase),this.shift)),s.exp(s.neg(s.mul(this.phase,this.phase,this.va)))),this.xyz.x=s.add(this.xyz.x,s.mul(9747e-17,Math.sqrt(2*Math.PI*45282e5),s.cos(s.add(s.mul(this.phase,2239900),this.shift.x)),s.exp(s.mul(-45282e5,this.phase,this.phase)))),this.xyz=s.div(this.xyz,1.0685e-7),this.$return(s.mul(s.mat3(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),this.xyz))})),s.getGlobalScope()[r](e,i)}schlickToF0(t,e,i,s){const r=t.$builder,n="Z_schlickToF0";return r.func(n,[r.vec3("f"),r.vec3("f90"),r.float("VdotH")],(function(){this.$l.x=r.clamp(r.sub(1,this.VdotH),0,1),this.$l.x2=r.mul(this.x,this.x),this.$l.x5=r.clamp(r.mul(this.x,this.x2,this.x2),0,.9999),this.$return(r.div(r.sub(this.f,r.mul(this.f90,this.x5)),r.sub(1,this.x5)))})),r.getGlobalScope()[n](e,i,s)}evalIridescence(t,e,i,s,r,n){const a=t.$builder,o=this,h="Z_evalIridescence";return a.func(h,[a.float("outsideIOR"),a.float("eta2"),a.float("cosTheta1"),a.float("thinFilmThickness"),a.vec3("baseF0")],(function(){this.$l.iridescenceIor=a.mix(this.outsideIOR,this.eta2,a.smoothStep(0,.03,this.thinFilmThickness)),this.$l.t=a.div(this.outsideIOR,this.iridescenceIor),this.$l.sinTheta2Sq=a.mul(this.t,this.t,a.sub(1,a.mul(this.cosTheta1,this.cosTheta1))),this.$l.cosTheta2Sq=a.sub(1,this.sinTheta2Sq),this.$if(a.lessThan(this.cosTheta2Sq,0),(function(){this.$return(a.vec3(1))})),this.$l.cosTheta2=a.sqrt(this.cosTheta2Sq),this.$l.R0=o.iorToFresnel0(this,this.iridescenceIor,this.outsideIOR),this.$l.R12=o.fresnelSchlick(this,this.cosTheta1,a.vec3(this.R0),a.vec3(1)).x,this.$l.R21=this.R12,this.$l.T121=a.sub(1,this.R12),this.$l.phi12=a.float(0),this.$if(a.lessThan(this.iridescenceIor,this.outsideIOR),(function(){this.phi12=Math.PI})),this.$l.phi21=a.sub(Math.PI,this.phi12),this.$l.baseIOR=o.fresnel0ToIor(this,a.clamp(this.baseF0,a.vec3(0),a.vec3(.9999))),this.$l.R1=o.iorToFresnel0v(this,this.baseIOR,this.iridescenceIor),this.$l.R23=o.fresnelSchlick(this,this.cosTheta2,this.R1,a.vec3(1)),this.$l.phi23=a.vec3(0),this.$if(a.lessThan(this.baseIOR.x,this.iridescenceIor),(function(){this.phi23.x=Math.PI})),this.$if(a.lessThan(this.baseIOR.y,this.iridescenceIor),(function(){this.phi23.y=Math.PI})),this.$if(a.lessThan(this.baseIOR.z,this.iridescenceIor),(function(){this.phi23.z=Math.PI})),this.$l.OPD=a.mul(this.iridescenceIor,this.thinFilmThickness,this.cosTheta2,2),this.$l.phi=a.add(a.vec3(this.phi21),this.phi23),this.$l.R123=a.clamp(a.mul(this.R12,this.R23),a.vec3(1e-5),a.vec3(.9999)),this.$l.r123=a.sqrt(this.R123),this.$l.Rs=a.div(a.mul(this.T121,this.T121,this.R23),a.sub(a.vec3(1),this.R123)),this.$l.C0=a.add(a.vec3(this.R12),this.Rs),this.$l.I=this.C0,this.$l.Cm=a.sub(this.Rs,a.vec3(this.T121)),this.$for(a.int("m"),1,3,(function(){this.Cm=a.mul(this.Cm,this.r123),this.$l.Sm=a.mul(o.evalSensitivity(this,a.mul(this.OPD,a.float(this.m)),a.mul(this.phi,a.float(this.m))),2),this.I=a.add(this.I,a.mul(this.Cm,this.Sm))})),this.$return(a.max(this.I,a.vec3(0)))})),a.getGlobalScope()[h](e,i,s,r,n)}indirectLighting(t,e,i,s,r){const n=t.$builder,a=this,o=a.drawContext,h="Z_PBRIndirectLighting";n.func(h,[n.vec3("normal"),n.vec3("viewVec"),a.getCommonDatasStruct(t)("data"),n.vec3("outColor").inout()],(function(){if(!o.drawEnvLight||!o.env.light.envLight.hasRadiance()&&!o.env.light.envLight.hasIrradiance())return;const t=Qa.getEnvLightStrength(this);if(a.occlusionTexture){const e=a.sampleOcclusionTexture(this).r;this.$l.occlusion=n.mul(n.add(n.mul(this.zOcclusionStrength,n.sub(e,1)),1),t)}else this.$l.occlusion=t;this.$l.NoV=n.clamp(n.dot(this.normal,this.viewVec),1e-4,1),this.$l.ggxLutSample=n.clamp(n.textureSampleLevel(this.zGGXLut,n.clamp(n.vec2(this.NoV,this.data.roughness),n.vec2(0),n.vec2(1)),0),n.vec4(0),n.vec4(1)),this.$l.f_ab=this.ggxLutSample.rg,this.$l.Fr=n.sub(n.max(n.vec3(n.sub(1,this.data.roughness)),this.data.f0.rgb),this.data.f0.rgb),a.iridescence?this.$l.k_S=n.mix(n.add(this.data.f0.rgb,n.mul(this.Fr,n.pow(n.sub(1,this.NoV),5))),this.data.iridescenceFresnel,this.data.iridescenceFactor.x):this.$l.k_S=n.add(this.data.f0.rgb,n.mul(this.Fr,n.pow(n.sub(1,this.NoV),5))),o.env.light.envLight.hasRadiance()&&(this.$l.radiance=o.env.light.envLight.getRadiance(this,n.reflect(n.neg(this.viewVec),this.normal),this.data.roughness),this.$l.FssEss=n.add(n.mul(this.k_S,this.f_ab.x),n.vec3(this.f_ab.y)),this.$l.iblSpecular=n.mul(this.radiance,this.FssEss,this.data.specularWeight,this.occlusion),a.sheen&&(this.iblSpecular=n.mul(this.iblSpecular,this.data.sheenAlbedoScaling)),this.outColor=n.add(this.outColor,this.iblSpecular)),o.env.light.envLight.hasIrradiance()&&(this.$l.irradiance=o.env.light.envLight.getIrradiance(this,this.normal),a.iridescence?(this.$l.iridescenceF0Max=n.vec3(n.max(n.max(this.data.iridescenceF0.r,this.data.iridescenceF0.g),this.data.iridescenceF0.b)),this.$l.mixedF0=n.mix(this.data.f0.rgb,this.iridescenceF0Max,this.data.iridescenceFactor.x),this.Fr=n.sub(n.max(n.vec3(n.sub(1,this.data.roughness)),this.mixedF0),this.mixedF0),this.k_S=n.add(this.mixedF0,n.mul(this.Fr,n.pow(n.sub(1,this.NoV),5)))):this.$l.mixedF0=this.data.f0.rgb,this.$l.FssEss=n.add(n.mul(this.k_S,this.f_ab.x,this.data.specularWeight),n.vec3(this.f_ab.y)),this.$l.Ems=n.sub(1,n.add(this.f_ab.x,this.f_ab.y)),this.$l.F_avg=n.mul(n.add(this.mixedF0,n.div(n.sub(n.vec3(1),this.mixedF0),21)),this.data.specularWeight),this.$l.FmsEms=n.div(n.mul(this.FssEss,this.F_avg,this.Ems),n.sub(n.vec3(1),n.mul(this.F_avg,this.Ems))),this.$l.k_D=n.mul(this.data.diffuse.rgb,n.add(n.sub(n.vec3(1),this.FssEss),this.FmsEms)),this.$l.iblDiffuse=n.mul(n.add(this.FmsEms,this.k_D),this.irradiance,this.occlusion),a.sheen&&(this.iblDiffuse=n.mul(this.iblDiffuse,this.data.sheenAlbedoScaling)),a.transmission&&(this.$l.iblTransmission=a.getIBLVolumnRefraction(this,this.ggxLutSample.rg,this.normal,this.viewVec,this.data.roughness,this.data.diffuse.rgb,this.data.f0.rgb,this.data.f90,this.$inputs.worldPos,this.data.f0.a,this.data.thicknessFactor,this.data.attenuationColor,this.data.attenuationDistance),this.iblDiffuse=n.mix(this.iblDiffuse,this.iblTransmission,this.data.transmissionFactor)),this.outColor=n.add(this.outColor,this.iblDiffuse)),a.sheen&&o.env.light.envLight.hasIrradiance()&&(this.$l.refl=n.reflect(n.neg(this.viewVec),this.normal),this.$l.sheenBRDF=n.clamp(n.textureSampleLevel(this.zGGXLut,n.clamp(n.vec2(this.NoV,this.data.sheenRoughness),n.vec2(0),n.vec2(1)),0),n.vec4(0),n.vec4(1)).b,this.outColor=n.add(this.outColor,n.mul(this.data.sheenColor,this.irradiance.rgb,this.sheenBRDF))),a.clearcoat&&o.env.light.envLight.hasRadiance()&&(this.$l.NoV=n.clamp(n.dot(this.data.ccNormal,this.viewVec),1e-4,1),this.$l.ggxLutSample=n.clamp(n.textureSampleLevel(this.zGGXLut,n.clamp(n.vec2(this.NoV,this.data.ccFactor.y),n.vec2(0),n.vec2(1)),0),n.vec4(0),n.vec4(1)),this.$l.f_ab=this.ggxLutSample.rg,this.$l.Fr=n.sub(n.max(n.vec3(n.sub(1,this.data.ccFactor.y)),this.data.f0.rgb),this.data.f0.rgb),this.$l.k_S=n.add(this.data.f0.rgb,n.mul(this.Fr,n.pow(n.sub(1,this.NoV),5))),this.$l.radiance=o.env.light.envLight.getRadiance(this,n.reflect(n.neg(this.viewVec),this.data.ccNormal),this.data.ccFactor.y),this.$l.FssEss=n.add(n.mul(this.k_S,this.f_ab.x),n.vec3(this.f_ab.y)),this.$l.ccSpecular=n.mul(this.radiance,this.FssEss,this.data.specularWeight,this.occlusion),this.outColor=n.add(this.outColor,n.mul(this.ccSpecular,this.data.ccFactor.x)))})),t.$g[h](e,i,s,r)}fresnelSchlick(t,e,i,s){const r=t.$builder,n="Z_fresnelSchlick";return r.func(n,[r.float("cosTheta"),r.vec3("f0"),r.vec3("f90")],(function(){this.$return(r.add(this.f0,r.mul(r.sub(this.f90,this.f0),r.pow(r.clamp(r.sub(1,this.cosTheta),0,1),5))))})),t.$g[n](e,i,s)}distributionGGX(t,e,i){const s=t.$builder,r="Z_distributionGGX";return s.func(r,[s.float("NdotH"),s.float("roughness")],(function(){this.$l.a2=s.mul(this.roughness,this.roughness),this.$l.NdotH2=s.mul(this.NdotH,this.NdotH),this.$l.num=this.a2,this.$l.denom=s.add(s.mul(this.NdotH2,s.sub(this.a2,1)),1),this.denom=s.mul(s.mul(3.14159265,this.denom),this.denom),this.$return(s.div(this.num,this.denom))})),t.$g[r](e,i)}visGGX(t,e,i,s){const r=t.$builder,n="Z_visGGX";return r.func(n,[r.float("NdotV"),r.float("NdotL"),r.float("roughness")],(function(){this.$l.a=this.roughness,this.$l.ggxV=r.mul(this.NdotL,r.sqrt(r.add(r.mul(this.NdotV,this.NdotV,r.sub(1,this.a)),this.a))),this.$l.ggxL=r.mul(this.NdotV,r.sqrt(r.add(r.mul(this.NdotL,this.NdotL,r.sub(1,this.a)),this.a))),this.$l.ggx=r.add(this.ggxV,this.ggxL,1e-5),this.$if(r.greaterThan(this.ggx,0),(function(){this.$return(r.div(.5,this.ggx))})).$else((function(){this.$return(r.float(0))}))})),t.$g[n](e,i,s)}};return i=a.defineFeature(),s=a.defineFeature(),r=a.defineFeature(),n=a.defineFeature(),a}function go(t){if(t.pbrMetallicRoughnessMixed)return t;const e=to(t,_o,oo,no("metallicRoughness"),no("occlusion"),no("specular"),no("specularColor"));return class extends e{static pbrMetallicRoughnessMixed=!0;_metallic;_roughness;_specularFactor;constructor(){super(),this._metallic=1,this._roughness=1,this._specularFactor=T.one()}get metallic(){return this._metallic}set metallic(t){t!==this._metallic&&(this._metallic=t,this.uniformChanged())}get roughness(){return this._roughness}set roughness(t){t!==this._roughness&&(this._roughness=t,this.uniformChanged())}get specularFactor(){return this._specularFactor}set specularFactor(t){t.equalsTo(this._specularFactor)||(this._specularFactor.set(t),this.uniformChanged())}PBRLight(t,e,i,s,r,n){const a=t.$builder,o="Z_PBRMetallicRoughnessLight",h=this;return a.func(o,[a.vec3("worldPos"),a.vec3("normal"),a.mat3("TBN"),a.vec3("viewVec"),a.vec4("albedo")],(function(){this.$l.pbrData=h.getCommonData(this,this.albedo,this.normal,this.viewVec,this.TBN),this.$l.lightingColor=a.vec3(0),this.$l.emissiveColor=h.calculateEmissiveColor(this),h.indirectLighting(this,this.normal,this.viewVec,this.pbrData,this.lightingColor),h.forEachLight(this,(function(t,e,i,s,r){this.$l.diffuse=a.vec3(),this.$l.specular=a.vec3(),this.$l.lightAtten=h.calculateLightAttenuation(this,t,this.worldPos,e,i),this.$l.lightDir=h.calculateLightDirection(this,t,this.worldPos,e,i),this.$l.NoL=a.clamp(a.dot(this.normal,this.lightDir),0,1),this.$l.lightColor=a.mul(s.rgb,s.a,this.lightAtten,this.NoL),r&&(this.lightColor=a.mul(this.lightColor,h.calculateShadow(this,this.worldPos,this.NoL))),h.directLighting(this,this.lightDir,this.lightColor,this.normal,this.viewVec,this.pbrData,this.lightingColor)})),this.$return(a.add(this.lightingColor,this.emissiveColor))})),a.getGlobalScope()[o](e,i,n,s,r)}fragmentShader(t){if(super.fragmentShader(t),this.needFragmentColor()){const e=t.$builder;t.zMetallic=e.float().uniform(2),t.zRoughness=e.float().uniform(2),t.zSpecularFactor=e.vec4().uniform(2)}}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),this.needFragmentColor(e)&&(t.setValue("zMetallic",this._metallic),t.setValue("zRoughness",this._roughness),t.setValue("zSpecularFactor",this._specularFactor))}calculateCommonData(t,e,i,s,r,n){const a=t.$builder;this.metallicRoughnessTexture?(t.$l.metallicRoughnessSample=this.sampleMetallicRoughnessTexture(t),n.metallic=a.mul(t.zMetallic,t.metallicRoughnessSample.z),n.roughness=a.mul(t.zRoughness,t.metallicRoughnessSample.y)):(n.metallic=t.zMetallic,n.roughness=t.zRoughness),this.specularColorTexture?t.$l.specularColor=a.mul(t.zSpecularFactor.rgb,this.sampleSpecularColorTexture(t).rgb):t.$l.specularColor=t.zSpecularFactor.rgb,this.specularTexture?n.specularWeight=a.mul(t.zSpecularFactor.a,this.sampleSpecularTexture(t).a):n.specularWeight=t.zSpecularFactor.a,n.f0=a.vec4(a.mix(a.min(a.mul(this.getF0(t).rgb,t.specularColor),a.vec3(1)),e.rgb,n.metallic),this.getF0(t).a),n.f90=a.vec3(1),n.diffuse=a.vec4(a.mix(e.rgb,a.vec3(0),n.metallic),e.a),super.calculateCommonData(t,e,i,s,r,n)}}}function xo(t){return t.foliageMixed?t:class extends t{static foliageMixed=!0;constructor(...t){super(...t),this.cullMode="none"}calculateFoliageAlbedo(t,e,i){const s=t.$builder,r=this,n="Z_CalcFoliageMipLevel";s.func(n,[s.vec2("coord")],(function(){this.$l.dx=s.dpdx(this.coord),this.$l.dy=s.dpdy(this.coord),this.$l.deltaMaxSqr=s.max(s.dot(this.dx,this.dx),s.dot(this.dy,this.dy)),this.$return(s.max(0,s.mul(s.log2(this.deltaMaxSqr),.5)))}));const a="Z_calcFoliageAlbedo";return s.func(a,[s.vec4("albedo"),s.vec2("coord")],(function(){this.$l.a=s.mul(this.albedo.a,s.add(1,s.mul(s.max(0,t[n](this.coord)),.25))),r.alphaToCoverage&&(this.a=s.add(s.div(s.sub(this.a,.4),s.max(s.fwidth(this.albedo.a),1e-4)),.5)),this.$return(s.vec4(this.albedo.rgb,this.a))})),s.getGlobalScope()[a](e,i)}}}class bo extends(to(ro,go,xo)){_terrainSize;_terrainNormalMap;_textureSize;constructor(t,e,i){super(),this.metallic=0,this.roughness=1,this.specularFactor=new T(1,1,1,.2),this.doubleSidedLighting=!1,this._terrainSize=t,this._terrainNormalMap=e,this._textureSize=x.one(),i&&(this.albedoTexture=i,this._textureSize.setXY(i.width,i.height))}isTransparentPass(t){return!1}supportLighting(){return!0}supportInstancing(){return!1}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),t.setTexture("terrainNormalMap",this._terrainNormalMap),t.setValue("terrainSize",this._terrainSize),this.needFragmentColor(e)&&t.setValue("albedoTextureSize",this._textureSize)}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$inputs.pos=e.vec3().attrib("position"),t.$inputs.placement=e.vec4().attrib("texCoord1"),t.terrainNormalMap=e.tex2D().uniform(2),t.terrainSize=e.vec2().uniform(2);const i=e.textureSampleLevel(t.terrainNormalMap,e.div(t.$inputs.placement.xz,t.terrainSize),0).rgb;t.$l.normal=e.normalize(e.sub(e.mul(i,2),e.vec3(1))),t.$l.axisX=e.vec3(1,0,0),t.$l.axisZ=e.cross(t.axisX,t.normal),t.$l.axisX=e.cross(t.normal,t.axisZ),t.$l.rotPos=e.mul(e.mat3(t.axisX,t.normal,t.axisZ),t.$inputs.pos),t.$outputs.worldPos=e.mul(Qa.getWorldMatrix(t),e.vec4(e.add(t.rotPos,t.$inputs.placement.xyz),1)).xyz,Qa.setClipSpacePosition(t,e.mul(Qa.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),t.$outputs.worldNorm=e.mul(Qa.getNormalMatrix(t),e.vec4(t.normal,0)).xyz}fragmentShader(t){super.fragmentShader(t);const e=t.$builder,i=this;this.needFragmentColor()?(t.albedoTextureSize=e.vec2().uniform(2),t.$l.albedo=this.calculateAlbedoColor(t),t.albedo=i.calculateFoliageAlbedo(t,t.albedo,e.mul(i.getAlbedoTexCoord(t),t.albedoTextureSize)),t.$l.litColor=e.vec3(0),this.drawContext.renderPass.type===Ra&&(t.$l.normalInfo=this.calculateNormalAndTBN(t,t.$inputs.worldPos,t.$inputs.worldNorm),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN)),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a))):this.outputFragmentColor(t,t.$inputs.worldPos,null)}apply(t){return this.alphaToCoverage=t.device.getFrameBufferSampleCount()>1,this.alphaCutoff=this.alphaToCoverage?1:.8,super.apply(t)}updateRenderStates(t,e,i){super.updateRenderStates(t,e,i),e.useRasterizerState().setCullMode("none")}}let wo=null,To=null;function vo(t){const e=q.instance.device;wo||(wo=e.createVertexLayout({vertexBuffers:[{buffer:e.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]})),To||(To=e.createRenderStateSet(),To.useRasterizerState().setCullMode("none"),To.useDepthState().enableTest(!1).enableWrite(!1));const i=e.getRenderStates();e.setRenderStates(t??To),e.setVertexLayout(wo),e.draw("triangle-strip",0,4),e.setRenderStates(i)}class yo extends(to(ro,oo,go)){static _metallicRoughnessGenerationProgram=null;static _metallicRoughnessGenerationBindGroup=null;_options;_uvScales;_numDetailMaps;_terrainInfo;constructor(t){if(super(),this.normalMapMode="object-space",this._options=null,this._numDetailMaps=0,this._uvScales=null,this._terrainInfo=null,t&&t.splatMap&&t.detailMaps&&t.detailMaps.albedoTextures){this._options=Object.assign({},t);const e=this._options.detailMaps.albedoTextures;if(this._numDetailMaps=Array.isArray(e)?e.length:e.depth,!this._numDetailMaps)throw new Error("TerrainMaterial(): Invalid detail textures");if(this._numDetailMaps>4)throw new Error("TerrainMaterial(): The maximum detail levels is 4");if(!this._options.detailMaps.uvScale||this._options.detailMaps.uvScale.length!==this._numDetailMaps)throw new Error("TerrainMaterial(): Invalid uv scale");this._uvScales=new Float32Array(4*this._numDetailMaps);for(let t=0;t<this._numDetailMaps;t++)this._uvScales[4*t]=this._options.detailMaps.uvScale[t],this._uvScales[4*t+1]=1,this._uvScales[4*t+2]=.01,this._uvScales[4*t+3]=.99;if(this._options.detailMaps.metallic){if(this._options.detailMaps.metallic.length!==this._numDetailMaps)throw new Error("TerrainMaterial(): Invalid metallic values");for(let t=0;t<this._numDetailMaps;t++)this._uvScales[4*t+2]=this._options.detailMaps.metallic[t]}if(this._options.detailMaps.roughness){if(this._options.detailMaps.roughness.length!==this._numDetailMaps)throw new Error("TerrainMaterial(): Invalid roughness values");for(let t=0;t<this._numDetailMaps;t++)this._uvScales[4*t+3]=this._options.detailMaps.roughness[t]}const i=t.detailMaps.normalTextures;if(i){if((Array.isArray(i)?i.length:i.depth)!==this._numDetailMaps)throw new Error("TerrainMaterial(): The number of normal textures not match the number of albedo textures");if(t.detailMaps.normalScale){if(t.detailMaps.normalScale.length!==this._numDetailMaps)throw new Error("TerrainMaterial(): Invalid normal scale");for(let e=0;e<this._numDetailMaps;e++)this._uvScales[4*e+1]=t.detailMaps.normalScale[e]}}if(this._options=Object.assign({},t),Array.isArray(e))for(let t=0;t<e.length;t++){if(!e[t])throw new Error("TerrainMaterial(): Invalid detail albedo texture");e[t].samplerOptions={addressU:"repeat",addressV:"repeat"}}else e.samplerOptions={addressU:"repeat",addressV:"repeat"};if(Array.isArray(i))for(let t=0;t<i.length;t++){if(!i[t])throw new Error("TerrainMaterial(): Invalid detail normal texture");i[t].samplerOptions={addressU:"repeat",addressV:"repeat"}}else i&&(i.samplerOptions={addressU:"repeat",addressV:"repeat"})}this.metallicRoughnessTexture=this.generateMetallicRoughnessMap(),this.metallicRoughnessTexCoordIndex=-1,this.albedoTexCoordIndex=-1,this.normalTexCoordIndex=-1}get terrainInfo(){return this._terrainInfo}set terrainInfo(t){this._terrainInfo=t,this.uniformChanged()}isTransparentPass(t){return!1}supportLighting(){return!0}supportInstancing(){return!1}isBatchable(){return!1}applyUniformValues(t,e,i){if(super.applyUniformValues(t,e,i),this.needFragmentColor(e)&&(t.setValue("terrainInfo",this._terrainInfo),this._options)){if(t.setValue("detailScales",this._uvScales),t.setTexture("splatMap",this._options.splatMap),Array.isArray(this._options.detailMaps.albedoTextures))for(let e=0;e<this._numDetailMaps;e++)t.setTexture(`detailAlbedoMap${e}`,this._options.detailMaps.albedoTextures[e]);else t.setTexture("detailAlbedoMap",this._options.detailMaps.albedoTextures);if(Array.isArray(this._options.detailMaps.normalTextures))for(let e=0;e<this._numDetailMaps;e++)t.setTexture(`detailNormalMap${e}`,this._options.detailMaps.normalTextures[e]);else t.setTexture("detailNormalMap",this._options.detailMaps.normalTextures)}}getMetallicRoughnessTexCoord(t){return t.$inputs.mapUV}getNormalTexCoord(t){return t.$inputs.mapUV}getAlbedoTexCoord(t){return t.$inputs.mapUV}calculateAlbedoColor(t){if(!this._options)return super.calculateAlbedoColor(t);const e=this,i=t.$builder,s="getTerrainAlbedo";return i.func(s,[],(function(){this.$l.mask=i.textureSample(this.splatMap,this.$inputs.mapUV),this.$l.color=i.vec3(0);const t=!Array.isArray(e._options.detailMaps.albedoTextures);for(let s=0;s<e._numDetailMaps;s++){const e=i.mul(this.$inputs.mapUV,this.detailScales.at(s).x),r=t?i.textureArraySample(this.detailAlbedoMap,e,s).rgb:i.textureSample(this[`detailAlbedoMap${s}`],e).rgb;this.color=i.add(this.color,i.mul(r,this.mask[s]))}this.$return(i.vec4(this.color,1))})),i.getGlobalScope()[s]()}sampleDetailNormalMap(t,e,i,s,r){const n=t.$builder,a=n.sub(n.mul(n.textureSample(e,i).rgb,2),n.vec3(1)),o=n.mul(a,n.vec3(n.vec3(s).xx,1));return n.normalize(n.mul(r,o))}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$l.oPos=Qa.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(Qa.getWorldMatrix(t),e.vec4(t.oPos,1)).xyz,Qa.setClipSpacePosition(t,e.mul(Qa.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),this.needFragmentColor()&&(t.terrainInfo=e.vec4().uniform(2),t.$l.oNorm=Qa.resolveVertexNormal(t),t.$outputs.worldNorm=e.mul(Qa.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz,t.$outputs.mapUV=e.div(t.oPos.xz,t.terrainInfo.xy))}fragmentShader(t){super.fragmentShader(t);const e=t.$builder,i=this;if(this.needFragmentColor()){if(this._options){t.detailScales=e.vec4[this._numDetailMaps]().uniform(2),t.splatMap=e.tex2D().uniform(2);if(!Array.isArray(i._options.detailMaps.albedoTextures))t.detailAlbedoMap=e.tex2DArray().uniform(2);else for(let s=0;s<i._numDetailMaps;s++)t[`detailAlbedoMap${s}`]=e.tex2D().uniform(2);if(!Array.isArray(i._options.detailMaps.normalTextures))t.detailNormalMap=e.tex2DArray().uniform(2);else for(let s=0;s<i._numDetailMaps;s++)t[`detailNormalMap${s}`]=e.tex2D().uniform(2)}t.$l.albedo=this.calculateAlbedoColor(t),t.$l.normalInfo=this.calculateNormalAndTBN(t,t.$inputs.worldPos,t.$inputs.worldNorm);let s=!1;if(this._options&&this._options.detailMaps.normalTextures)if(t.$l.detailMask=e.textureSample(t.splatMap,t.$inputs.mapUV),Array.isArray(this._options.detailMaps.normalTextures))for(let i=0;i<this._options.detailMaps.normalTextures.length;i++){const r=t[`detailNormalMap${i}`],n=t.detailScales.at(i).y,a=e.mul(t.$inputs.mapUV,t.detailScales.at(i).x);t.normalInfo.normal=e.add(t.normalInfo.normal,e.mul(this.sampleDetailNormalMap(t,r,a,n,t.normalInfo.TBN),t.detailMask[i])),s=!0}else{const i=t.detailNormalMap;for(let r=0;r<this._numDetailMaps;r++){const n=t.detailScales.at(r).y,a=e.mul(t.$inputs.mapUV,t.detailScales.at(r).x),o=e.sub(e.mul(e.textureArraySample(i,a,r).rgb,2),e.vec3(1)),h=e.mul(o,e.vec3(e.vec3(n).xx,1)),l=e.normalize(e.mul(t.normalInfo.TBN,h));t.normalInfo.normal=e.add(t.normalInfo.normal,e.mul(l,t.detailMask[r])),s=!0}}s&&(t.normalInfo.normal=e.normalize(t.normalInfo.normal)),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a))}else this.outputFragmentColor(t,t.$inputs.worldPos,null)}generateMetallicRoughnessMap(){const t=q.instance.device;if(!this._options){const e=t.createTexture2D("rgba8unorm",1,1,{samplerOptions:{mipFilter:"none"}});return e.update(new Uint8Array([0,1,0,0]),0,0,1,1),e.name="TerrainMetallicRoughnessMap",e}yo._metallicRoughnessGenerationProgram||(yo._metallicRoughnessGenerationProgram=t.buildRenderProgram({vertex(e){this.$inputs.pos=e.vec2().attrib("position"),this.$outputs.uv=e.vec2(),e.main((function(){this.$builtins.position=e.vec4(this.$inputs.pos,0,1),this.$outputs.uv=e.add(e.mul(this.$inputs.pos.xy,.5),e.vec2(.5)),"webgpu"===t.type&&(this.$builtins.position.y=e.neg(this.$builtins.position.y))}))},fragment(t){this.$outputs.outColor=t.vec4(),this.roughness=t.vec4().uniform(0),this.metallic=t.vec4().uniform(0),this.splatMap=t.tex2D().uniform(0),t.main((function(){this.weights=t.textureSample(this.splatMap,this.$inputs.uv),this.roughnessValue=t.dot(this.weights,this.roughness),this.metallicValue=t.dot(this.weights,this.metallic),this.$outputs.outColor=t.vec4(0,this.roughnessValue,this.metallicValue,1)}))}}),yo._metallicRoughnessGenerationBindGroup=t.createBindGroup(yo._metallicRoughnessGenerationProgram.bindGroupLayouts[0]));const e=T.one(),i=T.zero();for(let t=0;t<this._numDetailMaps;t++)i[t]=this._uvScales[4*t+2],e[t]=this._uvScales[4*t+3];const s=t.createTexture2D("rgba8unorm",this._options.splatMap.width,this._options.splatMap.height);s.name="TerrainMetallicRoughnessMap";const r=yo._metallicRoughnessGenerationProgram,n=yo._metallicRoughnessGenerationBindGroup;n.setValue("roughness",e),n.setValue("metallic",i),n.setTexture("splatMap",this._options.splatMap);const a=t.createFrameBuffer([s],null);return t.pushDeviceStates(),t.setFramebuffer(a),t.setProgram(r),t.setBindGroup(0,n),vo(),t.popDeviceStates(),a.dispose(),s}updateRenderStates(t,e,i){super.updateRenderStates(t,e,i);1===i.renderPass.type?e.useRasterizerState().setCullMode("front"):e.defaultRasterizerState()}}class Eo extends(to(ro,go,ho)){static FEATURE_VERTEX_NORMAL=this.defineFeature();static FEATURE_VERTEX_TANGENT=this.defineFeature();constructor(){super(),this.useFeature(Eo.FEATURE_VERTEX_NORMAL,!0)}get vertexNormal(){return this.featureUsed(Eo.FEATURE_VERTEX_NORMAL)}set vertexNormal(t){this.useFeature(Eo.FEATURE_VERTEX_NORMAL,!!t)}get vertexTangent(){return this.featureUsed(Eo.FEATURE_VERTEX_TANGENT)}set vertexTangent(t){this.useFeature(Eo.FEATURE_VERTEX_TANGENT,!!t)}vertexShader(t){super.vertexShader(t);const e=t.$builder,i=Qa.getWorldMatrix(t);t.$l.oPos=Qa.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(i,e.vec4(t.oPos,1)).xyz,t.$l.csPos=e.mul(Qa.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1)),Qa.setClipSpacePosition(t,t.csPos),this.transmission&&(t.$outputs.screenUV=e.add(e.mul(e.div(t.csPos.xy,t.csPos.w),.5),e.vec2(.5)),t.$outputs.modelScale=e.vec3(e.length(i[0].xyz),e.length(i[1].xyz),e.length(i[2].xyz))),this.vertexNormal&&(t.$l.oNorm=Qa.resolveVertexNormal(t),t.$outputs.wNorm=e.mul(Qa.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz,this.vertexTangent&&(t.$l.oTangent=Qa.resolveVertexTangent(t),t.$outputs.wTangent=e.mul(Qa.getNormalMatrix(t),e.vec4(t.oTangent.xyz,0)).xyz,t.$outputs.wBinormal=e.mul(e.cross(t.$outputs.wNorm,t.$outputs.wTangent),t.oTangent.w)))}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;this.needFragmentColor()?(t.$l.albedo=this.calculateAlbedoColor(t),this.vertexColor&&(t.albedo=e.mul(t.albedo,this.getVertexColor(t))),this.drawContext.renderPass.type===Ra?(t.$l.normalInfo=this.calculateNormalAndTBN(t,t.$inputs.worldPos,t.$inputs.wNorm,t.$inputs.wTangent,t.$inputs.wBinormal),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a))):this.outputFragmentColor(t,t.$inputs.worldPos,t.albedo)):this.outputFragmentColor(t,t.$inputs.worldPos,null)}}function So(t){if(t.pbrSpecularGlossnessMixed)return t;const e=to(t,_o,oo,no("specular"));return class extends e{static pbrSpecularGlossnessMixed=!0;_specularFactor;_glossinessFactor;constructor(){super(),this._specularFactor=T.one(),this._glossinessFactor=1}get specularFactor(){return this._specularFactor}set specularFactor(t){t.equalsTo(this._specularFactor)||(this._specularFactor.set(t),this.uniformChanged())}get glossinessFactor(){return this._glossinessFactor}set glossinessFactor(t){t!==this._glossinessFactor&&(this._glossinessFactor=t,this.uniformChanged())}fragmentShader(t){if(super.fragmentShader(t),this.needFragmentColor()){const e=t.$builder;t.zSpecularFactor=e.vec4().uniform(2),t.zGlossinessFactor=e.float().uniform(2)}}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),this.needFragmentColor(e)&&(t.setValue("zSpecularFactor",this._specularFactor),t.setValue("zGlossinessFactor",this._glossinessFactor))}PBRLight(t,e,i,s,r,n){const a=t.$builder,o="Z_PBRSpecularGlossinessLight",h=this;return a.func(o,[a.vec3("worldPos"),a.vec3("normal"),a.mat3("TBN"),a.vec3("viewVec"),a.vec4("albedo")],(function(){this.$l.pbrData=h.getCommonData(this,this.albedo,this.normal,this.viewVec,this.TBN),this.$l.lightingColor=a.vec3(0),this.$l.emissiveColor=h.calculateEmissiveColor(this),h.indirectLighting(this,this.normal,this.viewVec,this.pbrData,this.lightingColor),h.forEachLight(this,(function(t,e,i,s,r){this.$l.diffuse=a.vec3(),this.$l.specular=a.vec3(),this.$l.lightAtten=h.calculateLightAttenuation(this,t,this.worldPos,e,i),this.$l.lightDir=h.calculateLightDirection(this,t,this.worldPos,e,i),this.$l.NoL=a.clamp(a.dot(this.normal,this.lightDir),0,1),this.$l.lightColor=a.mul(s.rgb,s.a,this.lightAtten,this.NoL),r&&(this.lightColor=a.mul(this.lightColor,h.calculateShadow(this,this.worldPos,this.NoL))),h.directLighting(this,this.lightDir,this.lightColor,this.normal,this.viewVec,this.pbrData,this.lightingColor)})),this.$return(a.add(this.lightingColor,this.emissiveColor))})),a.getGlobalScope()[o](e,i,n,s,r)}calculateCommonData(t,e,i,s,r,n){super.calculateCommonData(t,e,i,s,r,n);const a=t.$builder;this.specularTexture?(t.$l.specularTextureSample=this.sampleSpecularTexture(t),n.roughness=a.sub(1,a.mul(t.zGlossinessFactor,t.specularTextureSample.a)),n.f0=a.vec4(a.mul(t.specularTextureSample.rgb,t.zSpecularFactor.rgb),this.getF0(t).a)):(n.roughness=a.sub(1,t.zGlossinessFactor),n.f0=a.vec4(t.zSpecularFactor.rgb,this.getF0(t).a)),n.metallic=a.max(a.max(n.f0.r,n.f0.g),n.f0.b),n.diffuse=a.vec4(a.mul(e.rgb,a.sub(1,n.metallic)),e.a),n.specularWeight=1,n.f90=a.vec3(1)}}}class Co extends(to(ro,So,ho)){static FEATURE_VERTEX_NORMAL=this.defineFeature();static FEATURE_VERTEX_TANGENT=this.defineFeature();constructor(){super(),this.useFeature(Co.FEATURE_VERTEX_NORMAL,!0)}get vertexNormal(){return this.featureUsed(Co.FEATURE_VERTEX_NORMAL)}set vertexNormal(t){this.useFeature(Co.FEATURE_VERTEX_NORMAL,!!t)}get vertexTangent(){return this.featureUsed(Co.FEATURE_VERTEX_TANGENT)}set vertexTangent(t){this.useFeature(Co.FEATURE_VERTEX_TANGENT,!!t)}vertexShader(t){super.vertexShader(t);const e=t.$builder,i=Qa.getWorldMatrix(t);t.$l.oPos=Qa.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(i,e.vec4(t.oPos,1)).xyz,t.$l.csPos=e.mul(Qa.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1)),Qa.setClipSpacePosition(t,t.csPos),this.transmission&&(t.$outputs.screenUV=e.add(e.mul(e.div(t.csPos.xy,t.csPos.w),.5),e.vec2(.5)),t.$outputs.modelScale=e.vec3(e.length(i[0].xyz),e.length(i[1].xyz),e.length(i[2].xyz))),this.vertexNormal&&(t.$l.oNorm=Qa.resolveVertexNormal(t),t.$outputs.wNorm=e.mul(Qa.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz,this.vertexTangent&&(t.$l.oTangent=Qa.resolveVertexTangent(t),t.$outputs.wTangent=e.mul(Qa.getNormalMatrix(t),e.vec4(t.oTangent.xyz,0)).xyz,t.$outputs.wBinormal=e.mul(e.cross(t.$outputs.wNorm,t.$outputs.wTangent),t.oTangent.w)))}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;this.needFragmentColor()?(t.$l.albedo=this.calculateAlbedoColor(t),this.vertexColor&&(t.albedo=e.mul(t.albedo,this.getVertexColor(t))),this.drawContext.renderPass.type===Ra?(t.$l.normalInfo=this.calculateNormalAndTBN(t,t.$inputs.worldPos,t.$inputs.wNorm,t.$inputs.wTangent,t.$inputs.wBinormal),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a))):this.outputFragmentColor(t,t.$inputs.worldPos,t.albedo)):this.outputFragmentColor(t,t.$inputs.worldPos,null)}}class Ao{_renderBundles;constructor(){this._renderBundles={}}getRenderBundle(t){return this._renderBundles[t]??null}beginRenderBundle(){q.instance.device.beginCapture()}endRenderBundle(t){this._renderBundles[t]=q.instance.device.endCapture()}}const Mo=16384;class Ro{static _instanceBindGroupLayout=null;_bindGroupList=[];_allocFrameStamp;constructor(){this._allocFrameStamp=-1,this._bindGroupList=[]}allocateInstanceBindGroup(t,e){if(this._allocFrameStamp!==t){this._allocFrameStamp=t;for(const t of this._bindGroupList)t.offset=0}for(const t of this._bindGroupList)if(t.offset+e<=Mo)return t.dirty=!0,t;if(!Ro._instanceBindGroupLayout){const t=new Un(q.instance.device).buildRender({vertex(t){this[Qa.getInstanceDataUniformName()]=t.vec4[4096]().uniformBuffer(3),t.main((function(){}))},fragment(t){t.main((function(){}))}});Ro._instanceBindGroupLayout=t[2][3]}const i={bindGroup:q.instance.device.createBindGroup(Ro._instanceBindGroupLayout),buffer:new Float32Array(Mo),offset:0,dirty:!0};return this._bindGroupList.push(i),i}}const Fo=new Ro;class Io{_itemList;_renderPass;_shadowedLightList;_unshadowedLightList;_sunLight;_bindGroupAllocator;_ref;_instanceInfo;_needSceneColor;_drawTransparent;_objectColorMaps;constructor(t,e){this._bindGroupAllocator=e??Fo,this._itemList=null,this._renderPass=t,this._shadowedLightList=[],this._unshadowedLightList=[],this._sunLight=null,this._ref={ref:this},this._instanceInfo=new Map,this._needSceneColor=!1,this._drawTransparent=!1,this._objectColorMaps=[new Map]}get sunLight(){return this._sunLight}set sunLight(t){this._sunLight=t}get needSceneColor(){return this._needSceneColor}get drawTransparent(){return this._drawTransparent}get renderPass(){return this._renderPass}get itemList(){return this._itemList}get shadowedLights(){return this._shadowedLightList}get unshadowedLights(){return this._unshadowedLightList}get ref(){return this._ref}getInstanceInfo(t){return this._instanceInfo.get(t)}getMaxBatchSize(){return q.instance.device.getDeviceCaps().shaderCaps.maxUniformBufferSize/64}pushLight(t){t.castShadow?this._shadowedLightList.push(t):this._unshadowedLightList.push(t),t.isDirectionLight()&&t.sunLight&&(this.sunLight=t)}pushRenderQueue(t){const e=t._itemList;e&&(this._itemList||(this._itemList=this.newRenderItemList()),this._itemList.opaque.lit.push(...e.opaque.lit),this._itemList.opaque.unlit.push(...e.opaque.unlit),this._itemList.transmission.lit.push(...e.transmission.lit),this._itemList.transmission.unlit.push(...e.transmission.unlit),this._itemList.transparent.lit.push(...e.transparent.lit),this._itemList.transparent.unlit.push(...e.transparent.unlit),this._needSceneColor||=t._needSceneColor,this._drawTransparent||=t._drawTransparent,this._objectColorMaps.push(...t._objectColorMaps))}push(t,e){if(e){this._itemList||(this._itemList=this.newRenderItemList());const i=2===e.getQueueType(),s=e.isUnlit(),r=!i&&e.needSceneColor();if(this._needSceneColor||=r,this._drawTransparent||=i,t.enablePicking&&(e.getMaterial().objectColor=e.getObjectColor(),this._objectColorMaps[0].set(e.getId(),e)),e.isBatchable()){const t=i?s?this._itemList.transparent.unlit[0].instanceList:this._itemList.transparent.lit[0].instanceList:s?r?this._itemList.transmission.unlit[0].instanceList:this._itemList.opaque.unlit[0].instanceList:r?this._itemList.transmission.lit[0].instanceList:this._itemList.opaque.lit[0].instanceList,n=e.getInstanceId(this._renderPass);let a=t[n];a||(a=[],t[n]=a),a.push(e)}else{const n=i?s?this._itemList.transparent.unlit[0]:this._itemList.transparent.lit[0]:s?r?this._itemList.transmission.unlit[0]:this._itemList.opaque.unlit[0]:r?this._itemList.transmission.lit[0]:this._itemList.opaque.lit[0],a=!!e.getBoneMatrices(),o=!!e.getMorphData();let h;h=a&&o?n.skinAndMorphItemList:a?n.skinItemList:o?n.morphItemList:n.itemList,this.binaryInsert(h,{drawable:e,sortDistance:e.getSortDistance(t),instanceData:null}),e.applyTransformUniforms(this);const l=e.getMaterial();l&&n.materialList.add(l.coreMaterial)}e.pushRenderQueueRef(this._ref)}}getDrawableByColor(t){const e=(t[0]<<24)+(t[1]<<16)+(t[2]<<8)+t[3];for(const t of this._objectColorMaps){const i=t.get(e);if(i)return i}return null}reset(){this._itemList=null,this._shadowedLightList=[],this._unshadowedLightList=[],this._sunLight=null,this._needSceneColor=!1,this._drawTransparent=!1}dispose(){this._ref.ref=null,this._ref=null,this.reset()}end(t,e){const i=q.instance.device.frameInfo.frameCounter,s=this._itemList;if(!this.itemList)return this;const r=[s.opaque.lit,s.opaque.unlit,s.transmission.lit,s.transmission.unlit,s.transparent.lit,s.transparent.unlit];for(let s=0;s<r.length;s++){const n=r[s];for(const s of n){if(s.renderQueue!==this)continue;const r=s.instanceList;for(const e in r){const n=r[e];if(1===n.length){this.binaryInsert(s.itemList,{drawable:n[0],sortDistance:n[0].getSortDistance(t),instanceData:null}),n[0].applyTransformUniforms(this);const e=n[0].getMaterial();e&&s.materialList.add(e.coreMaterial)}else{let e=null,r=null;for(let a=0;a<n.length;a++){const o=n[a],h=o.getInstanceUniforms(),l=16+(h?.length??0);(!e||e.offset+l>Mo)&&(e=this._bindGroupAllocator.allocateInstanceBindGroup(i,l),r={drawable:o,sortDistance:o.getSortDistance(t),instanceData:{bindGroup:e,offset:e.offset,numInstances:0,stride:l}},this.binaryInsert(s.instanceItemList,r),o.applyInstanceOffsetAndStride(this,l,e.offset));const u={bindGroup:e,offset:e.offset};this._instanceInfo.set(o,u),o.applyTransformUniforms(this),o.applyMaterialUniforms(u),e.offset+=l,r.instanceData.numInstances++;const c=o.getMaterial();c&&s.materialList.add(c.coreMaterial)}}}s.instanceList={},e&&(s.itemList.length>0&&(s.renderBundle=new Ao),s.skinItemList.length>0&&(s.skinRenderBundle=new Ao),s.morphItemList.length>0&&(s.morphRenderBundle=new Ao),s.skinAndMorphItemList.length>0&&(s.skinAndMorphRenderBundle=new Ao),s.instanceItemList.length>0&&(s.instanceRenderBundle=new Ao))}}return this}binaryInsert(t,e){let i=0,s=t.length-1;const r=e.drawable.getMaterial().instanceId;for(;i<=s;){const n=Math.floor((i+s)/2),a=t[n].drawable.getMaterial().instanceId;if(a===r)return void t.splice(n+1,0,e);a<r?i=n+1:s=n-1}t.splice(i,0,e)}sortTransparentItems(t){this._itemList&&(this._itemList.transparent.lit[0].itemList.sort(((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t))),this._itemList.transparent.lit[0].skinItemList.sort(((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t))),this._itemList.transparent.lit[0].morphItemList.sort(((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t))),this._itemList.transparent.lit[0].skinAndMorphItemList.sort(((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t))),this._itemList.transparent.unlit[0].itemList.sort(((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t))),this._itemList.transparent.unlit[0].skinItemList.sort(((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t))),this._itemList.transparent.unlit[0].morphItemList.sort(((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t))),this._itemList.transparent.unlit[0].skinAndMorphItemList.sort(((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t))))}drawableDistanceToCamera(t,e){const i=t.getXForm().position;return b.distanceSq(i,e)}newRenderItemListInfo(){return{itemList:[],skinItemList:[],morphItemList:[],skinAndMorphItemList:[],instanceItemList:[],materialList:new Set,instanceList:{},renderQueue:this}}newRenderItemListBundle(){return{lit:[this.newRenderItemListInfo()],unlit:[this.newRenderItemListInfo()]}}newRenderItemList(){return{opaque:this.newRenderItemListBundle(),transmission:this.newRenderItemListBundle(),transparent:this.newRenderItemListBundle()}}}class Do{_type;_globalBindGroups;_clearColor;_clearDepth;_clearStencil;constructor(t){this._type=t,this._clearColor=new T(0,0,0,1),this._clearDepth=1,this._clearStencil=0,this._globalBindGroups={}}get clearColor(){return this._clearColor}set clearColor(t){this._clearColor=t??null}get clearDepth(){return this._clearDepth}set clearDepth(t){this._clearDepth=t??null}get clearStencil(){return this._clearStencil}set clearStencil(t){this._clearStencil=t??null}get type(){return this._type}isAutoFlip(t){return!(!t.device.getFramebuffer()||"webgpu"!==t.device.type)}render(t,e,i){t.renderPass=this,this.drawScene(t,e??t.camera,i)}getGlobalBindGroup(t){const e=this.getGlobalBindGroupHash(t);let i=this._globalBindGroups[e];if(!i){const s=t.device.programBuilder.buildRender({vertex(e){Qa.prepareVertexShader(e,t),e.main((function(){}))},fragment(e){Qa.prepareFragmentShader(e,t),e.main((function(){}))}});i=t.device.createBindGroup(s[2][0]),this._globalBindGroups[e]=i}return i}dispose(){this._globalBindGroups={}}getGlobalBindGroupHash(t){return`${this.constructor.name}:${this._getGlobalBindGroupHash(t)}`}drawScene(t,e,i){const s=t.device;this.clearFramebuffer();const r=i??this.cullScene(t,e);if(r){const e=s.isWindingOrderReversed();s.reverseVertexWindingOrder(this.isAutoFlip(t)?!e:e),this.renderItems(t,r),s.reverseVertexWindingOrder(e),r!==i&&r.dispose()}}cullScene(t,e){if(e){const i=new Io(this),s=new Na(this,e,i,t.primaryCamera);return t.scene.octree?t.scene.octree.getRootNode().traverse(s):t.scene.rootNode.traverse(s),i.end(e)}return null}drawItem(t,e,i,s){const r=s!==e.drawable.getXForm().worldMatrixDet<0;r&&t.reverseVertexWindingOrder(!t.isWindingOrderReversed()),e.drawable.draw(i),r&&t.reverseVertexWindingOrder(!t.isWindingOrderReversed())}internalDrawItemList(t,e,i,s,r){if(i&&t.primaryCamera.commandBufferReuse){const e=i.getRenderBundle(r);if(e)return void t.device.executeRenderBundle(e);i.beginRenderBundle()}for(const i of e){t.instanceData=i.instanceData;const e=s!==i.drawable.getXForm().worldMatrixDet<0;e&&t.device.reverseVertexWindingOrder(!t.device.isWindingOrderReversed()),i.drawable.draw(t),e&&t.device.reverseVertexWindingOrder(!t.device.isWindingOrderReversed())}i&&t.primaryCamera.commandBufferReuse&&i.endRenderBundle(r)}drawItemList(t,e,i){e.renderQueue=t.renderQueue,e.instanceData=null;const s=`${i?"1":"0"}-${e.device.getBindGroup(0)[0].getGPUId()}-${e.device.getFramebuffer()?.getHash()??""}-${`${e.sceneColorTexture?.uid??0}-${e.linearDepthTexture?.uid??0}`}-${e.renderPassHash}`;t&&(t.itemList.length>0&&(e.skinAnimation=!1,e.instancing=!1,t.materialList.forEach((t=>t.apply(e))),this.internalDrawItemList(e,t.itemList,t.renderBundle,i,s)),t.skinItemList.length>0&&(e.skinAnimation=!0,e.morphAnimation=!1,e.instancing=!1,t.materialList.forEach((t=>t.apply(e))),this.internalDrawItemList(e,t.skinItemList,t.skinRenderBundle,i,s)),t.morphItemList.length>0&&(e.skinAnimation=!1,e.morphAnimation=!0,e.instancing=!1,t.materialList.forEach((t=>t.apply(e))),this.internalDrawItemList(e,t.morphItemList,t.morphRenderBundle,i,s)),t.skinAndMorphItemList.length>0&&(e.skinAnimation=!0,e.morphAnimation=!0,e.instancing=!1,t.materialList.forEach((t=>t.apply(e))),this.internalDrawItemList(e,t.skinAndMorphItemList,t.skinAndMorphRenderBundle,i,s)),t.instanceItemList.length>0&&(e.skinAnimation=!1,e.instancing=!0,t.materialList.forEach((t=>t.apply(e))),this.internalDrawItemList(e,t.instanceItemList,t.instanceRenderBundle,i,s))),e.renderQueue=null}clearFramebuffer(){q.instance.device.clearFrameBuffer(this._clearColor,this._clearDepth,this._clearStencil)}}class $o extends Do{_shadowMapHash;_transmission;constructor(){super(Ra),this._shadowMapHash=null}get transmission(){return this._transmission}set transmission(t){this._transmission=t}_getGlobalBindGroupHash(t){return`lp:${this._shadowMapHash}:${t.oit?.calculateHash()??""}:${t.env.getHash(t)}`}renderLightPass(t,e,i,s){const r=!t.lightBlending;t.drawEnvLight=r&&"none"!==t.env.light.type&&(t.env.light.envLight.hasRadiance()||t.env.light.envLight.hasIrradiance()),t.renderPassHash=this.getGlobalBindGroupHash(t);const n=t.globalBindGroupAllocator.getGlobalBindGroup(t);s.cameraSet[t.renderPassHash]||(Qa.setCameraUniforms(n,t.camera,t.flip,!!t.device.getFramebuffer()),s.cameraSet[t.renderPassHash]=1),t.currentShadowLight?Qa.setLightUniformsShadow(n,t,i[0]):s.lightSet[t.renderPassHash]||(Qa.setLightUniforms(n,t,t.clusteredLight.clusterParam,t.clusteredLight.countParam,t.clusteredLight.lightBuffer,t.clusteredLight.lightIndexTexture),s.lightSet[t.renderPassHash]=1),t.applyFog&&!s.fogSet[t.renderPassHash]&&(Qa.setFogUniforms(n,t.env.sky.mappedFogType,r?t.env.sky.fogColor:T.zero(),t.env.sky.fogParams,t.env.sky.aerialPerspectiveDensity*t.env.sky.aerialPerspectiveDensity,t.env.sky.getAerialPerspectiveLUT(t)),s.fogSet[t.renderPassHash]=1),t.device.setBindGroup(0,n);const a=t.camera.worldMatrixDet<0;for(const i of e.lit)this.drawItemList(i,t,a);if(!t.lightBlending)for(const i of e.unlit)this.drawItemList(i,t,a)}renderItems(t,e){t.applyFog=null,t.renderPassHash=null,t.env=t.scene.env,t.drawEnvLight=!1,t.flip=this.isAutoFlip(t);const i=e.drawTransparent&&t.primaryCamera.oit&&t.primaryCamera.oit.supportDevice(t.device.type)?t.primaryCamera.oit:null;!i&&e.drawTransparent&&e.sortTransparentItems(t.primaryCamera.getWorldPosition());const s={lightSet:{},cameraSet:{},fogSet:{}},r=e.itemList,n=[this._transmission?r?.transmission:r?.opaque,r?.transparent];for(let a=0;a<2;a++){if(n[a]){t.applyFog=1===a&&"none"!==t.env.sky.fogType?t.env.sky.fogType:null,t.queue=0===a?1:2,t.oit=0!==a&&r?i:null;const o=t.oit?t.oit.begin(t):1;for(let i=0;i<o;i++){if(t.oit&&!t.oit.beginPass(t,i))continue;let r=0;if(t.shadowMapInfo)for(const e of t.shadowMapInfo.keys())t.currentShadowLight=e,t.lightBlending=r>0,this._shadowMapHash=t.shadowMapInfo.get(e).shaderHash,this.renderLightPass(t,n[a],[e],s),r++;(0===r||e.unshadowedLights.length>0)&&(t.currentShadowLight=null,t.lightBlending=r>0,this._shadowMapHash="",this.renderLightPass(t,n[a],e.unshadowedLights,s)),t.oit&&t.oit.endPass(t,i)}t.oit&&t.oit.end(t)}0!==a||t.sceneColorTexture||(t.env.sky.skyWorldMatrix=t.scene.rootNode.worldMatrix,t.env.sky.renderSky(t)),e.needSceneColor&&!t.sceneColorTexture||(0===a&&t.env.sky.renderFog(t),t.compositor?.drawPostEffects(t,0===a,t.linearDepthTexture))}}}class Lo extends Do{_currentLight;constructor(){super(1),this._currentLight=null}get light(){return this._currentLight}set light(t){this._currentLight=t}_getGlobalBindGroupHash(t){return`sm:${t.shadowMapInfo.get(this.light).shaderHash}`}renderItems(t,e){const i=e.itemList;if(i){t.drawEnvLight=!1,t.env=null,t.applyFog=null,t.flip=this.isAutoFlip(t),t.renderPassHash=this.getGlobalBindGroupHash(t);const e=t.globalBindGroupAllocator.getGlobalBindGroup(t);t.device.setBindGroup(0,e),Qa.setLightUniformsShadowMap(e,t,this._currentLight),Qa.setCameraUniforms(e,t.camera,t.flip,!0);const s=t.camera.worldMatrixDet<0;for(const e of i.opaque.lit)this.drawItemList(e,t,s);for(const e of i.opaque.unlit)this.drawItemList(e,t,s)}}}class Po extends Do{constructor(){super(2)}_getGlobalBindGroupHash(t){return""}renderItems(t,e){const i=e.itemList;if(i){t.applyFog=null,t.drawEnvLight=!1,t.env=null,t.flip=this.isAutoFlip(t),t.renderPassHash=this.getGlobalBindGroupHash(t);const e=t.globalBindGroupAllocator.getGlobalBindGroup(t);t.device.setBindGroup(0,e),Qa.setCameraUniforms(e,t.camera,t.flip,!0);const s=t.camera.worldMatrixDet<0;for(const e of i.opaque.lit)this.drawItemList(e,t,s);for(const e of i.opaque.unlit)this.drawItemList(e,t,s)}}}class No extends(s(Object)()){_parent;_children;_position;_scaling;_rotation;_localMatrix;_worldMatrix;_worldMatrixDet;_invWorldMatrix;_tmpLocalMatrix;_tmpWorldMatrix;_transformTag;_transformChangeCallback;constructor(){super(),this._parent=null,this._children=[],this._transformChangeCallback=()=>this._onTransformChanged(!0),this._position=new w(0,0,0),this._position.callback=this._transformChangeCallback,this._scaling=new w(1,1,1),this._scaling.callback=this._transformChangeCallback,this._rotation=new y,this._rotation.callback=this._transformChangeCallback,this._worldMatrix=null,this._worldMatrixDet=null,this._invWorldMatrix=null,this._localMatrix=null,this._transformTag=0,this._tmpLocalMatrix=S.identity(),this._tmpWorldMatrix=S.identity()}get parent(){return this._parent}set parent(t){(t=t||null)!==this._parent&&this._setParent(t)}get children(){return this._children}get position(){return this._position||this.syncTRS(),this._position}set position(t){this._position||this.syncTRS(),this._position.setXYZ(t[0],t[1],t[2])}get scale(){return this._scaling||this.syncTRS(),this._scaling}set scale(t){this._scaling||this.syncTRS(),this._scaling.setXYZ(t[0],t[1],t[2])}get rotation(){return this._rotation||this.syncTRS(),this._rotation}set rotation(t){this._rotation||this.syncTRS(),this._rotation.setXYZW(t[0],t[1],t[2],t[3])}worldToThis(t,e){return t instanceof b?(e=e||new b,this.invWorldMatrix.transformPointAffine(t,e),e):(e=e||new T,this.invWorldMatrix.transformAffine(t,e),e)}otherToThis(t,e,i){return this.worldToThis(t.thisToWorld(e,i),i)}thisToWorld(t,e){return t instanceof b?(e=e||new b,this.worldMatrix.transformPointAffine(t,e),e):(e=e||new T,this.worldMatrix.transformAffine(t,e),e)}thisToOther(t,e,i){return t.worldToThis(this.thisToWorld(e,i),i)}getWorldPosition(){return new b(this.worldMatrix.m03,this.worldMatrix.m13,this.worldMatrix.m23)}moveBy(t){return this._position.addBy(t),this}scaleBy(t){return this._scaling.mulBy(t),this}setLocalTransform(t){return this._localMatrix=t,this._position=null,this._rotation=null,this._scaling=null,this._onTransformChanged(!1),this}get localMatrix(){return this._localMatrix||(this._localMatrix=this._tmpLocalMatrix,this._localMatrix.scaling(this._scaling).rotateLeft(new S(this._rotation)).translateLeft(this._position)),this._localMatrix}set localMatrix(t){this.setLocalTransform(t)}get worldMatrix(){return this._worldMatrix||(this._worldMatrix=this._tmpWorldMatrix,this._parent?S.multiplyAffine(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this._worldMatrix.set(this.localMatrix)),this._worldMatrix}get worldMatrixDet(){return null===this._worldMatrixDet&&(this._worldMatrixDet=this.worldMatrix.det()),this._worldMatrixDet}get invWorldMatrix(){return this._invWorldMatrix||(this._invWorldMatrix=S.invertAffine(this.worldMatrix)),this._invWorldMatrix}lookAt(t,e,i){return S.lookAt(t,e,i).decompose(this._scaling,this._rotation,this._position),this}reparent(t){return this.parent=t,this}getTag(){return this._transformTag}syncTRS(){this._position=new w,this._rotation=new y,this._scaling=new w,this._localMatrix.decompose(this._scaling,this._rotation,this._position),this._position.callback=this._transformChangeCallback,this._rotation.callback=this._transformChangeCallback,this._scaling.callback=this._transformChangeCallback}_onTransformChanged(t){if(t&&(this._localMatrix=null),this._worldMatrix){this._worldMatrix=null,this._invWorldMatrix=null,this._transformTag++;for(const t of this._children)t._onTransformChanged(!1)}this._worldMatrixDet=null}_setParent(t){this._parent!==t&&(this._parent&&this._parent._children.splice(this._parent._children.indexOf(this),1),this._parent=t,this._parent&&this._parent._children.push(this),this._onTransformChanged(!1))}}class Bo extends No{static BBOXDRAW_INHERITED=-1;static BBOXDRAW_DISABLED=0;static BBOXDRAW_LOCAL=1;static BBOXDRAW_WORLD=2;_clipMode;_boxDrawMode;_visible;_pickMode;_name;_scene;_bv;_bvDirty;_bvWorld;_placeToOctree;constructor(t){super(),this._scene=t,this._name="",this._bv=null,this._bvWorld=null,this._bvDirty=!0,this._clipMode=!0,this._boxDrawMode=Bo.BBOXDRAW_DISABLED,this._visible="inherit",this._pickMode=!1,this._placeToOctree=!0,t&&this!==t.rootNode&&this.reparent(t.rootNode)}get placeToOctree(){return this._placeToOctree}set placeToOctree(t){!!t!==this._placeToOctree&&(this._placeToOctree=!!t,this.isGraphNode()&&this.scene.invalidateNodePlacement(this))}get name(){return this._name}set name(t){this._name=t||""}get scene(){return this._scene}get attached(){return!!this._scene?.rootNode?.isParentOf(this)}hasChild(t){return this._children.indexOf(t)>=0}removeChildren(){for(;this._children.length;)this._children[0].remove()}isParentOf(t){for(;t&&t!==this;)t=t.parent;return t===this}remove(){return this.parent=null,this}traverse(t,e){if(e){for(let i=this._children.length-1;i>=0;i--)this._children[i].traverse(t,e);t.visit(this)}else{t.visit(this);for(const e of this._children)e.traverse(t)}}iterate(t){t(this);for(const e of this._children)e.iterate(t)}isGraphNode(){return!1}isLight(){return!1}isMesh(){return!1}isBatchGroup(){return!1}isTerrain(){return!1}isCamera(){return!1}isPunctualLight(){return!1}dispose(){this.remove(),this.removeChildren()}computeBoundingVolume(t){return t}getBoundingVolume(){return this._bvDirty&&(this._bv=this.computeBoundingVolume(this._bv)||null,this._bvDirty=!1),this._bv}setBoundingVolume(t){t!==this._bv&&(this._bv=t,this.invalidateBoundingVolume())}getWorldBoundingVolume(){return this._bvWorld||(this._bvWorld=this.getBoundingVolume()?.transform(this.worldMatrix)??null),this._bvWorld}invalidateBoundingVolume(){this._bvDirty=!0,this.invalidateWorldBoundingVolume(!1)}invalidateWorldBoundingVolume(t){this._bvWorld=null,this._scene&&(t?this.iterate((t=>{t.isGraphNode()&&this._scene.invalidateNodePlacement(t)})):this.isGraphNode()&&this._scene.invalidateNodePlacement(this))}get clipTestEnabled(){return this._clipMode}set clipTestEnabled(t){this._clipMode=t}get hidden(){let t=this;for(;t&&"inherit"===t._visible;)t=t.parent;return!!t&&"hidden"===t._visible}get showState(){return this._visible}set showState(t){if(t!==this._visible){const e=this.hidden;this._visible=t,e!==this.hidden&&this.notifyHiddenChanged()}}get pickable(){return this._pickMode}set pickable(t){this._pickMode=!!t}get computedBoundingBoxDrawMode(){if(this._boxDrawMode===Bo.BBOXDRAW_INHERITED){let t=this.parent;for(;t&&!t.isGraphNode();)t=t.parent;return t?.computedBoundingBoxDrawMode??Bo.BBOXDRAW_DISABLED}return this._boxDrawMode}get boundingBoxDrawMode(){return this._boxDrawMode}set boundingBoxDrawMode(t){this._boxDrawMode=t}_setParent(t){let e=this._parent,i=t;if(i!==e){const t=this.attached?this.scene:null,e=i?.attached?i.scene:null,s=t&&t!==e,r=e&&t!==e;s&&this._willDetach(),r&&this._willAttach(),super._setParent(i),s&&this._detached(),r&&this._attached()}for(;e;)e.dispatchEvent(this,"noderemoved"),e=e.parent;for(;i;)i.dispatchEvent(this,"nodeattached"),i=i.parent}_onTransformChanged(t){super._onTransformChanged(t),this.invalidateWorldBoundingVolume(!0),this.dispatchEvent(this,"transformchanged")}_willAttach(){}_attached(){}_willDetach(){}_detached(){}notifyHiddenChanged(){this._visibleChanged(),this.dispatchEvent(this,"visiblechanged");for(const t of this._children)"inherit"===t.showState&&t.notifyHiddenChanged()}_visibleChanged(){}}function Oo(t,e){const i=t.$builder,s="Z_noise3d";return i.func(s,[i.vec3("p")],(function(){this.$l.p3=i.fract(i.mul(this.p,.1031)),this.$l.p3=i.add(this.p3,i.vec3(i.dot(this.p3,i.add(this.p3.yzx,i.vec3(33.33))))),this.$return(i.fract(i.mul(i.add(this.p3.x,this.p3.y),this.p3.z)))})),i.getGlobalScope()[s](e)}function Uo(t,e){const i=t.$builder,s="Z_smoothNoise3D";return i.func(s,[i.vec3("p")],(function(){this.$l.cell=i.floor(this.p),this.$l.local=i.fract(this.p),this.$l.local=i.mul(this.local,i.mul(this.local,i.sub(i.vec3(3),i.mul(this.local,2)))),this.$l.ldb=Oo(this,this.cell),this.$l.rdb=Oo(this,i.add(this.cell,i.vec3(1,0,0))),this.$l.ldf=Oo(this,i.add(this.cell,i.vec3(0,0,1))),this.$l.rdf=Oo(this,i.add(this.cell,i.vec3(1,0,1))),this.$l.lub=Oo(this,i.add(this.cell,i.vec3(0,1,0))),this.$l.rub=Oo(this,i.add(this.cell,i.vec3(1,1,0))),this.$l.luf=Oo(this,i.add(this.cell,i.vec3(0,1,1))),this.$l.ruf=Oo(this,i.add(this.cell,i.vec3(1,1,1))),this.$return(i.mix(i.mix(i.mix(this.ldb,this.rdb,this.local.x),i.mix(this.ldf,this.rdf,this.local.x),this.local.z),i.mix(i.mix(this.lub,this.rub,this.local.x),i.mix(this.luf,this.ruf,this.local.x),this.local.z),this.local.y))})),i.getGlobalScope()[s](e)}const ko={linear:Qa.FOG_TYPE_LINEAR,exp:Qa.FOG_TYPE_EXP,exp2:Qa.FOG_TYPE_EXP2,scatter:Qa.FOG_TYPE_SCATTER,none:Qa.FOG_TYPE_NONE},zo=S.identity();class Vo{_skyType;_skyColor;_skyboxTexture;_updateRadianceMaps;_radianceMapDirty;_scatterSkyboxFramebuffer;_scatterSkyboxTextureWidth;_aerialPerspectiveDensity;_radianceMap;_radianceMapWidth;_irradianceMap;_irradianceMapWidth;_fogType;_fogColor;_fogParams;_cloudy;_cloudIntensity;_wind;_nearestSampler;_programSky;_bindgroupSky;_programFog;_bindgroupFog;_programFogScatter;_bindgroupFogScatter;_vertexLayout;_primitiveSky;_skyWorldMatrix;_renderStatesSky;_renderStatesSkyNoDepthTest;_renderStatesFog;_renderStatesFogScatter;_drawGround;_lastSunDir;constructor(){this._skyType="scatter",this._updateRadianceMaps=!0,this._radianceMapDirty=!0,this._skyColor=T.zero(),this._skyboxTexture=null,this._scatterSkyboxFramebuffer=null,this._scatterSkyboxTextureWidth=256,this._aerialPerspectiveDensity=1,this._radianceMap=null,this._radianceMapWidth=128,this._irradianceMap=null,this._irradianceMapWidth=64,this._fogType="none",this._fogColor=T.one(),this._fogParams=new T(1,100,50,.002),this._cloudy=.6,this._cloudIntensity=40,this._wind=x.zero(),this._drawGround=!1,this._nearestSampler=null,this._programSky={},this._bindgroupSky={},this._programFog=null,this._bindgroupFog=null,this._programFogScatter=null,this._bindgroupFogScatter=null,this._vertexLayout=null,this._primitiveSky=null,this._renderStatesSky=null,this._renderStatesSkyNoDepthTest=null,this._renderStatesFog=null,this._renderStatesFogScatter=null,this._skyWorldMatrix=zo,this._lastSunDir=b.zero()}getHash(t){return"scatter"===t.applyFog?"1":t.applyFog?"2":"0"}get skyType(){return this._skyType}set skyType(t){t!==this._skyType&&(this._skyType=t,this.invalidateIBLMaps())}get drawGround(){return this._drawGround}set drawGround(t){this._drawGround=!!t}get autoUpdateIBLMaps(){return this._updateRadianceMaps}set autoUpdateIBLMaps(t){this._updateRadianceMaps!==!!t&&(this._updateRadianceMaps=!!t,this._updateRadianceMaps&&this.invalidateIBLMaps())}get skyColor(){return this._skyColor}set skyColor(t){t.equalsTo(this._skyColor)||(this._skyColor.set(t),this.invalidateIBLMaps())}get aerialPerspectiveDensity(){return this._aerialPerspectiveDensity}set aerialPerspectiveDensity(t){this._aerialPerspectiveDensity=t}get cloudy(){return this._cloudy}set cloudy(t){t!==this._cloudy&&"scatter"===this._skyType&&(this._cloudy=t,this.invalidateIBLMaps())}get cloudIntensity(){return this._cloudIntensity}set cloudIntensity(t){t!==this._cloudIntensity&&"scatter"===this._skyType&&(this._cloudIntensity=t,this.invalidateIBLMaps())}get wind(){return this._wind}set wind(t){this._wind.set(t)}get radianceMap(){return this._radianceMap||(this._radianceMap=q.instance.device.createCubeTexture("rgba16f",this._radianceMapWidth),this._radianceMap.name="SkyRadianceMap"),this._radianceMap}get irradianceMap(){return this._irradianceMap||(this._irradianceMap=q.instance.device.createCubeTexture("rgba16f",this._irradianceMapWidth,{samplerOptions:{mipFilter:"none"}}),this._irradianceMap.name="SkyIrradianceMap"),this._irradianceMap}get skyboxTexture(){return this._skyboxTexture}set skyboxTexture(t){t!==this._skyboxTexture&&(this._skyboxTexture=t,"skybox"===this._skyType&&this.invalidateIBLMaps())}get skyWorldMatrix(){return this._skyWorldMatrix}set skyWorldMatrix(t){(t=t??zo)!==this._skyWorldMatrix&&(this._skyWorldMatrix=t,this.invalidateIBLMaps())}get mappedFogType(){return ko[this._fogType]}get fogType(){return this._fogType}set fogType(t){this._fogType=t}get fogStart(){return this._fogParams.x}set fogStart(t){this._fogParams.x=t}get fogEnd(){return this._fogParams.y}set fogEnd(t){this._fogParams.y=t}get fogTop(){return this._fogParams.z}set fogTop(t){this._fogParams.z=t}get fogDensity(){return this._fogParams.w}set fogDensity(t){this._fogParams.w=t}get fogColor(){return this._fogColor}set fogColor(t){this._fogColor.set(t)}get fogParams(){return this._fogParams}set fogParams(t){this._fogParams.set(t)}invalidateIBLMaps(){this._radianceMapDirty=!0}drawScatteredFog(t){return t.sunLight&&"scatter"===this._fogType}getAerialPerspectiveLUT(t){if(this.drawScatteredFog(t)){const e=Vo._getSunDir(t.sunLight),i=Math.PI/2-Math.acos(Math.max(-1,Math.min(1,e.y))),s=t.camera.getFarPlane()*this._aerialPerspectiveDensity*this._aerialPerspectiveDensity;return Ba.getAerialPerspectiveLut(i,s)}return null}updateIBLMaps(t){const e=q.instance.device;let i=null;if("skybox"===this._skyType&&this._skyboxTexture)i=this._skyboxTexture;else{if(!this._scatterSkyboxFramebuffer){const t=e.getDeviceCaps().textureCaps,i=t.supportHalfFloatColorBuffer&&t.supportLinearHalfFloatTexture?"rgba16f":t.supportFloatColorBuffer&&t.supportLinearFloatTexture?"rgba32f":"rgba8unorm",s=e.createCubeTexture(i,this._scatterSkyboxTextureWidth);s.name="BakedSkyboxTexture",this._scatterSkyboxFramebuffer=e.createFrameBuffer([s],null),this._radianceMapDirty=!0}const s=new Go(null);s.setPerspective(Math.PI/2,1,1,20);const r=e.getRenderStates();e.pushDeviceStates(),e.setFramebuffer(this._scatterSkyboxFramebuffer);for(const e of[m.PX,m.NX,m.PY,m.NY,m.PZ,m.NZ])s.lookAtCubeFace(e),this._scatterSkyboxFramebuffer.setColorAttachmentCubeFace(0,e),this._renderSky(s,!1,t,!0,!1);e.popDeviceStates(),e.setRenderStates(r),i=this._scatterSkyboxFramebuffer.getColorAttachments()[0]}et(i,"ggx",this.radianceMap),et(i,"lambertian",this.irradianceMap)}renderFog(t){const e=t.camera,i=t.linearDepthTexture,s=t.device,r=s.getRenderStates();this._prepareSkyBox(s);const n=t.sunLight;if("scatter"===this._fogType&&!n)return void console.error("Cannot render scattering fog without sun light");const a="scatter"===this._fogType?this._programFogScatter:this._programFog,o="scatter"===this._fogType?this._renderStatesFogScatter:this._renderStatesFog;if(a&&i){const h="scatter"===this._fogType?this._bindgroupFogScatter:this._bindgroupFog;if(h.setTexture("depthTex",i,this._nearestSampler),h.setValue("rt",s.getFramebuffer()?1:0),h.setValue("invProjViewMatrix",e.invViewProjectionMatrix),h.setValue("cameraNearFar",new x(e.getNearPlane(),e.getFarPlane())),h.setValue("cameraPosition",e.getWorldPosition()),h.setValue("srgbOut",s.getFramebuffer()?0:1),"scatter"===this._fogType){const e=n?n.directionAndCutoff.xyz().scaleBy(-1):Qa.defaultSunDir,i=Math.PI/2-Math.acos(Math.max(-1,Math.min(1,e.y))),s=this._aerialPerspectiveDensity*this._aerialPerspectiveDensity,r=t.camera.getFarPlane()*s;h.setTexture("apLut",Ba.getAerialPerspectiveLut(i,r)),h.setValue("sliceDist",r/Ba.aerialPerspectiveSliceZ),h.setValue("sunDir",e),h.setValue("worldScale",s)}else h.setValue("fogType",this.mappedFogType),h.setValue("fogColor",this._fogColor),h.setValue("fogParams",this._fogParams);s.setProgram(a),s.setBindGroup(0,h),s.setVertexLayout(this._vertexLayout),s.setRenderStates(o),s.draw("triangle-strip",0,4),s.setRenderStates(r)}}renderSky(t){const e=Vo._getSunDir(t.sunLight);e.equalsTo(this._lastSunDir)||(this._radianceMapDirty=!0),this._renderSky(t.camera,!0,e,this._drawGround,"scatter"===this._skyType&&this._cloudy>0),this._radianceMapDirty&&"ibl"===t.env.light.type&&(!t.env.light.radianceMap||t.env.light.radianceMap!==this._radianceMap&&t.env.light.irradianceMap!==this._irradianceMap||(this._radianceMapDirty=!1,this._lastSunDir.set(e),this.updateIBLMaps(e)))}_renderSky(t,e,i,s,r){const n=q.instance.device,a=n.getRenderStates();this._prepareSkyBox(n),"scatter"===this._skyType?this._drawScattering(t,i,e,s,r):"skybox"===this._skyType&&this._skyboxTexture?this._drawSkybox(t,e):this._drawSkyColor(t,e),n.setRenderStates(a)}_drawSkyColor(t,e){const i=q.instance.device,s=this._bindgroupSky.color;s.setValue("viewProjMatrix",t.viewProjectionMatrix),s.setValue("worldMatrix",this._skyWorldMatrix),s.setValue("cameraPos",t.getWorldPosition()),s.setValue("color",this._skyColor),s.setValue("srgbOut",i.getFramebuffer()?0:1),i.setProgram(this._programSky.color),i.setBindGroup(0,s),i.setRenderStates(e?this._renderStatesSky:this._renderStatesSkyNoDepthTest),this._primitiveSky.draw()}_drawSkybox(t,e){const i=q.instance.device,s=this._bindgroupSky.skybox;s.setTexture("skyCubeMap",this._skyboxTexture),s.setValue("flip",i.getFramebuffer()&&"webgpu"===i.type?new T(1,-1,1,1):new T(1,1,1,1)),s.setValue("viewProjMatrix",t.viewProjectionMatrix),s.setValue("worldMatrix",this._skyWorldMatrix),s.setValue("cameraPos",t.getWorldPosition()),s.setValue("srgbOut",i.getFramebuffer()?0:1),i.setProgram(this._programSky.skybox),i.setBindGroup(0,s),i.setRenderStates(e?this._renderStatesSky:this._renderStatesSkyNoDepthTest),this._primitiveSky.draw()}_drawScattering(t,e,i,s,r){const n=q.instance.device,a=Math.PI/2-Math.acos(Math.max(-1,Math.min(1,e.y))),o=Ba.getTransmittanceLut(),h=Ba.getSkyViewLut(a),l=r?this._programSky.scatter:this._programSky["scatter-nocloud"],u=r?this._bindgroupSky.scatter:this._bindgroupSky["scatter-nocloud"];u.setValue("sunDir",e),u.setValue("flip",n.getFramebuffer()&&"webgpu"===n.type?new T(1,-1,1,1):new T(1,1,1,1)),u.setValue("viewProjMatrix",t.viewProjectionMatrix),u.setValue("worldMatrix",this._skyWorldMatrix),u.setValue("cameraPos",t.getWorldPosition()),u.setValue("srgbOut",n.getFramebuffer()?0:1),u.setTexture("tLut",o),u.setTexture("skyLut",h),r&&(u.setValue("cloudy",this._cloudy),u.setValue("cloudIntensity",this._cloudIntensity),u.setValue("time",.001*n.frameInfo.elapsedOverall),u.setValue("velocity",this._wind)),u.setValue("drawGround",s?1:0),n.setProgram(l),n.setBindGroup(0,u),n.setRenderStates(i?this._renderStatesSky:this._renderStatesSkyNoDepthTest),this._primitiveSky.draw()}_prepareSkyBox(t){this._programFogScatter||(this._programFogScatter=t.buildRenderProgram({label:"FogScatter",vertex(e){this.rt=e.int().uniform(0),this.$inputs.pos=e.vec2().attrib("position"),this.$outputs.uv=e.vec2(),e.main((function(){this.$builtins.position=e.vec4(this.$inputs.pos,1,1),this.$outputs.uv=e.add(e.mul(this.$inputs.pos.xy,.5),e.vec2(.5)),"webgpu"===t.type&&this.$if(e.notEqual(this.rt,0),(function(){this.$builtins.position.y=e.neg(this.$builtins.position.y)}))}))},fragment(e){this.depthTex=e.tex2D().sampleType("unfilterable-float").uniform(0),this.invProjViewMatrix=e.mat4().uniform(0),this.cameraNearFar=e.vec2().uniform(0),this.cameraPosition=e.vec3().uniform(0),this.apLut=e.tex2D().uniform(0),this.worldScale=e.float().uniform(0),this.sliceDist=e.float().uniform(0),this.sunDir=e.vec3().uniform(0),this.srgbOut=e.int().uniform(0),this.$outputs.outColor=e.vec4(),e.main((function(){this.$l.depthValue=e.textureSample(this.depthTex,this.$inputs.uv),"webgl"===t.type?this.$l.linearDepth=ha(this,this.depthValue):this.$l.linearDepth=this.depthValue.r,this.$l.nonLinearDepth=e.div(e.sub(e.div(this.cameraNearFar.x,this.linearDepth),this.cameraNearFar.y),e.sub(this.cameraNearFar.x,this.cameraNearFar.y)),this.$l.clipSpacePos=e.vec4(e.sub(e.mul(this.$inputs.uv,2),e.vec2(1)),e.sub(e.mul(this.nonLinearDepth,2),1),1),this.$l.hPos=e.mul(this.invProjViewMatrix,this.clipSpacePos),this.$l.hPos=e.div(this.$l.hPos,this.$l.hPos.w),this.$l.viewDir=e.sub(this.hPos.xyz,this.cameraPosition),this.viewDir.y=e.max(0,this.viewDir.y),this.$l.distance=e.mul(e.length(this.viewDir),this.worldScale),this.$l.slice0=e.floor(e.div(this.distance,this.sliceDist)),this.$l.slice1=e.add(this.slice0,1),this.$l.factor=e.sub(e.div(this.distance,this.sliceDist),this.slice0),this.$l.viewNormal=e.normalize(this.viewDir),this.$l.horizonAngle=e.acos(e.clamp(e.dot(e.normalize(this.sunDir.xz),e.normalize(this.viewNormal.xz)),0,1)),this.$l.zenithAngle=e.asin(this.viewNormal.y),this.$l.sliceU=e.max(e.div(this.horizonAngle,2*Math.PI),.5/Ba.aerialPerspectiveSliceZ),this.$l.u0=e.div(e.add(this.slice0,this.sliceU),Ba.aerialPerspectiveSliceZ),this.$l.u1=e.add(this.u0,1/Ba.aerialPerspectiveSliceZ),this.$l.v=e.div(this.zenithAngle,Math.PI/2),this.$l.t0=e.textureSampleLevel(this.apLut,e.vec2(this.u0,this.v),0),this.$l.t1=e.textureSampleLevel(this.apLut,e.vec2(this.u1,this.v),0),this.$l.t=e.mix(this.t0,this.t1,this.factor),this.$outputs.outColor=e.vec4(this.t.rgb,e.sub(1,this.t.a))}))}}),this._bindgroupFogScatter=t.createBindGroup(this._programFogScatter.bindGroupLayouts[0])),this._programFog||(this._programFog=t.buildRenderProgram({label:"Fog",vertex(e){this.rt=e.int().uniform(0),this.$inputs.pos=e.vec2().attrib("position"),this.$outputs.uv=e.vec2(),e.main((function(){this.$builtins.position=e.vec4(this.$inputs.pos,1,1),this.$outputs.uv=e.add(e.mul(this.$inputs.pos.xy,.5),e.vec2(.5)),"webgpu"===t.type&&this.$if(e.notEqual(this.rt,0),(function(){this.$builtins.position.y=e.neg(this.$builtins.position.y)}))}))},fragment(e){this.depthTex=e.tex2D().sampleType("unfilterable-float").uniform(0),this.invProjViewMatrix=e.mat4().uniform(0),this.cameraNearFar=e.vec2().uniform(0),this.cameraPosition=e.vec3().uniform(0),this.fogType=e.int().uniform(0),this.fogColor=e.vec4().uniform(0),this.fogParams=e.vec4().uniform(0),this.srgbOut=e.int().uniform(0),this.$outputs.outColor=e.vec4(),e.main((function(){this.$l.depthValue=e.textureSample(this.depthTex,this.$inputs.uv),"webgl"===t.type?this.$l.linearDepth=ha(this,this.depthValue):this.$l.linearDepth=this.depthValue.r,this.$l.nonLinearDepth=e.div(e.sub(e.div(this.cameraNearFar.x,this.linearDepth),this.cameraNearFar.y),e.sub(this.cameraNearFar.x,this.cameraNearFar.y)),this.$l.clipSpacePos=e.vec4(e.sub(e.mul(this.$inputs.uv,2),e.vec2(1)),e.sub(e.mul(this.nonLinearDepth,2),1),1),this.$l.hPos=e.mul(this.invProjViewMatrix,this.clipSpacePos),this.$l.hPos=e.div(this.$l.hPos,this.$l.hPos.w),this.$l.viewDir=e.sub(this.hPos.xyz,this.cameraPosition),this.$l.fogFactor=Qa.computeFogFactor(this,this.viewDir,this.fogType,this.fogParams),this.$l.color=e.mul(this.fogColor.rgb,this.fogFactor),this.$if(e.equal(this.srgbOut,0),(function(){this.$outputs.outColor=e.vec4(this.color,this.fogFactor)})).$else((function(){this.$outputs.outColor=e.vec4(ca(this,this.color),this.fogFactor)}))}))}}),this._bindgroupFog=t.createBindGroup(this._programFog.bindGroupLayouts[0])),this._programSky.color||(this._programSky.color=t.buildRenderProgram({label:"SolidColorSky",vertex(t){this.$inputs.pos=t.vec3().attrib("position"),this.worldMatrix=t.mat4().uniform(0),this.viewProjMatrix=t.mat4().uniform(0),this.cameraPos=t.vec3().uniform(0),t.main((function(){this.$l.worldDirection=t.mul(this.worldMatrix,t.vec4(this.$inputs.pos,0)).xyz,this.$builtins.position=t.mul(this.viewProjMatrix,t.vec4(t.add(this.worldDirection,this.cameraPos),1)),this.$builtins.position.z=this.$builtins.position.w}))},fragment(t){this.$outputs.outColor=t.vec4(),this.color=t.vec4().uniform(0),this.srgbOut=t.int().uniform(0),t.main((function(){this.$if(t.equal(this.srgbOut,0),(function(){this.$outputs.outColor=t.vec4(this.color.rgb,1)})).$else((function(){this.$outputs.outColor=t.vec4(ca(this,this.color.rgb),1)}))}))}}),this._bindgroupSky.color=t.createBindGroup(this._programSky.color.bindGroupLayouts[0])),this._programSky.scatter||(this._programSky.scatter=Vo._createScatterProgram(t,!0),this._bindgroupSky.scatter=t.createBindGroup(this._programSky.scatter.bindGroupLayouts[0])),this._programSky["scatter-nocloud"]||(this._programSky["scatter-nocloud"]=Vo._createScatterProgram(t,!1),this._bindgroupSky["scatter-nocloud"]=t.createBindGroup(this._programSky["scatter-nocloud"].bindGroupLayouts[0])),this._programSky.skybox||(this._programSky.skybox=t.buildRenderProgram({label:"SkyBoxSky",vertex(t){this.$inputs.pos=t.vec3().attrib("position"),this.$outputs.texCoord=t.vec3(),this.worldMatrix=t.mat4().uniform(0),this.viewProjMatrix=t.mat4().uniform(0),this.cameraPos=t.vec3().uniform(0),this.flip=t.vec4().uniform(0),t.main((function(){this.$outputs.texCoord=this.$inputs.pos,this.$l.worldPos=t.add(this.cameraPos,t.mul(this.worldMatrix,t.vec4(this.$inputs.pos,0)).xyz),this.$builtins.position=t.mul(this.viewProjMatrix,t.vec4(this.worldPos,1),this.flip),this.$builtins.position.z=this.$builtins.position.w}))},fragment(t){this.$outputs.outColor=t.vec4(),this.skyCubeMap=t.texCube().uniform(0),this.srgbOut=t.int().uniform(0),t.main((function(){this.$l.texCoord=t.normalize(this.$inputs.texCoord),this.$l.color=t.textureSampleLevel(this.skyCubeMap,this.texCoord,0).rgb,this.$if(t.equal(this.srgbOut,0),(function(){this.$outputs.outColor=t.vec4(this.color,1)})).$else((function(){this.$outputs.outColor=t.vec4(ca(this,this.color),1)}))}))}}),this._bindgroupSky.skybox=t.createBindGroup(this._programSky.skybox.bindGroupLayouts[0])),this._renderStatesSky||(this._renderStatesSky=t.createRenderStateSet(),this._renderStatesSky.useDepthState().enableTest(!0).enableWrite(!1).setCompareFunc("le"),this._renderStatesSky.useRasterizerState().setCullMode("none")),this._renderStatesSkyNoDepthTest||(this._renderStatesSkyNoDepthTest=t.createRenderStateSet(),this._renderStatesSkyNoDepthTest.useDepthState().enableTest(!1).enableWrite(!1),this._renderStatesSkyNoDepthTest.useRasterizerState().setCullMode("none")),this._renderStatesFog||(this._renderStatesFog=t.createRenderStateSet(),this._renderStatesFog.useRasterizerState().setCullMode("none"),this._renderStatesFog.useBlendingState().enable(!0).setBlendFunc("one","inv-src-alpha"),this._renderStatesFog.useDepthState().enableTest(!1).enableWrite(!1)),this._renderStatesFogScatter||(this._renderStatesFogScatter=t.createRenderStateSet(),this._renderStatesFogScatter.useRasterizerState().setCullMode("none"),this._renderStatesFogScatter.useBlendingState().enable(!0).setBlendFunc("one","inv-src-alpha"),this._renderStatesFogScatter.useDepthState().enableTest(!0).enableWrite(!1).setCompareFunc("gt")),this._nearestSampler||(this._nearestSampler=t.createSampler({magFilter:"nearest",minFilter:"nearest",mipFilter:"none",addressU:"clamp",addressV:"clamp"})),this._vertexLayout||(this._vertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]})),this._primitiveSky||(this._primitiveSky=new ya({size:8}))}static _getSunDir(t){return t?.directionAndCutoff.xyz().scaleBy(-1)??Qa.defaultSunDir}static _createScatterProgram(t,e){return t.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec3().attrib("position"),this.worldMatrix=t.mat4().uniform(0),this.viewProjMatrix=t.mat4().uniform(0),this.cameraPos=t.vec3().uniform(0),this.flip=t.vec4().uniform(0),t.main((function(){this.$outputs.worldDirection=t.mul(this.worldMatrix,t.vec4(this.$inputs.pos,0)).xyz,this.$builtins.position=t.mul(this.viewProjMatrix,t.vec4(t.add(this.$outputs.worldDirection,this.cameraPos),1),this.flip),this.$builtins.position.z=this.$builtins.position.w}))},fragment(t){this.$outputs.outColor=t.vec4(),this.tLut=t.tex2D().uniform(0),this.skyLut=t.tex2D().uniform(0),this.sunDir=t.vec3().uniform(0),e&&(this.cloudy=t.float().uniform(0),this.cloudIntensity=t.float().uniform(0),this.time=t.float().uniform(0),this.velocity=t.vec2().uniform(0)),this.drawGround=t.int().uniform(0),this.srgbOut=t.int().uniform(0),this.viewPos=t.vec3(Ba.viewPosition.x,Ba.viewPosition.y,Ba.viewPosition.z),t.func("getMiePhase",[t.float("cosTheta")],(function(){this.$l.g=t.float(.8),this.$l.scale=t.float(3/(8*Math.PI)),this.$l.gg=t.mul(this.g,this.g),this.$l.num=t.mul(t.sub(1,this.gg),t.add(t.mul(this.cosTheta,this.cosTheta),1)),this.$l.denom=t.mul(t.add(2,this.gg),t.pow(t.sub(t.add(1,this.gg),t.mul(this.g,this.cosTheta,2)),1.5)),this.$return(t.div(t.mul(this.scale,this.num),this.denom))})),t.func("noise",[t.vec3("p"),t.float("t")],(function(){this.p2=t.mul(this.p,.25),this.f=t.mul(Uo(this,this.p2),.5),this.p2=t.mul(this.p2,3.02),this.p2.y=t.sub(this.p2.y,t.mul(this.t,.02)),this.f=t.add(this.f,t.mul(Uo(this,this.p2),.25)),this.p2=t.mul(this.p2,3.03),this.p2.y=t.add(this.p2.y,t.mul(this.t,.01)),this.f=t.add(this.f,t.mul(Uo(this,this.p2),.125)),this.p2=t.mul(this.p2,3.02),this.f=t.add(this.f,t.mul(Uo(this,this.p2),.0625)),this.p2=t.mul(this.p2,3.01),this.f=t.add(this.f,t.mul(Uo(this,this.p2),.03125)),this.p2=t.mul(this.p2,3.01),this.f=t.add(this.f,t.mul(Uo(this,this.p2),.015625)),this.$return(this.f)})),t.func("getValFromSkyLUT",[t.vec3("rayDir"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.viewPos),this.$l.up=t.div(this.viewPos,this.height),this.$l.c=t.div(t.sqrt(t.sub(t.mul(this.height,this.height),t.mul(Ba.groundRadius,Ba.groundRadius))),this.height),this.$l.horizonAngle=t.acos(t.clamp(this.c,-1,1)),this.$l.altitudeAngle=t.sub(this.horizonAngle,t.acos(t.dot(this.rayDir,this.up))),this.$l.azimuthAngle=t.float(),this.$if(t.greaterThan(t.abs(this.altitudeAngle),.5*Math.PI-1e-4),(function(){this.azimuthAngle=0})).$else((function(){this.$l.right=t.cross(this.sunDir,this.up),this.$l.forward=t.cross(this.up,this.right),this.$l.projectedDir=t.normalize(t.sub(this.rayDir,t.mul(this.up,t.dot(this.rayDir,this.up)))),this.$l.sinTheta=t.dot(this.projectedDir,this.right),this.$l.cosTheta=t.dot(this.projectedDir,this.forward),this.azimuthAngle=t.add(t.atan2(this.sinTheta,this.cosTheta),Math.PI)})),this.$l.v=t.add(.5,t.mul(.5,t.sign(this.altitudeAngle),t.sqrt(t.mul(t.abs(this.altitudeAngle),2/Math.PI)))),this.$l.uv=t.vec2(t.div(this.azimuthAngle,2*Math.PI),this.v),this.$return(t.textureSampleLevel(this.skyLut,this.uv,0).rgb)})),t.func("sunWithBloom",[t.vec3("rayDir"),t.vec3("sunDir")],(function(){this.$l.sunSolidAngle=.53*Math.PI/180,this.$l.minSunCosTheta=t.cos(this.sunSolidAngle),this.$l.cosTheta=t.dot(this.rayDir,this.sunDir),this.$if(t.greaterThanEqual(this.cosTheta,this.minSunCosTheta),(function(){this.$return(t.vec3(1))})),this.$l.offset=t.sub(this.minSunCosTheta,this.cosTheta),this.$l.gaussianBloom=t.mul(t.exp(t.mul(this.offset,-5e4)),.5),this.$l.invBloom=t.mul(t.div(1,t.add(.02,t.mul(this.offset,300))),.01),this.$return(t.vec3(t.add(this.gaussianBloom,this.invBloom)))})),t.func("rayIntersectSphere",[t.vec3("ro"),t.vec3("rd"),t.float("rad")],(function(){this.$l.b=t.dot(this.ro,this.rd),this.$l.c=t.sub(t.dot(this.ro,this.ro),t.mul(this.rad,this.rad)),this.$if(t.and(t.greaterThan(this.c,0),t.greaterThan(this.b,0)),(function(){this.$return(t.float(-1))})),this.$l.bb=t.mul(this.b,this.b),this.$l.discr=t.sub(this.bb,this.c),this.$if(t.lessThan(this.discr,0),(function(){this.$return(t.float(-1))})),this.$if(t.greaterThan(this.discr,this.bb),(function(){this.$return(t.sub(t.sqrt(this.discr),this.b))})),this.$return(t.sub(t.neg(t.sqrt(this.discr)),this.b))})),t.func("getValFromTLUT",[t.vec3("pos"),t.vec3("sunDir")],(function(){this.$l.height=t.length(this.pos),this.$l.up=t.div(this.pos,this.height),this.$l.sunCosZenithAngle=t.dot(this.sunDir,this.up),this.$l.uv=t.vec2(t.clamp(t.add(.5,t.mul(this.sunCosZenithAngle,.5)),0,1),t.max(0,t.min(1,t.div(t.sub(this.height,Ba.groundRadius),t.sub(Ba.atmosphereRadius,Ba.groundRadius))))),this.$return(t.textureSampleLevel(this.tLut,this.uv,0).rgb)})),t.main((function(){this.$l.rayDir=t.normalize(this.$inputs.worldDirection),this.$l.sunIntensity=t.sqrt(t.max(0,t.mul(this.sunDir.y,this.rayDir.y))),e&&(this.$l.noiseValue=t.float(),this.$if(t.lessThanEqual(this.rayDir.y,0),(function(){this.noiseValue=0})).$else((function(){this.$l.tMin=t.div(3e3,this.rayDir.y),this.$l.cloudPoint=t.mul(this.rayDir,this.tMin),this.speed=t.mul(t.vec3(this.velocity.x,0,this.velocity.y),this.time),this.$l.noiseScale=t.float(4e-4),this.noiseValue=this.noise(t.mul(t.add(this.cloudPoint,this.speed),this.noiseScale),this.time),this.noiseValue=t.add(this.noiseValue,this.cloudy),this.noiseValue=t.smoothStep(1,t.add(1,this.cloudy),this.noiseValue)})),this.$l.sunColor=t.mul(this.getValFromSkyLUT(this.sunDir,this.sunDir),this.sunIntensity),this.$l.cloudColor=t.mul(this.sunColor.rgb,t.mul(this.noiseValue,this.cloudIntensity))),this.$l.skyRayDir=this.$choice(t.equal(this.drawGround,0),t.normalize(t.vec3(this.rayDir.x,t.max(0,this.rayDir.y),this.rayDir.z)),this.rayDir),this.$l.lum=this.getValFromSkyLUT(this.skyRayDir,this.sunDir),this.$l.sunLum=this.sunWithBloom(this.rayDir,this.sunDir),this.sunLum=t.smoothStep(t.vec3(.002),t.vec3(1),this.sunLum),this.$if(t.greaterThan(t.length(this.sunLum),0),(function(){this.$if(t.greaterThanEqual(this.rayIntersectSphere(this.viewPos,this.rayDir,Ba.groundRadius),0),(function(){this.sunLum=t.vec3(0)})).$else((function(){this.sunLum=t.mul(this.sunLum,this.getValFromTLUT(this.viewPos,this.sunDir))}))})),e?(this.lum=t.add(this.lum,this.sunLum),this.$l.vfactor=t.clamp(t.div(t.sub(this.rayDir.y,.01),t.sub(.03,.01)),0,1),this.$l.factor=t.clamp(t.mul(this.noiseValue,this.vfactor),0,1),this.$l.color=t.mix(this.lum,this.cloudColor,this.factor)):this.$l.color=this.lum,this.color=t.mul(this.color,8),this.color=t.pow(this.color,t.vec3(1.3)),this.color=t.div(this.color,t.add(t.mul(t.smoothStep(0,.2,t.clamp(this.sunDir.y,0,1)),2),.15)),this.$if(t.equal(this.srgbOut,0),(function(){this.$outputs.outColor=t.vec4(this.color,1)})).$else((function(){this.$outputs.outColor=t.vec4(ca(this,this.color),1)}))}))}})}}new R,new x(0,0),S.identity(),S.rotationZ(270*Math.PI/180),S.rotationZ(90*Math.PI/180),S.rotationZ(180*Math.PI/180),new x(2,2),new x(1,2);class Go extends Bo{_projMatrix;_viewMatrix;_viewProjMatrix;_rotationMatrix;_invViewProjMatrix;_clipPlane;_controller;_frustum;_frustumV;_dirty;_sampleCount;_framebuffer;_viewport;_scissor;_clearColor;_clipMask;_oit;_depthPrePass;_commandBufferReuse;_picking;_pickPosX;_pickPosY;_pickResultPromise;_pickResult;constructor(t,e){super(t),this._projMatrix=e||S.identity(),this._viewMatrix=S.identity(),this._viewProjMatrix=S.identity(),this._invViewProjMatrix=S.identity(),this._clipPlane=null,this._dirty=!0,this._controller=null,this._framebuffer=null,this._viewport=null,this._scissor=null,this._clearColor=new T(0,0,0,1),this._clipMask=0,this._sampleCount=1,this._frustum=null,this._frustumV=null,this._oit=null,this._depthPrePass=!1,this._pickPosX=0,this._pickPosY=0,this._pickResult=null,this._commandBufferReuse=!0}get clipPlane(){return this._clipPlane}set clipPlane(t){this._clipPlane=t,this._invalidate(!1)}get depthPrePass(){return this._depthPrePass}set depthPrePass(t){this._depthPrePass=!!t}get commandBufferReuse(){return this._commandBufferReuse}set commandBufferReuse(t){this._commandBufferReuse=!!t}get enablePicking(){return this._picking}set enablePicking(t){this._picking=!!t}get pickPosX(){return this._pickPosX}set pickPosX(t){this._pickPosX=t}get pickPosY(){return this._pickPosY}set pickPosY(t){this._pickPosY=t}get pickResult(){return this._pickResult}set pickResult(t){this._pickResult=t}get pickResultAsync(){return this._pickResultPromise}set pickResultAsync(t){this._pickResultPromise=t}get sampleCount(){return this._sampleCount}set sampleCount(t){1!==t&&4!==t?console.error(`Invalid sample count: ${t}`):this._sampleCount=t}get oit(){return this._oit}set oit(t){this._oit=t}get clipMask(){return this._clipMask}set clipMask(t){this._clipMask=t}get framebuffer(){return this._framebuffer}set framebuffer(t){this._framebuffer=t??null}get viewport(){return this._viewport?[...this._viewport]:null}set viewport(t){this._viewport=t?.slice()??null}get scissor(){return this._scissor?[...this._scissor]:null}set scissor(t){this._scissor=t?.slice()??null}get clearColor(){return this._clearColor}set clearColor(t){t?this._clearColor.set(t):this._clearColor=null}handleEvent(t,e){let i=!1;return this._controller&&("pointerdown"===(e=e??t.type)?i=this._controller.onMouseDown(t):"pointerup"===e?i=this._controller.onMouseUp(t):"pointermove"===e?i=this._controller.onMouseMove(t):"wheel"===e?i=this._controller.onMouseWheel(t):"keydown"===e?i=this._controller.onKeyDown(t):"keyup"===e&&(i=this._controller.onKeyUp(t)),i&&t.preventDefault()),i}constructRay(t,e){const i=this.viewport?this.viewport[2]:q.instance.device.getViewport().width,s=this.viewport?this.viewport[3]:q.instance.device.getViewport().height,r=new T(2*t/i-1,1-2*e/s,1,1),n=this.invViewProjectionMatrix.transform(r);n.scaleBy(1/n.w);const a=this.getWorldPosition(),o=b.sub(n.xyz(),a).inplaceNormalize();return new P(a,o)}lookAt(t,e,i){return this.setLocalTransform(S.lookAt(t,e,i))}lookAtCubeFace(t,e){return this.setLocalTransform(S.lookAtCubeFace(t,e??this.position))}setPerspective(t,e,i,s){return this._projMatrix.perspective(t,e,i,s),this._invalidate(!0),this}setOrtho(t,e,i,s,r,n){return this._projMatrix.ortho(t,e,i,s,r,n),this._invalidate(!0),this}setProjectionMatrix(t){t&&t!==this._projMatrix&&(this._projMatrix.set(t),this._invalidate(!0))}getProjectionMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._projMatrix}getRotationMatrix(){const t=new S;this.worldMatrix.decompose(null,t,null);const e=t.getRow(0).xyz().scaleBy(-1),i=t.getRow(1).xyz(),s=t.getRow(2).xyz().scaleBy(-1);return t.setRow(0,new T(e.x,e.y,e.z,0)),t.setRow(1,new T(i.x,i.y,i.z,0)),t.setRow(2,new T(s.x,s.y,s.z,0)),t}get viewMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._viewMatrix}get viewProjectionMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._viewProjMatrix}get invViewProjectionMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._invViewProjMatrix}get frustum(){return this._dirty&&(this._dirty=!1,this._compute()),this._frustum}get frustumViewSpace(){return this._dirty&&(this._dirty=!1,this._compute()),this._frustumV||(this._frustumV=new M(this._projMatrix)),this._frustumV}get controller(){return this._controller||null}set controller(t){this.setController(t)}isCamera(){return!0}getNearPlane(){return this._projMatrix.getNearPlane()}getFarPlane(){return this._projMatrix.getFarPlane()}getFOV(){return this._projMatrix.getFov()}getTanHalfFovy(){return this._projMatrix.getTanHalfFov()}getAspect(){return this._projMatrix.getAspect()}render(t,e){const i=q.instance.device;i.pushDeviceStates(),i.reverseVertexWindingOrder(!1),i.setFramebuffer(this._framebuffer),gh.setClearColor(this._clearColor),gh.renderScene(t,this,e),i.popDeviceStates()}updateController(){this._controller?.update()}resetController(){this._controller?.reset()}setController(t){if(this._controller!==t){if(t&&t._getCamera()&&t._getCamera()!==this)throw new Error("Camera.setController failed: one camera controller object cannot be assigned to multiple camera");this._controller?._setCamera(null),this._controller=t,this._controller?._setCamera(this)}return this}_invalidate(t){this._dirty=!0,t&&(this._frustumV=null)}_compute(){this._computeProj(),S.invertAffine(this.worldMatrix,this._viewMatrix),S.multiply(this._projMatrix,this._viewMatrix,this._viewProjMatrix),S.invert(this._viewProjMatrix,this._invViewProjMatrix),this._frustum?this._frustum.initWithMatrix(this._viewProjMatrix):this._frustum=new M(this._viewProjMatrix)}_computeProj(){}_onTransformChanged(t){super._onTransformChanged(t),this._invalidate(!1)}dispose(){this.setController(null),this._projMatrix=null,this._viewMatrix=null,this._viewProjMatrix=null}}class Xo{_resourceDirty;constructor(){this._resourceDirty=!0}invalidateResource(){this._resourceDirty=!0}updateResources(t){this.doUpdateResources(t)}}const Wo=[[.511749,.547686],[.58929,.257224],[.165018,.57663],[.407692,.742285],[.707012,.646523],[.31463,.466825],[.801257,.485186],[.418136,.146517],[.579889,.0368284],[.79801,.140114],[-.0413185,.371455],[-.0529108,.627352],[.0821375,.882071],[.17308,.301207],[-.120452,.867216],[.371096,.916454],[-.178381,.146101],[-.276489,.550525],[.12542,.126643],[-.296654,.286879],[.261744,-.00604975],[-.213417,.715776],[.425684,-.153211],[-.480054,.321357],[-.0717878,-.0250567],[-.328775,-.169666],[-.394923,.130802],[-.553681,-.176777],[-.722615,.120616],[-.693065,.309017],[.603193,.791471],[-.0754941,-.297988],[.109303,-.156472],[.260605,-.280111],[.129731,-.487954],[-.537315,.520494],[-.42758,.800607],[.77309,-.0728102],[.908777,.328356],[.985341,.0759158],[.947536,-.11837],[-.103315,-.610747],[.337171,-.584],[.210919,-.720055],[.41894,-.36769],[-.254228,-.49368],[-.428562,-.404037],[-.831732,-.189615],[-.922642,.0888026],[-.865914,.427795],[.706117,-.311662],[.545465,-.520942],[-.695738,.664492],[.389421,-.899007],[.48842,-.708054],[.760298,-.62735],[-.390788,-.707388],[-.591046,-.686721],[-.769903,-.413775],[-.604457,-.502571],[-.557234,.00451362],[.147572,-.924353],[-.0662488,-.892081],[.863832,-.4072]];function Ho(t){return t.$builder.div(1,Qa.getShadowCameraParams(t).z)}function jo(t,e,i){const s="Z_computeShadowMapDepth",r=t.$builder;return r.func(s,[r.vec3("worldPos")],(function(){mt(i)?this.$return(r.vec4(r.emulateDepthClamp?r.clamp(t.$inputs.clamppedDepth,0,1):t.$builtins.fragCoord.z,0,0,1)):(this.$l.depth=r.float(),this.$l.lightType=Qa.getLightTypeForShadow(this),this.$if(r.equal(this.lightType,Ia),(function(){this.depth=r.emulateDepthClamp?r.clamp(this.$inputs.clamppedDepth,0,1):this.$builtins.fragCoord.z})).$elseif(r.equal(this.lightType,Da),(function(){this.$l.lightSpacePos=r.mul(Qa.getLightViewMatrixForShadow(this),r.vec4(this.worldPos,1)),this.depth=r.clamp(r.div(r.length(this.lightSpacePos.xyz),Qa.getLightPositionAndRangeForShadow(this).w),0,1)})).$else((function(){this.$l.lightSpacePos=r.mul(Qa.getLightViewMatrixForShadow(this),r.vec4(this.worldPos,1)),this.depth=r.clamp(r.div(r.neg(this.lightSpacePos.z),Qa.getLightPositionAndRangeForShadow(this).w),0,1)})),this.$return("rgba8unorm"===i?la(this,this.depth):r.vec4(this.depth,0,0,1)))})),r.getGlobalScope()[s](e)}function qo(t,e){const i="lib_computeReceiverPlaneDepthBias",s=t.$builder;return s.func(i,[s.vec4("coords")],(function(){this.$l.dx=s.dpdx(this.coords),this.$l.dy=s.dpdy(this.coords),this.$l.biasMultiply=s.float(1),this.$l.uv=s.vec2(s.sub(s.mul(this.dy.y,this.dx.z),s.mul(this.dx.y,this.dy.z)),s.sub(s.mul(this.dx.x,this.dy.z),s.mul(this.dy.x,this.dx.z))),this.$l.uv=s.mul(this.$l.uv,s.div(this.biasMultiply,s.sub(s.mul(this.dx.x,this.dy.y),s.mul(this.dx.y,this.dy.x)))),this.$l.minFractionalError=s.float(.01),this.$l.fractionalSamplingError=s.dot(s.vec2(Ho(this)),s.abs(this.$l.uv)),this.$l.staticBias=s.min(this.$l.fractionalSamplingError,this.$l.minFractionalError),this.$return(s.vec3(this.$l.uv,this.$l.staticBias))})),s.getGlobalScope()[i](e)}function Yo(t,e,i,s,r,n){const a=n?"lib_sampleShadowMapCascadePCF":"lib_sampleShadowMapPCF",o=t.$builder,h=mt(e);return o.func(a,[o.vec2("coords"),o.float("z"),o.vec2("offset"),...n?[o.int("cascade")]:[]],(function(){const t=this.z,i=o.add(this.coords,this.offset);h?this.$return(n&&"webgl"!==q.instance.device.type?o.textureArraySampleCompareLevel(Qa.getShadowMap(this),i,this.cascade,t):o.textureSampleCompareLevel(Qa.getShadowMap(this),i,t)):(this.$l.shadowTex=n&&"webgl"!==q.instance.device.type?o.textureArraySampleLevel(Qa.getShadowMap(this),i,this.cascade,0):o.textureSampleLevel(Qa.getShadowMap(this),i,0),"rgba8unorm"===e&&(this.shadowTex.x=ha(this,this.shadowTex)),this.$return(o.step(t,this.shadowTex.x)))})),o.getGlobalScope()[a](i,r,s,...n?[n]:[])}function Zo(t,e,i,s,r,n){const a="lib_sampleShadowMap",o=t.$builder,h=mt(i);return o.func(a,[e===Da?o.vec3("coords"):o.vec2("coords"),o.float("z"),...n?[o.int("cascade")]:[]],(function(){e===Da?h?this.$return(o.clamp(o.textureSampleCompareLevel(Qa.getShadowMap(this),this.coords,this.z),0,1)):(this.$l.shadowTex=o.textureSampleLevel(Qa.getShadowMap(this),this.coords,0),"rgba8unorm"===i&&(this.shadowTex.x=ha(this,this.shadowTex)),this.$return(o.step(this.z,this.shadowTex.x))):h?this.$return(n&&"webgl"!==q.instance.device.type?o.textureArraySampleCompareLevel(Qa.getShadowMap(this),this.coords,this.cascade,this.z):o.textureSampleCompareLevel(Qa.getShadowMap(this),this.coords,this.z)):(this.$l.shadowTex=n&&"webgl"!==q.instance.device.type?o.textureArraySampleLevel(Qa.getShadowMap(this),this.coords,this.cascade,0):o.textureSampleLevel(Qa.getShadowMap(this),this.coords,0),"rgba8unorm"===i&&(this.shadowTex.x=ha(this,this.shadowTex)),this.$return(o.step(this.z,this.shadowTex.x)))})),n?o.getGlobalScope()[a](s,r,n):o.getGlobalScope()[a](s,r)}function Ko(t,e,i){const s="lib_chebyshevUpperBound",r=t.$builder;return r.func(s,[r.float("distance"),r.vec2("occluder")],(function(){this.$l.shadow=r.float(1),this.$l.test=r.step(this.distance,this.occluder.x),this.$if(r.notEqual(this.test,1),(function(){this.$l.d=r.sub(this.distance,this.occluder.x),this.$l.variance=r.max(r.mul(this.occluder.y,this.occluder.y),0);const t=Qa.getDepthBiasValues(this).z;this.shadow=r.div(this.variance,r.add(this.variance,r.mul(this.d,this.d))),this.shadow=r.clamp(r.div(r.sub(this.shadow,t),r.sub(1,t)),0,1)})),this.$return(this.shadow)})),r.getGlobalScope()[s](e,i)}function Qo(t,e,i,s,r){const n="lib_filterShadowVSM",a=t.$builder;return a.func(n,[a.vec4("texCoord"),...r?[a.int("cascade")]:[]],(function(){e===Da?(this.$l.shadowTex=a.textureSampleLevel(Qa.getShadowMap(this),this.texCoord.xyz,0),this.$return(Ko(this,this.texCoord.w,"rgba8unorm"===i?ua(this,this.shadowTex):this.shadowTex.rg))):("webgl"!==q.instance.device.type&&r?this.$l.shadowTex=a.textureArraySampleLevel(Qa.getShadowMap(this),this.texCoord.xy,this.cascade,0):this.$l.shadowTex=a.textureSampleLevel(Qa.getShadowMap(this),this.texCoord.xy,0),this.$return(Ko(this,this.texCoord.z,"rgba8unorm"===i?ua(this,this.shadowTex):this.shadowTex.rg)))})),a.getGlobalScope()[n](s,...r?[r]:[])}function Jo(t,e,i,s,r){const n="lib_filterShadowESM",a=t.$builder;return a.func(n,[e===Da?a.vec3("shadowVertex"):a.vec4("shadowVertex"),...r?[a.int("cascade")]:[]],(function(){e===Da?(this.$l.depth=a.div(a.length(this.shadowVertex.xyz),Qa.getLightPositionAndRangeForShadow(this).w),this.$l.shadowTex=a.textureSampleLevel(Qa.getShadowMap(this),this.shadowVertex.xyz,0),"rgba8unorm"===i&&(this.shadowTex.x=ha(this,this.shadowTex))):(r&&"webgl"!==q.instance.device.type?this.$l.shadowTex=a.textureArraySampleLevel(Qa.getShadowMap(this),this.shadowVertex.xy,this.cascade,0):this.$l.shadowTex=a.textureSampleLevel(Qa.getShadowMap(this),this.shadowVertex.xy,0),"rgba8unorm"===i&&(this.shadowTex.x=ha(this,this.shadowTex)),e===$a?(this.$l.nearFar=Qa.getShadowCameraParams(this).xy,this.$l.depth=Qa.nonLinearDepthToLinearNormalized(this,this.shadowVertex.z,this.nearFar)):this.$l.depth=this.shadowVertex.z);const t=Qa.getDepthBiasValues(this).z;this.$return(a.clamp(a.exp(a.min(87,a.mul(t,a.sub(this.shadowTex.x,this.depth)))),0,1))})),a.getGlobalScope()[n](s,...r?[r]:[])}function th(t,e,i,s,r,n,a){const o=`lib_filterShadowPCF${s}x${s}`,h=t.$builder;return h.func(o,[h.vec4("texCoord"),...n?[h.vec3("receiverPlaneDepthBias")]:[],...a?[h.int("cascade")]:[]],(function(){this.$l.lightDepth=this.texCoord.z,n&&(this.lightDepth=h.sub(this.lightDepth,this.receiverPlaneDepthBias.z));const t=Ho(this);this.$l.uv=h.add(h.mul(this.texCoord.xy,h.vec2(function(t){return Qa.getShadowCameraParams(t).z}(this))),h.vec2(0)),this.$l.st=h.fract(this.uv),this.$l.baseUV=h.sub(h.floor(this.uv),h.vec2(.5)),this.baseUV=h.mul(this.baseUV,t),this.$l.shadow=h.float(0),3===s?(this.$l.uvw0=h.sub(h.vec2(3),h.mul(2,this.st)),this.$l.uvw1=h.add(h.vec2(1),h.mul(2,this.st)),this.$l.u=h.mul(h.vec2(h.sub(h.div(h.sub(2,this.st.x),this.uvw0.x),1),h.add(h.div(this.st.x,this.uvw1.x),1)),t),this.$l.v=h.mul(h.vec2(h.sub(h.div(h.sub(2,this.st.y),this.uvw0.y),1),h.add(h.div(this.st.y,this.uvw1.y),1)),t),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.x,this.v.x),this.lightDepth,this.cascade),this.uvw0.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.y,this.v.x),this.lightDepth,this.cascade),this.uvw1.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.x,this.v.y),this.lightDepth,this.cascade),this.uvw0.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.y,this.v.y),this.lightDepth,this.cascade),this.uvw1.x,this.uvw1.y)),this.shadow=h.div(this.shadow,16)):5===s?(this.$l.uvw0=h.sub(h.vec2(4),h.mul(this.st,3)),this.$l.uvw1=h.vec2(7),this.$l.uvw2=h.add(h.vec2(1),h.mul(this.st,3)),this.$l.u=h.mul(h.vec3(h.sub(h.div(h.sub(3,h.mul(this.st.x,2)),this.uvw0.x),2),h.div(h.add(this.st.x,3),this.uvw1.x),h.add(h.div(this.st.x,this.uvw2.x),2)),t),this.$l.v=h.mul(h.vec3(h.sub(h.div(h.sub(3,h.mul(this.st.y,2)),this.uvw0.y),2),h.div(h.add(this.st.y,3),this.uvw1.y),h.add(h.div(this.st.y,this.uvw2.y),2)),t),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.x,this.v.x),this.lightDepth,this.cascade),this.uvw0.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.y,this.v.x),this.lightDepth,this.cascade),this.uvw1.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.z,this.v.x),this.lightDepth,this.cascade),this.uvw2.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.x,this.v.y),this.lightDepth,this.cascade),this.uvw0.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.y,this.v.y),this.lightDepth,this.cascade),this.uvw1.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.z,this.v.y),this.lightDepth,this.cascade),this.uvw2.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.x,this.v.z),this.lightDepth,this.cascade),this.uvw0.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.y,this.v.z),this.lightDepth,this.cascade),this.uvw1.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.vec2(this.u.z,this.v.z),this.lightDepth,this.cascade),this.uvw2.x,this.uvw2.y)),this.shadow=h.div(this.shadow,144)):7===s&&(this.$l.uvw0=h.sub(h.mul(this.st,5),h.vec2(6)),this.$l.uvw1=h.sub(h.mul(this.st,11),h.vec2(28)),this.$l.uvw2=h.sub(h.mul(this.st,-11),h.vec2(17)),this.$l.uvw3=h.sub(h.mul(this.st,-5),1),this.$l.u=h.vec4(h.sub(h.div(h.sub(h.mul(this.st.x,4),5),this.uvw0.x),3),h.sub(h.div(h.sub(h.mul(this.st.x,4),16),this.uvw1.x),1),h.add(h.div(h.sub(h.mul(this.st.x,-7),5),this.uvw2.x),1),h.add(h.div(h.neg(this.st.x),this.uvw3.x),3)),this.$l.v=h.vec4(h.sub(h.div(h.sub(h.mul(this.st.y,4),5),this.uvw0.y),3),h.sub(h.div(h.sub(h.mul(this.st.y,4),16),this.uvw1.y),1),h.add(h.div(h.sub(h.mul(this.st.y,-7),5),this.uvw2.y),1),h.add(h.div(h.neg(this.st.y),this.uvw3.y),3)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.x),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.x),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.x),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.x),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.y),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.y),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.y),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.y),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.z),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.z),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.z),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.z),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.w),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw3.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.w),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw3.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.w),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw3.y)),this.shadow=h.add(this.shadow,h.mul(Yo(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.w),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw3.y)),this.shadow=h.div(this.shadow,2704)),this.$return(this.shadow)})),h.getGlobalScope()[o](r,...n?[n]:[],...a?[a]:[])}function eh(t,e,i,s,r,n,a){const o="lib_filterShadowPoissonDisc",h=t.$builder;return h.func(o,[h.vec4("texCoord"),...n?[h.vec3("receiverPlaneDepthBias")]:[],...a?[h.int("cascade")]:[]],(function(){this.$l.lightDepth=this.texCoord.z,n&&(this.lightDepth=h.sub(this.lightDepth,this.receiverPlaneDepthBias.z)),this.$l.duv=h.vec2(),this.$l.filterRadius=h.mul(Ho(this),function(t){return Qa.getDepthBiasValues(t).z}(this)),this.$l.matrix=function(t,e){const i="lib_getRandomRotationMatrix",s=t.$builder;return s.func(i,[s.vec2("fragCoord")],(function(){this.$l.randomAngle=s.mul(function(t,e){const i=t.$builder;return i.fract(i.mul(52.9829189,i.fract(i.dot(e,i.vec2(.06711056,.00583715)))))}(this,e),2*Math.PI),this.$l.randomBase=s.vec2(s.cos(this.randomAngle),s.sin(this.randomAngle)),this.$return(s.mat2(this.randomBase.x,this.randomBase.y,s.neg(this.randomBase.y),this.randomBase.x))})),s.getGlobalScope()[i](e)}(this,this.$builtins.fragCoord.xy),this.$l.shadow=h.float(0);for(let t=0;t<s;t++){this.duv=h.mul(this.matrix,h.mul(h.vec2(Wo[t][0],Wo[t][1]),this.filterRadius));const s=n?h.add(this.lightDepth,h.dot(this.duv,this.receiverPlaneDepthBias.xy)):this.lightDepth;this.shadow=h.add(this.shadow,Zo(this,e,i,h.add(this.texCoord.xy,this.duv),s,this.cascade))}this.shadow=h.div(this.shadow,s),this.$return(this.shadow)})),h.getGlobalScope()[o](r,...n?[n]:[],...a?[a]:[])}class ih extends Xo{static instance=new ih;constructor(){super()}resourceDirty(){return!1}getType(){return"hard"}getShadowMapBorder(t){return 0}getShadowMap(t){return this.useNativeShadowMap(t)?t.shadowMapFramebuffer.getDepthAttachment():t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(this.useNativeShadowMap(t))||null}postRenderShadowMap(){}releaseTemporalResources(t){}getDepthScale(){return 1}setDepthScale(t){}getShaderHash(){return""}getShadowMapColorFormat(t){if(this.useNativeShadowMap(t))return null;{const t=q.instance.device;return"webgl"===t.type?t.getDeviceCaps().textureCaps.supportFloatColorBuffer?"rgba32f":t.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"rgba16f":"rgba8unorm":"r32f"}}getShadowMapDepthFormat(t){return"webgl"===q.instance.device.type?"d24s8":"d32f"}computeShadowMapDepth(t,e,i){return jo(e,i,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const n="lib_computeShadowCSM",a=e.$builder,o=this;return a.func(n,[a.vec4("shadowVertex"),a.float("NdotL"),a.int("split")],(function(){const e="rgba8unorm"!==t.shadowMap.format;this.$l.shadowCoord=a.div(this.shadowVertex.xyz,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord.xyz,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$if(this.inShadow,(function(){this.$l.shadowBias=dh.computeShadowBiasCSM(t,this,this.NdotL,this.split),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),o.useNativeShadowMap(t)?t.shadowMap.isTexture2DArray()?this.shadow=a.textureArraySampleCompareLevel(Qa.getShadowMap(this),this.shadowCoord.xy,this.split,this.shadowCoord.z):this.shadow=a.textureSampleCompareLevel(Qa.getShadowMap(this),this.shadowCoord.xy,this.shadowCoord.z):(t.shadowMap.isTexture2DArray()?this.$l.shadowTex=a.textureArraySampleLevel(Qa.getShadowMap(this),this.shadowCoord.xy,this.split,0):this.$l.shadowTex=a.textureSampleLevel(Qa.getShadowMap(this),this.shadowCoord.xy,0),e||(this.shadowTex.x=ha(this,this.shadowTex)),this.shadow=a.step(this.shadowCoord.z,this.shadowTex.x))})),this.$return(this.shadow)})),a.getGlobalScope()[n](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",n=e.$builder,a=this;return n.func(r,[n.vec4("shadowVertex"),n.float("NdotL")],(function(){const e="rgba8unorm"!==t.shadowMap.format;t.lightType===Da?(this.$l.dir=n.sub(this.shadowVertex.xyz,Qa.getLightPositionAndRangeForShadow(this).xyz),a.useNativeShadowMap(t)?(this.$l.nearFar=Qa.getShadowCameraParams(this).xy,this.$l.maxZ=n.max(n.max(n.abs(this.dir.x),n.abs(this.dir.y)),n.abs(this.dir.z)),this.$l.distance=Qa.linearDepthToNonLinear(this,this.maxZ,this.nearFar),this.$l.shadowBias=dh.computeShadowBias(t,this,n.div(this.maxZ,Qa.getLightPositionAndRangeForShadow(this).w),this.NdotL,!0),this.$return(n.textureSampleCompareLevel(Qa.getShadowMap(this),this.dir,n.sub(this.distance,this.shadowBias)))):(this.$l.distance=n.div(n.length(this.dir),Qa.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=dh.computeShadowBias(t,this,this.distance,this.NdotL,!0),this.$l.shadowTex=n.textureSampleLevel(Qa.getShadowMap(this),this.dir,0),e||(this.shadowTex.x=ha(this,this.shadowTex)),this.distance=n.sub(this.distance,this.shadowBias),this.$return(n.step(this.distance,this.shadowTex.x)))):(this.$l.shadowCoord=n.div(this.shadowVertex.xyz,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord.xyz,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$if(this.inShadow,(function(){a.useNativeShadowMap(t)?(this.$l.shadowBias=dh.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),this.shadow=n.textureSampleCompareLevel(Qa.getShadowMap(this),this.shadowCoord.xy,this.shadowCoord.z)):(t.lightType===$a?(this.$l.nearFar=Qa.getShadowCameraParams(this).xy,this.shadowCoord.z=Qa.nonLinearDepthToLinearNormalized(this,this.shadowCoord.z,this.nearFar),this.$l.shadowBias=dh.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!0)):this.$l.shadowBias=dh.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),this.$l.shadowTex=n.textureSampleLevel(Qa.getShadowMap(this),this.shadowCoord.xy,0),e||(this.shadowTex.x=ha(this,this.shadowTex)),this.shadow=n.step(this.shadowCoord.z,this.shadowTex.x))})),this.$return(this.shadow))})),n.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return"webgl"!==q.instance.device.type}}class sh extends pa{_phase;_kernelSize;_sigma;_blurSize;_logSpace;_logSpaceMultiplier;_depthTex;_depthCutoff;constructor(t,e,i,s){super(),this._phase=t,this._kernelSize=e,this._sigma=i,this._blurSize=s,this._logSpace=!1,this._logSpaceMultiplier=1,this._depthTex=null,this._depthCutoff=.7}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}get kernelSize(){return this._kernelSize}set kernelSize(t){this._kernelSize!==t&&(this._kernelSize=t,this.invalidateHash())}get logSpace(){return this._logSpace}set logSpace(t){this._logSpace!==!!t&&(this._logSpace=!!t,this.invalidateHash())}get logSpaceMultiplier(){return this._logSpaceMultiplier}set logSpaceMultiplier(t){this._logSpaceMultiplier=t}get depthTexture(){return this._depthTex}set depthTexture(t){this._depthTex!==t&&(t&&this._depthTex||this.invalidateHash(),this._depthTex=t)}get depthCutoff(){return this._depthCutoff}set depthCutoff(t){this._depthCutoff=t}setup(t,e){const i=t.$builder;if("fragment"===i.shaderKind){if(this._depthTex&&(t.depthTex=i.tex2D().sampleType("unfilterable-float").uniform(0),t.depthCutoff=i.float().uniform(0)),t.sigma=i.float().uniform(0),t.blurSize=i.float().uniform(0),this._logSpace&&"horizonal"===this._phase&&(t.multiplier=i.float().uniform(0)),"horizonal"!==this._phase&&"vertical"!==this._phase)throw new Error(`GaussianBlurFilter.setupFilter() failed: invalid phase: ${this._phase}`);if(!Number.isInteger(this._kernelSize)||this._kernelSize<0||0==(1&this._kernelSize))throw new Error(`GaussianBlurFilter.setupFilter() failed: invalid kernel size: ${this._kernelSize}`);t.blurMultiplyVec="cube"===e?"horizonal"===this._phase?i.vec3(1,0,0):i.vec3(0,1,0):"horizonal"===this._phase?i.vec2(1,0):i.vec2(0,1),t.numBlurPixelsPerSide=i.float((this._kernelSize+1)/2)}}setUniforms(t){t.setValue("sigma",this._sigma),t.setValue("blurSize",this._blurSize),this._logSpace&&"horizonal"===this._phase&&t.setValue("multiplier",this._logSpaceMultiplier),this._depthTex&&(t.setTexture("depthTex",this._depthTex),t.setValue("depthCutoff",this._depthCutoff))}filter(t,e,i,s,r,n){const a=this,o=t.$builder;return a._depthTex&&o.func("getLinearDepth",[o.vec2("uv")],(function(){this.$l.depthValue=o.textureSample(this.depthTex,this.uv),"webgl"===o.getDevice().type?this.$return(ha(this,this.depthValue)):this.$return(this.depthValue.r)})),t.incrementalGaussian=o.vec3(),t.incrementalGaussian.x=o.div(1,o.mul(t.sigma,Math.sqrt(2*Math.PI))),t.incrementalGaussian.y=o.exp(o.div(-.5,o.mul(t.sigma,t.sigma))),t.incrementalGaussian.z=o.mul(t.incrementalGaussian.y,t.incrementalGaussian.y),t.coefficientSum=o.float(0),t.minExpValue=o.vec4(87,87,87,87),t.d0=a.readTexel(t,e,i,s,r,n),a._logSpace?t.avgValue=o.vec4(t.incrementalGaussian.x):t.avgValue=o.mul(a.readTexel(t,e,i,s,r,n),t.incrementalGaussian.x),a._depthTex&&(t.centerDepth=t.getLinearDepth(s)),t.coefficientSum=o.add(t.coefficientSum,t.incrementalGaussian.x),t.incrementalGaussian=o.vec3(o.mul(t.incrementalGaussian.xy,t.incrementalGaussian.yz),t.incrementalGaussian.z),t.$for(o.float("i"),1,t.numBlurPixelsPerSide,(function(){this.$l.uv1=o.sub(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),this.$l.d1=o.vec4(),a._depthTex?(this.$l.depth1=this.getLinearDepth(this.uv1),this.$l.test1=o.lessThan(o.abs(o.sub(this.depth1,this.centerDepth)),this.depthCutoff)):this.$l.test1=!0,this.$if(this.test1,(function(){this.d1=a.readTexel(t,e,i,this.uv1,r,n)})),this.$l.uv2=o.add(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),this.$l.d2=o.vec4(),a._depthTex?(this.$l.depth2=this.getLinearDepth(this.uv2),this.$l.test2=o.lessThan(o.abs(o.sub(this.depth2,this.centerDepth)),this.depthCutoff)):this.$l.test2=!0,this.$if(this.test2,(function(){this.d2=a.readTexel(t,e,i,o.add(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),r,n)})),a._logSpace?"horizonal"===a._phase?(this.$if(this.test1,(function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.mul(o.sub(this.d1,this.d0),this.multiplier))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)})),this.$if(this.test2,(function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.mul(o.sub(this.d2,this.d0),this.multiplier))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)}))):(this.$if(this.test1,(function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.sub(this.d1,this.d0))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)})),this.$if(this.test2,(function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.sub(this.d2,this.d0))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)}))):(this.$if(this.test1,(function(){this.avgValue=o.add(this.avgValue,o.mul(this.d1,this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)})),this.$if(this.test2,(function(){this.avgValue=o.add(this.avgValue,o.mul(this.d2,this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)}))),this.incrementalGaussian=o.vec3(o.mul(this.incrementalGaussian.xy,this.incrementalGaussian.yz),this.incrementalGaussian.z)})),t.$l.outColor=o.div(t.avgValue,t.coefficientSum),a._logSpace&&("horizonal"===a._phase?t.outColor=o.add(o.mul(t.multiplier,t.d0),o.log(t.outColor)):t.outColor=o.add(t.d0,o.log(t.outColor))),t.outColor}calcHash(){return`${this._depthTex?1:0}-${this._phase}-${this._kernelSize}-${Number(!!this._logSpace)}`}}class rh extends sh{_packFloat;get packFloat(){return this._packFloat}set packFloat(t){this._packFloat!==!!t&&(this._packFloat=!!t,this.invalidateHash())}readTexel(t,e,i,s,r,n){const a=t.$builder,o=super.readTexel(t,e,i,s,r,n);return this.packFloat?a.vec4(ha(t,o),0,0,1):o}writeTexel(t,e,i,s){const r=super.writeTexel(t,e,i,s);return this.packFloat?la(t,r.r):r}calcHash(){return`${super.calcHash()}-${Number(this.packFloat)}`}}class nh extends Xo{_depthScale;_blur;_kernelSize;_blurSize;_logSpace;_blitterH;_blitterV;_mipmap;constructor(t,e,i){super(),this._blur=!0,this._depthScale=i??500,this._kernelSize=t??5,this._blurSize=e??1,this._logSpace=!0,this._mipmap=!0,this._blitterH=new rh("horizonal",this._kernelSize,4,1/1024),this._blitterV=new rh("vertical",this._kernelSize,4,1/1024)}resourceDirty(){return this._resourceDirty}get blur(){return this._blur}set blur(t){this._blur!==!!t&&(this._blur=!!t,this._resourceDirty=!0)}get mipmap(){return this._mipmap}set mipmap(t){this._mipmap!==!!t&&(this._mipmap=!!t,this._blur&&(this._resourceDirty=!0))}get kernelSize(){return this._kernelSize}set kernelSize(t){this._kernelSize=t}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}get logSpace(){return this._logSpace}set logSpace(t){this._logSpace=!!t}getType(){return"esm"}getShadowMapBorder(t){return this._blur?Math.ceil((this._kernelSize+1)/2*this._blurSize):0}getShadowMap(t){const e=t.implData;return e?e.blurFramebuffer2.getColorAttachments()[0]:t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){t.implData={blurFramebuffer:null,blurFramebuffer2:null};const e=this.getShadowMapColorFormat(t),i=t.shadowMapFramebuffer.getColorAttachments()[0].width,s=t.shadowMapFramebuffer.getColorAttachments()[0].height;this._blur&&(t.implData={blurFramebuffer:dh.fetchTemporalFramebuffer(!0,t.lightType,t.numShadowCascades,i,s,e,null,!1),blurFramebuffer2:dh.fetchTemporalFramebuffer(!0,t.lightType,t.numShadowCascades,i,s,e,null,!0)}),t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(!1)??null}postRenderShadowMap(t){if(t.implData){const e=t.implData,i=t.shadowMapFramebuffer.getColorAttachments()[0];this._blitterH.blurSize=this._blurSize/i.width,this._blitterH.kernelSize=this._kernelSize,this._blitterH.logSpace=this._logSpace,this._blitterH.packFloat="rgba8unorm"===i.format,this._blitterV.blurSize=this._blurSize/i.height,this._blitterV.kernelSize=this._kernelSize,this._blitterV.logSpace=this._logSpace,this._blitterV.packFloat="rgba8unorm"===i.format,this._blitterH.blit(i,e.blurFramebuffer),this._blitterV.blit(e.blurFramebuffer.getColorAttachments()[0],e.blurFramebuffer2)}}releaseTemporalResources(t){}getDepthScale(){return this._depthScale}setDepthScale(t){this._depthScale=t}getShaderHash(){return""}getShadowMapColorFormat(t){const e=q.instance.device;return e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"webgl"===e.type?"rgba16f":"r16f":e.getDeviceCaps().textureCaps.supportFloatColorBuffer?"webgl"===e.type?"rgba32f":"r32f":"rgba8unorm"}getShadowMapDepthFormat(t){return"d24s8"}computeShadowMapDepth(t,e,i){return jo(e,i,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const n="lib_computeShadowCSM",a=e.$builder;return a.func(n,[a.vec4("shadowVertex"),a.float("NdotL"),a.int("split")],(function(){this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$if(this.inShadow,(function(){this.shadow=Jo(this,t.lightType,t.shadowMap.format,this.shadowCoord,this.split)})),this.$return(this.shadow)})),a.getGlobalScope()[n](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",n=e.$builder;return n.func(r,[n.vec4("shadowVertex"),n.float("NdotL")],(function(){t.lightType===Da?(this.$l.dir=n.sub(this.shadowVertex.xyz,Qa.getLightPositionAndRangeForShadow(this).xyz),this.$return(Jo(this,Da,t.shadowMap.format,this.dir))):(this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$if(this.inShadow,(function(){this.shadow=Jo(this,t.lightType,t.shadowMap.format,this.shadowCoord)})),this.$return(this.shadow))})),n.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return!1}}class ah extends pa{_phase;_packFloat;_blurSize;_kernelSize;constructor(t,e,i,s){super(),this._phase=t,this._blurSize=i,this._kernelSize=e,this._packFloat=s}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}get kernelSize(){return this._kernelSize}set kernelSize(t){t!==this._kernelSize&&(this._kernelSize=t,this.invalidateHash())}get packFloat(){return this._packFloat}set packFloat(t){this._packFloat!==!!t&&(this._packFloat=!!t,this.invalidateHash())}setup(t,e){const i=t.$builder;"fragment"===i.shaderKind&&(t.blurSize=i.float().uniform(0),t.blurMultiplyVec="cube"===e?"horizonal"===this._phase?i.vec3(1,0,0):i.vec3(0,1,0):"horizonal"===this._phase?i.vec2(1,0):i.vec2(0,1),t.numBlurPixelsPerSide=i.float((this._kernelSize+1)/2),t.weight=i.float(1/(this._kernelSize*this._kernelSize)))}setUniforms(t){t.setValue("blurSize",this._blurSize)}readTexel(t,e,i,s,r,n){const a=t.$builder,o=super.readTexel(t,e,i,s,r,n);return this._packFloat?"horizonal"===this._phase?a.vec4(ha(t,o)):a.vec4(ua(t,o),0,0):o}writeTexel(t,e,i,s){const r=super.writeTexel(t,e,i,s);return this._packFloat?function(t,e,i){const s=t.$builder,r="Z_encode2HalfToRGBA";return s.func(r,[s.float("a"),s.float("b")],(function(){this.$l.t=s.vec4(this.a,s.fract(s.mul(this.a,255)),this.b,s.fract(s.mul(this.b,255))),this.$return(s.vec4(s.sub(this.t.x,s.div(this.t.y,255)),this.t.y,s.sub(this.t.z,s.div(this.t.w,255)),this.t.w))})),s.getGlobalScope()[r](e,i)}(t,r.x,r.y):r}filter(t,e,i,s,r,n){const a=this,o=t.$builder;return t.d0=a.readTexel(t,e,i,s,r,n),t.mean=o.float(0),t.squaredMean=o.float(0),t.$for(o.float("i"),1,t.numBlurPixelsPerSide,(function(){this.d1=a.readTexel(this,e,i,o.sub(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),r,n),this.d2=a.readTexel(this,e,i,o.add(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),r,n),this.mean=o.add(this.mean,this.d1.x),this.mean=o.add(this.mean,this.d2.x),"horizonal"===a._phase?(this.squaredMean=o.add(this.squaredMean,o.mul(this.d1.x,this.d1.x)),this.squaredMean=o.add(this.squaredMean,o.mul(this.d2.x,this.d2.x))):(this.squaredMean=o.add(this.squaredMean,o.dot(this.d1.xy,this.d1.xy)),this.squaredMean=o.add(this.squaredMean,o.dot(this.d2.xy,this.d2.xy)))})),t.mean=o.div(t.mean,a._kernelSize),t.squaredMean=o.div(t.squaredMean,a._kernelSize),t.stdDev=o.sqrt(o.max(0,o.sub(t.squaredMean,o.mul(t.mean,t.mean)))),o.vec4(t.mean,t.stdDev,0,1)}calcHash(){return`${this._phase}-${this._kernelSize}-${Number(this._packFloat)}`}}class oh extends Xo{_blur;_kernelSize;_blurSize;_blitterH;_blitterV;_mipmap;_darkness;constructor(t,e,i){super(),this._blur=!0,this._kernelSize=t??5,this._blurSize=e??1,this._darkness=i??0,this._mipmap=!0,this._blitterH=new ah("horizonal",this._kernelSize,1/1024,!1),this._blitterV=new ah("vertical",this._kernelSize,1/1024,!1)}resourceDirty(){return this._resourceDirty}get blur(){return this._blur}set blur(t){this._blur!==!!t&&(this._blur=!!t,this._resourceDirty=!0)}get mipmap(){return this._mipmap}set mipmap(t){this._mipmap!==!!t&&(this._mipmap=!!t,this._blur&&(this._resourceDirty=!0))}get kernelSize(){return this._kernelSize}set kernelSize(t){this._kernelSize=t}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}getDepthScale(){return this._darkness}setDepthScale(t){this._darkness=t}getType(){return"vsm"}getShadowMapBorder(t){return this._blur?Math.ceil((this._kernelSize+1)/2*this._blurSize):0}getShadowMap(t){const e=t.implData;return e?e.blurFramebuffer2.getColorAttachments()[0]:t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){const e=this.getShadowMapColorFormat(t),i=t.shadowMapFramebuffer.getColorAttachments()[0].width,s=t.shadowMapFramebuffer.getColorAttachments()[0].height;this._blur&&(t.implData={blurFramebuffer:dh.fetchTemporalFramebuffer(!0,t.lightType,t.numShadowCascades,i,s,e,null,!1),blurFramebuffer2:dh.fetchTemporalFramebuffer(!0,t.lightType,t.numShadowCascades,i,s,e,null,this._mipmap)}),t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(!1)??null}postRenderShadowMap(t){if(this._blur){const e=t.implData;this._blitterH.blurSize=this._blurSize/t.shadowMap.width,this._blitterH.kernelSize=this._kernelSize,this._blitterH.packFloat="rgba8unorm"===t.shadowMap.format,this._blitterV.blurSize=this._blurSize/t.shadowMap.height,this._blitterV.kernelSize=this._kernelSize,this._blitterV.packFloat="rgba8unorm"===t.shadowMap.format,this._blitterH.blit(t.shadowMapFramebuffer.getColorAttachments()[0],e.blurFramebuffer),this._blitterV.blit(e.blurFramebuffer.getColorAttachments()[0],e.blurFramebuffer2)}}releaseTemporalResources(t){}getShaderHash(){return""}getShadowMapColorFormat(t){const e=q.instance.device;return e.getDeviceCaps().textureCaps.supportFloatColorBuffer&&e.getDeviceCaps().textureCaps.supportLinearFloatTexture?"webgl"===e.type?"rgba32f":"rg32f":e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer&&e.getDeviceCaps().textureCaps.supportLinearHalfFloatTexture?"webgl"===e.type?"rgba16f":"rg16f":"rgba8unorm"}getShadowMapDepthFormat(t){return"d24s8"}computeShadowMapDepth(t,e,i){return jo(e,i,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const n="lib_computeShadowCSM",a=e.$builder;return a.func(n,[a.vec4("shadowVertex"),a.float("NdotL"),a.int("split")],(function(){this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$if(this.inShadow,(function(){this.$l.shadowBias=dh.computeShadowBiasCSM(t,this,this.NdotL,this.split),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.shadow=Qo(this,t.lightType,t.shadowMap.format,this.shadowCoord,this.split)})),this.$return(this.shadow)})),a.getGlobalScope()[n](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",n=e.$builder;return n.func(r,[n.vec4("shadowVertex"),n.float("NdotL")],(function(){t.lightType===Da?(this.$l.dir=n.sub(this.shadowVertex.xyz,Qa.getLightPositionAndRangeForShadow(this).xyz),this.$l.distance=n.div(n.length(this.dir),Qa.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=dh.computeShadowBias(t,this,this.distance,this.NdotL,!0),this.$l.coord=n.vec4(this.dir,n.sub(this.distance,this.shadowBias)),this.$return(Qo(this,t.lightType,t.shadowMap.format,this.coord))):(this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$if(this.inShadow,(function(){t.lightType===$a?(this.$l.nearFar=Qa.getShadowCameraParams(this).xy,this.shadowCoord.z=Qa.nonLinearDepthToLinearNormalized(this,this.shadowCoord.z,this.nearFar),this.$l.shadowBias=dh.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!0)):this.$l.shadowBias=dh.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),this.shadow=Qo(this,t.lightType,t.shadowMap.format,this.shadowCoord)})),this.$return(this.shadow))})),n.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return!1}}class hh extends Xo{_tapCount;_sampleRadius;_shadowSampler;constructor(t,e){super(),this._tapCount=t??3,this._sampleRadius=e??1,this._shadowSampler=null}get tapCount(){return this._tapCount}set tapCount(t){this._tapCount=t}getType(){return"pcf-pd"}dispose(){this._shadowSampler=null}resourceDirty(){return!1}getShadowMapBorder(t){return this._sampleRadius+1}getShadowMap(t){return this.useNativeShadowMap(t)?t.shadowMapFramebuffer.getDepthAttachment():t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(this.useNativeShadowMap(t))||null}postRenderShadowMap(){}releaseTemporalResources(t){}getDepthScale(){return this._sampleRadius}setDepthScale(t){this._sampleRadius=t}getShaderHash(){return`${this._tapCount}`}getShadowMapColorFormat(t){if(this.useNativeShadowMap(t))return null;{const t=q.instance.device;return t.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"webgl"===t.type?"rgba16f":"r16f":t.getDeviceCaps().textureCaps.supportFloatColorBuffer?"webgl"===t.type?"rgba32f":"r32f":"rgba8unorm"}}getShadowMapDepthFormat(t){return"webgl"===q.instance.device.type?"d24s8":"d32f"}computeShadowMapDepth(t,e,i){return jo(e,i,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const n="lib_computeShadowCSM",a=e.$builder,o=this;return a.func(n,[a.vec4("shadowVertex"),a.float("NdotL"),a.int("split")],(function(){this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$l.receiverPlaneDepthBias=qo(this,this.shadowCoord),this.$if(this.inShadow,(function(){this.$l.shadowBias=dh.computeShadowBiasCSM(t,this,this.NdotL,this.split),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.shadow=eh(this,t.lightType,t.shadowMap.format,o._tapCount,this.shadowCoord,this.receiverPlaneDepthBias,this.split)})),this.$return(this.shadow)})),a.getGlobalScope()[n](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",n=e.$builder,a=this;return n.func(r,[n.vec4("shadowVertex"),n.float("NdotL")],(function(){t.lightType===Da?(this.$l.dir=n.sub(this.shadowVertex.xyz,Qa.getLightPositionAndRangeForShadow(this).xyz),a.useNativeShadowMap(t)?(this.$l.nearFar=Qa.getShadowCameraParams(this).xy,this.$l.maxZ=n.max(n.max(n.abs(this.dir.x),n.abs(this.dir.y)),n.abs(this.dir.z)),this.$l.distance=Qa.linearDepthToNonLinear(this,this.maxZ,this.nearFar),this.$l.shadowBias=dh.computeShadowBias(t,this,n.div(this.maxZ,Qa.getLightPositionAndRangeForShadow(this).w),this.NdotL,!0),this.$return(a.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias))):(this.$l.distance=n.div(n.length(this.dir),Qa.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=dh.computeShadowBias(t,this,this.distance,this.NdotL,!0),this.$return(a.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias)))):(this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$l.receiverPlaneDepthBias=qo(this,this.shadowCoord),this.$if(this.inShadow,(function(){this.$l.shadowBias=dh.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),this.shadow=eh(this,t.lightType,t.shadowMap.format,a._tapCount,this.shadowCoord,this.receiverPlaneDepthBias)})),this.$return(this.shadow))})),n.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return"webgl"!==q.instance.device.type}sampleShadowMap(t,e,i,s,r){const n="lib_sampleShadowMap",a=e.$builder,o=this;return a.func(n,[a.vec3("coords"),a.float("z"),a.float("bias")],(function(){const e="rgba8unorm"!==t.shadowMap.format;o.useNativeShadowMap(t)?this.$return(a.clamp(a.textureSampleCompareLevel(Qa.getShadowMap(this),this.coords,a.sub(this.z,this.bias)),0,1)):(this.$l.shadowTex=a.textureSampleLevel(Qa.getShadowMap(this),this.coords,0),e||(this.shadowTex.x=ha(this,this.shadowTex)),this.$l.distance=a.sub(this.z,this.bias),this.$return(a.step(this.distance,this.shadowTex.x)))})),a.getGlobalScope()[n](i,s,r)}sampleShadowMapCSM(t,e,i,s,r,n){const a="lib_sampleShadowMapCSM",o=e.$builder,h=this;return o.func(a,[o.vec4("coords"),o.int("split"),o.float("z"),o.float("bias")],(function(){const e="rgba8unorm"!==t.shadowMap.format;this.$l.distance=o.sub(this.z,this.bias),h.useNativeShadowMap(t)?t.shadowMap.isTexture2DArray()?this.$return(o.clamp(o.textureArraySampleCompareLevel(Qa.getShadowMap(this),this.coords.xy,this.split,this.distance),0,1)):this.$return(o.clamp(o.textureSampleCompareLevel(Qa.getShadowMap(this),this.coords.xy,this.distance),0,1)):(t.shadowMap.isTexture2DArray()?this.$l.shadowTex=o.textureArraySampleLevel(Qa.getShadowMap(this),this.coords.xy,this.split,0):this.$l.shadowTex=o.textureSampleLevel(Qa.getShadowMap(this),this.coords.xy,0),e||(this.shadowTex.x=ha(this,this.shadowTex)),this.$return(o.step(this.distance,this.shadowTex.x)))})),o.getGlobalScope()[a](i,s,r,n)}}class lh extends Xo{_kernelSize;_shadowSampler;constructor(t){super(),this._kernelSize=t??5,this._shadowSampler=null}get kernelSize(){return this._kernelSize}set kernelSize(t){t=3!==t&&5!==t&&7!==t?5:t,this._kernelSize=t}getType(){return"pcf-opt"}dispose(){this._shadowSampler=null}resourceDirty(){return!1}getShadowMapBorder(t){return this._kernelSize}getShadowMap(t){return this.useNativeShadowMap(t)?t.shadowMapFramebuffer.getDepthAttachment():t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(this.useNativeShadowMap(t))||null}postRenderShadowMap(){}releaseTemporalResources(t){}getDepthScale(){return 1}setDepthScale(t){}getShaderHash(){return`${this._kernelSize}`}getShadowMapColorFormat(t){return this.useNativeShadowMap(t)?null:"rgba8unorm"}getShadowMapDepthFormat(t){return"webgl"===q.instance.device.type?"d24s8":"d32f"}computeShadowMapDepth(t,e,i){return jo(e,i,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const n="lib_computeShadowCSM",a=e.$builder,o=this;return a.func(n,[a.vec4("shadowVertex"),a.float("NdotL"),a.int("split")],(function(){this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$l.receiverPlaneDepthBias=qo(this,this.shadowCoord),this.$if(this.inShadow,(function(){this.$l.shadowBias=dh.computeShadowBiasCSM(t,this,this.NdotL,this.split),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.shadow=th(this,t.lightType,t.shadowMap.format,o._kernelSize,this.shadowCoord,this.receiverPlaneDepthBias,this.split)})),this.$return(this.shadow)})),a.getGlobalScope()[n](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",n=e.$builder,a=this;return n.func(r,[n.vec4("shadowVertex"),n.float("NdotL")],(function(){t.lightType===Da?(this.$l.dir=n.sub(this.shadowVertex.xyz,Qa.getLightPositionAndRangeForShadow(this).xyz),a.useNativeShadowMap(t)?(this.$l.nearFar=Qa.getShadowCameraParams(this).xy,this.$l.maxZ=n.max(n.max(n.abs(this.dir.x),n.abs(this.dir.y)),n.abs(this.dir.z)),this.$l.distance=Qa.linearDepthToNonLinear(this,this.maxZ,this.nearFar),this.$l.shadowBias=dh.computeShadowBias(t,this,n.div(this.maxZ,Qa.getLightPositionAndRangeForShadow(this).w),this.NdotL,!0),this.$return(a.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias))):(this.$l.distance=n.div(n.length(this.dir),Qa.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=dh.computeShadowBias(t,this,this.distance,this.NdotL,!0),this.$return(a.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias)))):(this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$l.receiverPlaneDepthBias=qo(this,this.shadowCoord),this.$if(this.inShadow,(function(){this.$l.shadowBias=dh.computeShadowBias(t,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),this.shadow=th(this,t.lightType,t.shadowMap.format,a._kernelSize,this.shadowCoord,this.receiverPlaneDepthBias)})),this.$return(this.shadow))})),n.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return"webgl"!==q.instance.device.type}sampleShadowMap(t,e,i,s,r){const n="lib_sampleShadowMap",a=e.$builder,o=this;return a.func(n,[a.vec3("coords"),a.float("z"),a.float("bias")],(function(){const e="rgba8unorm"!==t.shadowMap.format;o.useNativeShadowMap(t)?this.$return(a.clamp(a.textureSampleCompareLevel(Qa.getShadowMap(this),this.coords,a.sub(this.z,this.bias)),0,1)):(this.$l.shadowTex=a.textureSampleLevel(Qa.getShadowMap(this),this.coords,0),e||(this.shadowTex.x=ha(this,this.shadowTex)),this.$l.distance=a.sub(this.z,this.bias),this.$return(a.step(this.distance,this.shadowTex.x)))})),a.getGlobalScope()[n](i,s,r)}sampleShadowMapCSM(t,e,i,s,r,n){const a="lib_sampleShadowMapCSM",o=e.$builder,h=this;return o.func(a,[o.vec4("coords"),o.int("split"),o.float("z"),o.float("bias")],(function(){const e="rgba8unorm"!==t.shadowMap.format;this.$l.distance=o.sub(this.z,this.bias),h.useNativeShadowMap(t)?t.shadowMap.isTexture2DArray()?this.$return(o.clamp(o.textureArraySampleCompareLevel(Qa.getShadowMap(this),this.coords.xy,this.split,this.distance),0,1)):this.$return(o.clamp(o.textureSampleCompareLevel(Qa.getShadowMap(this),this.coords.xy,this.distance),0,1)):(t.shadowMap.isTexture2DArray()?this.$l.shadowTex=o.textureArraySampleLevel(Qa.getShadowMap(this),this.coords.xy,this.split,0):this.$l.shadowTex=o.textureSampleLevel(Qa.getShadowMap(this),this.coords.xy,0),e||(this.shadowTex.x=ha(this,this.shadowTex)),this.$return(o.step(this.distance,this.shadowTex.x)))})),o.getGlobalScope()[a](i,s,r,n)}}const uh=new S,ch=new M(S.identity());class dh{static _snapMatrix=new S;static _target=new b;static _up=new b;static _frustumMin=new b;static _frustumMax=new b;static _frustumCenter=new b;static _lightCameras=new WeakMap;static _shadowMapParams=[];_light;_config;_resourceDirty;_shadowMode;_shadowDistance;_impl;_pdSampleCount;_pdSampleRadius;_pcfKernelSize;_vsmBlurKernelSize;_vsmBlurRadius;_vsmDarkness;_esmBlur;_esmBlurKernelSize;_esmBlurRadius;_esmDepthScale;_shadowRegion;constructor(t){this._light=t,this._config={shadowMapSize:1024,numCascades:1,splitLambda:.5,depthBias:.05,normalBias:.05,nearClip:1},this._resourceDirty=!0,this._shadowMode="hard",this._shadowDistance=2e3,this._impl=null,this._pdSampleCount=12,this._pdSampleRadius=4,this._pcfKernelSize=5,this._vsmBlurKernelSize=5,this._vsmBlurRadius=4,this._vsmDarkness=.3,this._esmBlur=!0,this._esmBlurKernelSize=5,this._esmBlurRadius=4,this._esmDepthScale=200,this._shadowRegion=null,this.applyMode(this._shadowMode)}get light(){return this._light}get shadowMapSize(){return this._config.shadowMapSize}set shadowMapSize(t){!Number.isInteger(t)||t<1?console.error(`invalid shadow map size: ${t}`):this._config.shadowMapSize!==t&&(this._config.shadowMapSize=t,this._resourceDirty=!0)}get shadowRegion(){return this._shadowRegion}set shadowRegion(t){this._shadowRegion=t}get shadowDistance(){return this._shadowDistance}set shadowDistance(t){this._shadowDistance=Math.max(0,t)}get numShadowCascades(){return this._config.numCascades}set numShadowCascades(t){1===t||2===t||3===t||4===t?!this._light.isDirectionLight()&&t>1?console.error("only directional light can have more than one shadow cascades"):t!==this._config.numCascades&&(this._config.numCascades=t,this._resourceDirty=!0):console.error(`invalid shadow cascade number: ${t}`)}get splitLambda(){return this._config.splitLambda}set splitLambda(t){this._config.splitLambda!==t&&(this._config.splitLambda=t)}get depthBias(){return this._config.depthBias}set depthBias(t){this._config.depthBias=t}get normalBias(){return this._config.normalBias}set normalBias(t){this._config.normalBias=t}get nearClip(){return this._config.nearClip}set nearClip(t){this._config.nearClip!==t&&(this._config.nearClip=t)}get mode(){return this._shadowMode}set mode(t){t!==this._shadowMode&&(this._shadowMode=t,this.applyMode(this._shadowMode))}getShaderHash(t){return`${t.impl.constructor.name}_${t.impl.getShaderHash()}_${t.lightType}_${t.shadowMap.target}_${Number(t.numShadowCascades>1)}_${Number(q.instance.device.getDeviceCaps().textureCaps.getTextureFormatInfo(t.shadowMap.format).filterable)}`}get pdSampleCount(){return this._pdSampleCount}set pdSampleCount(t){(t=Math.min(Math.max(1,Number(t)>>0),64))!==this._pdSampleCount&&(this._pdSampleCount=t,this.asPCFPD()&&(this.asPCFPD().tapCount=this._pdSampleCount))}get pdSampleRadius(){return this._pdSampleRadius}set pdSampleRadius(t){(t=Math.max(0,Number(t)>>0))!==this._pdSampleRadius&&(this._pdSampleRadius=t,this.asPCFPD()?.setDepthScale(this._pdSampleRadius))}get pcfKernelSize(){return this._pcfKernelSize}set pcfKernelSize(t){(t=3!==t&&5!==t&&7!==t?5:t)!==this._pcfKernelSize&&(this._pcfKernelSize=t,this.asPCFOPT()&&(this.asPCFOPT().kernelSize=this._pcfKernelSize))}get vsmBlurKernelSize(){return this._vsmBlurKernelSize}set vsmBlurKernelSize(t){(t=1|Math.max(3,Number(t)>>0))!==this._vsmBlurKernelSize&&(this._vsmBlurKernelSize=t,this.asVSM()&&(this.asVSM().kernelSize=this._vsmBlurKernelSize))}get vsmBlurRadius(){return this._vsmBlurRadius}set vsmBlurRadius(t){(t=Math.max(0,Number(t)||0))!==this._vsmBlurRadius&&(this._vsmBlurRadius=t,this.asVSM()&&(this.asVSM().blurSize=this._vsmBlurRadius))}get vsmDarkness(){return this._vsmDarkness}set vsmDarkness(t){(t=Math.min(.999,Math.max(0,Number(t)||0)))!==this._vsmDarkness&&(this._vsmDarkness=t,this.asVSM()?.setDepthScale(this._vsmDarkness))}get esmBlur(){return this._esmBlur}set esmBlur(t){!!t!==this.esmBlur&&(this._esmBlur=!!t,this.asESM()&&(this.asESM().blur=this._esmBlur))}get esmBlurKernelSize(){return this._esmBlurKernelSize}set esmBlurKernelSize(t){(t=1|Math.max(3,Number(t)>>0))!==this._esmBlurKernelSize&&(this._esmBlurKernelSize=t,this.asESM()&&(this.asESM().kernelSize=this._esmBlurKernelSize))}get esmBlurRadius(){return this._esmBlurRadius}set esmBlurRadius(t){(t=Math.max(0,Number(t)||0))!==this._esmBlurRadius&&(this._esmBlurRadius=t,this.asESM()&&(this.asESM().blurSize=this._esmBlurRadius))}get esmDepthScale(){return this._esmDepthScale}set esmDepthScale(t){(t=Math.max(0,Number(t)||0))!==this._esmDepthScale&&(this._esmDepthScale=t,this.asESM()?.setDepthScale(this._esmDepthScale))}computeShadow(t,e,i,s){return this._impl.computeShadow(t,e,i,s)}computeShadowCSM(t,e,i,s,r){return this._impl.computeShadowCSM(t,e,i,s,r)}static releaseTemporalResources(t){if(t.shadowMapInfo){for(const e of t.shadowMapInfo.keys()){const i=t.shadowMapInfo.get(e);t.device.pool.releaseFrameBuffer(i.shadowMapFramebuffer),i.impl.releaseTemporalResources(i),i.lightType=0,i.depthClampEnabled=!1,i.shaderHash="",i.numShadowCascades=1,i.shadowMapFramebuffer=null,i.impl=null,i.shadowMap=null,i.shadowMapSampler=null,i.implData=null,this._shadowMapParams.push(i)}t.shadowMapInfo=null}}static computeShadowBias(t,e,i,s,r){const n=e.$builder,a=Qa.getDepthBiasValues(e);if(t.lightType===Ia)return n.dot(n.mul(a.xy,n.vec2(1,n.sub(1,s))),n.vec2(1,1));{const t=Qa.getShadowCameraParams(e).xy,o=r?i:Qa.nonLinearDepthToLinearNormalized(e,i,t),h=n.mix(1,a.w,o);return n.dot(n.mul(a.xy,n.vec2(1,n.sub(1,s)),h),n.vec2(1,1))}}static computeShadowBiasCSM(t,e,i,s){const r=e.$builder,n=Qa.getDepthBiasValues(e),a=r.vec4(r.float(r.equal(s,0)),r.float(r.equal(s,1)),r.float(r.equal(s,2)),r.float(r.equal(s,3))),o=r.dot(Qa.getDepthBiasScales(e),a);return r.dot(r.mul(n.xy,r.vec2(1,r.sub(1,i)),o),r.vec2(1,1))}isTextureInvalid(t,e,i,s,r){return t&&(t.target!==e||t.format!==i||t.width!==s||t.height!==r||t.depth!==this.numShadowCascades)}createTexture(t,e,i,s,r){const n=q.instance.device,a={samplerOptions:{mipFilter:"none"}};switch(t){case"2d":return n.createTexture2D(e,i,s,a);case"cube":return n.createCubeTexture(e,i,a);case"2darray":return n.createTexture2DArray(e,i,s,r,a);default:return null}}static fetchTemporalFramebuffer(t,e,i,s,r,n,a,o){const h=q.instance.device,l=i>1&&"webgl"!==h.type,u=n?l?[h.pool.fetchTemporalTexture2DArray(!1,n,s,r,i,o)]:e===Da?[h.pool.fetchTemporalTextureCube(!1,n,s,o)]:[h.pool.fetchTemporalTexture2D(!1,n,s,r,o)]:null,c=a?l?h.pool.fetchTemporalTexture2DArray(!1,a,s,r,i,!1):"webgl"!==h.type&&e===Da?h.pool.fetchTemporalTextureCube(!1,a,s,!1):h.pool.fetchTemporalTexture2D(!1,a,s,r,!1):null,d=h.pool.createTemporalFramebuffer(t,u,c);return u&&h.pool.releaseTexture(u[0]),c&&h.pool.releaseTexture(c),d}updateResources(t){const e=q.instance.device,i=t.impl.getShadowMapColorFormat(t),s=t.impl.getShadowMapDepthFormat(t),r=t.numShadowCascades,n=r>1&&"webgl"!==e.type,a=r>1&&!n?2*this._config.shadowMapSize:this._config.shadowMapSize,o=r>2&&!n?2*this._config.shadowMapSize:this._config.shadowMapSize;t.shadowMapFramebuffer=dh.fetchTemporalFramebuffer(!1,this._light.lightType,r,a,o,i,s),t.impl=this._impl,this._impl.updateResources(t)}createLightCameraPoint(t){t.reparent(t.scene.rootNode),t.position.setXYZ(0,0,0),t.rotation.identity(),t.scale.setXYZ(1,1,1),t.setPerspective(Math.PI/2,1,this._config.nearClip,Math.min(this._shadowDistance,this._light.range)),t.position.set(this._light.positionAndRange.xyz())}createLightCameraSpot(t){t.reparent(this._light),t.position.setXYZ(0,0,0),t.rotation.identity(),t.scale.setXYZ(1,1,1),t.setPerspective(2*this._light.cutoff,1,this._config.nearClip,Math.min((this._shadowDistance,this._light).range))}createLightCameraDirectional(t,e,i,s,r){let n=e.frustumViewSpace;this._shadowDistance<e.getFarPlane()&&(uh.set(e.getProjectionMatrix()),uh.setNearFar(uh.getNearPlane(),this._shadowDistance),ch.initWithMatrix(uh),n=ch),r=r||0;const a=(this.shadowMapSize-2*r)/this.shadowMapSize,o=dh._frustumMin,h=dh._frustumMax,l=dh._frustumCenter,u=dh._target,c=dh._up;o.setXYZ(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),h.setXYZ(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.corners.forEach((t=>{o.inplaceMin(t),h.inplaceMax(t)}));let d=.5*b.distance(o,h)*a;const p=e.thisToWorld(b.add(o,h,l).scaleBy(.5),l),m=.5*t.diagonalLength*a;if(m<d&&(d=m,b.add(t.minPoint,t.maxPoint,p).scaleBy(.5)),u.setXYZ(p.x+this._light.directionAndCutoff.x,p.y+this._light.directionAndCutoff.y,p.z+this._light.directionAndCutoff.z),c.setXYZ(0,1,0),i.lookAt(p,u,c),i.position.set(p),i.setOrtho(-d,d,-d,d,-d,d),p.setXYZ(0,0,0),i.viewProjectionMatrix.transformPointP(p,p),s){const t=p.x*this.shadowMapSize*.5,e=p.y*this.shadowMapSize*.5,i=Math.round(t),r=Math.round(e);p.setXYZ(2*(i-t)/this.shadowMapSize,2*(r-e)/this.shadowMapSize,0),s.translation(p)}}static fetchShadowMapParams(){return this._shadowMapParams.length>0?this._shadowMapParams.pop():{lightType:0,depthClampEnabled:!1,shaderHash:"",cameraParams:new T,cascadeDistances:new T,depthBiasScales:new T,depthBiasValues:[new T,new T,new T,new T],numShadowCascades:1,shadowMatrices:new Float32Array(64),shadowMap:null,shadowMapSampler:null,shadowMapFramebuffer:null,impl:null,implData:null}}static fetchCameraForScene(t){const e=this._lightCameras.get(t);if(e&&0!==e.length){const i=e.pop();return i.parent=t.rootNode,i.position.setXYZ(0,0,0),i.rotation.identity(),i.scale.setXYZ(1,1,1),i.clipMask=0,i}return new Go(t)}static releaseCamera(t){let e=this._lightCameras.get(t.scene);e||(e=[],this._lightCameras.set(t.scene,e)),t.remove(),e.push(t)}calcSplitDistances(t,e,i){const s=[0,0,0,0,0];for(let r=0;r<=i;++r){const n=r/i,a=t*Math.pow(e/t,n),o=t+(e-t)*n;s[r]=a*this._config.splitLambda+o*(1-this._config.splitLambda)}return s}calcDepthBiasParams(t,e,i,s,r,n){const a=Math.min(t.getProjectionMatrix().getNearPlaneWidth(),t.getProjectionMatrix().getNearPlaneHeight()),o=Math.min(t.getProjectionMatrix().getFarPlaneWidth(),t.getProjectionMatrix().getFarPlaneHeight()),h=a/e/2;n.setXYZW(i*h,s*h,r,o/a)}postRenderShadowMap(t){this._impl.postRenderShadowMap(t)}render(t,e){t.shadowMapInfo||(t.shadowMapInfo=new Map);const i=dh.fetchShadowMapParams();i.impl=this._impl,i.lightType=this.light.lightType,i.numShadowCascades=i.lightType===Ia?this._config.numCascades:1,t.shadowMapInfo.set(this.light,i);const s=t.scene,r=t.camera;e.light=this._light,this.updateResources(i),i.shaderHash=this.getShaderHash(i);const n=q.instance.device,a=i.shadowMapFramebuffer;i.depthClampEnabled=!1,e.clearColor=a.getColorAttachments()[0]?a.getColorAttachments()[0].isFloatFormat()?new T(1,1,1,1):new T(0,0,0,1):null;const o=this._impl.getDepthScale(),h=this._light.isDirectionLight()&&this._shadowRegion&&this._shadowRegion.isValid()?this._shadowRegion:s.boundingBox;if(this._light.isPointLight()){const r=dh.fetchCameraForScene(s);this.createLightCameraPoint(r),this.calcDepthBiasParams(r,this._config.shadowMapSize,this._config.depthBias,this._config.normalBias,o,i.depthBiasValues[0]),i.cameraParams.setXYZW(r.getNearPlane(),r.getFarPlane(),this._config.shadowMapSize,this._shadowDistance),n.setFramebuffer(a),i.shadowMatrices.set(S.transpose(r.viewMatrix));for(const i of[m.PX,m.NX,m.PY,m.NY,m.PZ,m.NZ])r.lookAtCubeFace(i),a.setColorAttachmentCubeFace(0,i),a.setDepthAttachmentCubeFace(i),t.camera=r,e.render(t);i.shadowMatrices.set(S.identity()),dh.releaseCamera(r)}else if(this._config.numCascades>1){const l=this.calcSplitDistances(r.getNearPlane(),Math.min(this._shadowDistance,r.getFarPlane()),this._config.numCascades),u=dh.fetchCameraForScene(s),c=dh.fetchCameraForScene(s),d=dh.fetchCameraForScene(s);d.clipMask=R.ClipLeft|R.ClipRight|R.ClipBottom|R.ClipTop,u.reparent(r),i.depthClampEnabled=q.instance.device.getDeviceCaps().shaderCaps.supportFragmentDepth;for(let s=0;s<this._config.numCascades;s++){u.setPerspective(r.getFOV(),r.getAspect(),l[s],l[s+1]);const p=dh._snapMatrix,m=i.impl.getShadowMapBorder(i);this.createLightCameraDirectional(h,u,c,p,m),this.createLightCameraDirectional(h,u,d,null,m),this.calcDepthBiasParams(c,this._config.shadowMapSize,this._config.depthBias,this._config.normalBias,o,i.depthBiasValues[s]),i.depthBiasScales[s]=1,i.cameraParams.setXYZW(c.getNearPlane(),c.getFarPlane(),this._config.shadowMapSize,this._shadowDistance);let f=null;if(a.getColorAttachments()[0]?.isTexture2DArray()||a.getDepthAttachment()?.isTexture2DArray())c.setProjectionMatrix(S.multiply(p,c.getProjectionMatrix())),a.setColorAttachmentLayer(0,s),a.setDepthAttachmentLayer(s);else{const t=this._config.numCascades>2?2:1,e=this._config.numCascades>1?2:1,i=new S,r=s%2,a=s>>1;i.setRowXYZW(0,1.5-.5*e,0,0,0),i.setRowXYZW(1,0,1.5-.5*t,0,0),i.setRowXYZW(2,0,0,1,0),i.setRowXYZW(3,r-.5*e+.5,a-.5*t+.5,0,1),c.setProjectionMatrix(S.multiply(i,S.multiply(p,c.getProjectionMatrix()))),f="webgpu"===n.type?[r*this._config.shadowMapSize,(t-1-a)*this._config.shadowMapSize,this._config.shadowMapSize,this._config.shadowMapSize]:[r*this._config.shadowMapSize,a*this._config.shadowMapSize,this._config.shadowMapSize,this._config.shadowMapSize]}n.setFramebuffer(a),n.setScissor(f),t.camera=c,e.render(t,d),i.shadowMatrices.set(S.transpose(c.viewProjectionMatrix),16*s),i.cascadeDistances[s]=l[s+1]}dh.releaseCamera(u),dh.releaseCamera(c),dh.releaseCamera(d)}else{const l=dh.fetchCameraForScene(s),u=dh._snapMatrix;l.clipMask=R.ClipLeft|R.ClipRight|R.ClipBottom|R.ClipTop,this._light.isDirectionLight()?this.createLightCameraDirectional(h,r,l,u,i.impl.getShadowMapBorder(i)):this.createLightCameraSpot(l),this.calcDepthBiasParams(l,this._config.shadowMapSize,this._config.depthBias,this._config.normalBias,o,i.depthBiasValues[0]),i.cameraParams.setXYZW(l.getNearPlane(),l.getFarPlane(),this._config.shadowMapSize,this._shadowDistance),n.setFramebuffer(a),l.setProjectionMatrix(S.multiply(u,l.getProjectionMatrix())),t.camera=l,e.render(t),i.shadowMatrices.set(S.transpose(l.viewProjectionMatrix)),dh.releaseCamera(l)}t.camera=r,this.postRenderShadowMap(i)}applyMode(t){"hard"===t||"vsm"===t||"esm"===t||"pcf-pd"===t||"pcf-opt"===t?(this._impl=null,"hard"===t?this._impl=new ih:"vsm"===t?this._impl=new oh(this._vsmBlurKernelSize,this._vsmBlurRadius,this._vsmDarkness):"esm"===t?this._impl=new nh(this._esmBlurKernelSize,this._esmBlurRadius,this._esmDepthScale):"pcf-pd"===t?this._impl=new hh(this._pdSampleCount,this._pdSampleRadius):"pcf-opt"===t&&(this._impl=new lh(this._pcfKernelSize))):console.error(`ShadowMapper.setShadowMode() failed: invalid mode: ${t}`)}asVSM(){return"vsm"===this._impl?.getType()?this._impl:null}asESM(){return"esm"===this._impl?.getType()?this._impl:null}asPCFPD(){return"pcf-pd"===this._impl?.getType()?this._impl:null}asPCFOPT(){return"pcf-opt"===this._impl?.getType()?this._impl:null}}class ph extends Go{_near;_far;_fovY;_aspect;_window;constructor(t,e,i,s,r){super(t),this._fovY=e,this._aspect=i,this._near=s,this._far=r,this._window=null,this._invalidate(!0)}get window(){return this._window}set window(t){this._window=t??null,this._invalidate(!0)}get near(){return this._near}set near(t){t!==this._near&&(this._near=t,this._invalidate(!0))}get far(){return this._far}set far(t){t!==this._far&&(this._far=t,this._invalidate(!0))}get fovY(){return this._fovY}set fovY(t){t!==this._fovY&&(this._fovY=t,this._invalidate(!0))}get aspect(){return this._aspect}set aspect(t){t!==this._aspect&&(this._aspect=t,this._invalidate(!0))}setPerspective(t,e,i,s){return this._aspect=e,this._fovY=t,this._near=i,this._far=s,this._invalidate(!0),this}setOrtho(t,e,i,s,r,n){throw new Error("setOrtho() not allowed on PerspectiveCamera")}setProjectionMatrix(t){if(!t||t===this._projMatrix||!t.isPerspective())throw new Error("PerspectiveCamera.setProjectionMatrix(): param is not a perspective projection matrix");t.getFov(),this._aspect=t.getAspect(),this._fovY=t.getFov(),this._near=t.getNearPlane(),this._far=t.getFarPlane(),this._invalidate(!0)}_computeProj(){const t=this._near*Math.tan(.5*this._fovY),e=t*this._aspect;let i=-e,s=e,r=t,n=-t;if(this._window){const t=s-i,e=r-n;i+=t*this._window[0],n+=e*this._window[1],s=i+t*this._window[2],r=n+e*this._window[3]}this._projMatrix.frustum(i,s,n,r,this._near,this._far)}}class mh{_tileCountX;_tileCountY;_tileCountZ;_lights;_lightIndexTexture;_lightIndexFramebuffer;_lightIndexProgram;_bindGroup;_lightIndexVertexLayout;_lightIndexRenderStates;_lightBuffer;_sizeParam;_countParam;_clusterParam;constructor(){this._tileCountX=16,this._tileCountY=16,this._tileCountZ=32,this._lights=new Float32Array(3072),this._lightIndexTexture=null,this._lightIndexFramebuffer=null,this._lightIndexProgram=null,this._lightBuffer=null,this._bindGroup=null,this._lightIndexVertexLayout=null,this._lightIndexRenderStates=null,this._sizeParam=new T,this._countParam=new Int32Array(4),this._clusterParam=new T}get lightBuffer(){return this._lightBuffer}get clusterParam(){return this._clusterParam}get countParam(){return this._countParam}get lightIndexTexture(){return this._lightIndexTexture}createVertexLayout(t,e,i){let s;if("webgl"===t.type){const r=new Float32Array(this._tileCountX*this._tileCountY*this._tileCountZ*3);for(let t=0;t<r.length;t++){const s=t%e,n=Math.floor(t/e);r[3*t+0]=2*(s+.5)/e-1,r[3*t+1]=2*(n+.5)/i-1,r[3*t+2]=t}s=t.createVertexBuffer("position_f32x3",r)}else{const r=new Float32Array(this._tileCountX*this._tileCountY*this._tileCountZ*2);for(let t=0;t<r.length;t++){const s=t%e,n=Math.floor(t/e);r[2*t+0]=2*(s+.5)/e-1,r[2*t+1]=2*(n+.5)/i-1}s=t.createVertexBuffer("position_f32x2",r)}this._lightIndexVertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:s}]})}createRenderState(t){this._lightIndexRenderStates=t.createRenderStateSet(),this._lightIndexRenderStates.useDepthState().enableTest(!1).enableWrite(!1),this._lightIndexRenderStates.useRasterizerState().setCullMode("none")}createProgram(t){const e="webgl"===t.type;this._lightIndexProgram=t.buildRenderProgram({vertex(t){this.$inputs.pos=(e?t.vec3():t.vec2()).attrib("position"),this.$outputs.value=e?t.vec4():t.uvec4(),this.invProjMatrix=t.mat4().uniform(0),this.viewMatrix=t.mat4().uniform(0),this.sizeParam=t.vec4().uniform(0),this.countParam=t.ivec4().uniform(0),this[Qa.getLightBufferUniformName()]=t.vec4[768]().uniformBuffer(0),t.func("lineIntersectionToZPlane",[t.vec3("a"),t.vec3("b"),t.float("zDistance")],(function(){this.$l.normal=t.vec3(0,0,1),this.$l.ab=t.sub(this.b,this.a),this.$l.t=t.div(t.sub(this.zDistance,t.dot(this.normal,this.a)),t.dot(this.normal,this.ab)),this.$return(t.add(this.a,t.mul(this.t,this.ab)))})),t.func("clipToView",[t.vec4("clip")],(function(){this.$l.view=t.mul(this.invProjMatrix,this.clip),this.$return(t.div(this.view,this.view.w))})),t.func("screenToView",[t.vec4("screen")],(function(){this.$l.texCoord=t.div(this.screen.xy,this.sizeParam.xy),this.$l.clip=t.vec4(t.sub(t.mul(t.vec2(this.texCoord.x,t.sub(1,this.texCoord.y)),2),t.vec2(1)),this.screen.z,this.screen.w),this.$return(this.clipToView(this.clip))})),t.func("sphereIntersectsAABB",[t.vec4("sphere"),t.vec3("aabbMin"),t.vec3("aabbMax")],(function(){this.$l.dmin=t.float(0),this.$if(t.lessThanEqual(this.sphere.w,0),(function(){this.$return(!0)})),this.$for(t.int("i"),0,3,(function(){this.$if(t.lessThan(this.sphere.at(this.i),this.aabbMin.at(this.i)),(function(){this.$l.delta=t.sub(this.sphere.at(this.i),this.aabbMin.at(this.i)),this.dmin=t.add(this.dmin,t.mul(this.delta,this.delta))})).$elseif(t.greaterThan(this.sphere.at(this.i),this.aabbMax.at(this.i)),(function(){this.$l.delta=t.sub(this.sphere.at(this.i),this.aabbMax.at(this.i)),this.dmin=t.add(this.dmin,t.mul(this.delta,this.delta))}))})),this.$if(t.lessThanEqual(this.dmin,t.mul(this.sphere.w,this.sphere.w)),(function(){this.$return(!0)})),this.$return(!1)})),t.main((function(){"webgpu"!==t.getDevice().type&&(this.$builtins.pointSize=1),this.$builtins.position=t.vec4(this.$inputs.pos.xy,0,1),"webgpu"===t.getDevice().type&&(this.$builtins.position=t.mul(this.$builtins.position,t.vec4(1,-1,1,1))),this.$l.tileIndex=e?t.int(this.$inputs.pos.z):t.int(this.$builtins.vertexIndex),this.$l.tileSize=t.div(this.sizeParam.xy,t.vec2(this.countParam.xy)),this.$l.zIndex=t.div(this.tileIndex,t.mul(this.countParam.x,this.countParam.y)),this.$l.yIndex=t.div(t.sub(this.tileIndex,t.mul(this.zIndex,this.countParam.x,this.countParam.y)),this.countParam.x),this.$l.xIndex=t.sub(this.tileIndex,t.add(t.mul(this.zIndex,this.countParam.x,this.countParam.y),t.mul(this.yIndex,this.countParam.x))),this.$l.maxPoint_sS=t.vec4(t.mul(t.vec2(t.float(t.add(this.xIndex,1)),t.float(t.add(this.yIndex,1))),this.tileSize),0,1),this.$l.minPoint_sS=t.vec4(t.mul(t.vec2(t.float(this.xIndex),t.float(this.yIndex)),this.tileSize),0,1),this.$l.maxPoint_vS=this.screenToView(this.maxPoint_sS).xyz,this.$l.minPoint_vS=this.screenToView(this.minPoint_sS).xyz,this.$l.tileNear=t.mul(t.neg(this.sizeParam.z),t.pow(t.div(this.sizeParam.w,this.sizeParam.z),t.div(t.float(this.zIndex),t.float(this.countParam.z)))),this.$l.tileFar=t.mul(t.neg(this.sizeParam.z),t.pow(t.div(this.sizeParam.w,this.sizeParam.z),t.div(t.add(t.float(this.zIndex),1),t.float(this.countParam.z)))),this.$l.eyePos=t.vec3(0),this.$l.minPointNear=this.lineIntersectionToZPlane(this.eyePos,this.minPoint_vS,this.tileNear),this.$l.minPointFar=this.lineIntersectionToZPlane(this.eyePos,this.minPoint_vS,this.tileFar),this.$l.maxPointNear=this.lineIntersectionToZPlane(this.eyePos,this.maxPoint_vS,this.tileNear),this.$l.maxPointFar=this.lineIntersectionToZPlane(this.eyePos,this.maxPoint_vS,this.tileFar),this.$l.aabbMin=t.min(t.min(this.minPointNear,this.minPointFar),t.min(this.maxPointNear,this.maxPointFar)),this.$l.aabbMax=t.max(t.max(this.minPointNear,this.minPointFar),t.max(this.maxPointNear,this.maxPointFar)),this.$l.n=t.int(0),e?(this.$l.lightIndices=t.float[8](),this.$for(t.int("i"),0,8,(function(){this.lightIndices.setAt(this.i,0)})),this.$for(t.int("i"),1,256,(function(){this.$if(t.equal(this.i,this.countParam.w),(function(){this.$break()})),this.$l.light=this[Qa.getLightBufferUniformName()].at(t.mul(this.i,3)),this.$l.lightPos=t.mul(this.viewMatrix,t.vec4(this.light.xyz,1)),this.$l.lightPos.w=this.light.w,this.$if(this.sphereIntersectsAABB(this.lightPos,this.aabbMin,this.aabbMax),(function(){this.$for(t.int("j"),0,8,(function(){this.$if(t.equal(this.j,this.n),(function(){this.lightIndices.setAt(this.j,t.float(this.i)),this.n=t.add(this.n,1),this.$break()}))})),this.$if(t.equal(this.n,8),(function(){this.$break()}))}))})),this.$outputs.value.r=t.add(t.mul(this.lightIndices[0],256),this.lightIndices[1]),this.$outputs.value.g=t.add(t.mul(this.lightIndices[2],256),this.lightIndices[3]),this.$outputs.value.b=t.add(t.mul(this.lightIndices[4],256),this.lightIndices[5]),this.$outputs.value.a=t.add(t.mul(this.lightIndices[6],256),this.lightIndices[7])):(this.$l.lightIndex=[t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0)],this.$for(t.uint("i"),1,t.uint(this.countParam.w),(function(){this.$l.light=this[Qa.getLightBufferUniformName()].at(t.mul(this.i,3)),this.$l.lightPos=t.mul(this.viewMatrix,t.vec4(this.light.xyz,1)),this.$l.lightPos.w=this.light.w,this.$if(this.sphereIntersectsAABB(this.lightPos,this.aabbMin,this.aabbMax),(function(){this.lightIndex.setAt(this.n,this.i),this.n=t.add(this.n,1),this.$if(t.equal(this.n,16),(function(){this.$break()}))}))})),this.$l.r=t.add(t.sal(this.lightIndex[0],24),t.sal(this.lightIndex[1],16),t.sal(this.lightIndex[2],8),this.lightIndex[3]),this.$l.g=t.add(t.sal(this.lightIndex[4],24),t.sal(this.lightIndex[5],16),t.sal(this.lightIndex[6],8),this.lightIndex[7]),this.$l.b=t.add(t.sal(this.lightIndex[8],24),t.sal(this.lightIndex[9],16),t.sal(this.lightIndex[10],8),this.lightIndex[11]),this.$l.a=t.add(t.sal(this.lightIndex[12],24),t.sal(this.lightIndex[13],16),t.sal(this.lightIndex[14],8),this.lightIndex[15]),this.$outputs.value=t.uvec4(this.r,this.g,this.b,this.a))}))},fragment(t){this.$outputs.color=e?t.vec4():t.uvec4(),t.main((function(){this.$outputs.color=this.$inputs.value}))}}),this._bindGroup=t.createBindGroup(this._lightIndexProgram.bindGroupLayouts[0]),this._lightBuffer?.dispose();const i=this._lightIndexProgram.getBindingInfo(Qa.getLightBufferUniformName()).type;this._lightBuffer=t.createStructuredBuffer(i,{usage:"uniform"})}createLightIndexTexture(t){const e=Math.log2(this._tileCountX*this._tileCountY*this._tileCountZ),i=e+1>>>1,s=2<<i-1,r=2<<e-i-1;if(s*r!=this._tileCountX*this._tileCountY*this._tileCountZ)throw new Error("Internal error");this._lightIndexTexture=t.createTexture2D("webgl"===t.type?"rgba32f":"rgba32ui",s,r,{samplerOptions:{mipFilter:"none"}}),this._lightIndexTexture.name="ClusterLightIndex",this._lightIndexFramebuffer?.dispose(),this._lightIndexFramebuffer=t.createFrameBuffer([this._lightIndexTexture],null)}calculateLightIndex(t,e){const i=this.getVisibleLights(e,this._lights),s=q.instance.device;this._lightIndexTexture||this.createLightIndexTexture(s),this._lightIndexProgram||this.createProgram(s),this._lightIndexVertexLayout||this.createVertexLayout(s,this._lightIndexTexture.width,this._lightIndexTexture.height),this._lightIndexRenderStates||this.createRenderState(s);const r=s.getViewport(),n=s.screenToDevice(r.width),a=s.screenToDevice(r.height),o=this._tileCountZ/Math.log2(t.getFarPlane()/t.getNearPlane()),h=-this._tileCountZ*Math.log2(t.getNearPlane())/Math.log2(t.getFarPlane()/t.getNearPlane());if(this._clusterParam.setXYZW(n,a,o,h),s.pushDeviceStates(),s.setFramebuffer(this._lightIndexFramebuffer),i>0){this._lightBuffer.bufferSubData(0,this._lights),this._sizeParam.setXYZW(n,a,t.getNearPlane(),t.getFarPlane()),this._countParam[0]=this._tileCountX,this._countParam[1]=this._tileCountY,this._countParam[2]=this._tileCountZ,this._countParam[3]=i+1,this._bindGroup.setValue("invProjMatrix",S.invert(t.getProjectionMatrix())),this._bindGroup.setValue("viewMatrix",t.viewMatrix),this._bindGroup.setValue("sizeParam",this._sizeParam),this._bindGroup.setValue("countParam",this._countParam),this._bindGroup.setBuffer(Qa.getLightBufferUniformName(),this._lightBuffer),s.setProgram(this._lightIndexProgram),s.setVertexLayout(this._lightIndexVertexLayout),s.setBindGroup(0,this._bindGroup);const e=s.getRenderStates();s.setRenderStates(this._lightIndexRenderStates),s.draw("point-list",0,this._tileCountX*this._tileCountY*this._tileCountZ),s.setRenderStates(e)}else s.clearFrameBuffer(new T(0,0,0,0),1,0);s.popDeviceStates()}getVisibleLights(t,e){const i=Math.min(t.unshadowedLights.length,La);for(let s=1;s<=i;s++){const i=t.unshadowedLights[s-1];e.set(i.positionAndRange,12*s),e.set(i.directionAndCutoff,12*s+4),e.set(i.diffuseAndIntensity,12*s+8)}return i}}class fh{static _layouts={};static _allocators=[];_bindGroups;constructor(){this._bindGroups={}}static get(){return this._allocators.pop()??new fh}static release(t){this._allocators.push(t)}getGlobalBindGroup(t){const e=t.renderPassHash;let i=this._bindGroups[e];if(!i){let s=fh._layouts[e];if(!s){s=t.device.programBuilder.buildRender({vertex(e){Qa.prepareVertexShader(e,t),e.main((function(){}))},fragment(e){Qa.prepareFragmentShader(e,t),e.main((function(){}))}})[2][0],fh._layouts[e]=s}i=t.device.createBindGroup(s),this._bindGroups[e]=i}return i}}class _h extends Do{constructor(){super(3)}_getGlobalBindGroupHash(t){return"ocp"}renderItems(t,e){const i=e.itemList;if(i){t.applyFog=null,t.drawEnvLight=!1,t.env=null,t.picking=!0,t.flip=this.isAutoFlip(t),t.renderPassHash=this.getGlobalBindGroupHash(t);const e=t.globalBindGroupAllocator.getGlobalBindGroup(t);t.device.setBindGroup(0,e),Qa.setCameraUniforms(e,t.camera,t.flip,!0);const s=t.camera.worldMatrixDet<0;for(const e of[i.opaque,i.transmission,i.transparent])if(e){for(const i of e.lit)this.drawItemList(i,t,s);for(const i of e.unlit)this.drawItemList(i,t,s)}t.picking=!1}}}class gh{static _scenePass=new $o;static _depthPass=new Po;static _shadowMapPass=new Lo;static _objectColorPass=new _h;static _clusters=[];static get sceneRenderPass(){return this._scenePass}static get depthRenderPass(){return this._depthPass}static get shadowMapRenderPass(){return this._shadowMapPass}static setClearColor(t){this._scenePass.clearColor=t}static getClusteredLight(){return this._clusters.length>0?this._clusters.pop():new mh}static freeClusteredLight(t){this._clusters.push(t)}static renderScene(t,e,i){const s=q.instance.device,r={device:s,scene:t,primaryCamera:e,picking:!1,oit:null,globalBindGroupAllocator:fh.get(),camera:e,compositor:i?.needDrawPostEffects()?i:null,timestamp:s.frameInfo.frameTimestamp,queue:0,lightBlending:!1,renderPass:null,renderPassHash:null,applyFog:null,flip:!1,drawEnvLight:!1,env:null};t.frameUpdate(),e&&!s.isContextLost()&&this._renderScene(r),fh.release(r.globalBindGroupAllocator)}static _renderSceneDepth(t,e,i){const s=t.device;s.pushDeviceStates(),s.setFramebuffer(i),this._depthPass.clearColor="webgl"===s.type?new T(0,0,0,1):new T(1,1,1,1),this._depthPass.render(t,null,e),s.popDeviceStates()}static _renderScene(t){const e=t.device,i=t.camera.viewport,s=t.camera.scissor,r=e.getFramebuffer(),n=e.getDrawingBufferWidth(),a=e.getDrawingBufferHeight();t.depthFormat="d24s8",t.viewportX=r?i?.[0]??0:e.screenToDevice(i?.[0]??0),t.viewportY=r?i?.[1]??0:e.screenToDevice(i?.[1]??0),t.viewportWidth=r?i?.[2]??r.getWidth():i?e.screenToDevice(i[2]):e.getDrawingBufferWidth(),t.viewportHeight=r?i?.[3]??r.getHeight():i?e.screenToDevice(i[3]):e.getDrawingBufferHeight(),t.defaultViewport=!r&&!i;const o=i&&!e.getDeviceCaps().miscCaps.supportOversizedViewport&&(t.viewportX<0||t.viewportY<0||t.viewportX+t.viewportWidth>n||t.viewportY+t.viewportHeight>a),h=e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"rgba16f":"rgba8unorm";let l=null,u=null;t.camera.enablePicking&&this.renderObjectColors(t);const c=this._scenePass.cullScene(t,t.camera);t.sunLight=c.sunLight,t.clusteredLight=this.getClusteredLight(),t.clusteredLight.calculateLightIndex(t.camera,c),this.renderShadowMaps(t,c.shadowedLights);const d=t.compositor?1:t.primaryCamera.sampleCount;if(t.primaryCamera.depthPrePass||o||c.needSceneColor||t.scene.env.needSceneDepthTexture()||t.primaryCamera.oit||t.compositor?.requireLinearDepth()){const s="webgl"===e.type?"rgba8unorm":"r32f";if(r||i){const i=r?.getDepthAttachment();u=i?.isTexture2D()?e.pool.fetchTemporalFramebuffer(!0,i.width,i.height,s,i,!1):e.pool.fetchTemporalFramebuffer(!0,t.viewportWidth,t.viewportHeight,s,t.depthFormat,!1)}else u=e.pool.fetchTemporalFramebuffer(!0,n,a,s,t.depthFormat);this._renderSceneDepth(t,c,u),t.linearDepthTexture=u.getColorAttachments()[0],t.depthTexture=u.getDepthAttachment(),l=t.depthTexture===r?.getDepthAttachment()?r:e.pool.fetchTemporalFramebuffer(!0,t.depthTexture.width,t.depthTexture.height,h,t.depthTexture,!1,d)}else t.linearDepthTexture=null,t.depthTexture=null,l=i?e.pool.fetchTemporalFramebuffer(!0,t.viewportWidth,t.viewportHeight,h,t.depthFormat,!1,d):r;if(l&&l!==r?(e.pushDeviceStates(),e.setFramebuffer(l)):(e.setViewport(i),e.setScissor(s)),this._scenePass.clearDepth=1,this._scenePass.clearStencil=0,this._scenePass.transmission=!1,c.needSceneColor){const i=e.pool.fetchTemporalFramebuffer(!0,t.depthTexture.width,t.depthTexture.height,h,t.depthTexture,!0);e.pushDeviceStates(),e.setFramebuffer(i)}if(t.compositor?.begin(t),this._scenePass.render(t,null,c),t.compositor?.end(t),c.needSceneColor&&(t.sceneColorTexture=e.getFramebuffer().getColorAttachments()[0],e.popDeviceStates(),(new wa).blit(t.sceneColorTexture,e.getFramebuffer()??null,e.createSampler({magFilter:"nearest",minFilter:"nearest",mipFilter:"none"})),this._scenePass.transmission=!0,this._scenePass.clearColor=null,this._scenePass.clearDepth=null,this._scenePass.clearStencil=null,t.compositor?.begin(t),this._scenePass.render(t,null,c),t.compositor?.end(t)),c.dispose(),l&&l!==r){const n=new wa;o?n.destRect=[t.viewportX,t.viewportY,t.viewportWidth,t.viewportHeight]:n.viewport=i,n.scissor=s,n.srgbOut=!r;const a=l.getColorAttachments()[0];n.blit(a,r??null,e.createSampler({magFilter:"nearest",minFilter:"nearest",mipFilter:"none"})),e.popDeviceStates()}dh.releaseTemporalResources(t),this.freeClusteredLight(t.clusteredLight)}static renderShadowMaps(t,e){t.renderPass=this._shadowMapPass,t.device.pushDeviceStates();for(const i of e)i.shadow.render(t,this._shadowMapPass);t.device.popDeviceStates()}static renderObjectColors(t){if(!(t.camera instanceof ph))return;t.renderPass=this._objectColorPass,t.device.pushDeviceStates();const e=t.device.pool.fetchTemporalFramebuffer(!1,1,1,"rgba8unorm",t.depthFormat,!1);t.device.setViewport(t.camera.viewport);const i=t.device.getViewport(),s=t.camera.viewport,r=t.camera.scissor,n=t.camera.window,a=t.camera.pickPosX/i.width,o=(i.height-t.camera.pickPosY-1)/i.height,h=1/i.width,l=1/i.height;t.camera.viewport=null,t.camera.scissor=null,t.camera.window=[a,o,h,l],t.device.setFramebuffer(e),this._objectColorPass.clearColor=T.zero(),this._objectColorPass.clearDepth=1;const u=this._objectColorPass.cullScene(t,t.camera);this._objectColorPass.render(t,t.camera,u),t.camera.viewport=s,t.camera.scissor=r,t.camera.window=n,t.device.popDeviceStates();const c=e.getColorAttachments()[0],d=new Uint8Array(4),p=t.camera,m=t.device;p.pickResultAsync=new Promise(((t,i)=>{c.readPixels(0,0,1,1,0,0,d).then((()=>{const i=u.getDrawableByColor(d);p.pickResult=i&&i.getPickTarget()?.pickable?{drawable:i,node:i.getPickTarget()}:null,m.pool.releaseFrameBuffer(e),t(p.pickResult)})).catch((t=>{i(t)}))}))}}class xh{}class bh extends xh{static UNIFORM_NAME_IBL_RADIANCE_MAP="zIBLRadianceMap";static UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD="zIBLRadianceMapMaxLOD";static UNIFORM_NAME_IBL_IRRADIANCE_SH="zIBLIrradianceSH";_radianceMap;_irradianceSH;constructor(t,e){if(super(),this._radianceMap=t||null,e)if(this._irradianceSH=new Float32Array(36),e instanceof Float32Array){if(36!==e.length)throw new Error("3rd order SH coefficients expected");this._irradianceSH.set(e)}else{if(9!==e.length)throw new Error("3rd order SH coefficients expected");for(let t=0;t<9;t++)this._irradianceSH[4*t+0]=e[t].x,this._irradianceSH[4*t+1]=e[t].y,this._irradianceSH[4*t+2]=e[t].z}else this._irradianceSH=null}getType(){return"ibl-sh"}get radianceMap(){return this._radianceMap}set radianceMap(t){this._radianceMap=t}get irradianceSH(){return this._irradianceSH}set irradianceSH(t){if(t&&t.length<36)throw new Error("3rd order SH coefficients expected");this._irradianceSH=t}initShaderBindings(t){"fragment"===t.shaderKind&&(this._radianceMap&&(t.getGlobalScope()[bh.UNIFORM_NAME_IBL_RADIANCE_MAP]=t.texCube().uniform(0),t.getGlobalScope()[bh.UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD]=t.float().uniform(0)),this._irradianceSH&&(t.getGlobalScope()[bh.UNIFORM_NAME_IBL_IRRADIANCE_SH]=t.vec4[9]().uniform(0)))}updateBindGroup(t){this._radianceMap&&(t.setValue(bh.UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD,this._radianceMap.mipLevelCount-1),t.setTexture(bh.UNIFORM_NAME_IBL_RADIANCE_MAP,this._radianceMap)),this._irradianceSH&&t.setValue(bh.UNIFORM_NAME_IBL_IRRADIANCE_SH,this._irradianceSH)}getRadiance(t,e,i){const s=t.$builder;return q.instance.device.getDeviceCaps().shaderCaps.supportShaderTextureLod?s.textureSampleLevel(t[wh.UNIFORM_NAME_IBL_RADIANCE_MAP],e,s.mul(i,t[wh.UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD])).rgb:s.textureSample(t[wh.UNIFORM_NAME_IBL_RADIANCE_MAP],e).rgb}getIrradiance(t,e){const i=t.$builder;return i.func("Z_sh_Y0",[i.vec3("v")],(function(){this.$return(.2820947917)})),i.func("Z_sh_Y1",[i.vec3("v")],(function(){this.$return(i.mul(this.v.y,-.4886025119))})),i.func("Z_sh_Y2",[i.vec3("v")],(function(){this.$return(i.mul(this.v.z,.4886025119))})),i.func("Z_sh_Y3",[i.vec3("v")],(function(){this.$return(i.mul(this.v.x,-.4886025119))})),i.func("Z_sh_Y4",[i.vec3("v")],(function(){this.$return(i.mul(this.v.x,this.v.y,1.0925484306))})),i.func("Z_sh_Y5",[i.vec3("v")],(function(){this.$return(i.mul(this.v.y,this.v.z,-1.0925484306))})),i.func("Z_sh_Y6",[i.vec3("v")],(function(){this.$return(i.mul(i.sub(i.mul(this.v.z,this.v.z,3),1),.3153915652))})),i.func("Z_sh_Y7",[i.vec3("v")],(function(){this.$return(i.mul(this.v.x,this.v.z,-1.0925484306))})),i.func("Z_sh_Y8",[i.vec3("v")],(function(){this.$return(i.mul(i.sub(i.mul(this.v.x,this.v.x),i.mul(this.v.y,this.v.y)),.5462742153))})),i.func("Z_sh_eval",[i.vec3("v")],(function(){this.$l.c=i.mul(this[bh.UNIFORM_NAME_IBL_IRRADIANCE_SH][0].xyz,this.Z_sh_Y0(this.v)),this.c=i.add(this.c,i.mul(this[bh.UNIFORM_NAME_IBL_IRRADIANCE_SH][1].xyz,this.Z_sh_Y1(this.v))),this.c=i.add(this.c,i.mul(this[bh.UNIFORM_NAME_IBL_IRRADIANCE_SH][2].xyz,this.Z_sh_Y2(this.v))),this.c=i.add(this.c,i.mul(this[bh.UNIFORM_NAME_IBL_IRRADIANCE_SH][3].xyz,this.Z_sh_Y3(this.v))),this.c=i.add(this.c,i.mul(this[bh.UNIFORM_NAME_IBL_IRRADIANCE_SH][4].xyz,this.Z_sh_Y4(this.v))),this.c=i.add(this.c,i.mul(this[bh.UNIFORM_NAME_IBL_IRRADIANCE_SH][5].xyz,this.Z_sh_Y5(this.v))),this.c=i.add(this.c,i.mul(this[bh.UNIFORM_NAME_IBL_IRRADIANCE_SH][6].xyz,this.Z_sh_Y6(this.v))),this.c=i.add(this.c,i.mul(this[bh.UNIFORM_NAME_IBL_IRRADIANCE_SH][7].xyz,this.Z_sh_Y7(this.v))),this.c=i.add(this.c,i.mul(this[bh.UNIFORM_NAME_IBL_IRRADIANCE_SH][8].xyz,this.Z_sh_Y8(this.v))),this.$return(this.c)})),i.getGlobalScope().Z_sh_eval(e)}hasRadiance(){return!!this._radianceMap}hasIrradiance(){return!!this._irradianceSH}}class wh extends xh{static UNIFORM_NAME_IBL_RADIANCE_MAP="zIBLRadianceMap";static UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD="zIBLRadianceMapMaxLOD";static UNIFORM_NAME_IBL_IRRADIANCE_MAP="zIBLIrradianceMap";_radianceMap;_irradianceMap;constructor(t,e){super(),this._radianceMap=t||null,this._irradianceMap=e||null}getType(){return"ibl"}get radianceMap(){return this._radianceMap}set radianceMap(t){this._radianceMap=t}get irradianceMap(){return this._irradianceMap}set irradianceMap(t){this._irradianceMap=t}initShaderBindings(t){"fragment"===t.shaderKind&&(this._radianceMap&&(t.getGlobalScope()[wh.UNIFORM_NAME_IBL_RADIANCE_MAP]=t.texCube().uniform(0),t.getGlobalScope()[wh.UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD]=t.float().uniform(0)),this._irradianceMap&&(t.getGlobalScope()[wh.UNIFORM_NAME_IBL_IRRADIANCE_MAP]=t.texCube().uniform(0)))}updateBindGroup(t){this._radianceMap&&(t.setValue(wh.UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD,this._radianceMap.mipLevelCount-1),t.setTexture(wh.UNIFORM_NAME_IBL_RADIANCE_MAP,this._radianceMap)),this._irradianceMap&&t.setTexture(wh.UNIFORM_NAME_IBL_IRRADIANCE_MAP,this._irradianceMap)}getRadiance(t,e,i){const s=t.$builder;return q.instance.device.getDeviceCaps().shaderCaps.supportShaderTextureLod?s.textureSampleLevel(t[wh.UNIFORM_NAME_IBL_RADIANCE_MAP],e,s.mul(i,t[wh.UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD])).rgb:s.textureSample(t[wh.UNIFORM_NAME_IBL_RADIANCE_MAP],e).rgb}getIrradiance(t,e){return t.$builder.textureSampleLevel(t[wh.UNIFORM_NAME_IBL_IRRADIANCE_MAP],e,0).rgb}hasRadiance(){return!!this._radianceMap}hasIrradiance(){return!!this._irradianceMap}}class Th extends xh{static UNIFORM_NAME_CONSTANT_AMBIENT="zConstantAmbient";_ambientColor;constructor(t){super(),this._ambientColor=t?new T(t):new T(0,0,0,1)}get ambientColor(){return this._ambientColor}set ambientColor(t){t&&this._ambientColor.set(t)}getType(){return"constant"}initShaderBindings(t){"fragment"===t.shaderKind&&(t.getGlobalScope()[Th.UNIFORM_NAME_CONSTANT_AMBIENT]=t.vec4().uniform(0))}updateBindGroup(t){t.setValue(Th.UNIFORM_NAME_CONSTANT_AMBIENT,this._ambientColor)}getRadiance(t,e,i){return null}getIrradiance(t,e){return t[Th.UNIFORM_NAME_CONSTANT_AMBIENT].rgb}hasRadiance(){return!1}hasIrradiance(){return!0}}class vh extends xh{static UNIFORM_NAME_AMBIENT_UP="zHemisphericAmbientUp";static UNIFORM_NAME_AMBIENT_DOWN="zHemisphericAmbientDown";_ambientUp;_ambientDown;constructor(t,e){super(),this._ambientUp=new T(t),this._ambientDown=new T(e)}get ambientUp(){return this._ambientUp}set ambientUp(t){t&&this._ambientUp.set(t)}get ambientDown(){return this._ambientDown}set ambientDown(t){t&&this._ambientDown.set(t)}getType(){return"hemisphere"}initShaderBindings(t){"fragment"===t.shaderKind&&(t.getGlobalScope()[vh.UNIFORM_NAME_AMBIENT_UP]=t.vec4().uniform(0),t.getGlobalScope()[vh.UNIFORM_NAME_AMBIENT_DOWN]=t.vec4().uniform(0))}updateBindGroup(t){t.setValue(vh.UNIFORM_NAME_AMBIENT_UP,this._ambientUp),t.setValue(vh.UNIFORM_NAME_AMBIENT_DOWN,this._ambientDown)}getRadiance(t,e,i){return null}getIrradiance(t,e){const i=t.$builder,s=i.add(i.mul(e.y,.5),.5);return i.mix(t[vh.UNIFORM_NAME_AMBIENT_DOWN],t[vh.UNIFORM_NAME_AMBIENT_UP],s).rgb}hasRadiance(){return!1}hasIrradiance(){return!0}}class yh{_ray;_rayLocal;_intersected;_intersectedDist;constructor(t,e){this._ray=t,this._rayLocal=new P,this._intersected=null,this._intersectedDist=e}get intersected(){return this._intersected}get intersectedDist(){return this._intersectedDist}get intersectedPoint(){return b.add(this._ray.origin,b.scale(this._ray.direction,this._intersectedDist))}visit(t){return t instanceof Ca?this.visitOctreeNode(t):t.isMesh()?this.visitMesh(t):!!t.isTerrain()&&this.visitTerrain(t)}visitTerrain(t){if(!t.hidden&&t.pickable){this._ray.transform(t.invWorldMatrix,this._rayLocal);const e=t.rayIntersect(this._rayLocal);if(null!==e&&e<this._intersectedDist)return this._intersectedDist=e,this._intersected=t,!0}return!1}visitMesh(t){if(!t.hidden&&t.pickable){this._ray.transform(t.invWorldMatrix,this._rayLocal);const e=t.primitive.raycast(this._rayLocal);if(null!==e&&e<this._intersectedDist)return this._intersectedDist=e,this._intersected=t.getPickTarget()??t,!0}return!1}visitOctreeNode(t){if(0===t.getLevel()||null!==this._ray.bboxIntersectionTest(t.getBoxLoosed())){const e=t.getNodes();for(let t=0;t<e.length;t++)this.visit(e[t]);return!0}return!1}}class Eh{_envLight;_ambientColor;_ambientDown;_ambientUp;_radianceMap;_irradianceMap;_irradianceSH;_strength;constructor(){this._envLight=new wh,this._ambientColor=new T(.2,.2,.2,1),this._ambientDown=new T(.2,.2,.2,1),this._ambientUp=new T(.3,.5,.8,1),this._radianceMap=null,this._irradianceMap=null,this._strength=1}getHash(t){return t.drawEnvLight?`${this.type}:${this._envLight.hasRadiance()?"1":"0"}:${this._envLight.hasIrradiance()?"1":"0"}`:"none"}get envLight(){return this._envLight}get strength(){return this._strength}set strength(t){this._strength=t}get ambientColor(){return this._ambientColor.clone()}set ambientColor(t){this._ambientColor.set(t),"constant"===this.type&&(this._envLight.ambientColor=this._ambientColor)}get ambientUp(){return this._ambientUp.clone()}set ambientUp(t){this._ambientUp.set(t),"hemisphere"===this.type&&(this._envLight.ambientUp=this._ambientUp)}get ambientDown(){return this._ambientDown.clone()}set ambientDown(t){this._ambientDown.set(t),"hemisphere"===this.type&&(this._envLight.ambientDown=this._ambientDown)}get radianceMap(){return this._radianceMap}set radianceMap(t){this._radianceMap=t??null,("ibl"===this.type||"ibl-sh"===this.type)&&(this._envLight.radianceMap=this._radianceMap)}get irradianceMap(){return this._irradianceMap}set irradianceMap(t){this._irradianceMap=t??null,"ibl"===this.type&&(this._envLight.irradianceMap=this._irradianceMap)}get irradianceSH(){return this._irradianceSH}set irradianceSH(t){this._irradianceSH=t??null,"ibl-sh"===this.type&&(this._envLight.irradianceSH=this._irradianceSH)}get type(){return this._envLight?.getType()??"none"}set type(t){switch(t){case"none":this._envLight=null;break;case"ibl":this._envLight?.getType()!==t&&(this._envLight=new wh(this._radianceMap,this._irradianceMap)),this._envLight.radianceMap=this.radianceMap,this._envLight.irradianceMap=this.irradianceMap;break;case"ibl-sh":this._envLight?.getType()!==t&&(this._envLight=new bh(this._radianceMap,this._irradianceSH)),this._envLight.radianceMap=this.radianceMap,this._envLight.irradianceSH=this.irradianceSH;break;case"constant":this._envLight?.getType()!==t&&(this._envLight=new Th(this._ambientColor));break;case"hemisphere":this._envLight?.getType()!==t&&(this._envLight=new vh(this._ambientUp,this._ambientDown))}}}class Sh{_sky;_light;constructor(){this._sky=new Vo,this._light=new Eh}get sky(){return this._sky}get light(){return this._light}getHash(t){return`${this.light?.getHash(t)}:${this._sky?.getHash(t)}`}needSceneDepthTexture(){return"none"!==this._sky.fogType}}class Ch{static NAME="sceneupdate";scene;type=Ch.NAME;constructor(t){this.scene=t}}class Ah extends(s(Object)()){static _nextId=0;_rootNode;_octree;_nodePlaceList;_env;_updateEvent;_updateFrame;_animationSet;_id;constructor(){super(),this._id=++Ah._nextId,this._octree=new Ma(this,8,8),this._nodePlaceList=new Set,this._env=new Sh,this._updateEvent=new Ch(this),this._updateFrame=-1,this._animationSet=[],this._rootNode=new Bo(this)}get animationSet(){return this._animationSet}get id(){return this._id}get rootNode(){return this._rootNode}get octree(){return this.updateNodePlacement(this._octree,this._nodePlaceList),this._octree}get boundingBox(){return this.updateNodePlacement(this._octree,this._nodePlaceList),this._octree.getRootNode().getBoxLoosed()}get env(){return this._env}dispose(){this._rootNode=null}raycast(t,e=1/0){const i=new yh(t,e);return this.octree.getRootNode().traverse(i),i.intersected?{node:i.intersected,dist:i.intersectedDist,point:i.intersectedPoint}:null}constructRay(t,e,i,s,r,n){const a=new T(2*s/e-1,1-2*r/i,1,1),o=t.invViewProjectionMatrix.transform(a);o.scaleBy(1/o.w);let h=t.getWorldPosition(),l=b.sub(o.xyz(),h).inplaceNormalize();return n&&(h=n.transformPointAffine(h),l=n.transformVectorAffine(l)),new P(h,l)}invalidateNodePlacement(t){(t.placeToOctree||t.octreeNode)&&this._nodePlaceList.add(t)}frameUpdate(){const t=q.instance.device.frameInfo;if(t.frameCounter!==this._updateFrame){this._updateFrame=t.frameCounter;for(const t of this._animationSet)t.update();"ibl"===this.env.light.type&&(this.env.light.radianceMap?this.env.light.radianceMap===this.env.sky.radianceMap&&"none"===this.env.sky.skyType&&(this.env.light.radianceMap=null):"none"!==this.env.sky.skyType&&(this.env.light.radianceMap=this.env.sky.radianceMap),this.env.light.irradianceMap?this.env.light.irradianceMap===this.env.sky.irradianceMap&&"none"===this.env.sky.skyType&&(this.env.light.irradianceMap=null):"none"!==this.env.sky.skyType&&(this.env.light.irradianceMap=this.env.sky.irradianceMap)),this.dispatchEvent(this._updateEvent),this.updateNodePlacement(this._octree,this._nodePlaceList)}}updateNodePlacement(t,e){function i(i,s){s&&!i.hidden&&i.placeToOctree?t.placeNode(i):t.removeNode(i),e.delete(i)}if(e.size>0)for(;e.size>0;){const s=e.keys().next().value;t?i(s,s.attached):e.delete(s)}}}class Mh extends Bo{_octreeNode;constructor(t){super(t),this._octreeNode=null}get octreeNode(){return this._octreeNode}set octreeNode(t){this._octreeNode=t}getName(){return this._name}isGraphNode(){return!0}getXForm(){return this}getBoneMatrices(){return null}getInvBindMatrix(){return null}getSortDistance(t){const e=t.worldMatrix,i=this.worldMatrix,s=e.m03-i.m03,r=e.m13-i.m13,n=e.m23-i.m23;return s*s+r*r*n*n}isBatchable(){return!1}_visibleChanged(){this._scene?.invalidateNodePlacement(this)}}class Rh extends Mh{_type;_intensity;_positionRange;_directionCutoff;_diffuseIntensity;constructor(t,e){super(t),this._intensity=1,this._type=e,this._positionRange=null,this._directionCutoff=null,this._diffuseIntensity=null}get lightType(){return this._type}get intensity(){return this._intensity}set intensity(t){this.setIntensity(t)}get positionAndRange(){return this._positionRange||this.computeUniforms(),this._positionRange}get directionAndCutoff(){return this._directionCutoff||this.computeUniforms(),this._directionCutoff}get diffuseAndIntensity(){return this._diffuseIntensity||this.computeUniforms(),this._diffuseIntensity}get viewMatrix(){return this.invWorldMatrix}get viewProjMatrix(){return null}setIntensity(t){return this._intensity!==t&&(this._intensity=t,this.invalidateUniforms()),this}invalidateUniforms(){this._positionRange=null,this._directionCutoff=null,this._diffuseIntensity=null}isLight(){return!0}isPunctualLight(){return!1}isDirectionLight(){return!1}isPointLight(){return!1}isSpotLight(){return!1}}class Fh extends Rh{_color;_castShadow;_lightViewProjectionMatrix;_shadowMapper;constructor(t,e){super(t,e),this._color=T.one(),this._castShadow=!1,this._lightViewProjectionMatrix=S.identity(),this._shadowMapper=new dh(this)}get color(){return this._color}set color(t){this.setColor(t)}setColor(t){return this._color.set(t),this.invalidateUniforms(),this}get castShadow(){return this._castShadow}set castShadow(t){this.setCastShadow(t)}setCastShadow(t){return this._castShadow=t,this}get viewProjMatrix(){return this._lightViewProjectionMatrix}set viewProjMatrix(t){this.setLightViewProjectionMatrix(t)}get shadow(){return this._shadowMapper}setLightViewProjectionMatrix(t){return this._lightViewProjectionMatrix.set(t),this}isPunctualLight(){return!0}_onTransformChanged(t){super._onTransformChanged(t),this.invalidateUniforms()}}class Ih extends Fh{static _currentSunLight=null;_sunLight;constructor(t){super(t,Ia),Ih._currentSunLight?this._sunLight=!1:(Ih._currentSunLight=this,this._sunLight=!0)}get sunLight(){return this._sunLight}set sunLight(t){!!t!==this._sunLight&&(this._sunLight=!!t,this._sunLight?(Ih._currentSunLight._sunLight=!1,Ih._currentSunLight=this):Ih._currentSunLight=null),this._sunLight=!!t}isDirectionLight(){return!0}computeBoundingVolume(t){return null}computeUniforms(){const t=this.worldMatrix.getRow(3),e=this.worldMatrix.getRow(2).scaleBy(-1);this._positionRange=new T(t.x,t.y,t.z,-1),this._directionCutoff=new T(e.x,e.y,e.z,0),this._diffuseIntensity=new T(this.color.x,this.color.y,this.color.z,this.intensity)}}let Dh=0;function $h(t){return class extends t{_mdRenderQueueRef;_mdDrawableBindGroup;_mdDrawableBindGroupInstanced;_mdDrawableBindGroupSkin;_mdDrawableBindGroupMorph;_mdDrawableBindGroupSkinMorph;_id;_objectColor;constructor(...t){super(...t),this._id=++Dh,this._objectColor=null,this._mdRenderQueueRef=[],this._mdDrawableBindGroup=null,this._mdDrawableBindGroupInstanced=new Map,this._mdDrawableBindGroupSkin=null,this._mdDrawableBindGroupMorph=null,this._mdDrawableBindGroupSkinMorph=null,this.getXForm().on("transformchanged",(t=>{for(const t of this._mdRenderQueueRef)t.ref&&this.applyTransformUniforms(t.ref)}))}getId(){return this._id}getObjectColor(){if(!this._objectColor){const t=(255&this._id)/255,e=(this._id>>>8&255)/255,i=(this._id>>>16&255)/255,s=(this._id>>>24&255)/255;this._objectColor=new T(s,i,e,t)}return this._objectColor}pushRenderQueueRef(t){this.renderQueueRefPrune(),this._mdRenderQueueRef.push(t)}renderQueueRefPrune(){for(;this._mdRenderQueueRef.length>0;){const t=this._mdRenderQueueRef[this._mdRenderQueueRef.length-1].ref;if(t)return t;this._mdRenderQueueRef.pop()}return null}applyInstanceOffsetAndStride(t,e,i){const s=this.getDrawableBindGroup(q.instance.device,!0,t);s.setValue(Qa.getInstanceDataStrideUniformName(),e>>2),s.setValue(Qa.getInstanceDataOffsetUniformName(),i>>2)}applyTransformUniforms(t){const e=t.getInstanceInfo(this),i=this.getDrawableBindGroup(q.instance.device,!!e,t);e?e.bindGroup.bindGroup.setRawData(Qa.getInstanceDataUniformName(),4*e.offset,this.getXForm().worldMatrix,0,16):i.setValue(Qa.getWorldMatrixUniformName(),this.getXForm().worldMatrix)}applyMaterialUniforms(t){const e=this.getInstanceUniforms();e&&t.bindGroup.bindGroup.setRawData(Qa.getInstanceDataUniformName(),4*(t.offset+16),e,0,e.length)}bind(t){const e=t.device,i=this.getDrawableBindGroup(e,!!t.instanceData,t.renderQueue);if(e.setBindGroup(1,i),e.setBindGroup(3,t.instanceData?t.instanceData.bindGroup.bindGroup:null),t.skinAnimation){const t=this.getBoneMatrices();i.setTexture(Qa.getBoneMatricesUniformName(),t),i.setValue(Qa.getBoneInvBindMatrixUniformName(),this.getInvBindMatrix()),i.setValue(Qa.getBoneTextureSizeUniformName(),t.width)}if(t.morphAnimation){const t=this.getMorphData(),e=this.getMorphInfo();i.setTexture(Qa.getMorphDataUniformName(),t),i.setBuffer(Qa.getMorphInfoUniformName(),e)}}getDrawableBindGroup(t,e,i){const s=!!this.getBoneMatrices(),r=!!this.getMorphData();let n=e?this._mdDrawableBindGroupInstanced.get(i):s&&r?this._mdDrawableBindGroupSkinMorph:s?this._mdDrawableBindGroupSkin:r?this._mdDrawableBindGroupMorph:this._mdDrawableBindGroup;if(!n){const a=new Un(t).buildRender({vertex(t){Qa.vertexShaderDrawableStuff(this,s,r,e),t.main((function(){}))},fragment(t){t.main((function(){}))}});if(n=t.createBindGroup(a[2][1]),e)this._mdDrawableBindGroupInstanced.set(i,n);else if(s&&r)this._mdDrawableBindGroupSkinMorph=n;else if(s)this._mdDrawableBindGroupSkin=n;else if(r){const t=a[2][1],e=t.nameMap?.[Qa.getMorphInfoUniformName()]??Qa.getMorphInfoUniformName();for(let i=0;i<t.entries.length;i++){const s=t.entries[i];if(s.name===e){console.log(s.type);break}}this._mdDrawableBindGroupMorph=n}else this._mdDrawableBindGroup=n}return n}}}class Lh extends(i(Mh,$h)){_primitive;_material;_castShadow;_bboxChangeCallback;_animatedBoundingBox;_boneMatrices;_invBindMatrix;_morphData;_morphInfo;_instanceHash;_batchable;_boundingBoxNode;_instanceColor;constructor(t,e,i){super(t),this._primitive=null,this._material=null,this._castShadow=!0,this._animatedBoundingBox=null,this._boneMatrices=null,this._invBindMatrix=null,this._morphData=null,this._morphInfo=null,this._instanceHash=null,this._boundingBoxNode=null,this._instanceColor=T.zero(),this._batchable="webgl"!==q.instance.deviceType,this._bboxChangeCallback=this._onBoundingboxChange.bind(this),this.primitive=e??null,this.material=i??Lh._getDefaultMaterial()}getName(){return this._name}getInstanceId(t){return`${this._instanceHash}:${this.worldMatrixDet>=0}`}getInstanceUniforms(){return this.material.$instanceUniforms}getInstanceColor(){return this._instanceColor}getPickTarget(){return this}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t}get primitive(){return this._primitive}set primitive(t){t!==this._primitive&&(this._primitive&&this._primitive.removeBoundingboxChangeCallback(this._bboxChangeCallback),this._primitive=t||null,this._primitive&&this._primitive.addBoundingboxChangeCallback(this._bboxChangeCallback),this._instanceHash=this._primitive&&this._material?`${this.constructor.name}:${this._scene.id}:${this._primitive.id}:${this._material.instanceId}`:null,this.invalidateBoundingVolume())}get material(){return this._material}set material(t){this._material!==t&&(this._material=t,this._instanceHash=this._primitive&&this._material?`${this.constructor.name}:${this._scene.id}:${this._primitive.id}:${this._material.instanceId}`:null)}get drawBoundingBox(){return!!this._boundingBoxNode}set drawBoundingBox(t){!!this._boundingBoxNode!=!!t&&(t?(Lh._defaultBoxFrame||(Lh._defaultBoxFrame=new Ea({size:1})),this._boundingBoxNode=new Lh(this._scene,Lh._defaultBoxFrame).reparent(this),this._boundingBoxNode.scale.set(this.getBoundingVolume().toAABB().size),this._boundingBoxNode.position.set(this.getBoundingVolume().toAABB().minPoint)):(this._boundingBoxNode.remove(),this._boundingBoxNode=null))}isMesh(){return!0}setAnimatedBoundingBox(t){this._animatedBoundingBox=t,this.invalidateBoundingVolume()}setBoneMatrices(t){this._boneMatrices=t}setInvBindMatrix(t){this._invBindMatrix=t}setMorphData(t){this._morphData=t}getMorphData(){return this._morphData}setMorphInfo(t){this._morphInfo=t}getMorphInfo(){return this._morphInfo}isBatchable(){return this._batchable&&!this._boneMatrices&&!this._morphData&&this._material?.isBatchable()}dispose(){this._primitive=null,this._material=null,super.dispose()}getQueueType(){return this.material?.getQueueType()??1}isUnlit(){return!this.material?.supportLighting()}needSceneColor(){return this.material?.needSceneColor()}draw(t){this.bind(t),this.material.draw(this.primitive,t)}getMaterial(){return this.material}getBoneMatrices(){return this._boneMatrices}getInvBindMatrix(){return this._invBindMatrix}getXForm(){return this}computeBoundingVolume(t){let e;if(this._animatedBoundingBox)e=this._animatedBoundingBox;else{const t=this.primitive;e=t?t.getBoundingVolume():null}return e&&this._boundingBoxNode&&(this._boundingBoxNode.scale.set(e.toAABB().size),this._boundingBoxNode.position.set(e.toAABB().minPoint)),e}_onBoundingboxChange(){this.invalidateBoundingVolume()}static _defaultMaterial=null;static _defaultBoxFrame=null;static _getDefaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=new lo),this._defaultMaterial}}class Ph{_terrain;constructor(t){this._terrain=t}getXForm(){return this._terrain}}class Nh extends(i(Ph,$h)){_geometry;_geometryLines;_quadtree;_mipLevel;_offsetX;_offsetZ;_step;_boundingBox;_lodDistance;_maxError;_parent;_offsetScale;constructor(t){super(t),this._geometry=null,this._geometryLines=null,this._mipLevel=0,this._offsetX=0,this._offsetZ=0,this._boundingBox=null,this._parent=null,this._offsetScale=null,this._quadtree=null,this._step=0,this._lodDistance=0}initialize(t,e,i,s,r,n,a,o){const h=t.getPatchSize(),l=t.getRootSize();this._mipLevel=e?e.getMipLevel()+1:0;const u=Math.floor((l-1)/(h-1))>>this._mipLevel,c=(h-1)*u,d=e?e.getOffsetX():0,p=e?e.getOffsetZ():0;if(this._offsetX=d+i*c,this._offsetZ=p+s*c,(this._offsetX+c>=t.getRootSizeX()||this._offsetZ+c>=t.getRootSizeZ())&&(r=null),this._quadtree=t,this._step=u,this._parent=e,this._geometry=r?new da:null,this._geometryLines=r?new da:null,this._maxError=r?this.computeMaxError():0,r){const t=this._quadtree.getScaleX(),e=this._quadtree.getScaleZ();1===u&&(this._boundingBox=new Ta,this._boundingBox.minPoint.x=this._offsetX*t,this._boundingBox.minPoint.y=Number.MAX_VALUE,this._boundingBox.minPoint.z=this._offsetZ*e,this._boundingBox.maxPoint.x=this._offsetX*t+(this._quadtree.getPatchSize()-1)*this._step*t,this._boundingBox.maxPoint.y=-Number.MAX_VALUE,this._boundingBox.maxPoint.z=this._offsetZ*e+(this._quadtree.getPatchSize()-1)*this._step*e),this.setupVertices(this.computeSkirtLength(),r,n,a,o),this._offsetScale=new T(this._step*t,this._offsetX*t,this._step*e,this._offsetZ*e)}return!0}getInstanceColor(){return this._terrain.getInstanceColor()}getPickTarget(){return this._terrain}getMaterial(){return this._terrain.material}draw(t){const e=1===t.renderPass.type,i=this._quadtree.getTerrain().wireframe&&!e?this.getGeometryWireframe():this.getGeometry();this.bind(t),this._terrain.material.draw(i,t)}setupCamera(t,e,i){this._lodDistance=i>0&&e>0?this.computeLodDistance(t,e,i):-1}getName(){return"TerrainPatch"}getBoneMatrices(){return null}getInvBindMatrix(){return null}getMorphData(){return null}getMorphInfo(){return null}getSortDistance(t){return this._quadtree.getTerrain().getSortDistance(t)}getQueueType(){return 1}isUnlit(){return!1}needSceneColor(){return!1}isBatchable(){return!1}setupVertices(t,e,i,s,r){const n=this,a=this._quadtree.getScaleX()*this._step,o=this._quadtree.getScaleZ()*this._step,h=this._quadtree.getScaleX()*this._offsetX,l=this._quadtree.getScaleZ()*this._offsetZ;function u(t,u,c,d,p,m,f){const _=d+p*m,g=r[_]*s;return u[3*c+0]=i[_].x,u[3*c+1]=i[_].y,u[3*c+2]=i[_].z,t[3*c+0]=e[3*c+0]*a+h,t[3*c+1]=g+f,t[3*c+2]=e[3*c+2]*o+l,n._boundingBox&&(n._boundingBox.maxPoint.y<g&&(n._boundingBox.maxPoint.y=g),n._boundingBox.minPoint.y>g&&(n._boundingBox.minPoint.y=g)),c+1}const c=this._quadtree.getPatchSize(),d=(c+2)*(c+2),p=new Float32Array(3*d),m=new Float32Array(3*d);let f=this._offsetX,_=this._offsetZ,g=0;const x=this._quadtree.getHeightField().getSizeX();g=u(p,m,g,f,_,x,-t);for(let e=0;e<c;e++,f+=this._step)g=u(p,m,g,f,_,x,-t);g=u(p,m,g,f-this._step,_,x,-t),_=this._offsetZ;for(let e=0;e<c;e++,_+=this._step){f=this._offsetX,g=u(p,m,g,f,_,x,-t);for(let t=0;t<c;t++,f+=this._step)g=u(p,m,g,f,_,x,0);g=u(p,m,g,f-this._step,_,x,-t)}f=this._offsetX,_-=this._step,g=u(p,m,g,f,_,x,-t);for(let e=0;e<c;e++,f+=this._step)g=u(p,m,g,f,_,x,-t);g=u(p,m,g,f-this._step,_,x,-t);const b=q.instance.device.createVertexBuffer("position_f32x3",p),w=q.instance.device.createVertexBuffer("normal_f32x3",m);this._geometry.setVertexBuffer(b),this._geometry.setVertexBuffer(w),this._geometry.setIndexBuffer(this._quadtree.getIndices()),this._geometry.indexStart=0,this._geometry.indexCount=this._quadtree.getIndices().length,this._geometry.primitiveType="triangle-strip",this._geometryLines.setVertexBuffer(b),this._geometryLines.setVertexBuffer(w),this._geometryLines.setIndexBuffer(this._quadtree.getIndicesWireframe()),this._geometryLines.indexStart=0,this._geometryLines.indexCount=this._quadtree.getIndicesWireframe().length,this._geometryLines.primitiveType="line-list"}getOffsetScale(){if(!this._offsetScale){const t=this._quadtree.getScaleX(),e=this._quadtree.getScaleZ();this._offsetScale=new T(this._step*t,this._offsetX*t,this._step*e,this._offsetZ*e)}return this._offsetScale}getBoundingBox(){return this._boundingBox}setBoundingBox(t){this._boundingBox=t}getMipLevel(){return this._mipLevel}getOffsetX(){return this._offsetX}getOffsetZ(){return this._offsetZ}getStep(){return this._step}getLODDistance(){return this._lodDistance}getGeometry(){return this._geometry}getGeometryWireframe(){return this._geometryLines}getHeight(t,e){const i=this._offsetX+this._step*Math.floor((t-this._offsetX)/this._step),s=this._offsetZ+this._step*Math.floor((e-this._offsetZ)/this._step),r=i==t?i:i+this._step,n=s==e?s:s+this._step,a=this._quadtree.getHeightField(),o=a.getHeight(i,s),h=a.getHeight(r,s),l=a.getHeight(i,n),u=a.getHeight(r,n),c=(t-i)/this._step,d=o+(h-o)*c;return d+(l+(u-l)*c-d)*((e-s)/this._step)}computeMaxError(){if(1===this._step)return 0;let t=0;const e=this._step*(this._quadtree.getPatchSize()-1),i=this._quadtree.getRootSize(),s=this._quadtree.getHeightField();for(let r=this._offsetZ;r<=this._offsetZ+e;r++)for(let n=this._offsetX;n<=this._offsetX+e;n++){const e=this._offsetZ+Math.floor((r-this._offsetZ)/this._step)*this._step,a=this._offsetX+Math.floor((n-this._offsetX)/this._step)*this._step;if(e===i-1||a===i-1)continue;const o=e+this._step,h=a+this._step,l=s.getHeight(a,e),u=s.getHeight(h,e),c=s.getHeight(a,o),d=s.getHeight(h,o),p=(r-e)/this._step,m=(n-a)/this._step,f=s.getHeight(n,r),_=l+m*(u-l),g=_+p*(c+m*(d-c)-_),x=Math.abs(f-g);x>t&&(t=x)}return t}computeSkirtLength(){let t=0,e=this._parent;for(;e;){const i=this.computeErrorMetric(e);i>t&&(t=i),e=e._parent}return t}computeErrorMetric(t){let e=0;if(t.getMipLevel()>this._mipLevel){const i=t.getOffsetX(),s=t.getOffsetZ(),r=t.getStep(),n=t.getStep()*this._quadtree.getPatchSize();for(let a=s;a<s+n;a+=r)for(let s=i;s<i+n;s+=r){const i=Math.abs(this.getHeight(s,a)-t.getHeight(s,a));i>e&&(e=i)}}else if(t.getMipLevel()<this._mipLevel){const i=this._step*(this._quadtree.getPatchSize()-1);for(let s=this._offsetZ;s<=this._offsetZ+i;s+=this._step)for(let r=this._offsetX;r<=this._offsetX+i;r+=this._step){const i=Math.abs(this.getHeight(r,s)-t.getHeight(r,s));i>e&&(e=i)}}return e}computeBoundingBox(t){const[e,i]=this.computeHeightBound(),s=this._quadtree.getScaleX(),r=this._quadtree.getScaleZ();t.minPoint=new b(this._offsetX*s,i,this._offsetZ*r),t.maxPoint=new b(this._offsetX*s+(this._quadtree.getPatchSize()-1)*this._step*s,e,this._offsetZ*r+(this._quadtree.getPatchSize()-1)*this._step*r)}computeLodDistance(t,e,i){return.5*this._maxError*t/(i*e)}sqrDistanceToPoint(t){const e=this.getBoundingBox(),i=Math.sqrt(e.extents.x*e.extents.x+e.extents.z*e.extents.z),s=t.x-e.center.x,r=t.z-e.center.z,n=Math.max(0,Math.sqrt(s*s+r*r)-i),a=t.y>e.maxPoint.y?t.y-e.maxPoint.y:t.y<e.minPoint.y?e.minPoint.y-t.y:0;return n*n+a*a}sqrDistancePointToTriangle(t,e,i,s){const r=e,n=b.sub(i,r),a=b.sub(s,r),o=b.sub(r,t),h=b.dot(n,n),l=b.dot(n,a),u=b.dot(a,a),c=b.dot(n,o),d=b.dot(a,o),p=b.dot(o,o),m=h*u-l*l;let f,_=l*d-u*c,g=l*c-h*d;if(_+g<=m)_<0?g<0&&c<0?(g=0,-c>=h?(_=1,f=h+2*c+p):(_=-c/h,f=c*_+p)):(_=0,d>=0?(g=0,f=p):-d>=u?(g=1,f=u+2*d+p):(g=-d/u,f=d*g+p)):g<0?(g=0,c>=0?(_=0,f=p):-c>=h?(_=1,f=h+2*c+p):(_=-c/h,f=c*_+p)):(_/=m,g/=m,f=_*(h*_+l*g+2*c)+g*(l*_+u*g+2*d)+p);else if(_<0){const t=l+c,e=u+d;if(e>t){const i=e-t,s=h-2*l+u;i>=s?(_=1,g=0,f=h+2*c+p):(_=i/s,g=1-_,f=_*(h*_+l*g+2*c)+g*(l*_+u*g+2*d)+p)}else _=0,e<=0?(g=1,f=u+2*d+p):d>=0?(g=0,f=p):(g=-d/u,f=d*g+p)}else if(g<0){const t=l+d,e=h+c;if(e>t){const i=e-t,s=h-2*l+u;i>=s?(g=1,_=0,f=u+2*d+p):(g=i/s,_=1-g,f=_*(h*_+l*g+2*c)+g*(l*_+u*g+2*d)+p)}else g=0,e<=0?(_=1,f=h+2*c+p):c>=0?(_=0,f=p):(_=-c/h,f=c*_+p)}else{const t=u+d-l-c;if(t<=0)_=0,g=1,f=u+2*d+p;else{const e=h-2*l+u;t>=e?(_=1,g=0,f=h+2*c+p):(_=t/e,g=1-_,f=_*(h*_+l*g+2*c)+g*(l*_+u*g+2*d)+p)}}return f<0&&(f=0),f}computeHeightBound(){let t=-Number.MAX_VALUE,e=Number.MAX_VALUE;const i=this._step*(this._quadtree.getPatchSize()-1),s=this._quadtree.getHeightField(),r=Math.min(s.getSizeZ()-1,this._offsetZ+i),n=Math.min(s.getSizeX()-1,this._offsetX+i);for(let i=this._offsetZ;i<=r;i++)for(let r=this._offsetX;r<=n;r++){const n=s.getHeight(r,i);n>t&&(t=n),n<e&&(e=n)}return[t,e]}isDummy(){return!this._geometry&&!!this._quadtree}}class Bh{_resX;_resY;_spacingX;_spacingZ;_heights;_rootNode;constructor(t,e,i,s,r){this._rootNode=null,this._heights=null,this._spacingX=i,this._spacingZ=s,this.create(t,e,r)}create(t,e,i){this._resX=t,this._resY=e,this._rootNode=this.allocNode(),this._heights=new Float32Array(t*e);for(let t=0;t<this._heights.length;t++)this._heights[t]=i[t].y;return this.createChildNode(this._rootNode,0,0,t,e,i),!0}getHeight(t,e){return this._heights[(this._resY-1-e)*this._resX+t]}getNormal(t,e,i){i=i??new b,t=Math.max(0,Math.min(t,this._resX-2)),e=Math.max(0,Math.min(e,this._resY-2));const s=this._heights[t+e*this._resX],r=this._heights[t+(e+1)*this._resX],n=this._heights[t+1+(e+1)*this._resX],a=this._heights[t+1+e*this._resX],o=.5*(s+r-n-a),h=.5*(s+a-r-n),l=(this._rootNode.bbox.maxPoint.x-this._rootNode.bbox.minPoint.x)/(this._resX-1),u=(this._rootNode.bbox.maxPoint.z-this._rootNode.bbox.minPoint.z)/(this._resY-1);return i.setXYZ(o*u,2*l*u,-h*l).inplaceNormalize(),i}getRealNormal(t,e,i){i=i??new b,t-=this._rootNode.bbox.minPoint.x,e-=this._rootNode.bbox.minPoint.z;const s=t/((this._rootNode.bbox.maxPoint.x-this._rootNode.bbox.minPoint.x)/(this._resX-1)),r=e/((this._rootNode.bbox.maxPoint.z-this._rootNode.bbox.minPoint.z)/(this._resY-1));let n=Math.floor(s),a=Math.floor(r),o=n+1,h=a+1;n<0&&(n=0),a<0&&(a=0),o>=this._resX&&(o=this._resX-1),h>=this._resY&&(h=this._resY-1);const l=this.getNormal(n,a),u=this.getNormal(n,h),c=this.getNormal(o,a),d=this.getNormal(o,h);return l.addBy(u).addBy(c).addBy(d).scaleBy(.25).inplaceNormalize(),i.set(l),i}getRealHeight(t,e){t-=this._rootNode.bbox.minPoint.x,e-=this._rootNode.bbox.minPoint.z;const i=t/((this._rootNode.bbox.maxPoint.x-this._rootNode.bbox.minPoint.x)/(this._resX-1)),s=e/((this._rootNode.bbox.maxPoint.z-this._rootNode.bbox.minPoint.z)/(this._resY-1)),r=Math.floor(i),n=Math.floor(s),a=r+1,o=n+1;if(r<0||n<0||a>=this._resX||o>=this._resY)return 0;if(r===a){if(n===o)return this.getHeight(r,n);{const t=this.getHeight(r,n);return t+(this.getHeight(r,o)-t)*(s-n)}}{const t=this.getHeight(r,n),e=t+(this.getHeight(a,n)-t)*(i-r);if(n===o)return e;{const t=this.getHeight(r,o);return e+(t+(this.getHeight(a,o)-t)*(i-r)-e)*(s-n)}}}getRootNode(){return this._rootNode}getHeights(){return this._heights}allocNode(){return{bbox:new Ta,h:[0,0,0,0],rc:{x:0,y:0,w:0,h:0},left:null,right:null}}computeNodeBoundingBox(t,e,i){e.beginExtend();for(let s=0;s<t.rc.w;s++)for(let r=0;r<t.rc.h;r++){const n=i[t.rc.x+s+(t.rc.y+r)*this._resX];e.extend3(n.x,n.y,n.z)}}createChildNode(t,e,i,s,r,n){if(t.rc.x=e,t.rc.y=i,t.rc.w=s,t.rc.h=r,s<=2&&r<=2){t.left=null,t.right=null,t.h[0]=this.getHeight(e,i),t.h[1]=this.getHeight(e+1,i),t.h[2]=this.getHeight(e+1,i+1),t.h[3]=this.getHeight(e,i+1);const s=Math.min(...t.h),r=Math.max(...t.h);t.bbox=new Ta(new b(e*this._spacingX,s,i*this._spacingZ),new b((e+1)*this._spacingX,r,(i+1)*this._spacingZ))}else{if(s>=r){const a=s+1>>1,o=s-a+1;t.left=this.allocNode(),this.createChildNode(t.left,e,i,a,r,n),t.right=this.allocNode(),this.createChildNode(t.right,e+a-1,i,o,r,n)}else{const a=r+1>>1,o=r-a+1;t.left=this.allocNode(),this.createChildNode(t.left,e,i,s,a,n),t.right=this.allocNode(),this.createChildNode(t.right,e,i+a-1,s,o,n)}t.bbox.beginExtend(),t.bbox.extend(t.left.bbox.minPoint),t.bbox.extend(t.left.bbox.maxPoint),t.bbox.extend(t.right.bbox.minPoint),t.bbox.extend(t.right.bbox.maxPoint)}return!0}rayIntersect(t){return this.rayIntersectR(t,this._rootNode)}rayIntersectR(t,e){if(null===t.bboxIntersectionTestEx(e.bbox))return null;if(e.left&&e.right){const i=this.rayIntersectR(t,e.left),s=this.rayIntersectR(t,e.right);return null!==i&&null!==s?i<s?i:s:null===i?s:i}{const i=new b(e.bbox.minPoint.x,e.h[0],e.bbox.minPoint.z),s=new b(e.bbox.maxPoint.x,e.h[1],e.bbox.minPoint.z),r=new b(e.bbox.maxPoint.x,e.h[2],e.bbox.maxPoint.z),n=new b(e.bbox.minPoint.x,e.h[3],e.bbox.maxPoint.z);let a=!1,o=t.intersectionTestTriangle(i,s,n,!1);null!==o&&o>0?a=!0:o=Number.MAX_VALUE;let h=t.intersectionTestTriangle(n,s,r,!1);return null!==h&&h>0?a=!0:h=Number.MAX_VALUE,a?o<h?o:h:null}}}class Oh{m_v4Range;m_scale;m_sizeX;m_sizeZ;m_bboxTree;m_normals;constructor(){this.m_v4Range=T.zero(),this.m_bboxTree=null,this.m_scale=b.one(),this.m_sizeX=0,this.m_sizeZ=0,this.m_normals=null}init(t,e,i,s,r,n,a,o){const h=[];for(let l=0;l<e;++l){const u=l*t,c=(e-l-1)*t;for(let e=0;e<t;++e)h[c+e]=new T(i+e*r,o[u+e]*n,s+l*a,1)}return this.m_bboxTree=new Bh(t,e,r,a,h),this.m_v4Range.setXYZW(this.m_bboxTree.getRootNode().bbox.minPoint.x,this.m_bboxTree.getRootNode().bbox.minPoint.z,2*this.m_bboxTree.getRootNode().bbox.extents.x,2*this.m_bboxTree.getRootNode().bbox.extents.z),this.m_scale.setXYZ(r,n,a),this.m_sizeX=t,this.m_sizeZ=e,this.m_normals=this.computeNormalVectors(),!0}get normals(){return this.m_normals}clear(){this.m_bboxTree=null,this.m_v4Range.setXYZW(0,0,0,0),this.m_scale.setXYZ(1,1,1),this.m_sizeX=0,this.m_sizeZ=0}rayIntersect(t){return this.m_bboxTree.rayIntersect(t)}computeNormals(){const t=this.m_scale.x,e=this.m_scale.z,i=this.getHeights(),s=new b,r=new Uint8Array((this.m_sizeZ-1)*(this.m_sizeX-1)*4);for(let n=0;n<this.m_sizeZ-1;++n)for(let a=0;a<this.m_sizeX-1;++a){const o=i[a+n*this.m_sizeX],h=i[a+(n+1)*this.m_sizeX],l=i[a+1+(n+1)*this.m_sizeX],u=i[a+1+n*this.m_sizeX],c=.5*(o+h-l-u),d=.5*(o+u-h-l),p=a+(this.m_sizeZ-2-n)*(this.m_sizeX-1);s.setXYZ(c*e,2*t*e,-d*t).inplaceNormalize(),r[4*p+0]=Math.floor(255*(.5*s.x+.5)),r[4*p+1]=Math.floor(255*(.5*s.y+.5)),r[4*p+2]=Math.floor(255*(.5*s.z+.5)),r[4*p+3]=255}return r}computeNormalVectors(){const t=this.m_scale.x,e=this.m_scale.z,i=this.getHeights(),s=[];for(let r=0;r<this.m_sizeZ;++r)for(let n=0;n<this.m_sizeX;++n){const a=i[n+r*this.m_sizeX],o=n>0&&r>0?i[n-1+(r-1)*this.m_sizeX]:a,h=r>0&&r<this.m_sizeZ-1?i[n-1+(r+1)*this.m_sizeX]:a,l=n<this.m_sizeX-1&&r<this.m_sizeZ-1?i[n+1+(r+1)*this.m_sizeX]:a,u=n<this.m_sizeX-1&&r>0?i[n+1+(r-1)*this.m_sizeX]:a,c=.5*(o+h-l-u),d=.5*(o+u-h-l);s[n+(this.m_sizeZ-1-r)*this.m_sizeX]=new b(c*e,2*t*e,-d*t).inplaceNormalize()}return s}getBBoxTree(){return this.m_bboxTree}getSpacingX(){return this.m_scale.x}getSpacingZ(){return this.m_scale.z}getVerticalScale(){return this.m_scale.y}getSizeX(){return this.m_sizeX}getSizeZ(){return this.m_sizeZ}getOffsetX(){return this.m_v4Range.x}getOffsetZ(){return this.m_v4Range.y}getBoundingbox(){return this.m_bboxTree?.getRootNode()?.bbox||null}getHeights(){return this.m_bboxTree?.getHeights()||null}getHeight(t,e){return this.m_bboxTree?this.m_bboxTree.getHeight(t,e):0}getRealHeight(t,e){return this.m_bboxTree?this.m_bboxTree.getRealHeight(t,e):0}getRealNormal(t,e,i){i=i??new b;const s=this.m_bboxTree.getRootNode();t-=s.bbox.minPoint.x,e-=s.bbox.minPoint.z;const r=t/((s.bbox.maxPoint.x-s.bbox.minPoint.x)/(this.m_sizeX-1)),n=e/((s.bbox.maxPoint.z-s.bbox.minPoint.z)/(this.m_sizeZ-1));let a=Math.floor(r),o=Math.floor(n),h=a+1,l=o+1;return a<0&&(a=0),o<0&&(o=0),h>=this.m_sizeX&&(h=this.m_sizeX-1),l>=this.m_sizeZ&&(l=this.m_sizeZ-1),i.set(this.m_normals[a+o*this.m_sizeX]),i.addBy(this.m_normals[h+o*this.m_sizeX]),i.addBy(this.m_normals[h+l*this.m_sizeX]),i.addBy(this.m_normals[a+l*this.m_sizeX]),i.scaleBy(.4).inplaceNormalize(),i}}class Uh{_patch;_grassClusters;_parent;_children;constructor(){this._patch=null,this._grassClusters=[],this._parent=null,this._children=null}get grassClusters(){return this._grassClusters}addGrassCluster(t){this._grassClusters.push(t)}initialize(t,e,i,s,r,n,a,o){if(this._parent=e,this._children=[],this._patch=new Nh(t.terrain),!this._patch.initialize(t,this._parent?._patch||null,i,s,r,n,a,o))return!1;if(this._patch.getStep()>1){let e=null;const i=(t.getPatchSize()-1)*(this._patch.getStep()>>1),s=this._patch.getOffsetX(),h=this._patch.getOffsetZ(),l=[[s,h],[s+i,h],[s,h+i],[s+i,h+i]],u=t.getRootSizeX()-1,c=t.getRootSizeZ()-1;for(let i=0;i<4;++i)if(l[i][0]>=u||l[i][1]>=c)this._children[i]=null;else{if(this._children[i]=new Uh,!this._children[i].initialize(t,this,1&i,i>>1,r,n,a,o))return!1;const s=this._children[i]._patch.getBoundingBox();s&&(e||(e=new Ta,e.beginExtend()),e.extend(s.minPoint),e.extend(s.maxPoint))}this._patch.setBoundingBox(e)}return!0}setupCamera(t,e,i){this._patch&&!this._patch.isDummy()&&this._patch.setupCamera(t,e,i);for(let s=0;s<4;++s)this._children[s]&&this._children[s].setupCamera(t,e,i)}getBoundingbox(){return this._patch.getBoundingBox()}getPatch(){return this._patch}getParent(){return this._parent}getChild(t){return this._children[t]}}class kh{_baseVertices;_indices;_indicesWireframe;_normalMap;_scaleX;_scaleZ;_patchSize;_rootSizeX;_rootSizeZ;_rootSize;_primitiveCount;_primitiveType;_rootNode;_terrain;_heightField;constructor(t){this._terrain=t,this._baseVertices=null,this._indices=null,this._indicesWireframe=null,this._normalMap=null,this._scaleX=1,this._scaleZ=1,this._patchSize=0,this._rootSizeX=0,this._rootSizeZ=0,this._rootSize=0,this._heightField=null,this._rootNode=null,this._primitiveCount=0,this._primitiveType="triangle-strip"}get normalMap(){return this._normalMap}get rootNode(){return this._rootNode}get terrain(){return this._terrain}build(t,e,i,s,r,n,a,o){if(!h(t-1)||(e-1)%(t-1)||(i-1)%(t-1)||!s)return!1;if(this._heightField=new Oh,!this._heightField.init(e,i,0,0,r,n,a,s))return this._heightField=null,!1;const u=q.instance.device;this._patchSize=t,this._rootSizeX=e,this._rootSizeZ=i,this._rootSize=l(Math.max(e-1,i-1))+1,this._scaleX=r,this._scaleZ=a;const c=t+2,d=new Float32Array(c*c*3);let p=0;d[0]=0,d[1]=0,d[2]=0;for(let t=1;t<c-1;++t)d[3*t+0]=t-1,d[3*t+1]=0,d[3*t+2]=0;d[3*(c-1)+0]=c-3,d[3*(c-1)+1]=0,d[3*(c-1)+2]=0,p+=3*c;for(let t=1;t<c-1;++t,p+=3*c){d[p+0]=0,d[p+1]=0,d[p+2]=t-1;for(let e=1;e<c-1;++e)d[p+3*e+0]=e-1,d[p+3*e+1]=0,d[p+3*e+2]=t-1;d[p+3*(c-1)+0]=c-3,d[p+3*(c-1)+1]=0,d[p+3*(c-1)+2]=t-1}d[p+0]=0,d[p+1]=0,d[p+2]=c-3;for(let t=1;t<c-1;++t)d[p+3*t+0]=t-1,d[p+3*t+1]=0,d[p+3*t+2]=c-3;d[p+3*(c-1)+0]=c-3,d[p+3*(c-1)+1]=0,d[p+3*(c-1)+2]=c-3,this._baseVertices=d;const m=this.strip(o);this._indices=u.createIndexBuffer(m,{managed:!0});const f=this.line(m);this._indicesWireframe=u.createIndexBuffer(f,{managed:!0}),this._primitiveCount=m.length-2,this._primitiveType="triangle-strip",this._rootNode=new Uh;const _=this._heightField.normals,g=new Uint8Array(4*_.length);for(let t=0;t<_.length;t++){const e=_[t];g[4*t+0]=Math.floor(255*(.5*e.x+.5)),g[4*t+1]=Math.floor(255*(.5*e.y+.5)),g[4*t+2]=Math.floor(255*(.5*e.z+.5)),g[4*t+3]=255}return this._normalMap=u.createTexture2D("rgba8unorm",e,i,{samplerOptions:{mipFilter:"none"}}),this._normalMap.name=`TerrainNormalMap-${this._normalMap.uid}`,this._normalMap.update(g,0,0,this._normalMap.width,this._normalMap.height),this._rootNode.initialize(this,null,0,0,this._baseVertices,_,n,s)}strip(t){const e=this._patchSize+2,i=(t>>1)-1,s=[];for(let t=0;t<e-1;t+=i){const r=t,n=t+i>e-1?e-1:t+i;for(let t=0;t<e-1;++t){for(let i=r;i<=n;++i)s.push((e-1-i)*e+t),s.push((e-1-i)*e+t+1);s.push((e-1-n)*e+t+1),s.push(t==e-2?(e-1-n)*e:(e-1-r)*e+t+1)}}return s.length=s.length-2,new Uint16Array(s)}line(t){const e=t.length-2,i=[];let s,r,n,a=!0;for(let o=0;o<e;o++){o%2==0?(s=t[o],r=t[o+1],n=t[o+2]):(s=t[o+1],r=t[o],n=t[o+2]);const e=s===r||s===n||r===n;e||(a&&i.push(s,r),i.push(r,n,n,s)),a=e}return new Uint16Array(i)}setupCamera(t,e,i){this._rootNode?.setupCamera(t,e,i)}getBoundingBox(t){this._heightField?(t.minPoint=this._heightField.getBoundingbox().minPoint,t.maxPoint=this._heightField.getBoundingbox().maxPoint):(t.minPoint=b.zero(),t.maxPoint=b.zero())}getPatchSize(){return this._patchSize}getRootSize(){return this._rootSize}getRootSizeX(){return this._rootSizeX}getRootSizeZ(){return this._rootSizeZ}getTerrain(){return this._terrain}getElevations(){return this._heightField?.getHeights()||null}getScaleX(){return this._scaleX}getScaleZ(){return this._scaleZ}getIndices(){return this._indices}getIndicesWireframe(){return this._indicesWireframe}getPrimitiveCount(){return this._primitiveCount}getPrimitiveType(){return this._primitiveType}getHeightField(){return this._heightField}cull(t,e,i){if(this._rootNode&&this._terrain){const s=new M(S.multiply(t.camera.viewProjectionMatrix,i));return this.cull_r(t,this._rootNode,e,i,s,t.frustumCulling,!1)}return 0}cull_r(t,e,i,s,r,n,a){const o=t.camera,h=e.getBoundingbox();let l,u=0;if(n){if(l=o.clipMask?h.getClipStateWithFrustumMask(r,o.clipMask):h.getClipStateWithFrustum(r),l===p.NOT_CLIPPED)return u;l===p.A_INSIDE_B&&(n=!1)}else l=p.A_INSIDE_B;if(!a){const s=e.getPatch().isDummy()?-1:e.getPatch().getLODDistance(),r=s>=0?s*s:Number.MAX_VALUE;((s>=0?e.getPatch().sqrDistanceToPoint(i):0)>=r||!e.getChild(0))&&(e.getPatch().isDummy()||(t.push(o,e.getPatch()),a=!0,u=1))}if(e.grassClusters.length>0&&1!==t.renderPass.type)for(const i of e.grassClusters)t.push(o,i);for(let o=0;o<4;o++){const h=e.getChild(o);h&&(u+=this.cull_r(t,h,i,s,r,n,a))}return u}}class zh{_terrain;constructor(t){this._terrain=t}getXForm(){return this._terrain}}class Vh extends(i(zh,$h)){_primitive;_numInstances;_material;constructor(t,e,i,s,r,n){super(e),this._primitive=new da;const a=t.createVertexBuffer("tex1_f32x4",n);this._primitive.setVertexBuffer(i,"vertex"),this._primitive.setVertexBuffer(a,"instance"),this._primitive.setIndexBuffer(s),this._primitive.primitiveType="triangle-list",this._numInstances=n.length>>2,this._material=r}getName(){return"GrassCluster"}getMaterial(){return this._material}getInstanceColor(){return this._terrain.getInstanceColor()}getPickTarget(){return this._terrain}getBoneMatrices(){return null}getInvBindMatrix(){return null}getMorphData(){return null}getMorphInfo(){return null}getSortDistance(t){return this._terrain.getSortDistance(t)}getQueueType(){return this._terrain.grassMaterial.getQueueType()}isUnlit(){return!this._terrain.grassMaterial.supportLighting()}needSceneColor(){return!1}isBatchable(){return!1}draw(t){this.bind(t),this._material.draw(this._primitive,t,this._numInstances)}}class Gh{_clusterSize;_baseVertexBuffer;_indexBuffer;_layers;constructor(t,e){this._clusterSize=t,this._baseVertexBuffer=new Map,this._indexBuffer=null,this._layers=[]}getBaseVertexBuffer(t,e,i){const s=`${e}-${i}`;let r=this._baseVertexBuffer.get(s);if(r)return r;const n=.5*e,a=i,o=n*Math.cos(Math.PI/3),h=n*Math.sin(Math.PI/3),l=new Float32Array([n,0,0,0,1,n,a,0,0,0,-n,a,0,1,0,-n,0,0,1,1,o,0,h,0,1,-o,0,-h,1,1,-o,a,-h,1,0,o,a,h,0,0,-o,0,h,0,1,o,0,-h,1,1,o,a,-h,1,0,-o,a,h,0,0]);return r=t.createInterleavedVertexBuffer(["position_f32x3","tex0_f32x2"],l),this._baseVertexBuffer.set(s,r),r}getIndexBuffer(t){return this._indexBuffer||(this._indexBuffer=t.createIndexBuffer(new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11]))),this._indexBuffer}addGrassLayer(t,e,i,s,r,n,a){const o=i.length,h=i[0].length,u=e.heightFieldScale;this._clusterSize=Math.min(l(this._clusterSize),e.width-1,e.height-1);let c=null;return e.traverseQuadtree((l=>{if(l.getPatch().getStep()*(e.patchSize-1)===this._clusterSize){const d=l.getPatch().getBoundingBox(),p=[],m=d.minPoint.x,f=d.minPoint.z;let _=0;for(let t=0;t<this._clusterSize;t++)for(let s=0;s<this._clusterSize;s++){const r=m+s*u.x,a=f+t*u.z,l=r+u.x,c=a+u.z,d=r/e.scaledWidth,g=a/e.scaledHeight,x=h*d>>0,b=i[o*g>>0][x]*u.x*u.z;let w=0;b>0&&(w=b<1?Math.random()<=b?1:0:b>>0);for(let t=0;t<w;t++){const t=Math.random()*(l-r)+r,i=Math.random()*(c-a)+a,s=e.getElevation(t,i),o=Math.random()*Math.PI*2;p[_++]=t,p[_++]=s+n,p[_++]=i,p[_++]=o}}if(p.length>0){c||(c={material:new bo(new x(e.scaledWidth,e.scaledHeight),e.quadtree.normalMap,a),clusters:new Map},this._layers.push(c));const i=new Vh(t,e,this.getBaseVertexBuffer(t,s,r),this.getIndexBuffer(t),c.material,new Float32Array(p));c.clusters.set(l,i),l.grassClusters.push(i)}}})),c}}class Xh extends Mh{_quadtree;_grassManager;_maxPixelError;_maxPixelErrorDirty;_lodCamera;_heightFieldScale;_patchSize;_lastTanHalfFOVY;_width;_height;_material;_grassMaterial;_wireframe;_viewPoint;_castShadow;_instanceColor;constructor(t){super(t),this._quadtree=null,this._grassManager=null,this._maxPixelError=10,this._maxPixelErrorDirty=!0,this._lodCamera=null,this._heightFieldScale=b.one(),this._patchSize=33,this._lastTanHalfFOVY=0,this._width=0,this._height=0,this._material=null,this._grassMaterial=null,this._wireframe=!1,this._viewPoint=null,this._castShadow=!0,this._instanceColor=T.zero()}get quadtree(){return this._quadtree}getName(){return this._name}getInstanceColor(){return this._instanceColor}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=!!t}get maxPixelError(){return this._maxPixelError}set maxPixelError(t){t!==this._maxPixelError&&(this._maxPixelError=t,this._maxPixelErrorDirty=!0)}get LODCamera(){return this._lodCamera}set LODCamera(t){this._lodCamera=t}get scaledWidth(){return this._width*this._heightFieldScale.x}get scaledHeight(){return this._height*this._heightFieldScale.z}get heightFieldScale(){return this._heightFieldScale}get patchSize(){return this._patchSize}get width(){return this._width}get height(){return this._height}get material(){return this._material}get grassMaterial(){return this._grassMaterial}get wireframe(){return this._wireframe}set wireframe(t){this._wireframe=!!t}get normalMap(){return this._quadtree.normalMap}create(t,e,i,s,r,n){if(this._quadtree=new kh(this),n?.splatMap&&"rgba8unorm"!==n.splatMap.format)throw new Error("SplatMap must be rgba8unorm format");if(this._material=new yo(n),!this._quadtree.build(r,t,e,i,s.x,s.y,s.z,24))return this._quadtree=null,!1;if(this._patchSize=r,this._heightFieldScale.set(s),this._width=t,this._height=e,this._material.normalTexture=this._quadtree.normalMap,this._material.normalTexCoordIndex=-1,this._material.terrainInfo=new T(this.scaledWidth,this.scaledHeight,0,0),this.invalidateBoundingVolume(),n?.splatMap&&n?.detailMaps?.grass&&n.detailMaps.grass.findIndex((t=>t&&t.findIndex((t=>!!t))>=0))>=0){const t=n.splatMap,e=new Uint8Array(t.width*t.height*4);t.readPixels(0,0,t.width,t.height,0,0,e).then((()=>{for(let i=0;i<4;i++)if(n.detailMaps.grass[i])for(const s of n.detailMaps.grass[i])if(s){const r=s.density??1,n=s.bladeWidth??4,a=s.bladeHeigh??2,o=s.offset??0,h=s.texture??null,l=[];for(let s=0;s<t.height;s++){const n=[];for(let a=0;a<t.width;a++){const o=e[4*s*t.width+4*a+i]/255;n.push(o*r)}l.push(n)}this.createGrass(l,n,a,o,h)}}))}return!0}createGrass(t,e,i,s,r){this._grassManager||(this._grassManager=new Gh(64,t)),this._grassMaterial||(this._grassMaterial=new bo(new x(this.scaledWidth,this.scaledHeight),this._quadtree.normalMap,r)),this._grassManager.addGrassLayer(q.instance.device,this,t,e,i,s,r)}getElevation(t,e){return this._quadtree.getHeightField().getRealHeight(t,e)}getNormal(t,e,i){return this._quadtree.getHeightField().getRealNormal(t,e,i)}rayIntersect(t){return this._quadtree.getHeightField().rayIntersect(t)}computeBoundingVolume(t){return this._quadtree?this._quadtree.getHeightField().getBBoxTree().getRootNode().bbox:null}traverseQuadtree(t){this._quadtree.rootNode&&function e(i){t(i);for(let t=0;t<4;t++){const s=i.getChild(t);s&&e(s)}}(this._quadtree.rootNode)}cull(t){const e=t.primaryCamera.getTanHalfFovy();(e!==this._lastTanHalfFOVY||this._maxPixelErrorDirty)&&(this._maxPixelErrorDirty=!1,this._lastTanHalfFOVY=e,this._quadtree.setupCamera(1024,e,this._maxPixelError));const i=t.primaryCamera.getWorldPosition();return this._viewPoint=this.invWorldMatrix.transformPointAffine(i),this._quadtree.cull(t,this._viewPoint,this.worldMatrix)}isTerrain(){return!0}}class Wh{_name;_duration;_tracks;_skeletons;constructor(t){this._name=t,this._tracks=new Map,this._duration=0,this._skeletons=new Set}dispose(){this._tracks=null,this._skeletons?.forEach(((t,e)=>e.dispose())),this._skeletons=null}get name(){return this._name}get tracks(){return this._tracks}get skeletons(){return this._skeletons}get timeDuration(){return this._duration}addSkeleton(t){this._skeletons.add(t)}addTrack(t,e){if(!e)return;if(e.animation)return e.animation===this?void 0:void console.error("Track is already in another animation");const i=e.getBlendId(),s=this._tracks.get(t);if(s&&s.findIndex((t=>t.getBlendId()===i))>=0)return void console.error("Tracks with same BlendId could not be added to same animation");e.animation=this;let r=this._tracks.get(t);return r||(r=[],this._tracks.set(t,r)),r.push(e),this._duration=Math.max(this._duration,e.interpolator.maxTime),e.reset(t),this}}class Hh{_model;_animations;_scene;_activeTracks;_activeSkeletons;_activeAnimations;constructor(t,e){this._scene=t,this._model=e,this._scene.animationSet.push(this),this._animations={},this._activeTracks=new Map,this._activeSkeletons=new Map,this._activeAnimations=new Map}get numAnimations(){return Object.getOwnPropertyNames(this._animations).length}get(t){return this._animations[t]??null}add(t){this._animations[t.name]=t}getAnimationNames(){return Object.keys(this._animations)}update(){this._activeAnimations.forEach(((t,e)=>{if(t.fadeOut>0&&t.fadeOutStart<0&&(t.fadeOutStart=t.animateTime),t.firstFrame)t.firstFrame=!1;else{const i=.001*q.instance.device.frameInfo.elapsedFrame*t.speedRatio;t.currentTime+=i,t.animateTime+=i,t.currentTime>e.timeDuration?(t.repeatCounter++,t.currentTime=0):t.currentTime<0&&(t.repeatCounter++,t.currentTime=e.timeDuration),(0!==t.repeat&&t.repeatCounter>=t.repeat||t.fadeOut>0&&t.animateTime-t.fadeOutStart>=t.fadeOut)&&this.stopAnimation(e.name)}})),this._activeTracks.forEach(((t,e)=>{t.forEach((t=>{if(t.length>0){const i=function(t,e,i){let s=t[0],r=e[0];for(let n=1;n<t.length;n++)s+=t[n],r=i(r,e[n],t[n]/s);return r}(t.map((t=>{const e=this._activeAnimations.get(t.animation),i=e.weight,s=0===e.fadeIn?1:Math.min(1,e.animateTime/e.fadeIn);let r=1;return 0!==e.fadeOut&&(r=1-(e.animateTime-e.fadeOutStart)/e.fadeOut),i*s*r})),t.map((t=>t.calculateState(this._activeAnimations.get(t.animation).currentTime))),((e,i,s)=>t[0].mixState(e,i,s)));t[0].applyState(e,i)}}))})),this._activeSkeletons.forEach(((t,e)=>{e.apply()}))}isPlayingAnimation(t){return t?this._activeAnimations.has(this._animations[t]):this._activeAnimations.size>0}getAnimationWeight(t){const e=this._animations[t],i=this._activeAnimations.get(e);return i?.weight??0}setAnimationWeight(t,e){const i=this._animations[t],s=this._activeAnimations.get(i);s&&(s.weight=e)}playAnimation(t,e){const i=this._animations[t];if(!i)return void console.error(`Animation ${t} not exists`);const s=Math.max(e?.fadeIn??0,0),r=this._activeAnimations.get(i);if(r)r.fadeOut=0,r.fadeIn=s;else{const t=e?.repeat??0,r=e?.speedRatio??1,n=e?.weight??1;this._activeAnimations.set(i,{repeat:t,weight:n,speedRatio:r,fadeIn:s,fadeOut:0,repeatCounter:0,currentTime:r<0?i.timeDuration:0,animateTime:0,fadeOutStart:0,firstFrame:!0}),i.tracks?.forEach(((t,e)=>{let i=this._activeTracks.get(e);i||(i=new Map,this._activeTracks.set(e,i));for(const e of t){const t=e.getBlendId();let s=i.get(t);s||(s=[],i.set(t,s)),s.push(e)}})),i.skeletons?.forEach(((t,e)=>{const i=this._activeSkeletons.get(e);i?this._activeSkeletons.set(e,i+1):this._activeSkeletons.set(e,1)}))}}stopAnimation(t,e){const i=this._animations[t],s=this._activeAnimations.get(i);if(s){const t=Math.max(e?.fadeOut??0,0);0!==t?(s.fadeOut=t,s.fadeOutStart=-1):(this._activeAnimations.delete(i),this._activeTracks.forEach(((t,e)=>{t.forEach(((e,s)=>{t.set(s,e.filter((t=>t.animation!==i)))}))})),i.skeletons?.forEach(((t,e)=>{const i=this._activeSkeletons.get(e);1===i?(e.reset(this._model),this._activeSkeletons.delete(e)):this._activeSkeletons.set(e,i-1)})))}}dispose(){const t=this._scene.animationSet.indexOf(this);t>=0&&this._scene.animationSet.splice(t,1);for(const t in this._animations)this._animations[t].dispose();this._animations={},this._activeAnimations.clear(),this._activeSkeletons.clear(),this._activeTracks.clear()}}class jh{_interpolator;_animation;constructor(t){this._interpolator=t}get interpolator(){return this._interpolator}get animation(){return this._animation}set animation(t){this._animation=t}reset(t){}}class qh extends jh{_state;constructor(t,e){if(t instanceof z){if("vec3"!==t.target)throw new Error("TranslationTrack(): interpolator target must be 'vec3'");super(t)}else{const i=new Float32Array(e.map((t=>t.time))),s=new Float32Array(3*e.length);for(let t=0;t<e.length;t++)s[3*t+0]=e[t].value.x,s[3*t+1]=e[t].value.y,s[3*t+2]=e[t].value.z;super(new z(t,"vec3",i,s))}this._state=new b}calculateState(t){return this._interpolator.interpolate(t,this._state),this._state}applyState(t,e){t.position.set(e)}mixState(t,e,i){return new b(t.x+i*(e.x-t.x),t.y+i*(e.y-t.y),t.z+i*(e.z-t.z))}getBlendId(){return"node-translation"}}class Yh extends jh{_state;constructor(t,e){if(t instanceof z){if("quat"!==t.target)throw new Error("RotationTrack(): interpolator target must be 'quat'");super(t)}else{const i=new Float32Array(e.map((t=>t.time))),s=new Float32Array(4*e.length);for(let t=0;t<e.length;t++)s[4*t+0]=e[t].value.x,s[4*t+1]=e[t].value.y,s[4*t+2]=e[t].value.z,s[4*t+3]=e[t].value.w;super(new z(t,"quat",i,s))}this._state=new v}calculateState(t){return this._interpolator.interpolate(t,this._state),this._state}applyState(t,e){t.rotation.set(e)}mixState(t,e,i){return v.slerp(t,e,i)}getBlendId(){return"node-rotation"}}new b;class Zh extends jh{_state;constructor(t,e){if(t instanceof z){if("vec3"!==t.target)throw new Error("ScaleTrack(): interpolator target must be 'vec3'");super(t)}else{const i=new Float32Array(e.map((t=>t.time))),s=new Float32Array(3*e.length);for(let t=0;t<e.length;t++)s[3*t+0]=e[t].value.x,s[3*t+1]=e[t].value.y,s[3*t+2]=e[t].value.z;super(new z(t,"vec3",i,s))}this._state=new b}calculateState(t){return this._interpolator.interpolate(t,this._state),this._state}applyState(t,e){t.scale.set(e)}mixState(t,e,i){return new b(t.x+i*(e.x-t.x),t.y+i*(e.y-t.y),t.z+i*(e.z-t.z))}getBlendId(){return"node-scale"}}const Kh=new b,Qh=new b,Jh=new b,tl=new b;class el{_meshes;_joints;_inverseBindMatrices;_bindPoseMatrices;_jointMatrices;_jointMatrixArray;_jointTexture;constructor(t,e,i,s,r){this._joints=t,this._inverseBindMatrices=e,this._bindPoseMatrices=i,this._jointMatrixArray=null,this._jointMatrices=null,this._jointTexture=null,this.updateJointMatrices(),this._meshes=s.map(((t,e)=>({mesh:t,bounding:this.getBoundingInfo(r[e]),box:new Ta})))}dispose(){this._jointTexture?.dispose(),this._jointTexture=null,this._joints=null,this._inverseBindMatrices=null,this._bindPoseMatrices=null,this._jointMatrices=null,this._jointMatrixArray=null}get jointMatrices(){return this._jointMatrices}get jointTexture(){return this._jointTexture}updateJointMatrices(t){this._jointTexture||this._createJointTexture();for(let e=0;e<this._joints.length;e++){const i=this._jointMatrices[e];S.multiply(t?t[e]:this._joints[e].worldMatrix,this._inverseBindMatrices[e],i)}}computeBindPose(){this.updateJointMatrices(this._bindPoseMatrices),this._jointTexture.update(this._jointMatrixArray,0,0,this._jointTexture.width,this._jointTexture.height)}computeJoints(){this.updateJointMatrices(),this._jointTexture.update(this._jointMatrixArray,0,0,this._jointTexture.width,this._jointTexture.height)}apply(){this.computeJoints();for(const t of this._meshes)this.computeBoundingBox(t.bounding,t.mesh.invWorldMatrix),t.mesh.setBoneMatrices(this.jointTexture),t.mesh.setInvBindMatrix(t.mesh.invWorldMatrix),t.mesh.setAnimatedBoundingBox(t.bounding.boundingBox)}reset(t){this.computeBindPose();for(const e of this._meshes){const i=S.multiply(e.mesh.invWorldMatrix,t.worldMatrix);this.computeBoundingBox(e.bounding,i),e.mesh.setBoneMatrices(this.jointTexture),e.mesh.setInvBindMatrix(i),e.mesh.setAnimatedBoundingBox(e.bounding.boundingBox)}}computeBoundingBox(t,e){t.boundingBox.beginExtend();for(let i=0;i<t.boundingVertices.length;i++)this._jointMatrices[t.boundingVertexBlendIndices[4*i+0]].transformPointAffine(t.boundingVertices[i],Kh).scaleBy(t.boundingVertexJointWeights[4*i+0]),this._jointMatrices[t.boundingVertexBlendIndices[4*i+1]].transformPointAffine(t.boundingVertices[i],Qh).scaleBy(t.boundingVertexJointWeights[4*i+1]),this._jointMatrices[t.boundingVertexBlendIndices[4*i+2]].transformPointAffine(t.boundingVertices[i],Jh).scaleBy(t.boundingVertexJointWeights[4*i+2]),this._jointMatrices[t.boundingVertexBlendIndices[4*i+3]].transformPointAffine(t.boundingVertices[i],tl).scaleBy(t.boundingVertexJointWeights[4*i+3]),Kh.addBy(Qh).addBy(Jh).addBy(tl),e.transformPointAffine(Kh,Kh),t.boundingBox.extend(Kh)}_createJointTexture(){const t=l(Math.max(4,Math.ceil(Math.sqrt(4*this._joints.length))));this._jointTexture=q.instance.device.createTexture2D("rgba32f",t,t,{samplerOptions:{magFilter:"nearest",minFilter:"nearest",mipFilter:"none"}}),this._jointMatrixArray=new Float32Array(t*t*4);const e=this._jointMatrixArray.buffer;this._jointMatrices=this._joints.map(((t,i)=>new S(e,16*i*Float32Array.BYTES_PER_ELEMENT)))}getBoundingInfo(t){const e=[0,0,0,0,0,0];let i=Number.MAX_VALUE,s=-Number.MAX_VALUE,r=Number.MAX_VALUE,n=-Number.MAX_VALUE,a=Number.MAX_VALUE,o=-Number.MAX_VALUE;const h=t.rawPositions,l=new b,u=new b,c=new b,d=new b,p=new b,m=Math.floor(h.length/3);for(let f=0;f<m;f++)l.setXYZ(h[3*f],h[3*f+1],h[3*f+2]),this.jointMatrices[t.rawBlendIndices[4*f+0]].transformPointAffine(l,u).scaleBy(t.rawJointWeights[4*f+0]),this.jointMatrices[t.rawBlendIndices[4*f+1]].transformPointAffine(l,c).scaleBy(t.rawJointWeights[4*f+1]),this.jointMatrices[t.rawBlendIndices[4*f+2]].transformPointAffine(l,d).scaleBy(t.rawJointWeights[4*f+2]),this.jointMatrices[t.rawBlendIndices[4*f+3]].transformPointAffine(l,p).scaleBy(t.rawJointWeights[4*f+3]),u.addBy(c).addBy(d).addBy(p),u.x<i&&(i=u.x,e[0]=f),u.x>s&&(s=u.x,e[1]=f),u.y<r&&(r=u.y,e[2]=f),u.y>n&&(n=u.y,e[3]=f),u.z<a&&(a=u.z,e[4]=f),u.z>o&&(o=u.z,e[5]=f);return{boundingVertexBlendIndices:new Float32Array(Array.from({length:24}).map(((i,s)=>t.rawBlendIndices[4*e[s>>2]+s%4]))),boundingVertexJointWeights:new Float32Array(Array.from({length:24}).map(((i,s)=>t.rawJointWeights[4*e[s>>2]+s%4]))),boundingVertices:Array.from({length:6}).map(((i,s)=>new b(t.rawPositions[3*e[s]],t.rawPositions[3*e[s]+1],t.rawPositions[3*e[s]+2]))),boundingBox:new Ta}}}class il{_camera;constructor(){this._camera=null,this.reset()}_getCamera(){return this._camera}_setCamera(t){this._camera!==t&&(this._camera=t,this.reset())}reset(){}onMouseDown(t){return this._onMouseDown(t)}onMouseUp(t){return this._onMouseUp(t)}onMouseWheel(t){return this._onMouseWheel(t)}onMouseMove(t){return this._onMouseMove(t)}onKeyDown(t){return this._onKeyDown(t)}onKeyUp(t){return this._onKeyUp(t)}update(){}_onMouseDown(t){return!1}_onMouseUp(t){return!1}_onMouseWheel(t){return!1}_onMouseMove(t){return!1}_onKeyDown(t){return!1}_onKeyUp(t){return!1}}class sl extends il{options;mouseDown;lastMouseX;lastMouseY;rotateX;rotateY;eyePos;upVector;xVector;target;direction;quat;scale;constructor(t){super(),this.options=Object.assign({center:b.zero(),distance:1,damping:.1,moveSpeed:.2,rotateSpeed:.01,zoomSpeed:1},t||{}),this.rotateX=0,this.rotateY=0,this.eyePos=new b,this.upVector=b.axisPY(),this.xVector=new b,this.target=new b,this.direction=new b,this.quat=new v,this.scale=1}get center(){return this.options.center}set center(t){this.options.center.set(t)}reset(){this.mouseDown=!1,this.lastMouseX=0,this.lastMouseY=0,this.rotateX=0,this.rotateY=0,this.upVector=b.axisPY(),this.scale=1,this._loadCameraParams()}_onMouseDown(t){return 0===t.button&&(this.mouseDown=!0,this.lastMouseX=t.offsetX,this.lastMouseY=t.offsetY,this.rotateX=0,this.rotateY=0,!0)}_onMouseUp(t){return!(0!==t.button||!this.mouseDown)&&(this.mouseDown=!1,!0)}_onMouseWheel(t){const e=Math.pow(.9,Math.abs(this.options.zoomSpeed));return t.deltaY>0?this.scale/=e:this.scale*=e,!0}_onMouseMove(t){if(this.mouseDown){const e=t.offsetX-this.lastMouseX,i=t.offsetY-this.lastMouseY;return this.lastMouseX=t.offsetX,this.lastMouseY=t.offsetY,this.rotateX-=i*this.options.rotateSpeed,this.rotateY-=e*this.options.rotateSpeed,!0}return!1}_loadCameraParams(){const t=this._getCamera();if(t){this.eyePos=this._getCamera().position,this.target.set(this.options.center),t.lookAt(this.eyePos,this.target,this.upVector),b.sub(this.eyePos,this.target,this.direction),this.options.distance=this.direction.magnitude,this.direction.inplaceNormalize();const e=this._getCamera().localMatrix;this.xVector.setXYZ(e[0],e[1],e[2])}}setOptions(t){t&&Object.assign(this.options,t),this.reset()}update(){if(this._getCamera()){const t=this.options.center.x-this.target.x,e=this.options.center.y-this.target.y,i=this.options.center.z-this.target.z;this.eyePos.x+=t,this.eyePos.y+=e,this.eyePos.z+=i,this.target.set(this.options.center),v.fromAxisAngle(this.xVector,this.rotateX,this.quat),this.quat.transform(this.eyePos.subBy(this.target),this.eyePos),v.fromEulerAngle(0,this.rotateY,0,"XYZ",this.quat),this.quat.transform(this.eyePos,this.eyePos),this.quat.transform(this.xVector,this.xVector).inplaceNormalize(),b.normalize(this.eyePos,this.direction).inplaceNormalize(),b.cross(this.direction,this.xVector,this.upVector).inplaceNormalize(),b.add(this.target,b.scale(this.direction,this.options.distance*this.scale),this.eyePos),this._getCamera().lookAt(this.eyePos,this.target,this.upVector),this.mouseDown?(this.rotateX=0,this.rotateY=0):(this.rotateX*=1-this.options.damping,this.rotateY*=1-this.options.damping,Math.abs(this.rotateX)<1e-4&&(this.rotateX=0),Math.abs(this.rotateY)<1e-4&&(this.rotateY=0))}}}class rl{name;constructor(t){this.name=t}}class nl extends rl{_parent;_position;_rotation;_scaling;_mesh;_skeleton;_attachToSkeleton;_attachIndex;_meshAttached;_matrix;_worldMatrix;_weights;_children;_instances;constructor(t,e){super(t),this._parent=null,this._position=b.zero(),this._rotation=v.identity(),this._scaling=b.one(),this._children=[],this._mesh=null,this._skeleton=null,this._attachToSkeleton=null,this._meshAttached=!1,this._attachIndex=-1,this._matrix=null,this._weights=null,this._worldMatrix=null,this._instances=[],e?.addChild(this)}get parent(){return this._parent}get matrix(){return this._matrix}get worldMatrix(){return this._worldMatrix}get mesh(){return this._mesh}set mesh(t){this._mesh=t,this.setMeshAttached()}get instances(){return this._instances}get weights(){return this._weights}set weights(t){this._weights=t}get skeleton(){return this._skeleton}set skeleton(t){this._skeleton=t}get position(){return this._position}set position(t){this._position=t}get rotation(){return this._rotation}set rotation(t){this._rotation=t}get scaling(){return this._scaling}set scaling(t){this._scaling=t}get meshAttached(){return this._meshAttached}get children(){return this._children}get skeletonAttached(){return this._attachToSkeleton}get attachIndex(){return this._attachIndex}computeTransforms(t){this._matrix=S.scaling(this._scaling).rotateLeft(this._rotation).translateLeft(this._position),this._worldMatrix=t?S.multiply(t,this._matrix):new S(this._matrix);for(const t of this._children)t.computeTransforms(this._worldMatrix)}addChild(t){if(!t||t.parent)throw new Error("AssetHierarchyNode.addChild(): invalid child node");this._children.push(t),t._parent=this,t.meshAttached&&this.setMeshAttached()}removeChild(t){const e=this._children.indexOf(t);if(e<0)throw new Error("AssetHierarchyNode.removeChild(): invalid child node");this._children[e]._parent=null,this._children.splice(e,1)}attachToSkeleton(t,e){if(this._attachToSkeleton&&t!==this._attachToSkeleton)throw new Error("joint can not attached to multiple skeletons");this._attachToSkeleton=t,this._attachIndex=e}setMeshAttached(){this._meshAttached=!0,this._parent?.setMeshAttached()}}class al extends rl{pivot;joints;inverseBindMatrices;bindPoseMatrices;constructor(t){super(t),this.name=t,this.pivot=null,this.joints=[],this.inverseBindMatrices=[],this.bindPoseMatrices=[]}addJoint(t,e){t.attachToSkeleton(this,this.joints.length),this.joints.push(t),this.inverseBindMatrices.push(e),this.bindPoseMatrices.push(t.worldMatrix)}}class ol extends rl{rootNodes;constructor(t){super(t),this.rootNodes=[]}}class hl{_name;_skeletons;_nodes;_animations;_scenes;_activeScene;constructor(t){this._name=t||"",this._skeletons=[],this._nodes=[],this._scenes=[],this._animations=[],this._activeScene=-1}get name(){return this._name}set name(t){this._name=t}get scenes(){return this._scenes}get animations(){return this._animations}get skeletons(){return this._skeletons}get nodes(){return this._nodes}get activeScene(){return this._activeScene}set activeScene(t){this._activeScene=t}addNode(t,e,i){const s=new nl(i,t);return this._nodes[e]=s,s}addSkeleton(t){this._skeletons.push(t)}addAnimation(t){this._animations.push(t)}}var ll;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BYTE=5120]="BYTE",t[t.UBYTE=5121]="UBYTE",t[t.SHORT=5122]="SHORT",t[t.USHORT=5123]="USHORT",t[t.INT=5124]="INT",t[t.UINT=5125]="UINT",t[t.FLOAT=5126]="FLOAT"}(ll||(ll={}));class ul{bufferView;byteOffset;componentType;normalized;count;type;max;min;sparse;name;_typedView;_filteredView;_normalizedFilteredView;_normalizedTypedView;constructor(t){this.bufferView=t.bufferView,this.byteOffset=t.byteOffset??0,this.componentType=t.componentType,this.normalized=!!t.normalized,this.count=t.count,this.type=t.type,this.max=t.max,this.min=t.min,this.sparse=t.sparse,this.name=t.name,this._typedView=null,this._filteredView=null,this._normalizedFilteredView=null,this._normalizedTypedView=null}getTypedView(t){if(this._typedView)return this._typedView;if(void 0!==this.bufferView){const e=t.bufferViews[this.bufferView],i=t._loadedBuffers[e.buffer],s=this.byteOffset+(e.byteOffset??0),r=this.getComponentSize(this.componentType),n=this.getComponentCount(this.type);let a=0;switch(void 0!==e.byteStride&&0!==e.byteStride?0!==r?a=e.byteStride/r*(this.count-1)+n:console.warn("Invalid component type in accessor '"+(this.name?this.name:"")+"'"):a=this.count*n,a*r>i.byteLength-s&&(a=(i.byteLength-s)/r,console.warn("Count in accessor '"+(this.name?this.name:"")+"' is too large.")),this.componentType){case 5120:this._typedView=new Int8Array(i,s,a);break;case 5121:this._typedView=new Uint8Array(i,s,a);break;case 5122:this._typedView=new Int16Array(i,s,a);break;case 5123:this._typedView=new Uint16Array(i,s,a);break;case 5124:this._typedView=new Int32Array(i,s,a);break;case 5125:this._typedView=new Uint32Array(i,s,a);break;case 5126:this._typedView=new Float32Array(i,s,a)}}else void 0!==this.sparse&&(this._typedView=this.createView());return this._typedView?void 0!==this.sparse&&this.applySparse(t,this._typedView):console.warn("Failed to convert buffer view to typed view!: "+this.bufferView),this._typedView}getNormalizedTypedView(t){if(this._normalizedTypedView)return this._normalizedTypedView;const e=this.getTypedView(t);return this._normalizedTypedView=this.normalized?ul.dequantize(e,this.componentType):e,this._normalizedTypedView}getDeinterlacedView(t){if(this._filteredView)return this._filteredView;const e=this.getComponentSize(this.componentType),i=this.getComponentCount(this.type),s=this.count*i;let r="getFloat32";switch(this.componentType){case 5120:this._filteredView=new Int8Array(s),r="getInt8";break;case 5121:this._filteredView=new Uint8Array(s),r="getUint8";break;case 5122:this._filteredView=new Int16Array(s),r="getInt16";break;case 5123:this._filteredView=new Uint16Array(s),r="getUint16";break;case 5124:this._filteredView=new Int32Array(s),r="getInt32";break;case 5125:this._filteredView=new Uint32Array(s),r="getUint32";break;case 5126:this._filteredView=new Float32Array(s),r="getFloat32";break;default:return}if(void 0!==this.bufferView){const n=t.bufferViews[this.bufferView],a=t._loadedBuffers[n.buffer],o=this.byteOffset+(n.byteOffset??0),h=void 0!==n.byteStride&&0!==n.byteStride?n.byteStride:i*e,l=new DataView(a,o,this.count*h);for(let t=0;t<s;++t){const s=Math.floor(t/i)*h+t%i*e;this._filteredView[t]=l[r](s,!0)}}else void 0!==this.sparse&&(this._filteredView=this.createView());return void 0!==this.sparse&&this.applySparse(t,this._filteredView),this._filteredView}createView(){const t=this.count*this.getComponentCount(this.type);return 5120==this.componentType?new Int8Array(t):5121==this.componentType?new Uint8Array(t):5122==this.componentType?new Int16Array(t):5123==this.componentType?new Uint16Array(t):5124==this.componentType?new Int32Array(t):5125==this.componentType?new Uint32Array(t):5126==this.componentType?new Float32Array(t):void 0}getNormalizedDeinterlacedView(t){if(this._normalizedFilteredView)return this._normalizedFilteredView;const e=this.getDeinterlacedView(t);return this._normalizedFilteredView=this.normalized?ul.dequantize(e,this.componentType):e,this._normalizedFilteredView}applySparse(t,e){const i=t.bufferViews[this.sparse.indices.bufferView],s=t._loadedBuffers[i.buffer],r=this.sparse.indices.byteOffset+(i.byteOffset??0),n=this.getComponentSize(this.sparse.indices.componentType);let a=1;void 0!==i.byteStride&&0!==i.byteStride&&(a=i.byteStride/n);const o=this.sparse.count*a;let h;switch(this.sparse.indices.componentType){case 5121:h=new Uint8Array(s,r,o);break;case 5123:h=new Uint16Array(s,r,o);break;case 5125:h=new Uint32Array(s,r,o)}const l=t.bufferViews[this.sparse.values.bufferView],u=t._loadedBuffers[l.buffer],c=this.sparse.values.byteOffset+(l.byteOffset??0),d=this.getComponentSize(this.componentType);let p=this.getComponentCount(this.type);void 0!==l.byteStride&&0!==l.byteStride&&(p=l.byteStride/d);const m=this.sparse.count*p;let f;switch(this.componentType){case 5120:f=new Int8Array(u,c,m);break;case 5121:f=new Uint8Array(u,c,m);break;case 5122:f=new Int16Array(u,c,m);break;case 5123:f=new Uint16Array(u,c,m);break;case 5124:f=new Int32Array(u,c,m);break;case 5125:f=new Uint32Array(u,c,m);break;case 5126:f=new Float32Array(u,c,m)}for(let t=0;t<this.sparse.count;++t)for(let i=0;i<p;++i)e[h[t]*p+i]=f[t*p+i]}static dequantize(t,e){switch(e){case 5120:return new Float32Array(t).map((t=>Math.max(t/127,-1)));case 5121:return new Float32Array(t).map((t=>t/255));case 5122:return new Float32Array(t).map((t=>Math.max(t/32767,-1)));case 5123:return new Float32Array(t).map((t=>t/65535));default:return t}}getComponentCount(t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 0}}getComponentSize(t){switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}}}class cl{_urlResolver;constructor(){this._urlResolver=null}get urlResolver(){return this._urlResolver}set urlResolver(t){this._urlResolver=t}async request(t,e={},i="anonymous"){return(t=this._urlResolver?this._urlResolver(t):null)?fetch(t,{credentials:"anonymous"===i?"same-origin":"include",headers:e}):null}}class dl extends cl{}class pl extends cl{}class ml{_module;_decoder;_mesh;constructor(t,e){this._module=e,this._decoder=new this._module.Decoder;const i=new this._module.DecoderBuffer;i.Init(t,t.byteLength);const s=this._decoder.GetEncodedGeometryType(i);if(s!==this._module.TRIANGULAR_MESH)throw this._module.destroy(i),this._module.destroy(this._decoder),this._decoder=null,new Error(`Unsupported geometry type: ${s}`);this._mesh=new this._module.Mesh;const r=this._decoder.DecodeBufferToMesh(i,this._mesh);if(this._module.destroy(i),!r.ok()||0===this._mesh.ptr)throw this._module.destroy(this._decoder),this._decoder=null,this._module.destroy(this._mesh),this._mesh=null,new Error(r.error_msg())}getIndexBuffer(){if(!this._decoder||!this._mesh)return null;const t=3*this._mesh.num_faces(),e=new Uint32Array(t),i=this._module._malloc(e.byteLength);this._decoder.GetTrianglesUInt32Array(this._mesh,e.byteLength,i);const s=new Uint32Array(this._module.HEAPU32.buffer,i,t);return e.set(s),this._module._free(i),e}getAttributeBuffer(t,e){if(!this._decoder||!this._mesh)return null;const i=this._decoder.GetAttributeByUniqueId(this._mesh,t);if(!i)return null;const s=i.num_components(),r=this._mesh.num_points()*s;if(e.length!==r)return console.error(`getAttributeBuffer(): buffer length must be ${r}`),null;const n=this._module._malloc(e.byteLength);this._decoder.GetAttributeDataArrayForAllPoints(this._mesh,i,this.getDracoDataType(e),e.byteLength,n);const a=new e.constructor(this.getDracoHeap(e).buffer,n,r);return e.set(a),this._module._free(n),e}getDracoDataType(t){if(t instanceof Float32Array)return this._module.DT_FLOAT32;if(t instanceof Int8Array)return this._module.DT_INT8;if(t instanceof Int16Array)return this._module.DT_INT16;if(t instanceof Int32Array)return this._module.DT_INT32;if(t instanceof Uint8Array)return this._module.DT_UINT8;if(t instanceof Uint16Array)return this._module.DT_UINT16;if(t instanceof Uint32Array)return this._module.DT_UINT32;throw new Error("getDracoDataType(): invalid buffer type")}getDracoHeap(t){if(t instanceof Float32Array)return this._module.HEAPF32;if(t instanceof Int8Array)return this._module.HEAP8;if(t instanceof Int16Array)return this._module.HEAP16;if(t instanceof Int32Array)return this._module.HEAP32;if(t instanceof Uint8Array)return this._module.HEAPU8;if(t instanceof Uint16Array)return this._module.HEAPU16;if(t instanceof Uint32Array)return this._module.HEAPU32;throw new Error("getDracoHeap(): invalid buffer type")}}class fl extends pl{supportExtension(t){return".gltf"===t||".glb"===t}supportMIMEType(t){return"model/gltf+json"===t||"model/gltf-binary"===t}async load(t,e,i,s,r){const n=await s.arrayBuffer();if(this.isGLB(n))return this.loadBinary(t,e,n,r);const a=await new Response(s).json();return a._manager=t,a._loadedBuffers=null,this.loadJson(e,a,r)}async loadBinary(t,e,i,s){let r=null;const n=[],a=this.getGLBChunkInfos(i);for(const t of a)if(1313821514!==t.type||r)5130562===t.type&&n.push(i.slice(t.start,t.start+t.length));else{const e=new Uint8Array(i,20,t.length),s=new TextDecoder("utf-8").decode(e);r=JSON.parse(s)}return r?(r._manager=t,r._loadedBuffers=n,this.loadJson(e,r,s)):null}async loadJson(t,e,i){if(!i&&e.extensionsRequired&&e.extensionsRequired.indexOf("KHR_draco_mesh_compression")>=0)return console.error("Draco3d is required for loading model"),null;e._dracoModule=i,e._accessors=[],e._bufferCache={},e._textureCache={},e._materialCache={},e._nodes=[],e._meshes=[];const s=e.asset;if(s){const t=s.version;if("2.0"!==t)return console.error(`Invalid GLTF version: ${t}`),null}if(e._baseURI=t.substring(0,t.lastIndexOf("/")+1),!e._loadedBuffers){e._loadedBuffers=[];const t=e.buffers;if(t)for(const i of t){const t=this._normalizeURI(e._baseURI,i.uri),s=await e._manager.fetchBinaryData(t);if(i.byteLength!==s.byteLength)return console.error("Invalid GLTF: buffer byte length error."),null;e._loadedBuffers.push(s)}}if(e.accessors)for(const t of e.accessors)e._accessors.push(new ul(t));const r=e.scenes;if(r){const t=new hl;await this._loadMeshes(e,t),this._loadNodes(e,t),this._loadSkins(e,t);for(let i=0;i<e.nodes?.length;i++)"number"==typeof e.nodes[i].skin&&e.nodes[i].skin>=0&&(e._nodes[i].skeleton=t.skeletons[e.nodes[i].skin]);this._loadAnimations(e,t);for(const i of r){const s=new ol(i.name);for(const t of i.nodes)s.rootNodes.push(e._nodes[t]);t.scenes.push(s)}return"number"==typeof e.scene&&(t.activeScene=e.scene),t}return null}_normalizeURI(t,e){const i=e.toLowerCase();return i.startsWith("http://")||i.startsWith("https://")||i.startsWith("blob:")||i.startsWith("data:")?encodeURI(e):(e=e.replace(/\.\//g,""),"/"===(e=decodeURIComponent(e))[0]&&(e=e.slice(1)),t+(e=e.split("/").map((t=>encodeURIComponent(t))).join("/")))}_loadNodes(t,e){if(t.nodes){for(let i=0;i<t.nodes.length;i++)this._loadNode(t,i,null,e);for(const e of t._nodes)e.parent||e.computeTransforms(null)}}_loadSkins(t,e){if(t.skins)for(let i=0;i<t.skins.length;i++){const s=t.skins[i],r=new al(s.name);"number"==typeof s.skeleton&&(r.pivot=t._nodes[s.skeleton]);const n=t._accessors[s.inverseBindMatrices];if(!n||"MAT4"!==n.type||n.componentType!==ll.FLOAT)throw new Error("Invalid GLTF inverse bind matricies accessor");const a="number"==typeof s.inverseBindMatrices?n.getDeinterlacedView(t):null;s.joints.forEach(((e,i)=>{const s=16*i;r.addJoint(t._nodes[e],a?new S(a.subarray(s,s+16)):S.identity())})),e.addSkeleton(r)}}_loadAnimations(t,e){if(t.animations)for(let i=0;i<t.animations.length;i++){const s=this._loadAnimation(t,i,e);e.addAnimation(s)}}collectNodes(t){const e=new Map;for(const i of t._nodes)e.set(i,{translate:i.position||b.zero(),rotation:i.rotation||v.identity(),scale:i.scaling||b.one(),worldTransform:null});return e}getAnimationInfo(t,e){const i=t.animations[e],s=i.name||null,r=i.channels,n=i.samplers,a=[],o=[],h=this.collectNodes(t);let l=0;for(let e=0;e<r.length;e++){const i=r[e],s=n[i.sampler],h=t._accessors[s.input].getNormalizedDeinterlacedView(t),u=t._accessors[s.output].getNormalizedDeinterlacedView(t),c="STEP"===s.interpolation?"step":"CUBICSPLINE"===s.interpolation?"cubicspline":"linear";if("rotation"===i.target.path)a.push(new z(c,"quat",h,u)),o.push("rotation");else if("translation"===i.target.path)a.push(new z(c,"vec3",h,u)),o.push("translation");else if("scale"===i.target.path)a.push(new z(c,"vec3",h,u)),o.push("scale");else{if("weights"!==i.target.path)continue;a.push(new z(c,null,h,u)),o.push("weights")}const d=h[h.length-1];d>l&&(l=d)}return{name:s,channels:r,samplers:n,interpolators:a,interpolatorTypes:o,maxTime:l,nodes:h}}_loadAnimation(t,e,i){const s=this.getAnimationInfo(t,e),r={name:s.name,tracks:[],skeletons:[],nodes:[]};for(let e=0;e<s.channels.length;e++){const i=t._nodes[s.channels[e].target.node],n={node:i,type:s.interpolatorTypes[e],interpolator:s.interpolators[e]};"weights"===n.type&&(n.defaultMorphWeights=i.weights),r.tracks.push(n),r.nodes.indexOf(i)<0&&r.nodes.push(i),i.skeletonAttached&&r.skeletons.indexOf(i.skeletonAttached)<0&&r.skeletons.push(i.skeletonAttached)}return r}_loadNode(t,e,i,s){let r=t._nodes[e];if(r){if(i){if(r.parent)throw new Error("invalid node hierarchy");i.addChild(r)}return r}const n=t.nodes?.[e];if(!n)throw new Error(`invalid GLTF node: ${e}`);if(r=s.addNode(i,e,n.name),"number"==typeof n.mesh){r.mesh=t._meshes[n.mesh],r.weights&&(r.mesh.morphWeights=r.weights);const e=n.extensions?.EXT_mesh_gpu_instancing;if(e){const i=e.attributes;if(i){const e="number"==typeof i.TRANSLATION?t._accessors[i.TRANSLATION]:null,s="number"==typeof i.SCALE?t._accessors[i.SCALE]:null,n="number"==typeof i.ROTATION?t._accessors[i.ROTATION]:null,a=e?.count??s?.count??n.count??0,o=e?.getNormalizedDeinterlacedView(t),h=s?.getNormalizedDeinterlacedView(t),l=n?.getNormalizedDeinterlacedView(t);for(let t=0;t<a;t++){const e=o?new b(o[3*t],o[3*t+1],o[3*t+2]):b.zero(),i=h?new b(h[3*t],h[3*t+1],h[3*t+2]):b.one(),s=l?new v(l[4*t],l[4*t+1],l[4*t+2],l[4*t+3]):v.identity();r.instances.push({t:e,s:i,r:s})}}}else r.instances.push({t:b.zero(),s:b.one(),r:v.identity()})}if("number"!=typeof n.skin||n.skin<0)if(n.matrix){new S(n.matrix).decompose(r.scaling,r.rotation,r.position)}else n.rotation&&r.rotation.set(n.rotation),n.scale&&r.scaling.set(n.scale),n.translation&&r.position.set(n.translation);if(t._nodes[e]=r,n.children)for(const e of n.children)this._loadNode(t,e,r,s);return r}async _loadMeshes(t,e){if(t.meshes)for(let e=0;e<t.meshes.length;e++)t._meshes[e]=await this._loadMesh(t,e)}async _loadMesh(t,e){const i=t.meshes&&t.meshes[e];let s=null;if(i){s={morphWeights:i.weights??null,subMeshes:[]};const e=i.primitives,r=i.name||null;if(e)for(let i=0;i<e.length;i++){const n=e[i],a={name:`${r}-${i}`,primitive:null,material:null,rawPositions:null,rawBlendIndices:null,rawJointWeights:null,numTargets:0},o=new da,h=n.attributes,l=t._dracoModule?n.extensions?.KHR_draco_mesh_compression:null;let u=null;if(l){const e=t.bufferViews&&t.bufferViews[l.bufferView];if(!e)throw new Error("Draco buffer view not set");const i=t._loadedBuffers&&t._loadedBuffers[e.buffer];if(!i)throw new Error("Draco buffer view does not point to a valid ArrayBuffer");u=new ml(new Int8Array(i,e.byteOffset??0,e.byteLength),t._dracoModule)}for(const e in h)this._loadVertexBuffer(t,e,h[e],o,a,l,u);if(n.targets&&"webgl"===q.instance.device.type)if(void 0!==h.TEXCOORD_7)console.error("Could not load morph target animation"),n.targets=null;else{const t=new Float32Array(o.getNumVertices());for(let e=0;e<t.length;e++)t[e]=e;const e=q.instance.device.createVertexBuffer("tex7_f32",t);o.setVertexBuffer(e)}if(n.targets){const e={},i=[],s={POSITION:0,NORMAL:1,TANGENT:2,TEXCOORD_0:4,TEXCOORD_1:5,TEXCOORD_2:6,TEXCOORD_3:7,COLOR_0:3},r=new Set;for(const a of n.targets)for(const n in a){const o=s[n];if(void 0!==o){e[o]=e[o]??{numComponents:0,data:[]};const s=a[n],h=t._accessors[s];if(e[o].numComponents=h.getComponentCount(h.type),e[o].data.push(h.getNormalizedDeinterlacedView(t)),"POSITION"===n){const t=h.min?new b(h.min[0],h.min[1],h.min[2]):b.zero(),e=h.max?new b(h.max[0],h.max[1],h.max[2]):b.zero();i.push(new Ta(t,e))}r.add(o)}}a.numTargets=n.targets.length,a.targets=e,a.targetBox=i,a.morphAttribCount=r.size}const c=n.indices;"number"==typeof c&&this._loadIndexBuffer(t,c,o,a,l,u);let d=n.mode;"number"!=typeof d&&(d=4),o.primitiveType=this._primitiveType(d);const p=!!o.getVertexBuffer("normal"),m=!!o.getVertexBuffer("diffuse"),f=!!o.getVertexBuffer("tangent"),_=`${n.material}.${Number(p)}.${Number(m)}.${Number(f)}`;let g=t._materialCache[_];if(!g){const e=void 0!==n.material?t.materials[n.material]:null;g=await this._loadMaterial(t,e,m,p,f),t._materialCache[_]=g}a.primitive=o,a.material=g,s.subMeshes.push(a)}}return s}async _createMaterial(t,e){if("unlit"===e.type){const t=e,i=new po;return i.albedoColor=t.diffuse??T.one(),t.diffuseMap&&(i.albedoTexture=t.diffuseMap.texture,i.albedoTextureSampler=t.diffuseMap.sampler,i.albedoTexCoordIndex=t.diffuseMap.texCoord,i.albedoTexCoordMatrix=t.diffuseMap.transform),i.vertexColor=t.common.vertexColor,"blend"===e.common.alphaMode?i.blendMode="blend":"mask"===e.common.alphaMode&&(i.alphaCutoff=e.common.alphaCutoff),e.common.doubleSided&&(i.cullMode="none"),i}if("pbrSpecularGlossiness"===e.type){const t=e,i=new Co;return i.ior=t.ior,i.albedoColor=t.diffuse,i.specularFactor=new T(t.specular.x,t.specular.y,t.specular.z,1),i.glossinessFactor=t.glossness,t.diffuseMap&&(i.albedoTexture=t.diffuseMap.texture,i.albedoTextureSampler=t.diffuseMap.sampler,i.albedoTexCoordIndex=t.diffuseMap.texCoord,i.albedoTexCoordMatrix=t.diffuseMap.transform),t.common.normalMap&&(i.normalTexture=t.common.normalMap.texture,i.normalTextureSampler=t.common.normalMap.sampler,i.normalTexCoordIndex=t.common.normalMap.texCoord,i.normalTexCoordMatrix=t.common.normalMap.transform),i.normalScale=t.common.bumpScale,t.common.emissiveMap&&(i.emissiveTexture=t.common.emissiveMap.texture,i.emissiveTextureSampler=t.common.emissiveMap.sampler,i.emissiveTexCoordIndex=t.common.emissiveMap.texCoord,i.emissiveTexCoordMatrix=t.common.emissiveMap.transform),i.emissiveColor=t.common.emissiveColor,i.emissiveStrength=t.common.emissiveStrength,t.common.occlusionMap&&(i.occlusionTexture=t.common.occlusionMap.texture,i.occlusionTextureSampler=t.common.occlusionMap.sampler,i.occlusionTexCoordIndex=t.common.occlusionMap.texCoord,i.occlusionTexCoordMatrix=t.common.occlusionMap.transform),i.occlusionStrength=t.common.occlusionStrength,t.specularGlossnessMap&&(i.specularTexture=t.specularGlossnessMap.texture,i.specularTextureSampler=t.specularGlossnessMap.sampler,i.specularTexCoordIndex=t.specularGlossnessMap.texCoord,i.specularTexCoordMatrix=t.specularGlossnessMap.transform),i.vertexTangent=t.common.useTangent,i.vertexColor=t.common.vertexColor,"blend"===t.common.alphaMode?i.blendMode="blend":"mask"===t.common.alphaMode&&(i.alphaCutoff=t.common.alphaCutoff),t.common.doubleSided&&(i.cullMode="none"),i.vertexNormal=!!e.common.vertexNormal,i}if("pbrMetallicRoughness"===e.type){const t=e,i=new Eo;if(i.ior=t.ior,i.albedoColor=t.diffuse,i.metallic=t.metallic,i.roughness=t.roughness,t.diffuseMap&&(i.albedoTexture=t.diffuseMap.texture,i.albedoTextureSampler=t.diffuseMap.sampler,i.albedoTexCoordIndex=t.diffuseMap.texCoord,i.albedoTexCoordMatrix=t.diffuseMap.transform),t.common.normalMap&&(i.normalTexture=t.common.normalMap.texture,i.normalTextureSampler=t.common.normalMap.sampler,i.normalTexCoordIndex=t.common.normalMap.texCoord,i.normalTexCoordMatrix=t.common.normalMap.transform),i.normalScale=t.common.bumpScale,t.common.emissiveMap&&(i.emissiveTexture=t.common.emissiveMap.texture,i.emissiveTextureSampler=t.common.emissiveMap.sampler,i.emissiveTexCoordIndex=t.common.emissiveMap.texCoord,i.emissiveTexCoordMatrix=t.common.emissiveMap.transform),i.emissiveColor=t.common.emissiveColor,i.emissiveStrength=t.common.emissiveStrength,t.common.occlusionMap&&(i.occlusionTexture=t.common.occlusionMap.texture,i.occlusionTextureSampler=t.common.occlusionMap.sampler,i.occlusionTexCoordIndex=t.common.occlusionMap.texCoord,i.occlusionTexCoordMatrix=t.common.occlusionMap.transform,i.occlusionStrength=t.common.occlusionStrength),t.metallicMap&&(i.metallicRoughnessTexture=t.metallicMap.texture,i.metallicRoughnessTextureSampler=t.metallicMap.sampler,i.metallicRoughnessTexCoordIndex=t.metallicMap.texCoord,i.metallicRoughnessTexCoordMatrix=t.metallicMap.transform),i.specularFactor=t.specularFactor,t.specularMap&&(i.specularTexture=t.specularMap.texture,i.specularTextureSampler=t.specularMap.sampler,i.specularTexCoordIndex=t.specularMap.texCoord,i.specularTexCoordMatrix=t.specularMap.transform),t.specularColorMap&&(i.specularColorTexture=t.specularColorMap.texture,i.specularColorTextureSampler=t.specularColorMap.sampler,i.specularColorTexCoordIndex=t.specularColorMap.texCoord,i.specularColorTexCoordMatrix=t.specularColorMap.transform),t.sheen){const e=t.sheen;i.sheen=!0,i.sheenColorFactor=e.sheenColorFactor,i.sheenRoughnessFactor=e.sheenRoughnessFactor,e.sheenColorMap&&(i.sheenColorTexture=e.sheenColorMap.texture,i.sheenColorTextureSampler=e.sheenColorMap.sampler,i.sheenColorTexCoordIndex=e.sheenColorMap.texCoord,i.sheenColorTexCoordMatrix=e.sheenColorMap.transform),e.sheenRoughnessMap&&(i.sheenRoughnessTexture=e.sheenRoughnessMap.texture,i.sheenRoughnessTextureSampler=e.sheenRoughnessMap.sampler,i.sheenRoughnessTexCoordIndex=e.sheenRoughnessMap.texCoord,i.sheenRoughnessTexCoordMatrix=e.sheenRoughnessMap.transform)}if(t.iridescence){const e=t.iridescence;i.iridescence=!0,i.iridescenceFactor=e.iridescenceFactor,i.iridescenceIor=e.iridescenceIor,e.iridescenceMap&&(i.iridescenceTexture=e.iridescenceMap.texture,i.iridescenceTextureSampler=e.iridescenceMap.sampler,i.iridescenceTexCoordIndex=e.iridescenceMap.texCoord,i.iridescenceTexCoordMatrix=e.iridescenceMap.transform),i.iridescenceThicknessMin=e.iridescenceThicknessMinimum,i.iridescenceThicknessMax=e.iridescenceThicknessMaximum,e.iridescenceThicknessMap&&(i.iridescenceThicknessTexture=e.iridescenceThicknessMap.texture,i.iridescenceThicknessTextureSampler=e.iridescenceThicknessMap.sampler,i.iridescenceThicknessTexCoordIndex=e.iridescenceThicknessMap.texCoord,i.iridescenceThicknessTexCoordMatrix=e.iridescenceThicknessMap.transform)}if(t.transmission){const e=t.transmission;i.transmission=!0,i.transmissionFactor=e.transmissionFactor,e.transmissionMap&&(i.transmissionTexture=e.transmissionMap.texture,i.transmissionTextureSampler=e.transmissionMap.sampler,i.transmissionTexCoordIndex=e.transmissionMap.texCoord,i.transmissionTexCoordMatrix=e.transmissionMap.transform),i.thicknessFactor=e.thicknessFactor,e.thicknessMap&&(i.thicknessTexture=e.thicknessMap.texture,i.thicknessTextureSampler=e.thicknessMap.sampler,i.thicknessTexCoordIndex=e.thicknessMap.texCoord,i.thicknessTexCoordMatrix=e.thicknessMap.transform),i.attenuationDistance=e.attenuationDistance,i.attenuationColor=e.attenuationColor}if(t.clearcoat){const e=t.clearcoat;i.clearcoat=!0,i.clearcoatIntensity=e.clearCoatFactor,i.clearcoatRoughnessFactor=e.clearCoatRoughnessFactor,e.clearCoatIntensityMap&&(i.clearcoatIntensityTexture=e.clearCoatIntensityMap.texture,i.clearcoatIntensityTextureSampler=e.clearCoatIntensityMap.sampler,i.clearcoatIntensityTexCoordIndex=e.clearCoatIntensityMap.texCoord,i.clearcoatIntensityTexCoordMatrix=e.clearCoatIntensityMap.transform),e.clearCoatRoughnessMap&&(i.clearcoatRoughnessTexture=e.clearCoatRoughnessMap.texture,i.clearcoatRoughnessTextureSampler=e.clearCoatRoughnessMap.sampler,i.clearcoatRoughnessTexCoordIndex=e.clearCoatRoughnessMap.texCoord,i.clearcoatRoughnessTexCoordMatrix=e.clearCoatRoughnessMap.transform),e.clearCoatNormalMap&&(i.clearcoatNormalTexture=e.clearCoatNormalMap.texture,i.clearcoatNormalTextureSampler=e.clearCoatNormalMap.sampler,i.clearcoatNormalTexCoordIndex=e.clearCoatNormalMap.texCoord,i.clearcoatNormalTexCoordMatrix=e.clearCoatNormalMap.transform)}return i.vertexTangent=t.common.useTangent,i.vertexColor=t.common.vertexColor,"blend"===t.common.alphaMode?i.blendMode="blend":"mask"===t.common.alphaMode&&(i.alphaCutoff=t.common.alphaCutoff),t.common.doubleSided&&(i.cullMode="none"),i.vertexNormal=!!e.common.vertexNormal,i}}async _loadMaterial(t,e,i,s,r){let n=null,a=null,o=null;const h={useTangent:r,vertexColor:i,vertexNormal:s,bumpScale:1,emissiveColor:b.zero(),emissiveStrength:1,occlusionStrength:1};switch(e?.alphaMode){case"BLEND":h.alphaMode="blend";break;case"MASK":h.alphaMode="mask",h.alphaCutoff=e.alphaCutoff??.5}if(e?.doubleSided&&(h.doubleSided=!0),(e?.pbrMetallicRoughness||e?.extensions?.KHR_materials_pbrSpecularGlossiness)&&(h.normalMap=e.normalTexture?await this._loadTexture(t,e.normalTexture,!1):null,h.bumpScale=e.normalTexture?.scale??1,h.occlusionMap=e.occlusionTexture?await this._loadTexture(t,e.occlusionTexture,!1):null,h.occlusionStrength=e.occlusionTexture?.strength??1,h.emissiveMap=e.emissiveTexture?await this._loadTexture(t,e.emissiveTexture,!1):null,h.emissiveStrength=e?.extensions?.KHR_materials_emissive_strength?.emissiveStrength??1,h.emissiveColor=e.emissiveFactor?new b(e.emissiveFactor):b.zero()),e?.pbrMetallicRoughness&&(a={type:"pbrMetallicRoughness",ior:1.5,common:h},a.diffuse=new T(e.pbrMetallicRoughness.baseColorFactor??[1,1,1,1]),a.metallic=e.pbrMetallicRoughness.metallicFactor??1,a.roughness=e.pbrMetallicRoughness.roughnessFactor??1,a.diffuseMap=e.pbrMetallicRoughness.baseColorTexture?await this._loadTexture(t,e.pbrMetallicRoughness.baseColorTexture,!0):null,a.metallicMap=e.pbrMetallicRoughness.metallicRoughnessTexture?await this._loadTexture(t,e.pbrMetallicRoughness.metallicRoughnessTexture,!1):null,a.metallicIndex=2,a.roughnessIndex=1),e?.extensions?.KHR_materials_pbrSpecularGlossiness){const i=e.extensions?.KHR_materials_pbrSpecularGlossiness;o={type:"pbrSpecularGlossiness",ior:1.5,common:h},o.diffuse=new T(i.diffuseFactor??[1,1,1,1]),o.specular=new b(i.specularFactor??[1,1,1]),o.glossness=i.glossnessFactor??1,o.diffuseMap=i.diffuseTexture?await this._loadTexture(t,i.diffuseTexture,!0):null,o.specularGlossnessMap=i.specularGlossinessTexture?await this._loadTexture(t,i.specularGlossinessTexture,!0):null}if(n=o||a,n&&!e?.extensions?.KHR_materials_unlit||(n=e?.extensions?.KHR_materials_unlit?{type:"unlit",common:h,diffuse:a?.diffuse??T.one(),diffuseMap:a?.diffuseMap??null}:{type:"pbrMetallicRoughness",common:h,diffuse:T.one(),metallic:1,roughness:1,diffuseMap:null,metallicMap:null,metallicIndex:2,roughnessIndex:1}),"unlit"!==n.type&&e?.extensions?.KHR_materials_ior&&(n.ior=e.extensions.KHR_materials_ior.ior??1.5),"pbrMetallicRoughness"===n.type){a=n;const i=e?.extensions?.KHR_materials_specular?.specularColorFactor??[1,1,1];a.specularFactor=new T(...i,e?.extensions?.KHR_materials_specular?.specularFactor??1),a.specularMap=e?.extensions?.KHR_materials_specular?.specularTexture?await this._loadTexture(t,e.extensions.KHR_materials_specular.specularTexture,!1):null,a.specularColorMap=e?.extensions?.KHR_materials_specular?.specularColorTexture?await this._loadTexture(t,e.extensions.KHR_materials_specular.specularColorTexture,!0):null;const s=e?.extensions?.KHR_materials_iridescence;s&&(a.iridescence={iridescenceFactor:s.iridescenceFactor??0,iridescenceMap:s.iridescenceTexture?await this._loadTexture(t,s.iridescenceTexture,!1):null,iridescenceIor:s.iridescenceIor??1.3,iridescenceThicknessMinimum:s.iridescenceThicknessMinimum??100,iridescenceThicknessMaximum:s.iridescenceThicknessMaximum??400,iridescenceThicknessMap:s.iridescenceThicknessTexture?await this._loadTexture(t,s.iridescenceThicknessTexture,!1):null});const r=e?.extensions?.KHR_materials_transmission;if(r){a.transmission={transmissionFactor:r.transmissionFactor??0,transmissionMap:r.transmissionTexture?await this._loadTexture(t,r.transmissionTexture,!1):null,thicknessFactor:0,thicknessMap:null,attenuationDistance:99999,attenuationColor:b.one()};const i=e?.extensions?.KHR_materials_volume;if(i){a.transmission.thicknessFactor=i.thicknessFactor??0,a.transmission.thicknessMap=i.thicknessTexture?await this._loadTexture(t,i.thicknessTexture,!1):null,a.transmission.attenuationDistance=i.attenuationDistance??99999;const e=i.attenuationColor??[1,1,1];a.transmission.attenuationColor=new b(...e)}}const o=e?.extensions?.KHR_materials_sheen;o&&(a.sheen={sheenColorFactor:new b(o.sheenColorFactor??[0,0,0]),sheenColorMap:o.sheenColorTexture?await this._loadTexture(t,o.sheenColorTexture,!0):null,sheenRoughnessFactor:o.sheenRoughnessFactor??0,sheenRoughnessMap:o.sheenRoughnessTexture?await this._loadTexture(t,o.sheenRoughnessTexture,!0):null});const h=e?.extensions?.KHR_materials_clearcoat;h&&(a.clearcoat={clearCoatFactor:h.clearcoatFactor??0,clearCoatIntensityMap:h.clearcoatTexture?await this._loadTexture(t,h.clearcoatTexture,!1):null,clearCoatRoughnessFactor:h.clearcoatRoughnessFactor??0,clearCoatRoughnessMap:h.clearcoatRoughnessTexture?await this._loadTexture(t,h.clearcoatRoughnessTexture,!1):null,clearCoatNormalMap:h.clearcoatNormalTexture?await this._loadTexture(t,h.clearcoatNormalTexture,!1):null})}return await this._createMaterial(t._manager,n)}async _loadTexture(t,e,i){const s={texture:null,sampler:null,texCoord:e.texCoord??0,transform:null},r=t.textures[e.index];if(r){if(e.extensions?.KHR_texture_transform){const t=e.extensions.KHR_texture_transform;void 0!==t.texCoord&&(s.texCoord=t.texCoord);const i=void 0!==t.rotation?S.rotationZ(-t.rotation):S.identity(),r=void 0!==t.scale?new b(t.scale[0],t.scale[1],1):b.one(),n=void 0!==t.offset?new b(t.offset[0],t.offset[1],0):b.zero();s.transform=S.scaling(r).multiplyLeft(i).translateLeft(n)}let n="repeat",a="repeat",o="linear",h="linear",l="linear";const u=r.sampler,c=t.samplers&&t.samplers[u];if(c){switch(c.wrapS){case 10497:n="repeat";break;case 33648:n="mirrored-repeat";break;case 33071:n="clamp"}switch(c.wrapT){case 10497:a="repeat";break;case 33648:a="mirrored-repeat";break;case 33071:a="clamp"}switch(c.magFilter){case 9728:o="nearest";break;case 9729:o="linear"}switch(c.minFilter){case 9728:h="nearest",l="none";break;case 9729:h="linear",l="none";break;case 9984:h="nearest",l="nearest";break;case 9985:h="linear",l="nearest";break;case 9986:h="nearest",l="linear";break;case 9987:h="linear",l="linear"}}const d=r.source,p=`${d}:${!!i}:${n}:${a}:${h}:${o}:${l}`;if(s.texture=t._textureCache[p],!s.texture){const e=t.images[d];if(e)if(e.uri){const r=this._normalizeURI(t._baseURI,e.uri);s.texture=await t._manager.fetchTexture(r,{linearColorSpace:!i}),s.texture.name=r}else if("number"==typeof e.bufferView&&e.mimeType){const r=t.bufferViews&&t.bufferViews[e.bufferView];if(r){const n=t._loadedBuffers&&t._loadedBuffers[r.buffer];if(n){const a=new Uint8Array(n,r.byteOffset||0,r.byteLength),o=e.mimeType,h=new Blob([a],{type:o}),l=URL.createObjectURL(h);s.texture=await t._manager.fetchTexture(l,{mimeType:o,linearColorSpace:!i}),URL.revokeObjectURL(l)}}}s.texture&&(t._textureCache[p]=s.texture)}s.texture&&(s.sampler=q.instance.device.createSampler({addressU:n,addressV:a,magFilter:o,minFilter:h,mipFilter:l}))}return s}_primitiveType(t){switch(t){case 0:return"point-list";case 1:return"line-list";case 3:return"line-strip";case 4:return"triangle-list";case 5:return"triangle-strip";case 6:return"triangle-fan";default:return null}}_loadIndexBuffer(t,e,i,s,r,n){const a=t._accessors[e];if(n){const e=n.getIndexBuffer();if(!e||e.length!==a.count)throw new Error("Decode index buffer failed");if(e.length!==a.count)throw new Error("Decode index buffer failed");t._loadedBuffers.push(e.buffer),t.bufferViews||(t.bufferViews=[]),t.bufferViews.push({buffer:t._loadedBuffers.length-1,byteOffset:0,byteLength:e.byteLength}),a.componentType=ll.UINT,a.bufferView=t.bufferViews.length-1}this._setBuffer(t,e,i,null,s)}_loadVertexBuffer(t,e,i,s,r,n,a){const o=n?.attributes?.[e];if(void 0!==o){const e=t._accessors[i];let s=null;const r=e.count*e.getComponentCount(e.type);switch(e.componentType){case ll.FLOAT:s=new Float32Array(r);break;case ll.BYTE:s=new Int8Array(r);break;case ll.SHORT:s=new Int16Array(r);break;case ll.INT:s=new Int32Array(r);break;case ll.UBYTE:s=new Uint8Array(r);break;case ll.USHORT:s=new Uint16Array(r);break;case ll.UINT:s=new Uint32Array(r);break;default:throw new Error(`Invalid component type: ${e.componentType}`)}if(!a.getAttributeBuffer(o,s))throw new Error("Decode draco mesh failed");t._loadedBuffers.push(s.buffer),t.bufferViews||(t.bufferViews=[]),t.bufferViews.push({buffer:t._loadedBuffers.length-1,byteOffset:0,byteLength:s.byteLength}),e.bufferView=t.bufferViews.length-1}let h=null;switch(e){case"POSITION":h="position";break;case"NORMAL":h="normal";break;case"TANGENT":h="tangent";break;case"TEXCOORD_0":h="texCoord0";break;case"TEXCOORD_1":h="texCoord1";break;case"TEXCOORD_2":h="texCoord2";break;case"TEXCOORD_3":h="texCoord3";break;case"TEXCOORD_4":h="texCoord4";break;case"TEXCOORD_5":h="texCoord5";break;case"TEXCOORD_6":h="texCoord6";break;case"TEXCOORD_7":h="texCoord7";break;case"COLOR_0":h="diffuse";break;case"JOINTS_0":h="blendIndices";break;case"WEIGHTS_0":h="blendWeights";break;default:return}this._setBuffer(t,i,s,h,r)}_setBuffer(t,e,i,s,r){const n=q.instance.device,a=t._accessors[e],o=a.getComponentCount(a.type),h=!!a.normalized,l=`${e}:${s||""}:${Number(h)}`;let u=t._bufferCache[l];if(!u){let e=a.getNormalizedDeinterlacedView(t);if(s&&!(e instanceof Float32Array)){const t=new Float32Array(e.length);t.set(e),e=t}if(!s){if(!(e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array))return void console.error("Invalid index buffer component type");if(e instanceof Uint32Array&&!n.getDeviceCaps().miscCaps.support32BitIndex)return void console.error("Device does not support 32bit vertex index");if(e instanceof Uint8Array){const t=new Uint16Array(e.length);t.set(e),e=t}}if(s){const t=n.getVertexAttribFormat(s,"f32",o);u=n.createVertexBuffer(t,e)}else u=n.createIndexBuffer(e,{managed:!0});t._bufferCache[l]=u}if(u)if(s)if(i.setVertexBuffer(u),"position"===s){i.getIndexBuffer()||(i.indexCount=Math.floor(u.byteLength/12));const e=a.getNormalizedDeinterlacedView(t);r.rawPositions=e;const s=a.min,n=a.max;if(s&&n)i.setBoundingVolume(new Ta(new b(s),new b(n)));else{const t=new Ta;t.beginExtend();for(let i=0;i<e.length;i++){const s=new b(e[i*o],e[i*o+1],e[i*o+2]);t.extend(s)}t.isValid()&&i.setBoundingVolume(t)}}else"blendIndices"===s?r.rawBlendIndices=a.getNormalizedDeinterlacedView(t):"blendWeights"===s&&(r.rawJointWeights=a.getNormalizedDeinterlacedView(t));else i.setIndexBuffer(u),i.indexCount=u.length;return u}isGLB(t){if(t.byteLength>12){const e=new Uint32Array(t,0,3);if(1179937895===e[0]&&2===e[1]&&e[2]===t.byteLength)return!0}return!1}getGLBChunkInfo(t,e){const i=new Uint32Array(t,e,2);return{start:e+8,length:i[0],type:i[1]}}getGLBChunkInfos(t){const e=[];let i=12;for(;i<t.byteLength;){const s=this.getGLBChunkInfo(t,i);e.push(s),i+=s.length+8}return e}}class _l extends dl{supportExtension(t){return".jpg"===t||".jpeg"===t||".png"===t}supportMIMEType(t){return"image/jpg"===t||"image/jpeg"===t||"image/png"===t}async load(t,e,i,s,r,n,a){return new Promise(((t,e)=>{i||e("unknown image file type");const o=URL.createObjectURL(new Blob([s],{type:i})),h=document.createElement("img");h.src=o,h.onload=function(){createImageBitmap(h,{premultiplyAlpha:"none"}).then((i=>{const s={texture:a,samplerOptions:n},o=q.instance.device.createTexture2DFromImage(i,r,s);o?t(o):e("create texture from image element failed")}))},h.onerror=t=>{e(t)}}))}}const gl=31,xl=36,bl=542327876,wl=1,Tl=2,vl=4,yl=131072,El=65024,Sl=2097152;var Cl,Al,Ml,Rl;function Fl(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function Il(t){const e={},i=new Uint32Array(t,0,gl+1);if(i[0]!==bl)return console.log("Invalid DDS magic"),null;if(e.dwSize=i[1],124!==e.dwSize)return console.log("Invalid DDS header size"),null;if(e.dataOffset=e.dwSize+4,e.dwFlags=i[2],e.dwHeight=i[3],e.dwWidth=i[4],e.dwPitchOrLinearSize=i[5],e.dwDepth=i[6],e.dwMipmapCount=i[7],e.ddsPixelFormat={},e.ddsPixelFormat.dwFlags=i[20],e.ddsPixelFormat.dwFourCC=i[21],e.ddsPixelFormat.dwRGBBitCount=i[22],e.ddsPixelFormat.dwRBitMask=i[23],e.ddsPixelFormat.dwGBitMask=i[24],e.ddsPixelFormat.dwBBitMask=i[25],e.ddsPixelFormat.dwABitMask=i[26],e.dwCaps=i[27],e.dwCaps2=i[28],e.dwCaps3=i[29],e.dwCaps4=i[30],"DX10"===(s=e.ddsPixelFormat.dwFourCC,String.fromCharCode(255&s,s>>8&255,s>>16&255,s>>24&255))){const i=new Uint32Array(t,0,xl+1);e.ddsHeaderDX10={},e.ddsHeaderDX10.dxgiFormat=i[32],e.ddsPixelFormat.dwFourCC=e.ddsHeaderDX10.dxgiFormat,e.ddsHeaderDX10.dimension=i[33],e.ddsHeaderDX10.miscFlag=i[34],e.ddsHeaderDX10.arraySize=i[35],e.dataOffset+=20}var s;return e}!function(t){t[t.DDS_DIMENSION_TEXTURE1D=2]="DDS_DIMENSION_TEXTURE1D",t[t.DDS_DIMENSION_TEXTURE2D=3]="DDS_DIMENSION_TEXTURE2D",t[t.DDS_DIMENSION_TEXTURE3D=4]="DDS_DIMENSION_TEXTURE3D"}(Cl||(Cl={})),function(t){t[t.DXGI_FORMAT_RGBA32F=2]="DXGI_FORMAT_RGBA32F",t[t.DXGI_FORMAT_RGBA32UI=3]="DXGI_FORMAT_RGBA32UI",t[t.DXGI_FORMAT_RGBA32I=4]="DXGI_FORMAT_RGBA32I",t[t.DXGI_FORMAT_RGB32F=6]="DXGI_FORMAT_RGB32F",t[t.DXGI_FORMAT_RGB32UI=7]="DXGI_FORMAT_RGB32UI",t[t.DXGI_FORMAT_RGB32I=8]="DXGI_FORMAT_RGB32I",t[t.DXGI_FORMAT_RGBA16F=10]="DXGI_FORMAT_RGBA16F",t[t.DXGI_FORMAT_RGBA16UI=12]="DXGI_FORMAT_RGBA16UI",t[t.DXGI_FORMAT_RGBA16I=14]="DXGI_FORMAT_RGBA16I",t[t.DXGI_FORMAT_RG32F=16]="DXGI_FORMAT_RG32F",t[t.DXGI_FORMAT_RG32UI=17]="DXGI_FORMAT_RG32UI",t[t.DXGI_FORMAT_RG32I=18]="DXGI_FORMAT_RG32I",t[t.DXGI_FORMAT_RGBA8=28]="DXGI_FORMAT_RGBA8",t[t.DXGI_FORMAT_RGBA8_SRGB=29]="DXGI_FORMAT_RGBA8_SRGB",t[t.DXGI_FORMAT_RGBA8UI=30]="DXGI_FORMAT_RGBA8UI",t[t.DXGI_FORMAT_RGBA8I=32]="DXGI_FORMAT_RGBA8I",t[t.DXGI_FORMAT_RG16F=34]="DXGI_FORMAT_RG16F",t[t.DXGI_FORMAT_RG16UI=36]="DXGI_FORMAT_RG16UI",t[t.DXGI_FORMAT_RG16I=38]="DXGI_FORMAT_RG16I",t[t.DXGI_FORMAT_R32F=41]="DXGI_FORMAT_R32F",t[t.DXGI_FORMAT_R32UI=42]="DXGI_FORMAT_R32UI",t[t.DXGI_FORMAT_R32I=43]="DXGI_FORMAT_R32I",t[t.DXGI_FORMAT_R16F=54]="DXGI_FORMAT_R16F",t[t.DXGI_FORMAT_R16UI=57]="DXGI_FORMAT_R16UI",t[t.DXGI_FORMAT_R16I=59]="DXGI_FORMAT_R16I",t[t.DXGI_FORMAT_BGR565=85]="DXGI_FORMAT_BGR565",t[t.DXGI_FORMAT_BGRA5551=86]="DXGI_FORMAT_BGRA5551",t[t.DXGI_FORMAT_BGRA8=87]="DXGI_FORMAT_BGRA8",t[t.DXGI_FORMAT_BGRX8=88]="DXGI_FORMAT_BGRX8",t[t.DXGI_FORMAT_BGRA8_SRGB=91]="DXGI_FORMAT_BGRA8_SRGB",t[t.DXGI_FORMAT_BGRX8_SRGB=93]="DXGI_FORMAT_BGRX8_SRGB"}(Al||(Al={})),function(t){t[t.D3DFMT_RGB8=20]="D3DFMT_RGB8",t[t.D3DFMT_ARGB8=21]="D3DFMT_ARGB8",t[t.D3DFMT_XRGB8=22]="D3DFMT_XRGB8",t[t.D3DFMT_RGB565=23]="D3DFMT_RGB565",t[t.D3DFMT_XRGB1555=24]="D3DFMT_XRGB1555",t[t.D3DFMT_ARGB1555=25]="D3DFMT_ARGB1555",t[t.D3DFMT_ARGB4=26]="D3DFMT_ARGB4",t[t.D3DFMT_A8=28]="D3DFMT_A8",t[t.D3DFMT_XRGB4=30]="D3DFMT_XRGB4",t[t.D3DFMT_ABGR8=32]="D3DFMT_ABGR8",t[t.D3DFMT_XBGR8=33]="D3DFMT_XBGR8",t[t.D3DFMT_A8P8=40]="D3DFMT_A8P8",t[t.D3DFMT_P8=41]="D3DFMT_P8",t[t.D3DFMT_L8=50]="D3DFMT_L8",t[t.D3DFMT_A8L8=51]="D3DFMT_A8L8",t[t.D3DFMT_DXT1=Fl("DXT1")]="D3DFMT_DXT1",t[t.D3DFMT_DXT2=Fl("DXT2")]="D3DFMT_DXT2",t[t.D3DFMT_DXT3=Fl("DXT3")]="D3DFMT_DXT3",t[t.D3DFMT_DXT4=Fl("DXT4")]="D3DFMT_DXT4",t[t.D3DFMT_DXT5=Fl("DXT5")]="D3DFMT_DXT5",t[t.D3DFMT_BC4=Fl("ATI1")]="D3DFMT_BC4",t[t.D3DFMT_BC5=Fl("ATI2")]="D3DFMT_BC5",t[t.D3DFMT_R16F=111]="D3DFMT_R16F",t[t.D3DFMT_RG16F=112]="D3DFMT_RG16F",t[t.D3DFMT_RGBA16F=113]="D3DFMT_RGBA16F",t[t.D3DFMT_R32F=114]="D3DFMT_R32F",t[t.D3DFMT_RG32F=115]="D3DFMT_RG32F",t[t.D3DFMT_RGBA32F=116]="D3DFMT_RGBA32F"}(Ml||(Ml={})),function(t){t[t.RGB_SWIZZLE=1]="RGB_SWIZZLE",t[t.ALPHA_ONE=22]="ALPHA_ONE"}(Rl||(Rl={}));const Dl={2:"rgba32f",3:"rgba32ui",4:"rgba32i",10:"rgba16f",12:"rgba16ui",14:"rgba16i",16:"rg32f",17:"rg32ui",18:"rg32i",28:"rgba8unorm",29:"rgba8unorm-srgb",30:"rgba8ui",31:"rgba8snorm",32:"rgba8i",34:"rg16f",36:"rg16ui",38:"rg16i",41:"r32f",42:"r32ui",43:"r32i",49:"rg8unorm",50:"rg8ui",51:"rg8snorm",52:"rg8i",54:"r16f",57:"r16ui",59:"r16i",61:"r8unorm",62:"r8ui",63:"r8snorm",64:"r8i",71:"dxt1",72:"dxt1-srgb",74:"dxt3",75:"dxt3-srgb",77:"dxt5",78:"dxt5-srgb",80:"bc4",81:"bc4-signed",83:"bc5",84:"bc5-signed",95:"bc6h",96:"bc6h-signed",98:"bc7",99:"bc7-srgb"},$l=[{format:"dxt1",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Fl("DXT1")}},{format:"dxt3",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Fl("DXT3")}},{format:"dxt5",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Fl("DXT5")}},{format:"bc4",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Fl("ATI1")}},{format:"bc4",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Fl("BC4U")}},{format:"bc4-signed",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Fl("BC4S")}},{format:"bc5",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Fl("ATI2")}},{format:"bc5",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Fl("ATI2")}},{format:"bc5",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Fl("BC5U")}},{format:"bc5-signed",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Fl("BC5S")}},{format:"bgra8unorm",convertFlags:1,pf:{dwFlags:64|wl,dwRGBBitCount:32,dwRBitMask:16711680,dwGBitMask:65280,dwBBitMask:255,dwABitMask:4278190080}},{format:"bgra8unorm",convertFlags:23,pf:{dwFlags:64,dwRGBBitCount:32,dwRBitMask:16711680,dwGBitMask:65280,dwBBitMask:255}},{format:"rgba8unorm",convertFlags:0,pf:{dwFlags:64|wl,dwRGBBitCount:32,dwRBitMask:255,dwGBitMask:65280,dwBBitMask:16711680,dwABitMask:4278190080}},{format:"rgba8unorm",convertFlags:22,pf:{dwFlags:64,dwRGBBitCount:32,dwRBitMask:255,dwGBitMask:65280,dwBBitMask:16711680}},{format:"r16f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:111}},{format:"r16f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Al.DXGI_FORMAT_R16F}},{format:"rg16f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:112}},{format:"rg16f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Al.DXGI_FORMAT_RG16F}},{format:"rgba16f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:113}},{format:"rgba16f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Al.DXGI_FORMAT_RGBA16F}},{format:"r32f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:114}},{format:"r32f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Al.DXGI_FORMAT_R32F}},{format:"rg32f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:115}},{format:"rg32f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Al.DXGI_FORMAT_RG32F}},{format:"rgba32f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:116}},{format:"rgba32f",convertFlags:0,pf:{dwFlags:vl,dwFourCC:Al.DXGI_FORMAT_RGBA32F}}];function Ll(t,e){return(e=e||{}).format=function(t){if(t.ddsHeaderDX10){const e=t.ddsHeaderDX10?Dl[t.ddsHeaderDX10.dxgiFormat]:null;if(e)return e}const e=t.ddsPixelFormat,i=e.dwFlags;let s;for(s=0;s<$l.length;s++){const t=$l[s];if(i&vl&&t.pf.dwFlags&vl){if(e.dwFourCC===t.pf.dwFourCC)break}else if(i===t.pf.dwFlags)if(i&Tl){if(e.dwRGBBitCount===t.pf.dwRGBBitCount&&e.dwABitMask===t.pf.dwABitMask)break}else if(i&yl){if(!(e.dwRGBBitCount!==t.pf.dwRGBBitCount||e.dwRBitMask!==t.pf.dwRBitMask||e.dwABitMask!==t.pf.dwABitMask&&i&wl))break}else if(e.dwRGBBitCount===t.pf.dwRGBBitCount&&!(e.dwRBitMask!==t.pf.dwRBitMask||e.dwGBitMask!==t.pf.dwGBitMask||e.dwBBitMask!==t.pf.dwBBitMask||e.dwABitMask!==t.pf.dwABitMask&&i&wl))break}return s===$l.length?null:$l[s].format}(t),null===e.format?null:(e.isCompressed="dxt1"===e.format||"dxt3"===e.format||"dxt5"===e.format||"bc4"===e.format||"bc4-signed"===e.format||"bc5"===e.format||"bc5-signed"===e.format||"bc6h"===e.format||"bc6h-signed"===e.format||"bc7"===e.format||"bc7-srgb"===e.format,e.dataOffset=t.ddsHeaderDX10?148:128,e.width=t.dwWidth,e.height=t.dwHeight,e.depth=1,e.mipLevels=t.dwMipmapCount||1,e.arraySize=t.ddsHeaderDX10?t.ddsHeaderDX10.arraySize:1,e.isCubemap=e.isVolume=!1,t.dwCaps2&El?(e.isCubemap=!0,e.arraySize*=6):t.dwCaps2&Sl?(e.isVolume=!0,e.depth=t.dwDepth):t.ddsHeaderDX10&&t.ddsHeaderDX10.arraySize>1&&(e.isArray=!0,e.depth=t.ddsHeaderDX10.arraySize),e)}function Pl(t,e,i,s,r){switch(s){case"r16f":return new Uint16Array(t,r,e*i);case"rg16f":return new Uint16Array(t,r,e*i*2);case"r32f":return new Float32Array(t,r,e*i);case"rgba8unorm":case"bgra8unorm":return new Uint8Array(t,r,e*i*4);case"rgba16f":return new Uint16Array(t,r,e*i*4);case"rg32f":return new Float32Array(t,r,e*i*2);case"rgba32f":return new Float32Array(t,r,e*i*4);case"dxt1":case"bc4":case"bc4-signed":return new Uint8Array(t,r,Math.max(4,e)/4*Math.max(4,i)/4*8);case"dxt3":case"dxt5":case"bc5":case"bc5-signed":case"bc6h":case"bc6h-signed":case"bc7":case"bc7-srgb":return new Uint8Array(t,r,Math.max(4,e)/4*Math.max(4,i)/4*16);default:return null}}class Nl extends dl{supportExtension(t){return".dds"===t}supportMIMEType(t){return"image/dds"===t||"image/x-dds"===t}async load(t,e,i,s,r,n,a){const o=function(t){const e=Il(t);if(!e)return null;const i={};Ll(e,i),i.mipDatas=[];let s=i.dataOffset;for(let e=0;e<i.arraySize;e++){const e=[];let r=i.width,n=i.height;for(let a=0;a<i.mipLevels;a++){const a=Pl(t,r,n,i.format,s);e.push({data:a,width:r,height:n}),s+=a.byteLength,r=Math.max(1,r>>1),n=Math.max(1,n>>1)}i.mipDatas.push(e)}return i}(s);if(!o)throw new Error(`read DDS file failed: ${e}`);const h={texture:a,samplerOptions:n};return q.instance.device.createTextureFromMipmapData(o,r,h)}}const Bl=u(1);class Ol extends dl{supportExtension(t){return".hdr"===t}supportMIMEType(t){return"image/hdr"===t}async load(t,e,i,s,r,n,a){let o;for(const t of["rg11b10uf","rgba16f","rgba32f","rgba8unorm"]){const e=q.instance.device.getDeviceCaps().textureCaps.getTextureFormatInfo(t);if(e&&e.filterable&&e.renderable){o=t;break}}const h=await this.loadHDR(new Uint8Array(s),o),l={texture:a,samplerOptions:n},u=q.instance.device.createTexture2D(o,h.width,h.height,l);return u.update(h.dataFloat,0,0,h.width,h.height),u}_rgbeToFloat32(t){const e=t.byteLength>>2,i=new Float32Array(4*e);for(let s=0;s<e;s++){const e=Math.pow(2,t[4*s+3]-136);i[4*s]=t[4*s]*e,i[4*s+1]=t[4*s+1]*e,i[4*s+2]=t[4*s+2]*e,i[4*s+3]=1}return i}_rgbeToFloat16(t){const e=t.byteLength>>2,i=new Uint16Array(4*e);for(let s=0;s<e;s++){const e=Math.pow(2,t[4*s+3]-136);i[4*s+0]=u(Math.max(-65504,Math.min(t[4*s]*e,65504))),i[4*s+1]=u(Math.max(-65504,Math.min(t[4*s+1]*e,65504))),i[4*s+2]=u(Math.max(-65504,Math.min(t[4*s+2]*e,65504))),i[4*s+3]=Bl}return i}_rgbeToR11G11B10(t){const e=t.byteLength>>2,i=new Uint32Array(e);for(let s=0;s<e;s++){const e=Math.pow(2,t[4*s+3]-136),r=t[4*s]*e,n=t[4*s+1]*e,a=t[4*s+2]*e;i[s]=c(r,n,a)}return i}_rgbeToRGBM(t){const e=t.byteLength>>2,i=new Uint8Array(4*e);for(let s=0;s<e;s++){const e=Math.pow(2,t[4*s+3]-136),r=Math.pow(t[4*s]*e,1/2.2),n=Math.pow(t[4*s+1]*e,1/2.2),a=Math.pow(t[4*s+2]*e,1/2.2),o=Math.max(r,n,a),h=Math.ceil(255*o/6)/255,l=6*h;i[4*s]=Math.ceil(255*r/l),i[4*s+1]=Math.ceil(255*n/l),i[4*s+2]=Math.ceil(255*a/l),i[4*s+3]=Math.ceil(255*Math.min(h,1))}return i}async loadHDR(t,e){let i="",s=0;const r=t;let n;for(;!i.match(/\n\n[^\n]+\n/g);)i+=String.fromCharCode(r[s++]);if(n=i.match(/FORMAT=(.*)$/m),n.length<2)return;if(n=n[1],"32-bit_rle_rgbe"!=n)return console.warn("unknown format : "+n),null;let a=i.split(/\n/).reverse();if(a.length<2)return;if(a=a[1].split(" "),a.length<4)return;const o=1*Number(a[3]),h=1*Number(a[1]),l=new Uint8Array(o*h*4);let u=0;for(let t=0;t<h;t++){const t=[];let e=r.slice(s,s+=4);if(2==e[0]&&2==e[1]&&e[2]==(o>>8&255)&&e[3]==(255&o)&&o>=8&&o<32768){for(let e=0;e<4;e++){let i=e*o;const n=(e+1)*o;let a,h;for(;i<n;)if(a=r.slice(s,s+=2),a[0]>128)for(h=a[0]-128;h-- >0;)t[i++]=a[1];else for(h=a[0]-1,t[i++]=a[1];h-- >0;)t[i++]=r[s++]}for(let e=0;e<o;e++)l[u++]=t[e+0*o],l[u++]=t[e+1*o],l[u++]=t[e+2*o],l[u++]=t[e+3*o]}else{s-=4;for(let t=0;t<o;t++)e=r.slice(s,s+=4),l[u++]=e[0],l[u++]=e[1],l[u++]=e[2],l[u++]=e[3]}}return{dataFloat:"rgba32f"===e?this._rgbeToFloat32(l):"rgba16f"===e?this._rgbeToFloat16(l):"rg11b10uf"===e?this._rgbeToR11G11B10(l):this._rgbeToRGBM(l),width:o,height:h}}}function Ul(){return async function(t){const e=q.instance.device.createCubeTexture("rgba8unorm",32,{samplerOptions:{mipFilter:"none"}}),i=q.instance.device.createFrameBuffer([e],null);q.instance.device.pushDeviceStates(),q.instance.device.setFramebuffer(i);const s=[new T(1,0,0,1),new T(.2,0,0,1),new T(0,1,0,1),new T(0,.2,0,1),new T(0,0,1,1),new T(0,0,.2,1)];for(let t=0;t<6;t++)i.setColorAttachmentCubeFace(0,t),q.instance.device.clearFrameBuffer(s[t],null,null);return q.instance.device.popDeviceStates(),i.dispose(),e}}function kl(t){const e=new Uint32Array(1);function i(t,i,s){s.setXY(t*i,function(t){return e[0]=t,e[0]=(e[0]<<16|e[0]>>16)>>>0,e[0]=(1431655765&e[0])<<1|(2863311530&e[0])>>>1>>>0,e[0]=(858993459&e[0])<<2|(3435973836&e[0])>>>2>>>0,e[0]=(252645135&e[0])<<4|(4042322160&e[0])>>>4>>>0,e[0]=(16711935&e[0])<<8|(4278255360&e[0])>>>8>>>0,2.3283064365386963e-10*e[0]}(t))}function s(t,e){const i=1/e,s=1-t*t;return(2+i)*Math.pow(s,.5*i)/(2*Math.PI)}function r(t,e){return Math.min(Math.max(1/(4*(e+t-e*t)),0),1)}function n(t,e){const i=2*Math.PI*t.x,s=1-t.y,r=Math.sqrt(1-s*s);e.setXYZ(r*Math.cos(i),r*Math.sin(i),s)}function a(t,e,a){let o=0;const h=new b(Math.sqrt(1-t*t),0,t),l=new x,u=new b,c=new b;for(let d=0;d<a;d++){i(d,1/a,l),n(l,u),b.scale(u,2*b.dot(h,u),c).subBy(h);const p=Math.min(Math.max(b.dot(h,u),0),1),m=Math.min(Math.max(c.z,0),1),f=Math.min(Math.max(u.z,0),1);if(m>0){o+=r(t,m)*s(f,e)*m*p}}return o*(8*Math.PI/a)}const o=function(){const t=new ArrayBuffer(4),e=new Float32Array(t),i=new Uint32Array(t),s=new Uint32Array(512),r=new Uint32Array(512);for(let t=0;t<256;++t){const e=t-127;e<-27?(s[t]=0,s[256|t]=32768,r[t]=24,r[256|t]=24):e<-14?(s[t]=1024>>-e-14,s[256|t]=1024>>-e-14|32768,r[t]=-e-1,r[256|t]=-e-1):e<=15?(s[t]=e+15<<10,s[256|t]=e+15<<10|32768,r[t]=13,r[256|t]=13):e<128?(s[t]=31744,s[256|t]=64512,r[t]=24,r[256|t]=24):(s[t]=31744,s[256|t]=64512,r[t]=13,r[256|t]=13)}const n=new Uint32Array(2048),a=new Uint32Array(64),o=new Uint32Array(64);for(let t=1;t<1024;++t){let e=t<<13,i=0;for(;0==(8388608&e);)e<<=1,i-=8388608;e&=-8388609,i+=947912704,n[t]=e|i}for(let t=1024;t<2048;++t)n[t]=939524096+(t-1024<<13);for(let t=1;t<31;++t)a[t]=t<<23;a[31]=1199570944,a[32]=2147483648;for(let t=33;t<63;++t)a[t]=2147483648+(t-32<<23);a[63]=3347054592;for(let t=1;t<64;++t)32!==t&&(o[t]=1024);return{floatView:e,uint32View:i,baseTable:s,shiftTable:r,mantissaTable:n,exponentTable:a,offsetTable:o}}();function h(t){t=Math.min(Math.max(t,-65504),65504),o.floatView[0]=t;const e=o.uint32View[0],i=e>>23&511;return o.baseTable[i]+((8388607&e)>>o.shiftTable[i])}return async function(e,i){if(i){if(!i.isTexture2D())throw new Error("can not reload sheen lut texture: invalid texture type");if("rgba16f"!==i.format)throw new Error("can not reload sheen lut texture: invalid texture format");if(i.width!==t||i.height!==t)throw new Error("can not reload sheen lut texture: invalid texture size")}const s=i||q.instance.device.createTexture2D("rgba16f",t,t),r=new Uint16Array(t*t*4);let n=0;const o=h(1);for(let e=t-1;e>=0;e--){const i=Math.min(Math.max((e+.5)/t,0),1),s=i*i;for(let e=0;e<t;e++){const i=h(a(Math.min(Math.max((e+.5)/t,0),1),s,512));r[n++]=0,r[n++]=0,r[n++]=i,r[n++]=o}}return s.update(r,0,0,t,t),s.name=`builtin:${Fa}`,s}}class zl extends dl{supportExtension(t){return".tga"===t}supportMIMEType(t){return"image/tga"===t||"image/x-tga"===t}parseTGA(t,e,i,s){const r=new DataView(t),n=[0,0,0,0];do{let t=0;t+=r.getUint8(0);const a=r.getUint8(1);if(0!==a&&1!==a)break;const o=r.getUint8(2);if(2!==o&&10!==o)break;t+=r.getUint16(5,!0)*a;const h=r.getUint16(12,!0),l=r.getUint16(14,!0),u=r.getUint8(16);if(16!==u&&24!==u&&32!==u)break;let c=18+t;const d=u/8,p=new Uint8Array(h*l*4);let m=0;for(;m<h*l;)if(2===o){for(let t=0;t<d;t++)n[t]=r.getUint8(c++);this.mergeBytes(p,4*m,n,d),m++}else{const t=r.getUint8(c++);for(let t=0;t<d;t++)n[t]=r.getUint8(c++);const e=127&t;if(this.mergeBytes(p,4*m,n,d),m++,128&t)for(let t=0;t<e;t++)this.mergeBytes(p,4*m,n,d),m++;else for(let t=0;t<e;t++){for(let e=0;e<d;e++)n[t]=r.getUint8(c++);this.mergeBytes(p,4*m,n,d),m++}}const f={texture:s};i&&(f.samplerOptions={mipFilter:"none"});const _=q.instance.device.createTexture2D(e?"rgba8unorm-srgb":"rgba8unorm",h,l,f);return _.update(p,0,0,h,l),_}while(0);throw new Error("Unsupported TGA file format")}mergeBytes(t,e,i,s){4===s?(t[e+0]=i[2],t[e+1]=i[1],t[e+2]=i[0],t[e+3]=i[3]):3===s?(t[e+0]=i[2],t[e+1]=i[1],t[e+2]=i[0],t[e+3]=255):2===s&&(t[e+0]=(124&i[1])<<1,t[e+1]=(3&i[1])<<6|(224&i[0])>>2,t[e+2]=(31&i[0])<<3,t[e+3]=128&i[1])}async load(t,e,i,s,r,n,a){return new Promise(((t,e)=>{t(this.parseTGA(s,r,"none"===n?.mipFilter,a))}))}}function Vl(t,e){const i=t.numTargets;if(0===i)return;const s=Object.getOwnPropertyNames(t.targets),r=t.primitive.getNumVertices(),n=new Float32Array(268);for(let t=0;t<i;t++)n[4+t]=e?.[t]??0;const a=Math.ceil(Math.sqrt(r*s.length*i));if(a>q.instance.device.getDeviceCaps().textureCaps.maxTextureSize)throw new Error("Morph target data too large");n[0]=a,n[1]=a,n[2]=r,n[3]=i;let o=0;const h=new Float32Array(a*a*4);for(let e=0;e<8;e++){if(s.indexOf(String(e))<0){n[260+e]=-1;continue}n[260+e]=o>>2;const a=t.targets[e];if(a.data.length!==i)return void console.error("Invalid morph target data");for(let t=0;t<i;t++){const e=a.data[t];for(let t=0;t<r;t++)for(let i=0;i<4;i++)h[o++]=i<a.numComponents?e[t*a.numComponents+i]:1}}const l=q.instance.device.createTexture2D("rgba32f",a,a,{samplerOptions:{minFilter:"nearest",magFilter:"nearest",mipFilter:"none"}});l.update(h,0,0,a,a);const u=new ee("dummy","std140",[{name:Qa.getMorphInfoUniformName(),type:new ie(new te(Bt.F32VEC4),67)}]),c=q.instance.device.createStructuredBuffer(u,{usage:"uniform"},n),d=new Ta;Gl(d,t.targetBox,n.subarray(4,260),i);const p=t.mesh.getBoundingVolume().toAABB();d.minPoint.addBy(p.minPoint),d.maxPoint.addBy(p.maxPoint),t.mesh.setMorphData(l),t.mesh.setMorphInfo(c),t.mesh.setAnimatedBoundingBox(d)}function Gl(t,e,i,s){t.minPoint.setXYZ(0,0,0),t.maxPoint.setXYZ(0,0,0);for(let r=0;r<s;r++){const s=i[r],n=e[r];t.minPoint.x+=n.minPoint.x*s,t.minPoint.y+=n.minPoint.y*s,t.minPoint.y+=n.minPoint.z*s,t.maxPoint.x+=n.maxPoint.x*s,t.maxPoint.y+=n.maxPoint.y*s,t.maxPoint.y+=n.maxPoint.z*s}}class Xl extends jh{_state;_boundingBox;_defaultWeights;constructor(t,e){super(t.interpolator),this._state={numTargets:t.interpolator.stride,boundingBox:new Ta,weights:new Float32Array(Pa)},this._boundingBox=e.targetBox,this._defaultWeights=t.defaultMorphWeights??Array.from({length:this._state.numTargets}).map((()=>0))}calculateState(t){return this._interpolator.interpolate(t,this._state.weights),Gl(this._state.boundingBox,this._boundingBox,this._state.weights,this._state.numTargets),this._state}applyState(t,e){t.getMorphInfo().bufferSubData(16,e.weights);const i=new Ta,s=t.getBoundingVolume().toAABB();i.minPoint=b.add(s.minPoint,e.boundingBox.minPoint),i.maxPoint=b.add(s.maxPoint,e.boundingBox.maxPoint),t.setAnimatedBoundingBox(i)}mixState(t,e,i){const s={weights:new Float32Array(t.numTargets),boundingBox:new Ta,numTargets:t.numTargets};for(let r=0;r<t.numTargets;r++)s.weights[r]=t.weights[r]+(e.weights[r]-t.weights[r])*i,s.boundingBox.minPoint=b.min(t.boundingBox.minPoint,e.boundingBox.minPoint),s.boundingBox.maxPoint=b.max(t.boundingBox.maxPoint,e.boundingBox.maxPoint);return s}getBlendId(){return"node-morph"}reset(t){this._state.weights.set(this._defaultWeights),this.applyState(t,this._state)}}class Wl{static _builtinTextures={};static _builtinTextureLoaders={[Fa]:kl(64),TEST_Cubemap:Ul()};_httpRequest;_textureLoaders;_modelLoaders;_textures;_models;_binaryDatas;_textDatas;constructor(){this._httpRequest=new e,this._textureLoaders=[new _l,new Nl,new Ol,new zl],this._modelLoaders=[new fl],this._textures={},this._models={},this._binaryDatas={},this._textDatas={}}get httpRequest(){return this._httpRequest}clearCache(){this._textures={},this._models={},this._binaryDatas={},this._textDatas={}}purgeCache(){for(const t in this._textures)this._textures[t].then((t=>t?.dispose())).catch((t=>{})),delete this._textures[t];this._models={},this._binaryDatas={},this._textDatas={}}addTextureLoader(t){t&&this._textureLoaders.unshift(t)}addModelLoader(t){t&&this._modelLoaders.unshift(t)}async fetchTextData(t,e){let i=this._textDatas[t];return i||(i=this.loadTextData(t,e),this._textDatas[t]=i),i}async fetchBinaryData(t,e){let i=this._binaryDatas[t];return i||(i=this.loadBinaryData(t,e),this._binaryDatas[t]=i),i}async fetchTexture(t,e){if(e?.texture)return this.loadTexture(t,e.mimeType??null,!e.linearColorSpace,e.samplerOptions,e.texture);{const i=this.getHash("2d",t,e);let s=this._textures[i];if(s){const t=await s;if(t.disposed)return await t.reload(),t}else s=this.loadTexture(t,e?.mimeType??null,!e?.linearColorSpace,e?.samplerOptions),this._textures[i]=s;return s}}async fetchModelData(t,e,i){let s=this._models[e];return s||(s=this.loadModel(e,i),this._models[e]=s),s}async fetchModel(t,e,i){const s=await this.fetchModelData(t,e,i);return this.createSceneNode(t,s,!!i?.enableInstancing)}async loadTextData(t,e){let i=await this._httpRequest.requestText(t);if(e)try{i=e(i)}catch(t){throw new Error(`Load text data post process failed: ${t}`)}return i}async loadBinaryData(t,e){let i=await this._httpRequest.requestArrayBuffer(t);if(e)try{i=e(i)}catch(t){throw new Error(`Load binary data post process failed: ${t}`)}return i}async loadTexture(t,e,i,s,r){const n=await this._httpRequest.requestArrayBuffer(t);let a="",o="";const h=t.match(/^data:([^;]+)/);if(h)e=e||h[1];else{o=new URL(t,new URL(location.href).origin).pathname.split("/").filter((t=>!!t)).slice(-1)[0];const i=o?o.lastIndexOf("."):-1;a=i>=0?o.substring(i).toLowerCase():null,e||(".jpg"===a||".jpeg"===a?e="image/jpg":".png"===a&&(e="image/png"))}for(const h of this._textureLoaders){if(!(a&&h.supportExtension(a)||e&&h.supportMIMEType(e)))continue;const l=await this.doLoadTexture(h,o,e,n,!!i,s,r);if(l.name=o,t.match(/^blob:/))l.restoreHandler=async t=>{await this.doLoadTexture(h,o,e,n,!!i,s,t)};else{const r=s?null:{...s};l.restoreHandler=async s=>{await this.loadTexture(t,e,i,r,s)}}return l}throw new Error(`Can not find loader for asset ${t}`)}async doLoadTexture(t,e,i,s,r,n,a){const o=q.instance.device;if("webgl"!==o.type)return await t.load(this,e,i,s,r,n,a);{let u=await t.load(this,e,i,s,r,n);if(a){const t=u.width!==a.width||u.height!==a.height?"linear":"nearest",e=t,i="none",s=o.createSampler({addressU:"clamp",addressV:"clamp",magFilter:t,minFilter:e,mipFilter:i});(new wa).blit(u,a,s),u=a}else{const t=h(u.width),e=h(u.height),i=u.isSRGBFormat();if(i||!t||!e){const s=t?u.width:l(u.width),r=e?u.height:l(u.height),n=s!==u.width||r!==u.height?"linear":"nearest",a=n,h="none",c=o.createSampler({addressU:"clamp",addressV:"clamp",magFilter:n,minFilter:a,mipFilter:h}),d=i?"rgba8unorm":u.format,p=new wa,m=u.isTexture2D()?o.createTexture2D(d,s,r):o.createCubeTexture(d,s);p.blit(u,m,c),u.dispose(),u=m}}return u}}async loadModel(t,e){const i=await this.httpRequest.requestBlob(t),s=new URL(t,new URL(location.href).origin).pathname.split("/").filter((t=>!!t)).slice(-1)[0],r=s?s.lastIndexOf("."):-1,n=r>=0?s.substring(r):null;for(const r of this._modelLoaders){if(!r.supportExtension(n)&&!r.supportMIMEType(e?.mimeType||i.type))continue;let a=await r.load(this,t,e?.mimeType||i.type,i,e?.dracoDecoderModule);if(!a)throw new Error(`Load asset failed: ${t}`);if(e?.postProcess)try{a=e.postProcess(a)}catch(t){throw new Error(`Model loader post process failed: ${t}`)}return a.name=s,a}throw new Error(`Can not find loader for asset ${t}`)}async fetchBuiltinTexture(t,e){const i=Wl._builtinTextureLoaders[t];if(!i)throw new Error(`Unknown builtin texture name: ${t}`);if(e)return i(this,e);{let e=Wl._builtinTextures[t];e||(e=i(this),Wl._builtinTextures[t]=e);const s=await e;return s.restoreHandler=async t=>{await i(this,t)},s}}createSceneNode(t,e,i){const s=new Bo(t);s.name=e.name;let r=new Hh(t,s);for(let n=0;n<e.scenes.length;n++){const a=e.scenes[n],o=new Map,h=new Map;for(let r=0;r<a.rootNodes.length;r++)this.setAssetNodeToSceneNode(t,s,e,a.rootNodes[r],o,h,i);for(const t of e.animations){const e=new Wh(t.name);for(const i of t.tracks)if("translation"===i.type)e.addTrack(h.get(i.node),new qh(i.interpolator));else if("scale"===i.type)e.addTrack(h.get(i.node),new Zh(i.interpolator));else if("rotation"===i.type)e.addTrack(h.get(i.node),new Yh(i.interpolator));else if("weights"===i.type)for(const t of i.node.mesh.subMeshes)if(i.interpolator.stride>Pa)console.error(`Morph target too large: ${i.interpolator.stride}, the maximum is 256`);else{const s=new Xl(i,t);e.addTrack(t.mesh,s)}else console.error(`Invalid animation track type: ${i.type}`);if(0!==e.tracks.size){r.add(e);for(const i of t.skeletons){const t=o.get(i);t&&(t.skeleton||(t.skeleton=new el(i.joints.map((t=>h.get(t))),i.inverseBindMatrices,i.bindPoseMatrices,t.mesh,t.bounding)),e.addSkeleton(t.skeleton))}}}}return 0===r.numAnimations&&(r.dispose(),r=null),{group:s,animationSet:r}}static setBuiltinTextureLoader(t,e){e?this._builtinTextureLoaders[t]=e:delete this._builtinTextureLoaders[t]}setAssetNodeToSceneNode(t,e,i,s,r,n,a){const o=new Bo(t);if(n.set(s,o),o.name=`${s.name}`,o.position.set(s.position),o.rotation.set(s.rotation),o.scale.set(s.scaling),s.mesh){const e=s.mesh,i=s.skeleton;for(const n of e.subMeshes)for(const h of s.instances){const s=new Lh(t);s.position=h.t,s.scale=h.s,s.rotation=h.r,s.name=n.name,s.clipTestEnabled=!0,s.showState="inherit",s.primitive=n.primitive,s.material=a?n.material.createInstance():n.material,s.reparent(o),n.mesh=s,Vl(n,e.morphWeights),i&&(r.has(i)?(r.get(i).mesh.push(s),r.get(i).bounding.push(n)):r.set(i,{mesh:[s],bounding:[n]}))}}o.reparent(e);for(const e of s.children)this.setAssetNodeToSceneNode(t,o,i,e,r,n,a)}getHash(t,e,i){return`${t}:${e}:${!i?.linearColorSpace}`}}class Hl{_outputTexture;_quadVertexLayout;_quadRenderStateSet;_enabled;_opaque;constructor(){this._outputTexture=null,this._quadVertexLayout=null,this._quadRenderStateSet=null,this._enabled=!0,this._opaque=!1}get enabled(){return this._enabled}set enabled(t){this._enabled=!!t}get opaque(){return this._opaque}needFlip(t){return"webgpu"===t.type&&!!t.getFramebuffer()}dispose(){this._quadVertexLayout?.dispose(),this._quadVertexLayout=null,this._quadRenderStateSet=null}drawFullscreenQuad(t){vo(t)}createVertexLayout(t){return t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]})}createRenderStates(t){const e=t.createRenderStateSet();return e.useRasterizerState().setCullMode("none"),e.useDepthState().enableTest(!1).enableWrite(!1),e}}class jl extends Hl{static _nearestSampler=null;static _programTonemap=null;_bindgroupTonemap;_exposure;constructor(){super(),this._bindgroupTonemap=null,this._opaque=!1,this._exposure=1}get exposure(){return this._exposure}set exposure(t){this._exposure=t}requireLinearDepthTexture(){return!1}requireDepthAttachment(){return!1}apply(t,e,i,s){const r=t.device;this._prepare(r,e),this._tonemap(r,e,s)}_tonemap(t,e,i){this._bindgroupTonemap.setValue("srgbOut",i?1:0),this._bindgroupTonemap.setValue("exposure",this._exposure),this._bindgroupTonemap.setValue("flip",this.needFlip(t)?1:0),this._bindgroupTonemap.setTexture("tex",e,jl._nearestSampler),t.setProgram(jl._programTonemap),t.setBindGroup(0,this._bindgroupTonemap),this.drawFullscreenQuad()}_prepare(t,e){jl._programTonemap||(jl._programTonemap=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))},fragment(t){this.srgbOut=t.int().uniform(0),this.exposure=t.float().uniform(0),this.tex=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.func("RRTAndODTFit",[t.vec3("v")],(function(){this.$l.a=t.sub(t.mul(this.v,t.add(this.v,t.vec3(.0245786))),t.vec3(90537e-9)),this.$l.b=t.add(t.mul(this.v,t.add(t.mul(this.v,.983729),t.vec3(.432951))),t.vec3(.238081)),this.$return(t.div(this.a,this.b))})),t.main((function(){this.$l.vSample=t.textureSample(this.tex,this.$inputs.uv),this.$l.ACESInputMat=t.mat3(.59719,.076,.0284,.35458,.90834,.13383,.04823,.01566,.83777),this.$l.ACESOutputMat=t.mat3(1.60475,-.10208,-.00327,-.53108,1.10813,-.07276,-.07367,-.00605,1.07602),this.$l.color=t.mul(this.vSample.rgb,t.div(this.exposure,.6)),this.color=t.mul(this.ACESInputMat,this.color),this.color=this.RRTAndODTFit(this.color),this.color=t.mul(this.ACESOutputMat,this.color),this.color=t.clamp(this.color,t.vec3(0),t.vec3(1)),this.$if(t.notEqual(this.srgbOut,0),(function(){this.$l.color=ca(this,this.color)})),this.$outputs.outColor=t.vec4(this.color,1)}))}})),this._bindgroupTonemap||(this._bindgroupTonemap=t.createBindGroup(jl._programTonemap.bindGroupLayouts[0])),jl._nearestSampler||(jl._nearestSampler=t.createSampler({magFilter:"nearest",minFilter:"nearest",mipFilter:"none",addressU:"clamp",addressV:"clamp"}))}dispose(){super.dispose(),this._bindgroupTonemap?.dispose(),this._bindgroupTonemap=null}}class ql extends Hl{static _nearestSampler=null;static _programDownsampleH=null;static _programDownsampleV=null;static _programUpsample=null;static _programFinalCompose=null;static _programPrefilter=null;static _renderStateAdditive=null;_bindgroupDownsampleH;_bindgroupDownsampleV;_bindgroupUpsample;_bindgroupFinalCompose;_bindgroupPrefilter;_thresholdValue;_invTexSize;_maxDownsampleLevels;_downsampleLimit;_threshold;_thresholdKnee;_intensity;constructor(){super(),this._bindgroupDownsampleH=null,this._bindgroupDownsampleV=null,this._bindgroupUpsample=null,this._bindgroupFinalCompose=null,this._bindgroupPrefilter=null,this._opaque=!1,this._thresholdValue=new T,this._invTexSize=new x,this._maxDownsampleLevels=4,this._downsampleLimit=32,this._threshold=.8,this._thresholdKnee=0,this._intensity=1}get maxDownsampleLevel(){return this._maxDownsampleLevels}set maxDownsampleLevel(t){this._maxDownsampleLevels=t}get downsampleLimit(){return this._downsampleLimit}set downsampleLimit(t){this._downsampleLimit=t}get threshold(){return this._threshold}set threshold(t){this._threshold=t}get thresholdKnee(){return this._thresholdKnee}set thresholdKnee(t){this._thresholdKnee=t}get intensity(){return this._intensity}set intensity(t){this._intensity=t}requireLinearDepthTexture(){return!1}requireDepthAttachment(){return!1}apply(t,e,i,s){const r=t.device,n=[];this._prepare(r,e),r.pushDeviceStates();const a=Math.max(e.width>>1,1),o=Math.max(e.height>>1,1),h=r.pool.fetchTemporalTexture2D(!1,e.format,a,o,!1);this.prefilter(r,e,h),this.downsample(r,h,n),this.upsample(r,n),r.popDeviceStates(),this.finalCompose(r,e,n[0]);for(const t of n)r.pool.releaseTexture(t);r.pool.releaseTexture(h)}prefilter(t,e,i){this._thresholdValue.x=this._threshold*this._threshold,this._thresholdValue.y=this._thresholdValue.x*this._thresholdKnee,this._thresholdValue.z=2*this._thresholdValue.y,this._thresholdValue.w=.25/(this._thresholdValue.y+1e-5),this._thresholdValue.y-=this._thresholdValue.x,t.setFramebuffer([i]),t.setProgram(ql._programPrefilter),t.setBindGroup(0,this._bindgroupPrefilter),this._bindgroupPrefilter.setTexture("tex",e),this._bindgroupPrefilter.setValue("flip","webgpu"===t.type?1:0),this._bindgroupPrefilter.setValue("threshold",this._thresholdValue),this.drawFullscreenQuad()}finalCompose(t,e,i){t.setProgram(ql._programFinalCompose),t.setBindGroup(0,this._bindgroupFinalCompose),this._bindgroupFinalCompose.setTexture("srcTex",e),this._bindgroupFinalCompose.setTexture("bloomTex",i),this._bindgroupFinalCompose.setValue("intensity",this._intensity),this._bindgroupFinalCompose.setValue("flip","webgpu"===t.type&&t.getFramebuffer()?1:0),this.drawFullscreenQuad()}upsample(t,e){t.setProgram(ql._programUpsample),t.setBindGroup(0,this._bindgroupUpsample),this._bindgroupUpsample.setValue("flip","webgpu"===t.type?1:0);for(let i=e.length-2;i>=0;i--)this._bindgroupUpsample.setTexture("tex",e[i+1]),t.setFramebuffer([e[i]]),this.drawFullscreenQuad(ql._renderStateAdditive)}downsample(t,e,i){const s=Math.max(2,this._downsampleLimit);let r=Math.max(s,e.width>>1),n=Math.max(s,e.height>>1),a=Math.max(this._maxDownsampleLevels,1),o=e;for(this._bindgroupDownsampleH.setValue("flip","webgpu"===t.type?1:0),this._bindgroupDownsampleV.setValue("flip","webgpu"===t.type?1:0);(r>=s||n>=s)&&a>0;){const s=t.pool.fetchTemporalTexture2D(!1,e.format,r,n,!1);i.push(s);const h=t.pool.fetchTemporalTexture2D(!1,e.format,r,n,!1);this._invTexSize.setXY(1/o.width,1/o.height),t.setFramebuffer([h]),t.setProgram(ql._programDownsampleH),t.setBindGroup(0,this._bindgroupDownsampleH),this._bindgroupDownsampleH.setTexture("tex",o),this._bindgroupDownsampleH.setValue("invTexSize",this._invTexSize),this.drawFullscreenQuad(),this._invTexSize.setXY(1/h.width,1/h.height),t.setFramebuffer([s]),t.setProgram(ql._programDownsampleV),t.setBindGroup(0,this._bindgroupDownsampleV),this._bindgroupDownsampleV.setTexture("tex",h),this._bindgroupDownsampleV.setValue("invTexSize",this._invTexSize),this.drawFullscreenQuad(),a--,r=Math.max(1,r>>1),n=Math.max(1,n>>1),o=s,t.pool.releaseTexture(h)}}_prepare(t,e){if(ql._programFinalCompose||(ql._programFinalCompose=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))},fragment(t){this.srcTex=t.tex2D().uniform(0),this.bloomTex=t.tex2D().uniform(0),this.intensity=t.float().uniform(0),this.$outputs.outColor=t.vec4(),t.main((function(){this.$l.srcSample=t.textureSampleLevel(this.srcTex,this.$inputs.uv,0),this.$l.bloomSample=t.textureSampleLevel(this.bloomTex,this.$inputs.uv,0),this.$outputs.outColor=t.vec4(t.add(this.srcSample.rgb,t.mul(this.bloomSample.rgb,this.intensity)),1)}))}})),this._bindgroupFinalCompose||(this._bindgroupFinalCompose=t.createBindGroup(ql._programFinalCompose.bindGroupLayouts[0])),ql._programPrefilter||(ql._programPrefilter=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))},fragment(t){this.tex=t.tex2D().uniform(0),this.threshold=t.vec4().uniform(0),this.$outputs.outColor=t.vec4(),t.main((function(){this.$l.p=t.textureSampleLevel(this.tex,this.$inputs.uv,0),this.$l.brightness=t.max(t.max(this.p.r,this.p.g),this.p.b),this.$l.soft=t.clamp(t.add(this.brightness,this.threshold.y),0,this.threshold.z),this.soft=t.mul(this.soft,this.soft,this.threshold.w),this.$l.contrib=t.div(t.max(this.soft,t.sub(this.brightness,this.threshold.x)),t.max(this.brightness,1e-5)),this.$outputs.outColor=t.vec4(t.mul(this.p.rgb,this.contrib),1)}))}})),this._bindgroupPrefilter||(this._bindgroupPrefilter=t.createBindGroup(ql._programPrefilter.bindGroupLayouts[0])),ql._programUpsample||(ql._programUpsample=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))},fragment(t){this.tex=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.main((function(){this.$outputs.outColor=t.textureSampleLevel(this.tex,this.$inputs.uv,0)}))}})),this._bindgroupUpsample||(this._bindgroupUpsample=t.createBindGroup(ql._programUpsample.bindGroupLayouts[0])),!ql._programDownsampleH){const e=[-4,-3,-2,-1,0,1,2,3,4],i=[.01621622,.05405405,.12162162,.19459459,.22702703,.19459459,.12162162,.05405405,.01621622];ql._programDownsampleH=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))},fragment(t){this.invTexSize=t.vec2().uniform(0),this.tex=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.main((function(){this.$l.sum=t.vec3(0),this.$l.offset=t.float();for(let s=0;s<9;s++)this.offset=t.mul(this.invTexSize.x,2*e[s]),this.sum=t.add(this.sum,t.mul(t.textureSampleLevel(this.tex,t.add(this.$inputs.uv,t.vec2(this.offset,0)),0).rgb,i[s]));this.$outputs.outColor=t.vec4(this.sum,1)}))}})}if(this._bindgroupDownsampleH||(this._bindgroupDownsampleH=t.createBindGroup(ql._programDownsampleH.bindGroupLayouts[0])),!ql._programDownsampleV){const e=[-3.23076923,-1.38461538,0,1.38461538,3.23076923],i=[.07027027,.31621622,.22702703,.31621622,.07027027];ql._programDownsampleV=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))},fragment(t){this.invTexSize=t.vec2().uniform(0),this.tex=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.main((function(){this.$l.sum=t.vec3(0),this.$l.offset=t.float();for(let s=0;s<5;s++)this.offset=t.mul(this.invTexSize.y,e[s]),this.sum=t.add(this.sum,t.mul(t.textureSampleLevel(this.tex,t.add(this.$inputs.uv,t.vec2(0,this.offset)),0).rgb,i[s]));this.$outputs.outColor=t.vec4(this.sum,1)}))}})}this._bindgroupDownsampleV||(this._bindgroupDownsampleV=t.createBindGroup(ql._programDownsampleV.bindGroupLayouts[0])),ql._nearestSampler||(ql._nearestSampler=t.createSampler({magFilter:"nearest",minFilter:"nearest",mipFilter:"none",addressU:"clamp",addressV:"clamp"})),ql._renderStateAdditive||(ql._renderStateAdditive=t.createRenderStateSet(),ql._renderStateAdditive.useRasterizerState().setCullMode("none"),ql._renderStateAdditive.useDepthState().enableTest(!1).enableWrite(!1),ql._renderStateAdditive.useBlendingState().enable(!0).setBlendFuncRGB("one","one").setBlendFuncAlpha("one","zero"))}dispose(){super.dispose(),this._bindgroupDownsampleH?.dispose(),this._bindgroupDownsampleH=null}}class Yl extends Hl{static _program=null;static _sampler=null;_bindgroup;_invTexSize;constructor(){super(),this._opaque=!1,this._bindgroup=null,this._invTexSize=new x}dispose(){super.dispose(),this._bindgroup?.dispose(),this._bindgroup=null}requireLinearDepthTexture(){return!1}requireDepthAttachment(){return!1}apply(t,e,i,s){const r=t.device;this._prepare(r),this._invTexSize.setXY(1/e.width,1/e.height),this._bindgroup.setTexture("srcTex",e,Yl._sampler),this._bindgroup.setValue("flip",this.needFlip(r)?1:0),this._bindgroup.setValue("srgbOut",s?1:0),this._bindgroup.setValue("invTexSize",this._invTexSize),r.setProgram(Yl._program),r.setBindGroup(0,this._bindgroup),this.drawFullscreenQuad()}_prepare(t){Yl._program||(Yl._program=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))},fragment(t){this.srcTex=t.tex2D().uniform(0),this.srgbOut=t.int().uniform(0),this.invTexSize=t.vec2().uniform(0),this.$outputs.outColor=t.vec4(),t.func("getLuma",[t.vec3("vSample")],(function(){this.$return(t.dot(this.vSample,t.vec3(.299,.587,.114)))})),t.func("FXAA",[t.vec2("uv")],(function(){this.$l.posM=this.uv,this.$l.rgbyM=t.textureSampleLevel(this.srcTex,this.uv,0),this.$l.lumaM=this.getLuma(this.rgbyM.rgb),this.$l.lumaN=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(0,-1),this.invTexSize)),0).rgb),this.$l.lumaW=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(-1,0),this.invTexSize)),0).rgb),this.$l.lumaE=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(1,0),this.invTexSize)),0).rgb),this.$l.lumaS=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(0,1),this.invTexSize)),0).rgb),this.$l.rangeMin=t.min(this.lumaM,t.min(t.min(this.lumaN,this.lumaW),t.min(this.lumaS,this.lumaE))),this.$l.rangeMax=t.max(this.lumaM,t.max(t.max(this.lumaN,this.lumaW),t.max(this.lumaS,this.lumaE))),this.$l.range=t.sub(this.rangeMax,this.rangeMin),this.$if(t.lessThan(this.range,t.max(1/16,t.div(this.rangeMax,8))),(function(){this.$return(this.rgbyM)})),this.$l.lumaNW=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(-1,-1),this.invTexSize)),0).rgb),this.$l.lumaNE=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(1,-1),this.invTexSize)),0).rgb),this.$l.lumaSW=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(-1,1),this.invTexSize)),0).rgb),this.$l.lumaSE=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(1,1),this.invTexSize)),0).rgb),this.$l.lumaNS=t.add(this.lumaN,this.lumaS),this.$l.lumaWE=t.add(this.lumaW,this.lumaE),this.$l.subpixRcpRange=t.div(1,this.range),this.$l.subpixNSWE=t.add(this.lumaNS,this.lumaWE),this.$l.edgeHorz1=t.add(t.mul(-2,this.lumaM),this.lumaNS),this.$l.edgeVert1=t.add(t.mul(-2,this.lumaM),this.lumaWE),this.$l.lumaNESE=t.add(this.lumaNE,this.lumaSE),this.$l.lumaNWNE=t.add(this.lumaNW,this.lumaNE),this.$l.edgeHorz2=t.add(t.mul(-2,this.lumaE),this.lumaNESE),this.$l.edgeVert2=t.add(t.mul(-2,this.lumaN),this.lumaNWNE),this.$l.lumaNWSW=t.add(this.lumaNW,this.lumaSW),this.$l.lumaSWSE=t.add(this.lumaSW,this.lumaSE),this.$l.edgeHorz4=t.add(t.mul(t.abs(this.edgeHorz1),2),t.abs(this.edgeHorz2)),this.$l.edgeVert4=t.add(t.mul(t.abs(this.edgeVert1),2),t.abs(this.edgeVert2)),this.$l.edgeHorz3=t.add(t.mul(-2,this.lumaW),this.lumaNWSW),this.$l.edgeVert3=t.add(t.mul(-2,this.lumaS),this.lumaSWSE),this.$l.edgeHorz=t.add(t.abs(this.edgeHorz3),this.edgeHorz4),this.$l.edgeVert=t.add(t.abs(this.edgeVert3),this.edgeVert4),this.$l.subpixNWSWNESE=t.add(this.lumaNWSW,this.lumaNESE),this.$l.lengthSign=this.invTexSize.x,this.$l.horzSpan=t.greaterThanEqual(this.edgeHorz,this.edgeVert),this.$l.subpixA=t.add(t.mul(this.subpixNSWE,2),this.subpixNWSWNESE),this.$if(t.not(this.horzSpan),(function(){this.lumaN=this.lumaW,this.lumaS=this.lumaE})).$else((function(){this.lengthSign=this.invTexSize.y})),this.$l.subpixB=t.sub(t.div(this.subpixA,12),this.lumaM),this.$l.gradientN=t.sub(this.lumaN,this.lumaM),this.$l.gradientS=t.sub(this.lumaS,this.lumaM),this.$l.lumaNN=t.add(this.lumaN,this.lumaM),this.$l.lumaSS=t.add(this.lumaS,this.lumaM),this.$l.pairN=t.greaterThanEqual(t.abs(this.gradientN),t.abs(this.gradientS)),this.$l.gradient=t.max(t.abs(this.gradientN),t.abs(this.gradientS)),this.$if(this.pairN,(function(){this.lengthSign=t.neg(this.lengthSign)})),this.$l.subpixC=t.clamp(t.mul(t.abs(this.subpixB),this.subpixRcpRange),0,1),this.$l.posB=this.posM,this.$l.offNP=t.vec2(),this.$if(t.not(this.horzSpan),(function(){this.offNP.x=0,this.offNP.y=this.invTexSize.y,this.posB.x=t.add(this.posB.x,t.mul(this.lengthSign,.5))})).$else((function(){this.offNP.x=this.invTexSize.x,this.offNP.y=0,this.posB.y=t.add(this.posB.y,t.mul(this.lengthSign,.5))})),this.$l.posN=t.sub(this.posB,this.offNP),this.$l.posP=t.add(this.posB,this.offNP),this.$l.subpixD=t.add(t.mul(-2,this.subpixC),3),this.$l.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN,0).rgb),this.$l.subpixE=t.mul(this.subpixC,this.subpixC),this.$l.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP,0).rgb),this.$if(t.not(this.pairN),(function(){this.lumaNN=this.lumaSS})),this.$l.gradientScaled=t.div(this.gradient,4),this.$l.lumaMM=t.sub(this.lumaM,t.mul(this.lumaNN,.5)),this.$l.subpixF=t.mul(this.subpixD,this.subpixE),this.$l.lumaMLTZero=t.lessThan(this.lumaMM,0),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5)),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5)),this.$l.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.$l.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),(function(){this.posN=t.sub(this.posN,t.mul(this.offNP,1.5))})),this.$l.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),(function(){this.posP=t.add(this.posP,t.mul(this.offNP,1.5))})),this.$if(this.doneNP,(function(){this.$if(t.not(this.doneN),(function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))})),this.$if(t.not(this.doneP),(function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))})),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),(function(){this.posN=t.sub(this.posN,t.mul(this.offNP,2))})),this.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),(function(){this.posP=t.add(this.posP,t.mul(this.offNP,2))})),this.$if(this.doneNP,(function(){this.$if(t.not(this.doneN),(function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))})),this.$if(t.not(this.doneP),(function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))})),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),(function(){this.posN=t.sub(this.posN,t.mul(this.offNP,2))})),this.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),(function(){this.posP=t.add(this.posP,t.mul(this.offNP,2))})),this.$if(this.doneNP,(function(){this.$if(t.not(this.doneN),(function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))})),this.$if(t.not(this.doneP),(function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))})),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),(function(){this.posN=t.sub(this.posN,t.mul(this.offNP,4))})),this.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),(function(){this.posP=t.add(this.posP,t.mul(this.offNP,4))})),this.$if(this.doneNP,(function(){this.$if(t.not(this.doneN),(function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))})),this.$if(t.not(this.doneP),(function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))})),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),(function(){this.posN=t.sub(this.posN,t.mul(this.offNP,2))})),this.$if(t.not(this.doneP),(function(){this.posP=t.add(this.posP,t.mul(this.offNP,2))}))}))}))}))})),this.$l.dstN=t.sub(this.posM.x,this.posN.x),this.$l.dstP=t.sub(this.posP.x,this.posM.x),this.$if(t.not(this.horzSpan),(function(){this.dstN=t.sub(this.posM.y,this.posN.y),this.dstP=t.sub(this.posP.y,this.posM.y)})),this.$l.goodSpanN=t.notEqual(t.lessThan(this.lumaEndN,0),this.lumaMLTZero),this.$l.spanLength=t.add(this.dstP,this.dstN),this.$l.goodSpanP=t.notEqual(t.lessThan(this.lumaEndP,0),this.lumaMLTZero),this.$l.spanLengthRcp=t.div(1,this.spanLength),this.$l.directionN=t.lessThan(this.dstN,this.dstP),this.$l.dst=t.min(this.dstN,this.dstP),this.$l.goodSpan=this.$choice(this.directionN,this.goodSpanN,this.goodSpanP),this.$l.subpixG=t.mul(this.subpixF,this.subpixF),this.$l.pixelOffset=t.add(t.mul(this.dst,t.neg(this.spanLengthRcp)),.5),this.$l.subpixH=t.mul(this.subpixG,.75),this.$l.pixelOffsetGood=this.$choice(this.goodSpan,this.pixelOffset,0),this.$l.pixelOffsetSubpix=t.max(this.pixelOffsetGood,this.subpixH),this.$if(t.not(this.horzSpan),(function(){this.posM.x=t.add(this.posM.x,t.mul(this.pixelOffsetSubpix,this.lengthSign))})).$else((function(){this.posM.y=t.add(this.posM.y,t.mul(this.pixelOffsetSubpix,this.lengthSign))})),this.$return(t.textureSampleLevel(this.srcTex,this.posM,0).xyzw)})),t.main((function(){this.$l.color=this.FXAA(this.$inputs.uv),this.$if(t.equal(this.srgbOut,0),(function(){this.$outputs.outColor=this.color})).$else((function(){this.$outputs.outColor=t.vec4(ca(this,this.color.rgb),this.color.a)}))}))}})),Yl._sampler||(Yl._sampler=t.createSampler({magFilter:"linear",minFilter:"linear",mipFilter:"none",addressU:"clamp",addressV:"clamp"})),this._bindgroup||(this._bindgroup=t.createBindGroup(Yl._program.bindGroupLayouts[0]))}}class Zl{_postEffectsOpaque;_postEffectsTransparency;static _blitSampler=null;static _blitProgram=null;static _blitBindgroup=null;static _blitRenderStates=null;static _blitVertexLayout=null;constructor(){this._postEffectsOpaque=[],this._postEffectsTransparency=[]}requireLinearDepth(){for(const t of this._postEffectsOpaque)if(t.requireLinearDepthTexture())return!0;for(const t of this._postEffectsTransparency)if(t.requireLinearDepthTexture())return!0;return!1}appendPostEffect(t){if(t){if(this._postEffectsOpaque.indexOf(t)>=0||this._postEffectsTransparency.indexOf(t)>=0)return void console.error("Posteffect cannot be added to same compositor multiple times");(t.opaque?this._postEffectsOpaque:this._postEffectsTransparency).push(t)}}removePostEffect(t){for(const e of[this._postEffectsOpaque,this._postEffectsTransparency]){const i=e.indexOf(t);if(i>=0)return void e.splice(i,1)}}clear(){this._postEffectsOpaque=[],this._postEffectsTransparency=[]}getPostEffects(){return[...this._postEffectsOpaque,...this._postEffectsTransparency]}begin(t){const e=t.device,i=e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"rgba16f":"rgba8unorm",s=e.getFramebuffer(),r=s?.getDepthAttachment();let n=null;const a=r?r.width:t.viewportWidth,o=r?r.height:t.viewportHeight;t.primaryCamera.sampleCount>1&&(n=e.pool.fetchTemporalFramebuffer(!0,a,o,i,r,!1,t.primaryCamera.sampleCount));const h=[e.pool.fetchTemporalFramebuffer(!0,a,o,i,r??t.depthFormat,!1),e.pool.fetchTemporalFramebuffer(!0,a,o,i,r??t.depthFormat,!1)];let l;n?(l=3,e.setFramebuffer(n)):(l=0,e.setFramebuffer(h[l])),e.setViewport(null),e.setScissor(null),t.compositorContex={finalFramebuffer:s,pingpongFramebuffers:h,msTexture:n,writeIndex:l}}drawPostEffects(t,e,i){const s=e?this._postEffectsOpaque:this._postEffectsTransparency;if(s.length>0){const r=t.device;for(let n=0;n<s.length;n++){const a=s[n];if(!a.enabled)continue;const o=r.getFramebuffer().getColorAttachments()[0];this.isLastPostEffect(e,n)&&(!a.requireDepthAttachment()||!!t.compositorContex.finalFramebuffer)?(r.setFramebuffer(t.compositorContex.finalFramebuffer),r.setViewport(null),r.setScissor(null)):(t.compositorContex.writeIndex=(1+t.compositorContex.writeIndex)%2,r.setFramebuffer(t.compositorContex.pingpongFramebuffers[t.compositorContex.writeIndex]),r.setViewport(null),r.setScissor(null)),a.apply(t,o,i,!r.getFramebuffer())}}}end(t){const e=t.device;if(e.getFramebuffer()!==t.compositorContex.finalFramebuffer){const i=e.getFramebuffer().getColorAttachments()[0];e.setFramebuffer(t.compositorContex.finalFramebuffer),e.setViewport(null),e.setScissor(null),Zl._blit(e,i,!t.compositorContex.finalFramebuffer)}t.compositorContex=null}isLastPostEffect(t,e){const i=t?this._postEffectsOpaque:this._postEffectsTransparency;for(let t=e;t<i.length;t++)if(i[t].enabled)return!1;if(t)for(let t=0;t<this._postEffectsTransparency.length;t++)if(this._postEffectsTransparency[t].enabled)return!1;return!0}needDrawPostEffects(){for(let t=0;t<this._postEffectsOpaque.length;t++)if(this._postEffectsOpaque[t].enabled)return!0;for(let t=0;t<this._postEffectsTransparency.length;t++)if(this._postEffectsTransparency[t].enabled)return!0;return!1}static _blit(t,e,i){this._blitProgram||(this._blitProgram=t.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),this.flip=t.int().uniform(0),t.main((function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),(function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}))}))},fragment(t){this.srcTex=t.tex2D().sampleType("unfilterable-float").uniform(0),this.srgbOutput=t.int().uniform(0),this.$outputs.outColor=t.vec4(),t.main((function(){this.$outputs.outColor=t.textureSample(this.srcTex,this.$inputs.uv),this.$if(t.notEqual(this.srgbOutput,0),(function(){this.$outputs.outColor=t.vec4(ca(this,this.$outputs.outColor.rgb),1)}))}))}}),this._blitBindgroup=t.createBindGroup(this._blitProgram.bindGroupLayouts[0]),this._blitVertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]}),this._blitSampler=t.createSampler({minFilter:"nearest",magFilter:"nearest",mipFilter:"none",addressU:"clamp",addressV:"clamp"}),this._blitRenderStates=t.createRenderStateSet(),this._blitRenderStates.useRasterizerState().setCullMode("none"),this._blitRenderStates.useDepthState().enableTest(!1).enableWrite(!1)),this._blitBindgroup.setTexture("srcTex",e,this._blitSampler),this._blitBindgroup.setValue("srgbOutput",i?1:0),this._blitBindgroup.setValue("flip","webgpu"===t.type&&t.getFramebuffer()?1:0),t.setRenderStates(this._blitRenderStates),t.setProgram(this._blitProgram),t.setBindGroup(0,this._blitBindgroup),t.setVertexLayout(this._blitVertexLayout),t.draw("triangle-strip",0,4)}}let Kl=0;class Ql extends(s(Object)()){_device;_object;_uid;_cid;_name;_queueState;_restoreHandler;constructor(t){super(),this._device=t,this._object=null,this._uid=++Kl,this._cid=1,this._name=`${Gs(this)}#${this._uid}`,this._queueState=0,this._restoreHandler=null,this._device.addGPUObject(this)}get device(){return this._device}get object(){return this._object}get uid(){return this._uid}get cid(){return this._cid}get disposed(){return!this._object}get restoreHandler(){return this._restoreHandler}set restoreHandler(t){this._restoreHandler=t}get name(){return this._name}set name(t){if(t!==this._name){const e=new Ft(this,this._name);this._name=t,this._device.dispatchEvent(e)}}get queueState(){return this._queueState}set queueState(t){this._queueState=t}isVertexLayout(){return!1}isFramebuffer(){return!1}isSampler(){return!1}isTexture(){return!1}isTexture2D(){return!1}isTexture2DArray(){return!1}isTexture3D(){return!1}isTextureCube(){return!1}isTextureVideo(){return!1}isProgram(){return!1}isBuffer(){return!1}isBindGroup(){return!1}dispose(){this.disposed||this._device.disposeObject(this,!0)}async reload(){if(this.disposed){const t=this._device.restoreObject(this);return this._cid++,t}}destroy(){throw new Error("Abstract function call: dispose()")}async restore(){throw new Error("Abstract function call: restore()")}}class Jl extends Ql{static _hashCounter=0;_type;_vs;_fs;_cs;_label;_hash;_error;_bindGroupLayouts;_vertexAttributes;_csModule;_vsModule;_fsModule;_pipelineLayout;constructor(t,e){if(super(t),this._type=e.type,this._label=e.label,this._bindGroupLayouts=[...e.params.bindGroupLayouts],this._error="","render"===e.type){const t=e.params;this._vs=t.vs,this._fs=t.fs,this._vertexAttributes=t.vertexAttributes?t.vertexAttributes.join(":"):""}else{const t=e.params;this._cs=t.source}this._load(),this._hash=String(++Jl._hashCounter)}get type(){return this._type}get label(){return this._label}getCompileError(){return this._error}getShaderSource(t){switch(t){case"vertex":return this._vs;case"fragment":return this._fs;case"compute":return this._cs}}getBindingInfo(t){for(let e=0;e<this._bindGroupLayouts.length;e++){const i=this._bindGroupLayouts[e],s=i.nameMap?.[t]??t;for(let t=0;t<i.entries.length;t++){const r=i.entries[t];if(r.name===s)return{group:e,binding:t,type:r.type}}}return null}get bindGroupLayouts(){return this._bindGroupLayouts}get vertexAttributes(){return this._vertexAttributes}get hash(){return this._hash}getPipelineLayout(){return this._pipelineLayout}getShaderModule(){return{vsModule:this._vsModule,fsModule:this._fsModule,csModule:this._csModule,pipelineLayout:this._pipelineLayout}}get fsModule(){return this._fsModule}destroy(){this._vsModule=null,this._fsModule=null,this._pipelineLayout=null,this._object=null}async restore(){this._object||this._load()}isProgram(){return!0}createUniformBuffer(t){const e=this.getBindingInfo(t)?.type;return e?this.device.createStructuredBuffer(e,{usage:"uniform"}):null}_load(){"render"===this._type?(this._vsModule=this.createShaderModule(this._vs),this._fsModule=this.createShaderModule(this._fs)):this._csModule=this.createShaderModule(this._cs),this._pipelineLayout=this.createPipelineLayout(this._bindGroupLayouts),this._object={}}createPipelineLayout(t){const e=[];return t.forEach((t=>{e.push(this._device.fetchBindGroupLayout(t)[1])})),this._device.device.createPipelineLayout({bindGroupLayouts:e})}createShaderModule(t){let e=this._device.device.createShaderModule({code:t});if(e){const i=e.compilationInfo||e.getCompilationInfo;if(!i)return e;i.call(e).then((i=>{let s=!1;if(i?.messages?.length>0){let e="";for(const r of i.messages)"error"===r.type&&(s=!0),e+=`Line ${r.lineNum}:${r.linePos} - ${t.slice(r.offset,r.offset+r.length)}\n`,e+=`${r.message}\n`,"error"===r.type?(s=!0,console.error(e)):"warning"===r.type?console.warn(e):console.log(e),this._error+=e}s&&(e=null)}))}return e}use(){this._device.setProgram(this)}}class tu{_device;_bufferList;_defaultSize;_unmappedBufferList;constructor(t,e=65536){this._device=t,this._bufferList=[],this._defaultSize=e,this._unmappedBufferList=[]}uploadBuffer(t,e,i,s,r,n){const a=r+3&-4,o=this.fetchBufferMapped(a,!!n);if(t){const e=o.mappedRange;new Uint8Array(e,o.offset,a).set(new Uint8Array(t,i,r))}const h={mappedBuffer:{...o},uploadSize:a,uploadBuffer:e,uploadOffset:s};return o.offset+=a,o.offset=o.offset+7&-8,h}beginUploads(){for(let t=this._bufferList.length-1;t>=0;t--){const e=this._bufferList[t];e.used&&(e.buffer.unmap(),this._unmappedBufferList.push(e),this._bufferList.splice(t,1),e.mappedRange=null)}return this._unmappedBufferList.length}endUploads(){for(const t of this._unmappedBufferList)t.buffer.mapAsync(GPUMapMode.WRITE).then((()=>{t.offset=0,t.used=!1,t.mappedRange=t.buffer.getMappedRange(),this._bufferList.push(t)}));this._unmappedBufferList=[]}purge(){for(let t=this._bufferList.length-1;t>=0;t--){const e=this._bufferList[t];e.mappedRange&&(e.buffer.unmap(),e.buffer.destroy())}this._bufferList=[];for(const t of this._unmappedBufferList)t.buffer.destroy();this._unmappedBufferList=[]}fetchBufferMapped(t,e){for(const i of this._bufferList)if(e||i.size-i.offset>=t)return i.used=!0,i;const i=Math.max(t,this._defaultSize)+3&-4,s=this._device.device.createBuffer({label:`StagingRingBuffer${this._bufferList.length}:${i}`,size:i,usage:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,mappedAtCreation:!0});return this._bufferList.push({buffer:s,size:i,offset:0,used:!0,mappedRange:s.getMappedRange()}),this._bufferList[this._bufferList.length-1]}}class eu extends Ql{_size;_usage;_gpuUsage;_memCost;_ringBuffer;_pendingUploads;constructor(t,e,i){if(super(t),this._object=null,this._memCost=0,this._usage=e,this._gpuUsage=0,this._size="number"==typeof i?i:i.byteLength,this._size<=0)throw new Error("can not create buffer with zero size");this._ringBuffer=new tu(t,this._size+15&-16),this._pendingUploads=[],this.load("number"==typeof i?null:i)}get hash(){return this._object?this._device.gpuGetObjectHash(this._object):0}get byteLength(){return this._size}get usage(){return this._usage}get gpuUsage(){return this._gpuUsage}searchInsertPosition(t){let e=0,i=this._pendingUploads.length-1,s=this._pendingUploads.length;for(;e<=i;){const r=Math.floor((e+i)/2);this._pendingUploads[r].uploadOffset<t?e=r+1:(s=r,i=r-1)}return s}bufferSubData(t,e,i,s){if(i=Number(i)||0,t=Number(t)||0,i+(s=Number(s)||e.length-i)>e.length)throw new Error("bufferSubData() failed: source buffer is too small");if(t+s*e.BYTES_PER_ELEMENT>this.byteLength)throw new Error("bufferSubData() failed: dest buffer is too small");const r=s*e.BYTES_PER_ELEMENT;if(0!=(3&t)||0!=(3&r))throw new Error("bufferSubData() failed: destination byte offset or upload size must be 4 bytes aligned");const n=e.byteOffset+i*e.BYTES_PER_ELEMENT,a=this.searchInsertPosition(t);if(a<this._pendingUploads.length){const e=this._pendingUploads[a];e.uploadOffset<t+r&&e.uploadOffset+e.uploadSize>t&&this._device.bufferUpload(this)}let o=!1;if(0===this._pendingUploads.length)this.pushUpload(t,r,0),o=!0;else{let e=t,i=t+r;for(;a<this._pendingUploads.length;){const t=this._pendingUploads[a],s=t.uploadOffset,r=s+t.uploadSize;if(!(s<i&&r>e))break;e=Math.min(e,s),i=Math.max(i,r),this._pendingUploads.splice(a,1)}this.pushUpload(e,i-e,a)}new Uint8Array(this._pendingUploads[0].mappedBuffer.mappedRange,t,r).set(new Uint8Array(e.buffer,n,r)),o&&this._device.bufferUpload(this)}async getBufferSubData(t,e,i){if(!(this._usage&Ls.BF_READ))throw new Error("getBufferSubData() failed: buffer does not have BF_READ flag set");if(this.sync(),e=Number(e)||0,i=Number(i)||this.byteLength-e,e<0||e+i>this.byteLength)throw new Error("data query range out of bounds");if(t&&t.byteLength<i)throw new Error("no enough space for querying buffer data");t=t||new Uint8Array(i),await this._object.mapAsync(GPUMapMode.READ);const s=this._object.getMappedRange();return t.set(new Uint8Array(s,e,i)),this._object.unmap(),t}async restore(){this._device.isContextLost()||this.load()}destroy(){this._object&&(this._object.destroy(),this._object=null,this._gpuUsage=0,this._memCost=0)}isBuffer(){return!0}beginSyncChanges(t){if(this._pendingUploads.length>0){const e=t||this._device.device.createCommandEncoder();for(const t of this._pendingUploads)e.copyBufferToBuffer(t.mappedBuffer.buffer,t.mappedBuffer.offset,this._object,t.uploadOffset,t.uploadSize);t||this._device.device.queue.submit([e.finish()]),this._pendingUploads.length=0,this._ringBuffer.beginUploads()}}endSyncChanges(){this._usage&Ls.DYNAMIC?this._ringBuffer.endUploads():this._ringBuffer.purge()}load(t){if(!this._device.isContextLost()&&(this._memCost=0,!this._device.isContextLost()&&!this._object)){this._gpuUsage=0;let e="";if(this._usage&Ls.BF_VERTEX&&(this._gpuUsage|=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,e+="[vertex]"),this._usage&Ls.BF_INDEX&&(this._gpuUsage|=GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,e+="[index]"),this._usage&Ls.BF_UNIFORM&&(this._gpuUsage|=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC,e+="[uniform]"),this._usage&Ls.BF_STORAGE&&(this._gpuUsage|=GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC,e+="[storage]"),this._usage&Ls.BF_READ&&(this._gpuUsage|=GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ,e+="[mapRead]"),this._usage&Ls.BF_WRITE&&(this._gpuUsage|=GPUBufferUsage.COPY_SRC|GPUBufferUsage.MAP_WRITE,e+="[mapWrite]"),t){this._object=this._device.gpuCreateBuffer({label:e,size:t.byteLength+15&-16,usage:this._gpuUsage,mappedAtCreation:!0});const i=this._object.getMappedRange();new t.constructor(i).set(t),this._object.unmap()}else this._object=this._device.gpuCreateBuffer({label:e,size:this.byteLength+15&-16,usage:this._gpuUsage});const i=this.byteLength;this._device.updateVideoMemoryCost(i-this._memCost),this._memCost=i}}sync(){this._pendingUploads&&this._device.flushUploads()}pushUpload(t,e,i){const s=this._ringBuffer.fetchBufferMapped(e,!0);this._pendingUploads.splice(i,0,{mappedBuffer:{buffer:s.buffer,size:s.size,offset:t,used:s.used,mappedRange:s.mappedRange},uploadSize:e,uploadOffset:t,uploadBuffer:this._object})}}const iu=te.getCachedTypeInfo(Bt.U8VEC2_NORM),su=te.getCachedTypeInfo(Bt.U8VEC4_NORM),ru=te.getCachedTypeInfo(Bt.I8VEC2_NORM),nu=te.getCachedTypeInfo(Bt.I8VEC4_NORM),au=te.getCachedTypeInfo(Bt.U16VEC2),ou=te.getCachedTypeInfo(Bt.U16VEC4),hu=te.getCachedTypeInfo(Bt.I16VEC2),lu=te.getCachedTypeInfo(Bt.I16VEC4),uu=te.getCachedTypeInfo(Bt.U16VEC2_NORM),cu=te.getCachedTypeInfo(Bt.U16VEC4_NORM),du=te.getCachedTypeInfo(Bt.I16VEC2_NORM),pu=te.getCachedTypeInfo(Bt.I16VEC4_NORM),mu=te.getCachedTypeInfo(Bt.F16VEC2),fu=te.getCachedTypeInfo(Bt.F16VEC4),_u=te.getCachedTypeInfo(Bt.F32),gu=te.getCachedTypeInfo(Bt.F32VEC2),xu=te.getCachedTypeInfo(Bt.F32VEC3),bu=te.getCachedTypeInfo(Bt.F32VEC4),wu=te.getCachedTypeInfo(Bt.U32),Tu=te.getCachedTypeInfo(Bt.U32VEC2),vu=te.getCachedTypeInfo(Bt.U32VEC3),yu=te.getCachedTypeInfo(Bt.U32VEC4),Eu=te.getCachedTypeInfo(Bt.I32),Su=te.getCachedTypeInfo(Bt.I32VEC2),Cu=te.getCachedTypeInfo(Bt.I32VEC3),Au=te.getCachedTypeInfo(Bt.I32VEC4),Mu={[iu.typeId]:"unorm8x2",[su.typeId]:"unorm8x4",[ru.typeId]:"snorm8x2",[nu.typeId]:"snorm8x4",[au.typeId]:"uint16x2",[ou.typeId]:"uint16x4",[hu.typeId]:"sint16x2",[lu.typeId]:"sint16x4",[uu.typeId]:"unorm16x2",[cu.typeId]:"unorm16x4",[du.typeId]:"snorm16x2",[pu.typeId]:"snorm16x4",[mu.typeId]:"float16x2",[fu.typeId]:"float16x4",[_u.typeId]:"float32",[gu.typeId]:"float32x2",[xu.typeId]:"float32x3",[bu.typeId]:"float32x4",[wu.typeId]:"uint32",[Tu.typeId]:"uint32x2",[vu.typeId]:"uint32x3",[yu.typeId]:"uint32x4",[Eu.typeId]:"sint32",[Su.typeId]:"sint32x2",[Cu.typeId]:"sint32x3",[Au.typeId]:"sint32x4"};class Ru extends eu{_structure;_data;constructor(t,e,i,s){if(!e?.isStructType())throw new Error("invalid structure type");if(i&Ls.BF_INDEX)throw new Error("structured buffer must not have Index usage flag");if(i&Ls.BF_READ||i&Ls.BF_WRITE)throw new Error("structured buffer must not have Read or Write usage flags");if(i&Ls.BF_VERTEX&&(1!==e.structMembers.length||!e.structMembers[0].type.isArrayType()))throw new Error("structured buffer for vertex usage must have only one array member");(i&Ls.BF_UNIFORM||i&Ls.BF_STORAGE)&&(i|=Ls.DYNAMIC);const r=e.toBufferLayout(0,e.layout);if(s&&r.byteSize!==s.byteLength)throw new Error(`create structured buffer failed: invalid source size: ${s.byteLength}, should be ${r.byteSize}`);super(t,i,s||r.byteSize),this._data=new oa(r,this),this._structure=e}set(t,e){this._data.set(t,e)}get structure(){return this._structure}set structure(t){if(t&&!t.isCompatibleType(this._structure)){const e=t.toBufferLayout(0,t.layout);if(e.byteSize>this.byteLength)throw new Error(`set structure type failed: new structure type is too large: ${e.byteSize}`);this._data=new oa(e,this),this._structure=t}}static getGPUVertexFormat(t){return Mu[t.typeId]}}class Fu extends Ql{_layout;_layoutDesc;_entries;_bindGroup;_buffers;_textures;_gpuId;_videoTextures;_dynamicOffsets;_resources;constructor(t,e){super(t),this._device=t,this._layout=e,this._layoutDesc=null,this._entries=null,this._bindGroup=null,this._dynamicOffsets=null,this._gpuId=0,this._resources={},this._buffers=[],this._textures=[],this._videoTextures=null;for(const t of this._layout.entries)t.buffer&&t.buffer.hasDynamicOffset&&(this._dynamicOffsets||(this._dynamicOffsets=[]),this._dynamicOffsets[t.buffer.dynamicOffsetIndex]=0)}get bindGroup(){return this._bindGroup||(this._bindGroup=this._create()),this._bindGroup}get layoutDescriptor(){return this._bindGroup||(this._bindGroup=this._create()),this._layoutDesc}get entries(){return this._bindGroup||(this._bindGroup=this._create()),this._entries}getGPUId(){return`${this._uid}:${this._gpuId}`}get bufferList(){return this._buffers}get textureList(){return this._textures}invalidate(){this._bindGroup=null,this._gpuId++}getLayout(){return this._layout}getDynamicOffsets(){return this._dynamicOffsets}getBuffer(t){return this._getBuffer(t,Ls.BF_UNIFORM|Ls.BF_STORAGE,!0)}setBuffer(t,e,i,s,r){const n=this._layout.nameMap?.[t]??t;for(const a of this._layout.entries)if(a.name===n){if(a.buffer){s=s??0,r=r??(e?Math.max(0,e.byteLength-s):0);const n=this._resources[a.name],o="uniform"===a.buffer.type?Ls.BF_UNIFORM:Ls.BF_STORAGE;e&&e.usage&o?e===n?.[0]&&s===n?.[1]&&r===n?.[2]||(this._resources[a.name]=[e,s,r],this.invalidate()):console.log(`setBuffer() failed: buffer resource '${t}' must be type '${a.buffer.type}'`),a.buffer.hasDynamicOffset&&(this._dynamicOffsets[a.buffer.dynamicOffsetIndex]=i??0)}else console.log(`setBuffer() failed: resource '${t}' is not buffer`);return}console.log(`setBuffer() failed: no buffer resource named '${t}'`)}setValue(t,e){const i=this._layout.nameMap?.[t];if(i)this.setValue(i,{[t]:e});else{const i=this._getBuffer(t,Ls.BF_UNIFORM|Ls.BF_STORAGE,!1);if(i){if(!(i instanceof Ru))throw new Error(`BindGroup.setValue() failed: '${t}' is not structured buffer`);if(e?.BYTES_PER_ELEMENT)i.bufferSubData(0,e);else for(const t in e)i.set(t,e[t])}else console.log(`setValue() failed: no uniform buffer named '${t}'`)}}setRawData(t,e,i,s,r){const n=this._layout.nameMap?.[t];if(n)this.setRawData(n,e,i,s,r);else{const n=this._getBuffer(t,Ls.BF_UNIFORM|Ls.BF_STORAGE,!1);n?n.bufferSubData(e,i,s,r):console.log(`set(): no uniform buffer named '${t}'`)}}getTexture(t){if(this._findTextureLayout(t)){const e=this._resources[t];return e?e[0]:null}throw new Error(`getTexture() failed:${t} is not a texture`)}setTextureView(t,e,i,s,r,n){if(!e)throw new Error(`WebGPUBindGroup.setTextureView() failed: invalid texture uniform value: ${e}`);{const a=this._findTextureLayout(t);if(!a)throw new Error(`WebGPUBindGroup.setView() failed: no texture uniform named '${t}'`);{if(a.externalTexture)throw new Error("WebGPUBindGroup.setTextureView() failed: video texture does not have view");if(e.isTextureVideo())throw new Error("WebGPUBindGroup.setTextureView() failed: invalid texture type");const o=this._resources[t],h=e.getView(i,s,r);if(o&&o[1]===h||(this._resources[t]=[e,h],this.invalidate()),a.texture?.autoBindSampler){const t=this._findSamplerLayout(a.texture.autoBindSampler);if(!t||!t.sampler)throw new Error(`WebGPUBindGroup.setTextureView() failed: sampler entry not found: ${a.texture.autoBindSampler}`);const i=!n||n.compare?e.getDefaultSampler(!1):n;i.object!==this._resources[a.texture.autoBindSampler]&&(this._resources[a.texture.autoBindSampler]=i.object,this.invalidate())}if(a.texture?.autoBindSamplerComparison){const t=this._findSamplerLayout(a.texture.autoBindSamplerComparison);if(!t||!t.sampler)throw new Error(`WebGPUBindGroup.setTextureView() failed: sampler entry not found: ${a.texture.autoBindSamplerComparison}`);const i=n&&n.compare?n:e.getDefaultSampler(!0);i.object!==this._resources[a.texture.autoBindSamplerComparison]&&(this._resources[a.texture.autoBindSamplerComparison]=i.object,this.invalidate())}}}}setTexture(t,e,i){if(!e)throw new Error(`WebGPUBindGroup.setTexture() failed: invalid texture uniform value: ${e}`);{const s=this._findTextureLayout(t);if(!s)throw new Error(`WebGPUBindGroup.setTexture() failed: no texture uniform named '${t}'`);{const r=this._resources[t];if(s.externalTexture){if(!e.isTextureVideo())throw new Error(`WebGPUBindGroup.setTexture() failed: invalid texture type of resource '${t}'`);if(!r||r!==e){r&&r.removeBindGroupReference(this),e&&e.addBindGroupReference(this),this._resources[t]=e,this.invalidate(),this._videoTextures=[];for(const t of this._layout.entries)if(t.externalTexture){const e=this._resources[t.name];e&&this._videoTextures.indexOf(e)<0&&this._videoTextures.push(e)}}}else{if(e.isTextureVideo())throw new Error(`WebGPUBindGroup.setTexture() failed: invalid texture type of resource '${t}'`);const i=e.getDefaultView();if(!s.externalTexture&&!i)throw new Error("WebGPUBindGroup.setTexture() failed: create texture view failed");r&&r[0]===e||(this._resources[t]=[e,i],this.invalidate())}const n=s.texture?.autoBindSampler||s.externalTexture?.autoBindSampler;if(n){const t=this._findSamplerLayout(n);if(!t||!t.sampler)throw new Error(`WebGPUBindGroup.setTexture() failed: sampler entry not found: ${n}`);const s=!i||i.compare?e.getDefaultSampler(!1):i;s.object!==this._resources[n]&&(this._resources[n]=s.object,this.invalidate())}const a=s.texture?.autoBindSamplerComparison;if(a){const t=this._findSamplerLayout(a);if(!t||!t.sampler)throw new Error(`WebGPUBindGroup.setTexture() failed: sampler entry not found: ${a}`);const s=i&&i.compare?i:e.getDefaultSampler(!0);s.object!==this._resources[a]&&(this._resources[a]=s.object,this.invalidate())}}}}setSampler(t,e){const i=e?.object;i?this._resources[t]!==i&&(this._findSamplerLayout(t)?(this._resources[t]=i,this.invalidate()):console.log(`WebGPUBindGroup.setSampler() failed: no sampler uniform named '${t}'`)):console.log(`WebGPUBindGroup.setSampler() failed: invalid sampler uniform value: ${e}`)}destroy(){this.invalidate(),this._resources={},this._buffers=[],this._textures=[],this._videoTextures=null,this._object=null}async restore(){this.invalidate(),this._object={}}isBindGroup(){return!0}updateVideoTextures(){this._videoTextures?.forEach((t=>{t.updateVideoFrame()&&this.invalidate()}))}_findTextureLayout(t){for(const e of this._layout.entries)if((e.texture||e.storageTexture||e.externalTexture)&&e.name===t)return e;return null}_findSamplerLayout(t){for(const e of this._layout.entries)if(e.sampler&&e.name===t)return e;return null}_getBuffer(t,e,i=!1){const s=this._getBufferInfo(t,e,i);return s?.[0]??null}_getBufferInfo(t,e,i=!1){const s=this._layout.nameMap?.[t]??t;for(const t of this._layout.entries)if(t.buffer&&t.name===s){const s="uniform"===t.buffer.type?Ls.BF_UNIFORM:Ls.BF_STORAGE;if(!(e&s))return null;let r=this._resources[t.name];if(!(r&&r[0]||i)){const e={usage:s===Ls.BF_UNIFORM?"uniform":null,storage:s===Ls.BF_STORAGE,dynamic:!0},i=this._device.createStructuredBuffer(t.type,e);r=[i,0,i.byteLength],this._resources[t.name]=r}return r}return null}_create(){let t=null;this._layoutDesc=null,this._entries=null,this._textures=[],this._buffers=[];const e=[];let i=!0;for(const t of this._layout.entries){const s={binding:t.binding};if(t.buffer){const e=this._getBufferInfo(t.name,"uniform"===t.buffer.type?Ls.BF_UNIFORM:Ls.BF_STORAGE,!0);if(!e)throw new Error(`Uniform buffer '${t.name}' not exists, maybe you forgot settings some uniform values`);this._buffers.indexOf(e[0])<0&&this._buffers.push(e[0]),s.resource={buffer:e[0].object,offset:e[1],size:e[2]},i=i&&!!e[0].object}else if(t.texture||t.storageTexture){const e=this._resources[t.name];e?(this._textures.indexOf(e[0])<0&&this._textures.push(e[0]),s.resource=e[1],i=i&&!!e[1]):(console.error(`Missing texture in bind group: ${t.name}`),i=!1)}else if(t.externalTexture){const e=this._resources[t.name];s.resource=e.object,i=i&&!!e.object}else if(t.sampler){const e=this._resources[t.name];s.resource=e,i=i&&!!e}e.push(s)}if(!i)return null;const[s,r]=this._device.fetchBindGroupLayout(this._layout),n={layout:r,entries:e};return r.label&&(n.label=`${r.label}.bindgroup`),t=this._device.gpuCreateBindGroup(n),t||console.log("Create bindgroup failed"),this._layoutDesc=s,this._entries=e,t}}const Iu={repeat:"repeat","mirrored-repeat":"mirror-repeat",clamp:"clamp-to-edge"},Du={nearest:"nearest",linear:"linear",none:void 0},$u={always:"always",le:"less-equal",ge:"greater-equal",lt:"less",gt:"greater",eq:"equal",ne:"not-equal",never:"never"},Lu={keep:"keep",replace:"replace",zero:"zero",invert:"invert",incr:"increment-clamp",decr:"decrement-clamp","incr-wrap":"increment-wrap","decr-wrap":"decrement-wrap"},Pu={"triangle-list":"triangle-list","triangle-strip":"triangle-strip","triangle-fan":null,"line-list":"line-list","line-strip":"line-strip","point-list":"point-list"},Nu={back:"back",front:"front",none:"none"},Bu={add:"add",subtract:"subtract","reverse-subtract":"reverse-subtract",min:"min",max:"max"},Ou={"const-color":"constant","const-alpha":"constant","dst-color":"dst","dst-alpha":"dst-alpha","inv-const-color":"one-minus-constant","inv-const-alpha":"one-minus-constant","inv-dst-color":"one-minus-dst","inv-dst-alpha":"one-minus-dst-alpha","src-color":"src","src-alpha":"src-alpha","inv-src-color":"one-minus-src","inv-src-alpha":"one-minus-src-alpha","src-alpha-saturate":"src-alpha-saturated",one:"one",zero:"zero"},Uu={float32:"0",float32x2:"1",float32x3:"2",float32x4:"3",uint32:"4",uint32x2:"5",uint32x3:"6",uint32x4:"7",sint32:"8",sint32x2:"9",sint32x3:"a",sint32x4:"b",uint16x2:"c",uint16x4:"d",unorm16x2:"e",unorm16x4:"f",sint16x2:"g",sint16x4:"h",snorm16x2:"i",snorm16x4:"j",uint8x2:"k",uint8x4:"l",unorm8x2:"m",unorm8x4:"n",sint8x2:"o",sint8x4:"p",snorm8x2:"q",snorm8x4:"r"},ku={unknown:null,rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",bgra8unorm:"bgra8unorm",dxt1:"bc1-rgba-unorm",dxt3:"bc2-rgba-unorm",dxt5:"bc3-rgba-unorm","dxt1-srgb":"bc1-rgba-unorm-srgb","dxt3-srgb":"bc2-rgba-unorm-srgb","dxt5-srgb":"bc3-rgba-unorm-srgb",bc4:"bc4-r-unorm","bc4-signed":"bc4-r-snorm",bc5:"bc5-rg-unorm","bc5-signed":"bc5-rg-snorm",bc6h:"bc6h-rgb-ufloat","bc6h-signed":"bc6h-rgb-float",bc7:"bc7-rgba-unorm","bc7-srgb":"bc7-rgba-unorm-srgb","astc-4x4":"astc-4x4-unorm","astc-4x4-srgb":"astc-4x4-unorm-srgb","astc-5x4":"astc-5x4-unorm","astc-5x4-srgb":"astc-5x4-unorm-srgb","astc-5x5":"astc-5x5-unorm","astc-5x5-srgb":"astc-5x5-unorm-srgb","astc-6x5":"astc-6x5-unorm","astc-6x5-srgb":"astc-6x5-unorm-srgb","astc-6x6":"astc-6x6-unorm","astc-6x6-srgb":"astc-6x6-unorm-srgb","astc-8x5":"astc-8x5-unorm","astc-8x5-srgb":"astc-8x5-unorm-srgb","astc-8x6":"astc-8x6-unorm","astc-8x6-srgb":"astc-8x6-unorm-srgb","astc-8x8":"astc-8x8-unorm","astc-8x8-srgb":"astc-8x8-unorm-srgb","astc-10x5":"astc-10x5-unorm","astc-10x5-srgb":"astc-10x5-unorm-srgb","astc-10x6":"astc-10x6-unorm","astc-10x6-srgb":"astc-10x6-unorm-srgb","astc-10x8":"astc-10x8-unorm","astc-10x8-srgb":"astc-10x8-unorm-srgb","astc-10x10":"astc-10x10-unorm","astc-10x10-srgb":"astc-10x10-unorm-srgb","astc-12x10":"astc-12x10-unorm","astc-12x10-srgb":"astc-12x10-unorm-srgb","astc-12x12":"astc-12x12-unorm","astc-12x12-srgb":"astc-12x12-unorm-srgb",r8unorm:"r8unorm",r8snorm:"r8snorm",r16f:"r16float",r32f:"r32float",r8ui:"r8uint",r8i:"r8sint",r16ui:"r16uint",r16i:"r16sint",r32ui:"r32uint",r32i:"r32sint",rg8unorm:"rg8unorm",rg8snorm:"rg8snorm",rg16f:"rg16float",rg32f:"rg32float",rg8ui:"rg8uint",rg8i:"rg8sint",rg16ui:"rg16uint",rg16i:"rg16sint",rg32ui:"rg32uint",rg32i:"rg32sint","rgba8unorm-srgb":"rgba8unorm-srgb","bgra8unorm-srgb":"bgra8unorm-srgb",rgba16f:"rgba16float",rgba32f:"rgba32float",rgba8ui:"rgba8uint",rgba8i:"rgba8sint",rgba16ui:"rgba16uint",rgba16i:"rgba16sint",rgba32ui:"rgba32uint",rgba32i:"rgba32sint",rg11b10uf:"rg11b10ufloat",d16:"depth16unorm",d24:"depth24plus",d32f:"depth32float",d32fs8:"depth32float-stencil8",d24s8:"depth24plus-stencil8"};function zu(t,e){const i={},s=t.length;for(let r=0;r<s;r++)i[t[r]]=e[r];return i}const Vu=zu(Object.values(ku),Object.keys(ku)),Gu=zu(Object.values(Uu),Object.keys(Uu));class Xu extends Ql{_target;_hash;_memCost;_views;_defaultView;_mipmapDirty;_flags;_width;_height;_depth;_format;_renderable;_fb;_gpuFormat;_mipLevelCount;_samplerOptions;_ringBuffer;_pendingUploads;constructor(t,e){super(t),this._target=e,this._flags=0,this._width=0,this._height=0,this._depth=0,this._renderable=!1,this._fb=!1,this._format="unknown",this._gpuFormat=null,this._mipLevelCount=0,this._samplerOptions=null,this._memCost=0,this._mipmapDirty=!1,this._views=[],this._defaultView=null,this._ringBuffer=new tu(t),this._pendingUploads=[]}get hash(){return this._object?this._device.gpuGetObjectHash(this._object):0}get target(){return this._target}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get memCost(){return this._memCost}get format(){return this._format}get mipLevelCount(){return this._mipLevelCount}get gpuFormat(){return this._gpuFormat}get samplerOptions(){return this._samplerOptions}set samplerOptions(t){const e=this.getTextureCaps().getTextureFormatInfo(this._format);this._samplerOptions=t?Object.assign({},this._getSamplerOptions(e,!!t.compare),t):null}isTexture(){return!0}isFilterable(){return!!this.getTextureCaps().getTextureFormatInfo(this._format)?.filterable}clearPendingUploads(){this._pendingUploads.length>0&&(this._pendingUploads=[],this.beginSyncChanges(null),this.endSyncChanges())}isMipmapDirty(){return this._mipmapDirty}setMipmapDirty(t){this._mipmapDirty=t}destroy(){this._object&&(this.isTextureVideo()||this._object.destroy(),this._object=null,this._device.updateVideoMemoryCost(-this._memCost),this._memCost=0)}async restore(){this._object||this._device.isContextLost()||this.init()}getTextureCaps(){return this._device.getDeviceCaps().textureCaps}isSRGBFormat(){return wt(this._format)}isFloatFormat(){return _t(this._format)}isIntegerFormat(){return gt(this._format)}isSignedFormat(){return xt(this._format)}isCompressedFormat(){return bt(this._format)}isDepth(){return mt(this._format)}isRenderable(){return this._renderable}getView(t,e,i){return t=Number(t)||0,e=Number(e)||0,i=Number(i)||0,this._views[e]||(this._views[e]=[]),this._views[e][t]||(this._views[e][t]=[]),this._views[e][t][i]||(this._views[e][t][i]=this.createView(t,e,i)),this._views[e][t][i]}getDefaultView(){return this._defaultView||!this._object||this.isTextureVideo()||(this._defaultView=this._device.gpuCreateTextureView(this._object,{dimension:this.isTextureCube()?"cube":this.isTexture3D()?"3d":this.isTexture2DArray()?"2d-array":"2d",arrayLayerCount:this.isTextureCube()?6:this.isTexture2DArray()?this._depth:1,aspect:mt(this.format)?"depth-only":"all"})),this._defaultView}copyPixelDataToBuffer(t,e,i,s,r,n,a){if(this.isTextureVideo())throw new Error("copyPixelDataToBuffer() failed: can not copy pixel data of video texture");this.sync(),Xu.copyTexturePixelsToBuffer(this._device.device,this.object,this.width,this.height,this.format,t,e,i,s,r,n,a)}generateMipmaps(){this._mipmapDirty=!0,this._device.textureUpload(this)}beginSyncChanges(t){if(!this.isTextureVideo()&&this._pendingUploads.length>0&&this._object){const e=t||this._device.device.createCommandEncoder();for(const t of this._pendingUploads)if(t.mappedBuffer){const i=t;e.copyBufferToTexture({buffer:i.mappedBuffer.buffer,offset:i.mappedBuffer.offset,bytesPerRow:i.bufferStride,rowsPerImage:i.uploadHeight},{texture:this._object,origin:{x:i.uploadOffsetX,y:i.uploadOffsetY,z:i.uploadOffsetZ},mipLevel:i.mipLevel},{width:i.uploadWidth,height:i.uploadHeight,depthOrArrayLayers:i.uploadDepth})}else if(t.image){const e=t,i={texture:this._object,origin:{x:e.offsetX,y:e.offsetY,z:e.offsetZ},mipLevel:e.mipLevel,premultipliedAlpha:!1};this._device.device.queue.copyExternalImageToTexture({source:e.image,origin:{x:e.srcX,y:e.srcY}},i,{width:e.width,height:e.height,depthOrArrayLayers:e.depth})}this._pendingUploads.length=0,t||this._device.device.queue.submit([e.finish()]),this._ringBuffer.beginUploads()}}endSyncChanges(){this._flags&Ls.DYNAMIC?this._ringBuffer.endUploads():this._ringBuffer.purge()}getDefaultSampler(t){const e=this.getTextureCaps().getTextureFormatInfo(this._format);return this._device.createSampler(this._samplerOptions&&!this._samplerOptions.compare==!t?this._samplerOptions:this._getSamplerOptions(e,t))}sync(){this._device.flush()}_calcMipLevelCount(t,e,i,s){if(mt(t)||this.isTexture3D()||this.isTextureVideo())return 1;if(this._flags&Ls.TF_NO_MIPMAP)return 1;const r=this.getTextureCaps().getTextureFormatInfo(t);return r&&r.renderable?Math.floor(Math.log2(Math.max(e,i)))+1:1}allocInternal(t,e,i,s,r){if(!this.isTextureVideo()){if(0===r)r=this._calcMipLevelCount(t,e,i,s);else if(1!==r){let t=Math.max(e,i);this.isTexture3D()&&(t=Math.max(t,s));const n=Math.floor(Math.log2(t))+1;(!Number.isInteger(r)||r<0||r>n)&&(r=n)}if(this._object&&(this._format!==t||this._width!==e||this._height!==i||this._depth,this._mipLevelCount!==r)){const t=this._object;this._device.runNextFrame((()=>{t.destroy()})),this._object=null}if(!this._object&&(this._format=t,this._width=e,this._height=i,this._depth=s,this._mipLevelCount=r,!this._device.isContextLost())){this._gpuFormat=ku[this._format];const t=this.getTextureCaps().getTextureFormatInfo(this._format);this._renderable=t.renderable&&!(this._flags&Ls.TF_WRITABLE),this._object=this._device.gpuCreateTexture({size:{width:this._width,height:this._height,depthOrArrayLayers:this.isTextureCube()?6:this._depth},format:this._gpuFormat,mipLevelCount:this._mipLevelCount,sampleCount:1,dimension:this.isTexture3D()?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(this._renderable&&!this.isTexture3D()?GPUTextureUsage.RENDER_ATTACHMENT:0)|(this._flags&Ls.TF_WRITABLE?GPUTextureUsage.STORAGE_BINDING:0)});const e=this.getTextureCaps().calcMemoryUsage(this._format,this._width*this._height*(this.isTextureCube()?6:this._depth));this._device.updateVideoMemoryCost(e-this._memCost),this._memCost=e}}}static copyTexturePixelsToBuffer(t,e,i,s,r,n,a,o,h,l,u,c){if(!(c.gpuUsage&GPUBufferUsage.COPY_DST))throw new Error("copyTexturePixelsToBuffer() failed: destination buffer does not have COPY_DST usage set");const d=vt(r),p=s/yt(r),m=i/d*Tt(r),f=m+255&-256,_=p*m,g=p*f;if(c.byteLength<_)throw new Error(`copyTexturePixelsToBuffer() failed: destination buffer size is ${c.byteLength}, should be at least ${_}`);const x=t.createBuffer({size:g,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),b=t.createCommandEncoder();if(b.copyTextureToBuffer({texture:e,mipLevel:u??0,origin:{x:n,y:a,z:l??0}},{buffer:x,offset:0,bytesPerRow:f},{width:o,height:h,depthOrArrayLayers:1}),_!==g)for(let t=0;t<p;t++)b.copyBufferToBuffer(x,t*f,c.object,t*m,m);else b.copyBufferToBuffer(x,0,c.object,0,_);t.queue.submit([b.finish()]),x.destroy()}uploadRaw(t,e,i,s,r,n,a,o){if(this.isTextureVideo())return void console.error("BaseTexture.uploadRaw(): Cannot upload to video texture");const h=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),l=this.getTextureCaps().getTextureFormatInfo(this._format),u=l.blockWidth||1,c=l.blockHeight||1,d=Math.ceil(e/u),p=Math.ceil(i/c),m=d*l.size;if(m*p*s!==h.byteLength)throw new Error(`WebGPUTexture.update() invalid data size: ${h.byteLength}`);if(this._device.isTextureUploading(this)){const t=m+255&-256,e=t*p*s,i=this._ringBuffer.uploadBuffer(null,null,0,0,e),l=i.mappedBuffer.mappedRange,f=new Uint8Array(h),_=new Uint8Array(l,i.mappedBuffer.offset,e);if(e===h.byteLength)_.set(new Uint8Array(h));else for(let e=0;e<s;e++){const i=e*m*d,s=e*t*p;for(let e=0;e<p;e++)_.set(f.subarray(i+e*m,i+(e+1)*m),s+e*t)}this._pendingUploads.push({mappedBuffer:i.mappedBuffer,uploadOffsetX:r,uploadOffsetY:n,uploadOffsetZ:a,uploadWidth:u*d,uploadHeight:c*p,uploadDepth:s,bufferStride:t,mipLevel:o}),this._device.textureUpload(this)}else{this.clearPendingUploads();const t={texture:this._object,mipLevel:o,origin:{x:r,y:n,z:a}},e={bytesPerRow:m,rowsPerImage:c*p},i={width:u*d,height:c*p,depthOrArrayLayers:s};this._device.device.queue.writeTexture(t,h,e,i)}}uploadImageData(t,e,i,s,r,n,a,o,h){this.isTextureVideo()?console.error("BaseTexture.uploadImageData(): Cannot upload to video texture"):(this._pendingUploads.push({image:t,offsetX:n,offsetY:a,offsetZ:h??0,srcX:e??0,srcY:i??0,srcZ:0,width:s,height:r,depth:1,mipLevel:o??0}),this._device.textureUpload(this))}_getSamplerOptions(t,e){const i=this.isDepth()&&e,s=t.filterable||i;return{addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:s?"linear":"nearest",minFilter:t.filterable?"linear":"nearest",mipFilter:this._mipLevelCount>1?s?"linear":"nearest":"none",compare:i?"lt":null}}_markAsCurrentFB(t){this._fb=t}_isMarkedAsCurrentFB(){return this._fb}}class Wu extends Xu{constructor(t){super(t,"2d")}isTexture2D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._mipLevelCount)}update(t,e,i,s,r){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),this.uploadRaw(t,s,r,1,e,i,0,0),this._mipLevelCount>1&&this.generateMipmaps())}updateFromElement(t,e,i,s,r,n,a){if(!this._device.isContextLost())if(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),t instanceof HTMLCanvasElement||this._device.isTextureUploading(this)){const o=document.createElement("canvas");o.width=n,o.height=a;const h=o.getContext("2d");h.drawImage(t,s,r,n,a,0,0,n,a);const l=h.getImageData(0,0,n,a);this.update(l.data,e,i,n,a),o.width=0,o.height=0}else this.uploadImageData(t,s,r,n,a,e,i,0,0)}async readPixels(t,e,i,s,r,n,a){if(0!==r)throw new Error("Texture2D.readPixels(): parameter faceOrLayer must be 0");if(n>=this.mipLevelCount||n<0)throw new Error(`Texture2D.readPixels(): invalid miplevel: ${n}`);const o=vt(this.format),h=yt(this.format),l=Tt(this.format),u=Math.ceil(i/o)*Math.ceil(s/h)*l;if(a.byteLength<u)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${a.byteLength}, should be at least ${u}`);const c=this._device.createBuffer(u,{usage:"read"});await this.copyPixelDataToBuffer(t,e,i,s,0,n,c),await c.getBufferSubData(new Uint8Array(a.buffer,a.byteOffset,a.byteLength),0,u),c.dispose()}readPixelsToBuffer(t,e,i,s,r,n,a){if(0!==r)throw new Error("Texture2D.readPixels(): parameter faceOrLayer must be 0");if(n>=this.mipLevelCount||n<0)throw new Error(`Texture2D.readPixels(): invalid miplevel: ${n}`);this.copyPixelDataToBuffer(t,e,i,s,0,n,a)}loadFromElement(t,e,i){this._flags=Number(i)||0;const s=e?"rgba8unorm-srgb":"rgba8unorm";this.loadImage(t,s)}createEmpty(t,e,i,s){this._flags=Number(s)||0,this.loadEmpty(t,e,i,0)}createView(t,e,i){return this._object?this._device.gpuCreateTextureView(this._object,{dimension:"2d",baseMipLevel:t??0,mipLevelCount:i||this._mipLevelCount-(t??0),baseArrayLayer:0,arrayLayerCount:1}):null}createWithMipmapData(t,e,i){t.isCubemap||t.isVolume?console.error("loading 2d texture with mipmap data failed: data is not 2d texture"):(this._flags=Number(i)||0,this._flags&Ls.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadLevels(t,e))}loadEmpty(t,e,i,s){this.allocInternal(t,e,i,1,s),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(t,e){let i=e?pt(t.format):t.format,s=!1;"bgra8unorm"===i?(i="rgba8unorm",s=!0):"bgra8unorm-srgb"===this._format&&(i="rgba8unorm-srgb",s=!0);const r=t.width,n=t.height,a=t.mipLevels;if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(i,r,n,1,a),!this._device.isContextLost())for(let e=0;e<t.mipDatas[0].length;e++){if(s)for(let i=0;i<t.mipDatas[0][e].width*t.mipDatas[0][e].height;i++){const s=t.mipDatas[0][e].data[4*i];t.mipDatas[0][e].data[4*i]=t.mipDatas[0][e].data[4*i+2],t.mipDatas[0][e].data[4*i+2]=s}this.uploadRaw(t.mipDatas[0][e].data,t.mipDatas[0][e].width,t.mipDatas[0][e].height,1,0,0,0,e)}}else console.error("No s3tc compression format support")}loadImage(t,e){this.allocInternal(e,Number(t.width),Number(t.height),1,0),this._device.isContextLost()||(this.updateFromElement(t,0,0,0,0,this._width,this._height),this._mipLevelCount>1&&this.generateMipmaps())}}class Hu extends Xu{constructor(t){super(t,"2darray")}isTexture2DArray(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(t,e,i,s,r,n,a){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount),this.uploadRaw(t,r,n,a,e,i,s,0),this._mipLevelCount>1&&this.generateMipmaps())}updateFromElement(t,e,i,s,r,n,a,o){if(!this._device.isContextLost())if(this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount),t instanceof HTMLCanvasElement||this._device.isTextureUploading(this)){const h=document.createElement("canvas");h.width=a,h.height=o;const l=h.getContext("2d");l.drawImage(t,r,n,a,o,0,0,a,o);const u=l.getImageData(0,0,a,o);this.update(u.data,e,i,s,a,o,1),h.width=0,h.height=0}else this.uploadImageData(t,r,n,a,o,e,i,0,s)}createEmpty(t,e,i,s,r){this._flags=Number(r)||0,this.loadEmpty(t,e,i,s,0)}createWithMipmapData(t,e){t.arraySize?(this._flags=Number(e)||0,this._flags&Ls.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(t)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}createView(t,e,i){return this._object?this._device.gpuCreateTextureView(this._object,{dimension:"2d",baseMipLevel:t??0,mipLevelCount:i||this._mipLevelCount-(t??0),baseArrayLayer:e??0,arrayLayerCount:1}):null}async readPixels(t,e,i,s,r,n,a){if(r<0||r>=this._depth)throw new Error(`Texture2DArray.readPixels(): invalid layer: ${r}`);if(n<0||n>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixels(): invalid miplevel: ${n}`);const o=vt(this.format),h=yt(this.format),l=Tt(this.format),u=Math.ceil(i/o)*Math.ceil(s/h)*l;if(a.byteLength<u)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${a.byteLength}, should be at least ${u}`);const c=this._device.createBuffer(u,{usage:"read"});await this.copyPixelDataToBuffer(t,e,i,s,r,n,c),await c.getBufferSubData(new Uint8Array(a.buffer,a.byteOffset,a.byteLength),0,u),c.dispose()}readPixelsToBuffer(t,e,i,s,r,n,a){if(r<0||r>=this._depth)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid layer: ${r}`);if(n<0||n>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid miplevel: ${n}`);this.copyPixelDataToBuffer(t,e,i,s,r,n,a)}loadEmpty(t,e,i,s,r){this.allocInternal(t,e,i,s,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(t){const e=t.format,i=t.width,s=t.height,r=t.arraySize,n=1!==t.mipLevels||this._flags&Ls.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,i,s,r);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(e,i,s,t.arraySize,n),!this._device.isContextLost()){for(let e=0;e<t.arraySize;e++){if(t.mipDatas[e].length!==t.mipLevels)return void console.log("Texture2DArray.loadLevels() failed: Invalid texture data");for(let i=0;i<t.mipLevels;i++)this.uploadRaw(t.mipDatas[e][i].data,t.mipDatas[e][i].width,t.mipDatas[e][i].height,1,0,0,e,i)}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture2DArray.loadLevels(): No s3tc compression format support")}}class ju extends Xu{constructor(t){super(t,"3d")}isTexture3D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(t,e,i,s,r,n,a){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount),this.uploadRaw(t,r,n,a,e,i,s,0))}createEmpty(t,e,i,s,r){this._flags=Number(r)||0,this.loadEmpty(t,e,i,s,0)}createView(t,e,i){return this._object?this._device.gpuCreateTextureView(this._object,{dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:e,arrayLayerCount:1}):null}async readPixels(t,e,i,s,r,n,a){if(0!==n)throw new Error("Texture3D.readPixels(): parameter mipLevel must be 0");const o=vt(this.format),h=yt(this.format),l=Tt(this.format),u=this.width/o*(this.height/h)*l;if(a.byteLength<u)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${a.byteLength}, should be at least ${u}`);const c=this._device.createBuffer(u,{usage:"read"});await this.copyPixelDataToBuffer(t,e,i,s,r,0,c),await c.getBufferSubData(new Uint8Array(a.buffer,a.byteOffset,a.byteLength),0,u),c.dispose()}readPixelsToBuffer(t,e,i,s,r,n,a){if(0!==n)throw new Error("Texture3D.readPixelsToBuffer(): parameter mipLevel must be 0");this.copyPixelDataToBuffer(t,e,i,s,r,0,a)}createWithMipmapData(t,e){t.arraySize?(this._flags=Number(e)||0,this._flags&Ls.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(t)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}loadLevels(t){const e=t.format,i=t.width,s=t.height,r=t.depth,n=1!==t.mipLevels||this._flags&Ls.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,i,s,r);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(e,i,s,r,n),!this._device.isContextLost()){for(let e=0;e<r;e++){if(t.mipDatas[e].length!==t.mipLevels)return void console.log("Texture3D.loadLevels() failed: Invalid texture data");for(let i=0;i<t.mipLevels;i++)this.uploadRaw(t.mipDatas[e][i].data,t.mipDatas[e][i].width,t.mipDatas[e][i].height,1,0,0,e,i)}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture3D.loadLevels(): No s3tc compression format support")}loadEmpty(t,e,i,s,r){this.allocInternal(t,e,i,s,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}}class qu extends Xu{constructor(t){super(t,"cube")}init(){this.loadEmpty(this._format,this._width,this._mipLevelCount)}update(t,e,i,s,r,n){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),this.uploadRaw(t,s,r,1,e,i,n,0),this._mipLevelCount>1&&this.generateMipmaps())}updateFromElement(t,e,i,s,r,n,a,o){if(!this._device.isContextLost())if(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),t instanceof HTMLCanvasElement||this._device.isTextureUploading(this)){const h=document.createElement("canvas");h.width=a,h.height=o;const l=h.getContext("2d");l.drawImage(t,r,n,a,o,0,0,a,o);const u=l.getImageData(0,0,a,o);this.update(u.data,e,i,a,o,s),h.width=0,h.height=0}else this.uploadImageData(t,r,n,a,o,e,i,0,s)}createEmpty(t,e,i){this._flags=Number(i)||0,this._flags&Ls.TF_WRITABLE?console.error(new Error("storage texture can not be cube texture")):this.loadEmpty(t,e,0)}isTextureCube(){return!0}createView(t,e,i){return this._object?this._device.gpuCreateTextureView(this._object,{format:this._gpuFormat,dimension:"2d",baseMipLevel:t??0,mipLevelCount:i||this._mipLevelCount-(t??0),baseArrayLayer:e??0,arrayLayerCount:1,aspect:"all"}):null}async readPixels(t,e,i,s,r,n,a){if(n<0||n>=this.mipLevelCount)throw new Error(`TextureCube.readPixels(): invalid miplevel: ${n}`);const o=vt(this.format),h=yt(this.format),l=Tt(this.format),u=Math.ceil(i/o)*Math.ceil(s/h)*l;if(a.byteLength<u)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${a.byteLength}, should be at least ${u}`);const c=this._device.createBuffer(u,{usage:"read"});await this.copyPixelDataToBuffer(t,e,i,s,r,n,c),await c.getBufferSubData(new Uint8Array(a.buffer,a.byteOffset,a.byteLength),0,u),c.dispose()}readPixelsToBuffer(t,e,i,s,r,n,a){if(n<0||n>=this.mipLevelCount)throw new Error(`TextureCube.readPixelsToBuffer(): invalid miplevel: ${n}`);this.copyPixelDataToBuffer(t,e,i,s,r,n,a)}createWithMipmapData(t,e,i){t.isCubemap?(this._flags=Number(i)||0,this._flags&Ls.TF_WRITABLE?console.error("webgl device does not support storage texture"):this.loadLevels(t,e)):console.error("loading cubmap with mipmap data failed: data is not cubemap")}loadEmpty(t,e,i){this.allocInternal(t,e,e,1,i),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadImages(t,e){const i=t[0].width,s=t[0].height;if(6===t.length){for(let e=1;e<6;e++)if(t[e].width!==i||t[e].height!==s)return void console.error(new Error("cubemap face images must have identical sizes"));if(0!==i&&0!==s&&(this.allocInternal(e,i,s,1,0),!this._device.isContextLost())){const e=this._width,i=this._height;for(let s=0;s<6;s++)createImageBitmap(t[s],{premultiplyAlpha:"none"}).then((t=>{this.updateFromElement(t,0,0,s,0,0,e,i)}));this._mipLevelCount>1&&this.generateMipmaps()}}else console.error(new Error("cubemap face list must have 6 images"))}loadLevels(t,e){const i=e?pt(t.format):t.format,s=t.width,r=t.height,n=1!==t.mipLevels||this._flags&Ls.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,s,r,1);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(i,s,r,1,n),!this._device.isContextLost())for(let e=0;e<6;e++){if(t.mipDatas[e].length!==t.mipLevels)return void console.log("TextureCube.loadLevels() failed: Invalid texture data");for(let i=0;i<t.mipLevels;i++)this.uploadRaw(t.mipDatas[e][i].data,t.mipDatas[e][i].width,t.mipDatas[e][i].height,1,0,0,e,i)}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}else console.error("TextureCube.loadLevels(): No s3tc compression format support")}}class Yu extends Xu{_source;_refBindGroups;constructor(t,e){super(t,"2d"),this._source=e,this._width=0,this._height=0,this._refBindGroups=[],this.loadFromElement()}isTextureVideo(){return!0}addBindGroupReference(t){this._refBindGroups.push(t)}removeBindGroupReference(t){const e=this._refBindGroups.indexOf(t);e>=0&&this._refBindGroups.splice(e,1)}get width(){return this._width}get height(){return this._height}get source(){return this._source}async restore(){this._object||this._device.isContextLost()||this.loadElement(this._source)}updateVideoFrame(){if(this._source.readyState>2){return new window.VideoFrame(this._source).close(),this._object=this._device.gpuImportExternalTexture(this._source),!0}return!1}createView(t,e,i){return null}init(){this.loadFromElement()}readPixels(t,e,i,s,r,n,a){throw new Error("Video texture does not support readPixels()")}readPixelsToBuffer(t,e,i,s,r,n,a){throw new Error("Video texture does not support readPixelsToBuffer()")}loadFromElement(){this.loadElement(this._source)}loadElement(t){if(this._format="rgba8unorm",this._width=t.videoWidth,this._height=t.videoHeight,this._depth=1,this._mipLevelCount=1,!this._device.isContextLost()&&t.readyState>2){this._object=this._device.gpuImportExternalTexture(t);const e=this;this._device.runNextFrame((function t(){if(!e.disposed){if(e._source.readyState>2){new window.VideoFrame(e._source).close(),e._object=e._device.gpuImportExternalTexture(e._source);for(const t of e._refBindGroups)t.invalidate()}e._device.runNextFrame(t)}}))}return!!this._object}}class Zu{maxDrawBuffers;maxColorAttachmentBytesPerSample;supportMultisampledFramebuffer;supportFloatBlending;supportDepth32float;supportDepth32floatStencil8;constructor(t){this.maxDrawBuffers=t.device.limits.maxColorAttachments,this.maxColorAttachmentBytesPerSample=t.device.limits.maxColorAttachmentBytesPerSample,this.supportMultisampledFramebuffer=!0,this.supportFloatBlending=!0,this.supportDepth32float=!0,this.supportDepth32floatStencil8=t.device.features.has("depth32float-stencil8")}}class Ku{supportOversizedViewport;supportBlendMinMax;support32BitIndex;supportDepthClamp;maxBindGroups;maxTexCoordIndex;constructor(t){this.supportOversizedViewport=!1,this.supportBlendMinMax=!0,this.support32BitIndex=!0,this.supportDepthClamp=t.device.features.has("depth-clip-control"),this.maxBindGroups=4,this.maxTexCoordIndex=8}}class Qu{supportFragmentDepth;supportStandardDerivatives;supportShaderTextureLod;supportHighPrecisionFloat;supportHighPrecisionInt;maxUniformBufferSize;uniformBufferOffsetAlignment;maxStorageBufferSize;storageBufferOffsetAlignment;constructor(t){this.supportFragmentDepth=!0,this.supportStandardDerivatives=!0,this.supportShaderTextureLod=!0,this.supportHighPrecisionFloat=!0,this.maxUniformBufferSize=t.device.limits.maxUniformBufferBindingSize||65536,this.uniformBufferOffsetAlignment=t.device.limits.minUniformBufferOffsetAlignment||256,this.maxStorageBufferSize=t.device.limits.maxStorageBufferBindingSize||134217728,this.storageBufferOffsetAlignment=t.device.limits.minStorageBufferOffsetAlignment||256}}class Ju{_textureFormatInfos;maxTextureSize;maxCubeTextureSize;npo2Mipmapping;npo2Repeating;supportS3TC;supportS3TCSRGB;supportBPTC;supportRGTC;supportASTC;supportDepthTexture;support3DTexture;supportSRGBTexture;supportFloatTexture;supportLinearFloatTexture;supportHalfFloatTexture;supportLinearHalfFloatTexture;supportAnisotropicFiltering;supportFloatColorBuffer;supportHalfFloatColorBuffer;supportFloatBlending;constructor(t){if(this.supportAnisotropicFiltering=!0,this.supportDepthTexture=!0,this.support3DTexture=!0,this.supportSRGBTexture=!0,this.supportFloatTexture=!0,this.supportFloatColorBuffer=!0,this.supportHalfFloatColorBuffer=!0,this.supportFloatBlending=!0,this.supportS3TC=t.device.features.has("texture-compression-bc"),this.supportS3TCSRGB=this.supportS3TC,this.supportBPTC=this.supportS3TC,this.supportRGTC=this.supportS3TC,this.supportASTC=t.device.features.has("texture-compression-astc"),this.supportHalfFloatTexture=!0,this.maxTextureSize=t.device.limits.maxTextureDimension2D,this.maxCubeTextureSize=t.device.limits.maxTextureDimension2D,this.npo2Mipmapping=!0,this.npo2Repeating=!0,this._textureFormatInfos={rgba8unorm:{gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!0,size:4},rgba8snorm:{gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!1,writable:!0,size:4},bgra8unorm:{gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:4}},this.supportASTC)for(const t of["4x4","5x4","5x5","6x5","6x6","8x5","8x6","8x8","10x5","10x6","10x8","10x10","12x10","12x12"]){const[e,i]=t.split("x").map((t=>Number(t)));this._textureFormatInfos[`astc-${t}`]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:e,blockHeight:i},this._textureFormatInfos[`astc-${t}-srgb`]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:e,blockHeight:i}}this.supportS3TC&&(this._textureFormatInfos.dxt1={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:8,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos.dxt3={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos.dxt5={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4}),this.supportRGTC&&(this._textureFormatInfos.bc4={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:8,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc4-signed"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:8,writable:!1,blockWidth:4,blockHeight:4}),this._textureFormatInfos.bc5={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc5-signed"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this.supportBPTC&&(this._textureFormatInfos.bc6h={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc6h-signed"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos.bc7={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc7-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4}),this.supportS3TCSRGB&&(this._textureFormatInfos["dxt1-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:8,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["dxt3-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4},this._textureFormatInfos["dxt5-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:4,blockHeight:4}),this._textureFormatInfos.r8unorm={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:1},this._textureFormatInfos.r8snorm={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!1,writable:!1,size:1},this._textureFormatInfos.r16f={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.r32f={gpuSampleType:"unfilterable-float",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:4},this._textureFormatInfos.r8ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:1},this._textureFormatInfos.r8i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:1},this._textureFormatInfos.r16ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.r16i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.r32ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:4},this._textureFormatInfos.r32i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:4},this._textureFormatInfos.rg8unorm={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.rg8snorm={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!1,writable:!1,size:2},this._textureFormatInfos.rg16f={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.rg32f={gpuSampleType:"unfilterable-float",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos.rg8ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.rg8i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.rg16ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.rg16i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.rg32ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos.rg32i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos["rgba8unorm-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos["bgra8unorm-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.rgba16f={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos.rgba32f={gpuSampleType:"unfilterable-float",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:16},this._textureFormatInfos.rgba8ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:4},this._textureFormatInfos.rgba8i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:4},this._textureFormatInfos.rgba16ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos.rgba16i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:8},this._textureFormatInfos.rgba32ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:16},this._textureFormatInfos.rgba32i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,size:16},this._textureFormatInfos.rg11b10uf={gpuSampleType:"float",filterable:!0,renderable:t.device.features.has("rg11b10ufloat-renderable"),compressed:!1,writable:!1,size:4},this._textureFormatInfos.d16={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:2},this._textureFormatInfos.d24={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.d32f={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:4},this._textureFormatInfos.d32fs8={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:8},this._textureFormatInfos.d24s8={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,size:4},this.supportLinearFloatTexture=this._textureFormatInfos.r32f.filterable&&this._textureFormatInfos.rg32f.filterable&&this._textureFormatInfos.rgba32f.filterable,this.supportLinearHalfFloatTexture=this._textureFormatInfos.r16f.filterable&&this._textureFormatInfos.rg16f.filterable&&this._textureFormatInfos.rgba16f.filterable}calcMemoryUsage(t,e){return this._textureFormatInfos[t]?this._textureFormatInfos[t].size*e:0}getTextureFormatInfo(t){return this._textureFormatInfos[t]}}class tc extends Ql{static _hashCounter=0;_vertexData;_hash;_layouts;constructor(t,e){super(t),this._vertexData=new Xs;for(const t of e.vertexBuffers)this._vertexData.setVertexBuffer(t.buffer,t.stepMode);e.indexBuffer&&this._vertexData.setIndexBuffer(e.indexBuffer),this._hash=String(++tc._hashCounter),this._layouts={}}destroy(){this._object=null}async restore(){this._object={}}setDrawOffset(t,e){for(const i of this._vertexData.vertexBuffers)i?.buffer===t&&(i.drawOffset=e)}get hash(){return this._hash}get vertexBuffers(){return this._vertexData.vertexBuffers}get indexBuffer(){return this._vertexData.indexBuffer}getDrawOffset(){return this._vertexData.getDrawOffset()}getVertexBuffer(t){return this._vertexData.getVertexBuffer(t)}getVertexBufferInfo(t){return this._vertexData.getVertexBufferInfo(t)}getIndexBuffer(){return this._vertexData.getIndexBuffer()}getLayouts(t){if(!t)return null;let e=this._layouts[t];return e||(e=this.calcHash(t),this._layouts[t]=e),e}calcHash(t){const e=[],i=[],s=this._vertexData.vertexBuffers,r=t.split(":").map((t=>Number(t)));for(let t=0;t<r.length;t++){const n=s[r[t]],a=n?.buffer;if(!a){console.log(`ERROR: No vertex buffer set for location ${t}`);continue}const o=Ru.getGPUVertexFormat(n.type);if(!o)throw new Error("Invalid vertex buffer format");const h=i.findIndex((t=>t.buffer===a)),l=n.stride;let u=h>=0?e[h]:`${l}-${Number("instance"===n.stepMode)}`;u+=`-${Uu[o]}-${n.offset}-${t}`,h>=0?e[h]=u:(e.push(u),i.push(n))}return{layoutHash:e.join(":"),buffers:i}}bind(){this._device.setVertexLayout(this)}draw(t,e,i){this.bind(),this._device.draw(t,e,i)}drawInstanced(t,e,i,s){this.bind(),this._device.drawInstanced(t,e,i,s)}}class ec{static _defaultState;_hash;static get defaultState(){return this._defaultState}constructor(){this._hash=null}get hash(){return this._getHash(this.constructor)}invalidateHash(){this._hash=null}_getHash(t){return this===t.defaultState?"":(null===this._hash&&(this._hash=this.computeHash()),this._hash)}}class ic extends ec{static _defaultState=new ic;_redMask;_greenMask;_blueMask;_alphaMask;constructor(){super(),this._redMask=this._greenMask=this._blueMask=this._alphaMask=!0}clone(){return(new ic).setColorMask(this._redMask,this._greenMask,this._blueMask,this._alphaMask)}get redMask(){return this._redMask}set redMask(t){this._redMask!==!!t&&(this._redMask=!!t,this.invalidateHash())}get greenMask(){return this._greenMask}set greenMask(t){this._greenMask!==!!t&&(this._greenMask=!!t,this.invalidateHash())}get blueMask(){return this._blueMask}set blueMask(t){this._blueMask!==!!t&&(this._blueMask=!!t,this.invalidateHash())}get alphaMask(){return this._alphaMask}set alphaMask(t){this._alphaMask!==!!t&&(this._alphaMask=!!t,this.invalidateHash())}setColorMask(t,e,i,s){return this.redMask=t,this.greenMask=e,this.blueMask=i,this.alphaMask=s,this}computeHash(){let t=0;return this.redMask&&(t+=1),this.greenMask&&(t+=2),this.blueMask&&(t+=4),this.alphaMask&&(t+=8),String(t)}}class sc extends ec{static _defaultState=new sc;_enabled;_alphaToCoverageEnabled;_srcBlendRGB;_dstBlendRGB;_srcBlendAlpha;_dstBlendAlpha;_rgbEquation;_alphaEquation;constructor(){super(),this._enabled=!1,this._alphaToCoverageEnabled=!1,this._srcBlendRGB="one",this._dstBlendRGB="zero",this._srcBlendAlpha="one",this._dstBlendAlpha="zero",this._rgbEquation="add",this._alphaEquation="add"}clone(){const t=new sc;return t.enable(this._enabled),t.enableAlphaToCoverage(this._alphaToCoverageEnabled),t.setBlendFuncRGB(this._srcBlendRGB,this._dstBlendRGB),t.setBlendFuncAlpha(this._srcBlendAlpha,this._dstBlendAlpha),t.setBlendEquation(this._rgbEquation,this._alphaEquation),t}get enabled(){return this._enabled}set enabled(t){this._enabled!==!!t&&(this._enabled=!!t,this.invalidateHash())}get alphaToCoverageEnabled(){return this._alphaToCoverageEnabled}set alphaToCoverageEnabled(t){this._alphaToCoverageEnabled!==!!t&&(this._alphaToCoverageEnabled=!!t,this.invalidateHash())}get srcBlendRGB(){return this._srcBlendRGB}set srcBlendRGB(t){this._srcBlendRGB!==t&&(this._srcBlendRGB=t,this.invalidateHash())}get srcBlendAlpha(){return this._srcBlendAlpha}set srcBlendAlpha(t){this._srcBlendAlpha!==t&&(this._srcBlendAlpha=t,this.invalidateHash())}get dstBlendRGB(){return this._dstBlendRGB}set dstBlendRGB(t){this._dstBlendRGB!==t&&(this._dstBlendRGB=t,this.invalidateHash())}get dstBlendAlpha(){return this._dstBlendAlpha}set dstBlendAlpha(t){this._dstBlendAlpha!==t&&(this._dstBlendAlpha=t,this.invalidateHash())}get rgbEquation(){return this._rgbEquation}set rgbEquation(t){this._rgbEquation!==t&&(this._rgbEquation=t,this.invalidateHash())}get alphaEquation(){return this._alphaEquation}set alphaEquation(t){this._alphaEquation!==t&&(this._alphaEquation=t,this.invalidateHash())}enable(t){return this.enabled=t,this}enableAlphaToCoverage(t){return this.alphaToCoverageEnabled=t,this}setBlendFunc(t,e){return this.srcBlendRGB=t,this.dstBlendRGB=e,this.srcBlendAlpha=t,this.dstBlendAlpha=e,this}setBlendFuncRGB(t,e){return this.srcBlendRGB=t,this.dstBlendRGB=e,this}setBlendFuncAlpha(t,e){return this.srcBlendAlpha=t,this.dstBlendAlpha=e,this}setBlendEquation(t,e){return this.rgbEquation=t,this.alphaEquation=e,this}computeHash(){return this._enabled?`${this._srcBlendRGB}-${this._srcBlendAlpha}-${this._dstBlendRGB}-${this._dstBlendAlpha}-${this._rgbEquation}-${this._alphaEquation}-${Number(!!this._alphaToCoverageEnabled)}`:`${Number(!!this._alphaToCoverageEnabled)}`}}class rc extends ec{static _defaultState=new rc;_cullMode;_depthClampEnabled;constructor(){super(),this._cullMode="back",this._depthClampEnabled=!1}clone(){return(new rc).setCullMode(this._cullMode).enableDepthClamp(this._depthClampEnabled)}get cullMode(){return this._cullMode}set cullMode(t){this._cullMode!==t&&(this._cullMode=t,this.invalidateHash())}setCullMode(t){return this.cullMode=t,this}get depthClampEnabled(){return this._depthClampEnabled}set depthClampEnabled(t){this.enableDepthClamp(t)}enableDepthClamp(t){return this._depthClampEnabled!==!!t&&(this._depthClampEnabled=!!t,this.invalidateHash()),this}computeHash(){return`${this._cullMode}-${this._depthClampEnabled?1:0}`}}class nc extends ec{static _defaultState=new nc;_testEnabled;_writeEnabled;_compareFunc;constructor(){super(),this._testEnabled=!0,this._writeEnabled=!0,this._compareFunc="le"}clone(){const t=new nc;return t.enableTest(this._testEnabled),t.enableWrite(this._writeEnabled),t.setCompareFunc(this._compareFunc),t}get testEnabled(){return this._testEnabled}set testEnabled(t){this._testEnabled!==!!t&&(this._testEnabled=t,this.invalidateHash())}get writeEnabled(){return this._writeEnabled}set writeEnabled(t){this._writeEnabled!==!!t&&(this._writeEnabled=t,this.invalidateHash())}get compareFunc(){return this._compareFunc}set compareFunc(t){this._compareFunc!==t&&(this._compareFunc=t,this.invalidateHash())}enableTest(t){return this.testEnabled=t,this}enableWrite(t){return this.writeEnabled=t,this}setCompareFunc(t){return this.compareFunc=t,this}computeHash(){return`${Number(this._testEnabled)}-${Number(this._writeEnabled)}-${this.compareFunc}}`}}class ac extends ec{static _defaultState=new ac;_enabled;_writeMask;_failOp;_failOpBack;_zFailOp;_zFailOpBack;_passOp;_passOpBack;_func;_funcBack;_ref;_readMask;constructor(){super(),this._enabled=!1,this._failOp=this.failOpBack="keep",this._zFailOp=this.zFailOpBack="keep",this._passOp=this.passOpBack="keep",this._func=this.funcBack="always",this._ref=0,this._writeMask=4294967295,this._readMask=4294967295}clone(){const t=new ac;return t.enable(this._enabled),t.setWriteMask(this._writeMask),t.setFrontOp(this._failOp,this._zFailOp,this._passOp),t.setBackOp(this._failOpBack,this._zFailOpBack,this._passOpBack),t.setFrontCompareFunc(this._func),t.setBackCompareFunc(this._funcBack),t.setReference(this._ref),t.setReadMask(this._readMask),t}get enabled(){return this._enabled}set enabled(t){this._enabled!==!!t&&(this._enabled=!!t,this.invalidateHash())}get writeMask(){return this._writeMask}set writeMask(t){this._writeMask!==t&&(this._writeMask=t,this.invalidateHash())}get failOp(){return this._failOp}set failOp(t){this._failOp!==t&&(this._failOp=t,this.invalidateHash())}get failOpBack(){return this._failOpBack}set failOpBack(t){this._failOpBack!==t&&(this._failOpBack=t,this.invalidateHash())}get zFailOp(){return this._zFailOp}set zFailOp(t){this._zFailOp!==t&&(this._zFailOp=t,this.invalidateHash())}get zFailOpBack(){return this._zFailOpBack}set zFailOpBack(t){this._zFailOpBack!==t&&(this._zFailOpBack=t,this.invalidateHash())}get passOp(){return this._passOp}set passOp(t){this._passOp!==t&&(this._passOp=t,this.invalidateHash())}get passOpBack(){return this._passOpBack}set passOpBack(t){this._passOpBack!==t&&(this._passOpBack=t,this.invalidateHash())}get func(){return this._func}set func(t){this._func!==t&&(this._func=t,this.invalidateHash())}get funcBack(){return this._funcBack}set funcBack(t){this._funcBack!==t&&(this._funcBack=t,this.invalidateHash())}get ref(){return this._ref}set ref(t){this._ref!==t&&(this._ref=t,this.invalidateHash())}get readMask(){return this._readMask}set readMask(t){this._readMask!==t&&(this._readMask=t,this.invalidateHash())}enable(t){return this.enabled=t,this}setWriteMask(t){return this.writeMask=t,this}setFrontOp(t,e,i){return this.failOp=t,this.zFailOp=e,this.passOp=i,this}setBackOp(t,e,i){return this.failOpBack=t,this.zFailOpBack=e,this.passOpBack=i,this}setFrontCompareFunc(t){return this.func=t,this}setBackCompareFunc(t){return this.funcBack=t,this}setReference(t){return this.ref=t,this}setReadMask(t){return this.readMask=t,this}computeHash(){return this._enabled?`${this.sideHash(!1)}-${this.sideHash(!0)}-${this.readMask.toString(16)}-${this.writeMask.toString(16)}-${this.ref.toString(16)}`:""}sideHash(t){return t?`${this._failOpBack}-${this._zFailOpBack}-${this._passOpBack}-${this._funcBack}`:`${this._failOp}-${this._zFailOp}-${this._passOp}-${this._func}`}}class oc{_device;colorState;blendingState;rasterizerState;depthState;stencilState;constructor(t){this._device=t,this.colorState=null,this.blendingState=null,this.rasterizerState=null,this.depthState=null,this.stencilState=null}clone(){const t=new oc(this._device);return t.colorState=this.colorState?.clone()??null,t.blendingState=this.blendingState?.clone()??null,t.rasterizerState=this.rasterizerState?.clone()??null,t.depthState=this.depthState?.clone()??null,t.stencilState=this.stencilState?.clone()??null,t}copyFrom(t){this.colorState=t.colorState,this.blendingState=t.blendingState,this.rasterizerState=t.rasterizerState,this.depthState=t.depthState,this.stencilState=t.stencilState}get hash(){return`${this.colorState?.hash||""}:${this.blendingState?.hash||""}:${this.rasterizerState?.hash||""}:${this.depthState?.hash||""}:${this.stencilState?.hash||""}`}useColorState(t){return this.colorState=t??this.colorState??new ic}defaultColorState(){this.colorState=null}useBlendingState(t){return this.blendingState=t??this.blendingState??new sc}defaultBlendingState(){this.blendingState=null}useRasterizerState(t){return this.rasterizerState=t??this.rasterizerState??new rc}defaultRasterizerState(){this.rasterizerState=null}useDepthState(t){return this.depthState=t??this.depthState??new nc}defaultDepthState(){this.depthState=null}useStencilState(t){return this.stencilState=t??this.stencilState??new ac}defaultStencilState(){this.stencilState=null}apply(t){this._device.setRenderStates(this)}}const hc=te.getCachedTypeInfo(Bt.U16),lc=["stencil8","depth24plus-stencil8","depth24unorm-stencil8","depth32float-stencil8"],uc=["depth16unorm","depth24plus","depth24plus-stencil8","depth32float","depth24unorm-stencil8","depth32float-stencil8"];class cc{_device;_renderPipelines;_computePipelines;constructor(t){this._device=t,this._renderPipelines={},this._computePipelines={}}wipeCache(){this._renderPipelines={},this._computePipelines={}}fetchComputePipeline(t){const e=this.getComputePipelineHash(t);let i=this._computePipelines[e];if(void 0===i){const s=t.getShaderModule(),r={layout:s.pipelineLayout,compute:{module:s.csModule,entryPoint:"main"}};i=this._device.gpuCreateComputePipeline(r),this._computePipelines[e]=i}return i}fetchRenderPipeline(t,e,i,s,r){if(!r.hash)return null;t.vertexAttributes||(e=null);const n=this.getRenderPipelineHash(r.hash,t,e,i,s);let a=this._renderPipelines[n];if(void 0===a){const o=e?this._device.fetchVertexLayout(e.getLayouts(t.vertexAttributes).layoutHash):null,h=t.getShaderModule(),l={module:h.vsModule,entryPoint:"main"};o&&(l.buffers=o);const u=this.createPrimitiveState(e,i,s),c=this.createDepthStencilState(r.depthFormat,i),d=r.colorFormats.map((t=>this.createColorTargetState(i,t))),p={label:n,layout:h.pipelineLayout,vertex:l,primitive:u,depthStencil:c,multisample:this.createMultisampleState(r.sampleCount,i),fragment:{module:h.fsModule,entryPoint:"main",targets:d}};a=this._device.gpuCreateRenderPipeline(p),this._renderPipelines[n]=a}return a}createPrimitiveState(t,e,i){const s=Pu[i];if(!s)throw new Error(`createPrimitiveState() failed: invalid primitive type: ${i}`);const r=e?.rasterizerState||rc.defaultState,n=Nu[r.cullMode];if(!n)throw new Error(`createPrimitiveState() failed: invalid cull mode: ${r.cullMode}`);const a={topology:s,frontFace:this._device.isWindingOrderReversed()?"cw":"ccw",cullMode:n};return this._device.device.features.has("depth-clip-control")&&(a.unclippedDepth=r.depthClampEnabled),"triangle-strip"!==s&&"line-strip"!==s||(a.stripIndexFormat=t?.getIndexBuffer()?.indexType===hc?"uint16":"uint32"),a}createMultisampleState(t,e){return{count:t,alphaToCoverageEnabled:t>1&&(e?.blendingState??sc.defaultState).alphaToCoverageEnabled}}createDepthStencilState(t,e){if(!t)return;const i=e?.depthState||nc.defaultState,s=e?.stencilState||ac.defaultState,r=lc.indexOf(t)>=0,n=uc.indexOf(t)>=0,a={format:t,depthWriteEnabled:!!n&&i.writeEnabled,depthCompare:n&&i.testEnabled?$u[i.compareFunc]:"always"};if(r){const t=s.enabled?this.createStencilFaceState(s.func,s.failOp,s.zFailOp,s.passOp):void 0,e=s.enabled?this.createStencilFaceState(s.funcBack,s.failOpBack,s.zFailOpBack,s.passOpBack):void 0,i=s.enabled?s.readMask:void 0,r=s.enabled?s.writeMask:void 0;a.stencilFront=t,a.stencilBack=e,a.stencilReadMask=i,a.stencilWriteMask=r}return a}createStencilFaceState(t,e,i,s){return{compare:$u[t],failOp:Lu[e],depthFailOp:Lu[i],passOp:Lu[s]}}createColorTargetState(t,e){const i=t?.blendingState||sc.defaultState,s=t?.colorState||ic.defaultState,r={format:e,writeMask:(s.redMask?GPUColorWrite.RED:0)|(s.greenMask?GPUColorWrite.GREEN:0)|(s.blueMask?GPUColorWrite.BLUE:0)|(s.alphaMask?GPUColorWrite.ALPHA:0)};return i.enabled&&(r.blend=this.createBlendState(i)),r}createBlendState(t){return{color:this.createBlendComponent(t.rgbEquation,t.srcBlendRGB,t.dstBlendRGB),alpha:this.createBlendComponent(t.alphaEquation,t.srcBlendAlpha,t.dstBlendAlpha)}}createBlendComponent(t,e,i){const s=Bu[t];if(!s)throw new Error(`createBlendComponent() failed: invalid blend op: ${t}`);const r=Ou[e];if(!r)throw new Error(`createBlendComponent() failed: invalid source blend func ${e}`);const n=Ou[i];if(!n)throw new Error(`createBlendComponent() failed: invalid dest blend func ${i}`);return{operation:s,srcFactor:r,dstFactor:n}}getRenderPipelineHash(t,e,i,s,r){return`${e.hash}:${i?.getLayouts(e.vertexAttributes).layoutHash||""}:${t}:${r}:${s?.hash||""}:${Number(this._device.isWindingOrderReversed())}`}getComputePipelineHash(t){return t.hash}}class dc extends Ql{_options;_width;_height;_bindFlag;_hash;_msaaColorTextures;_msaaDepthTexture;constructor(t,e,i,s){if(super(t),e.length>0&&e.findIndex((t=>!t))>=0)throw new Error("WebGPUFramebuffer(): invalid color attachments");if(this._object=null,this._options={colorAttachments:e?.length>0?e.map((t=>({texture:t,face:0,layer:0,level:0,generateMipmaps:!0}))):null,depthAttachment:i?{texture:i,face:0,layer:0,level:0,generateMipmaps:!1}:null,sampleCount:s?.sampleCount??1,ignoreDepthStencil:s?.ignoreDepthStencil??!1},!this._options.colorAttachments&&!this._options.depthAttachment)throw new Error("WebGPUFramebuffer(): colorAttachments or depthAttachment must be specified");if(this._width=this._options.colorAttachments?this._options.colorAttachments[0].texture.width:this._options.depthAttachment.texture.width,this._height=this._options.colorAttachments?this._options.colorAttachments[0].texture.height:this._options.depthAttachment.texture.height,this._options.colorAttachments&&this._options.colorAttachments.findIndex((t=>t.texture.width!==this._width||t.texture.height!==this._height))>=0||this._options.depthAttachment&&(this._options.depthAttachment.texture.width!==this._width||this._options.depthAttachment.texture.height!==this._height))throw new Error("WebGPUFramebuffer(): attachment textures must have same width and height");this._bindFlag=0,this._msaaColorTextures=null,this._msaaDepthTexture=null;const r=this._options.colorAttachments?.map((t=>t.texture.format)).join(":")??"",n=this._options.depthAttachment?.texture.format??"";this._hash=`${r}-${n}-${this._options.sampleCount??1}`,this._init()}getOptions(){return this._options}get bindFlag(){return this._bindFlag}getHash(){return this._hash}getWidth(){const t=this._options.colorAttachments?.[0]??this._options.depthAttachment;return t?Math.max(t.texture.width>>t.level,1):0}getHeight(){const t=this._options.colorAttachments?.[0]??this._options.depthAttachment;return t?Math.max(t.texture.height>>t.level,1):0}async restore(){if(this._options?.depthAttachment?.texture?.disposed&&await this._options.depthAttachment.texture.reload(),this._options?.colorAttachments)for(const t of this._options.colorAttachments)t?.texture?.disposed&&await t.texture.reload();this._device.isContextLost()||this._init()}destroy(){if(this._object=null,this._msaaColorTextures){for(const t of this._msaaColorTextures)t.destroy();this._msaaColorTextures=null}this._msaaDepthTexture&&(this._msaaDepthTexture.destroy(),this._msaaDepthTexture=null)}setColorAttachmentGenerateMipmaps(t,e){const i=this._options.colorAttachments?.[t];i&&(i.generateMipmaps=!!e)}setColorAttachmentCubeFace(t,e){const i=this._options.colorAttachments?.[t];i&&i.face!==e&&(i.face=e,this._bindFlag++)}setColorAttachmentMipLevel(t,e){const i=this._options.colorAttachments?.[t];i&&i.level!==e&&(i.level=e,this._bindFlag++)}setColorAttachmentLayer(t,e){const i=this._options.colorAttachments?.[t];i&&i.layer!==e&&(i.layer=e,this._bindFlag++)}setDepthAttachmentCubeFace(t){const e=this._options.depthAttachment;e&&e.face!==t&&(e.face=t,this._bindFlag++)}setDepthAttachmentLayer(t){const e=this._options.depthAttachment;e&&e.layer!==t&&(e.layer=t,this._bindFlag++)}getDepthAttachment(){return this._options?.depthAttachment?.texture||null}getColorAttachments(){return this._options?.colorAttachments?.map((t=>t?.texture||null))||[]}getMSAADepthAttachment(){return this._msaaDepthTexture}getMSAAColorAttacments(){return this._msaaColorTextures}getColorFormats(){return this._options?.colorAttachments?.map((t=>(t?.texture)?.gpuFormat||null))}getDepthFormat(){return(this._options.depthAttachment?.texture)?.gpuFormat||null}bind(){throw new Error("no bind operatation for WebGPU")}unbind(){throw new Error("no unbind operatation for WebGPU")}_init(){if(this._options.sampleCount>1){this._msaaColorTextures=[];for(const t of this._options.colorAttachments){const e=this.device.gpuCreateTexture({size:{width:this._width,height:this._height,depthOrArrayLayers:1},format:t.texture.gpuFormat,mipLevelCount:1,sampleCount:this._options.sampleCount,dimension:"2d",usage:GPUTextureUsage.COPY_SRC|GPUTextureUsage.RENDER_ATTACHMENT});this._msaaColorTextures.push(e)}if(this._options.depthAttachment){const t=this.device.gpuCreateTexture({size:{width:this._width,height:this._height,depthOrArrayLayers:1},format:this._options.depthAttachment.texture.gpuFormat,mipLevelCount:1,sampleCount:this._options.sampleCount,dimension:"2d",usage:GPUTextureUsage.COPY_SRC|GPUTextureUsage.RENDER_ATTACHMENT});this._msaaDepthTexture=t}}this._object={}}isFramebuffer(){return!0}getSampleCount(){return this._options.sampleCount}}const pc=te.getCachedTypeInfo(Bt.U16),mc=te.getCachedTypeInfo(Bt.U32);class fc extends eu{indexType;length;constructor(t,e,i){if(!(e instanceof Uint16Array||e instanceof Uint32Array))throw new Error("invalid index data");super(t,Ls.BF_INDEX|i,e),this.indexType=e instanceof Uint16Array?pc:mc,this.length=e.length}}class _c{_device;_bindGroupLayoutCache;constructor(t){this._device=t,this._bindGroupLayoutCache={}}fetchBindGroupLayout(t){const e=t?this.getLayoutHash(t):"";let i=this._bindGroupLayoutCache[e];if(!i){if(i=this.createBindGroupLayout(t),!i)throw new Error(`fetchBindGroupLayout() failed: hash: ${e}`);this._bindGroupLayoutCache[e]=i}return i}getLayoutHash(t){let e="";for(const i of t.entries){let t=`${i.binding}:${i.visibility}:`;i.buffer?t+=`b:${i.buffer.type}:${i.buffer.hasDynamicOffset}:${i.buffer.minBindingSize}`:i.sampler?t+=`s${i.sampler.type}:`:i.texture?t+=`t${i.texture.sampleType}-${i.texture.viewDimension}-${Number(!!i.texture.multisampled)}:`:i.storageTexture?t+=`k${i.storageTexture.access}-${i.storageTexture.format}-${i.storageTexture.viewDimension}:`:i.externalTexture&&(t+="v:"),e=`${e} ${t}`}return e}createBindGroupLayout(t){const e={entries:t?.entries.map((t=>{const e=t.binding,i=(t.visibility&Et.Vertex?GPUShaderStage.VERTEX:0)|(t.visibility&Et.Fragment?GPUShaderStage.FRAGMENT:0)|(t.visibility&Et.Compute?GPUShaderStage.COMPUTE:0),s=t.buffer?{type:t.buffer.type,hasDynamicOffset:t.buffer.hasDynamicOffset,minBindingSize:Number(t.buffer.minBindingSize)||0}:void 0,r=t.sampler?{type:t.sampler.type}:void 0,n=t.texture?{sampleType:t.texture.sampleType,viewDimension:t.texture.viewDimension}:void 0,a=t.storageTexture?{access:"write-only",viewDimension:"2d",format:ku[t.storageTexture.format]}:void 0,o=t.externalTexture?{}:void 0,h={binding:e,visibility:i};return s?h.buffer=s:r?h.sampler=r:n?h.texture=n:a?h.storageTexture=a:o&&(h.externalTexture=o),h}))||[]};return t?.label&&(e.label=t.label),[e,this._device.device.createBindGroupLayout(e)]}}class gc{_layouts;constructor(){this._layouts={}}fetchVertexLayout(t){let e=this._layouts[t];return e||(e=[],t.split(":").forEach((t=>{const i=t.split("-"),s={arrayStride:Number(i[0]),stepMode:Number(i[1])?"instance":"vertex",attributes:[]};for(let t=2;t<i.length;t+=3)s.attributes.push({format:Gu[i[t]],offset:Number(i[t+1]),shaderLocation:Number(i[t+2])});e.push(s)})),this._layouts[t]=e),e}}class xc extends Ql{_options;constructor(t,e){super(t),this._options=Object.assign({addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:"nearest",minFilter:"nearest",mipFilter:"none",lodMin:0,lodMax:32,compare:null,maxAnisotropy:1},e||{}),this._load()}get hash(){return this._object?this._device.gpuGetObjectHash(this._object):0}get addressModeU(){return this._options.addressU}get addressModeV(){return this._options.addressV}get addressModeW(){return this._options.addressW}get magFilter(){return this._options.magFilter}get minFilter(){return this._options.minFilter}get mipFilter(){return this._options.mipFilter}get lodMin(){return this._options.lodMin}get lodMax(){return this._options.lodMax}get compare(){return this._options.compare}get maxAnisotropy(){return this._options.maxAnisotropy}destroy(){this._object=null}async restore(){this._device.isContextLost()||this._load()}_load(){return this._object=this._device.gpuCreateSampler({addressModeU:Iu[this._options.addressU],addressModeV:Iu[this._options.addressV],addressModeW:Iu[this._options.addressW],magFilter:Du[this._options.magFilter],minFilter:Du[this._options.minFilter],mipmapFilter:Du[this._options.mipFilter],lodMinClamp:this._options.lodMin,lodMaxClamp:this._options.lodMax,compare:$u[this._options.compare]||void 0,maxAnisotropy:this._options.maxAnisotropy}),!!this._object}isSampler(){return!0}}class bc{static _clearPrograms={};static _clearBindGroup=null;static _clearStateSet=null;static _defaultClearColor=new T(0,0,0,1);static drawClearQuad(t,e,i,s){this._clearBindGroup||this.initClearQuad(t);const r=t.getFrameBufferInfo().clearHash,n=this.getClearProgram(t.getDevice(),r),a=!!e,o=!(null==i),h=!(null==s);n.bindGroup.setValue("clearDepth",i??1),n.bindGroup.setValue("clearColor",e??this._defaultClearColor),this._clearStateSet.useDepthState().enableWrite(o),this._clearStateSet.useColorState().setColorMask(a,a,a,a),this._clearStateSet.useStencilState().enable(h).setReference(h?s:0),t.getDevice().commandQueue.draw(n.program,null,this._clearStateSet,[n.bindGroup],null,"triangle-strip",0,4,1)}static getClearProgram(t,e){let i=this._clearPrograms[e];if(!i){const s=e.split(""),r=t.buildRenderProgram({label:`ClearQuad-${e}`,vertex(t){this.clearDepth=t.float().uniform(0),this.coords=[t.vec2(-1,1),t.vec2(1,1),t.vec2(-1,-1),t.vec2(1,-1)],t.main((function(){this.$builtins.position=t.vec4(this.coords.at(this.$builtins.vertexIndex),this.clearDepth,1)}))},fragment(t){if(this.clearColor=t.vec4().uniform(0),0===s.length)this.$outputs.outColor=t.vec4(),t.main((function(){this.$outputs.outColor=this.clearColor}));else{for(let e=0;e<s.length;e++)this.$outputs[`outColor${e}`]="f"===s[e]?t.vec4():"i"===s[e]?t.ivec4():t.uvec4();t.main((function(){for(let e=0;e<s.length;e++)this.$outputs[`outColor${e}`]="f"===s[e]?this.clearColor:"i"===s[e]?t.ivec4(this.clearColor):t.uvec4(this.clearColor)}))}}});i={program:r,bindGroup:t.createBindGroup(r.bindGroupLayouts[0])},this._clearPrograms[e]=i}return i}static initClearQuad(t){this._clearStateSet=t.getDevice().createRenderStateSet(),this._clearStateSet.useDepthState().enableTest(!1),this._clearStateSet.useRasterizerState().setCullMode("none"),this._clearStateSet.useStencilState().enable(!0).setFrontOp("replace","replace","replace").setBackOp("replace","replace","replace").setFrontCompareFunc("always").setBackCompareFunc("always")}}class wc{static _frameBufferInfo=null;static _mipmapGenerationProgram=null;static _mipmapGenerationBindGroup=new WeakMap;static _mipmapGenerationStateSet=null;static generateMipmap(t,e,i){if(!e.isRenderable())return;this._mipmapGenerationProgram||this.initMipmapGeneration(t);const s=i??t.device.createCommandEncoder(),r=e.mipLevelCount,n=e.isTextureCube()?6:e.isTexture2DArray()?e.depth:1;e.setMipmapDirty(!1);for(let i=0;i<n;i++)for(let n=1;n<r;n++)this.generateMiplevel(t,s,e,e.object,e.gpuFormat,n,n,i);i||t.device.queue.submit([s.finish()])}static generateMipmapsForBindGroups(t,e){for(const i of e)if(i)for(const e of i.textureList)!e.disposed&&e.isMipmapDirty()&&wc.generateMipmap(t,e)}static generateMiplevel(t,e,i,s,r,n,a,o){const h=this.beginMipmapGenerationPass(e,s,r,n,o);h.setBindGroup(0,this.getMipmapGenerationBindGroup(t,i,a,o).bindGroup);const l=t.pipelineCache.fetchRenderPipeline(this._mipmapGenerationProgram,null,this._mipmapGenerationStateSet,"triangle-strip",this._frameBufferInfo);l&&(h.setPipeline(l),h.draw(4,1,0)),h.end()}static beginMipmapGenerationPass(t,e,i,s,r){const n={colorAttachments:[{view:e.createView({dimension:"2d",baseMipLevel:s||0,mipLevelCount:1,baseArrayLayer:r||0,arrayLayerCount:1}),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}]};this._frameBufferInfo={colorFormats:[i],depthFormat:null,sampleCount:1,hash:null,clearHash:null},this._frameBufferInfo.hash=`${this._frameBufferInfo.colorFormats.join("-")}:${this._frameBufferInfo.depthFormat}:${this._frameBufferInfo.sampleCount}`;const a=t.beginRenderPass(n);return a.insertDebugMarker("MipmapGeneration"),a}static getMipmapGenerationBindGroup(t,e,i,s){let r=this._mipmapGenerationBindGroup.get(e);r||(r=[],this._mipmapGenerationBindGroup.set(e,r));let n=r[s];n||(n=[],r[s]=n);let a=n[i];return a||(a=t.createBindGroup(this._mipmapGenerationProgram.bindGroupLayouts[0]),a.setTextureView("tex",e,i-1,s,1),n[i]=a),a}static initMipmapGeneration(t){this._mipmapGenerationProgram=t.buildRenderProgram({label:"MipmapGeneration",vertex(t){this.$outputs.outUV=t.vec2(),this.coords=[t.vec2(-1,1),t.vec2(1,1),t.vec2(-1,-1),t.vec2(1,-1)],this.uv=[t.vec2(0,0),t.vec2(1,0),t.vec2(0,1),t.vec2(1,1)],t.main((function(){this.$builtins.position=t.vec4(this.coords.at(this.$builtins.vertexIndex),0,1),this.$outputs.outUV=this.uv.at(this.$builtins.vertexIndex)}))},fragment(t){this.$outputs.color=t.vec4(),this.tex=t.tex2D().uniform(0),t.main((function(){this.$outputs.color=t.textureSampleLevel(this.tex,this.$inputs.outUV,0)}))}}),this._mipmapGenerationStateSet=t.createRenderStateSet(),this._mipmapGenerationStateSet.useDepthState().enableTest(!1).enableWrite(!1),this._mipmapGenerationStateSet.useRasterizerState().setCullMode("none")}}const Tc=te.getCachedTypeInfo(Bt.U16);class vc{_device;_renderCommandEncoder;_renderPassEncoder;_fbBindFlag;_currentViewport;_currentScissor;_frameBufferInfo;constructor(t){this._device=t,this._renderCommandEncoder=this._device.device.createCommandEncoder(),this._renderPassEncoder=null,this._fbBindFlag=null,this._currentViewport=null,this._currentScissor=null,this._frameBufferInfo=this.createFrameBufferInfo(null)}get active(){return!!this._renderPassEncoder}createFrameBufferInfo(t){const e=t?{frameBuffer:t,colorFormats:t.getColorAttachments().map((t=>t.gpuFormat)),depthFormat:t.getDepthAttachment()?.gpuFormat,sampleCount:t.getOptions().sampleCount,hash:null,clearHash:t.getColorAttachments().map((t=>{const e=Vu[t.gpuFormat];return gt(e)?xt(e)?"i":"u":"f"})).join("")}:{frameBuffer:null,colorFormats:[this._device.backbufferFormat],depthFormat:this._device.backbufferDepthFormat,sampleCount:this._device.sampleCount,hash:null,clearHash:"f"};return e.hash=`${e.colorFormats.join("-")}:${e.depthFormat}:${e.sampleCount}`,e}setFramebuffer(t){this._frameBufferInfo.frameBuffer!==t&&(this.end(),this._frameBufferInfo=this.createFrameBufferInfo(t),this.setViewport(null),this.setScissor(null))}getFramebuffer(){return this._frameBufferInfo.frameBuffer}setViewport(t){!t||!Array.isArray(t)&&t.default?this._currentViewport={x:0,y:0,width:this._device.deviceToScreen(this._device.drawingBufferWidth),height:this._device.deviceToScreen(this._device.drawingBufferHeight),default:!0}:Array.isArray(t)?this._currentViewport={x:t[0],y:t[1],width:t[2],height:t[3],default:!1}:this._currentViewport=Object.assign({default:!1},t);const e=this._device.screenToDevice(this._currentViewport.x),i=this._device.screenToDevice(this._currentViewport.y),s=this._device.screenToDevice(this._currentViewport.width),r=this._device.screenToDevice(this._currentViewport.height);(e<0||i<0||s>this._device.drawingBufferWidth||r>this._device.drawingBufferHeight)&&console.log(`** VIEWPORT ERROR **: (${e}, ${i}, ${s}, ${r}) => (0, 0, ${this._device.drawingBufferWidth}, ${this._device.drawingBufferHeight})`),this._renderPassEncoder&&this._renderPassEncoder.setViewport(e,this._device.drawingBufferHeight-i-r,s,r,0,1)}getViewport(){return Object.assign({},this._currentViewport)}setScissor(t){const e=this._device.deviceToScreen(this._device.drawingBufferWidth),i=this._device.deviceToScreen(this._device.drawingBufferHeight);null==t||!Array.isArray(t)&&t.default?this._currentScissor={x:0,y:0,width:e,height:i,default:!0}:Array.isArray(t)?this._currentScissor={x:t[0],y:t[1],width:t[2],height:t[3],default:!1}:this._currentScissor=Object.assign({default:!1},t);let s=this._device.screenToDevice(this._currentScissor.x),r=this._device.screenToDevice(this._currentScissor.y),n=this._device.screenToDevice(this._currentScissor.width),a=this._device.screenToDevice(this._currentScissor.height);s<0&&(n+=s,s=0),r<0&&(a+=r,r=0),n=Math.min(this._device.screenToDevice(e)-s,n),a=Math.min(this._device.screenToDevice(i)-r,a),(n<0||a<0)&&(s=0,r=0,n=0,a=0),this._renderPassEncoder&&this._renderPassEncoder.setScissorRect(s,this._device.drawingBufferHeight-r-a,n,a)}getScissor(){return Object.assign({},this._currentScissor)}executeRenderBundle(t){this.active||this.begin(),this._renderPassEncoder.executeBundles([t])}draw(t,e,i,s,r,n,a,o,h){const l=this.validateDraw(t,s);2&l||(1&l&&this.end(),this.active||this.begin(),this.drawInternal(this._renderPassEncoder,t,e,i,s,r,n,a,o,h))}clear(t,e,i){this._currentScissor?(this._renderPassEncoder||this.begin(),this._renderPassEncoder.insertDebugMarker("clear"),bc.drawClearQuad(this,t,e,i),this._renderPassEncoder.insertDebugMarker("end clear")):(this.end(),this.begin(t,e,i))}getDevice(){return this._device}getFrameBufferInfo(){return this._frameBufferInfo}begin(t,e,i){if(this.active)return void console.error("WebGPURenderPass.begin() failed: begin() has already been called");this._renderCommandEncoder=this._device.device.createCommandEncoder();const s=this._frameBufferInfo.frameBuffer;if(s){const r=s.getDepthAttachment();let n;if(r){r._markAsCurrentFB(!0);const t=s.getOptions().depthAttachment,e=r.isTexture2DArray()||r.isTexture3D()?t.layer:r.isTextureCube()?t.face:0;n=r.getView(0,e??0,1)}this._fbBindFlag=s.bindFlag;const a={label:`customRenderPass:${this._frameBufferInfo.hash}`,colorAttachments:s.getOptions().colorAttachments?.map(((e,i)=>{const r=e.texture;if(r){r._markAsCurrentFB(!0);const n=r.isTexture2DArray()||r.isTexture3D()?e.layer:r.isTextureCube()?e.face:0;if(1===s.getOptions().sampleCount)return{view:r.getView(e.level??0,n??0,1),loadOp:t?"clear":"load",clearValue:t,storeOp:"store"};{const a=s.getMSAAColorAttacments()[i];return{view:this._device.gpuCreateTextureView(a,{dimension:"2d",baseMipLevel:e.level??0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}),resolveTarget:r.getView(e.level??0,n??0,1),loadOp:t?"clear":"load",clearValue:t,storeOp:"store"}}}return null}))??[],depthStencilAttachment:r?1===s.getOptions().sampleCount?{view:n,depthLoadOp:"number"==typeof e?"clear":"load",depthClearValue:e,depthStoreOp:"store",stencilLoadOp:ft(r.format)?"number"==typeof i?"clear":"load":void 0,stencilClearValue:i,stencilStoreOp:ft(r.format)?"store":void 0}:{view:s.getMSAADepthAttachment().createView(),depthLoadOp:"number"==typeof e?"clear":"load",depthClearValue:e,depthStoreOp:"store",stencilLoadOp:ft(r.format)?"number"==typeof i?"clear":"load":void 0,stencilClearValue:i,stencilStoreOp:ft(r.format)?"store":void 0}:void 0};this._renderPassEncoder=this._renderCommandEncoder.beginRenderPass(a)}else{const s=this._device.defaultRenderPassDesc,r=this._device.defaultRenderPassDesc.colorAttachments[0];this._frameBufferInfo.sampleCount>1?r.resolveTarget=this._device.context.getCurrentTexture().createView():r.view=this._device.context.getCurrentTexture().createView(),r.loadOp=t?"clear":"load",r.clearValue=t;const n=this._device.defaultRenderPassDesc.depthStencilAttachment;n.depthLoadOp="number"==typeof e?"clear":"load",n.depthClearValue=e,n.stencilLoadOp="number"==typeof i?"clear":"load",n.stencilClearValue=i,this._renderPassEncoder=this._renderCommandEncoder.beginRenderPass(s)}this.setViewport(this._currentViewport),this.setScissor(this._currentScissor)}end(){if(this._renderPassEncoder&&(this._renderPassEncoder.end(),this._renderPassEncoder=null),this._renderCommandEncoder&&(this._device.device.queue.submit([this._renderCommandEncoder.finish()]),this._renderCommandEncoder=null),this._frameBufferInfo.frameBuffer){const t=this._frameBufferInfo.frameBuffer.getOptions();if(t.colorAttachments)for(const e of t.colorAttachments)e.texture._markAsCurrentFB(!1),e.generateMipmaps&&e.texture.mipLevelCount>1&&e.texture.generateMipmaps();(t.depthAttachment?.texture)?._markAsCurrentFB(!1)}}capture(t,e,i,s,r,n,a,o,h,l){this.drawInternal(this._renderPassEncoder,e,i,s,r,n,a,o,h,l,t)}drawInternal(t,e,i,s,r,n,a,o,h,l,u){if(this.setBindGroupsForRender(t,e,r,n,u)){const r=this._device.pipelineCache.fetchRenderPipeline(e,i,s,a,this._frameBufferInfo);if(r){t.setPipeline(r),u?.setPipeline(r);const n=s?.stencilState;if(n&&t.setStencilReference(n.ref),i){const s=i.getLayouts(e.vertexAttributes)?.buffers;s?.forEach(((e,i)=>{t.setVertexBuffer(i,e.buffer.object,e.drawOffset),u?.setVertexBuffer(i,e.buffer.object,e.drawOffset)}));const r=i.getIndexBuffer();r?(t.setIndexBuffer(r.object,r.indexType===Tc?"uint16":"uint32"),u?.setIndexBuffer(r.object,r.indexType===Tc?"uint16":"uint32"),t.drawIndexed(h,l,o),u?.drawIndexed(h,l,o)):(t.draw(h,l,o),u?.draw(h,l,o))}else t.draw(h,l,o),u?.draw(h,l,o)}}}validateDraw(t,e){let i=0;if(e)for(let s=0;s<t.bindGroupLayouts.length;s++){const r=e[s];if(!r)return console.error(`Missing bind group (${s}) when drawing with program '${t.name}'`),2;if(r.bindGroup){for(const t of r.bufferList)t.disposed&&(i|=2);for(const t of r.textureList)t.disposed&&(i|=2),t._isMarkedAsCurrentFB()&&(console.error("bind resource texture can not be current render target"),i|=2)}}return this._frameBufferInfo.frameBuffer&&this._frameBufferInfo.frameBuffer.bindFlag!==this._fbBindFlag&&(i|=1),i}setBindGroupsForRender(t,e,i,s,r){if(i)for(let n=0;n<4;n++)if(n<e.bindGroupLayouts.length){const e=i[n].bindGroup;if(!e)return!1;const a=i[n].getDynamicOffsets()??s?.[n];a?(t.setBindGroup(n,e,a),r?.setBindGroup(n,e,a)):(t.setBindGroup(n,e),r?.setBindGroup(n,e))}else t.setBindGroup(n,this._device.emptyBindGroup),r?.setBindGroup(n,this._device.emptyBindGroup);return!0}}class yc{_device;_computeCommandEncoder;_computePassEncoder;constructor(t,e){this._device=t,this._computeCommandEncoder=this._device.device.createCommandEncoder(),this._computePassEncoder=null}get active(){return!!this._computePassEncoder}compute(t,e,i,s,r,n){if(1&this.validateCompute(t,e))return;this._computePassEncoder||this.begin(),this.setBindGroupsForCompute(this._computePassEncoder,t,e,i);const a=this._device.pipelineCache.fetchComputePipeline(t);a&&(this._computePassEncoder.setPipeline(a),this._computePassEncoder.dispatchWorkgroups(s,r,n))}setBindGroupsForCompute(t,e,i,s){if(i)for(let r=0;r<4;r++)if(r<e.bindGroupLayouts.length){const e=i[r].bindGroup;if(!e)return!1;const n=s?.[r];n?t.setBindGroup(r,e,n):t.setBindGroup(r,e)}else t.setBindGroup(r,this._device.emptyBindGroup);return!0}begin(){this.active?console.error("WebGPUComputePass.begin() failed: WebGPUComputePass.begin() has already been called"):(this._computeCommandEncoder=this._device.device.createCommandEncoder(),this._computePassEncoder=this._computeCommandEncoder.beginComputePass())}end(){this.active&&(this._computePassEncoder.end(),this._computePassEncoder=null,this._device.device.queue.submit([this._computeCommandEncoder.finish()]),this._computeCommandEncoder=null)}validateCompute(t,e){let i=0;if(e)for(let s=0;s<t.bindGroupLayouts.length;s++){const r=e[s];if(!r)return console.error(`Missing bind group (${s}) when compute with program '${t.name}'`),1;if(r.bindGroup){for(const t of r.bufferList)t.disposed&&(i|=1);for(const t of r.textureList)t.disposed&&(i|=1)}}return i}}class Ec{_renderPass;_computePass;_bufferUploads;_textureUploads;_device;_drawcallCounter;constructor(t){this._device=t,this._bufferUploads=new Map,this._textureUploads=new Map,this._renderPass=new vc(t),this._computePass=new yc(t),this._drawcallCounter=0}isBufferUploading(t){return!!this._bufferUploads.has(t)}isTextureUploading(t){return!!this._textureUploads.has(t)}flushUploads(){if(this._bufferUploads.size>0||this._textureUploads.size>0){this._drawcallCounter=0;const t=this._bufferUploads;this._bufferUploads=new Map;const e=this._textureUploads;this._textureUploads=new Map;const i=this._device.device.createCommandEncoder();t.forEach(((t,e)=>e.beginSyncChanges(i))),e.forEach(((t,e)=>{e.beginSyncChanges(i),e.isMipmapDirty()&&wc.generateMipmap(this._device,e,i)})),this._device.device.queue.submit([i.finish()]),t.forEach(((t,e)=>e.endSyncChanges())),e.forEach(((t,e)=>e.endSyncChanges())),this._renderPass.end(),this._computePass.end()}}get currentPass(){return this._renderPass.active?this._renderPass:this._computePass.active?this._computePass:null}beginFrame(){}endFrame(){this.flush()}flush(){this.flushUploads(),this._renderPass.end(),this._computePass.end()}setFramebuffer(t){this.flushUploads(),this._renderPass.setFramebuffer(t)}getFramebuffer(){return this._renderPass.getFramebuffer()}getFramebufferInfo(){return this._renderPass.getFrameBufferInfo()}executeRenderBundle(t){this._computePass.end(),this._renderPass.executeRenderBundle(t)}bufferUpload(t){this._bufferUploads.has(t)?this._drawcallCounter>this._bufferUploads.get(t)&&this.flushUploads():this._bufferUploads.set(t,this._drawcallCounter)}textureUpload(t){this._textureUploads.has(t)?this._drawcallCounter>this._textureUploads.get(t)&&this.flushUploads():this._textureUploads.set(t,this._drawcallCounter)}copyBuffer(t,e,i,s,r){this.flushUploads();const n=this._device.device.createCommandEncoder();n.copyBufferToBuffer(t.object,i,e.object,s,r),this._device.device.queue.submit([n.finish()])}compute(t,e,i,s,r,n){this._drawcallCounter++,this._renderPass.end(),this._computePass.compute(t,e,i,s,r,n)}draw(t,e,i,s,r,n,a,o,h){this._drawcallCounter++,this._computePass.end(),this._renderPass.draw(t,e,i,s,r,n,a,o,h)}capture(t,e,i,s,r,n,a,o,h,l){this._drawcallCounter++,this._computePass.end(),this._renderPass.capture(t,e,i,s,r,n,a,o,h,l)}setViewport(t){this._renderPass.setViewport(t)}getViewport(){return this._renderPass.getViewport()}setScissor(t){this._renderPass.setScissor(t)}getScissor(){return this._renderPass.getScissor()}clear(t,e,i){this._renderPass.clear(t,e,i)}finish(){return this._device.device.queue.onSubmittedWorkDone()}}class Sc extends aa{_context;_dpr;_device;_adapter;_deviceCaps;_reverseWindingOrder;_canRender;_backBufferFormat;_depthFormat;_defaultMSAAColorTexture;_defaultMSAAColorTextureView;_defaultDepthTexture;_defaultDepthTextureView;_pipelineCache;_bindGroupCache;_vertexLayoutCache;_samplerCache;_currentProgram;_currentVertexData;_currentStateSet;_currentBindGroups;_currentBindGroupOffsets;_commandQueue;_gpuObjectHashCounter;_gpuObjectHasher;_defaultRenderPassDesc;_sampleCount;_emptyBindGroup;_captureRenderBundle;_adapterInfo;constructor(t,e,i){super(e,t),this._dpr=Math.max(1,Math.floor(i?.dpr??window.devicePixelRatio)),this._device=null,this._adapter=null,this._context=null,this._reverseWindingOrder=!1,this._defaultMSAAColorTexture=null,this._defaultMSAAColorTextureView=null,this._defaultDepthTexture=null,this._defaultDepthTextureView=null,this._pipelineCache=null,this._bindGroupCache=null,this._vertexLayoutCache=null,this._currentProgram=null,this._currentVertexData=null,this._currentStateSet=null,this._currentBindGroups=[],this._currentBindGroupOffsets=[],this._defaultRenderPassDesc=null,this._sampleCount=i?.msaa?4:1,this._deviceCaps=null,this._gpuObjectHasher=new WeakMap,this._gpuObjectHashCounter=1,this._emptyBindGroup=null,this._captureRenderBundle=null,this._samplerCache=new class{_device;_samplers;constructor(t){this._device=t,this._samplers={}}fetchSampler(t){const e=this.hash(t);let i=this._samplers[e];return i||(i=this.createSampler(t),this._samplers[e]=i),i}hash(t){return`${t.addressU?String(t.addressU):""}:${t.addressV?String(t.addressV):""}:${t.addressW?String(t.addressW):""}:${t.magFilter?String(t.magFilter):""}:${t.minFilter?String(t.minFilter):""}:${t.mipFilter?String(t.mipFilter):""}:${t.lodMin?String(t.lodMin):""}:${t.lodMax?String(t.lodMax):""}:${t.compare?String(t.compare):""}:${t.maxAnisotropy?String(t.maxAnisotropy):""}`}createSampler(t){return new xc(this._device,t)}}(this),this._adapterInfo={}}get context(){return this._context}getFrameBufferSampleCount(){return this.getFramebuffer()?.getSampleCount()??this._sampleCount}get device(){return this._device}get adapter(){return this._adapter}get commandQueue(){return this._commandQueue}get drawingBufferWidth(){return this.getDrawingBufferWidth()}get drawingBufferHeight(){return this.getDrawingBufferHeight()}get clientWidth(){return this.canvas.clientWidth}get clientHeight(){return this.canvas.clientHeight}get pipelineCache(){return this._pipelineCache}get backbufferFormat(){return this._backBufferFormat}get backbufferDepthFormat(){return this._depthFormat}get defaultDepthTexture(){return this._defaultDepthTexture}get defaultDepthTextureView(){return this._defaultDepthTextureView}get defaultMSAAColorTextureView(){return this._defaultMSAAColorTextureView}get defaultRenderPassDesc(){return this._defaultRenderPassDesc}get sampleCount(){return this._sampleCount}get currentPass(){return this._commandQueue.currentPass}get emptyBindGroup(){return this._emptyBindGroup}getScale(){return this._dpr}getAdapterInfo(){return this._adapterInfo}isContextLost(){return!1}getDeviceCaps(){return this._deviceCaps}getDrawingBufferWidth(){return this.getFramebuffer()?.getWidth()||this.canvas.width}getDrawingBufferHeight(){return this.getFramebuffer()?.getHeight()||this.canvas.height}getBackBufferWidth(){return this.canvas.width}getBackBufferHeight(){return this.canvas.height}async initContext(){if(!navigator.gpu)throw new Error("No browser support for WebGPU");if(this._adapter=await navigator.gpu.requestAdapter(),!this._adapter)throw new Error("WebGPU: requestAdapter() failed");this._adapter.isFallbackAdapter&&console.warn("using a fallback adapter"),this._adapterInfo=this._adapter.requestAdapterInfo?await this._adapter.requestAdapterInfo():{},this._device=await this._adapter.requestDevice({requiredFeatures:[...this._adapter.features],requiredLimits:{...this._adapter.limits}}),console.log("WebGPU device features:");for(const t of this._device.features)console.log(` - ${t}`);if(this.device.lost.then((t=>{console.error(`WebGPU device was lost: ${t.message}`),this._canRender=!1})),this._emptyBindGroup=this.device.createBindGroup({layout:this.device.createBindGroupLayout({entries:[]}),entries:[]}),this._context=this.canvas.getContext("webgpu")||null,!this._context)throw this._canRender=!1,new Error("WebGPU: getContext() failed");this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this._deviceCaps={textureCaps:new Ju(this),framebufferCaps:new Zu(this),miscCaps:new Ku(this),shaderCaps:new Qu(this)},this.configure(),this._pipelineCache=new cc(this),this._bindGroupCache=new _c(this),this._vertexLayoutCache=new gc,this._commandQueue=new Ec(this),this._canRender=!0,this.setViewport(null),this.setScissor(null),this.on("resize",(t=>{const e=Math.max(1,Math.round(this.canvas.clientWidth*this._dpr)),i=Math.max(1,Math.round(this.canvas.clientHeight*this._dpr));e===this.canvas.width&&i===this.canvas.height||(this.canvas.width=e,this.canvas.height=i,this.createDefaultRenderAttachments(),this.setViewport(null),this.setScissor(null))})),this.dispatchEvent(new At(this.canvas.clientWidth,this.canvas.clientHeight))}nextFrame(t){return this._commandQueue.finish().then(t),0}cancelNextFrame(t){}clearFrameBuffer(t,e,i){this._commandQueue.clear(t,e,i)}createGPUTimer(){return null}createRenderStateSet(){return new oc(this)}createSampler(t){return this.fetchSampler(t)}createTextureFromMipmapData(t,e,i){if(!t)return console.error("Device.createTextureFromMipmapData() failed: invalid data"),null;if(t.isCubemap){const s=new qu(this);return s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s}if(t.isVolume){const e=new ju(this);return e.createWithMipmapData(t,this.parseTextureOptions(i)),e}if(t.isArray){const e=new Hu(this);return e.createWithMipmapData(t,this.parseTextureOptions(i)),e}{const s=new Wu(this);return s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s}}createTexture2D(t,e,i,s){const r=s?.texture??new Wu(this);return r.isTexture2D()?(r.createEmpty(t,e,i,this.parseTextureOptions(s)),r.samplerOptions=s?.samplerOptions??null,r):(console.error("createTexture2D() failed: options.texture must be 2d texture"),null)}createTexture2DFromMipmapData(t,e,i){const s=i?.texture??new Wu(this);return s.isTexture2D()?(s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createTexture2DFromMipmapData() failed: options.texture must be 2d texture"),null)}createTexture2DFromImage(t,e,i){const s=i?.texture??new Wu(this);return s.isTexture2D()?(s.loadFromElement(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createTexture2DFromImage() failed: options.texture must be 2d texture"),null)}createTexture2DArray(t,e,i,s,r){const n=r?.texture??new Hu(this);return n.isTexture2DArray()?(n.createEmpty(t,e,i,s,this.parseTextureOptions(r)),n.samplerOptions=r?.samplerOptions??null,n):(console.error("createTexture2DArray() failed: options.texture must be 2d array texture"),null)}createTexture2DArrayFromMipmapData(t,e){const i=e?.texture??new Hu(this);return i.isTexture2DArray()?(i.createWithMipmapData(t,this.parseTextureOptions(e)),i.samplerOptions=e?.samplerOptions??null,i):(console.error("createTexture2DArrayFromMipmapData() failed: options.texture must be 2d array texture"),null)}createTexture2DArrayFromImages(t,e,i){if(!t||0===t.length)return console.error("createTexture2DArrayFromImages() failed: Invalid image elements"),null;let s=0,r=0;for(const e of t)if(0===s||0===r)s=e.width,r=e.height;else if(s!==e.width||r!==e.height)return console.error("createTexture2DArrayFromImages() failed: Image elements must have the same size"),null;if(i?.texture&&!i.texture.isTexture2DArray())return console.error("createTexture2DArrayFromImages() failed: options.texture must be 2d array texture"),null;let n=i?.texture;if(n){if(n.depth!==t.length)return console.error("createTexture2DArrayFromImages() failed: Layer count of options.texture not match the given image elements"),null;if(n.width!==s||n.height!==r)return console.error("createTexture2DArrayFromImages() failed: Size of options.texture not match the given image elements"),null}else{n=this.createTexture2DArray(e?"rgba8unorm-srgb":"rgba8unorm",s,r,t.length,i);for(let e=0;e<t.length;e++)n.updateFromElement(t[e],0,0,e,0,0,s,r)}return n.samplerOptions=i?.samplerOptions??null,n}createTexture3D(t,e,i,s,r){const n=r?.texture??new ju(this);return n.isTexture3D()?(n.createEmpty(t,e,i,s,this.parseTextureOptions(r)),n.samplerOptions=r?.samplerOptions??null,n):(console.error("createTexture3D() failed: options.texture must be 3d texture"),null)}createCubeTexture(t,e,i){const s=i?.texture??new qu(this);return s.isTextureCube()?(s.createEmpty(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createCubeTexture() failed: options.texture must be cube texture"),null)}createCubeTextureFromMipmapData(t,e,i){const s=i?.texture??new qu(this);return s.isTextureCube()?(s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createCubeTextureFromMipmapData() failed: options.texture must be cube texture"),null)}createTextureVideo(t,e){const i=new Yu(this,t);return i.samplerOptions=e??null,i}createGPUProgram(t){return new Jl(this,t)}createBindGroup(t){return new Fu(this,t)}createBuffer(t,e){return new eu(this,this.parseBufferOptions(e),t)}copyBuffer(t,e,i,s,r){this._commandQueue.copyBuffer(t,e,i,s,r)}createIndexBuffer(t,e){return new fc(this,t,this.parseBufferOptions(e,"index"))}createStructuredBuffer(t,e,i){return new Ru(this,t,this.parseBufferOptions(e),i)}createVertexLayout(t){return new tc(this,t)}createFrameBuffer(t,e,i){return new dc(this,t,e,i)}setBindGroup(t,e,i){this._currentBindGroups[t]=e,this._currentBindGroupOffsets[t]=i??e?.getDynamicOffsets()??null}getBindGroup(t){return[this._currentBindGroups[t],this._currentBindGroupOffsets[t]]}setViewport(t){this._commandQueue.setViewport(t)}getViewport(){return this._commandQueue.getViewport()}setScissor(t){this._commandQueue.setScissor(t)}getScissor(){return this._commandQueue.getScissor()}setProgram(t){this._currentProgram=t}getProgram(){return this._currentProgram}setVertexLayout(t){this._currentVertexData=t}getVertexLayout(){return this._currentVertexData}setRenderStates(t){this._currentStateSet=t}getRenderStates(){return this._currentStateSet}getFramebuffer(){return this._commandQueue.getFramebuffer()??null}reverseVertexWindingOrder(t){this._reverseWindingOrder=!!t}isWindingOrderReversed(){return this._reverseWindingOrder}isBufferUploading(t){return this._commandQueue.isBufferUploading(t)}isTextureUploading(t){return this._commandQueue.isTextureUploading(t)}getFramebufferInfo(){return this._commandQueue.getFramebufferInfo()}gpuGetObjectHash(t){return this._gpuObjectHasher.get(t)}gpuCreateTexture(t){const e=this._device.createTexture(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuImportExternalTexture(t){const e=this._device.importExternalTexture({source:t});return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuCreateSampler(t){const e=this._device.createSampler(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuCreateBindGroup(t){const e=this._device.createBindGroup(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuCreateBuffer(t){const e=this._device.createBuffer(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuCreateTextureView(t,e){const i=t?.createView(e);return i&&this._gpuObjectHasher.set(i,++this._gpuObjectHashCounter),i}gpuCreateRenderPipeline(t){const e=this._device.createRenderPipeline(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuCreateComputePipeline(t){const e=this._device.createComputePipeline(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}fetchVertexLayout(t){return this._vertexLayoutCache.fetchVertexLayout(t)}fetchSampler(t){return this._samplerCache.fetchSampler(t)}fetchBindGroupLayout(t){return this._bindGroupCache.fetchBindGroupLayout(t)}flush(){this._commandQueue.flush()}async readPixels(t,e,i,s,r,n){const a=this.getFramebuffer(),o=a?a.getColorAttachments()[t]?.object:this.context.getCurrentTexture(),h=a?a.getColorAttachments()[t]?.format:Vu[this._backBufferFormat];if(o&&h){const t=s*r*Tt(h),a=this.createBuffer(t,{usage:"read"});this.readPixelsToBuffer(0,e,i,s,r,a);const o=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);await a.getBufferSubData(o),a.dispose()}else console.error("readPixels() failed: no color attachment0 or unrecoganized color attachment format")}readPixelsToBuffer(t,e,i,s,r,n){const a=this.getFramebuffer(),o=a?a.getColorAttachments()[t]?.object:this.context.getCurrentTexture(),h=a?a.getColorAttachments()[t]?.format:Vu[this._backBufferFormat],l=a?a.getColorAttachments()[t]?.width:this.getDrawingBufferWidth(),u=a?a.getColorAttachments()[t]?.height:this.getDrawingBufferHeight();o&&h?(this.flush(),Xu.copyTexturePixelsToBuffer(this._device,o,l,u,h,e,i,s,r,0,0,n)):console.error("readPixelsToBuffer() failed: no color attachment0 or unrecoganized color attachment format")}looseContext(){}restoreContext(){}beginCapture(){if(this._captureRenderBundle)throw new Error("Device.beginCapture() failed: device is already capturing draw commands");const t=this.getFramebufferInfo(),e={colorFormats:t.colorFormats,depthStencilFormat:t.depthFormat,sampleCount:t.sampleCount};this._captureRenderBundle=this._device.createRenderBundleEncoder(e)}endCapture(){if(!this._captureRenderBundle)throw new Error("Device.endCapture() failed: device is not capturing draw commands");const t=this._captureRenderBundle.finish();return this._captureRenderBundle=null,t}executeRenderBundle(t){this._commandQueue.executeRenderBundle(t)}bufferUpload(t){this._commandQueue.bufferUpload(t)}textureUpload(t){this._commandQueue.textureUpload(t)}flushUploads(){this._commandQueue.flushUploads()}_setFramebuffer(t){this._commandQueue.setFramebuffer(t)}onBeginFrame(){return!!this._canRender&&(this._commandQueue.beginFrame(),!0)}onEndFrame(){this._commandQueue.endFrame()}_draw(t,e,i){this._commandQueue.draw(this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,t,e,i,1),this._captureRenderBundle&&this._commandQueue.capture(this._captureRenderBundle,this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,t,e,i,1)}_drawInstanced(t,e,i,s){this._commandQueue.draw(this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,t,e,i,s),this._captureRenderBundle&&this._commandQueue.capture(this._captureRenderBundle,this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,t,e,i,s)}_compute(t,e,i){this._commandQueue.compute(this._currentProgram,this._currentBindGroups,this._currentBindGroupOffsets,t,e,i)}configure(){this._backBufferFormat=navigator.gpu.getPreferredCanvasFormat(),this._depthFormat=this._deviceCaps.framebufferCaps.supportDepth32floatStencil8?"depth32float-stencil8":"depth24plus-stencil8",this._context.configure({device:this._device,format:this._backBufferFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:"opaque",colorSpace:"srgb"}),this.createDefaultRenderAttachments()}createDefaultRenderAttachments(){const t=Math.max(1,this.canvas.width),e=Math.max(1,this.canvas.height);this._defaultMSAAColorTexture?.destroy(),this._defaultMSAAColorTexture=null,this._defaultMSAAColorTextureView=null,this._defaultDepthTexture?.destroy(),this._defaultDepthTexture=null,this._defaultDepthTextureView=null,this._sampleCount>1&&(this._defaultMSAAColorTexture=this.gpuCreateTexture({size:{width:t,height:e,depthOrArrayLayers:1},format:this._backBufferFormat,dimension:"2d",mipLevelCount:1,sampleCount:this._sampleCount,usage:GPUTextureUsage.RENDER_ATTACHMENT}),this._defaultMSAAColorTextureView=this._defaultMSAAColorTexture.createView()),this._defaultDepthTexture=this.gpuCreateTexture({size:{width:t,height:e,depthOrArrayLayers:1},format:this._depthFormat,dimension:"2d",mipLevelCount:1,sampleCount:this._sampleCount,usage:GPUTextureUsage.RENDER_ATTACHMENT}),this._defaultDepthTextureView=this._defaultDepthTexture.createView(),this._defaultRenderPassDesc={label:`mainRenderPass:${this._sampleCount}`,colorAttachments:[{view:this._sampleCount>1?this._defaultMSAAColorTextureView:null,resolveTarget:void 0,loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}],depthStencilAttachment:{view:this._defaultDepthTextureView,depthLoadOp:"clear",depthClearValue:1,depthStoreOp:"store",stencilLoadOp:"clear",stencilClearValue:0,stencilStoreOp:"store"}}}}const Cc={typeName:()=>"webgpu",supported:()=>!!window.GPU&&navigator.gpu instanceof window.GPU,async createDevice(t,e){try{const i=new(s(Sc)())(this,t,e);return await i.initContext(),i.setViewport(),i.setScissor(),i}catch(t){return console.error(t),null}}};var Ac;function Mc(t){return!(!t||!t.texStorage2D)}!function(t){t[t.READ_BUFFER=3074]="READ_BUFFER",t[t.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",t[t.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",t[t.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",t[t.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",t[t.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",t[t.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",t[t.COLOR=6144]="COLOR",t[t.DEPTH=6145]="DEPTH",t[t.STENCIL=6146]="STENCIL",t[t.RED=6403]="RED",t[t.RGB8=32849]="RGB8",t[t.RGBA8=32856]="RGBA8",t[t.RGB10_A2=32857]="RGB10_A2",t[t.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",t[t.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",t[t.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",t[t.TEXTURE_3D=32879]="TEXTURE_3D",t[t.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",t[t.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",t[t.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",t[t.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",t[t.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",t[t.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",t[t.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",t[t.MIN=32775]="MIN",t[t.MAX=32776]="MAX",t[t.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",t[t.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",t[t.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",t[t.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",t[t.CURRENT_QUERY=34917]="CURRENT_QUERY",t[t.QUERY_RESULT=34918]="QUERY_RESULT",t[t.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",t[t.STREAM_READ=35041]="STREAM_READ",t[t.STREAM_COPY=35042]="STREAM_COPY",t[t.STATIC_READ=35045]="STATIC_READ",t[t.STATIC_COPY=35046]="STATIC_COPY",t[t.DYNAMIC_READ=35049]="DYNAMIC_READ",t[t.DYNAMIC_COPY=35050]="DYNAMIC_COPY",t[t.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",t[t.DRAW_BUFFER0=34853]="DRAW_BUFFER0",t[t.DRAW_BUFFER1=34854]="DRAW_BUFFER1",t[t.DRAW_BUFFER2=34855]="DRAW_BUFFER2",t[t.DRAW_BUFFER3=34856]="DRAW_BUFFER3",t[t.DRAW_BUFFER4=34857]="DRAW_BUFFER4",t[t.DRAW_BUFFER5=34858]="DRAW_BUFFER5",t[t.DRAW_BUFFER6=34859]="DRAW_BUFFER6",t[t.DRAW_BUFFER7=34860]="DRAW_BUFFER7",t[t.DRAW_BUFFER8=34861]="DRAW_BUFFER8",t[t.DRAW_BUFFER9=34862]="DRAW_BUFFER9",t[t.DRAW_BUFFER10=34863]="DRAW_BUFFER10",t[t.DRAW_BUFFER11=34864]="DRAW_BUFFER11",t[t.DRAW_BUFFER12=34865]="DRAW_BUFFER12",t[t.DRAW_BUFFER13=34866]="DRAW_BUFFER13",t[t.DRAW_BUFFER14=34867]="DRAW_BUFFER14",t[t.DRAW_BUFFER15=34868]="DRAW_BUFFER15",t[t.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",t[t.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",t[t.SAMPLER_3D=35679]="SAMPLER_3D",t[t.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",t[t.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",t[t.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",t[t.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",t[t.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",t[t.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",t[t.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",t[t.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",t[t.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",t[t.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",t[t.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",t[t.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",t[t.SRGB=35904]="SRGB",t[t.SRGB8=35905]="SRGB8",t[t.SRGB_ALPHA=35906]="SRGB_ALPHA",t[t.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",t[t.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",t[t.RGBA32F=34836]="RGBA32F",t[t.RGB32F=34837]="RGB32F",t[t.RGBA16F=34842]="RGBA16F",t[t.RGB16F=34843]="RGB16F",t[t.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",t[t.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",t[t.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",t[t.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",t[t.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",t[t.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",t[t.R11F_G11F_B10F=35898]="R11F_G11F_B10F",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.RGB9_E5=35901]="RGB9_E5",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",t[t.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",t[t.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",t[t.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",t[t.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",t[t.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",t[t.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",t[t.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",t[t.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",t[t.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",t[t.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",t[t.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",t[t.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",t[t.RGBA32UI=36208]="RGBA32UI",t[t.RGB32UI=36209]="RGB32UI",t[t.RGBA16UI=36214]="RGBA16UI",t[t.RGB16UI=36215]="RGB16UI",t[t.RGBA8UI=36220]="RGBA8UI",t[t.RGB8UI=36221]="RGB8UI",t[t.RGBA32I=36226]="RGBA32I",t[t.RGB32I=36227]="RGB32I",t[t.RGBA16I=36232]="RGBA16I",t[t.RGB16I=36233]="RGB16I",t[t.RGBA8I=36238]="RGBA8I",t[t.RGB8I=36239]="RGB8I",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",t[t.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",t[t.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",t[t.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",t[t.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",t[t.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",t[t.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",t[t.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",t[t.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",t[t.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",t[t.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",t[t.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",t[t.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",t[t.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",t[t.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",t[t.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",t[t.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",t[t.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",t[t.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",t[t.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",t[t.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",t[t.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",t[t.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",t[t.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",t[t.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",t[t.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",t[t.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",t[t.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",t[t.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",t[t.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",t[t.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",t[t.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",t[t.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",t[t.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",t[t.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",t[t.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",t[t.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",t[t.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",t[t.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",t[t.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",t[t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",t[t.MAX_SAMPLES=36183]="MAX_SAMPLES",t[t.HALF_FLOAT=5131]="HALF_FLOAT",t[t.RG=33319]="RG",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.R8=33321]="R8",t[t.RG8=33323]="RG8",t[t.R16F=33325]="R16F",t[t.R32F=33326]="R32F",t[t.RG16F=33327]="RG16F",t[t.RG32F=33328]="RG32F",t[t.R8I=33329]="R8I",t[t.R8UI=33330]="R8UI",t[t.R16I=33331]="R16I",t[t.R16UI=33332]="R16UI",t[t.R32I=33333]="R32I",t[t.R32UI=33334]="R32UI",t[t.RG8I=33335]="RG8I",t[t.RG8UI=33336]="RG8UI",t[t.RG16I=33337]="RG16I",t[t.RG16UI=33338]="RG16UI",t[t.RG32I=33339]="RG32I",t[t.RG32UI=33340]="RG32UI",t[t.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",t[t.R8_SNORM=36756]="R8_SNORM",t[t.RG8_SNORM=36757]="RG8_SNORM",t[t.RGB8_SNORM=36758]="RGB8_SNORM",t[t.RGBA8_SNORM=36759]="RGBA8_SNORM",t[t.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",t[t.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",t[t.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",t[t.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",t[t.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",t[t.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",t[t.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",t[t.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",t[t.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",t[t.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",t[t.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",t[t.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",t[t.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",t[t.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",t[t.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",t[t.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",t[t.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",t[t.UNIFORM_TYPE=35383]="UNIFORM_TYPE",t[t.UNIFORM_SIZE=35384]="UNIFORM_SIZE",t[t.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",t[t.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",t[t.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",t[t.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",t[t.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",t[t.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",t[t.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",t[t.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",t[t.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",t[t.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",t[t.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",t[t.INVALID_INDEX=4294967295]="INVALID_INDEX",t[t.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",t[t.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",t[t.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",t[t.OBJECT_TYPE=37138]="OBJECT_TYPE",t[t.SYNC_CONDITION=37139]="SYNC_CONDITION",t[t.SYNC_STATUS=37140]="SYNC_STATUS",t[t.SYNC_FLAGS=37141]="SYNC_FLAGS",t[t.SYNC_FENCE=37142]="SYNC_FENCE",t[t.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",t[t.UNSIGNALED=37144]="UNSIGNALED",t[t.SIGNALED=37145]="SIGNALED",t[t.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",t[t.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",t[t.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",t[t.WAIT_FAILED=37149]="WAIT_FAILED",t[t.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",t[t.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",t[t.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",t[t.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",t[t.SAMPLER_BINDING=35097]="SAMPLER_BINDING",t[t.RGB10_A2UI=36975]="RGB10_A2UI",t[t.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",t[t.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",t[t.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",t[t.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",t[t.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",t[t.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",t[t.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",t[t.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",t[t.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",t[t.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",t[t.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",t[t.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN",t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_COLOR=768]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",t[t.SRC_ALPHA=770]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=772]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",t[t.DST_COLOR=774]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",t[t.FUNC_ADD=32774]="FUNC_ADD",t[t.FUNC_MIN=32775]="FUNC_MIN",t[t.FUNC_MAX=32776]="FUNC_MAX",t[t.BLEND_EQUATION=32777]="BLEND_EQUATION",t[t.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",t[t.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",t[t.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",t[t.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",t[t.BLEND_DST_RGB=32968]="BLEND_DST_RGB",t[t.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",t[t.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",t[t.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",t[t.CONSTANT_COLOR=32769]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",t[t.BLEND_COLOR=32773]="BLEND_COLOR",t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",t[t.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",t[t.STREAM_DRAW=35040]="STREAM_DRAW",t[t.STATIC_DRAW=35044]="STATIC_DRAW",t[t.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",t[t.BUFFER_SIZE=34660]="BUFFER_SIZE",t[t.BUFFER_USAGE=34661]="BUFFER_USAGE",t[t.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK",t[t.FRONT_AND_BACK=1032]="FRONT_AND_BACK",t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.CULL_FACE=2884]="CULL_FACE",t[t.BLEND=3042]="BLEND",t[t.DITHER=3024]="DITHER",t[t.STENCIL_TEST=2960]="STENCIL_TEST",t[t.DEPTH_TEST=2929]="DEPTH_TEST",t[t.SCISSOR_TEST=3089]="SCISSOR_TEST",t[t.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",t[t.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",t[t.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",t[t.NO_ERROR=0]="NO_ERROR",t[t.INVALID_ENUM=1280]="INVALID_ENUM",t[t.INVALID_VALUE=1281]="INVALID_VALUE",t[t.INVALID_OPERATION=1282]="INVALID_OPERATION",t[t.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",t[t.CW=2304]="CW",t[t.CCW=2305]="CCW",t[t.LINE_WIDTH=2849]="LINE_WIDTH",t[t.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",t[t.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",t[t.CULL_FACE_MODE=2885]="CULL_FACE_MODE",t[t.FRONT_FACE=2886]="FRONT_FACE",t[t.DEPTH_RANGE=2928]="DEPTH_RANGE",t[t.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",t[t.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",t[t.DEPTH_FUNC=2932]="DEPTH_FUNC",t[t.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",t[t.STENCIL_FUNC=2962]="STENCIL_FUNC",t[t.STENCIL_FAIL=2964]="STENCIL_FAIL",t[t.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",t[t.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",t[t.STENCIL_REF=2967]="STENCIL_REF",t[t.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",t[t.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",t[t.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",t[t.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",t[t.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",t[t.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",t[t.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",t[t.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",t[t.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",t[t.VIEWPORT=2978]="VIEWPORT",t[t.SCISSOR_BOX=3088]="SCISSOR_BOX",t[t.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",t[t.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",t[t.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",t[t.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",t[t.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",t[t.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",t[t.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",t[t.RED_BITS=3410]="RED_BITS",t[t.GREEN_BITS=3411]="GREEN_BITS",t[t.BLUE_BITS=3412]="BLUE_BITS",t[t.ALPHA_BITS=3413]="ALPHA_BITS",t[t.DEPTH_BITS=3414]="DEPTH_BITS",t[t.STENCIL_BITS=3415]="STENCIL_BITS",t[t.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",t[t.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",t[t.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",t[t.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",t[t.SAMPLES=32937]="SAMPLES",t[t.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",t[t.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",t[t.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",t[t.DONT_CARE=4352]="DONT_CARE",t[t.FASTEST=4353]="FASTEST",t[t.NICEST=4354]="NICEST",t[t.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.ALPHA=6406]="ALPHA",t[t.RGB=6407]="RGB",t[t.RGBA=6408]="RGBA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",t[t.VERTEX_SHADER=35633]="VERTEX_SHADER",t[t.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",t[t.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",t[t.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",t[t.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",t[t.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",t[t.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",t[t.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",t[t.SHADER_TYPE=35663]="SHADER_TYPE",t[t.DELETE_STATUS=35712]="DELETE_STATUS",t[t.LINK_STATUS=35714]="LINK_STATUS",t[t.VALIDATE_STATUS=35715]="VALIDATE_STATUS",t[t.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",t[t.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",t[t.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",t[t.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",t[t.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",t[t.NEVER=512]="NEVER",t[t.LESS=513]="LESS",t[t.EQUAL=514]="EQUAL",t[t.LEQUAL=515]="LEQUAL",t[t.GREATER=516]="GREATER",t[t.NOTEQUAL=517]="NOTEQUAL",t[t.GEQUAL=518]="GEQUAL",t[t.ALWAYS=519]="ALWAYS",t[t.KEEP=7680]="KEEP",t[t.REPLACE=7681]="REPLACE",t[t.INCR=7682]="INCR",t[t.DECR=7683]="DECR",t[t.INVERT=5386]="INVERT",t[t.INCR_WRAP=34055]="INCR_WRAP",t[t.DECR_WRAP=34056]="DECR_WRAP",t[t.VENDOR=7936]="VENDOR",t[t.RENDERER=7937]="RENDERER",t[t.VERSION=7938]="VERSION",t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9729]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",t[t.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",t[t.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",t[t.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",t[t.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",t[t.TEXTURE=5890]="TEXTURE",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",t[t.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",t[t.TEXTURE0=33984]="TEXTURE0",t[t.TEXTURE1=33985]="TEXTURE1",t[t.TEXTURE2=33986]="TEXTURE2",t[t.TEXTURE3=33987]="TEXTURE3",t[t.TEXTURE4=33988]="TEXTURE4",t[t.TEXTURE5=33989]="TEXTURE5",t[t.TEXTURE6=33990]="TEXTURE6",t[t.TEXTURE7=33991]="TEXTURE7",t[t.TEXTURE8=33992]="TEXTURE8",t[t.TEXTURE9=33993]="TEXTURE9",t[t.TEXTURE10=33994]="TEXTURE10",t[t.TEXTURE11=33995]="TEXTURE11",t[t.TEXTURE12=33996]="TEXTURE12",t[t.TEXTURE13=33997]="TEXTURE13",t[t.TEXTURE14=33998]="TEXTURE14",t[t.TEXTURE15=33999]="TEXTURE15",t[t.TEXTURE16=34e3]="TEXTURE16",t[t.TEXTURE17=34001]="TEXTURE17",t[t.TEXTURE18=34002]="TEXTURE18",t[t.TEXTURE19=34003]="TEXTURE19",t[t.TEXTURE20=34004]="TEXTURE20",t[t.TEXTURE21=34005]="TEXTURE21",t[t.TEXTURE22=34006]="TEXTURE22",t[t.TEXTURE23=34007]="TEXTURE23",t[t.TEXTURE24=34008]="TEXTURE24",t[t.TEXTURE25=34009]="TEXTURE25",t[t.TEXTURE26=34010]="TEXTURE26",t[t.TEXTURE27=34011]="TEXTURE27",t[t.TEXTURE28=34012]="TEXTURE28",t[t.TEXTURE29=34013]="TEXTURE29",t[t.TEXTURE30=34014]="TEXTURE30",t[t.TEXTURE31=34015]="TEXTURE31",t[t.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",t[t.REPEAT=10497]="REPEAT",t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",t[t.FLOAT_VEC2=35664]="FLOAT_VEC2",t[t.FLOAT_VEC3=35665]="FLOAT_VEC3",t[t.FLOAT_VEC4=35666]="FLOAT_VEC4",t[t.INT_VEC2=35667]="INT_VEC2",t[t.INT_VEC3=35668]="INT_VEC3",t[t.INT_VEC4=35669]="INT_VEC4",t[t.BOOL=35670]="BOOL",t[t.BOOL_VEC2=35671]="BOOL_VEC2",t[t.BOOL_VEC3=35672]="BOOL_VEC3",t[t.BOOL_VEC4=35673]="BOOL_VEC4",t[t.FLOAT_MAT2=35674]="FLOAT_MAT2",t[t.FLOAT_MAT3=35675]="FLOAT_MAT3",t[t.FLOAT_MAT4=35676]="FLOAT_MAT4",t[t.SAMPLER_2D=35678]="SAMPLER_2D",t[t.SAMPLER_CUBE=35680]="SAMPLER_CUBE",t[t.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",t[t.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",t[t.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",t[t.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",t[t.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",t[t.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",t[t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",t[t.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",t[t.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",t[t.COMPILE_STATUS=35713]="COMPILE_STATUS",t[t.LOW_FLOAT=36336]="LOW_FLOAT",t[t.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",t[t.HIGH_FLOAT=36338]="HIGH_FLOAT",t[t.LOW_INT=36339]="LOW_INT",t[t.MEDIUM_INT=36340]="MEDIUM_INT",t[t.HIGH_INT=36341]="HIGH_INT",t[t.FRAMEBUFFER=36160]="FRAMEBUFFER",t[t.RENDERBUFFER=36161]="RENDERBUFFER",t[t.RGBA4=32854]="RGBA4",t[t.RGB5_A1=32855]="RGB5_A1",t[t.RGB565=36194]="RGB565",t[t.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",t[t.STENCIL_INDEX8=36168]="STENCIL_INDEX8",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t[t.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",t[t.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",t[t.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",t[t.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",t[t.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",t[t.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",t[t.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",t[t.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",t[t.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",t[t.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",t[t.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",t[t.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",t[t.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",t[t.NONE=0]="NONE",t[t.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",t[t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",t[t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",t[t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",t[t.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",t[t.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",t[t.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",t[t.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",t[t.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",t[t.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",t[t.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",t[t.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",t[t.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",t[t.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",t[t.TEXTURE_MAX_ANISOTROPY=34046]="TEXTURE_MAX_ANISOTROPY",t[t.MAX_TEXTURE_MAX_ANISOTROPY=34047]="MAX_TEXTURE_MAX_ANISOTROPY"}(Ac||(Ac={}));class Rc extends Error{static errorToString={[Ac.NO_ERROR]:"NO_ERROR",[Ac.INVALID_ENUM]:"INVALID_ENUM",[Ac.INVALID_VALUE]:"INVALID_VALUE",[Ac.INVALID_OPERATION]:"INVALID_OPERATION",[Ac.INVALID_FRAMEBUFFER_OPERATION]:"INVALID_FRAMEBUFFER_OPERATION",[Ac.OUT_OF_MEMORY]:"OUT_OF_MEMORY",[Ac.CONTEXT_LOST_WEBGL]:"CONTEXT_LOST_WEBGL"};code;constructor(t){super(Rc.errorToString[t]),this.code=t}}const Fc={add:Ac.FUNC_ADD,subtract:Ac.FUNC_SUBTRACT,"reverse-subtract":Ac.FUNC_REVERSE_SUBTRACT,max:Ac.FUNC_MAX,min:Ac.FUNC_MIN},Ic={[Ac.FUNC_ADD]:"add",[Ac.FUNC_SUBTRACT]:"subtract",[Ac.FUNC_REVERSE_SUBTRACT]:"reverse-subtract",[Ac.FUNC_MAX]:"max",[Ac.FUNC_MIN]:"min"},Dc={zero:Ac.ZERO,one:Ac.ONE,"src-alpha":Ac.SRC_ALPHA,"inv-src-alpha":Ac.ONE_MINUS_SRC_ALPHA,"src-alpha-saturate":Ac.BLEND,"dst-alpha":Ac.DST_ALPHA,"inv-dst-alpha":Ac.ONE_MINUS_DST_ALPHA,"src-color":Ac.SRC_COLOR,"inv-src-color":Ac.ONE_MINUS_SRC_COLOR,"dst-color":Ac.DST_COLOR,"inv-dst-color":Ac.ONE_MINUS_DST_COLOR,"const-color":Ac.CONSTANT_COLOR,"inv-const-color":Ac.ONE_MINUS_CONSTANT_COLOR,"const-alpha":Ac.CONSTANT_ALPHA,"inv-const-alpha":Ac.ONE_MINUS_CONSTANT_ALPHA},$c={[Ac.ZERO]:"zero",[Ac.ONE]:"one",[Ac.SRC_ALPHA]:"src-alpha",[Ac.ONE_MINUS_SRC_ALPHA]:"inv-src-alpha",[Ac.SRC_ALPHA_SATURATE]:"src-alpha-saturate",[Ac.DST_ALPHA]:"dst-alpha",[Ac.ONE_MINUS_DST_ALPHA]:"inv-dst-alpha",[Ac.SRC_COLOR]:"src-color",[Ac.ONE_MINUS_SRC_COLOR]:"inv-src-color",[Ac.DST_COLOR]:"dst-color",[Ac.ONE_MINUS_DST_COLOR]:"inv-dst-color",[Ac.CONSTANT_COLOR]:"const-color",[Ac.ONE_MINUS_CONSTANT_COLOR]:"inv-const-color",[Ac.CONSTANT_ALPHA]:"const-alpha",[Ac.ONE_MINUS_CONSTANT_ALPHA]:"inv-const-alpha"},Lc={none:Ac.NONE,front:Ac.FRONT,back:Ac.BACK},Pc={[Ac.NONE]:"none",[Ac.FRONT]:"front",[Ac.BACK]:"back"};Ac.CW,Ac.CCW,Ac.CW,Ac.CCW;const Nc={keep:Ac.KEEP,zero:Ac.ZERO,replace:Ac.REPLACE,incr:Ac.INCR,"incr-wrap":Ac.INCR_WRAP,decr:Ac.DECR,"decr-wrap":Ac.DECR_WRAP,invert:Ac.INVERT},Bc={[Ac.KEEP]:"keep",[Ac.ZERO]:"zero",[Ac.REPLACE]:"replace",[Ac.INCR]:"incr",[Ac.INCR_WRAP]:"incr-wrap",[Ac.DECR]:"decr",[Ac.DECR_WRAP]:"decr-wrap",[Ac.INVERT]:"invert"},Oc={always:Ac.ALWAYS,le:Ac.LEQUAL,ge:Ac.GEQUAL,lt:Ac.LESS,gt:Ac.GREATER,eq:Ac.EQUAL,ne:Ac.NOTEQUAL,never:Ac.NEVER},Uc={[Ac.NONE]:null,[Ac.ALWAYS]:"always",[Ac.LEQUAL]:"le",[Ac.GEQUAL]:"ge",[Ac.LESS]:"lt",[Ac.GREATER]:"gt",[Ac.EQUAL]:"eq",[Ac.NOTEQUAL]:"ne",[Ac.NEVER]:"never"},kc={repeat:Ac.REPEAT,"mirrored-repeat":Ac.MIRRORED_REPEAT,clamp:Ac.CLAMP_TO_EDGE},zc={[Bt.BOOL]:Ac.BOOL,[Bt.BVEC2]:Ac.BOOL_VEC2,[Bt.BVEC3]:Ac.BOOL_VEC3,[Bt.BVEC4]:Ac.BOOL_VEC4,[Bt.F32]:Ac.FLOAT,[Bt.F32VEC2]:Ac.FLOAT_VEC2,[Bt.F32VEC3]:Ac.FLOAT_VEC3,[Bt.F32VEC4]:Ac.FLOAT_VEC4,[Bt.I8]:Ac.BYTE,[Bt.I16]:Ac.SHORT,[Bt.I32]:Ac.INT,[Bt.I32VEC2]:Ac.INT_VEC2,[Bt.I32VEC3]:Ac.INT_VEC3,[Bt.I32VEC4]:Ac.INT_VEC4,[Bt.U8]:Ac.UNSIGNED_BYTE,[Bt.U8_NORM]:Ac.UNSIGNED_BYTE,[Bt.I8_NORM]:Ac.BYTE,[Bt.U16]:Ac.UNSIGNED_SHORT,[Bt.U16_NORM]:Ac.UNSIGNED_SHORT,[Bt.I16_NORM]:Ac.SHORT,[Bt.U32]:Ac.UNSIGNED_INT,[Bt.U32VEC2]:Ac.UNSIGNED_INT_VEC2,[Bt.U32VEC3]:Ac.UNSIGNED_INT_VEC3,[Bt.U32VEC4]:Ac.UNSIGNED_INT_VEC4},Vc={"triangle-list":Ac.TRIANGLES,"triangle-strip":Ac.TRIANGLE_STRIP,"triangle-fan":Ac.TRIANGLE_FAN,"line-list":Ac.LINES,"line-strip":Ac.LINE_STRIP,"point-list":Ac.POINTS},Gc={"2d":Ac.TEXTURE_2D,"3d":Ac.TEXTURE_3D,cube:Ac.TEXTURE_CUBE_MAP,"2darray":Ac.TEXTURE_2D_ARRAY},Xc={[m.PX]:Ac.TEXTURE_CUBE_MAP_POSITIVE_X,[m.NX]:Ac.TEXTURE_CUBE_MAP_NEGATIVE_X,[m.PY]:Ac.TEXTURE_CUBE_MAP_POSITIVE_Y,[m.NY]:Ac.TEXTURE_CUBE_MAP_NEGATIVE_Y,[m.PZ]:Ac.TEXTURE_CUBE_MAP_POSITIVE_Z,[m.NZ]:Ac.TEXTURE_CUBE_MAP_NEGATIVE_Z};function Wc(t){switch(t){case"nearest":return Ac.NEAREST;case"linear":return Ac.LINEAR;default:return Ac.NONE}}function Hc(t,e){switch(t){case"nearest":switch(e){case"none":return Ac.NEAREST;case"nearest":return Ac.NEAREST_MIPMAP_NEAREST;case"linear":return Ac.NEAREST_MIPMAP_LINEAR}break;case"linear":switch(e){case"none":return Ac.LINEAR;case"nearest":return Ac.LINEAR_MIPMAP_NEAREST;case"linear":return Ac.LINEAR_MIPMAP_LINEAR}}return Ac.NONE}let jc=0;class qc extends(s(Object)()){_device;_object;_uid;_cid;_name;_restoreHandler;constructor(t){super(),this._device=t,this._object=null,this._uid=++jc,this._cid=1,this._name=`${Gs(this)}#${this._uid}`,this._restoreHandler=null,this._device.addGPUObject(this)}get device(){return this._device}get object(){return this._object}get disposed(){return!this._object}get restoreHandler(){return this._restoreHandler}set restoreHandler(t){this._restoreHandler=t}get uid(){return this._uid}get cid(){return this._cid}get name(){return this._name}set name(t){if(t!==this._name){const e=new Ft(this,this._name);this._name=t,this._device.dispatchEvent(e)}}isVertexLayout(){return!1}isFramebuffer(){return!1}isSampler(){return!1}isTexture(){return!1}isTexture2D(){return!1}isTexture2DArray(){return!1}isTexture3D(){return!1}isTextureCube(){return!1}isTextureVideo(){return!1}isProgram(){return!1}isBuffer(){return!1}isBindGroup(){return!1}dispose(){this.disposed||this._device.disposeObject(this,!0)}async reload(){if(this.disposed){const t=this._device.restoreObject(this);return this._cid++,t}}destroy(){throw new Error("Abstract function call: destroy()")}async restore(){throw new Error("Abstract function call: restore()")}}class Yc extends qc{_target;_memCost;_flags;_width;_height;_depth;_format;_mipLevelCount;_samplerOptions;_webgl1fallback;constructor(t,e){super(t),this._target=e||"2d",this._memCost=0,this._flags=0,this._width=0,this._height=0,this._depth=1,this._format="unknown",this._mipLevelCount=0,this._samplerOptions=null,this._webgl1fallback=!1}get target(){return this._target}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get memCost(){return this._memCost}get format(){return this._format}get mipLevelCount(){return this._mipLevelCount}get samplerOptions(){return this._samplerOptions}set samplerOptions(t){const e=this.getTextureCaps().getTextureFormatInfo(this._format);this._samplerOptions=t?Object.assign({},this._getSamplerOptions(e,!!t.compare),t):null}get isWebGL1Fallback(){return this._webgl1fallback}isFilterable(){return!!this.getTextureCaps().getTextureFormatInfo(this._format)?.filterable&&!!(this.device.isWebGL2||h(this._width)||h(this._height))}destroy(){this._object&&(this._device.context.deleteTexture(this._object),this._device.invalidateBindingTextures(),this._object=null,this._device.updateVideoMemoryCost(-this._memCost),this._memCost=0)}async restore(){this._object||this._device.isContextLost()||this.init()}isTexture(){return!0}getTextureCaps(){return this._device.getDeviceCaps().textureCaps}isSRGBFormat(){return wt(this._format)}isFloatFormat(){return _t(this._format)}isIntegerFormat(){return gt(this._format)}isSignedFormat(){return xt(this._format)}isCompressedFormat(){return bt(this._format)}isDepth(){return mt(this._format)}getDefaultSampler(t){const e=this.getTextureCaps().getTextureFormatInfo(this._format);return this._device.createSampler(this._samplerOptions&&!this._samplerOptions.compare==!t?this._samplerOptions:this._getSamplerOptions(e,t))}allocInternal(t,e,i,s,r){if(this._device.isWebGL2||h(e)&&h(i)?this._webgl1fallback=!1:(r=1,this._webgl1fallback=!0),this._device.setCurrentSamplerForTexture(this,null),0===r)r=this._calcMipLevelCount(t,e,i,s);else if(1!==r){let t=Math.max(e,i);this.isTexture3D()&&(t=Math.max(t,s));const n=Math.floor(Math.log2(t))+1;(!Number.isInteger(r)||r<0||r>n)&&(r=n)}if(this._object&&(this._format!==t||this._width!==e||this._height!==i||this._depth,this._mipLevelCount!==r)){const t=this._object;this._device.runNextFrame((()=>{this._device.context.deleteTexture(t),this._device.invalidateBindingTextures()})),this._object=null}if(!this._object&&(this._format=t,this._width=e,this._height=i,this._depth=s,this._mipLevelCount=r,!this._device.isContextLost())){this._object=this._device.context.createTexture();const t=this._device.context;this._device.bindTexture(Gc[this._target],0,this);const e=this.getTextureCaps().getTextureFormatInfo(this._format);if(Mc(t)&&!this.isTextureVideo())this.isTexture3D()||this.isTexture2DArray()?t.texStorage3D(Gc[this._target],this._mipLevelCount,e.glInternalFormat,this._width,this._height,this._depth):t.texStorage2D(Gc[this._target],this._mipLevelCount,e.glInternalFormat,this._width,this._height),this._device.context.texParameteri(Gc[this._target],Ac.TEXTURE_BASE_LEVEL,0),this._device.context.texParameteri(Gc[this._target],Ac.TEXTURE_MAX_LEVEL,this._mipLevelCount-1);else{let t=this._width,i=this._height;const s=bt(this._format),n=vt(this._format),a=yt(this._format),o=Tt(this._format);for(let h=0;h<r;h++){const r=s?new Uint8Array(Math.ceil(t/n)*Math.ceil(i/a)*o):null;if(r?.fill(255),this.isTextureCube())for(let n=0;n<6;n++){const a=Xc[n];s?this._device.context.compressedTexImage2D(a,h,e.glInternalFormat,t,i,0,r):this._device.context.texImage2D(a,h,e.glInternalFormat,t,i,0,e.glFormat,e.glType[0],null)}else s?this._device.context.compressedTexImage2D(Gc[this._target],h,e.glInternalFormat,t,i,0,r):this._device.context.texImage2D(Gc[this._target],h,e.glInternalFormat,t,i,0,e.glFormat,e.glType[0],null);t=Math.max(t>>1,1),i=Math.max(i>>1,1)}}const i=this.isTextureCube()?6:1,s=this.getTextureCaps().calcMemoryUsage(this._format,e.glType[0],this._width*this._height*this._depth*i);this._device.updateVideoMemoryCost(s-this._memCost),this._memCost=s}}_calcMipLevelCount(t,e,i,s){if(mt(t)||this.isTextureVideo())return 1;if(this._flags&Ls.TF_NO_MIPMAP)return 1;if(!(this._device.isWebGL2||h(e)&&h(i)))return 1;const r=this.getTextureCaps().getTextureFormatInfo(t);if(!r||!r.renderable)return 1;let n=Math.max(e,i);return this.isTexture3D()&&(n=Math.max(n,s)),Math.floor(Math.log2(n))+1}_getSamplerOptions(t,e){const i=this.isDepth()&&e,s=t.filterable||i;return{addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:s?"linear":"nearest",minFilter:s?"linear":"nearest",mipFilter:this._mipLevelCount>1?s?"linear":"nearest":"none",compare:i?"le":null}}}class Zc extends Yc{constructor(t){super(t,"2d")}isTexture2D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._mipLevelCount)}update(t,e,i,s,r){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const n=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(Gc[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texSubImage2D(Gc[this._target],0,e,i,s,r,n.glFormat,n.glType[0],t),this._mipLevelCount>1&&this.generateMipmaps()}updateFromElement(t,e,i,s,r,n,a){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format);if(this._device.bindTexture(Gc[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===s&&0===r&&n===t.width&&a===t.height)this._device.context.texSubImage2D(Gc[this._target],0,e,i,o.glFormat,o.glType[0],t);else{const h=document.createElement("canvas");h.width=n,h.height=a;h.getContext("2d").drawImage(t,s,r,n,a,0,0,n,a),this._device.context.texSubImage2D(Gc[this._target],0,e,i,o.glFormat,o.glType[0],h),h.width=0,h.height=0}this._mipLevelCount>1&&this.generateMipmaps()}async readPixels(t,e,i,s,r,n,a){if(0!==r)throw new Error("Texture2D.readPixels(): parameter 'faceOrLayer' must be 0");if(n>=this.mipLevelCount||n<0)throw new Error(`Texture2D.readPixels(): invalid miplevel: ${n}`);if(!this.device.isContextLost()&&!this.disposed)return new Promise((r=>{const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentMipLevel(0,n),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixels(0,t,e,i,s,a).then((()=>{o.dispose(),r()})),this._device.popDeviceStates()}))}readPixelsToBuffer(t,e,i,s,r,n,a){if(0!==r)throw new Error("Texture2D.readPixelsToBuffer(): parameter 'faceOrLayer' must be 0");if(n>=this.mipLevelCount||n<0)throw new Error(`Texture2D.readPixelsToBuffer(): invalid miplevel: ${n}`);if(!this.device.isContextLost()&&!this.disposed){const r=this._device.createFrameBuffer([this],null);r.setColorAttachmentMipLevel(0,n),r.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(r),this._device.readPixelsToBuffer(0,t,e,i,s,a),this._device.popDeviceStates(),r.dispose()}}loadFromElement(t,e,i){if(this._flags=Number(i)||0,this._flags&Ls.TF_WRITABLE)console.error(new Error("webgl device does not support storage texture"));else{const i=e?"rgba8unorm-srgb":"rgba8unorm";this.loadImage(t,i)}}createEmpty(t,e,i,s){this._flags=Number(s)||0,this._flags&Ls.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,i,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Gc[this._target];this._device.bindTexture(t,0,this),this._device.context.generateMipmap(t)}}createWithMipmapData(t,e,i){t.isCubemap||t.isVolume?console.error("loading 2d texture with mipmap data failed: data is not 2d texture"):(this._flags=Number(i)||0,this._flags&Ls.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadLevels(t,e))}loadEmpty(t,e,i,s){this.allocInternal(t,e,i,1,s),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(t,e){let i=e?pt(t.format):t.format,s=!1;"bgra8unorm"===i?(i="rgba8unorm",s=!0):"bgra8unorm-srgb"===i&&(i="rgba8unorm-srgb",s=!0);const r=t.width,n=t.height,a=t.mipLevels;if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(i,r,n,1,a),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format),i=Gc[this._target];this._device.bindTexture(i,0,this),this.device.clearErrors();for(let r=0;r<this._mipLevelCount;r++){if(t.isCompressed)this._device.context.compressedTexSubImage2D(i,r,0,0,t.mipDatas[0][r].width,t.mipDatas[0][r].height,e.glInternalFormat,t.mipDatas[0][r].data);else{if(s)for(let e=0;e<t.mipDatas[0][r].width*t.mipDatas[0][r].height;e++){const i=t.mipDatas[0][r].data[4*e];t.mipDatas[0][r].data[4*e]=t.mipDatas[0][r].data[4*e+2],t.mipDatas[0][r].data[4*e+2]=i}this._device.context.texSubImage2D(i,r,0,0,t.mipDatas[0][r].width,t.mipDatas[0][r].height,e.glFormat,e.glType[0],t.mipDatas[0][r].data)}const n=this.device.getError();if(n)return void console.error(n)}}}else console.warn("No s3tc compression format support")}loadImage(t,e){if(this.allocInternal(e,Number(t.width),Number(t.height),1,0),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format);this.device.clearErrors();const i=Gc[this._target];this._device.bindTexture(i,0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,4),this._device.context.texSubImage2D(i,0,0,0,e.glFormat,e.glType[0],t);const s=this.device.getError();s&&console.error(s),this._mipLevelCount>1&&this.generateMipmaps()}}}class Kc extends Yc{constructor(t){if(!t.isWebGL2)throw new Error("device does not support 2d texture array");super(t,"2darray")}isTexture2DArray(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(t,e,i,s,r,n,a){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format),h=this._device.context;this._device.bindTexture(Gc[this._target],0,this),h.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),h.texSubImage3D(Gc[this._target],0,e,i,s,r,n,a,o.glFormat,o.glType[0],t),this._mipLevelCount>1&&this.generateMipmaps()}createWithMipmapData(t,e){t.arraySize?(this._flags=Number(e)||0,this._flags&Ls.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(t)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}loadLevels(t){const e=t.format,i=t.width,s=t.height,r=1!==t.mipLevels||this._flags&Ls.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,i,s,1);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(e,i,s,t.arraySize,r),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format),i=this._device.context;this._device.bindTexture(Gc[this._target],0,this),this.device.clearErrors();for(let s=0;s<t.arraySize;s++){if(t.mipDatas[s].length!==t.mipLevels)return void console.log("Texture2DArray.loadLevels() failed: Invalid texture data");for(let r=0;r<t.mipLevels;r++){t.isCompressed?i.compressedTexSubImage3D(i.TEXTURE_2D_ARRAY,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glInternalFormat,t.mipDatas[s][r].data):i.texSubImage3D(i.TEXTURE_2D_ARRAY,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glFormat,e.glType[0],t.mipDatas[s][r].data);const n=this.device.getError();if(n)return void console.error(n)}}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture2DArray.loadLevels(): No s3tc compression format support")}updateFromElement(t,e,i,s,r,n,a,o){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const h=this.getTextureCaps().getTextureFormatInfo(this._format),l=this._device.context;if(this._device.bindTexture(Gc[this._target],0,this),l.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===r&&0===n&&a===t.width&&o===t.height)l.texSubImage3D(Gc[this._target],0,e,i,s,a,o,1,h.glFormat,h.glType[0],t);else{const u=document.createElement("canvas");u.width=a,u.height=o;u.getContext("2d").drawImage(t,r,n,a,o,0,0,a,o),l.texSubImage3D(Gc[this._target],0,e,i,s,a,o,1,h.glFormat,h.glType[0],u),u.width=0,u.height=0}this._mipLevelCount>1&&this.generateMipmaps()}createEmpty(t,e,i,s,r){this._flags=Number(r)||0,this._flags&Ls.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,i,s,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Gc[this._target];this._device.bindTexture(t,0,this),this._device.context.generateMipmap(t)}}readPixels(t,e,i,s,r,n,a){if(r<0||r>=this._depth)throw new Error(`Texture2DArray.readPixels(): invalid layer: ${r}`);if(n<0||n>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixels(): invalid miplevel: ${n}`);if(!this.device.isContextLost()&&!this.disposed)return new Promise((o=>{const h=this._device.createFrameBuffer([this],null);h.setColorAttachmentLayer(0,r),h.setColorAttachmentMipLevel(0,n),h.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(h),this._device.readPixels(0,t,e,i,s,a).then((()=>{h.dispose(),o()})),this._device.popDeviceStates()}))}readPixelsToBuffer(t,e,i,s,r,n,a){if(r<0||r>=this._depth)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid layer: ${r}`);if(n<0||n>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid miplevel: ${n}`);const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentLayer(0,r),o.setColorAttachmentMipLevel(0,n),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,t,e,i,s,a),this._device.popDeviceStates(),o.dispose()}loadEmpty(t,e,i,s,r){this.allocInternal(t,e,i,s,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}}class Qc extends Yc{constructor(t){if(!t.isWebGL2)throw new Error("device does not support 3D texture");super(t,"3d")}get depth(){return this._depth}isTexture3D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(t,e,i,s,r,n,a){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format),h=this._device.context;this._device.bindTexture(Gc[this._target],0,this),h.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),h.texSubImage3D(Gc[this._target],0,e,i,s,r,n,a,o.glFormat,o.glType[0],t)}createEmpty(t,e,i,s,r){this._flags=Number(r)||0,this._flags&Ls.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,i,s,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Gc[this._target];this._device.bindTexture(t,0,this),this._device.context.generateMipmap(t)}}readPixels(t,e,i,s,r,n,a){if(0!==n)throw new Error("Texture3D.readPixels(): parameter mipLevel must be 0");if(!this.device.isContextLost()&&!this.disposed)return new Promise((n=>{const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentLayer(0,r),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixels(0,t,e,i,s,a).then((()=>{o.dispose(),n()})),this._device.popDeviceStates()}))}readPixelsToBuffer(t,e,i,s,r,n,a){if(0!==n)throw new Error("Texture3D.readPixelsToBuffer(): parameter mipLevel must be 0");const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentLayer(0,r),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,t,e,i,s,a),this._device.popDeviceStates(),o.dispose()}createWithMipmapData(t,e){t.arraySize?(this._flags=Number(e)||0,this._flags&Ls.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(t)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}loadLevels(t){const e=t.format,i=t.width,s=t.height,r=t.depth,n=1!==t.mipLevels||this._flags&Ls.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,i,s,r);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(e,i,s,t.arraySize,n),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format),i=this._device.context;this._device.bindTexture(Gc[this._target],0,this),this.device.clearErrors();for(let s=0;s<r;s++){if(t.mipDatas[s].length!==t.mipLevels)return void console.log("Texture2DArray.loadLevels() failed: Invalid texture data");for(let r=0;r<t.mipLevels;r++){t.isCompressed?i.compressedTexSubImage3D(i.TEXTURE_3D,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glInternalFormat,t.mipDatas[s][r].data):i.texSubImage3D(i.TEXTURE_3D,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glFormat,e.glType[0],t.mipDatas[s][r].data);const n=this.device.getError();if(n)return void console.error(n)}}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture2DArray.loadLevels(): No s3tc compression format support")}loadEmpty(t,e,i,s,r){this.allocInternal(t,e,i,s,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}}class Jc extends Yc{constructor(t){super(t,"cube")}init(){this.loadEmpty(this._format,this._width,this._mipLevelCount)}update(t,e,i,s,r,n){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const a=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(Gc[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texSubImage2D(Xc[n],0,e,i,s,r,a.glFormat,a.glType[0],t),this._mipLevelCount>1&&this.generateMipmaps()}updateFromElement(t,e,i,s,r,n,a,o){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const h=this.getTextureCaps().getTextureFormatInfo(this._format);if(this._device.bindTexture(Gc[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===r&&0===n&&a===t.width&&o===t.height)this._device.context.texSubImage2D(Xc[s],0,e,i,h.glFormat,h.glType[0],t);else{const s=document.createElement("canvas");s.width=a,s.height=o;s.getContext("2d").drawImage(t,r,n,a,o,0,0,a,o),this._device.context.texSubImage2D(Gc[this._target],0,e,i,h.glFormat,h.glType[0],s),s.width=0,s.height=0}this._mipLevelCount>1&&this.generateMipmaps()}createEmpty(t,e,i){this._flags=Number(i)||0,this._flags&Ls.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,0)}readPixels(t,e,i,s,r,n,a){if(n<0||n>=this.mipLevelCount)throw new Error(`TextureCube.readPixels(): invalid miplevel: ${n}`);if(!this.device.isContextLost()&&!this.disposed)return new Promise((o=>{const h=this._device.createFrameBuffer([this],null);h.setColorAttachmentCubeFace(0,r),h.setColorAttachmentMipLevel(0,n),h.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(h),this._device.readPixels(0,t,e,i,s,a).then((()=>{h.dispose(),o()})),this._device.popDeviceStates()}))}readPixelsToBuffer(t,e,i,s,r,n,a){if(n<0||n>=this.mipLevelCount)throw new Error(`TextureCube.readPixels(): invalid miplevel: ${n}`);const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentCubeFace(0,r),o.setColorAttachmentMipLevel(0,n),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,t,e,i,s,a),this._device.popDeviceStates(),o.dispose()}isTextureCube(){return!0}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Gc[this._target];this._device.bindTexture(t,0,this),this._device.context.generateMipmap(t)}}createWithMipmapData(t,e,i){t.isCubemap?(this._flags=Number(i)||0,this._flags&Ls.TF_WRITABLE?console.error("webgl device does not support storage texture"):this.loadLevels(t,e)):console.error("loading cubmap with mipmap data failed: data is not cubemap")}loadEmpty(t,e,i){this.allocInternal(t,e,e,1,i),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadImages(t,e){const i=t[0].width,s=t[0].height;if(6===t.length){for(let e=1;e<6;e++)if(t[e].width!==i||t[e].height!==s)return void console.error(new Error("cubemap face images must have identical sizes"));if(0!==i&&0!==s&&(this.allocInternal(e,i,s,1,0),!this._device.isContextLost())){this.device.clearErrors(),this._device.bindTexture(Gc[this._target],0,this);const e=this.getTextureCaps().getTextureFormatInfo(this._format);for(let i=0;i<6;i++){this._device.context.texSubImage2D(Xc[i],0,0,0,e.glFormat,e.glType[0],t[i]);const s=this.device.getError();if(s)return void console.error(s)}this._mipLevelCount>1&&this.generateMipmaps()}}else console.error(new Error("cubemap face list must have 6 images"))}loadLevels(t,e){const i=e?pt(t.format):t.format,s=t.width,r=t.height,n=t.mipLevels;if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(i,s,r,1,n),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(Gc[this._target],0,this),this.device.clearErrors();for(let i=0;i<6;i++){const s=Xc[i];if(this._mipLevelCount>1&&t.mipDatas[i].length!==this._mipLevelCount)return void console.log("invalid texture data");for(let r=0;r<this._mipLevelCount;r++){t.isCompressed?this._device.context.compressedTexSubImage2D(s,r,0,0,t.mipDatas[i][r].width,t.mipDatas[i][r].height,e.glInternalFormat,t.mipDatas[i][r].data):this._device.context.texSubImage2D(s,r,0,0,t.mipDatas[i][r].width,t.mipDatas[i][r].height,e.glFormat,e.glType[0],t.mipDatas[i][r].data);const n=this.device.getError();if(n)return void console.error(n)}}}}else console.warn("No s3tc compression format support")}}class td extends Yc{_source;_callbackId;constructor(t,e){super(t,"2d"),this._source=null,this._callbackId=null,this._format="unknown",this.loadFromElement(e)}isTextureVideo(){return!0}get source(){return this._source}destroy(){this._source&&null!==this._callbackId&&this._source.cancelVideoFrameCallback(this._callbackId),super.destroy()}init(){this.loadElement(this._source)}loadFromElement(t){this._flags=Ls.TF_NO_MIPMAP,this.loadElement(t)}generateMipmaps(){}readPixels(t,e,i,s,r,n,a){throw new Error("Video texture does not support readPixels()")}readPixelsToBuffer(t,e,i,s,r,n,a){throw new Error("Video texture does not support readPixelsToBuffer()")}updateVideoFrame(){return!(!(this.object&&this._source.currentTime>0)||this._source.requestVideoFrameCallback)&&(this.update(),!0)}update(){if(this.allocInternal("rgba8unorm",this._source.videoWidth,this._source.videoHeight,1,1),!this._device.isContextLost()){const t=Gc[this._target],e=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(t,0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texImage2D(t,0,e.glInternalFormat,e.glFormat,e.glType[0],this._source)}}loadElement(t){if(this._source&&null!==this._callbackId&&(this._source.cancelVideoFrameCallback(this._callbackId),this._callbackId=null),this._source=t,this._source?.requestVideoFrameCallback){const t=this;t._callbackId=this._source.requestVideoFrameCallback((function e(){t._object&&(t.update(),t._callbackId=t._source.requestVideoFrameCallback(e))}))}this.allocInternal("rgba8unorm",Math.max(this._source.videoWidth,1),Math.max(this._source.videoHeight,1),1,1)}}class ed extends qc{_vertexData;_dirty;constructor(t,e){super(t),this._vertexData=new Xs,this._dirty=!1;for(const t of e.vertexBuffers)this._vertexData.setVertexBuffer(t.buffer,t.stepMode);e.indexBuffer&&this._vertexData.setIndexBuffer(e.indexBuffer),this.load()}destroy(){this._object&&this._device.vaoExt&&this._device.vaoExt.deleteVertexArray(this._object),this._object=null}async restore(){this._device.isContextLost()||this.load()}get vertexBuffers(){return this._vertexData.vertexBuffers}get indexBuffer(){return this._vertexData.indexBuffer}setDrawOffset(t,e){for(const i of this._vertexData.vertexBuffers)i?.buffer===t&&i.drawOffset!==e&&(i.drawOffset=e,this._dirty=!0)}getVertexBuffer(t){return this._vertexData.getVertexBuffer(t)}getVertexBufferInfo(t){return this._vertexData.getVertexBufferInfo(t)}getIndexBuffer(){return this._vertexData.getIndexBuffer()}bind(){this._object&&this._device.vaoExt?(this._device.vaoExt.bindVertexArray(this._object),this._dirty&&(this._dirty=!1,this.bindBuffers())):this.bindBuffers()}draw(t,e,i){this._device.setVertexLayout(this),this._device.draw(t,e,i)}drawInstanced(t,e,i,s){this._device.setVertexLayout(this),this._device.drawInstanced(t,e,i,s)}isVertexLayout(){return!0}load(){this._device.isContextLost()||(this._device.vaoExt?this._object||(this._object=this._device.vaoExt.createVertexArray(),this._device.vaoExt.bindVertexArray(this._object),this.bindBuffers(),this._device.vaoExt.bindVertexArray(null)):this._object={})}bindBuffers(){const t=this._vertexData.vertexBuffers,e=this._device.context;for(let i=0;i<t.length;i++){const s=t[i],r=s?.buffer;r?(r.disposed&&r.reload(),e.bindBuffer(Ac.ARRAY_BUFFER,r.object),e.enableVertexAttribArray(i),"instance"===s.stepMode&&this._device.instancedArraysExt?(e.vertexAttribPointer(i,s.type.cols,zc[s.type.scalarType],s.type.normalized,s.stride,s.offset),this._device.instancedArraysExt.vertexAttribDivisor(i,1)):e.vertexAttribPointer(i,s.type.cols,zc[s.type.scalarType],s.type.normalized,s.stride,s.drawOffset+s.offset)):e.disableVertexAttribArray(i)}this._vertexData.indexBuffer?.disposed&&this._vertexData.indexBuffer.reload(),e.bindBuffer(Ac.ELEMENT_ARRAY_BUFFER,this._vertexData.indexBuffer?this._vertexData.indexBuffer.object:null)}}class id extends qc{_size;_usage;_systemMemoryBuffer;_systemMemory;_memCost;constructor(t,e,i,s=!1){if(super(t),e&Ls.BF_VERTEX&&e&Ls.BF_INDEX)throw new Error("buffer usage must not have Vertex and Index simultaneously");if(!(t.isWebGL2||e&Ls.BF_VERTEX||e&Ls.BF_INDEX||e&Ls.BF_UNIFORM))throw new Error("no Vertex or Index or Uniform usage set when creating buffer");if(t.isWebGL2&&!(e&~Ls.DYNAMIC))throw new Error("buffer usage not set when creating buffer");if(e&Ls.DYNAMIC&&e&Ls.MANAGED)throw new Error("buffer usage DYNAMIC and MANAGED can not be both set");if(this._object=null,this._memCost=0,this._usage=e,this._size="number"==typeof i?i:i.byteLength,this._size<=0)throw new Error("can not create buffer with zero size");this._systemMemory=!!s,this._systemMemory||this._usage&Ls.MANAGED?(this._systemMemoryBuffer=new Uint8Array(this._size),i&&"number"!=typeof i&&this._systemMemoryBuffer.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength))):this._systemMemoryBuffer=null,this._systemMemory||this.load(this._systemMemoryBuffer||("number"==typeof i?null:i))}get byteLength(){return this._size}get systemMemoryBuffer(){return this._systemMemoryBuffer?.buffer||null}get usage(){return this._usage}bufferSubData(t,e,i,s){if(i=Number(i)||0,t=Number(t)||0,i+(s=Number(s)||e.length-i)>e.length)throw new Error("bufferSubData() failed: source buffer is too small");if(t+s*e.BYTES_PER_ELEMENT>this.byteLength)throw new Error("bufferSubData() failed: dest buffer is too small");if((this._systemMemory||this._usage&Ls.MANAGED)&&this._systemMemoryBuffer.set(new Uint8Array(e.buffer,e.byteOffset+i*e.BYTES_PER_ELEMENT,s*e.BYTES_PER_ELEMENT),t),!this._systemMemory&&!this.device.isContextLost()){let r;if(this.disposed&&this.reload(),this._device.isWebGL2||0===i&&s===e.length||(e=e.subarray(i,i+s)),this._device.vaoExt?.bindVertexArray(null),this._usage&Ls.BF_INDEX)r=Ac.ELEMENT_ARRAY_BUFFER;else if(this._usage&Ls.BF_VERTEX)r=Ac.ARRAY_BUFFER;else if(this._usage&Ls.BF_UNIFORM)r=Ac.UNIFORM_BUFFER;else{if(!(this._usage&(Ls.BF_READ|Ls.BF_WRITE)))throw new Error("Invalid buffer usage");r=Ac.COPY_WRITE_BUFFER}this._device.context.bindBuffer(r,this._object),this._device.isWebGL2?this._device.context.bufferSubData(r,t,e,i,s):this._device.context.bufferSubData(r,t,e)}}async getBufferSubData(t,e,i){return this.disposed&&this.reload(),this._getBufferData(t,e,i)}async _getBufferData(t,e,i){if(e=Number(e)||0,i=Number(i)||this.byteLength-e,e<0||e+i>this.byteLength)throw new Error("data query range out of bounds");if(t&&t.byteLength<i)throw new Error("no enough space for querying buffer data");if(t=t||new Uint8Array(i),this._systemMemoryBuffer)t.set(new Uint8Array(this._systemMemoryBuffer,e,i));else{const s=this._device.context;if(Mc(s)){const t=s.fenceSync(Ac.SYNC_GPU_COMMANDS_COMPLETE,0);s.flush(),await this.clientWaitAsync(s,t,0,10),s.deleteSync(t)}let r;if(this._device.vaoExt?.bindVertexArray(null),this._usage&Ls.BF_INDEX)r=Ac.ELEMENT_ARRAY_BUFFER;else if(this._usage&Ls.BF_VERTEX)r=Ac.ARRAY_BUFFER;else if(this._usage&Ls.BF_UNIFORM)r=Ac.UNIFORM_BUFFER;else{if(!(this._usage&(Ls.BF_READ|Ls.BF_WRITE)))throw new Error("Invalid buffer usage");r=Ac.COPY_READ_BUFFER}s.bindBuffer(r,this._object),s.getBufferSubData(r,e,t,0,i),s.bindBuffer(r,null)}return t}async restore(){this._systemMemory||this._object||this._device.isContextLost()||this.load(this._systemMemoryBuffer)}destroy(){!this._systemMemory&&this._object&&(this._device.context.deleteBuffer(this._object),this._object=null,this._device.updateVideoMemoryCost(-this._memCost),this._memCost=0)}isBuffer(){return!0}load(t){if(!this._device.isContextLost()){this._object||(this._object=this._device.context.createBuffer()),this._device.vaoExt?.bindVertexArray(null);let e,i=this._usage&Ls.DYNAMIC?Ac.DYNAMIC_DRAW:Ac.STATIC_DRAW;if(this._usage&Ls.BF_INDEX)e=Ac.ELEMENT_ARRAY_BUFFER;else if(this._usage&Ls.BF_VERTEX)e=Ac.ARRAY_BUFFER;else if(this._usage&Ls.BF_UNIFORM)e=Ac.UNIFORM_BUFFER;else if(this._usage&Ls.BF_READ)e=Ac.COPY_READ_BUFFER,i=Ac.STREAM_READ;else{if(!(this._usage&Ls.BF_WRITE))throw new Error(`WebGLGPUBuffer.load() failed: invalid buffer usage: ${this._usage}`);e=Ac.COPY_WRITE_BUFFER}this._device.context.bindBuffer(e,this._object),t?this._device.context.bufferData(e,t,i):this._device.context.bufferData(e,this._size+15&-16,i)}this._device.updateVideoMemoryCost(this._size-this._memCost),this._memCost=this._size}async clientWaitAsync(t,e,i,s){return new Promise(((r,n)=>{!function a(){const o=t.clientWaitSync(e,i,0);o!=t.WAIT_FAILED?o!=t.TIMEOUT_EXPIRED?r():setTimeout(a,s):n()}()}))}}const sd=te.getCachedTypeInfo(Bt.U16),rd=te.getCachedTypeInfo(Bt.U32);class nd extends id{indexType;length;constructor(t,e,i){if(!(e instanceof Uint16Array||e instanceof Uint32Array))throw new Error("invalid index data");super(t,Ls.BF_INDEX|i,e),this.indexType=e instanceof Uint16Array?sd:rd,this.length=e.length}}class ad extends qc{_options;_needBindBuffers;_drawTags;_lastDrawTag;_status;_statusAA;_width;_height;_isMRT;_drawBuffers;_hash;_depthAttachmentTarget;_colorAttachmentsAA;_depthAttachmentAA;_intermediateAttachments;_framebufferAA;_initialized;constructor(t,e,i,s){if(super(t),e.length>0&&e.findIndex((t=>!t))>=0)throw new Error("WebGLFramebuffer(): invalid color attachments");if(this._object=null,this._framebufferAA=null,this._colorAttachmentsAA=null,this._depthAttachmentAA=null,this._intermediateAttachments=null,this._needBindBuffers=!1,this._drawTags=0,this._lastDrawTag=-1,this._status=0,this._statusAA=0,this._options={colorAttachments:e?.length>0?e.map((t=>({texture:t,face:0,layer:0,level:0,generateMipmaps:!0}))):null,depthAttachment:i?{texture:i,face:0,layer:0,level:0,generateMipmaps:!1}:null,sampleCount:"webgl"===t.type?1:s?.sampleCount??1,ignoreDepthStencil:s?.ignoreDepthStencil??!1},!this._options.colorAttachments&&!this._options.depthAttachment)throw new Error("WebGLFramebuffer(): colorAttachments or depthAttachment must be specified");if(this._width=this._options.colorAttachments?this._options.colorAttachments[0].texture.width:this._options.depthAttachment.texture.width,this._height=this._options.colorAttachments?this._options.colorAttachments[0].texture.height:this._options.depthAttachment.texture.height,this._options.colorAttachments&&this._options.colorAttachments.findIndex((t=>t.texture.width!==this._width||t.texture.height!==this._height))>=0||this._options.depthAttachment&&(this._options.depthAttachment.texture.width!==this._width||this._options.depthAttachment.texture.height!==this._height))throw new Error("WebGLFramebuffer(): attachment textures must have same width and height");if(this._drawBuffers=this._options.colorAttachments?.map(((t,e)=>Ac.COLOR_ATTACHMENT0+e))??[],this._isMRT=this._drawBuffers.length>1,this._options.depthAttachment){const t=this._options.depthAttachment.texture.format;this._depthAttachmentTarget=ft(t)?Ac.DEPTH_STENCIL_ATTACHMENT:Ac.DEPTH_ATTACHMENT}else this._depthAttachmentTarget=Ac.NONE;const r=this._options.colorAttachments?.map((t=>t.texture.format)).join(":")??"",n=this._options.depthAttachment?.texture.format??"";this._hash=`${r}-${n}-${this._options.sampleCount??1}`,this._initialized=!1}tagDraw(){this._drawTags++}isMRT(){return this._isMRT}getWidth(){const t=this._options.colorAttachments?.[0]??this._options.depthAttachment;return Math.max(t.texture.width>>t.level,1)}getHeight(){const t=this._options.colorAttachments?.[0]??this._options.depthAttachment;return Math.max(t.texture.height>>t.level,1)}getHash(){return this._hash}async restore(){if(!this._object&&!this._device.isContextLost()&&(this._options?.depthAttachment?.texture?.disposed&&await this._options.depthAttachment.texture.reload(),this._options?.colorAttachments))for(const t of this._options.colorAttachments)t?.texture?.disposed&&await t.texture.reload();this._init()}destroy(){if(this._object){if(this._device.context.deleteFramebuffer(this._object),this._object=null,this._colorAttachmentsAA){for(const t of this._colorAttachmentsAA)this._device.context.deleteRenderbuffer(t);this._colorAttachmentsAA=null}if(this._depthAttachmentAA&&(this._device.context.deleteRenderbuffer(this._depthAttachmentAA),this._depthAttachmentAA=null),this._framebufferAA&&(this._device.context.deleteFramebuffer(this._framebufferAA),this._framebufferAA=null),this._intermediateAttachments){for(const t of this._intermediateAttachments)for(const e of t[1])e&&(this._device.context.deleteTexture(e.texture),this._device.invalidateBindingTextures());this._intermediateAttachments=null}}}setColorAttachmentGenerateMipmaps(t,e){const i=this._options.colorAttachments?.[t];i&&(i.generateMipmaps=!!e)}setColorAttachmentCubeFace(t,e){const i=this._options.colorAttachments?.[t];i&&i.face!==e&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),i.face=e,this.bind()):i.face=e)}setColorAttachmentMipLevel(t,e){const i=this._options.colorAttachments?.[t];i&&i.level!==e&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),i.level=e,this.bind()):i.level=e)}setColorAttachmentLayer(t,e){const i=this._options.colorAttachments?.[t];i&&i.layer!==e&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),i.layer=e,this.bind()):i.layer=e)}setDepthAttachmentCubeFace(t){const e=this._options.depthAttachment;e&&e.face!==t&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),e.face=t,this.bind()):e.face=t)}setDepthAttachmentLayer(t){const e=this._options.depthAttachment;e&&e.layer!==t&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),e.layer=t,this.bind()):e.layer=t)}getDepthAttachment(){return this._options?.depthAttachment?.texture||null}getColorAttachments(){return this._options.colorAttachments?.map((t=>t.texture||null))||[]}bind(){if(this._initialized||(this._init(),this._initialized=!0),this._object){if(this._device.context._currentFramebuffer=this,this._lastDrawTag=-1,this._needBindBuffers&&(this._needBindBuffers=!1,!this._bindBuffersAA()||!this._bindBuffers()))return this._device.context.bindFramebuffer(Ac.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null,!1;this._device.context.bindFramebuffer(Ac.FRAMEBUFFER,this._framebufferAA||this._object);const t=this._device.drawBuffersExt;return t?t.drawBuffers(this._drawBuffers):this._isMRT&&console.error("device does not support multiple framebuffer color attachments"),this._device.setViewport(null),this._device.setScissor(null),!0}return!1}unbind(){if(this._device.context._currentFramebuffer===this){this._updateMSAABuffer(),this._device.context.bindFramebuffer(Ac.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null,this._device.setViewport(),this._device.setScissor();const t=this._device.drawBuffersExt;if(t&&t.drawBuffers([Ac.BACK]),this._options.colorAttachments)for(const t of this._options.colorAttachments){const e=t.texture;if(t.level>0){const i=this._intermediateAttachments?.get(e)?.[t.level];if(i){const s=this._device.context.createFramebuffer();this._device.context.bindFramebuffer(Ac.FRAMEBUFFER,s),this._device.context.framebufferTexture2D(Ac.FRAMEBUFFER,Ac.COLOR_ATTACHMENT0,Ac.TEXTURE_2D,i.texture,0),e.isTexture2D()?(this._device.bindTexture(Ac.TEXTURE_2D,0,e),this._device.context.copyTexSubImage2D(Ac.TEXTURE_2D,t.level,0,0,0,0,i.width,i.height)):e.isTextureCube()&&(this._device.bindTexture(Ac.TEXTURE_CUBE_MAP,0,e),this._device.context.copyTexSubImage2D(Xc[t.face??m.PX],t.level,0,0,0,0,i.width,i.height)),this._device.context.bindFramebuffer(Ac.FRAMEBUFFER,null),this._device.context.deleteFramebuffer(s)}}t.generateMipmaps&&e.mipLevelCount>1&&e.generateMipmaps()}}}_updateMSAABuffer(){if(this._options.sampleCount>1&&this._lastDrawTag!==this._drawTags){const t=this._device.context;t.bindFramebuffer(Ac.READ_FRAMEBUFFER,this._framebufferAA),t.bindFramebuffer(Ac.DRAW_FRAMEBUFFER,this._object);let e=0;this._options.ignoreDepthStencil||this._depthAttachmentTarget===Ac.NONE||(e=Ac.DEPTH_BUFFER_BIT|(this._depthAttachmentTarget===Ac.DEPTH_STENCIL_ATTACHMENT?Ac.STENCIL_BUFFER_BIT:0));for(let i=0;i<this._drawBuffers.length;i++){for(let t=0;t<this._drawBuffers.length;t++)this._drawBuffers[t]=t===i?Ac.COLOR_ATTACHMENT0+i:Ac.NONE;t.readBuffer(this._drawBuffers[i]),t.drawBuffers(this._drawBuffers),t.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,Ac.COLOR_BUFFER_BIT|e,Ac.NEAREST),e=0}0!==e&&t.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,e,Ac.NEAREST);for(let t=0;t<this._drawBuffers.length;t++)this._drawBuffers[t]=Ac.COLOR_ATTACHMENT0+t;t.bindFramebuffer(Ac.READ_FRAMEBUFFER,null),t.bindFramebuffer(Ac.DRAW_FRAMEBUFFER,null),this._lastDrawTag=this._drawTags}}_load(){if(!this._device.isContextLost()){do{if(this._options.sampleCount>1&&(this._framebufferAA=this._device.context.createFramebuffer(),this._colorAttachmentsAA=[],this._depthAttachmentAA=null,!this._bindBuffersAA())){this.dispose();break}this._object=this._device.context.createFramebuffer(),this._device.context.bindFramebuffer(Ac.FRAMEBUFFER,this._object),this._bindBuffers()||this.dispose()}while(0);this._lastDrawTag=-1,this._device.context.bindFramebuffer(Ac.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null}}_bindAttachment(t,e){if(e.texture){let i=null;if("webgl"===this.device.type&&e.level>0){this._intermediateAttachments||(this._intermediateAttachments=new Map);let t=this._intermediateAttachments.get(e.texture);if(t||(t=[],this._intermediateAttachments.set(e.texture,t)),t[e.level])i=t[e.level].texture;else{let s=e.texture.width,r=e.texture.height,n=e.level;for(;n-- >0;)s=Math.max(s>>1,1),r=Math.max(r>>1,1);const a=this.device.getDeviceCaps().textureCaps.getTextureFormatInfo(e.texture.format);i=this._device.context.createTexture(),this._device.context.activeTexture(Ac.TEXTURE0),this._device.context.bindTexture(Ac.TEXTURE_2D,i),this._device.context.texImage2D(Ac.TEXTURE_2D,0,a.glInternalFormat,s,r,0,a.glFormat,a.glType[0],null),t[e.level]={texture:i,width:s,height:r},this._device.bindTexture(Ac.TEXTURE_2D,0,null)}}if(i)this._device.context.framebufferTexture2D(Ac.FRAMEBUFFER,t,Ac.TEXTURE_2D,i,0);else if(e.texture.isTexture2D())i?this._device.context.framebufferRenderbuffer(Ac.FRAMEBUFFER,t,Ac.RENDERBUFFER,i):this._device.context.framebufferTexture2D(Ac.FRAMEBUFFER,t,Ac.TEXTURE_2D,e.texture.object,e.level??0);else if(e.texture.isTextureCube())this._device.context.framebufferTexture2D(Ac.FRAMEBUFFER,t,Xc[e.face??m.PX],e.texture.object,e.level??0);else{if(!e.texture.isTexture2DArray()&&!e.texture.isTexture3D())return!1;this._device.context.framebufferTextureLayer(Ac.FRAMEBUFFER,t,e.texture.object,e.level??0,e.layer??0)}return!0}return!1}_bindBuffers(){if(!this._object)return!1;if(this._device.context.bindFramebuffer(Ac.FRAMEBUFFER,this._object),this._depthAttachmentTarget!==Ac.NONE&&!this._bindAttachment(this._depthAttachmentTarget,this._options.depthAttachment))return!1;for(let t=0;t<this._options.colorAttachments?.length;t++){const e=this._options.colorAttachments[t];if(e.texture&&!this._bindAttachment(Ac.COLOR_ATTACHMENT0+t,e))return!1}if(0===this._status){const t=this._device.context.checkFramebufferStatus(Ac.FRAMEBUFFER);t!==Ac.FRAMEBUFFER_COMPLETE?(console.error(`Framebuffer not complete: ${t}`),this._status=2):this._status=1}return 1===this._status}_createRenderbufferAA(t){const e=this._device.context.createRenderbuffer(),i=this.device.getDeviceCaps().textureCaps.getTextureFormatInfo(t.format);return this._device.context.bindRenderbuffer(Ac.RENDERBUFFER,e),this._device.context.renderbufferStorageMultisample(Ac.RENDERBUFFER,this._options.sampleCount,i.glInternalFormat,this._options.depthAttachment.texture.width,this._options.depthAttachment.texture.height),e}_bindBuffersAA(){if(!this._framebufferAA)return!0;this._device.context.bindFramebuffer(Ac.FRAMEBUFFER,this._framebufferAA),this._depthAttachmentTarget!==Ac.NONE&&(this._depthAttachmentAA||(this._depthAttachmentAA=this._createRenderbufferAA(this._options.depthAttachment.texture)),this._device.context.framebufferRenderbuffer(Ac.FRAMEBUFFER,this._depthAttachmentTarget,Ac.RENDERBUFFER,this._depthAttachmentAA));for(let t=0;t<this._options.colorAttachments?.length;t++){this._options.colorAttachments[t].texture&&(this._colorAttachmentsAA[t]||(this._colorAttachmentsAA[t]=this._createRenderbufferAA(this._options.colorAttachments[t].texture)),this._device.context.framebufferRenderbuffer(Ac.FRAMEBUFFER,Ac.COLOR_ATTACHMENT0+t,Ac.RENDERBUFFER,this._colorAttachmentsAA[t]))}if(0===this._statusAA){const t=this._device.context.checkFramebufferStatus(Ac.FRAMEBUFFER);t!==Ac.FRAMEBUFFER_COMPLETE?(console.error(`Framebuffer not complete: ${t}`),this._statusAA=2):this._statusAA=1}return 1===this._statusAA}_init(){if(1!==this._options.sampleCount&&4!==this._options.sampleCount)throw new Error(`WebGLFramebuffer(): Sample should be 1 or 4, got ${this._options.sampleCount}`);if(this._options.sampleCount>1&&!this._device.getDeviceCaps().framebufferCaps.supportMultisampledFramebuffer)throw new Error("WebGLFramebuffer(): Multisampled frame buffer not supported");this._load()}isFramebuffer(){return!0}getSampleCount(){return this._options.sampleCount}}class od{static _defaultState;static _currentState;apply(t,e){const i=this.constructor;(e||i._currentState!==this)&&this._apply(t),i._currentState=this}static get defaultState(){return od._defaultState}static applyDefaults(t,e){(e||this._currentState!==this._defaultState)&&this._defaultState.apply(t,e)}}class hd extends od{static _defaultState=new hd;static _currentState=null;redMask;greenMask;blueMask;alphaMask;constructor(){super(),this.redMask=this.greenMask=this.blueMask=this.alphaMask=!0}clone(){return(new hd).setColorMask(this.redMask,this.greenMask,this.blueMask,this.alphaMask)}setColorMask(t,e,i,s){return this.redMask=t,this.greenMask=e,this.blueMask=i,this.alphaMask=s,this}_apply(t){t.colorMask(this.redMask,this.greenMask,this.blueMask,this.alphaMask)}}class ld extends od{static _defaultState=new ld;static _currentState=null;_srcBlendRGB;_dstBlendRGB;_srcBlendAlpha;_dstBlendAlpha;_rgbEquation;_alphaEquation;enabled;alphaToCoverageEnabled;constructor(){super(),this.enabled=!1,this.alphaToCoverageEnabled=!1,this.srcBlendRGB="one",this.dstBlendRGB="zero",this.srcBlendAlpha="one",this.dstBlendAlpha="zero",this.rgbEquation="add",this.alphaEquation="add"}clone(){const t=new ld;return t.enable(this.enabled),t.enableAlphaToCoverage(this.alphaToCoverageEnabled),t.setBlendFuncRGB(this.srcBlendRGB,this.dstBlendRGB),t.setBlendFuncAlpha(this.srcBlendAlpha,this.dstBlendAlpha),t.setBlendEquation(this.rgbEquation,this.alphaEquation),t}get srcBlendRGB(){return $c[this._srcBlendRGB]}set srcBlendRGB(t){this._srcBlendRGB=Dc[t]}get dstBlendRGB(){return $c[this._dstBlendRGB]}set dstBlendRGB(t){this._dstBlendRGB=Dc[t]}get srcBlendAlpha(){return $c[this._srcBlendAlpha]}set srcBlendAlpha(t){this._srcBlendAlpha=Dc[t]}get dstBlendAlpha(){return $c[this._dstBlendAlpha]}set dstBlendAlpha(t){this._dstBlendAlpha=Dc[t]}get rgbEquation(){return Ic[this._rgbEquation]}set rgbEquation(t){this._rgbEquation=Fc[t]}get alphaEquation(){return Ic[this._alphaEquation]}set alphaEquation(t){this._alphaEquation=Fc[t]}enable(t){return this.enabled=!!t,this}enableAlphaToCoverage(t){return this.alphaToCoverageEnabled=!!t,this}setBlendFunc(t,e){return this.srcBlendRGB=t,this.dstBlendRGB=e,this.srcBlendAlpha=t,this.dstBlendAlpha=e,this}setBlendFuncRGB(t,e){return this.srcBlendRGB=t,this.dstBlendRGB=e,this}setBlendFuncAlpha(t,e){return this.srcBlendAlpha=t,this.dstBlendAlpha=e,this}setBlendEquation(t,e){return this.rgbEquation=t,this.alphaEquation=e,this}_apply(t){this.enabled?(t.enable(Ac.BLEND),t.blendEquationSeparate(this._rgbEquation,this._alphaEquation),this._srcBlendRGB===this._srcBlendAlpha&&this._dstBlendRGB===this._dstBlendAlpha?t.blendFunc(this._srcBlendRGB,this._dstBlendRGB):t.blendFuncSeparate(this._srcBlendRGB,this._dstBlendRGB,this._srcBlendAlpha,this._dstBlendAlpha)):t.disable(Ac.BLEND),this.alphaToCoverageEnabled?t.enable(Ac.SAMPLE_ALPHA_TO_COVERAGE):t.disable(Ac.SAMPLE_ALPHA_TO_COVERAGE)}}class ud extends od{static _defaultState=new ud;static _currentState=null;_cullMode;constructor(){super(),this.cullMode="back"}clone(){return(new ud).setCullMode(this.cullMode)}get cullMode(){return Pc[this._cullMode]}set cullMode(t){this._cullMode=Lc[t]}setCullMode(t){return this.cullMode=t,this}get depthClampEnabled(){return!1}set depthClampEnabled(t){this.enableDepthClamp(t)}enableDepthClamp(t){return t&&console.error("Depth clamp not supported"),this}_apply(t){"none"==this.cullMode?t.disable(Ac.CULL_FACE):(t.enable(Ac.CULL_FACE),t.cullFace(this._cullMode))}}class cd extends od{static _defaultState=new cd;static _currentState=null;testEnabled;writeEnabled;_compareFunc;constructor(){super(),this.testEnabled=!0,this.writeEnabled=!0,this.compareFunc="le"}clone(){const t=new cd;return t.enableTest(this.testEnabled),t.enableWrite(this.writeEnabled),t.setCompareFunc(this.compareFunc),t}get compareFunc(){return Uc[this._compareFunc]}set compareFunc(t){this._compareFunc=Oc[t]}enableTest(t){return this.testEnabled=t,this}enableWrite(t){return this.writeEnabled=t,this}setCompareFunc(t){return this.compareFunc=t,this}_apply(t){this.testEnabled?(t.enable(Ac.DEPTH_TEST),t.depthFunc(this._compareFunc)):t.disable(Ac.DEPTH_TEST),t.depthMask(this.writeEnabled)}}class dd extends od{static _defaultState=new dd;static _currentState=null;enabled;writeMask;ref;readMask;_failOp;_failOpBack;_zFailOp;_zFailOpBack;_passOp;_passOpBack;_func;_funcBack;constructor(){super(),this.enabled=!1,this.failOp=this.failOpBack="keep",this.zFailOp=this.zFailOpBack="keep",this.passOp=this.passOpBack="keep",this.func=this.funcBack="always",this.ref=0,this.writeMask=4294967295,this.readMask=4294967295}clone(){const t=new dd;return t.enable(this.enabled),t.setWriteMask(this.writeMask),t.setFrontOp(this.failOp,this.zFailOp,this.passOp),t.setBackOp(this.failOpBack,this.zFailOpBack,this.passOpBack),t.setFrontCompareFunc(this.func),t.setBackCompareFunc(this.funcBack),t.setReference(this.ref),t.setReadMask(this.readMask),t}get failOp(){return Bc[this._failOp]}set failOp(t){this._failOp=Nc[t]}get failOpBack(){return Bc[this._failOpBack]}set failOpBack(t){this._failOpBack=Nc[t]}get zFailOp(){return Bc[this._zFailOp]}set zFailOp(t){this._zFailOp=Nc[t]}get zFailOpBack(){return Bc[this._zFailOpBack]}set zFailOpBack(t){this._zFailOpBack=Nc[t]}get passOp(){return Bc[this._passOp]}set passOp(t){this._passOp=Nc[t]}get passOpBack(){return Bc[this._passOpBack]}set passOpBack(t){this._passOpBack=Nc[t]}get func(){return Uc[this._func]}set func(t){this._func=Oc[t]}get funcBack(){return Uc[this._funcBack]}set funcBack(t){this._funcBack=Oc[t]}enable(t){return this.enabled=t,this}setWriteMask(t){return this.writeMask=t,this}setFrontOp(t,e,i){return this.failOp=t,this.zFailOp=e,this.passOp=i,this}setBackOp(t,e,i){return this.failOpBack=t,this.zFailOpBack=e,this.passOpBack=i,this}setFrontCompareFunc(t){return this.func=t,this}setBackCompareFunc(t){return this.funcBack=t,this}setReference(t){return this.ref=t,this}setReadMask(t){return this.readMask=t,this}_apply(t){this.enabled?(t.enable(Ac.STENCIL_TEST),t.stencilMaskSeparate(Ac.FRONT,this.writeMask),t.stencilMaskSeparate(Ac.BACK,this.writeMask),t.stencilFuncSeparate(Ac.FRONT,this._func,this.ref,this.readMask),t.stencilFuncSeparate(Ac.BACK,this._funcBack,this.ref,this.readMask),t.stencilOpSeparate(Ac.FRONT,this._failOp,this._zFailOp,this._passOp),t.stencilOpSeparate(Ac.BACK,this._failOpBack,this._zFailOpBack,this._passOpBack)):t.disable(Ac.STENCIL_TEST)}}class pd{_gl;colorState;blendingState;rasterizerState;depthState;stencilState;constructor(t){this._gl=t,this.colorState=null,this.blendingState=null,this.rasterizerState=null,this.depthState=null,this.stencilState=null}clone(){const t=new pd(this._gl);return t.colorState=this.colorState?.clone()??null,t.blendingState=this.blendingState?.clone()??null,t.rasterizerState=this.rasterizerState?.clone()??null,t.depthState=this.depthState?.clone()??null,t.stencilState=this.stencilState?.clone()??null,t}copyFrom(t){this.colorState=t.colorState,this.blendingState=t.blendingState,this.rasterizerState=t.rasterizerState,this.depthState=t.depthState,this.stencilState=t.stencilState}apply(t){const e=this._gl;this.colorState?this.colorState.apply(e,t):hd.applyDefaults(e,t),this.blendingState?this.blendingState.apply(e,t):ld.applyDefaults(e,t),this.rasterizerState?this.rasterizerState.apply(e,t):ud.applyDefaults(e,t),this.depthState?this.depthState.apply(e,t):cd.applyDefaults(e,t),this.stencilState?this.stencilState.apply(e,t):dd.applyDefaults(e,t)}useColorState(t){return this.colorState=t??this.colorState??new hd}defaultColorState(){this.colorState=null}useBlendingState(t){return this.blendingState=t??this.blendingState??new ld}defaultBlendingState(){this.blendingState=null}useRasterizerState(t){return this.rasterizerState=t??this.rasterizerState??new ud}defaultRasterizerState(){this.rasterizerState=null}useDepthState(t){return this.depthState=t??this.depthState??new cd}defaultDepthState(){this.depthState=null}useStencilState(t){return this.stencilState=t??this.stencilState??new dd}defaultStencilState(){this.stencilState=null}static applyDefaults(t,e){hd.applyDefaults(t,e),ld.applyDefaults(t,e),ud.applyDefaults(t,e),cd.applyDefaults(t,e),dd.applyDefaults(t,e)}}var md;!function(t){t[t.QUERY_STATE_NONE=0]="QUERY_STATE_NONE",t[t.QUERY_STATE_QUERYING=1]="QUERY_STATE_QUERYING",t[t.QUERY_STATE_FINISHED=2]="QUERY_STATE_FINISHED"}(md||(md={}));class fd{_device;_query;_state;_timerQuery;_gpuTime;constructor(t){this._device=t,this._state=0,this._gpuTime=null;const e=this._device.context;if(Mc(e)){const t=e.getExtension("EXT_disjoint_timer_query_webgl2");t&&(this._timerQuery={createQuery:e.createQuery.bind(e),deleteQuery:e.deleteQuery.bind(e),beginQuery:e.beginQuery.bind(e),endQuery:e.endQuery.bind(e),isQuery:e.isQuery.bind(e),getQuery:e.getQuery.bind(e),getQueryObject:e.getQueryParameter.bind(e),queryCounter:t.queryCounterEXT.bind(t)})}else{const t=e.getExtension("EXT_disjoint_timer_query");t&&(this._timerQuery={createQuery:t.createQueryEXT.bind(t),deleteQuery:t.deleteQueryEXT.bind(t),beginQuery:t.beginQueryEXT.bind(t),endQuery:t.endQueryEXT.bind(t),isQuery:t.isQueryEXT.bind(t),getQuery:t.getQueryEXT.bind(t),getQueryObject:t.getQueryObjectEXT.bind(t),queryCounter:t.queryCounterEXT.bind(t)})}this._query=this._timerQuery?this._timerQuery.createQuery():null}get gpuTimerSupported(){return!!this._query}begin(){1===this._state&&this.end(),this._query&&this._timerQuery.beginQuery(35007,this._query),this._gpuTime=null,this._state=1}end(){1===this._state&&(this._query&&this._timerQuery.endQuery(35007),this._state=2)}ended(){return 1!==this._state}elapsed(){if(2===this._state&&null===this._gpuTime&&this._query&&this._timerQuery.getQueryObject(this._query,Ac.QUERY_RESULT_AVAILABLE)){this._device.context.getParameter(36795)||(this._gpuTime=Number(this._timerQuery.getQueryObject(this._query,Ac.QUERY_RESULT))/1e6)}return this._gpuTime}}class _d{_isWebGL2;_extDrawBuffers;_extFloatBlending;maxDrawBuffers;maxColorAttachmentBytesPerSample;supportMultisampledFramebuffer;supportFloatBlending;supportDepth32float;supportDepth32floatStencil8;constructor(t){this._isWebGL2=Mc(t),this._extDrawBuffers=this._isWebGL2?null:t.getExtension("WEBGL_draw_buffers"),this._extFloatBlending=t.getExtension("EXT_float_blend"),this.maxDrawBuffers=this._isWebGL2||this._extDrawBuffers?Math.min(t.getParameter(Ac.MAX_COLOR_ATTACHMENTS),t.getParameter(Ac.MAX_DRAW_BUFFERS)):1,this.maxColorAttachmentBytesPerSample=16*this.maxDrawBuffers,this.supportMultisampledFramebuffer=Mc(t),this.supportFloatBlending=!!this._extFloatBlending,this.supportDepth32float=this._isWebGL2,this.supportDepth32floatStencil8=this._isWebGL2}}class gd{_isWebGL2;_extIndexUint32;_extBlendMinMax;supportOversizedViewport;supportBlendMinMax;support32BitIndex;supportDepthClamp;maxBindGroups;maxTexCoordIndex;constructor(t){this._isWebGL2=Mc(t),this._extBlendMinMax=null,this._extIndexUint32=Mc?t.getExtension("OES_element_index_uint"):null,this._isWebGL2?(this.supportBlendMinMax=!0,this.support32BitIndex=!0):(this._extBlendMinMax=t.getExtension("EXT_blend_minmax"),this.supportBlendMinMax=!!this._extBlendMinMax,this.support32BitIndex=!!this._extIndexUint32),this.supportOversizedViewport=!0,this.supportDepthClamp=!1,this.maxBindGroups=4,this.maxTexCoordIndex=8}}class xd{_extFragDepth;_extStandardDerivatives;_extShaderTextureLod;supportFragmentDepth;supportStandardDerivatives;supportShaderTextureLod;supportHighPrecisionFloat;supportHighPrecisionInt;maxUniformBufferSize;uniformBufferOffsetAlignment;maxStorageBufferSize;storageBufferOffsetAlignment;constructor(t){this._extFragDepth=null,this._extStandardDerivatives=null,this.maxStorageBufferSize=0,this.storageBufferOffsetAlignment=0,Mc(t)?(this.supportFragmentDepth=!0,this.supportStandardDerivatives=!0,this.supportShaderTextureLod=!0,this.supportHighPrecisionFloat=!0,this.maxUniformBufferSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE)||16384,this.uniformBufferOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT)||256):(this._extFragDepth=t.getExtension("EXT_frag_depth"),this.supportFragmentDepth=!!this._extFragDepth,this._extStandardDerivatives=t.getExtension("OES_standard_derivatives"),this.supportStandardDerivatives=!!this._extStandardDerivatives,this._extShaderTextureLod=t.getExtension("EXT_shader_texture_lod"),this.supportShaderTextureLod=!!this._extShaderTextureLod,this.supportHighPrecisionFloat=t.getShaderPrecisionFormat&&!!t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT)?.precision&&!!t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT)?.precision,this.maxUniformBufferSize=0,this.uniformBufferOffsetAlignment=1)}}class bd{_isWebGL2;_extS3TC;_extS3TCSRGB;_extBPTC;_extRGTC;_extASTC;_extTextureFilterAnisotropic;_extDepthTexture;_extSRGB;_extTextureFloat;_extTextureFloatLinear;_extTextureHalfFloat;_extTextureHalfFloatLinear;_textureFormatInfos;maxTextureSize;maxCubeTextureSize;npo2Mipmapping;npo2Repeating;supportS3TC;supportS3TCSRGB;supportBPTC;supportRGTC;supportASTC;supportDepthTexture;support3DTexture;supportSRGBTexture;supportFloatTexture;supportLinearFloatTexture;supportHalfFloatTexture;supportLinearHalfFloatTexture;supportAnisotropicFiltering;supportFloatColorBuffer;supportHalfFloatColorBuffer;supportFloatBlending;constructor(t){if(this._isWebGL2=Mc(t),this._extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.supportAnisotropicFiltering=!!this._extTextureFilterAnisotropic,this._isWebGL2?this.supportDepthTexture=!0:(this._extDepthTexture=t.getExtension("WEBGL_depth_texture"),this.supportDepthTexture=!!this._extDepthTexture),this.support3DTexture=this._isWebGL2,this._extSRGB=this._isWebGL2?null:t.getExtension("EXT_sRGB"),this.supportSRGBTexture=this._isWebGL2||!!this._extSRGB,this._isWebGL2?this.supportFloatTexture=!0:(this._extTextureFloat=t.getExtension("OES_texture_float"),this.supportFloatTexture=!!this._extTextureFloat),this._extTextureFloatLinear=t.getExtension("OES_texture_float_linear"),this.supportLinearFloatTexture=!!this._extTextureFloatLinear,this._isWebGL2?(this.supportHalfFloatTexture=!0,this.supportLinearHalfFloatTexture=!0):(this._extTextureHalfFloat=t.getExtension("OES_texture_half_float"),this.supportHalfFloatTexture=!!this._extTextureHalfFloat,this._extTextureHalfFloatLinear=t.getExtension("OES_texture_half_float_linear"),this.supportLinearHalfFloatTexture=!!this._extTextureHalfFloatLinear),this._isWebGL2?t.getExtension("EXT_color_buffer_float")?(this.supportHalfFloatColorBuffer=!0,this.supportFloatColorBuffer=!0):t.getExtension("EXT_color_buffer_half_float")?(this.supportHalfFloatColorBuffer=!0,this.supportFloatColorBuffer=!1):(this.supportHalfFloatColorBuffer=!1,this.supportFloatColorBuffer=!1):(this.supportFloatColorBuffer=!!t.getExtension("WEBGL_color_buffer_float"),this.supportHalfFloatColorBuffer=!!t.getExtension("EXT_color_buffer_half_float")),this.supportFloatBlending=this.supportFloatColorBuffer&&!!t.getExtension("EXT_float_blend"),this._extS3TC=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),this.supportS3TC=!!this._extS3TC,this._extS3TCSRGB=t.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.supportS3TCSRGB=!!this._extS3TCSRGB,this._extBPTC=t.getExtension("EXT_texture_compression_bptc"),this.supportBPTC=!!this._extBPTC,this._extRGTC=t.getExtension("EXT_texture_compression_rgtc"),this.supportRGTC=!!this._extRGTC,this._extASTC=t.getExtension("WEBGL_compressed_texture_astc"),this.supportASTC=!!this._extASTC,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._isWebGL2?(this.npo2Mipmapping=!0,this.npo2Repeating=!0):(this.npo2Mipmapping=!1,this.npo2Repeating=!1),this._textureFormatInfos={rgba8unorm:{glFormat:t.RGBA,glInternalFormat:this._isWebGL2?t.RGBA8:t.RGBA,glType:[t.UNSIGNED_BYTE,t.UNSIGNED_SHORT_4_4_4_4,t.UNSIGNED_SHORT_5_5_5_1],filterable:!0,renderable:!0,compressed:!1}},this.supportASTC)for(const e of["4x4","5x4","5x5","6x5","6x6","8x5","8x6","8x8","10x5","10x6","10x8","10x10","12x10","12x12"])this._textureFormatInfos[`astc-${e}`]={glFormat:t.NONE,glInternalFormat:this._extASTC[`COMPRESSED_RGBA_ASTC_${e}_KHR`],glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos[`astc-${e}-srgb`]={glFormat:t.NONE,glInternalFormat:this._extASTC[`COMPRESSED_SRGB8_ALPHA8_ASTC_${e}_KHR`],glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0};this.supportS3TC&&(this._textureFormatInfos.dxt1={glFormat:t.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos.dxt3={glFormat:t.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos.dxt5={glFormat:t.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0}),this.supportS3TCSRGB&&(this._textureFormatInfos["dxt1-srgb"]={glFormat:t.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos["dxt3-srgb"]={glFormat:t.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos["dxt5-srgb"]={glFormat:t.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0}),this.supportRGTC&&(this._textureFormatInfos.bc4={glFormat:t.NONE,glInternalFormat:this._extRGTC.COMPRESSED_RED_RGTC1_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos["bc4-signed"]={glFormat:t.NONE,glInternalFormat:this._extRGTC.COMPRESSED_SIGNED_RED_RGTC1_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos.bc5={glFormat:t.NONE,glInternalFormat:this._extRGTC.COMPRESSED_RED_GREEN_RGTC2_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos["bc5-signed"]={glFormat:t.NONE,glInternalFormat:this._extRGTC.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0}),this.supportBPTC&&(this._textureFormatInfos.bc6h={glFormat:t.NONE,glInternalFormat:this._extBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos["bc6h-signed"]={glFormat:t.NONE,glInternalFormat:this._extBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos.bc7={glFormat:t.NONE,glInternalFormat:this._extBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0},this._textureFormatInfos["bc7-srgb"]={glFormat:t.NONE,glInternalFormat:this._extBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0}),Mc(t)?(this._textureFormatInfos.r8unorm={glFormat:t.RED,glInternalFormat:t.R8,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1},this._textureFormatInfos.r8snorm={glFormat:t.RED,glInternalFormat:t.R8_SNORM,glType:[t.BYTE],filterable:!0,renderable:!1,compressed:!1},this._textureFormatInfos.r16f={glFormat:t.RED,glInternalFormat:t.R16F,glType:[t.HALF_FLOAT,t.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1},this._textureFormatInfos.r32f={glFormat:t.RED,glInternalFormat:t.R32F,glType:[t.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1},this._textureFormatInfos.r8ui={glFormat:t.RED_INTEGER,glInternalFormat:t.R8UI,glType:[t.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.r8i={glFormat:t.RED_INTEGER,glInternalFormat:t.R8I,glType:[t.BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.r16ui={glFormat:t.RED_INTEGER,glInternalFormat:t.R16UI,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.r16i={glFormat:t.RED_INTEGER,glInternalFormat:t.R16I,glType:[t.SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.r32ui={glFormat:t.RED_INTEGER,glInternalFormat:t.R32UI,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.r32i={glFormat:t.RED_INTEGER,glInternalFormat:t.R32I,glType:[t.INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg8unorm={glFormat:t.RG,glInternalFormat:t.RG8,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1},this._textureFormatInfos.rg8snorm={glFormat:t.RG,glInternalFormat:t.RG8_SNORM,glType:[t.BYTE],filterable:!0,renderable:!1,compressed:!1},this._textureFormatInfos.rg16f={glFormat:t.RG,glInternalFormat:t.RG16F,glType:[t.HALF_FLOAT,t.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1},this._textureFormatInfos.rg32f={glFormat:t.RG,glInternalFormat:t.RG32F,glType:[t.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1},this._textureFormatInfos.rg8ui={glFormat:t.RG,glInternalFormat:t.RG8UI,glType:[t.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg8i={glFormat:t.RG,glInternalFormat:t.RG8I,glType:[t.BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg16ui={glFormat:t.RG,glInternalFormat:t.RG16UI,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg16i={glFormat:t.RG,glInternalFormat:t.RG16I,glType:[t.SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg32ui={glFormat:t.RG,glInternalFormat:t.RG32UI,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg32i={glFormat:t.RG,glInternalFormat:t.RG32I,glType:[t.INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos["rgba8unorm-srgb"]={glFormat:t.RGBA,glInternalFormat:t.SRGB8_ALPHA8,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1},this._textureFormatInfos.rgba8snorm={glFormat:t.RGBA,glInternalFormat:t.RGBA8_SNORM,glType:[t.BYTE],filterable:!0,renderable:!1,compressed:!1},this._textureFormatInfos.rgba16f={glFormat:t.RGBA,glInternalFormat:t.RGBA16F,glType:[t.HALF_FLOAT,t.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1},this._textureFormatInfos.rgba32f={glFormat:t.RGBA,glInternalFormat:t.RGBA32F,glType:[t.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1},this._textureFormatInfos.rgba8ui={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA8UI,glType:[t.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rgba8i={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA8I,glType:[t.BYTE],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rgba16ui={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA16UI,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rgba16i={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA16I,glType:[t.SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rgba32ui={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA32UI,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rgba32i={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA32I,glType:[t.INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.rg11b10uf={glFormat:t.RGB,glInternalFormat:t.R11F_G11F_B10F,glType:[t.UNSIGNED_INT_10F_11F_11F_REV],filterable:!0,renderable:!1,compressed:!1},this._textureFormatInfos.d16={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT16,glType:[t.UNSIGNED_SHORT,t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d24={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT24,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d32f={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT32F,glType:[t.FLOAT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d24s8={glFormat:t.DEPTH_STENCIL,glInternalFormat:t.DEPTH24_STENCIL8,glType:[t.UNSIGNED_INT_24_8],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d32fs8={glFormat:t.DEPTH_STENCIL,glInternalFormat:t.DEPTH32F_STENCIL8,glType:[t.FLOAT_32_UNSIGNED_INT_24_8_REV],filterable:!1,renderable:!0,compressed:!1}):(this.supportFloatTexture&&(this._textureFormatInfos.rgba32f={glFormat:t.RGBA,glInternalFormat:t.RGBA,glType:[t.FLOAT,t.UNSIGNED_BYTE,t.UNSIGNED_SHORT_4_4_4_4,t.UNSIGNED_SHORT_5_5_5_1],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1}),this.supportHalfFloatTexture&&(this._textureFormatInfos.rgba16f={glFormat:t.RGBA,glInternalFormat:t.RGBA,glType:[this._extTextureHalfFloat.HALF_FLOAT_OES,t.UNSIGNED_BYTE,t.UNSIGNED_SHORT_4_4_4_4,t.UNSIGNED_SHORT_5_5_5_1],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1}),this.supportSRGBTexture&&(this._textureFormatInfos["rgba8unorm-srgb"]={glFormat:this._extSRGB.SRGB_ALPHA_EXT,glInternalFormat:this._extSRGB.SRGB_ALPHA_EXT,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!1,compressed:!1}),this.supportDepthTexture&&(this._textureFormatInfos.d16={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d24={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1},this._textureFormatInfos.d24s8={glFormat:t.DEPTH_STENCIL,glInternalFormat:t.DEPTH_STENCIL,glType:[this._extDepthTexture.UNSIGNED_INT_24_8_WEBGL],filterable:!1,renderable:!0,compressed:!1}))}calcMemoryUsage(t,e,i){switch(t){case"d16":case"d24":case"d24s8":case"d32f":return e===Ac.UNSIGNED_SHORT?2*i:4*i;case"d32fs8":case"rg32f":case"rg32i":case"rg32ui":case"rgba16i":case"rgba16ui":return 8*i;case"dxt1":case"dxt1-srgb":return i/2;case"dxt3":case"dxt3-srgb":case"dxt5":case"dxt5-srgb":case"r8unorm":case"r8snorm":case"r8i":case"r8ui":return i;case"r16f":return e===Ac.HALF_FLOAT?2*i:4*i;case"r16i":case"r16ui":case"rg8unorm":case"rg8snorm":case"rg8i":case"rg8ui":return 2*i;case"r32f":case"r32i":case"r32ui":case"rg16i":case"rg16ui":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8i":case"rgba8ui":return 4*i;case"rg16f":return e===Ac.HALF_FLOAT?4*i:8*i;case"rgba16f":return e===Ac.HALF_FLOAT?8*i:16*i;case"rgba32f":case"rgba32i":case"rgba32ui":return 16*i;default:return 0}}getTextureFormatInfo(t){return this._textureFormatInfos[t]}}class wd extends id{_structure;_data;constructor(t,e,i,s){if(!e?.isStructType())throw new Error("invalid structure type");if(i&Ls.BF_INDEX)throw new Error("structured buffer must not have Index usage flag");if(i&Ls.BF_READ||i&Ls.BF_WRITE)throw new Error("structured buffer must not have Read or Write usage flags");if(i&Ls.BF_VERTEX){if(1!==e.structMembers.length||!e.structMembers[0].type.isArrayType())throw new Error("structured buffer for vertex usage must have only one array member");if(!wd.isValidArrayElementType(e.structMembers[0].type.elementType))throw new Error("invalid vertex data type when creating vertex buffer")}const r=e.toBufferLayout(0,e.layout);if(s&&r.byteSize!==s.byteLength)throw new Error(`create structured buffer failed: invalid source size: ${s.byteLength}, should be ${r.byteSize}`);const n=!t.isWebGL2&&0!=(i&Ls.BF_UNIFORM);super(t,i,s||r.byteSize,n),this._data=new oa(r,n?this.systemMemoryBuffer:this),this._structure=e}set(t,e){this._data.set(t,e)}get structure(){return this._structure}set structure(t){if(t&&!t.isCompatibleType(this._structure)){const e=t.toBufferLayout(0,t.layout);if(e.byteSize>this.byteLength)throw new Error(`set structure type failed: new structure type is too large: ${e.byteSize}`);this._data=new oa(e,this),this._structure=t}}getUniformData(){return this._data}static isValidArrayElementType(t){if(t.isPrimitiveType())return t.scalarType!==Bt.BOOL&&!t.isMatrixType();if(t.isStructType()){for(const e of t.structMembers)if(!e.type.isPrimitiveType()||e.type.scalarType===Bt.BOOL||e.type.isMatrixType())return!1;return!0}return!1}}class Td extends qc{_layout;_dynamicOffsets;_resources;constructor(t,e){super(t),this._device=t,this._layout=e,this._dynamicOffsets=null,this._resources={},this._object={};for(const t of this._layout.entries)t.buffer&&t.buffer.hasDynamicOffset&&(this._dynamicOffsets||(this._dynamicOffsets=[]),this._dynamicOffsets[t.buffer.dynamicOffsetIndex]=0)}getGPUId(){return String(this._uid)}getLayout(){return this._layout}getBuffer(t){return this._getBuffer(t,!0)}getDynamicOffsets(){return this._dynamicOffsets}setBuffer(t,e,i,s,r){const n=this._layout.nameMap?.[t]??t;for(const s of this._layout.entries)if(s.name===n)return void(s.buffer?(!e||e.usage&Ls.BF_UNIFORM?e!==this._resources[s.name]&&(this._resources[s.name]=e):console.log(`setBuffer() failed: buffer resource '${t}' must be type '${s.buffer.type}'`),s.buffer.hasDynamicOffset&&(this._dynamicOffsets[s.buffer.dynamicOffsetIndex]=i??0)):console.log(`setBuffer() failed: resource '${t}' is not buffer`));console.log(`setBuffer() failed: no buffer resource named '${t}'`)}setRawData(t,e,i,s,r){const n=this._layout.nameMap?.[t];if(n)this.setRawData(n,e,i,s,r);else{const n=this._getBuffer(t,!1);n?n.bufferSubData(e,i,s,r):console.log(`set(): no uniform buffer named '${t}'`)}}setValue(t,e){const i=this._layout.nameMap?.[t];if(i)this.setValue(i,{[t]:e});else{const i=this._getBuffer(t,!1);if(i){if(!(i instanceof wd))throw new Error(`BindGroup.setValue() failed: '${t}' is not structured buffer`);if(e?.BYTES_PER_ELEMENT)i.bufferSubData(0,e);else for(const t in e)i.set(t,e[t])}else console.log(`set(): no uniform buffer named '${t}'`)}}setTextureView(t,e,i,s,r,n){throw new Error("setTextureView() not supported for webgl device")}getTexture(t){if(this._findTextureLayout(t))return this._resources[t]?.[0]||null;throw new Error(`getTexture() failed:${t} is not a texture`)}setTexture(t,e,i){const s=this._findTextureLayout(t);s?this._resources[t]=[e,i||e.getDefaultSampler(!!s.texture?.autoBindSamplerComparison)]:console.log(`setTexture() failed: no texture uniform named '${t}'`)}setSampler(t,e){}apply(t,e){const i=this._device.isWebGL2,s=e??this.getDynamicOffsets();for(let e=0;e<this._layout.entries.length;e++){const r=this._layout.entries[e],n=this._resources[r.name];n instanceof id?i?r.buffer.hasDynamicOffset?t.setBlock(r.type.structName,n,s[r.buffer.dynamicOffsetIndex]):t.setBlock(r.type.structName,n,0):n instanceof wd&&t.setUniform(r.name,n.getUniformData().uniforms):Array.isArray(n)&&(n[0].isTextureVideo()&&n[0].updateVideoFrame(),t.setUniform(r.name,n))}}destroy(){this._resources={},this._object=null}async restore(){this._object={}}isBindGroup(){return!0}_getBuffer(t,e=!1){const i=this._layout.nameMap?.[t]??t;for(const t of this._layout.entries)if(t.buffer&&t.name===i){let i=this._resources[t.name];return i||e||(i=this._device.createStructuredBuffer(t.type,{usage:"uniform"}),this._resources[t.name]=i),i}return null}_findTextureLayout(t){for(const e of this._layout.entries)if((e.texture||e.storageTexture||e.externalTexture)&&e.name===t)return e;return null}}class vd extends qc{_vs;_fs;_unitCounter;_uniformSetters;_uniformInfo;_blockInfo;_bindGroupLayouts;_vertexAttributes;_error;_vertexShader;_fragmentShader;constructor(t,e,i,s,r){super(t),this._object=this._device.context.createProgram(),this._unitCounter=0,this._uniformSetters=null,this._uniformInfo=null,this._blockInfo=null,this._error="",this._vertexShader=null,this._fragmentShader=null,this._vs=e,this._fs=i,this._bindGroupLayouts=[...s],this._vertexAttributes=[...r],this.load()}get type(){return"render"}getCompileError(){return this._error}getShaderSource(t){switch(t){case"vertex":return this._vs;case"fragment":return this._fs;case"compute":return null}}getBindingInfo(t){for(let e=0;e<this._bindGroupLayouts.length;e++){const i=this._bindGroupLayouts[e],s=i.nameMap?.[t]??t;for(let t=0;t<i.entries.length;t++){const r=i.entries[t];if(r.name===s)return{group:e,binding:t,type:r.type}}}return null}get bindGroupLayouts(){return this._bindGroupLayouts}get vertexAttributes(){return this._vertexAttributes}setUniform(t,e){const i=this._uniformSetters[t];if(i)i(e);else{const i=Object.getPrototypeOf(e);i===Object.getPrototypeOf({})?this._setUniformStruct(t,e):i==Object.getPrototypeOf([])&&this._setUniformArray(t,e)}}setBlock(t,e,i){const s=this._blockInfo[t];s?this._device.bindUniformBuffer(s.index,e,i):console.error(`Block not found: ${t}`)}destroy(){this._object&&(this._device.context.deleteProgram(this._object),this._object=null,this._unitCounter=0,this._uniformSetters=null,this._uniformInfo=null,this._blockInfo=null,this._error="",this._vertexShader=null,this._fragmentShader=null)}async restore(){this._object||this._device.isContextLost()||this.load()}isProgram(){return!0}use(){return!(this!==this._device.context._currentProgram&&!this.checkLoad())}createUniformBuffer(t){const e=this.getBindingInfo(t)?.type;return e?this.device.createStructuredBuffer(e,{usage:"uniform"}):null}_setUniformStruct(t,e){for(const i in e)this.setUniform(`${t}.${i}`,e[i])}_setUniformArray(t,e){for(let i=0;i<e.length;i++)this.setUniform(`${t}[${i}]`,e[i])}load(){if(this._device.isContextLost())return;const t=this._device.context;this._error=null,this._uniformSetters={},this._object||(this._object=this._device.context.createProgram()),this._vertexShader=t.createShader(Ac.VERTEX_SHADER),t.attachShader(this._object,this._vertexShader),t.shaderSource(this._vertexShader,this._vs),t.compileShader(this._vertexShader),this._fragmentShader=t.createShader(Ac.FRAGMENT_SHADER),t.attachShader(this._object,this._fragmentShader),t.shaderSource(this._fragmentShader,this._fs),t.compileShader(this._fragmentShader);for(let e=0;e<zs.length;e++)t.bindAttribLocation(this._object,e,zs[e]);t.linkProgram(this._object)}checkLoad(){if(!this._object)return!1;if(this._vertexShader){const t=this._device.context;if(this._device.isContextLost()||t.getProgramParameter(this._object,Ac.LINK_STATUS)||(t.getShaderParameter(this._vertexShader,Ac.COMPILE_STATUS)?t.getShaderParameter(this._fragmentShader,Ac.COMPILE_STATUS)?(this._error=t.getProgramInfoLog(this._object),console.error(new Error(`Load program failed: \n${this._error}`))):(this._error=t.getShaderInfoLog(this._fragmentShader),console.error(new Error(`Compile shader failed: ${this._error}`))):(this._error=t.getShaderInfoLog(this._vertexShader),console.error(new Error(`Compile shader failed: ${this._error}`)))),t.deleteShader(this._vertexShader),this._vertexShader=null,t.deleteShader(this._fragmentShader),this._fragmentShader=null,this._error)return t.deleteProgram(this._object),this._object=null,!1;this._device.context._currentProgram=this,this._device.context.useProgram(this._object),this._uniformSetters=this.createUniformSetters()}else this._device.context._currentProgram=this,this._device.context.useProgram(this._object);return!0}createUniformSetter(t){const e=t.location,i=t.isArray,s=this._device.context;switch(t.type){case Ac.FLOAT:return this.getUniformSetterfv(e);case Ac.FLOAT_VEC2:return this.getUniformSetter2fv(e);case Ac.FLOAT_VEC3:return this.getUniformSetter3fv(e);case Ac.FLOAT_VEC4:return this.getUniformSetter4fv(e);case Ac.INT:return this.getUniformSetteriv(e);case Ac.INT_VEC2:return this.getUniformSetter2iv(e);case Ac.INT_VEC3:return this.getUniformSetter3iv(e);case Ac.INT_VEC4:return this.getUniformSetter4iv(e);case Ac.UNSIGNED_INT:return this.getUniformSetteruiv(e);case Ac.UNSIGNED_INT_VEC2:return this.getUniformSetter2uiv(e);case Ac.UNSIGNED_INT_VEC3:return this.getUniformSetter3uiv(e);case Ac.UNSIGNED_INT_VEC4:return this.getUniformSetter4uiv(e);case Ac.BOOL:return this.getUniformSetteriv(e);case Ac.BOOL_VEC2:return this.getUniformSetter2iv(e);case Ac.BOOL_VEC3:return this.getUniformSetter3iv(e);case Ac.BOOL_VEC4:return this.getUniformSetter4iv(e);case Ac.FLOAT_MAT2:return this.getUniformSetterMatrix2(e);case Ac.FLOAT_MAT2x3:return this.getUniformSetterMatrix23(e);case Ac.FLOAT_MAT2x4:return this.getUniformSetterMatrix24(e);case Ac.FLOAT_MAT3:return this.getUniformSetterMatrix3(e);case Ac.FLOAT_MAT3x2:return this.getUniformSetterMatrix32(e);case Ac.FLOAT_MAT3x4:return this.getUniformSetterMatrix34(e);case Ac.FLOAT_MAT4:return this.getUniformSetterMatrix4(e);case Ac.FLOAT_MAT4x2:return this.getUniformSetterMatrix42(e);case Ac.FLOAT_MAT4x3:return this.getUniformSetterMatrix43(e);case Ac.SAMPLER_2D:case Ac.SAMPLER_2D_SHADOW:case Ac.INT_SAMPLER_2D:case Ac.UNSIGNED_INT_SAMPLER_2D:{const r=this._unitCounter;if(this._unitCounter+=t.size,!i)return s.uniform1i(e,r),this.getSamplerSetter(e,Ac.TEXTURE_2D,r)}case Ac.SAMPLER_2D_ARRAY:case Ac.SAMPLER_2D_ARRAY_SHADOW:case Ac.INT_SAMPLER_2D_ARRAY:case Ac.UNSIGNED_INT_SAMPLER_2D_ARRAY:{const r=this._unitCounter;if(this._unitCounter+=t.size,!i)return s.uniform1i(e,r),this.getSamplerSetter(e,Ac.TEXTURE_2D_ARRAY,r)}case Ac.SAMPLER_CUBE:case Ac.SAMPLER_CUBE_SHADOW:case Ac.INT_SAMPLER_CUBE:case Ac.UNSIGNED_INT_SAMPLER_CUBE:{const r=this._unitCounter;if(this._unitCounter+=t.size,!i)return s.uniform1i(e,r),this.getSamplerSetter(e,Ac.TEXTURE_CUBE_MAP,r)}case Ac.SAMPLER_3D:case Ac.INT_SAMPLER_3D:case Ac.UNSIGNED_INT_SAMPLER_3D:{const r=this._unitCounter;if(this._unitCounter+=t.size,!i)return s.uniform1i(e,r),this.getSamplerSetter(e,Ac.TEXTURE_3D,r)}}return console.error(`Error: unsupported uniform type: ${t.name}`),null}createUniformSetters(){const t={},e=this._device.context,i=e.getProgramParameter(this._object,Ac.ACTIVE_UNIFORMS);this._uniformInfo=[];for(let s=0;s<i;s++){const i=e.getActiveUniform(this._object,s);let r=i.name,n=!1;if(r.startsWith("gl_")||r.startsWith("webgl_"))this._uniformInfo.push(null);else{"[0]"===r.substr(-3)&&(r=r.substr(0,r.length-3),n=!0);const a=i.size,o=i.type,h=-1,l=0,u=e.getUniformLocation(this._object,i.name),c=null,{ctor:d,elementSize:p}=this.getTypedArrayInfo(i.type),m={index:s,name:r,size:a,type:o,blockIndex:h,offset:l,isArray:n,location:u,view:c,viewCtor:d,viewElementSize:p};this._uniformInfo.push(m),u&&(t[r]=this.createUniformSetter(m))}}if(Mc(e)){this._blockInfo={};const t=e.getProgramParameter(this._object,Ac.ACTIVE_UNIFORM_BLOCKS);for(let i=0;i<t;i++){const t=e.getActiveUniformBlockName(this._object,i),s=e.getUniformBlockIndex(this._object,t),r=!!e.getActiveUniformBlockParameter(this._object,i,Ac.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER),n=!!e.getActiveUniformBlockParameter(this._object,i,Ac.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER),a=r||n,o=e.getActiveUniformBlockParameter(this._object,i,Ac.UNIFORM_BLOCK_DATA_SIZE),h=e.getActiveUniformBlockParameter(this._object,i,Ac.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES);this._blockInfo[t]={index:s,used:a,size:o,uniformIndices:h},e.uniformBlockBinding(this._object,s,s)}}return t}getUniformSetterfv(t){return e=>{this._device.context.uniform1fv(t,e)}}getUniformSetter2fv(t){return e=>{this._device.context.uniform2fv(t,e)}}getUniformSetter3fv(t){return e=>{this._device.context.uniform3fv(t,e)}}getUniformSetter4fv(t){return e=>{this._device.context.uniform4fv(t,e)}}getUniformSetteriv(t){return e=>{this._device.context.uniform1iv(t,e)}}getUniformSetter2iv(t){return e=>{this._device.context.uniform2iv(t,e)}}getUniformSetter3iv(t){return e=>{this._device.context.uniform3iv(t,e)}}getUniformSetter4iv(t){return e=>{this._device.context.uniform4iv(t,e)}}getUniformSetteruiv(t){return e=>{this._device.context.uniform1uiv(t,e)}}getUniformSetter2uiv(t){return e=>{this._device.context.uniform2uiv(t,e)}}getUniformSetter3uiv(t){return e=>{this._device.context.uniform3uiv(t,e)}}getUniformSetter4uiv(t){return e=>{this._device.context.uniform4uiv(t,e)}}getUniformSetterMatrix2(t){return e=>{this._device.context.uniformMatrix2fv(t,!1,e)}}getUniformSetterMatrix23(t){return e=>{this._device.context.uniformMatrix2x3fv(t,!1,e)}}getUniformSetterMatrix24(t){return e=>{this._device.context.uniformMatrix2x4fv(t,!1,e)}}getUniformSetterMatrix32(t){return e=>{this._device.context.uniformMatrix3x2fv(t,!1,e)}}getUniformSetterMatrix3(t){return e=>{this._device.context.uniformMatrix3fv(t,!1,e)}}getUniformSetterMatrix34(t){return e=>{this._device.context.uniformMatrix3x4fv(t,!1,e)}}getUniformSetterMatrix42(t){return e=>{this._device.context.uniformMatrix4x2fv(t,!1,e)}}getUniformSetterMatrix43(t){return e=>{this._device.context.uniformMatrix4x3fv(t,!1,e)}}getUniformSetterMatrix4(t){return e=>{this._device.context.uniformMatrix4fv(t,!1,e)}}getSamplerSetter(t,e,i){return t=>this._device.bindTexture(e,i,t[0],t[1])}getTypedArrayInfo(t){let e=null,i=0;switch(t){case Ac.INT:e=Int32Array,i=4;break;case Ac.INT_VEC2:e=Int32Array,i=8;break;case Ac.INT_VEC3:e=Int32Array,i=12;break;case Ac.INT_VEC4:e=Int32Array,i=16;break;case Ac.UNSIGNED_INT:case Ac.BOOL:e=Uint32Array,i=4;break;case Ac.UNSIGNED_INT_VEC2:case Ac.BOOL_VEC2:e=Uint32Array,i=8;break;case Ac.UNSIGNED_INT_VEC3:case Ac.BOOL_VEC3:e=Uint32Array,i=12;break;case Ac.UNSIGNED_INT_VEC4:case Ac.BOOL_VEC4:e=Uint32Array,i=16;break;case Ac.FLOAT:e=Float32Array,i=4;break;case Ac.FLOAT_VEC2:e=Float32Array,i=8;break;case Ac.FLOAT_VEC3:e=Float32Array,i=12;break;case Ac.FLOAT_VEC4:case Ac.FLOAT_MAT2:e=Float32Array,i=16;break;case Ac.FLOAT_MAT2x3:case Ac.FLOAT_MAT3x2:e=Float32Array,i=24;break;case Ac.FLOAT_MAT2x4:case Ac.FLOAT_MAT4x2:e=Float32Array,i=32;break;case Ac.FLOAT_MAT3:e=Float32Array,i=36;break;case Ac.FLOAT_MAT3x4:case Ac.FLOAT_MAT4x3:e=Float32Array,i=48;break;case Ac.FLOAT_MAT4:e=Float32Array,i=64}return{ctor:e,elementSize:i}}}class yd extends qc{_options;constructor(t,e){super(t),this._options=Object.assign({addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:"nearest",minFilter:"nearest",mipFilter:"none",lodMin:0,lodMax:32,compare:null,maxAnisotropy:1},e||{}),this._load()}get addressModeU(){return this._options.addressU}get addressModeV(){return this._options.addressV}get addressModeW(){return this._options.addressW}get magFilter(){return this._options.magFilter}get minFilter(){return this._options.minFilter}get mipFilter(){return this._options.mipFilter}get lodMin(){return this._options.lodMin}get lodMax(){return this._options.lodMax}get compare(){return this._options.compare}get maxAnisotropy(){return this._options.maxAnisotropy}destroy(){this._object&&Mc(this._device.context)&&this._device.context.deleteSampler(this._object),this._object=null}async restore(){this._object||this._device.isContextLost()||this._load()}apply(t){if(t?.object&&!this._device.isWebGL2&&!this._device.isContextLost()){const e=this._device.context,i=Gc[t.target];this._device.bindTexture(i,0,t),e.texParameteri(i,Ac.TEXTURE_WRAP_S,kc[this._options.addressU]),e.texParameteri(i,Ac.TEXTURE_WRAP_T,kc[this._options.addressV]),e.texParameteri(i,Ac.TEXTURE_MAG_FILTER,Wc(this._options.magFilter)),e.texParameteri(i,Ac.TEXTURE_MIN_FILTER,Hc(this._options.minFilter,this._options.mipFilter)),this._device.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&e.texParameterf(i,Ac.TEXTURE_MAX_ANISOTROPY,this._options.maxAnisotropy)}}_load(){if(!Mc(this._device.context))return this._object={},!0;if(!this._device.isContextLost()){const t=this._device.context;this._object||(this._object=t.createSampler()),t.samplerParameteri(this._object,Ac.TEXTURE_WRAP_S,kc[this._options.addressU]),t.samplerParameteri(this._object,Ac.TEXTURE_WRAP_T,kc[this._options.addressV]),t.samplerParameteri(this._object,Ac.TEXTURE_WRAP_R,kc[this._options.addressW]),t.samplerParameteri(this._object,Ac.TEXTURE_MAG_FILTER,Wc(this._options.magFilter)),t.samplerParameteri(this._object,Ac.TEXTURE_MIN_FILTER,Hc(this._options.minFilter,this._options.mipFilter)),t.samplerParameterf(this._object,Ac.TEXTURE_MIN_LOD,this._options.lodMin),t.samplerParameterf(this._object,Ac.TEXTURE_MAX_LOD,this._options.lodMax),null===this._options.compare?t.samplerParameteri(this._object,Ac.TEXTURE_COMPARE_MODE,Ac.NONE):(t.samplerParameteri(this._object,Ac.TEXTURE_COMPARE_MODE,Ac.COMPARE_REF_TO_TEXTURE),t.samplerParameteri(this._object,Ac.TEXTURE_COMPARE_FUNC,Oc[this._options.compare])),this._device.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&t.samplerParameterf(this._object,Ac.TEXTURE_MAX_ANISOTROPY,this._options.maxAnisotropy)}return!0}isSampler(){return!0}}class Ed{_device;_samplers;constructor(t){this._device=t,this._samplers={}}fetchSampler(t){const e=this.hash(t);let i=this._samplers[e];return i||(i=this.createSampler(t),this._samplers[e]=i),i}hash(t){return`${t.addressU?String(t.addressU):""}:${t.addressV?String(t.addressV):""}:${t.addressW?String(t.addressW):""}:${t.magFilter?String(t.magFilter):""}:${t.minFilter?String(t.minFilter):""}:${t.mipFilter?String(t.mipFilter):""}:${t.lodMin?String(t.lodMin):""}:${t.lodMax?String(t.lodMax):""}:${t.compare?String(t.compare):""}:${t.maxAnisotropy?String(t.maxAnisotropy):""}`}createSampler(t){return new yd(this._device,t)}}const Sd=te.getCachedTypeInfo(Bt.U16),Cd=new Int32Array(4),Ad=new Uint32Array(4);let Md=null,Rd=null;const Fd=s(class extends aa{_context;_isWebGL2;_msaaSampleCount;_loseContextExtension;_contextLost;_isRendering;_dpr;_reverseWindingOrder;_deviceCaps;_vaoExt;_instancedArraysExt;_drawBuffersExt;_currentProgram;_currentVertexData;_currentStateSet;_currentBindGroups;_currentBindGroupOffsets;_currentViewport;_currentScissorRect;_samplerCache;_textureSamplerMap;_captureRenderBundle;_deviceUniformBuffers;_deviceUniformBufferOffsets;_bindTextures;_bindSamplers;_adapterInfo;constructor(t,e,i){super(e,t),this._dpr=Math.max(1,Math.floor(i?.dpr??window.devicePixelRatio)),this._isRendering=!1,this._captureRenderBundle=null,this._msaaSampleCount=i?.msaa?4:1;let s=null;if(s=this.canvas.getContext(t===Dd?"webgl":"webgl2",{antialias:!!i?.msaa,depth:!0,stencil:!0,premultipliedAlpha:!1}),!s)throw new Error("Invalid argument or no webgl support");this._isWebGL2=Mc(s),this._adapterInfo={vendor:s.getParameter(s.VENDOR),renderer:s.getParameter(s.RENDERER),version:s.getParameter(s.VERSION)},this._contextLost=!1,this._reverseWindingOrder=!1,this._deviceCaps=null,this._context=s,this._currentProgram=null,this._currentVertexData=null,this._currentStateSet=null,this._currentBindGroups=[],this._currentBindGroupOffsets=[],this._currentViewport=null,this._currentScissorRect=null,this._deviceUniformBuffers=[],this._deviceUniformBufferOffsets=[],this._bindTextures={[Ac.TEXTURE_2D]:[],[Ac.TEXTURE_CUBE_MAP]:[],[Ac.TEXTURE_3D]:[],[Ac.TEXTURE_2D_ARRAY]:[]},this._bindSamplers=[],this._samplerCache=new Ed(this),this._textureSamplerMap=new WeakMap,this._loseContextExtension=this._context.getExtension("WEBGL_lose_context"),this.canvas.addEventListener("webglcontextlost",(t=>{this._contextLost=!0,t.preventDefault(),this.handleContextLost()}),!1),this.canvas.addEventListener("webglcontextrestored",(t=>{this._contextLost=!1,this.handleContextRestored()}),!1)}get context(){return this._context}getAdapterInfo(){return this._adapterInfo}getFrameBufferSampleCount(){return this.getFramebuffer()?.getSampleCount()??this._msaaSampleCount}get isWebGL2(){return this._isWebGL2}get drawingBufferWidth(){return this.getDrawingBufferWidth()}get drawingBufferHeight(){return this.getDrawingBufferHeight()}get clientWidth(){return this.canvas.clientWidth}get clientHeight(){return this.canvas.clientHeight}getScale(){return this._dpr}isContextLost(){return this._context.isContextLost()}getDeviceCaps(){return this._deviceCaps}get vaoExt(){return this._vaoExt}get instancedArraysExt(){return this._instancedArraysExt}get drawBuffersExt(){return this._drawBuffersExt}getDrawingBufferWidth(){return this._context._currentFramebuffer?.getWidth()||this._context.drawingBufferWidth}getDrawingBufferHeight(){return this._context._currentFramebuffer?.getHeight()||this._context.drawingBufferHeight}getBackBufferWidth(){return this.canvas.width}getBackBufferHeight(){return this.canvas.height}invalidateBindingTextures(){this._bindTextures={[Ac.TEXTURE_2D]:[],[Ac.TEXTURE_CUBE_MAP]:[],[Ac.TEXTURE_3D]:[],[Ac.TEXTURE_2D_ARRAY]:[]}}bindTexture(t,e,i,s){const r=i?.object??null,n=this._context;if(n.activeTexture(Ac.TEXTURE0+e),this._bindTextures[t][e]!==r&&(n.bindTexture(t,r),this._bindTextures[t][e]=r),this._isWebGL2){const t=s?.object??null;t&&this._bindSamplers[e]!==t&&(n.bindSampler(e,t),this._bindSamplers[e]=t)}else if(i&&s&&this._textureSamplerMap.get(i)!==s){const e=i.isWebGL1Fallback;this._textureSamplerMap.set(i,s),n.texParameteri(t,Ac.TEXTURE_WRAP_S,kc[s.addressModeU]),n.texParameteri(t,Ac.TEXTURE_WRAP_T,kc[s.addressModeV]),n.texParameteri(t,Ac.TEXTURE_MAG_FILTER,Wc(s.magFilter)),n.texParameteri(t,Ac.TEXTURE_MIN_FILTER,Hc(s.minFilter,e?"none":s.mipFilter)),this.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&n.texParameterf(t,Ac.TEXTURE_MAX_ANISOTROPY,s.maxAnisotropy)}}bindUniformBuffer(t,e,i){this._deviceUniformBuffers[t]===e.object&&this._deviceUniformBufferOffsets[t]===i||(i?this.context.bindBufferRange(Ac.UNIFORM_BUFFER,t,e.object,i,e.byteLength-i):this.context.bindBufferBase(Ac.UNIFORM_BUFFER,t,e.object),this._deviceUniformBuffers[t]=e.object,this._deviceUniformBufferOffsets[t]=i)}async initContext(){this.initContextState(),this.on("resize",(t=>{const e=Math.max(1,Math.round(this.canvas.clientWidth*this._dpr)),i=Math.max(1,Math.round(this.canvas.clientHeight*this._dpr));e===this.canvas.width&&i===this.canvas.height||(this.canvas.width=e,this.canvas.height=i,this.setViewport(this._currentViewport),this.setScissor(this._currentScissorRect))})),this.dispatchEvent(new At(this.canvas.clientWidth,this.canvas.clientHeight))}clearFrameBuffer(t,e,i){const s=this._context,r=t?s.COLOR_BUFFER_BIT:0,n="number"==typeof e?s.DEPTH_BUFFER_BIT:0,a="number"==typeof i?s.STENCIL_BUFFER_BIT:0;if(r||n||a){if(cd.applyDefaults(this._context),Mc(s)&&s._currentFramebuffer){if(n||a){s._currentFramebuffer.getDepthAttachment()&&s.clearBufferfi(Ac.DEPTH_STENCIL,0,e||1,i||0)}if(r){const e=s._currentFramebuffer.getColorAttachments();for(let i=0;i<e.length;i++)gt(e[i].format)?xt(e[i].format)?(Cd[0]=t[0],Cd[1]=t[1],Cd[2]=t[2],Cd[3]=t[3],s.clearBufferiv(Ac.COLOR,i,Cd)):(Ad[0]=t[0],Ad[1]=t[1],Ad[2]=t[2],Ad[3]=t[3],s.clearBufferuiv(Ac.COLOR,i,Ad)):s.clearBufferfv(Ac.COLOR,i,t)}}else s.clearColor(t[0],t[1],t[2],t[3]),s.clearDepth(e),s.clearStencil(i),s.clear(r|n|a);s._currentFramebuffer?.tagDraw()}}createGPUTimer(){return new fd(this)}createRenderStateSet(){return new pd(this._context)}createSampler(t){return this._samplerCache.fetchSampler(t)}createTextureFromMipmapData(t,e,i){if(!t)return console.error("Device.createTextureFromMipmapData() failed: invalid data"),null;if(t.isCubemap){const s=new Jc(this);return s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s}if(t.isVolume){const e=new Qc(this);return e.createWithMipmapData(t,this.parseTextureOptions(i)),e}if(t.isArray){const e=new Kc(this);return e.createWithMipmapData(t,this.parseTextureOptions(i)),e}{const s=new Zc(this);return s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s}}createTexture2D(t,e,i,s){const r=s?.texture??new Zc(this);return r.isTexture2D()?(r.createEmpty(t,e,i,this.parseTextureOptions(s)),r.samplerOptions=s?.samplerOptions??null,r):(console.error("createTexture2D() failed: options.texture must be 2d texture"),null)}createTexture2DFromMipmapData(t,e,i){const s=i?.texture??new Zc(this);return s.isTexture2D()?(s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createTexture2DFromMipmapData() failed: options.texture must be 2d texture"),null)}createTexture2DFromImage(t,e,i){const s=i?.texture??new Zc(this);return s.isTexture2D()?(s.loadFromElement(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createTexture2DFromImage() failed: options.texture must be 2d texture"),null)}createTexture2DArray(t,e,i,s,r){const n=r?.texture??new Kc(this);return n.isTexture2DArray()?(n.createEmpty(t,e,i,s,this.parseTextureOptions(r)),n.samplerOptions=r?.samplerOptions??null,n):(console.error("createTexture2DArray() failed: options.texture must be 2d array texture"),null)}createTexture2DArrayFromImages(t,e,i){if(!t||0===t.length)return console.error("createTexture2DArrayFromImages() failed: Invalid image elements"),null;let s=0,r=0;for(const e of t)if(0===s||0===r)s=e.width,r=e.height;else if(s!==e.width||r!==e.height)return console.error("createTexture2DArrayFromImages() failed: Image elements must have the same size"),null;if(i?.texture&&!i.texture.isTexture2DArray())return console.error("createTexture2DArrayFromImages() failed: options.texture must be 2d array texture"),null;let n=i?.texture;if(n){if(n.depth!==t.length)return console.error("createTexture2DArrayFromImages() failed: Layer count of options.texture not match the given image elements"),null;if(n.width!==s||n.height!==r)return console.error("createTexture2DArrayFromImages() failed: Size of options.texture not match the given image elements"),null}else{n=this.createTexture2DArray(e?"rgba8unorm-srgb":"rgba8unorm",s,r,t.length,i);for(let e=0;e<t.length;e++)n.updateFromElement(t[e],0,0,e,0,0,s,r)}return n.samplerOptions=i?.samplerOptions??null,n}createTexture3D(t,e,i,s,r){if(!this.isWebGL2)return console.error("device does not support 3d texture"),null;const n=r?.texture??new Qc(this);return n.isTexture3D()?(n.createEmpty(t,e,i,s,this.parseTextureOptions(r)),n.samplerOptions=r?.samplerOptions??null,n):(console.error("createTexture3D() failed: options.texture must be 3d texture"),null)}createCubeTexture(t,e,i){const s=i?.texture??new Jc(this);return s.isTextureCube()?(s.createEmpty(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createCubeTexture() failed: options.texture must be cube texture"),null)}createCubeTextureFromMipmapData(t,e,i){const s=i?.texture??new Jc(this);return s.isTextureCube()?(s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createCubeTextureFromMipmapData() failed: options.texture must be cube texture"),null)}createTexture2DArrayFromMipmapData(t,e){const i=e?.texture??new Kc(this);return i.isTexture2DArray()?(i.createWithMipmapData(t,this.parseTextureOptions(e)),i.samplerOptions=e?.samplerOptions??null,i):(console.error("createTexture2DArrayFromMipmapData() failed: options.texture must be 2d array texture"),null)}createTextureVideo(t,e){const i=new td(this,t);return i.samplerOptions=e??null,i}createGPUProgram(t){if("compute"===t.type)throw new Error("device does not support compute shader");const e=t.params;return new vd(this,e.vs,e.fs,e.bindGroupLayouts,e.vertexAttributes)}createBindGroup(t){return new Td(this,t)}createBuffer(t,e){return new id(this,this.parseBufferOptions(e),t,!this._isWebGL2)}copyBuffer(t,e,i,s,r){if(!this.isWebGL2)return void console.error("copyBuffer() is not supported for current device");const n=this._context;n.bindBuffer(n.COPY_READ_BUFFER,t.object),n.bindBuffer(n.COPY_WRITE_BUFFER,e.object),n.copyBufferSubData(n.COPY_READ_BUFFER,n.COPY_WRITE_BUFFER,i,s,r)}createIndexBuffer(t,e){return new nd(this,t,this.parseBufferOptions(e,"index"))}createStructuredBuffer(t,e,i){return new wd(this,t,this.parseBufferOptions(e),i)}createVertexLayout(t){return new ed(this,t)}createFrameBuffer(t,e,i){return new ad(this,t,e,i)}setBindGroup(t,e,i){if(i&&!Mc(this._context))throw new Error("setBindGroup(): no dynamic offset buffer support for WebGL1 device");this._currentBindGroups[t]=e,this._currentBindGroupOffsets[t]=i||null}getBindGroup(t){return[this._currentBindGroups[t],this._currentBindGroupOffsets[t]]}setViewport(t){null==t||!Array.isArray(t)&&t.default?this._currentViewport={x:0,y:0,width:this.deviceToScreen(this.drawingBufferWidth),height:this.deviceToScreen(this.drawingBufferHeight),default:!0}:Array.isArray(t)?this._currentViewport={x:t[0],y:t[1],width:t[2],height:t[3],default:!1}:this._currentViewport=Object.assign({default:!1},t),this._context.viewport(this.screenToDevice(this._currentViewport.x),this.screenToDevice(this._currentViewport.y),this.screenToDevice(this._currentViewport.width),this.screenToDevice(this._currentViewport.height))}getViewport(){return Object.assign({},this._currentViewport)}setScissor(t){null==t||!Array.isArray(t)&&t.default?this._currentScissorRect={x:0,y:0,width:this.deviceToScreen(this.drawingBufferWidth),height:this.deviceToScreen(this.drawingBufferHeight),default:!0}:Array.isArray(t)?this._currentScissorRect={x:t[0],y:t[1],width:t[2],height:t[3],default:!1}:this._currentScissorRect=Object.assign({default:!1},t),this._context.scissor(this.screenToDevice(this._currentScissorRect.x),this.screenToDevice(this._currentScissorRect.y),this.screenToDevice(this._currentScissorRect.width),this.screenToDevice(this._currentScissorRect.height))}getScissor(){return Object.assign({},this._currentScissorRect)}setProgram(t){this._currentProgram=t}getProgram(){return this._currentProgram}setVertexLayout(t){this._currentVertexData=t}getVertexLayout(){return this._currentVertexData}setRenderStates(t){this._currentStateSet=t}getRenderStates(){return this._currentStateSet}getFramebuffer(){return this._context._currentFramebuffer??null}reverseVertexWindingOrder(t){this._reverseWindingOrder!==!!t&&(this._reverseWindingOrder=!!t,this._context.frontFace(t?this._context.CW:this._context.CCW))}isWindingOrderReversed(){return!!this._reverseWindingOrder}flush(){this.context.flush()}async readPixels(t,e,i,s,r,n){const a=this.getFramebuffer(),o=a?a.getColorAttachments()[t]:null,h=o?o.format:"rgba8unorm";let l=Ac.NONE,u=Ac.NONE;const c=Tt(h);if(l=this.context.getParameter(Ac.IMPLEMENTATION_COLOR_READ_FORMAT),u=this.context.getParameter(Ac.IMPLEMENTATION_COLOR_READ_TYPE),(l!==Ac.RGBA||u!==Ac.UNSIGNED_BYTE&&u!==Ac.FLOAT)&&!Mc(this.context))throw new Error(`readPixels() failed: invalid format: ${h}`);const d=s*r*c;if(n.byteLength<d)throw new Error(`readPixels() failed: destination buffer must have at least ${d} bytes`);if(Mc(this.context)){const o=this.createBuffer(d,{usage:"read",managed:!1});this.context.bindBuffer(Ac.PIXEL_PACK_BUFFER,o.object),this.context.readBuffer(a?Ac.COLOR_ATTACHMENT0+t:Ac.COLOR_ATTACHMENT0),this.flush(),this.context.readPixels(e,i,s,r,l,u,0),this.context.bindBuffer(Ac.PIXEL_PACK_BUFFER,null);const h=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);await o.getBufferSubData(h),o.dispose()}else this.context.readPixels(e,i,s,r,l,u,n)}readPixelsToBuffer(t,e,i,s,r,n){const a=this.getFramebuffer(),o=a?a.getColorAttachments()[t]:null,h=o?o.format:"rgba8unorm";let l=Ac.NONE,u=Ac.NONE;if(!Mc(this.context))throw new Error("readPixels() failed: readPixels() requires webgl2 device");if(bt(h)||mt(h))throw new Error(`readPixels() failed: invalid format: ${h}`);const c=function(t){return!!(1&dt[t])}(h),d=function(t){return!!(2&dt[t])}(h),p=function(t){return!!(4&dt[t])}(h),m=function(t){return!!(8&dt[t])}(h),f=(c?1:0)+(d?1:0)+(p?1:0)+(m?1:0),_=Tt(h)/f,g=gt(h),x=_t(h),b=xt(h);c&&d&&p&&m?l=g?Ac.RGBA_INTEGER:Ac.RGBA:c&&d?l=g?Ac.RG_INTEGER:Ac.RG:c&&(l=g?Ac.RED_INTEGER:Ac.RED),1===_?u=b?Ac.BYTE:Ac.UNSIGNED_BYTE:2===_?u=x?Ac.HALF_FLOAT:b?Ac.SHORT:Ac.UNSIGNED_SHORT:4===_&&(u=x?Ac.FLOAT:b?Ac.INT:Ac.UNSIGNED_INT),this.context.bindBuffer(Ac.PIXEL_PACK_BUFFER,n.object),this.context.readBuffer(a?Ac.COLOR_ATTACHMENT0+t:Ac.COLOR_ATTACHMENT0),this.flush(),this.context.readPixels(e,i,s,r,l,u,0),this.context.bindBuffer(Ac.PIXEL_PACK_BUFFER,null)}looseContext(){this.context.isContextLost()||this._loseContextExtension?.loseContext()}restoreContext(){if(this.context.isContextLost()){this.clearErrors(),this._loseContextExtension?.restoreContext();const t=this.getError();t&&console.log(t)}}beginCapture(){if(this._captureRenderBundle)throw new Error("Device.beginCapture() failed: device is already capturing draw commands");this._captureRenderBundle=[]}endCapture(){if(!this._captureRenderBundle)throw new Error("Device.endCapture() failed: device is not capturing draw commands");const t=this._captureRenderBundle;return this._captureRenderBundle=null,t}executeRenderBundle(t){for(const e of t){this.setProgram(e.program),this.setVertexLayout(e.vertexLayout),this.setRenderStates(e.renderStateSet);for(let t=0;t<4;t++)this.setBindGroup(t,e.bindGroups[t],e.bindGroupOffsets[t]);0===e.numInstances?this.draw(e.primitiveType,e.first,e.count):this.drawInstanced(e.primitiveType,e.first,e.count,e.numInstances)}}_setFramebuffer(t){t!==this._context._currentFramebuffer&&(this._context._currentFramebuffer?.unbind(),t?.bind())}onBeginFrame(){return this._contextLost&&(this._context.isContextLost()||(this._contextLost=!1,this.handleContextRestored())),!this._contextLost}nextFrame(t){return requestAnimationFrame(t)}cancelNextFrame(t){cancelAnimationFrame(t)}onEndFrame(){}_draw(t,e,i){if(this._currentVertexData){if(this._currentVertexData.bind(),this._currentProgram){if(!this._currentProgram.use())return;for(let t=0;t<this._currentProgram.bindGroupLayouts.length;t++){const e=this._currentBindGroups[t];if(!e)return void console.error(`Missing bind group (${t}) when drawing with program '${this._currentProgram.name}'`);{const i=this._currentBindGroupOffsets[t];e.apply(this._currentProgram,i)}}}this._currentStateSet?this._currentStateSet.apply():pd.applyDefaults(this._context);const s=this._currentVertexData.indexBuffer;s?this.context.drawElements(Vc[t],i,zc[s.indexType.primitiveType],e*(s.indexType===Sd?2:4)):this.context.drawArrays(Vc[t],e,i),this._context._currentFramebuffer?.tagDraw()}if(this._captureRenderBundle){const s=this._currentStateSet?.clone()??this.createRenderStateSet();if(this._reverseWindingOrder){const t=s.rasterizerState;t?"back"===t.cullMode?t.cullMode="front":"front"===t.cullMode&&(t.cullMode="back"):s.useRasterizerState().setCullMode("front")}this._captureRenderBundle.push({bindGroups:[...this._currentBindGroups],bindGroupOffsets:this._currentBindGroupOffsets.map((t=>t?[...t]:null)),program:this._currentProgram,vertexLayout:this._currentVertexData,primitiveType:t,renderStateSet:s,count:i,first:e,numInstances:0})}}_drawInstanced(t,e,i,s){if(this.instancedArraysExt&&this._currentVertexData){if(this._currentVertexData.bind(),this._currentProgram){if(!this._currentProgram.use())return;for(let t=0;t<this._currentBindGroups.length;t++){const e=this._currentBindGroups[t];if(e){const i=this._currentBindGroupOffsets[t];e.apply(this._currentProgram,i)}}}this._currentStateSet?.apply();const r=this._currentVertexData.indexBuffer;r?this.instancedArraysExt.drawElementsInstanced(Vc[t],i,zc[r.indexType.primitiveType],e*(r.indexType===Sd?2:4),s):this.instancedArraysExt.drawArraysInstanced(Vc[t],e,i,s),this._context._currentFramebuffer?.tagDraw()}this._captureRenderBundle&&this._captureRenderBundle.push({bindGroups:[...this._currentBindGroups],bindGroupOffsets:this._currentBindGroupOffsets.map((t=>t?[...t]:null)),program:this._currentProgram,vertexLayout:this._currentVertexData,primitiveType:t,renderStateSet:this._currentStateSet?.clone()??null,count:i,first:e,numInstances:s})}_compute(){throw new Error("WebGL device does not support compute shader")}createInstancedArraysEXT(){const t=this._context;if(Mc(t))return{vertexAttribDivisor:t.vertexAttribDivisor.bind(t),drawArraysInstanced:t.drawArraysInstanced.bind(t),drawElementsInstanced:t.drawElementsInstanced.bind(t)};{const e=t.getExtension("ANGLE_instanced_arrays");return e?{vertexAttribDivisor:e.vertexAttribDivisorANGLE.bind(e),drawArraysInstanced:e.drawArraysInstancedANGLE.bind(e),drawElementsInstanced:e.drawElementsInstancedANGLE.bind(e)}:null}}createDrawBuffersEXT(){const t=this._context;if(Mc(t))return{drawBuffers:t.drawBuffers.bind(t)};{const e=t.getExtension("WEBGL_draw_buffers");return e?{drawBuffers:e.drawBuffersWEBGL.bind(e)}:null}}createVertexArrayObjectEXT(){const t=this._context;if(Mc(t))return{createVertexArray:t.createVertexArray.bind(t),bindVertexArray:t.bindVertexArray.bind(t),deleteVertexArray:t.deleteVertexArray.bind(t),isVertexArray:t.isVertexArray.bind(t)};{const e=t.getExtension("OES_vertex_array_object");return e?{createVertexArray:e.createVertexArrayOES.bind(e),bindVertexArray:e.bindVertexArrayOES.bind(e),deleteVertexArray:e.deleteVertexArrayOES.bind(e),isVertexArray:e.isVertexArrayOES.bind(e)}:null}}handleContextLost(){this._isRendering=this.isRendering,this.exitLoop(),console.log("handle context lost"),this.invalidateAll(),this.dispatchEvent(new St)}handleContextRestored(){console.log("handle context restored"),this.initContextState(),this._textureSamplerMap=new WeakMap,this._currentProgram=null,this._currentVertexData=null,this._currentStateSet=null,this._currentBindGroups=[],this._currentBindGroupOffsets=[],this._currentViewport=null,this._currentScissorRect=null,this._samplerCache=new Ed(this),this._isRendering&&(this._isRendering=!1,this.reloadAll().then((()=>{this.dispatchEvent(new Ct),this.runLoop(this.runLoopFunction)})))}initContextState(){this._deviceCaps={miscCaps:new gd(this._context),framebufferCaps:new _d(this._context),shaderCaps:new xd(this._context),textureCaps:new bd(this._context)},this._vaoExt=this.createVertexArrayObjectEXT(),this._instancedArraysExt=this.createInstancedArraysEXT(),this._drawBuffersExt=this.createDrawBuffersEXT(),this._context.pixelStorei(Ac.UNPACK_COLORSPACE_CONVERSION_WEBGL,Ac.NONE),this._context.pixelStorei(Ac.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),this.setViewport(null),this.setScissor(null),this._context.enable(Ac.SCISSOR_TEST),this.enableGPUTimeRecording(!0),this._context._currentFramebuffer=void 0,this._context._currentProgram=void 0,this._deviceUniformBuffers=[],this._deviceUniformBufferOffsets=[],this._bindTextures={[Ac.TEXTURE_2D]:[],[Ac.TEXTURE_CUBE_MAP]:[],[Ac.TEXTURE_3D]:[],[Ac.TEXTURE_2D_ARRAY]:[]},this._bindSamplers=[]}clearErrors(){for(;this._context.getError(););}getCurrentSamplerForTexture(t){return this._textureSamplerMap.get(t)}setCurrentSamplerForTexture(t,e){this._textureSamplerMap.set(t,e)}getError(t){const e=this._context.getError(),i=e===Ac.NO_ERROR?null:new Rc(e);if(i&&t)throw i;return i}})();async function Id(t,e,i){try{const s=new Fd(t,e,i);return await s.initContext(),s.setViewport(),s.setScissor(),s}catch(t){return console.error(t),null}}const Dd={typeName:()=>"webgl",supported(){if(null===Md){const t=document.createElement("canvas"),e=t.getContext("webgl");Md=!!e,t.width=0,t.height=0}return Md},async createDevice(t,e){return Id(this,t,e)}},$d=Dd,Ld={typeName:()=>"webgl2",supported(){if(null===Rd){const t=document.createElement("canvas"),e=t.getContext("webgl2");Rd=!!e,t.width=0,t.height=0}return Rd},async createDevice(t,e){return Id(this,t,e)}},Pd=15,Nd=256,Bd=573,Od=256,Ud=-2,kd=-5;function zd(t){return Vd(t.map((([t,e])=>new Array(t).fill(e,0,t))))}function Vd(t){return t.reduce(((t,e)=>t.concat(Array.isArray(e)?Vd(e):e)),[])}const Gd=[0,1,2,3].concat(...zd([[2,4],[2,5],[4,6],[4,7],[8,8],[8,9],[16,10],[16,11],[32,12],[32,13],[64,14],[64,15],[2,0],[1,16],[1,17],[2,18],[2,19],[4,20],[4,21],[8,22],[8,23],[16,24],[16,25],[32,26],[32,27],[64,28],[64,29]]));function Xd(){const t=this;function e(t,e){let i=0;do{i|=1&t,t>>>=1,i<<=1}while(--e>0);return i>>>1}t.build_tree=function(i){const s=t.dyn_tree,r=t.stat_desc.static_tree,n=t.stat_desc.elems;let a,o,h,l=-1;for(i.heap_len=0,i.heap_max=Bd,a=0;a<n;a++)0!==s[2*a]?(i.heap[++i.heap_len]=l=a,i.depth[a]=0):s[2*a+1]=0;for(;i.heap_len<2;)h=i.heap[++i.heap_len]=l<2?++l:0,s[2*h]=1,i.depth[h]=0,i.opt_len--,r&&(i.static_len-=r[2*h+1]);for(t.max_code=l,a=Math.floor(i.heap_len/2);a>=1;a--)i.pqdownheap(s,a);h=n;do{a=i.heap[1],i.heap[1]=i.heap[i.heap_len--],i.pqdownheap(s,1),o=i.heap[1],i.heap[--i.heap_max]=a,i.heap[--i.heap_max]=o,s[2*h]=s[2*a]+s[2*o],i.depth[h]=Math.max(i.depth[a],i.depth[o])+1,s[2*a+1]=s[2*o+1]=h,i.heap[1]=h++,i.pqdownheap(s,1)}while(i.heap_len>=2);i.heap[--i.heap_max]=i.heap[1],function(e){const i=t.dyn_tree,s=t.stat_desc.static_tree,r=t.stat_desc.extra_bits,n=t.stat_desc.extra_base,a=t.stat_desc.max_length;let o,h,l,u,c,d,p=0;for(u=0;u<=Pd;u++)e.bl_count[u]=0;for(i[2*e.heap[e.heap_max]+1]=0,o=e.heap_max+1;o<Bd;o++)h=e.heap[o],u=i[2*i[2*h+1]+1]+1,u>a&&(u=a,p++),i[2*h+1]=u,h>t.max_code||(e.bl_count[u]++,c=0,h>=n&&(c=r[h-n]),d=i[2*h],e.opt_len+=d*(u+c),s&&(e.static_len+=d*(s[2*h+1]+c)));if(0!==p){do{for(u=a-1;0===e.bl_count[u];)u--;e.bl_count[u]--,e.bl_count[u+1]+=2,e.bl_count[a]--,p-=2}while(p>0);for(u=a;0!==u;u--)for(h=e.bl_count[u];0!==h;)l=e.heap[--o],l>t.max_code||(i[2*l+1]!=u&&(e.opt_len+=(u-i[2*l+1])*i[2*l],i[2*l+1]=u),h--)}}(i),function(t,i,s){const r=[];let n,a,o,h=0;for(n=1;n<=Pd;n++)r[n]=h=h+s[n-1]<<1;for(a=0;a<=i;a++)o=t[2*a+1],0!==o&&(t[2*a]=e(r[o]++,o))}(s,t.max_code,i.bl_count)}}function Wd(t,e,i,s,r){const n=this;n.static_tree=t,n.extra_bits=e,n.extra_base=i,n.elems=s,n.max_length=r}Xd._length_code=[0,1,2,3,4,5,6,7].concat(...zd([[2,8],[2,9],[2,10],[2,11],[4,12],[4,13],[4,14],[4,15],[8,16],[8,17],[8,18],[8,19],[16,20],[16,21],[16,22],[16,23],[32,24],[32,25],[32,26],[31,27],[1,28]])),Xd.base_length=[0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,0],Xd.base_dist=[0,1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096,6144,8192,12288,16384,24576],Xd.d_code=function(t){return t<256?Gd[t]:Gd[256+(t>>>7)]},Xd.extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],Xd.extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Xd.extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Xd.bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];const Hd=zd([[144,8],[112,9],[24,7],[8,8]]);Wd.static_ltree=Vd([12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,19,275,147,403,83,339,211,467,51,307,179,435,115,371,243,499,11,267,139,395,75,331,203,459,43,299,171,427,107,363,235,491,27,283,155,411,91,347,219,475,59,315,187,443,123,379,251,507,7,263,135,391,71,327,199,455,39,295,167,423,103,359,231,487,23,279,151,407,87,343,215,471,55,311,183,439,119,375,247,503,15,271,143,399,79,335,207,463,47,303,175,431,111,367,239,495,31,287,159,415,95,351,223,479,63,319,191,447,127,383,255,511,0,64,32,96,16,80,48,112,8,72,40,104,24,88,56,120,4,68,36,100,20,84,52,116,3,131,67,195,35,163,99,227].map(((t,e)=>[t,Hd[e]])));const jd=zd([[30,5]]);Wd.static_dtree=Vd([0,16,8,24,4,20,12,28,2,18,10,26,6,22,14,30,1,17,9,25,5,21,13,29,3,19,11,27,7,23].map(((t,e)=>[t,jd[e]]))),Wd.static_l_desc=new Wd(Wd.static_ltree,Xd.extra_lbits,257,286,Pd),Wd.static_d_desc=new Wd(Wd.static_dtree,Xd.extra_dbits,0,30,Pd),Wd.static_bl_desc=new Wd(null,Xd.extra_blbits,0,19,7);function qd(t,e,i,s,r){const n=this;n.good_length=t,n.max_lazy=e,n.nice_length=i,n.max_chain=s,n.func=r}const Yd=[new qd(0,0,0,0,0),new qd(4,4,8,4,1),new qd(4,5,16,8,1),new qd(4,6,32,32,1),new qd(4,4,16,16,2),new qd(8,16,32,32,2),new qd(8,16,128,128,2),new qd(8,32,128,256,2),new qd(32,128,258,1024,2),new qd(32,258,258,4096,2)],Zd=["need dictionary","stream end","","","stream error","data error","","buffer error","",""],Kd=113,Qd=666,Jd=258,tp=262;function ep(t,e,i,s){const r=t[2*e],n=t[2*i];return r<n||r==n&&s[e]<=s[i]}function ip(){const t=this;let e,i,s,r,n,a,o,h,l,u,c,d,p,m,f,_,g,x,b,w,T,v,y,E,S,C,A,M,R,F,I,D,$;const L=new Xd,P=new Xd,N=new Xd;let B,O,U,k,z,V;function G(){let e;for(e=0;e<286;e++)I[2*e]=0;for(e=0;e<30;e++)D[2*e]=0;for(e=0;e<19;e++)$[2*e]=0;I[512]=1,t.opt_len=t.static_len=0,O=U=0}function X(t,e){let i,s=-1,r=t[1],n=0,a=7,o=4;0===r&&(a=138,o=3),t[2*(e+1)+1]=65535;for(let h=0;h<=e;h++)i=r,r=t[2*(h+1)+1],++n<a&&i==r||(n<o?$[2*i]+=n:0!==i?(i!=s&&$[2*i]++,$[32]++):n<=10?$[34]++:$[36]++,n=0,s=i,0===r?(a=138,o=3):i==r?(a=6,o=3):(a=7,o=4))}function W(e){t.pending_buf[t.pending++]=e}function H(t){W(255&t),W(t>>>8&255)}function j(t,e){let i;const s=e;V>16-s?(i=t,z|=i<<V&65535,H(z),z=i>>>16-V,V+=s-16):(z|=t<<V&65535,V+=s)}function q(t,e){const i=2*t;j(65535&e[i],65535&e[i+1])}function Y(t,e){let i,s,r=-1,n=t[1],a=0,o=7,h=4;for(0===n&&(o=138,h=3),i=0;i<=e;i++)if(s=n,n=t[2*(i+1)+1],!(++a<o&&s==n)){if(a<h)do{q(s,$)}while(0!=--a);else 0!==s?(s!=r&&(q(s,$),a--),q(16,$),j(a-3,2)):a<=10?(q(17,$),j(a-3,3)):(q(18,$),j(a-11,7));a=0,r=s,0===n?(o=138,h=3):s==n?(o=6,h=3):(o=7,h=4)}}function Z(){16==V?(H(z),z=0,V=0):V>=8&&(W(255&z),z>>>=8,V-=8)}function K(e,i){let s,r,n;if(t.dist_buf[O]=e,t.lc_buf[O]=255&i,O++,0===e?I[2*i]++:(U++,e--,I[2*(Xd._length_code[i]+Nd+1)]++,D[2*Xd.d_code(e)]++),0==(8191&O)&&A>2){for(s=8*O,r=T-g,n=0;n<30;n++)s+=D[2*n]*(5+Xd.extra_dbits[n]);if(s>>>=3,U<Math.floor(O/2)&&s<Math.floor(r/2))return!0}return O==B-1}function Q(e,i){let s,r,n,a,o=0;if(0!==O)do{s=t.dist_buf[o],r=t.lc_buf[o],o++,0===s?q(r,e):(n=Xd._length_code[r],q(n+Nd+1,e),a=Xd.extra_lbits[n],0!==a&&(r-=Xd.base_length[n],j(r,a)),s--,n=Xd.d_code(s),q(n,i),a=Xd.extra_dbits[n],0!==a&&(s-=Xd.base_dist[n],j(s,a)))}while(o<O);q(Od,e),k=e[513]}function J(){V>8?H(z):V>0&&W(255&z),z=0,V=0}function tt(e,i,s){j(0+(s?1:0),3),function(e,i,s){J(),k=8,s&&(H(i),H(~i)),t.pending_buf.set(h.subarray(e,e+i),t.pending),t.pending+=i}(e,i,!0)}function et(e,i,s){let r,n,a=0;A>0?(L.build_tree(t),P.build_tree(t),a=function(){let e;for(X(I,L.max_code),X(D,P.max_code),N.build_tree(t),e=18;e>=3&&0===$[2*Xd.bl_order[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e}(),r=t.opt_len+3+7>>>3,n=t.static_len+3+7>>>3,n<=r&&(r=n)):r=n=i+5,i+4<=r&&-1!=e?tt(e,i,s):n==r?(j(2+(s?1:0),3),Q(Wd.static_ltree,Wd.static_dtree)):(j(4+(s?1:0),3),function(t,e,i){let s;for(j(t-257,5),j(e-1,5),j(i-4,4),s=0;s<i;s++)j($[2*Xd.bl_order[s]+1],3);Y(I,t-1),Y(D,e-1)}(L.max_code+1,P.max_code+1,a+1),Q(I,D)),G(),s&&J()}function it(t){et(g>=0?g:-1,T-g,t),g=T,e.flush_pending()}function st(){let t,i,s,r;do{if(r=l-y-T,0===r&&0===T&&0===y)r=n;else if(-1==r)r--;else if(T>=n+n-tp){h.set(h.subarray(n,n+n),0),v-=n,T-=n,g-=n,t=p,s=t;do{i=65535&c[--s],c[s]=i>=n?i-n:0}while(0!=--t);t=n,s=t;do{i=65535&u[--s],u[s]=i>=n?i-n:0}while(0!=--t);r+=n}if(0===e.avail_in)return;t=e.read_buf(h,T+y,r),y+=t,y>=3&&(d=255&h[T],d=(d<<_^255&h[T+1])&f)}while(y<tp&&0!==e.avail_in)}function rt(t){let e,i,s=S,r=T,a=E;const l=T>n-tp?T-(n-tp):0;let c=F;const d=o,p=T+Jd;let m=h[r+a-1],f=h[r+a];E>=R&&(s>>=2),c>y&&(c=y);do{if(e=t,h[e+a]==f&&h[e+a-1]==m&&h[e]==h[r]&&h[++e]==h[r+1]){r+=2,e++;do{}while(h[++r]==h[++e]&&h[++r]==h[++e]&&h[++r]==h[++e]&&h[++r]==h[++e]&&h[++r]==h[++e]&&h[++r]==h[++e]&&h[++r]==h[++e]&&h[++r]==h[++e]&&r<p);if(i=Jd-(p-r),r=p-Jd,i>a){if(v=t,a=i,i>=c)break;m=h[r+a-1],f=h[r+a]}}}while((t=65535&u[t&d])>l&&0!=--s);return a<=y?a:y}function nt(e){return e.total_in=e.total_out=0,e.msg=null,t.pending=0,t.pending_out=0,i=Kd,r=0,L.dyn_tree=I,L.stat_desc=Wd.static_l_desc,P.dyn_tree=D,P.stat_desc=Wd.static_d_desc,N.dyn_tree=$,N.stat_desc=Wd.static_bl_desc,z=0,V=0,k=8,G(),function(){l=2*n,c[p-1]=0;for(let t=0;t<p-1;t++)c[t]=0;C=Yd[A].max_lazy,R=Yd[A].good_length,F=Yd[A].nice_length,S=Yd[A].max_chain,T=0,g=0,y=0,x=E=2,w=0,d=0}(),0}t.depth=[],t.bl_count=[],t.heap=[],I=[],D=[],$=[],t.pqdownheap=function(e,i){const s=t.heap,r=s[i];let n=i<<1;for(;n<=t.heap_len&&(n<t.heap_len&&ep(e,s[n+1],s[n],t.depth)&&n++,!ep(e,r,s[n],t.depth));)s[i]=s[n],i=n,n<<=1;s[i]=r},t.deflateInit=function(e,i,r,l,d,g){return l||(l=8),d||(d=8),g||(g=0),e.msg=null,-1==i&&(i=6),d<1||d>9||8!=l||r<9||r>15||i<0||i>9||g<0||g>2?Ud:(e.dstate=t,a=r,n=1<<a,o=n-1,m=d+7,p=1<<m,f=p-1,_=Math.floor((m+3-1)/3),h=new Uint8Array(2*n),u=[],c=[],B=1<<d+6,t.pending_buf=new Uint8Array(4*B),s=4*B,t.dist_buf=new Uint16Array(B),t.lc_buf=new Uint8Array(B),A=i,M=g,nt(e))},t.deflateEnd=function(){return 42!=i&&i!=Kd&&i!=Qd?Ud:(t.lc_buf=null,t.dist_buf=null,t.pending_buf=null,c=null,u=null,h=null,t.dstate=null,i==Kd?-3:0)},t.deflateParams=function(t,e,i){let s=0;return-1==e&&(e=6),e<0||e>9||i<0||i>2?Ud:(Yd[A].func!=Yd[e].func&&0!==t.total_in&&(s=t.deflate(1)),A!=e&&(A=e,C=Yd[A].max_lazy,R=Yd[A].good_length,F=Yd[A].nice_length,S=Yd[A].max_chain),M=i,s)},t.deflateSetDictionary=function(t,e,s){let r,a=s,l=0;if(!e||42!=i)return Ud;if(a<3)return 0;for(a>n-tp&&(a=n-tp,l=s-a),h.set(e.subarray(l,l+a),0),T=a,g=a,d=255&h[0],d=(d<<_^255&h[1])&f,r=0;r<=a-3;r++)d=(d<<_^255&h[r+2])&f,u[r&o]=c[d],c[d]=r;return 0},t.deflate=function(l,m){let S,R,F,I,D;if(m>4||m<0)return Ud;if(!l.next_out||!l.next_in&&0!==l.avail_in||i==Qd&&4!=m)return l.msg=Zd[4],Ud;if(0===l.avail_out)return l.msg=Zd[7],kd;var $;if(e=l,I=r,r=m,42==i&&(R=8+(a-8<<4)<<8,F=(A-1&255)>>1,F>3&&(F=3),R|=F<<6,0!==T&&(R|=32),R+=31-R%31,i=Kd,W(($=R)>>8&255),W(255&$)),0!==t.pending){if(e.flush_pending(),0===e.avail_out)return r=-1,0}else if(0===e.avail_in&&m<=I&&4!=m)return e.msg=Zd[7],kd;if(i==Qd&&0!==e.avail_in)return l.msg=Zd[7],kd;if(0!==e.avail_in||0!==y||0!=m&&i!=Qd){switch(D=-1,Yd[A].func){case 0:D=function(t){let i,r=65535;for(r>s-5&&(r=s-5);;){if(y<=1){if(st(),0===y&&0==t)return 0;if(0===y)break}if(T+=y,y=0,i=g+r,(0===T||T>=i)&&(y=T-i,T=i,it(!1),0===e.avail_out))return 0;if(T-g>=n-tp&&(it(!1),0===e.avail_out))return 0}return it(4==t),0===e.avail_out?4==t?2:0:4==t?3:1}(m);break;case 1:D=function(t){let i,s=0;for(;;){if(y<tp){if(st(),y<tp&&0==t)return 0;if(0===y)break}if(y>=3&&(d=(d<<_^255&h[T+2])&f,s=65535&c[d],u[T&o]=c[d],c[d]=T),0!==s&&(T-s&65535)<=n-tp&&2!=M&&(x=rt(s)),x>=3)if(i=K(T-v,x-3),y-=x,x<=C&&y>=3){x--;do{T++,d=(d<<_^255&h[T+2])&f,s=65535&c[d],u[T&o]=c[d],c[d]=T}while(0!=--x);T++}else T+=x,x=0,d=255&h[T],d=(d<<_^255&h[T+1])&f;else i=K(0,255&h[T]),y--,T++;if(i&&(it(!1),0===e.avail_out))return 0}return it(4==t),0===e.avail_out?4==t?2:0:4==t?3:1}(m);break;case 2:D=function(t){let i,s,r=0;for(;;){if(y<tp){if(st(),y<tp&&0==t)return 0;if(0===y)break}if(y>=3&&(d=(d<<_^255&h[T+2])&f,r=65535&c[d],u[T&o]=c[d],c[d]=T),E=x,b=v,x=2,0!==r&&E<C&&(T-r&65535)<=n-tp&&(2!=M&&(x=rt(r)),x<=5&&(1==M||3==x&&T-v>4096)&&(x=2)),E>=3&&x<=E){s=T+y-3,i=K(T-1-b,E-3),y-=E-1,E-=2;do{++T<=s&&(d=(d<<_^255&h[T+2])&f,r=65535&c[d],u[T&o]=c[d],c[d]=T)}while(0!=--E);if(w=0,x=2,T++,i&&(it(!1),0===e.avail_out))return 0}else if(0!==w){if(i=K(0,255&h[T-1]),i&&it(!1),T++,y--,0===e.avail_out)return 0}else w=1,T++,y--}return 0!==w&&(i=K(0,255&h[T-1]),w=0),it(4==t),0===e.avail_out?4==t?2:0:4==t?3:1}(m)}if(2!=D&&3!=D||(i=Qd),0==D||2==D)return 0===e.avail_out&&(r=-1),0;if(1==D){if(1==m)j(2,3),q(Od,Wd.static_ltree),Z(),1+k+10-V<9&&(j(2,3),q(Od,Wd.static_ltree),Z()),k=7;else if(tt(0,0,!1),3==m)for(S=0;S<p;S++)c[S]=0;if(e.flush_pending(),0===e.avail_out)return r=-1,0}}return 4!=m?0:1}}function sp(){const t=this;t.next_in_index=0,t.next_out_index=0,t.avail_in=0,t.total_in=0,t.avail_out=0,t.total_out=0}sp.prototype={deflateInit(t,e){const i=this;return i.dstate=new ip,e||(e=Pd),i.dstate.deflateInit(i,t,e)},deflate(t){const e=this;return e.dstate?e.dstate.deflate(e,t):Ud},deflateEnd(){const t=this;if(!t.dstate)return Ud;const e=t.dstate.deflateEnd();return t.dstate=null,e},deflateParams(t,e){const i=this;return i.dstate?i.dstate.deflateParams(i,t,e):Ud},deflateSetDictionary(t,e){const i=this;return i.dstate?i.dstate.deflateSetDictionary(i,t,e):Ud},read_buf(t,e,i){const s=this;let r=s.avail_in;return r>i&&(r=i),0===r?0:(s.avail_in-=r,t.set(s.next_in.subarray(s.next_in_index,s.next_in_index+r),e),s.next_in_index+=r,s.total_in+=r,r)},flush_pending(){const t=this;let e=t.dstate.pending;e>t.avail_out&&(e=t.avail_out),0!==e&&(t.next_out.set(t.dstate.pending_buf.subarray(t.dstate.pending_out,t.dstate.pending_out+e),t.next_out_index),t.next_out_index+=e,t.dstate.pending_out+=e,t.total_out+=e,t.avail_out-=e,t.dstate.pending-=e,0===t.dstate.pending&&(t.dstate.pending_out=0))}};const rp=0,np=1,ap=-2,op=-3,hp=-4,lp=-5,up=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],cp=1440,dp=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],pp=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],mp=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],fp=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],_p=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],gp=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],xp=15;function bp(){let t,e,i,s,r,n;function a(t,e,a,o,h,l,u,c,d,p,m){let f,_,g,x,b,w,T,v,y,E,S,C,A,M,R;E=0,b=a;do{i[t[e+E]]++,E++,b--}while(0!==b);if(i[0]==a)return u[0]=-1,c[0]=0,rp;for(v=c[0],w=1;w<=xp&&0===i[w];w++);for(T=w,v<w&&(v=w),b=xp;0!==b&&0===i[b];b--);for(g=b,v>b&&(v=b),c[0]=v,M=1<<w;w<b;w++,M<<=1)if((M-=i[w])<0)return op;if((M-=i[b])<0)return op;for(i[b]+=M,n[1]=w=0,E=1,A=2;0!=--b;)n[A]=w+=i[E],A++,E++;b=0,E=0;do{0!==(w=t[e+E])&&(m[n[w]++]=b),E++}while(++b<a);for(a=n[g],n[0]=b=0,E=0,x=-1,C=-v,r[0]=0,S=0,R=0;T<=g;T++)for(f=i[T];0!=f--;){for(;T>C+v;){if(x++,C+=v,R=g-C,R=R>v?v:R,(_=1<<(w=T-C))>f+1&&(_-=f+1,A=T,w<R))for(;++w<R&&!((_<<=1)<=i[++A]);)_-=i[A];if(R=1<<w,p[0]+R>cp)return op;r[x]=S=p[0],p[0]+=R,0!==x?(n[x]=b,s[0]=w,s[1]=v,w=b>>>C-v,s[2]=S-r[x-1]-w,d.set(s,3*(r[x-1]+w))):u[0]=S}for(s[1]=T-C,E>=a?s[0]=192:m[E]<o?(s[0]=m[E]<256?0:96,s[2]=m[E++]):(s[0]=l[m[E]-o]+16+64,s[2]=h[m[E++]-o]),_=1<<T-C,w=b>>>C;w<R;w+=_)d.set(s,3*(S+w));for(w=1<<T-1;0!=(b&w);w>>>=1)b^=w;for(b^=w,y=(1<<C)-1;(b&y)!=n[x];)x--,C-=v,y=(1<<C)-1}return 0!==M&&1!=g?lp:rp}function o(a){let o;for(t||(t=[],e=[],i=new Int32Array(xp+1),s=[],r=new Int32Array(xp),n=new Int32Array(xp+1)),e.length<a&&(e=[]),o=0;o<a;o++)e[o]=0;for(o=0;o<xp+1;o++)i[o]=0;for(o=0;o<3;o++)s[o]=0;r.set(i.subarray(0,xp),0),n.set(i.subarray(0,xp+1),0)}this.inflate_trees_bits=function(i,s,r,n,h){let l;return o(19),t[0]=0,l=a(i,0,19,19,null,null,r,s,n,t,e),l==op?h.msg="oversubscribed dynamic bit lengths tree":l!=lp&&0!==s[0]||(h.msg="incomplete dynamic bit lengths tree",l=op),l},this.inflate_trees_dynamic=function(i,s,r,n,h,l,u,c,d){let p;return o(288),t[0]=0,p=a(r,0,i,257,mp,fp,l,n,c,t,e),p!=rp||0===n[0]?(p==op?d.msg="oversubscribed literal/length tree":p!=hp&&(d.msg="incomplete literal/length tree",p=op),p):(o(288),p=a(r,i,s,0,_p,gp,u,h,c,t,e),p!=rp||0===h[0]&&i>257?(p==op?d.msg="oversubscribed distance tree":p==lp?(d.msg="incomplete distance tree",p=op):p!=hp&&(d.msg="empty distance tree with lengths",p=op),p):rp)}}bp.inflate_trees_fixed=function(t,e,i,s){return t[0]=9,e[0]=5,i[0]=dp,s[0]=pp,rp};const wp=0,Tp=1,vp=2,yp=3,Ep=4,Sp=5,Cp=6,Ap=7,Mp=8,Rp=9;function Fp(){const t=this;let e,i,s,r,n=0,a=0,o=0,h=0,l=0,u=0,c=0,d=0,p=0,m=0;function f(t,e,i,s,r,n,a,o){let h,l,u,c,d,p,m,f,_,g,x,b,w,T,v,y;m=o.next_in_index,f=o.avail_in,d=a.bitb,p=a.bitk,_=a.write,g=_<a.read?a.read-_-1:a.end-_,x=up[t],b=up[e];do{for(;p<20;)f--,d|=(255&o.read_byte(m++))<<p,p+=8;if(h=d&x,l=i,u=s,y=3*(u+h),0!==(c=l[y]))for(;;){if(d>>=l[y+1],p-=l[y+1],0!=(16&c)){for(c&=15,w=l[y+2]+(d&up[c]),d>>=c,p-=c;p<15;)f--,d|=(255&o.read_byte(m++))<<p,p+=8;for(h=d&b,l=r,u=n,y=3*(u+h),c=l[y];;){if(d>>=l[y+1],p-=l[y+1],0!=(16&c)){for(c&=15;p<c;)f--,d|=(255&o.read_byte(m++))<<p,p+=8;if(T=l[y+2]+(d&up[c]),d>>=c,p-=c,g-=w,_>=T)v=_-T,_-v>0&&2>_-v?(a.win[_++]=a.win[v++],a.win[_++]=a.win[v++],w-=2):(a.win.set(a.win.subarray(v,v+2),_),_+=2,v+=2,w-=2);else{v=_-T;do{v+=a.end}while(v<0);if(c=a.end-v,w>c){if(w-=c,_-v>0&&c>_-v)do{a.win[_++]=a.win[v++]}while(0!=--c);else a.win.set(a.win.subarray(v,v+c),_),_+=c,v+=c,c=0;v=0}}if(_-v>0&&w>_-v)do{a.win[_++]=a.win[v++]}while(0!=--w);else a.win.set(a.win.subarray(v,v+w),_),_+=w,v+=w,w=0;break}if(0!=(64&c))return o.msg="invalid distance code",w=o.avail_in-f,w=p>>3<w?p>>3:w,f+=w,m-=w,p-=w<<3,a.bitb=d,a.bitk=p,o.avail_in=f,o.total_in+=m-o.next_in_index,o.next_in_index=m,a.write=_,op;h+=l[y+2],h+=d&up[c],y=3*(u+h),c=l[y]}break}if(0!=(64&c))return 0!=(32&c)?(w=o.avail_in-f,w=p>>3<w?p>>3:w,f+=w,m-=w,p-=w<<3,a.bitb=d,a.bitk=p,o.avail_in=f,o.total_in+=m-o.next_in_index,o.next_in_index=m,a.write=_,np):(o.msg="invalid literal/length code",w=o.avail_in-f,w=p>>3<w?p>>3:w,f+=w,m-=w,p-=w<<3,a.bitb=d,a.bitk=p,o.avail_in=f,o.total_in+=m-o.next_in_index,o.next_in_index=m,a.write=_,op);if(h+=l[y+2],h+=d&up[c],y=3*(u+h),0===(c=l[y])){d>>=l[y+1],p-=l[y+1],a.win[_++]=l[y+2],g--;break}}else d>>=l[y+1],p-=l[y+1],a.win[_++]=l[y+2],g--}while(g>=258&&f>=10);return w=o.avail_in-f,w=p>>3<w?p>>3:w,f+=w,m-=w,p-=w<<3,a.bitb=d,a.bitk=p,o.avail_in=f,o.total_in+=m-o.next_in_index,o.next_in_index=m,a.write=_,rp}t.init=function(t,n,a,o,h,l){e=wp,c=t,d=n,s=a,p=o,r=h,m=l,i=null},t.proc=function(t,_,g){let x,b,w,T,v,y,E,S=0,C=0,A=0;for(A=_.next_in_index,T=_.avail_in,S=t.bitb,C=t.bitk,v=t.write,y=v<t.read?t.read-v-1:t.end-v;;)switch(e){case wp:if(y>=258&&T>=10&&(t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,g=f(c,d,s,p,r,m,t,_),A=_.next_in_index,T=_.avail_in,S=t.bitb,C=t.bitk,v=t.write,y=v<t.read?t.read-v-1:t.end-v,g!=rp)){e=g==np?Ap:Rp;break}o=c,i=s,a=p,e=Tp;case Tp:for(x=o;C<x;){if(0===T)return t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g);g=rp,T--,S|=(255&_.read_byte(A++))<<C,C+=8}if(b=3*(a+(S&up[x])),S>>>=i[b+1],C-=i[b+1],w=i[b],0===w){h=i[b+2],e=Cp;break}if(0!=(16&w)){l=15&w,n=i[b+2],e=vp;break}if(0==(64&w)){o=w,a=b/3+i[b+2];break}if(0!=(32&w)){e=Ap;break}return e=Rp,_.msg="invalid literal/length code",g=op,t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g);case vp:for(x=l;C<x;){if(0===T)return t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g);g=rp,T--,S|=(255&_.read_byte(A++))<<C,C+=8}n+=S&up[x],S>>=x,C-=x,o=d,i=r,a=m,e=yp;case yp:for(x=o;C<x;){if(0===T)return t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g);g=rp,T--,S|=(255&_.read_byte(A++))<<C,C+=8}if(b=3*(a+(S&up[x])),S>>=i[b+1],C-=i[b+1],w=i[b],0!=(16&w)){l=15&w,u=i[b+2],e=Ep;break}if(0==(64&w)){o=w,a=b/3+i[b+2];break}return e=Rp,_.msg="invalid distance code",g=op,t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g);case Ep:for(x=l;C<x;){if(0===T)return t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g);g=rp,T--,S|=(255&_.read_byte(A++))<<C,C+=8}u+=S&up[x],S>>=x,C-=x,e=Sp;case Sp:for(E=v-u;E<0;)E+=t.end;for(;0!==n;){if(0===y&&(v==t.end&&0!==t.read&&(v=0,y=v<t.read?t.read-v-1:t.end-v),0===y&&(t.write=v,g=t.inflate_flush(_,g),v=t.write,y=v<t.read?t.read-v-1:t.end-v,v==t.end&&0!==t.read&&(v=0,y=v<t.read?t.read-v-1:t.end-v),0===y)))return t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g);t.win[v++]=t.win[E++],y--,E==t.end&&(E=0),n--}e=wp;break;case Cp:if(0===y&&(v==t.end&&0!==t.read&&(v=0,y=v<t.read?t.read-v-1:t.end-v),0===y&&(t.write=v,g=t.inflate_flush(_,g),v=t.write,y=v<t.read?t.read-v-1:t.end-v,v==t.end&&0!==t.read&&(v=0,y=v<t.read?t.read-v-1:t.end-v),0===y)))return t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g);g=rp,t.win[v++]=h,y--,e=wp;break;case Ap:if(C>7&&(C-=8,T++,A--),t.write=v,g=t.inflate_flush(_,g),v=t.write,y=v<t.read?t.read-v-1:t.end-v,t.read!=t.write)return t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g);e=Mp;case Mp:return g=np,t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g);case Rp:return g=op,t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g);default:return g=ap,t.bitb=S,t.bitk=C,_.avail_in=T,_.total_in+=A-_.next_in_index,_.next_in_index=A,t.write=v,t.inflate_flush(_,g)}},t.free=function(){}}const Ip=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Dp=0,$p=1,Lp=2,Pp=3,Np=4,Bp=5,Op=6,Up=7,kp=8,zp=9;function Vp(t,e){const i=this;let s,r=Dp,n=0,a=0,o=0;const h=[0],l=[0],u=new Fp;let c=0,d=new Int32Array(3*cp);const p=new bp;i.bitk=0,i.bitb=0,i.win=new Uint8Array(e),i.end=e,i.read=0,i.write=0,i.reset=function(t,e){e&&(e[0]=0),r==Op&&u.free(t),r=Dp,i.bitk=0,i.bitb=0,i.read=i.write=0},i.reset(t,null),i.inflate_flush=function(t,e){let s,r,n;return r=t.next_out_index,n=i.read,s=(n<=i.write?i.write:i.end)-n,s>t.avail_out&&(s=t.avail_out),0!==s&&e==lp&&(e=rp),t.avail_out-=s,t.total_out+=s,t.next_out.set(i.win.subarray(n,n+s),r),r+=s,n+=s,n==i.end&&(n=0,i.write==i.end&&(i.write=0),s=i.write-n,s>t.avail_out&&(s=t.avail_out),0!==s&&e==lp&&(e=rp),t.avail_out-=s,t.total_out+=s,t.next_out.set(i.win.subarray(n,n+s),r),r+=s,n+=s),t.next_out_index=r,i.read=n,e},i.proc=function(t,e){let m,f,_,g,x,b,w,T;for(g=t.next_in_index,x=t.avail_in,f=i.bitb,_=i.bitk,b=i.write,w=b<i.read?i.read-b-1:i.end-b;;){let v,y,E,S,C,A,M,R;switch(r){case Dp:for(;_<3;){if(0===x)return i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);e=rp,x--,f|=(255&t.read_byte(g++))<<_,_+=8}switch(m=7&f,c=1&m,m>>>1){case 0:f>>>=3,_-=3,m=7&_,f>>>=m,_-=m,r=$p;break;case 1:v=[],y=[],E=[[]],S=[[]],bp.inflate_trees_fixed(v,y,E,S),u.init(v[0],y[0],E[0],0,S[0],0),f>>>=3,_-=3,r=Op;break;case 2:f>>>=3,_-=3,r=Pp;break;case 3:return f>>>=3,_-=3,r=zp,t.msg="invalid block type",e=op,i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e)}break;case $p:for(;_<32;){if(0===x)return i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);e=rp,x--,f|=(255&t.read_byte(g++))<<_,_+=8}if((~f>>>16&65535)!=(65535&f))return r=zp,t.msg="invalid stored block lengths",e=op,i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);n=65535&f,f=_=0,r=0!==n?Lp:0!==c?Up:Dp;break;case Lp:if(0===x)return i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);if(0===w&&(b==i.end&&0!==i.read&&(b=0,w=b<i.read?i.read-b-1:i.end-b),0===w&&(i.write=b,e=i.inflate_flush(t,e),b=i.write,w=b<i.read?i.read-b-1:i.end-b,b==i.end&&0!==i.read&&(b=0,w=b<i.read?i.read-b-1:i.end-b),0===w)))return i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);if(e=rp,m=n,m>x&&(m=x),m>w&&(m=w),i.win.set(t.read_buf(g,m),b),g+=m,x-=m,b+=m,w-=m,0!=(n-=m))break;r=0!==c?Up:Dp;break;case Pp:for(;_<14;){if(0===x)return i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);e=rp,x--,f|=(255&t.read_byte(g++))<<_,_+=8}if(a=m=16383&f,(31&m)>29||(m>>5&31)>29)return r=zp,t.msg="too many length or distance symbols",e=op,i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);if(m=258+(31&m)+(m>>5&31),!s||s.length<m)s=[];else for(T=0;T<m;T++)s[T]=0;f>>>=14,_-=14,o=0,r=Np;case Np:for(;o<4+(a>>>10);){for(;_<3;){if(0===x)return i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);e=rp,x--,f|=(255&t.read_byte(g++))<<_,_+=8}s[Ip[o++]]=7&f,f>>>=3,_-=3}for(;o<19;)s[Ip[o++]]=0;if(h[0]=7,m=p.inflate_trees_bits(s,h,l,d,t),m!=rp)return(e=m)==op&&(s=null,r=zp),i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);o=0,r=Bp;case Bp:for(;m=a,!(o>=258+(31&m)+(m>>5&31));){let n,u;for(m=h[0];_<m;){if(0===x)return i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);e=rp,x--,f|=(255&t.read_byte(g++))<<_,_+=8}if(m=d[3*(l[0]+(f&up[m]))+1],u=d[3*(l[0]+(f&up[m]))+2],u<16)f>>>=m,_-=m,s[o++]=u;else{for(T=18==u?7:u-14,n=18==u?11:3;_<m+T;){if(0===x)return i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);e=rp,x--,f|=(255&t.read_byte(g++))<<_,_+=8}if(f>>>=m,_-=m,n+=f&up[T],f>>>=T,_-=T,T=o,m=a,T+n>258+(31&m)+(m>>5&31)||16==u&&T<1)return s=null,r=zp,t.msg="invalid bit length repeat",e=op,i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);u=16==u?s[T-1]:0;do{s[T++]=u}while(0!=--n);o=T}}if(l[0]=-1,C=[],A=[],M=[],R=[],C[0]=9,A[0]=6,m=a,m=p.inflate_trees_dynamic(257+(31&m),1+(m>>5&31),s,C,A,M,R,d,t),m!=rp)return m==op&&(s=null,r=zp),e=m,i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);u.init(C[0],A[0],d,M[0],d,R[0]),r=Op;case Op:if(i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,(e=u.proc(i,t,e))!=np)return i.inflate_flush(t,e);if(e=rp,u.free(t),g=t.next_in_index,x=t.avail_in,f=i.bitb,_=i.bitk,b=i.write,w=b<i.read?i.read-b-1:i.end-b,0===c){r=Dp;break}r=Up;case Up:if(i.write=b,e=i.inflate_flush(t,e),b=i.write,w=b<i.read?i.read-b-1:i.end-b,i.read!=i.write)return i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);r=kp;case kp:return e=np,i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);case zp:return e=op,i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e);default:return e=ap,i.bitb=f,i.bitk=_,t.avail_in=x,t.total_in+=g-t.next_in_index,t.next_in_index=g,i.write=b,i.inflate_flush(t,e)}}},i.free=function(t){i.reset(t,null),i.win=null,d=null},i.set_dictionary=function(t,e,s){i.win.set(t.subarray(e,e+s),0),i.read=i.write=s},i.sync_point=function(){return r==$p?1:0}}const Gp=13,Xp=[0,0,255,255];function Wp(){const t=this;function e(t){return t&&t.istate?(t.total_in=t.total_out=0,t.msg=null,t.istate.mode=7,t.istate.blocks.reset(t,null),rp):ap}t.mode=0,t.method=0,t.was=[0],t.need=0,t.marker=0,t.wbits=0,t.inflateEnd=function(e){return t.blocks&&t.blocks.free(e),t.blocks=null,rp},t.inflateInit=function(i,s){return i.msg=null,t.blocks=null,s<8||s>15?(t.inflateEnd(i),ap):(t.wbits=s,i.istate.blocks=new Vp(i,1<<s),e(i),rp)},t.inflate=function(t,e){let i,s;if(!t||!t.istate||!t.next_in)return ap;const r=t.istate;for(e=4==e?lp:rp,i=lp;;)switch(r.mode){case 0:if(0===t.avail_in)return i;if(i=e,t.avail_in--,t.total_in++,8!=(15&(r.method=t.read_byte(t.next_in_index++)))){r.mode=Gp,t.msg="unknown compression method",r.marker=5;break}if(8+(r.method>>4)>r.wbits){r.mode=Gp,t.msg="invalid win size",r.marker=5;break}r.mode=1;case 1:if(0===t.avail_in)return i;if(i=e,t.avail_in--,t.total_in++,s=255&t.read_byte(t.next_in_index++),((r.method<<8)+s)%31!=0){r.mode=Gp,t.msg="incorrect header check",r.marker=5;break}if(0==(32&s)){r.mode=7;break}r.mode=2;case 2:if(0===t.avail_in)return i;i=e,t.avail_in--,t.total_in++,r.need=(255&t.read_byte(t.next_in_index++))<<24&4278190080,r.mode=3;case 3:if(0===t.avail_in)return i;i=e,t.avail_in--,t.total_in++,r.need+=(255&t.read_byte(t.next_in_index++))<<16&16711680,r.mode=4;case 4:if(0===t.avail_in)return i;i=e,t.avail_in--,t.total_in++,r.need+=(255&t.read_byte(t.next_in_index++))<<8&65280,r.mode=5;case 5:return 0===t.avail_in?i:(i=e,t.avail_in--,t.total_in++,r.need+=255&t.read_byte(t.next_in_index++),r.mode=6,2);case 6:return r.mode=Gp,t.msg="need dictionary",r.marker=0,ap;case 7:if(i=r.blocks.proc(t,i),i==op){r.mode=Gp,r.marker=0;break}if(i==rp&&(i=e),i!=np)return i;i=e,r.blocks.reset(t,r.was),r.mode=12;case 12:return t.avail_in=0,np;case Gp:return op;default:return ap}},t.inflateSetDictionary=function(t,e,i){let s=0,r=i;if(!t||!t.istate||6!=t.istate.mode)return ap;const n=t.istate;return r>=1<<n.wbits&&(r=(1<<n.wbits)-1,s=i-r),n.blocks.set_dictionary(e,s,r),n.mode=7,rp},t.inflateSync=function(t){let i,s,r,n,a;if(!t||!t.istate)return ap;const o=t.istate;if(o.mode!=Gp&&(o.mode=Gp,o.marker=0),0===(i=t.avail_in))return lp;for(s=t.next_in_index,r=o.marker;0!==i&&r<4;)t.read_byte(s)==Xp[r]?r++:r=0!==t.read_byte(s)?0:4-r,s++,i--;return t.total_in+=s-t.next_in_index,t.next_in_index=s,t.avail_in=i,o.marker=r,4!=r?op:(n=t.total_in,a=t.total_out,e(t),t.total_in=n,t.total_out=a,o.mode=7,rp)},t.inflateSyncPoint=function(t){return t&&t.istate&&t.istate.blocks?t.istate.blocks.sync_point():ap}}function Hp(){}Hp.prototype={inflateInit(t){const e=this;return e.istate=new Wp,t||(t=15),e.istate.inflateInit(e,t)},inflate(t){const e=this;return e.istate?e.istate.inflate(e,t):ap},inflateEnd(){const t=this;if(!t.istate)return ap;const e=t.istate.inflateEnd(t);return t.istate=null,e},inflateSync(){const t=this;return t.istate?t.istate.inflateSync(t):ap},inflateSetDictionary(t,e){const i=this;return i.istate?i.istate.inflateSetDictionary(i,t,e):ap},read_byte(t){return this.next_in[t]},read_buf(t,e){return this.next_in.subarray(t,t+e)}};const jp=4294967295,qp=65535,Yp=33639248,Zp=101075792,Kp=22,Qp=1,Jp=void 0,tm="undefined",em="function";class im{constructor(t){return class extends TransformStream{constructor(e,i){const s=new t(i);super({transform(t,e){e.enqueue(s.append(t))},flush(t){const e=s.flush();e&&t.enqueue(e)}})}}}}let sm=2;try{typeof navigator!=tm&&navigator.hardwareConcurrency&&(sm=navigator.hardwareConcurrency)}catch(t){}const rm={chunkSize:524288,maxWorkers:sm,terminateWorkerTimeout:5e3,useWebWorkers:!0,useCompressionStream:!0,workerScripts:Jp,CompressionStreamNative:typeof CompressionStream!=tm&&CompressionStream,DecompressionStreamNative:typeof DecompressionStream!=tm&&DecompressionStream},nm=Object.assign({},rm);function am(t){const{baseURL:e,chunkSize:i,maxWorkers:s,terminateWorkerTimeout:r,useCompressionStream:n,useWebWorkers:a,Deflate:o,Inflate:h,CompressionStream:l,DecompressionStream:u,workerScripts:c}=t;if(om("baseURL",e),om("chunkSize",i),om("maxWorkers",s),om("terminateWorkerTimeout",r),om("useCompressionStream",n),om("useWebWorkers",a),o&&(nm.CompressionStream=new im(o)),h&&(nm.DecompressionStream=new im(h)),om("CompressionStream",l),om("DecompressionStream",u),c!==Jp){const{deflate:t,inflate:e}=c;if((t||e)&&(nm.workerScripts||(nm.workerScripts={})),t){if(!Array.isArray(t))throw new Error("workerScripts.deflate must be an array");nm.workerScripts.deflate=t}if(e){if(!Array.isArray(e))throw new Error("workerScripts.inflate must be an array");nm.workerScripts.inflate=e}}}function om(t,e){e!==Jp&&(nm[t]=e)}const hm={application:{"andrew-inset":"ez",annodex:"anx","atom+xml":"atom","atomcat+xml":"atomcat","atomserv+xml":"atomsrv",bbolin:"lin","cu-seeme":"cu","davmount+xml":"davmount",dsptype:"tsp",ecmascript:["es","ecma"],futuresplash:"spl",hta:"hta","java-archive":"jar","java-serialized-object":"ser","java-vm":"class",m3g:"m3g","mac-binhex40":"hqx",mathematica:["nb","ma","mb"],msaccess:"mdb",msword:["doc","dot","wiz"],mxf:"mxf",oda:"oda",ogg:"ogx",pdf:"pdf","pgp-keys":"key","pgp-signature":["asc","sig"],"pics-rules":"prf",postscript:["ps","ai","eps","epsi","epsf","eps2","eps3"],rar:"rar","rdf+xml":"rdf","rss+xml":"rss",rtf:"rtf","xhtml+xml":["xhtml","xht"],xml:["xml","xsl","xsd","xpdl"],"xspf+xml":"xspf",zip:"zip","vnd.android.package-archive":"apk","vnd.cinderella":"cdy","vnd.google-earth.kml+xml":"kml","vnd.google-earth.kmz":"kmz","vnd.mozilla.xul+xml":"xul","vnd.ms-excel":["xls","xlb","xlt","xlm","xla","xlc","xlw"],"vnd.ms-pki.seccat":"cat","vnd.ms-pki.stl":"stl","vnd.ms-powerpoint":["ppt","pps","pot","ppa","pwz"],"vnd.oasis.opendocument.chart":"odc","vnd.oasis.opendocument.database":"odb","vnd.oasis.opendocument.formula":"odf","vnd.oasis.opendocument.graphics":"odg","vnd.oasis.opendocument.graphics-template":"otg","vnd.oasis.opendocument.image":"odi","vnd.oasis.opendocument.presentation":"odp","vnd.oasis.opendocument.presentation-template":"otp","vnd.oasis.opendocument.spreadsheet":"ods","vnd.oasis.opendocument.spreadsheet-template":"ots","vnd.oasis.opendocument.text":"odt","vnd.oasis.opendocument.text-master":["odm","otm"],"vnd.oasis.opendocument.text-template":"ott","vnd.oasis.opendocument.text-web":"oth","vnd.openxmlformats-officedocument.spreadsheetml.sheet":"xlsx","vnd.openxmlformats-officedocument.spreadsheetml.template":"xltx","vnd.openxmlformats-officedocument.presentationml.presentation":"pptx","vnd.openxmlformats-officedocument.presentationml.slideshow":"ppsx","vnd.openxmlformats-officedocument.presentationml.template":"potx","vnd.openxmlformats-officedocument.wordprocessingml.document":"docx","vnd.openxmlformats-officedocument.wordprocessingml.template":"dotx","vnd.smaf":"mmf","vnd.stardivision.calc":"sdc","vnd.stardivision.chart":"sds","vnd.stardivision.draw":"sda","vnd.stardivision.impress":"sdd","vnd.stardivision.math":["sdf","smf"],"vnd.stardivision.writer":["sdw","vor"],"vnd.stardivision.writer-global":"sgl","vnd.sun.xml.calc":"sxc","vnd.sun.xml.calc.template":"stc","vnd.sun.xml.draw":"sxd","vnd.sun.xml.draw.template":"std","vnd.sun.xml.impress":"sxi","vnd.sun.xml.impress.template":"sti","vnd.sun.xml.math":"sxm","vnd.sun.xml.writer":"sxw","vnd.sun.xml.writer.global":"sxg","vnd.sun.xml.writer.template":"stw","vnd.symbian.install":["sis","sisx"],"vnd.visio":["vsd","vst","vss","vsw","vsdx","vssx","vstx","vssm","vstm"],"vnd.wap.wbxml":"wbxml","vnd.wap.wmlc":"wmlc","vnd.wap.wmlscriptc":"wmlsc","vnd.wordperfect":"wpd","vnd.wordperfect5.1":"wp5","x-123":"wk","x-7z-compressed":"7z","x-abiword":"abw","x-apple-diskimage":"dmg","x-bcpio":"bcpio","x-bittorrent":"torrent","x-cbr":["cbr","cba","cbt","cb7"],"x-cbz":"cbz","x-cdf":["cdf","cda"],"x-cdlink":"vcd","x-chess-pgn":"pgn","x-cpio":"cpio","x-csh":"csh","x-director":["dir","dxr","cst","cct","cxt","w3d","fgd","swa"],"x-dms":"dms","x-doom":"wad","x-dvi":"dvi","x-httpd-eruby":"rhtml","x-font":"pcf.Z","x-freemind":"mm","x-gnumeric":"gnumeric","x-go-sgf":"sgf","x-graphing-calculator":"gcf","x-gtar":["gtar","taz"],"x-hdf":"hdf","x-httpd-php":["phtml","pht","php"],"x-httpd-php-source":"phps","x-httpd-php3":"php3","x-httpd-php3-preprocessed":"php3p","x-httpd-php4":"php4","x-httpd-php5":"php5","x-ica":"ica","x-info":"info","x-internet-signup":["ins","isp"],"x-iphone":"iii","x-iso9660-image":"iso","x-java-jnlp-file":"jnlp","x-jmol":"jmz","x-killustrator":"kil","x-latex":"latex","x-lyx":"lyx","x-lzx":"lzx","x-maker":["frm","fb","fbdoc"],"x-ms-wmd":"wmd","x-msdos-program":["com","exe","bat","dll"],"x-netcdf":["nc"],"x-ns-proxy-autoconfig":["pac","dat"],"x-nwc":"nwc","x-object":"o","x-oz-application":"oza","x-pkcs7-certreqresp":"p7r","x-python-code":["pyc","pyo"],"x-qgis":["qgs","shp","shx"],"x-quicktimeplayer":"qtl","x-redhat-package-manager":["rpm","rpa"],"x-ruby":"rb","x-sh":"sh","x-shar":"shar","x-shockwave-flash":["swf","swfl"],"x-silverlight":"scr","x-stuffit":"sit","x-sv4cpio":"sv4cpio","x-sv4crc":"sv4crc","x-tar":"tar","x-tex-gf":"gf","x-tex-pk":"pk","x-texinfo":["texinfo","texi"],"x-trash":["~","%","bak","old","sik"],"x-ustar":"ustar","x-wais-source":"src","x-wingz":"wz","x-x509-ca-cert":["crt","der","cer"],"x-xcf":"xcf","x-xfig":"fig","x-xpinstall":"xpi",applixware:"aw","atomsvc+xml":"atomsvc","ccxml+xml":"ccxml","cdmi-capability":"cdmia","cdmi-container":"cdmic","cdmi-domain":"cdmid","cdmi-object":"cdmio","cdmi-queue":"cdmiq","docbook+xml":"dbk","dssc+der":"dssc","dssc+xml":"xdssc","emma+xml":"emma","epub+zip":"epub",exi:"exi","font-tdpfr":"pfr","gml+xml":"gml","gpx+xml":"gpx",gxf:"gxf",hyperstudio:"stk","inkml+xml":["ink","inkml"],ipfix:"ipfix","jsonml+json":"jsonml","lost+xml":"lostxml","mads+xml":"mads",marc:"mrc","marcxml+xml":"mrcx","mathml+xml":["mathml","mml"],mbox:"mbox","mediaservercontrol+xml":"mscml","metalink+xml":"metalink","metalink4+xml":"meta4","mets+xml":"mets","mods+xml":"mods",mp21:["m21","mp21"],mp4:"mp4s","oebps-package+xml":"opf","omdoc+xml":"omdoc",onenote:["onetoc","onetoc2","onetmp","onepkg"],oxps:"oxps","patch-ops-error+xml":"xer","pgp-encrypted":"pgp",pkcs10:"p10","pkcs7-mime":["p7m","p7c"],"pkcs7-signature":"p7s",pkcs8:"p8","pkix-attr-cert":"ac","pkix-crl":"crl","pkix-pkipath":"pkipath",pkixcmp:"pki","pls+xml":"pls","prs.cww":"cww","pskc+xml":"pskcxml","reginfo+xml":"rif","relax-ng-compact-syntax":"rnc","resource-lists+xml":"rl","resource-lists-diff+xml":"rld","rls-services+xml":"rs","rpki-ghostbusters":"gbr","rpki-manifest":"mft","rpki-roa":"roa","rsd+xml":"rsd","sbml+xml":"sbml","scvp-cv-request":"scq","scvp-cv-response":"scs","scvp-vp-request":"spq","scvp-vp-response":"spp",sdp:"sdp","set-payment-initiation":"setpay","set-registration-initiation":"setreg","shf+xml":"shf","sparql-query":"rq","sparql-results+xml":"srx",srgs:"gram","srgs+xml":"grxml","sru+xml":"sru","ssdl+xml":"ssdl","ssml+xml":"ssml","tei+xml":["tei","teicorpus"],"thraud+xml":"tfi","timestamped-data":"tsd","vnd.3gpp.pic-bw-large":"plb","vnd.3gpp.pic-bw-small":"psb","vnd.3gpp.pic-bw-var":"pvb","vnd.3gpp2.tcap":"tcap","vnd.3m.post-it-notes":"pwn","vnd.accpac.simply.aso":"aso","vnd.accpac.simply.imp":"imp","vnd.acucobol":"acu","vnd.acucorp":["atc","acutc"],"vnd.adobe.air-application-installer-package+zip":"air","vnd.adobe.formscentral.fcdt":"fcdt","vnd.adobe.fxp":["fxp","fxpl"],"vnd.adobe.xdp+xml":"xdp","vnd.adobe.xfdf":"xfdf","vnd.ahead.space":"ahead","vnd.airzip.filesecure.azf":"azf","vnd.airzip.filesecure.azs":"azs","vnd.amazon.ebook":"azw","vnd.americandynamics.acc":"acc","vnd.amiga.ami":"ami","vnd.anser-web-certificate-issue-initiation":"cii","vnd.anser-web-funds-transfer-initiation":"fti","vnd.antix.game-component":"atx","vnd.apple.installer+xml":"mpkg","vnd.apple.mpegurl":"m3u8","vnd.aristanetworks.swi":"swi","vnd.astraea-software.iota":"iota","vnd.audiograph":"aep","vnd.blueice.multipass":"mpm","vnd.bmi":"bmi","vnd.businessobjects":"rep","vnd.chemdraw+xml":"cdxml","vnd.chipnuts.karaoke-mmd":"mmd","vnd.claymore":"cla","vnd.cloanto.rp9":"rp9","vnd.clonk.c4group":["c4g","c4d","c4f","c4p","c4u"],"vnd.cluetrust.cartomobile-config":"c11amc","vnd.cluetrust.cartomobile-config-pkg":"c11amz","vnd.commonspace":"csp","vnd.contact.cmsg":"cdbcmsg","vnd.cosmocaller":"cmc","vnd.crick.clicker":"clkx","vnd.crick.clicker.keyboard":"clkk","vnd.crick.clicker.palette":"clkp","vnd.crick.clicker.template":"clkt","vnd.crick.clicker.wordbank":"clkw","vnd.criticaltools.wbs+xml":"wbs","vnd.ctc-posml":"pml","vnd.cups-ppd":"ppd","vnd.curl.car":"car","vnd.curl.pcurl":"pcurl","vnd.dart":"dart","vnd.data-vision.rdz":"rdz","vnd.dece.data":["uvf","uvvf","uvd","uvvd"],"vnd.dece.ttml+xml":["uvt","uvvt"],"vnd.dece.unspecified":["uvx","uvvx"],"vnd.dece.zip":["uvz","uvvz"],"vnd.denovo.fcselayout-link":"fe_launch","vnd.dna":"dna","vnd.dolby.mlp":"mlp","vnd.dpgraph":"dpg","vnd.dreamfactory":"dfac","vnd.ds-keypoint":"kpxx","vnd.dvb.ait":"ait","vnd.dvb.service":"svc","vnd.dynageo":"geo","vnd.ecowin.chart":"mag","vnd.enliven":"nml","vnd.epson.esf":"esf","vnd.epson.msf":"msf","vnd.epson.quickanime":"qam","vnd.epson.salt":"slt","vnd.epson.ssf":"ssf","vnd.eszigno3+xml":["es3","et3"],"vnd.ezpix-album":"ez2","vnd.ezpix-package":"ez3","vnd.fdf":"fdf","vnd.fdsn.mseed":"mseed","vnd.fdsn.seed":["seed","dataless"],"vnd.flographit":"gph","vnd.fluxtime.clip":"ftc","vnd.framemaker":["fm","frame","maker","book"],"vnd.frogans.fnc":"fnc","vnd.frogans.ltf":"ltf","vnd.fsc.weblaunch":"fsc","vnd.fujitsu.oasys":"oas","vnd.fujitsu.oasys2":"oa2","vnd.fujitsu.oasys3":"oa3","vnd.fujitsu.oasysgp":"fg5","vnd.fujitsu.oasysprs":"bh2","vnd.fujixerox.ddd":"ddd","vnd.fujixerox.docuworks":"xdw","vnd.fujixerox.docuworks.binder":"xbd","vnd.fuzzysheet":"fzs","vnd.genomatix.tuxedo":"txd","vnd.geogebra.file":"ggb","vnd.geogebra.tool":"ggt","vnd.geometry-explorer":["gex","gre"],"vnd.geonext":"gxt","vnd.geoplan":"g2w","vnd.geospace":"g3w","vnd.gmx":"gmx","vnd.grafeq":["gqf","gqs"],"vnd.groove-account":"gac","vnd.groove-help":"ghf","vnd.groove-identity-message":"gim","vnd.groove-injector":"grv","vnd.groove-tool-message":"gtm","vnd.groove-tool-template":"tpl","vnd.groove-vcard":"vcg","vnd.hal+xml":"hal","vnd.handheld-entertainment+xml":"zmm","vnd.hbci":"hbci","vnd.hhe.lesson-player":"les","vnd.hp-hpgl":"hpgl","vnd.hp-hpid":"hpid","vnd.hp-hps":"hps","vnd.hp-jlyt":"jlt","vnd.hp-pcl":"pcl","vnd.hp-pclxl":"pclxl","vnd.hydrostatix.sof-data":"sfd-hdstx","vnd.ibm.minipay":"mpy","vnd.ibm.modcap":["afp","listafp","list3820"],"vnd.ibm.rights-management":"irm","vnd.ibm.secure-container":"sc","vnd.iccprofile":["icc","icm"],"vnd.igloader":"igl","vnd.immervision-ivp":"ivp","vnd.immervision-ivu":"ivu","vnd.insors.igm":"igm","vnd.intercon.formnet":["xpw","xpx"],"vnd.intergeo":"i2g","vnd.intu.qbo":"qbo","vnd.intu.qfx":"qfx","vnd.ipunplugged.rcprofile":"rcprofile","vnd.irepository.package+xml":"irp","vnd.is-xpr":"xpr","vnd.isac.fcs":"fcs","vnd.jam":"jam","vnd.jcp.javame.midlet-rms":"rms","vnd.jisp":"jisp","vnd.joost.joda-archive":"joda","vnd.kahootz":["ktz","ktr"],"vnd.kde.karbon":"karbon","vnd.kde.kchart":"chrt","vnd.kde.kformula":"kfo","vnd.kde.kivio":"flw","vnd.kde.kontour":"kon","vnd.kde.kpresenter":["kpr","kpt"],"vnd.kde.kspread":"ksp","vnd.kde.kword":["kwd","kwt"],"vnd.kenameaapp":"htke","vnd.kidspiration":"kia","vnd.kinar":["kne","knp"],"vnd.koan":["skp","skd","skt","skm"],"vnd.kodak-descriptor":"sse","vnd.las.las+xml":"lasxml","vnd.llamagraphics.life-balance.desktop":"lbd","vnd.llamagraphics.life-balance.exchange+xml":"lbe","vnd.lotus-1-2-3":"123","vnd.lotus-approach":"apr","vnd.lotus-freelance":"pre","vnd.lotus-notes":"nsf","vnd.lotus-organizer":"org","vnd.lotus-screencam":"scm","vnd.lotus-wordpro":"lwp","vnd.macports.portpkg":"portpkg","vnd.mcd":"mcd","vnd.medcalcdata":"mc1","vnd.mediastation.cdkey":"cdkey","vnd.mfer":"mwf","vnd.mfmp":"mfm","vnd.micrografx.flo":"flo","vnd.micrografx.igx":"igx","vnd.mif":"mif","vnd.mobius.daf":"daf","vnd.mobius.dis":"dis","vnd.mobius.mbk":"mbk","vnd.mobius.mqy":"mqy","vnd.mobius.msl":"msl","vnd.mobius.plc":"plc","vnd.mobius.txf":"txf","vnd.mophun.application":"mpn","vnd.mophun.certificate":"mpc","vnd.ms-artgalry":"cil","vnd.ms-cab-compressed":"cab","vnd.ms-excel.addin.macroenabled.12":"xlam","vnd.ms-excel.sheet.binary.macroenabled.12":"xlsb","vnd.ms-excel.sheet.macroenabled.12":"xlsm","vnd.ms-excel.template.macroenabled.12":"xltm","vnd.ms-fontobject":"eot","vnd.ms-htmlhelp":"chm","vnd.ms-ims":"ims","vnd.ms-lrm":"lrm","vnd.ms-officetheme":"thmx","vnd.ms-powerpoint.addin.macroenabled.12":"ppam","vnd.ms-powerpoint.presentation.macroenabled.12":"pptm","vnd.ms-powerpoint.slide.macroenabled.12":"sldm","vnd.ms-powerpoint.slideshow.macroenabled.12":"ppsm","vnd.ms-powerpoint.template.macroenabled.12":"potm","vnd.ms-project":["mpp","mpt"],"vnd.ms-word.document.macroenabled.12":"docm","vnd.ms-word.template.macroenabled.12":"dotm","vnd.ms-works":["wps","wks","wcm","wdb"],"vnd.ms-wpl":"wpl","vnd.ms-xpsdocument":"xps","vnd.mseq":"mseq","vnd.musician":"mus","vnd.muvee.style":"msty","vnd.mynfc":"taglet","vnd.neurolanguage.nlu":"nlu","vnd.nitf":["ntf","nitf"],"vnd.noblenet-directory":"nnd","vnd.noblenet-sealer":"nns","vnd.noblenet-web":"nnw","vnd.nokia.n-gage.data":"ngdat","vnd.nokia.n-gage.symbian.install":"n-gage","vnd.nokia.radio-preset":"rpst","vnd.nokia.radio-presets":"rpss","vnd.novadigm.edm":"edm","vnd.novadigm.edx":"edx","vnd.novadigm.ext":"ext","vnd.oasis.opendocument.chart-template":"otc","vnd.oasis.opendocument.formula-template":"odft","vnd.oasis.opendocument.image-template":"oti","vnd.olpc-sugar":"xo","vnd.oma.dd2+xml":"dd2","vnd.openofficeorg.extension":"oxt","vnd.openxmlformats-officedocument.presentationml.slide":"sldx","vnd.osgeo.mapguide.package":"mgp","vnd.osgi.dp":"dp","vnd.osgi.subsystem":"esa","vnd.palm":["pdb","pqa","oprc"],"vnd.pawaafile":"paw","vnd.pg.format":"str","vnd.pg.osasli":"ei6","vnd.picsel":"efif","vnd.pmi.widget":"wg","vnd.pocketlearn":"plf","vnd.powerbuilder6":"pbd","vnd.previewsystems.box":"box","vnd.proteus.magazine":"mgz","vnd.publishare-delta-tree":"qps","vnd.pvi.ptid1":"ptid","vnd.quark.quarkxpress":["qxd","qxt","qwd","qwt","qxl","qxb"],"vnd.realvnc.bed":"bed","vnd.recordare.musicxml":"mxl","vnd.recordare.musicxml+xml":"musicxml","vnd.rig.cryptonote":"cryptonote","vnd.rn-realmedia":"rm","vnd.rn-realmedia-vbr":"rmvb","vnd.route66.link66+xml":"link66","vnd.sailingtracker.track":"st","vnd.seemail":"see","vnd.sema":"sema","vnd.semd":"semd","vnd.semf":"semf","vnd.shana.informed.formdata":"ifm","vnd.shana.informed.formtemplate":"itp","vnd.shana.informed.interchange":"iif","vnd.shana.informed.package":"ipk","vnd.simtech-mindmapper":["twd","twds"],"vnd.smart.teacher":"teacher","vnd.solent.sdkm+xml":["sdkm","sdkd"],"vnd.spotfire.dxp":"dxp","vnd.spotfire.sfs":"sfs","vnd.stepmania.package":"smzip","vnd.stepmania.stepchart":"sm","vnd.sus-calendar":["sus","susp"],"vnd.svd":"svd","vnd.syncml+xml":"xsm","vnd.syncml.dm+wbxml":"bdm","vnd.syncml.dm+xml":"xdm","vnd.tao.intent-module-archive":"tao","vnd.tcpdump.pcap":["pcap","cap","dmp"],"vnd.tmobile-livetv":"tmo","vnd.trid.tpt":"tpt","vnd.triscape.mxs":"mxs","vnd.trueapp":"tra","vnd.ufdl":["ufd","ufdl"],"vnd.uiq.theme":"utz","vnd.umajin":"umj","vnd.unity":"unityweb","vnd.uoml+xml":"uoml","vnd.vcx":"vcx","vnd.visionary":"vis","vnd.vsf":"vsf","vnd.webturbo":"wtb","vnd.wolfram.player":"nbp","vnd.wqd":"wqd","vnd.wt.stf":"stf","vnd.xara":"xar","vnd.xfdl":"xfdl","vnd.yamaha.hv-dic":"hvd","vnd.yamaha.hv-script":"hvs","vnd.yamaha.hv-voice":"hvp","vnd.yamaha.openscoreformat":"osf","vnd.yamaha.openscoreformat.osfpvg+xml":"osfpvg","vnd.yamaha.smaf-audio":"saf","vnd.yamaha.smaf-phrase":"spf","vnd.yellowriver-custom-menu":"cmp","vnd.zul":["zir","zirz"],"vnd.zzazz.deck+xml":"zaz","voicexml+xml":"vxml",widget:"wgt",winhlp:"hlp","wsdl+xml":"wsdl","wspolicy+xml":"wspolicy","x-ace-compressed":"ace","x-authorware-bin":["aab","x32","u32","vox"],"x-authorware-map":"aam","x-authorware-seg":"aas","x-blorb":["blb","blorb"],"x-bzip":"bz","x-bzip2":["bz2","boz"],"x-cfs-compressed":"cfs","x-chat":"chat","x-conference":"nsc","x-dgc-compressed":"dgc","x-dtbncx+xml":"ncx","x-dtbook+xml":"dtb","x-dtbresource+xml":"res","x-eva":"eva","x-font-bdf":"bdf","x-font-ghostscript":"gsf","x-font-linux-psf":"psf","x-font-pcf":"pcf","x-font-snf":"snf","x-font-ttf":["ttf","ttc"],"x-font-type1":["pfa","pfb","pfm","afm"],"x-freearc":"arc","x-gca-compressed":"gca","x-glulx":"ulx","x-gramps-xml":"gramps","x-install-instructions":"install","x-lzh-compressed":["lzh","lha"],"x-mie":"mie","x-mobipocket-ebook":["prc","mobi"],"x-ms-application":"application","x-ms-shortcut":"lnk","x-ms-xbap":"xbap","x-msbinder":"obd","x-mscardfile":"crd","x-msclip":"clp","application/x-ms-installer":"msi","x-msmediaview":["mvb","m13","m14"],"x-msmetafile":["wmf","wmz","emf","emz"],"x-msmoney":"mny","x-mspublisher":"pub","x-msschedule":"scd","x-msterminal":"trm","x-mswrite":"wri","x-nzb":"nzb","x-pkcs12":["p12","pfx"],"x-pkcs7-certificates":["p7b","spc"],"x-research-info-systems":"ris","x-silverlight-app":"xap","x-sql":"sql","x-stuffitx":"sitx","x-subrip":"srt","x-t3vm-image":"t3","x-tex-tfm":"tfm","x-tgif":"obj","x-xliff+xml":"xlf","x-xz":"xz","x-zmachine":["z1","z2","z3","z4","z5","z6","z7","z8"],"xaml+xml":"xaml","xcap-diff+xml":"xdf","xenc+xml":"xenc","xml-dtd":"dtd","xop+xml":"xop","xproc+xml":"xpl","xslt+xml":"xslt","xv+xml":["mxml","xhvml","xvml","xvm"],yang:"yang","yin+xml":"yin",envoy:"evy",fractals:"fif","internet-property-stream":"acx",olescript:"axs","vnd.ms-outlook":"msg","vnd.ms-pkicertstore":"sst","x-compress":"z","x-perfmon":["pma","pmc","pmr","pmw"],"ynd.ms-pkipko":"pko",gzip:["gz","tgz"],"smil+xml":["smi","smil"],"vnd.debian.binary-package":["deb","udeb"],"vnd.hzn-3d-crossword":"x3d","vnd.sqlite3":["db","sqlite","sqlite3","db-wal","sqlite-wal","db-shm","sqlite-shm"],"vnd.wap.sic":"sic","vnd.wap.slc":"slc","x-krita":["kra","krz"],"x-perl":["pm","pl"],yaml:["yaml","yml"]},audio:{amr:"amr","amr-wb":"awb",annodex:"axa",basic:["au","snd"],flac:"flac",midi:["mid","midi","kar","rmi"],mpeg:["mpga","mpega","mp3","m4a","mp2a","m2a","m3a"],mpegurl:"m3u",ogg:["oga","ogg","spx"],"prs.sid":"sid","x-aiff":"aifc","x-gsm":"gsm","x-ms-wma":"wma","x-ms-wax":"wax","x-pn-realaudio":"ram","x-realaudio":"ra","x-sd2":"sd2",adpcm:"adp",mp4:"mp4a",s3m:"s3m",silk:"sil","vnd.dece.audio":["uva","uvva"],"vnd.digital-winds":"eol","vnd.dra":"dra","vnd.dts":"dts","vnd.dts.hd":"dtshd","vnd.lucent.voice":"lvp","vnd.ms-playready.media.pya":"pya","vnd.nuera.ecelp4800":"ecelp4800","vnd.nuera.ecelp7470":"ecelp7470","vnd.nuera.ecelp9600":"ecelp9600","vnd.rip":"rip",webm:"weba","x-caf":"caf","x-matroska":"mka","x-pn-realaudio-plugin":"rmp",xm:"xm",aac:"aac",aiff:["aiff","aif","aff"],opus:"opus",wav:"wav"},chemical:{"x-alchemy":"alc","x-cache":["cac","cache"],"x-cache-csf":"csf","x-cactvs-binary":["cbin","cascii","ctab"],"x-cdx":"cdx","x-chem3d":"c3d","x-cif":"cif","x-cmdf":"cmdf","x-cml":"cml","x-compass":"cpa","x-crossfire":"bsd","x-csml":["csml","csm"],"x-ctx":"ctx","x-cxf":["cxf","cef"],"x-embl-dl-nucleotide":["emb","embl"],"x-gamess-input":["inp","gam","gamin"],"x-gaussian-checkpoint":["fch","fchk"],"x-gaussian-cube":"cub","x-gaussian-input":["gau","gjc","gjf"],"x-gaussian-log":"gal","x-gcg8-sequence":"gcg","x-genbank":"gen","x-hin":"hin","x-isostar":["istr","ist"],"x-jcamp-dx":["jdx","dx"],"x-kinemage":"kin","x-macmolecule":"mcm","x-macromodel-input":"mmod","x-mdl-molfile":"mol","x-mdl-rdfile":"rd","x-mdl-rxnfile":"rxn","x-mdl-sdfile":"sd","x-mdl-tgf":"tgf","x-mmcif":"mcif","x-mol2":"mol2","x-molconn-Z":"b","x-mopac-graph":"gpt","x-mopac-input":["mop","mopcrt","zmt"],"x-mopac-out":"moo","x-ncbi-asn1":"asn","x-ncbi-asn1-ascii":["prt","ent"],"x-ncbi-asn1-binary":"val","x-rosdal":"ros","x-swissprot":"sw","x-vamas-iso14976":"vms","x-vmd":"vmd","x-xtel":"xtel","x-xyz":"xyz"},font:{otf:"otf",woff:"woff",woff2:"woff2"},image:{gif:"gif",ief:"ief",jpeg:["jpeg","jpg","jpe","jfif","jfif-tbnl","jif"],pcx:"pcx",png:"png","svg+xml":["svg","svgz"],tiff:["tiff","tif"],"vnd.djvu":["djvu","djv"],"vnd.wap.wbmp":"wbmp","x-canon-cr2":"cr2","x-canon-crw":"crw","x-cmu-raster":"ras","x-coreldraw":"cdr","x-coreldrawpattern":"pat","x-coreldrawtemplate":"cdt","x-corelphotopaint":"cpt","x-epson-erf":"erf","x-icon":"ico","x-jg":"art","x-jng":"jng","x-nikon-nef":"nef","x-olympus-orf":"orf","x-portable-anymap":"pnm","x-portable-bitmap":"pbm","x-portable-graymap":"pgm","x-portable-pixmap":"ppm","x-rgb":"rgb","x-xbitmap":"xbm","x-xpixmap":"xpm","x-xwindowdump":"xwd",bmp:"bmp",cgm:"cgm",g3fax:"g3",ktx:"ktx","prs.btif":"btif",sgi:"sgi","vnd.dece.graphic":["uvi","uvvi","uvg","uvvg"],"vnd.dwg":"dwg","vnd.dxf":"dxf","vnd.fastbidsheet":"fbs","vnd.fpx":"fpx","vnd.fst":"fst","vnd.fujixerox.edmics-mmr":"mmr","vnd.fujixerox.edmics-rlc":"rlc","vnd.ms-modi":"mdi","vnd.ms-photo":"wdp","vnd.net-fpx":"npx","vnd.xiff":"xif",webp:"webp","x-3ds":"3ds","x-cmx":"cmx","x-freehand":["fh","fhc","fh4","fh5","fh7"],"x-pict":["pic","pct"],"x-tga":"tga","cis-cod":"cod",avif:"avifs",heic:["heif","heic"],pjpeg:["pjpg"],"vnd.adobe.photoshop":"psd","x-adobe-dng":"dng","x-fuji-raf":"raf","x-icns":"icns","x-kodak-dcr":"dcr","x-kodak-k25":"k25","x-kodak-kdc":"kdc","x-minolta-mrw":"mrw","x-panasonic-raw":["raw","rw2","rwl"],"x-pentax-pef":["pef","ptx"],"x-sigma-x3f":"x3f","x-sony-arw":"arw","x-sony-sr2":"sr2","x-sony-srf":"srf"},message:{rfc822:["eml","mime","mht","mhtml","nws"]},model:{iges:["igs","iges"],mesh:["msh","mesh","silo"],vrml:["wrl","vrml"],"x3d+vrml":["x3dv","x3dvz"],"x3d+xml":"x3dz","x3d+binary":["x3db","x3dbz"],"vnd.collada+xml":"dae","vnd.dwf":"dwf","vnd.gdl":"gdl","vnd.gtw":"gtw","vnd.mts":"mts","vnd.usdz+zip":"usdz","vnd.vtu":"vtu"},text:{"cache-manifest":["manifest","appcache"],calendar:["ics","icz","ifb"],css:"css",csv:"csv",h323:"323",html:["html","htm","shtml","stm"],iuls:"uls",plain:["txt","text","brf","conf","def","list","log","in","bas","diff","ksh"],richtext:"rtx",scriptlet:["sct","wsc"],texmacs:"tm","tab-separated-values":"tsv","vnd.sun.j2me.app-descriptor":"jad","vnd.wap.wml":"wml","vnd.wap.wmlscript":"wmls","x-bibtex":"bib","x-boo":"boo","x-c++hdr":["h++","hpp","hxx","hh"],"x-c++src":["c++","cpp","cxx","cc"],"x-component":"htc","x-dsrc":"d","x-diff":"patch","x-haskell":"hs","x-java":"java","x-literate-haskell":"lhs","x-moc":"moc","x-pascal":["p","pas","pp","inc"],"x-pcs-gcd":"gcd","x-python":"py","x-scala":"scala","x-setext":"etx","x-tcl":["tcl","tk"],"x-tex":["tex","ltx","sty","cls"],"x-vcalendar":"vcs","x-vcard":"vcf",n3:"n3","prs.lines.tag":"dsc",sgml:["sgml","sgm"],troff:["t","tr","roff","man","me","ms"],turtle:"ttl","uri-list":["uri","uris","urls"],vcard:"vcard","vnd.curl":"curl","vnd.curl.dcurl":"dcurl","vnd.curl.scurl":"scurl","vnd.curl.mcurl":"mcurl","vnd.dvb.subtitle":"sub","vnd.fly":"fly","vnd.fmi.flexstor":"flx","vnd.graphviz":"gv","vnd.in3d.3dml":"3dml","vnd.in3d.spot":"spot","x-asm":["s","asm"],"x-c":["c","h","dic"],"x-fortran":["f","for","f77","f90"],"x-opml":"opml","x-nfo":"nfo","x-sfv":"sfv","x-uuencode":"uu",webviewhtml:"htt",javascript:"js",json:"json",markdown:["md","markdown","mdown","markdn"],"vnd.wap.si":"si","vnd.wap.sl":"sl"},video:{avif:"avif","3gpp":"3gp",annodex:"axv",dl:"dl",dv:["dif","dv"],fli:"fli",gl:"gl",mpeg:["mpeg","mpg","mpe","m1v","m2v","mp2","mpa","mpv2"],mp4:["mp4","mp4v","mpg4"],quicktime:["qt","mov"],ogg:"ogv","vnd.mpegurl":["mxu","m4u"],"x-flv":"flv","x-la-asf":["lsf","lsx"],"x-mng":"mng","x-ms-asf":["asf","asx","asr"],"x-ms-wm":"wm","x-ms-wmv":"wmv","x-ms-wmx":"wmx","x-ms-wvx":"wvx","x-msvideo":"avi","x-sgi-movie":"movie","x-matroska":["mpv","mkv","mk3d","mks"],"3gpp2":"3g2",h261:"h261",h263:"h263",h264:"h264",jpeg:"jpgv",jpm:["jpm","jpgm"],mj2:["mj2","mjp2"],"vnd.dece.hd":["uvh","uvvh"],"vnd.dece.mobile":["uvm","uvvm"],"vnd.dece.pd":["uvp","uvvp"],"vnd.dece.sd":["uvs","uvvs"],"vnd.dece.video":["uvv","uvvv"],"vnd.dvb.file":"dvb","vnd.fvt":"fvt","vnd.ms-playready.media.pyv":"pyv","vnd.uvvu.mp4":["uvu","uvvu"],"vnd.vivo":"viv",webm:"webm","x-f4v":"f4v","x-m4v":"m4v","x-ms-vob":"vob","x-smv":"smv",mp2t:"ts"},"x-conference":{"x-cooltalk":"ice"},"x-world":{"x-vrml":["vrm","flr","wrz","xaf","xof"]}};(()=>{const t={};for(const e of Object.keys(hm))for(const i of Object.keys(hm[e])){const s=hm[e][i];if("string"==typeof s)t[s]=e+"/"+i;else for(let r=0;r<s.length;r++)t[s[r]]=e+"/"+i}})();const lm=[];for(let t=0;t<256;t++){let e=t;for(let t=0;t<8;t++)1&e?e=e>>>1^3988292384:e>>>=1;lm[t]=e}class um{constructor(t){this.crc=t||-1}append(t){let e=0|this.crc;for(let i=0,s=0|t.length;i<s;i++)e=e>>>8^lm[255&(e^t[i])];this.crc=e}get(){return~this.crc}}class cm extends TransformStream{constructor(){let t;const e=new um;super({transform(t,i){e.append(t),i.enqueue(t)},flush(){const i=new Uint8Array(4);new DataView(i.buffer).setUint32(0,e.get()),t.value=i}}),t=this}}const dm={concat(t,e){if(0===t.length||0===e.length)return t.concat(e);const i=t[t.length-1],s=dm.getPartial(i);return 32===s?t.concat(e):dm._shiftRight(e,s,0|i,t.slice(0,t.length-1))},bitLength(t){const e=t.length;if(0===e)return 0;const i=t[e-1];return 32*(e-1)+dm.getPartial(i)},clamp(t,e){if(32*t.length<e)return t;const i=(t=t.slice(0,Math.ceil(e/32))).length;return e&=31,i>0&&e&&(t[i-1]=dm.partial(e,t[i-1]&2147483648>>e-1,1)),t},partial:(t,e,i)=>32===t?e:(i?0|e:e<<32-t)+1099511627776*t,getPartial:t=>Math.round(t/1099511627776)||32,_shiftRight(t,e,i,s){for(void 0===s&&(s=[]);e>=32;e-=32)s.push(i),i=0;if(0===e)return s.concat(t);for(let r=0;r<t.length;r++)s.push(i|t[r]>>>e),i=t[r]<<32-e;const r=t.length?t[t.length-1]:0,n=dm.getPartial(r);return s.push(dm.partial(e+n&31,e+n>32?i:s.pop(),1)),s}},pm={bytes:{fromBits(t){const e=dm.bitLength(t)/8,i=new Uint8Array(e);let s;for(let r=0;r<e;r++)0==(3&r)&&(s=t[r/4]),i[r]=s>>>24,s<<=8;return i},toBits(t){const e=[];let i,s=0;for(i=0;i<t.length;i++)s=s<<8|t[i],3==(3&i)&&(e.push(s),s=0);return 3&i&&e.push(dm.partial(8*(3&i),s)),e}}},mm={sha1:class{constructor(t){const e=this;e.blockSize=512,e._init=[1732584193,4023233417,2562383102,271733878,3285377520],e._key=[1518500249,1859775393,2400959708,3395469782],t?(e._h=t._h.slice(0),e._buffer=t._buffer.slice(0),e._length=t._length):e.reset()}reset(){const t=this;return t._h=t._init.slice(0),t._buffer=[],t._length=0,t}update(t){const e=this;"string"==typeof t&&(t=pm.utf8String.toBits(t));const i=e._buffer=dm.concat(e._buffer,t),s=e._length,r=e._length=s+dm.bitLength(t);if(r>9007199254740991)throw new Error("Cannot hash more than 2^53 - 1 bits");const n=new Uint32Array(i);let a=0;for(let t=e.blockSize+s-(e.blockSize+s&e.blockSize-1);t<=r;t+=e.blockSize)e._block(n.subarray(16*a,16*(a+1))),a+=1;return i.splice(0,16*a),e}finalize(){const t=this;let e=t._buffer;const i=t._h;e=dm.concat(e,[dm.partial(1,1)]);for(let t=e.length+2;15&t;t++)e.push(0);for(e.push(Math.floor(t._length/4294967296)),e.push(0|t._length);e.length;)t._block(e.splice(0,16));return t.reset(),i}_f(t,e,i,s){return t<=19?e&i|~e&s:t<=39?e^i^s:t<=59?e&i|e&s|i&s:t<=79?e^i^s:void 0}_S(t,e){return e<<t|e>>>32-t}_block(t){const e=this,i=e._h,s=Array(80);for(let e=0;e<16;e++)s[e]=t[e];let r=i[0],n=i[1],a=i[2],o=i[3],h=i[4];for(let t=0;t<=79;t++){t>=16&&(s[t]=e._S(1,s[t-3]^s[t-8]^s[t-14]^s[t-16]));const i=e._S(5,r)+e._f(t,n,a,o)+h+s[t]+e._key[Math.floor(t/20)]|0;h=o,o=a,a=e._S(30,n),n=r,r=i}i[0]=i[0]+r|0,i[1]=i[1]+n|0,i[2]=i[2]+a|0,i[3]=i[3]+o|0,i[4]=i[4]+h|0}}},fm={aes:class{constructor(t){const e=this;e._tables=[[[],[],[],[],[]],[[],[],[],[],[]]],e._tables[0][0][0]||e._precompute();const i=e._tables[0][4],s=e._tables[1],r=t.length;let n,a,o,h=1;if(4!==r&&6!==r&&8!==r)throw new Error("invalid aes key size");for(e._key=[a=t.slice(0),o=[]],n=r;n<4*r+28;n++){let t=a[n-1];(n%r==0||8===r&&n%r==4)&&(t=i[t>>>24]<<24^i[t>>16&255]<<16^i[t>>8&255]<<8^i[255&t],n%r==0&&(t=t<<8^t>>>24^h<<24,h=h<<1^283*(h>>7))),a[n]=a[n-r]^t}for(let t=0;n;t++,n--){const e=a[3&t?n:n-4];o[t]=n<=4||t<4?e:s[0][i[e>>>24]]^s[1][i[e>>16&255]]^s[2][i[e>>8&255]]^s[3][i[255&e]]}}encrypt(t){return this._crypt(t,0)}decrypt(t){return this._crypt(t,1)}_precompute(){const t=this._tables[0],e=this._tables[1],i=t[4],s=e[4],r=[],n=[];let a,o,h,l;for(let t=0;t<256;t++)n[(r[t]=t<<1^283*(t>>7))^t]=t;for(let u=a=0;!i[u];u^=o||1,a=n[a]||1){let n=a^a<<1^a<<2^a<<3^a<<4;n=n>>8^255&n^99,i[u]=n,s[n]=u,l=r[h=r[o=r[u]]];let c=16843009*l^65537*h^257*o^16843008*u,d=257*r[n]^16843008*n;for(let i=0;i<4;i++)t[i][u]=d=d<<24^d>>>8,e[i][n]=c=c<<24^c>>>8}for(let i=0;i<5;i++)t[i]=t[i].slice(0),e[i]=e[i].slice(0)}_crypt(t,e){if(4!==t.length)throw new Error("invalid aes block size");const i=this._key[e],s=i.length/4-2,r=[0,0,0,0],n=this._tables[e],a=n[0],o=n[1],h=n[2],l=n[3],u=n[4];let c,d,p,m=t[0]^i[0],f=t[e?3:1]^i[1],_=t[2]^i[2],g=t[e?1:3]^i[3],x=4;for(let t=0;t<s;t++)c=a[m>>>24]^o[f>>16&255]^h[_>>8&255]^l[255&g]^i[x],d=a[f>>>24]^o[_>>16&255]^h[g>>8&255]^l[255&m]^i[x+1],p=a[_>>>24]^o[g>>16&255]^h[m>>8&255]^l[255&f]^i[x+2],g=a[g>>>24]^o[m>>16&255]^h[f>>8&255]^l[255&_]^i[x+3],x+=4,m=c,f=d,_=p;for(let t=0;t<4;t++)r[e?3&-t:t]=u[m>>>24]<<24^u[f>>16&255]<<16^u[_>>8&255]<<8^u[255&g]^i[x++],c=m,m=f,f=_,_=g,g=c;return r}}},_m={getRandomValues(t){const e=new Uint32Array(t.buffer),i=t=>{let e=987654321;const i=4294967295;return function(){e=36969*(65535&e)+(e>>16)&i;return(((e<<16)+(t=18e3*(65535&t)+(t>>16)&i)&i)/4294967296+.5)*(Math.random()>.5?1:-1)}};for(let s,r=0;r<t.length;r+=4){const t=i(4294967296*(s||Math.random()));s=987654071*t(),e[r/4]=4294967296*t()|0}return t}},gm={ctrGladman:class{constructor(t,e){this._prf=t,this._initIv=e,this._iv=e}reset(){this._iv=this._initIv}update(t){return this.calculate(this._prf,t,this._iv)}incWord(t){if(255==(t>>24&255)){let e=t>>16&255,i=t>>8&255,s=255&t;255===e?(e=0,255===i?(i=0,255===s?s=0:++s):++i):++e,t=0,t+=e<<16,t+=i<<8,t+=s}else t+=1<<24;return t}incCounter(t){0===(t[0]=this.incWord(t[0]))&&(t[1]=this.incWord(t[1]))}calculate(t,e,i){let s;if(!(s=e.length))return[];const r=dm.bitLength(e);for(let r=0;r<s;r+=4){this.incCounter(i);const s=t.encrypt(i);e[r]^=s[0],e[r+1]^=s[1],e[r+2]^=s[2],e[r+3]^=s[3]}return dm.clamp(e,r)}}},xm={importKey:t=>new xm.hmacSha1(pm.bytes.toBits(t)),pbkdf2(t,e,i,s){if(i=i||1e4,s<0||i<0)throw new Error("invalid params to pbkdf2");const r=1+(s>>5)<<2;let n,a,o,h,l;const u=new ArrayBuffer(r),c=new DataView(u);let d=0;const p=dm;for(e=pm.bytes.toBits(e),l=1;d<(r||1);l++){for(n=a=t.encrypt(p.concat(e,[l])),o=1;o<i;o++)for(a=t.encrypt(a),h=0;h<a.length;h++)n[h]^=a[h];for(o=0;d<(r||1)&&o<n.length;o++)c.setInt32(d,n[o]),d+=4}return u.slice(0,s/8)},hmacSha1:class{constructor(t){const e=this,i=e._hash=mm.sha1,s=[[],[]];e._baseHash=[new i,new i];const r=e._baseHash[0].blockSize/32;t.length>r&&(t=(new i).update(t).finalize());for(let e=0;e<r;e++)s[0][e]=909522486^t[e],s[1][e]=1549556828^t[e];e._baseHash[0].update(s[0]),e._baseHash[1].update(s[1]),e._resultHash=new i(e._baseHash[0])}reset(){const t=this;t._resultHash=new t._hash(t._baseHash[0]),t._updated=!1}update(t){this._updated=!0,this._resultHash.update(t)}digest(){const t=this,e=t._resultHash.finalize(),i=new t._hash(t._baseHash[1]).update(e).finalize();return t.reset(),i}encrypt(t){if(this._updated)throw new Error("encrypt on already updated hmac called!");return this.update(t),this.digest(t)}}},bm=typeof crypto!=tm&&typeof crypto.getRandomValues==em,wm="Invalid password",Tm="Invalid signature",vm="zipjs-abort-check-password";function ym(t){return bm?crypto.getRandomValues(t):_m.getRandomValues(t)}const Em=16,Sm="raw",Cm={name:"PBKDF2"},Am=Object.assign({hash:{name:"HMAC"}},Cm),Mm=Object.assign({iterations:1e3,hash:{name:"SHA-1"}},Cm),Rm=["deriveBits"],Fm=[8,12,16],Im=[16,24,32],Dm=10,$m=[0,0,0,0],Lm=typeof crypto!=tm,Pm=Lm&&crypto.subtle,Nm=Lm&&typeof Pm!=tm,Bm=pm.bytes,Om=fm.aes,Um=gm.ctrGladman,km=xm.hmacSha1;let zm=Lm&&Nm&&typeof Pm.importKey==em,Vm=Lm&&Nm&&typeof Pm.deriveBits==em;class Gm extends TransformStream{constructor({password:t,rawPassword:e,signed:i,encryptionStrength:s,checkPasswordOnly:r}){super({start(){Object.assign(this,{ready:new Promise((t=>this.resolveReady=t)),password:jm(t,e),signed:i,strength:s-1,pending:new Uint8Array})},async transform(t,e){const i=this,{password:s,strength:n,resolveReady:a,ready:o}=i;s?(await async function(t,e,i,s){const r=await Hm(t,e,i,Ym(s,0,Fm[e])),n=Ym(s,Fm[e]);if(r[0]!=n[0]||r[1]!=n[1])throw new Error(wm)}(i,n,s,Ym(t,0,Fm[n]+2)),t=Ym(t,Fm[n]+2),r?e.error(new Error(vm)):a()):await o;const h=new Uint8Array(t.length-Dm-(t.length-Dm)%Em);e.enqueue(Wm(i,t,h,0,Dm,!0))},async flush(t){const{signed:e,ctr:i,hmac:s,pending:r,ready:n}=this;if(s&&i){await n;const a=Ym(r,0,r.length-Dm),o=Ym(r,r.length-Dm);let h=new Uint8Array;if(a.length){const t=Km(Bm,a);s.update(t);const e=i.update(t);h=Zm(Bm,e)}if(e){const t=Ym(Zm(Bm,s.digest()),0,Dm);for(let e=0;e<Dm;e++)if(t[e]!=o[e])throw new Error(Tm)}t.enqueue(h)}}})}}class Xm extends TransformStream{constructor({password:t,rawPassword:e,encryptionStrength:i}){let s;super({start(){Object.assign(this,{ready:new Promise((t=>this.resolveReady=t)),password:jm(t,e),strength:i-1,pending:new Uint8Array})},async transform(t,e){const i=this,{password:s,strength:r,resolveReady:n,ready:a}=i;let o=new Uint8Array;s?(o=await async function(t,e,i){const s=ym(new Uint8Array(Fm[e])),r=await Hm(t,e,i,s);return qm(s,r)}(i,r,s),n()):await a;const h=new Uint8Array(o.length+t.length-t.length%Em);h.set(o,0),e.enqueue(Wm(i,t,h,o.length,0))},async flush(t){const{ctr:e,hmac:i,pending:r,ready:n}=this;if(i&&e){await n;let a=new Uint8Array;if(r.length){const t=e.update(Km(Bm,r));i.update(t),a=Zm(Bm,t)}s.signature=Zm(Bm,i.digest()).slice(0,Dm),t.enqueue(qm(a,s.signature))}}}),s=this}}function Wm(t,e,i,s,r,n){const{ctr:a,hmac:o,pending:h}=t,l=e.length-r;let u;for(h.length&&(e=qm(h,e),i=function(t,e){if(e&&e>t.length){const i=t;(t=new Uint8Array(e)).set(i,0)}return t}(i,l-l%Em)),u=0;u<=l-Em;u+=Em){const t=Km(Bm,Ym(e,u,u+Em));n&&o.update(t);const r=a.update(t);n||o.update(r),i.set(Zm(Bm,r),u+s)}return t.pending=Ym(e,u),i}async function Hm(t,e,i,s){t.password=null;const r=await async function(t,e,i,s,r){if(!zm)return xm.importKey(e);try{return await Pm.importKey(t,e,i,s,r)}catch(t){return zm=!1,xm.importKey(e)}}(Sm,i,Am,!1,Rm),n=await async function(t,e,i){if(!Vm)return xm.pbkdf2(e,t.salt,Mm.iterations,i);try{return await Pm.deriveBits(t,e,i)}catch(s){return Vm=!1,xm.pbkdf2(e,t.salt,Mm.iterations,i)}}(Object.assign({salt:s},Mm),r,8*(2*Im[e]+2)),a=new Uint8Array(n),o=Km(Bm,Ym(a,0,Im[e])),h=Km(Bm,Ym(a,Im[e],2*Im[e])),l=Ym(a,2*Im[e]);return Object.assign(t,{keys:{key:o,authentication:h,passwordVerification:l},ctr:new Um(new Om(o),Array.from($m)),hmac:new km(h)}),l}function jm(t,e){return e===Jp?function(t){if(typeof TextEncoder==tm){t=unescape(encodeURIComponent(t));const e=new Uint8Array(t.length);for(let i=0;i<e.length;i++)e[i]=t.charCodeAt(i);return e}return(new TextEncoder).encode(t)}(t):e}function qm(t,e){let i=t;return t.length+e.length&&(i=new Uint8Array(t.length+e.length),i.set(t,0),i.set(e,t.length)),i}function Ym(t,e,i){return t.subarray(e,i)}function Zm(t,e){return t.fromBits(e)}function Km(t,e){return t.toBits(e)}const Qm=12;class Jm extends TransformStream{constructor({password:t,passwordVerification:e,checkPasswordOnly:i}){super({start(){Object.assign(this,{password:t,passwordVerification:e}),rf(this,t)},transform(t,e){const s=this;if(s.password){const e=ef(s,t.subarray(0,Qm));if(s.password=null,e[11]!=s.passwordVerification)throw new Error(wm);t=t.subarray(Qm)}i?e.error(new Error(vm)):e.enqueue(ef(s,t))}})}}class tf extends TransformStream{constructor({password:t,passwordVerification:e}){super({start(){Object.assign(this,{password:t,passwordVerification:e}),rf(this,t)},transform(t,e){const i=this;let s,r;if(i.password){i.password=null;const e=ym(new Uint8Array(Qm));e[11]=i.passwordVerification,s=new Uint8Array(t.length+e.length),s.set(sf(i,e),0),r=Qm}else s=new Uint8Array(t.length),r=0;s.set(sf(i,t),r),e.enqueue(s)}})}}function ef(t,e){const i=new Uint8Array(e.length);for(let s=0;s<e.length;s++)i[s]=af(t)^e[s],nf(t,i[s]);return i}function sf(t,e){const i=new Uint8Array(e.length);for(let s=0;s<e.length;s++)i[s]=af(t)^e[s],nf(t,e[s]);return i}function rf(t,e){const i=[305419896,591751049,878082192];Object.assign(t,{keys:i,crcKey0:new um(i[0]),crcKey2:new um(i[2])});for(let i=0;i<e.length;i++)nf(t,e.charCodeAt(i))}function nf(t,e){let[i,s,r]=t.keys;t.crcKey0.append([e]),i=~t.crcKey0.get(),s=hf(Math.imul(hf(s+of(i)),134775813)+1),t.crcKey2.append([s>>>24]),r=~t.crcKey2.get(),t.keys=[i,s,r]}function af(t){const e=2|t.keys[2];return of(Math.imul(e,1^e)>>>8)}function of(t){return 255&t}function hf(t){return 4294967295&t}const lf="deflate-raw";class uf extends TransformStream{constructor(t,{chunkSize:e,CompressionStream:i,CompressionStreamNative:s}){super({});const{compressed:r,encrypted:n,useCompressionStream:a,zipCrypto:o,signed:h,level:l}=t,u=this;let c,d,p=df(super.readable);n&&!o||!h||(c=new cm,p=ff(p,c)),r&&(p=mf(p,a,{level:l,chunkSize:e},s,i)),n&&(o?p=ff(p,new tf(t)):(d=new Xm(t),p=ff(p,d))),pf(u,p,(()=>{let t;n&&!o&&(t=d.signature),n&&!o||!h||(t=new DataView(c.value.buffer).getUint32(0)),u.signature=t}))}}class cf extends TransformStream{constructor(t,{chunkSize:e,DecompressionStream:i,DecompressionStreamNative:s}){super({});const{zipCrypto:r,encrypted:n,signed:a,signature:o,compressed:h,useCompressionStream:l}=t;let u,c,d=df(super.readable);n&&(r?d=ff(d,new Jm(t)):(c=new Gm(t),d=ff(d,c))),h&&(d=mf(d,l,{chunkSize:e},s,i)),n&&!r||!a||(u=new cm,d=ff(d,u)),pf(this,d,(()=>{if((!n||r)&&a){const t=new DataView(u.value.buffer);if(o!=t.getUint32(0,!1))throw new Error(Tm)}}))}}function df(t){return ff(t,new TransformStream({transform(t,e){t&&t.length&&e.enqueue(t)}}))}function pf(t,e,i){e=ff(e,new TransformStream({flush:i})),Object.defineProperty(t,"readable",{get:()=>e})}function mf(t,e,i,s,r){try{t=ff(t,new(e&&s?s:r)(lf,i))}catch(s){if(!e)return t;try{t=ff(t,new r(lf,i))}catch(e){return t}}return t}function ff(t,e){return t.pipeThrough(e)}const _f="message",gf="start",xf="pull",bf="data",wf="ack",Tf="close",vf="inflate";class yf extends TransformStream{constructor(t,e){super({});const i=this,{codecType:s}=t;let r;s.startsWith("deflate")?r=uf:s.startsWith(vf)&&(r=cf);let n=0,a=0;const o=new r(t,e),h=super.readable,l=new TransformStream({transform(t,e){t&&t.length&&(a+=t.length,e.enqueue(t))},flush(){Object.assign(i,{inputSize:a})}}),u=new TransformStream({transform(t,e){t&&t.length&&(n+=t.length,e.enqueue(t))},flush(){const{signature:t}=o;Object.assign(i,{signature:t,outputSize:n,inputSize:a})}});Object.defineProperty(i,"readable",{get:()=>h.pipeThrough(l).pipeThrough(o).pipeThrough(u)})}}class Ef extends TransformStream{constructor(t){let e;super({transform:function i(s,r){if(e){const t=new Uint8Array(e.length+s.length);t.set(e),t.set(s,e.length),s=t,e=null}s.length>t?(r.enqueue(s.slice(0,t)),i(s.slice(t),r)):e=s},flush(t){e&&e.length&&t.enqueue(e)}})}}let Sf=typeof Worker!=tm;class Cf{constructor(t,{readable:e,writable:i},{options:s,config:r,streamOptions:n,useWebWorkers:a,transferStreams:o,scripts:h},l){const{signal:u}=n;return Object.assign(t,{busy:!0,readable:e.pipeThrough(new Ef(r.chunkSize)).pipeThrough(new Af(e,n),{signal:u}),writable:i,options:Object.assign({},s),scripts:h,transferStreams:o,terminate:()=>new Promise((e=>{const{worker:i,busy:s}=t;i?(s?t.resolveTerminated=e:(i.terminate(),e()),t.interface=null):e()})),onTaskFinished(){const{resolveTerminated:e}=t;e&&(t.resolveTerminated=null,t.terminated=!0,t.worker.terminate(),e()),t.busy=!1,l(t)}}),(a&&Sf?Ff:Rf)(t,r)}}class Af extends TransformStream{constructor(t,{onstart:e,onprogress:i,size:s,onend:r}){let n=0;super({async start(){e&&await Mf(e,s)},async transform(t,e){n+=t.length,i&&await Mf(i,n,s),e.enqueue(t)},async flush(){t.size=n,r&&await Mf(r,n)}})}}async function Mf(t,...e){try{await t(...e)}catch(t){}}function Rf(t,e){return{run:()=>async function({options:t,readable:e,writable:i,onTaskFinished:s},r){try{const s=new yf(t,r);await e.pipeThrough(s).pipeTo(i,{preventClose:!0,preventAbort:!0});const{signature:n,inputSize:a,outputSize:o}=s;return{signature:n,inputSize:a,outputSize:o}}finally{s()}}(t,e)}}function Ff(t,e){const{baseURL:i,chunkSize:s}=e;if(!t.interface){let r;try{r=function(t,e,i){const s={type:"module"};let r,n;typeof t==em&&(t=t());try{r=new URL(t,e)}catch(e){r=t}if(If)try{n=new Worker(r)}catch(t){If=!1,n=new Worker(r,s)}else n=new Worker(r,s);return n.addEventListener(_f,(t=>async function({data:t},e){const{type:i,value:s,messageId:r,result:n,error:a}=t,{reader:o,writer:h,resolveResult:l,rejectResult:u,onTaskFinished:c}=e;try{if(a){const{message:t,stack:e,code:i,name:s}=a,r=new Error(t);Object.assign(r,{stack:e,code:i,name:s}),d(r)}else{if(i==xf){const{value:t,done:i}=await o.read();$f({type:bf,value:t,done:i,messageId:r},e)}i==bf&&(await h.ready,await h.write(new Uint8Array(s)),$f({type:wf,messageId:r},e)),i==Tf&&d(null,n)}}catch(a){$f({type:Tf,messageId:r},e),d(a)}function d(t,e){t?u(t):l(e),h&&h.releaseLock(),c()}}(t,i))),n}(t.scripts[0],i,t)}catch(i){return Sf=!1,Rf(t,e)}Object.assign(t,{worker:r,interface:{run:()=>async function(t,e){let i,s;const r=new Promise(((t,e)=>{i=t,s=e}));Object.assign(t,{reader:null,writer:null,resolveResult:i,rejectResult:s,result:r});const{readable:n,options:a,scripts:o}=t,{writable:h,closed:l}=function(t){let e;const i=new Promise((t=>e=t)),s=new WritableStream({async write(e){const i=t.getWriter();await i.ready,await i.write(e),i.releaseLock()},close(){e()},abort:e=>t.getWriter().abort(e)});return{writable:s,closed:i}}(t.writable),u=$f({type:gf,scripts:o.slice(1),options:a,config:e,readable:n,writable:h},t);u||Object.assign(t,{reader:n.getReader(),writer:h.getWriter()});const c=await r;try{await h.getWriter().close()}catch(t){}return await l,c}(t,{chunkSize:s})}})}return t.interface}let If=!0,Df=!0;function $f(t,{worker:e,writer:i,onTaskFinished:s,transferStreams:r}){try{let{value:i,readable:s,writable:n}=t;const a=[];if(i&&(i.byteLength<i.buffer.byteLength?t.value=i.buffer.slice(0,i.byteLength):t.value=i.buffer,a.push(t.value)),r&&Df?(s&&a.push(s),n&&a.push(n)):t.readable=t.writable=null,a.length)try{return e.postMessage(t,a),!0}catch(i){Df=!1,t.readable=t.writable=null,e.postMessage(t)}else e.postMessage(t)}catch(t){throw i&&i.releaseLock(),s(),t}}let Lf=[];const Pf=[];let Nf=0;async function Bf(t,e){const{options:i,config:s}=e,{transferStreams:r,useWebWorkers:n,useCompressionStream:a,codecType:o,compressed:h,signed:l,encrypted:u}=i,{workerScripts:c,maxWorkers:d}=s;e.transferStreams=r||r===Jp;const p=!(h||l||u||e.transferStreams);return e.useWebWorkers=!p&&(n||n===Jp&&s.useWebWorkers),e.scripts=e.useWebWorkers&&c?c[o]:[],i.useCompressionStream=a||a===Jp&&s.useCompressionStream,(await async function(){const i=Lf.find((t=>!t.busy));if(i)return Of(i),new Cf(i,t,e,m);if(Lf.length<d){const i={indexWorker:Nf};return Nf++,Lf.push(i),new Cf(i,t,e,m)}return new Promise((i=>Pf.push({resolve:i,stream:t,workerOptions:e})))}()).run();function m(t){if(Pf.length){const[{resolve:e,stream:i,workerOptions:s}]=Pf.splice(0,1);e(new Cf(t,i,s,m))}else t.worker?(Of(t),function(t,e){const{config:i}=e,{terminateWorkerTimeout:s}=i;Number.isFinite(s)&&s>=0&&(t.terminated?t.terminated=!1:t.terminateTimeout=setTimeout((async()=>{Lf=Lf.filter((e=>e!=t));try{await t.terminate()}catch(t){}}),s))}(t,e)):Lf=Lf.filter((e=>e!=t))}}function Of(t){const{terminateTimeout:e}=t;e&&(clearTimeout(e),t.terminateTimeout=null)}const Uf=65536,kf="writable";class zf{constructor(){this.size=0}init(){this.initialized=!0}}class Vf extends zf{get readable(){const t=this,{chunkSize:e=Uf}=t,i=new ReadableStream({start(){this.chunkOffset=0},async pull(s){const{offset:r=0,size:n,diskNumberStart:a}=i,{chunkOffset:o}=this;s.enqueue(await Yf(t,r+o,Math.min(e,n-o),a)),o+e>n?s.close():this.chunkOffset+=e}});return i}}class Gf extends Vf{constructor(t){super(),Object.assign(this,{blob:t,size:t.size})}async readUint8Array(t,e){const i=this,s=t+e,r=t||s<i.size?i.blob.slice(t,s):i.blob;let n=await r.arrayBuffer();return n.byteLength>e&&(n=n.slice(t,s)),new Uint8Array(n)}}class Xf extends zf{constructor(t){super();const e=new TransformStream,i=[];t&&i.push(["Content-Type",t]),Object.defineProperty(this,kf,{get:()=>e.writable}),this.blob=new Response(e.readable,{headers:i}).blob()}getData(){return this.blob}}class Wf extends Vf{constructor(t){super(),this.readers=t}async init(){const t=this,{readers:e}=t;t.lastDiskNumber=0,t.lastDiskOffset=0,await Promise.all(e.map((async(i,s)=>{await i.init(),s!=e.length-1&&(t.lastDiskOffset+=i.size),t.size+=i.size}))),super.init()}async readUint8Array(t,e,i=0){const s=this,{readers:r}=this;let n,a=i;-1==a&&(a=r.length-1);let o=t;for(;o>=r[a].size;)o-=r[a].size,a++;const h=r[a],l=h.size;if(o+e<=l)n=await Yf(h,o,e);else{const r=l-o;n=new Uint8Array(e),n.set(await Yf(h,o,r)),n.set(await s.readUint8Array(t+r,e-r,i),r)}return s.lastDiskNumber=Math.max(a,s.lastDiskNumber),n}}class Hf extends zf{constructor(t,e=4294967295){super();const i=this;let s,r,n;Object.assign(i,{diskNumber:0,diskOffset:0,size:0,maxSize:e,availableSize:e});const a=new WritableStream({async write(e){const{availableSize:a}=i;if(n)e.length>=a?(await o(e.slice(0,a)),await h(),i.diskOffset+=s.size,i.diskNumber++,n=null,await this.write(e.slice(a))):await o(e);else{const{value:a,done:o}=await t.next();if(o&&!a)throw new Error("Writer iterator completed too soon");s=a,s.size=0,s.maxSize&&(i.maxSize=s.maxSize),i.availableSize=i.maxSize,await jf(s),r=a.writable,n=r.getWriter(),await this.write(e)}},async close(){await n.ready,await h()}});async function o(t){const e=t.length;e&&(await n.ready,await n.write(t),s.size+=e,i.size+=e,i.availableSize-=e)}async function h(){r.size=s.size,await n.close()}Object.defineProperty(i,kf,{get:()=>a})}}async function jf(t,e){if(!t.init||t.initialized)return Promise.resolve();await t.init(e)}function qf(t){return Array.isArray(t)&&(t=new Wf(t)),t instanceof ReadableStream&&(t={readable:t}),t}function Yf(t,e,i,s){return t.readUint8Array(e,i,s)}const Zf="\0 !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~ ".split(""),Kf=256==Zf.length;function Qf(t,e){return e&&"cp437"==e.trim().toLowerCase()?function(t){if(Kf){let e="";for(let i=0;i<t.length;i++)e+=Zf[t[i]];return e}return(new TextDecoder).decode(t)}(t):new TextDecoder(e).decode(t)}const Jf="filename",t_="rawFilename",e_="comment",i_="rawComment",s_="uncompressedSize",r_="compressedSize",n_="offset",a_="diskNumberStart",o_="lastModDate",h_="rawLastModDate",l_="lastAccessDate",u_="rawLastAccessDate",c_="creationDate",d_="rawCreationDate",p_=[Jf,t_,r_,s_,o_,h_,e_,i_,l_,c_,n_,a_,a_,"internalFileAttribute","externalFileAttribute","msDosCompatible","zip64","directory","bitFlag","encrypted","signature","filenameUTF8","commentUTF8","compressionMethod","version","versionMadeBy","extraField","rawExtraField","extraFieldZip64","extraFieldUnicodePath","extraFieldUnicodeComment","extraFieldAES","extraFieldNTFS","extraFieldExtendedTimestamp"];class m_{constructor(t){p_.forEach((e=>this[e]=t[e]))}}const f_="File format is not recognized",__="Zip64 extra field not found",g_="Compression method not supported",x_="Split zip file",b_="utf-8",w_="cp437",T_=[[s_,jp],[r_,jp],[n_,jp],[a_,qp]],v_={[qp]:{getValue:$_,bytes:4},[jp]:{getValue:L_,bytes:8}};class y_{constructor(t,e={}){Object.assign(this,{reader:qf(t),options:e,config:nm})}async*getEntriesGenerator(t={}){const e=this;let{reader:i}=e;const{config:s}=e;if(await jf(i),i.size!==Jp&&i.readUint8Array||(i=new Gf(await new Response(i.readable).blob()),await jf(i)),i.size<Kp)throw new Error(f_);i.chunkSize=function(t){return Math.max(t.chunkSize,64)}(s);const r=await async function(t,e,i,s,r){const n=new Uint8Array(4);!function(t,e,i){t.setUint32(e,i,!0)}(P_(n),0,e);const a=s+r;return await o(s)||await o(Math.min(a,i));async function o(e){const r=i-e,a=await Yf(t,r,e);for(let t=a.length-s;t>=0;t--)if(a[t]==n[0]&&a[t+1]==n[1]&&a[t+2]==n[2]&&a[t+3]==n[3])return{offset:r+t,buffer:a.slice(t,t+s).buffer}}}(i,101010256,i.size,Kp,1048560);if(!r){throw 134695760==$_(P_(await Yf(i,0,4)))?new Error(x_):new Error("End of central directory not found")}const n=P_(r);let a=$_(n,12),o=$_(n,16);const h=r.offset,l=D_(n,20),u=h+Kp+l;let c=D_(n,4);const d=i.lastDiskNumber||0;let p=D_(n,6),m=D_(n,8),f=0,_=0;if(o==jp||a==jp||m==qp||p==qp){const t=P_(await Yf(i,r.offset-20,20));if(117853008!=$_(t,0))throw new Error("End of Zip64 central directory not found");o=L_(t,8);let e=await Yf(i,o,56,-1),s=P_(e);const n=r.offset-20-56;if($_(s,0)!=Zp&&o!=n){const t=o;o=n,f=o-t,e=await Yf(i,o,56,-1),s=P_(e)}if($_(s,0)!=Zp)throw new Error("End of Zip64 central directory locator not found");c==qp&&(c=$_(s,16)),p==qp&&(p=$_(s,20)),m==qp&&(m=L_(s,32)),a==jp&&(a=L_(s,40)),o-=a}if(o>=i.size&&(f=i.size-o-a-Kp,o=i.size-a-Kp),d!=c)throw new Error(x_);if(o<0)throw new Error(f_);let g=0,x=await Yf(i,o,a,p),b=P_(x);if(a){const t=r.offset-a;if($_(b,g)!=Yp&&o!=t){const e=o;o=t,f+=o-e,x=await Yf(i,o,a,p),b=P_(x)}}const w=r.offset-o-(i.lastDiskOffset||0);if(a!=w&&w>=0&&(a=w,x=await Yf(i,o,a,p),b=P_(x)),o<0||o>=i.size)throw new Error(f_);const T=M_(e,t,"filenameEncoding"),v=M_(e,t,"commentEncoding");for(let r=0;r<m;r++){const n=new E_(i,s,e.options);if($_(b,g)!=Yp)throw new Error("Central directory header not found");S_(n,b,g+6);const a=Boolean(n.bitFlag.languageEncodingFlag),o=g+46,h=o+n.filenameLength,l=h+n.extraFieldLength,u=D_(b,g+4),c=0==(0&u),d=x.subarray(o,h),p=D_(b,g+32),w=l+p,y=x.subarray(l,w),E=a,S=a,C=c&&16==(16&I_(b,g+38)),A=$_(b,g+42)+f;Object.assign(n,{versionMadeBy:u,msDosCompatible:c,compressedSize:0,uncompressedSize:0,commentLength:p,directory:C,offset:A,diskNumberStart:D_(b,g+34),internalFileAttribute:D_(b,g+36),externalFileAttribute:$_(b,g+38),rawFilename:d,filenameUTF8:E,commentUTF8:S,rawExtraField:x.subarray(h,l)});const[M,R]=await Promise.all([Qf(d,E?b_:T||w_),Qf(y,S?b_:v||w_)]);Object.assign(n,{rawComment:y,filename:M,comment:R,directory:C||M.endsWith("/")}),_=Math.max(A,_),await C_(n,n,b,g+6);const F=new m_(n);F.getData=(t,e)=>n.getData(t,F,e),g=w;const{onprogress:I}=t;if(I)try{await I(r+1,m,new m_(n))}catch(t){}yield F}const y=M_(e,t,"extractPrependedData"),E=M_(e,t,"extractAppendedData");return y&&(e.prependedData=_>0?await Yf(i,0,_):new Uint8Array),e.comment=l?await Yf(i,h+Kp,l):new Uint8Array,E&&(e.appendedData=u<i.size?await Yf(i,u,i.size-u):new Uint8Array),!0}async getEntries(t={}){const e=[];for await(const i of this.getEntriesGenerator(t))e.push(i);return e}async close(){}}class E_{constructor(t,e,i){Object.assign(this,{reader:t,config:e,options:i})}async getData(t,e,i={}){const s=this,{reader:r,offset:n,diskNumberStart:a,extraFieldAES:o,compressionMethod:h,config:l,bitFlag:u,signature:c,rawLastModDate:d,uncompressedSize:p,compressedSize:m}=s,f=e.localDirectory={},_=P_(await Yf(r,n,30,a));let g=M_(s,i,"password"),x=M_(s,i,"rawPassword");if(g=g&&g.length&&g,x=x&&x.length&&x,o&&99!=o.originalCompressionMethod)throw new Error(g_);if(0!=h&&8!=h)throw new Error(g_);if(67324752!=$_(_,0))throw new Error("Local file header not found");S_(f,_,4),f.rawExtraField=f.extraFieldLength?await Yf(r,n+30+f.filenameLength,f.extraFieldLength,a):new Uint8Array,await C_(s,f,_,4,!0),Object.assign(e,{lastAccessDate:f.lastAccessDate,creationDate:f.creationDate});const b=s.encrypted&&f.encrypted,w=b&&!o;if(b){if(!w&&o.strength===Jp)throw new Error("Encryption method not supported");if(!g&&!x)throw new Error("File contains encrypted entry")}const T=n+30+f.filenameLength+f.extraFieldLength,v=m,y=r.readable;Object.assign(y,{diskNumberStart:a,offset:T,size:v});const E=M_(s,i,"signal"),S=M_(s,i,"checkPasswordOnly");S&&(t=new WritableStream),t=function(t){t.writable===Jp&&typeof t.next==em&&(t=new Hf(t)),t instanceof WritableStream&&(t={writable:t});const{writable:e}=t;return e.size===Jp&&(e.size=0),t instanceof Hf||Object.assign(t,{diskNumber:0,diskOffset:0,availableSize:1/0,maxSize:1/0}),t}(t),await jf(t,p);const{writable:C}=t,{onstart:A,onprogress:M,onend:R}=i,F={options:{codecType:vf,password:g,rawPassword:x,zipCrypto:w,encryptionStrength:o&&o.strength,signed:M_(s,i,"checkSignature"),passwordVerification:w&&(u.dataDescriptor?d>>>8&255:c>>>24&255),signature:c,compressed:0!=h,encrypted:b,useWebWorkers:M_(s,i,"useWebWorkers"),useCompressionStream:M_(s,i,"useCompressionStream"),transferStreams:M_(s,i,"transferStreams"),checkPasswordOnly:S},config:l,streamOptions:{signal:E,size:v,onstart:A,onprogress:M,onend:R}};let I=0;try{({outputSize:I}=await Bf({readable:y,writable:C},F))}catch(t){if(!S||t.message!=vm)throw t}finally{const t=M_(s,i,"preventClose");C.size+=I,t||C.locked||await C.getWriter().close()}return S?Jp:t.getData?t.getData():C}}function S_(t,e,i){const s=t.rawBitFlag=D_(e,i+2),r=1==(1&s),n=$_(e,i+6);Object.assign(t,{encrypted:r,version:D_(e,i),bitFlag:{level:(6&s)>>1,dataDescriptor:8==(8&s),languageEncodingFlag:2048==(2048&s)},rawLastModDate:n,lastModDate:R_(n),filenameLength:D_(e,i+22),extraFieldLength:D_(e,i+24)})}async function C_(t,e,i,s,r){const{rawExtraField:n}=e,a=e.extraField=new Map,o=P_(new Uint8Array(n));let h=0;try{for(;h<n.length;){const t=D_(o,h),e=D_(o,h+2);a.set(t,{type:t,data:n.slice(h+4,h+4+e)}),h+=4+e}}catch(t){}const l=D_(i,s+4);Object.assign(e,{signature:$_(i,s+10),uncompressedSize:$_(i,s+18),compressedSize:$_(i,s+14)});const u=a.get(1);u&&(!function(t,e){e.zip64=!0;const i=P_(t.data),s=T_.filter((([t,i])=>e[t]==i));for(let r=0,n=0;r<s.length;r++){const[a,o]=s[r];if(e[a]==o){const s=v_[o];e[a]=t[a]=s.getValue(i,n),n+=s.bytes}else if(t[a])throw new Error(__)}}(u,e),e.extraFieldZip64=u);const c=a.get(28789);c&&(await A_(c,Jf,t_,e,t),e.extraFieldUnicodePath=c);const d=a.get(25461);d&&(await A_(d,e_,i_,e,t),e.extraFieldUnicodeComment=d);const p=a.get(39169);p?(!function(t,e,i){const s=P_(t.data),r=I_(s,4);Object.assign(t,{vendorVersion:I_(s,0),vendorId:I_(s,2),strength:r,originalCompressionMethod:i,compressionMethod:D_(s,5)}),e.compressionMethod=t.compressionMethod}(p,e,l),e.extraFieldAES=p):e.compressionMethod=l;const m=a.get(10);m&&(!function(t,e){const i=P_(t.data);let s,r=4;try{for(;r<t.data.length&&!s;){const e=D_(i,r),n=D_(i,r+2);e==Qp&&(s=t.data.slice(r+4,r+4+n)),r+=4+n}}catch(t){}try{if(s&&24==s.length){const i=P_(s),r=i.getBigUint64(0,!0),n=i.getBigUint64(8,!0),a=i.getBigUint64(16,!0);Object.assign(t,{rawLastModDate:r,rawLastAccessDate:n,rawCreationDate:a});const o=F_(r),h=F_(n),l={lastModDate:o,lastAccessDate:h,creationDate:F_(a)};Object.assign(t,l),Object.assign(e,l)}}catch(t){}}(m,e),e.extraFieldNTFS=m);const f=a.get(21589);f&&(!function(t,e,i){const s=P_(t.data),r=I_(s,0),n=[],a=[];i?(1==(1&r)&&(n.push(o_),a.push(h_)),2==(2&r)&&(n.push(l_),a.push(u_)),4==(4&r)&&(n.push(c_),a.push(d_))):t.data.length>=5&&(n.push(o_),a.push(h_));let o=1;n.forEach(((i,r)=>{if(t.data.length>=o+4){const n=$_(s,o);e[i]=t[i]=new Date(1e3*n);const h=a[r];t[h]=n}o+=4}))}(f,e,r),e.extraFieldExtendedTimestamp=f);const _=a.get(6534);_&&(e.extraFieldUSDZ=_)}async function A_(t,e,i,s,r){const n=P_(t.data),a=new um;a.append(r[i]);const o=P_(new Uint8Array(4));o.setUint32(0,a.get(),!0);const h=$_(n,1);Object.assign(t,{version:I_(n,0),[e]:Qf(t.data.subarray(5)),valid:!r.bitFlag.languageEncodingFlag&&h==$_(o,0)}),t.valid&&(s[e]=t[e],s[e+"UTF8"]=!0)}function M_(t,e,i){return e[i]===Jp?t.options[i]:e[i]}function R_(t){const e=(4294901760&t)>>16,i=65535&t;try{return new Date(1980+((65024&e)>>9),((480&e)>>5)-1,31&e,(63488&i)>>11,(2016&i)>>5,2*(31&i),0)}catch(t){}}function F_(t){return new Date(Number(t/BigInt(1e4)-BigInt(116444736e5)))}function I_(t,e){return t.getUint8(e)}function D_(t,e){return t.getUint16(e,!0)}function $_(t,e){return t.getUint32(e,!0)}function L_(t,e){return Number(t.getBigUint64(e,!0))}function P_(t){return new DataView(t.buffer)}let N_;try{N_=import.meta.url}catch(t){}am({baseURL:N_}),function(t){const e=()=>URL.createObjectURL(new Blob(['const{Array:e,Object:t,Number:n,Math:r,Error:s,Uint8Array:i,Uint16Array:o,Uint32Array:c,Int32Array:f,Map:a,DataView:l,Promise:u,TextEncoder:w,crypto:h,postMessage:d,TransformStream:p,ReadableStream:y,WritableStream:m,CompressionStream:b,DecompressionStream:g}=self,k=void 0,v="undefined",S="function";class z{constructor(e){return class extends p{constructor(t,n){const r=new e(n);super({transform(e,t){t.enqueue(r.append(e))},flush(e){const t=r.flush();t&&e.enqueue(t)}})}}}}const C=[];for(let e=0;256>e;e++){let t=e;for(let e=0;8>e;e++)1&t?t=t>>>1^3988292384:t>>>=1;C[e]=t}class x{constructor(e){this.t=e||-1}append(e){let t=0|this.t;for(let n=0,r=0|e.length;r>n;n++)t=t>>>8^C[255&(t^e[n])];this.t=t}get(){return~this.t}}class A extends p{constructor(){let e;const t=new x;super({transform(e,n){t.append(e),n.enqueue(e)},flush(){const n=new i(4);new l(n.buffer).setUint32(0,t.get()),e.value=n}}),e=this}}const _={concat(e,t){if(0===e.length||0===t.length)return e.concat(t);const n=e[e.length-1],r=_.i(n);return 32===r?e.concat(t):_.o(t,r,0|n,e.slice(0,e.length-1))},l(e){const t=e.length;if(0===t)return 0;const n=e[t-1];return 32*(t-1)+_.i(n)},u(e,t){if(32*e.length<t)return e;const n=(e=e.slice(0,r.ceil(t/32))).length;return t&=31,n>0&&t&&(e[n-1]=_.h(t,e[n-1]&2147483648>>t-1,1)),e},h:(e,t,n)=>32===e?t:(n?0|t:t<<32-e)+1099511627776*e,i:e=>r.round(e/1099511627776)||32,o(e,t,n,r){for(void 0===r&&(r=[]);t>=32;t-=32)r.push(n),n=0;if(0===t)return r.concat(e);for(let s=0;s<e.length;s++)r.push(n|e[s]>>>t),n=e[s]<<32-t;const s=e.length?e[e.length-1]:0,i=_.i(s);return r.push(_.h(t+i&31,t+i>32?n:r.pop(),1)),r}},I={p:{m(e){const t=_.l(e)/8,n=new i(t);let r;for(let s=0;t>s;s++)0==(3&s)&&(r=e[s/4]),n[s]=r>>>24,r<<=8;return n},g(e){const t=[];let n,r=0;for(n=0;n<e.length;n++)r=r<<8|e[n],3==(3&n)&&(t.push(r),r=0);return 3&n&&t.push(_.h(8*(3&n),r)),t}}},P=class{constructor(e){const t=this;t.blockSize=512,t.k=[1732584193,4023233417,2562383102,271733878,3285377520],t.v=[1518500249,1859775393,2400959708,3395469782],e?(t.S=e.S.slice(0),t.C=e.C.slice(0),t.A=e.A):t.reset()}reset(){const e=this;return e.S=e.k.slice(0),e.C=[],e.A=0,e}update(e){const t=this;"string"==typeof e&&(e=I._.g(e));const n=t.C=_.concat(t.C,e),r=t.A,i=t.A=r+_.l(e);if(i>9007199254740991)throw new s("Cannot hash more than 2^53 - 1 bits");const o=new c(n);let f=0;for(let e=t.blockSize+r-(t.blockSize+r&t.blockSize-1);i>=e;e+=t.blockSize)t.I(o.subarray(16*f,16*(f+1))),f+=1;return n.splice(0,16*f),t}P(){const e=this;let t=e.C;const n=e.S;t=_.concat(t,[_.h(1,1)]);for(let e=t.length+2;15&e;e++)t.push(0);for(t.push(r.floor(e.A/4294967296)),t.push(0|e.A);t.length;)e.I(t.splice(0,16));return e.reset(),n}D(e,t,n,r){return e>19?e>39?e>59?e>79?void 0:t^n^r:t&n|t&r|n&r:t^n^r:t&n|~t&r}V(e,t){return t<<e|t>>>32-e}I(t){const n=this,s=n.S,i=e(80);for(let e=0;16>e;e++)i[e]=t[e];let o=s[0],c=s[1],f=s[2],a=s[3],l=s[4];for(let e=0;79>=e;e++){16>e||(i[e]=n.V(1,i[e-3]^i[e-8]^i[e-14]^i[e-16]));const t=n.V(5,o)+n.D(e,c,f,a)+l+i[e]+n.v[r.floor(e/20)]|0;l=a,a=f,f=n.V(30,c),c=o,o=t}s[0]=s[0]+o|0,s[1]=s[1]+c|0,s[2]=s[2]+f|0,s[3]=s[3]+a|0,s[4]=s[4]+l|0}},D={getRandomValues(e){const t=new c(e.buffer),n=e=>{let t=987654321;const n=4294967295;return()=>(t=36969*(65535&t)+(t>>16)&n,(((t<<16)+(e=18e3*(65535&e)+(e>>16)&n)&n)/4294967296+.5)*(r.random()>.5?1:-1))};for(let s,i=0;i<e.length;i+=4){const e=n(4294967296*(s||r.random()));s=987654071*e(),t[i/4]=4294967296*e()|0}return e}},V={importKey:e=>new V.R(I.p.g(e)),B(e,t,n,r){if(n=n||1e4,0>r||0>n)throw new s("invalid params to pbkdf2");const i=1+(r>>5)<<2;let o,c,f,a,u;const w=new ArrayBuffer(i),h=new l(w);let d=0;const p=_;for(t=I.p.g(t),u=1;(i||1)>d;u++){for(o=c=e.encrypt(p.concat(t,[u])),f=1;n>f;f++)for(c=e.encrypt(c),a=0;a<c.length;a++)o[a]^=c[a];for(f=0;(i||1)>d&&f<o.length;f++)h.setInt32(d,o[f]),d+=4}return w.slice(0,r/8)},R:class{constructor(e){const t=this,n=t.M=P,r=[[],[]];t.U=[new n,new n];const s=t.U[0].blockSize/32;e.length>s&&(e=(new n).update(e).P());for(let t=0;s>t;t++)r[0][t]=909522486^e[t],r[1][t]=1549556828^e[t];t.U[0].update(r[0]),t.U[1].update(r[1]),t.K=new n(t.U[0])}reset(){const e=this;e.K=new e.M(e.U[0]),e.N=!1}update(e){this.N=!0,this.K.update(e)}digest(){const e=this,t=e.K.P(),n=new e.M(e.U[1]).update(t).P();return e.reset(),n}encrypt(e){if(this.N)throw new s("encrypt on already updated hmac called!");return this.update(e),this.digest(e)}}},R=typeof h!=v&&typeof h.getRandomValues==S,B="Invalid password",E="Invalid signature",M="zipjs-abort-check-password";function U(e){return R?h.getRandomValues(e):D.getRandomValues(e)}const K=16,N={name:"PBKDF2"},O=t.assign({hash:{name:"HMAC"}},N),T=t.assign({iterations:1e3,hash:{name:"SHA-1"}},N),W=["deriveBits"],j=[8,12,16],H=[16,24,32],L=10,F=[0,0,0,0],q=typeof h!=v,G=q&&h.subtle,J=q&&typeof G!=v,Q=I.p,X=class{constructor(e){const t=this;t.O=[[[],[],[],[],[]],[[],[],[],[],[]]],t.O[0][0][0]||t.T();const n=t.O[0][4],r=t.O[1],i=e.length;let o,c,f,a=1;if(4!==i&&6!==i&&8!==i)throw new s("invalid aes key size");for(t.v=[c=e.slice(0),f=[]],o=i;4*i+28>o;o++){let e=c[o-1];(o%i==0||8===i&&o%i==4)&&(e=n[e>>>24]<<24^n[e>>16&255]<<16^n[e>>8&255]<<8^n[255&e],o%i==0&&(e=e<<8^e>>>24^a<<24,a=a<<1^283*(a>>7))),c[o]=c[o-i]^e}for(let e=0;o;e++,o--){const t=c[3&e?o:o-4];f[e]=4>=o||4>e?t:r[0][n[t>>>24]]^r[1][n[t>>16&255]]^r[2][n[t>>8&255]]^r[3][n[255&t]]}}encrypt(e){return this.W(e,0)}decrypt(e){return this.W(e,1)}T(){const e=this.O[0],t=this.O[1],n=e[4],r=t[4],s=[],i=[];let o,c,f,a;for(let e=0;256>e;e++)i[(s[e]=e<<1^283*(e>>7))^e]=e;for(let l=o=0;!n[l];l^=c||1,o=i[o]||1){let i=o^o<<1^o<<2^o<<3^o<<4;i=i>>8^255&i^99,n[l]=i,r[i]=l,a=s[f=s[c=s[l]]];let u=16843009*a^65537*f^257*c^16843008*l,w=257*s[i]^16843008*i;for(let n=0;4>n;n++)e[n][l]=w=w<<24^w>>>8,t[n][i]=u=u<<24^u>>>8}for(let n=0;5>n;n++)e[n]=e[n].slice(0),t[n]=t[n].slice(0)}W(e,t){if(4!==e.length)throw new s("invalid aes block size");const n=this.v[t],r=n.length/4-2,i=[0,0,0,0],o=this.O[t],c=o[0],f=o[1],a=o[2],l=o[3],u=o[4];let w,h,d,p=e[0]^n[0],y=e[t?3:1]^n[1],m=e[2]^n[2],b=e[t?1:3]^n[3],g=4;for(let e=0;r>e;e++)w=c[p>>>24]^f[y>>16&255]^a[m>>8&255]^l[255&b]^n[g],h=c[y>>>24]^f[m>>16&255]^a[b>>8&255]^l[255&p]^n[g+1],d=c[m>>>24]^f[b>>16&255]^a[p>>8&255]^l[255&y]^n[g+2],b=c[b>>>24]^f[p>>16&255]^a[y>>8&255]^l[255&m]^n[g+3],g+=4,p=w,y=h,m=d;for(let e=0;4>e;e++)i[t?3&-e:e]=u[p>>>24]<<24^u[y>>16&255]<<16^u[m>>8&255]<<8^u[255&b]^n[g++],w=p,p=y,y=m,m=b,b=w;return i}},Y=class{constructor(e,t){this.j=e,this.H=t,this.L=t}reset(){this.L=this.H}update(e){return this.F(this.j,e,this.L)}q(e){if(255==(e>>24&255)){let t=e>>16&255,n=e>>8&255,r=255&e;255===t?(t=0,255===n?(n=0,255===r?r=0:++r):++n):++t,e=0,e+=t<<16,e+=n<<8,e+=r}else e+=1<<24;return e}G(e){0===(e[0]=this.q(e[0]))&&(e[1]=this.q(e[1]))}F(e,t,n){let r;if(!(r=t.length))return[];const s=_.l(t);for(let s=0;r>s;s+=4){this.G(n);const r=e.encrypt(n);t[s]^=r[0],t[s+1]^=r[1],t[s+2]^=r[2],t[s+3]^=r[3]}return _.u(t,s)}},Z=V.R;let $=q&&J&&typeof G.importKey==S,ee=q&&J&&typeof G.deriveBits==S;class te extends p{constructor({password:e,rawPassword:n,signed:r,encryptionStrength:o,checkPasswordOnly:c}){super({start(){t.assign(this,{ready:new u((e=>this.J=e)),password:ie(e,n),signed:r,X:o-1,pending:new i})},async transform(e,t){const n=this,{password:r,X:o,J:f,ready:a}=n;r?(await(async(e,t,n,r)=>{const i=await se(e,t,n,ce(r,0,j[t])),o=ce(r,j[t]);if(i[0]!=o[0]||i[1]!=o[1])throw new s(B)})(n,o,r,ce(e,0,j[o]+2)),e=ce(e,j[o]+2),c?t.error(new s(M)):f()):await a;const l=new i(e.length-L-(e.length-L)%K);t.enqueue(re(n,e,l,0,L,!0))},async flush(e){const{signed:t,Y:n,Z:r,pending:o,ready:c}=this;if(r&&n){await c;const f=ce(o,0,o.length-L),a=ce(o,o.length-L);let l=new i;if(f.length){const e=ae(Q,f);r.update(e);const t=n.update(e);l=fe(Q,t)}if(t){const e=ce(fe(Q,r.digest()),0,L);for(let t=0;L>t;t++)if(e[t]!=a[t])throw new s(E)}e.enqueue(l)}}})}}class ne extends p{constructor({password:e,rawPassword:n,encryptionStrength:r}){let s;super({start(){t.assign(this,{ready:new u((e=>this.J=e)),password:ie(e,n),X:r-1,pending:new i})},async transform(e,t){const n=this,{password:r,X:s,J:o,ready:c}=n;let f=new i;r?(f=await(async(e,t,n)=>{const r=U(new i(j[t]));return oe(r,await se(e,t,n,r))})(n,s,r),o()):await c;const a=new i(f.length+e.length-e.length%K);a.set(f,0),t.enqueue(re(n,e,a,f.length,0))},async flush(e){const{Y:t,Z:n,pending:r,ready:o}=this;if(n&&t){await o;let c=new i;if(r.length){const e=t.update(ae(Q,r));n.update(e),c=fe(Q,e)}s.signature=fe(Q,n.digest()).slice(0,L),e.enqueue(oe(c,s.signature))}}}),s=this}}function re(e,t,n,r,s,o){const{Y:c,Z:f,pending:a}=e,l=t.length-s;let u;for(a.length&&(t=oe(a,t),n=((e,t)=>{if(t&&t>e.length){const n=e;(e=new i(t)).set(n,0)}return e})(n,l-l%K)),u=0;l-K>=u;u+=K){const e=ae(Q,ce(t,u,u+K));o&&f.update(e);const s=c.update(e);o||f.update(s),n.set(fe(Q,s),u+r)}return e.pending=ce(t,u),n}async function se(n,r,s,o){n.password=null;const c=await(async(e,t,n,r,s)=>{if(!$)return V.importKey(t);try{return await G.importKey("raw",t,n,!1,s)}catch(e){return $=!1,V.importKey(t)}})(0,s,O,0,W),f=await(async(e,t,n)=>{if(!ee)return V.B(t,e.salt,T.iterations,n);try{return await G.deriveBits(e,t,n)}catch(r){return ee=!1,V.B(t,e.salt,T.iterations,n)}})(t.assign({salt:o},T),c,8*(2*H[r]+2)),a=new i(f),l=ae(Q,ce(a,0,H[r])),u=ae(Q,ce(a,H[r],2*H[r])),w=ce(a,2*H[r]);return t.assign(n,{keys:{key:l,$:u,passwordVerification:w},Y:new Y(new X(l),e.from(F)),Z:new Z(u)}),w}function ie(e,t){return t===k?(e=>{if(typeof w==v){const t=new i((e=unescape(encodeURIComponent(e))).length);for(let n=0;n<t.length;n++)t[n]=e.charCodeAt(n);return t}return(new w).encode(e)})(e):t}function oe(e,t){let n=e;return e.length+t.length&&(n=new i(e.length+t.length),n.set(e,0),n.set(t,e.length)),n}function ce(e,t,n){return e.subarray(t,n)}function fe(e,t){return e.m(t)}function ae(e,t){return e.g(t)}class le extends p{constructor({password:e,passwordVerification:n,checkPasswordOnly:r}){super({start(){t.assign(this,{password:e,passwordVerification:n}),de(this,e)},transform(e,t){const n=this;if(n.password){const t=we(n,e.subarray(0,12));if(n.password=null,t[11]!=n.passwordVerification)throw new s(B);e=e.subarray(12)}r?t.error(new s(M)):t.enqueue(we(n,e))}})}}class ue extends p{constructor({password:e,passwordVerification:n}){super({start(){t.assign(this,{password:e,passwordVerification:n}),de(this,e)},transform(e,t){const n=this;let r,s;if(n.password){n.password=null;const t=U(new i(12));t[11]=n.passwordVerification,r=new i(e.length+t.length),r.set(he(n,t),0),s=12}else r=new i(e.length),s=0;r.set(he(n,e),s),t.enqueue(r)}})}}function we(e,t){const n=new i(t.length);for(let r=0;r<t.length;r++)n[r]=ye(e)^t[r],pe(e,n[r]);return n}function he(e,t){const n=new i(t.length);for(let r=0;r<t.length;r++)n[r]=ye(e)^t[r],pe(e,t[r]);return n}function de(e,n){const r=[305419896,591751049,878082192];t.assign(e,{keys:r,ee:new x(r[0]),te:new x(r[2])});for(let t=0;t<n.length;t++)pe(e,n.charCodeAt(t))}function pe(e,t){let[n,s,i]=e.keys;e.ee.append([t]),n=~e.ee.get(),s=be(r.imul(be(s+me(n)),134775813)+1),e.te.append([s>>>24]),i=~e.te.get(),e.keys=[n,s,i]}function ye(e){const t=2|e.keys[2];return me(r.imul(t,1^t)>>>8)}function me(e){return 255&e}function be(e){return 4294967295&e}const ge="deflate-raw";class ke extends p{constructor(e,{chunkSize:t,CompressionStream:n,CompressionStreamNative:r}){super({});const{compressed:s,encrypted:i,useCompressionStream:o,zipCrypto:c,signed:f,level:a}=e,u=this;let w,h,d=Se(super.readable);i&&!c||!f||(w=new A,d=xe(d,w)),s&&(d=Ce(d,o,{level:a,chunkSize:t},r,n)),i&&(c?d=xe(d,new ue(e)):(h=new ne(e),d=xe(d,h))),ze(u,d,(()=>{let e;i&&!c&&(e=h.signature),i&&!c||!f||(e=new l(w.value.buffer).getUint32(0)),u.signature=e}))}}class ve extends p{constructor(e,{chunkSize:t,DecompressionStream:n,DecompressionStreamNative:r}){super({});const{zipCrypto:i,encrypted:o,signed:c,signature:f,compressed:a,useCompressionStream:u}=e;let w,h,d=Se(super.readable);o&&(i?d=xe(d,new le(e)):(h=new te(e),d=xe(d,h))),a&&(d=Ce(d,u,{chunkSize:t},r,n)),o&&!i||!c||(w=new A,d=xe(d,w)),ze(this,d,(()=>{if((!o||i)&&c){const e=new l(w.value.buffer);if(f!=e.getUint32(0,!1))throw new s(E)}}))}}function Se(e){return xe(e,new p({transform(e,t){e&&e.length&&t.enqueue(e)}}))}function ze(e,n,r){n=xe(n,new p({flush:r})),t.defineProperty(e,"readable",{get:()=>n})}function Ce(e,t,n,r,s){try{e=xe(e,new(t&&r?r:s)(ge,n))}catch(r){if(!t)return e;try{e=xe(e,new s(ge,n))}catch(t){return e}}return e}function xe(e,t){return e.pipeThrough(t)}const Ae="data",_e="close";class Ie extends p{constructor(e,n){super({});const r=this,{codecType:s}=e;let i;s.startsWith("deflate")?i=ke:s.startsWith("inflate")&&(i=ve);let o=0,c=0;const f=new i(e,n),a=super.readable,l=new p({transform(e,t){e&&e.length&&(c+=e.length,t.enqueue(e))},flush(){t.assign(r,{inputSize:c})}}),u=new p({transform(e,t){e&&e.length&&(o+=e.length,t.enqueue(e))},flush(){const{signature:e}=f;t.assign(r,{signature:e,outputSize:o,inputSize:c})}});t.defineProperty(r,"readable",{get:()=>a.pipeThrough(l).pipeThrough(f).pipeThrough(u)})}}class Pe extends p{constructor(e){let t;super({transform:function n(r,s){if(t){const e=new i(t.length+r.length);e.set(t),e.set(r,t.length),r=e,t=null}r.length>e?(s.enqueue(r.slice(0,e)),n(r.slice(e),s)):t=r},flush(e){t&&t.length&&e.enqueue(t)}})}}const De=new a,Ve=new a;let Re,Be=0,Ee=!0;async function Me(e){try{const{options:t,scripts:r,config:s}=e;if(r&&r.length)try{Ee?importScripts.apply(k,r):await Ue(r)}catch(e){Ee=!1,await Ue(r)}self.initCodec&&self.initCodec(),s.CompressionStreamNative=self.CompressionStream,s.DecompressionStreamNative=self.DecompressionStream,self.Deflate&&(s.CompressionStream=new z(self.Deflate)),self.Inflate&&(s.DecompressionStream=new z(self.Inflate));const i={highWaterMark:1},o=e.readable||new y({async pull(e){const t=new u((e=>De.set(Be,e)));Ke({type:"pull",messageId:Be}),Be=(Be+1)%n.MAX_SAFE_INTEGER;const{value:r,done:s}=await t;e.enqueue(r),s&&e.close()}},i),c=e.writable||new m({async write(e){let t;const r=new u((e=>t=e));Ve.set(Be,t),Ke({type:Ae,value:e,messageId:Be}),Be=(Be+1)%n.MAX_SAFE_INTEGER,await r}},i),f=new Ie(t,s);Re=new AbortController;const{signal:a}=Re;await o.pipeThrough(f).pipeThrough(new Pe(s.chunkSize)).pipeTo(c,{signal:a,preventClose:!0,preventAbort:!0});try{await c.getWriter().close()}catch(e){}const{signature:l,inputSize:w,outputSize:h}=f;Ke({type:_e,result:{signature:l,inputSize:w,outputSize:h}})}catch(e){Ne(e)}}async function Ue(e){for(const t of e)await import(t)}function Ke(e){let{value:t}=e;if(t)if(t.length)try{t=new i(t),e.value=t.buffer,d(e,[e.value])}catch(t){d(e)}else d(e);else d(e)}function Ne(e=new s("Unknown error")){const{message:t,stack:n,code:r,name:i}=e;d({error:{message:t,stack:n,code:r,name:i}})}addEventListener("message",(({data:e})=>{const{type:t,messageId:n,value:r,done:s}=e;try{if("start"==t&&Me(e),t==Ae){const e=De.get(n);De.delete(n),e({value:new i(r),done:s})}if("ack"==t){const e=Ve.get(n);Ve.delete(n),e()}t==_e&&Re.abort()}catch(e){Ne(e)}}));const Oe=-2;function Te(t){return We(t.map((([t,n])=>new e(t).fill(n,0,t))))}function We(t){return t.reduce(((t,n)=>t.concat(e.isArray(n)?We(n):n)),[])}const je=[0,1,2,3].concat(...Te([[2,4],[2,5],[4,6],[4,7],[8,8],[8,9],[16,10],[16,11],[32,12],[32,13],[64,14],[64,15],[2,0],[1,16],[1,17],[2,18],[2,19],[4,20],[4,21],[8,22],[8,23],[16,24],[16,25],[32,26],[32,27],[64,28],[64,29]]));function He(){const e=this;function t(e,t){let n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1}e.ne=n=>{const s=e.re,i=e.ie.se,o=e.ie.oe;let c,f,a,l=-1;for(n.ce=0,n.fe=573,c=0;o>c;c++)0!==s[2*c]?(n.ae[++n.ce]=l=c,n.le[c]=0):s[2*c+1]=0;for(;2>n.ce;)a=n.ae[++n.ce]=2>l?++l:0,s[2*a]=1,n.le[a]=0,n.ue--,i&&(n.we-=i[2*a+1]);for(e.he=l,c=r.floor(n.ce/2);c>=1;c--)n.de(s,c);a=o;do{c=n.ae[1],n.ae[1]=n.ae[n.ce--],n.de(s,1),f=n.ae[1],n.ae[--n.fe]=c,n.ae[--n.fe]=f,s[2*a]=s[2*c]+s[2*f],n.le[a]=r.max(n.le[c],n.le[f])+1,s[2*c+1]=s[2*f+1]=a,n.ae[1]=a++,n.de(s,1)}while(n.ce>=2);n.ae[--n.fe]=n.ae[1],(t=>{const n=e.re,r=e.ie.se,s=e.ie.pe,i=e.ie.ye,o=e.ie.me;let c,f,a,l,u,w,h=0;for(l=0;15>=l;l++)t.be[l]=0;for(n[2*t.ae[t.fe]+1]=0,c=t.fe+1;573>c;c++)f=t.ae[c],l=n[2*n[2*f+1]+1]+1,l>o&&(l=o,h++),n[2*f+1]=l,f>e.he||(t.be[l]++,u=0,i>f||(u=s[f-i]),w=n[2*f],t.ue+=w*(l+u),r&&(t.we+=w*(r[2*f+1]+u)));if(0!==h){do{for(l=o-1;0===t.be[l];)l--;t.be[l]--,t.be[l+1]+=2,t.be[o]--,h-=2}while(h>0);for(l=o;0!==l;l--)for(f=t.be[l];0!==f;)a=t.ae[--c],a>e.he||(n[2*a+1]!=l&&(t.ue+=(l-n[2*a+1])*n[2*a],n[2*a+1]=l),f--)}})(n),((e,n,r)=>{const s=[];let i,o,c,f=0;for(i=1;15>=i;i++)s[i]=f=f+r[i-1]<<1;for(o=0;n>=o;o++)c=e[2*o+1],0!==c&&(e[2*o]=t(s[c]++,c))})(s,e.he,n.be)}}function Le(e,t,n,r,s){const i=this;i.se=e,i.pe=t,i.ye=n,i.oe=r,i.me=s}He.ge=[0,1,2,3,4,5,6,7].concat(...Te([[2,8],[2,9],[2,10],[2,11],[4,12],[4,13],[4,14],[4,15],[8,16],[8,17],[8,18],[8,19],[16,20],[16,21],[16,22],[16,23],[32,24],[32,25],[32,26],[31,27],[1,28]])),He.ke=[0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,0],He.ve=[0,1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096,6144,8192,12288,16384,24576],He.Se=e=>256>e?je[e]:je[256+(e>>>7)],He.ze=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],He.Ce=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],He.xe=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],He.Ae=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];const Fe=Te([[144,8],[112,9],[24,7],[8,8]]);Le._e=We([12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,19,275,147,403,83,339,211,467,51,307,179,435,115,371,243,499,11,267,139,395,75,331,203,459,43,299,171,427,107,363,235,491,27,283,155,411,91,347,219,475,59,315,187,443,123,379,251,507,7,263,135,391,71,327,199,455,39,295,167,423,103,359,231,487,23,279,151,407,87,343,215,471,55,311,183,439,119,375,247,503,15,271,143,399,79,335,207,463,47,303,175,431,111,367,239,495,31,287,159,415,95,351,223,479,63,319,191,447,127,383,255,511,0,64,32,96,16,80,48,112,8,72,40,104,24,88,56,120,4,68,36,100,20,84,52,116,3,131,67,195,35,163,99,227].map(((e,t)=>[e,Fe[t]])));const qe=Te([[30,5]]);function Ge(e,t,n,r,s){const i=this;i.Ie=e,i.Pe=t,i.De=n,i.Ve=r,i.Re=s}Le.Be=We([0,16,8,24,4,20,12,28,2,18,10,26,6,22,14,30,1,17,9,25,5,21,13,29,3,19,11,27,7,23].map(((e,t)=>[e,qe[t]]))),Le.Ee=new Le(Le._e,He.ze,257,286,15),Le.Me=new Le(Le.Be,He.Ce,0,30,15),Le.Ue=new Le(null,He.xe,0,19,7);const Je=[new Ge(0,0,0,0,0),new Ge(4,4,8,4,1),new Ge(4,5,16,8,1),new Ge(4,6,32,32,1),new Ge(4,4,16,16,2),new Ge(8,16,32,32,2),new Ge(8,16,128,128,2),new Ge(8,32,128,256,2),new Ge(32,128,258,1024,2),new Ge(32,258,258,4096,2)],Qe=["need dictionary","stream end","","","stream error","data error","","buffer error","",""],Xe=113,Ye=666,Ze=262;function $e(e,t,n,r){const s=e[2*t],i=e[2*n];return i>s||s==i&&r[t]<=r[n]}function et(){const e=this;let t,n,s,c,f,a,l,u,w,h,d,p,y,m,b,g,k,v,S,z,C,x,A,_,I,P,D,V,R,B,E,M,U;const K=new He,N=new He,O=new He;let T,W,j,H,L,F;function q(){let t;for(t=0;286>t;t++)E[2*t]=0;for(t=0;30>t;t++)M[2*t]=0;for(t=0;19>t;t++)U[2*t]=0;E[512]=1,e.ue=e.we=0,W=j=0}function G(e,t){let n,r=-1,s=e[1],i=0,o=7,c=4;0===s&&(o=138,c=3),e[2*(t+1)+1]=65535;for(let f=0;t>=f;f++)n=s,s=e[2*(f+1)+1],++i<o&&n==s||(c>i?U[2*n]+=i:0!==n?(n!=r&&U[2*n]++,U[32]++):i>10?U[36]++:U[34]++,i=0,r=n,0===s?(o=138,c=3):n==s?(o=6,c=3):(o=7,c=4))}function J(t){e.Ke[e.pending++]=t}function Q(e){J(255&e),J(e>>>8&255)}function X(e,t){let n;const r=t;F>16-r?(n=e,L|=n<<F&65535,Q(L),L=n>>>16-F,F+=r-16):(L|=e<<F&65535,F+=r)}function Y(e,t){const n=2*e;X(65535&t[n],65535&t[n+1])}function Z(e,t){let n,r,s=-1,i=e[1],o=0,c=7,f=4;for(0===i&&(c=138,f=3),n=0;t>=n;n++)if(r=i,i=e[2*(n+1)+1],++o>=c||r!=i){if(f>o)do{Y(r,U)}while(0!=--o);else 0!==r?(r!=s&&(Y(r,U),o--),Y(16,U),X(o-3,2)):o>10?(Y(18,U),X(o-11,7)):(Y(17,U),X(o-3,3));o=0,s=r,0===i?(c=138,f=3):r==i?(c=6,f=3):(c=7,f=4)}}function $(){16==F?(Q(L),L=0,F=0):8>F||(J(255&L),L>>>=8,F-=8)}function ee(t,n){let s,i,o;if(e.Ne[W]=t,e.Oe[W]=255&n,W++,0===t?E[2*n]++:(j++,t--,E[2*(He.ge[n]+256+1)]++,M[2*He.Se(t)]++),0==(8191&W)&&D>2){for(s=8*W,i=C-k,o=0;30>o;o++)s+=M[2*o]*(5+He.Ce[o]);if(s>>>=3,j<r.floor(W/2)&&s<r.floor(i/2))return!0}return W==T-1}function te(t,n){let r,s,i,o,c=0;if(0!==W)do{r=e.Ne[c],s=e.Oe[c],c++,0===r?Y(s,t):(i=He.ge[s],Y(i+256+1,t),o=He.ze[i],0!==o&&(s-=He.ke[i],X(s,o)),r--,i=He.Se(r),Y(i,n),o=He.Ce[i],0!==o&&(r-=He.ve[i],X(r,o)))}while(W>c);Y(256,t),H=t[513]}function ne(){F>8?Q(L):F>0&&J(255&L),L=0,F=0}function re(t,n,r){X(0+(r?1:0),3),((t,n)=>{ne(),H=8,Q(n),Q(~n),e.Ke.set(u.subarray(t,t+n),e.pending),e.pending+=n})(t,n)}function se(n){((t,n,r)=>{let s,i,o=0;D>0?(K.ne(e),N.ne(e),o=(()=>{let t;for(G(E,K.he),G(M,N.he),O.ne(e),t=18;t>=3&&0===U[2*He.Ae[t]+1];t--);return e.ue+=14+3*(t+1),t})(),s=e.ue+3+7>>>3,i=e.we+3+7>>>3,i>s||(s=i)):s=i=n+5,n+4>s||-1==t?i==s?(X(2+(r?1:0),3),te(Le._e,Le.Be)):(X(4+(r?1:0),3),((e,t,n)=>{let r;for(X(e-257,5),X(t-1,5),X(n-4,4),r=0;n>r;r++)X(U[2*He.Ae[r]+1],3);Z(E,e-1),Z(M,t-1)})(K.he+1,N.he+1,o+1),te(E,M)):re(t,n,r),q(),r&&ne()})(0>k?-1:k,C-k,n),k=C,t.Te()}function ie(){let e,n,r,s;do{if(s=w-A-C,0===s&&0===C&&0===A)s=f;else if(-1==s)s--;else if(C>=f+f-Ze){u.set(u.subarray(f,f+f),0),x-=f,C-=f,k-=f,e=y,r=e;do{n=65535&d[--r],d[r]=f>n?0:n-f}while(0!=--e);e=f,r=e;do{n=65535&h[--r],h[r]=f>n?0:n-f}while(0!=--e);s+=f}if(0===t.We)return;e=t.je(u,C+A,s),A+=e,3>A||(p=255&u[C],p=(p<<g^255&u[C+1])&b)}while(Ze>A&&0!==t.We)}function oe(e){let t,n,r=I,s=C,i=_;const o=C>f-Ze?C-(f-Ze):0;let c=B;const a=l,w=C+258;let d=u[s+i-1],p=u[s+i];R>_||(r>>=2),c>A&&(c=A);do{if(t=e,u[t+i]==p&&u[t+i-1]==d&&u[t]==u[s]&&u[++t]==u[s+1]){s+=2,t++;do{}while(u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&w>s);if(n=258-(w-s),s=w-258,n>i){if(x=e,i=n,n>=c)break;d=u[s+i-1],p=u[s+i]}}}while((e=65535&h[e&a])>o&&0!=--r);return i>A?A:i}e.le=[],e.be=[],e.ae=[],E=[],M=[],U=[],e.de=(t,n)=>{const r=e.ae,s=r[n];let i=n<<1;for(;i<=e.ce&&(i<e.ce&&$e(t,r[i+1],r[i],e.le)&&i++,!$e(t,s,r[i],e.le));)r[n]=r[i],n=i,i<<=1;r[n]=s},e.He=(t,S,x,W,j,G)=>(W||(W=8),j||(j=8),G||(G=0),t.Le=null,-1==S&&(S=6),1>j||j>9||8!=W||9>x||x>15||0>S||S>9||0>G||G>2?Oe:(t.Fe=e,a=x,f=1<<a,l=f-1,m=j+7,y=1<<m,b=y-1,g=r.floor((m+3-1)/3),u=new i(2*f),h=[],d=[],T=1<<j+6,e.Ke=new i(4*T),s=4*T,e.Ne=new o(T),e.Oe=new i(T),D=S,V=G,(t=>(t.qe=t.Ge=0,t.Le=null,e.pending=0,e.Je=0,n=Xe,c=0,K.re=E,K.ie=Le.Ee,N.re=M,N.ie=Le.Me,O.re=U,O.ie=Le.Ue,L=0,F=0,H=8,q(),(()=>{w=2*f,d[y-1]=0;for(let e=0;y-1>e;e++)d[e]=0;P=Je[D].Pe,R=Je[D].Ie,B=Je[D].De,I=Je[D].Ve,C=0,k=0,A=0,v=_=2,z=0,p=0})(),0))(t))),e.Qe=()=>42!=n&&n!=Xe&&n!=Ye?Oe:(e.Oe=null,e.Ne=null,e.Ke=null,d=null,h=null,u=null,e.Fe=null,n==Xe?-3:0),e.Xe=(e,t,n)=>{let r=0;return-1==t&&(t=6),0>t||t>9||0>n||n>2?Oe:(Je[D].Re!=Je[t].Re&&0!==e.qe&&(r=e.Ye(1)),D!=t&&(D=t,P=Je[D].Pe,R=Je[D].Ie,B=Je[D].De,I=Je[D].Ve),V=n,r)},e.Ze=(e,t,r)=>{let s,i=r,o=0;if(!t||42!=n)return Oe;if(3>i)return 0;for(i>f-Ze&&(i=f-Ze,o=r-i),u.set(t.subarray(o,o+i),0),C=i,k=i,p=255&u[0],p=(p<<g^255&u[1])&b,s=0;i-3>=s;s++)p=(p<<g^255&u[s+2])&b,h[s&l]=d[p],d[p]=s;return 0},e.Ye=(r,i)=>{let o,w,m,I,R;if(i>4||0>i)return Oe;if(!r.$e||!r.et&&0!==r.We||n==Ye&&4!=i)return r.Le=Qe[4],Oe;if(0===r.tt)return r.Le=Qe[7],-5;var B;if(t=r,I=c,c=i,42==n&&(w=8+(a-8<<4)<<8,m=(D-1&255)>>1,m>3&&(m=3),w|=m<<6,0!==C&&(w|=32),w+=31-w%31,n=Xe,J((B=w)>>8&255),J(255&B)),0!==e.pending){if(t.Te(),0===t.tt)return c=-1,0}else if(0===t.We&&I>=i&&4!=i)return t.Le=Qe[7],-5;if(n==Ye&&0!==t.We)return r.Le=Qe[7],-5;if(0!==t.We||0!==A||0!=i&&n!=Ye){switch(R=-1,Je[D].Re){case 0:R=(e=>{let n,r=65535;for(r>s-5&&(r=s-5);;){if(1>=A){if(ie(),0===A&&0==e)return 0;if(0===A)break}if(C+=A,A=0,n=k+r,(0===C||C>=n)&&(A=C-n,C=n,se(!1),0===t.tt))return 0;if(C-k>=f-Ze&&(se(!1),0===t.tt))return 0}return se(4==e),0===t.tt?4==e?2:0:4==e?3:1})(i);break;case 1:R=(e=>{let n,r=0;for(;;){if(Ze>A){if(ie(),Ze>A&&0==e)return 0;if(0===A)break}if(3>A||(p=(p<<g^255&u[C+2])&b,r=65535&d[p],h[C&l]=d[p],d[p]=C),0===r||(C-r&65535)>f-Ze||2!=V&&(v=oe(r)),3>v)n=ee(0,255&u[C]),A--,C++;else if(n=ee(C-x,v-3),A-=v,v>P||3>A)C+=v,v=0,p=255&u[C],p=(p<<g^255&u[C+1])&b;else{v--;do{C++,p=(p<<g^255&u[C+2])&b,r=65535&d[p],h[C&l]=d[p],d[p]=C}while(0!=--v);C++}if(n&&(se(!1),0===t.tt))return 0}return se(4==e),0===t.tt?4==e?2:0:4==e?3:1})(i);break;case 2:R=(e=>{let n,r,s=0;for(;;){if(Ze>A){if(ie(),Ze>A&&0==e)return 0;if(0===A)break}if(3>A||(p=(p<<g^255&u[C+2])&b,s=65535&d[p],h[C&l]=d[p],d[p]=C),_=v,S=x,v=2,0!==s&&P>_&&f-Ze>=(C-s&65535)&&(2!=V&&(v=oe(s)),5>=v&&(1==V||3==v&&C-x>4096)&&(v=2)),3>_||v>_)if(0!==z){if(n=ee(0,255&u[C-1]),n&&se(!1),C++,A--,0===t.tt)return 0}else z=1,C++,A--;else{r=C+A-3,n=ee(C-1-S,_-3),A-=_-1,_-=2;do{++C>r||(p=(p<<g^255&u[C+2])&b,s=65535&d[p],h[C&l]=d[p],d[p]=C)}while(0!=--_);if(z=0,v=2,C++,n&&(se(!1),0===t.tt))return 0}}return 0!==z&&(n=ee(0,255&u[C-1]),z=0),se(4==e),0===t.tt?4==e?2:0:4==e?3:1})(i)}if(2!=R&&3!=R||(n=Ye),0==R||2==R)return 0===t.tt&&(c=-1),0;if(1==R){if(1==i)X(2,3),Y(256,Le._e),$(),9>1+H+10-F&&(X(2,3),Y(256,Le._e),$()),H=7;else if(re(0,0,!1),3==i)for(o=0;y>o;o++)d[o]=0;if(t.Te(),0===t.tt)return c=-1,0}}return 4!=i?0:1}}function tt(){const e=this;e.nt=0,e.rt=0,e.We=0,e.qe=0,e.tt=0,e.Ge=0}function nt(e){const t=new tt,n=(o=e&&e.chunkSize?e.chunkSize:65536)+5*(r.floor(o/16383)+1);var o;const c=new i(n);let f=e?e.level:-1;void 0===f&&(f=-1),t.He(f),t.$e=c,this.append=(e,r)=>{let o,f,a=0,l=0,u=0;const w=[];if(e.length){t.nt=0,t.et=e,t.We=e.length;do{if(t.rt=0,t.tt=n,o=t.Ye(0),0!=o)throw new s("deflating: "+t.Le);t.rt&&(t.rt==n?w.push(new i(c)):w.push(c.subarray(0,t.rt))),u+=t.rt,r&&t.nt>0&&t.nt!=a&&(r(t.nt),a=t.nt)}while(t.We>0||0===t.tt);return w.length>1?(f=new i(u),w.forEach((e=>{f.set(e,l),l+=e.length}))):f=w[0]?new i(w[0]):new i,f}},this.flush=()=>{let e,r,o=0,f=0;const a=[];do{if(t.rt=0,t.tt=n,e=t.Ye(4),1!=e&&0!=e)throw new s("deflating: "+t.Le);n-t.tt>0&&a.push(c.slice(0,t.rt)),f+=t.rt}while(t.We>0||0===t.tt);return t.Qe(),r=new i(f),a.forEach((e=>{r.set(e,o),o+=e.length})),r}}tt.prototype={He(e,t){const n=this;return n.Fe=new et,t||(t=15),n.Fe.He(n,e,t)},Ye(e){const t=this;return t.Fe?t.Fe.Ye(t,e):Oe},Qe(){const e=this;if(!e.Fe)return Oe;const t=e.Fe.Qe();return e.Fe=null,t},Xe(e,t){const n=this;return n.Fe?n.Fe.Xe(n,e,t):Oe},Ze(e,t){const n=this;return n.Fe?n.Fe.Ze(n,e,t):Oe},je(e,t,n){const r=this;let s=r.We;return s>n&&(s=n),0===s?0:(r.We-=s,e.set(r.et.subarray(r.nt,r.nt+s),t),r.nt+=s,r.qe+=s,s)},Te(){const e=this;let t=e.Fe.pending;t>e.tt&&(t=e.tt),0!==t&&(e.$e.set(e.Fe.Ke.subarray(e.Fe.Je,e.Fe.Je+t),e.rt),e.rt+=t,e.Fe.Je+=t,e.Ge+=t,e.tt-=t,e.Fe.pending-=t,0===e.Fe.pending&&(e.Fe.Je=0))}};const rt=-2,st=-3,it=-5,ot=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],ct=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],ft=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],at=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],lt=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],ut=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],wt=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];function ht(){let e,t,n,r,s,i;function o(e,t,o,c,f,a,l,u,w,h,d){let p,y,m,b,g,k,v,S,z,C,x,A,_,I,P;C=0,g=o;do{n[e[t+C]]++,C++,g--}while(0!==g);if(n[0]==o)return l[0]=-1,u[0]=0,0;for(S=u[0],k=1;15>=k&&0===n[k];k++);for(v=k,k>S&&(S=k),g=15;0!==g&&0===n[g];g--);for(m=g,S>g&&(S=g),u[0]=S,I=1<<k;g>k;k++,I<<=1)if(0>(I-=n[k]))return st;if(0>(I-=n[g]))return st;for(n[g]+=I,i[1]=k=0,C=1,_=2;0!=--g;)i[_]=k+=n[C],_++,C++;g=0,C=0;do{0!==(k=e[t+C])&&(d[i[k]++]=g),C++}while(++g<o);for(o=i[m],i[0]=g=0,C=0,b=-1,A=-S,s[0]=0,x=0,P=0;m>=v;v++)for(p=n[v];0!=p--;){for(;v>A+S;){if(b++,A+=S,P=m-A,P=P>S?S:P,(y=1<<(k=v-A))>p+1&&(y-=p+1,_=v,P>k))for(;++k<P&&(y<<=1)>n[++_];)y-=n[_];if(P=1<<k,h[0]+P>1440)return st;s[b]=x=h[0],h[0]+=P,0!==b?(i[b]=g,r[0]=k,r[1]=S,k=g>>>A-S,r[2]=x-s[b-1]-k,w.set(r,3*(s[b-1]+k))):l[0]=x}for(r[1]=v-A,o>C?d[C]<c?(r[0]=256>d[C]?0:96,r[2]=d[C++]):(r[0]=a[d[C]-c]+16+64,r[2]=f[d[C++]-c]):r[0]=192,y=1<<v-A,k=g>>>A;P>k;k+=y)w.set(r,3*(x+k));for(k=1<<v-1;0!=(g&k);k>>>=1)g^=k;for(g^=k,z=(1<<A)-1;(g&z)!=i[b];)b--,A-=S,z=(1<<A)-1}return 0!==I&&1!=m?it:0}function c(o){let c;for(e||(e=[],t=[],n=new f(16),r=[],s=new f(15),i=new f(16)),t.length<o&&(t=[]),c=0;o>c;c++)t[c]=0;for(c=0;16>c;c++)n[c]=0;for(c=0;3>c;c++)r[c]=0;s.set(n.subarray(0,15),0),i.set(n.subarray(0,16),0)}this.st=(n,r,s,i,f)=>{let a;return c(19),e[0]=0,a=o(n,0,19,19,null,null,s,r,i,e,t),a==st?f.Le="oversubscribed dynamic bit lengths tree":a!=it&&0!==r[0]||(f.Le="incomplete dynamic bit lengths tree",a=st),a},this.it=(n,r,s,i,f,a,l,u,w)=>{let h;return c(288),e[0]=0,h=o(s,0,n,257,at,lt,a,i,u,e,t),0!=h||0===i[0]?(h==st?w.Le="oversubscribed literal/length tree":-4!=h&&(w.Le="incomplete literal/length tree",h=st),h):(c(288),h=o(s,n,r,0,ut,wt,l,f,u,e,t),0!=h||0===f[0]&&n>257?(h==st?w.Le="oversubscribed distance tree":h==it?(w.Le="incomplete distance tree",h=st):-4!=h&&(w.Le="empty distance tree with lengths",h=st),h):0)}}function dt(){const e=this;let t,n,r,s,i=0,o=0,c=0,f=0,a=0,l=0,u=0,w=0,h=0,d=0;function p(e,t,n,r,s,i,o,c){let f,a,l,u,w,h,d,p,y,m,b,g,k,v,S,z;d=c.nt,p=c.We,w=o.ot,h=o.ct,y=o.write,m=y<o.read?o.read-y-1:o.end-y,b=ot[e],g=ot[t];do{for(;20>h;)p--,w|=(255&c.ft(d++))<<h,h+=8;if(f=w&b,a=n,l=r,z=3*(l+f),0!==(u=a[z]))for(;;){if(w>>=a[z+1],h-=a[z+1],0!=(16&u)){for(u&=15,k=a[z+2]+(w&ot[u]),w>>=u,h-=u;15>h;)p--,w|=(255&c.ft(d++))<<h,h+=8;for(f=w&g,a=s,l=i,z=3*(l+f),u=a[z];;){if(w>>=a[z+1],h-=a[z+1],0!=(16&u)){for(u&=15;u>h;)p--,w|=(255&c.ft(d++))<<h,h+=8;if(v=a[z+2]+(w&ot[u]),w>>=u,h-=u,m-=k,v>y){S=y-v;do{S+=o.end}while(0>S);if(u=o.end-S,k>u){if(k-=u,y-S>0&&u>y-S)do{o.lt[y++]=o.lt[S++]}while(0!=--u);else o.lt.set(o.lt.subarray(S,S+u),y),y+=u,S+=u,u=0;S=0}}else S=y-v,y-S>0&&2>y-S?(o.lt[y++]=o.lt[S++],o.lt[y++]=o.lt[S++],k-=2):(o.lt.set(o.lt.subarray(S,S+2),y),y+=2,S+=2,k-=2);if(y-S>0&&k>y-S)do{o.lt[y++]=o.lt[S++]}while(0!=--k);else o.lt.set(o.lt.subarray(S,S+k),y),y+=k,S+=k,k=0;break}if(0!=(64&u))return c.Le="invalid distance code",k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,st;f+=a[z+2],f+=w&ot[u],z=3*(l+f),u=a[z]}break}if(0!=(64&u))return 0!=(32&u)?(k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,1):(c.Le="invalid literal/length code",k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,st);if(f+=a[z+2],f+=w&ot[u],z=3*(l+f),0===(u=a[z])){w>>=a[z+1],h-=a[z+1],o.lt[y++]=a[z+2],m--;break}}else w>>=a[z+1],h-=a[z+1],o.lt[y++]=a[z+2],m--}while(m>=258&&p>=10);return k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,0}e.init=(e,i,o,c,f,a)=>{t=0,u=e,w=i,r=o,h=c,s=f,d=a,n=null},e.ut=(e,y,m)=>{let b,g,k,v,S,z,C,x=0,A=0,_=0;for(_=y.nt,v=y.We,x=e.ot,A=e.ct,S=e.write,z=S<e.read?e.read-S-1:e.end-S;;)switch(t){case 0:if(z>=258&&v>=10&&(e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,m=p(u,w,r,h,s,d,e,y),_=y.nt,v=y.We,x=e.ot,A=e.ct,S=e.write,z=S<e.read?e.read-S-1:e.end-S,0!=m)){t=1==m?7:9;break}c=u,n=r,o=h,t=1;case 1:for(b=c;b>A;){if(0===v)return e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(_++))<<A,A+=8}if(g=3*(o+(x&ot[b])),x>>>=n[g+1],A-=n[g+1],k=n[g],0===k){f=n[g+2],t=6;break}if(0!=(16&k)){a=15&k,i=n[g+2],t=2;break}if(0==(64&k)){c=k,o=g/3+n[g+2];break}if(0!=(32&k)){t=7;break}return t=9,y.Le="invalid literal/length code",m=st,e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m);case 2:for(b=a;b>A;){if(0===v)return e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(_++))<<A,A+=8}i+=x&ot[b],x>>=b,A-=b,c=w,n=s,o=d,t=3;case 3:for(b=c;b>A;){if(0===v)return e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(_++))<<A,A+=8}if(g=3*(o+(x&ot[b])),x>>=n[g+1],A-=n[g+1],k=n[g],0!=(16&k)){a=15&k,l=n[g+2],t=4;break}if(0==(64&k)){c=k,o=g/3+n[g+2];break}return t=9,y.Le="invalid distance code",m=st,e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m);case 4:for(b=a;b>A;){if(0===v)return e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(_++))<<A,A+=8}l+=x&ot[b],x>>=b,A-=b,t=5;case 5:for(C=S-l;0>C;)C+=e.end;for(;0!==i;){if(0===z&&(S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z&&(e.write=S,m=e.wt(y,m),S=e.write,z=S<e.read?e.read-S-1:e.end-S,S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z)))return e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m);e.lt[S++]=e.lt[C++],z--,C==e.end&&(C=0),i--}t=0;break;case 6:if(0===z&&(S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z&&(e.write=S,m=e.wt(y,m),S=e.write,z=S<e.read?e.read-S-1:e.end-S,S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z)))return e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m);m=0,e.lt[S++]=f,z--,t=0;break;case 7:if(A>7&&(A-=8,v++,_--),e.write=S,m=e.wt(y,m),S=e.write,z=S<e.read?e.read-S-1:e.end-S,e.read!=e.write)return e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m);t=8;case 8:return m=1,e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m);case 9:return m=st,e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m);default:return m=rt,e.ot=x,e.ct=A,y.We=v,y.qe+=_-y.nt,y.nt=_,e.write=S,e.wt(y,m)}},e.ht=()=>{}}ht.dt=(e,t,n,r)=>(e[0]=9,t[0]=5,n[0]=ct,r[0]=ft,0);const pt=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function yt(e,t){const n=this;let r,s=0,o=0,c=0,a=0;const l=[0],u=[0],w=new dt;let h=0,d=new f(4320);const p=new ht;n.ct=0,n.ot=0,n.lt=new i(t),n.end=t,n.read=0,n.write=0,n.reset=(e,t)=>{t&&(t[0]=0),6==s&&w.ht(e),s=0,n.ct=0,n.ot=0,n.read=n.write=0},n.reset(e,null),n.wt=(e,t)=>{let r,s,i;return s=e.rt,i=n.read,r=(i>n.write?n.end:n.write)-i,r>e.tt&&(r=e.tt),0!==r&&t==it&&(t=0),e.tt-=r,e.Ge+=r,e.$e.set(n.lt.subarray(i,i+r),s),s+=r,i+=r,i==n.end&&(i=0,n.write==n.end&&(n.write=0),r=n.write-i,r>e.tt&&(r=e.tt),0!==r&&t==it&&(t=0),e.tt-=r,e.Ge+=r,e.$e.set(n.lt.subarray(i,i+r),s),s+=r,i+=r),e.rt=s,n.read=i,t},n.ut=(e,t)=>{let i,f,y,m,b,g,k,v;for(m=e.nt,b=e.We,f=n.ot,y=n.ct,g=n.write,k=g<n.read?n.read-g-1:n.end-g;;){let S,z,C,x,A,_,I,P;switch(s){case 0:for(;3>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}switch(i=7&f,h=1&i,i>>>1){case 0:f>>>=3,y-=3,i=7&y,f>>>=i,y-=i,s=1;break;case 1:S=[],z=[],C=[[]],x=[[]],ht.dt(S,z,C,x),w.init(S[0],z[0],C[0],0,x[0],0),f>>>=3,y-=3,s=6;break;case 2:f>>>=3,y-=3,s=3;break;case 3:return f>>>=3,y-=3,s=9,e.Le="invalid block type",t=st,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t)}break;case 1:for(;32>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if((~f>>>16&65535)!=(65535&f))return s=9,e.Le="invalid stored block lengths",t=st,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);o=65535&f,f=y=0,s=0!==o?2:0!==h?7:0;break;case 2:if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);if(0===k&&(g==n.end&&0!==n.read&&(g=0,k=g<n.read?n.read-g-1:n.end-g),0===k&&(n.write=g,t=n.wt(e,t),g=n.write,k=g<n.read?n.read-g-1:n.end-g,g==n.end&&0!==n.read&&(g=0,k=g<n.read?n.read-g-1:n.end-g),0===k)))return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);if(t=0,i=o,i>b&&(i=b),i>k&&(i=k),n.lt.set(e.je(m,i),g),m+=i,b-=i,g+=i,k-=i,0!=(o-=i))break;s=0!==h?7:0;break;case 3:for(;14>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if(c=i=16383&f,(31&i)>29||(i>>5&31)>29)return s=9,e.Le="too many length or distance symbols",t=st,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);if(i=258+(31&i)+(i>>5&31),!r||r.length<i)r=[];else for(v=0;i>v;v++)r[v]=0;f>>>=14,y-=14,a=0,s=4;case 4:for(;4+(c>>>10)>a;){for(;3>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}r[pt[a++]]=7&f,f>>>=3,y-=3}for(;19>a;)r[pt[a++]]=0;if(l[0]=7,i=p.st(r,l,u,d,e),0!=i)return(t=i)==st&&(r=null,s=9),n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);a=0,s=5;case 5:for(;i=c,258+(31&i)+(i>>5&31)>a;){let o,w;for(i=l[0];i>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if(i=d[3*(u[0]+(f&ot[i]))+1],w=d[3*(u[0]+(f&ot[i]))+2],16>w)f>>>=i,y-=i,r[a++]=w;else{for(v=18==w?7:w-14,o=18==w?11:3;i+v>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if(f>>>=i,y-=i,o+=f&ot[v],f>>>=v,y-=v,v=a,i=c,v+o>258+(31&i)+(i>>5&31)||16==w&&1>v)return r=null,s=9,e.Le="invalid bit length repeat",t=st,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);w=16==w?r[v-1]:0;do{r[v++]=w}while(0!=--o);a=v}}if(u[0]=-1,A=[],_=[],I=[],P=[],A[0]=9,_[0]=6,i=c,i=p.it(257+(31&i),1+(i>>5&31),r,A,_,I,P,d,e),0!=i)return i==st&&(r=null,s=9),t=i,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);w.init(A[0],_[0],d,I[0],d,P[0]),s=6;case 6:if(n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,1!=(t=w.ut(n,e,t)))return n.wt(e,t);if(t=0,w.ht(e),m=e.nt,b=e.We,f=n.ot,y=n.ct,g=n.write,k=g<n.read?n.read-g-1:n.end-g,0===h){s=0;break}s=7;case 7:if(n.write=g,t=n.wt(e,t),g=n.write,k=g<n.read?n.read-g-1:n.end-g,n.read!=n.write)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);s=8;case 8:return t=1,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);case 9:return t=st,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);default:return t=rt,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t)}}},n.ht=e=>{n.reset(e,null),n.lt=null,d=null},n.yt=(e,t,r)=>{n.lt.set(e.subarray(t,t+r),0),n.read=n.write=r},n.bt=()=>1==s?1:0}const mt=13,bt=[0,0,255,255];function gt(){const e=this;function t(e){return e&&e.gt?(e.qe=e.Ge=0,e.Le=null,e.gt.mode=7,e.gt.kt.reset(e,null),0):rt}e.mode=0,e.method=0,e.vt=[0],e.St=0,e.marker=0,e.zt=0,e.Ct=t=>(e.kt&&e.kt.ht(t),e.kt=null,0),e.xt=(n,r)=>(n.Le=null,e.kt=null,8>r||r>15?(e.Ct(n),rt):(e.zt=r,n.gt.kt=new yt(n,1<<r),t(n),0)),e.At=(e,t)=>{let n,r;if(!e||!e.gt||!e.et)return rt;const s=e.gt;for(t=4==t?it:0,n=it;;)switch(s.mode){case 0:if(0===e.We)return n;if(n=t,e.We--,e.qe++,8!=(15&(s.method=e.ft(e.nt++)))){s.mode=mt,e.Le="unknown compression method",s.marker=5;break}if(8+(s.method>>4)>s.zt){s.mode=mt,e.Le="invalid win size",s.marker=5;break}s.mode=1;case 1:if(0===e.We)return n;if(n=t,e.We--,e.qe++,r=255&e.ft(e.nt++),((s.method<<8)+r)%31!=0){s.mode=mt,e.Le="incorrect header check",s.marker=5;break}if(0==(32&r)){s.mode=7;break}s.mode=2;case 2:if(0===e.We)return n;n=t,e.We--,e.qe++,s.St=(255&e.ft(e.nt++))<<24&4278190080,s.mode=3;case 3:if(0===e.We)return n;n=t,e.We--,e.qe++,s.St+=(255&e.ft(e.nt++))<<16&16711680,s.mode=4;case 4:if(0===e.We)return n;n=t,e.We--,e.qe++,s.St+=(255&e.ft(e.nt++))<<8&65280,s.mode=5;case 5:return 0===e.We?n:(n=t,e.We--,e.qe++,s.St+=255&e.ft(e.nt++),s.mode=6,2);case 6:return s.mode=mt,e.Le="need dictionary",s.marker=0,rt;case 7:if(n=s.kt.ut(e,n),n==st){s.mode=mt,s.marker=0;break}if(0==n&&(n=t),1!=n)return n;n=t,s.kt.reset(e,s.vt),s.mode=12;case 12:return e.We=0,1;case mt:return st;default:return rt}},e._t=(e,t,n)=>{let r=0,s=n;if(!e||!e.gt||6!=e.gt.mode)return rt;const i=e.gt;return s<1<<i.zt||(s=(1<<i.zt)-1,r=n-s),i.kt.yt(t,r,s),i.mode=7,0},e.It=e=>{let n,r,s,i,o;if(!e||!e.gt)return rt;const c=e.gt;if(c.mode!=mt&&(c.mode=mt,c.marker=0),0===(n=e.We))return it;for(r=e.nt,s=c.marker;0!==n&&4>s;)e.ft(r)==bt[s]?s++:s=0!==e.ft(r)?0:4-s,r++,n--;return e.qe+=r-e.nt,e.nt=r,e.We=n,c.marker=s,4!=s?st:(i=e.qe,o=e.Ge,t(e),e.qe=i,e.Ge=o,c.mode=7,0)},e.Pt=e=>e&&e.gt&&e.gt.kt?e.gt.kt.bt():rt}function kt(){}function vt(e){const t=new kt,n=e&&e.chunkSize?r.floor(2*e.chunkSize):131072,o=new i(n);let c=!1;t.xt(),t.$e=o,this.append=(e,r)=>{const f=[];let a,l,u=0,w=0,h=0;if(0!==e.length){t.nt=0,t.et=e,t.We=e.length;do{if(t.rt=0,t.tt=n,0!==t.We||c||(t.nt=0,c=!0),a=t.At(0),c&&a===it){if(0!==t.We)throw new s("inflating: bad input")}else if(0!==a&&1!==a)throw new s("inflating: "+t.Le);if((c||1===a)&&t.We===e.length)throw new s("inflating: bad input");t.rt&&(t.rt===n?f.push(new i(o)):f.push(o.subarray(0,t.rt))),h+=t.rt,r&&t.nt>0&&t.nt!=u&&(r(t.nt),u=t.nt)}while(t.We>0||0===t.tt);return f.length>1?(l=new i(h),f.forEach((e=>{l.set(e,w),w+=e.length}))):l=f[0]?new i(f[0]):new i,l}},this.flush=()=>{t.Ct()}}kt.prototype={xt(e){const t=this;return t.gt=new gt,e||(e=15),t.gt.xt(t,e)},At(e){const t=this;return t.gt?t.gt.At(t,e):rt},Ct(){const e=this;if(!e.gt)return rt;const t=e.gt.Ct(e);return e.gt=null,t},It(){const e=this;return e.gt?e.gt.It(e):rt},_t(e,t){const n=this;return n.gt?n.gt._t(n,e,t):rt},ft(e){return this.et[e]},je(e,t){return this.et.subarray(e,e+t)}},self.initCodec=()=>{self.Deflate=nt,self.Inflate=vt};\n'],{type:"text/javascript"}));t({workerScripts:{inflate:[e],deflate:[e]}})}(am),am({Deflate:function(t){const e=new sp,i=(s=t&&t.chunkSize?t.chunkSize:65536)+5*(Math.floor(s/16383)+1);var s;const r=new Uint8Array(i);let n=t?t.level:-1;void 0===n&&(n=-1),e.deflateInit(n),e.next_out=r,this.append=function(t,s){let n,a,o=0,h=0,l=0;const u=[];if(t.length){e.next_in_index=0,e.next_in=t,e.avail_in=t.length;do{if(e.next_out_index=0,e.avail_out=i,n=e.deflate(0),0!=n)throw new Error("deflating: "+e.msg);e.next_out_index&&(e.next_out_index==i?u.push(new Uint8Array(r)):u.push(r.subarray(0,e.next_out_index))),l+=e.next_out_index,s&&e.next_in_index>0&&e.next_in_index!=o&&(s(e.next_in_index),o=e.next_in_index)}while(e.avail_in>0||0===e.avail_out);return u.length>1?(a=new Uint8Array(l),u.forEach((function(t){a.set(t,h),h+=t.length}))):a=u[0]?new Uint8Array(u[0]):new Uint8Array,a}},this.flush=function(){let t,s,n=0,a=0;const o=[];do{if(e.next_out_index=0,e.avail_out=i,t=e.deflate(4),1!=t&&0!=t)throw new Error("deflating: "+e.msg);i-e.avail_out>0&&o.push(r.slice(0,e.next_out_index)),a+=e.next_out_index}while(e.avail_in>0||0===e.avail_out);return e.deflateEnd(),s=new Uint8Array(a),o.forEach((function(t){s.set(t,n),n+=t.length})),s}},Inflate:function(t){const e=new Hp,i=t&&t.chunkSize?Math.floor(2*t.chunkSize):131072,s=new Uint8Array(i);let r=!1;e.inflateInit(),e.next_out=s,this.append=function(t,n){const a=[];let o,h,l=0,u=0,c=0;if(0!==t.length){e.next_in_index=0,e.next_in=t,e.avail_in=t.length;do{if(e.next_out_index=0,e.avail_out=i,0!==e.avail_in||r||(e.next_in_index=0,r=!0),o=e.inflate(0),r&&o===lp){if(0!==e.avail_in)throw new Error("inflating: bad input")}else if(o!==rp&&o!==np)throw new Error("inflating: "+e.msg);if((r||o===np)&&e.avail_in===t.length)throw new Error("inflating: bad input");e.next_out_index&&(e.next_out_index===i?a.push(new Uint8Array(s)):a.push(s.subarray(0,e.next_out_index))),c+=e.next_out_index,n&&e.next_in_index>0&&e.next_in_index!=l&&(n(e.next_in_index),l=e.next_in_index)}while(e.avail_in>0||0===e.avail_out);return a.length>1?(h=new Uint8Array(c),a.forEach((function(t){h.set(t,u),u+=t.length}))):h=a[0]?new Uint8Array(a[0]):new Uint8Array,h}},this.flush=function(){e.inflateEnd()}}});class B_ extends(to(ro,go,xo)){_textureSize;constructor(){super(),this._textureSize=x.zero()}get textureWidth(){return this._textureSize.x}set textureWidth(t){t!==this._textureSize.x&&(this._textureSize.x=t,this.uniformChanged())}get textureHeight(){return this._textureSize.y}set textureHeight(t){t!==this._textureSize.y&&(this._textureSize.y=t,this.uniformChanged())}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),this.needFragmentColor(e)&&t.setValue("albedoTextureSize",this._textureSize)}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$l.oPos=Qa.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(Qa.getWorldMatrix(t),e.vec4(t.oPos,1)).xyz,Qa.setClipSpacePosition(t,e.mul(Qa.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),t.$l.oNorm=e.normalize(e.mul(t.oPos,e.vec3(1,.5,1))),t.$outputs.wNorm=e.mul(Qa.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz}fragmentShader(t){super.fragmentShader(t);const e=t.$builder,i=this;this.needFragmentColor()?(t.albedoTextureSize=e.vec2().uniform(2),t.$l.albedo=this.calculateAlbedoColor(t),t.albedo=i.calculateFoliageAlbedo(t,t.albedo,e.mul(i.getAlbedoTexCoord(t),t.albedoTextureSize)),t.$l.litColor=e.vec3(0),this.drawContext.renderPass.type===Ra&&(t.$l.normalInfo=this.calculateNormalAndTBN(t,t.$inputs.worldPos,t.$inputs.worldNorm),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN)),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a))):this.outputFragmentColor(t,t.$inputs.worldPos,null)}}to(ro,So,xo);class O_{constructor(t,e,i,s,r="div"){this.parent=t,this.object=e,this.property=i,this._disabled=!1,this._hidden=!1,this.initialValue=this.getValue(),this.domElement=document.createElement(r),this.domElement.classList.add("controller"),this.domElement.classList.add(s),this.$name=document.createElement("div"),this.$name.classList.add("name"),O_.nextNameID=O_.nextNameID||0,this.$name.id="lil-gui-name-"+ ++O_.nextNameID,this.$widget=document.createElement("div"),this.$widget.classList.add("widget"),this.$disable=this.$widget,this.domElement.appendChild(this.$name),this.domElement.appendChild(this.$widget),this.domElement.addEventListener("keydown",(t=>t.stopPropagation())),this.domElement.addEventListener("keyup",(t=>t.stopPropagation())),this.parent.children.push(this),this.parent.controllers.push(this),this.parent.$children.appendChild(this.domElement),this._listenCallback=this._listenCallback.bind(this),this.name(i)}name(t){return this._name=t,this.$name.textContent=t,this}onChange(t){return this._onChange=t,this}_callOnChange(){this.parent._callOnChange(this),void 0!==this._onChange&&this._onChange.call(this,this.getValue()),this._changed=!0}onFinishChange(t){return this._onFinishChange=t,this}_callOnFinishChange(){this._changed&&(this.parent._callOnFinishChange(this),void 0!==this._onFinishChange&&this._onFinishChange.call(this,this.getValue())),this._changed=!1}reset(){return this.setValue(this.initialValue),this._callOnFinishChange(),this}enable(t=!0){return this.disable(!t)}disable(t=!0){return t===this._disabled||(this._disabled=t,this.domElement.classList.toggle("disabled",t),this.$disable.toggleAttribute("disabled",t)),this}show(t=!0){return this._hidden=!t,this.domElement.style.display=this._hidden?"none":"",this}hide(){return this.show(!1)}options(t){const e=this.parent.add(this.object,this.property,t);return e.name(this._name),this.destroy(),e}min(t){return this}max(t){return this}step(t){return this}decimals(t){return this}listen(t=!0){return this._listening=t,void 0!==this._listenCallbackID&&(cancelAnimationFrame(this._listenCallbackID),this._listenCallbackID=void 0),this._listening&&this._listenCallback(),this}_listenCallback(){this._listenCallbackID=requestAnimationFrame(this._listenCallback);const t=this.save();t!==this._listenPrevValue&&this.updateDisplay(),this._listenPrevValue=t}getValue(){return this.object[this.property]}setValue(t){return this.getValue()!==t&&(this.object[this.property]=t,this._callOnChange(),this.updateDisplay()),this}updateDisplay(){return this}load(t){return this.setValue(t),this._callOnFinishChange(),this}save(){return this.getValue()}destroy(){this.listen(!1),this.parent.children.splice(this.parent.children.indexOf(this),1),this.parent.controllers.splice(this.parent.controllers.indexOf(this),1),this.parent.$children.removeChild(this.domElement)}}class U_ extends O_{constructor(t,e,i){super(t,e,i,"boolean","label"),this.$input=document.createElement("input"),this.$input.setAttribute("type","checkbox"),this.$input.setAttribute("aria-labelledby",this.$name.id),this.$widget.appendChild(this.$input),this.$input.addEventListener("change",(()=>{this.setValue(this.$input.checked),this._callOnFinishChange()})),this.$disable=this.$input,this.updateDisplay()}updateDisplay(){return this.$input.checked=this.getValue(),this}}function k_(t){let e,i;return(e=t.match(/(#|0x)?([a-f0-9]{6})/i))?i=e[2]:(e=t.match(/rgb\(\s*(\d*)\s*,\s*(\d*)\s*,\s*(\d*)\s*\)/))?i=parseInt(e[1]).toString(16).padStart(2,0)+parseInt(e[2]).toString(16).padStart(2,0)+parseInt(e[3]).toString(16).padStart(2,0):(e=t.match(/^#?([a-f0-9])([a-f0-9])([a-f0-9])$/i))&&(i=e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),!!i&&"#"+i}const z_={isPrimitive:!0,match:t=>"number"==typeof t,fromHexString:t=>parseInt(t.substring(1),16),toHexString:t=>"#"+t.toString(16).padStart(6,0)},V_={isPrimitive:!1,match:t=>Array.isArray(t),fromHexString(t,e,i=1){const s=z_.fromHexString(t);e[0]=(s>>16&255)/255*i,e[1]=(s>>8&255)/255*i,e[2]=(255&s)/255*i},toHexString:([t,e,i],s=1)=>z_.toHexString(t*(s=255/s)<<16^e*s<<8^i*s<<0)},G_={isPrimitive:!1,match:t=>Object(t)===t,fromHexString(t,e,i=1){const s=z_.fromHexString(t);e.r=(s>>16&255)/255*i,e.g=(s>>8&255)/255*i,e.b=(255&s)/255*i},toHexString:({r:t,g:e,b:i},s=1)=>z_.toHexString(t*(s=255/s)<<16^e*s<<8^i*s<<0)},X_=[{isPrimitive:!0,match:t=>"string"==typeof t,fromHexString:k_,toHexString:k_},z_,V_,G_];class W_ extends O_{constructor(t,e,i,s){var r;super(t,e,i,"color"),this.$input=document.createElement("input"),this.$input.setAttribute("type","color"),this.$input.setAttribute("tabindex",-1),this.$input.setAttribute("aria-labelledby",this.$name.id),this.$text=document.createElement("input"),this.$text.setAttribute("type","text"),this.$text.setAttribute("spellcheck","false"),this.$text.setAttribute("aria-labelledby",this.$name.id),this.$display=document.createElement("div"),this.$display.classList.add("display"),this.$display.appendChild(this.$input),this.$widget.appendChild(this.$display),this.$widget.appendChild(this.$text),this._format=(r=this.initialValue,X_.find((t=>t.match(r)))),this._rgbScale=s,this._initialValueHexString=this.save(),this._textFocused=!1,this.$input.addEventListener("input",(()=>{this._setValueFromHexString(this.$input.value)})),this.$input.addEventListener("blur",(()=>{this._callOnFinishChange()})),this.$text.addEventListener("input",(()=>{const t=k_(this.$text.value);t&&this._setValueFromHexString(t)})),this.$text.addEventListener("focus",(()=>{this._textFocused=!0,this.$text.select()})),this.$text.addEventListener("blur",(()=>{this._textFocused=!1,this.updateDisplay(),this._callOnFinishChange()})),this.$disable=this.$text,this.updateDisplay()}reset(){return this._setValueFromHexString(this._initialValueHexString),this}_setValueFromHexString(t){if(this._format.isPrimitive){const e=this._format.fromHexString(t);this.setValue(e)}else this._format.fromHexString(t,this.getValue(),this._rgbScale),this._callOnChange(),this.updateDisplay()}save(){return this._format.toHexString(this.getValue(),this._rgbScale)}load(t){return this._setValueFromHexString(t),this._callOnFinishChange(),this}updateDisplay(){return this.$input.value=this._format.toHexString(this.getValue(),this._rgbScale),this._textFocused||(this.$text.value=this.$input.value.substring(1)),this.$display.style.backgroundColor=this.$input.value,this}}class H_ extends O_{constructor(t,e,i){super(t,e,i,"function"),this.$button=document.createElement("button"),this.$button.appendChild(this.$name),this.$widget.appendChild(this.$button),this.$button.addEventListener("click",(t=>{t.preventDefault(),this.getValue().call(this.object),this._callOnChange()})),this.$button.addEventListener("touchstart",(()=>{}),{passive:!0}),this.$disable=this.$button}}class j_ extends O_{constructor(t,e,i,s,r,n){super(t,e,i,"number"),this._initInput(),this.min(s),this.max(r);const a=void 0!==n;this.step(a?n:this._getImplicitStep(),a),this.updateDisplay()}decimals(t){return this._decimals=t,this.updateDisplay(),this}min(t){return this._min=t,this._onUpdateMinMax(),this}max(t){return this._max=t,this._onUpdateMinMax(),this}step(t,e=!0){return this._step=t,this._stepExplicit=e,this}updateDisplay(){const t=this.getValue();if(this._hasSlider){let e=(t-this._min)/(this._max-this._min);e=Math.max(0,Math.min(e,1)),this.$fill.style.width=100*e+"%"}return this._inputFocused||(this.$input.value=void 0===this._decimals?t:t.toFixed(this._decimals)),this}_initInput(){this.$input=document.createElement("input"),this.$input.setAttribute("type","text"),this.$input.setAttribute("aria-labelledby",this.$name.id);window.matchMedia("(pointer: coarse)").matches&&(this.$input.setAttribute("type","number"),this.$input.setAttribute("step","any")),this.$widget.appendChild(this.$input),this.$disable=this.$input;const t=t=>{const e=parseFloat(this.$input.value);isNaN(e)||(this._snapClampSetValue(e+t),this.$input.value=this.getValue())};let e,i,s,r,n,a=!1;const o=t=>{if(a){const s=t.clientX-e,r=t.clientY-i;Math.abs(r)>5?(t.preventDefault(),this.$input.blur(),a=!1,this._setDraggingStyle(!0,"vertical")):Math.abs(s)>5&&h()}if(!a){const e=t.clientY-s;n-=e*this._step*this._arrowKeyMultiplier(t),r+n>this._max?n=this._max-r:r+n<this._min&&(n=this._min-r),this._snapClampSetValue(r+n)}s=t.clientY},h=()=>{this._setDraggingStyle(!1,"vertical"),this._callOnFinishChange(),window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",h)};this.$input.addEventListener("input",(()=>{let t=parseFloat(this.$input.value);isNaN(t)||(this._stepExplicit&&(t=this._snap(t)),this.setValue(this._clamp(t)))})),this.$input.addEventListener("keydown",(e=>{"Enter"===e.key&&this.$input.blur(),"ArrowUp"===e.code&&(e.preventDefault(),t(this._step*this._arrowKeyMultiplier(e))),"ArrowDown"===e.code&&(e.preventDefault(),t(this._step*this._arrowKeyMultiplier(e)*-1))})),this.$input.addEventListener("wheel",(e=>{this._inputFocused&&(e.preventDefault(),t(this._step*this._normalizeMouseWheel(e)))}),{passive:!1}),this.$input.addEventListener("mousedown",(t=>{e=t.clientX,i=s=t.clientY,a=!0,r=this.getValue(),n=0,window.addEventListener("mousemove",o),window.addEventListener("mouseup",h)})),this.$input.addEventListener("focus",(()=>{this._inputFocused=!0})),this.$input.addEventListener("blur",(()=>{this._inputFocused=!1,this.updateDisplay(),this._callOnFinishChange()}))}_initSlider(){this._hasSlider=!0,this.$slider=document.createElement("div"),this.$slider.classList.add("slider"),this.$fill=document.createElement("div"),this.$fill.classList.add("fill"),this.$slider.appendChild(this.$fill),this.$widget.insertBefore(this.$slider,this.$input),this.domElement.classList.add("hasSlider");const t=t=>{const e=this.$slider.getBoundingClientRect();let i=(s=t,r=e.left,n=e.right,a=this._min,o=this._max,(s-r)/(n-r)*(o-a)+a);var s,r,n,a,o;this._snapClampSetValue(i)},e=e=>{t(e.clientX)},i=()=>{this._callOnFinishChange(),this._setDraggingStyle(!1),window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",i)};let s,r,n=!1;const a=e=>{e.preventDefault(),this._setDraggingStyle(!0),t(e.touches[0].clientX),n=!1},o=e=>{if(n){const t=e.touches[0].clientX-s,i=e.touches[0].clientY-r;Math.abs(t)>Math.abs(i)?a(e):(window.removeEventListener("touchmove",o),window.removeEventListener("touchend",h))}else e.preventDefault(),t(e.touches[0].clientX)},h=()=>{this._callOnFinishChange(),this._setDraggingStyle(!1),window.removeEventListener("touchmove",o),window.removeEventListener("touchend",h)},l=this._callOnFinishChange.bind(this);let u;this.$slider.addEventListener("mousedown",(s=>{this._setDraggingStyle(!0),t(s.clientX),window.addEventListener("mousemove",e),window.addEventListener("mouseup",i)})),this.$slider.addEventListener("touchstart",(t=>{t.touches.length>1||(this._hasScrollBar?(s=t.touches[0].clientX,r=t.touches[0].clientY,n=!0):a(t),window.addEventListener("touchmove",o,{passive:!1}),window.addEventListener("touchend",h))}),{passive:!1}),this.$slider.addEventListener("wheel",(t=>{if(Math.abs(t.deltaX)<Math.abs(t.deltaY)&&this._hasScrollBar)return;t.preventDefault();const e=this._normalizeMouseWheel(t)*this._step;this._snapClampSetValue(this.getValue()+e),this.$input.value=this.getValue(),clearTimeout(u),u=setTimeout(l,400)}),{passive:!1})}_setDraggingStyle(t,e="horizontal"){this.$slider&&this.$slider.classList.toggle("active",t),document.body.classList.toggle("lil-gui-dragging",t),document.body.classList.toggle(`lil-gui-${e}`,t)}_getImplicitStep(){return this._hasMin&&this._hasMax?(this._max-this._min)/1e3:.1}_onUpdateMinMax(){!this._hasSlider&&this._hasMin&&this._hasMax&&(this._stepExplicit||this.step(this._getImplicitStep(),!1),this._initSlider(),this.updateDisplay())}_normalizeMouseWheel(t){let{deltaX:e,deltaY:i}=t;Math.floor(t.deltaY)!==t.deltaY&&t.wheelDelta&&(e=0,i=-t.wheelDelta/120,i*=this._stepExplicit?1:10);return e+-i}_arrowKeyMultiplier(t){let e=this._stepExplicit?1:10;return t.shiftKey?e*=10:t.altKey&&(e/=10),e}_snap(t){const e=Math.round(t/this._step)*this._step;return parseFloat(e.toPrecision(15))}_clamp(t){return t<this._min&&(t=this._min),t>this._max&&(t=this._max),t}_snapClampSetValue(t){this.setValue(this._clamp(this._snap(t)))}get _hasScrollBar(){const t=this.parent.root.$children;return t.scrollHeight>t.clientHeight}get _hasMin(){return void 0!==this._min}get _hasMax(){return void 0!==this._max}}class q_ extends O_{constructor(t,e,i,s){super(t,e,i,"option"),this.$select=document.createElement("select"),this.$select.setAttribute("aria-labelledby",this.$name.id),this.$display=document.createElement("div"),this.$display.classList.add("display"),this.$select.addEventListener("change",(()=>{this.setValue(this._values[this.$select.selectedIndex]),this._callOnFinishChange()})),this.$select.addEventListener("focus",(()=>{this.$display.classList.add("focus")})),this.$select.addEventListener("blur",(()=>{this.$display.classList.remove("focus")})),this.$widget.appendChild(this.$select),this.$widget.appendChild(this.$display),this.$disable=this.$select,this.options(s)}options(t){return this._values=Array.isArray(t)?t:Object.values(t),this._names=Array.isArray(t)?t:Object.keys(t),this.$select.replaceChildren(),this._names.forEach((t=>{const e=document.createElement("option");e.textContent=t,this.$select.appendChild(e)})),this.updateDisplay(),this}updateDisplay(){const t=this.getValue(),e=this._values.indexOf(t);return this.$select.selectedIndex=e,this.$display.textContent=-1===e?t:this._names[e],this}}class Y_ extends O_{constructor(t,e,i){super(t,e,i,"string"),this.$input=document.createElement("input"),this.$input.setAttribute("type","text"),this.$input.setAttribute("spellcheck","false"),this.$input.setAttribute("aria-labelledby",this.$name.id),this.$input.addEventListener("input",(()=>{this.setValue(this.$input.value)})),this.$input.addEventListener("keydown",(t=>{"Enter"===t.code&&this.$input.blur()})),this.$input.addEventListener("blur",(()=>{this._callOnFinishChange()})),this.$widget.appendChild(this.$input),this.$disable=this.$input,this.updateDisplay()}updateDisplay(){return this.$input.value=this.getValue(),this}}let Z_=!1;class K_{constructor({parent:t,autoPlace:e=void 0===t,container:i,width:s,title:r="Controls",closeFolders:n=!1,injectStyles:a=!0,touchStyles:o=!0}={}){if(this.parent=t,this.root=t?t.root:this,this.children=[],this.controllers=[],this.folders=[],this._closed=!1,this._hidden=!1,this.domElement=document.createElement("div"),this.domElement.classList.add("lil-gui"),this.$title=document.createElement("div"),this.$title.classList.add("title"),this.$title.setAttribute("role","button"),this.$title.setAttribute("aria-expanded",!0),this.$title.setAttribute("tabindex",0),this.$title.addEventListener("click",(()=>this.openAnimated(this._closed))),this.$title.addEventListener("keydown",(t=>{"Enter"!==t.code&&"Space"!==t.code||(t.preventDefault(),this.$title.click())})),this.$title.addEventListener("touchstart",(()=>{}),{passive:!0}),this.$children=document.createElement("div"),this.$children.classList.add("children"),this.domElement.appendChild(this.$title),this.domElement.appendChild(this.$children),this.title(r),this.parent)return this.parent.children.push(this),this.parent.folders.push(this),void this.parent.$children.appendChild(this.domElement);this.domElement.classList.add("root"),o&&this.domElement.classList.add("allow-touch-styles"),!Z_&&a&&(!function(t){const e=document.createElement("style");e.innerHTML=t;const i=document.querySelector("head link[rel=stylesheet], head style");i?document.head.insertBefore(e,i):document.head.appendChild(e)}('.lil-gui {\n  font-family: var(--font-family);\n  font-size: var(--font-size);\n  line-height: 1;\n  font-weight: normal;\n  font-style: normal;\n  text-align: left;\n  color: var(--text-color);\n  user-select: none;\n  -webkit-user-select: none;\n  touch-action: manipulation;\n  --background-color: #1f1f1f;\n  --text-color: #ebebeb;\n  --title-background-color: #111111;\n  --title-text-color: #ebebeb;\n  --widget-color: #424242;\n  --hover-color: #4f4f4f;\n  --focus-color: #595959;\n  --number-color: #2cc9ff;\n  --string-color: #a2db3c;\n  --font-size: 11px;\n  --input-font-size: 11px;\n  --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;\n  --font-family-mono: Menlo, Monaco, Consolas, "Droid Sans Mono", monospace;\n  --padding: 4px;\n  --spacing: 4px;\n  --widget-height: 20px;\n  --title-height: calc(var(--widget-height) + var(--spacing) * 1.25);\n  --name-width: 45%;\n  --slider-knob-width: 2px;\n  --slider-input-width: 27%;\n  --color-input-width: 27%;\n  --slider-input-min-width: 45px;\n  --color-input-min-width: 45px;\n  --folder-indent: 7px;\n  --widget-padding: 0 0 0 3px;\n  --widget-border-radius: 2px;\n  --checkbox-size: calc(0.75 * var(--widget-height));\n  --scrollbar-width: 5px;\n}\n.lil-gui, .lil-gui * {\n  box-sizing: border-box;\n  margin: 0;\n  padding: 0;\n}\n.lil-gui.root {\n  width: var(--width, 245px);\n  display: flex;\n  flex-direction: column;\n  background: var(--background-color);\n}\n.lil-gui.root > .title {\n  background: var(--title-background-color);\n  color: var(--title-text-color);\n}\n.lil-gui.root > .children {\n  overflow-x: hidden;\n  overflow-y: auto;\n}\n.lil-gui.root > .children::-webkit-scrollbar {\n  width: var(--scrollbar-width);\n  height: var(--scrollbar-width);\n  background: var(--background-color);\n}\n.lil-gui.root > .children::-webkit-scrollbar-thumb {\n  border-radius: var(--scrollbar-width);\n  background: var(--focus-color);\n}\n@media (pointer: coarse) {\n  .lil-gui.allow-touch-styles, .lil-gui.allow-touch-styles .lil-gui {\n    --widget-height: 28px;\n    --padding: 6px;\n    --spacing: 6px;\n    --font-size: 13px;\n    --input-font-size: 16px;\n    --folder-indent: 10px;\n    --scrollbar-width: 7px;\n    --slider-input-min-width: 50px;\n    --color-input-min-width: 65px;\n  }\n}\n.lil-gui.force-touch-styles, .lil-gui.force-touch-styles .lil-gui {\n  --widget-height: 28px;\n  --padding: 6px;\n  --spacing: 6px;\n  --font-size: 13px;\n  --input-font-size: 16px;\n  --folder-indent: 10px;\n  --scrollbar-width: 7px;\n  --slider-input-min-width: 50px;\n  --color-input-min-width: 65px;\n}\n.lil-gui.autoPlace {\n  max-height: 100%;\n  position: fixed;\n  top: 0;\n  right: 15px;\n  z-index: 1001;\n}\n\n.lil-gui .controller {\n  display: flex;\n  align-items: center;\n  padding: 0 var(--padding);\n  margin: var(--spacing) 0;\n}\n.lil-gui .controller.disabled {\n  opacity: 0.5;\n}\n.lil-gui .controller.disabled, .lil-gui .controller.disabled * {\n  pointer-events: none !important;\n}\n.lil-gui .controller > .name {\n  min-width: var(--name-width);\n  flex-shrink: 0;\n  white-space: pre;\n  padding-right: var(--spacing);\n  line-height: var(--widget-height);\n}\n.lil-gui .controller .widget {\n  position: relative;\n  display: flex;\n  align-items: center;\n  width: 100%;\n  min-height: var(--widget-height);\n}\n.lil-gui .controller.string input {\n  color: var(--string-color);\n}\n.lil-gui .controller.boolean {\n  cursor: pointer;\n}\n.lil-gui .controller.color .display {\n  width: 100%;\n  height: var(--widget-height);\n  border-radius: var(--widget-border-radius);\n  position: relative;\n}\n@media (hover: hover) {\n  .lil-gui .controller.color .display:hover:before {\n    content: " ";\n    display: block;\n    position: absolute;\n    border-radius: var(--widget-border-radius);\n    border: 1px solid #fff9;\n    top: 0;\n    right: 0;\n    bottom: 0;\n    left: 0;\n  }\n}\n.lil-gui .controller.color input[type=color] {\n  opacity: 0;\n  width: 100%;\n  height: 100%;\n  cursor: pointer;\n}\n.lil-gui .controller.color input[type=text] {\n  margin-left: var(--spacing);\n  font-family: var(--font-family-mono);\n  min-width: var(--color-input-min-width);\n  width: var(--color-input-width);\n  flex-shrink: 0;\n}\n.lil-gui .controller.option select {\n  opacity: 0;\n  position: absolute;\n  width: 100%;\n  max-width: 100%;\n}\n.lil-gui .controller.option .display {\n  position: relative;\n  pointer-events: none;\n  border-radius: var(--widget-border-radius);\n  height: var(--widget-height);\n  line-height: var(--widget-height);\n  max-width: 100%;\n  overflow: hidden;\n  word-break: break-all;\n  padding-left: 0.55em;\n  padding-right: 1.75em;\n  background: var(--widget-color);\n}\n@media (hover: hover) {\n  .lil-gui .controller.option .display.focus {\n    background: var(--focus-color);\n  }\n}\n.lil-gui .controller.option .display.active {\n  background: var(--focus-color);\n}\n.lil-gui .controller.option .display:after {\n  font-family: "lil-gui";\n  content: "";\n  position: absolute;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  padding-right: 0.375em;\n}\n.lil-gui .controller.option .widget,\n.lil-gui .controller.option select {\n  cursor: pointer;\n}\n@media (hover: hover) {\n  .lil-gui .controller.option .widget:hover .display {\n    background: var(--hover-color);\n  }\n}\n.lil-gui .controller.number input {\n  color: var(--number-color);\n}\n.lil-gui .controller.number.hasSlider input {\n  margin-left: var(--spacing);\n  width: var(--slider-input-width);\n  min-width: var(--slider-input-min-width);\n  flex-shrink: 0;\n}\n.lil-gui .controller.number .slider {\n  width: 100%;\n  height: var(--widget-height);\n  background: var(--widget-color);\n  border-radius: var(--widget-border-radius);\n  padding-right: var(--slider-knob-width);\n  overflow: hidden;\n  cursor: ew-resize;\n  touch-action: pan-y;\n}\n@media (hover: hover) {\n  .lil-gui .controller.number .slider:hover {\n    background: var(--hover-color);\n  }\n}\n.lil-gui .controller.number .slider.active {\n  background: var(--focus-color);\n}\n.lil-gui .controller.number .slider.active .fill {\n  opacity: 0.95;\n}\n.lil-gui .controller.number .fill {\n  height: 100%;\n  border-right: var(--slider-knob-width) solid var(--number-color);\n  box-sizing: content-box;\n}\n\n.lil-gui-dragging .lil-gui {\n  --hover-color: var(--widget-color);\n}\n.lil-gui-dragging * {\n  cursor: ew-resize !important;\n}\n\n.lil-gui-dragging.lil-gui-vertical * {\n  cursor: ns-resize !important;\n}\n\n.lil-gui .title {\n  height: var(--title-height);\n  line-height: calc(var(--title-height) - 4px);\n  font-weight: 600;\n  padding: 0 var(--padding);\n  -webkit-tap-highlight-color: transparent;\n  cursor: pointer;\n  outline: none;\n  text-decoration-skip: objects;\n}\n.lil-gui .title:before {\n  font-family: "lil-gui";\n  content: "";\n  padding-right: 2px;\n  display: inline-block;\n}\n.lil-gui .title:active {\n  background: var(--title-background-color);\n  opacity: 0.75;\n}\n@media (hover: hover) {\n  body:not(.lil-gui-dragging) .lil-gui .title:hover {\n    background: var(--title-background-color);\n    opacity: 0.85;\n  }\n  .lil-gui .title:focus {\n    text-decoration: underline var(--focus-color);\n  }\n}\n.lil-gui.root > .title:focus {\n  text-decoration: none !important;\n}\n.lil-gui.closed > .title:before {\n  content: "";\n}\n.lil-gui.closed > .children {\n  transform: translateY(-7px);\n  opacity: 0;\n}\n.lil-gui.closed:not(.transition) > .children {\n  display: none;\n}\n.lil-gui.transition > .children {\n  transition-duration: 300ms;\n  transition-property: height, opacity, transform;\n  transition-timing-function: cubic-bezier(0.2, 0.6, 0.35, 1);\n  overflow: hidden;\n  pointer-events: none;\n}\n.lil-gui .children:empty:before {\n  content: "Empty";\n  padding: 0 var(--padding);\n  margin: var(--spacing) 0;\n  display: block;\n  height: var(--widget-height);\n  font-style: italic;\n  line-height: var(--widget-height);\n  opacity: 0.5;\n}\n.lil-gui.root > .children > .lil-gui > .title {\n  border: 0 solid var(--widget-color);\n  border-width: 1px 0;\n  transition: border-color 300ms;\n}\n.lil-gui.root > .children > .lil-gui.closed > .title {\n  border-bottom-color: transparent;\n}\n.lil-gui + .controller {\n  border-top: 1px solid var(--widget-color);\n  margin-top: 0;\n  padding-top: var(--spacing);\n}\n.lil-gui .lil-gui .lil-gui > .title {\n  border: none;\n}\n.lil-gui .lil-gui .lil-gui > .children {\n  border: none;\n  margin-left: var(--folder-indent);\n  border-left: 2px solid var(--widget-color);\n}\n.lil-gui .lil-gui .controller {\n  border: none;\n}\n\n.lil-gui label, .lil-gui input, .lil-gui button {\n  -webkit-tap-highlight-color: transparent;\n}\n.lil-gui input {\n  border: 0;\n  outline: none;\n  font-family: var(--font-family);\n  font-size: var(--input-font-size);\n  border-radius: var(--widget-border-radius);\n  height: var(--widget-height);\n  background: var(--widget-color);\n  color: var(--text-color);\n  width: 100%;\n}\n@media (hover: hover) {\n  .lil-gui input:hover {\n    background: var(--hover-color);\n  }\n  .lil-gui input:active {\n    background: var(--focus-color);\n  }\n}\n.lil-gui input:disabled {\n  opacity: 1;\n}\n.lil-gui input[type=text],\n.lil-gui input[type=number] {\n  padding: var(--widget-padding);\n  -moz-appearance: textfield;\n}\n.lil-gui input[type=text]:focus,\n.lil-gui input[type=number]:focus {\n  background: var(--focus-color);\n}\n.lil-gui input[type=checkbox] {\n  appearance: none;\n  width: var(--checkbox-size);\n  height: var(--checkbox-size);\n  border-radius: var(--widget-border-radius);\n  text-align: center;\n  cursor: pointer;\n}\n.lil-gui input[type=checkbox]:checked:before {\n  font-family: "lil-gui";\n  content: "";\n  font-size: var(--checkbox-size);\n  line-height: var(--checkbox-size);\n}\n@media (hover: hover) {\n  .lil-gui input[type=checkbox]:focus {\n    box-shadow: inset 0 0 0 1px var(--focus-color);\n  }\n}\n.lil-gui button {\n  outline: none;\n  cursor: pointer;\n  font-family: var(--font-family);\n  font-size: var(--font-size);\n  color: var(--text-color);\n  width: 100%;\n  height: var(--widget-height);\n  text-transform: none;\n  background: var(--widget-color);\n  border-radius: var(--widget-border-radius);\n  border: none;\n}\n@media (hover: hover) {\n  .lil-gui button:hover {\n    background: var(--hover-color);\n  }\n  .lil-gui button:focus {\n    box-shadow: inset 0 0 0 1px var(--focus-color);\n  }\n}\n.lil-gui button:active {\n  background: var(--focus-color);\n}\n\n@font-face {\n  font-family: "lil-gui";\n  src: url("data:application/font-woff;charset=utf-8;base64,d09GRgABAAAAAAUsAAsAAAAACJwAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABCAAAAH4AAADAImwmYE9TLzIAAAGIAAAAPwAAAGBKqH5SY21hcAAAAcgAAAD0AAACrukyyJBnbHlmAAACvAAAAF8AAACEIZpWH2hlYWQAAAMcAAAAJwAAADZfcj2zaGhlYQAAA0QAAAAYAAAAJAC5AHhobXR4AAADXAAAABAAAABMAZAAAGxvY2EAAANsAAAAFAAAACgCEgIybWF4cAAAA4AAAAAeAAAAIAEfABJuYW1lAAADoAAAASIAAAIK9SUU/XBvc3QAAATEAAAAZgAAAJCTcMc2eJxVjbEOgjAURU+hFRBK1dGRL+ALnAiToyMLEzFpnPz/eAshwSa97517c/MwwJmeB9kwPl+0cf5+uGPZXsqPu4nvZabcSZldZ6kfyWnomFY/eScKqZNWupKJO6kXN3K9uCVoL7iInPr1X5baXs3tjuMqCtzEuagm/AAlzQgPAAB4nGNgYRBlnMDAysDAYM/gBiT5oLQBAwuDJAMDEwMrMwNWEJDmmsJwgCFeXZghBcjlZMgFCzOiKOIFAB71Bb8AeJy1kjFuwkAQRZ+DwRAwBtNQRUGKQ8OdKCAWUhAgKLhIuAsVSpWz5Bbkj3dEgYiUIszqWdpZe+Z7/wB1oCYmIoboiwiLT2WjKl/jscrHfGg/pKdMkyklC5Zs2LEfHYpjcRoPzme9MWWmk3dWbK9ObkWkikOetJ554fWyoEsmdSlt+uR0pCJR34b6t/TVg1SY3sYvdf8vuiKrpyaDXDISiegp17p7579Gp3p++y7HPAiY9pmTibljrr85qSidtlg4+l25GLCaS8e6rRxNBmsnERunKbaOObRz7N72ju5vdAjYpBXHgJylOAVsMseDAPEP8LYoUHicY2BiAAEfhiAGJgZWBgZ7RnFRdnVJELCQlBSRlATJMoLV2DK4glSYs6ubq5vbKrJLSbGrgEmovDuDJVhe3VzcXFwNLCOILB/C4IuQ1xTn5FPilBTj5FPmBAB4WwoqAHicY2BkYGAA4sk1sR/j+W2+MnAzpDBgAyEMQUCSg4EJxAEAwUgFHgB4nGNgZGBgSGFggJMhDIwMqEAYAByHATJ4nGNgAIIUNEwmAABl3AGReJxjYAACIQYlBiMGJ3wQAEcQBEV4nGNgZGBgEGZgY2BiAAEQyQWEDAz/wXwGAAsPATIAAHicXdBNSsNAHAXwl35iA0UQXYnMShfS9GPZA7T7LgIu03SSpkwzYTIt1BN4Ak/gKTyAeCxfw39jZkjymzcvAwmAW/wgwHUEGDb36+jQQ3GXGot79L24jxCP4gHzF/EIr4jEIe7wxhOC3g2TMYy4Q7+Lu/SHuEd/ivt4wJd4wPxbPEKMX3GI5+DJFGaSn4qNzk8mcbKSR6xdXdhSzaOZJGtdapd4vVPbi6rP+cL7TGXOHtXKll4bY1Xl7EGnPtp7Xy2n00zyKLVHfkHBa4IcJ2oD3cgggWvt/V/FbDrUlEUJhTn/0azVWbNTNr0Ens8de1tceK9xZmfB1CPjOmPH4kitmvOubcNpmVTN3oFJyjzCvnmrwhJTzqzVj9jiSX911FjeAAB4nG3HMRKCMBBA0f0giiKi4DU8k0V2GWbIZDOh4PoWWvq6J5V8If9NVNQcaDhyouXMhY4rPTcG7jwYmXhKq8Wz+p762aNaeYXom2n3m2dLTVgsrCgFJ7OTmIkYbwIbC6vIB7WmFfAAAA==") format("woff");\n}'),Z_=!0),i?i.appendChild(this.domElement):e&&(this.domElement.classList.add("autoPlace"),document.body.appendChild(this.domElement)),s&&this.domElement.style.setProperty("--width",s+"px"),this._closeFolders=n}add(t,e,i,s,r){if(Object(i)===i)return new q_(this,t,e,i);const n=t[e];switch(typeof n){case"number":return new j_(this,t,e,i,s,r);case"boolean":return new U_(this,t,e);case"string":return new Y_(this,t,e);case"function":return new H_(this,t,e)}console.error("gui.add failed\n\tproperty:",e,"\n\tobject:",t,"\n\tvalue:",n)}addColor(t,e,i=1){return new W_(this,t,e,i)}addFolder(t){const e=new K_({parent:this,title:t});return this.root._closeFolders&&e.close(),e}load(t,e=!0){return t.controllers&&this.controllers.forEach((e=>{e instanceof H_||e._name in t.controllers&&e.load(t.controllers[e._name])})),e&&t.folders&&this.folders.forEach((e=>{e._title in t.folders&&e.load(t.folders[e._title])})),this}save(t=!0){const e={controllers:{},folders:{}};return this.controllers.forEach((t=>{if(!(t instanceof H_)){if(t._name in e.controllers)throw new Error(`Cannot save GUI with duplicate property "${t._name}"`);e.controllers[t._name]=t.save()}})),t&&this.folders.forEach((t=>{if(t._title in e.folders)throw new Error(`Cannot save GUI with duplicate folder "${t._title}"`);e.folders[t._title]=t.save()})),e}open(t=!0){return this._setClosed(!t),this.$title.setAttribute("aria-expanded",!this._closed),this.domElement.classList.toggle("closed",this._closed),this}close(){return this.open(!1)}_setClosed(t){this._closed!==t&&(this._closed=t,this._callOnOpenClose(this))}show(t=!0){return this._hidden=!t,this.domElement.style.display=this._hidden?"none":"",this}hide(){return this.show(!1)}openAnimated(t=!0){return this._setClosed(!t),this.$title.setAttribute("aria-expanded",!this._closed),requestAnimationFrame((()=>{const e=this.$children.clientHeight;this.$children.style.height=e+"px",this.domElement.classList.add("transition");const i=t=>{t.target===this.$children&&(this.$children.style.height="",this.domElement.classList.remove("transition"),this.$children.removeEventListener("transitionend",i))};this.$children.addEventListener("transitionend",i);const s=t?this.$children.scrollHeight:0;this.domElement.classList.toggle("closed",!t),requestAnimationFrame((()=>{this.$children.style.height=s+"px"}))})),this}title(t){return this._title=t,this.$title.textContent=t,this}reset(t=!0){return(t?this.controllersRecursive():this.controllers).forEach((t=>t.reset())),this}onChange(t){return this._onChange=t,this}_callOnChange(t){this.parent&&this.parent._callOnChange(t),void 0!==this._onChange&&this._onChange.call(this,{object:t.object,property:t.property,value:t.getValue(),controller:t})}onFinishChange(t){return this._onFinishChange=t,this}_callOnFinishChange(t){this.parent&&this.parent._callOnFinishChange(t),void 0!==this._onFinishChange&&this._onFinishChange.call(this,{object:t.object,property:t.property,value:t.getValue(),controller:t})}onOpenClose(t){return this._onOpenClose=t,this}_callOnOpenClose(t){this.parent&&this.parent._callOnOpenClose(t),void 0!==this._onOpenClose&&this._onOpenClose.call(this,t)}destroy(){this.parent&&(this.parent.children.splice(this.parent.children.indexOf(this),1),this.parent.folders.splice(this.parent.folders.indexOf(this),1)),this.domElement.parentElement&&this.domElement.parentElement.removeChild(this.domElement),Array.from(this.children).forEach((t=>t.destroy()))}controllersRecursive(){let t=Array.from(this.controllers);return this.folders.forEach((e=>{t=t.concat(e.controllersRecursive())})),t}foldersRecursive(){let t=Array.from(this.folders);return this.folders.forEach((e=>{t=t.concat(e.foldersRecursive())})),t}}class Q_{_deviceList;_params;_gui;constructor(){this._deviceList=["WebGL","WebGL2","WebGPU"],this._params={deviceType:this._deviceList[this._deviceList.findIndex((t=>t.toLowerCase()===q.instance.device.type))]},this._gui=new K_({container:document.body}),this.create()}create(){const t=document.createElement("p");t.style.marginTop="1.5rem",t.style.padding="0.5rem",t.style.color="#ffff00",t.innerText="Rotate with left mouse button.";const e=document.createElement("p");e.style.marginBottom="1rem",e.style.padding="0.5rem",e.style.color="#ffff00",e.innerText="Move with right mouse button.",this._gui.domElement.append(t,e);this._gui.addFolder("System").add(this._params,"deviceType",this._deviceList).name("Select device").onChange((t=>{const e=new URL(window.location.href);e.searchParams.set("dev",t.toLowerCase()),window.location.href=e.href}))}}class J_{_assetManager;_scene;_terrain;_camera;_character;_compositor;_axisPZ;_actorTarget;_actorDirection;_actorSpeed;_actorRunning;_loaded;_loadPercent;_ui;_lastAnimation;constructor(){this._terrain=null,this._axisPZ=b.axisPZ(),this._actorTarget=new b,this._actorDirection=new b,this._actorSpeed=6,this._actorRunning=!1,this._assetManager=new Wl,this._scene=this.createScene(),this._camera=this.createCamera(this._scene),this._compositor=new Zl,this._compositor.appendPostEffect(new jl),this._compositor.appendPostEffect(new ql),this._compositor.appendPostEffect(new Yl),q.instance.device.setFont("24px arial"),this.render(),this._loaded=!1,this._loadPercent=0,this._ui=null,this._lastAnimation=null}async fetchAssetArchive(t,e){e(0);const i=await fetch(t);if(!i.ok)throw new Error("Download failed");const s=i.headers.get("content-length"),r=s?parseInt(s,10):0;let n=0,a=new Uint8Array(r||1048576);const o=i.body.getReader();if(!o)throw new Error("Download data is empty");const h=async()=>{const{done:t,value:i}=await o.read();if(!t){if(a.length<n+i.length){const t=new Uint8Array(Math.max(2*a.length,n+i.length));t.set(a),a=t}return a.set(i,n),n+=i.length,e(Math.floor(n/r*100)),h()}};return await h(),new Blob([a])}async readZip(t){const e=new y_(new Gf(t)),i=await e.getEntries(),s=new Map;for(const t of i)if(!t.directory){const e=await t.getData(new Xf),i=URL.createObjectURL(e);s.set(`/${t.filename}`,i)}return await e.close(),s}get camera(){return this._camera}createScene(){const t=new Ah;t.env.light.type="ibl",t.env.light.strength=1,t.env.light.radianceMap=t.env.sky.radianceMap,t.env.light.irradianceMap=t.env.sky.irradianceMap,t.env.sky.skyType="scatter",t.env.sky.fogType="scatter",t.env.sky.aerialPerspectiveDensity=10,t.env.sky.cloudy=.6;const e=new Ih(t).setColor(new T(1,1,1,1));return e.lookAt(new b(1,1,1),new b(0,0,0),b.axisPY()),e.intensity=4,e.shadow.shadowMapSize=2048,e.shadow.numShadowCascades=4,e.shadow.shadowDistance=300,e.castShadow=!0,e.shadow.mode="pcf-opt",t}createCamera(t){return new ph(t,Math.PI/3,q.instance.device.getDrawingBufferWidth()/q.instance.device.getDrawingBufferHeight(),1,1500)}async load(){this._loaded=!1,this._loadPercent=0;const t=await this.fetchAssetArchive("./assets/terrain_assets.zip",(t=>{this._loadPercent=t}));q.instance.device.runNextFrame((async()=>{const e=await this.readZip(t);this._assetManager.httpRequest.urlResolver=t=>e.get(t)||t,this._terrain=await this.loadTerrain(this._scene,this._assetManager),this._character=await this.loadCharacter(this._scene,this._assetManager),this._camera.parent=this._terrain,this._character.group.parent=this._terrain;const i=.37*this._terrain.scaledWidth,s=.19*this._terrain.scaledHeight,r=this._terrain.getElevation(i,s);this._character.group.position.setXYZ(i,r,s),this.idle();const n=new b(i+1,r+5,s-21),a=new b(i,r,s);this._camera.lookAt(n,a,b.axisPY()),this._camera.controller=new sl({center:a}),this._terrain.showState="visible",this._scene.env.sky.wind.setXY(700,350),this._loaded=!0}))}playAnimation(t){this._lastAnimation!==t&&(this._lastAnimation&&this._character.animationSet.stopAnimation(this._lastAnimation,{fadeOut:.3}),this._character.animationSet.playAnimation(t,{fadeIn:.3}),this._lastAnimation=t)}idle(){this.playAnimation("idle01_yindao")}run(){this.playAnimation("run_front")}async loadCharacter(t,e){const i=await e.fetchModel(t,"/assets/models/alice_shellfire/scene.gltf");return i.group.scale.setXYZ(2,2,2),i}async loadTerrain(t,e){const i=1025,s=1025,r=await e.fetchBinaryData("/assets/maps/map3/heightmap.raw"),n=new Uint16Array(r),a=new Float32Array(1050625);for(let t=0;t<1050625;t++)a[t]=n[t]/65535;const o=await e.fetchTexture("/assets/maps/map3/857caeb1.dds"),h=await e.fetchTexture("/assets/maps/map3/grass1x.dds"),l=await e.fetchTexture("/assets/maps/map3/gj02.dds"),u=await e.fetchTexture("/assets/maps/map3/splatmap.tga",{linearColorSpace:!0}),c=await e.fetchTexture("/assets/maps/map3/grass_color.png",{linearColorSpace:!1}),d=await e.fetchTexture("/assets/maps/map3/grass_norm.png",{linearColorSpace:!0}),p=await e.fetchTexture("/assets/maps/map3/28.png",{linearColorSpace:!1}),m=await e.fetchTexture("/assets/maps/map3/29.png",{linearColorSpace:!0}),f=await e.fetchTexture("/assets/maps/map3/174.jpg",{linearColorSpace:!1}),_=await e.fetchTexture("/assets/maps/map3/174_norm.jpg",{linearColorSpace:!0}),g=new Xh(t);g.showState="hidden",g.create(i,s,a,new b(1,100,1),33,{splatMap:u,detailMaps:{albedoTextures:[c,p,f],normalTextures:[d,m,_],uvScale:[120,120,120],normalScale:[2,5,.5],metallic:[0,0,0],roughness:[.95,.9,.7],grass:[[{bladeWidth:2,bladeHeigh:2,density:1.2,offset:-.1,texture:o},{bladeWidth:2,bladeHeigh:3,density:.06,offset:-.02,texture:h}],[{bladeWidth:2,bladeHeigh:2,density:.6,offset:0,texture:l}]]}}),g.maxPixelError=6,g.castShadow=!0,g.pickable=!0;const x=b.axisPY(),w=[{url:"/assets/models/stylized_tree.glb",scale:1.5}],T=1/w.length,y=new X(0);for(let i=0;i<500;i++){const i=y.get()*g.scaledWidth,s=y.get()*g.scaledHeight,r=g.getElevation(i,s),n=Math.min(Math.floor(y.get()/T),w.length-1),a=await e.fetchModel(t,w[n].url,{postProcess:this.replaceMaterials});a.group.parent=g,a.group.pickable=!1,a.group.position.setXYZ(i,r,s),a.group.scale.setXYZ(w[n].scale,w[n].scale,w[n].scale),a.group.rotation=v.fromAxisAngle(x,2*y.get()*Math.PI)}return g}replaceMaterials(t){function e(t){if(t.mesh)for(const e of t.mesh.subMeshes){const t=e.material,i="blend"===t.blendMode||t.alphaCutoff>0;if(t instanceof Eo&&t.albedoTexture&&i){const i=new B_;i.textureWidth=t.albedoTexture.width,i.textureHeight=t.albedoTexture.height,i.blendMode="none",i.alphaCutoff=.8,i.cullMode="none",i.ior=t.ior,i.specularFactor=t.specularFactor,i.albedoColor=t.albedoColor,i.albedoTexCoordIndex=t.albedoTexCoordIndex,i.albedoTexCoordMatrix=t.albedoTexCoordMatrix,i.albedoTexture=t.albedoTexture,i.albedoTextureSampler=t.albedoTextureSampler,i.normalTexture=t.normalTexture,i.normalTexCoordIndex=t.normalTexCoordIndex,i.normalTexCoordMatrix=t.normalTexCoordMatrix,i.normalTextureSampler=t.normalTextureSampler,i.normalScale=t.normalScale,i.occlusionTexture=t.occlusionTexture,i.occlusionTexCoordIndex=t.occlusionTexCoordIndex,i.occlusionTexCoordMatrix=t.occlusionTexCoordMatrix,i.occlusionTextureSampler=t.occlusionTextureSampler,i.metallicRoughnessTexture=t.metallicRoughnessTexture,i.metallicRoughnessTexCoordIndex=t.metallicRoughnessTexCoordIndex,i.metallicRoughnessTexCoordMatrix=t.metallicRoughnessTexCoordMatrix,i.metallicRoughnessTextureSampler=t.metallicRoughnessTextureSampler,i.specularTexture=t.specularTexture,i.specularTexCoordIndex=t.specularTexCoordIndex,i.specularTexCoordMatrix=t.specularTexCoordMatrix,i.specularTextureSampler=t.specularTextureSampler,i.specularColorTexture=t.specularColorTexture,i.specularColorTexCoordIndex=t.specularColorTexCoordIndex,i.specularColorTexCoordMatrix=t.specularColorTexCoordMatrix,i.specularColorTextureSampler=t.specularColorTextureSampler,i.metallic=0,i.roughness=1,e.material=i}else if(t instanceof Co&&t.albedoTexture&&i){const i=new B_;i.textureWidth=t.albedoTexture.width,i.textureHeight=t.albedoTexture.height,i.blendMode="none",i.alphaCutoff=.8,i.cullMode="none",i.ior=t.ior,i.specularFactor=t.specularFactor,i.albedoColor=t.albedoColor,i.albedoTexCoordIndex=t.albedoTexCoordIndex,i.albedoTexCoordMatrix=t.albedoTexCoordMatrix,i.albedoTexture=t.albedoTexture,i.albedoTextureSampler=t.albedoTextureSampler,i.normalTexture=t.normalTexture,i.normalTexCoordIndex=t.normalTexCoordIndex,i.normalTexCoordMatrix=t.normalTexCoordMatrix,i.normalTextureSampler=t.normalTextureSampler,i.normalScale=t.normalScale,i.occlusionTexture=t.occlusionTexture,i.occlusionTexCoordIndex=t.occlusionTexCoordIndex,i.occlusionTexCoordMatrix=t.occlusionTexCoordMatrix,i.occlusionTextureSampler=t.occlusionTextureSampler,i.specularTexture=t.specularTexture,i.specularTexCoordIndex=t.specularTexCoordIndex,i.specularTexCoordMatrix=t.specularTexCoordMatrix,i.specularTextureSampler=t.specularTextureSampler,i.metallic=0,i.roughness=1,e.material=i}}for(const i of t.children)e(i)}for(const i of t.nodes)e(i);return t}handlePointerUp(t,e,i){if(!this._loaded)return;const s=this._camera.constructRay(e,i),r=this._scene.raycast(s,this._camera.getFarPlane());r&&r.node.isTerrain()&&(this._terrain.invWorldMatrix.transformPointAffine(r.point,this._actorTarget),2===t&&(this._actorDirection.set(b.mul(b.sub(this._actorTarget,this._character.group.position),new b(1,0,1)).inplaceNormalize()),this._character.group.rotation=v.unitVectorToUnitVector(this._axisPZ,this._actorDirection),this.run(),this._actorRunning=!0))}updateCharacter(){if(this._loaded&&this._actorRunning){const t=b.distance(b.mul(this._character.group.position,new b(1,0,1)),b.mul(this._actorTarget,new b(1,0,1)));let e=q.instance.device.frameInfo.elapsedFrame*this._actorSpeed/1e3;e>=t&&(this._actorRunning=!1,e=t,this.idle());const i=b.add(this._character.group.position,b.scale(this._actorDirection,e));i.y=this._terrain.getElevation(i.x,i.z),this._character.group.position.set(i),this._camera.controller.center=i}}updateCamera(){this._camera.updateController();const t=this._terrain.getElevation(this._camera.position.x,this._camera.position.z);this._camera.position.y<t+2&&(this._camera.position.y=t+2)}render(){this._loaded&&(this.updateCharacter(),this.updateCamera()),this._camera.render(this._scene,this._compositor),this._loaded?this._ui||(this._ui=new Q_):q.instance.device.drawText(`Loading: %${this._loadPercent}`,20,20,"#a00000")}}const tg=new q({backend:function(){const t=(e="dev",new URL(window.location.toString()).searchParams.get(e)||null||"webgl");var e;if("webgpu"===t){if(Cc.supported())return Cc;console.warn("No WebGPU support, fall back to WebGL2")}if("webgl2"===t){if(Ld.supported())return Ld;console.warn("No WebGL2 support, fall back to WebGL1")}return $d}(),canvas:document.querySelector("#canvas"),enableMSAA:!1});tg.ready().then((async()=>{const t=new J_;tg.device.canvas.addEventListener("contextmenu",(function(t){return t.preventDefault(),!1})),tg.inputManager.use(t.camera.handleEvent.bind(t.camera)),tg.on("pointerup",(e=>{t.handlePointerUp(e.button,e.offsetX,e.offsetY)})),q.instance.device.canvas.addEventListener("contextmenu",(function(t){return t.preventDefault(),!1})),tg.on("resize",(e=>{t.camera.aspect=e.width/e.height})),tg.on("tick",(e=>{t.render()})),t.load(),tg.run()}));
//# sourceMappingURL=demo-3.js.map
