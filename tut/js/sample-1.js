const e={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32",transparent:"rgba(0,0,0,0)"};function t(e,t){if(!e)throw new Error(t||"Assertion failed")}class r{_listeners;constructor(){this._listeners=null}on(e,t,r){t?this._listeners=this._internalAddEventListener(this._listeners,e,t,{context:r??null,once:!1}):console.error("Cannot set NULL listener")}once(e,t,r){t?this._listeners=this._internalAddEventListener(this._listeners,e,t,{context:r??null,once:!0}):console.error("Cannot set NULL listener")}off(e,t,r){this._internalRemoveEventListener(this._listeners,e,t,r??null)}dispatchEvent(e,...t){this._invokeLocalListeners(e,...t)}_internalAddEventListener(e,t,r,s){if("string"!=typeof t)return;e||(e={});const i=r,n={...s};let a=e[t];return a||(e[t]=a=[]),a.push({handler:i,options:n,removed:!1}),e}_internalRemoveEventListener(e,t,r,s){if("string"!=typeof t||!e)return;const i=r,n=e[t];if(n){for(let e=0;e<n.length;e++){const t=n[e];if(t.handler===i&&t.options.context===s){n.splice(e,1);break}}0===n.length&&(e[t]=void 0)}}_invokeLocalListeners(e,...t){if(!this._listeners)return;const r=this._listeners[e];if(r&&r.length>0){const e=r.slice();for(const r of e)r.handler.call(r.options?.context||this,...t),r.options.once&&(r.removed=!0);for(let e=r.length-1;e>=0;e--)r[e].removed&&r.splice(e,1)}}}function s(e){return e%1==0&&e>=0&&!(e&e-1)}var i=function(e){return e[e.PX=0]="PX",e[e.NX=1]="NX",e[e.PY=2]="PY",e[e.NY=3]="NY",e[e.PZ=4]="PZ",e[e.NZ=5]="NZ",e}({});const n=new Float32Array([1,0,0,0,1,0,0,0,1]),a=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class o extends Float32Array{equalsTo(e,t){if(!e||this.length!==e.length)return!1;if(this===e)return!0;for(let r=0;r<this.length;r++){const s=this[r],i=e[r],n=t??1e-4*Math.max(1,Math.abs(s),Math.abs(i));if(Math.abs(s-i)>n)return!1}return!0}toString(){const e=[...this].map(e=>e.toFixed(3));return`${this.constructor.name}{${e.join(",")}}`}isNaN(){for(let e=0;e<this.length;e++)if(Number.isNaN(this[e]))return!0;return!1}setRandom(e,t){for(let r=0;r<this.length;r++)this[r]=e+(t-e)*Math.random()}}class u extends o{constructor(e,t){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,2);else if(super(2),"number"==typeof e&&"number"==typeof t)this[0]=e,this[1]=t;else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=2)this[0]=e[0],this[1]=e[1];else if(void 0!==e)throw new Error("Vector2.constructor(): invalid arguments")}clone(){return new u(this)}get x(){return this[0]}set x(e){this[0]=e}get y(){return this[1]}set y(e){this[1]=e}get magnitude(){return Math.hypot(this[0],this[1])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]}setXY(e,t){return this[0]=e,this[1]=t,this}setAndNormalize(e,t){const r=Math.hypot(e,t);return this.setXY(e/r,t/r)}subBy(e){return u.sub(this,e,this),this}addBy(e){return u.add(this,e,this),this}combineBy(e,t,r){return u.combine(this,e,t,r,this),this}mulBy(e){return u.mul(this,e,this),this}divBy(e){return u.div(this,e,this),this}scaleBy(e){return u.scale(this,e,this),this}inplaceNormalize(){return u.normalize(this,this),this}inplaceInverse(){return u.inverse(this,this),this}inplaceMin(e){return u.min(this,e,this),this}inplaceMax(e){return u.max(this,e,this),this}static zero(){return new u(0,0)}static one(){return new u(1,1)}static axisPX(){return new u(1,0)}static axisNX(){return new u(-1,0)}static axisPY(){return new u(0,1)}static axisNY(){return new u(0,-1)}static distance(e,t){return Math.hypot(e.x-t.x,e.y-t.y)}static distanceSq(e,t){const r=e.x-t.x,s=e.y-t.y;return r*r+s*s}static normalize(e,t){const r=e.magnitude,s=e.x/r,i=e.y/r;return(t||new u).setXY(s,i)}static inverse(e,t){const r=1/e.x,s=1/e.y;return(t||new u).setXY(r,s)}static sub(e,t,r){const s=e.x-t.x,i=e.y-t.y;return(r||new u).setXY(s,i)}static add(e,t,r){const s=e.x+t.x,i=e.y+t.y;return(r||new u).setXY(s,i)}static combine(e,t,r,s,i){const n=e.x*r+t.x*s,a=e.y*r+t.y*s;return(i||new u).setXY(n,a)}static mul(e,t,r){const s=e.x*t.x,i=e.y*t.y;return(r||new u).setXY(s,i)}static div(e,t,r){const s=e.x/t.x,i=e.y/t.y;return(r||new u).setXY(s,i)}static scale(e,t,r){const s=e.x*t,i=e.y*t;return(r||new u).setXY(s,i)}static min(e,t,r){const s=e.x<t.x?e.x:t.x,i=e.y<t.y?e.y:t.y;return(r||new u).setXY(s,i)}static max(e,t,r){const s=e.x>t.x?e.x:t.x,i=e.y>t.y?e.y:t.y;return(r||new u).setXY(s,i)}static abs(e,t){const r=e.x<0?-e.x:e.x,s=e.y<0?-e.y:e.y;return(t||new u).setXY(r,s)}static dot(e,t){return e.x*t.x+e.y*t.y}static cross(e,t){return e.x*t.y-e.y*t.x}}class h extends o{constructor(e,t,r){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,3);else if(super(3),"number"==typeof e&&"number"==typeof t&&"number"==typeof r)this[0]=e,this[1]=t,this[2]=r;else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=3)this[0]=e[0],this[1]=e[1],this[2]=e[2];else if(void 0!==e)throw new Error("Vector3.constructor(): invalid arguments")}clone(){return new h(this)}get x(){return this[0]}set x(e){this[0]=e}get y(){return this[1]}set y(e){this[1]=e}get z(){return this[2]}set z(e){this[2]=e}get magnitude(){return Math.hypot(this[0],this[1],this[2])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]}xy(){return new u(this.x,this.y)}setXYZ(e,t,r){return this[0]=e,this[1]=t,this[2]=r,this}setAndNormalize(e,t,r){const s=Math.hypot(e,t,r);return this.setXYZ(e/s,t/s,r/s)}subBy(e){return h.sub(this,e,this),this}addBy(e){return h.add(this,e,this),this}combineBy(e,t,r){return h.combine(this,e,t,r,this),this}mulBy(e){return h.mul(this,e,this),this}divBy(e){return h.div(this,e,this),this}scaleBy(e){return h.scale(this,e,this),this}inplaceNormalize(){return h.normalize(this,this),this}inplaceInverse(){return h.inverse(this,this),this}inplaceMin(e){return h.min(this,e,this),this}inplaceMax(e){return h.max(this,e,this),this}static zero(){return new h(0,0,0)}static one(){return new h(1,1,1)}static axisPX(){return new h(1,0,0)}static axisNX(){return new h(-1,0,0)}static axisPY(){return new h(0,1,0)}static axisNY(){return new h(0,-1,0)}static axisPZ(){return new h(0,0,1)}static axisNZ(){return new h(0,0,-1)}static distance(e,t){return Math.hypot(e.x-t.x,e.y-t.y,e.z-t.z)}static distanceSq(e,t){const r=e.x-t.x,s=e.y-t.y,i=e.z-t.z;return r*r+s*s+i*i}static normalize(e,t){const r=e.magnitude,s=e.x/r,i=e.y/r,n=e.z/r;return(t||new h).setXYZ(s,i,n)}static inverse(e,t){const r=1/e.x,s=1/e.y,i=1/e.z;return(t||new h).setXYZ(r,s,i)}static sub(e,t,r){const s=e.x-t.x,i=e.y-t.y,n=e.z-t.z;return(r||new h).setXYZ(s,i,n)}static add(e,t,r){const s=e.x+t.x,i=e.y+t.y,n=e.z+t.z;return(r||new h).setXYZ(s,i,n)}static combine(e,t,r,s,i){const n=e.x*r+t.x*s,a=e.y*r+t.y*s,o=e.z*r+t.z*s;return(i||new h).setXYZ(n,a,o)}static mul(e,t,r){const s=e.x*t.x,i=e.y*t.y,n=e.z*t.z;return(r||new h).setXYZ(s,i,n)}static div(e,t,r){const s=e.x/t.x,i=e.y/t.y,n=e.z/t.z;return(r||new h).setXYZ(s,i,n)}static scale(e,t,r){const s=e.x*t,i=e.y*t,n=e.z*t;return(r||new h).setXYZ(s,i,n)}static min(e,t,r){const s=e.x<t.x?e.x:t.x,i=e.y<t.y?e.y:t.y,n=e.z<t.z?e.z:t.z;return(r||new h).setXYZ(s,i,n)}static max(e,t,r){const s=e.x>t.x?e.x:t.x,i=e.y>t.y?e.y:t.y,n=e.z>t.z?e.z:t.z;return(r||new h).setXYZ(s,i,n)}static abs(e,t){const r=e.x<0?-e.x:e.x,s=e.y<0?-e.y:e.y,i=e.z<0?-e.z:e.z;return(t||new h).setXYZ(r,s,i)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static cross(e,t,r){const s=e.y*t.z-e.z*t.y,i=e.z*t.x-e.x*t.z,n=e.x*t.y-e.y*t.x;return(r||new h).setXYZ(s,i,n)}}class l extends o{constructor(e,t,r,s){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,4);else if(super(4),"number"==typeof e&&"number"==typeof t&&"number"==typeof r&&"number"==typeof s)this[0]=e,this[1]=t,this[2]=r,this[3]=s;else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=4)this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3];else if(void 0!==e)throw new Error("Vector4.constructor(): invalid arguments")}clone(){return new l(this)}get x(){return this[0]}set x(e){this[0]=e}get y(){return this[1]}set y(e){this[1]=e}get z(){return this[2]}set z(e){this[2]=e}get w(){return this[3]}set w(e){this[3]=e}get magnitude(){return Math.hypot(this[0],this[1],this[2],this[3])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3]}xy(){return new u(this.x,this.y)}xyz(){return new h(this.x,this.y,this.z)}setXYZW(e,t,r,s){return this[0]=e,this[1]=t,this[2]=r,this[3]=s,this}setAndNormalize(e,t,r,s){const i=Math.hypot(e,t,r,s);return this.setXYZW(e/i,t/i,r/i,s/i)}subBy(e){return l.sub(this,e,this),this}addBy(e){return l.add(this,e,this),this}combineBy(e,t,r){return l.combine(this,e,t,r,this),this}mulBy(e){return l.mul(this,e,this),this}divBy(e){return l.div(this,e,this),this}scaleBy(e){return l.scale(this,e,this),this}inplaceNormalize(){return l.normalize(this,this),this}inplaceInverse(){return l.inverse(this,this),this}inplaceMin(e){return l.min(this,e,this),this}inplaceMax(e){return l.max(this,e,this),this}static zero(){return new l(0,0,0,0)}static one(){return new l(1,1,1,1)}static axisPX(){return new l(1,0,0,0)}static axisNX(){return new l(-1,0,0,0)}static axisPY(){return new l(0,1,0,0)}static axisNY(){return new l(0,-1,0,0)}static axisPZ(){return new l(0,0,1,0)}static axisNZ(){return new l(0,0,-1,0)}static axisPW(){return new l(0,0,0,1)}static axisNW(){return new l(0,0,0,-1)}static normalize(e,t){const r=e.magnitude,s=e.x/r,i=e.y/r,n=e.z/r,a=e.w/r;return(t||new l).setXYZW(s,i,n,a)}static inverse(e,t){const r=1/e.x,s=1/e.y,i=1/e.z,n=1/e.w;return(t||new l).setXYZW(r,s,i,n)}static sub(e,t,r){const s=e.x-t.x,i=e.y-t.y,n=e.z-t.z,a=e.w-t.w;return(r||new l).setXYZW(s,i,n,a)}static add(e,t,r){const s=e.x+t.x,i=e.y+t.y,n=e.z+t.z,a=e.w+t.w;return(r||new l).setXYZW(s,i,n,a)}static combine(e,t,r,s,i){const n=e.x*r+t.x*s,a=e.y*r+t.y*s,o=e.z*r+t.z*s,u=e.w*r+t.w*s;return(i||new l).setXYZW(n,a,o,u)}static mul(e,t,r){const s=e.x*t.x,i=e.y*t.y,n=e.z*t.z,a=e.w*t.w;return(r||new l).setXYZW(s,i,n,a)}static div(e,t,r){const s=e.x/t.x,i=e.y/t.y,n=e.z/t.z,a=e.w/t.w;return(r||new l).setXYZW(s,i,n,a)}static scale(e,t,r){const s=e.x*t,i=e.y*t,n=e.z*t,a=e.w*t;return(r||new l).setXYZW(s,i,n,a)}static min(e,t,r){const s=e.x<t.x?e.x:t.x,i=e.y<t.y?e.y:t.y,n=e.z<t.z?e.z:t.z,a=e.w<t.w?e.w:t.w;return(r||new l).setXYZW(s,i,n,a)}static max(e,t,r){const s=e.x>t.x?e.x:t.x,i=e.y>t.y?e.y:t.y,n=e.z>t.z?e.z:t.z,a=e.w>t.w?e.w:t.w;return(r||new l).setXYZW(s,i,n,a)}static abs(e,t){const r=e.x<0?-e.x:e.x,s=e.y<0?-e.y:e.y,i=e.z<0?-e.z:e.z,n=e.w<0?-e.w:e.w;return(t||new l).setXYZW(r,s,i,n)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}}class c extends o{constructor(e,t,r,s){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,4);else if(super(4),"number"==typeof e&&"number"==typeof t&&"number"==typeof r&&"number"==typeof s)this[0]=e,this[1]=t,this[2]=r,this[3]=s;else if(e instanceof _||e instanceof p)this.fromRotationMatrix(e);else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=4)this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3];else{if(void 0!==e)throw new Error("Quaternion.constructor(): invalid arguments");this[0]=0,this[1]=0,this[2]=0,this[3]=1}}clone(){return new c(this)}get x(){return this[0]}set x(e){this[0]=e}get y(){return this[1]}set y(e){this[1]=e}get z(){return this[2]}set z(e){this[2]=e}get w(){return this[3]}set w(e){this[3]=e}setXYZW(e,t,r,s){return this[0]=e,this[1]=t,this[2]=r,this[3]=s,this}scaleBy(e){return c.scale(this,e,this),this}setAndNormalize(e,t,r,s){const i=Math.hypot(e,t,r,s);return this.setXYZW(e/i,t/i,r/i,s/i)}get magnitude(){return Math.hypot(this[0],this[1],this[2],this[3])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3]}identity(){return c.identity(this),this}inplaceNormalize(){return c.normalize(this,this),this}inplaceConjugate(){return c.conjugate(this,this),this}multiplyRight(e){return c.multiply(this,e,this),this}multiplyLeft(e){return c.multiply(e,this,this),this}unitVectorToUnitVector(e,t){return c.unitVectorToUnitVector(e,t,this),this}fromEulerAngle(e,t,r,s="ZYX"){return c.fromEulerAngle(e,t,r,s,this),this}fromAxisAngle(e,t){return c.fromAxisAngle(e,t,this),this}toAxisAngle(e){const t=2*Math.acos(this[3]),r=Math.sin(t/2);return r>1e-6?e.setXYZ(this[0]/r,this[1]/2,this[2]/r):e.setXYZ(1,0,0),t}toEulerAngles(e){e=e??new h;const t=2*(this.w*this.x+this.y*this.z),r=1-2*(this.x*this.x+this.y*this.y),s=Math.atan2(t,r),i=Math.max(-1,Math.min(1,2*(this.w*this.y-this.z*this.x))),n=Math.asin(i),a=2*(this.w*this.z+this.x*this.y),o=1-2*(this.y*this.y+this.z*this.z),u=Math.atan2(a,o);return e.setXYZ(s,n,u)}fromRotationMatrix(e){return c.fromRotationMatrix(e,this),this}toMatrix3x3(e){const t=e||new _;return this.toMatrix(t),t}toMatrix4x4(e){const t=e||p.identity();return this.toMatrix(t),t.m03=0,t.m13=0,t.m23=0,t.m30=0,t.m31=0,t.m32=0,t.m33=1,t}getDirectionX(e){return(e=e??new h).setXYZ(1-2*(this.y*this.y+this.z*this.z),2*(this.x*this.y+this.z*this.w),2*(this.z*this.x-this.y*this.w))}getDirectionY(e){return(e=e??new h).setXYZ(2*(this.x*this.y-this.z*this.w),1-2*(this.z*this.z+this.x*this.x),2*(this.y*this.z+this.x*this.w))}getDirectionZ(e){return(e=e??new h).setXYZ(2*(this.z*this.x+this.y*this.w),2*(this.y*this.z-this.x*this.w),1-2*(this.y*this.y+this.x*this.x))}getAxisAngle(e){e=e??new l;const t=this.w<0?-1:1,r=this.x*t,s=this.y*t,i=this.z*t,n=this.w*t,a=Math.acos(n),o=Math.sin(a);return e.setXYZW(r/o,s/o,i/o,2*a)}transform(e,t){t=t||new h;const r=2*this.x,s=2*this.y,i=2*this.z,n=this.x*r,a=this.y*s,o=this.z*i,u=this.x*s,l=this.x*i,c=this.y*i,_=this.w*r,p=this.w*s,f=this.w*i;return t.setXYZ((1-a-o)*e.x+(u-f)*e.y+(l+p)*e.z,(u+f)*e.x+(1-n-o)*e.y+(c-_)*e.z,(l-p)*e.x+(c+_)*e.y+(1-n-a)*e.z)}static scale(e,t,r){return(r=r||e).setXYZW(e.x*t,e.y*t,e.z*t,e.w*t)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static identity(e){return(e||new c).setXYZW(0,0,0,1)}static normalize(e,t){const r=e.magnitude;return(t||new c).setXYZW(e.x/r,e.y/r,e.z/r,e.w/r)}static conjugate(e,t){return(t||new c).setXYZW(-e.x,-e.y,-e.z,e.w)}static multiply(e,t,r){r=r||new c;const s=e.x*t.w+e.w*t.x+e.y*t.z-e.z*t.y,i=e.y*t.w+e.w*t.y+e.z*t.x-e.x*t.z,n=e.z*t.w+e.w*t.z+e.x*t.y-e.y*t.x,a=e.w*t.w-e.x*t.x-e.y*t.y-e.z*t.z;return r.setXYZW(s,i,n,a)}static slerp(e,t,r,s){if(s=s||new c,r<=0)return s.setXYZW(e.x,e.y,e.z,e.w);if(r>=1)return s.setXYZW(t.x,t.y,t.z,t.w);const i=this.dot(e,t),n=i<0?-1:1,a=e.x,o=e.y,u=e.z,h=e.w,l=t.x*n,_=t.y*n,p=t.z*n,f=t.w*n,m=i*n;if(m>=1)return s.setXYZW(a,o,u,h);const d=1-m*m;if(d<=Number.EPSILON){const i=1-r;return s.setAndNormalize(e.x*i+t.x*r,e.y*i+t.y*r,e.z*i+t.z*r,e.w*i+t.w*r)}const E=Math.sqrt(d),T=Math.atan2(E,m),x=Math.sin((1-r)*T)/E,g=Math.sin(r*T)/E;return s.setXYZW(a*x+l*g,o*x+_*g,u*x+p*g,h*x+f*g)}static angleBetween(e,t){const r=this.dot(e,t),s=r<-1?-1:r>1?1:r;return 2*Math.acos(Math.abs(s))}static unitVectorToUnitVector(e,t,r){r=r||new c;let s=h.dot(e,t)+1;return s<1e-6?(s=0,Math.abs(e.x)>Math.abs(e.z)?r.setAndNormalize(-e.y,e.x,0,s):r.setAndNormalize(0,-e.z,e.y,s)):r.setAndNormalize(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x,s)}static fromEulerAngle(e,t,r,s="ZYX",i){i=i||new c;const n=Math.cos(e/2),a=Math.cos(t/2),o=Math.cos(r/2),u=Math.sin(e/2),h=Math.sin(t/2),l=Math.sin(r/2);switch(s){case"XYZ":return i.setXYZW(u*a*o+n*h*l,n*h*o-u*a*l,n*a*l+u*h*o,n*a*o-u*h*l);case"YXZ":return i.setXYZW(u*a*o+n*h*l,n*h*o-u*a*l,n*a*l-u*h*o,n*a*o+u*h*l);case"ZXY":return i.setXYZW(u*a*o-n*h*l,n*h*o+u*a*l,n*a*l+u*h*o,n*a*o-u*h*l);case"ZYX":return i.setXYZW(u*a*o-n*h*l,n*h*o+u*a*l,n*a*l-u*h*o,n*a*o+u*h*l);case"YZX":return i.setXYZW(u*a*o+n*h*l,n*h*o+u*a*l,n*a*l-u*h*o,n*a*o-u*h*l);case"XZY":return i.setXYZW(u*a*o-n*h*l,n*h*o-u*a*l,n*a*l+u*h*o,n*a*o+u*h*l)}}static fromAxisAngle(e,t,r){r=r||new c;const s=t/2,i=Math.sin(s);return r.setXYZW(e.x*i,e.y*i,e.z*i,Math.cos(s))}static fromRotationMatrix(e,t){t=t||new c;const r=e.m00+e.m11+e.m22;let s;return r>0?(s=.5/Math.sqrt(r+1),t.setXYZW((e.m21-e.m12)*s,(e.m02-e.m20)*s,(e.m10-e.m01)*s,.25/s)):e.m00>e.m11&&e.m00>e.m22?(s=2*Math.sqrt(1+e.m00-e.m11-e.m22),t.setXYZW(.25*s,(e.m01+e.m10)/s,(e.m02+e.m20)/s,(e.m21-e.m12)/s)):e.m11>e.m22?(s=2*Math.sqrt(1-e.m00+e.m11-e.m22),t.setXYZW((e.m10+e.m01)/s,.25*s,(e.m21+e.m12)/s,(e.m02-e.m20)/s)):(s=2*Math.sqrt(1-e.m00-e.m11+e.m22),t.setXYZW((e.m02+e.m20)/s,(e.m12+e.m21)/s,.25*s,(e.m10-e.m01)/s)),t}toMatrix(e){const t=this.x*this.x,r=this.y*this.y,s=this.z*this.z,i=this.x*this.y,n=this.z*this.w,a=this.z*this.x,o=this.y*this.w,u=this.y*this.z,h=this.x*this.w;e.m00=1-2*(r+s),e.m10=2*(i+n),e.m20=2*(a-o),e.m01=2*(i-n),e.m11=1-2*(s+t),e.m21=2*(u+h),e.m02=2*(a+o),e.m12=2*(u-h),e.m22=1-2*(r+t)}}class _ extends o{constructor(e,t,r,s,i,n,a,o,u){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,9);else if(super(9),"number"==typeof e)this[0]=e,this[1]=t,this[2]=r,this[3]=s,this[4]=i,this[5]=n,this[6]=a,this[7]=o,this[8]=u;else if(e instanceof c)e.toMatrix3x3(this);else if(e instanceof p)this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[4],this[4]=e[5],this[5]=e[6],this[6]=e[8],this[7]=e[9],this[8]=e[10];else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=9)this.set(e);else{if(void 0!==e)throw new Error("Matrix3x4.constructor(): invalid arguments");this.identity()}}clone(){return new _(this)}get m00(){return this[0]}set m00(e){this[0]=e}get m10(){return this[1]}set m10(e){this[1]=e}get m20(){return this[2]}set m20(e){this[2]=e}get m01(){return this[3]}set m01(e){this[3]=e}get m11(){return this[4]}set m11(e){this[4]=e}get m21(){return this[5]}set m21(e){this[5]=e}get m02(){return this[6]}set m02(e){this[6]=e}get m12(){return this[7]}set m12(e){this[7]=e}get m22(){return this[8]}set m22(e){this[8]=e}getRow(e,t){return(t||new h).setXYZ(this[3*e],this[3*e+1],this[3*e+2])}setRow(e,t){return this[3*e]=t.x,this[3*e+1]=t.y,this[3*e+2]=t.z,this}setRowXYZ(e,t,r,s){return this[3*e]=t,this[3*e+1]=r,this[3*e+2]=s,this}getCol(e,t){return(t||new h).setXYZ(this[e],this[3+e],this[6+e])}setCol(e,t){return this[e]=t.x,this[3+e]=t.y,this[6+e]=t.z,this}setColXYZ(e,t,r,s){return this[e]=t,this[3+e]=r,this[6+e]=s,this}static add(e,t,r){r=r||new _;for(let s=0;s<9;s++)r[s]=e[s]+t[s];return r}static sub(e,t,r){r=r||new _;for(let s=0;s<9;s++)r[s]=e[s]-t[s];return r}static mul(e,t,r){r=r||new _;for(let s=0;s<9;s++)r[s]=e[s]*t[s];return r}static div(e,t,r){r=r||new _;for(let s=0;s<9;s++)r[s]=e[s]/t[s];return r}static scale(e,t,r){r=r||new _;for(let s=0;s<9;s++)r[s]=e[s]*t;return r}static identity(e){return(e=e||new _).set(n),e}static transpose(e,t){return e===(t=t||new _)?([t[1],t[3]]=[t[3],t[1]],[t[2],t[6]]=[t[6],t[2]],[t[5],t[7]]=[t[7],t[5]]):(t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8]),t}static invert(e,t){t=t||new _;const r=e[0],s=e[1],i=e[2],n=e[3],a=e[4],o=e[5],u=e[6],h=e[7],l=e[8],c=l*a-o*h,p=o*u-l*n,f=h*n-u*a,m=1/(r*c+s*p+i*f);return t[0]=c*m,t[1]=(i*h-l*s)*m,t[2]=(o*s-i*a)*m,t[3]=p*m,t[4]=(l*r-i*u)*m,t[5]=(i*n-o*r)*m,t[6]=f*m,t[7]=(s*u-h*r)*m,t[8]=(a*r-s*n)*m,t}static rotationX(e,t){t=t||new _;const r=Math.cos(e),s=Math.sin(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=r,t[5]=s,t[6]=0,t[7]=-s,t[8]=r,t}static rotationY(e,t){t=t||new _;const r=Math.cos(e),s=Math.sin(e);return t[0]=r,t[1]=0,t[2]=-s,t[3]=0,t[4]=1,t[5]=0,t[6]=s,t[7]=0,t[8]=r,t}static rotationZ(e,t){t=t||new _;const r=Math.cos(e),s=Math.sin(e);return t[0]=r,t[1]=s,t[2]=0,t[3]=-s,t[4]=r,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}static rotation(e,t,r){r=r||new _;let s=e.x,i=e.y,n=e.z;const a=Math.hypot(s,i,n);s/=a,i/=a,n/=a;const o=s*s,u=i*i,h=n*n,l=Math.cos(t),c=Math.sin(t),p=1-l;return r[0]=o+(1-o)*l,r[1]=s*i*p+n*c,r[2]=s*n*p-i*c,r[3]=s*i*p-n*c,r[4]=u+(1-u)*l,r[5]=i*n*p+s*c,r[6]=s*n*p+i*c,r[7]=i*n*p-s*c,r[8]=h+(1-h)*l,r}static multiply(e,t,r){r=r||new _;const s=e[0],i=e[1],n=e[2],a=e[3],o=e[4],u=e[5],h=e[6],l=e[7],c=e[8],p=t[0],f=t[1],m=t[2],d=t[3],E=t[4],T=t[5],x=t[6],g=t[7],y=t[8];return r[0]=s*p+a*f+h*m,r[1]=i*p+o*f+l*m,r[2]=n*p+u*f+c*m,r[3]=s*d+a*E+h*T,r[4]=i*d+o*E+l*T,r[5]=n*d+u*E+c*T,r[6]=s*x+a*g+h*y,r[7]=i*x+o*g+l*y,r[8]=n*x+u*g+c*y,r}subBy(e){return _.sub(this,e,this),this}addBy(e){return _.add(this,e,this),this}mulBy(e){return _.mul(this,e,this),this}divBy(e){return _.div(this,e,this),this}scaleBy(e){return _.scale(this,e,this),this}identity(){return _.identity(this),this}inplaceInvert(){return _.invert(this,this),this}transpose(){return _.transpose(this,this),this}multiplyRight(e){return _.multiply(this,e,this),this}multiplyLeft(e){return _.multiply(e,this,this),this}rotationX(e){return _.rotationX(e,this),this}rotationY(e){return _.rotationY(e,this),this}rotationZ(e){return _.rotationZ(e,this),this}rotation(e,t){return _.rotation(e,t,this),this}transform(e,t){return(t=t||new h).setXYZ(this[0]*e[0]+this[3]*e[1]+this[6]*e[2],this[1]*e[0]+this[4]*e[1]+this[7]*e[2],this[2]*e[0]+this[5]*e[1]+this[8]*e[2])}transformPoint(e,t){return this.transform(e,t)}transformVector(e,t){return this.transform(e,t)}}class p extends o{constructor(e,t,r,s,i,n,a,o,u,h,l,p,f,m,d,E){if(e instanceof ArrayBuffer&&"number"==typeof t)super(e,t,16);else if(super(16),"number"==typeof e)this[0]=e,this[1]=t,this[2]=r,this[3]=s,this[4]=i,this[5]=n,this[6]=a,this[7]=o,this[8]=u,this[9]=h,this[10]=l,this[11]=p,this[12]=f,this[13]=m,this[14]=d,this[15]=E;else if(e instanceof c)e.toMatrix4x4(this);else if(e instanceof _)this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=0,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=0,this.m20=e.m20,this.m21=e.m21,this.m22=e.m22,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=1;else if((e instanceof Float32Array||Array.isArray(e))&&e.length>=16)this.set(e);else{if(void 0!==e)throw new Error("Matrix4x4.constructor(): invalid arguments");this.identity()}}clone(){return new p(this)}get m00(){return this[0]}set m00(e){this[0]=e}get m10(){return this[1]}set m10(e){this[1]=e}get m20(){return this[2]}set m20(e){this[2]=e}get m30(){return this[3]}set m30(e){this[3]=e}get m01(){return this[4]}set m01(e){this[4]=e}get m11(){return this[5]}set m11(e){this[5]=e}get m21(){return this[6]}set m21(e){this[6]=e}get m31(){return this[7]}set m31(e){this[7]=e}get m02(){return this[8]}set m02(e){this[8]=e}get m12(){return this[9]}set m12(e){this[9]=e}get m22(){return this[10]}set m22(e){this[10]=e}get m32(){return this[11]}set m32(e){this[11]=e}get m03(){return this[12]}set m03(e){this[12]=e}get m13(){return this[13]}set m13(e){this[13]=e}get m23(){return this[14]}set m23(e){this[14]=e}get m33(){return this[15]}set m33(e){this[15]=e}getRow(e,t){return(t||new l).setXYZW(this[4*e],this[4*e+1],this[4*e+2],this[4*e+3])}setRow(e,t){return this[4*e]=t.x,this[4*e+1]=t.y,this[4*e+2]=t.z,this[4*e+3]=t.w,this}setRowXYZW(e,t,r,s,i){return this[4*e]=t,this[4*e+1]=r,this[4*e+2]=s,this[4*e+3]=i,this}getCol(e,t){return(t||new l).setXYZW(this[e],this[4+e],this[8+e],this[12+e])}setCol(e,t){return this[e]=t.x,this[4+e]=t.y,this[8+e]=t.z,this[12+e]=t.w,this}setColXYZW(e,t,r,s,i){return this[e]=t,this[4+e]=r,this[8+e]=s,this[12+e]=i,this}static add(e,t,r){r=r||new p;for(let s=0;s<16;s++)r[s]=e[s]+t[s];return r}static sub(e,t,r){r=r||new p;for(let s=0;s<16;s++)r[s]=e[s]-t[s];return r}static mul(e,t,r){r=r||new p;for(let s=0;s<16;s++)r[s]=e[s]*t[s];return r}static div(e,t,r){r=r||new p;for(let s=0;s<16;s++)r[s]=e[s]/t[s];return r}static scale(e,t,r){r=r||new p;for(let s=0;s<16;s++)r[s]=e[s]*t;return r}static identity(e){return(e=e||new p).set(a),e}static ortho(e,t,r,s,i,n,a){return(a=a||new p)[0]=2/(t-e),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(s-r),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2/(i-n),a[11]=0,a[12]=(e+t)/(e-t),a[13]=(r+s)/(r-s),a[14]=(i+n)/(i-n),a[15]=1,a}static reflection(e,t,r,s,i){return(i=i||new p).m00=1-2*e*e,i.m01=-2*e*t,i.m02=-2*e*r,i.m03=-2*e*s,i.m10=-2*e*t,i.m11=1-2*t*t,i.m12=-2*t*r,i.m13=-2*t*s,i.m20=-2*e*r,i.m21=-2*t*r,i.m22=1-2*r*r,i.m23=-2*r*s,i.m30=0,i.m31=0,i.m32=0,i.m33=1,i}static perspective(e,t,r,s,i){const n=r*Math.tan(.5*e),a=n*t;return this.frustum(-a,a,-n,n,r,s,i)}static obliqueProjection(e,t){const r=new p(e),s=p.invert(e).transform(new l(t.a>0?1:-1,t.b>0?1:-1,1,1)),i=2/(s.x*t.a+s.y*t.b+s.z*t.c+s.w*t.d);return r[2]=t.a*i-r[3],r[6]=t.b*i-r[7],r[10]=t.c*i-r[11],r[14]=t.d*i-r[15],r}static obliquePerspective(e,t){const r=new p(e),s=new l(((t.x>0?1:t.x<0?-1:0)+e.m02)/e.m00,((t.y>0?1:t.y<0?-1:0)+e.m12)/e.m11,-1,(1+e.m22)/e.m23),i=l.scale(t,2/l.dot(t,s));return r.m20=i.x,r.m21=i.y,r.m22=i.z+1,r.m23=i.w,r}static frustum(e,t,r,s,i,n,a){const o=t-e,u=s-r,h=i-n;return(a=a||new p)[0]=2*i/o,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*i/u,a[6]=0,a[7]=0,a[8]=(e+t)/o,a[9]=(s+r)/u,a[10]=(i+n)/h,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*i*n/h,a[15]=0,a}static transpose(e,t){return e===(t=t||new p)?([t[1],t[4]]=[t[4],t[1]],[t[2],t[8]]=[t[8],t[2]],[t[3],t[12]]=[t[12],t[3]],[t[6],t[9]]=[t[9],t[6]],[t[7],t[13]]=[t[13],t[7]],[t[11],t[14]]=[t[14],t[11]]):(t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]),t}static invert(e,t){t=t||new p;const r=e[0],s=e[1],i=e[2],n=e[3],a=e[4],o=e[5],u=e[6],h=e[7],l=e[8],c=e[9],_=e[10],f=e[11],m=e[12],d=e[13],E=e[14],T=e[15],x=_*T,g=E*f,y=u*T,A=E*h,b=u*f,R=_*h,S=i*T,C=E*n,I=i*f,F=_*n,N=i*h,v=u*n,w=l*d,L=m*c,O=a*d,M=m*o,B=a*c,D=l*o,U=r*d,$=m*s,G=r*c,P=l*s,V=r*o,X=a*s,W=x*o+A*c+b*d-(g*o+y*c+R*d),k=g*s+S*c+F*d-(x*s+C*c+I*d),z=y*s+C*o+N*d-(A*s+S*o+v*d),H=R*s+I*o+v*c-(b*s+F*o+N*c),Y=1/(r*W+a*k+l*z+m*H);return t[0]=Y*W,t[1]=Y*k,t[2]=Y*z,t[3]=Y*H,t[4]=Y*(g*a+y*l+R*m-(x*a+A*l+b*m)),t[5]=Y*(x*r+C*l+I*m-(g*r+S*l+F*m)),t[6]=Y*(A*r+S*a+v*m-(y*r+C*a+N*m)),t[7]=Y*(b*r+F*a+N*l-(R*r+I*a+v*l)),t[8]=Y*(w*h+M*f+B*T-(L*h+O*f+D*T)),t[9]=Y*(L*n+U*f+P*T-(w*n+$*f+G*T)),t[10]=Y*(O*n+$*h+V*T-(M*n+U*h+X*T)),t[11]=Y*(D*n+G*h+X*f-(B*n+P*h+V*f)),t[12]=Y*(O*_+D*E+L*u-(B*E+w*u+M*_)),t[13]=Y*(G*E+w*i+$*_-(U*_+P*E+L*i)),t[14]=Y*(U*u+X*E+M*i-(V*E+O*i+$*u)),t[15]=Y*(V*_+B*i+P*u-(G*u+X*_+D*i)),t}static invertAffine(e,t){t=t||new p;const r=e[0],s=e[1],i=e[2],n=e[4],a=e[5],o=e[6],u=e[8],h=e[9],l=e[10],c=e[12],_=e[13],f=e[14],m=l*a-o*h,d=i*h-l*s,E=o*s-i*a,T=1/(r*m+n*d+u*E);return t[0]=T*m,t[1]=T*d,t[2]=T*E,t[3]=0,t[4]=T*(o*u-l*n),t[5]=T*(l*r-i*u),t[6]=T*(i*n-o*r),t[7]=0,t[8]=T*(n*h-u*a),t[9]=T*(u*s-r*h),t[10]=T*(r*a-n*s),t[11]=0,t[12]=T*(n*_*l+u*a*f+c*h*o-(n*h*f+u*_*o+c*a*l)),t[13]=T*(r*h*f+u*_*i+c*s*l-(r*_*l+u*s*f+c*h*i)),t[14]=T*(r*_*o+n*s*f+c*a*i-(r*a*f+n*_*i+c*s*o)),t[15]=1,t}static translation(e,t){return(t=t||new p)[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e.x,t[13]=e.y,t[14]=e.z,t[15]=1,t}static scaling(e,t){return(t=t||new p)[0]=e.x,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e.y,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e.z,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static rotationX(e,t){t=t||new p;const r=Math.cos(e),s=Math.sin(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=s,t[7]=0,t[8]=0,t[9]=-s,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static rotationY(e,t){t=t||new p;const r=Math.cos(e),s=Math.sin(e);return t[0]=r,t[1]=0,t[2]=-s,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=s,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static rotationZ(e,t){t=t||new p;const r=Math.cos(e),s=Math.sin(e);return t[0]=r,t[1]=s,t[2]=0,t[3]=0,t[4]=-s,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static rotation(e,t,r){r=r||new p;let s=e.x,i=e.y,n=e.z;const a=Math.hypot(s,i,n);s/=a,i/=a,n/=a;const o=s*s,u=i*i,h=n*n,l=Math.cos(t),c=Math.sin(t),_=1-l;return r[0]=o+(1-o)*l,r[1]=s*i*_+n*c,r[2]=s*n*_-i*c,r[3]=0,r[4]=s*i*_-n*c,r[5]=u+(1-u)*l,r[6]=i*n*_+s*c,r[7]=0,r[8]=s*n*_+i*c,r[9]=i*n*_-s*c,r[10]=h+(1-h)*l,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}static compose(e,t,r,s){return(s=s??new p).scaling(e).rotateLeft(t).translateLeft(r)}static lookAt(e,t,r,s){s=s||new p;const i=h.normalize(h.sub(e,t)),n=h.normalize(h.cross(r,i)),a=h.normalize(h.cross(i,n));return s[0]=n.x,s[1]=n.y,s[2]=n.z,s[3]=0,s[4]=a.x,s[5]=a.y,s[6]=a.z,s[7]=0,s[8]=i.x,s[9]=i.y,s[10]=i.z,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,s}static lookAtCubeFace(e,t,r){switch(e){case i.PX:return this.lookAt(t,new h(t.x+1,t.y,t.z),new h(0,-1,0),r);case i.NX:return this.lookAt(t,new h(t.x-1,t.y,t.z),new h(0,-1,0),r);case i.PY:return this.lookAt(t,new h(t.x,t.y+1,t.z),new h(0,0,1),r);case i.NY:return this.lookAt(t,new h(t.x,t.y-1,t.z),new h(0,0,-1),r);case i.PZ:return this.lookAt(t,new h(t.x,t.y,t.z+1),new h(0,-1,0),r);case i.NZ:return this.lookAt(t,new h(t.x,t.y,t.z-1),new h(0,-1,0),r);default:return null}}static multiply(e,t,r){r=r||new p;const s=e[0],i=e[1],n=e[2],a=e[3],o=e[4],u=e[5],h=e[6],l=e[7],c=e[8],_=e[9],f=e[10],m=e[11],d=e[12],E=e[13],T=e[14],x=e[15],g=t[0],y=t[1],A=t[2],b=t[3],R=t[4],S=t[5],C=t[6],I=t[7],F=t[8],N=t[9],v=t[10],w=t[11],L=t[12],O=t[13],M=t[14],B=t[15];return r[0]=s*g+o*y+c*A+d*b,r[1]=i*g+u*y+_*A+E*b,r[2]=n*g+h*y+f*A+T*b,r[3]=a*g+l*y+m*A+x*b,r[4]=s*R+o*S+c*C+d*I,r[5]=i*R+u*S+_*C+E*I,r[6]=n*R+h*S+f*C+T*I,r[7]=a*R+l*S+m*C+x*I,r[8]=s*F+o*N+c*v+d*w,r[9]=i*F+u*N+_*v+E*w,r[10]=n*F+h*N+f*v+T*w,r[11]=a*F+l*N+m*v+x*w,r[12]=s*L+o*O+c*M+d*B,r[13]=i*L+u*O+_*M+E*B,r[14]=n*L+h*O+f*M+T*B,r[15]=a*L+l*O+m*M+x*B,r}static multiplyAffine(e,t,r){r=r||new p;const s=e[0],i=e[1],n=e[2],a=e[4],o=e[5],u=e[6],h=e[8],l=e[9],c=e[10],_=e[12],f=e[13],m=e[14],d=t[0],E=t[1],T=t[2],x=t[4],g=t[5],y=t[6],A=t[8],b=t[9],R=t[10],S=t[12],C=t[13],I=t[14];return r[0]=s*d+a*E+h*T,r[1]=i*d+o*E+l*T,r[2]=n*d+u*E+c*T,r[3]=0,r[4]=s*x+a*g+h*y,r[5]=i*x+o*g+l*y,r[6]=n*x+u*g+c*y,r[7]=0,r[8]=s*A+a*b+h*R,r[9]=i*A+o*b+l*R,r[10]=n*A+u*b+c*R,r[11]=0,r[12]=s*S+a*C+h*I+_,r[13]=i*S+o*C+l*I+f,r[14]=n*S+u*C+c*I+m,r[15]=1,r}static translateRight(e,t,r){if((r=r||new p)!==e)r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12],r[13]=e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13],r[14]=e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14],r[15]=e[15];else{const s=e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12],i=e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13],n=e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14];r[12]=s,r[13]=i,r[14]=n}return r}static translateLeft(e,t,r){return(r=r||new p)!==e?(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12]+t.x,r[13]=e[13]+t.y,r[14]=e[14]+t.z,r[15]=e[15]):(r[12]+=t.x,r[13]+=t.y,r[14]+=t.z),r}static scaleRight(e,t,r){return(r=r||new p)!==e?(r[0]=e[0]*t.x,r[1]=e[1]*t.x,r[2]=e[2]*t.x,r[3]=e[3]*t.x,r[4]=e[4]*t.y,r[5]=e[5]*t.y,r[6]=e[6]*t.y,r[7]=e[7]*t.y,r[8]=e[8]*t.z,r[9]=e[9]*t.z,r[10]=e[10]*t.z,r[11]=e[11]*t.z,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):(r[0]*=t.x,r[1]*=t.x,r[2]*=t.x,r[3]*=t.x,r[4]*=t.y,r[5]*=t.y,r[6]*=t.y,r[7]*=t.y,r[8]*=t.z,r[9]*=t.z,r[10]*=t.z,r[11]*=t.z),r}static scaleLeft(e,t,r){return(r=r||new p)[0]=e[0]*t.x,r[1]=e[1]*t.y,r[2]=e[2]*t.z,r[3]=e[3],r[4]=e[4]*t.x,r[5]=e[5]*t.y,r[6]=e[6]*t.z,r[7]=e[7],r[8]=e[8]*t.x,r[9]=e[9]*t.y,r[10]=e[10]*t.z,r[11]=e[11],r[12]=e[12]*t.x,r[13]=e[13]*t.y,r[14]=e[14]*t.z,r[15]=e[15],r}static rotateRight(e,t,r){r=r||new p;const s=t instanceof c?new _(t):t,i=e[0],n=e[1],a=e[2],o=e[3],u=e[4],h=e[5],l=e[6],f=e[7],m=e[8],d=e[9],E=e[10],T=e[11],x=e[12],g=e[13],y=e[14],A=e[15],b=s.m00,R=s.m10,S=s.m20,C=s.m01,I=s.m11,F=s.m21,N=s.m02,v=s.m12,w=s.m22;return r[0]=i*b+u*R+m*S,r[1]=n*b+h*R+d*S,r[2]=a*b+l*R+E*S,r[3]=o*b+f*R+T*S,r[4]=i*C+u*I+m*F,r[5]=n*C+h*I+d*F,r[6]=a*C+l*I+E*F,r[7]=o*C+f*I+T*F,r[8]=i*N+u*v+m*w,r[9]=n*N+h*v+d*w,r[10]=a*N+l*v+E*w,r[11]=o*N+f*v+T*w,r[12]=x,r[13]=g,r[14]=y,r[15]=A,r}static rotateLeft(e,t,r){r=r||new p;const s=t instanceof c?new _(t):t,i=s.m00,n=s.m10,a=s.m20,o=s.m01,u=s.m11,h=s.m21,l=s.m02,f=s.m12,m=s.m22,d=e[0],E=e[1],T=e[2],x=e[3],g=e[4],y=e[5],A=e[6],b=e[7],R=e[8],S=e[9],C=e[10],I=e[11],F=e[12],N=e[13],v=e[14],w=e[15];return r[0]=i*d+o*E+l*T,r[1]=n*d+u*E+f*T,r[2]=a*d+h*E+m*T,r[3]=x,r[4]=i*g+o*y+l*A,r[5]=n*g+u*y+f*A,r[6]=a*g+h*y+m*A,r[7]=b,r[8]=i*R+o*S+l*C,r[9]=n*R+u*S+f*C,r[10]=a*R+h*S+m*C,r[11]=I,r[12]=i*F+o*N+l*v,r[13]=n*F+u*N+f*v,r[14]=a*F+h*N+m*v,r[15]=w,r}subBy(e){return p.sub(this,e,this),this}addBy(e){return p.add(this,e,this),this}mulBy(e){return p.mul(this,e,this),this}divBy(e){return p.div(this,e,this),this}scaleBy(e){return p.scale(this,e,this),this}identity(){return p.identity(this),this}perspective(e,t,r,s){return p.perspective(e,t,r,s,this),this}frustum(e,t,r,s,i,n){return p.frustum(e,t,r,s,i,n,this),this}ortho(e,t,r,s,i,n){return p.ortho(e,t,r,s,i,n,this),this}isOrtho(){return 1===this[15]}isPerspective(){return 0===this[15]}getNearPlaneWidth(){return this.isPerspective()?2*this.getNearPlane()/this[0]:2/this[0]}getNearPlaneHeight(){return this.isPerspective()?2*this.getNearPlane()/this[5]:2/this[5]}getNearPlane(){return this.isPerspective()?this[14]/(this[10]-1):(this[14]+1)/this[10]}getFarPlaneWidth(){return this.isPerspective()?this.getNearPlaneWidth()*this.getFarPlane()/this.getNearPlane():this.getNearPlaneWidth()}getFarPlaneHeight(){return this.isPerspective()?this.getNearPlaneHeight()*this.getFarPlane()/this.getNearPlane():this.getNearPlaneHeight()}getFarPlane(){return this.isPerspective()?this[14]/(this[10]+1):(this[14]-1)/this[10]}getFov(){return this.isOrtho()?0:2*Math.atan(1/this[5])}getTanHalfFov(){return this.isOrtho()?0:1/this[5]}getAspect(){return this[5]/this[0]}getLeftPlane(){return this.isPerspective()?(this[8]-1)*this.getNearPlane()/this[0]:(-1-this[12])/this[0]}getRightPlane(){return this.isPerspective()?(this[8]+1)*this.getNearPlane()/this[0]:(1-this[12])/this[0]}getTopPlane(){return this.isPerspective()?(this[9]+1)*this.getNearPlane()/this[5]:(1-this[13])/this[5]}getBottomPlane(){return this.isPerspective()?(this[9]-1)*this.getNearPlane()/this[5]:(-1-this[13])/this[5]}setNearFar(e,t){return this.isPerspective()?this.perspective(this.getFov(),this.getAspect(),e,t):(this[10]=2/(e-t),this[14]=(e+t)/(e-t)),this}translation(e){return p.translation(e,this),this}scaling(e){return p.scaling(e,this),this}inplaceInvert(){return p.invert(this,this),this}inplaceInvertAffine(){return p.invertAffine(this,this),this}transpose(){return p.transpose(this,this),this}multiplyRight(e){return p.multiply(this,e,this),this}multiplyRightAffine(e){return p.multiplyAffine(this,e,this),this}multiplyLeft(e){return p.multiply(e,this,this),this}multiplyLeftAffine(e){return p.multiplyAffine(e,this,this),this}rotationX(e){return p.rotationX(e,this),this}rotationY(e){return p.rotationY(e,this),this}rotationZ(e){return p.rotationZ(e,this),this}rotation(e,t){return p.rotation(e,t,this),this}translateRight(e){return p.translateRight(this,e,this),this}translateLeft(e){return p.translateLeft(this,e,this),this}scaleRight(e){return p.scaleRight(this,e,this),this}scaleLeft(e){return p.scaleLeft(this,e,this),this}rotateRight(e){return p.rotateRight(this,e,this),this}rotateLeft(e){return p.rotateLeft(this,e,this),this}lookAt(e,t,r){return p.lookAt(e,t,r,this),this}transformPoint(e,t){return(t=t||new l).setXYZW(this[0]*e[0]+this[4]*e[1]+this[8]*e[2]+this[12],this[1]*e[0]+this[5]*e[1]+this[9]*e[2]+this[13],this[2]*e[0]+this[6]*e[1]+this[10]*e[2]+this[14],this[3]*e[0]+this[7]*e[1]+this[11]*e[2]+this[15])}transformPointH(e,t){t=t||new h;const r=this[3]*e[0]+this[7]*e[1]+this[11]*e[2]+this[15];return t.setXYZ((this[0]*e[0]+this[4]*e[1]+this[8]*e[2]+this[12])/r,(this[1]*e[0]+this[5]*e[1]+this[9]*e[2]+this[13])/r,(this[2]*e[0]+this[6]*e[1]+this[10]*e[2]+this[14])/r)}transformPointP(e,t){t=t||new h;const r=this[0]*e[0]+this[4]*e[1]+this[8]*e[2]+this[12],s=this[1]*e[0]+this[5]*e[1]+this[9]*e[2]+this[13],i=this[2]*e[0]+this[6]*e[1]+this[10]*e[2]+this[14],n=this[3]*e[0]+this[7]*e[1]+this[11]*e[2]+this[15];return t.setXYZ(r/n,s/n,i/n)}transformPointAffine(e,t){return(t=t||new h).setXYZ(this[0]*e[0]+this[4]*e[1]+this[8]*e[2]+this[12],this[1]*e[0]+this[5]*e[1]+this[9]*e[2]+this[13],this[2]*e[0]+this[6]*e[1]+this[10]*e[2]+this[14])}transformVector(e,t){return(t=t||new l).setXYZW(this[0]*e[0]+this[4]*e[1]+this[8]*e[2],this[1]*e[0]+this[5]*e[1]+this[9]*e[2],this[2]*e[0]+this[6]*e[1]+this[10]*e[2],this[3]*e[0]+this[7]*e[1]+this[11]*e[2])}transformVectorAffine(e,t){return(t=t||new h).setXYZ(this[0]*e[0]+this[4]*e[1]+this[8]*e[2],this[1]*e[0]+this[5]*e[1]+this[9]*e[2],this[2]*e[0]+this[6]*e[1]+this[10]*e[2])}transform(e,t){return(t=t||new l).setXYZW(this[0]*e[0]+this[4]*e[1]+this[8]*e[2]+this[12]*e[3],this[1]*e[0]+this[5]*e[1]+this[9]*e[2]+this[13]*e[3],this[2]*e[0]+this[6]*e[1]+this[10]*e[2]+this[14]*e[3],this[3]*e[0]+this[7]*e[1]+this[11]*e[2]+this[15]*e[3])}transformAffine(e,t){return(t=t||new l).setXYZW(this[0]*e[0]+this[4]*e[1]+this[8]*e[2]+this[12]*e[3],this[1]*e[0]+this[5]*e[1]+this[9]*e[2]+this[13]*e[3],this[2]*e[0]+this[6]*e[1]+this[10]*e[2]+this[14]*e[3],e.w)}det(){const e=this[0],t=this[1],r=this[2],s=this[3],i=this[4],n=this[5],a=this[6],o=this[7],u=this[8],h=this[9],l=this[10],c=this[11],_=this[12],p=this[13],f=this[14],m=this[15],d=l*m-f*c,E=h*m-p*c,T=h*f-p*l,x=u*m-_*c,g=u*f-l*_,y=u*p-_*h;return e*+(n*d-a*E+o*T)+t*-(i*d-a*x+o*g)+r*+(i*E-n*x+o*y)+s*-(i*T-n*g+a*y)}compose(e,t,r){return p.compose(e,t,r,this),this}decompose(e,t,r){r&&r.setXYZ(this[12],this[13],this[14]);const s=this.det()<=0?-1:1,i=Math.hypot(this[0],this[1],this[2]),n=Math.hypot(this[4],this[5],this[6])*s,a=Math.hypot(this[8],this[9],this[10]);if(e&&e.setXYZ(i,n,a),t instanceof c){const e=new _(this);e[0]/=i,e[1]/=i,e[2]/=i,e[3]/=n,e[4]/=n,e[5]/=n,e[6]/=a,e[7]/=a,e[8]/=a,t.fromRotationMatrix(e)}else t instanceof _?(t[0]=this[0]/i,t[1]=this[1]/i,t[2]=this[2]/i,t[3]=this[4]/n,t[4]=this[5]/n,t[5]=this[6]/n,t[6]=this[8]/a,t[7]=this[9]/a,t[8]=this[10]/a):t instanceof p&&(t[0]=this[0]/i,t[1]=this[1]/i,t[2]=this[2]/i,t[3]=0,t[4]=this[4]/n,t[5]=this[5]/n,t[6]=this[6]/n,t[7]=0,t[8]=this[8]/a,t[9]=this[9]/a,t[10]=this[10]/a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1);return this}decomposeLookAt(e,t,r){return e?.setXYZ(this[12],this[13],this[14]),r?.setXYZ(this[4],this[5],this[6]),t?.setXYZ(this[12]-this[8],this[13]-this[9],this[14]-this[10]),this}toDualQuaternion(){const e=new h,t=new c,r=new h;this.decompose(r,t,e);const s=new c(.5*this.m03,.5*this.m13,.5*this.m23,0);return{real:t,dual:c.multiply(s,t),scale:r}}}class f{_bins;_maxBins;_width;_height;constructor(e,t,r=0){this._width=e,this._height=t,this._maxBins=r,this._bins=[new m(this._width,this._height)]}clear(){this._bins=[new m(this._width,this._height)]}insert(e,t){if(e>this._width||t>this._height)return null;const r=this._bins[this._bins.length-1].insert(e,t);if(r)return{x:r.x,y:r.y,width:r.width,height:r.height,binIndex:this._bins.length-1};if(0===this._maxBins||this._bins.length<this._maxBins){this._bins.push(new m(this._width,this._height));const r=this._bins[this._bins.length-1].insert(e,t);return{x:r.x,y:r.y,width:r.width,height:r.height,binIndex:this._bins.length-1}}return null}}class m{freeRects;constructor(e,t){this.freeRects=[{x:0,y:0,width:e,height:t}]}insert(e,t){const r=this.findBestFit(e,t);if(!r)return null;let s=this.freeRects.length,i=0;for(;i<s;)this.splitFreeRect(this.freeRects[i],r)&&(this.freeRects.splice(i,1),--s,--i),++i;return this.pruneFreeRects(),r}findBestFit(e,t){let r=Number.MAX_VALUE,s=null;for(const i of this.freeRects)if(i.width>=e&&i.height>=t){const n=i.width*i.height-e*t;n<r&&(s||(s={width:e,height:t}),s.x=i.x,s.y=i.y,r=n)}return s}splitFreeRect(e,t){return!(t.x>=e.x+e.width||t.x+t.width<=e.x||t.y>=e.y+e.height||t.y+t.height<=e.y)&&(t.x<e.x+e.width&&t.x+t.width>e.x&&(t.y>e.y&&t.y<e.y+e.height&&this.freeRects.push({x:e.x,y:e.y,width:e.width,height:t.y-e.y}),t.y+t.height<e.y+e.height&&this.freeRects.push({x:e.x,y:t.y+t.height,width:e.width,height:e.y+e.height-t.y-t.height})),t.y<e.y+e.height&&t.y+t.height>e.y&&(t.x>e.x&&t.x<e.x+e.width&&this.freeRects.push({x:e.x,y:e.y,width:t.x-e.x,height:e.height}),t.x+t.width<e.x+e.width&&this.freeRects.push({x:t.x+t.width,y:e.y,width:e.x+e.width-t.x-t.width,height:e.height})),!0)}pruneFreeRects(){let e=0,t=0,r=this.freeRects.length;for(;e<r;){t=e+1;const s=this.freeRects[e];for(;t<r;){const i=this.freeRects[t];if(this.isRectInRect(s,i)){this.freeRects.splice(e,1),--e,--r;break}this.isRectInRect(i,s)&&(this.freeRects.splice(t,1),--t,--r),t++}e++}}isRectInRect(e,t){return e.x>=t.x&&e.y>=t.y&&e.x+e.width<=t.x+t.width&&e.y+e.height<=t.y+t.height}}class d extends r{_disposed;constructor(){super(),this._disposed=!1}get disposed(){return this._disposed}dispose(){this._disposed||(this.dispatchEvent("dispose"),this.onDispose(),this._disposed=!0)}onDispose(){}}const E=16777216,T=33554432,x=50331648,g=67108864,y=83886080,A=100663296,b=117440512,R=134217728;function S(e,t,r,s,i,n,a,o,u,h,l,c,_,p,f){return e|((t?1:0)|(r?2:0)|(s?4:0)|(i?8:0))|((n?16:0)|(a?32:0))|(o?64:0)|(u?128:0)|(h?256:0)|(l?512:0)|(c?1024:0)|(_<<16|p<<20|f<<11)}const C={unknown:0,r8unorm:S(0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,1,1,1),r8snorm:S(0,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,1,1,1),r16f:S(0,!0,!1,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,2),r32f:S(0,!0,!1,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,4),r8ui:S(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,1),r8i:S(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,1),r16ui:S(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,2),r16i:S(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,2),r32ui:S(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,4),r32i:S(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,4),rg8unorm:S(0,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,1,1,2),rg8snorm:S(0,!0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,1,1,2),rg16f:S(0,!0,!0,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,4),rg32f:S(0,!0,!0,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,8),rg8ui:S(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,2),rg8i:S(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,2),rg16ui:S(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,4),rg16i:S(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,4),rg32ui:S(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,8),rg32i:S(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,8),rgba8unorm:S(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,1,1,4),"rgba8unorm-srgb":S(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,1,1,4),rgba8snorm:S(0,!0,!0,!0,!0,!1,!1,!1,!1,!0,!1,!1,1,1,4),bgra8unorm:S(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!0,1,1,4),"bgra8unorm-srgb":S(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!0,1,1,4),rgba16f:S(0,!0,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1,1,1,8),rgba32f:S(0,!0,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1,1,1,16),rgba8ui:S(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,4),rgba8i:S(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,4),rgba16ui:S(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,8),rgba16i:S(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,8),rgba32ui:S(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,16),rgba32i:S(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,16),rg11b10uf:S(0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,!1,1,1,4),d16:S(0,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,1,1,2),d24:S(0,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,0,0,0),d32f:S(0,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!1,1,1,4),d24s8:S(0,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,1,1,4),d32fs8:S(0,!1,!1,!1,!1,!0,!0,!0,!1,!0,!1,!1,1,1,5),dxt1:S(E,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,8),"dxt1-srgb":S(E,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,8),dxt3:S(T,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"dxt3-srgb":S(T,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),dxt5:S(x,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"dxt5-srgb":S(x,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),bc4:S(g,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,4,4,8),"bc4-signed":S(g,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,4,4,8),bc5:S(y,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,4,4,16),"bc5-signed":S(y,!0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,4,4,16),bc6h:S(A,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,!1,4,4,16),"bc6h-signed":S(A,!0,!0,!0,!1,!1,!1,!0,!1,!0,!1,!1,4,4,16),bc7:S(b,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"bc7-srgb":S(b,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),"astc-4x4":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"astc-4x4-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),"astc-5x4":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,5,4,16),"astc-5x4-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,5,4,16),"astc-5x5":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,5,5,16),"astc-5x5-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,5,5,16),"astc-6x5":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,6,5,16),"astc-6x5-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,6,5,16),"astc-6x6":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,6,6,16),"astc-6x6-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,6,6,16),"astc-8x5":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,5,16),"astc-8x5-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,5,16),"astc-8x6":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,6,16),"astc-8x6-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,6,16),"astc-8x8":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,8,16),"astc-8x8-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,8,16),"astc-10x5":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,5,16),"astc-10x5-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,5,16),"astc-10x6":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,6,16),"astc-10x6-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,6,16),"astc-10x8":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,8,16),"astc-10x8-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,8,16),"astc-10x10":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,10,16),"astc-10x10-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,10,16),"astc-12x10":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,12,10,16),"astc-12x10-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,12,10,16),"astc-12x12":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,12,12,16),"astc-12x12-srgb":S(R,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,12,12,16)};function I(e){switch(e){case"rgba8unorm":return"rgba8unorm-srgb";case"bgra8unorm":return"bgra8unorm-srgb";case"dxt1":return"dxt1-srgb";case"dxt3":return"dxt3-srgb";case"dxt5":return"dxt5-srgb";case"bc7":return"bc7-srgb";case"astc-4x4":return"astc-4x4-srgb";case"astc-5x4":return"astc-5x4-srgb";case"astc-5x5":return"astc-5x5-srgb";case"astc-6x5":return"astc-6x5-srgb";case"astc-6x6":return"astc-6x6-srgb";case"astc-8x5":return"astc-8x5-srgb";case"astc-8x6":return"astc-8x6-srgb";case"astc-8x8":return"astc-8x8-srgb";case"astc-10x5":return"astc-10x5-srgb";case"astc-10x6":return"astc-10x6-srgb";case"astc-10x8":return"astc-10x8-srgb";case"astc-10x10":return"astc-10x10-srgb";case"astc-12x10":return"astc-12x10-srgb";case"astc-12x12":return"astc-12x12-srgb";default:return e}}function F(e){return!!(16&C[e])}function N(e){return!!(64&C[e])}function v(e){return!!(128&C[e])}function w(e){return!!(256&C[e])}function L(e){return!!(520093696&C[e])}function O(e){return(63488&C[e])>>11}var M=function(e){return e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Compute=4]="Compute",e}({});function B(e,t){return e+t-1&~(t-1)}function D(e){if(e.isPrimitiveType())return e.isScalarType()?4:1<<Math.min(4,e.cols+1);if(e.isAtomicI32()||e.isAtomicU32())return 4;if(e.isArrayType())return e.elementType.isAnyType()?1:D(e.elementType);{let t=0;for(const r of e.structMembers)t=Math.max(t,D(r.type));return Math.max(t,16)}}function U(e){return 1}function $(e){if(e.isPrimitiveType())return e.isMatrixType()?e.rows*D(ie.getCachedTypeInfo(e.resizeType(1,e.cols))):4*e.cols;if(e.isArrayType())return e.elementType.isAnyType()?0:e.dimension*B($(e.elementType),D(e.elementType));if(e.isAtomicI32()||e.isAtomicU32())return 4;{let t=0,r=0;for(const s of e.structMembers){const e=D(s.type);t=B(t,e),t+=$(s.type),r=Math.max(r,e)}return B(t,r)}}function G(e){if(e.isPrimitiveType()){let t;switch(e.scalarType){case X.U8:case X.U8_NORM:case X.I8:case X.I8_NORM:t=1;break;case X.F16:case X.I16:case X.I16_NORM:case X.U16:case X.U16_NORM:t=2;break;default:t=4}return e.rows*e.cols*t}if(e.isArrayType())return e.elementType.isAnyType()?0:e.dimension*G(e.elementType);if(e.isAtomicI32()||e.isAtomicU32())return 4;{let t=0;for(const r of e.structMembers)t+=G(r.type);return t}}function P(e,t,r,s){return e|t<<4|r<<7|s<<10}function V(e){return e.isPrimitiveType()?e.scalarType:e.isArrayType()?e.elementType.isAnyType()?null:V(e.elementType):X.U8}var X=function(e){return e[e.NONE=0]="NONE",e[e.F16=P(1,1,1,0)]="F16",e[e.F16VEC2=P(1,1,2,0)]="F16VEC2",e[e.F16VEC3=P(1,1,3,0)]="F16VEC3",e[e.F16VEC4=P(1,1,4,0)]="F16VEC4",e[e.F32=P(2,1,1,0)]="F32",e[e.F32VEC2=P(2,1,2,0)]="F32VEC2",e[e.F32VEC3=P(2,1,3,0)]="F32VEC3",e[e.F32VEC4=P(2,1,4,0)]="F32VEC4",e[e.BOOL=P(3,1,1,0)]="BOOL",e[e.BVEC2=P(3,1,2,0)]="BVEC2",e[e.BVEC3=P(3,1,3,0)]="BVEC3",e[e.BVEC4=P(3,1,4,0)]="BVEC4",e[e.I8=P(4,1,1,0)]="I8",e[e.I8VEC2=P(4,1,2,0)]="I8VEC2",e[e.I8VEC3=P(4,1,3,0)]="I8VEC3",e[e.I8VEC4=P(4,1,4,0)]="I8VEC4",e[e.I8_NORM=P(4,1,1,1)]="I8_NORM",e[e.I8VEC2_NORM=P(4,1,2,1)]="I8VEC2_NORM",e[e.I8VEC3_NORM=P(4,1,3,1)]="I8VEC3_NORM",e[e.I8VEC4_NORM=P(4,1,4,1)]="I8VEC4_NORM",e[e.I16=P(5,1,1,0)]="I16",e[e.I16VEC2=P(5,1,2,0)]="I16VEC2",e[e.I16VEC3=P(5,1,3,0)]="I16VEC3",e[e.I16VEC4=P(5,1,4,0)]="I16VEC4",e[e.I16_NORM=P(5,1,1,1)]="I16_NORM",e[e.I16VEC2_NORM=P(5,1,2,1)]="I16VEC2_NORM",e[e.I16VEC3_NORM=P(5,1,3,1)]="I16VEC3_NORM",e[e.I16VEC4_NORM=P(5,1,4,1)]="I16VEC4_NORM",e[e.I32=P(6,1,1,0)]="I32",e[e.I32VEC2=P(6,1,2,0)]="I32VEC2",e[e.I32VEC3=P(6,1,3,0)]="I32VEC3",e[e.I32VEC4=P(6,1,4,0)]="I32VEC4",e[e.I32_NORM=P(6,1,1,1)]="I32_NORM",e[e.I32VEC2_NORM=P(6,1,2,1)]="I32VEC2_NORM",e[e.I32VEC3_NORM=P(6,1,3,1)]="I32VEC3_NORM",e[e.I32VEC4_NORM=P(6,1,4,1)]="I32VEC4_NORM",e[e.U8=P(7,1,1,0)]="U8",e[e.U8VEC2=P(7,1,2,0)]="U8VEC2",e[e.U8VEC3=P(7,1,3,0)]="U8VEC3",e[e.U8VEC4=P(7,1,4,0)]="U8VEC4",e[e.U8_NORM=P(7,1,1,1)]="U8_NORM",e[e.U8VEC2_NORM=P(7,1,2,1)]="U8VEC2_NORM",e[e.U8VEC3_NORM=P(7,1,3,1)]="U8VEC3_NORM",e[e.U8VEC4_NORM=P(7,1,4,1)]="U8VEC4_NORM",e[e.U16=P(8,1,1,0)]="U16",e[e.U16VEC2=P(8,1,2,0)]="U16VEC2",e[e.U16VEC3=P(8,1,3,0)]="U16VEC3",e[e.U16VEC4=P(8,1,4,0)]="U16VEC4",e[e.U16_NORM=P(8,1,1,1)]="U16_NORM",e[e.U16VEC2_NORM=P(8,1,2,1)]="U16VEC2_NORM",e[e.U16VEC3_NORM=P(8,1,3,1)]="U16VEC3_NORM",e[e.U16VEC4_NORM=P(8,1,4,1)]="U16VEC4_NORM",e[e.U32=P(9,1,1,0)]="U32",e[e.U32VEC2=P(9,1,2,0)]="U32VEC2",e[e.U32VEC3=P(9,1,3,0)]="U32VEC3",e[e.U32VEC4=P(9,1,4,0)]="U32VEC4",e[e.U32_NORM=P(9,1,1,1)]="U32_NORM",e[e.U32VEC2_NORM=P(9,1,2,1)]="U32VEC2_NORM",e[e.U32VEC3_NORM=P(9,1,3,1)]="U32VEC3_NORM",e[e.U32VEC4_NORM=P(9,1,4,1)]="U32VEC4_NORM",e[e.MAT2=P(2,2,2,0)]="MAT2",e[e.MAT2x3=P(2,2,3,0)]="MAT2x3",e[e.MAT2x4=P(2,2,4,0)]="MAT2x4",e[e.MAT3x2=P(2,3,2,0)]="MAT3x2",e[e.MAT3=P(2,3,3,0)]="MAT3",e[e.MAT3x4=P(2,3,4,0)]="MAT3x4",e[e.MAT4x2=P(2,4,2,0)]="MAT4x2",e[e.MAT4x3=P(2,4,3,0)]="MAT4x3",e[e.MAT4=P(2,4,4,0)]="MAT4",e}({});const W={[X.F32]:"float",[X.F32VEC2]:"vec2",[X.F32VEC3]:"vec3",[X.F32VEC4]:"vec4",[X.BOOL]:"bool",[X.BVEC2]:"bvec2",[X.BVEC3]:"bvec3",[X.BVEC4]:"bvec4",[X.I32]:"int",[X.I32VEC2]:"ivec2",[X.I32VEC3]:"ivec3",[X.I32VEC4]:"ivec4",[X.U32]:"uint",[X.U32VEC2]:"uvec2",[X.U32VEC3]:"uvec3",[X.U32VEC4]:"uvec4",[X.MAT2]:"mat2",[X.MAT2x3]:"mat2x3",[X.MAT2x4]:"mat2x4",[X.MAT3x2]:"mat3x2",[X.MAT3]:"mat3",[X.MAT3x4]:"mat3x4",[X.MAT4x2]:"mat4x2",[X.MAT4x3]:"mat4x3",[X.MAT4]:"mat4"},k={[X.F32]:"f32",[X.F32VEC2]:"vec2<f32>",[X.F32VEC3]:"vec3<f32>",[X.F32VEC4]:"vec4<f32>",[X.BOOL]:"bool",[X.BVEC2]:"vec2<bool>",[X.BVEC3]:"vec3<bool>",[X.BVEC4]:"vec4<bool>",[X.I32]:"i32",[X.I32VEC2]:"vec2<i32>",[X.I32VEC3]:"vec3<i32>",[X.I32VEC4]:"vec4<i32>",[X.U32]:"u32",[X.U32VEC2]:"vec2<u32>",[X.U32VEC3]:"vec3<u32>",[X.U32VEC4]:"vec4<u32>",[X.MAT2]:"mat2x2<f32>",[X.MAT2x3]:"mat2x3<f32>",[X.MAT2x4]:"mat2x4<f32>",[X.MAT3x2]:"mat3x2<f32>",[X.MAT3]:"mat3x3<f32>",[X.MAT3x4]:"mat3x4<f32>",[X.MAT4x2]:"mat4x2<f32>",[X.MAT4x3]:"mat4x3<f32>",[X.MAT4]:"mat4x4<f32>"},z=16,H=64,Y=128,j=512,K=1024;var Z=function(e){return e[e.TEX_1D=257]="TEX_1D",e[e.ITEX_1D=513]="ITEX_1D",e[e.UTEX_1D=1025]="UTEX_1D",e[e.TEX_2D=258]="TEX_2D",e[e.ITEX_2D=514]="ITEX_2D",e[e.UTEX_2D=1026]="UTEX_2D",e[e.TEX_2D_ARRAY=274]="TEX_2D_ARRAY",e[e.ITEX_2D_ARRAY=530]="ITEX_2D_ARRAY",e[e.UTEX_2D_ARRAY=1042]="UTEX_2D_ARRAY",e[e.TEX_3D=260]="TEX_3D",e[e.ITEX_3D=516]="ITEX_3D",e[e.UTEX_3D=1028]="UTEX_3D",e[e.TEX_CUBE=264]="TEX_CUBE",e[e.ITEX_CUBE=520]="ITEX_CUBE",e[e.UTEX_CUBE=1032]="UTEX_CUBE",e[e.TEX_CUBE_ARRAY=280]="TEX_CUBE_ARRAY",e[e.ITEX_CUBE_ARRAY=536]="ITEX_CUBE_ARRAY",e[e.UTEX_CUBE_ARRAY=1048]="UTEX_CUBE_ARRAY",e[e.TEX_MULTISAMPLED_2D=290]="TEX_MULTISAMPLED_2D",e[e.ITEX_MULTISAMPLED_2D=546]="ITEX_MULTISAMPLED_2D",e[e.UTEX_MULTISAMPLED_2D=1058]="UTEX_MULTISAMPLED_2D",e[e.TEX_STORAGE_1D=65]="TEX_STORAGE_1D",e[e.TEX_STORAGE_2D=66]="TEX_STORAGE_2D",e[e.TEX_STORAGE_2D_ARRAY=82]="TEX_STORAGE_2D_ARRAY",e[e.TEX_STORAGE_3D=68]="TEX_STORAGE_3D",e[e.TEX_DEPTH_2D=130]="TEX_DEPTH_2D",e[e.TEX_DEPTH_2D_ARRAY=146]="TEX_DEPTH_2D_ARRAY",e[e.TEX_DEPTH_CUBE=136]="TEX_DEPTH_CUBE",e[e.TEX_DEPTH_CUBE_ARRAY=152]="TEX_DEPTH_CUBE_ARRAY",e[e.TEX_DEPTH_MULTISAMPLED_2D=162]="TEX_DEPTH_MULTISAMPLED_2D",e[e.TEX_EXTERNAL=2048]="TEX_EXTERNAL",e}({});const q={[Z.TEX_1D]:"highp sampler2D",[Z.TEX_2D]:"highp sampler2D",[Z.TEX_CUBE]:"highp samplerCube",[Z.TEX_EXTERNAL]:"highp sampler2D"},Q={[Z.TEX_1D]:"highp sampler2D",[Z.TEX_2D]:"highp sampler2D",[Z.ITEX_1D]:"highp isampler2D",[Z.ITEX_2D]:"highp isampler2D",[Z.UTEX_1D]:"highp usampler2D",[Z.UTEX_2D]:"highp usampler2D",[Z.TEX_2D_ARRAY]:"highp sampler2DArray",[Z.ITEX_2D_ARRAY]:"highp isampler2DArray",[Z.UTEX_2D_ARRAY]:"highp usampler2DArray",[Z.TEX_3D]:"highp sampler3D",[Z.ITEX_3D]:"highp isampler3D",[Z.UTEX_3D]:"highp usampler3D",[Z.TEX_CUBE]:"highp samplerCube",[Z.ITEX_CUBE]:"highp isamplerCube",[Z.UTEX_CUBE]:"highp usamplerCube",[Z.TEX_DEPTH_2D]:"highp sampler2DShadow",[Z.TEX_DEPTH_2D_ARRAY]:"highp sampler2DArrayShadow",[Z.TEX_DEPTH_CUBE]:"highp samplerCubeShadow",[Z.TEX_EXTERNAL]:"highp sampler2D"},J={[Z.TEX_1D]:"texture_1d<f32>",[Z.ITEX_1D]:"texture_1d<i32>",[Z.UTEX_1D]:"texture_1d<u32>",[Z.TEX_2D]:"texture_2d<f32>",[Z.ITEX_2D]:"texture_2d<i32>",[Z.UTEX_2D]:"texture_2d<u32>",[Z.TEX_2D_ARRAY]:"texture_2d_array<f32>",[Z.ITEX_2D_ARRAY]:"texture_2d_array<i32>",[Z.UTEX_2D_ARRAY]:"texture_2d_array<u32>",[Z.TEX_3D]:"texture_3d<f32>",[Z.ITEX_3D]:"texture_3d<i32>",[Z.UTEX_3D]:"texture_3d<u32>",[Z.TEX_CUBE]:"texture_cube<f32>",[Z.ITEX_CUBE]:"texture_cube<i32>",[Z.UTEX_CUBE]:"texture_cube<u32>",[Z.TEX_CUBE_ARRAY]:"texture_cube_array<f32>",[Z.ITEX_CUBE_ARRAY]:"texture_cube_array<i32>",[Z.UTEX_CUBE_ARRAY]:"texture_cube_array<u32>",[Z.TEX_MULTISAMPLED_2D]:"texture_multisampled_2d<f32>",[Z.ITEX_MULTISAMPLED_2D]:"texture_multisampled_2d<i32>",[Z.UTEX_MULTISAMPLED_2D]:"texture_multisampled_2d<u32>",[Z.TEX_STORAGE_1D]:"texture_storage_1d",[Z.TEX_STORAGE_2D]:"texture_storage_2d",[Z.TEX_STORAGE_2D_ARRAY]:"texture_storage_2d_array",[Z.TEX_STORAGE_3D]:"texture_storage_3d",[Z.TEX_DEPTH_2D]:"texture_depth_2d",[Z.TEX_DEPTH_2D_ARRAY]:"texture_depth_2d_array",[Z.TEX_DEPTH_CUBE]:"texture_depth_cube",[Z.TEX_DEPTH_CUBE_ARRAY]:"texture_depth_cube_array",[Z.TEX_DEPTH_MULTISAMPLED_2D]:"texture_depth_multisampled_2d",[Z.TEX_EXTERNAL]:"texture_external"},ee={rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",bgra8unorm:"bgra8unorm",rgba8ui:"rgba8uint",rgba8i:"rgba8sint",rgba16ui:"rgba16uint",rgba16i:"rgba16sint",rgba16f:"rgba16float",r32f:"r32float",r32ui:"r32uint",r32i:"r32sint",rg32f:"rg32float",rg32ui:"rg32uint",rg32i:"rg32sint",rgba32f:"rgba32float",rgba32ui:"rgba32uint",rgba32i:"rgba32sint"};var te=function(e){return e[e.UNKNOWN=0]="UNKNOWN",e[e.SAMPLE=1]="SAMPLE",e[e.COMPARISON=2]="COMPARISON",e}({}),re=function(e){return e.UNKNOWN="unknown",e.FUNCTION="function",e.PRIVATE="private",e.WORKGROUP="workgroup",e.UNIFORM="uniform",e.STORAGE="storage",e}({});class se{cls;detail;id;constructor(e,t){this.cls=e,this.detail=t,this.id=null}get typeId(){return this.id||(this.id=this.genTypeId()),this.id}isVoidType(){return!1}isAnyType(){return!1}isPrimitiveType(){return!1}haveAtomicMembers(){return!1}isStructType(){return!1}isArrayType(){return!1}isPointerType(){return!1}isAtomicI32(){return!1}isAtomicU32(){return!1}isSamplerType(){return!1}isTextureType(){return!1}isHostSharable(){return!1}isConstructible(){return!1}isStorable(){return!1}getConstructorOverloads(e){return[]}isCompatibleType(e){return e.typeId===this.typeId}}class ie extends se{static cachedTypes={};static cachedCtorOverloads={};constructor(e){super(1,{primitiveType:e})}static getCachedTypeInfo(e){let t=this.cachedTypes[e];return t||(t=new ie(e),this.cachedTypes[e]=t),t}static getCachedOverloads(e,t){let r=this.cachedCtorOverloads[e];r||(r={},this.cachedCtorOverloads[e]=r);let s=r[t];if(!s){const i=this.getCachedTypeInfo(t),n=i.toTypeName(e);if(s=[new le(n,i,[])],i.isScalarType())s.push(new le(n,i,[{type:this.getCachedTypeInfo(X.F32)}])),s.push(new le(n,i,[{type:this.getCachedTypeInfo(X.I32)}])),s.push(new le(n,i,[{type:this.getCachedTypeInfo(X.U32)}])),s.push(new le(n,i,[{type:this.getCachedTypeInfo(X.BOOL)}]));else if(i.isVectorType()){const e={type:this.getCachedTypeInfo(i.scalarType)},t={type:this.getCachedTypeInfo(i.resizeType(1,2))},r={type:this.getCachedTypeInfo(i.resizeType(1,3))};switch(s.push(new le(n,i,[e])),i.cols){case 2:s.push(new le(n,i,[e,e])),s.push(new le(n,i,[{type:_e}])),s.push(new le(n,i,[{type:Te}])),s.push(new le(n,i,[{type:Ae}])),s.push(new le(n,i,[{type:Ce}]));break;case 3:s.push(new le(n,i,[e,e,e])),s.push(new le(n,i,[e,t])),s.push(new le(n,i,[t,e])),s.push(new le(n,i,[{type:pe}])),s.push(new le(n,i,[{type:xe}])),s.push(new le(n,i,[{type:be}])),s.push(new le(n,i,[{type:Ie}]));break;case 4:s.push(new le(n,i,[e,e,e,e])),s.push(new le(n,i,[e,e,t])),s.push(new le(n,i,[e,t,e])),s.push(new le(n,i,[t,e,e])),s.push(new le(n,i,[t,t])),s.push(new le(n,i,[e,r])),s.push(new le(n,i,[r,e])),s.push(new le(n,i,[{type:fe}])),s.push(new le(n,i,[{type:ge}])),s.push(new le(n,i,[{type:Re}])),s.push(new le(n,i,[{type:Fe}]))}}else if(i.isMatrixType()){const e=this.getCachedTypeInfo(i.resizeType(1,i.cols));s.push(new le(n,i,Array.from({length:i.rows}).map(()=>({type:e})))),s.push(new le(n,i,Array.from({length:i.rows*i.cols}).map(()=>({type:ce}))))}r[t]=s}return s}get primitiveType(){return this.detail.primitiveType}isInteger(){const e=15&this.primitiveType;return 4===e||7===e||5===e||8===e||6===e||9===e}get scalarType(){return this.resizeType(1,1)}get rows(){return this.primitiveType>>4&7}get cols(){return this.primitiveType>>7&7}get normalized(){return!!(this.primitiveType>>10&1)}getLayoutAlignment(e){return"packed"===e?1:this.isScalarType()?4:1<<Math.min(4,this.cols+1)}getLayoutSize(){return this.getSize()}getSize(){let e;switch(this.scalarType){case X.BOOL:case X.I32:case X.I32_NORM:case X.U32:case X.U32_NORM:case X.F32:e=4;break;case X.F16:case X.I16:case X.I16_NORM:case X.U16:case X.U16_NORM:e=2;break;default:e=1}return e*this.cols*this.rows}resizeType(e,t){return P(15&this.primitiveType,e,t,this.normalized?1:0)}isScalarType(){return 1===this.rows&&1===this.cols}isVectorType(){return 1===this.rows&&this.cols>1}isMatrixType(){return this.rows>1&&this.cols>1}isPrimitiveType(){return!0}isHostSharable(){return this.scalarType!==X.BOOL}isConstructible(){return!0}isStorable(){return!0}getConstructorOverloads(e){return ie.getCachedOverloads(e,this.primitiveType)}toTypeName(e,t){if("webgpu"===e){const e=k[this.primitiveType];return t?`${t}: ${e}`:e}{const e=W[this.primitiveType];return t?`${e} ${t}`:e}}toBufferLayout(e){return null}genTypeId(){return`PRIM:${this.primitiveType}`}}class ne extends se{constructor(e,t,r){super(1,{layout:t||"default",structName:e,structMembers:r.map(e=>{const t=D(e.type),r=$(e.type);return{name:e.name,type:e.type,alignment:t,size:r,defaultAlignment:t,defaultSize:r}})}),"std140"===this.layout?this.calcAlignmentAndSizeSTD140():"std430"===this.layout&&this.calcAlignmentAndSizePacked()}get layout(){return this.detail.layout}get structName(){return this.detail.structName}set structName(e){this.detail.structName=e}get structMembers(){return this.detail.structMembers}haveAtomicMembers(){for(const e of this.structMembers)return!(!e.type.isStructType()||!e.type.haveAtomicMembers())||(!(!e.type.isArrayType()||!e.type.haveAtomicMembers())||(e.type.isAtomicI32()||e.type.isAtomicU32()))}extends(e,t){const r=this.structMembers.map(e=>({name:e.name,type:e.type}));return new ne(e,this.layout,[...r,...t])}isStructType(){return!0}isHostSharable(){return this.detail.structMembers.every(e=>e.type.isHostSharable())}isConstructible(){return this.detail.structMembers.every(e=>e.type.isConstructible())}isStorable(){return!0}getConstructorOverloads(){const e=[new le(this.structName,this,[])];return this.isConstructible()&&e.push(new le(this.structName,this,this.structMembers.map(e=>({type:e.type})))),e}toTypeName(e,t){return"webgpu"===e?t?`${t}: ${this.structName}`:this.structName:t?`${this.structName} ${t}`:this.structName}getLayoutAlignment(e){if("packed"===e)return 1;let t=0;for(const r of this.structMembers)t=Math.max(t,r.type.getLayoutAlignment(e));return"std140"===e&&(t=B(t,16)),t}getLayoutSize(e){let t=0,r=0;for(const s of this.structMembers){const i=s.type.getLayoutAlignment(e);t=B(t,i),t+=s.type.getLayoutSize(e),r=Math.max(r,i)}return B(t,r)}toBufferLayout(e,t){const r={byteSize:0,entries:[]},s=e;for(const s of this.structMembers){e=B(e,s.type.getLayoutAlignment(t));const i=s.type.getLayoutSize(t);r.entries.push({name:s.name,offset:e,byteSize:i,type:V(s.type),subLayout:s.type.isStructType()?s.type.toBufferLayout(e,t):null,arraySize:s.type.isArrayType()?s.type.dimension:0}),e+=i}return r.byteSize="std140"===t?B(e-s,16):e-s,r}clone(e){return new ne(e||this.structName,this.layout,this.structMembers)}reset(e,t,r){this.detail={layout:t||"default",structName:e,structMembers:r.map(e=>{const t=D(e.type),r=$(e.type);return{name:e.name,type:e.type,alignment:t,size:r,defaultAlignment:t,defaultSize:r}})},"std140"===this.layout?this.calcAlignmentAndSizeSTD140():"std430"===this.layout&&this.calcAlignmentAndSizePacked(),this.id=null}genTypeId(){return`STRUCT:${this.structName}:${this.layout}:${this.structMembers.map(e=>`${e.name}(${e.type.typeId})`).join(":")}`}calcAlignmentAndSizeSTD140(){for(const e of this.structMembers)if(e.type.isPrimitiveType()){if(e.type.isMatrixType()&&2===e.type.cols)throw new Error(`matrix${e.type.rows}x${e.type.cols} can not be used in std140 layout`)}else{if(e.type.isArrayType()&&(e.type.elementType.isAnyType()||16!==D(e.type.elementType)))throw new Error("array element must be 16 bytes aligned in std140 layout");e.type.isStructType()&&(e.alignment=16,e.size=B(e.defaultSize,16))}}calcAlignmentAndSizePacked(){for(const e of this.structMembers)e.alignment=U(),e.size=G(e.type)}}class ae extends se{constructor(e,t){super(2,{elementType:e,dimension:Number(t)||0})}get elementType(){return this.detail.elementType}get dimension(){return this.detail.dimension}haveAtomicMembers(){return this.elementType.isStructType()||this.elementType.isArrayType()?this.elementType.haveAtomicMembers():this.elementType.isAtomicI32()||this.elementType.isAtomicU32()}isArrayType(){return!0}isHostSharable(){return this.detail.elementType.isHostSharable()}isConstructible(){return this.dimension&&this.detail.elementType.isConstructible()}isStorable(){return!0}getConstructorOverloads(e){const t=this.toTypeName(e),r=[new le(t,this,[])];return"webgl"!==e&&this.isConstructible()&&r.push(new le(t,this,Array.from({length:this.dimension}).map(()=>({type:this.elementType})))),r}toTypeName(e,r){if("webgpu"===e){const t=`array<${this.elementType.toTypeName(e)}${this.dimension?", "+this.dimension:""}>`;return r?`${r}: ${t}`:t}t(!!this.dimension,"runtime-sized array not supported for webgl"),t(!this.elementType.isArrayType(),"multi-dimensional arrays not supported for webgl");return`${this.elementType.toTypeName(e,r)}[${this.dimension}]`}getLayoutAlignment(e){return"packed"===e||this.elementType.isAnyType()?1:"std430"===e?this.elementType.getLayoutAlignment(e):B(this.elementType.getLayoutAlignment(e),16)}getLayoutSize(e){const t=this.elementType.isAnyType()?1:this.elementType.getLayoutAlignment(e);if("std140"===e&&15&t)throw new Error("Error: array element stride of std140 must be multiple of 16");return this.elementType.isAnyType()?0:this.dimension*B(this.elementType.getLayoutSize(e),t)}toBufferLayout(e){return null}isCompatibleType(e){return!!e.isArrayType()&&((0===this.dimension||e.dimension===this.dimension)&&this.elementType.isCompatibleType(e.elementType))}genTypeId(){return`ARRAY:(${this.elementType.typeId})[${this.dimension}]`}}class oe extends se{writable;constructor(e,r){super(3,{pointerType:e,addressSpace:r}),t(e.isStorable(),"the pointee type must be storable"),this.writable=!1}get pointerType(){return this.detail.pointerType}get addressSpace(){return this.detail.addressSpace}set addressSpace(e){this.detail.addressSpace!==e&&(this.detail.addressSpace=e,this.id=null)}haveAtomicMembers(){return this.pointerType.haveAtomicMembers()}isPointerType(){return!0}toTypeName(e,t){if("webgpu"===e){const r="unknown"===this.addressSpace?"function":this.addressSpace,s="storage"===r&&this.writable?", read_write":"",i=`ptr<${r}, ${this.pointerType.toTypeName(e)} ${s}>`;return t?`${t}: ${i}`:i}throw new Error("pointer type not supported for webgl")}toBufferLayout(e){return null}genTypeId(){return`PTR:(${this.pointerType.typeId})`}}class ue extends se{constructor(e){super(7,{accessMode:e})}get accessMode(){return this.detail.accessMode}isSamplerType(){return!0}isStorable(){return!0}toTypeName(e,t){if("webgpu"===e){const e=1===this.accessMode?"sampler":"sampler_comparison";return t?`${t}: ${e}`:e}throw new Error("sampler type not supported for webgl")}toBufferLayout(e){return null}genTypeId(){return`SAMPLER:${this.accessMode}`}}class he extends se{constructor(e,r,s,i){super(6,{textureType:e,readable:s,writable:i,storageTexelFormat:r||null}),t(!!J[e],"unsupported texture type"),t(!(e&H&&!ee[r]),"invalid texel format for storage texture")}get textureType(){return this.detail.textureType}get storageTexelFormat(){return this.detail.storageTexelFormat}get readable(){return this.detail.readable}set readable(e){this.detail.readable=!!e}get writable(){return this.detail.writable}set writable(e){this.detail.writable=!!e}isStorable(){return!0}is1DTexture(){return!!(1&this.detail.textureType)}is2DTexture(){return!!(2&this.detail.textureType)}is3DTexture(){return!!(4&this.detail.textureType)}isCubeTexture(){return!!(8&this.detail.textureType)}isArrayTexture(){return!!(this.detail.textureType&z)}isStorageTexture(){return!!(this.detail.textureType&H)}isDepthTexture(){return!!(this.detail.textureType&Y)}isMultisampledTexture(){return!!(32&this.detail.textureType)}isExternalTexture(){return!!(2048&this.detail.textureType)}isIntTexture(){return!!(this.detail.textureType&j)}isUIntTexture(){return!!(this.detail.textureType&K)}isTextureType(){return!0}toTypeName(e,r){if("webgpu"===e){let e=J[this.textureType];if(this.isStorageTexture()){e=`${e}<${ee[this.storageTexelFormat]}, ${this.writable?this.readable?"read_write":"write":"read"}>`}return r?`${r}: ${e}`:e}{const s=("webgl"===e?q:Q)[this.textureType];return t(!!s,"unsupported texture type"),r?`${s} ${r}`:s}}toBufferLayout(e){return null}genTypeId(){return`TEXTURE:${this.textureType}:${this.textureType&H?this.storageTexelFormat:""}`}}class le extends se{constructor(e,t,r){super(8,{name:e,returnType:t,argTypes:r})}get name(){return this.detail.name}get returnType(){return this.detail.returnType}get argTypes(){return this.detail.argTypes}get argHash(){return this.argTypes.map(e=>e.type.typeId).join(",")}genTypeId(){return`fn(${this.argHash}):${this.returnType.typeId}`}toBufferLayout(e){return null}toTypeName(){throw new Error("not supported")}}ie.getCachedTypeInfo(X.F16),ie.getCachedTypeInfo(X.F16VEC2),ie.getCachedTypeInfo(X.F16VEC3),ie.getCachedTypeInfo(X.F16VEC4);const ce=ie.getCachedTypeInfo(X.F32),_e=ie.getCachedTypeInfo(X.F32VEC2),pe=ie.getCachedTypeInfo(X.F32VEC3),fe=ie.getCachedTypeInfo(X.F32VEC4);ie.getCachedTypeInfo(X.I8),ie.getCachedTypeInfo(X.I8VEC2),ie.getCachedTypeInfo(X.I8VEC3),ie.getCachedTypeInfo(X.I8VEC4),ie.getCachedTypeInfo(X.I8_NORM),ie.getCachedTypeInfo(X.I8VEC2_NORM),ie.getCachedTypeInfo(X.I8VEC3_NORM),ie.getCachedTypeInfo(X.I8VEC4_NORM),ie.getCachedTypeInfo(X.I16),ie.getCachedTypeInfo(X.I16VEC2),ie.getCachedTypeInfo(X.I16VEC3),ie.getCachedTypeInfo(X.I16VEC4),ie.getCachedTypeInfo(X.I16_NORM),ie.getCachedTypeInfo(X.I16VEC2_NORM),ie.getCachedTypeInfo(X.I16VEC3_NORM),ie.getCachedTypeInfo(X.I16VEC4_NORM);const me=new class extends se{constructor(){super(4,null)}haveAtomicMembers(){return!0}isAtomicI32(){return!0}isHostSharable(){return!0}isStorable(){return!0}toTypeName(e,t){if("webgpu"===e){const e="atomic<i32>";return t?`${t}: ${e}`:e}throw new Error("atomic type not supported for webgl")}toBufferLayout(e){return null}getLayoutAlignment(e){return 4}getLayoutSize(){return this.getSize()}getSize(){return 4}genTypeId(){return"ATOMICI32"}},de=new class extends se{constructor(){super(5,null)}haveAtomicMembers(){return!0}isAtomicU32(){return!0}isHostSharable(){return!0}isStorable(){return!0}toTypeName(e,t){if("webgpu"===e){const e="atomic<u32>";return t?`${t}: ${e}`:e}throw new Error("atomic type not supported for webgl")}toBufferLayout(e){return null}getLayoutAlignment(e){return 4}getLayoutSize(){return this.getSize()}getSize(){return 4}genTypeId(){return"ATOMICU32"}},Ee=ie.getCachedTypeInfo(X.I32),Te=ie.getCachedTypeInfo(X.I32VEC2),xe=ie.getCachedTypeInfo(X.I32VEC3),ge=ie.getCachedTypeInfo(X.I32VEC4);ie.getCachedTypeInfo(X.I32),ie.getCachedTypeInfo(X.I32VEC2_NORM),ie.getCachedTypeInfo(X.I32VEC3_NORM),ie.getCachedTypeInfo(X.I32VEC4_NORM),ie.getCachedTypeInfo(X.U8),ie.getCachedTypeInfo(X.U8VEC2),ie.getCachedTypeInfo(X.U8VEC3),ie.getCachedTypeInfo(X.U8VEC4),ie.getCachedTypeInfo(X.U8_NORM),ie.getCachedTypeInfo(X.U8VEC2_NORM),ie.getCachedTypeInfo(X.U8VEC3_NORM),ie.getCachedTypeInfo(X.U8VEC4_NORM),ie.getCachedTypeInfo(X.U16),ie.getCachedTypeInfo(X.U16VEC2),ie.getCachedTypeInfo(X.U16VEC3),ie.getCachedTypeInfo(X.U16VEC4),ie.getCachedTypeInfo(X.U16_NORM),ie.getCachedTypeInfo(X.U16VEC2_NORM),ie.getCachedTypeInfo(X.U16VEC3_NORM),ie.getCachedTypeInfo(X.U16VEC4_NORM);const ye=ie.getCachedTypeInfo(X.U32),Ae=ie.getCachedTypeInfo(X.U32VEC2),be=ie.getCachedTypeInfo(X.U32VEC3),Re=ie.getCachedTypeInfo(X.U32VEC4);ie.getCachedTypeInfo(X.U32_NORM),ie.getCachedTypeInfo(X.U32VEC2_NORM),ie.getCachedTypeInfo(X.U32VEC3_NORM),ie.getCachedTypeInfo(X.U32VEC4_NORM);const Se=ie.getCachedTypeInfo(X.BOOL),Ce=ie.getCachedTypeInfo(X.BVEC2),Ie=ie.getCachedTypeInfo(X.BVEC3),Fe=ie.getCachedTypeInfo(X.BVEC4),Ne=ie.getCachedTypeInfo(X.MAT2),ve=ie.getCachedTypeInfo(X.MAT2x3),we=ie.getCachedTypeInfo(X.MAT2x4),Le=ie.getCachedTypeInfo(X.MAT3x2),Oe=ie.getCachedTypeInfo(X.MAT3),Me=ie.getCachedTypeInfo(X.MAT3x4),Be=ie.getCachedTypeInfo(X.MAT4x2),De=ie.getCachedTypeInfo(X.MAT4x3),Ue=ie.getCachedTypeInfo(X.MAT4),$e=new he(Z.TEX_1D),Ge=new he(Z.ITEX_1D),Pe=new he(Z.UTEX_1D),Ve=new he(Z.TEX_2D),Xe=new he(Z.ITEX_2D),We=new he(Z.UTEX_2D),ke=new he(Z.TEX_2D_ARRAY),ze=new he(Z.ITEX_2D_ARRAY),He=new he(Z.UTEX_2D_ARRAY),Ye=new he(Z.TEX_3D),je=new he(Z.ITEX_3D),Ke=new he(Z.UTEX_3D),Ze=new he(Z.TEX_CUBE),qe=new he(Z.ITEX_CUBE),Qe=new he(Z.UTEX_CUBE),Je=new he(Z.TEX_EXTERNAL),et=new he(Z.TEX_CUBE_ARRAY),tt=new he(Z.ITEX_CUBE_ARRAY),rt=new he(Z.UTEX_CUBE_ARRAY),st=new he(Z.TEX_MULTISAMPLED_2D),it=new he(Z.ITEX_MULTISAMPLED_2D),nt=new he(Z.UTEX_MULTISAMPLED_2D),at=new he(Z.TEX_STORAGE_1D,"rgba8unorm"),ot=new he(Z.TEX_STORAGE_1D,"rgba8snorm"),ut=new he(Z.TEX_STORAGE_1D,"rgba8unorm"),ht=new he(Z.TEX_STORAGE_1D,"rgba8ui"),lt=new he(Z.TEX_STORAGE_1D,"rgba8i"),ct=new he(Z.TEX_STORAGE_1D,"rgba16ui"),_t=new he(Z.TEX_STORAGE_1D,"rgba16i"),pt=new he(Z.TEX_STORAGE_1D,"rgba16f"),ft=new he(Z.TEX_STORAGE_1D,"rgba32ui"),mt=new he(Z.TEX_STORAGE_1D,"rgba32i"),dt=new he(Z.TEX_STORAGE_1D,"rgba32f"),Et=new he(Z.TEX_STORAGE_1D,"rg32ui"),Tt=new he(Z.TEX_STORAGE_1D,"rg32i"),xt=new he(Z.TEX_STORAGE_1D,"rg32f"),gt=new he(Z.TEX_STORAGE_1D,"r32ui"),yt=new he(Z.TEX_STORAGE_1D,"r32i"),At=new he(Z.TEX_STORAGE_1D,"r32f"),bt=new he(Z.TEX_STORAGE_2D,"rgba8unorm"),Rt=new he(Z.TEX_STORAGE_2D,"rgba8snorm"),St=new he(Z.TEX_STORAGE_2D,"bgra8unorm"),Ct=new he(Z.TEX_STORAGE_2D,"rgba8ui"),It=new he(Z.TEX_STORAGE_2D,"rgba8i"),Ft=new he(Z.TEX_STORAGE_2D,"rgba16ui"),Nt=new he(Z.TEX_STORAGE_2D,"rgba16i"),vt=new he(Z.TEX_STORAGE_2D,"rgba16f"),wt=new he(Z.TEX_STORAGE_2D,"rgba32ui"),Lt=new he(Z.TEX_STORAGE_2D,"rgba32i"),Ot=new he(Z.TEX_STORAGE_2D,"rgba32f"),Mt=new he(Z.TEX_STORAGE_2D,"rg32ui"),Bt=new he(Z.TEX_STORAGE_2D,"rg32i"),Dt=new he(Z.TEX_STORAGE_2D,"rg32f"),Ut=new he(Z.TEX_STORAGE_2D,"r32ui"),$t=new he(Z.TEX_STORAGE_2D,"r32i"),Gt=new he(Z.TEX_STORAGE_2D,"r32f"),Pt=new he(Z.TEX_STORAGE_2D_ARRAY,"rgba8unorm"),Vt=new he(Z.TEX_STORAGE_2D_ARRAY,"rgba8snorm");new he(Z.TEX_STORAGE_2D_ARRAY,"bgra8unorm");const Xt=new he(Z.TEX_STORAGE_2D_ARRAY,"rgba8ui"),Wt=new he(Z.TEX_STORAGE_2D_ARRAY,"rgba8i"),kt=new he(Z.TEX_STORAGE_2D_ARRAY,"rgba16ui"),zt=new he(Z.TEX_STORAGE_2D_ARRAY,"rgba16i"),Ht=new he(Z.TEX_STORAGE_2D_ARRAY,"rgba16f"),Yt=new he(Z.TEX_STORAGE_2D_ARRAY,"rgba32ui"),jt=new he(Z.TEX_STORAGE_2D_ARRAY,"rgba32i"),Kt=new he(Z.TEX_STORAGE_2D_ARRAY,"rgba32f"),Zt=new he(Z.TEX_STORAGE_2D_ARRAY,"rg32ui"),qt=new he(Z.TEX_STORAGE_2D_ARRAY,"rg32i"),Qt=new he(Z.TEX_STORAGE_2D_ARRAY,"rg32f"),Jt=new he(Z.TEX_STORAGE_2D_ARRAY,"r32ui"),er=new he(Z.TEX_STORAGE_2D_ARRAY,"r32i"),tr=new he(Z.TEX_STORAGE_2D_ARRAY,"r32f"),rr=new he(Z.TEX_STORAGE_3D,"rgba8unorm"),sr=new he(Z.TEX_STORAGE_3D,"rgba8snorm"),ir=new he(Z.TEX_STORAGE_3D,"bgra8unorm"),nr=new he(Z.TEX_STORAGE_3D,"rgba8ui"),ar=new he(Z.TEX_STORAGE_3D,"rgba8i"),or=new he(Z.TEX_STORAGE_3D,"rgba16ui"),ur=new he(Z.TEX_STORAGE_3D,"rgba16i"),hr=new he(Z.TEX_STORAGE_3D,"rgba16f"),lr=new he(Z.TEX_STORAGE_3D,"rgba32ui"),cr=new he(Z.TEX_STORAGE_3D,"rgba32i"),_r=new he(Z.TEX_STORAGE_3D,"rgba32f"),pr=new he(Z.TEX_STORAGE_3D,"rg32ui"),fr=new he(Z.TEX_STORAGE_3D,"rg32i"),mr=new he(Z.TEX_STORAGE_3D,"rg32f"),dr=new he(Z.TEX_STORAGE_3D,"r32ui"),Er=new he(Z.TEX_STORAGE_3D,"r32i"),Tr=new he(Z.TEX_STORAGE_3D,"r32f"),xr=new he(Z.TEX_DEPTH_2D),gr=new he(Z.TEX_DEPTH_2D_ARRAY),yr=new he(Z.TEX_DEPTH_CUBE),Ar=new he(Z.TEX_DEPTH_CUBE_ARRAY),br=new he(Z.TEX_DEPTH_MULTISAMPLED_2D),Rr=new ue(1),Sr=new ue(2),Cr=new class extends se{constructor(){super(9,null)}isVoidType(){return!0}toTypeName(){return"void"}genTypeId(){return"void"}toBufferLayout(e){return null}};new class extends se{constructor(){super(10,null)}isAnyType(){return!0}toTypeName(){return"any"}genTypeId(){return"any"}toBufferLayout(e){return null}isCompatibleType(e){return!0}};const Ir=new ne("FrexpResult","default",[{name:"sig",type:ce},{name:"exp",type:Ee}]),Fr=new ne("FrexpResultVec2","default",[{name:"sig",type:_e},{name:"exp",type:Te}]),Nr=new ne("FrexpResultVec3","default",[{name:"sig",type:pe},{name:"exp",type:xe}]),vr=new ne("FrexpResultVec4","default",[{name:"sig",type:fe},{name:"exp",type:ge}]),wr=0,Lr=1,Or=2,Mr=3,Br=4,Dr=5,Ur=6,$r=7,Gr=8,Pr=9,Vr=10,Xr=11,Wr=12,kr=13,zr={position_u8normx2:[0,X.U8VEC2_NORM,2,"u8norm",2],position_u8normx4:[0,X.U8VEC4_NORM,4,"u8norm",4],position_i8normx2:[0,X.I8VEC2_NORM,2,"i8norm",2],position_i8normx4:[0,X.I8VEC4_NORM,4,"i8norm",4],position_u16x2:[0,X.U16VEC2,4,"u16",2],position_u16x4:[0,X.U16VEC4,8,"u16",4],position_i16x2:[0,X.I16VEC2,4,"i16",2],position_i16x4:[0,X.I16VEC4,8,"i16",4],position_u16normx2:[0,X.U16VEC2_NORM,4,"u16norm",2],position_u16normx4:[0,X.U16VEC4_NORM,8,"u16norm",4],position_i16normx2:[0,X.I16VEC2_NORM,4,"i16norm",2],position_i16normx4:[0,X.I16VEC4_NORM,8,"i16norm",4],position_f16x2:[0,X.F16VEC2,4,"f16",2],position_f16x4:[0,X.F16VEC4,8,"f16",4],position_f32:[0,X.F32,4,"f32",1],position_f32x2:[0,X.F32VEC2,8,"f32",2],position_f32x3:[0,X.F32VEC3,12,"f32",3],position_f32x4:[0,X.F32VEC4,16,"f32",4],position_i32:[0,X.I32,4,"i32",1],position_i32x2:[0,X.I32VEC2,8,"i32",2],position_i32x3:[0,X.I32VEC3,12,"i32",3],position_i32x4:[0,X.I32VEC4,16,"i32",4],position_u32:[0,X.U32,4,"u32",1],position_u32x2:[0,X.U32VEC2,8,"u32",2],position_u32x3:[0,X.U32VEC3,12,"u32",3],position_u32x4:[0,X.U32VEC4,16,"u32",4],normal_f16x4:[1,X.F16VEC4,8,"f16",4],normal_f32x3:[1,X.F32VEC3,12,"f32",3],normal_f32x4:[1,X.F32VEC4,16,"f32",4],diffuse_u8normx4:[2,X.U8VEC4_NORM,4,"u8norm",4],diffuse_u16x4:[2,X.U16VEC4,8,"u16",4],diffuse_u16normx4:[2,X.U16VEC4_NORM,8,"u16norm",4],diffuse_f16x4:[2,X.F16VEC4,8,"f16",4],diffuse_f32x3:[2,X.F32VEC3,12,"f32",3],diffuse_f32x4:[2,X.F32VEC4,16,"f32",4],diffuse_u32x3:[2,X.U32VEC3,12,"u32",3],diffuse_u32x4:[2,X.U32VEC4,16,"u32",4],tangent_f16x4:[3,X.F16VEC4,8,"f16",4],tangent_f32x3:[3,X.F32VEC3,12,"f32",3],tangent_f32x4:[3,X.F32VEC4,16,"f32",4],tex0_u8normx2:[4,X.U8VEC2_NORM,2,"u8norm",2],tex0_u8normx4:[4,X.U8VEC4_NORM,4,"u8norm",4],tex0_i8normx2:[4,X.I8VEC2_NORM,2,"i8norm",2],tex0_i8normx4:[4,X.I8VEC4_NORM,4,"i8norm",4],tex0_u16x2:[4,X.U16VEC2,4,"u16",2],tex0_u16x4:[4,X.U16VEC4,8,"u16",4],tex0_i16x2:[4,X.I16VEC2,4,"i16",2],tex0_i16x4:[4,X.I16VEC4,8,"i16",4],tex0_u16normx2:[4,X.U16VEC2_NORM,4,"u16norm",2],tex0_u16normx4:[4,X.U16VEC4_NORM,8,"u16norm",4],tex0_i16normx2:[4,X.I16VEC2_NORM,4,"i16norm",2],tex0_i16normx4:[4,X.I16VEC4_NORM,8,"i16norm",4],tex0_f16x2:[4,X.F16VEC2,4,"f16",2],tex0_f16x4:[4,X.F16VEC4,8,"f16",4],tex0_f32:[4,X.F32,4,"f32",1],tex0_f32x2:[4,X.F32VEC2,8,"f32",2],tex0_f32x3:[4,X.F32VEC3,12,"f32",3],tex0_f32x4:[4,X.F32VEC4,16,"f32",4],tex0_i32:[4,X.I32,4,"i32",1],tex0_i32x2:[4,X.I32VEC2,8,"i32",2],tex0_i32x3:[4,X.I32VEC3,12,"i32",3],tex0_i32x4:[4,X.I32VEC4,16,"i32",4],tex0_u32:[4,X.U32,4,"u32",1],tex0_u32x2:[4,X.U32VEC2,8,"u32",2],tex0_u32x3:[4,X.U32VEC3,12,"u32",3],tex0_u32x4:[4,X.U32VEC4,16,"u32",4],tex1_u8normx2:[5,X.U8VEC2_NORM,2,"u8norm",2],tex1_u8normx4:[5,X.U8VEC4_NORM,4,"u8norm",4],tex1_i8normx2:[5,X.I8VEC2_NORM,2,"i8norm",2],tex1_i8normx4:[5,X.I8VEC4_NORM,4,"i8norm",4],tex1_u16x2:[5,X.U16VEC2,4,"u16",2],tex1_u16x4:[5,X.U16VEC4,8,"u16",4],tex1_i16x2:[5,X.I16VEC2,4,"i16",2],tex1_i16x4:[5,X.I16VEC4,8,"i16",4],tex1_u16normx2:[5,X.U16VEC2_NORM,4,"u16norm",2],tex1_u16normx4:[5,X.U16VEC4_NORM,8,"u16norm",4],tex1_i16normx2:[5,X.I16VEC2_NORM,4,"i16norm",2],tex1_i16normx4:[5,X.I16VEC4_NORM,8,"i16norm",4],tex1_f16x2:[5,X.F16VEC2,4,"f16",2],tex1_f16x4:[5,X.F16VEC4,8,"f16",4],tex1_f32:[5,X.F32,4,"f32",1],tex1_f32x2:[5,X.F32VEC2,8,"f32",2],tex1_f32x3:[5,X.F32VEC3,12,"f32",3],tex1_f32x4:[5,X.F32VEC4,16,"f32",4],tex1_i32:[5,X.I32,4,"i32",1],tex1_i32x2:[5,X.I32VEC2,8,"i32",2],tex1_i32x3:[5,X.I32VEC3,12,"i32",3],tex1_i32x4:[5,X.I32VEC4,16,"i32",4],tex1_u32:[5,X.U32,4,"u32",1],tex1_u32x2:[5,X.U32VEC2,8,"u32",2],tex1_u32x3:[5,X.U32VEC3,12,"u32",3],tex1_u32x4:[5,X.U32VEC4,16,"u32",4],tex2_u8normx2:[6,X.U8VEC2_NORM,2,"u8norm",2],tex2_u8normx4:[6,X.U8VEC4_NORM,4,"u8norm",4],tex2_i8normx2:[6,X.I8VEC2_NORM,2,"i8norm",2],tex2_i8normx4:[6,X.I8VEC4_NORM,4,"i8norm",4],tex2_u16x2:[6,X.U16VEC2,4,"u16",2],tex2_u16x4:[6,X.U16VEC4,8,"u16",4],tex2_i16x2:[6,X.I16VEC2,4,"i16",2],tex2_i16x4:[6,X.I16VEC4,8,"i16",4],tex2_u16normx2:[6,X.U16VEC2_NORM,4,"u16norm",2],tex2_u16normx4:[6,X.U16VEC4_NORM,8,"u16norm",4],tex2_i16normx2:[6,X.I16VEC2_NORM,4,"i16norm",2],tex2_i16normx4:[6,X.I16VEC4_NORM,8,"i16norm",4],tex2_f16x2:[6,X.F16VEC2,4,"f16",2],tex2_f16x4:[6,X.F16VEC4,8,"f16",4],tex2_f32:[6,X.F32,4,"f32",1],tex2_f32x2:[6,X.F32VEC2,8,"f32",2],tex2_f32x3:[6,X.F32VEC3,12,"f32",3],tex2_f32x4:[6,X.F32VEC4,16,"f32",4],tex2_i32:[6,X.I32,4,"i32",1],tex2_i32x2:[6,X.I32VEC2,8,"i32",2],tex2_i32x3:[6,X.I32VEC3,12,"i32",3],tex2_i32x4:[6,X.I32VEC4,16,"i32",4],tex2_u32:[6,X.U32,4,"u32",1],tex2_u32x2:[6,X.U32VEC2,8,"u32",2],tex2_u32x3:[6,X.U32VEC3,12,"u32",3],tex2_u32x4:[6,X.U32VEC4,16,"u32",4],tex3_u8normx2:[7,X.U8VEC2_NORM,2,"u8norm",2],tex3_u8normx4:[7,X.U8VEC4_NORM,4,"u8norm",4],tex3_i8normx2:[7,X.I8VEC2_NORM,2,"i8norm",2],tex3_i8normx4:[7,X.I8VEC4_NORM,4,"i8norm",4],tex3_u16x2:[7,X.U16VEC2,4,"u16",2],tex3_u16x4:[7,X.U16VEC4,8,"u16",4],tex3_i16x2:[7,X.I16VEC2,4,"i16",2],tex3_i16x4:[7,X.I16VEC4,8,"i16",4],tex3_u16normx2:[7,X.U16VEC2_NORM,4,"u16norm",2],tex3_u16normx4:[7,X.U16VEC4_NORM,8,"u16norm",4],tex3_i16normx2:[7,X.I16VEC2_NORM,4,"i16norm",2],tex3_i16normx4:[7,X.I16VEC4_NORM,8,"i16norm",4],tex3_f16x2:[7,X.F16VEC2,4,"f16",2],tex3_f16x4:[7,X.F16VEC4,8,"f16",4],tex3_f32:[7,X.F32,4,"f32",1],tex3_f32x2:[7,X.F32VEC2,8,"f32",2],tex3_f32x3:[7,X.F32VEC3,12,"f32",3],tex3_f32x4:[7,X.F32VEC4,16,"f32",4],tex3_i32:[7,X.I32,4,"i32",1],tex3_i32x2:[7,X.I32VEC2,8,"i32",2],tex3_i32x3:[7,X.I32VEC3,12,"i32",3],tex3_i32x4:[7,X.I32VEC4,16,"i32",4],tex3_u32:[7,X.U32,4,"u32",1],tex3_u32x2:[7,X.U32VEC2,8,"u32",2],tex3_u32x3:[7,X.U32VEC3,12,"u32",3],tex3_u32x4:[7,X.U32VEC4,16,"u32",4],tex4_u8normx2:[8,X.U8VEC2_NORM,2,"u8norm",2],tex4_u8normx4:[8,X.U8VEC4_NORM,4,"u8norm",4],tex4_i8normx2:[8,X.I8VEC2_NORM,2,"i8norm",2],tex4_i8normx4:[8,X.I8VEC4_NORM,4,"i8norm",4],tex4_u16x2:[8,X.U16VEC2,4,"u16",2],tex4_u16x4:[8,X.U16VEC4,8,"u16",4],tex4_i16x2:[8,X.I16VEC2,4,"i16",2],tex4_i16x4:[8,X.I16VEC4,8,"i16",4],tex4_u16normx2:[8,X.U16VEC2_NORM,4,"u16norm",2],tex4_u16normx4:[8,X.U16VEC4_NORM,8,"u16norm",4],tex4_i16normx2:[8,X.I16VEC2_NORM,4,"i16norm",2],tex4_i16normx4:[8,X.I16VEC4_NORM,8,"i16norm",4],tex4_f16x2:[8,X.F16VEC2,4,"f16",2],tex4_f16x4:[8,X.F16VEC4,8,"f16",4],tex4_f32:[8,X.F32,4,"f32",1],tex4_f32x2:[8,X.F32VEC2,8,"f32",2],tex4_f32x3:[8,X.F32VEC3,12,"f32",3],tex4_f32x4:[8,X.F32VEC4,16,"f32",4],tex4_i32:[8,X.I32,4,"i32",1],tex4_i32x2:[8,X.I32VEC2,8,"i32",2],tex4_i32x3:[8,X.I32VEC3,12,"i32",3],tex4_i32x4:[8,X.I32VEC4,16,"i32",4],tex4_u32:[8,X.U32,4,"u32",1],tex4_u32x2:[8,X.U32VEC2,8,"u32",2],tex4_u32x3:[8,X.U32VEC3,12,"u32",3],tex4_u32x4:[8,X.U32VEC4,16,"u32",4],tex5_u8normx2:[9,X.U8VEC2_NORM,2,"u8norm",2],tex5_u8normx4:[9,X.U8VEC4_NORM,4,"u8norm",4],tex5_i8normx2:[9,X.I8VEC2_NORM,2,"i8norm",2],tex5_i8normx4:[9,X.I8VEC4_NORM,4,"i8norm",4],tex5_u16x2:[9,X.U16VEC2,4,"u16",2],tex5_u16x4:[9,X.U16VEC4,8,"u16",4],tex5_i16x2:[9,X.I16VEC2,4,"i16",2],tex5_i16x4:[9,X.I16VEC4,8,"i16",4],tex5_u16normx2:[9,X.U16VEC2_NORM,4,"u16norm",2],tex5_u16normx4:[9,X.U16VEC4_NORM,8,"u16norm",4],tex5_i16normx2:[9,X.I16VEC2_NORM,4,"i16norm",2],tex5_i16normx4:[9,X.I16VEC4_NORM,8,"i16norm",4],tex5_f16x2:[9,X.F16VEC2,4,"f16",2],tex5_f16x4:[9,X.F16VEC4,8,"f16",4],tex5_f32:[9,X.F32,4,"f32",1],tex5_f32x2:[9,X.F32VEC2,8,"f32",2],tex5_f32x3:[9,X.F32VEC3,12,"f32",3],tex5_f32x4:[9,X.F32VEC4,16,"f32",4],tex5_i32:[9,X.I32,4,"i32",1],tex5_i32x2:[9,X.I32VEC2,8,"i32",2],tex5_i32x3:[9,X.I32VEC3,12,"i32",3],tex5_i32x4:[9,X.I32VEC4,16,"i32",4],tex5_u32:[9,X.U32,4,"u32",1],tex5_u32x2:[9,X.U32VEC2,8,"u32",2],tex5_u32x3:[9,X.U32VEC3,12,"u32",3],tex5_u32x4:[9,X.U32VEC4,16,"u32",4],tex6_u8normx2:[Vr,X.U8VEC2_NORM,2,"u8norm",2],tex6_u8normx4:[Vr,X.U8VEC4_NORM,4,"u8norm",4],tex6_i8normx2:[Vr,X.I8VEC2_NORM,2,"i8norm",2],tex6_i8normx4:[Vr,X.I8VEC4_NORM,4,"i8norm",4],tex6_u16x2:[Vr,X.U16VEC2,4,"u16",2],tex6_u16x4:[Vr,X.U16VEC4,8,"u16",4],tex6_i16x2:[Vr,X.I16VEC2,4,"i16",2],tex6_i16x4:[Vr,X.I16VEC4,8,"i16",4],tex6_u16normx2:[Vr,X.U16VEC2_NORM,4,"u16norm",2],tex6_u16normx4:[Vr,X.U16VEC4_NORM,8,"u16norm",4],tex6_i16normx2:[Vr,X.I16VEC2_NORM,4,"i16norm",2],tex6_i16normx4:[Vr,X.I16VEC4_NORM,8,"i16norm",4],tex6_f16x2:[Vr,X.F16VEC2,4,"f16",2],tex6_f16x4:[Vr,X.F16VEC4,8,"f16",4],tex6_f32:[Vr,X.F32,4,"f32",1],tex6_f32x2:[Vr,X.F32VEC2,8,"f32",2],tex6_f32x3:[Vr,X.F32VEC3,12,"f32",3],tex6_f32x4:[Vr,X.F32VEC4,16,"f32",4],tex6_i32:[Vr,X.I32,4,"i32",1],tex6_i32x2:[Vr,X.I32VEC2,8,"i32",2],tex6_i32x3:[Vr,X.I32VEC3,12,"i32",3],tex6_i32x4:[Vr,X.I32VEC4,16,"i32",4],tex6_u32:[Vr,X.U32,4,"u32",1],tex6_u32x2:[Vr,X.U32VEC2,8,"u32",2],tex6_u32x3:[Vr,X.U32VEC3,12,"u32",3],tex6_u32x4:[Vr,X.U32VEC4,16,"u32",4],tex7_u8normx2:[Xr,X.U8VEC2_NORM,2,"u8norm",2],tex7_u8normx4:[Xr,X.U8VEC4_NORM,4,"u8norm",4],tex7_i8normx2:[Xr,X.I8VEC2_NORM,2,"i8norm",2],tex7_i8normx4:[Xr,X.I8VEC4_NORM,4,"i8norm",4],tex7_u16x2:[Xr,X.U16VEC2,4,"u16",2],tex7_u16x4:[Xr,X.U16VEC4,8,"u16",4],tex7_i16x2:[Xr,X.I16VEC2,4,"i16",2],tex7_i16x4:[Xr,X.I16VEC4,8,"i16",4],tex7_u16normx2:[Xr,X.U16VEC2_NORM,4,"u16norm",2],tex7_u16normx4:[Xr,X.U16VEC4_NORM,8,"u16norm",4],tex7_i16normx2:[Xr,X.I16VEC2_NORM,4,"i16norm",2],tex7_i16normx4:[Xr,X.I16VEC4_NORM,8,"i16norm",4],tex7_f16x2:[Xr,X.F16VEC2,4,"f16",2],tex7_f16x4:[Xr,X.F16VEC4,8,"f16",4],tex7_f32:[Xr,X.F32,4,"f32",1],tex7_f32x2:[Xr,X.F32VEC2,8,"f32",2],tex7_f32x3:[Xr,X.F32VEC3,12,"f32",3],tex7_f32x4:[Xr,X.F32VEC4,16,"f32",4],tex7_i32:[Xr,X.I32,4,"i32",1],tex7_i32x2:[Xr,X.I32VEC2,8,"i32",2],tex7_i32x3:[Xr,X.I32VEC3,12,"i32",3],tex7_i32x4:[Xr,X.I32VEC4,16,"i32",4],tex7_u32:[Xr,X.U32,4,"u32",1],tex7_u32x2:[Xr,X.U32VEC2,8,"u32",2],tex7_u32x3:[Xr,X.U32VEC3,12,"u32",3],tex7_u32x4:[Xr,X.U32VEC4,16,"u32",4],blendweights_f16x1:[Wr,X.F16,2,"f16",1],blendweights_f32x1:[Wr,X.F32,4,"f32",1],blendweights_f16x2:[Wr,X.F16VEC2,4,"f16",2],blendweights_f32x2:[Wr,X.F32VEC2,8,"f32",2],blendweights_f16x3:[Wr,X.F16VEC3,6,"f16",3],blendweights_f32x3:[Wr,X.F32VEC3,12,"f32",3],blendweights_f16x4:[Wr,X.F16VEC4,8,"f16",4],blendweights_f32x4:[Wr,X.F32VEC4,16,"f32",4],blendindices_u16x1:[kr,X.U16,2,"u16",1],blendindices_f16x1:[kr,X.F16,2,"f16",1],blendindices_f32x1:[kr,X.F32,4,"f32",1],blendindices_u32x1:[kr,X.U32,4,"u32",1],blendindices_u16x2:[kr,X.U16VEC2,4,"u16",2],blendindices_f16x2:[kr,X.F16VEC2,4,"f16",2],blendindices_f32x2:[kr,X.F32VEC2,8,"f32",2],blendindices_u32x2:[kr,X.U32VEC2,8,"u32",2],blendindices_u16x3:[kr,X.U16VEC3,6,"u16",3],blendindices_f16x3:[kr,X.F16VEC3,6,"f16",3],blendindices_f32x3:[kr,X.F32VEC3,12,"f32",3],blendindices_u32x3:[kr,X.U32VEC3,12,"u32",3],blendindices_u16x4:[kr,X.U16VEC4,8,"u16",4],blendindices_f16x4:[kr,X.F16VEC4,8,"f16",4],blendindices_f32x4:[kr,X.F32VEC4,16,"f32",4],blendindices_u32x4:[kr,X.U32VEC4,16,"u32",4]},Hr={position:0,normal:1,diffuse:2,tangent:3,blendIndices:kr,blendWeights:Wr,texCoord0:4,texCoord1:5,texCoord2:6,texCoord3:7,texCoord4:8,texCoord5:9,texCoord6:Vr,texCoord7:Xr},Yr={[wr]:"position",[Lr]:"normal",[Or]:"diffuse",[Mr]:"tangent",[kr]:"blendIndices",[Wr]:"blendWeights",[Br]:"texCoord0",[Dr]:"texCoord1",[Ur]:"texCoord2",[$r]:"texCoord3",[Gr]:"texCoord4",[Pr]:"texCoord5",[Vr]:"texCoord6",[Xr]:"texCoord7"};var jr=function(e){return e[e.TF_LINEAR_COLOR_SPACE=2]="TF_LINEAR_COLOR_SPACE",e[e.TF_NO_MIPMAP=4]="TF_NO_MIPMAP",e[e.TF_WRITABLE=8]="TF_WRITABLE",e[e.TF_NO_GC=16]="TF_NO_GC",e[e.BF_VERTEX=32]="BF_VERTEX",e[e.BF_INDEX=64]="BF_INDEX",e[e.BF_READ=128]="BF_READ",e[e.BF_WRITE=256]="BF_WRITE",e[e.BF_UNIFORM=512]="BF_UNIFORM",e[e.BF_STORAGE=1024]="BF_STORAGE",e[e.BF_PACK_PIXEL=2048]="BF_PACK_PIXEL",e[e.BF_UNPACK_PIXEL=4096]="BF_UNPACK_PIXEL",e[e.DYNAMIC=8192]="DYNAMIC",e[e.MANAGED=16384]="MANAGED",e}({});function Kr(e){return Hr[e]}function Zr(e){return Yr[e]}function qr(e){return zr[e][2]}function Qr(e){const t=e.structMembers[0].type.elementType;if(t.isStructType()){let e=0;for(const r of t.structMembers)e+=r.type.getSize();return e}return t.getSize()}function Jr(e,t){const r=Zr(t);return r?function(e,t){const r=e.structMembers[0],s=r.type.elementType;if(s.isStructType()){for(const e of s.structMembers)if(e.name===t)return e.type;return null}return r.name===t?s:null}(e,r):null}function es(e,...t){if(0===t.length)return null;if(1===t.length){const r=zr[t[0]];return new ne(null,"packed",[{name:Zr(r[0]),type:new ae(ie.getCachedTypeInfo(r[1]),e)}])}{const r=new ne(null,"packed",t.map(e=>({name:Zr(zr[e][0]),type:ie.getCachedTypeInfo(zr[e][1])})));return new ne(null,"packed",[{name:"value",type:new ae(r,e)}])}}const ts=function(){const e=[];for(let t=0;t<16;t++)e.push(rs(t));return e}();function rs(e){switch(e){case 0:return"a_position";case 1:return"a_normal";case 2:return"a_diffuse";case 3:return"a_tangent";case 4:return"a_texcoord0";case 5:return"a_texcoord1";case 6:return"a_texcoord2";case 7:return"a_texcoord3";case 8:return"a_texcoord4";case 9:return"a_texcoord5";case Vr:return"a_texcoord6";case Xr:return"a_texcoord7";case kr:return"a_indices";case Wr:return"a_weight";default:return null}}class ss{_vertexBuffers;_indexBuffer;_drawOffset;_numVertices;constructor(){this._vertexBuffers=[];for(let e=0;e<16;e++)this._vertexBuffers.push(null);this._indexBuffer=null,this._drawOffset=0,this._numVertices=0}clone(){const e=new ss;return e._vertexBuffers=this._vertexBuffers.slice(),e._indexBuffer=this._indexBuffer,e._drawOffset=this._drawOffset,e.calcNumVertices(),e}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get numVertices(){return this._numVertices}getDrawOffset(){return this._drawOffset}setDrawOffset(e){e!==this._drawOffset&&(this._drawOffset=e,this.calcNumVertices())}getVertexBuffer(e){return this._vertexBuffers[Kr(e)]?.buffer??null}getVertexBufferInfo(e){return this._vertexBuffers[Kr(e)]??null}getIndexBuffer(){return this._indexBuffer||null}setVertexBuffer(e,t){if(!e)return null;if(!(e.usage&jr.BF_VERTEX))throw new Error("setVertexBuffer() failed: buffer is null or buffer has not Vertex usage flag");t=t||"vertex";const r=e.structure.structMembers[0].type.elementType;if(r.isStructType()){let s=0;for(const i of r.structMembers){const r=Kr(i.name);this.internalSetVertexBuffer(r,e,s,t),s+=i.size}}else{const r=Kr(e.structure.structMembers[0].name);this.internalSetVertexBuffer(r,e,0,t)}return e}removeVertexBuffer(e){let t=!1;for(let r=0;r<this._vertexBuffers.length;r++){const s=this._vertexBuffers[r];s?.buffer===e&&(this._vertexBuffers[r]=null,t=!0)}return t&&this.calcNumVertices(),t}setIndexBuffer(e){return e!==this._indexBuffer&&(this._indexBuffer=e||null),e}calcNumVertices(){this._numVertices=0;for(let e=0;e<16;e++){const t=this._vertexBuffers[e];if(t&&"instance"!==t.stepMode){const e=Math.floor(t.buffer.byteLength/t.stride);e>this._numVertices&&(this._numVertices=e)}}}internalSetVertexBuffer(e,t,r,s){if(e<0||e>=16)throw new Error(`setVertexBuffer() failed: location out of bounds: ${e}`);r=Number(r)||0,s=s||"vertex";const i=this._vertexBuffers[e];return i&&i.buffer===t&&i.offset===r&&i.stepMode===s?null:(this._vertexBuffers[e]={buffer:t,offset:r,type:Jr(t.structure,e),stride:Qr(t.structure),drawOffset:0,stepMode:s},this.calcNumVertices(),t)}}class is{_cpuTimer;_cpuStart;_cpuTime;_ended;constructor(){this._cpuTimer=window.performance||window.Date,this._cpuTime=null,this._ended=!1}now(){return this._cpuTimer.now()}begin(){this._cpuStart=this.now(),this._cpuTime=null,this._ended=!1}end(){this._cpuTime=this.now()-this._cpuStart,this._ended=!0}ended(){return this._ended}elapsed(){return this._cpuTime}}class ns{_memCost;_memCostThreshold;_device;_id;_freeTextures={};_allocatedTextures=new WeakMap;_autoReleaseTextures=new Set;_freeFramebuffers={};_allocatedFramebuffers=new WeakMap;_autoReleaseFramebuffers=new Set;constructor(e,t,r=1073741824){this._device=e,this._id=t,this._memCost=0,this._memCostThreshold=r,this._freeTextures={},this._allocatedTextures=new WeakMap,this._autoReleaseTextures=new Set,this._freeFramebuffers={},this._allocatedFramebuffers=new WeakMap,this._autoReleaseFramebuffers=new Set,this._memCost=0}get id(){return this._id}autoRelease(){for(const e of this._autoReleaseTextures)this.releaseTexture(e);this._autoReleaseTextures.clear();for(const e of this._autoReleaseFramebuffers)this.releaseFrameBuffer(e);this._autoReleaseFramebuffers.clear(),this._memCost>=this._memCostThreshold&&this.purge()}fetchTemporalTexture2D(e,t,r,s,i=!1){const n=`2d:${t}:${r}:${s}:${i?1:0}`;let a=null;const o=this._freeTextures[n];return o?(a=o.pop(),0===o.length&&(this._freeTextures[n]=void 0)):(a=this._device.createTexture2D(t,r,s,{mipmapping:i}),this._memCost+=a.memCost),this._allocatedTextures.set(a,{hash:n,refcount:1,dispose:!1}),e&&this._autoReleaseTextures.add(a),a}fetchTemporalTexture2DArray(e,t,r,s,i,n=!1){const a=`2darray:${t}:${r}:${s}:${i}:${n?1:0}`;let o=null;const u=this._freeTextures[a];return u?(o=u.pop(),0===u.length&&(this._freeTextures[a]=void 0)):(o=this._device.createTexture2DArray(t,r,s,i,{mipmapping:n}),this._memCost+=o.memCost),this._allocatedTextures.set(o,{hash:a,refcount:1,dispose:!1}),e&&this._autoReleaseTextures.add(o),o}fetchTemporalTextureCube(e,t,r,s=!1){const i=`cube:${t}:${r}:${s?1:0}`;let n=null;const a=this._freeTextures[i];return a?(n=a.pop(),0===a.length&&(this._freeTextures[i]=void 0)):(n=this._device.createCubeTexture(t,r,{mipmapping:s}),this._memCost+=n.memCost),this._allocatedTextures.set(n,{hash:i,refcount:1,dispose:!1}),e&&this._autoReleaseTextures.add(n),n}fetchTemporalFramebuffer(e,t,r,s,i=null,n=!1,a=1,o=!0,u=0,h=0,l=0){const c=Array.isArray(s)?s:s?[s]:[],_=c.map(e=>"string"==typeof e?this.fetchTemporalTexture2D(!1,e,t,r,n):e),p="string"==typeof i?this.fetchTemporalTexture2D(!1,i,t,r,!1):i,f=this.createTemporalFramebuffer(e,_,p,a,o,u,h,l);for(let e=0;e<c.length;e++)"string"==typeof c[e]&&this.releaseTexture(_[e]);return"string"==typeof i&&this.releaseTexture(p),f}createTemporalFramebuffer(e,t,r=null,s=1,i=!0,n=0,a=0,o=0){t=t??[];let u=`${r?.uid??0}:${s??1}:${i?1:0}`;if(t.length>0){u+=`:${n}:${a}:${o}`;for(const e of t)u+=`:${e.uid}`}let h=null;const l=this._freeFramebuffers[u];if(l)h=l.pop(),0===l.length&&(this._freeFramebuffers[u]=void 0);else{h=this._device.createFrameBuffer(t,r,{ignoreDepthStencil:i,sampleCount:s});for(let e=0;e<h.getColorAttachments().length;e++)h.setColorAttachmentMipLevel(e,n),h.setColorAttachmentCubeFace(e,a),h.setColorAttachmentLayer(e,o)}const c=this._allocatedTextures.get(r);c&&c.refcount++;for(const e of t){const t=this._allocatedTextures.get(e);t&&t.refcount++}return this._allocatedFramebuffers.set(h,{hash:u,refcount:1}),e&&this._autoReleaseFramebuffers.add(h),h}disposeTexture(e){this.safeReleaseTexture(e,!0)}releaseTexture(e){this._allocatedTextures.get(e)?this.safeReleaseTexture(e):console.error("ObjectPool.releaseTexture(): texture is not allocated from pool")}retainTexture(e){const t=this._allocatedTextures.get(e);t?t.refcount++:console.error("ObjectPool.retainTexture(): texture is not allocated from pool")}disposeFrameBuffer(e){this._allocatedFramebuffers.get(e)?(this.internalDisposeFrameBuffer(e),e.dispose()):console.error("ObjectPool.disposeFrameBuffer(): framebuffer is not allocated from pool")}releaseFrameBuffer(e){const t=this._allocatedFramebuffers.get(e);if(t){if(t.refcount--,t.refcount<=0){this.internalDisposeFrameBuffer(e);const r=this._freeFramebuffers[t.hash];r?r.push(e):this._freeFramebuffers[t.hash]=[e]}}else console.error("ObjectPool.releaseFrameBuffer(): framebuffer is not allocated from pool")}retainFrameBuffer(e){const t=this._allocatedFramebuffers.get(e);t?t.refcount++:console.error("ObjectPool.retainFrameBuffer(): framebuffer is not allocated from pool")}purge(){for(const e in this._freeFramebuffers){if(this._freeFramebuffers[e])for(const t of this._freeFramebuffers[e])this.internalDisposeFrameBuffer(t),t.dispose()}this._freeFramebuffers={};for(const e in this._freeTextures){const t=this._freeTextures[e];for(const e of t)this._memCost-=e.memCost,e.dispose()}this._freeTextures={}}internalDisposeFrameBuffer(e){if(e){const t=e.getColorAttachments();if(t)for(const e of t)this.safeReleaseTexture(e);const r=e.getDepthAttachment();r&&this.safeReleaseTexture(r),this._allocatedFramebuffers.delete(e),this._autoReleaseFramebuffers.delete(e)}}safeReleaseTexture(e,t=!1){const r=this._allocatedTextures.get(e);if(r)if(r.refcount--,r.refcount<=0)if(this._allocatedTextures.delete(e),this._autoReleaseTextures.delete(e),t||r.dispose)this._memCost-=e.memCost,e.dispose();else{const t=this._freeTextures[r.hash];t?t.push(e):this._freeTextures[r.hash]=[e]}else t&&(r.dispose=!0)}}class as{_builder;_tagList;_attribList;constructor(e){this._builder=e,this._tagList={},this._attribList={}}get vertexAttributes(){return this._builder.getVertexAttributes()}hasVertexAttribute(e){return this.vertexAttributes.indexOf(e)>=0}clear(){this._tagList={},this._attribList={}}tag(e,t){if("string"==typeof e){if(void 0===t)return this.getTag(e);this.addTag(e,t)}else for(const t of Object.keys(e))this.addTag(t,e[t])}attribute(e){return this._attribList[e]||null}setAttrib(e,t){this._attribList[e]=t}addTag(e,t){this._tagList[e]=t}getTag(e){const t=this._tagList[e];return t?t(this._builder.getGlobalScope()):null}}function os(e,t){return"number"==typeof t||"boolean"==typeof t||Array.isArray(t)?`${t}`:t.$ast?.toString(e)}function us(e,t){return t?.toTypeName(e)}class hs extends Error{}class ls extends hs{value;constructor(e){super(),this.value=e}getMessage(e){return`value out of range: ${this.value}`}}class cs extends hs{value;valueType;expectedType;constructor(e,t,r){super(),this.value=e,this.valueType=t,this.expectedType=r}getMessage(e){return`cannot convert '${"string"==typeof this.value?this.value:os(e,this.value)}' of type '${"string"==typeof this.valueType?this.valueType:us(e,this.valueType)}' to type ${"string"==typeof this.expectedType?this.expectedType:us(e,this.expectedType)}`}}class _s extends hs{func;constructor(e){super(),this.func=e}getMessage(e){return`wrong argument count for function '${this.func}'`}}class ps extends hs{func;param;constructor(e,t){super(),this.func=e,this.param=t||null}getMessage(e){return`parameter type error for function '${this.func}': ${this.param}`}}class fs extends hs{func;param;reason;constructor(e,t,r){super(),this.func=e,this.param=t||null,this.reason=r||null}getMessage(e){return`invalid parameter value for function '${this.func}'${this.param?": "+this.param:""}${this.reason?": "+this.reason:""}}`}}class ms extends hs{func;constructor(e){super(),this.func=e}getMessage(e){return`No matched overloading found for function '${this.func}'`}}class ds extends hs{value;constructor(e){super(),this.value=e}getMessage(e){return`'${os(e,this.value)}' is not a reference type`}}class Es extends hs{value;constructor(e){super(),this.value=e}getMessage(e){return`'${os(e,this.value)}' is not a pointer type`}}class Ts extends hs{feature;constructor(e){super(),this.feature=e}getMessage(e){return`feature not support for ${e} device: ${this.feature}`}}class xs extends hs{funcName;constructor(e){super(),this.funcName=e}getMessage(e){return`function call must be made inside a function scope: ${this.funcName}()`}}class gs extends hs{ast;text;constructor(e,t){super(),this.ast=e,this.text=t}getMessage(e){return`${this.text}: ${this.ast.toString(e)}`}}class ys extends hs{constructor(e){super(e)}getMessage(e){return`Internal error: ${this.message}`}}let As=null;function bs(e){As=e}function Rs(){return As}const Ss="zVSInput",Cs="zVSOutput",Is="zFSInput",Fs="zFSOutput",Ns="zCSInput";var vs=function(e){return e[e.DECLARE_TYPE_NONE=0]="DECLARE_TYPE_NONE",e[e.DECLARE_TYPE_IN=1]="DECLARE_TYPE_IN",e[e.DECLARE_TYPE_OUT=2]="DECLARE_TYPE_OUT",e[e.DECLARE_TYPE_WORKGROUP=3]="DECLARE_TYPE_WORKGROUP",e[e.DECLARE_TYPE_UNIFORM=4]="DECLARE_TYPE_UNIFORM",e[e.DECLARE_TYPE_STORAGE=5]="DECLARE_TYPE_STORAGE",e}({}),ws=function(e){return e[e.NONE=0]="NONE",e[e.HIGH=1]="HIGH",e[e.MEDIUM=2]="MEDIUM",e[e.LOW=3]="LOW",e}({});function Ls(e){switch(e){case M.Vertex:return"zVertexInput";case M.Fragment:return"zVertexOutput";case M.Compute:return"zComputeInput";default:return null}}function Os(e){switch(e){case M.Vertex:return"zVSInputCpy";case M.Fragment:return"zFSInputCpy";case M.Compute:return"zCSInputCpy";default:return null}}function Ms(e){switch(e){case M.Vertex:return"zVSOutputCpy";case M.Fragment:return"zFSOutputCpy";case M.Compute:return"zCSOutputCpy";default:return null}}function Bs(e){switch(e){case M.Vertex:return Ss;case M.Fragment:return Is;case M.Compute:return Ns;default:return null}}function Ds(e,t){return`ch_auto_sampler_${e}${t?"_comparison":""}`}const Us={webgl:{position:{name:"gl_Position",type:new ie(X.F32VEC4),stage:"vertex"},pointSize:{name:"gl_PointSize",type:new ie(X.F32),stage:"vertex"},fragCoord:{name:"gl_FragCoord",type:new ie(X.F32VEC4),stage:"fragment"},frontFacing:{name:"gl_FrontFacing",type:new ie(X.BOOL),stage:"fragment"},fragDepth:{name:"gl_FragDepthEXT",type:new ie(X.F32),inOrOut:"out",extension:"GL_EXT_frag_depth",stage:"fragment"}},webgl2:{vertexIndex:{name:"gl_VertexID",semantic:"vertex_index",type:new ie(X.U32),inOrOut:"in",stage:"vertex"},instanceIndex:{name:"gl_InstanceID",semantic:"instance_index",type:new ie(X.U32),inOrOut:"in",stage:"vertex"},position:{name:"gl_Position",type:new ie(X.F32VEC4),stage:"vertex"},pointSize:{name:"gl_PointSize",type:new ie(X.F32),stage:"vertex"},fragCoord:{name:"gl_FragCoord",type:new ie(X.F32VEC4),stage:"fragment"},frontFacing:{name:"gl_FrontFacing",type:new ie(X.BOOL),stage:"fragment"},fragDepth:{name:"gl_FragDepth",type:new ie(X.F32),stage:"fragment"}},webgpu:{vertexIndex:{name:"zVertexId",semantic:"vertex_index",type:new ie(X.U32),inOrOut:"in",stage:"vertex"},instanceIndex:{name:"zInstanceId",semantic:"instance_index",type:new ie(X.U32),inOrOut:"in",stage:"vertex"},position:{name:"zPosition",semantic:"position",type:new ie(X.F32VEC4),inOrOut:"out",stage:"vertex"},fragCoord:{name:"zFragCoord",semantic:"position",type:new ie(X.F32VEC4),inOrOut:"in",stage:"fragment"},frontFacing:{name:"zFrontFacing",semantic:"front_facing",type:new ie(X.BOOL),inOrOut:"in",stage:"fragment"},fragDepth:{name:"zFragDepth",semantic:"frag_depth",type:new ie(X.F32),inOrOut:"out",stage:"fragment"},localInvocationId:{name:"zLocalInvocationId",semantic:"local_invocation_id",type:new ie(X.U32VEC3),inOrOut:"in",stage:"compute"},globalInvocationId:{name:"zGlobalInvocationId",semantic:"global_invocation_id",type:new ie(X.U32VEC3),inOrOut:"in",stage:"compute"},workGroupId:{name:"zWorkGroupId",semantic:"workgroup_id",type:new ie(X.U32VEC3),inOrOut:"in",stage:"compute"},numWorkGroups:{name:"zNumWorkGroups",semantic:"num_workgroups",type:new ie(X.U32VEC3),inOrOut:"in",stage:"compute"},sampleMaskIn:{name:"zSampleMaskIn",semantic:"sample_mask_in",type:new ie(X.U32),inOrOut:"in",stage:"fragment"},sampleMaskOut:{name:"zSampleMaskOut",semantic:"sample_mask_out",type:new ie(X.U32),inOrOut:"out",stage:"fragment"},sampleIndex:{name:"zSampleIndex",semantic:"sample_index",type:new ie(X.U32),inOrOut:"in",stage:"fragment"}}};function $s(e){return e%1==0?e.toFixed(1):String(e)}function Gs(e){return String(0|e)}function Ps(e){return String(e>>>0)}function Vs(e){if("("===(e=e.trim())[0]&&")"===e[e.length-1]){let t=0;for(let r=1;r<e.length-1;r++)if("("===e[r])t++;else if(")"===e[r]&&(t--,t<0))break;if(t>0)throw new ys(`Invalid expression: ${e}`);if(0===t)return e.substring(1,e.length-1)}return e}class Xs{isReference(){return!1}isPointer(){return!!this.getType()?.isPointerType()}getType(){return null}toWebGL(e,t){return""}toWebGL2(e,t){return""}toWGSL(e,t){return""}toString(e){return this.constructor.name}}class Ws extends Xs{}class ks extends Ws{paramAST;writable;constructor(e){super(),this.paramAST=e,this.writable=!1}getType(){return this.paramAST.getType()}markWritable(){this.paramAST instanceof js&&console.warn(`Write to non-output parameter ${this.paramAST.value.$str}`),this.writable=!0}isWritable(){return this.writable}getAddressSpace(){return this.paramAST.getAddressSpace()}isConstExp(){return this.paramAST.isConstExp()}isReference(){return this.paramAST.isReference()}toWebGL(e,t){return this.paramAST.toWebGL(e,t)}toWebGL2(e,t){return this.paramAST.toWebGL2(e,t)}toWGSL(e,t){return this.paramAST.toWGSL(e,t)}}class zs extends Xs{statements;constructor(){super(),this.statements=[]}toWebGL(e,t){return this.statements.filter(e=>!(e instanceof di)||e.isStatement).map(r=>r.toWebGL(e,t)).join("")}toWebGL2(e,t){return this.statements.filter(e=>!(e instanceof di)||e.isStatement).map(r=>r.toWebGL2(e,t)).join("")}toWGSL(e,t){return this.statements.filter(e=>!(e instanceof di)||e.isStatement).map(r=>r instanceof di&&!r.getType().isVoidType()?`${e}_ = ${r.toWGSL("",t)}`:r.toWGSL(e,t)).join("")}}class Hs extends zs{toWebGL(e,t){return`${e}{\n${super.toWebGL(e+" ",t)}${e}}\n`}toWebGL2(e,t){return`${e}{\n${super.toWebGL2(e+" ",t)}${e}}\n`}toWGSL(e,t){return`${e}{\n${super.toWGSL(e+" ",t)}${e}}\n`}}class Ys extends zs{uniforms;constructor(){super(),this.uniforms=[]}findFunctions(e){const t=[];for(const r of this.statements)r instanceof Ti&&r.name===e&&t.push(r);return t}toWebGL(e,t){const r=`${e}precision highp float;\n${e}precision highp int;\n`,s=`${e}#version 100\n`,i=t.types.map(r=>r.toWebGL(e,t)).join("")+this.uniforms.map(r=>r.toWebGL(e,t)).join("")+t.inputs.map(r=>r.toWebGL(e,t)).join("")+t.outputs.map(r=>r.toWebGL(e,t)).join("")+super.toWebGL(e,t);for(const e of t.builtins){const r=Us.webgl[e];r.extension&&t.extensions.add(r.extension)}return s+[...t.extensions].map(t=>`${e}#extension ${t}: enable\n`).join("")+r+t.defines.join("")+i}toWebGL2(e,t){const r=`${e}precision highp float;\n${e}precision highp int;\n`,s=`${e}#version 300 es\n`,i=t.types.map(r=>r.toWebGL2(e,t)).join("")+this.uniforms.map(r=>r.toWebGL2(e,t)).join("")+t.inputs.map(r=>r.toWebGL2(e,t)).join("")+t.outputs.map(r=>r.toWebGL2(e,t)).join("")+super.toWebGL2(e,t);for(const e of t.builtins){const r=Us.webgl2[e];r.extension&&t.extensions.add(r.extension)}return s+[...t.extensions].map(t=>`${e}#extension ${t}: enable\n`).join("")+r+t.defines.join("")+i}toWGSL(e,t){const r=t.type===M.Vertex?[Ss,Cs]:t.type===M.Fragment?[Is,Fs]:[Ns],s=[];for(const e of t.builtins)s.push(Us.webgpu[e].name);const i=Object.keys(Us.webgpu).map(e=>Us.webgpu[e].name);for(const e of t.types)if(e instanceof bi&&r.indexOf(e.type.structName)>=0)for(let t=e.type.structMembers.length-1;t>=0;t--){const r=e.type.structMembers[t];i.indexOf(r.name)>=0&&s.indexOf(r.name)<0&&(e.type.structMembers.splice(t,1),e.prefix.splice(t,1))}return t.types=t.types.filter(e=>!(e instanceof bi)||e.type.structMembers.length>0),t.types.map(r=>r.toWGSL(e,t)).join("")+this.uniforms.map(r=>r.toWGSL(e,t)).join("")+super.toWGSL(e,t)}}class js extends Ws{value;ref;writable;constExp;constructor(e){super(),this.value=e,this.ref=null,this.writable=!1,this.constExp=!1}get name(){return this.value.$str}isReference(){return!0}isConstExp(){return this.constExp}markWritable(){this.writable=!0,this.constExp=!1,this.ref&&this.ref.markWritable()}isWritable(){const e=this.getType();return this.writable||e.isAtomicI32()||e.isAtomicU32()||e.isStructType()&&e.haveAtomicMembers()}getAddressSpace(){switch(this.value.$declareType){case 4:return re.UNIFORM;case 5:return re.STORAGE;case 1:case 2:return null;default:return this.value.$global?re.PRIVATE:re.FUNCTION}}getType(){return this.value.$typeinfo}toWebGL(e,t){return this.name}toWebGL2(e,t){return this.name}toWGSL(e,t){if(1===this.value.$declareType){const r=Os(t.type);return t.global[r][this.name].$ast.toWGSL(e,t)}if(2===this.value.$declareType){const r=Ms(t.type);return t.global[r][this.name].$ast.toWGSL(e,t)}return this.name}toString(e){return this.name}}class Ks extends Xs{}class Zs extends Ks{value;constructor(e){if(super(),e.getAddressSpace()===re.UNIFORM)throw new gs(e,"cannot assign to uniform variable");this.value=e,this.value instanceof di&&(this.value.isStatement=!1)}getType(){return this.value.getType()}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isReference(){return this.value.isReference()}toWebGL(e,t){return this.value.toWebGL(e,t)}toWebGL2(e,t){return this.value.toWebGL2(e,t)}toWGSL(e,t){return this.value.toWGSL(e,t)}toString(e){return this.value.toString(e)}}class qs extends Ks{scope;field;type;constructor(e,t,r){super(),this.scope=e,this.field=t,this.type=r}getType(){return this.type}markWritable(){this.scope.markWritable()}isWritable(){return this.scope.isWritable()}isReference(){return this.scope.isReference()}toWebGL(e,t){return`${this.scope.toWebGL(e,t)}.${this.field}`}toWebGL2(e,t){return`${this.scope.toWebGL2(e,t)}.${this.field}`}toWGSL(e,t){return`${(this.scope.isPointer()?new ni(this.scope):this.scope).toWGSL(e,t)}.${this.field}`}toString(e){return`${(this.scope.isPointer()?new ni(this.scope):this.scope).toString(e)}.${this.field}`}}class Qs extends Ks{value;index;type;constructor(e,t,r){super(),this.value=e,this.index=t,this.type=r,this.index instanceof di&&(this.index.isStatement=!1)}getType(){return this.type}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isReference(){return this.value.isReference()}toWebGL(e,t){return`${this.value.toWebGL(e,t)}[${this.index.toWebGL(e,t)}]`}toWebGL2(e,t){return`${this.value.toWebGL2(e,t)}[${this.index.toWebGL2(e,t)}]`}toWGSL(e,t){return`${(this.value.isPointer()?new ni(this.value):this.value).toWGSL(e,t)}[${this.index.toWGSL(e,t)}]`}toString(e){return`${(this.value.isPointer()?new ni(this.value):this.value).toString(e)}[${this.index.toString(e)}]`}}class Js extends Ks{value;constructor(e){super(),this.value=e,this.value.constExp=!0}getType(){return this.value.getType()}markWritable(){}isWritable(){return!1}isReference(){return!0}toWebGL(e,t){let r="";switch(this.value.value.$declareType){case 1:case 2:case 4:case 5:throw new Error("invalid declare type");default:r=!this.value.constExp||this.value.isWritable()||this.getType().isStructType()?"":"const "}return`${r}${this.getType().toTypeName("webgl",this.value.name)}`}toWebGL2(e,t){let r="";switch(this.value.value.$declareType){case 1:case 2:case 4:case 5:throw new Error("invalid declare type");default:r=!this.value.constExp||this.value.isWritable()||this.getType().isStructType()?"":"const "}return`${r}${this.getType().toTypeName("webgl2",this.value.name)}`}toWGSL(e,t){let r;switch(this.value.value.$declareType){case 1:case 2:case 4:case 5:throw new Error("invalid declare type");default:{const e=this.value.getAddressSpace(),t=this.getType().isPointerType()||!this.value.isWritable()&&(e===re.PRIVATE||e===re.FUNCTION),s=e===re.PRIVATE,i=e===re.STORAGE&&this.value.isWritable()?", read_write":"",n=e!==re.FUNCTION?`<${e}${i}>`:"";r=t?s?"const ":"let ":`var${n} `;break}}{const e=this.getType();e.isPointerType()&&(this.value.isWritable()||this.value.ref.isWritable())&&(e.writable=!0);return`${r}${e.toTypeName("webgpu",this.value.name)}`}}toString(e){return this.value.toString(e)}}class ei extends Ws{type;args;constExp;convertedArgs;constructor(e,t){super(),this.type=e,this.args=t,this.convertedArgs=null;for(const e of t){if(null==e)throw new Error("invalid constructor argument");e instanceof di&&(e.isStatement=!1),this.constExp&&=!(e instanceof Ws)||e.isConstExp()}const r=Rs().getDevice().type,s=this.type.getConstructorOverloads(r);for(const e of s)if(this.convertedArgs=Ri(this.args,e),this.convertedArgs)break;if(!this.convertedArgs)throw new Error(`no matching overload function found for type ${this.type.toTypeName(r)}`)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.constExp}getAddressSpace(){return null}toWebGL(e,t){const r=this.convertedArgs.args.map(r=>Vs(r.toWebGL(e,t))).join(",");return`${this.convertedArgs.name}(${r})`}toWebGL2(e,t){const r=this.convertedArgs.args.map(r=>Vs(r.toWebGL2(e,t))).join(",");return`${this.convertedArgs.name}(${r})`}toWGSL(e,t){const r=this.convertedArgs.args.map(r=>Vs(r.toWGSL(e,t))).join(",");return`${this.convertedArgs.name}(${r})`}toString(e){return"constructor"}}class ti extends Ws{value;type;constructor(e,t){if(super(),this.value=e,this.type=t,"number"==typeof e){if(t.primitiveType===X.BOOL)throw new cs(e,typeof e,t);if(t.primitiveType===X.I32&&(!Number.isInteger(e)||e<-2147483648||e>4294967295))throw new cs(e,typeof e,t);if(e<0&&t.primitiveType===X.U32&&(!Number.isInteger(e)||e<0||e>4294967295))throw new cs(e,typeof e,t)}else if(t.primitiveType!==X.BOOL)throw new cs(e,typeof e,t)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return!0}getAddressSpace(){return null}toWebGL(e,t){switch(this.type.primitiveType){case X.F32:return $s(this.value);case X.I32:return Gs(this.value);case X.U32:return`${Ps(this.value)}u`;case X.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toWebGL2(e,t){switch(this.type.primitiveType){case X.F32:return $s(this.value);case X.I32:return Gs(this.value);case X.U32:return`${Ps(this.value)}u`;case X.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toWGSL(e,t){switch(this.type.primitiveType){case X.F32:return $s(this.value);case X.I32:return Gs(this.value);case X.U32:return`${Ps(this.value)}u`;case X.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toString(e){return`${this.value}`}}class ri extends Ws{source;field;type;constructor(e,t,r){super(),this.source=e,this.field=t,this.type=r,this.source instanceof di&&(this.source.isStatement=!1)}getType(){return this.type}isReference(){return this.source.isReference()}isConstExp(){return this.source.isConstExp()}markWritable(){this.source.markWritable()}isWritable(){return this.source.isWritable()}getAddressSpace(){return this.source.getAddressSpace()}toWebGL(e,t){return this.source instanceof ti?`(${this.source.toWebGL(e,t)}).${this.field}`:`${this.source.toWebGL(e,t)}.${this.field}`}toWebGL2(e,t){return this.source instanceof ti?`(${this.source.toWebGL(e,t)}).${this.field}`:`${this.source.toWebGL(e,t)}.${this.field}`}toWGSL(e,t){const r=this.source.isPointer()?new ni(this.source):this.source;return r instanceof ti?`(${r.toWGSL(e,t)}).${this.field}`:`${r.toWGSL(e,t)}.${this.field}`}toString(e){return`${(this.source.isPointer()?new ni(this.source):this.source).toString(e)}.${this.field}`}}class si extends Ws{sourceValue;castType;constructor(e,t){super(),this.sourceValue=e,this.castType=t,this.sourceValue instanceof di&&(this.sourceValue.isStatement=!1)}getType(){return this.castType}markWritable(){}isWritable(){return!1}isConstExp(){return this.sourceValue.isConstExp()}getAddressSpace(){return null}toWebGL(e,t){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWebGL(e,t):`${this.castType.toTypeName("webgl")}(${Vs(this.sourceValue.toWebGL(e,t))})`}toWebGL2(e,t){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWebGL2(e,t):`${this.castType.toTypeName("webgl2")}(${Vs(this.sourceValue.toWebGL2(e,t))})`}toWGSL(e,t){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWGSL(e,t):`${this.castType.toTypeName("webgpu")}(${Vs(this.sourceValue.toWGSL(e,t))})`}toString(e){return`${this.castType.toTypeName(e)}(${Vs(this.sourceValue.toString(e))})`}}class ii extends Ws{value;type;constructor(e){super(),t(e.isReference(),"no pointer type for non-reference values"),this.value=e,this.type=new oe(e.getType(),e.getAddressSpace())}getType(){return this.type}isConstExp(){return!1}markWritable(){if(this.value.getAddressSpace()===re.UNIFORM)throw new gs(this.value,"uniforms are not writable");this.value.markWritable()}isWritable(){return this.value.isWritable()}getAddressSpace(){return this.value.getAddressSpace()}toWebGL(e,t){throw new Error("GLSL does not support pointer type")}toWebGL2(e,t){throw new Error("GLSL does not support pointer type")}toWGSL(e,t){const r=this.value instanceof ks?this.value.paramAST:this.value;return r instanceof ni?r.value.toWGSL(e,t):`(&${r.toWGSL(e,t)})`}toString(e){const t=this.value instanceof ks?this.value.paramAST:this.value;return t instanceof ni?t.value.toString(e):`(&${t.toString(e)})`}}class ni extends Ws{value;constructor(e){super(),this.value=e,this.value instanceof di&&(this.value.isStatement=!1)}getType(){const e=this.value.getType();return e.isPointerType()?e.pointerType:e}isReference(){return!0}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isConstExp(){return!1}getAddressSpace(){return this.value instanceof Ws?this.value.getAddressSpace():null}toWebGL(e,t){return this.value.toWebGL(e,t)}toWebGL2(e,t){return this.value.toWebGL2(e,t)}toWGSL(e,t){return this.value.getType().isPointerType()?`(*${this.value.toWGSL(e,t)})`:this.value.toWGSL(e,t)}toString(e){return`*${this.value.toString(e)}`}}class ai extends Ws{value;op;type;constructor(e,t,r){super(),this.value=e,this.op=t,this.type=r,this.value instanceof di&&(this.value.isStatement=!1)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.value.isConstExp()}getAddressSpace(){return null}toWebGL(e,t){return`${this.op}${this.value.toWebGL(e,t)}`}toWebGL2(e,t){return`${this.op}${this.value.toWebGL2(e,t)}`}toWGSL(e,t){const r=this.value.isPointer()?new ni(this.value):this.value;return`${this.op}${r.toWGSL(e,t)}`}toString(e){const t=this.value.isPointer()?new ni(this.value):this.value;return`${this.op}${t.toString(e)}`}}class oi extends Ws{left;right;type;op;constructor(e,t,r,s){super(),this.left=e,this.right=t,this.op=r,this.type=s,this.left instanceof di&&(this.left.isStatement=!1),this.right instanceof di&&(this.right.isStatement=!1)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.left.isConstExp()&&this.right.isConstExp()}getAddressSpace(){return null}toWebGL(e,t){return`(${this.left.toWebGL(e,t)} ${this.op} ${this.right.toWebGL(e,t)})`}toWebGL2(e,t){return`(${this.left.toWebGL2(e,t)} ${this.op} ${this.right.toWebGL2(e,t)})`}toWGSL(e,t){const r=this.left.isPointer()?new ni(this.left):this.left,s=this.right.isPointer()?new ni(this.right):this.right;return`(${r.toWGSL(e,t)} ${this.op} ${s.toWGSL(e,t)})`}toString(e){const t=this.left.isPointer()?new ni(this.left):this.left,r=this.right.isPointer()?new ni(this.right):this.right;return`(${t.toString(e)} ${this.op} ${r.toString(e)})`}}class ui extends Ws{source;index;type;constructor(e,t,r){super(),this.source=e,this.index=t,this.type=r,this.source instanceof di&&(this.source.isStatement=!1),this.index instanceof di&&(this.index.isStatement=!1)}getType(){return this.type}isReference(){return this.source.isReference()}markWritable(){this.source.markWritable()}isWritable(){return this.source.isWritable()}isConstExp(){return this.source.isConstExp()&&this.index.isConstExp()}getAddressSpace(){return this.source.getAddressSpace()}toWebGL(e,t){return`${this.source.toWebGL(e,t)}[${Vs(this.index.toWebGL(e,t))}]`}toWebGL2(e,t){return`${this.source.toWebGL2(e,t)}[${Vs(this.index.toWebGL2(e,t))}]`}toWGSL(e,t){return`${this.source.toWGSL(e,t)}[${Vs(this.index.toWGSL(e,t))}]`}toString(e){return`${this.source.toString(e)}[${Vs(this.index.toString(e))}]`}}class hi extends Xs{value;constructor(e){if(super(),e.getType().isVoidType())throw new Error("can not touch void type");e instanceof di&&(e.isStatement=!1),this.value=e}toWebGL(e,t){return`${e}${this.value.toWebGL("",t)};\n`}toWebGL2(e,t){return`${e}${this.value.toWebGL2("",t)};\n`}toWGSL(e,t){return this.value.getType().isVoidType()?`${e}${this.value.toWGSL("",t)};\n`:`${e}_ = ${this.value.toWGSL("",t)};\n`}}class li extends Ws{condition;first;second;type;constructor(e,t,r){super(),e instanceof di&&(e.isStatement=!1),t instanceof di&&(t.isStatement=!1),r instanceof di&&(r.isStatement=!1),this.condition=e instanceof Ws?e:new ti(e,Se);let s=null,i=null;if(t instanceof Ws)s=t.getType(),this.first=t,t instanceof di&&(t.isStatement=!1);else if("number"==typeof t)Number.isInteger(t)||(this.first=new ti(t,ce),s=ce);else{if("boolean"!=typeof t)throw new Error("select: invalid first value");this.first=new ti(t,Se),s=Se}if(r instanceof Ws)i=r.getType(),this.second=r,r instanceof di&&(r.isStatement=!1);else if("number"==typeof r)Number.isInteger(r)||(this.second=new ti(r,ce),i=ce);else{if("boolean"!=typeof r)throw new Error("select: invalid second value");this.second=new ti(r,Se),i=Se}if(!s&&!i)throw new Error("select: cannot determine the value types");if(s&&i){if(!s.isCompatibleType(i))throw new Error("select: first value and second value must be the same type");this.type=s}else if(s){if(s.typeId===ce.typeId)this.second=new ti(r,ce);else if(s.typeId===Ee.typeId)this.second=new ti(r,Ee);else{if(s.typeId!==ye.typeId)throw new Error("select: invalid type of the second value");this.second=new ti(r,ye)}this.type=s}else{if(i.typeId===ce.typeId)this.first=new ti(t,ce);else if(i.typeId===Ee.typeId)this.first=new ti(t,Ee);else{if(i.typeId!==ye.typeId)throw new Error("select: invalid type of the first value");this.first=new ti(t,ye)}this.type=i}}getType(){return this.type}isConstExp(){return!1}markWritable(){}isWritable(){return!1}getAddressSpace(){return null}toWebGL(e,t){return`${e}(${this.condition.toWebGL("",t)} ? ${this.first.toWebGL("",t)} : ${this.second.toWebGL("",t)})`}toWebGL2(e,t){return`${e}(${this.condition.toWebGL2("",t)} ? ${this.first.toWebGL2("",t)} : ${this.second.toWebGL2("",t)})`}toWGSL(e,t){return`${e}select(${this.second.toWGSL("",t)}, ${this.first.toWGSL("",t)}, ${this.condition.toWGSL("",t)})`}}class ci extends Xs{lvalue;rvalue;constructor(e,t){if(super(),!e.isReference())throw new Error("assignment: l-value required");if(this.lvalue=e,this.rvalue=t,this.lvalue instanceof Js)if(this.lvalue.getType().isPointerType())if(this.rvalue instanceof js)this.lvalue.value.ref=this.rvalue.ref;else{if(!(this.rvalue instanceof ii))throw new gs(this.lvalue,"invalid pointer assignment");this.lvalue.value.ref=this.rvalue.value}else this.rvalue instanceof Ws&&(this.lvalue.value.constExp=this.rvalue.isConstExp());else{if(this.lvalue.getType().isPointerType())throw new gs(this.lvalue,"cannot assign to read-only variable");this.lvalue.markWritable()}this.rvalue instanceof di&&(this.rvalue.isStatement=!1);const r=this.lvalue.getType(),s=r.isPointerType()?r.pointerType:r,i=this.checkScalarType(this.rvalue,s),n=i&&i.isPointerType()?i.pointerType:i;if(!s.isCompatibleType(n))throw new cs(this.rvalue instanceof Ws?this.rvalue.toString(i.isPointerType()?"webgpu":"webgl"):`${this.rvalue}`,i,r)}getType(){return null}toWebGL(e,t){let r=null;const s=this.lvalue.getType(),i=this.checkScalarType(this.rvalue,s);if(!s.isCompatibleType(i))throw new cs(this.rvalue instanceof Ws?this.rvalue.toString("webgl"):`${this.rvalue}`,i,s);return r="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?i.primitiveType===X.F32?$s(this.rvalue):String(this.rvalue):Vs(this.rvalue.toWebGL(e,t)),this.lvalue instanceof Js&&(this.lvalue.value.constExp&&=!(this.rvalue instanceof Ws)||this.rvalue.isConstExp()),`${e}${this.lvalue.toWebGL(e,t)} = ${r};\n`}toWebGL2(e,t){let r=null;const s=this.lvalue.getType(),i=this.checkScalarType(this.rvalue,s);if(!s.isCompatibleType(i))throw new cs(this.rvalue instanceof Ws?this.rvalue.toString("webgl2"):`${this.rvalue}`,i,s);return r="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?i.primitiveType===X.F32?$s(this.rvalue):String(this.rvalue):Vs(this.rvalue.toWebGL2(e,t)),this.lvalue instanceof Js&&(this.lvalue.value.constExp&&=!(this.rvalue instanceof Ws)||this.rvalue.isConstExp()),`${e}${this.lvalue.toWebGL2(e,t)} = ${r};\n`}toWGSL(e,t){const r=this.lvalue.getType(),[s,i]=r.isPointerType()?[r.pointerType,!0]:[r,!1],n=this.checkScalarType(this.rvalue,s),a=n&&n.isPointerType(),o=a?n.pointerType:n;if(!s.isCompatibleType(o))throw new cs(this.rvalue instanceof Ws?this.rvalue.toString("webgpu"):`${this.rvalue}`,n,r);if(this.lvalue instanceof Zs||this.lvalue instanceof Js){const e=s.isStructType()?s.structName:null;if(e&&t.types.findIndex(t=>t instanceof bi&&t.type.structName===e)<0)return""}let u;u="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?n.primitiveType===X.F32?$s(this.rvalue):String(this.rvalue):Vs(this.rvalue.toWGSL(e,t));const h=this.lvalue.toWGSL(e,t);if(i&&!a){if(this.lvalue instanceof Js)throw new Error(`rvalue must be pointer type: ${u}`);return`${e}*(${h}) = ${u};\n`}return a&&!i?`${e}${h} = *(${u});\n`:`${e}${h} = ${u};\n`}checkScalarType(e,t){if(e instanceof Ws)return e.getType();const r="boolean"==typeof e,s="number"==typeof e&&Number.isInteger(e)&&e>=-2147483648&&e<=2147483647,i="number"==typeof e&&Number.isInteger(e)&&e>=0&&e<=4294967295,n="number"==typeof e;if(!t.isPrimitiveType())return r?Se:s?Ee:i?ye:ce;switch(t.primitiveType){case X.BOOL:return r?t:s?Ee:i?ye:ce;case X.F32:return n?t:Se;case X.I32:return s?t:r?Se:i?ye:ce;case X.U32:return i?t:r?Se:s?Ee:ce;default:return null}}}class _i extends Xs{toWebGL(e,t){return`${e}discard;\n`}toWebGL2(e,t){return`${e}discard;\n`}toWGSL(e,t){return`${e}discard;\n`}}class pi extends Xs{toWebGL(e,t){return`${e}break;\n`}toWebGL2(e,t){return`${e}break;\n`}toWGSL(e,t){return`${e}break;\n`}}class fi extends Xs{toWebGL(e,t){return`${e}continue;\n`}toWebGL2(e,t){return`${e}continue;\n`}toWGSL(e,t){return`${e}continue;\n`}}class mi extends Xs{value;constructor(e){super(),this.value=e,this.value instanceof di&&(this.value.isStatement=!1)}toWebGL(e,t){return this.value?`${e}return ${Vs(this.value.toWebGL(e,t))};\n`:`${e}return;\n`}toWebGL2(e,t){return this.value?`${e}return ${Vs(this.value.toWebGL2(e,t))};\n`:`${e}return;\n`}toWGSL(e,t){return this.value?`${e}return ${Vs(this.value.toWGSL(e,t))};\n`:`${e}return;\n`}}class di extends Ws{name;args;retType;func;isStatement;constructor(e,t,r,s,i){if(super(),this.name=e,this.args=t,this.retType=r?.returnType??i??Cr,this.func=r,this.isStatement=!0,r){if(r.funcType.argTypes.length!==this.args.length)throw new ys("ASTCallFunction(): number of parameters mismatch");for(let i=0;i<this.args.length;i++){const n=r.funcType.argTypes[i];if(n.byRef){if("webgpu"===s){const r=t[i].getAddressSpace();if(r!==re.FUNCTION&&r!==re.PRIVATE)throw new ps(e,"pointer type of function parameter must be function or private");const s=n.type;if(!s.isPointerType())throw new ys("ASTCallFunction(): invalid reference type");if(s.addressSpace===re.UNKNOWN)s.addressSpace=r;else if(s.addressSpace!==r)throw new ps(e,`invalid pointer parameter address space '${r}', should be '${s.addressSpace}`)}this.args[i].markWritable()}}}for(const e of this.args)e instanceof di&&(e.isStatement=!1)}getType(){return this.retType}isConstExp(){return!1}markWritable(){}isWritable(){return!1}getAddressSpace(){return null}toWebGL(e,t){"dFdx"===this.name||"dFdy"===this.name||"fwidth"===this.name?t.extensions.add("GL_OES_standard_derivatives"):"texture2DLodEXT"!==this.name&&"texture2DProjLodEXT"!==this.name&&"textureCubeLodEXT"!==this.name&&"texture2DGradEXT"!==this.name&&"texture2DProjGradEXT"!==this.name&&"textureCubeGradEXT"!==this.name||t.extensions.add("GL_EXT_shader_texture_lod");const r=this.args.map(r=>Vs(r.toWebGL(e,t)));return`${this.isStatement?e:""}${this.name}(${r.join(",")})${this.isStatement?";\n":""}`}toWebGL2(e,t){const r=this.args.map(r=>Vs(r.toWebGL2(e,t)));return`${this.isStatement?e:""}${this.name}(${r.join(",")})${this.isStatement?";\n":""}`}toWGSL(e,t){let r=this.args;if(this.func){let e;const s=Ri(r,this.func.funcType);if(s&&(e=s.args),!e)throw new Error(`no matching overloading found for function '${this.name}'`);r=e.filter(e=>{const r=e.getType();return!(r.isStructType()&&t.types.findIndex(e=>e instanceof bi&&e.type.structName===r.structName)<0)})}const s=r.map(r=>Vs(r.toWGSL(e,t)));return`${this.isStatement?e:""}${this.name}(${s.join(",")})${this.isStatement?";\n":""}`}toString(e){return`${this.name}(...)`}}class Ei extends Xs{value;group;binding;blockName;constructor(e){super(),this.value=e,this.group=0,this.binding=0}isReference(){return!0}isPointer(){return this.value.getType().isPointerType()}toWebGL(e,t){let r="",s=!1,i=this.value.getType();switch(this.value.value.$declareType){case 1:t.type===M.Vertex?(r="attribute ",t.defines.push(`#define ${this.value.name} ${rs(t.vertexAttributes[this.value.value.$location])}\n`)):r="varying ";break;case 2:t.type===M.Vertex?r="varying ":(s=!0,t.mrt?(t.defines.push(`#define ${this.value.name} gl_FragData[${this.value.value.$location}]\n`),t.extensions.add("GL_EXT_draw_buffers")):t.defines.push(`#define ${this.value.name} gl_FragColor\n`));break;case 4:r="uniform ",i=t.typeReplacement?.get(this.value.value)||i;break;case 5:throw new Error(`invalid variable declare type: ${this.value.name}`)}if(!s)return`${e}${r}${i.toTypeName("webgl",this.value.name)};\n`}toWebGL2(e,t){let r="",s=this.value.getType();switch(this.value.value.$declareType){case 1:r=t.type===M.Fragment&&s.isPrimitiveType()&&s.isInteger()?"flat in ":"in ",t.type===M.Vertex&&t.defines.push(`#define ${this.value.name} ${rs(t.vertexAttributes[this.value.value.$location])}\n`);break;case 2:r=t.type===M.Vertex?s.isPrimitiveType()&&s.isInteger()?"flat out ":"out ":`layout(location = ${this.value.value.$location}) out `;break;case 4:return s.isStructType()?`${e}layout(std140) uniform ${this.blockName} { ${s.structName} ${this.value.name}; };\n`:(s=t.typeReplacement?.get(this.value.value)||s,`${e}uniform ${s.toTypeName("webgl2",this.value.name)};\n`);case 5:throw new Error(`invalid variable declare type: ${this.value.name}`)}return`${e}${r}${this.value.getType().toTypeName("webgl2",this.value.name)};\n`}toWGSL(e,t){let r;const s=this.value.getType().isPrimitiveType()||this.value.getType().isStructType()||this.value.getType().isArrayType();switch(this.value.value.$declareType){case 1:case 2:throw new Error("Internal error");case 4:r=`@group(${this.group}) @binding(${this.binding}) var${s?"<uniform>":""} `;break;case 5:r=`@group(${this.group}) @binding(${this.binding}) var<storage, ${this.value.value.$readonly?"read":"read_write"}> `;break;case 3:r="var<workgroup> ";break;default:r=`${this.value.getType().isPointerType()?"let":"var"}${this.value.value.$global&&!this.value.getType().isPointerType()?"<private>":""} `}{const s=this.value.getType(),i=s.isStructType()?s.structName:null;return i&&t.types.findIndex(e=>e instanceof bi&&e.type.structName===i)<0?"":`${e}${r}${s.toTypeName("webgpu",this.value.name)};\n`}}toString(e){return this.value.toString(e)}}class Ti extends zs{name;args;isBuiltin;isMainFunc;funcType;builtins;returnType;constructor(e,t,r,s,i=!1){super(),this.name=e,this.args=t,this.funcType=s,this.builtins=[],this.isBuiltin=i,this.isMainFunc=r,this.returnType=s?s.returnType:null}toWebGL(e,t){if(this.isBuiltin)return"";{let r="";const s=[];for(const e of this.args){let t,r,i;e.paramAST instanceof js?(t=e.paramAST.value,r=e.paramAST.name,i=""):(t=e.paramAST.value.value,r=e.paramAST.value.name,i=`${t.$inout} `),s.push(`${i}${e.getType().toTypeName("webgl",r)}`)}return r+=`${e}${this.returnType.toTypeName("webgl")} ${this.name}(${s.join(",")}) {\n`,r+=super.toWebGL(e+"  ",t),r+=`${e}}\n`,r}}toWebGL2(e,t){if(this.isBuiltin)return"";{let r="";const s=[];for(const e of this.args){let t,r,i;e.paramAST instanceof js?(t=e.paramAST.value,r=e.paramAST.name,i=""):(t=e.paramAST.value.value,r=e.paramAST.value.name,i=`${t.$inout} `),s.push(`${i}${e.getType().toTypeName("webgl2",r)}`)}return r+=`${e}${this.returnType.toTypeName("webgl2")} ${this.name}(${s.join(",")}) {\n`,r+=super.toWebGL2(e+"  ",t),r+=`${e}}\n`,r}}toWGSL(e,t){if(this.isBuiltin)return"";{let r="";const s=[...this.builtins];for(const e of this.args){const r=e.paramAST instanceof js?e.paramAST.name:e.paramAST.value.name,i=e.paramAST instanceof js?e.paramAST.getType():e.paramAST.value.getType(),n=i.isPointerType()?i.pointerType:i;n.isStructType()&&t.types.findIndex(e=>e instanceof bi&&e.type.structName===n.structName)<0||s.push(`${i.toTypeName("webgpu",r)}`)}let i="";if(this.isMainFunc)switch(t.type){case M.Vertex:i="@vertex ";break;case M.Fragment:i="@fragment ";break;case M.Compute:i=`@compute @workgroup_size(${t.workgroupSize[0]}, ${t.workgroupSize[1]}, ${t.workgroupSize[2]}) `}const n=this.returnType.isVoidType()?null:this.returnType.toTypeName("webgpu"),a=n?` -> ${n}`:"";return r+=`${e}${i}fn ${this.name}(${s.join(",")})${a} {\n`,r+=super.toWGSL(e+"  ",t),r+=`${e}}\n`,r}}}class xi extends zs{keyword;condition;nextElse;constructor(e,t){super(),this.keyword=e,this.condition=t,this.nextElse=null,this.condition instanceof di&&(this.condition.isStatement=!1)}toWebGL(e,t){let r=`${e}${this.keyword} ${this.condition?"("+Vs(this.condition.toWebGL(e,t))+")":""} {\n`;return r+=super.toWebGL(e+"  ",t),r+=`${e}}\n`,this.nextElse&&(r+=this.nextElse.toWebGL(e,t)),r}toWebGL2(e,t){let r=`${e}${this.keyword} ${this.condition?"("+Vs(this.condition.toWebGL2(e,t))+")":""} {\n`;return r+=super.toWebGL2(e+"  ",t),r+=`${e}}\n`,this.nextElse&&(r+=this.nextElse.toWebGL2(e,t)),r}toWGSL(e,t){let r=`${e}${this.keyword} ${this.condition?"("+Vs(this.condition.toWGSL(e,t))+")":""} {\n`;return r+=super.toWGSL(e+"  ",t),r+=`${e}}\n`,this.nextElse&&(r+=this.nextElse.toWGSL(e,t)),r}}class gi extends zs{init;start;end;open;reverse;constructor(e,t,r,s,i){super(),this.init=e,this.start=t,this.end=r,this.open=s,this.reverse=i,this.statements=[],this.start instanceof di&&(this.start.isStatement=!1),this.end instanceof di&&(this.end.isStatement=!1)}toWebGL(e,t){const r=this.init.getType().toTypeName("webgl",this.init.name),s=Vs(this.start.toWebGL(e,t)),i=Vs(this.end.toWebGL(e,t)),n=this.open?this.reverse?">":"<":this.reverse?">=":"<=";let a=`${e}for (${r} = ${s}; ${this.init.name} ${n} ${i}; ${this.init.name}${this.reverse?"--":"++"}) {\n`;return a+=super.toWebGL(e+"  ",t),a+=`${e}}\n`,a}toWebGL2(e,t){const r=this.init.getType().toTypeName("webgl2",this.init.name),s=Vs(this.start.toWebGL2(e,t)),i=Vs(this.end.toWebGL2(e,t)),n=this.open?this.reverse?">":"<":this.reverse?">=":"<=";let a=`${e}for (${r} = ${s}; ${this.init.name} ${n} ${i}; ${this.init.name}${this.reverse?"--":"++"}) {\n`;return a+=super.toWebGL2(e+"  ",t),a+=`${e}}\n`,a}toWGSL(e,t){const r=`var ${this.init.getType().toTypeName("webgpu",this.init.name)}`,s=Vs(this.start.toWGSL(e,t)),i=Vs(this.end.toWGSL(e,t)),n=new ti(1,this.init.getType()).toWGSL(e,t),a=this.open?this.reverse?"> ":"<":this.reverse?">=":"<=";let o=`${e}for (${r} = ${s}; ${this.init.name} ${a} ${i}; ${this.init.name} = ${this.init.name} ${this.reverse?"-":"+"} ${n}) {\n`;return o+=super.toWGSL(e+"  ",t),o+=`${e}}\n`,o}}class yi extends zs{condition;constructor(e){super(),this.condition=e,this.condition instanceof di&&(this.condition.isStatement=!1)}toWebGL(e,t){throw new Error("No do-while() loop support for WebGL1.0 device")}toWebGL2(e,t){let r=`${e}do {\n`;return r+=super.toWebGL2(e+" ",t),r+=`${e}} while(${Vs(this.condition.toWebGL2(e,t))});\n`,r}toWGSL(e,t){let r=`${e}loop {\n`;return r+=super.toWGSL(e+" ",t),r+=`${e}  if (!(${Vs(this.condition.toWGSL(e,t))})) { break; }\n`,r+=`${e}}\n`,r}}class Ai extends zs{condition;constructor(e){super(),this.condition=e,this.condition instanceof di&&(this.condition.isStatement=!1)}toWebGL(e,t){let r=`${e}for(int z_tmp_counter = 0; z_tmp_counter == 0; z_tmp_counter += 0) {\n`;const s=e+"  ";return r+=`${s}if(!(${Vs(this.condition.toWebGL(e,t))})){ break; }\n`,r+=super.toWebGL(s,t),r+=`${e}}\n`,r}toWebGL2(e,t){let r=`${e}while(${Vs(this.condition.toWebGL2(e,t))}) {\n`;return r+=super.toWebGL2(e+"  ",t),r+=`${e}}\n`,r}toWGSL(e,t){let r=`${e}for(;${Vs(this.condition.toWGSL(e,t))};) {\n`;return r+=super.toWGSL(e+"  ",t),r+=`${e}}\n`,r}}class bi extends Xs{type;prefix;builtin;constructor(e,t){super(),this.prefix=null,this.builtin=t,this.type=e}getType(){return this.type}toWebGL(e,t){if(this.builtin)return"";{let t=`${e}struct ${this.type.structName} {\n`;for(const r of this.type.structMembers)t+=`${e}  ${r.type.toTypeName("webgl",r.name)};\n`;return t+=`${e}};\n`,t}}toWebGL2(e,t){if(this.builtin)return"";{let t=`${e}struct ${this.type.structName} {\n`;for(const r of this.type.structMembers)t+=`${e}  ${r.type.toTypeName("webgl2",r.name)};\n`;return t+=`${e}};\n`,t}}toWGSL(e,t){if(this.builtin)return"";{let t=`${e}struct ${this.type.structName} {\n`;return t+=this.type.structMembers.map((t,r)=>{const s=this.prefix?this.prefix[r]:"",i=t.type.getLayoutSize(this.type.layout)!==t.type.getLayoutSize("default")?`@size(${t.type.getLayoutSize(this.type.layout)}) `:"",n=r>0&&t.type.getLayoutAlignment(this.type.layout)!==t.type.getLayoutAlignment("default")?`@align(${t.type.getLayoutAlignment(this.type.layout)}) `:"";return`${e}  ${s}${n}${i}${t.type.toTypeName("webgpu",t.name)}`}).join(",\n"),t+=`\n${e}};\n`,t}}}function Ri(e,t){if(e.length!==t.argTypes.length)return null;const r=[];for(let s=0;s<e.length;s++){const i=!!t.argTypes[s].byRef,n=i?t.argTypes[s].type.pointerType:t.argTypes[s].type,a=e[s];if("number"==typeof a){if(i||!n.isPrimitiveType()||!n.isScalarType()||n.primitiveType===X.BOOL)return null;r.push(new ti(a,n))}else if("boolean"==typeof a){if(i||!n.isPrimitiveType()||n.primitiveType!==X.BOOL)return null;r.push(new ti(a,n))}else{if(!n.isCompatibleType(a.getType()))return null;i?(a.markWritable(),r.push(new ii(a))):r.push(a)}}return{name:t.name,args:r}}const Si=new Map;function Ci(e,t){return new Proxy(e,{get:function(r,s){if("symbol"==typeof s||s in r)return r[s];let i=Si.get(e);i||(i={},Si.set(e,i));let n=i[s];if(!n&&(t.isPrimitiveType()||t.isStructType()||t.isArrayType()||t.isAtomicI32()||t.isAtomicU32()))if("ptr"===s){const e=new oe(t,re.FUNCTION);n=function(...t){if(1===t.length&&"string"==typeof t[0])return new Ni(t[0],e);throw new Error("Invalid pointer type constructor")}}else{const e=Number(s);if(Number.isInteger(e)&&e>=0){const r=new ae(t,e);n=Ci(function(...e){if(1===e.length&&"string"==typeof e[0])return new Ni(e[0],r);{const t=new Ni("",r);return t.$ast=new ei(t.$typeinfo,e.map(e=>e instanceof Ni?e.$ast:e)),t}},r)}}return n&&(i[s]=n),n}})}class Ii{proxy;constructor(){return this.proxy=new Proxy(this,{get:function(e,t){return"string"==typeof t?e.$get(t):void 0},set:function(e,t,r){return"string"==typeof t&&e.$set(t,r)}}),this.proxy}get $thisProxy(){return this.proxy}}let Fi=0;class Ni extends Ii{$uid;$str;$location;$typeinfo;$global;$sampleType;$precision;$ast;$inout;$memberCache;$attrib;$tags;$_group;$declareType;$isBuffer;$readonly;$bindingSize;constructor(e,t){if(super(),!e&&t.isPointerType())throw new Error("no default constructor for pointer type");if(this.$uid=Fi++,this.$str=e||"",this.$location=0,this.$global=!1,this.$typeinfo=t,this.$qualifier=null,this.$precision=ws.NONE,this.$ast=new js(this),this.$inout=null,this.$memberCache={},this.$attrib=null,this.$tags=[],this.$_group=null,this.$declareType=vs.DECLARE_TYPE_NONE,this.$isBuffer=!1,this.$bindingSize=0,this.$readonly=!1,t.isTextureType())if(t.isDepthTexture())this.$sampleType="depth";else{const e=function(e){switch(e.textureType){case Z.TEX_1D:case Z.TEX_STORAGE_1D:case Z.TEX_2D:case Z.TEX_STORAGE_2D:case Z.TEX_2D_ARRAY:case Z.TEX_STORAGE_2D_ARRAY:case Z.TEX_3D:case Z.TEX_STORAGE_3D:case Z.TEX_CUBE:case Z.TEX_EXTERNAL:return new ie(X.F32VEC4);case Z.TEX_DEPTH_2D_ARRAY:case Z.TEX_DEPTH_2D:case Z.TEX_DEPTH_CUBE:return new ie(X.F32);case Z.ITEX_2D_ARRAY:case Z.ITEX_1D:case Z.ITEX_2D:case Z.ITEX_3D:case Z.ITEX_CUBE:return new ie(X.I32);case Z.UTEX_2D_ARRAY:case Z.UTEX_1D:case Z.UTEX_2D:case Z.UTEX_3D:case Z.UTEX_CUBE:return new ie(X.U32);default:return null}}(t);e.primitiveType===X.I32?this.$sampleType="sint":e.primitiveType===X.U32?this.$sampleType="uint":this.$sampleType="float"}}get $group(){return this.$_group}set $group(e){this.$_group=e}uniform(e){return this.$declareType=vs.DECLARE_TYPE_UNIFORM,this.$group=e,this.$isBuffer=!1,this}uniformBuffer(e,t=0){if(!this.$typeinfo.isPrimitiveType()&&!this.$typeinfo.isArrayType()&&!this.$typeinfo.isStructType())throw new gs(this.$ast,"only primitive type, array type or structure type can be set as uniform buffer");return this.$declareType=vs.DECLARE_TYPE_UNIFORM,this.$group=e,this.$isBuffer=!0,this.$bindingSize=t,this}workgroup(){return this.$declareType=vs.DECLARE_TYPE_WORKGROUP,this}storage(e){if(!this.$typeinfo.isHostSharable()){if(this.$typeinfo.isTextureType()){if(!this.$typeinfo.isStorageTexture())throw new gs(this.$ast,"type cannot be declared as storage texture");return this.uniform(e)}throw new gs(this.$ast,"type cannot be declared in storage address space")}return this.$declareType=vs.DECLARE_TYPE_STORAGE,this.$group=e,this.$isBuffer=!1,this.$readonly=!1,this}storageReadonly(e){return this.storage(e),this.$readonly=!0,this}storageBuffer(e,t=0){if(!(this.$typeinfo.isPrimitiveType()||this.$typeinfo.isArrayType()||this.$typeinfo.isStructType()||this.$typeinfo.isAtomicI32()||this.$typeinfo.isAtomicU32()))throw new gs(this.$ast,"only primitive type, array type or structure type can be set as storage buffer");return this.$declareType=vs.DECLARE_TYPE_STORAGE,this.$group=e,this.$isBuffer=!0,this.$bindingSize=t,this.$readonly=!1,this}storageBufferReadonly(e,t=0){return this.storageBuffer(e,t),this.$readonly=!0,this}inout(){return this.$inout="inout",this}out(){return this.$inout="out",this}attrib(e){return this.$declareType=vs.DECLARE_TYPE_IN,this.$attrib=e,this}tag(...e){return e.forEach(e=>{this.$tags.indexOf(e)<0&&this.$tags.push(e)}),this}sampleType(e){return e&&(this.$sampleType=e),this}at(e){const t=this.$ast.getType();if(!(t.isArrayType()||t.isPrimitiveType()&&(t.isVectorType()||t.isMatrixType())))throw new Error("at() function must be used with array types");let r,s=null;t.isArrayType()?(s=t.elementType,r=t.dimension):t.isVectorType()?(s=ie.getCachedTypeInfo(t.resizeType(1,1)),r=t.cols):t.isMatrixType()&&(s=ie.getCachedTypeInfo(t.resizeType(1,t.cols)),r=t.rows);const i=new Ni("",s);if("number"==typeof e){if(!Number.isInteger(e))throw new Error("at() array index must be integer type");if(e<0||r>0&&e>=r)throw new Error("at() array index out of bounds");i.$ast=new ui(this.$ast,new ti(e,Ee),s)}else{const t=e.$ast.getType();if(!t.isPrimitiveType()||!t.isScalarType())throw new Error("at() array index must be scalar type");let r=e.$ast;t.scalarType!==X.I32&&t.scalarType!==X.U32&&(r=new si(r,Ee)),i.$ast=new ui(this.$ast,r,s)}return i}setAt(e,t){const r=this.$ast.getType();if(!(r.isArrayType()||r.isPrimitiveType()&&r.isVectorType()))throw new Error("setAt() function must be used with array types");if("number"==typeof e){if(!Number.isInteger(e))throw new Error("setAt() array index must be integer type");const t=r.isArrayType()?r.dimension:r.cols;if(e<0||t>0&&e>=t)throw new Error("setAt() array index out of bounds")}Rs().getCurrentScope().$ast.statements.push(new ci(new Qs(new Zs(this.$ast),"number"==typeof e?new ti(e,Ee):e.$ast,r.isArrayType()?r.elementType:new ie(r.scalarType)),t instanceof Ni?t.$ast:t))}highp(){return this.$precision=ws.HIGH,this}mediump(){return this.$precision=ws.MEDIUM,this}lowp(){return this.$precision=ws.LOW,this}isConstructor(){return this.$ast instanceof ei&&0===this.$ast.args.length}isVector(){const e=this.$ast.getType();return e.isPrimitiveType()&&e.isVectorType()}numComponents(){const e=this.$ast.getType();return e.isPrimitiveType()?e.cols:0}getTypeName(){return this.$ast.getType().toTypeName(Rs().getDevice().type)}$get(e){if("string"==typeof e){if("$"===e[0]||e in this)return this[e];{let t=this.$memberCache[e];if(!t){const r=this.$ast?.getType()||this.$typeinfo,s=Number(e);if(Number.isNaN(s))if(r.isStructType()){const s=r.structMembers.findIndex(t=>t.name===e);if(s<0)return;const i=r.structMembers[s];if(i.type.isStructType()){t=Rs().structInfo.structs[i.type.structName].call(Rs(),`${this.$str}.${e}`)}else t=new Ni(`${this.$str}.${e}`,i.type);t.$ast=new ri(this.$ast,e,i.type)}else{if(!r.isPrimitiveType()||!r.isVectorType()&&!r.isScalarType())throw new Error(`invalid index operation: ${this.$ast.toString(Rs().getDevice().type)}[${e}]`);if(0===e.length||e.length>4||[...e].some(e=>"xyzw".slice(0,r.cols).indexOf(e)<0)&&[...e].some(e=>"rgba".slice(0,r.cols).indexOf(e)<0))throw new Error(`unknown swizzle target: ${this.$ast.toString(Rs().getDevice().type)}[${e}]`);const s=ie.getCachedTypeInfo(r.resizeType(1,e.length));t=new Ni("",s),1===r.cols?t.$ast=new ei(s,[this.$ast]):t.$ast=new ri(this.$ast,e,s)}else if(r.isArrayType())t=this.at(s);else if(r.isPrimitiveType()&&r.isVectorType()){if(s>=r.cols)throw new Error(`component index out of bounds: ${this.$str}[${s}]`);t=this.$get("xyzw"[s])}else{if(!r.isPrimitiveType()||!r.isMatrixType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);{const e=ie.getCachedTypeInfo(r.resizeType(1,r.cols));t=new Ni("",e),t.$ast=new ui(this.$ast,new ti(s,Ee),e)}}this.$memberCache[e]=t}return t}}}$set(e,t){if("string"==typeof e){if("$"===e[0]||e in this)this[e]=t;else{if("number"!=typeof t&&"boolean"!=typeof t&&!(t instanceof Ni))throw new Error("Invalid output value assignment");const r=this.$ast?.getType()||this.$typeinfo,s=Number(e);if(Number.isNaN(s))if(r.isStructType()){const s=r.structMembers.findIndex(t=>t.name===e);if(s<0)throw new Error(`unknown struct member '${e}`);const i=r.structMembers[s];let n;if("number"==typeof t||"boolean"==typeof t){if(!i.type.isPrimitiveType()||!i.type.isScalarType())throw new Error(`can not set struct member '${e}: invalid value type`);n=new ti(t,i.type)}else t instanceof Ni&&(n=t.$ast);if(!n)throw new Error(`can not set struct member '${e}: invalid value type`);Rs().getCurrentScope().$ast.statements.push(new ci(new qs(new Zs(this.$ast),e,i.type),n))}else{if(e.length>1||"xyzw".indexOf(e)<0&&"rgba".indexOf(e)<0)throw new Error(`invalid index operation: ${this.$str}[${s}]`);if(!r.isPrimitiveType()||!r.isVectorType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);const i=ie.getCachedTypeInfo(r.scalarType);Rs().getCurrentScope().$ast.statements.push(new ci(new qs(new Zs(this.$ast),e,i),t instanceof Ni?t.$ast:t))}else if(r.isArrayType())this.setAt(s,t);else if(r.isPrimitiveType()&&r.isVectorType()){if(s>=r.cols)throw new Error(`component index out of bounds: ${this.$str}[${s}]`);this.$set("xyzw"[s],t)}else{if(!r.isPrimitiveType()||!r.isMatrixType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);{if(!(t instanceof Ni))throw new Error(`invalid matrix column vector assignment: ${this.$str}[${s}]`);const e=ie.getCachedTypeInfo(r.resizeType(1,r.cols));Rs().getCurrentScope().$ast.statements.push(new ci(new Qs(new Zs(this.$ast),new ti(s,Ee),e),t.$ast))}}}return!0}return!1}}const vi=[[ce,_e,pe,fe],[Ee,Te,xe,ge],[ye,Ae,be,Re],[Se,Ce,Ie,Fe]],wi=[Ne,ve,we,Le,Oe,Me,Be,De,Ue];function Li(e,t,...r){const s="webgl"===e.getDevice().type?Gi:"webgl2"===e.getDevice().type?Pi:Vi,i=ki?.[t].overloads.filter(e=>!!(e[1]&s)).map(e=>e[0]);if(!i||0===i.length)throw new Ts(`builtin shader function '${t}'`);const n=r.map(t=>e.normalizeExpValue(t)),a=e._matchFunctionOverloading(i,n);if(!a)throw new ms(t);return a}function Oi(e,t){return e.$callFunction(t[0].name,t[1],t[0])}function Mi(e,t,...r){return Oi(e,Li(e,t,...r))}function Bi(e,t,r,s){const i=[];for(let r=0;r<wi.length;r++){const n=wi[r],a=s.map(e=>({type:e||wi[r]}));i.push([new Ti(e,null,!1,new le(e,n,a),!0),t])}return i}function Di(e,t,r,s,i){if(s.findIndex(e=>"number"==typeof e)<0)return[[new Ti(e,null,!1,new le(e,r,s.map(e=>({type:e}))),!0),t]];{const n=[];let a=i?1:0;for(;a<4;a++){const i="number"==typeof r?vi[r][a]:r,o=s.map(e=>"number"==typeof e?{type:vi[e][a]}:{type:e});n.push([new Ti(e,null,!1,new le(e,i,o),!0),t])}return n}}function Ui(e,t,r){const s=new Ni("",r);return s.$ast=new ai(e,t,r),s}function $i(e,t,r,s){const i=new Ni("",s);return i.$ast=new oi(e,t,r,s),i}const Gi=1,Pi=2,Vi=4,Xi=Gi|Pi,Wi=Xi|Vi,ki={add_2:{overloads:[...Di("",Wi,0,[0,0]),...Di("",Wi,1,[1,1]),...Di("",Wi,2,[2,2]),...Di("",Wi,3,[3,3]),...Di("",Wi,_e,[ce,_e]),...Di("",Wi,_e,[_e,ce]),...Di("",Wi,pe,[ce,pe]),...Di("",Wi,pe,[pe,ce]),...Di("",Wi,fe,[ce,fe]),...Di("",Wi,fe,[fe,ce]),...Di("",Wi,Te,[Ee,Te]),...Di("",Wi,Te,[Te,Ee]),...Di("",Wi,xe,[Ee,xe]),...Di("",Wi,xe,[xe,Ee]),...Di("",Wi,ge,[Ee,ge]),...Di("",Wi,ge,[ge,Ee]),...Di("",Wi,Ae,[ye,Ae]),...Di("",Wi,Ae,[Ae,ye]),...Di("",Wi,be,[ye,be]),...Di("",Wi,be,[be,ye]),...Di("",Wi,Re,[ye,Re]),...Di("",Wi,Re,[Re,ye]),...Bi("",Wi,0,[null,null])],normalizeFunc(e,t,...r){if(2===r.length&&"number"==typeof r[0]&&"number"==typeof r[1])return r[0]+r[1];const s=Li(e,t,...r);return $i(s[1][0],s[1][1],"+",s[0].returnType)}},add:{overloads:[],normalizeFunc(e,t,...r){if(r.length<2)throw new _s("add");let s=r[0];for(let t=1;t<r.length;t++)s=e.add_2(s,r[t]);return s}},sub:{overloads:[...Di("",Wi,0,[0,0]),...Di("",Wi,1,[1,1]),...Di("",Wi,2,[2,2]),...Di("",Wi,3,[3,3]),...Di("",Wi,_e,[ce,_e]),...Di("",Wi,_e,[_e,ce]),...Di("",Wi,pe,[ce,pe]),...Di("",Wi,pe,[pe,ce]),...Di("",Wi,fe,[ce,fe]),...Di("",Wi,fe,[fe,ce]),...Di("",Wi,Te,[Ee,Te]),...Di("",Wi,Te,[Te,Ee]),...Di("",Wi,xe,[Ee,xe]),...Di("",Wi,xe,[xe,Ee]),...Di("",Wi,ge,[Ee,ge]),...Di("",Wi,ge,[ge,Ee]),...Di("",Wi,Ae,[ye,Ae]),...Di("",Wi,Ae,[Ae,ye]),...Di("",Wi,be,[ye,be]),...Di("",Wi,be,[be,ye]),...Di("",Wi,Re,[ye,Re]),...Di("",Wi,Re,[Re,ye]),...Bi("",Wi,0,[null,null])],normalizeFunc(e,t,...r){const s=Li(e,t,...r);return $i(s[1][0],s[1][1],"-",s[0].returnType)}},div:{overloads:[...Di("",Wi,0,[0,0]),...Di("",Wi,1,[1,1]),...Di("",Wi,2,[2,2]),...Di("",Wi,3,[3,3]),...Di("",Wi,_e,[ce,_e]),...Di("",Wi,_e,[_e,ce]),...Di("",Wi,pe,[ce,pe]),...Di("",Wi,pe,[pe,ce]),...Di("",Wi,fe,[ce,fe]),...Di("",Wi,fe,[fe,ce]),...Di("",Wi,Te,[Ee,Te]),...Di("",Wi,Te,[Te,Ee]),...Di("",Wi,xe,[Ee,xe]),...Di("",Wi,xe,[xe,Ee]),...Di("",Wi,ge,[Ee,ge]),...Di("",Wi,ge,[ge,Ee]),...Di("",Wi,Ae,[ye,Ae]),...Di("",Wi,Ae,[Ae,ye]),...Di("",Wi,be,[ye,be]),...Di("",Wi,be,[be,ye]),...Di("",Wi,Re,[ye,Re]),...Di("",Wi,Re,[Re,ye])],normalizeFunc(e,t,...r){const s=Li(e,t,...r);return $i(s[1][0],s[1][1],"/",s[0].returnType)}},mul_2:{overloads:[...Di("",Wi,0,[0,0]),...Di("",Wi,1,[1,1]),...Di("",Wi,2,[2,2]),...Di("",Wi,3,[3,3]),...Di("",Wi,_e,[ce,_e]),...Di("",Wi,_e,[_e,ce]),...Di("",Wi,pe,[ce,pe]),...Di("",Wi,pe,[pe,ce]),...Di("",Wi,fe,[ce,fe]),...Di("",Wi,fe,[fe,ce]),...Di("",Wi,Te,[Ee,Te]),...Di("",Wi,Te,[Te,Ee]),...Di("",Wi,xe,[Ee,xe]),...Di("",Wi,xe,[xe,Ee]),...Di("",Wi,ge,[Ee,ge]),...Di("",Wi,ge,[ge,Ee]),...Di("",Wi,Ae,[ye,Ae]),...Di("",Wi,Ae,[Ae,ye]),...Di("",Wi,be,[ye,be]),...Di("",Wi,be,[be,ye]),...Di("",Wi,Re,[ye,Re]),...Di("",Wi,Re,[Re,ye]),...Bi("",Wi,0,[ce,null]),...Bi("",Wi,0,[null,ce]),...Di("",Wi,Ne,[Ne,Ne]),...Di("",Wi,Le,[Ne,Le]),...Di("",Wi,Be,[Ne,Be]),...Di("",Wi,_e,[Ne,_e]),...Di("",Wi,_e,[_e,Ne]),...Di("",Wi,ve,[ve,Ne]),...Di("",Wi,Oe,[ve,Le]),...Di("",Wi,De,[ve,Be]),...Di("",Wi,pe,[ve,_e]),...Di("",Wi,_e,[pe,ve]),...Di("",Wi,we,[we,Ne]),...Di("",Wi,Me,[we,Le]),...Di("",Wi,Ue,[we,Be]),...Di("",Wi,fe,[we,_e]),...Di("",Wi,_e,[fe,we]),...Di("",Wi,Ne,[Le,ve]),...Di("",Wi,Le,[Le,Oe]),...Di("",Wi,Be,[Le,De]),...Di("",Wi,_e,[Le,pe]),...Di("",Wi,pe,[_e,Le]),...Di("",Wi,ve,[Oe,ve]),...Di("",Wi,Oe,[Oe,Oe]),...Di("",Wi,De,[Oe,De]),...Di("",Wi,pe,[Oe,pe]),...Di("",Wi,pe,[pe,Oe]),...Di("",Wi,we,[Me,ve]),...Di("",Wi,Me,[Me,Oe]),...Di("",Wi,Ue,[Me,De]),...Di("",Wi,fe,[Me,pe]),...Di("",Wi,pe,[fe,Me]),...Di("",Wi,Ne,[Be,we]),...Di("",Wi,Le,[Be,Me]),...Di("",Wi,Be,[Be,Ue]),...Di("",Wi,_e,[Be,fe]),...Di("",Wi,fe,[_e,Be]),...Di("",Wi,ve,[De,we]),...Di("",Wi,Oe,[De,Me]),...Di("",Wi,De,[De,Ue]),...Di("",Wi,pe,[De,fe]),...Di("",Wi,fe,[pe,De]),...Di("",Wi,we,[Ue,we]),...Di("",Wi,Me,[Ue,Me]),...Di("",Wi,Ue,[Ue,Ue]),...Di("",Wi,fe,[Ue,fe]),...Di("",Wi,fe,[fe,Ue])],normalizeFunc(e,t,...r){const s=Li(e,t,...r);return $i(s[1][0],s[1][1],"*",s[0].returnType)}},mul:{overloads:[],normalizeFunc(e,t,...r){if(r.length<2)throw new _s("mul");let s=r[0];for(let t=1;t<r.length;t++)s=e.mul_2(s,r[t]);return s}},mod:{overloads:[...Di("mod",Wi,0,[0,0]),...Di("mod",Wi,1,[1,1]),...Di("mod",Wi,2,[2,2]),...Di("mod",Wi,3,[3,3])],normalizeFunc(e,t,...r){const s=Li(e,t,...r),i=s[1][0].getType(),n=i.isPrimitiveType()&&(i.scalarType===X.I32||i.scalarType===X.U32);if("webgl"===e.getDevice().type&&n)throw new Ts("integer modulus");return"webgpu"===e.getDevice().type||n?$i(s[1][0],s[1][1],"%",s[0].returnType):Oi(e,s)}},radians:{overloads:Di("radians",Wi,0,[0])},degrees:{overloads:Di("degrees",Wi,0,[0])},sin:{overloads:Di("sin",Wi,0,[0])},cos:{overloads:Di("cos",Wi,0,[0])},tan:{overloads:Di("tan",Wi,0,[0])},asin:{overloads:Di("asin",Wi,0,[0])},acos:{overloads:Di("acos",Wi,0,[0])},atan:{overloads:Di("atan",Wi,0,[0])},atan2:{overloads:[...Di("atan",Xi,0,[0,0]),...Di("atan2",Vi,0,[0,0])]},sinh:{overloads:Di("sinh",Pi|Vi,0,[0])},cosh:{overloads:Di("cosh",Pi|Vi,0,[0])},tanh:{overloads:Di("tanh",Pi|Vi,0,[0])},asinh:{overloads:Di("asinh",Pi,0,[0])},acosh:{overloads:Di("acosh",Pi,0,[0])},atanh:{overloads:Di("atanh",Pi,0,[0])},pow:{overloads:Di("pow",Wi,0,[0,0])},exp:{overloads:Di("exp",Wi,0,[0])},exp2:{overloads:Di("exp2",Wi,0,[0])},log:{overloads:Di("log",Wi,0,[0])},log2:{overloads:Di("log2",Wi,0,[0])},sqrt:{overloads:Di("sqrt",Wi,0,[0])},inverseSqrt:{overloads:[...Di("inversesqrt",Xi,0,[0]),...Di("inverseSqrt",Vi,0,[0])]},abs:{overloads:[...Di("abs",Wi,0,[0]),...Di("abs",Pi|Vi,1,[1]),...Di("abs",Vi,2,[2])]},sign:{overloads:[...Di("sign",Wi,0,[0]),...Di("sign",Pi,1,[1])]},floor:{overloads:Di("floor",Wi,0,[0])},ceil:{overloads:Di("ceil",Wi,0,[0])},fract:{overloads:Di("fract",Wi,0,[0])},fma:{overloads:Di("fma",Wi,0,[0,0,0]),normalizeFunc(e,t,...r){const s=Li(e,t,...r);return"webgpu"===e.getDevice().type?Oi(e,s):e.add(e.mul(r[0],r[1]),r[2])}},round:{overloads:Di("round",Vi,0,[0])},trunc:{overloads:Di("trunc",Vi,0,[0])},min:{overloads:[...Di("min",Wi,0,[0,0]),...Di("min",Pi|Vi,1,[1,1]),...Di("min",Pi|Vi,2,[2,2])]},max:{overloads:[...Di("max",Wi,0,[0,0]),...Di("max",Pi|Vi,1,[1,1]),...Di("max",Pi|Vi,2,[2,2])]},clamp:{overloads:[...Di("clamp",Wi,0,[0,0,0]),...Di("clamp",Pi|Vi,1,[1,1,1]),...Di("clamp",Pi|Vi,2,[2,2,2])]},saturate:{overloads:[],normalizeFunc(e,t,...r){if(1!==r.length)throw new _s("saturate");if(!(r[0]instanceof Ni))throw new fs("saturate","x");const s=r[0].$ast.getType();if(!s.isPrimitiveType()||!s.isScalarType()&&!s.isVectorType())throw new ps("saturate","x");const i=s.isScalarType()?0:e[`vec${s.cols}`](0),n=s.isScalarType()?1:e[`vec${s.cols}`](1);return e.clamp(r[0],i,n)}},mix:{overloads:[...Di("mix",Wi,0,[0,0,0]),...Di("mix",Wi,0,[0,0,ce])]},step:{overloads:Di("step",Wi,0,[0,0])},smoothStep:{overloads:Di("smoothstep",Wi,0,[0,0,0])},isnan:{overloads:Di("isnan",Pi,3,[0])},isinf:{overloads:Di("isinf",Pi,3,[0])},length:{overloads:Di("length",Wi,ce,[0])},distance:{overloads:Di("distance",Wi,ce,[0,0])},dot:{overloads:[...Di("dot",Wi,ce,[0,0],!0),...Di("dot",Vi,Ee,[1,1],!0),...Di("dot",Vi,ye,[2,2],!0)]},cross:{overloads:Di("cross",Wi,pe,[pe,pe])},normalize:{overloads:Di("normalize",Wi,0,[0],!0)},faceForward:{overloads:[...Di("faceforward",Xi,0,[0,0,0],!0),...Di("faceForward",Vi,0,[0,0,0],!0)]},reflect:{overloads:Di("reflect",Wi,0,[0,0],!0)},refract:{overloads:Di("refract",Wi,0,[0,0,ce],!0)},frexp:{overloads:[...Di("frexp",Vi,Ir,[ce]),...Di("frexp",Vi,Fr,[_e]),...Di("frexp",Vi,Nr,[pe]),...Di("frexp",Vi,vr,[fe])]},outerProduct:{overloads:[...Di("outerProduct",Pi,Ne,[_e,_e]),...Di("outerProduct",Pi,Oe,[pe,pe]),...Di("outerProduct",Pi,Ue,[fe,fe]),...Di("outerProduct",Pi,ve,[pe,_e]),...Di("outerProduct",Pi,Le,[_e,pe]),...Di("outerProduct",Pi,we,[fe,_e]),...Di("outerProduct",Pi,Be,[_e,fe]),...Di("outerProduct",Pi,Me,[fe,pe]),...Di("outerProduct",Pi,De,[pe,fe])]},transpose:{overloads:[...Di("transpose",Pi|Vi,Ne,[Ne]),...Di("transpose",Pi|Vi,Oe,[Oe]),...Di("transpose",Pi|Vi,Ue,[Ue]),...Di("transpose",Pi|Vi,ve,[Le]),...Di("transpose",Pi|Vi,Le,[ve]),...Di("transpose",Pi|Vi,we,[Be]),...Di("transpose",Pi|Vi,Be,[we]),...Di("transpose",Pi|Vi,Me,[De]),...Di("transpose",Pi|Vi,De,[Me])]},determinant:{overloads:[...Di("determinant",Pi|Vi,ce,[Ne]),...Di("determinant",Pi|Vi,ce,[Oe]),...Di("determinant",Pi|Vi,ce,[Ue])]},inverse:{overloads:[...Di("inverse",Pi,Ne,[Ne]),...Di("inverse",Pi,Oe,[Oe]),...Di("inverse",Pi,Ue,[Ue])]},lessThan:{overloads:[...Di("lessThan",Wi,3,[0,0]),...Di("lessThan",Wi,3,[1,1]),...Di("lessThan",Wi,3,[2,2])],normalizeFunc(e,t,...r){const s=Li(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?$i(s[1][0],s[1][1],"<",s[0].returnType):Oi(e,s)}},lessThanEqual:{overloads:[...Di("lessThanEqual",Wi,3,[0,0]),...Di("lessThanEqual",Wi,3,[1,1]),...Di("lessThanEqual",Wi,3,[2,2])],normalizeFunc(e,t,...r){const s=Li(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?$i(s[1][0],s[1][1],"<=",s[0].returnType):Oi(e,s)}},greaterThan:{overloads:[...Di("greaterThan",Wi,3,[0,0]),...Di("greaterThan",Wi,3,[1,1]),...Di("greaterThan",Wi,3,[2,2])],normalizeFunc(e,t,...r){const s=Li(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?$i(s[1][0],s[1][1],">",s[0].returnType):Oi(e,s)}},greaterThanEqual:{overloads:[...Di("greaterThanEqual",Wi,3,[0,0]),...Di("greaterThanEqual",Wi,3,[1,1]),...Di("greaterThanEqual",Wi,3,[2,2])],normalizeFunc(e,t,...r){const s=Li(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?$i(s[1][0],s[1][1],">=",s[0].returnType):Oi(e,s)}},compEqual:{overloads:[...Di("equal",Wi,3,[0,0]),...Di("equal",Wi,3,[1,1]),...Di("equal",Wi,3,[2,2]),...Di("equal",Wi,3,[3,3])],normalizeFunc(e,t,...r){const s=Li(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?$i(s[1][0],s[1][1],"==",s[0].returnType):Oi(e,s)}},compNotEqual:{overloads:[...Di("notEqual",Wi,3,[0,0]),...Di("notEqual",Wi,3,[1,1]),...Di("notEqual",Wi,3,[2,2]),...Di("notEqual",Wi,3,[3,3])],normalizeFunc(e,t,...r){const s=Li(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?$i(s[1][0],s[1][1],"!=",s[0].returnType):Oi(e,s)}},equal:{overloads:[...Di("equal",Wi,Se,[0,0]),...Di("equal",Wi,Se,[1,1]),...Di("equal",Wi,Se,[2,2]),...Di("equal",Wi,Se,[3,3])],normalizeFunc(e,t,...r){const s=Li(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type&&i.isPrimitiveType()&&!i.isScalarType()?e.all(e.compEqual(r[0],r[1])):$i(s[1][0],s[1][1],"==",s[0].returnType)}},notEqual:{overloads:[...Di("notEqual",Wi,Se,[0,0]),...Di("notEqual",Wi,Se,[1,1]),...Di("notEqual",Wi,Se,[2,2]),...Di("notEqual",Wi,Se,[3,3])],normalizeFunc(e,t,...r){const s=Li(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type&&i.isPrimitiveType()&&!i.isScalarType()?e.any(e.compNotEqual(r[0],r[1])):$i(s[1][0],s[1][1],"!=",s[0].returnType)}},any:{overloads:Di("any",Wi,Se,[3],!0)},all:{overloads:Di("all",Wi,Se,[3],!0)},not:{overloads:Di("not",Wi,3,[3]),normalizeFunc(e,t,...r){const s=Li(e,t,...r),i=s[1][0].getType();return"webgpu"===e.getDevice().type||i.isPrimitiveType()&&i.isScalarType()?Ui(s[1][0],"!",s[0].returnType):Oi(e,s)}},neg:{overloads:[...Di("neg",Wi,0,[0]),...Di("neg",Wi,1,[1])],normalizeFunc(e,t,...r){const s=Li(e,t,...r);return Ui(s[1][0],"-",s[0].returnType)}},or_2:{overloads:Di("or",Wi,Se,[3,3]),normalizeFunc(e,t,...r){const s=Li(e,t,...r);return $i(s[1][0],s[1][1],"||",s[0].returnType)}},or:{overloads:[],normalizeFunc(e,t,...r){if(r.length<2)throw new _s("or");let s=r[0];for(let t=1;t<r.length;t++)s=e.or_2(s,r[t]);return s}},compOr:{overloads:[...Di("compOr",Pi|Vi,1,[1,1]),...Di("compOr",Pi|Vi,2,[2,2])],normalizeFunc(e,t,...r){const s=Li(e,t,...r);return $i(s[1][0],s[1][1],"|",s[0].returnType)}},and_2:{overloads:Di("and",Wi,Se,[3,3]),normalizeFunc(e,t,...r){const s=Li(e,t,...r);return $i(s[1][0],s[1][1],"&&",s[0].returnType)}},and:{overloads:[],normalizeFunc(e,t,...r){if(r.length<2)throw new _s("and");let s=r[0];for(let t=1;t<r.length;t++)s=e.and_2(s,r[t]);return s}},compAnd:{overloads:[...Di("compAnd",Pi|Vi,1,[1,1]),...Di("compAnd",Pi|Vi,2,[2,2])],normalizeFunc(e,t,...r){const s=Li(e,t,...r);return $i(s[1][0],s[1][1],"&",s[0].returnType)}},compXor:{overloads:[...Di("compXor",Pi|Vi,1,[1,1]),...Di("compXor",Pi|Vi,2,[2,2])],normalizeFunc(e,t,...r){const s=Li(e,t,...r);return $i(s[1][0],s[1][1],"^",s[0].returnType)}},sal:{overloads:[...Di("sal",Pi|Vi,1,[1,2]),...Di("sal",Pi|Vi,2,[2,2])],normalizeFunc(e,t,...r){const s=Li(e,t,...r);return $i(s[1][0],s[1][1],"<<",s[0].returnType)}},sar:{overloads:[...Di("sar",Pi|Vi,1,[1,2]),...Di("sar",Pi|Vi,2,[2,2])],normalizeFunc(e,t,...r){const s=Li(e,t,...r);return $i(s[1][0],s[1][1],">>",s[0].returnType)}},arrayLength:{overloads:[],normalizeFunc(e,t,...r){if(1!==r.length)throw new _s("arrayLength");if(!(r[0]instanceof Ni))throw new fs("arrayLength","array");const s=r[0].$ast.getType(),i=s.isPointerType()?s.pointerType:s;if(!i.isArrayType()||0!==i.dimension)throw new ps("arrayLength","array");const n=s.isArrayType()?e.addressOf(r[0]).$ast:r[0].$ast;return e.$callFunctionNoCheck(t,[n],ye)}},select:{overloads:[...Di("select",Vi,0,[0,0,Se]),...Di("select",Vi,1,[1,1,Se]),...Di("select",Vi,2,[2,2,Se]),...Di("select",Vi,3,[3,3,Se]),...Di("select",Vi,0,[0,0,3],!0),...Di("select",Vi,1,[1,1,3],!0),...Di("select",Vi,2,[2,2,3],!0),...Di("select",Vi,3,[3,3,3],!0),...Di("mix",Pi,0,[0,0,3]),...Di("mix",Pi,1,[1,1,3]),...Di("mix",Pi,2,[2,2,3])]},floatBitsToInt:{overloads:Di("floatBitsToInt",Pi,1,[0]),normalizeFunc(e,t,...r){if(1!==r.length)throw new _s("floatBitsToInt");if(r[0]instanceof Ni){if(r[0].$ast.getType().typeId!==ce.typeId)throw new ps("floatBitsToInt","x")}else if("number"!=typeof r[0])throw new fs("floatBitsToInt","x");return"webgpu"===e.getDevice().type?e.$callFunctionNoCheck("bitcast<i32>",[r[0]instanceof Ni?r[0].$ast:new ti(r[0],ce)],Ee):Mi(e,t,...r)}},floatBitsToUint:{overloads:Di("floatBitsToUint",Pi,2,[0]),normalizeFunc(e,t,...r){if(1!==r.length)throw new _s("floatBitsToUint");if(r[0]instanceof Ni){if(r[0].$ast.getType().typeId!==ce.typeId)throw new ps("floatBitsToUint","x")}else if("number"!=typeof r[0])throw new fs("floatBitsToUint","x");return"webgpu"===e.getDevice().type?e.$callFunctionNoCheck("bitcast<u32>",[r[0]instanceof Ni?r[0].$ast:new ti(r[0],ce)],ye):Mi(e,t,...r)}},intBitsToFloat:{overloads:Di("intBitsToFloat",Pi,0,[1]),normalizeFunc(e,t,...r){if(1!==r.length)throw new _s("intBitsToFloat");if(r[0]instanceof Ni){if(r[0].$ast.getType().typeId!==Ee.typeId)throw new ps("intBitsToFloat","x")}else if("number"!=typeof r[0])throw new fs("intBitsToFloat","x");return"webgpu"===e.getDevice().type?e.$callFunctionNoCheck("bitcast<f32>",[r[0]instanceof Ni?r[0].$ast:new ti(r[0],Ee)],ce):Mi(e,t,...r)}},uintBitsToFloat:{overloads:Di("uintBitsToFloat",Pi,0,[2]),normalizeFunc(e,t,...r){if(1!==r.length)throw new _s("uintBitsToFloat");if(r[0]instanceof Ni){if(r[0].$ast.getType().typeId!==ye.typeId)throw new ps("uintBitsToFloat","x")}else if("number"!=typeof r[0])throw new fs("uintBitsToFloat","x");return"webgpu"===e.getDevice().type?e.$callFunctionNoCheck("bitcast<f32>",[r[0]instanceof Ni?r[0].$ast:new ti(r[0],ye)],ce):Mi(e,t,...r)}},pack4x8snorm:{overloads:Di("pack4x8snorm",Vi,ye,[fe])},unpack4x8snorm:{overloads:Di("unpack4x8snorm",Vi,fe,[ye])},pack4x8unorm:{overloads:Di("pack4x8unorm",Vi,ye,[fe])},unpack4x8unorm:{overloads:Di("unpack4x8unorm",Vi,fe,[ye])},pack2x16snorm:{overloads:[...Di("pack2x16snorm",Vi,ye,[_e]),...Di("packSnorm2x16",Pi,ye,[_e])]},unpack2x16snorm:{overloads:[...Di("unpack2x16snorm",Vi,_e,[ye]),...Di("unpackSnorm2x16",Pi,_e,[ye])]},pack2x16unorm:{overloads:[...Di("pack2x16unorm",Vi,ye,[_e]),...Di("packUnorm2x16",Pi,ye,[_e])]},unpack2x16unorm:{overloads:[...Di("unpack2x16unorm",Vi,_e,[ye]),...Di("unpackUnorm2x16",Pi,_e,[ye])]},pack2x16float:{overloads:[...Di("pack2x16float",Vi,ye,[_e]),...Di("packHalf2x16",Pi,ye,[_e])]},unpack2x16float:{overloads:[...Di("unpack2x16float",Vi,_e,[ye]),...Di("unpackHalf2x16",Pi,_e,[ye])]},matrixCompMult:{overloads:Bi("matrixCompMult",Xi,0,[null,null])},dpdx:{overloads:[...Di("dFdx",Xi,0,[0]),...Di("dpdx",Vi,0,[0])]},dpdy:{overloads:[...Di("dFdy",Xi,0,[0]),...Di("dpdy",Vi,0,[0])]},fwidth:{overloads:Di("fwidth",Wi,0,[0])},dpdxCoarse:{overloads:[...Di("dpdxCoarse",Vi,0,[0]),...Di("dFdx",Xi,0,[0])]},dpdxFine:{overloads:[...Di("dpdxFine",Vi,0,[0]),...Di("dFdx",Xi,0,[0])]},dpdyCoarse:{overloads:[...Di("dpdyCoarse",Vi,0,[0]),...Di("dFdy",Xi,0,[0])]},dpdyFine:{overloads:[...Di("dpdyFine",Vi,0,[0]),...Di("dFdy",Xi,0,[0])]},textureDimensions:{overloads:[...Di("textureDimensions",Vi,ye,[$e,Ee]),...Di("textureDimensions",Vi,ye,[Ge,Ee]),...Di("textureDimensions",Vi,ye,[Pe,Ee]),...Di("textureDimensions",Vi,Ae,[Ve,Ee]),...Di("textureDimensions",Vi,Ae,[Xe,Ee]),...Di("textureDimensions",Vi,Ae,[We,Ee]),...Di("textureDimensions",Vi,Ae,[ke,Ee]),...Di("textureDimensions",Vi,Ae,[ze,Ee]),...Di("textureDimensions",Vi,Ae,[He,Ee]),...Di("textureDimensions",Vi,be,[Ye,Ee]),...Di("textureDimensions",Vi,be,[je,Ee]),...Di("textureDimensions",Vi,be,[Ke,Ee]),...Di("textureDimensions",Vi,Ae,[Ze,Ee]),...Di("textureDimensions",Vi,Ae,[qe,Ee]),...Di("textureDimensions",Vi,Ae,[Qe,Ee]),...Di("textureDimensions",Vi,Ae,[et,Ee]),...Di("textureDimensions",Vi,Ae,[tt,Ee]),...Di("textureDimensions",Vi,Ae,[rt,Ee]),...Di("textureDimensions",Vi,Ae,[st]),...Di("textureDimensions",Vi,Ae,[it]),...Di("textureDimensions",Vi,Ae,[nt]),...Di("textureDimensions",Vi,Ae,[xr,Ee]),...Di("textureDimensions",Vi,Ae,[gr,Ee]),...Di("textureDimensions",Vi,Ae,[yr,Ee]),...Di("textureDimensions",Vi,Ae,[Ar,Ee]),...Di("textureDimensions",Vi,Ae,[br]),...Di("textureDimensions",Vi,ye,[at]),...Di("textureDimensions",Vi,ye,[ot]),...Di("textureDimensions",Vi,ye,[ht]),...Di("textureDimensions",Vi,ye,[lt]),...Di("textureDimensions",Vi,ye,[ct]),...Di("textureDimensions",Vi,ye,[_t]),...Di("textureDimensions",Vi,ye,[pt]),...Di("textureDimensions",Vi,ye,[ft]),...Di("textureDimensions",Vi,ye,[mt]),...Di("textureDimensions",Vi,ye,[dt]),...Di("textureDimensions",Vi,ye,[Et]),...Di("textureDimensions",Vi,ye,[Tt]),...Di("textureDimensions",Vi,ye,[xt]),...Di("textureDimensions",Vi,ye,[gt]),...Di("textureDimensions",Vi,ye,[yt]),...Di("textureDimensions",Vi,ye,[At]),...Di("textureDimensions",Vi,Ae,[bt]),...Di("textureDimensions",Vi,Ae,[Rt]),...Di("textureDimensions",Vi,Ae,[Ct]),...Di("textureDimensions",Vi,Ae,[It]),...Di("textureDimensions",Vi,Ae,[Ft]),...Di("textureDimensions",Vi,Ae,[Nt]),...Di("textureDimensions",Vi,Ae,[vt]),...Di("textureDimensions",Vi,Ae,[wt]),...Di("textureDimensions",Vi,Ae,[Lt]),...Di("textureDimensions",Vi,Ae,[Ot]),...Di("textureDimensions",Vi,Ae,[Mt]),...Di("textureDimensions",Vi,Ae,[Bt]),...Di("textureDimensions",Vi,Ae,[Dt]),...Di("textureDimensions",Vi,Ae,[Ut]),...Di("textureDimensions",Vi,Ae,[$t]),...Di("textureDimensions",Vi,Ae,[Gt]),...Di("textureDimensions",Vi,Ae,[Pt]),...Di("textureDimensions",Vi,Ae,[Vt]),...Di("textureDimensions",Vi,Ae,[Xt]),...Di("textureDimensions",Vi,Ae,[Wt]),...Di("textureDimensions",Vi,Ae,[kt]),...Di("textureDimensions",Vi,Ae,[zt]),...Di("textureDimensions",Vi,Ae,[Ht]),...Di("textureDimensions",Vi,Ae,[Yt]),...Di("textureDimensions",Vi,Ae,[jt]),...Di("textureDimensions",Vi,Ae,[Kt]),...Di("textureDimensions",Vi,Ae,[Zt]),...Di("textureDimensions",Vi,Ae,[qt]),...Di("textureDimensions",Vi,Ae,[Qt]),...Di("textureDimensions",Vi,Ae,[Jt]),...Di("textureDimensions",Vi,Ae,[er]),...Di("textureDimensions",Vi,Ae,[tr]),...Di("textureDimensions",Vi,be,[rr]),...Di("textureDimensions",Vi,be,[sr]),...Di("textureDimensions",Vi,be,[nr]),...Di("textureDimensions",Vi,be,[ar]),...Di("textureDimensions",Vi,be,[or]),...Di("textureDimensions",Vi,be,[ur]),...Di("textureDimensions",Vi,be,[hr]),...Di("textureDimensions",Vi,be,[lr]),...Di("textureDimensions",Vi,be,[cr]),...Di("textureDimensions",Vi,be,[_r]),...Di("textureDimensions",Vi,be,[pr]),...Di("textureDimensions",Vi,be,[fr]),...Di("textureDimensions",Vi,be,[mr]),...Di("textureDimensions",Vi,be,[dr]),...Di("textureDimensions",Vi,be,[Er]),...Di("textureDimensions",Vi,be,[Tr]),...Di("textureSize",Pi,Te,[$e,Ee]),...Di("textureSize",Pi,Te,[Ve,Ee]),...Di("textureSize",Pi,Te,[Ge,Ee]),...Di("textureSize",Pi,Te,[Xe,Ee]),...Di("textureSize",Pi,Te,[Pe,Ee]),...Di("textureSize",Pi,Te,[We,Ee]),...Di("textureSize",Pi,Te,[ke,Ee]),...Di("textureSize",Pi,Te,[ze,Ee]),...Di("textureSize",Pi,Te,[He,Ee]),...Di("textureSize",Pi,Te,[Ze,Ee]),...Di("textureSize",Pi,Te,[qe,Ee]),...Di("textureSize",Pi,Te,[Qe,Ee]),...Di("textureSize",Pi,xe,[Ye,Ee]),...Di("textureSize",Pi,xe,[je,Ee]),...Di("textureSize",Pi,xe,[Ke,Ee]),...Di("textureSize",Pi,Te,[xr,Ee]),...Di("textureSize",Pi,Te,[yr,Ee]),...Di("textureSize",Pi,Te,[gr,Ee])],normalizeFunc(e,t,...r){if(r.length<1||r.length>2)throw new _s("textureDimensions");if(!(r[0]instanceof Ni))throw new fs("textureDimensions","tex");const s=r[0].$ast.getType();if(!s.isTextureType())throw new ps("textureDimensions","tex");if("webgpu"===e.getDevice().type){if((s.isMultisampledTexture()||s.isStorageTexture())&&void 0!==r[1])throw new fs("textureDimensions","level");return Mi(e,t,...r)}if("webgl2"===e.getDevice().type){const i=r[0],n=r[1]||0;return s.is1DTexture()?Mi(e,t,i,n).x:Mi(e,t,i,n)}}},textureGather:{overloads:[...Di("textureGather",Vi,fe,[Ee,Ve,Rr,_e]),...Di("textureGather",Vi,ge,[Ee,Xe,Rr,_e]),...Di("textureGather",Vi,Re,[Ee,We,Rr,_e]),...Di("textureGather",Vi,fe,[Ee,Ze,Rr,pe]),...Di("textureGather",Vi,ge,[Ee,qe,Rr,pe]),...Di("textureGather",Vi,Re,[Ee,Qe,Rr,pe]),...Di("textureGather",Vi,fe,[xr,Rr,_e]),...Di("textureGather",Vi,fe,[yr,Rr,pe])]},textureArrayGather:{overloads:[...Di("textureGather",Vi,fe,[Ee,ke,Rr,_e,Ee]),...Di("textureGather",Vi,ge,[Ee,ze,Rr,_e,Ee]),...Di("textureGather",Vi,Re,[Ee,He,Rr,_e,Ee]),...Di("textureGather",Vi,fe,[Ee,et,Rr,pe,Ee]),...Di("textureGather",Vi,ge,[Ee,tt,Rr,pe,Ee]),...Di("textureGather",Vi,Re,[Ee,rt,Rr,pe,Ee]),...Di("textureGather",Vi,fe,[gr,Rr,_e,Ee]),...Di("textureGather",Vi,fe,[Ar,Rr,pe,Ee])]},textureGatherCompare:{overloads:[...Di("textureGatherCompare",Vi,fe,[xr,Sr,_e,ce]),...Di("textureGatherCompare",Vi,fe,[yr,Sr,pe,ce])]},textureArrayGatherCompare:{overloads:[...Di("textureGatherCompare",Vi,fe,[gr,Sr,_e,Ee,ce]),...Di("textureGatherCompare",Vi,fe,[Ar,Sr,pe,Ee,ce])]},textureLoad:{overloads:[...Di("textureLoad",Vi,fe,[$e,Ee,Ee]),...Di("textureLoad",Vi,ge,[Ge,Ee,Ee]),...Di("textureLoad",Vi,Re,[Pe,Ee,Ee]),...Di("textureLoad",Vi,fe,[ut,Ee]),...Di("textureLoad",Vi,fe,[At,Ee]),...Di("textureLoad",Vi,ge,[yt,Ee]),...Di("textureLoad",Vi,Re,[gt,Ee]),...Di("textureLoad",Vi,fe,[xt,Ee]),...Di("textureLoad",Vi,ge,[Tt,Ee]),...Di("textureLoad",Vi,Re,[Et,Ee]),...Di("textureLoad",Vi,fe,[pt,Ee]),...Di("textureLoad",Vi,ge,[_t,Ee]),...Di("textureLoad",Vi,Re,[ct,Ee]),...Di("textureLoad",Vi,fe,[dt,Ee]),...Di("textureLoad",Vi,ge,[mt,Ee]),...Di("textureLoad",Vi,Re,[ft,Ee]),...Di("textureLoad",Vi,ge,[lt,Ee]),...Di("textureLoad",Vi,Re,[ht,Ee]),...Di("textureLoad",Vi,fe,[ot,Ee]),...Di("textureLoad",Vi,fe,[at,Ee]),...Di("textureLoad",Vi,fe,[Ve,Te,Ee]),...Di("textureLoad",Vi,ge,[Xe,Te,Ee]),...Di("textureLoad",Vi,Re,[We,Te,Ee]),...Di("textureLoad",Vi,fe,[St,Te]),...Di("textureLoad",Vi,fe,[Gt,Te]),...Di("textureLoad",Vi,ge,[$t,Te]),...Di("textureLoad",Vi,Re,[Ut,Te]),...Di("textureLoad",Vi,fe,[Dt,Te]),...Di("textureLoad",Vi,ge,[Bt,Te]),...Di("textureLoad",Vi,Re,[Mt,Te]),...Di("textureLoad",Vi,fe,[vt,Te]),...Di("textureLoad",Vi,ge,[Nt,Te]),...Di("textureLoad",Vi,Re,[Ft,Te]),...Di("textureLoad",Vi,fe,[Ot,Te]),...Di("textureLoad",Vi,ge,[Lt,Te]),...Di("textureLoad",Vi,Re,[wt,Te]),...Di("textureLoad",Vi,ge,[It,Te]),...Di("textureLoad",Vi,Re,[Ct,Te]),...Di("textureLoad",Vi,fe,[Rt,Te]),...Di("textureLoad",Vi,fe,[bt,Te]),...Di("textureLoad",Vi,fe,[Ye,xe,Ee]),...Di("textureLoad",Vi,ge,[je,xe,Ee]),...Di("textureLoad",Vi,Re,[Ke,xe,Ee]),...Di("textureLoad",Vi,fe,[ir,xe]),...Di("textureLoad",Vi,fe,[Tr,xe]),...Di("textureLoad",Vi,ge,[Er,xe]),...Di("textureLoad",Vi,Re,[dr,xe]),...Di("textureLoad",Vi,fe,[mr,xe]),...Di("textureLoad",Vi,ge,[fr,xe]),...Di("textureLoad",Vi,Re,[pr,xe]),...Di("textureLoad",Vi,fe,[hr,xe]),...Di("textureLoad",Vi,ge,[ur,xe]),...Di("textureLoad",Vi,Re,[or,xe]),...Di("textureLoad",Vi,fe,[_r,xe]),...Di("textureLoad",Vi,ge,[cr,xe]),...Di("textureLoad",Vi,Re,[lr,xe]),...Di("textureLoad",Vi,ge,[ar,xe]),...Di("textureLoad",Vi,Re,[nr,xe]),...Di("textureLoad",Vi,fe,[sr,xe]),...Di("textureLoad",Vi,fe,[rr,xe]),...Di("textureLoad",Vi,fe,[st,Te,Ee]),...Di("textureLoad",Vi,ge,[it,Te,Ee]),...Di("textureLoad",Vi,Re,[nt,Te,Ee]),...Di("textureLoad",Vi,fe,[Je,Te]),...Di("textureLoad",Vi,ce,[xr,Te,Ee]),...Di("textureLoad",Vi,ce,[br,Te,Ee]),...Di("texelFetch",Pi,fe,[$e,Te,Ee]),...Di("texelFetch",Pi,fe,[Ve,Te,Ee]),...Di("texelFetch",Pi,fe,[Ye,xe,Ee]),...Di("texelFetch",Pi,Re,[Je,Te,Ee]),...Di("texelFetch",Pi,fe,[Ge,Te,Ee]),...Di("texelFetch",Pi,ge,[Xe,Te,Ee]),...Di("texelFetch",Pi,ge,[je,xe,Ee]),...Di("texelFetch",Pi,fe,[Pe,Te,Ee]),...Di("texelFetch",Pi,Re,[We,Te,Ee]),...Di("texelFetch",Pi,Re,[Ke,xe,Ee])],normalizeFunc(e,t,...r){if(0===r.length)throw new _s("textureLoad");if(!(r[0]instanceof Ni))throw new fs("textureLoad","tex");const s=r[0].$ast.getType();if(!s.isTextureType())throw new ps("textureLoad","tex");if("webgl2"===e.getDevice().type){if(3!==r.length)throw new _s("textureLoad");if(s.is1DTexture()){if("number"==typeof r[1]){if(!Number.isInteger(r[1]))throw new ps("textureLoad","coord")}else{if(!(r[1]instanceof Ni))throw new ps("textureLoad","coord");{const e=r[1].$ast.getType();if(!e.isPrimitiveType()||!e.isScalarType()||e.scalarType!==X.I32)throw new ps("textureLoad","coord")}}r[1]=e.ivec2(r[1],0)}}else"webgpu"===e.getDevice().type&&(s.isExternalTexture()&&(r=r.slice(0,2)),s.isStorageTexture()&&(s.readable=!0));return Mi(e,t,...r)}},textureArrayLoad:{overloads:[...Di("textureLoad",Vi,fe,[ke,Te,Ee,Ee]),...Di("textureLoad",Vi,ge,[ze,Te,Ee,Ee]),...Di("textureLoad",Vi,Re,[He,Te,Ee,Ee]),...Di("textureLoad",Vi,ce,[gr,Te,Ee,Ee]),...Di("texelFetch",Pi,fe,[ke,xe,Ee]),...Di("texelFetch",Pi,ge,[ze,xe,Ee]),...Di("texelFetch",Pi,Re,[He,xe,Ee])],normalizeFunc(e,t,...r){if(0===r.length)throw new _s("textureArrayLoad");const s=r[0];if(!(s instanceof Ni))throw new fs("textureArrayLoad","tex");const i=s.$ast.getType();if(!i.isTextureType())throw new ps("textureArrayLoad","tex");if("webgl2"===e.getDevice().type){if(4!==r.length)throw new _s("textureArrayLoad");const i=e.ivec3(r[1],r[2]);return Mi(e,t,s,i,r[3])}return i.isStorageTexture()&&(i.readable=!0),Mi(e,t,...r)}},textureStore:{overloads:[...Di("textureStore",Vi,Cr,[at,ye,fe]),...Di("textureStore",Vi,Cr,[ot,ye,fe]),...Di("textureStore",Vi,Cr,[ht,ye,Re]),...Di("textureStore",Vi,Cr,[lt,ye,ge]),...Di("textureStore",Vi,Cr,[ct,ye,Re]),...Di("textureStore",Vi,Cr,[_t,ye,ge]),...Di("textureStore",Vi,Cr,[pt,ye,fe]),...Di("textureStore",Vi,Cr,[ft,ye,Re]),...Di("textureStore",Vi,Cr,[mt,ye,ge]),...Di("textureStore",Vi,Cr,[dt,ye,fe]),...Di("textureStore",Vi,Cr,[Et,ye,Re]),...Di("textureStore",Vi,Cr,[Tt,ye,ge]),...Di("textureStore",Vi,Cr,[xt,ye,fe]),...Di("textureStore",Vi,Cr,[gt,ye,Re]),...Di("textureStore",Vi,Cr,[yt,ye,ge]),...Di("textureStore",Vi,Cr,[At,ye,fe]),...Di("textureStore",Vi,Cr,[bt,Ae,fe]),...Di("textureStore",Vi,Cr,[Rt,Ae,fe]),...Di("textureStore",Vi,Cr,[Ct,Ae,Re]),...Di("textureStore",Vi,Cr,[It,Ae,ge]),...Di("textureStore",Vi,Cr,[Ft,Ae,Re]),...Di("textureStore",Vi,Cr,[Nt,Ae,ge]),...Di("textureStore",Vi,Cr,[vt,Ae,fe]),...Di("textureStore",Vi,Cr,[wt,Ae,Re]),...Di("textureStore",Vi,Cr,[Lt,Ae,ge]),...Di("textureStore",Vi,Cr,[Ot,Ae,fe]),...Di("textureStore",Vi,Cr,[Mt,Ae,Re]),...Di("textureStore",Vi,Cr,[Bt,Ae,ge]),...Di("textureStore",Vi,Cr,[Dt,Ae,fe]),...Di("textureStore",Vi,Cr,[Ut,Ae,Re]),...Di("textureStore",Vi,Cr,[Ut,Te,Re]),...Di("textureStore",Vi,Cr,[$t,Ae,ge]),...Di("textureStore",Vi,Cr,[Gt,Ae,fe]),...Di("textureStore",Vi,Cr,[rr,be,fe]),...Di("textureStore",Vi,Cr,[sr,be,fe]),...Di("textureStore",Vi,Cr,[nr,be,Re]),...Di("textureStore",Vi,Cr,[ar,be,ge]),...Di("textureStore",Vi,Cr,[or,be,Re]),...Di("textureStore",Vi,Cr,[ur,be,ge]),...Di("textureStore",Vi,Cr,[hr,be,fe]),...Di("textureStore",Vi,Cr,[lr,be,Re]),...Di("textureStore",Vi,Cr,[cr,be,ge]),...Di("textureStore",Vi,Cr,[_r,be,fe]),...Di("textureStore",Vi,Cr,[pr,be,Re]),...Di("textureStore",Vi,Cr,[fr,be,ge]),...Di("textureStore",Vi,Cr,[mr,be,fe]),...Di("textureStore",Vi,Cr,[dr,be,Re]),...Di("textureStore",Vi,Cr,[Er,be,ge]),...Di("textureStore",Vi,Cr,[Tr,be,fe])],normalizeFunc(e,t,...r){if("webgpu"===e.getDevice().type){const e=r[0];if(e instanceof Ni){const t=e.$ast.getType();t?.isTextureType()&&t.isStorageTexture()&&(t.writable=!0)}}return Mi(e,t,...r)}},textureArrayStore:{overloads:[...Di("textureStore",Vi,Cr,[Pt,Ae,Ee,fe]),...Di("textureStore",Vi,Cr,[Vt,Ae,Ee,fe]),...Di("textureStore",Vi,Cr,[Xt,Ae,Ee,Re]),...Di("textureStore",Vi,Cr,[Wt,Ae,Ee,ge]),...Di("textureStore",Vi,Cr,[kt,Ae,Ee,Re]),...Di("textureStore",Vi,Cr,[zt,Ae,Ee,ge]),...Di("textureStore",Vi,Cr,[Ht,Ae,Ee,fe]),...Di("textureStore",Vi,Cr,[Yt,Ae,Ee,Re]),...Di("textureStore",Vi,Cr,[jt,Ae,Ee,ge]),...Di("textureStore",Vi,Cr,[Kt,Ae,Ee,fe]),...Di("textureStore",Vi,Cr,[Zt,Ae,Ee,Re]),...Di("textureStore",Vi,Cr,[qt,Ae,Ee,ge]),...Di("textureStore",Vi,Cr,[Qt,Ae,Ee,fe]),...Di("textureStore",Vi,Cr,[Jt,Ae,Ee,Re]),...Di("textureStore",Vi,Cr,[er,Ae,Ee,ge]),...Di("textureStore",Vi,Cr,[tr,Ae,Ee,fe])],normalizeFunc(e,t,...r){if("webgpu"===e.getDevice().type){const e=r[0];if(e instanceof Ni){const t=e.$ast.getType();t?.isTextureType()&&t.isStorageTexture()&&(t.writable=!0)}}return Mi(e,t,...r)}},textureNumLayers:{overloads:[...Di("textureNumLayers",Vi,Ee,[ke]),...Di("textureNumLayers",Vi,Ee,[ze]),...Di("textureNumLayers",Vi,Ee,[He]),...Di("textureNumLayers",Vi,Ee,[et]),...Di("textureNumLayers",Vi,Ee,[tt]),...Di("textureNumLayers",Vi,Ee,[rt]),...Di("textureNumLayers",Vi,Ee,[gr]),...Di("textureNumLayers",Vi,Ee,[Ar]),...Di("textureNumLayers",Vi,Ee,[tr]),...Di("textureNumLayers",Vi,Ee,[er]),...Di("textureNumLayers",Vi,Ee,[Jt]),...Di("textureNumLayers",Vi,Ee,[Qt]),...Di("textureNumLayers",Vi,Ee,[qt]),...Di("textureNumLayers",Vi,Ee,[Zt]),...Di("textureNumLayers",Vi,Ee,[Ht]),...Di("textureNumLayers",Vi,Ee,[zt]),...Di("textureNumLayers",Vi,Ee,[kt]),...Di("textureNumLayers",Vi,Ee,[Kt]),...Di("textureNumLayers",Vi,Ee,[jt]),...Di("textureNumLayers",Vi,Ee,[Yt]),...Di("textureNumLayers",Vi,Ee,[Wt]),...Di("textureNumLayers",Vi,Ee,[Vt]),...Di("textureNumLayers",Vi,Ee,[Xt]),...Di("textureNumLayers",Vi,Ee,[Pt])]},textureNumLevels:{overloads:[...Di("textureNumLevels",Vi,Ee,[$e]),...Di("textureNumLevels",Vi,Ee,[Ge]),...Di("textureNumLevels",Vi,Ee,[Pe]),...Di("textureNumLevels",Vi,Ee,[Ve]),...Di("textureNumLevels",Vi,Ee,[Xe]),...Di("textureNumLevels",Vi,Ee,[We]),...Di("textureNumLevels",Vi,Ee,[ke]),...Di("textureNumLevels",Vi,Ee,[ze]),...Di("textureNumLevels",Vi,Ee,[He]),...Di("textureNumLevels",Vi,Ee,[Ye]),...Di("textureNumLevels",Vi,Ee,[je]),...Di("textureNumLevels",Vi,Ee,[Ke]),...Di("textureNumLevels",Vi,Ee,[Ze]),...Di("textureNumLevels",Vi,Ee,[qe]),...Di("textureNumLevels",Vi,Ee,[Qe]),...Di("textureNumLevels",Vi,Ee,[et]),...Di("textureNumLevels",Vi,Ee,[tt]),...Di("textureNumLevels",Vi,Ee,[rt]),...Di("textureNumLevels",Vi,Ee,[xr]),...Di("textureNumLevels",Vi,Ee,[gr]),...Di("textureNumLevels",Vi,Ee,[yr]),...Di("textureNumLevels",Vi,Ee,[Ar])]},textureNumSamples:{overloads:[...Di("textureNumSamples",Vi,Ee,[st]),...Di("textureNumSamples",Vi,Ee,[it]),...Di("textureNumSamples",Vi,Ee,[nt]),...Di("textureNumSamples",Vi,Ee,[br])]},textureSample:{overloads:[...Di("textureSample",Vi,fe,[$e,Rr,ce]),...Di("textureSample",Vi,fe,[Ve,Rr,_e]),...Di("textureSample",Vi,fe,[Ye,Rr,pe]),...Di("textureSample",Vi,fe,[Ze,Rr,pe]),...Di("textureSample",Vi,ce,[xr,Rr,_e]),...Di("textureSample",Vi,ce,[yr,Rr,pe]),...Di("textureSampleBaseClampToEdge",Vi,fe,[Je,Rr,_e]),...Di("texture",Pi,fe,[$e,_e]),...Di("texture",Pi,fe,[Ve,_e]),...Di("texture",Pi,fe,[Je,_e]),...Di("texture",Pi,fe,[xr,_e]),...Di("texture",Pi,fe,[Ye,pe]),...Di("texture",Pi,fe,[Ze,pe]),...Di("texture",Pi,fe,[yr,pe]),...Di("texture2D",Gi,fe,[$e,_e]),...Di("texture2D",Gi,fe,[Ve,_e]),...Di("texture2D",Gi,fe,[Je,_e]),...Di("texture2D",Gi,fe,[xr,_e]),...Di("textureCube",Gi,fe,[Ze,pe]),...Di("textureCube",Gi,fe,[yr,pe])],normalizeFunc(e,t,...r){if(2!==r.length)throw new _s("textureSample");const s=r[0];if(!(s instanceof Ni))throw new ps("textureSample","texture");const i=s.$ast.getType();if(!i.isTextureType())throw new ps("textureSample","texture");if("webgpu"===e.getDevice().type){if(i.isStorageTexture())throw new ps("textureSample","texture");const n=e.getDefaultSampler(s,!1),a=Mi(e,t,s,n,r[1]);return a.$ast.getType().isCompatibleType(ce)?e.vec4(a):a}if(e.getDefaultSampler(s,!1),i.is1DTexture()){if(r[1]instanceof Ni){const e=r[1].$ast.getType();if(!e.isPrimitiveType()||!e.isScalarType()||e.scalarType!==X.F32)throw new ps("textureSample","coord")}else if("number"!=typeof r[1])throw new ps("textureSample","coord");r[1]=e.vec2(r[1],0)}return Mi(e,t,...r)}},textureArraySample:{overloads:[...Di("textureSample",Vi,fe,[ke,Rr,_e,Ee]),...Di("textureSample",Vi,fe,[et,Rr,pe,Ee]),...Di("textureSample",Vi,ce,[gr,Rr,_e,Ee]),...Di("textureSample",Vi,ce,[Ar,Rr,pe,Ee]),...Di("texture",Pi,fe,[ke,pe]),...Di("texture",Pi,fe,[gr,pe])],normalizeFunc(e,t,...r){if(3!==r.length)throw new _s("textureArraySample");const s=r[0];if(!(s instanceof Ni))throw new ps("textureArraySample","texture");if(!s.$ast.getType().isTextureType())throw new ps("textureArraySample","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!1),n=Mi(e,t,s,i,r[1],r[2]);return n.$ast.getType().isCompatibleType(ce)?e.vec4(n):n}{e.getDefaultSampler(s,!1);const i=r[1],n=r[2],a=e.vec3(i,e.float(n));return Mi(e,t,s,a)}}},textureSampleBias:{overloads:[...Di("textureSampleBias",Vi,fe,[Ve,Rr,_e,ce]),...Di("textureSampleBias",Vi,fe,[Ye,Rr,pe,ce]),...Di("textureSampleBias",Vi,fe,[Ze,Rr,pe,ce]),...Di("texture",Pi,fe,[Ve,_e,ce]),...Di("texture",Pi,fe,[Ye,pe,ce]),...Di("texture",Pi,fe,[Ze,pe,ce]),...Di("texture2D",Gi,fe,[Ve,_e,ce]),...Di("textureCube",Gi,fe,[Ze,pe,ce])],normalizeFunc(e,t,...r){if(3!==r.length)throw new _s("textureSampleBias");const s=r[0];if(!(s instanceof Ni))throw new ps("textureSampleBias","texture");if(!s.$ast.getType().isTextureType())throw new ps("textureSampleBias","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!1);return Mi(e,t,s,i,r[1],r[2])}return e.getDefaultSampler(s,!1),Mi(e,t,...r)}},textureArraySampleBias:{overloads:[...Di("textureSampleBias",Vi,fe,[ke,Rr,_e,Ee,ce]),...Di("textureSampleBias",Vi,fe,[et,Rr,pe,Ee,ce]),...Di("texture",Pi,fe,[ke,pe,ce])],normalizeFunc(e,t,...r){if(4!==r.length)throw new _s("textureArraySampleBias");const s=r[0];if(!(s instanceof Ni))throw new ps("textureArraySampleBias","texture");if(!s.$ast.getType().isTextureType())throw new ps("textureArraySampleBias","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!1);return Mi(e,t,s,i,r[1],r[2],r[3])}if("webgl2"===e.getDevice().type){e.getDefaultSampler(s,!1);const i=r[1],n=r[2],a=e.vec3(i,e.float(n));return Mi(e,t,s,a,r[3])}}},textureSampleCompare:{overloads:[...Di("textureSampleCompare",Vi,ce,[xr,Sr,_e,ce]),...Di("textureSampleCompare",Vi,ce,[yr,Sr,pe,ce]),...Di("texture",Pi,ce,[xr,pe]),...Di("texture",Pi,ce,[yr,fe])],normalizeFunc(e,t,...r){if(3!==r.length)throw new _s("textureSampleCompare");const s=r[0];if(!(s instanceof Ni))throw new ps("textureSampleCompare","texture");const i=s.$ast.getType();if(!i.isTextureType()||!i.isDepthTexture())throw new ps("textureSampleCompare","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(r[0],!0);return Mi(e,t,s,i,r[1],r[2])}{let n;return e.getDefaultSampler(r[0],!0),n=i.isCubeTexture()||i.isArrayTexture()?e.vec4(r[1],r[2]):e.vec3(r[1],r[2]),Mi(e,t,s,n)}}},textureArraySampleCompare:{overloads:[...Di("textureSampleCompare",Vi,ce,[gr,Sr,_e,Ee,ce]),...Di("textureSampleCompare",Vi,ce,[Ar,Sr,pe,Ee,ce]),...Di("texture",Pi,ce,[gr,fe])],normalizeFunc(e,t,...r){if(4!==r.length)throw new _s("textureArraySampleCompare");const s=r[0];if(!(s instanceof Ni))throw new ps("textureArraySampleCompare","texture");const i=s.$ast.getType();if(!i.isTextureType()||!i.isDepthTexture())throw new ps("textureArraySampleCompare","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(r[0],!0);return Mi(e,t,s,i,r[1],r[2],r[3])}{e.getDefaultSampler(r[0],!0);const i=e.vec4(r[1],e.float(r[2]),r[3]);return Mi(e,t,s,i)}}},textureSampleLevel:{overloads:[...Di("textureSampleLevel",Vi,fe,[Ve,Rr,_e,ce]),...Di("textureSampleLevel",Vi,fe,[Ye,Rr,pe,ce]),...Di("textureSampleLevel",Vi,fe,[Ze,Rr,pe,ce]),...Di("textureSampleLevel",Vi,fe,[Je,Rr,_e]),...Di("textureSampleLevel",Vi,ce,[xr,Rr,_e,Ee]),...Di("textureSampleLevel",Vi,ce,[yr,Rr,pe,Ee]),...Di("textureLod",Pi,fe,[Ve,_e,ce]),...Di("textureLod",Pi,fe,[xr,_e,ce]),...Di("textureLod",Pi,fe,[Je,_e,ce]),...Di("textureLod",Pi,fe,[Ye,pe,ce]),...Di("textureLod",Pi,fe,[Ze,pe,ce]),...Di("textureLod",Pi,fe,[yr,pe,ce]),...Di("texture2DLodEXT",Gi,fe,[Ve,_e,ce]),...Di("texture2DLodEXT",Gi,fe,[xr,_e,ce]),...Di("texture2DLodEXT",Gi,fe,[Je,_e,ce]),...Di("textureCubeLodEXT",Gi,fe,[Ze,pe,ce]),...Di("textureCubeLodEXT",Gi,fe,[yr,pe,ce])],normalizeFunc(e,t,...r){const s=r[0];if(!(s instanceof Ni))throw new ps("textureSampleLevel","texture");const i=s.$ast.getType();if(!i.isTextureType())throw new ps("textureSampleLevel","texture");if("webgl"===e.getDevice().type&&"vertex"===e.shaderKind)return e.textureSample(s,r[1]);if("webgpu"===e.getDevice().type){if(i.isExternalTexture())return e.textureLoad(s,e.ivec2(r[1]),0);{const n=e.getDefaultSampler(s,!1),a=i.isDepthTexture()&&("number"==typeof r[2]||r[2]instanceof Ni&&r[2].$ast.getType().isCompatibleType(ce))?e.int(r[2]):r[2],o=i.isExternalTexture()?Mi(e,t,s,n,r[1]):Mi(e,t,s,n,r[1],a);return o.$ast.getType().isCompatibleType(ce)?e.vec4(o):o}}return e.getDefaultSampler(s,!1),i.isExternalTexture()?Mi(e,t,r[0],r[1],0):Mi(e,t,r[0],r[1],r[2])}},textureArraySampleLevel:{overloads:[...Di("textureSampleLevel",Vi,fe,[ke,Rr,_e,Ee,ce]),...Di("textureSampleLevel",Vi,fe,[et,Rr,pe,Ee,ce]),...Di("textureSampleLevel",Vi,ce,[gr,Rr,_e,Ee,Ee]),...Di("textureSampleLevel",Vi,ce,[Ar,Rr,pe,Ee,Ee]),...Di("textureLod",Pi,fe,[ke,pe,ce])],normalizeFunc(e,t,...r){if(4!==r.length)throw new _s("textureArraySampleLevel");const s=r[0];if(!(s instanceof Ni))throw new ps("textureArraySampleLevel","texture");const i=s.$ast.getType();if(!i.isTextureType())throw new ps("textureArraySampleLevel","texture");if("webgpu"===e.getDevice().type){const n=e.getDefaultSampler(s,!1),a=i.isDepthTexture()&&("number"==typeof r[3]||r[3]instanceof Ni&&r[3].$ast.getType().isCompatibleType(ce))?e.int(r[3]):r[3],o=Mi(e,t,s,n,r[1],r[2],a);return o.$ast.getType().isCompatibleType(ce)?e.vec4(o):o}{e.getDefaultSampler(s,!1);const i=e.vec3(r[1],e.float(r[2]));return Mi(e,t,s,i,r[3])}}},textureSampleCompareLevel:{overloads:[...Di("textureSampleCompareLevel",Vi,ce,[xr,Sr,_e,ce]),...Di("textureSampleCompareLevel",Vi,ce,[yr,Sr,pe,ce]),...Di("textureLod",Pi,ce,[xr,pe,ce]),...Di("texture",Pi,ce,[yr,fe])],normalizeFunc(e,t,...r){if(3!==r.length)throw new _s("textureSampleCompareLevel");const s=r[0];if(!(s instanceof Ni))throw new ps("textureSampleCompareLevel","texture");const i=s.$ast.getType();if(!i.isTextureType()||!i.isDepthTexture())throw new ps("textureSampleCompareLevel","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!0);return Mi(e,t,s,i,r[1],r[2])}{let n;return e.getDefaultSampler(r[0],!0),n=i.isCubeTexture()||i.isArrayTexture()?e.vec4(r[1],r[2]):e.vec3(r[1],r[2]),i.isCubeTexture()?Mi(e,t,s,n):Mi(e,t,s,n,0)}}},textureArraySampleCompareLevel:{overloads:[...Di("textureSampleCompareLevel",Vi,ce,[gr,Sr,_e,Ee,ce]),...Di("textureSampleCompareLevel",Vi,ce,[Ar,Sr,pe,Ee,ce]),...Di("texture",Pi,ce,[gr,fe])],normalizeFunc(e,t,...r){if(4!==r.length)throw new _s("textureArraySampleCompareLevel");const s=r[0];if(!(s instanceof Ni))throw new ps("textureArraySampleCompareLevel","texture");const i=s.$ast.getType();if(!i.isTextureType()||!i.isDepthTexture())throw new ps("textureArraySampleCompareLevel","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!0);return Mi(e,t,s,i,r[1],r[2],r[3])}{e.getDefaultSampler(r[0],!0);const i=e.vec4(r[1],e.float(r[2]),r[3]);return Mi(e,t,s,i)}}},textureSampleGrad:{overloads:[...Di("textureSampleGrad",Vi,fe,[Ve,Rr,_e,_e,_e]),...Di("textureSampleGrad",Vi,fe,[Ye,Rr,pe,pe,pe]),...Di("textureSampleGrad",Vi,fe,[Ze,Rr,pe,pe,pe]),...Di("textureGrad",Pi,fe,[Ve,_e,_e,_e]),...Di("textureGrad",Pi,fe,[Ye,pe,pe,pe]),...Di("textureGrad",Pi,fe,[Ze,pe,pe,pe]),...Di("texture2DGradEXT",Gi,fe,[Ve,_e,_e,_e]),...Di("textureCubeGradEXT",Gi,fe,[Ze,pe,pe,pe])],normalizeFunc(e,t,...r){if(4!==r.length)throw new _s("textureSampleGrad");const s=r[0];if(!(s instanceof Ni))throw new ps("textureSampleGrad","texture");if(!s.$ast.getType().isTextureType())throw new ps("textureSampleGrad","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!1);return Mi(e,t,s,i,r[1],r[2],r[3])}return e.getDefaultSampler(s,!1),Mi(e,t,...r)}},textureArraySampleGrad:{overloads:[...Di("textureSampleGrad",Vi,fe,[ke,Rr,_e,Ee,_e,_e]),...Di("textureSampleGrad",Vi,fe,[et,Rr,pe,Ee,pe,pe]),...Di("textureGrad",Pi,fe,[ke,pe,_e,_e])],normalizeFunc(e,t,...r){if(5!==r.length)throw new _s("textureArraySampleGrad");const s=r[0];if(!(s instanceof Ni))throw new ps("textureArraySampleGrad","texture");const i=s.$ast.getType();if(!i.isTextureType()||!i.isArrayTexture())throw new ps("textureArraySampleGrad","texture");if("webgpu"===e.getDevice().type){const i=e.getDefaultSampler(s,!1);return Mi(e,t,s,i,r[1],r[2],r[3],r[4])}{e.getDefaultSampler(s,!1);const i=e.vec3(r[1],e.float(r[2]));return Mi(e,t,s,i,r[3],r[4])}}},storageBarrier:{overloads:Di("storageBarrier",Vi,Cr,[])},workgroupBarrier:{overloads:Di("workgroupBarrier",Vi,Cr,[])},atomicLoad:{overloades:[],normalizeFunc(e,t,...r){if(1!==r.length)throw new _s(t);const s=r[0];if(!(s instanceof Ni))throw new ps(t,"ptr");if(s.$ast.getType().typeId===me.typeId)return e.$callFunctionNoCheck(t,[new ii(s.$ast)],Ee);if(s.$ast.getType().typeId===de.typeId)return e.$callFunctionNoCheck(t,[new ii(s.$ast)],ye);throw new fs(t,"ptr must be atomic type")}},atomicStore:{overloades:[],normalizeFunc(e,t,...r){if(2!==r.length)throw new _s(t);const s=r[0],i=r[1];if(!(s instanceof Ni))throw new ps(t,"ptr");if(s.$ast.getType().typeId===me.typeId){if("number"==typeof i){if(!Number.isInteger(i))throw new fs(t,"value");return e.$callFunctionNoCheck(t,[new ii(s.$ast),new ti(i,Ee)],Cr)}if(i instanceof Ni){if(i.$ast.getType().typeId!==Ee.typeId)throw new ps(t,"value");return e.$callFunctionNoCheck(t,[new ii(s.$ast),i.$ast],Cr)}throw new ps(t,"value")}if(s.$ast.getType().typeId===de.typeId){if("number"==typeof i){if(!Number.isInteger(i))throw new fs(t,"value");return e.$callFunctionNoCheck(t,[new ii(s.$ast),new ti(i,ye)],Cr)}if(i instanceof Ni){if(i.$ast.getType().typeId!==ye.typeId)throw new ps(t,"value");return e.$callFunctionNoCheck(t,[new ii(s.$ast),i.$ast],Cr)}throw new ps(t,"value")}throw new fs(t,"ptr must be atomic type")}}};for(const e of["atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange"])ki[e]={overloades:[],normalizeFunc(e,t,...r){if(2!==r.length)throw new _s(t);const s=r[0],i=r[1];if(!(s instanceof Ni))throw new ps(t,"ptr");if(s.$ast.getType().typeId===me.typeId){if("number"==typeof i){if(!Number.isInteger(i))throw new fs(t,"value");return e.$callFunctionNoCheck(t,[new ii(s.$ast),new ti(i,Ee)],Ee)}if(i instanceof Ni){if(i.$ast.getType().typeId!==Ee.typeId)throw new ps(t,"value");return e.$callFunctionNoCheck(t,[new ii(s.$ast),i.$ast],Ee)}throw new ps(t,"value")}if(s.$ast.getType().typeId===de.typeId){if("number"==typeof i){if(!Number.isInteger(i))throw new fs(t,"value");return e.$callFunctionNoCheck(t,[new ii(s.$ast),new ti(i,ye)],ye)}if(i instanceof Ni){if(i.$ast.getType().typeId!==ye.typeId)throw new ps(t,"value");return e.$callFunctionNoCheck(t,[new ii(s.$ast),i.$ast],ye)}throw new ps(t,"value")}throw new fs(t,"ptr must be atomic type")}};const zi={rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",rgba8uint:"rgba8ui",rgba8sint:"rgba8i",rgba16uint:"rgba16ui",rgba16sint:"rgba16i",rgba16float:"rgba16f",r32float:"r32f",r32uint:"r32ui",r32sint:"r32i",rg32float:"rg32f",rg32uint:"rg32ui",rg32sint:"rg32i",rgba32float:"rgba32f",rgba32uint:"rgba32ui",rgba32sint:"rgba32i"};function Hi(e,...t){if("webgl"===this.getDevice().type){if(e.scalarType===X.U32)throw new Ts("unsigned integer type");if(e.isMatrixType()&&e.cols!==e.rows)throw new Ts("non-square matrix type")}if(1===t.length&&"string"==typeof t[0])return new Ni(t[0],e);{const r=new Ni("",e);return!e.isScalarType()||1!==t.length||"number"!=typeof t[0]&&"boolean"!=typeof t[0]?r.$ast=new ei(r.$typeinfo,t.map(e=>{if("string"==typeof e)throw new ps("vec_n");return e instanceof Ni?e.$ast:e})):r.$ast=new ti(t[0],e),r}}const Yi={float:ce,int:Ee,uint:ye,bool:Se,vec2:_e,ivec2:Te,uvec2:Ae,bvec2:Ce,vec3:pe,ivec3:xe,uvec3:be,bvec3:Ie,vec4:fe,ivec4:ge,uvec4:Re,bvec4:Fe,mat2:Ne,mat2x3:ve,mat2x4:we,mat3x2:Le,mat3:Oe,mat3x4:Me,mat4x2:Be,mat4x3:De,mat4:Ue},ji={tex1D:$e,tex2D:Ve,tex3D:Ye,texCube:Ze,tex2DShadow:xr,texCubeShadow:yr,tex2DArray:ke,tex2DArrayShadow:gr,texExternal:Je,itex1D:Ge,itex2D:Xe,itex3D:je,itexCube:qe,itex2DArray:ze,utex1D:Pe,utex2D:We,utex3D:Ke,utexCube:Qe,utex2DArray:He,sampler:Rr,samplerComparison:Sr};const Ki={texStorage1D:Z.TEX_STORAGE_1D,texStorage2D:Z.TEX_STORAGE_2D,texStorage2DArray:Z.TEX_STORAGE_2D_ARRAY,texStorage3D:Z.TEX_STORAGE_3D};const Zi="zVSInput_",qi="zVSOutput_";class Qi{_device;_workgroupSize;_scopeStack=[];_shaderType=M.Vertex|M.Fragment|M.Compute;_structInfo;_uniforms;_globalScope;_builtinScope;_inputScope;_outputScope;_inputs;_outputs;_vertexAttributes;_depthRangeCorrection;_emulateDepthClamp;_lastError;_reflection;_autoStructureTypeIndex;_nameMap;constructor(e){this._device=e,this._workgroupSize=null,this._structInfo={},this._uniforms=[],this._scopeStack=[],this._globalScope=null,this._builtinScope=null,this._inputScope=null,this._outputScope=null,this._inputs=[],this._outputs=[],this._vertexAttributes=[],this._depthRangeCorrection="webgpu"===e.type,this._emulateDepthClamp=!1,this._lastError=null,this._reflection=new as(this),this._autoStructureTypeIndex=0,this._nameMap=[]}get lastError(){return this._lastError}get shaderType(){return this._shaderType}get shaderKind(){return this._shaderType===M.Vertex?"vertex":this._shaderType===M.Fragment?"fragment":this._shaderType===M.Compute?"compute":null}getGlobalScope(){return this._globalScope}get builtinScope(){return this._builtinScope}get inputScope(){return this._inputScope}get outputScope(){return this._outputScope}get depthRangeCorrection(){return this._depthRangeCorrection}get emulateDepthClamp(){return this._emulateDepthClamp}set emulateDepthClamp(e){this._emulateDepthClamp=e}getReflection(){return this._reflection}getDevice(){return this._device}reset(){this._workgroupSize=null,this._structInfo={},this._uniforms=[],this._scopeStack=[],this._globalScope=null,this._builtinScope=null,this._inputScope=null,this._outputScope=null,this._inputs=[],this._outputs=[],this._vertexAttributes=[],this._depthRangeCorrection="webgpu"===this._device.type,this._reflection=new as(this),this._autoStructureTypeIndex=0,this._nameMap=[]}queryGlobal(e){return this.getReflection().tag(e)}pushScope(e){this._scopeStack.unshift(e)}popScope(){return this._scopeStack.shift()}getCurrentScope(){return this._scopeStack[0]}getCurrentFunctionScope(){let e=this.getCurrentScope();for(;e&&!(e instanceof on);)e=e.$parent;return e}buildRender(e){bs(this),this._lastError=null,this.defineInternalStructs();const t=this.buildRenderSource(e);return bs(null),this.reset(),t}buildCompute(e){bs(this),this._lastError=null,this._workgroupSize=e.workgroupSize,this.defineInternalStructs();const t=this.buildComputeSource(e);return bs(null),this.reset(),t}buildRenderProgram(e){const t=this.buildRender(e);return t?this._device.createGPUProgram({type:"render",label:e.label,params:{vs:t[0],fs:t[1],bindGroupLayouts:t[2],vertexAttributes:t[3]}}):null}buildComputeProgram(e){const t=this.buildCompute(e);return t?this._device.createGPUProgram({type:"compute",params:{source:t[0],bindGroupLayouts:t[1]}}):null}func(e,t,r){this.getGlobalScope().$createFunctionIfNotExists(e,t,r)}main(e){this.getGlobalScope().$mainFunc(e)}addressOf(e){if("webgpu"!==this._device.type)throw new Ts("pointer shader type");if(!e.$ast.isReference())throw new ds(e);const t=new Ni("",e.$ast.getType());return t.$ast=new ii(e.$ast),t}referenceOf(e){if("webgpu"!==this._device.type)throw new Ts("pointer shader type");if(!e.$ast.getType().isPointerType())throw new Es(e);const t=new ni(e.$ast),r=new Ni("",t.getType());return r.$ast=t,r}struct(e,t){let r=null;for(const t of[M.Vertex,M.Fragment,M.Compute])if(t&this._shaderType){const s=this._structInfo[t];if(r=s?.structs[e],r)break}if(!r)throw new fs("struct","structName",`Struct type ${e} not exists`);return r.call(this,t)}isIdenticalStruct(e,t,r){if(r&&e.structName&&t.structName&&e.structName!==t.structName)return!1;if(e.structMembers.length!==t.structMembers.length)return!1;for(let r=0;r<e.structMembers.length;r++){const s=e.structMembers[r],i=t.structMembers[r];if(s.name!==i.name)return!1;if(s.type.isStructType()){if(!i.type.isStructType())return!1;if(!this.isIdenticalStruct(s.type,i.type,!0))return!1}else if(!s.type.isCompatibleType(i.type))return!1}return!0}generateStructureName(){return"zStruct"+this._autoStructureTypeIndex++}getVertexAttributes(){return this._vertexAttributes}defineHiddenStruct(e){for(const t of[M.Vertex,M.Fragment,M.Compute]){let r=this._structInfo[t];if(r||(r={structs:{},types:[]},this._structInfo[t]=r),r.structs[e.structName])throw new fs("defineStruct","structName",`cannot re-define struct '${e.structName}'`);r.types.push(new bi(e,!0))}}defineStruct(e,t){const r="default",s=new ne(t??"",r,e.map(e=>{if(!(e.$typeinfo.isPrimitiveType()||e.$typeinfo.isArrayType()||e.$typeinfo.isStructType()||e.$typeinfo.isAtomicI32()||e.$typeinfo.isAtomicU32()))throw new Error(`invalid struct member type: '${e.$str}'`);return{name:e.$str,type:e.$typeinfo}}));for(const e of[M.Vertex,M.Fragment,M.Compute]){let t=null,i=null;const n=this._structInfo[e];if(n){if(Rs().shaderType===e&&n.structs[s.structName])throw new fs("defineStruct","structName",`cannot re-define struct '${s.structName}'`);for(const e of n.types)if(!e.builtin&&this.isIdenticalStruct(e.getType(),s,!1)){t=e,i=n.structs[e.getType().structName];break}}if(t){if(t.type.layout!==r)throw new Error(`Can not redefine struct ${t.type.structName} with different layout`);return e!==Rs().shaderType&&(this._structInfo[Rs().shaderType]||(this._structInfo[Rs().shaderType]={structs:{},types:[]}),this._structInfo[Rs().shaderType].types.indexOf(t)<0&&(this._structInfo[Rs().shaderType].types.push(t),this._structInfo[Rs().shaderType].structs[t.getType().structName]=i)),i}}return this.internalDefineStruct(t??this.generateStructureName(),r,this._shaderType,!1,...e)}defineStructByType(e){const t=e.extends(e.structName||this.generateStructureName(),[]);for(const e of[M.Vertex,M.Fragment,M.Compute]){let r=null,s=null;const i=this._structInfo[e];if(i){if(Rs().shaderType===e&&i.structs[t.structName])throw new fs("defineStruct","structName",`cannot re-define struct '${t.structName}'`);for(const e of i.types)if(!e.builtin&&this.isIdenticalStruct(e.getType(),t,!1)){r=e,s=i.structs[e.getType().structName];break}}if(r){if(r.type.layout!==t.layout)throw new Error(`Can not redefine struct ${r.type.structName} with different layout`);return e!==Rs().shaderType&&(this._structInfo[Rs().shaderType]||(this._structInfo[Rs().shaderType]={structs:{},types:[]}),this._structInfo[Rs().shaderType].types.push(r),this._structInfo[Rs().shaderType].structs[r.getType().structName]=s),s}}return this.internalDefineStructByType(this._shaderType,!1,t)}internalDefineStruct(e,t,r,s,...i){const n=new ne(e,t,i.map(e=>{if(!(e.$typeinfo.isPrimitiveType()||e.$typeinfo.isArrayType()||e.$typeinfo.isStructType()||e.$typeinfo.isAtomicI32()||e.$typeinfo.isAtomicU32()))throw new Error(`invalid struct member type: '${e.$str}'`);return{name:e.$str,type:e.$typeinfo}}));return this.internalDefineStructByType(r,s,n)}internalDefineStructByType(e,t,r){const s=Ci(function(...e){let t;return 1===e.length&&"string"==typeof e[0]?t=new Ni(e[0],r):(t=new Ni("",r),t.$ast=new ei(t.$typeinfo,e.map(e=>e instanceof Ni?e.$ast:e))),t},r);for(const i of[M.Vertex,M.Fragment,M.Compute])if(e&i){let e=this._structInfo[i];if(e||(e={structs:{},types:[]},this._structInfo[i]=e),e.structs[r.structName])throw new fs("defineStruct","structName",`cannot re-define struct '${r.structName}'`);e.types.push(new bi(r,t)),e.structs[r.structName]=s}return s}getFunction(e){return this._globalScope?this._globalScope.$getFunctions(e):null}get structInfo(){return this._structInfo[this._shaderType]}getBlockName(e){return`ch_block_name_${e}`}defineBuiltinStruct(e,t){const r="in"===t?Bs(e):function(e){switch(e){case M.Vertex:return Cs;case M.Fragment:return Fs;case M.Compute:return"zCSOutput";default:return null}}(e),s="in"===t?Os(e):Ms(e),i=e===M.Vertex?"vertex":e===M.Fragment?"fragment":"compute",n=Us.webgpu,a=[],o=[];for(const e in n)n[e].stage===i&&n[e].inOrOut===t&&(a.push({name:n[e].name,type:n[e].type}),o.push(`@builtin(${n[e].semantic}) `));const u="in"===t?this._inputs:this._outputs;for(const e of u){if(!(e[1]instanceof Ei))throw new ys("defineBuiltinStruct() failed: input/output is not declare var ast node");const t=e[1].value.getType();if(!t.isPrimitiveType()&&!t.isArrayType()&&!t.isStructType())throw new Error(`invalid in/out variable type: '${e[1].value.name}'`);a.push({name:e[1].value.name,type:t}),o.push(`@location(${e[1].value.value.$location}) ${t.isPrimitiveType()&&t.isInteger()?"@interpolate(flat) ":""}`)}if(a.length>0){const i=this.findStructType(r,e);if(i)return i.getType().reset(r,"default",a),i.prefix=o,null;{const i=this.internalDefineStructByType(this._shaderType,!1,new ne(r,"default",a));this.findStructType(r,e).prefix=o;const n=this.struct(r,s);return[i,n,r,"in"===t?this.struct(r,Ls(e)):n]}}return null}defineInternalStructs(){this.defineHiddenStruct(Ir),this.defineHiddenStruct(Fr),this.defineHiddenStruct(Nr),this.defineHiddenStruct(vr)}array(...e){if(0===e.length)throw new _s("array");e=e.map(e=>this.normalizeExpValue(e));let t=!0,r=null,s=!0,i=!0,n=!0,a=!0,o=!1;for(const s of e)if(s instanceof Ni){const e=s.$ast.getType();if(!e.isConstructible()){t=!1;break}r?e.isCompatibleType(r)||(t=!1):r=e}if(t){r&&r.isPrimitiveType()&&r.isScalarType()?(s=r.primitiveType===X.BOOL,i=r.primitiveType===X.F32,a=r.primitiveType===X.U32,n=r.primitiveType===X.I32):r&&(s=!1,i=!1,a=!1,n=!1,o=!0);for(const r of e){if(!(r instanceof Ni)&&o){t=!1;break}"number"==typeof r?(s=!1,(0|r)===r&&(r<0?(a=!1,n=n&&r>=-2147483648):(a=a&&r<=4294967295,n=n&&r<=2147483647))):"boolean"==typeof r&&(i=!1,n=!1,a=!1)}}if(t&&!o&&(s?r=Se:n?r=Ee:a?r=ye:i&&(r=ce),t=!!r),!t)throw new ps("array");if(!r.isPrimitiveType()&&!r.isArrayType()&&!r.isStructType())throw new ps("array");const u=new ae(r,e.length),h=new Ni("",u);return h.$ast=new ei(u,e.map(e=>{if(e instanceof Ni)return e.$ast;if(!r.isPrimitiveType()||!r.isScalarType())throw new cs(e,typeof e,r);return new ti(e,r)})),h}discard(){this.getCurrentScope().$ast.statements.push(new _i)}tagShaderExp(e,t){if("string"==typeof t)this._reflection.tag(t,e);else if(Array.isArray(t))t.forEach(t=>this.tagShaderExp(e,t));else for(const r of Object.keys(t))this.tagShaderExp(t=>e(t)[r],t[r])}in(e,t,r){this._inputs[e]?this._inputScope[t]||Object.defineProperty(this._inputScope,t,{get:function(){return r},set:function(){throw new Error(`cannot assign to readonly variable: ${t}`)}}):(r.$location=e,r.$declareType=vs.DECLARE_TYPE_IN,this._inputs[e]=[t,new Ei(new js(r))],Object.defineProperty(this._inputScope,t,{get:function(){return r},set:function(){throw new Error(`cannot assign to readonly variable: ${t}`)}}),r.$tags.forEach(e=>this.tagShaderExp(()=>r,e)))}out(e,t,r){if(this._outputs[e])throw new Error(`output location ${e} has already been used`);r.$location=e,r.$declareType=vs.DECLARE_TYPE_OUT,this._outputs[e]=[t,new Ei(new js(r))];for(const s of[t,String(e)])Object.defineProperty(this._outputScope,s,{get:function(){return r},set:function(e){Rs().getCurrentScope().$ast.statements.push(new ci(new Zs(r.$ast),e instanceof Ni?e.$ast:e))}})}getDefaultSampler(e,t){const r=this._uniforms.findIndex(t=>t.texture?.exp===e);if(r<0)return;const s=t?"comparison":"sample";if(this._uniforms[r].texture.autoBindSampler&&this._uniforms[r].texture.autoBindSampler!==s)throw new Error("multiple sampler not supported");if(this._uniforms[r].texture.autoBindSampler=s,"webgpu"===this._device.type){const r=Ds(e.$str,t);if(!this.getGlobalScope()[r])throw new Error(`failed to find sampler name ${r}`);return this.getGlobalScope()[r]}return null}normalizeExpValue(e){if(Array.isArray(e)){const t=e.map(e=>Array.isArray(e)?this.normalizeExpValue(e):e);return this.array(...t)}return e}guessExpValueType(e){const t=this.normalizeExpValue(e);if("boolean"==typeof t)return Se;if("number"==typeof t){if(Number.isInteger(t)){if(t>=-1073741824&&t<=2147483647)return Ee;if(t>=0&&t<=4294967295)return ye;throw new ls(t)}return ce}return t instanceof Ni?t.$ast?.getType()||t.$typeinfo:void 0}findStructType(e,t){for(const r of[M.Vertex,M.Fragment,M.Compute])if(r&t){const t=this._structInfo[r];if(t)for(const r of t.types)if(r.type.structName===e)return r}return null}findStructConstructor(e,t){for(const r of[M.Vertex,M.Fragment,M.Compute])if(r&t){const t=this._structInfo[r];if(t&&t.structs?.[e])return t.structs[e]}return null}buildComputeSource(e){try{return this._lastError=null,this._shaderType=M.Compute,this._scopeStack=[],this._globalScope=new nn,this._builtinScope=new tn,this._inputs=[],this._outputs=[],this._inputScope=new rn,this._outputScope=new sn,this._reflection.clear(),this.generate(e.compute),this.mergeUniformsCompute(this._globalScope),this.updateUniformBindings([this._globalScope],[M.Compute]),[this.generateComputeSource(this._globalScope,this._builtinScope),this.createBindGroupLayouts(e.label)]}catch(e){return e instanceof hs?(this._lastError=e.getMessage(this._device.type),console.error(this._lastError),null):e instanceof Error?(this._lastError=e.toString(),console.error(this._lastError),null):(this._lastError=Object.prototype.toString.call(e),console.error(`Error: ${this._lastError}`),null)}}buildRenderSource(e){try{this._lastError=null,this._shaderType=M.Vertex,this._scopeStack=[],this._globalScope=new nn,this._builtinScope=new tn,this._inputs=[],this._outputs=[],this._inputScope=new rn,this._outputScope=new sn,this._reflection.clear(),this.generate(e.vertex);const t=this._globalScope,r=this._builtinScope,s=this._inputs,i=this._outputs;this._shaderType=M.Fragment,this._scopeStack=[],this._globalScope=new nn,this._builtinScope=new tn,this._inputs=[],this._outputs=[],this._inputScope=new rn,this._outputScope=new sn,this._reflection.clear(),i.forEach((e,t)=>{this.in(t,e[0],new Ni(e[1].value.name,e[1].value.getType()).tag(...e[1].value.value.$tags))}),this.generate(e.fragment);const n=this._globalScope,a=this._builtinScope,o=this._inputs,u=this._outputs;return this.mergeUniforms(t,n),this.updateUniformBindings([t,n],[M.Vertex,M.Fragment]),[this.generateRenderSource(M.Vertex,t,r,s.map(e=>e[1]),i.map(e=>e[1])),this.generateRenderSource(M.Fragment,n,a,o.map(e=>e[1]),u.map(e=>e[1])),this.createBindGroupLayouts(e.label),this._vertexAttributes]}catch(e){return e instanceof hs?(this._lastError=e.getMessage(this._device.type),console.error(this._lastError),null):e instanceof Error?(this._lastError=e.toString(),console.error(this._lastError),null):(this._lastError=Object.prototype.toString.call(e),console.error(`Error: ${this._lastError}`),null)}}generate(e){this.pushScope(this._globalScope),this._emulateDepthClamp&&this._shaderType===M.Vertex&&(this._globalScope.$outputs.clamppedDepth=this.float().tag("CLAMPPED_DEPTH")),e?.call(this._globalScope,this),this.popScope(),this._globalScope.$ast.statements=[...this._globalScope.$ast.statements.filter(e=>e instanceof Ei||e instanceof ci),...this._globalScope.$ast.statements.filter(e=>!(e instanceof Ei||e instanceof ci))]}generateRenderSource(e,t,r,s,i){const n={type:e,mrt:e===M.Fragment&&i.length>1,defines:[],extensions:new Set,builtins:[...r.$_usedBuiltins],types:this._structInfo[e]?.types||[],typeReplacement:new Map,inputs:s,outputs:i,global:t,vertexAttributes:this._vertexAttributes,workgroupSize:null};switch(this._device.type){case"webgl":for(const e of this._uniforms)if(e.texture){const t=e.texture.exp.$ast.getType();if(t.isTextureType()&&t.isDepthTexture()){if("comparison"===e.texture.autoBindSampler)throw new Ts("depth texture comparison");"sample"===e.texture.autoBindSampler&&(t.is2DTexture()?n.typeReplacement.set(e.texture.exp,Ve):t.isCubeTexture()&&n.typeReplacement.set(e.texture.exp,Ze))}}return t.$ast.toWebGL("",n);case"webgl2":for(const e of this._uniforms)if(e.texture){const t=e.texture.exp.$ast.getType();t.isTextureType()&&t.isDepthTexture()&&"sample"===e.texture.autoBindSampler&&(t.is2DTexture()?n.typeReplacement.set(e.texture.exp,t.isArrayTexture()?ke:Ve):t.isCubeTexture()&&n.typeReplacement.set(e.texture.exp,Ze))}return t.$ast.toWebGL2("",n);case"webgpu":return t.$ast.toWGSL("",n);default:return null}}generateComputeSource(e,t){const r={type:M.Compute,mrt:!1,defines:[],extensions:new Set,builtins:[...t.$_usedBuiltins],types:this._structInfo[M.Compute]?.types||[],typeReplacement:null,inputs:[],outputs:[],global:e,vertexAttributes:[],workgroupSize:this._workgroupSize};return e.$ast.toWGSL("",r)}mergeUniformsCompute(e){const t=[];for(let e=0;e<this._uniforms.length;e++){const r=this._uniforms[e];if(r.block&&(r.block.exp.$declareType===vs.DECLARE_TYPE_UNIFORM||r.block.exp.$declareType===vs.DECLARE_TYPE_STORAGE)){if(r.block.exp.$typeinfo.isStructType()&&r.block.exp.$isBuffer)continue;t[r.group]||(t[r.group]=[]);const s=new Ni(r.block.exp.$str,r.block.exp.$ast.getType());s.$declareType=r.block.exp.$declareType,s.$isBuffer=r.block.exp.$isBuffer,s.$bindingSize=r.block.exp.$bindingSize,s.$readonly=r.block.exp.$readonly,t[r.group].push({member:s,uniform:e})}}for(const r in t)if(t[r].length>0){const s=["std140","std430"],i=["zUBC","zSBC"],n=[t[r].filter(e=>e.member.$declareType===vs.DECLARE_TYPE_UNIFORM),t[r].filter(e=>e.member.$declareType===vs.DECLARE_TYPE_STORAGE)];for(let t=0;t<2;t++){if(0===n[t].length)continue;const a=[n[t].filter(e=>!e.member.$isBuffer),...n[t].filter(e=>e.member.$isBuffer).map(e=>[e])];for(let n=0;n<a.length;n++){if(0===a[n].length)continue;const o=`${i[t]}_${r}_${n}`,u=this.generateStructureName(),h=Rs().internalDefineStruct(u,s[t],M.Compute,!1,...a[n].map(e=>e.member)),l=!(t>0)||a[n].findIndex(e=>!e.member.$readonly)<0,c=h();0===t?c.uniformBuffer(Number(r),n>0?a[n][0].member.$bindingSize:0):(c.storageBuffer(Number(r),n>0?a[n][0].member.$bindingSize:0),c.$readonly=l),e[o]=c;const _=this._uniforms.findIndex(e=>e.block?.name===o);this._uniforms[_].mask=M.Compute;let p=this._nameMap[Number(r)];p||(p={},this._nameMap[Number(r)]=p);let f=!1;for(let e=a[n].length-1;e>=0;e--){const t=a[n][e],r=this._uniforms[t.uniform].block.exp;p[r.$str]=o,r.$str=`${o}.${r.$str}`,f||=r.$ast.isWritable()}f&&e[o].$ast.markWritable()}}}this._uniforms=this._uniforms.filter(e=>!e.block||e.block.exp.$typeinfo.isStructType()&&e.block.exp.$isBuffer)}mergeUniforms(e,t){const r=[],s=[],i=[];for(let e=0;e<this._uniforms.length;e++){const t=this._uniforms[e];if(t.block&&(t.block.exp.$declareType===vs.DECLARE_TYPE_UNIFORM||t.block.exp.$declareType===vs.DECLARE_TYPE_STORAGE)){if(t.block.exp.$typeinfo.isStructType()&&t.block.exp.$isBuffer)continue;const n=!!(t.mask&M.Vertex),a=!!(t.mask&M.Fragment);if(n&&a){i[t.group]||(i[t.group]=[]);const r=new Ni(t.block.exp.$str,t.block.exp.$ast.getType());r.$declareType=t.block.exp.$declareType,r.$isBuffer=t.block.exp.$isBuffer,r.$bindingSize=t.block.exp.$bindingSize,r.$readonly=t.block.exp.$readonly,i[t.group].push({member:r,uniform:e})}else if(n){r[t.group]||(r[t.group]=[]);const s=new Ni(t.block.exp.$str,t.block.exp.$ast.getType());s.$declareType=t.block.exp.$declareType,s.$isBuffer=t.block.exp.$isBuffer,s.$bindingSize=t.block.exp.$bindingSize,s.$readonly=t.block.exp.$readonly,r[t.group].push({member:s,uniform:e})}else if(a){s[t.group]||(s[t.group]=[]);const r=new Ni(t.block.exp.$str,t.block.exp.$ast.getType());r.$declareType=t.block.exp.$declareType,r.$isBuffer=t.block.exp.$isBuffer,r.$bindingSize=t.block.exp.$bindingSize,r.$readonly=t.block.exp.$readonly,s[t.group].push({member:r,uniform:e})}}}const n=[r,s,i],a=["zUBV","zUBF","zUBA"],o=["zSBV","zSBF","zSBA"],u=[M.Vertex,M.Fragment,M.Vertex|M.Fragment];for(let r=0;r<3;r++)for(const s in n[r])if(n[r][s]?.length>0){const i=[n[r][s].filter(e=>e.member.$declareType===vs.DECLARE_TYPE_UNIFORM),n[r][s].filter(e=>e.member.$declareType===vs.DECLARE_TYPE_STORAGE)],h=[a,o],l=["std140","std430"];for(let n=0;n<2;n++){if(0===i[n].length)continue;const a=[i[n].filter(e=>!e.member.$isBuffer),...i[n].filter(e=>e.member.$isBuffer).map(e=>[e])];for(let i=0;i<a.length;i++){if(0===a[i].length)continue;const o=`${h[n][r]}_${s}_${i}`,c=this.generateStructureName(),_=Rs().internalDefineStruct(c,l[n],u[r],!1,...a[i].map(e=>e.member)),p=!(n>0)||a[i].findIndex(e=>!e.member.$readonly)<0;if(u[r]&M.Vertex){const t=_();if(n>0&&!p)throw new Error("Storage buffer in vertex shader must be read-only");0===n?t.uniformBuffer(Number(s),i>0?a[i][0].member.$bindingSize:0):(t.storageBuffer(Number(s),i>0?a[i][0].member.$bindingSize:0),t.$readonly=p),e[o]=t}if(u[r]&M.Fragment){const e=_();0===n?e.uniformBuffer(Number(s),i>0?a[i][0].member.$bindingSize:0):(e.storageBuffer(Number(s),i>0?a[i][0].member.$bindingSize:0),e.$readonly=p),t[o]=e}const f=this._uniforms.findIndex(e=>e.block?.name===o);this._uniforms[f].mask=u[r];let m=this._nameMap[Number(s)];m||(m={},this._nameMap[Number(s)]=m);let d=!1;for(let e=a[i].length-1;e>=0;e--){const t=a[i][e],r=this._uniforms[t.uniform].block.exp;m[r.$str]=o,r.$str=`${o}.${r.$str}`,d||=r.$ast.isWritable()}d&&(u[r]&M.Vertex?e[o].$ast.markWritable():t[o].$ast.markWritable())}}}this._uniforms=this._uniforms.filter(e=>!e.block||e.block.exp.$typeinfo.isStructType()&&e.block.exp.$isBuffer)}updateUniformBindings(e,t){this._uniforms=this._uniforms.filter(e=>!!e.mask);const r=Array.from({length:4}).fill(0);for(const e of this._uniforms)e.binding=r[e.group]++;for(let r=0;r<e.length;r++){const s=e[r],i=t[r];for(const e of this._uniforms)if(e.mask&i){const t=s.$ast.uniforms,r=e.block?e.block.name:e.texture?e.texture.exp.$str:e.sampler.$str,i=t.findIndex(e=>e.value.name===r);if(i<0)throw new Error(`updateUniformBindings() failed: unable to find uniform ${r}`);t[i].binding=e.binding}}}createBindGroupLayouts(e){const t=[],r=[0,0,0,0];for(const s of this._uniforms){let i=t[s.group];i||(i={label:`${e||"unknown"}[${s.group}]`,entries:[]},this._nameMap[s.group]&&(i.nameMap=this._nameMap[s.group]),t[s.group]=i);const n={binding:s.binding,visibility:s.mask,type:null,name:""};if(s.block){n.type=s.block.exp.$typeinfo.clone(this.getBlockName(s.block.name));const e=s.block.exp.$declareType===vs.DECLARE_TYPE_STORAGE;n.buffer={type:e?s.block.exp.$readonly?"read-only-storage":"storage":"uniform",minBindingSize:s.block.bindingSize,hasDynamicOffset:!!s.block.bindingSize,uniformLayout:n.type.toBufferLayout(0,n.type.layout),dynamicOffsetIndex:s.block.bindingSize?r[s.group]++:-1},n.name=s.block.name}else if(s.texture){if(n.type=s.texture.exp.$typeinfo,!n.type.isTextureType())throw new Error("internal error");if(n.type.isStorageTexture()){let e;e=n.type.isArrayTexture()?n.type.isCubeTexture()?"cube-array":"2d-array":n.type.is3DTexture()?"3d":n.type.isCubeTexture()?"cube":n.type.is1DTexture()?"1d":"2d",n.storageTexture={access:"write-only",viewDimension:e,format:n.type.storageTexelFormat}}else if(n.type.isExternalTexture())n.externalTexture={autoBindSampler:s.texture.autoBindSampler?Ds(s.texture.exp.$str,!1):null};else{const e="webgpu"===this._device.type?s.texture.exp.$sampleType:s.texture.autoBindSampler&&n.type.isDepthTexture()?"float":s.texture.exp.$sampleType;let t;t=n.type.isArrayTexture()?n.type.isCubeTexture()?"cube-array":"2d-array":n.type.is3DTexture()?"3d":n.type.isCubeTexture()?"cube":n.type.is1DTexture()?"1d":"2d",n.texture={sampleType:e,viewDimension:t,multisampled:!1,autoBindSampler:null,autoBindSamplerComparison:null},"webgpu"!==this._device.type&&"sample"!==s.texture.autoBindSampler||(n.texture.autoBindSampler=Ds(s.texture.exp.$str,!1)),("webgpu"===this._device.type&&n.type.isDepthTexture()||"comparison"===s.texture.autoBindSampler)&&(n.texture.autoBindSamplerComparison=Ds(s.texture.exp.$str,!0))}n.name=s.texture.exp.$str}else{if(!s.sampler)throw new ys("invalid uniform entry type");if(n.type=s.sampler.$typeinfo,!n.type.isSamplerType())throw new Error("internal error");n.sampler={type:n.type.accessMode===te.SAMPLE?"float"===s.sampler.$sampleType?"filtering":"non-filtering":"comparison"},n.name=s.sampler.$str}i.entries.push(n)}for(let r=0;r<t.length;r++)t[r]||(t[r]={label:`${e||"unknown"}[${r}]`,entries:[]});return t}_getFunctionOverload(e,t){const r=t.filter(e=>{if(e instanceof Ni){const t=e.$ast.getType();if(t.isStructType()&&this._structInfo[this._shaderType]?.types.findIndex(e=>e.type.structName===t.structName)<0)return!1}return!0}),s=this.getGlobalScope().$getFunctions(e);return s?this._matchFunctionOverloading(s,r):null}_matchFunctionOverloading(e,t){for(const r of e){if(t.length!==r.funcType.argTypes.length)continue;const e=[];let s=!0;for(let i=0;i<t.length;i++){const n=r.funcType.argTypes[i],a=n.byRef&&n.type instanceof oe?n.type.pointerType:n.type,o=t[i];if("boolean"==typeof o){if(!a.isPrimitiveType()||a.primitiveType!==X.BOOL){s=!1;break}e.push(new ti(o,Se))}else if("number"==typeof o){if(!a.isPrimitiveType()||!a.isScalarType()||a.scalarType===X.BOOL){s=!1;break}if(a.scalarType===X.I32){if(!Number.isInteger(o)||o<-2147483648||o>2147483647){s=!1;break}e.push(new ti(o,Ee))}else if(a.scalarType===X.U32){if(!Number.isInteger(o)||o<0||o>4294967295){s=!1;break}e.push(new ti(o,ye))}else e.push(new ti(o,a))}else{if(!a.isCompatibleType(o.$ast.getType())){s=!1;break}e.push(o.$ast)}}if(s)return[r,e]}return null}$callFunction(e,t,r){if(this.getCurrentScope()===this.getGlobalScope())throw new xs(e);const s=new Ni("",r.returnType);return s.$ast=new di(e,t,r,Rs().getDevice().type),this.getCurrentScope().$ast.statements.push(s.$ast),s}$callFunctionNoCheck(e,t,r){if(this.getCurrentScope()===this.getGlobalScope())throw new xs(e);const s=new Ni("",r);return s.$ast=new di(e,t,null,Rs().getDevice().type,r),this.getCurrentScope().$ast.statements.push(s.$ast),s}}class Ji extends Ii{$_variables;$_parentScope;$_AST;$_localScope;constructor(e,t){super(),this.$_parentScope=t||null,this.$_variables={},this.$_AST=e,this.$_localScope=null}get $builder(){return Rs()}get $builtins(){return Rs().builtinScope}get $inputs(){return Rs().inputScope}get $outputs(){return Rs().outputScope}get $parent(){return this.$_parentScope}get $ast(){return this.$_AST}set $ast(e){this.$_AST=e}$getVertexAttrib(e){return this.$inputs.$getVertexAttrib(e)}get $l(){return this.$_getLocalScope()}get $g(){return this.$_getGlobalScope()}$local(e,t){const r=Rs().normalizeExpValue(t);e.$global=this instanceof nn,this.$_declare(e,r)}$touch(e){this.$ast.statements.push(new hi(e.$ast))}$query(e){return this.$builder.getReflection().tag(e)}$_declareInternal(e,t){const r=e.$str;if(this.$_variables[r])throw new Error(`cannot re-declare variable '${r}'`);if(!(e.$ast instanceof js))throw new Error(`invalid variable declaration: '${e.$ast.toString(Rs().getDevice().type)}'`);const s=e.$typeinfo;if(s.isPointerType()){if(!t)throw new Error(`cannot declare pointer type variable without initialization: '${e.$str}'`);if(!(t instanceof Ni))throw new Error(`invalid initialization for pointer type declaration: '${e.$str}`);const r=t.$ast.getType();if(!r.isPointerType()||!s.pointerType.isCompatibleType(r.pointerType))throw new Error(`incompatible pointer type assignment: '${e.$str}'`);e.$typeinfo=r}if(this.$_registerVar(e,r),null==t)return new Ei(e.$ast);if(t instanceof Ni&&t.$ast instanceof ei&&0===t.$ast.args.length){if(!t.$ast.getType().isCompatibleType(e.$ast.getType()))throw new cs(t,t.$ast.getType(),e.$ast.getType());return new Ei(e.$ast)}return new ci(new Js(e.$ast),t instanceof Ni?t.$ast:t)}$_findOrSetUniform(e){const t=e.$str,r={group:e.$group,binding:0,mask:0};e.$typeinfo.isTextureType()?r.texture={autoBindSampler:null,exp:e}:e.$typeinfo.isSamplerType()?r.sampler=e:r.block={name:t,bindingSize:e.$bindingSize,exp:e};let s=!1;for(const t of Rs()._uniforms)if(t.group===r.group){if(r.block&&t.block&&t.block.name===r.block.name&&t.block.exp.$typeinfo.isCompatibleType(r.block.exp.$typeinfo)){t.mask|=Rs().shaderType,e=t.block.exp,s=!0;break}if(r.texture&&t.texture&&r.texture.exp.$str===t.texture.exp.$str&&r.texture.exp.$typeinfo.isCompatibleType(t.texture.exp.$typeinfo)){t.mask|=Rs().shaderType,e=t.texture.exp,s=!0;break}if(r.sampler&&t.sampler&&r.sampler.$str===t.sampler.$str&&r.sampler.$typeinfo.isCompatibleType(t.sampler.$typeinfo)){t.mask|=Rs().shaderType,e=t.sampler,s=!0;break}}if(s||(r.mask=Rs().shaderType,Rs()._uniforms.push(r)),r.texture&&!r.texture.exp.$typeinfo.isStorageTexture()&&"webgpu"===Rs().getDevice().type){const t=e.$typeinfo.isTextureType()&&e.$typeinfo.isDepthTexture(),s=Ds(e.$str,!1),i=Rs().sampler(s).uniform(r.group).sampleType(e.$sampleType);if(i.$sampleType=e.$sampleType,this.$local(i),t){const t=Ds(e.$str,!0),s=Rs().samplerComparison(t).uniform(r.group).sampleType(e.$sampleType);this.$local(s)}}return e}$_declare(e,t){if(this.$_variables[e.$str])throw new gs(e.$ast,"cannot re-declare variable");if(e.$declareType===vs.DECLARE_TYPE_UNIFORM||e.$declareType===vs.DECLARE_TYPE_STORAGE){const t=e.$ast.name;if(!(this instanceof nn))throw new Error(`uniform or storage variables can only be declared within global scope: ${t}`);if(!(e.$declareType!==vs.DECLARE_TYPE_UNIFORM||e.$typeinfo.isTextureType()||e.$typeinfo.isSamplerType()||e.$typeinfo.isConstructible()&&e.$typeinfo.isHostSharable()))throw new gs(e.$ast,`type '${e.$typeinfo.toTypeName(Rs().getDevice().type)}' cannot be declared in uniform address space`);if(e.$declareType===vs.DECLARE_TYPE_STORAGE){if("webgpu"!==Rs().getDevice().type)throw new Ts("storage buffer binding");if(!e.$typeinfo.isHostSharable())throw new gs(e.$ast,`type '${e.$typeinfo.toTypeName(Rs().getDevice().type)}' cannot be declared in storage address space`)}e=this.$_findOrSetUniform(e);const r=this.$_declareInternal(e);r.group=e.$group,r.binding=0,r.blockName=Rs().getBlockName(t);const s=e.$typeinfo;(s.isStructType()&&e.$isBuffer||s.isTextureType()||s.isSamplerType()||s.isStructType()&&("std140"===s.detail.layout||"std430"===s.detail.layout))&&this.$ast.uniforms.push(r),e.$tags.forEach(t=>{Rs().tagShaderExp(()=>e,t)})}else{const r=this.$_declareInternal(e,t);this.$ast.statements.push(r)}}$_registerVar(e,t){const r=t||e.$str,s={configurable:!0,get:function(){return e},set:function(t){Rs().getCurrentScope().$ast.statements.push(new ci(new Zs(e.$ast),t instanceof Ni?t.$ast:t))}};Object.defineProperty(this,r,s),this.$_variables[r]=e}$localGet(e){if("string"==typeof e&&("$"===e[0]||e in this))return this[e]}$localSet(e,t){return("$"===e[0]||e in this)&&(this[e]=t,!0)}$get(e){const t=this.$localGet(e);return void 0===t&&this.$_parentScope?this.$_parentScope.$thisProxy.$get(e):t}$set(e,t){if("$"===e[0])return this[e]=t,!0;{let r=this;for(;r&&!(e in r);)r=r.$_parentScope;if(r)return r[e]=t,!0;if(this.$l)return this.$l[e]=t,!0}return!1}$_getLocalScope(){return this.$_localScope||(this.$_localScope=new en(this)),this.$_localScope}$_getGlobalScope(){return this.$builder.getGlobalScope()}}class en extends Ji{$_scope;constructor(e){super(null,null),this.$_scope=e}$get(e){return"$"===e[0]?this[e]:this.$_scope.$localGet(e)}$set(e,t){if("$"===e[0])return this[e]=t,!0;if(!(this.$_scope instanceof nn)&&t instanceof Ni&&(t.isConstructor()||t.$typeinfo.isTextureType()&&t.$ast instanceof js&&!t.$ast.name)&&(t.$declareType===vs.DECLARE_TYPE_UNIFORM||t.$declareType===vs.DECLARE_TYPE_STORAGE))return this.$g[e]=t,!0;if(void 0===this.$_scope.$localGet(e)){const r=Rs().guessExpValueType(t);if(r.isCompatibleType(Cr))throw new Error(`Cannot assign void type to '${e}'`);const s=new Ni(e,r);return t instanceof Ni&&!this.$_scope.$parent&&(s.$declareType=t.$declareType,s.$isBuffer=t.$isBuffer,s.$bindingSize=t.$bindingSize,s.$readonly=t.$readonly,s.$group=t.$group,s.$attrib=t.$attrib,s.$sampleType=t.$sampleType,s.$precision=t.$precision,s.tag(...t.$tags)),this.$_scope.$local(s,t),!0}return this.$_scope.$localSet(e,t)}$_getLocalScope(){return this}}class tn extends Ji{$_usedBuiltins;$_builtinVars;constructor(){super(null),this.$_usedBuiltins=new Set;if(!("webgpu"===Rs().getDevice().type)){this.$_builtinVars={};const e=Us[Rs().getDevice().type];for(const t in e){const r=e[t];this.$_builtinVars[t]=new Ni(r.name,r.type)}}const e=Us[Rs().getDevice().type],t=this;for(const r of Object.keys(e))Object.defineProperty(this,r,{get:function(){return t.$getBuiltinVar(r)},set:function(e){if("number"!=typeof e&&!(e instanceof Ni))throw new Error("Invalid output value assignment");const s=t.$getBuiltinVar(r);Rs().getCurrentScope().$ast.statements.push(new ci(new Zs(s.$ast),e instanceof Ni?e.$ast:e))}})}$_getLocalScope(){return null}$getBuiltinVar(e){const t=Rs();this.$_usedBuiltins.add(e);if("webgpu"===t.getDevice().type){const r=Us[t.getDevice().type][e],s=r.inOrOut;if("in"===s)return t.getCurrentFunctionScope()[Ls(t.shaderType)][r.name];const i="in"===s?Os(t.shaderType):Ms(t.shaderType),n=t.getCurrentScope();if(!n[i]||!n[i][r.name])throw new Error(`invalid use of builtin variable ${e}`);return n[i][r.name]}return"webgl2"!==t.getDevice().type||"vertexIndex"!==e&&"instanceIndex"!==e?this.$_builtinVars[e]:t.uint(this.$_builtinVars[e])}}class rn extends Ji{$_names;$_aliases;constructor(){super(null),this.$_names={},this.$_aliases={}}$getVertexAttrib(e){const t=this.$_names[e];return t?this[t]:null}$_getLocalScope(){return null}$get(e){if("$"===e[0])return this[e];this.$_aliases[e]&&(e=this.$_aliases[e]);const t=this.$builder;if("webgpu"===t.getDevice().type){const r=t.getCurrentFunctionScope()[Ls(t.shaderType)],s="vertex"===t.shaderKind?Zi:qi,i=`${s}${e}`;if(r.$typeinfo.structMembers.findIndex(e=>e.name===i)<0)return;return r[`${s}${e}`]}return super.$get(e)}$set(e,t){if("$"===e[0])this[e]=t;else{if(!(t instanceof Ni))throw new Error("invalid vertex input value");const r=Rs().shaderType;if(r!==M.Vertex)throw new Error(`shader input variables can only be declared in vertex shader: "${e}"`);const s=Kr(t.$attrib);if(void 0===s)throw new Error(`can not declare shader input variable: invalid vertex attribute: "${e}"`);if(Rs()._vertexAttributes.indexOf(s)>=0){const r=this.$_names[t.$attrib];if(e!==r){if(this[r].$typeinfo.typeId!==t.$typeinfo.typeId)throw new Error(`can not declare shader input variable: attribute already declared with different type: "${e}"`);this.$_aliases[e]=r}return!0}if(!(t instanceof Ni&&t.$ast instanceof ei))throw new Error(`invalid shader input variable declaration: "${e}"`);const i=t.$ast.getType();if(!i.isPrimitiveType()||i.isMatrixType()||i.primitiveType===X.BOOL)throw new Error(`type cannot be used as pipeline input/output: ${e}`);this.$_names[t.$attrib]=e;const n=Rs()._inputs.length,a=new Ni(`${Zi}${e}`,i).tag(...t.$tags);Rs().in(n,e,a),Rs()._vertexAttributes.push(s),"webgpu"===Rs().getDevice().type&&Rs().findStructType(Bs(r),r)&&Rs().defineBuiltinStruct(r,"in")}return!0}}class sn extends Ji{constructor(){super(null)}$_getLocalScope(){return null}$set(e,t){if("$"===e[0])this[e]=t;else{const r=Rs();if(!(e in this)){if(!(r.getCurrentScope()!==r.getGlobalScope()||t instanceof Ni&&t.$ast instanceof ei))throw new Error(`invalid shader output variable declaration: ${e}`);const s=t.$ast.getType();if(!s.isPrimitiveType()||s.isMatrixType()||s.primitiveType===X.BOOL)throw new Error(`type cannot be used as pipeline input/output: ${e}`);const i=r._outputs.length;if(r.out(i,e,new Ni(`${"vertex"===r.shaderKind?qi:"zFSOutput_"}${e}`,s).tag(...t.$tags)),"webgpu"===Rs().getDevice().type){const e=Rs().shaderType;Rs().findStructType(Bs(e),e)&&Rs().defineBuiltinStruct(e,"out")}}if(Rs().getCurrentScope()!==Rs().getGlobalScope()){const r=t.$ast;r instanceof ei&&!(r.args.length>0)||(this[e]=t)}}return!0}}class nn extends Ji{$_inputStructInfo;constructor(){super(new Ys),this.$_inputStructInfo=null}get $inputStructInfo(){return this.$_inputStructInfo||(this.$_inputStructInfo=this.$builder.defineBuiltinStruct(this.$builder.shaderType,"in")),this.$_inputStructInfo}get $inputStruct(){return this.$inputStructInfo[0]}$mainFunc(e){const t=Rs();if("webgpu"===t.getDevice().type){const r=this.$inputStructInfo,s=t.shaderType===M.Compute,i=s?null:t.defineBuiltinStruct(t.shaderType,"out");i&&this.$local(i[1]),this.$internalCreateFunction("main",r?[r[3]]:[],!0,function(){t.shaderType===M.Fragment&&t.emulateDepthClamp&&(this.$builtins.fragDepth=t.clamp(this.$inputs.clamppedDepth,0,1)),e?.call(this),t.shaderType===M.Vertex&&(t.depthRangeCorrection&&(this.$builtins.position.z=t.mul(t.add(this.$builtins.position.z,this.$builtins.position.w),.5)),t.emulateDepthClamp&&(this.$outputs.clamppedDepth=t.div(this.$builtins.position.z,this.$builtins.position.w),this.$builtins.position.z=0)),s||this.$return(i[1])})}else this.$internalCreateFunction("main",[],!0,function(){t.shaderType===M.Fragment&&t.emulateDepthClamp&&(this.$builtins.fragDepth=t.clamp(this.$inputs.clamppedDepth,0,1)),e?.call(this),t.shaderType===M.Vertex&&t.emulateDepthClamp&&(this.$outputs.clamppedDepth=t.div(t.add(t.div(this.$builtins.position.z,this.$builtins.position.w),1),2),this.$builtins.position.z=0)})}$createFunctionIfNotExists(e,t,r){this.$internalCreateFunction(e,t,!1,r)}$getFunctions(e){return this.$ast.findFunctions(e)}$getCurrentFunctionScope(){let e=Rs().getCurrentScope();for(;e&&!(e instanceof on);)e=e.$parent;return e}$internalCreateFunction(e,t,r,s){const i=Rs();"webgpu"!==i.getDevice().type||r||t.push(this.$inputStruct(Ls(i.shaderType))),t.forEach(t=>{if(!(t.$ast instanceof js))throw new Error(`${e}(): invalid function definition`);let r=t.$ast;t.$inout&&("webgpu"===Rs().getDevice().type&&(t.$typeinfo=new oe(t.$typeinfo,re.UNKNOWN)),r=new ni(t.$ast)),t.$ast=new ks(r)});const n=this.$getFunctions(e),a=this.$getCurrentFunctionScope(),o=new Ti(e,t.map(e=>e.$ast),r,null,!1);if(a){const e=this.$ast.statements.indexOf(a.$ast);if(e<0)throw new Error("Internal error");this.$ast.statements.splice(e,0,o)}else this.$ast.statements.push(o);new on(this,t,o,s),o.returnType||(o.returnType=Cr),o.funcType=new le(o.name,o.returnType,t.map(e=>{const t=e.$ast;return t.paramAST instanceof ni?{type:t.paramAST.value.getType(),byRef:t.paramAST instanceof ni}:{type:t.paramAST.getType(),byRef:!1}}));for(const t of n)if(t.funcType.argHash===o.funcType.argHash){if(t.returnType.isCompatibleType(o.returnType))return void this.$ast.statements.splice(this.$ast.statements.indexOf(o),1);throw new Error(`Invalid function overloading: ${e}`)}0===n.length&&Object.defineProperty(this,e,{get:function(){if(0===this.$getFunctions(e).length)throw new Error(`function ${e} not found`);return(...t)=>{let r=null;if("webgpu"===i.getDevice().type){let e=i.getCurrentScope();for(;e&&!(e instanceof on);)e=e.$parent;const t=e.$ast.args;r=e[t[t.length-1].paramAST.name]}const s=(r?[...t,r]:t).map(e=>i.normalizeExpValue(e)),n=i._getFunctionOverload(e,s);if(!n)throw new Error(`ERROR: no matching overloads for function ${e}(${s.map(e=>e instanceof Ni?e.$ast?.getType()?.toTypeName()??"?":typeof e).join(", ")})`);return Rs().$callFunction(e,n[1],n[0])}}})}}class an extends Ji{constructor(e){super(new zs,e)}$return(e){const t=this.findOwnerFunction().$ast;let r=null;const s=Rs().normalizeExpValue(e);if(null!=s)if("number"==typeof s){if(t.returnType&&t.returnType.isPrimitiveType()&&t.returnType.isScalarType()&&!t.returnType.isCompatibleType(Se)&&(r=t.returnType),!r)if(Number.isInteger(s))if(s<0){if(s<-2147483648)throw new Error(`function ${t.name}: invalid return value: ${s}`);r=Ee}else{if(s>4294967295)throw new Error(`function ${t.name}: invalid return value: ${s}`);r=s<=2147483647?Ee:ye}else r=ce}else r="boolean"==typeof s?Se:s.$ast.getType();else r=Cr;if(r.isPointerType())throw new Error("function can not return pointer type");if(t.returnType){if(!t.returnType.isCompatibleType(r))throw new Error(`function ${t.name}: return type must be ${t.returnType?.toTypeName(Rs().getDevice().type)||"void"}`)}else t.returnType=r;let i=null;if(null!=s)if(s instanceof Ni)i=s.$ast;else{if(!r.isPrimitiveType()||!r.isScalarType())throw new cs(s,typeof s,r);i=new ti(s,r)}this.$ast.statements.push(new mi(i))}$scope(e){const t=new Hs;return this.$ast.statements.push(t),new cn(this,t,e)}$if(e,t){const r=new xi("if",e instanceof Ni?e.$ast:new ti(e,"number"==typeof e?ce:Se));return this.$ast.statements.push(r),new _n(this,r,t)}$choice(e,t,r){const s=new li(e instanceof Ni?e.$ast:e,t instanceof Ni?t.$ast:t,r instanceof Ni?r.$ast:r),i=new Ni("",s.getType());return i.$ast=s,i}$break(){this.$ast.statements.push(new pi)}$continue(){this.$ast.statements.push(new fi)}$for(e,t,r,s,i,n){const a=e.$ast.getType();if(!a.isPrimitiveType()||!a.isScalarType())throw new gs(e.$ast,"invalid for range initializer type");const o=t instanceof Ni?t.$ast:new ti(t,a);"function"==typeof s?(n=s,s=!0,i=!1):"function"==typeof i?(n=i,s=!!s,i=!1):(s=!!s,i=!!i);const u=new gi(e.$ast,o,r instanceof Ni?r.$ast:new ti(r,a),s,i);this.$ast.statements.push(u),new ln(this,e,r,u,n)}$do(e){if("webgl"===this.$builder.getDevice().type)throw new Error("No do-while() loop support for WebGL1.0 device");const t=new yi(null);return this.$ast.statements.push(t),new hn(this,t,e)}$while(e,t){const r=new Ai(e instanceof Ni?e.$ast:new ti(e,"number"==typeof e?ce:Se));this.$ast.statements.push(r),new un(this,r,t)}findOwnerFunction(){for(let e=this;e;e=e.$parent)if(e instanceof on)return e;return null}$getMainScope(){for(let e=this;e;e=e.$parent)if(e instanceof on&&e.$isMain())return e;return null}}class on extends an{$typeinfo;constructor(e,t,r,s){super(e),this.$ast=r;for(const e of t){if(this.$_variables[e.$str])throw new Error("Duplicate function parameter name is not allowed");this.$_registerVar(e)}Rs().pushScope(this),s?.call(this),Rs().popScope()}$isMain(){return this.$ast.isMainFunc}}class un extends an{constructor(e,t,r){super(e),this.$ast=t,Rs().pushScope(this),r?.call(this),Rs().popScope()}}class hn extends an{constructor(e,t,r){super(e),this.$ast=t,Rs().pushScope(this),r?.call(this),Rs().popScope()}$while(e){this.$ast.condition=e instanceof Ni?e.$ast:new ti(e,"number"==typeof e?ce:Se)}}class ln extends an{constructor(e,t,r,s,i){super(e),this.$ast=s,this.$_registerVar(t),Rs().pushScope(this),i?.call(this),Rs().popScope()}}class cn extends an{constructor(e,t,r){super(e),this.$ast=t,Rs().pushScope(this),r?.call(this),Rs().popScope()}}class _n extends an{constructor(e,t,r){super(e),this.$ast=t,Rs().pushScope(this),r?.call(this),Rs().popScope()}$elseif(e,t){const r=new xi("else if",e instanceof Ni?e.$ast:new ti(e,"number"==typeof e?ce:Se));return this.$ast.nextElse=r,new _n(this.$_parentScope,r,t)}$else(e){const t=new xi("else",null);this.$ast.nextElse=t,new _n(this.$_parentScope,t,e)}}var pn;!function(e){for(const t of Object.keys(ki))e.prototype[t]=function(...e){return(ki?.[t]?.normalizeFunc||Mi)(this,t,...e)}}(Qi),pn=Qi,Object.keys(Yi).forEach(e=>{pn.prototype[e]=Ci(function(...t){return Hi.call(this,Yi[e],...t)},Yi[e])}),Object.keys(ji).forEach(e=>{pn.prototype[e]=function(t){return new Ni(t,ji[e])}}),Object.keys(Ki).forEach(e=>{pn.prototype[e]=function(e){const t={};for(const r of Object.keys(zi))t[r]=function(t){return new Ni(t,new he(e,zi[r]))};return t}(Ki[e])}),pn.prototype.atomic_int=Ci(function(...e){if(e.length>1)throw new _s("atomic_int");if(1===e.length){if("string"!=typeof e[0])throw new ps("atomic_int","name");return new Ni(e[0],me)}{const e=new Ni("",me);return e.$ast=new ei(e.$typeinfo,[]),e}},me),pn.prototype.atomic_uint=Ci(function(...e){if(e.length>1)throw new _s("atomic_uint");if(1===e.length&&"string"==typeof e[0])return new Ni(e[0],de);if(0===e.length){const e=new Ni("",de);return e.$ast=new ei(e.$typeinfo,[]),e}const t=e[0];if("number"==typeof t&&Number.isInteger(t)||t instanceof Ni&&t.$ast.getType().typeId===ye.typeId){const e=new Ni("",de);return e.$ast=new ei(e.$typeinfo,[t instanceof Ni?t.$ast:t]),e}return null},de);class fn{static _canvas=null;static _context=null;static get canvas(){return this._realize(),this._canvas}static get context(){return this._realize(),this._context}static get font(){return this.context.font}static set font(e){this.context.font=e}static _realize(){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=512,this._canvas.height=512,this._canvas.style.left="-10000px",this._canvas.style.position="absolute",this._context=this._canvas.getContext("2d",{willReadFrequently:!0}),this._context.textBaseline="top",this._context.textAlign="left",this._context.fillStyle="transparent",this._context.fillRect(0,0,this._canvas.width,this._canvas.height),this._context.fillStyle="#ffffff",this._context.imageSmoothingEnabled=!0,this._context.imageSmoothingQuality="high")}}class mn{static fontCache={};_name;_nameScaled;_scale;_size;_family;_top;_bottom;_topScaled;_bottomScaled;_div;constructor(e,t){this._top=0,this._bottom=0,this._size=0,this._topScaled=0,this._bottomScaled=0,this._family="",this._scale=t,this._name=e,this._nameScaled=null,this._div=document.createElement("div"),this._name&&this._normalizeFont()}static fetchFont(e,t){let r=this.fontCache[e];r||(r={},this.fontCache[e]=r);let s=r[t];return s||(s=new mn(e,t),r[t]=s),s}get fontName(){return this._name}set fontName(e){this._name=e,this._normalizeFont()}get fontNameScaled(){return this._nameScaled}get size(){return this._size}get family(){return this._family}get top(){return this._top}get bottom(){return this._bottom}get topScaled(){return this._topScaled}get bottomScaled(){return this._bottomScaled}get maxHeight(){return this._bottom-this._top+1}get maxHeightScaled(){return this._bottomScaled-this._topScaled+1}equalTo(e){return this._size===e._size&&this._family===e._family}_measureFontHeight(e){const t=fn.context.font,r=fn.context.textBaseline,s=fn.context.fillStyle;fn.context.font=e,this._div.style.font=fn.context.font;const i=this._div.style.fontSize,n=parseInt(i.substring(0,i.length-2)),a=this._div.style.fontFamily,o="bdfghijklpq|_~",u=fn.context.measureText(o);let h,l;h=0,l=n-1;const c=Math.ceil(u.width)+10,_=n+10;fn.context.clearRect(0,0,c,_),fn.context.textBaseline="top",fn.context.fillStyle="#ffffff",fn.context.fillText(o,5,5);const p=fn.context.getImageData(0,0,c,_).data;for(let e=0;e<c*_;e++)if(p[4*e+3]>0){h=Math.floor(e/c);break}for(let e=c*_-1;e>=0;e--)if(p[4*e+3]>0){l=Math.floor(e/c);break}return h-=5,l-=5,fn.context.font=t,fn.context.textBaseline=r,fn.context.fillStyle=s,{size:n,family:a,top:h,bottom:l}}_normalizeFont(){const e=this._measureFontHeight(this._name);this._nameScaled=`${Math.round(e.size*this._scale)}px ${e.family}`;const t=this._measureFontHeight(this._nameScaled);this._size=e.size,this._family=e.family,this._top=e.top,this._bottom=e.bottom,this._topScaled=t.top,this._bottomScaled=t.bottom}}class dn{static ATLAS_WIDTH=1024;static ATLAS_HEIGHT=1024;_packer;_device;_binWidth;_binHeight;_rectBorderWidth;_linearSpace;_atlasList;_atlasInfoMap;_atlasRestoreHandler;constructor(e,t,r,s,i){this._device=e,this._binWidth=t,this._binHeight=r,this._rectBorderWidth=s,this._linearSpace=!!i,this._packer=new f(this._binWidth,this._binHeight),this._atlasList=[],this._atlasInfoMap={},this._atlasRestoreHandler=null}get atlasTextureRestoreHandler(){return this._atlasRestoreHandler}set atlasTextureRestoreHandler(e){this._atlasRestoreHandler=e}getAtlasTexture(e){return this._atlasList[e]}getAtlasInfo(e){return this._atlasInfoMap[e]||null}isEmpty(){return 0===this._atlasList.length}clear(){this._packer.clear();for(const e of this._atlasList)e.dispose();this._atlasList=[],this._atlasInfoMap={}}pushCanvas(e,t,r,s,i,n){const a=this._packer.insert(i+2*this._rectBorderWidth,n+2*this._rectBorderWidth);if(a){const o=a.x+this._rectBorderWidth,u=a.y+this._rectBorderWidth;this._updateAtlasTextureCanvas(a.binIndex,t,o,u,i,n,r,s);const h={atlasIndex:a.binIndex,uMin:o/this._binWidth,vMin:u/this._binHeight,uMax:(o+i)/this._binWidth,vMax:(u+n)/this._binHeight,width:i,height:n};return this._atlasInfoMap[e]=h,h}return null}pushBitmap(e,t){const r=this._packer.insert(t.width+2*this._rectBorderWidth,t.height+2*this._rectBorderWidth);if(r){const s=r.x+this._rectBorderWidth,i=r.y+this._rectBorderWidth;this._updateAtlasTexture(r.binIndex,t,s,i);const n={atlasIndex:r.binIndex,uMin:s/this._binWidth,vMin:i/this._binHeight,uMax:(s+t.width)/this._binWidth,vMax:(i+t.height)/this._binHeight,width:t.width,height:t.height};return this._atlasInfoMap[e]=n,n}return null}_createAtlasTexture(){const e=this._device.createTexture2D("rgba8unorm",this._binWidth,this._binHeight,{mipmapping:!1});return e.update(new Uint8Array(e.width*e.height*4),0,0,e.width,e.height),e.restoreHandler=()=>{e.update(new Uint8Array(e.width*e.height*4),0,0,e.width,e.height),this._atlasRestoreHandler?.(e)},e}_updateAtlasTextureCanvas(e,t,r,s,i,n,a,o){let u=null;e===this._atlasList.length?(u=this._createAtlasTexture(),this._atlasList.push(u)):u=this._atlasList[e],u.updateFromElement(t.canvas,r,s,a,o,i,n)}_updateAtlasTexture(e,t,r,s){let i=null;if(e===this._atlasList.length?(i=this._createAtlasTexture(),this._atlasList.push(i)):i=this._atlasList[e],t instanceof ImageBitmap)i.updateFromElement(t,r,s,0,0,t.width,t.height);else{const e=new Uint8Array(t.data.buffer);i.update(e,r,s,t.width,t.height)}}}class En extends dn{constructor(e,t,r,s){super(e,t,r,s,!0),this.atlasTextureRestoreHandler=async()=>{this.isEmpty()||this.clear()}}getGlyphInfo(e,t){if(!e||!t)return null;let r=this.getAtlasInfo(this._hash(e,t));return r||(r=this._cacheGlyph(e,t),r.width=Math.round(r.width*(t.maxHeight/t.maxHeightScaled)),r.height=t.maxHeight),r}measureStringWidth(e,t,r){let s=0;for(const i of e)s+=t+this.getCharWidth(i,r);return s}clipStringToWidth(e,t,r,s,i){let n=0,a=s;for(;a<e.length&&(n+=r+this.getCharWidth(e[a],i),!(n>t));a++);return a-s}getCharWidth(e,t){if(!t)return 0;fn.font=t.fontNameScaled;const r=fn.context.measureText(e);let s=r.width;return 0===s?0:("number"==typeof r.actualBoundingBoxRight&&(s=Math.floor(Math.max(s,r.actualBoundingBoxRight)+.8)),s=Math.round(s*(t.maxHeight/t.maxHeightScaled)),s)}_getGlyphBitmap(e,t){if(!t)return null;fn.font=t.fontNameScaled;const r=fn.context.measureText(e);let s=r.width;if(0===s)return null;"number"==typeof r.actualBoundingBoxRight&&(s=Math.floor(Math.max(s,r.actualBoundingBoxRight)+.8));const i=t.maxHeightScaled;return fn.context.fillStyle="#fff",fn.context.clearRect(0,0,s+2,i),fn.context.fillText(e,0,-t.topScaled),fn.context.getImageData(0,0,s,i)}_hash(e,t){return`${t.family}@${t.size}&${e}`}_cacheGlyph(e,t){const r=this._getGlyphBitmap(e,t);return this.pushBitmap(this._hash(e,t),r)}}class Tn{static GLYPH_COUNT=1024;static glyphManager=null;static prepared=!1;static textVertexBuffer=null;static textVertexLayout=null;static textProgram=null;static textBindGroup=null;static textRenderStates=null;static textOffset=0;static textMatrix=new p;static font=null;static vertexCache=null;static colorValue=new l;static calculateTextMatrix(e,t){const r=e.getViewport(),s=p.ortho(0,r.width,0,r.height,1,100),i=p.translation(new h(0,r.height,0)).scaleRight(new h(1,-1,1));p.multiply(s,i,t)}static setFont(e,t){this.font=mn.fetchFont(t,e.getScale())||mn.fetchFont("12px arial",e.getScale())}static drawText(t,r,s,i,n){if(r.length>0){t.pushDeviceStates(),this.prepareDrawText(t),this.calculateTextMatrix(t,this.textMatrix);const a=function(t){t=t.trim().toLowerCase();let r=null;if("#"===(t=e[t]||t)[0]){const e=(t.length-1)/3,s=[17,1,.062272][e-1];r={r:parseInt(t.substring(1,1+e),16)*s/255,g:parseInt(t.substring(1+e,1+2*e),16)*s/255,b:parseInt(t.substring(1+2*e,1+3*e),16)*s/255,a:1}}else{let e;(e=t.match(/^\s*rgb\s*\(\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\s*,\s*(\d\.?\d*)\s*\)\s*$/i))?r={r:Number(e[1])/255,g:Number(e[2])/255,b:Number(e[3])/255,a:1}:(e=t.match(/^\s*rgba\s*\(\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\s*,\s*([\d*.?\d*]+)\s*,\s*(\d*\.?\d*)\s*\)\s*$/i))&&(r={r:Number(e[1])/255,g:Number(e[2])/255,b:Number(e[3])/255,a:Number(e[4])})}if(!r||Number.isNaN(r.r)||Number.isNaN(r.g)||Number.isNaN(r.b)||Number.isNaN(r.a))throw new Error(`parseColor(): invalid color '${t}'`);return r.r=Math.pow(Math.min(1,r.r),2.2),r.g=Math.pow(Math.min(1,r.g),2.2),r.b=Math.pow(Math.min(1,r.b),2.2),r.a=Math.min(1,r.a),r}(s);this.colorValue.x=a.r,this.colorValue.y=a.g,this.colorValue.z=a.b,this.colorValue.w=a.a,this.textBindGroup.setValue("flip","webgpu"===t.type&&t.getFramebuffer()?1:0),this.textBindGroup.setValue("srgbOut",t.getFramebuffer()?0:1),this.textBindGroup.setValue("textMatrix",this.textMatrix),this.textBindGroup.setValue("textColor",this.colorValue),t.setProgram(this.textProgram),t.setVertexLayout(this.textVertexLayout),t.setRenderStates(this.textRenderStates),t.setBindGroup(0,this.textBindGroup);let o=0;const u=r.length;for(;o<u;){const e=Math.min(u-o,this.GLYPH_COUNT-this.textOffset);e>0&&(i=this.drawTextNoOverflow(t,r,o,e,i,n),o+=e,this.textOffset+=e),this.GLYPH_COUNT===this.textOffset&&(this.textOffset=0,t.flush())}t.popDeviceStates()}}static drawTextNoOverflow(e,t,r,s,i,n){let a=0,o=-1,u=0;for(;u<s;u++){const s=this.glyphManager.getGlyphInfo(t[u+r],this.font)||this.glyphManager.getGlyphInfo("?",this.font);o>=0&&s.atlasIndex!==o&&(this.textVertexBuffer.bufferSubData(16*(this.textOffset+a)*4,this.vertexCache,16*(this.textOffset+a),16*(u-a)),this.textBindGroup.setTexture("tex",this.glyphManager.getAtlasTexture(o)),e.draw("triangle-list",6*(this.textOffset+a),6*(u-a)),a=u),o=s.atlasIndex;const h=16*(this.textOffset+u);this.vertexCache[h+0]=i,this.vertexCache[h+1]=n,this.vertexCache[h+2]=s.uMin,this.vertexCache[h+3]=s.vMin,this.vertexCache[h+4]=i+s.width,this.vertexCache[h+5]=n,this.vertexCache[h+6]=s.uMax,this.vertexCache[h+7]=s.vMin,this.vertexCache[h+8]=i+s.width,this.vertexCache[h+9]=n+s.height,this.vertexCache[h+10]=s.uMax,this.vertexCache[h+11]=s.vMax,this.vertexCache[h+12]=i,this.vertexCache[h+13]=n+s.height,this.vertexCache[h+14]=s.uMin,this.vertexCache[h+15]=s.vMax,i+=s.width}return this.textVertexBuffer.bufferSubData(16*(this.textOffset+a)*4,this.vertexCache,16*(this.textOffset+a),16*(u-a)),this.textBindGroup.setTexture("tex",this.glyphManager.getAtlasTexture(o)),e.draw("triangle-list",6*(this.textOffset+a),6*(u-a)),i}static prepareDrawText(e){if(!this.prepared){this.prepared=!0,this.font=this.font||mn.fetchFont("16px arial",e.getScale()),this.glyphManager=new En(e,1024,1024,1),this.vertexCache=new Float32Array(16*this.GLYPH_COUNT),this.textVertexBuffer=e.createInterleavedVertexBuffer(["position_f32x2","tex0_f32x2"],this.vertexCache,{dynamic:!0});const t=new Uint16Array(6*this.GLYPH_COUNT);for(let e=0;e<this.GLYPH_COUNT;e++){const r=4*e;t[6*e+0]=r+0,t[6*e+1]=r+1,t[6*e+2]=r+2,t[6*e+3]=r+0,t[6*e+4]=r+2,t[6*e+5]=r+3}const r=e.createIndexBuffer(t);this.textVertexLayout=e.createVertexLayout({vertexBuffers:[{buffer:this.textVertexBuffer}],indexBuffer:r}),this.textOffset=0,this.textProgram=e.buildRenderProgram({vertex(e){this.$inputs.pos=e.vec2().attrib("position"),this.$inputs.uv=e.vec2().attrib("texCoord0"),this.$outputs.uv=e.vec2(),this.flip=e.int(0).uniform(0),this.textMatrix=e.mat4().uniform(0),e.main(function(){this.$builtins.position=e.mul(this.textMatrix,e.vec4(this.$inputs.pos,-50,1)),this.$if(e.notEqual(this.flip,0),function(){this.$builtins.position.y=e.neg(this.$builtins.position.y)}),this.$outputs.uv=this.$inputs.uv})},fragment(e){this.$outputs.color=e.vec4(),this.textColor=e.vec4().uniform(0),this.tex=e.tex2D().uniform(0),this.srgbOut=e.int().uniform(0),e.main(function(){this.alpha=e.mul(e.textureSample(this.tex,this.$inputs.uv).a,this.textColor.a),this.$if(e.notEqual(this.srgbOut,0),function(){this.$outputs.color=e.vec4(e.mul(e.pow(this.textColor.rgb,e.vec3(1/2.2)),this.alpha),this.alpha)}).$else(function(){this.$outputs.color=e.vec4(e.mul(this.textColor.rgb,this.alpha),this.alpha)})})}}),this.textProgram.name="@DrawText",this.textBindGroup=e.createBindGroup(this.textProgram.bindGroupLayouts[0]),this.textRenderStates=e.createRenderStateSet(),this.textRenderStates.useBlendingState().enable(!0).setBlendFuncRGB("one","inv-src-alpha").setBlendFuncAlpha("zero","one"),this.textRenderStates.useDepthState().enableTest(!1).enableWrite(!1),this.textRenderStates.useRasterizerState().setCullMode("none")}}}class xn extends r{_canvas;_canvasClientWidth;_canvasClientHeight;_gpuObjectList;_gpuMemCost;_disposeObjectList;_beginFrameTime;_endFrameTime;_frameInfo;_cpuTimer;_gpuTimer;_runningLoop;_fpsCounter;_runLoopFunc;_backend;_beginFrameCounter;_programBuilder;_poolMap;_defaultPoolKey;_temporalFramebuffer;_vSync;_stateStack;constructor(e,t){super(),this._backend=t,this._gpuObjectList={textures:[],samplers:[],buffers:[],programs:[],framebuffers:[],vertexArrayObjects:[],bindGroups:[]},this._canvas=e,this._canvas.setAttribute("tabindex","1"),this._canvasClientWidth=e.clientWidth,this._canvasClientHeight=e.clientHeight,this._gpuMemCost=0,this._disposeObjectList=[],this._beginFrameTime=0,this._endFrameTime=0,this._runLoopFunc=null,this._frameInfo={frameCounter:0,frameTimestamp:0,elapsedTimeCPU:0,elapsedTimeGPU:0,elapsedFrame:0,elapsedOverall:0,FPS:0,drawCalls:0,computeCalls:0,nextFrameCall:[],nextFrameCallNext:[]},this._programBuilder=new Qi(this),this._cpuTimer=new is,this._gpuTimer=null,this._runningLoop=null,this._fpsCounter={time:0,frame:0},this._stateStack=[],this._beginFrameCounter=0,this._poolMap=new Map,this._defaultPoolKey=Symbol("defaultPool"),this._poolMap.set(this._defaultPoolKey,new ns(this,this._defaultPoolKey)),this._temporalFramebuffer=!1,this._temporalFramebuffer=!1,this._vSync=!0,this._registerEventHandlers()}get backend(){return this._backend}get videoMemoryUsage(){return this._gpuMemCost}get frameInfo(){return this._frameInfo}get isRendering(){return null!==this._runningLoop}get canvas(){return this._canvas}get type(){return this._backend.typeName()}get vSync(){return this._vSync}set vSync(e){this._vSync=!!e}get pool(){return this._poolMap.get(this._defaultPoolKey)}get runLoopFunction(){return this._runLoopFunc}get programBuilder(){return this._programBuilder}poolExists(e){return this._poolMap.has(e)}getPool(e){let t=this._poolMap.get(e);return t||(t=new ns(this,e),this._poolMap.set(e,t)),t}setFont(e){Tn.setFont(this,e)}drawText(e,t,r,s){Tn.drawText(this,e,s,t,r)}setFramebuffer(e,t,r){let s=null,i=!1;Array.isArray(e)?(s=this.pool.fetchTemporalFramebuffer(!1,0,0,e,t,!0,r),i=!0):s=e??null;const n=this.getFramebuffer();n!==s&&(this._temporalFramebuffer&&this.pool.releaseFrameBuffer(n),this._temporalFramebuffer=i,this._setFramebuffer(s))}disposeObject(e,t=!0){e&&(t&&this.removeGPUObject(e),this.isContextLost()?e.destroy():this._disposeObjectList.push(e))}restoreObject(e){e&&e.disposed&&!this.isContextLost()&&(e.restore(),e.restoreHandler?.(e))}enableGPUTimeRecording(e){e&&!this._gpuTimer?this._gpuTimer=this.createGPUTimer():e||(this._gpuTimer?.end(),this._gpuTimer=null)}beginFrame(){if(0===this._beginFrameCounter){for(const e of this._disposeObjectList)e.destroy();this._disposeObjectList=[]}return this._beginFrameCounter++,this._beginFrameTime=this._cpuTimer.now(),this.updateFrameInfo(),this._poolMap.forEach(e=>e.autoRelease()),this.onBeginFrame()}endFrame(){this._beginFrameCounter>0&&(this._beginFrameCounter--,0===this._beginFrameCounter&&(this._endFrameTime=this._cpuTimer.now(),this._frameInfo.frameCounter++,this.onEndFrame()))}getVertexAttribFormat(e,t,r){return function(e,t,r){const s=Kr(e);for(const e in zr){const i=zr[e];if(i[0]===s&&i[3]===t&&i[4]===r)return e}return null}(e,t,r)}createInterleavedVertexBuffer(e,t,r){if(r&&r.usage&&"vertex"!==r.usage)return console.error("createInterleavedVertexBuffer() failed: options.usage must be 'vertex' or not set"),null;let s=0;for(const t of e)s+=qr(t);const i=es(t.byteLength/s|0,...e),n=Object.assign({usage:"vertex",dynamic:!1,managed:!0,storage:!1},r||{});return n.storage&&(n.dynamic=!1,n.managed=!1),n.dynamic&&(n.managed=!1),this.createStructuredBuffer(i,n,t)}createVertexBuffer(e,t,r){if(r&&r.usage&&"vertex"!==r.usage)return console.error("createVertexBuffer() failed: options.usage must be 'vertex' or not set"),null;const s=qr(e),i=es(t.byteLength/s|0,e),n=Object.assign({usage:"vertex",dynamic:!1,managed:!0,storage:!1},r||{});return n.storage&&(n.dynamic=!1,n.managed=!1),n.dynamic&&(n.managed=!1),this.createStructuredBuffer(i,n,t)}draw(e,t,r){this._frameInfo.drawCalls++,this._draw(e,t,r)}drawInstanced(e,t,r,s){this._frameInfo.drawCalls++,this._drawInstanced(e,t,r,s)}executeRenderBundle(e){this._frameInfo.drawCalls+=this._executeRenderBundle(e)}compute(e,t,r){this._frameInfo.computeCalls++,this._compute(e,t,r)}runNextFrame(e){e&&this._frameInfo.nextFrameCall.push(e)}async runNextFrameAsync(e){return new Promise(t=>{e?this._frameInfo.nextFrameCall.push(()=>{const r=e();r instanceof Promise?r.then(()=>t()):t()}):t()})}exitLoop(){null!==this._runningLoop&&(0!==this._runningLoop?cancelAnimationFrame(this._runningLoop):this.cancelNextFrame(this._runningLoop),this._runningLoop=null)}runLoop(e){if(null!==this._runningLoop)return void console.error("Device.runLoop() can not be nested");if(!e)return void console.error("Device.runLoop() argment error");const t=this;t._runLoopFunc=e,function e(){t._vSync?t._runningLoop=requestAnimationFrame(e):t._runningLoop=t.nextFrame(()=>{null!==t._runningLoop&&e()}),t.beginFrame()&&(t._runLoopFunc(t),t.endFrame())}()}pushDeviceStates(){this._stateStack.push({windowOrderReversed:this.isWindingOrderReversed(),framebuffer:this.getFramebuffer(),viewport:this.getViewport(),scissor:this.getScissor(),program:this.getProgram(),renderStateSet:this.getRenderStates(),vertexLayout:this.getVertexLayout(),bindGroups:[this.getBindGroup(0),this.getBindGroup(1),this.getBindGroup(2),this.getBindGroup(3)]})}popDeviceStates(){if(0===this._stateStack.length)console.error("Device.popDeviceStates(): stack is empty");else{const e=this._stateStack.pop();this.setFramebuffer(e.framebuffer),this.setViewport(e.viewport),this.setScissor(e.scissor),this.setProgram(e.program),this.setRenderStates(e.renderStateSet),this.setVertexLayout(e.vertexLayout),this.setBindGroup(0,...e.bindGroups[0]),this.setBindGroup(1,...e.bindGroups[1]),this.setBindGroup(2,...e.bindGroups[2]),this.setBindGroup(3,...e.bindGroups[3]),this.reverseVertexWindingOrder(e.windowOrderReversed)}}getGPUObjects(){return this._gpuObjectList}getGPUObjectById(e){for(const t of[this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.buffers,this._gpuObjectList.framebuffers,this._gpuObjectList.programs,this._gpuObjectList.vertexArrayObjects])for(const r of t)if(r.uid===e)return r;return null}screenToDevice(e){return this.getFramebuffer()?e:Math.round(e*this.getScale())}deviceToScreen(e){return this.getFramebuffer()?e:Math.round(e/this.getScale())}buildRenderProgram(e){return this._programBuilder.buildRenderProgram(e)}buildComputeProgram(e){return this._programBuilder.buildComputeProgram(e)}addGPUObject(e){const t=this.getGPUObjectList(e);t&&t.indexOf(e)<0&&(t.push(e),this.dispatchEvent("gpuobject_added",e))}removeGPUObject(e){const t=this.getGPUObjectList(e);if(t){const r=t.indexOf(e);r>=0&&(t.splice(r,1),this.dispatchEvent("gpuobject_removed",e))}}updateVideoMemoryCost(e){this._gpuMemCost+=e}_onresize(){this._canvasClientWidth===this._canvas.clientWidth&&this._canvasClientHeight===this._canvas.clientHeight||(this._canvasClientWidth=this._canvas.clientWidth,this._canvasClientHeight=this._canvas.clientHeight,this.dispatchEvent("resize",this._canvasClientWidth,this._canvasClientHeight))}_registerEventHandlers(){const e=this._canvas,t=this;window.ResizeObserver?new window.ResizeObserver(()=>{t._onresize()}).observe(e,{}):(window.MutationObserver&&new MutationObserver(function(e){e.length>0&&t._onresize()}).observe(e,{attributes:!0,attributeFilter:["style"]}),window.addEventListener("resize",()=>{this._onresize()}))}updateFrameInfo(){this._frameInfo.drawCalls=0,this._frameInfo.computeCalls=0;const e=this._beginFrameTime;if(0===this._frameInfo.frameTimestamp)this._frameInfo.frameTimestamp=e,this._frameInfo.elapsedTimeCPU=0,this._frameInfo.elapsedTimeGPU=0,this._frameInfo.elapsedFrame=0,this._frameInfo.elapsedOverall=0,this._frameInfo.FPS=0,this._fpsCounter.time=e,this._fpsCounter.frame=this._frameInfo.frameCounter,this._gpuTimer&&this._gpuTimer.begin();else{this._frameInfo.elapsedFrame=e-this._frameInfo.frameTimestamp,this._frameInfo.elapsedOverall+=this._frameInfo.elapsedFrame;let t=0,r=0;0!==this._endFrameTime&&(t=e-this._endFrameTime,r=this._endFrameTime-this._frameInfo.frameTimestamp),this._frameInfo.frameTimestamp=e,e>=this._fpsCounter.time+1e3&&(this._frameInfo.FPS=1e3*(this._frameInfo.frameCounter-this._fpsCounter.frame)/(e-this._fpsCounter.time),this._fpsCounter.time=e,this._fpsCounter.frame=this._frameInfo.frameCounter,this._frameInfo.elapsedTimeGPU=t,this._frameInfo.elapsedTimeCPU=r)}const t=this._frameInfo.nextFrameCall;this._frameInfo.nextFrameCall=this._frameInfo.nextFrameCallNext,this._frameInfo.nextFrameCallNext=t;for(const e of this._frameInfo.nextFrameCallNext)e();this._frameInfo.nextFrameCallNext.length=0}getGPUObjectList(e){let t=null;return e.isTexture()?t=this._gpuObjectList.textures:e.isSampler()?t=this._gpuObjectList.samplers:e.isBuffer()?t=this._gpuObjectList.buffers:e.isFramebuffer()?t=this._gpuObjectList.framebuffers:e.isProgram()?t=this._gpuObjectList.programs:e.isVertexLayout()?t=this._gpuObjectList.vertexArrayObjects:e.isBindGroup()&&(t=this._gpuObjectList.bindGroups),t}invalidateAll(){for(const e of[this._gpuObjectList.buffers,this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.programs,this._gpuObjectList.framebuffers,this._gpuObjectList.vertexArrayObjects,this._gpuObjectList.bindGroups])for(const t of e)this.disposeObject(t,!1);if(this.isContextLost()){for(const e of this._disposeObjectList)e.destroy();this._disposeObjectList=[]}}reloadAll(){for(const e of[this._gpuObjectList.buffers,this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.programs,this._gpuObjectList.framebuffers,this._gpuObjectList.vertexArrayObjects,this._gpuObjectList.bindGroups])for(const t of e.slice())t.reload()}parseTextureOptions(e){const t=!1===e?.mipmapping?jr.TF_NO_MIPMAP:0,r=e?.writable?jr.TF_WRITABLE:0,s=e?.dynamic?jr.DYNAMIC:0;return t&&e?.samplerOptions&&(e.samplerOptions.mipFilter="none"),t|r|s}parseBufferOptions(e,t){let r;switch(e?.usage||t){case"uniform":r=jr.BF_UNIFORM,e.managed=!1,e.dynamic=e.dynamic??!0;break;case"vertex":r=jr.BF_VERTEX;break;case"index":r=jr.BF_INDEX;break;case"read":r=jr.BF_READ,e.managed=!1;break;case"write":r=jr.BF_WRITE,e.managed=!1;break;case"pack-pixel":r=jr.BF_PACK_PIXEL,e.managed=!1;break;case"unpack-pixel":r=jr.BF_UNPACK_PIXEL,e.managed=!1;break;default:r=0}const s=e?.storage?jr.BF_STORAGE:0,i=e?.dynamic?jr.DYNAMIC:0;return r|s|i|(0===i&&(e?.managed??1)?jr.MANAGED:0)}}class gn{_cache;_buffer;_size;_uniformMap;_uniformPositions;constructor(e,t){if(this._size=e.byteSize+15&-16,this._size<=0)throw new Error(`UniformBuffer(): invalid uniform buffer byte size: ${this._size}`);this._uniformMap={},this._uniformPositions={},this._cache=t instanceof ArrayBuffer?t:null,this._buffer=t instanceof ArrayBuffer?null:t,this.init(e,0,"")}get byteLength(){return this._size}get buffer(){return this._cache}get uniforms(){return this._uniformMap}set(e,t){if(void 0!==t){const r=this._uniformMap[e];if(r)if(this._cache)if("number"==typeof t)r[0]=t;else if(t?._v)r.set(t._v);else{if("number"!=typeof t?.length)throw new Error("invalid uniform value");r.set(t.length>r.length?t.subarray(0,r.length):t)}else{const s=this._uniformPositions[e][1];if("number"==typeof t)r[0]=t,this._buffer.bufferSubData(this._uniformPositions[e][0],r);else{if(!(t.BYTES_PER_ELEMENT&&s<=t.byteLength))throw new Error("invalid uniform value");{const r=t;this._buffer.bufferSubData(this._uniformPositions[e][0],r,0,s/r.BYTES_PER_ELEMENT|0)}}}else{if(Object.getPrototypeOf(t)!==Object.getPrototypeOf({}))throw new Error("invalid uniform value");this.setStruct(e,t)}}}setStruct(e,t){for(const r in t)this.set(`${e}.${r}`,t[r])}init(e,t,r){for(const s of e.entries)if(s.subLayout)t=this.init(s.subLayout,t,`${r}${s.name}.`);else{const e=`${r}${s.name}`;if(this._uniformPositions[e])throw new Error(`UniformBuffer(): duplicate uniform name: ${e}`);if(s.offset<t||s.byteSize<0)throw new Error("UniformBuffer(): invalid layout");this._uniformPositions[e]=[s.offset,s.byteSize];let i=null;switch(s.type){case X.F32:i=Float32Array;break;case X.U32:case X.BOOL:i=Uint32Array;break;case X.I32:i=Int32Array;break;case X.U16:case X.U16_NORM:case X.F16:i=Uint16Array;break;case X.I16:case X.I16_NORM:i=Int16Array;break;case X.U8:case X.U8_NORM:i=Uint8Array;break;case X.I8:case X.I8_NORM:i=Int8Array}if(!i)throw new Error(`UniformBuffer(): invalid data type for uniform: ${e}`);if(s.byteSize%i.BYTES_PER_ELEMENT)throw new Error(`UniformBuffer(): invalid byte size for uniform: ${e}`);this._cache?this._uniformMap[e]=new i(this._cache,s.offset,s.byteSize/i.BYTES_PER_ELEMENT):this._uniformMap[e]=new i(1),t=s.offset+s.byteSize}return t}}var yn=function(e){return e[e.READ_BUFFER=3074]="READ_BUFFER",e[e.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",e[e.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",e[e.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",e[e.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",e[e.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",e[e.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",e[e.COLOR=6144]="COLOR",e[e.DEPTH=6145]="DEPTH",e[e.STENCIL=6146]="STENCIL",e[e.RED=6403]="RED",e[e.RGB8=32849]="RGB8",e[e.RGBA8=32856]="RGBA8",e[e.RGB10_A2=32857]="RGB10_A2",e[e.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",e[e.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",e[e.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",e[e.TEXTURE_3D=32879]="TEXTURE_3D",e[e.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",e[e.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",e[e.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",e[e.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",e[e.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",e[e.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",e[e.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",e[e.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",e[e.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",e[e.MIN=32775]="MIN",e[e.MAX=32776]="MAX",e[e.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",e[e.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",e[e.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",e[e.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",e[e.CURRENT_QUERY=34917]="CURRENT_QUERY",e[e.QUERY_RESULT=34918]="QUERY_RESULT",e[e.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",e[e.STREAM_READ=35041]="STREAM_READ",e[e.STREAM_COPY=35042]="STREAM_COPY",e[e.STATIC_READ=35045]="STATIC_READ",e[e.STATIC_COPY=35046]="STATIC_COPY",e[e.DYNAMIC_READ=35049]="DYNAMIC_READ",e[e.DYNAMIC_COPY=35050]="DYNAMIC_COPY",e[e.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",e[e.DRAW_BUFFER0=34853]="DRAW_BUFFER0",e[e.DRAW_BUFFER1=34854]="DRAW_BUFFER1",e[e.DRAW_BUFFER2=34855]="DRAW_BUFFER2",e[e.DRAW_BUFFER3=34856]="DRAW_BUFFER3",e[e.DRAW_BUFFER4=34857]="DRAW_BUFFER4",e[e.DRAW_BUFFER5=34858]="DRAW_BUFFER5",e[e.DRAW_BUFFER6=34859]="DRAW_BUFFER6",e[e.DRAW_BUFFER7=34860]="DRAW_BUFFER7",e[e.DRAW_BUFFER8=34861]="DRAW_BUFFER8",e[e.DRAW_BUFFER9=34862]="DRAW_BUFFER9",e[e.DRAW_BUFFER10=34863]="DRAW_BUFFER10",e[e.DRAW_BUFFER11=34864]="DRAW_BUFFER11",e[e.DRAW_BUFFER12=34865]="DRAW_BUFFER12",e[e.DRAW_BUFFER13=34866]="DRAW_BUFFER13",e[e.DRAW_BUFFER14=34867]="DRAW_BUFFER14",e[e.DRAW_BUFFER15=34868]="DRAW_BUFFER15",e[e.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",e[e.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",e[e.SAMPLER_3D=35679]="SAMPLER_3D",e[e.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",e[e.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",e[e.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",e[e.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",e[e.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",e[e.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",e[e.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",e[e.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",e[e.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",e[e.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",e[e.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",e[e.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",e[e.SRGB=35904]="SRGB",e[e.SRGB8=35905]="SRGB8",e[e.SRGB_ALPHA=35906]="SRGB_ALPHA",e[e.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",e[e.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",e[e.RGBA32F=34836]="RGBA32F",e[e.RGB32F=34837]="RGB32F",e[e.RGBA16F=34842]="RGBA16F",e[e.RGB16F=34843]="RGB16F",e[e.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",e[e.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",e[e.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",e[e.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",e[e.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",e[e.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",e[e.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",e[e.R11F_G11F_B10F=35898]="R11F_G11F_B10F",e[e.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",e[e.RGB9_E5=35901]="RGB9_E5",e[e.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",e[e.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",e[e.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",e[e.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",e[e.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",e[e.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",e[e.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",e[e.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",e[e.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",e[e.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",e[e.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",e[e.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",e[e.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",e[e.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",e[e.RGBA32UI=36208]="RGBA32UI",e[e.RGB32UI=36209]="RGB32UI",e[e.RGBA16UI=36214]="RGBA16UI",e[e.RGB16UI=36215]="RGB16UI",e[e.RGBA8UI=36220]="RGBA8UI",e[e.RGB8UI=36221]="RGB8UI",e[e.RGBA32I=36226]="RGBA32I",e[e.RGB32I=36227]="RGB32I",e[e.RGBA16I=36232]="RGBA16I",e[e.RGB16I=36233]="RGB16I",e[e.RGBA8I=36238]="RGBA8I",e[e.RGB8I=36239]="RGB8I",e[e.RED_INTEGER=36244]="RED_INTEGER",e[e.RGB_INTEGER=36248]="RGB_INTEGER",e[e.RGBA_INTEGER=36249]="RGBA_INTEGER",e[e.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",e[e.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",e[e.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",e[e.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",e[e.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",e[e.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",e[e.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",e[e.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",e[e.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",e[e.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",e[e.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",e[e.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",e[e.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",e[e.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",e[e.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",e[e.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",e[e.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",e[e.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",e[e.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",e[e.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",e[e.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",e[e.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",e[e.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",e[e.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",e[e.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",e[e.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",e[e.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",e[e.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",e[e.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",e[e.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",e[e.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",e[e.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",e[e.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",e[e.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",e[e.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",e[e.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",e[e.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",e[e.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",e[e.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",e[e.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",e[e.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",e[e.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",e[e.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",e[e.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",e[e.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",e[e.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",e[e.MAX_SAMPLES=36183]="MAX_SAMPLES",e[e.HALF_FLOAT=36193]="HALF_FLOAT",e[e.RG=33319]="RG",e[e.RG_INTEGER=33320]="RG_INTEGER",e[e.R8=33321]="R8",e[e.RG8=33323]="RG8",e[e.R16F=33325]="R16F",e[e.R32F=33326]="R32F",e[e.RG16F=33327]="RG16F",e[e.RG32F=33328]="RG32F",e[e.R8I=33329]="R8I",e[e.R8UI=33330]="R8UI",e[e.R16I=33331]="R16I",e[e.R16UI=33332]="R16UI",e[e.R32I=33333]="R32I",e[e.R32UI=33334]="R32UI",e[e.RG8I=33335]="RG8I",e[e.RG8UI=33336]="RG8UI",e[e.RG16I=33337]="RG16I",e[e.RG16UI=33338]="RG16UI",e[e.RG32I=33339]="RG32I",e[e.RG32UI=33340]="RG32UI",e[e.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",e[e.R8_SNORM=36756]="R8_SNORM",e[e.RG8_SNORM=36757]="RG8_SNORM",e[e.RGB8_SNORM=36758]="RGB8_SNORM",e[e.RGBA8_SNORM=36759]="RGBA8_SNORM",e[e.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",e[e.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",e[e.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",e[e.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",e[e.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",e[e.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",e[e.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",e[e.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",e[e.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",e[e.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",e[e.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",e[e.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",e[e.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",e[e.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",e[e.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",e[e.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",e[e.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",e[e.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",e[e.UNIFORM_TYPE=35383]="UNIFORM_TYPE",e[e.UNIFORM_SIZE=35384]="UNIFORM_SIZE",e[e.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",e[e.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",e[e.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",e[e.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",e[e.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",e[e.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",e[e.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",e[e.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",e[e.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",e[e.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",e[e.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",e[e.INVALID_INDEX=4294967295]="INVALID_INDEX",e[e.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",e[e.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",e[e.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",e[e.OBJECT_TYPE=37138]="OBJECT_TYPE",e[e.SYNC_CONDITION=37139]="SYNC_CONDITION",e[e.SYNC_STATUS=37140]="SYNC_STATUS",e[e.SYNC_FLAGS=37141]="SYNC_FLAGS",e[e.SYNC_FENCE=37142]="SYNC_FENCE",e[e.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",e[e.UNSIGNALED=37144]="UNSIGNALED",e[e.SIGNALED=37145]="SIGNALED",e[e.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",e[e.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",e[e.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",e[e.WAIT_FAILED=37149]="WAIT_FAILED",e[e.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",e[e.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",e[e.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",e[e.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",e[e.SAMPLER_BINDING=35097]="SAMPLER_BINDING",e[e.RGB10_A2UI=36975]="RGB10_A2UI",e[e.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",e[e.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",e[e.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",e[e.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",e[e.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",e[e.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",e[e.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",e[e.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",e[e.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",e[e.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",e[e.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",e[e.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN",e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",e[e.FUNC_ADD=32774]="FUNC_ADD",e[e.FUNC_MIN=32775]="FUNC_MIN",e[e.FUNC_MAX=32776]="FUNC_MAX",e[e.BLEND_EQUATION=32777]="BLEND_EQUATION",e[e.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",e[e.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",e[e.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",e[e.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",e[e.BLEND_DST_RGB=32968]="BLEND_DST_RGB",e[e.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",e[e.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",e[e.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",e[e.CONSTANT_COLOR=32769]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",e[e.BLEND_COLOR=32773]="BLEND_COLOR",e[e.ARRAY_BUFFER=34962]="ARRAY_BUFFER",e[e.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",e[e.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",e[e.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",e[e.STREAM_DRAW=35040]="STREAM_DRAW",e[e.STATIC_DRAW=35044]="STATIC_DRAW",e[e.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",e[e.BUFFER_SIZE=34660]="BUFFER_SIZE",e[e.BUFFER_USAGE=34661]="BUFFER_USAGE",e[e.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK",e[e.TEXTURE_2D=3553]="TEXTURE_2D",e[e.CULL_FACE=2884]="CULL_FACE",e[e.BLEND=3042]="BLEND",e[e.DITHER=3024]="DITHER",e[e.STENCIL_TEST=2960]="STENCIL_TEST",e[e.DEPTH_TEST=2929]="DEPTH_TEST",e[e.SCISSOR_TEST=3089]="SCISSOR_TEST",e[e.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",e[e.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",e[e.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",e[e.NO_ERROR=0]="NO_ERROR",e[e.INVALID_ENUM=1280]="INVALID_ENUM",e[e.INVALID_VALUE=1281]="INVALID_VALUE",e[e.INVALID_OPERATION=1282]="INVALID_OPERATION",e[e.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",e[e.CW=2304]="CW",e[e.CCW=2305]="CCW",e[e.LINE_WIDTH=2849]="LINE_WIDTH",e[e.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",e[e.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",e[e.CULL_FACE_MODE=2885]="CULL_FACE_MODE",e[e.FRONT_FACE=2886]="FRONT_FACE",e[e.DEPTH_RANGE=2928]="DEPTH_RANGE",e[e.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",e[e.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",e[e.DEPTH_FUNC=2932]="DEPTH_FUNC",e[e.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",e[e.STENCIL_FUNC=2962]="STENCIL_FUNC",e[e.STENCIL_FAIL=2964]="STENCIL_FAIL",e[e.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",e[e.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",e[e.STENCIL_REF=2967]="STENCIL_REF",e[e.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",e[e.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",e[e.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",e[e.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",e[e.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",e[e.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",e[e.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",e[e.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",e[e.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",e[e.VIEWPORT=2978]="VIEWPORT",e[e.SCISSOR_BOX=3088]="SCISSOR_BOX",e[e.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",e[e.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",e[e.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",e[e.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",e[e.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",e[e.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",e[e.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",e[e.RED_BITS=3410]="RED_BITS",e[e.GREEN_BITS=3411]="GREEN_BITS",e[e.BLUE_BITS=3412]="BLUE_BITS",e[e.ALPHA_BITS=3413]="ALPHA_BITS",e[e.DEPTH_BITS=3414]="DEPTH_BITS",e[e.STENCIL_BITS=3415]="STENCIL_BITS",e[e.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",e[e.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",e[e.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",e[e.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",e[e.SAMPLES=32937]="SAMPLES",e[e.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",e[e.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",e[e.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",e[e.DONT_CARE=4352]="DONT_CARE",e[e.FASTEST=4353]="FASTEST",e[e.NICEST=4354]="NICEST",e[e.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",e[e.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",e[e.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",e[e.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",e[e.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",e[e.VERTEX_SHADER=35633]="VERTEX_SHADER",e[e.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",e[e.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",e[e.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",e[e.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",e[e.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",e[e.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",e[e.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",e[e.SHADER_TYPE=35663]="SHADER_TYPE",e[e.DELETE_STATUS=35712]="DELETE_STATUS",e[e.LINK_STATUS=35714]="LINK_STATUS",e[e.VALIDATE_STATUS=35715]="VALIDATE_STATUS",e[e.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",e[e.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",e[e.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",e[e.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",e[e.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",e[e.NEVER=512]="NEVER",e[e.LESS=513]="LESS",e[e.EQUAL=514]="EQUAL",e[e.LEQUAL=515]="LEQUAL",e[e.GREATER=516]="GREATER",e[e.NOTEQUAL=517]="NOTEQUAL",e[e.GEQUAL=518]="GEQUAL",e[e.ALWAYS=519]="ALWAYS",e[e.KEEP=7680]="KEEP",e[e.REPLACE=7681]="REPLACE",e[e.INCR=7682]="INCR",e[e.DECR=7683]="DECR",e[e.INVERT=5386]="INVERT",e[e.INCR_WRAP=34055]="INCR_WRAP",e[e.DECR_WRAP=34056]="DECR_WRAP",e[e.VENDOR=7936]="VENDOR",e[e.RENDERER=7937]="RENDERER",e[e.VERSION=7938]="VERSION",e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",e[e.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",e[e.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",e[e.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",e[e.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",e[e.TEXTURE=5890]="TEXTURE",e[e.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",e[e.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",e[e.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",e[e.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",e[e.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",e[e.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",e[e.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",e[e.TEXTURE0=33984]="TEXTURE0",e[e.TEXTURE1=33985]="TEXTURE1",e[e.TEXTURE2=33986]="TEXTURE2",e[e.TEXTURE3=33987]="TEXTURE3",e[e.TEXTURE4=33988]="TEXTURE4",e[e.TEXTURE5=33989]="TEXTURE5",e[e.TEXTURE6=33990]="TEXTURE6",e[e.TEXTURE7=33991]="TEXTURE7",e[e.TEXTURE8=33992]="TEXTURE8",e[e.TEXTURE9=33993]="TEXTURE9",e[e.TEXTURE10=33994]="TEXTURE10",e[e.TEXTURE11=33995]="TEXTURE11",e[e.TEXTURE12=33996]="TEXTURE12",e[e.TEXTURE13=33997]="TEXTURE13",e[e.TEXTURE14=33998]="TEXTURE14",e[e.TEXTURE15=33999]="TEXTURE15",e[e.TEXTURE16=34e3]="TEXTURE16",e[e.TEXTURE17=34001]="TEXTURE17",e[e.TEXTURE18=34002]="TEXTURE18",e[e.TEXTURE19=34003]="TEXTURE19",e[e.TEXTURE20=34004]="TEXTURE20",e[e.TEXTURE21=34005]="TEXTURE21",e[e.TEXTURE22=34006]="TEXTURE22",e[e.TEXTURE23=34007]="TEXTURE23",e[e.TEXTURE24=34008]="TEXTURE24",e[e.TEXTURE25=34009]="TEXTURE25",e[e.TEXTURE26=34010]="TEXTURE26",e[e.TEXTURE27=34011]="TEXTURE27",e[e.TEXTURE28=34012]="TEXTURE28",e[e.TEXTURE29=34013]="TEXTURE29",e[e.TEXTURE30=34014]="TEXTURE30",e[e.TEXTURE31=34015]="TEXTURE31",e[e.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",e[e.REPEAT=10497]="REPEAT",e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D",e[e.SAMPLER_CUBE=35680]="SAMPLER_CUBE",e[e.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",e[e.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",e[e.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",e[e.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",e[e.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",e[e.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",e[e.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",e[e.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",e[e.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",e[e.COMPILE_STATUS=35713]="COMPILE_STATUS",e[e.LOW_FLOAT=36336]="LOW_FLOAT",e[e.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",e[e.HIGH_FLOAT=36338]="HIGH_FLOAT",e[e.LOW_INT=36339]="LOW_INT",e[e.MEDIUM_INT=36340]="MEDIUM_INT",e[e.HIGH_INT=36341]="HIGH_INT",e[e.FRAMEBUFFER=36160]="FRAMEBUFFER",e[e.RENDERBUFFER=36161]="RENDERBUFFER",e[e.RGBA4=32854]="RGBA4",e[e.RGB5_A1=32855]="RGB5_A1",e[e.RGB565=36194]="RGB565",e[e.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",e[e.STENCIL_INDEX8=36168]="STENCIL_INDEX8",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e[e.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",e[e.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",e[e.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",e[e.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",e[e.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",e[e.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",e[e.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",e[e.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",e[e.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",e[e.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",e[e.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",e[e.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",e[e.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",e[e.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",e[e.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",e[e.NONE=0]="NONE",e[e.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",e[e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",e[e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",e[e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",e[e.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",e[e.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",e[e.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",e[e.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",e[e.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",e[e.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",e[e.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",e[e.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",e[e.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",e[e.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",e[e.TEXTURE_MAX_ANISOTROPY=34046]="TEXTURE_MAX_ANISOTROPY",e[e.MAX_TEXTURE_MAX_ANISOTROPY=34047]="MAX_TEXTURE_MAX_ANISOTROPY",e}({});function An(e){return!(!e||!e.texStorage2D)}class bn extends Error{static errorToString={[yn.NO_ERROR]:"NO_ERROR",[yn.INVALID_ENUM]:"INVALID_ENUM",[yn.INVALID_VALUE]:"INVALID_VALUE",[yn.INVALID_OPERATION]:"INVALID_OPERATION",[yn.INVALID_FRAMEBUFFER_OPERATION]:"INVALID_FRAMEBUFFER_OPERATION",[yn.OUT_OF_MEMORY]:"OUT_OF_MEMORY",[yn.CONTEXT_LOST_WEBGL]:"CONTEXT_LOST_WEBGL"};code;constructor(e){super(bn.errorToString[e]),this.code=e}}const Rn={add:yn.FUNC_ADD,subtract:yn.FUNC_SUBTRACT,"reverse-subtract":yn.FUNC_REVERSE_SUBTRACT,max:yn.FUNC_MAX,min:yn.FUNC_MIN},Sn={[yn.FUNC_ADD]:"add",[yn.FUNC_SUBTRACT]:"subtract",[yn.FUNC_REVERSE_SUBTRACT]:"reverse-subtract",[yn.FUNC_MAX]:"max",[yn.FUNC_MIN]:"min"},Cn={zero:yn.ZERO,one:yn.ONE,"src-alpha":yn.SRC_ALPHA,"inv-src-alpha":yn.ONE_MINUS_SRC_ALPHA,"src-alpha-saturate":yn.BLEND,"dst-alpha":yn.DST_ALPHA,"inv-dst-alpha":yn.ONE_MINUS_DST_ALPHA,"src-color":yn.SRC_COLOR,"inv-src-color":yn.ONE_MINUS_SRC_COLOR,"dst-color":yn.DST_COLOR,"inv-dst-color":yn.ONE_MINUS_DST_COLOR,"const-color":yn.CONSTANT_COLOR,"inv-const-color":yn.ONE_MINUS_CONSTANT_COLOR,"const-alpha":yn.CONSTANT_ALPHA,"inv-const-alpha":yn.ONE_MINUS_CONSTANT_ALPHA},In={[yn.ZERO]:"zero",[yn.ONE]:"one",[yn.SRC_ALPHA]:"src-alpha",[yn.ONE_MINUS_SRC_ALPHA]:"inv-src-alpha",[yn.SRC_ALPHA_SATURATE]:"src-alpha-saturate",[yn.DST_ALPHA]:"dst-alpha",[yn.ONE_MINUS_DST_ALPHA]:"inv-dst-alpha",[yn.SRC_COLOR]:"src-color",[yn.ONE_MINUS_SRC_COLOR]:"inv-src-color",[yn.DST_COLOR]:"dst-color",[yn.ONE_MINUS_DST_COLOR]:"inv-dst-color",[yn.CONSTANT_COLOR]:"const-color",[yn.ONE_MINUS_CONSTANT_COLOR]:"inv-const-color",[yn.CONSTANT_ALPHA]:"const-alpha",[yn.ONE_MINUS_CONSTANT_ALPHA]:"inv-const-alpha"},Fn={none:yn.NONE,front:yn.FRONT,back:yn.BACK},Nn={[yn.NONE]:"none",[yn.FRONT]:"front",[yn.BACK]:"back"};yn.CW,yn.CCW,yn.CW,yn.CCW;const vn={keep:yn.KEEP,zero:yn.ZERO,replace:yn.REPLACE,incr:yn.INCR,"incr-wrap":yn.INCR_WRAP,decr:yn.DECR,"decr-wrap":yn.DECR_WRAP,invert:yn.INVERT},wn={[yn.KEEP]:"keep",[yn.ZERO]:"zero",[yn.REPLACE]:"replace",[yn.INCR]:"incr",[yn.INCR_WRAP]:"incr-wrap",[yn.DECR]:"decr",[yn.DECR_WRAP]:"decr-wrap",[yn.INVERT]:"invert"},Ln={always:yn.ALWAYS,le:yn.LEQUAL,ge:yn.GEQUAL,lt:yn.LESS,gt:yn.GREATER,eq:yn.EQUAL,ne:yn.NOTEQUAL,never:yn.NEVER},On={[yn.NONE]:null,[yn.ALWAYS]:"always",[yn.LEQUAL]:"le",[yn.GEQUAL]:"ge",[yn.LESS]:"lt",[yn.GREATER]:"gt",[yn.EQUAL]:"eq",[yn.NOTEQUAL]:"ne",[yn.NEVER]:"never"},Mn={repeat:yn.REPEAT,"mirrored-repeat":yn.MIRRORED_REPEAT,clamp:yn.CLAMP_TO_EDGE},Bn={[X.BOOL]:yn.BOOL,[X.BVEC2]:yn.BOOL_VEC2,[X.BVEC3]:yn.BOOL_VEC3,[X.BVEC4]:yn.BOOL_VEC4,[X.F32]:yn.FLOAT,[X.F32VEC2]:yn.FLOAT_VEC2,[X.F32VEC3]:yn.FLOAT_VEC3,[X.F32VEC4]:yn.FLOAT_VEC4,[X.I8]:yn.BYTE,[X.I16]:yn.SHORT,[X.I32]:yn.INT,[X.I32VEC2]:yn.INT_VEC2,[X.I32VEC3]:yn.INT_VEC3,[X.I32VEC4]:yn.INT_VEC4,[X.U8]:yn.UNSIGNED_BYTE,[X.U8_NORM]:yn.UNSIGNED_BYTE,[X.I8_NORM]:yn.BYTE,[X.U16]:yn.UNSIGNED_SHORT,[X.U16_NORM]:yn.UNSIGNED_SHORT,[X.I16_NORM]:yn.SHORT,[X.U32]:yn.UNSIGNED_INT,[X.U32VEC2]:yn.UNSIGNED_INT_VEC2,[X.U32VEC3]:yn.UNSIGNED_INT_VEC3,[X.U32VEC4]:yn.UNSIGNED_INT_VEC4},Dn={"triangle-list":yn.TRIANGLES,"triangle-strip":yn.TRIANGLE_STRIP,"triangle-fan":yn.TRIANGLE_FAN,"line-list":yn.LINES,"line-strip":yn.LINE_STRIP,"point-list":yn.POINTS},Un={"2d":yn.TEXTURE_2D,"3d":yn.TEXTURE_3D,cube:yn.TEXTURE_CUBE_MAP,"2darray":yn.TEXTURE_2D_ARRAY},$n={[i.PX]:yn.TEXTURE_CUBE_MAP_POSITIVE_X,[i.NX]:yn.TEXTURE_CUBE_MAP_NEGATIVE_X,[i.PY]:yn.TEXTURE_CUBE_MAP_POSITIVE_Y,[i.NY]:yn.TEXTURE_CUBE_MAP_NEGATIVE_Y,[i.PZ]:yn.TEXTURE_CUBE_MAP_POSITIVE_Z,[i.NZ]:yn.TEXTURE_CUBE_MAP_NEGATIVE_Z};function Gn(e){switch(e){case"nearest":return yn.NEAREST;case"linear":return yn.LINEAR;default:return yn.NONE}}function Pn(e,t){switch(e){case"nearest":switch(t){case"none":return yn.NEAREST;case"nearest":return yn.NEAREST_MIPMAP_NEAREST;case"linear":return yn.NEAREST_MIPMAP_LINEAR}break;case"linear":switch(t){case"none":return yn.LINEAR;case"nearest":return yn.LINEAR_MIPMAP_NEAREST;case"linear":return yn.LINEAR_MIPMAP_LINEAR}}return yn.NONE}let Vn=0;class Xn extends d{_device;_object;_uid;_cid;_name;_restoreHandler;constructor(e){var t;super(),this._device=e,this._object=null,this._uid=++Vn,this._cid=1,this._name=(t=this).isTexture2D()?"texture_2d":t.isTexture2DArray()?"texture_2darray":t.isTexture3D()?"texture_3d":t.isTextureCube()?"texture_cube":t.isTextureVideo()?"texture_video":t.isBuffer()?"buffer":t.isFramebuffer()?"framebuffer":t.isProgram()?"program":t.isSampler()?"sampler":t.isVertexLayout()?"vbo":"unknown",this._restoreHandler=null,this._device.addGPUObject(this)}get device(){return this._device}get object(){return this._object}get restoreHandler(){return this._restoreHandler}set restoreHandler(e){this._restoreHandler=e}get uid(){return this._uid}get cid(){return this._cid}get name(){return this._name}set name(e){if(e!==this._name){const t=this._name;this._name=e,this._device.dispatchEvent("gpuobject_rename",this,t)}}isVertexLayout(){return!1}isFramebuffer(){return!1}isSampler(){return!1}isTexture(){return!1}isTexture2D(){return!1}isTexture2DArray(){return!1}isTexture3D(){return!1}isTextureCube(){return!1}isTextureVideo(){return!1}isProgram(){return!1}isBuffer(){return!1}isBindGroup(){return!1}reload(){this.disposed&&(this._device.restoreObject(this),this._cid++)}destroy(){throw new Error("Abstract function call: destroy()")}restore(){throw new Error("Abstract function call: restore()")}onDispose(){super.onDispose(),this._device.disposeObject(this,!0)}}class Wn extends Xn{_target;_memCost;_flags;_width;_height;_depth;_format;_mipLevelCount;_samplerOptions;_webgl1fallback;_readFrameBuffers;constructor(e,t){super(e),this._target=t||"2d",this._memCost=0,this._flags=0,this._width=0,this._height=0,this._depth=1,this._format="unknown",this._mipLevelCount=0,this._samplerOptions=null,this._webgl1fallback=!1,this._readFrameBuffers=[]}get target(){return this._target}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get memCost(){return this._memCost}get format(){return this._format}get mipLevelCount(){return this._mipLevelCount}get samplerOptions(){return this._samplerOptions}set samplerOptions(e){const t=this.getTextureCaps().getTextureFormatInfo(this._format);this._samplerOptions=e?Object.assign({},this._getSamplerOptions(t,!!e.compare),e):null}get isWebGL1Fallback(){return this._webgl1fallback}isFilterable(){return!!this.getTextureCaps().getTextureFormatInfo(this._format)?.filterable&&!!(this.device.isWebGL2||s(this._width)||s(this._height))}destroy(){if(this._object){this._device.context.deleteTexture(this._object),this._device.invalidateBindingTextures(),this._object=null,this._device.updateVideoMemoryCost(-this._memCost);for(const e of this._readFrameBuffers)if(e)for(const t of e)t&&t.dispose();this._readFrameBuffers=[],this._memCost=0}}restore(){this._object||this._device.isContextLost()||this.init()}isTexture(){return!0}getTextureCaps(){return this._device.getDeviceCaps().textureCaps}isSRGBFormat(){return e=this._format,!!(512&C[e]);var e}isFloatFormat(){return N(this._format)}isIntegerFormat(){return v(this._format)}isSignedFormat(){return w(this._format)}isCompressedFormat(){return L(this._format)}isDepth(){return F(this._format)}getDefaultSampler(e){const t=this.getTextureCaps().getTextureFormatInfo(this._format);return this._device.createSampler(this._samplerOptions&&!this._samplerOptions.compare==!e?this._samplerOptions:this._getSamplerOptions(t,e))}_getFramebufferForRead(e,t){let r=this._readFrameBuffers[e];r||(r=[],this._readFrameBuffers[e]=r);let s=r[t];return s||(s=this._device.createFrameBuffer([this],null),this.isTextureCube()?s.setColorAttachmentCubeFace(0,e):(this.isTexture2DArray()||this.isTexture3D())&&s.setColorAttachmentLayer(0,e),s.setColorAttachmentMipLevel(0,t),s.setColorAttachmentGenerateMipmaps(0,!1),r[t]=s),s}allocInternal(e,t,r,i,n){if(this._device.isWebGL2||s(t)&&s(r)?this._webgl1fallback=!1:(n=1,this._webgl1fallback=!0),this._device.setCurrentSamplerForTexture(this,null),0===n)n=this._calcMipLevelCount(e,t,r,i);else if(1!==n){let e=Math.max(t,r);this.isTexture3D()&&(e=Math.max(e,i));const s=Math.floor(Math.log2(e))+1;(!Number.isInteger(n)||n<0||n>s)&&(n=s)}if(this._object&&(this._format!==e||this._width!==t||this._height!==r||this._depth,this._mipLevelCount!==n)){const e=this._object;this._device.runNextFrame(()=>{this._device.context.deleteTexture(e),this._device.invalidateBindingTextures()}),this._object=null}if(!this._object&&(this._format=e,this._width=t,this._height=r,this._depth=i,this._mipLevelCount=n,!this._device.isContextLost())){this._object=this._device.context.createTexture();const e=this._device.context;this._device.bindTexture(Un[this._target],0,this);const t=this.getTextureCaps().getTextureFormatInfo(this._format);if(An(e)&&!this.isTextureVideo())this.isTexture3D()||this.isTexture2DArray()?e.texStorage3D(Un[this._target],this._mipLevelCount,t.glInternalFormat,this._width,this._height,this._depth):e.texStorage2D(Un[this._target],this._mipLevelCount,t.glInternalFormat,this._width,this._height),this._device.context.texParameteri(Un[this._target],yn.TEXTURE_BASE_LEVEL,0),this._device.context.texParameteri(Un[this._target],yn.TEXTURE_MAX_LEVEL,this._mipLevelCount-1);else{let e=this._width,r=this._height;const s=L(this._format),i=function(e){return(983040&C[e])>>16}(this._format),a=function(e){return(15728640&C[e])>>20}(this._format),o=O(this._format);for(let u=0;u<n;u++){const n=s?new Uint8Array(Math.ceil(e/i)*Math.ceil(r/a)*o):null;if(n?.fill(255),this.isTextureCube())for(let i=0;i<6;i++){const a=$n[i];s?this._device.context.compressedTexImage2D(a,u,t.glInternalFormat,e,r,0,n):this._device.context.texImage2D(a,u,t.glInternalFormat,e,r,0,t.glFormat,t.glType[0],null)}else s?this._device.context.compressedTexImage2D(Un[this._target],u,t.glInternalFormat,e,r,0,n):this._device.context.texImage2D(Un[this._target],u,t.glInternalFormat,e,r,0,t.glFormat,t.glType[0],null);e=Math.max(e>>1,1),r=Math.max(r>>1,1)}}const r=this.isTextureCube()?6:1,s=this.getTextureCaps().calcMemoryUsage(this._format,t.glType[0],this._width*this._height*this._depth*r);this._device.updateVideoMemoryCost(s-this._memCost),this._memCost=s}}_calcMipLevelCount(e,t,r,i){if(F(e)||this.isTextureVideo())return 1;if(this._flags&jr.TF_NO_MIPMAP)return 1;if(!(this._device.isWebGL2||s(t)&&s(r)))return 1;const n=this.getTextureCaps().getTextureFormatInfo(e);if(!n||!n.renderable)return 1;let a=Math.max(t,r);return this.isTexture3D()&&(a=Math.max(a,i)),Math.floor(Math.log2(a))+1}_getSamplerOptions(e,t){const r=this.isDepth()&&t,s=e.filterable||r;return{addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:s?"linear":"nearest",minFilter:s?"linear":"nearest",mipFilter:this._mipLevelCount>1?s?"linear":"nearest":"none",compare:r?"le":null}}}class kn extends Wn{constructor(e){super(e,"2d")}isTexture2D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._mipLevelCount)}update(e,t,r,s,i){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const n=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(Un[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texSubImage2D(Un[this._target],0,t,r,s,i,n.glFormat,n.glType[0],e),this._mipLevelCount>1&&this.generateMipmaps()}updateFromElement(e,t,r,s,i,n,a){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format);if(this._device.bindTexture(Un[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===s&&0===i&&n===e.width&&a===e.height)this._device.context.texSubImage2D(Un[this._target],0,t,r,o.glFormat,o.glType[0],e);else{const u=document.createElement("canvas");u.width=n,u.height=a;u.getContext("2d").drawImage(e,s,i,n,a,0,0,n,a),this._device.context.texSubImage2D(Un[this._target],0,t,r,o.glFormat,o.glType[0],u),u.width=0,u.height=0}this._mipLevelCount>1&&this.generateMipmaps()}async readPixels(e,t,r,s,i,n,a){if(0!==i)throw new Error("Texture2D.readPixels(): parameter 'faceOrLayer' must be 0");if(n>=this.mipLevelCount||n<0)throw new Error(`Texture2D.readPixels(): invalid miplevel: ${n}`);if(!this.device.isContextLost()&&!this.disposed){const i=this._getFramebufferForRead(0,n);this._device.pushDeviceStates(),this._device.setFramebuffer(i);const o=this._device.readPixels(0,e,t,r,s,a);return this._device.popDeviceStates(),o}}readPixelsToBuffer(e,t,r,s,i,n,a){if(0!==i)throw new Error("Texture2D.readPixelsToBuffer(): parameter 'faceOrLayer' must be 0");if(n>=this.mipLevelCount||n<0)throw new Error(`Texture2D.readPixelsToBuffer(): invalid miplevel: ${n}`);if(!this.device.isContextLost()&&!this.disposed){const i=this._device.createFrameBuffer([this],null);i.setColorAttachmentMipLevel(0,n),i.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(i),this._device.readPixelsToBuffer(0,e,t,r,s,a),this._device.popDeviceStates(),i.dispose()}}loadFromElement(e,t,r){if(this._flags=Number(r)||0,this._flags&jr.TF_WRITABLE)console.error(new Error("webgl device does not support storage texture"));else{const r=t?"rgba8unorm-srgb":"rgba8unorm";this.loadImage(e,r)}}createEmpty(e,t,r,s){this._flags=Number(s)||0,this._flags&jr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(e,t,r,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const e=Un[this._target];this._device.bindTexture(e,0,this),this._device.context.generateMipmap(e)}}createWithMipmapData(e,t,r){e.isCubemap||e.isVolume?console.error("loading 2d texture with mipmap data failed: data is not 2d texture"):(this._flags=Number(r)||0,this._flags&jr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadLevels(e,t))}loadEmpty(e,t,r,s){this.allocInternal(e,t,r,1,s),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(e,t){let r=t?I(e.format):e.format,s=!1;"bgra8unorm"===r?(r="rgba8unorm",s=!0):"bgra8unorm-srgb"===r&&(r="rgba8unorm-srgb",s=!0);const i=e.width,n=e.height,a=e.mipLevels;if(!e.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(r,i,n,1,a),!this._device.isContextLost()){const t=this.getTextureCaps().getTextureFormatInfo(this._format),r=Un[this._target];this._device.bindTexture(r,0,this),this.device.clearErrors();for(let i=0;i<this._mipLevelCount;i++){if(e.isCompressed)this._device.context.compressedTexSubImage2D(r,i,0,0,e.mipDatas[0][i].width,e.mipDatas[0][i].height,t.glInternalFormat,e.mipDatas[0][i].data);else{if(s)for(let t=0;t<e.mipDatas[0][i].width*e.mipDatas[0][i].height;t++){const r=e.mipDatas[0][i].data[4*t];e.mipDatas[0][i].data[4*t]=e.mipDatas[0][i].data[4*t+2],e.mipDatas[0][i].data[4*t+2]=r}this._device.context.texSubImage2D(r,i,0,0,e.mipDatas[0][i].width,e.mipDatas[0][i].height,t.glFormat,t.glType[0],e.mipDatas[0][i].data)}const n=this.device.getError();if(n)return void console.error(n)}}}else console.warn("No s3tc compression format support")}loadImage(e,t){if(this.allocInternal(t,Number(e.width),Number(e.height),1,0),!this._device.isContextLost()){const t=this.getTextureCaps().getTextureFormatInfo(this._format);this.device.clearErrors();const r=Un[this._target];this._device.bindTexture(r,0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,4),this._device.context.texSubImage2D(r,0,0,0,t.glFormat,t.glType[0],e),this._mipLevelCount>1&&this.generateMipmaps()}}}class zn extends Wn{constructor(e){if(!e.isWebGL2)throw new Error("device does not support 2d texture array");super(e,"2darray")}isTexture2DArray(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(e,t,r,s,i,n,a){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format),u=this._device.context;this._device.bindTexture(Un[this._target],0,this),u.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),u.texSubImage3D(Un[this._target],0,t,r,s,i,n,a,o.glFormat,o.glType[0],e),this._mipLevelCount>1&&this.generateMipmaps()}createWithMipmapData(e,t){e.arraySize?(this._flags=Number(t)||0,this._flags&jr.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(e)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}loadLevels(e){const t=e.format,r=e.width,s=e.height,i=1!==e.mipLevels||this._flags&jr.TF_NO_MIPMAP?e.mipLevels:this._calcMipLevelCount(e.format,r,s,1);if(!e.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(t,r,s,e.arraySize,i),!this._device.isContextLost()){const t=this.getTextureCaps().getTextureFormatInfo(this._format),r=this._device.context;this._device.bindTexture(Un[this._target],0,this),this.device.clearErrors();for(let s=0;s<e.arraySize;s++){if(e.mipDatas[s].length!==e.mipLevels)return void console.error("Texture2DArray.loadLevels() failed: Invalid texture data");for(let i=0;i<e.mipLevels;i++){e.isCompressed?r.compressedTexSubImage3D(r.TEXTURE_2D_ARRAY,i,0,0,s,e.mipDatas[s][i].width,e.mipDatas[s][i].height,1,t.glInternalFormat,e.mipDatas[s][i].data):r.texSubImage3D(r.TEXTURE_2D_ARRAY,i,0,0,s,e.mipDatas[s][i].width,e.mipDatas[s][i].height,1,t.glFormat,t.glType[0],e.mipDatas[s][i].data);const n=this.device.getError();if(n)return void console.error(n)}}e.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture2DArray.loadLevels(): No s3tc compression format support")}updateFromElement(e,t,r,s,i,n,a,o){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const u=this.getTextureCaps().getTextureFormatInfo(this._format),h=this._device.context;if(this._device.bindTexture(Un[this._target],0,this),h.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===i&&0===n&&a===e.width&&o===e.height)h.texSubImage3D(Un[this._target],0,t,r,s,a,o,1,u.glFormat,u.glType[0],e);else{const l=document.createElement("canvas");l.width=a,l.height=o;l.getContext("2d").drawImage(e,i,n,a,o,0,0,a,o),h.texSubImage3D(Un[this._target],0,t,r,s,a,o,1,u.glFormat,u.glType[0],l),l.width=0,l.height=0}this._mipLevelCount>1&&this.generateMipmaps()}createEmpty(e,t,r,s,i){this._flags=Number(i)||0,this._flags&jr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(e,t,r,s,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const e=Un[this._target];this._device.bindTexture(e,0,this),this._device.context.generateMipmap(e)}}async readPixels(e,t,r,s,i,n,a){if(i<0||i>=this._depth)throw new Error(`Texture2DArray.readPixels(): invalid layer: ${i}`);if(n<0||n>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixels(): invalid miplevel: ${n}`);if(!this.device.isContextLost()&&!this.disposed){const o=this._getFramebufferForRead(i,n);this._device.pushDeviceStates(),this._device.setFramebuffer(o);const u=this._device.readPixels(0,e,t,r,s,a);return this._device.popDeviceStates(),u}}readPixelsToBuffer(e,t,r,s,i,n,a){if(i<0||i>=this._depth)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid layer: ${i}`);if(n<0||n>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid miplevel: ${n}`);const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentLayer(0,i),o.setColorAttachmentMipLevel(0,n),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,e,t,r,s,a),this._device.popDeviceStates(),o.dispose()}loadEmpty(e,t,r,s,i){this.allocInternal(e,t,r,s,i),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}}class Hn extends Wn{constructor(e){if(!e.isWebGL2)throw new Error("device does not support 3D texture");super(e,"3d")}get depth(){return this._depth}isTexture3D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(e,t,r,s,i,n,a){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format),u=this._device.context;this._device.bindTexture(Un[this._target],0,this),u.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),u.texSubImage3D(Un[this._target],0,t,r,s,i,n,a,o.glFormat,o.glType[0],e)}createEmpty(e,t,r,s,i){this._flags=Number(i)||0,this._flags&jr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(e,t,r,s,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const e=Un[this._target];this._device.bindTexture(e,0,this),this._device.context.generateMipmap(e)}}async readPixels(e,t,r,s,i,n,a){if(0!==n)throw new Error("Texture3D.readPixels(): parameter mipLevel must be 0");if(!this.device.isContextLost()&&!this.disposed){const o=this._getFramebufferForRead(i,n);this._device.pushDeviceStates(),this._device.setFramebuffer(o);const u=this._device.readPixels(0,e,t,r,s,a);return this._device.popDeviceStates(),u}}readPixelsToBuffer(e,t,r,s,i,n,a){if(0!==n)throw new Error("Texture3D.readPixelsToBuffer(): parameter mipLevel must be 0");const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentLayer(0,i),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,e,t,r,s,a),this._device.popDeviceStates(),o.dispose()}createWithMipmapData(e,t){e.arraySize?(this._flags=Number(t)||0,this._flags&jr.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(e)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}loadLevels(e){const t=e.format,r=e.width,s=e.height,i=e.depth,n=1!==e.mipLevels||this._flags&jr.TF_NO_MIPMAP?e.mipLevels:this._calcMipLevelCount(e.format,r,s,i);if(!e.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(t,r,s,e.arraySize,n),!this._device.isContextLost()){const t=this.getTextureCaps().getTextureFormatInfo(this._format),r=this._device.context;this._device.bindTexture(Un[this._target],0,this),this.device.clearErrors();for(let s=0;s<i;s++){if(e.mipDatas[s].length!==e.mipLevels)return void console.error("Texture2DArray.loadLevels() failed: Invalid texture data");for(let i=0;i<e.mipLevels;i++){e.isCompressed?r.compressedTexSubImage3D(r.TEXTURE_3D,i,0,0,s,e.mipDatas[s][i].width,e.mipDatas[s][i].height,1,t.glInternalFormat,e.mipDatas[s][i].data):r.texSubImage3D(r.TEXTURE_3D,i,0,0,s,e.mipDatas[s][i].width,e.mipDatas[s][i].height,1,t.glFormat,t.glType[0],e.mipDatas[s][i].data);const n=this.device.getError();if(n)return void console.error(n)}}e.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture2DArray.loadLevels(): No s3tc compression format support")}loadEmpty(e,t,r,s,i){this.allocInternal(e,t,r,s,i),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}}class Yn extends Wn{constructor(e){super(e,"cube")}init(){this.loadEmpty(this._format,this._width,this._mipLevelCount)}update(e,t,r,s,i,n){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const a=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(Un[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texSubImage2D($n[n],0,t,r,s,i,a.glFormat,a.glType[0],e),this._mipLevelCount>1&&this.generateMipmaps()}updateFromElement(e,t,r,s,i,n,a,o){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const u=this.getTextureCaps().getTextureFormatInfo(this._format);if(this._device.bindTexture(Un[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===i&&0===n&&a===e.width&&o===e.height)this._device.context.texSubImage2D($n[s],0,t,r,u.glFormat,u.glType[0],e);else{const s=document.createElement("canvas");s.width=a,s.height=o;s.getContext("2d").drawImage(e,i,n,a,o,0,0,a,o),this._device.context.texSubImage2D(Un[this._target],0,t,r,u.glFormat,u.glType[0],s),s.width=0,s.height=0}this._mipLevelCount>1&&this.generateMipmaps()}createEmpty(e,t,r){this._flags=Number(r)||0,this._flags&jr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(e,t,0)}async readPixels(e,t,r,s,i,n,a){if(n<0||n>=this.mipLevelCount)throw new Error(`TextureCube.readPixels(): invalid miplevel: ${n}`);if(!this.device.isContextLost()&&!this.disposed){const o=this._getFramebufferForRead(i,n);this._device.pushDeviceStates(),this._device.setFramebuffer(o);const u=this._device.readPixels(0,e,t,r,s,a);return this._device.popDeviceStates(),u}}readPixelsToBuffer(e,t,r,s,i,n,a){if(n<0||n>=this.mipLevelCount)throw new Error(`TextureCube.readPixels(): invalid miplevel: ${n}`);const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentCubeFace(0,i),o.setColorAttachmentMipLevel(0,n),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,e,t,r,s,a),this._device.popDeviceStates(),o.dispose()}isTextureCube(){return!0}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const e=Un[this._target];this._device.bindTexture(e,0,this),this._device.context.generateMipmap(e)}}createWithMipmapData(e,t,r){e.isCubemap?(this._flags=Number(r)||0,this._flags&jr.TF_WRITABLE?console.error("webgl device does not support storage texture"):this.loadLevels(e,t)):console.error("loading cubmap with mipmap data failed: data is not cubemap")}loadEmpty(e,t,r){this.allocInternal(e,t,t,1,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(e,t){const r=t?I(e.format):e.format,s=e.width,i=e.height,n=e.mipLevels;if(!e.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(r,s,i,1,n),!this._device.isContextLost()){const t=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(Un[this._target],0,this),this.device.clearErrors();for(let r=0;r<6;r++){const s=$n[r];if(this._mipLevelCount>1&&e.mipDatas[r].length!==this._mipLevelCount)return void console.error("invalid texture data");for(let i=0;i<this._mipLevelCount;i++){e.isCompressed?this._device.context.compressedTexSubImage2D(s,i,0,0,e.mipDatas[r][i].width,e.mipDatas[r][i].height,t.glInternalFormat,e.mipDatas[r][i].data):this._device.context.texSubImage2D(s,i,0,0,e.mipDatas[r][i].width,e.mipDatas[r][i].height,t.glFormat,t.glType[0],e.mipDatas[r][i].data);const n=this.device.getError();if(n)return void console.error(n)}}}}else console.warn("No s3tc compression format support")}}class jn extends Wn{_source;_callbackId;constructor(e,t){super(e,"2d"),this._source=null,this._callbackId=null,this._format="unknown",this.loadFromElement(t)}isTextureVideo(){return!0}get source(){return this._source}destroy(){this._source&&null!==this._callbackId&&this._source.cancelVideoFrameCallback(this._callbackId),super.destroy()}init(){this.loadElement(this._source)}loadFromElement(e){this._flags=jr.TF_NO_MIPMAP,this.loadElement(e)}generateMipmaps(){}readPixels(e,t,r,s,i,n,a){throw new Error("Video texture does not support readPixels()")}readPixelsToBuffer(e,t,r,s,i,n,a){throw new Error("Video texture does not support readPixelsToBuffer()")}updateVideoFrame(){return!(!(this.object&&this._source.currentTime>0)||this._source.requestVideoFrameCallback)&&(this.update(),!0)}update(){if(this.allocInternal("rgba8unorm",this._source.videoWidth,this._source.videoHeight,1,1),!this._device.isContextLost()){const e=Un[this._target],t=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(e,0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texImage2D(e,0,t.glInternalFormat,t.glFormat,t.glType[0],this._source)}}loadElement(e){if(this._source&&null!==this._callbackId&&(this._source.cancelVideoFrameCallback(this._callbackId),this._callbackId=null),this._source=e,this._source?.requestVideoFrameCallback){const e=this;e._callbackId=this._source.requestVideoFrameCallback(function t(){e._object&&(e.update(),e._callbackId=e._source.requestVideoFrameCallback(t))})}this.allocInternal("rgba8unorm",Math.max(this._source.videoWidth,1),Math.max(this._source.videoHeight,1),1,1)}}class Kn extends Xn{_vertexData;_dirty;constructor(e,t){super(e),this._vertexData=new ss,this._dirty=!1;for(const e of t.vertexBuffers)this._vertexData.setVertexBuffer(e.buffer,e.stepMode);t.indexBuffer&&this._vertexData.setIndexBuffer(t.indexBuffer),this.load()}destroy(){this._object&&this._device.vaoExt&&this._device.vaoExt.deleteVertexArray(this._object),this._object=null}restore(){this._device.isContextLost()||this.load()}get vertexBuffers(){return this._vertexData.vertexBuffers}get indexBuffer(){return this._vertexData.indexBuffer}setDrawOffset(e,t){for(const r of this._vertexData.vertexBuffers)r?.buffer===e&&r.drawOffset!==t&&(r.drawOffset=t,this._dirty=!0)}getVertexBuffer(e){return this._vertexData.getVertexBuffer(e)}getVertexBufferInfo(e){return this._vertexData.getVertexBufferInfo(e)}getIndexBuffer(){return this._vertexData.getIndexBuffer()}bind(){this._object&&this._device.vaoExt?(this._device.vaoExt.bindVertexArray(this._object),this._dirty&&(this._dirty=!1,this.bindBuffers())):this.bindBuffers()}draw(e,t,r){this._device.setVertexLayout(this),this._device.draw(e,t,r)}drawInstanced(e,t,r,s){this._device.setVertexLayout(this),this._device.drawInstanced(e,t,r,s)}isVertexLayout(){return!0}load(){this._device.isContextLost()||(this._device.vaoExt?this._object||(this._object=this._device.vaoExt.createVertexArray(),this._device.vaoExt.bindVertexArray(this._object),this.bindBuffers(),this._device.vaoExt.bindVertexArray(null)):this._object={})}bindBuffers(){const e=this._vertexData.vertexBuffers,t=this._device.context;for(let r=0;r<e.length;r++){const s=e[r],i=s?.buffer;i?(i.disposed&&i.reload(),t.bindBuffer(yn.ARRAY_BUFFER,i.object),t.enableVertexAttribArray(r),"instance"===s.stepMode&&this._device.instancedArraysExt?(t.vertexAttribPointer(r,s.type.cols,Bn[s.type.scalarType],s.type.normalized,s.stride,s.offset),this._device.instancedArraysExt.vertexAttribDivisor(r,1)):t.vertexAttribPointer(r,s.type.cols,Bn[s.type.scalarType],s.type.normalized,s.stride,s.drawOffset+s.offset)):t.disableVertexAttribArray(r)}this._vertexData.indexBuffer?.disposed&&this._vertexData.indexBuffer.reload(),t.bindBuffer(yn.ELEMENT_ARRAY_BUFFER,this._vertexData.indexBuffer?this._vertexData.indexBuffer.object:null)}}class Zn extends Xn{_size;_usage;_systemMemoryBuffer;_systemMemory;_memCost;constructor(e,t,r,s=!1){if(super(e),t&jr.BF_VERTEX&&t&jr.BF_INDEX)throw new Error("buffer usage must not have Vertex and Index simultaneously");if(!(e.isWebGL2||t&jr.BF_VERTEX||t&jr.BF_INDEX||t&jr.BF_UNIFORM))throw new Error("no Vertex or Index or Uniform usage set when creating buffer");if(e.isWebGL2&&!(t&~jr.DYNAMIC))throw new Error("buffer usage not set when creating buffer");if(t&jr.DYNAMIC&&t&jr.MANAGED)throw new Error("buffer usage DYNAMIC and MANAGED can not be both set");if(this._object=null,this._memCost=0,this._usage=t,this._size="number"==typeof r?r:r.byteLength,this._size<=0)throw new Error("can not create buffer with zero size");this._systemMemory=!!s,this._systemMemory||this._usage&jr.MANAGED?(this._systemMemoryBuffer=new Uint8Array(this._size),r&&"number"!=typeof r&&this._systemMemoryBuffer.set(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))):this._systemMemoryBuffer=null,this._systemMemory||this.load(this._systemMemoryBuffer||("number"==typeof r?null:r))}get byteLength(){return this._size}get systemMemoryBuffer(){return this._systemMemoryBuffer?.buffer||null}get usage(){return this._usage}bufferSubData(e,t,r,s){if(r=Number(r)||0,e=Number(e)||0,r+(s=Number(s)||t.length-r)>t.length)throw new Error("bufferSubData() failed: source buffer is too small");if(e+s*t.BYTES_PER_ELEMENT>this.byteLength)throw new Error("bufferSubData() failed: dest buffer is too small");if((this._systemMemory||this._usage&jr.MANAGED)&&this._systemMemoryBuffer.set(new Uint8Array(t.buffer,t.byteOffset+r*t.BYTES_PER_ELEMENT,s*t.BYTES_PER_ELEMENT),e),!this._systemMemory&&!this.device.isContextLost()){let i;if(this.disposed&&this.reload(),this._device.isWebGL2||0===r&&s===t.length||(t=t.subarray(r,r+s)),this._device.vaoExt?.bindVertexArray(null),this._usage&jr.BF_INDEX)i=yn.ELEMENT_ARRAY_BUFFER;else if(this._usage&jr.BF_VERTEX)i=yn.ARRAY_BUFFER;else if(this._usage&jr.BF_UNIFORM)i=yn.UNIFORM_BUFFER;else if(this._usage&(jr.BF_READ|jr.BF_WRITE))i=yn.COPY_WRITE_BUFFER;else{if(!(this._usage&(jr.BF_PACK_PIXEL|jr.BF_UNPACK_PIXEL)))throw new Error("Invalid buffer usage");i=yn.PIXEL_PACK_BUFFER}this._device.context.bindBuffer(i,this._object),this._device.isWebGL2?this._device.context.bufferSubData(i,e,t,r,s):this._device.context.bufferSubData(i,e,t)}}async getBufferSubData(e,t,r){return this.disposed&&this.reload(),this._getBufferData(e,t,r)}async _getBufferData(e,t,r){if(t=Number(t)||0,r=Number(r)||this.byteLength-t,t<0||t+r>this.byteLength)throw new Error("data query range out of bounds");if(e&&e.byteLength<r)throw new Error("no enough space for querying buffer data");if(e=e||new Uint8Array(r),this._systemMemoryBuffer)e.set(new Uint8Array(this._systemMemoryBuffer.buffer,t,r));else{const s=this._device.context;if(An(s)){const e=s.fenceSync(yn.SYNC_GPU_COMMANDS_COMPLETE,0);await this.clientWaitAsync(s,e,0,10),s.deleteSync(e)}let i;if(this._device.vaoExt?.bindVertexArray(null),this._usage&jr.BF_INDEX)i=yn.ELEMENT_ARRAY_BUFFER;else if(this._usage&jr.BF_VERTEX)i=yn.ARRAY_BUFFER;else if(this._usage&jr.BF_UNIFORM)i=yn.UNIFORM_BUFFER;else if(this._usage&(jr.BF_READ|jr.BF_WRITE))i=yn.COPY_READ_BUFFER;else{if(!(this._usage&(jr.BF_PACK_PIXEL|jr.BF_UNPACK_PIXEL)))throw new Error("Invalid buffer usage");i=yn.PIXEL_UNPACK_BUFFER}s.bindBuffer(i,this._object),s.getBufferSubData(i,t,e,0,r),s.bindBuffer(i,null)}return e}restore(){this._systemMemory||this._object||this._device.isContextLost()||this.load(this._systemMemoryBuffer)}destroy(){!this._systemMemory&&this._object&&(this._device.context.deleteBuffer(this._object),this._object=null,this._device.updateVideoMemoryCost(-this._memCost),this._memCost=0)}isBuffer(){return!0}load(e){if(!this._device.isContextLost()){this._object||(this._object=this._device.context.createBuffer()),this._device.vaoExt?.bindVertexArray(null);let t,r=this._usage&jr.DYNAMIC?yn.DYNAMIC_DRAW:yn.STATIC_DRAW;if(this._usage&jr.BF_INDEX)t=yn.ELEMENT_ARRAY_BUFFER;else if(this._usage&jr.BF_VERTEX)t=yn.ARRAY_BUFFER;else if(this._usage&jr.BF_UNIFORM)t=yn.UNIFORM_BUFFER;else if(this._usage&jr.BF_READ)t=yn.PIXEL_PACK_BUFFER,r=yn.STREAM_READ;else if(this._usage&jr.BF_WRITE)t=yn.COPY_WRITE_BUFFER;else if(this._usage&jr.BF_PACK_PIXEL)t=yn.PIXEL_PACK_BUFFER,r=yn.STREAM_READ;else{if(!(this._usage&jr.BF_UNPACK_PIXEL))throw new Error(`WebGLGPUBuffer.load() failed: invalid buffer usage: ${this._usage}`);t=yn.PIXEL_UNPACK_BUFFER}this._device.context.bindBuffer(t,this._object),e?this._device.context.bufferData(t,e,r):this._device.context.bufferData(t,this._size+15&-16,r)}this._device.updateVideoMemoryCost(this._size-this._memCost),this._memCost=this._size}async clientWaitAsync(e,t,r,s){return new Promise((i,n)=>{!function a(){const o=e.clientWaitSync(t,r,0);o!=e.WAIT_FAILED?o!=e.TIMEOUT_EXPIRED?i():setTimeout(a,s):n()}()})}}const qn=ie.getCachedTypeInfo(X.U16),Qn=ie.getCachedTypeInfo(X.U32);class Jn extends Zn{indexType;length;constructor(e,t,r){if(!(t instanceof Uint16Array||t instanceof Uint32Array))throw new Error("invalid index data");super(e,jr.BF_INDEX|r,t),this.indexType=t instanceof Uint16Array?qn:Qn,this.length=t.length}}class ea extends Xn{_options;_needBindBuffers;_drawTags;_lastDrawTag;_status;_statusAA;_width;_height;_isMRT;_drawBuffers;_hash;_needGenerateMipmaps;_depthAttachmentTarget;_colorAttachmentsAA;_depthAttachmentAA;_intermediateAttachments;_framebufferAA;_initialized;constructor(e,t,r,s){if(super(e),t.length>0&&t.findIndex(e=>!e)>=0)throw new Error("WebGLFramebuffer(): invalid color attachments");if(this._object=null,this._framebufferAA=null,this._colorAttachmentsAA=null,this._depthAttachmentAA=null,this._intermediateAttachments=null,this._needBindBuffers=!1,this._drawTags=0,this._lastDrawTag=-1,this._status=0,this._statusAA=0,this._options={colorAttachments:t?.length>0?t.map(e=>({texture:e,face:0,layer:0,level:0,generateMipmaps:!0})):null,depthAttachment:r?{texture:r,face:0,layer:0,level:0,generateMipmaps:!1}:null,sampleCount:"webgl"===e.type?1:s?.sampleCount??1,ignoreDepthStencil:s?.ignoreDepthStencil??!1},!this._options.colorAttachments&&!this._options.depthAttachment)throw new Error("WebGLFramebuffer(): colorAttachments or depthAttachment must be specified");if(this._width=this._options.colorAttachments?this._options.colorAttachments[0].texture.width:this._options.depthAttachment.texture.width,this._height=this._options.colorAttachments?this._options.colorAttachments[0].texture.height:this._options.depthAttachment.texture.height,this._options.colorAttachments&&this._options.colorAttachments.findIndex(e=>e.texture.width!==this._width||e.texture.height!==this._height)>=0||this._options.depthAttachment&&(this._options.depthAttachment.texture.width!==this._width||this._options.depthAttachment.texture.height!==this._height))throw new Error("WebGLFramebuffer(): attachment textures must have same width and height");if(this._drawBuffers=this._options.colorAttachments?.map((e,t)=>yn.COLOR_ATTACHMENT0+t)??[],this._isMRT=this._drawBuffers.length>1,this._options.depthAttachment){const e=this._options.depthAttachment.texture.format;this._depthAttachmentTarget=function(e){return!!(32&C[e])}(e)?yn.DEPTH_STENCIL_ATTACHMENT:yn.DEPTH_ATTACHMENT}else this._depthAttachmentTarget=yn.NONE;const i=this._options.colorAttachments?.map(e=>e.texture.format).join(":")??"",n=this._options.depthAttachment?.texture.format??"";this._hash=`${i}-${n}-${this._options.sampleCount??1}`,this._needGenerateMipmaps=!1,this._initialized=!1}tagDraw(){this._drawTags++}isMRT(){return this._isMRT}invalidateMipmaps(){this._needGenerateMipmaps=!0}getWidth(){const e=this._options.colorAttachments?.[0]??this._options.depthAttachment;return Math.max(e.texture.width>>e.level,1)}getHeight(){const e=this._options.colorAttachments?.[0]??this._options.depthAttachment;return Math.max(e.texture.height>>e.level,1)}getHash(){return this._hash}restore(){if(!this._object&&!this._device.isContextLost()&&(this._options?.depthAttachment?.texture?.disposed&&this._options.depthAttachment.texture.reload(),this._options?.colorAttachments))for(const e of this._options.colorAttachments)e?.texture?.disposed&&e.texture.reload();this._init()}destroy(){if(this._object){if(this._device.context.deleteFramebuffer(this._object),this._object=null,this._colorAttachmentsAA){for(const e of this._colorAttachmentsAA)this._device.context.deleteRenderbuffer(e);this._colorAttachmentsAA=null}if(this._depthAttachmentAA&&(this._device.context.deleteRenderbuffer(this._depthAttachmentAA),this._depthAttachmentAA=null),this._framebufferAA&&(this._device.context.deleteFramebuffer(this._framebufferAA),this._framebufferAA=null),this._intermediateAttachments){for(const e of this._intermediateAttachments)for(const t of e[1])t&&(this._device.context.deleteTexture(t.texture),this._device.invalidateBindingTextures());this._intermediateAttachments=null}}}setColorAttachmentGenerateMipmaps(e,t){const r=this._options.colorAttachments?.[e];r&&(r.generateMipmaps=!!t)}getColorAttachmentGenerateMipmaps(e){return this._options.colorAttachments?.[e]?.generateMipmaps}setColorAttachmentCubeFace(e,t){const r=this._options.colorAttachments?.[e];r&&r.face!==t&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),r.face=t,this.bind()):r.face=t)}getColorAttachmentCubeFace(e){return this._options.colorAttachments?.[e]?.face}setColorAttachmentMipLevel(e,t){const r=this._options.colorAttachments?.[e];r&&r.level!==t&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),r.level=t,this.bind()):r.level=t)}getColorAttachmentMipLevel(e){return this._options.colorAttachments?.[e]?.level}setColorAttachmentLayer(e,t){const r=this._options.colorAttachments?.[e];r&&r.layer!==t&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),r.layer=t,this.bind()):r.layer=t)}getColorAttachmentLayer(e){return this._options?.colorAttachments?.[e]?.layer}setDepthAttachmentCubeFace(e){const t=this._options.depthAttachment;t&&t.face!==e&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),t.face=e,this.bind()):t.face=e)}getDepthAttachmentCubeFace(){return this._options.depthAttachment?.face}setDepthAttachmentLayer(e){const t=this._options.depthAttachment;t&&t.layer!==e&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),t.layer=e,this.bind()):t.layer=e)}getDepthAttachmentLayer(){return this._options.depthAttachment?.layer}getDepthAttachment(){return this._options?.depthAttachment?.texture||null}getColorAttachments(){return this._options.colorAttachments?.map(e=>e.texture||null)||[]}getColorAttachment(e){return this.getColorAttachments()[e]??null}bind(){if(this._initialized||(this._init(),this._initialized=!0),this._object){if(this._device.context._currentFramebuffer=this,this._lastDrawTag=-1,this._needBindBuffers&&(this._needBindBuffers=!1,!this._bindBuffersAA()||!this._bindBuffers()))return this._device.context.bindFramebuffer(yn.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null,!1;this._device.context.bindFramebuffer(yn.FRAMEBUFFER,this._framebufferAA||this._object);const e=this._device.drawBuffersExt;return e?e.drawBuffers(this._drawBuffers):this._isMRT&&console.error("device does not support multiple framebuffer color attachments"),this._device.setViewport(null),this._device.setScissor(null),this._needGenerateMipmaps=!1,!0}return!1}unbind(){if(this._device.context._currentFramebuffer===this){this._updateMSAABuffer(),this._device.context.bindFramebuffer(yn.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null,this._device.setViewport(),this._device.setScissor();const e=this._device.drawBuffersExt;if(e&&e.drawBuffers([yn.BACK]),this._options.colorAttachments)for(const e of this._options.colorAttachments){const t=e.texture;if(e.level>0){const r=this._intermediateAttachments?.get(t)?.[e.level];if(r){const s=this._device.context.createFramebuffer();this._device.context.bindFramebuffer(yn.FRAMEBUFFER,s),this._device.context.framebufferTexture2D(yn.FRAMEBUFFER,yn.COLOR_ATTACHMENT0,yn.TEXTURE_2D,r.texture,0),t.isTexture2D()?(this._device.bindTexture(yn.TEXTURE_2D,0,t),this._device.context.copyTexSubImage2D(yn.TEXTURE_2D,e.level,0,0,0,0,r.width,r.height)):t.isTextureCube()&&(this._device.bindTexture(yn.TEXTURE_CUBE_MAP,0,t),this._device.context.copyTexSubImage2D($n[e.face??i.PX],e.level,0,0,0,0,r.width,r.height)),this._device.context.bindFramebuffer(yn.FRAMEBUFFER,null),this._device.context.deleteFramebuffer(s)}}this._needGenerateMipmaps&&e.generateMipmaps&&t.mipLevelCount>1&&t.generateMipmaps()}}}_updateMSAABuffer(){if(this._options.sampleCount>1&&this._lastDrawTag!==this._drawTags){const e=this._device.context;e.bindFramebuffer(yn.READ_FRAMEBUFFER,this._framebufferAA),e.bindFramebuffer(yn.DRAW_FRAMEBUFFER,this._object);let t=0;this._options.ignoreDepthStencil||this._depthAttachmentTarget===yn.NONE||(t=yn.DEPTH_BUFFER_BIT|(this._depthAttachmentTarget===yn.DEPTH_STENCIL_ATTACHMENT?yn.STENCIL_BUFFER_BIT:0));for(let r=0;r<this._drawBuffers.length;r++){for(let e=0;e<this._drawBuffers.length;e++)this._drawBuffers[e]=e===r?yn.COLOR_ATTACHMENT0+r:yn.NONE;e.readBuffer(this._drawBuffers[r]),e.drawBuffers(this._drawBuffers),e.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,yn.COLOR_BUFFER_BIT|t,yn.NEAREST),t=0}0!==t&&e.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,t,yn.NEAREST);for(let e=0;e<this._drawBuffers.length;e++)this._drawBuffers[e]=yn.COLOR_ATTACHMENT0+e;e.bindFramebuffer(yn.READ_FRAMEBUFFER,null),e.bindFramebuffer(yn.DRAW_FRAMEBUFFER,null),this._lastDrawTag=this._drawTags}}_load(){this._device.isContextLost()||(this._options.sampleCount>1&&(this._framebufferAA=this._device.context.createFramebuffer(),this._colorAttachmentsAA=[],this._depthAttachmentAA=null,!this._bindBuffersAA())?this.dispose():(this._object=this._device.context.createFramebuffer(),this._device.context.bindFramebuffer(yn.FRAMEBUFFER,this._object),this._bindBuffers()||this.dispose()),this._lastDrawTag=-1,this._device.context.bindFramebuffer(yn.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null)}_bindAttachment(e,t){if(t.texture){let r=null;if("webgl"===this.device.type&&!this.device.getDeviceCaps().framebufferCaps.supportRenderMipmap&&t.level>0){this._intermediateAttachments||(this._intermediateAttachments=new Map);let e=this._intermediateAttachments.get(t.texture);if(e||(e=[],this._intermediateAttachments.set(t.texture,e)),e[t.level])r=e[t.level].texture;else{let s=t.texture.width,i=t.texture.height,n=t.level;for(;n-- >0;)s=Math.max(s>>1,1),i=Math.max(i>>1,1);const a=this.device.getDeviceCaps().textureCaps.getTextureFormatInfo(t.texture.format);r=this._device.context.createTexture(),this._device.context.activeTexture(yn.TEXTURE0),this._device.context.bindTexture(yn.TEXTURE_2D,r),this._device.context.texImage2D(yn.TEXTURE_2D,0,a.glInternalFormat,s,i,0,a.glFormat,a.glType[0],null),e[t.level]={texture:r,width:s,height:i},this._device.bindTexture(yn.TEXTURE_2D,0,null)}}if(r)this._device.context.framebufferTexture2D(yn.FRAMEBUFFER,e,yn.TEXTURE_2D,r,0);else if(t.texture.isTexture2D())this._device.context.framebufferTexture2D(yn.FRAMEBUFFER,e,yn.TEXTURE_2D,t.texture.object,t.level??0);else if(t.texture.isTextureCube())this._device.context.framebufferTexture2D(yn.FRAMEBUFFER,e,$n[t.face??i.PX],t.texture.object,t.level??0);else{if(!t.texture.isTexture2DArray()&&!t.texture.isTexture3D())return!1;this._device.context.framebufferTextureLayer(yn.FRAMEBUFFER,e,t.texture.object,t.level??0,t.layer??0)}return!0}return!1}_bindBuffers(){if(!this._object)return!1;if(this._device.context.bindFramebuffer(yn.FRAMEBUFFER,this._object),this._depthAttachmentTarget!==yn.NONE&&!this._bindAttachment(this._depthAttachmentTarget,this._options.depthAttachment))return!1;if(this._options.colorAttachments)for(let e=0;e<this._options.colorAttachments.length;e++){const t=this._options.colorAttachments[e];if(t.texture&&!this._bindAttachment(yn.COLOR_ATTACHMENT0+e,t))return!1}if(0===this._status){const e=this._device.context.checkFramebufferStatus(yn.FRAMEBUFFER);e!==yn.FRAMEBUFFER_COMPLETE?(console.error(`Framebuffer not complete: ${e}`),this._status=2):this._status=1}return 1===this._status}_createRenderbufferAA(e){const t=this._device.context.createRenderbuffer(),r=this.device.getDeviceCaps().textureCaps.getTextureFormatInfo(e.format);return this._device.context.bindRenderbuffer(yn.RENDERBUFFER,t),this._device.context.renderbufferStorageMultisample(yn.RENDERBUFFER,this._options.sampleCount,r.glInternalFormat,this._options.depthAttachment.texture.width,this._options.depthAttachment.texture.height),t}_bindBuffersAA(){if(!this._framebufferAA)return!0;if(this._device.context.bindFramebuffer(yn.FRAMEBUFFER,this._framebufferAA),this._depthAttachmentTarget!==yn.NONE&&(this._depthAttachmentAA||(this._depthAttachmentAA=this._createRenderbufferAA(this._options.depthAttachment.texture)),this._device.context.framebufferRenderbuffer(yn.FRAMEBUFFER,this._depthAttachmentTarget,yn.RENDERBUFFER,this._depthAttachmentAA)),this._options.colorAttachments)for(let e=0;e<this._options.colorAttachments.length;e++){this._options.colorAttachments[e].texture&&(this._colorAttachmentsAA[e]||(this._colorAttachmentsAA[e]=this._createRenderbufferAA(this._options.colorAttachments[e].texture)),this._device.context.framebufferRenderbuffer(yn.FRAMEBUFFER,yn.COLOR_ATTACHMENT0+e,yn.RENDERBUFFER,this._colorAttachmentsAA[e]))}if(0===this._statusAA){const e=this._device.context.checkFramebufferStatus(yn.FRAMEBUFFER);e!==yn.FRAMEBUFFER_COMPLETE?(console.error(`Framebuffer not complete: ${e}`),this._statusAA=2):this._statusAA=1}return 1===this._statusAA}_init(){if(1!==this._options.sampleCount&&4!==this._options.sampleCount)throw new Error(`WebGLFramebuffer(): Sample should be 1 or 4, got ${this._options.sampleCount}`);if(this._options.sampleCount>1&&!this._device.getDeviceCaps().framebufferCaps.supportMultisampledFramebuffer)throw new Error("WebGLFramebuffer(): Multisampled frame buffer not supported");this._load()}isFramebuffer(){return!0}getSampleCount(){return this._options.sampleCount}}class ta{static _defaultState;static _currentState;apply(e,t){const r=this.constructor;(t||r._currentState!==this)&&this._apply(e),r._currentState=this}static get defaultState(){return ta._defaultState}static applyDefaults(e,t){(t||this._currentState!==this._defaultState)&&this._defaultState.apply(e,t)}}class ra extends ta{static _defaultState=new ra;static _currentState=null;redMask;greenMask;blueMask;alphaMask;constructor(){super(),this.redMask=this.greenMask=this.blueMask=this.alphaMask=!0}clone(){return(new ra).setColorMask(this.redMask,this.greenMask,this.blueMask,this.alphaMask)}setColorMask(e,t,r,s){return this.redMask=e,this.greenMask=t,this.blueMask=r,this.alphaMask=s,this}_apply(e){e.colorMask(this.redMask,this.greenMask,this.blueMask,this.alphaMask)}}class sa extends ta{static _defaultState=new sa;static _currentState=null;_srcBlendRGB;_dstBlendRGB;_srcBlendAlpha;_dstBlendAlpha;_rgbEquation;_alphaEquation;enabled;alphaToCoverageEnabled;constructor(){super(),this.enabled=!1,this.alphaToCoverageEnabled=!1,this.srcBlendRGB="one",this.dstBlendRGB="zero",this.srcBlendAlpha="one",this.dstBlendAlpha="zero",this.rgbEquation="add",this.alphaEquation="add"}clone(){const e=new sa;return e.enable(this.enabled),e.enableAlphaToCoverage(this.alphaToCoverageEnabled),e.setBlendFuncRGB(this.srcBlendRGB,this.dstBlendRGB),e.setBlendFuncAlpha(this.srcBlendAlpha,this.dstBlendAlpha),e.setBlendEquation(this.rgbEquation,this.alphaEquation),e}get srcBlendRGB(){return In[this._srcBlendRGB]}set srcBlendRGB(e){this._srcBlendRGB=Cn[e]}get dstBlendRGB(){return In[this._dstBlendRGB]}set dstBlendRGB(e){this._dstBlendRGB=Cn[e]}get srcBlendAlpha(){return In[this._srcBlendAlpha]}set srcBlendAlpha(e){this._srcBlendAlpha=Cn[e]}get dstBlendAlpha(){return In[this._dstBlendAlpha]}set dstBlendAlpha(e){this._dstBlendAlpha=Cn[e]}get rgbEquation(){return Sn[this._rgbEquation]}set rgbEquation(e){this._rgbEquation=Rn[e]}get alphaEquation(){return Sn[this._alphaEquation]}set alphaEquation(e){this._alphaEquation=Rn[e]}enable(e){return this.enabled=!!e,this}enableAlphaToCoverage(e){return this.alphaToCoverageEnabled=!!e,this}setBlendFunc(e,t){return this.srcBlendRGB=e,this.dstBlendRGB=t,this.srcBlendAlpha=e,this.dstBlendAlpha=t,this}setBlendFuncRGB(e,t){return this.srcBlendRGB=e,this.dstBlendRGB=t,this}setBlendFuncAlpha(e,t){return this.srcBlendAlpha=e,this.dstBlendAlpha=t,this}setBlendEquation(e,t){return this.rgbEquation=e,this.alphaEquation=t,this}_apply(e){this.enabled?(e.enable(yn.BLEND),e.blendEquationSeparate(this._rgbEquation,this._alphaEquation),this._srcBlendRGB===this._srcBlendAlpha&&this._dstBlendRGB===this._dstBlendAlpha?e.blendFunc(this._srcBlendRGB,this._dstBlendRGB):e.blendFuncSeparate(this._srcBlendRGB,this._dstBlendRGB,this._srcBlendAlpha,this._dstBlendAlpha)):e.disable(yn.BLEND),this.alphaToCoverageEnabled?e.enable(yn.SAMPLE_ALPHA_TO_COVERAGE):e.disable(yn.SAMPLE_ALPHA_TO_COVERAGE)}}class ia extends ta{static _defaultState=new ia;static _currentState=null;_cullMode;constructor(){super(),this.cullMode="back"}clone(){return(new ia).setCullMode(this.cullMode)}get cullMode(){return Nn[this._cullMode]}set cullMode(e){this._cullMode=Fn[e]}setCullMode(e){return this.cullMode=e,this}get depthClampEnabled(){return!1}set depthClampEnabled(e){this.enableDepthClamp(e)}enableDepthClamp(e){return e&&console.error("Depth clamp not supported"),this}_apply(e){"none"==this.cullMode?e.disable(yn.CULL_FACE):(e.enable(yn.CULL_FACE),e.cullFace(this._cullMode))}}class na extends ta{static _defaultState=new na;static _currentState=null;testEnabled;writeEnabled;depthBias;depthBiasSlopeScale;_compareFunc;constructor(){super(),this.testEnabled=!0,this.writeEnabled=!0,this.compareFunc="le",this.depthBias=0,this.depthBiasSlopeScale=0}clone(){const e=new na;return e.enableTest(this.testEnabled),e.enableWrite(this.writeEnabled),e.setCompareFunc(this.compareFunc),e.setDepthBias(this.depthBias),e.setDepthBiasSlopeScale(this.depthBiasSlopeScale),e}get compareFunc(){return On[this._compareFunc]}set compareFunc(e){this._compareFunc=Ln[e]}enableTest(e){return this.testEnabled=e,this}enableWrite(e){return this.writeEnabled=e,this}setCompareFunc(e){return this.compareFunc=e,this}setDepthBias(e){return this.depthBias=e,this}setDepthBiasSlopeScale(e){return this.depthBiasSlopeScale=e,this}_apply(e){this.testEnabled?(e.enable(yn.DEPTH_TEST),e.depthFunc(this._compareFunc)):e.disable(yn.DEPTH_TEST),e.depthMask(this.writeEnabled),0!==this.depthBias||0!==this.depthBiasSlopeScale?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.depthBiasSlopeScale,this.depthBias)):e.disable(e.POLYGON_OFFSET_FILL)}}class aa extends ta{static _defaultState=new aa;static _currentState=null;enabled;writeMask;ref;readMask;_failOp;_failOpBack;_zFailOp;_zFailOpBack;_passOp;_passOpBack;_func;_funcBack;constructor(){super(),this.enabled=!1,this.failOp=this.failOpBack="keep",this.zFailOp=this.zFailOpBack="keep",this.passOp=this.passOpBack="keep",this.func=this.funcBack="always",this.ref=0,this.writeMask=4294967295,this.readMask=4294967295}clone(){const e=new aa;return e.enable(this.enabled),e.setWriteMask(this.writeMask),e.setFrontOp(this.failOp,this.zFailOp,this.passOp),e.setBackOp(this.failOpBack,this.zFailOpBack,this.passOpBack),e.setFrontCompareFunc(this.func),e.setBackCompareFunc(this.funcBack),e.setReference(this.ref),e.setReadMask(this.readMask),e}get failOp(){return wn[this._failOp]}set failOp(e){this._failOp=vn[e]}get failOpBack(){return wn[this._failOpBack]}set failOpBack(e){this._failOpBack=vn[e]}get zFailOp(){return wn[this._zFailOp]}set zFailOp(e){this._zFailOp=vn[e]}get zFailOpBack(){return wn[this._zFailOpBack]}set zFailOpBack(e){this._zFailOpBack=vn[e]}get passOp(){return wn[this._passOp]}set passOp(e){this._passOp=vn[e]}get passOpBack(){return wn[this._passOpBack]}set passOpBack(e){this._passOpBack=vn[e]}get func(){return On[this._func]}set func(e){this._func=Ln[e]}get funcBack(){return On[this._funcBack]}set funcBack(e){this._funcBack=Ln[e]}enable(e){return this.enabled=e,this}setWriteMask(e){return this.writeMask=e,this}setFrontOp(e,t,r){return this.failOp=e,this.zFailOp=t,this.passOp=r,this}setBackOp(e,t,r){return this.failOpBack=e,this.zFailOpBack=t,this.passOpBack=r,this}setFrontCompareFunc(e){return this.func=e,this}setBackCompareFunc(e){return this.funcBack=e,this}setReference(e){return this.ref=e,this}setReadMask(e){return this.readMask=e,this}_apply(e){this.enabled?(e.enable(yn.STENCIL_TEST),e.stencilMaskSeparate(yn.FRONT,this.writeMask),e.stencilMaskSeparate(yn.BACK,this.writeMask),e.stencilFuncSeparate(yn.FRONT,this._func,this.ref,this.readMask),e.stencilFuncSeparate(yn.BACK,this._funcBack,this.ref,this.readMask),e.stencilOpSeparate(yn.FRONT,this._failOp,this._zFailOp,this._passOp),e.stencilOpSeparate(yn.BACK,this._failOpBack,this._zFailOpBack,this._passOpBack)):e.disable(yn.STENCIL_TEST)}}class oa{_gl;colorState;blendingState;rasterizerState;depthState;stencilState;constructor(e){this._gl=e,this.colorState=null,this.blendingState=null,this.rasterizerState=null,this.depthState=null,this.stencilState=null}clone(){const e=new oa(this._gl);return e.colorState=this.colorState?.clone()??null,e.blendingState=this.blendingState?.clone()??null,e.rasterizerState=this.rasterizerState?.clone()??null,e.depthState=this.depthState?.clone()??null,e.stencilState=this.stencilState?.clone()??null,e}copyFrom(e){this.colorState=e.colorState,this.blendingState=e.blendingState,this.rasterizerState=e.rasterizerState,this.depthState=e.depthState,this.stencilState=e.stencilState}apply(e){const t=this._gl;this.colorState?this.colorState.apply(t,e):ra.applyDefaults(t,e),this.blendingState?this.blendingState.apply(t,e):sa.applyDefaults(t,e),this.rasterizerState?this.rasterizerState.apply(t,e):ia.applyDefaults(t,e),this.depthState?this.depthState.apply(t,e):na.applyDefaults(t,e),this.stencilState?this.stencilState.apply(t,e):aa.applyDefaults(t,e)}useColorState(e){return this.colorState=e??this.colorState??new ra}defaultColorState(){this.colorState=null}useBlendingState(e){return this.blendingState=e??this.blendingState??new sa}defaultBlendingState(){this.blendingState=null}useRasterizerState(e){return this.rasterizerState=e??this.rasterizerState??new ia}defaultRasterizerState(){this.rasterizerState=null}useDepthState(e){return this.depthState=e??this.depthState??new na}defaultDepthState(){this.depthState=null}useStencilState(e){return this.stencilState=e??this.stencilState??new aa}defaultStencilState(){this.stencilState=null}static applyDefaults(e,t){ra.applyDefaults(e,t),sa.applyDefaults(e,t),ia.applyDefaults(e,t),na.applyDefaults(e,t),aa.applyDefaults(e,t)}}class ua{_device;_query;_state;_timerQuery;_gpuTime;constructor(e){this._device=e,this._state=0,this._gpuTime=null;const t=this._device.context;if(An(t)){const e=t.getExtension("EXT_disjoint_timer_query_webgl2");e&&(this._timerQuery={createQuery:t.createQuery.bind(t),deleteQuery:t.deleteQuery.bind(t),beginQuery:t.beginQuery.bind(t),endQuery:t.endQuery.bind(t),isQuery:t.isQuery.bind(t),getQuery:t.getQuery.bind(t),getQueryObject:t.getQueryParameter.bind(t),queryCounter:e.queryCounterEXT.bind(e)})}else{const e=t.getExtension("EXT_disjoint_timer_query");e&&(this._timerQuery={createQuery:e.createQueryEXT.bind(e),deleteQuery:e.deleteQueryEXT.bind(e),beginQuery:e.beginQueryEXT.bind(e),endQuery:e.endQueryEXT.bind(e),isQuery:e.isQueryEXT.bind(e),getQuery:e.getQueryEXT.bind(e),getQueryObject:e.getQueryObjectEXT.bind(e),queryCounter:e.queryCounterEXT.bind(e)})}this._query=this._timerQuery?this._timerQuery.createQuery():null}get gpuTimerSupported(){return!!this._query}begin(){1===this._state&&this.end(),this._query&&this._timerQuery.beginQuery(35007,this._query),this._gpuTime=null,this._state=1}end(){1===this._state&&(this._query&&this._timerQuery.endQuery(35007),this._state=2)}ended(){return 1!==this._state}elapsed(){if(2===this._state&&null===this._gpuTime&&this._query&&this._timerQuery.getQueryObject(this._query,yn.QUERY_RESULT_AVAILABLE)){this._device.context.getParameter(36795)||(this._gpuTime=Number(this._timerQuery.getQueryObject(this._query,yn.QUERY_RESULT))/1e6)}return this._gpuTime}}class ha{_isWebGL2;_extDrawBuffers;_extFloatBlending;_extRenderMipmap;maxDrawBuffers;maxColorAttachmentBytesPerSample;supportRenderMipmap;supportMultisampledFramebuffer;supportFloatBlending;supportDepth32float;supportDepth32floatStencil8;constructor(e){this._isWebGL2=An(e),this._extDrawBuffers=this._isWebGL2?null:e.getExtension("WEBGL_draw_buffers"),this._extFloatBlending=e.getExtension("EXT_float_blend"),this._extRenderMipmap=this._isWebGL2?null:e.getExtension("OES_fbo_render_mipmap"),this.maxDrawBuffers=this._isWebGL2||this._extDrawBuffers?Math.min(e.getParameter(yn.MAX_COLOR_ATTACHMENTS),e.getParameter(yn.MAX_DRAW_BUFFERS)):1,this.maxColorAttachmentBytesPerSample=16*this.maxDrawBuffers,this.supportRenderMipmap=An(e)||!!this._extRenderMipmap,this.supportMultisampledFramebuffer=An(e),this.supportFloatBlending=!!this._extFloatBlending,this.supportDepth32float=this._isWebGL2,this.supportDepth32floatStencil8=this._isWebGL2}}class la{_isWebGL2;_extIndexUint32;_extBlendMinMax;supportOversizedViewport;supportBlendMinMax;support32BitIndex;supportDepthClamp;maxBindGroups;maxTexCoordIndex;constructor(e){this._isWebGL2=An(e),this._extBlendMinMax=null,this._extIndexUint32=e.getExtension("OES_element_index_uint"),this._isWebGL2?(this.supportBlendMinMax=!0,this.support32BitIndex=!0):(this._extBlendMinMax=e.getExtension("EXT_blend_minmax"),this.supportBlendMinMax=!!this._extBlendMinMax,this.support32BitIndex=!!this._extIndexUint32),this.supportOversizedViewport=!0,this.supportDepthClamp=!1,this.maxBindGroups=4,this.maxTexCoordIndex=8}}class ca{_extFragDepth;_extStandardDerivatives;_extShaderTextureLod;supportFragmentDepth;supportStandardDerivatives;supportShaderTextureLod;supportHighPrecisionFloat;supportHighPrecisionInt;maxUniformBufferSize;uniformBufferOffsetAlignment;maxStorageBufferSize;storageBufferOffsetAlignment;constructor(e){this._extFragDepth=null,this._extStandardDerivatives=null,this.maxStorageBufferSize=0,this.storageBufferOffsetAlignment=0,An(e)?(this.supportFragmentDepth=!0,this.supportStandardDerivatives=!0,this.supportShaderTextureLod=!0,this.supportHighPrecisionFloat=!0,this.maxUniformBufferSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE)||16384,this.uniformBufferOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT)||256):(this._extFragDepth=e.getExtension("EXT_frag_depth"),this.supportFragmentDepth=!!this._extFragDepth,this._extStandardDerivatives=e.getExtension("OES_standard_derivatives"),this.supportStandardDerivatives=!!this._extStandardDerivatives,this._extShaderTextureLod=e.getExtension("EXT_shader_texture_lod"),this.supportShaderTextureLod=!!this._extShaderTextureLod,this.supportHighPrecisionFloat=e.getShaderPrecisionFormat&&!!e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT)?.precision&&!!e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT)?.precision,this.maxUniformBufferSize=0,this.uniformBufferOffsetAlignment=1)}}class _a{_isWebGL2;_extS3TC;_extS3TCSRGB;_extBPTC;_extRGTC;_extASTC;_extTextureFilterAnisotropic;_extDepthTexture;_extSRGB;_extTextureFloat;_extTextureFloatLinear;_extTextureHalfFloat;_extTextureHalfFloatLinear;_textureFormatInfos;maxTextureSize;maxCubeTextureSize;npo2Mipmapping;npo2Repeating;supportS3TC;supportS3TCSRGB;supportBPTC;supportRGTC;supportASTC;supportDepthTexture;support3DTexture;supportSRGBTexture;supportFloatTexture;supportLinearFloatTexture;supportHalfFloatTexture;supportLinearHalfFloatTexture;supportAnisotropicFiltering;supportFloatColorBuffer;supportHalfFloatColorBuffer;supportFloatBlending;constructor(e){if(this._isWebGL2=An(e),this._extTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.supportAnisotropicFiltering=!!this._extTextureFilterAnisotropic,this._isWebGL2?this.supportDepthTexture=!0:(this._extDepthTexture=e.getExtension("WEBGL_depth_texture"),this.supportDepthTexture=!!this._extDepthTexture),this.support3DTexture=this._isWebGL2,this._extSRGB=this._isWebGL2?null:e.getExtension("EXT_sRGB"),this.supportSRGBTexture=this._isWebGL2||!!this._extSRGB,this._isWebGL2?this.supportFloatTexture=!0:(this._extTextureFloat=e.getExtension("OES_texture_float"),this.supportFloatTexture=!!this._extTextureFloat),this._extTextureFloatLinear=e.getExtension("OES_texture_float_linear"),this.supportLinearFloatTexture=!!this._extTextureFloatLinear,this._isWebGL2?(this.supportHalfFloatTexture=!0,this.supportLinearHalfFloatTexture=!0):(this._extTextureHalfFloat=e.getExtension("OES_texture_half_float"),this.supportHalfFloatTexture=!!this._extTextureHalfFloat,this._extTextureHalfFloatLinear=e.getExtension("OES_texture_half_float_linear"),this.supportLinearHalfFloatTexture=!!this._extTextureHalfFloatLinear),this._isWebGL2?e.getExtension("EXT_color_buffer_float")?(this.supportHalfFloatColorBuffer=!0,this.supportFloatColorBuffer=!0):e.getExtension("EXT_color_buffer_half_float")?(this.supportHalfFloatColorBuffer=!0,this.supportFloatColorBuffer=!1):(this.supportHalfFloatColorBuffer=!1,this.supportFloatColorBuffer=!1):(this.supportFloatColorBuffer=!!e.getExtension("WEBGL_color_buffer_float"),this.supportHalfFloatColorBuffer=!!e.getExtension("EXT_color_buffer_half_float")),this.supportFloatBlending=this.supportFloatColorBuffer&&!!e.getExtension("EXT_float_blend"),this._extS3TC=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),this.supportS3TC=!!this._extS3TC,this._extS3TCSRGB=e.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.supportS3TCSRGB=!!this._extS3TCSRGB,this._extBPTC=e.getExtension("EXT_texture_compression_bptc"),this.supportBPTC=!!this._extBPTC,this._extRGTC=e.getExtension("EXT_texture_compression_rgtc"),this.supportRGTC=!!this._extRGTC,this._extASTC=e.getExtension("WEBGL_compressed_texture_astc"),this.supportASTC=!!this._extASTC,this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxCubeTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._isWebGL2?(this.npo2Mipmapping=!0,this.npo2Repeating=!0):(this.npo2Mipmapping=!1,this.npo2Repeating=!1),this._textureFormatInfos={rgba8unorm:{glFormat:e.RGBA,glInternalFormat:this._isWebGL2?e.RGBA8:e.RGBA,glType:[e.UNSIGNED_BYTE,e.UNSIGNED_SHORT_4_4_4_4,e.UNSIGNED_SHORT_5_5_5_1],filterable:!0,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4}},this.supportASTC)for(const t of["4x4","5x4","5x5","6x5","6x6","8x5","8x6","8x8","10x5","10x6","10x8","10x10","12x10","12x12"]){const[r,s]=t.split("x").map(e=>Number(e));this._textureFormatInfos[`astc-${t}`]={glFormat:e.NONE,glInternalFormat:this._extASTC[`COMPRESSED_RGBA_ASTC_${t}_KHR`],glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:r,blockHeight:s},this._textureFormatInfos[`astc-${t}-srgb`]={glFormat:e.NONE,glInternalFormat:this._extASTC[`COMPRESSED_SRGB8_ALPHA8_ASTC_${t}_KHR`],glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:r,blockHeight:s}}this.supportS3TC&&(this._textureFormatInfos.dxt1={glFormat:e.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:8,blockWidth:4,blockHeight:4},this._textureFormatInfos.dxt3={glFormat:e.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos.dxt5={glFormat:e.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4}),this.supportS3TCSRGB&&(this._textureFormatInfos["dxt1-srgb"]={glFormat:e.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:8,blockWidth:4,blockHeight:4},this._textureFormatInfos["dxt3-srgb"]={glFormat:e.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["dxt5-srgb"]={glFormat:e.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4}),this.supportRGTC&&(this._textureFormatInfos.bc4={glFormat:e.NONE,glInternalFormat:this._extRGTC.COMPRESSED_RED_RGTC1_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:8,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc4-signed"]={glFormat:e.NONE,glInternalFormat:this._extRGTC.COMPRESSED_SIGNED_RED_RGTC1_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:8,blockWidth:4,blockHeight:4},this._textureFormatInfos.bc5={glFormat:e.NONE,glInternalFormat:this._extRGTC.COMPRESSED_RED_GREEN_RGTC2_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc5-signed"]={glFormat:e.NONE,glInternalFormat:this._extRGTC.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4}),this.supportBPTC&&(this._textureFormatInfos.bc6h={glFormat:e.NONE,glInternalFormat:this._extBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc6h-signed"]={glFormat:e.NONE,glInternalFormat:this._extBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos.bc7={glFormat:e.NONE,glInternalFormat:this._extBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc7-srgb"]={glFormat:e.NONE,glInternalFormat:this._extBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT,glType:[e.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4}),An(e)?(this._textureFormatInfos.r8unorm={glFormat:e.RED,glInternalFormat:e.R8,glType:[e.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r8snorm={glFormat:e.RED,glInternalFormat:e.R8_SNORM,glType:[e.BYTE],filterable:!0,renderable:!1,compressed:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r16f={glFormat:e.RED,glInternalFormat:e.R16F,glType:[e.HALF_FLOAT,e.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.r32f={glFormat:e.RED,glInternalFormat:e.R32F,glType:[e.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.r8ui={glFormat:e.RED_INTEGER,glInternalFormat:e.R8UI,glType:[e.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r8i={glFormat:e.RED_INTEGER,glInternalFormat:e.R8I,glType:[e.BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r16ui={glFormat:e.RED_INTEGER,glInternalFormat:e.R16UI,glType:[e.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.r16i={glFormat:e.RED_INTEGER,glInternalFormat:e.R16I,glType:[e.SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.r32ui={glFormat:e.RED_INTEGER,glInternalFormat:e.R32UI,glType:[e.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.r32i={glFormat:e.RED_INTEGER,glInternalFormat:e.R32I,glType:[e.INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg8unorm={glFormat:e.RG,glInternalFormat:e.RG8,glType:[e.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg8snorm={glFormat:e.RG,glInternalFormat:e.RG8_SNORM,glType:[e.BYTE],filterable:!0,renderable:!1,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg16f={glFormat:e.RG,glInternalFormat:e.RG16F,glType:[e.HALF_FLOAT,e.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg32f={glFormat:e.RG,glInternalFormat:e.RG32F,glType:[e.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rg8ui={glFormat:e.RG,glInternalFormat:e.RG8UI,glType:[e.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg8i={glFormat:e.RG,glInternalFormat:e.RG8I,glType:[e.BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg16ui={glFormat:e.RG,glInternalFormat:e.RG16UI,glType:[e.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg16i={glFormat:e.RG,glInternalFormat:e.RG16I,glType:[e.SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg32ui={glFormat:e.RG,glInternalFormat:e.RG32UI,glType:[e.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rg32i={glFormat:e.RG,glInternalFormat:e.RG32I,glType:[e.INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos["rgba8unorm-srgb"]={glFormat:e.RGBA,glInternalFormat:e.SRGB8_ALPHA8,glType:[e.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rgba8snorm={glFormat:e.RGBA,glInternalFormat:e.RGBA8_SNORM,glType:[e.BYTE],filterable:!0,renderable:!1,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rgba16f={glFormat:e.RGBA,glInternalFormat:e.RGBA16F,glType:[e.HALF_FLOAT,e.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rgba32f={glFormat:e.RGBA,glInternalFormat:e.RGBA32F,glType:[e.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:16},this._textureFormatInfos.rgba8ui={glFormat:e.RGBA_INTEGER,glInternalFormat:e.RGBA8UI,glType:[e.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rgba8i={glFormat:e.RGBA_INTEGER,glInternalFormat:e.RGBA8I,glType:[e.BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rgba16ui={glFormat:e.RGBA_INTEGER,glInternalFormat:e.RGBA16UI,glType:[e.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rgba16i={glFormat:e.RGBA_INTEGER,glInternalFormat:e.RGBA16I,glType:[e.SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rgba32ui={glFormat:e.RGBA_INTEGER,glInternalFormat:e.RGBA32UI,glType:[e.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:16},this._textureFormatInfos.rgba32i={glFormat:e.RGBA_INTEGER,glInternalFormat:e.RGBA32I,glType:[e.INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:16},this._textureFormatInfos.rg11b10uf={glFormat:e.RGB,glInternalFormat:e.R11F_G11F_B10F,glType:[e.UNSIGNED_INT_10F_11F_11F_REV],filterable:!0,renderable:!1,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d16={glFormat:e.DEPTH_COMPONENT,glInternalFormat:e.DEPTH_COMPONENT16,glType:[e.UNSIGNED_SHORT,e.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.d24={glFormat:e.DEPTH_COMPONENT,glInternalFormat:e.DEPTH_COMPONENT24,glType:[e.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d32f={glFormat:e.DEPTH_COMPONENT,glInternalFormat:e.DEPTH_COMPONENT32F,glType:[e.FLOAT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d24s8={glFormat:e.DEPTH_STENCIL,glInternalFormat:e.DEPTH24_STENCIL8,glType:[e.UNSIGNED_INT_24_8],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d32fs8={glFormat:e.DEPTH_STENCIL,glInternalFormat:e.DEPTH32F_STENCIL8,glType:[e.FLOAT_32_UNSIGNED_INT_24_8_REV],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:8}):(this.supportFloatTexture&&(this._textureFormatInfos.rgba32f={glFormat:e.RGBA,glInternalFormat:e.RGBA,glType:[e.FLOAT,e.UNSIGNED_BYTE,e.UNSIGNED_SHORT_4_4_4_4,e.UNSIGNED_SHORT_5_5_5_1],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:16}),this.supportHalfFloatTexture&&(this._textureFormatInfos.rgba16f={glFormat:e.RGBA,glInternalFormat:e.RGBA,glType:[this._extTextureHalfFloat.HALF_FLOAT_OES,e.UNSIGNED_BYTE,e.UNSIGNED_SHORT_4_4_4_4,e.UNSIGNED_SHORT_5_5_5_1],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:8}),this.supportSRGBTexture&&(this._textureFormatInfos["rgba8unorm-srgb"]={glFormat:this._extSRGB.SRGB_ALPHA_EXT,glInternalFormat:this._extSRGB.SRGB_ALPHA_EXT,glType:[e.UNSIGNED_BYTE],filterable:!0,renderable:!1,compressed:!1,blockWidth:1,blockHeight:1,size:4}),this.supportDepthTexture&&(this._textureFormatInfos.d16={glFormat:e.DEPTH_COMPONENT,glInternalFormat:e.DEPTH_COMPONENT,glType:[e.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.d24={glFormat:e.DEPTH_COMPONENT,glInternalFormat:e.DEPTH_COMPONENT,glType:[e.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d24s8={glFormat:e.DEPTH_STENCIL,glInternalFormat:e.DEPTH_STENCIL,glType:[this._extDepthTexture.UNSIGNED_INT_24_8_WEBGL],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4}))}calcMemoryUsage(e,t,r){switch(e){case"d16":case"d24":case"d24s8":case"d32f":return t===yn.UNSIGNED_SHORT?2*r:4*r;case"d32fs8":case"rg32f":case"rg32i":case"rg32ui":case"rgba16i":case"rgba16ui":return 8*r;case"dxt1":case"dxt1-srgb":return r/2;case"dxt3":case"dxt3-srgb":case"dxt5":case"dxt5-srgb":case"r8unorm":case"r8snorm":case"r8i":case"r8ui":return r;case"r16f":return t===yn.HALF_FLOAT?2*r:4*r;case"r16i":case"r16ui":case"rg8unorm":case"rg8snorm":case"rg8i":case"rg8ui":return 2*r;case"r32f":case"r32i":case"r32ui":case"rg16i":case"rg16ui":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8i":case"rgba8ui":return 4*r;case"rg16f":return t===yn.HALF_FLOAT?4*r:8*r;case"rgba16f":return t===yn.HALF_FLOAT?8*r:16*r;case"rgba32f":case"rgba32i":case"rgba32ui":return 16*r;default:return 0}}getTextureFormatInfo(e){return this._textureFormatInfos[e]}}class pa extends Zn{_structure;_data;constructor(e,t,r,s){if(!t?.isStructType())throw new Error("invalid structure type");if(r&jr.BF_INDEX)throw new Error("structured buffer must not have Index usage flag");if(r&(jr.BF_READ|jr.BF_WRITE|jr.BF_PACK_PIXEL|jr.BF_UNPACK_PIXEL))throw new Error("structured buffer must not have Read or Write usage flags");if(r&jr.BF_VERTEX){if(1!==t.structMembers.length||!t.structMembers[0].type.isArrayType())throw new Error("structured buffer for vertex usage must have only one array member");if(!pa.isValidArrayElementType(t.structMembers[0].type.elementType))throw new Error("invalid vertex data type when creating vertex buffer")}const i=t.toBufferLayout(0,t.layout);if(s&&i.byteSize!==s.byteLength)throw new Error(`create structured buffer failed: invalid source size: ${s.byteLength}, should be ${i.byteSize}`);const n=!e.isWebGL2&&0!==(r&jr.BF_UNIFORM);super(e,r,s||i.byteSize,n),this._data=new gn(i,n?this.systemMemoryBuffer:this),this._structure=t}set(e,t){this._data.set(e,t)}get structure(){return this._structure}set structure(e){if(e&&!e.isCompatibleType(this._structure)){const t=e.toBufferLayout(0,e.layout);if(t.byteSize>this.byteLength)throw new Error(`set structure type failed: new structure type is too large: ${t.byteSize}`);this._data=new gn(t,this),this._structure=e}}getUniformData(){return this._data}static isValidArrayElementType(e){if(e.isPrimitiveType())return e.scalarType!==X.BOOL&&!e.isMatrixType();if(e.isStructType()){for(const t of e.structMembers)if(!t.type.isPrimitiveType()||t.type.scalarType===X.BOOL||t.type.isMatrixType())return!1;return!0}return!1}}class fa extends Xn{_layout;_dynamicOffsets;_resources;_createdBuffers;constructor(e,t){super(e),this._device=e,this._layout=t,this._dynamicOffsets=null,this._resources={},this._object={},this._createdBuffers=[];for(const e of this._layout.entries)e.buffer&&e.buffer.hasDynamicOffset&&(this._dynamicOffsets||(this._dynamicOffsets=[]),this._dynamicOffsets[e.buffer.dynamicOffsetIndex]=0)}getGPUId(){return String(this._uid)}getLayout(){return this._layout}getBuffer(e,t=!0){return this._getBuffer(e,t)}getDynamicOffsets(){return this._dynamicOffsets}setBuffer(e,t,r,s,i){const n=this._layout.nameMap?.[e]??e;for(const s of this._layout.entries)if(s.name===n)return void(s.buffer?(!t||t.usage&jr.BF_UNIFORM?t!==this._resources[s.name]&&(this._resources[s.name]=t):console.error(`setBuffer() failed: buffer resource '${e}' must be type '${s.buffer.type}'`),s.buffer.hasDynamicOffset&&(this._dynamicOffsets[s.buffer.dynamicOffsetIndex]=r??0)):console.error(`setBuffer() failed: resource '${e}' is not buffer`));console.error(`setBuffer() failed: no buffer resource named '${e}'`)}setRawData(e,t,r,s,i){const n=this._layout.nameMap?.[e];if(n)this.setRawData(n,t,r,s,i);else{const n=this._getBuffer(e,!1);n?n.bufferSubData(t,r,s,i):console.error(`set(): no uniform buffer named '${e}'`)}}setValue(e,t){const r=this._layout.nameMap?.[e];if(r)this.setValue(r,{[e]:t});else{const r=this._getBuffer(e,!1);if(r){if(!(r instanceof pa))throw new Error(`BindGroup.setValue() failed: '${e}' is not structured buffer`);if(t?.BYTES_PER_ELEMENT)r.bufferSubData(0,t);else for(const e in t)r.set(e,t[e])}else console.error(`set(): no uniform buffer named '${e}'`)}}setTextureView(e,t,r,s,i,n){throw new Error("setTextureView() not supported for webgl device")}getTexture(e){if(this._findTextureLayout(e))return this._resources[e]?.[0]||null;throw new Error(`getTexture() failed:${e} is not a texture`)}setTexture(e,t,r){const s=this._findTextureLayout(e);s?this._resources[e]=[t,r||t.getDefaultSampler(!!s.texture?.autoBindSamplerComparison)]:console.error(`setTexture() failed: no texture uniform named '${e}'`)}setSampler(e,t){}apply(e,t){const r=this._device.isWebGL2,s=t??this.getDynamicOffsets();for(let t=0;t<this._layout.entries.length;t++){const i=this._layout.entries[t],n=this._resources[i.name];n instanceof Zn?r?i.buffer.hasDynamicOffset?e.setBlock(i.type.structName,n,s[i.buffer.dynamicOffsetIndex]):e.setBlock(i.type.structName,n,0):n instanceof pa&&e.setUniform(i.name,n.getUniformData().uniforms):Array.isArray(n)&&(n[0].isTextureVideo()&&n[0].updateVideoFrame(),e.setUniform(i.name,n))}}destroy(){this._resources={},this._object=null;for(const e of this._createdBuffers)e.dispose();this._createdBuffers=[]}restore(){this._object={}}isBindGroup(){return!0}_getBuffer(e,t=!1){const r=this._layout.nameMap?.[e]??e;for(const e of this._layout.entries)if(e.buffer&&e.name===r){let r=this._resources[e.name];return r||t||(r=this._device.createStructuredBuffer(e.type,{usage:"uniform"}),this._resources[e.name]=r,this._createdBuffers.push(r)),r}return null}_findTextureLayout(e){for(const t of this._layout.entries)if((t.texture||t.storageTexture||t.externalTexture)&&t.name===e)return t;return null}}class ma extends Xn{_vs;_fs;_unitCounter;_uniformSetters;_uniformInfo;_blockInfo;_bindGroupLayouts;_vertexAttributes;_error;_vertexShader;_fragmentShader;constructor(e,t,r,s,i){super(e),this._object=this._device.context.createProgram(),this._unitCounter=0,this._uniformSetters=null,this._uniformInfo=null,this._blockInfo=null,this._error="",this._vertexShader=null,this._fragmentShader=null,this._vs=t,this._fs=r,this._bindGroupLayouts=[...s],this._vertexAttributes=[...i],this.load()}get type(){return"render"}getCompileError(){return this._error}getShaderSource(e){switch(e){case"vertex":return this._vs;case"fragment":return this._fs;case"compute":return null}}getBindingInfo(e){for(let t=0;t<this._bindGroupLayouts.length;t++){const r=this._bindGroupLayouts[t],s=r.nameMap?.[e]??e;for(let e=0;e<r.entries.length;e++){const i=r.entries[e];if(i.name===s)return{group:t,binding:e,type:i.type}}}return null}get bindGroupLayouts(){return this._bindGroupLayouts}get vertexAttributes(){return this._vertexAttributes}setUniform(e,t){const r=this._uniformSetters[e];if(r)r(t);else{const r=Object.getPrototypeOf(t);r===Object.getPrototypeOf({})?this._setUniformStruct(e,t):r==Object.getPrototypeOf([])&&this._setUniformArray(e,t)}}setBlock(e,t,r){const s=this._blockInfo[e];s?this._device.bindUniformBuffer(s.index,t,r):console.error(`Block not found: ${e}`)}destroy(){this._object&&(this._device.context.deleteProgram(this._object),this._object=null,this._unitCounter=0,this._uniformSetters=null,this._uniformInfo=null,this._blockInfo=null,this._error="",this._vertexShader=null,this._fragmentShader=null)}restore(){this._object||this._device.isContextLost()||this.load()}isProgram(){return!0}use(){return!(this!==this._device.context._currentProgram&&!this.checkLoad())}createUniformBuffer(e){const t=this.getBindingInfo(e)?.type;return t?this.device.createStructuredBuffer(t,{usage:"uniform"}):null}_setUniformStruct(e,t){for(const r in t)this.setUniform(`${e}.${r}`,t[r])}_setUniformArray(e,t){for(let r=0;r<t.length;r++)this.setUniform(`${e}[${r}]`,t[r])}load(){if(this._device.isContextLost())return;const e=this._device.context;this._error=null,this._uniformSetters={},this._object||(this._object=this._device.context.createProgram()),this._vertexShader=e.createShader(yn.VERTEX_SHADER),e.attachShader(this._object,this._vertexShader),e.shaderSource(this._vertexShader,this._vs),e.compileShader(this._vertexShader),this._fragmentShader=e.createShader(yn.FRAGMENT_SHADER),e.attachShader(this._object,this._fragmentShader),e.shaderSource(this._fragmentShader,this._fs),e.compileShader(this._fragmentShader);for(let t=0;t<ts.length;t++)e.bindAttribLocation(this._object,t,ts[t]);e.linkProgram(this._object)}checkLoad(){if(!this._object)return!1;if(this._vertexShader){const e=this._device.context;if(this._device.isContextLost()||e.getProgramParameter(this._object,yn.LINK_STATUS)||(e.getShaderParameter(this._vertexShader,yn.COMPILE_STATUS)?e.getShaderParameter(this._fragmentShader,yn.COMPILE_STATUS)?(this._error=e.getProgramInfoLog(this._object),console.error(new Error(`Load program failed: \n${this._error}`))):(this._error=e.getShaderInfoLog(this._fragmentShader),console.error(new Error(`Compile shader failed: ${this._error}`))):(this._error=e.getShaderInfoLog(this._vertexShader),console.error(new Error(`Compile shader failed: ${this._error}`)))),e.deleteShader(this._vertexShader),this._vertexShader=null,e.deleteShader(this._fragmentShader),this._fragmentShader=null,this._error)return e.deleteProgram(this._object),this._object=null,!1;this._device.context._currentProgram=this,this._device.context.useProgram(this._object),this._uniformSetters=this.createUniformSetters()}else this._device.context._currentProgram=this,this._device.context.useProgram(this._object);return!0}createUniformSetter(e){const t=e.location,r=e.isArray,s=this._device.context;switch(e.type){case yn.FLOAT:return this.getUniformSetterfv(t);case yn.FLOAT_VEC2:return this.getUniformSetter2fv(t);case yn.FLOAT_VEC3:return this.getUniformSetter3fv(t);case yn.FLOAT_VEC4:return this.getUniformSetter4fv(t);case yn.INT:return this.getUniformSetteriv(t);case yn.INT_VEC2:return this.getUniformSetter2iv(t);case yn.INT_VEC3:return this.getUniformSetter3iv(t);case yn.INT_VEC4:return this.getUniformSetter4iv(t);case yn.UNSIGNED_INT:return this.getUniformSetteruiv(t);case yn.UNSIGNED_INT_VEC2:return this.getUniformSetter2uiv(t);case yn.UNSIGNED_INT_VEC3:return this.getUniformSetter3uiv(t);case yn.UNSIGNED_INT_VEC4:return this.getUniformSetter4uiv(t);case yn.BOOL:return this.getUniformSetteriv(t);case yn.BOOL_VEC2:return this.getUniformSetter2iv(t);case yn.BOOL_VEC3:return this.getUniformSetter3iv(t);case yn.BOOL_VEC4:return this.getUniformSetter4iv(t);case yn.FLOAT_MAT2:return this.getUniformSetterMatrix2(t);case yn.FLOAT_MAT2x3:return this.getUniformSetterMatrix23(t);case yn.FLOAT_MAT2x4:return this.getUniformSetterMatrix24(t);case yn.FLOAT_MAT3:return this.getUniformSetterMatrix3(t);case yn.FLOAT_MAT3x2:return this.getUniformSetterMatrix32(t);case yn.FLOAT_MAT3x4:return this.getUniformSetterMatrix34(t);case yn.FLOAT_MAT4:return this.getUniformSetterMatrix4(t);case yn.FLOAT_MAT4x2:return this.getUniformSetterMatrix42(t);case yn.FLOAT_MAT4x3:return this.getUniformSetterMatrix43(t);case yn.SAMPLER_2D:case yn.SAMPLER_2D_SHADOW:case yn.INT_SAMPLER_2D:case yn.UNSIGNED_INT_SAMPLER_2D:{const i=this._unitCounter;if(this._unitCounter+=e.size,!r)return s.uniform1i(t,i),this.getSamplerSetter(t,yn.TEXTURE_2D,i)}case yn.SAMPLER_2D_ARRAY:case yn.SAMPLER_2D_ARRAY_SHADOW:case yn.INT_SAMPLER_2D_ARRAY:case yn.UNSIGNED_INT_SAMPLER_2D_ARRAY:{const i=this._unitCounter;if(this._unitCounter+=e.size,!r)return s.uniform1i(t,i),this.getSamplerSetter(t,yn.TEXTURE_2D_ARRAY,i)}case yn.SAMPLER_CUBE:case yn.SAMPLER_CUBE_SHADOW:case yn.INT_SAMPLER_CUBE:case yn.UNSIGNED_INT_SAMPLER_CUBE:{const i=this._unitCounter;if(this._unitCounter+=e.size,!r)return s.uniform1i(t,i),this.getSamplerSetter(t,yn.TEXTURE_CUBE_MAP,i)}case yn.SAMPLER_3D:case yn.INT_SAMPLER_3D:case yn.UNSIGNED_INT_SAMPLER_3D:{const i=this._unitCounter;if(this._unitCounter+=e.size,!r)return s.uniform1i(t,i),this.getSamplerSetter(t,yn.TEXTURE_3D,i)}}return console.error(`Error: unsupported uniform type: ${e.name}`),null}createUniformSetters(){const e={},t=this._device.context,r=t.getProgramParameter(this._object,yn.ACTIVE_UNIFORMS);this._uniformInfo=[];for(let s=0;s<r;s++){const r=t.getActiveUniform(this._object,s);let i=r.name,n=!1;if(i.startsWith("gl_")||i.startsWith("webgl_"))this._uniformInfo.push(null);else{"[0]"===i.substr(-3)&&(i=i.substr(0,i.length-3),n=!0);const a=r.size,o=r.type,u=-1,h=0,l=t.getUniformLocation(this._object,r.name),c=null,{ctor:_,elementSize:p}=this.getTypedArrayInfo(r.type),f={index:s,name:i,size:a,type:o,blockIndex:u,offset:h,isArray:n,location:l,view:c,viewCtor:_,viewElementSize:p};this._uniformInfo.push(f),l&&(e[i]=this.createUniformSetter(f))}}if(An(t)){this._blockInfo={};const e=t.getProgramParameter(this._object,yn.ACTIVE_UNIFORM_BLOCKS);for(let r=0;r<e;r++){const e=t.getActiveUniformBlockName(this._object,r),s=t.getUniformBlockIndex(this._object,e),i=!!t.getActiveUniformBlockParameter(this._object,r,yn.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER),n=!!t.getActiveUniformBlockParameter(this._object,r,yn.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER),a=i||n,o=t.getActiveUniformBlockParameter(this._object,r,yn.UNIFORM_BLOCK_DATA_SIZE),u=t.getActiveUniformBlockParameter(this._object,r,yn.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES);this._blockInfo[e]={index:s,used:a,size:o,uniformIndices:u},t.uniformBlockBinding(this._object,s,s)}}return e}getUniformSetterfv(e){return t=>{this._device.context.uniform1fv(e,t)}}getUniformSetter2fv(e){return t=>{this._device.context.uniform2fv(e,t)}}getUniformSetter3fv(e){return t=>{this._device.context.uniform3fv(e,t)}}getUniformSetter4fv(e){return t=>{this._device.context.uniform4fv(e,t)}}getUniformSetteriv(e){return t=>{this._device.context.uniform1iv(e,t)}}getUniformSetter2iv(e){return t=>{this._device.context.uniform2iv(e,t)}}getUniformSetter3iv(e){return t=>{this._device.context.uniform3iv(e,t)}}getUniformSetter4iv(e){return t=>{this._device.context.uniform4iv(e,t)}}getUniformSetteruiv(e){return t=>{this._device.context.uniform1uiv(e,t)}}getUniformSetter2uiv(e){return t=>{this._device.context.uniform2uiv(e,t)}}getUniformSetter3uiv(e){return t=>{this._device.context.uniform3uiv(e,t)}}getUniformSetter4uiv(e){return t=>{this._device.context.uniform4uiv(e,t)}}getUniformSetterMatrix2(e){return t=>{this._device.context.uniformMatrix2fv(e,!1,t)}}getUniformSetterMatrix23(e){return t=>{this._device.context.uniformMatrix2x3fv(e,!1,t)}}getUniformSetterMatrix24(e){return t=>{this._device.context.uniformMatrix2x4fv(e,!1,t)}}getUniformSetterMatrix32(e){return t=>{this._device.context.uniformMatrix3x2fv(e,!1,t)}}getUniformSetterMatrix3(e){return t=>{this._device.context.uniformMatrix3fv(e,!1,t)}}getUniformSetterMatrix34(e){return t=>{this._device.context.uniformMatrix3x4fv(e,!1,t)}}getUniformSetterMatrix42(e){return t=>{this._device.context.uniformMatrix4x2fv(e,!1,t)}}getUniformSetterMatrix43(e){return t=>{this._device.context.uniformMatrix4x3fv(e,!1,t)}}getUniformSetterMatrix4(e){return t=>{this._device.context.uniformMatrix4fv(e,!1,t)}}getSamplerSetter(e,t,r){return e=>this._device.bindTexture(t,r,e[0],e[1])}getTypedArrayInfo(e){let t=null,r=0;switch(e){case yn.INT:t=Int32Array,r=4;break;case yn.INT_VEC2:t=Int32Array,r=8;break;case yn.INT_VEC3:t=Int32Array,r=12;break;case yn.INT_VEC4:t=Int32Array,r=16;break;case yn.UNSIGNED_INT:case yn.BOOL:t=Uint32Array,r=4;break;case yn.UNSIGNED_INT_VEC2:case yn.BOOL_VEC2:t=Uint32Array,r=8;break;case yn.UNSIGNED_INT_VEC3:case yn.BOOL_VEC3:t=Uint32Array,r=12;break;case yn.UNSIGNED_INT_VEC4:case yn.BOOL_VEC4:t=Uint32Array,r=16;break;case yn.FLOAT:t=Float32Array,r=4;break;case yn.FLOAT_VEC2:t=Float32Array,r=8;break;case yn.FLOAT_VEC3:t=Float32Array,r=12;break;case yn.FLOAT_VEC4:case yn.FLOAT_MAT2:t=Float32Array,r=16;break;case yn.FLOAT_MAT2x3:case yn.FLOAT_MAT3x2:t=Float32Array,r=24;break;case yn.FLOAT_MAT2x4:case yn.FLOAT_MAT4x2:t=Float32Array,r=32;break;case yn.FLOAT_MAT3:t=Float32Array,r=36;break;case yn.FLOAT_MAT3x4:case yn.FLOAT_MAT4x3:t=Float32Array,r=48;break;case yn.FLOAT_MAT4:t=Float32Array,r=64}return{ctor:t,elementSize:r}}}class da extends Xn{_options;constructor(e,t){super(e),this._options=Object.assign({addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:"nearest",minFilter:"nearest",mipFilter:"none",lodMin:0,lodMax:32,compare:null,maxAnisotropy:1},t||{}),this._load()}get addressModeU(){return this._options.addressU}get addressModeV(){return this._options.addressV}get addressModeW(){return this._options.addressW}get magFilter(){return this._options.magFilter}get minFilter(){return this._options.minFilter}get mipFilter(){return this._options.mipFilter}get lodMin(){return this._options.lodMin}get lodMax(){return this._options.lodMax}get compare(){return this._options.compare}get maxAnisotropy(){return this._options.maxAnisotropy}destroy(){this._object&&An(this._device.context)&&this._device.context.deleteSampler(this._object),this._object=null}restore(){this._object||this._device.isContextLost()||this._load()}apply(e){if(e?.object&&!this._device.isWebGL2&&!this._device.isContextLost()){const t=this._device.context,r=Un[e.target];this._device.bindTexture(r,0,e),t.texParameteri(r,yn.TEXTURE_WRAP_S,Mn[this._options.addressU]),t.texParameteri(r,yn.TEXTURE_WRAP_T,Mn[this._options.addressV]),t.texParameteri(r,yn.TEXTURE_MAG_FILTER,Gn(this._options.magFilter)),t.texParameteri(r,yn.TEXTURE_MIN_FILTER,Pn(this._options.minFilter,this._options.mipFilter)),this._device.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&t.texParameterf(r,yn.TEXTURE_MAX_ANISOTROPY,this._options.maxAnisotropy)}}_load(){if(!An(this._device.context))return this._object={},!0;if(!this._device.isContextLost()){const e=this._device.context;this._object||(this._object=e.createSampler()),e.samplerParameteri(this._object,yn.TEXTURE_WRAP_S,Mn[this._options.addressU]),e.samplerParameteri(this._object,yn.TEXTURE_WRAP_T,Mn[this._options.addressV]),e.samplerParameteri(this._object,yn.TEXTURE_WRAP_R,Mn[this._options.addressW]),e.samplerParameteri(this._object,yn.TEXTURE_MAG_FILTER,Gn(this._options.magFilter)),e.samplerParameteri(this._object,yn.TEXTURE_MIN_FILTER,Pn(this._options.minFilter,this._options.mipFilter)),e.samplerParameterf(this._object,yn.TEXTURE_MIN_LOD,this._options.lodMin),e.samplerParameterf(this._object,yn.TEXTURE_MAX_LOD,this._options.lodMax),null===this._options.compare?e.samplerParameteri(this._object,yn.TEXTURE_COMPARE_MODE,yn.NONE):(e.samplerParameteri(this._object,yn.TEXTURE_COMPARE_MODE,yn.COMPARE_REF_TO_TEXTURE),e.samplerParameteri(this._object,yn.TEXTURE_COMPARE_FUNC,Ln[this._options.compare])),this._device.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&e.samplerParameterf(this._object,yn.TEXTURE_MAX_ANISOTROPY,this._options.maxAnisotropy)}return!0}isSampler(){return!0}}class Ea{_device;_samplers;constructor(e){this._device=e,this._samplers={}}fetchSampler(e){const t=this.hash(e);let r=this._samplers[t];return r||(r=this.createSampler(e),this._samplers[t]=r),r}hash(e){return`${e.addressU?String(e.addressU):""}:${e.addressV?String(e.addressV):""}:${e.addressW?String(e.addressW):""}:${e.magFilter?String(e.magFilter):""}:${e.minFilter?String(e.minFilter):""}:${e.mipFilter?String(e.mipFilter):""}:${e.lodMin?String(e.lodMin):""}:${e.lodMax?String(e.lodMax):""}:${e.compare?String(e.compare):""}:${e.maxAnisotropy?String(e.maxAnisotropy):""}`}createSampler(e){return new da(this._device,e)}}const Ta=ie.getCachedTypeInfo(X.U16),xa=new Int32Array(4),ga=new Uint32Array(4);let ya=null,Aa=null;const ba=function(e){return function(){return class extends e{_listeners;constructor(...e){super(...e),this._listeners=null}on(e,t,r){t?this._listeners=this._internalAddEventListener(this._listeners,e,t,{context:r??null,once:!1}):console.error("Cannot set NULL listener")}once(e,t,r){t?this._listeners=this._internalAddEventListener(this._listeners,e,t,{context:r??null,once:!0}):console.error("Cannot set NULL listener")}off(e,t,r){this._internalRemoveEventListener(this._listeners,e,t,r??null)}dispatchEvent(e,...t){this._invokeLocalListeners(e,...t)}_internalAddEventListener(e,t,r,s){if("string"!=typeof t)return;e||(e={});const i=r,n={...s};let a=e[t];return a||(e[t]=a=[]),a.push({handler:i,options:n,removed:!1}),e}_internalRemoveEventListener(e,t,r,s){if("string"!=typeof t||!e)return;const i=r,n=e[t];if(n){for(let e=0;e<n.length;e++){const t=n[e];if(t.handler===i&&t.options.context===s){n.splice(e,1);break}}0===n.length&&(e[t]=void 0)}}_invokeLocalListeners(e,...t){if(!this._listeners)return;const r=this._listeners[e];if(r&&r.length>0){const e=r.slice();for(const r of e)r.handler.call(r.options?.context||this,...t),r.options.once&&(r.removed=!0);for(let e=r.length-1;e>=0;e--)r[e].removed&&r.splice(e,1)}}}}}(class extends xn{_context;_isWebGL2;_msaaSampleCount;_loseContextExtension;_contextLost;_isRendering;_dpr;_reverseWindingOrder;_deviceCaps;_vaoExt;_instancedArraysExt;_drawBuffersExt;_currentProgram;_currentVertexData;_currentStateSet;_currentBindGroups;_currentBindGroupOffsets;_currentViewport;_currentScissorRect;_samplerCache;_textureSamplerMap;_captureRenderBundle;_deviceUniformBuffers;_deviceUniformBufferOffsets;_bindTextures;_bindSamplers;_readFormats;_adapterInfo;constructor(e,t,r){super(t,e),this._dpr=Math.max(1,Math.floor(r?.dpr??window.devicePixelRatio)),this._isRendering=!1,this._captureRenderBundle=null,this._msaaSampleCount=r?.msaa?4:1;let s=null;if(s=this.canvas.getContext(e===Sa?"webgl":"webgl2",{antialias:!!r?.msaa,depth:!0,stencil:!0,premultipliedAlpha:!1}),!s)throw new Error("Invalid argument or no webgl support");this._isWebGL2=An(s),this._adapterInfo={vendor:s.getParameter(s.VENDOR),renderer:s.getParameter(s.RENDERER),version:s.getParameter(s.VERSION)},this._contextLost=!1,this._reverseWindingOrder=!1,this._deviceCaps=null,this._context=s,this._currentProgram=null,this._currentVertexData=null,this._currentStateSet=null,this._currentBindGroups=[],this._currentBindGroupOffsets=[],this._currentViewport=null,this._currentScissorRect=null,this._deviceUniformBuffers=[],this._deviceUniformBufferOffsets=[],this._bindTextures={[yn.TEXTURE_2D]:[],[yn.TEXTURE_CUBE_MAP]:[],[yn.TEXTURE_3D]:[],[yn.TEXTURE_2D_ARRAY]:[]},this._bindSamplers=[],this._samplerCache=new Ea(this),this._textureSamplerMap=new WeakMap,this._loseContextExtension=this._context.getExtension("WEBGL_lose_context"),this._readFormats={},this.canvas.addEventListener("webglcontextlost",e=>{this._contextLost=!0,e.preventDefault(),this.handleContextLost()},!1),this.canvas.addEventListener("webglcontextrestored",()=>{this._contextLost=!1,this.handleContextRestored()},!1)}get context(){return this._context}getAdapterInfo(){return this._adapterInfo}getFrameBufferSampleCount(){return this.getFramebuffer()?.getSampleCount()??this._msaaSampleCount}get isWebGL2(){return this._isWebGL2}get drawingBufferWidth(){return this.getDrawingBufferWidth()}get drawingBufferHeight(){return this.getDrawingBufferHeight()}get clientWidth(){return this.canvas.clientWidth}get clientHeight(){return this.canvas.clientHeight}getScale(){return this._dpr}isContextLost(){return this._contextLost}getDeviceCaps(){return this._deviceCaps}get vaoExt(){return this._vaoExt}get instancedArraysExt(){return this._instancedArraysExt}get drawBuffersExt(){return this._drawBuffersExt}getDrawingBufferWidth(){return this._context._currentFramebuffer?.getWidth()||this._context.drawingBufferWidth}getDrawingBufferHeight(){return this._context._currentFramebuffer?.getHeight()||this._context.drawingBufferHeight}getBackBufferWidth(){return this.canvas.width}getBackBufferHeight(){return this.canvas.height}invalidateBindingTextures(){this._bindTextures={[yn.TEXTURE_2D]:[],[yn.TEXTURE_CUBE_MAP]:[],[yn.TEXTURE_3D]:[],[yn.TEXTURE_2D_ARRAY]:[]}}bindTexture(e,t,r,s){const i=r?.object??null,n=this._context;if(n.activeTexture(yn.TEXTURE0+t),this._bindTextures[e][t]!==i&&(n.bindTexture(e,i),this._bindTextures[e][t]=i),this._isWebGL2){const e=s?.object??null;e&&this._bindSamplers[t]!==e&&(n.bindSampler(t,e),this._bindSamplers[t]=e)}else if(r&&s&&this._textureSamplerMap.get(r)!==s){const t=r.isWebGL1Fallback;this._textureSamplerMap.set(r,s),n.texParameteri(e,yn.TEXTURE_WRAP_S,Mn[s.addressModeU]),n.texParameteri(e,yn.TEXTURE_WRAP_T,Mn[s.addressModeV]),n.texParameteri(e,yn.TEXTURE_MAG_FILTER,Gn(s.magFilter)),n.texParameteri(e,yn.TEXTURE_MIN_FILTER,Pn(s.minFilter,t?"none":s.mipFilter)),this.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&n.texParameterf(e,yn.TEXTURE_MAX_ANISOTROPY,s.maxAnisotropy)}}bindUniformBuffer(e,t,r){this._deviceUniformBuffers[e]===t.object&&this._deviceUniformBufferOffsets[e]===r||(r?this.context.bindBufferRange(yn.UNIFORM_BUFFER,e,t.object,r,t.byteLength-r):this.context.bindBufferBase(yn.UNIFORM_BUFFER,e,t.object),this._deviceUniformBuffers[e]=t.object,this._deviceUniformBufferOffsets[e]=r)}async initContext(){this.initContextState(),this.on("resize",()=>{const e=Math.max(1,Math.round(this.canvas.clientWidth*this._dpr)),t=Math.max(1,Math.round(this.canvas.clientHeight*this._dpr));e===this.canvas.width&&t===this.canvas.height||(this.canvas.width=e,this.canvas.height=t,this.setViewport(this._currentViewport),this.setScissor(this._currentScissorRect))}),this.dispatchEvent("resize",this.canvas.clientWidth,this.canvas.clientHeight)}clearFrameBuffer(e,t,r){const s=this._context,i=e?s.COLOR_BUFFER_BIT:0,n="number"==typeof t?s.DEPTH_BUFFER_BIT:0,a="number"==typeof r?s.STENCIL_BUFFER_BIT:0;if(i||n||a){if(na.applyDefaults(this._context),An(s)&&s._currentFramebuffer){if(n||a){s._currentFramebuffer.getDepthAttachment()&&s.clearBufferfi(yn.DEPTH_STENCIL,0,t??1,r??0)}if(i){const t=s._currentFramebuffer.getColorAttachments();for(let r=0;r<t.length;r++)v(t[r].format)?w(t[r].format)?(xa[0]=e[0],xa[1]=e[1],xa[2]=e[2],xa[3]=e[3],s.clearBufferiv(yn.COLOR,r,xa)):(ga[0]=e[0],ga[1]=e[1],ga[2]=e[2],ga[3]=e[3],s.clearBufferuiv(yn.COLOR,r,ga)):s.clearBufferfv(yn.COLOR,r,e)}}else i&&s.clearColor(e[0],e[1],e[2],e[3]),n&&s.clearDepth(t),a&&s.clearStencil(r),s.clear(i|n|a);s._currentFramebuffer?.tagDraw(),s._currentFramebuffer?.invalidateMipmaps()}}createGPUTimer(){return new ua(this)}createRenderStateSet(){return new oa(this._context)}createBlendingState(){return new sa}createColorState(){return new ra}createRasterizerState(){return new ia}createDepthState(){return new na}createStencilState(){return new aa}createSampler(e){return this._samplerCache.fetchSampler(e)}createTextureFromMipmapData(e,t,r){if(!e)return console.error("Device.createTextureFromMipmapData() failed: invalid data"),null;if(e.isCubemap){const s=new Yn(this);return s.createWithMipmapData(e,t,this.parseTextureOptions(r)),s.samplerOptions=r?.samplerOptions??null,s}if(e.isVolume){const t=new Hn(this);return t.createWithMipmapData(e,this.parseTextureOptions(r)),t.samplerOptions=r?.samplerOptions??null,t}if(e.isArray){const t=new zn(this);return t.createWithMipmapData(e,this.parseTextureOptions(r)),t.samplerOptions=r?.samplerOptions??null,t}{const s=new kn(this);return s.createWithMipmapData(e,t,this.parseTextureOptions(r)),s.samplerOptions=r?.samplerOptions??null,s}}createTexture2D(e,t,r,s){const i=s?.texture??new kn(this);return i.isTexture2D()?(i.createEmpty(e,t,r,this.parseTextureOptions(s)),i.samplerOptions=s?.samplerOptions??null,i):(console.error("createTexture2D() failed: options.texture must be 2d texture"),null)}createTexture2DFromImage(e,t,r){const s=r?.texture??new kn(this);return s.isTexture2D()?(s.loadFromElement(e,t,this.parseTextureOptions(r)),s.samplerOptions=r?.samplerOptions??null,s):(console.error("createTexture2DFromImage() failed: options.texture must be 2d texture"),null)}createTexture2DArray(e,t,r,s,i){const n=i?.texture??new zn(this);return n.isTexture2DArray()?(n.createEmpty(e,t,r,s,this.parseTextureOptions(i)),n.samplerOptions=i?.samplerOptions??null,n):(console.error("createTexture2DArray() failed: options.texture must be 2d array texture"),null)}createTexture2DArrayFromImages(e,t,r){if(!e||0===e.length)return console.error("createTexture2DArrayFromImages() failed: Invalid image elements"),null;let s=0,i=0;for(const t of e)if(0===s||0===i)s=t.width,i=t.height;else if(s!==t.width||i!==t.height)return console.error("createTexture2DArrayFromImages() failed: Image elements must have the same size"),null;if(r?.texture&&!r.texture.isTexture2DArray())return console.error("createTexture2DArrayFromImages() failed: options.texture must be 2d array texture"),null;let n=r?.texture;if(n){if(n.depth!==e.length)return console.error("createTexture2DArrayFromImages() failed: Layer count of options.texture not match the given image elements"),null;if(n.width!==s||n.height!==i)return console.error("createTexture2DArrayFromImages() failed: Size of options.texture not match the given image elements"),null}else{n=this.createTexture2DArray(t?"rgba8unorm-srgb":"rgba8unorm",s,i,e.length,r);for(let t=0;t<e.length;t++)n.updateFromElement(e[t],0,0,t,0,0,s,i)}return n.samplerOptions=r?.samplerOptions??null,n}createTexture3D(e,t,r,s,i){if(!this.isWebGL2)return console.error("device does not support 3d texture"),null;const n=i?.texture??new Hn(this);return n.isTexture3D()?(n.createEmpty(e,t,r,s,this.parseTextureOptions(i)),n.samplerOptions=i?.samplerOptions??null,n):(console.error("createTexture3D() failed: options.texture must be 3d texture"),null)}createCubeTexture(e,t,r){const s=r?.texture??new Yn(this);return s.isTextureCube()?(s.createEmpty(e,t,this.parseTextureOptions(r)),s.samplerOptions=r?.samplerOptions??null,s):(console.error("createCubeTexture() failed: options.texture must be cube texture"),null)}createTextureVideo(e,t){const r=new jn(this,e);return r.samplerOptions=t??null,r}copyFramebufferToTexture2D(e,t,r,s){if(!e?.isFramebuffer()||!r?.isTexture2D())return void console.error("copyFramebufferToTexture2D(): invalid framebuffer or texture");if(!Number.isInteger(s)||s<0||s>=r.mipLevelCount)return void console.error("copyFramebufferToTexture2D(): invalid mipmap level");const i=e.getColorAttachments()[t];if(!i||!i.isTexture2D())return void console.error("copyFramebufferToTexture2D(): Color attachment is not a 2D texture");const n=e.getColorAttachmentMipLevel(t),a=Math.max(i.width>>n,1),o=Math.max(i.height>>n,1),u=Math.max(r.width>>s,1),h=Math.max(r.height>>s,1);if(a!==u||o!==h)return void console.error("Source texture and destination texture must have same size");if(i.format!==r.format)return void console.error("copyFramebufferToTexture2D(): Color attachment must have same format with destination texture");if(t>0&&!this.isWebGL2)return void console.error("copyFramebufferToTexture2D(): Non-zero color attachment index requires WebGL2 or WebGPU device");this.pushDeviceStates(),this.setFramebuffer(null),this.setFramebuffer(e);const l=this._context;this.isWebGL2&&l.readBuffer(l.COLOR_ATTACHMENT0+t),this.bindTexture(l.TEXTURE_2D,0,r),l.copyTexSubImage2D(l.TEXTURE_2D,s,0,0,0,0,a,o),this.popDeviceStates()}copyTexture2D(e,t,r,s){if(!e||!r)return void console.error("CopyTexture2D(): invalid texture");if(!Number.isInteger(t)||t<0||t>=e.mipLevelCount)return void console.error("CopyTexture2D(): invalid source mipmap level");const i=this.createFrameBuffer([e],null);i.setColorAttachmentGenerateMipmaps(0,!1),i.setColorAttachmentMipLevel(0,t),this.copyFramebufferToTexture2D(i,0,r,s),i.dispose()}createGPUProgram(e){if("compute"===e.type)throw new Error("device does not support compute shader");const t=e.params;return new ma(this,t.vs,t.fs,t.bindGroupLayouts,t.vertexAttributes)}createBindGroup(e){return new fa(this,e)}createBuffer(e,t){return new Zn(this,this.parseBufferOptions(t),e,!this._isWebGL2)}copyBuffer(e,t,r,s,i){if(!this.isWebGL2)return void console.error("copyBuffer() is not supported for current device");const n=this._context;n.bindBuffer(n.COPY_READ_BUFFER,e.object),n.bindBuffer(n.COPY_WRITE_BUFFER,t.object),n.copyBufferSubData(n.COPY_READ_BUFFER,n.COPY_WRITE_BUFFER,r,s,i)}createIndexBuffer(e,t){return new Jn(this,e,this.parseBufferOptions(t,"index"))}createStructuredBuffer(e,t,r){return new pa(this,e,this.parseBufferOptions(t),r)}createVertexLayout(e){return new Kn(this,e)}createFrameBuffer(e,t,r){return new ea(this,e,t,r)}setBindGroup(e,t,r){if(r&&!An(this._context))throw new Error("setBindGroup(): no dynamic offset buffer support for WebGL1 device");this._currentBindGroups[e]=t,this._currentBindGroupOffsets[e]=r||null}getBindGroup(e){return[this._currentBindGroups[e],this._currentBindGroupOffsets[e]]}setViewport(e){null==e||!Array.isArray(e)&&e.default?this._currentViewport={x:0,y:0,width:this.deviceToScreen(this.drawingBufferWidth),height:this.deviceToScreen(this.drawingBufferHeight),default:!0}:Array.isArray(e)?this._currentViewport={x:e[0],y:e[1],width:e[2],height:e[3],default:!1}:this._currentViewport=Object.assign({default:!1},e),this._context.viewport(this.screenToDevice(this._currentViewport.x),this.screenToDevice(this._currentViewport.y),this.screenToDevice(this._currentViewport.width),this.screenToDevice(this._currentViewport.height))}getViewport(){return Object.assign({},this._currentViewport)}setScissor(e){null==e||!Array.isArray(e)&&e.default?this._currentScissorRect={x:0,y:0,width:this.deviceToScreen(this.drawingBufferWidth),height:this.deviceToScreen(this.drawingBufferHeight),default:!0}:Array.isArray(e)?this._currentScissorRect={x:e[0],y:e[1],width:e[2],height:e[3],default:!1}:this._currentScissorRect=Object.assign({default:!1},e),this._context.scissor(this.screenToDevice(this._currentScissorRect.x),this.screenToDevice(this._currentScissorRect.y),this.screenToDevice(this._currentScissorRect.width),this.screenToDevice(this._currentScissorRect.height))}getScissor(){return Object.assign({},this._currentScissorRect)}setProgram(e){this._currentProgram=e}getProgram(){return this._currentProgram}setVertexLayout(e){this._currentVertexData=e}getVertexLayout(){return this._currentVertexData}setRenderStates(e){this._currentStateSet=e}getRenderStates(){return this._currentStateSet}getFramebuffer(){return this._context._currentFramebuffer??null}reverseVertexWindingOrder(e){this._reverseWindingOrder!==!!e&&(this._reverseWindingOrder=!!e,this._context.frontFace(e?this._context.CW:this._context.CCW))}isWindingOrderReversed(){return!!this._reverseWindingOrder}flush(){this.context.flush()}async readPixels(e,t,r,s,i,n){const a=this.getFramebuffer(),o=a?a.getColorAttachments()[e]:null,u=o?o.format:"rgba8unorm";let h=this._readFormats[u];h||(h={format:this.context.getParameter(yn.IMPLEMENTATION_COLOR_READ_FORMAT),type:this.context.getParameter(yn.IMPLEMENTATION_COLOR_READ_TYPE)},this._readFormats[u]=h);const l=h.format,c=h.type,_=O(u);if((l!==yn.RGBA||c!==yn.UNSIGNED_BYTE&&c!==yn.FLOAT&&c!==yn.HALF_FLOAT)&&!An(this.context))throw new Error(`readPixels() failed: invalid format: ${u}`);const p=s*i*_;if(n.byteLength<p)throw new Error(`readPixels() failed: destination buffer must have at least ${p} bytes`);if(An(this.context)){const o=this.createBuffer(p,{usage:"pack-pixel",managed:!1});this.context.bindBuffer(yn.PIXEL_PACK_BUFFER,o.object),this.context.readBuffer(a?yn.COLOR_ATTACHMENT0+e:yn.COLOR_ATTACHMENT0),this.context.readPixels(t,r,s,i,l,c,0),this.context.bindBuffer(yn.PIXEL_PACK_BUFFER,null);const u=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);await o.getBufferSubData(u),o.dispose()}else this.context.readPixels(t,r,s,i,l,c,n)}readPixelsToBuffer(e,t,r,s,i,n){const a=this.getFramebuffer(),o=a?a.getColorAttachments()[e]:null,u=o?o.format:"rgba8unorm";let h=yn.NONE,l=yn.NONE;if(!An(this.context))throw new Error("readPixels() failed: readPixels() requires webgl2 device");if(L(u)||F(u))throw new Error(`readPixels() failed: invalid format: ${u}`);const c=function(e){return!!(1&C[e])}(u),_=function(e){return!!(2&C[e])}(u),p=function(e){return!!(4&C[e])}(u),f=function(e){return!!(8&C[e])}(u),m=(c?1:0)+(_?1:0)+(p?1:0)+(f?1:0),d=O(u)/m,E=v(u),T=N(u),x=w(u);c&&_&&p&&f?h=E?yn.RGBA_INTEGER:yn.RGBA:c&&_?h=E?yn.RG_INTEGER:yn.RG:c&&(h=E?yn.RED_INTEGER:yn.RED),1===d?l=x?yn.BYTE:yn.UNSIGNED_BYTE:2===d?l=T?yn.HALF_FLOAT:x?yn.SHORT:yn.UNSIGNED_SHORT:4===d&&(l=T?yn.FLOAT:x?yn.INT:yn.UNSIGNED_INT),this.context.bindBuffer(yn.PIXEL_PACK_BUFFER,n.object),this.context.readBuffer(a?yn.COLOR_ATTACHMENT0+e:yn.COLOR_ATTACHMENT0),this.context.readPixels(t,r,s,i,h,l,0),this.context.bindBuffer(yn.PIXEL_PACK_BUFFER,null)}looseContext(){this.context.isContextLost()||this._loseContextExtension?.loseContext()}restoreContext(){if(this.context.isContextLost()){this.clearErrors(),this._loseContextExtension?.restoreContext();const e=this.getError();e&&console.error(e)}}beginCapture(){if(this._captureRenderBundle)throw new Error("Device.beginCapture() failed: device is already capturing draw commands");this._captureRenderBundle=[]}endCapture(){if(!this._captureRenderBundle)throw new Error("Device.endCapture() failed: device is not capturing draw commands");const e=this._captureRenderBundle;return this._captureRenderBundle=null,e}_executeRenderBundle(e){for(const t of e){this.setProgram(t.program),this.setVertexLayout(t.vertexLayout),this.setRenderStates(t.renderStateSet);for(let e=0;e<4;e++)this.setBindGroup(e,t.bindGroups[e],t.bindGroupOffsets[e]);0===t.numInstances?this.draw(t.primitiveType,t.first,t.count):this.drawInstanced(t.primitiveType,t.first,t.count,t.numInstances)}return e.length}_setFramebuffer(e){e!==this._context._currentFramebuffer&&(this._context._currentFramebuffer?.unbind(),e?.bind())}onBeginFrame(){return this._contextLost&&(this._context.isContextLost()||(this._contextLost=!1,this.handleContextRestored())),!this._contextLost}nextFrame(e){return requestAnimationFrame(e)}cancelNextFrame(e){cancelAnimationFrame(e)}onEndFrame(){}_draw(e,t,r){if(this._currentVertexData){if(this._currentVertexData.bind(),this._currentProgram){if(!this._currentProgram.use())return;for(let e=0;e<this._currentProgram.bindGroupLayouts.length;e++){const t=this._currentBindGroups[e];if(!t)return void console.error(`Missing bind group (${e}) when drawing with program '${this._currentProgram.name}'`);{const r=this._currentBindGroupOffsets[e];t.apply(this._currentProgram,r)}}}this._currentStateSet?this._currentStateSet.apply():oa.applyDefaults(this._context);const s=this._currentVertexData.indexBuffer;s?this.context.drawElements(Dn[e],r,Bn[s.indexType.primitiveType],t*(s.indexType===Ta?2:4)):this.context.drawArrays(Dn[e],t,r),this._context._currentFramebuffer?.tagDraw(),this.getFramebuffer()?.invalidateMipmaps()}if(this._captureRenderBundle){const s=this._currentStateSet?.clone()??this.createRenderStateSet();if(this._reverseWindingOrder){const e=s.rasterizerState;e?"back"===e.cullMode?e.cullMode="front":"front"===e.cullMode&&(e.cullMode="back"):s.useRasterizerState().setCullMode("front")}this._captureRenderBundle.push({bindGroups:[...this._currentBindGroups],bindGroupOffsets:this._currentBindGroupOffsets.map(e=>e?[...e]:null),program:this._currentProgram,vertexLayout:this._currentVertexData,primitiveType:e,renderStateSet:s,count:r,first:t,numInstances:0})}}_drawInstanced(e,t,r,s){if(this.instancedArraysExt&&this._currentVertexData){if(this._currentVertexData.bind(),this._currentProgram){if(!this._currentProgram.use())return;for(let e=0;e<this._currentProgram.bindGroupLayouts.length;e++){const t=this._currentBindGroups[e];if(!t)return void console.error(`Missing bind group (${e}) when drawing with program '${this._currentProgram.name}'`);{const r=this._currentBindGroupOffsets[e];t.apply(this._currentProgram,r)}}}this._currentStateSet?.apply();const i=this._currentVertexData.indexBuffer;i?this.instancedArraysExt.drawElementsInstanced(Dn[e],r,Bn[i.indexType.primitiveType],t*(i.indexType===Ta?2:4),s):this.instancedArraysExt.drawArraysInstanced(Dn[e],t,r,s),this._context._currentFramebuffer?.tagDraw(),this._context._currentFramebuffer?.invalidateMipmaps()}this._captureRenderBundle&&this._captureRenderBundle.push({bindGroups:[...this._currentBindGroups],bindGroupOffsets:this._currentBindGroupOffsets.map(e=>e?[...e]:null),program:this._currentProgram,vertexLayout:this._currentVertexData,primitiveType:e,renderStateSet:this._currentStateSet?.clone()??null,count:r,first:t,numInstances:s})}_compute(){throw new Error("WebGL device does not support compute shader")}createInstancedArraysEXT(){const e=this._context;if(An(e))return{vertexAttribDivisor:e.vertexAttribDivisor.bind(e),drawArraysInstanced:e.drawArraysInstanced.bind(e),drawElementsInstanced:e.drawElementsInstanced.bind(e)};{const t=e.getExtension("ANGLE_instanced_arrays");return t?{vertexAttribDivisor:t.vertexAttribDivisorANGLE.bind(t),drawArraysInstanced:t.drawArraysInstancedANGLE.bind(t),drawElementsInstanced:t.drawElementsInstancedANGLE.bind(t)}:null}}createDrawBuffersEXT(){const e=this._context;if(An(e))return{drawBuffers:e.drawBuffers.bind(e)};{const t=e.getExtension("WEBGL_draw_buffers");return t?{drawBuffers:t.drawBuffersWEBGL.bind(t)}:null}}createVertexArrayObjectEXT(){const e=this._context;if(An(e))return{createVertexArray:e.createVertexArray.bind(e),bindVertexArray:e.bindVertexArray.bind(e),deleteVertexArray:e.deleteVertexArray.bind(e),isVertexArray:e.isVertexArray.bind(e)};{const t=e.getExtension("OES_vertex_array_object");return t?{createVertexArray:t.createVertexArrayOES.bind(t),bindVertexArray:t.bindVertexArrayOES.bind(t),deleteVertexArray:t.deleteVertexArrayOES.bind(t),isVertexArray:t.isVertexArrayOES.bind(t)}:null}}handleContextLost(){this._isRendering=this.isRendering,this.invalidateAll(),this.dispatchEvent("devicelost")}handleContextRestored(){console.info("handle context restored"),this.initContextState(),this._textureSamplerMap=new WeakMap,this._currentProgram=null,this._currentVertexData=null,this._currentStateSet=null,this._currentBindGroups=[],this._currentBindGroupOffsets=[],this._currentViewport=null,this._currentScissorRect=null,this._samplerCache=new Ea(this),this._isRendering&&(this._isRendering=!1,this.reloadAll(),this.dispatchEvent("devicerestored"))}initContextState(){this._deviceCaps={miscCaps:new la(this._context),framebufferCaps:new ha(this._context),shaderCaps:new ca(this._context),textureCaps:new _a(this._context)},this._vaoExt=this.createVertexArrayObjectEXT(),this._instancedArraysExt=this.createInstancedArraysEXT(),this._drawBuffersExt=this.createDrawBuffersEXT(),this._context.pixelStorei(yn.UNPACK_COLORSPACE_CONVERSION_WEBGL,yn.NONE),this._context.pixelStorei(yn.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),this.setViewport(null),this.setScissor(null),this._context.enable(yn.SCISSOR_TEST),this.enableGPUTimeRecording(!0),this._context._currentFramebuffer=void 0,this._context._currentProgram=void 0,this._deviceUniformBuffers=[],this._deviceUniformBufferOffsets=[],this._bindTextures={[yn.TEXTURE_2D]:[],[yn.TEXTURE_CUBE_MAP]:[],[yn.TEXTURE_3D]:[],[yn.TEXTURE_2D_ARRAY]:[]},this._bindSamplers=[]}clearErrors(){for(;this._context.getError(););}getCurrentSamplerForTexture(e){return this._textureSamplerMap.get(e)}setCurrentSamplerForTexture(e,t){this._textureSamplerMap.set(e,t)}getError(e){const t=this._context.getError(),r=t===yn.NO_ERROR?null:new bn(t);if(r&&e)throw r;return r}})();async function Ra(e,t,r){try{const s=new ba(e,t,r);return await s.initContext(),s.setViewport(),s.setScissor(),s}catch(e){return console.error(e),null}}const Sa={typeName:()=>"webgl",supported(){if(null===ya){const e=document.createElement("canvas"),t=e.getContext("webgl");ya=!!t,e.width=0,e.height=0}return ya},async createDevice(e,t){return Ra(this,e,t)}},Ca={typeName:()=>"webgl2",supported(){if(null===Aa){const e=document.createElement("canvas"),t=e.getContext("webgl2");Aa=!!t,e.width=0,e.height=0}return Aa},async createDevice(e,t){return Ra(this,e,t)}};!async function(){const e=document.querySelector("#canvas"),t=await Ca.createDevice(e),r=t.createVertexBuffer("position_f32x3",new Float32Array([-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1])),s=t.createVertexBuffer("normal_f32x3",new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0])),i=t.createVertexBuffer("tex0_f32x2",new Float32Array([0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0])),n=t.createIndexBuffer(new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23])),a=t.createVertexLayout({vertexBuffers:[{buffer:r},{buffer:s},{buffer:i}],indexBuffer:n}),o=document.createElement("img");o.src="https://cdn.zephyr3d.org/doc/assets/images/layer.jpg",o.crossOrigin="anonymous",await o.decode();const u=await createImageBitmap(o,{premultiplyAlpha:"none"}),_=t.createTexture2DFromImage(u,!0),f=t.buildRenderProgram({vertex(e){this.projMatrix=e.mat4().uniform(1),this.worldMatrix=e.mat4().uniform(1),this.$inputs.position=e.vec3().attrib("position"),this.$inputs.normal=e.vec3().attrib("normal"),this.$inputs.uv=e.vec2().attrib("texCoord0"),this.$outputs.uv=e.vec2(),this.$outputs.worldNormal=e.vec3(),e.main(function(){this.worldPos=e.mul(this.worldMatrix,e.vec4(this.$inputs.position,1)),this.$builtins.position=e.mul(this.projMatrix,this.worldPos),this.$outputs.worldNormal=e.mul(this.worldMatrix,e.vec4(this.$inputs.normal,0)).xyz,this.$outputs.uv=this.$inputs.uv})},fragment(e){this.tex=e.tex2D().uniform(0),this.lightdir=e.vec3().uniform(0),this.lightcolor=e.vec3().uniform(0),this.ambient=e.vec3().uniform(0),this.$outputs.color=e.vec4(),e.main(function(){this.sampleColor=e.textureSample(this.tex,this.$inputs.uv),this.NdotL=e.clamp(e.neg(e.dot(e.normalize(this.lightdir),e.normalize(this.$inputs.worldNormal))),0,1),this.finalColor=e.add(e.mul(this.sampleColor.rgb,this.lightcolor,this.NdotL),this.ambient),this.$outputs.color=e.vec4(e.pow(this.finalColor,e.vec3(1/2.2)),1)})}}),m=t.createBindGroup(f.bindGroupLayouts[0]);m.setValue("lightdir",new h(1,-1,-1).inplaceNormalize()),m.setValue("lightcolor",h.one()),m.setValue("ambient",new h(.01,.01,.01)),m.setTexture("tex",_);const d=t.createBindGroup(f.bindGroupLayouts[1]);t.runLoop(e=>{const t=.002*e.frameInfo.elapsedOverall,r=c.fromEulerAngle(t,t,0).toMatrix4x4();d.setValue("projMatrix",p.perspective(1.5,e.getDrawingBufferWidth()/e.getDrawingBufferHeight(),1,50)),d.setValue("worldMatrix",p.translateLeft(r,new h(0,0,-4))),e.clearFrameBuffer(new l(0,0,.5,1),1,0),e.setProgram(f),e.setVertexLayout(a),e.setBindGroup(0,m),e.setBindGroup(1,d),e.draw("triangle-list",0,36),e.drawText(`Device: ${e.type}`,30,30,"#ffffff"),e.drawText(`FPS: ${e.frameInfo.FPS.toFixed(2)}`,30,50,"#ffff00")})}();
//# sourceMappingURL=sample-1.js.map
