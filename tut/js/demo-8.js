const t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32",transparent:"rgba(0,0,0,0)"};function e(t,e){if(!t)throw new Error(e||"Assertion failed")}function i(t){let e="";for(let i=0;i<t.length;i++)e+=String.fromCharCode(t[i]);return btoa(e)}function s(t){const e=atob(t),i=new Uint8Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return i}function r(){if(crypto.randomUUID)return crypto.randomUUID();{const t=new Uint8Array(16);crypto.getRandomValues(t),t[6]=15&t[6]|64,t[8]=63&t[8]|128;const e=[...t].map(t=>t.toString(16).padStart(2,"0"));return[e.slice(0,4).join(""),e.slice(4,6).join(""),e.slice(6,8).join(""),e.slice(8,10).join(""),e.slice(10,16).join("")].join("-")}}function a(t,...e){let i=t;for(const t of e)i=t(i);return i}function n(t){return null!==t&&"object"==typeof t&&!Array.isArray(t)}function o(t){return Array.isArray(t)}function h(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t}function l(t,e){return t===e}function u(t){if(o(t))return t.map(u);if(n(t)){const e={};for(const i of Object.keys(t))e[i]=u(t[i]);return e}return t}function c(t,e){const i=[];return d(t,e,[],i),i}function d(t,e,i,s){h(t)&&h(e)?l(t,e)||s.push({kind:"set",path:i,value:u(e)}):o(t)&&o(e)?function(t,e,i,s){const r=[],a=Math.min(t.length,e.length);for(let c=0;c<a;c++){const a=t[c],p=e[c];if(h(a)&&h(p))l(a,p)||r.push({op:"set",index:c,value:u(p)});else{if(o(a)&&o(p)||n(a)&&n(p)){const t=[];if(d(a,p,[],t),t.length>0)for(const e of t)if("arr"===e.kind||"set"===e.kind||"del"===e.kind){const t=[...i,c,...e.path];"arr"===e.kind?s.push({kind:"arr",path:t,ops:e.ops}):"set"===e.kind?s.push({kind:"set",path:t,value:e.value}):"del"===e.kind&&s.push({kind:"del",path:t})}continue}r.push({op:"set",index:c,value:u(p)})}}for(let t=a;t<e.length;t++)r.push({op:"ins",index:t,value:u(e[t])});for(let i=t.length-1;i>=e.length;i--)r.push({op:"del",index:i});r.length>0&&s.push({kind:"arr",path:i,ops:r})}(t,e,i,s):n(t)&&n(e)?function(t,e,i,s){const r=new Set([...Object.keys(t),...Object.keys(e)]);for(const a of r){const r=[...i,a],n=Object.prototype.hasOwnProperty.call(t,a),o=Object.prototype.hasOwnProperty.call(e,a);!n&&o?s.push({kind:"set",path:r,value:u(e[a])}):n&&!o?s.push({kind:"del",path:r}):d(t[a],e[a],r,s)}}(t,e,i,s):s.push({kind:"set",path:i,value:u(e)})}function p(t,e){let i=t;for(const t of e)i=i?.[t];return i}function m(t,e,i){if(0===e.length)return u(i);const s=function(t,e){let i=t;for(let t=0;t<e.length;t++){const s=e[t],r=e[t+1];s in i&&void 0!==i[s]&&null!==i[s]||(i[s]="number"==typeof r?[]:{}),i=i[s]}return i}(t,e.slice(0,-1));return s[e[e.length-1]]=u(i),t}function f(t,e){if(0===e.length)return;const i=p(t,e.slice(0,-1));if(null==i)return t;const s=e[e.length-1];return o(i)&&"number"==typeof s?s>=0&&s<i.length&&i.splice(s,1):n(i)&&delete i[s],t}function _(t,e){for(const i of e)"set"===i.op&&(t[i.index]=u(i.value));for(const i of e)"ins"===i.op&&t.splice(i.index,0,u(i.value));const i=e.filter(t=>"del"===t.op).sort((t,e)=>e.index-t.index);for(const e of i)e.index>=0&&e.index<t.length&&t.splice(e.index,1)}function g(t,e){let i=u(t);for(const t of e)if("set"===t.kind)i=m(i,t.path,t.value);else if("del"===t.kind)i=f(i,t.path);else if("arr"===t.kind){const e=p(i,t.path);if(o(e))_(e,t.ops);else{const e=x([],t.ops);i=m(i,t.path,e)}}return i}function x(t,e){const i=t.slice();return _(i,e),i}class b{_listeners;constructor(){this._listeners=null}on(t,e,i){e?this._listeners=this._internalAddEventListener(this._listeners,t,e,{context:i??null,once:!1}):console.error("Cannot set NULL listener")}once(t,e,i){e?this._listeners=this._internalAddEventListener(this._listeners,t,e,{context:i??null,once:!0}):console.error("Cannot set NULL listener")}off(t,e,i){this._internalRemoveEventListener(this._listeners,t,e,i??null)}dispatchEvent(t,...e){this._invokeLocalListeners(t,...e)}_internalAddEventListener(t,e,i,s){if("string"!=typeof e)return;t||(t={});const r=i,a={...s};let n=t[e];return n||(t[e]=n=[]),n.push({handler:r,options:a,removed:!1}),t}_internalRemoveEventListener(t,e,i,s){if("string"!=typeof e||!t)return;const r=i,a=t[e];if(a){for(let t=0;t<a.length;t++){const e=a[t];if(e.handler===r&&e.options.context===s){a.splice(t,1);break}}0===a.length&&(t[e]=void 0)}}_invokeLocalListeners(t,...e){if(!this._listeners)return;const i=this._listeners[t];if(i&&i.length>0){const t=i.slice();for(const i of t)i.handler.call(i.options?.context||this,...e),i.options.once&&(i.removed=!0);for(let t=i.length-1;t>=0;t--)i[t].removed&&i.splice(t,1)}}}function v(t){return function(){return class extends t{_listeners;constructor(...t){super(...t),this._listeners=null}on(t,e,i){e?this._listeners=this._internalAddEventListener(this._listeners,t,e,{context:i??null,once:!1}):console.error("Cannot set NULL listener")}once(t,e,i){e?this._listeners=this._internalAddEventListener(this._listeners,t,e,{context:i??null,once:!0}):console.error("Cannot set NULL listener")}off(t,e,i){this._internalRemoveEventListener(this._listeners,t,e,i??null)}dispatchEvent(t,...e){this._invokeLocalListeners(t,...e)}_internalAddEventListener(t,e,i,s){if("string"!=typeof e)return;t||(t={});const r=i,a={...s};let n=t[e];return n||(t[e]=n=[]),n.push({handler:r,options:a,removed:!1}),t}_internalRemoveEventListener(t,e,i,s){if("string"!=typeof e||!t)return;const r=i,a=t[e];if(a){for(let t=0;t<a.length;t++){const e=a[t];if(e.handler===r&&e.options.context===s){a.splice(t,1);break}}0===a.length&&(t[e]=void 0)}}_invokeLocalListeners(t,...e){if(!this._listeners)return;const i=this._listeners[t];if(i&&i.length>0){const t=i.slice();for(const i of t)i.handler.call(i.options?.context||this,...e),i.options.once&&(i.removed=!0);for(let t=i.length-1;t>=0;t--)i[t].removed&&i.splice(t,1)}}}}}const y=new ArrayBuffer(4),T=new Float32Array(y),w=new Uint32Array(y);function S(t){return t*Math.PI/180}function A(t){return 180*t/Math.PI}function C(t){return T[0]=t,T[0]}function E(t){return t%1==0&&t>=0&&!(t&t-1)}function M(t){return t<=0?1:(t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,(t|=t>>32)+1)}function B(t){T[0]=t;let e,i=w[0];const s=(2147483648&i)>>>16;if(i&=2147483647,i>=1199570944)e=31744|(i>2139095040?512|i>>>13&1023:0);else if(i<=855638016)e=0;else if(i<947912704){const t=125-(i>>>23);i=8388608|8388607&i,e=i>>>t+1;e+=i>>>t&1&(e|(i&(1<<t)-1?1:0))}else i+=3355443200,e=i+4095+(i>>>13&1)>>>13&32767;return e|s}function I(t,e,i){const s=[],r=[];T[0]=t,s[0]=w[0],T[0]=e,s[1]=w[0],T[0]=i,s[2]=w[0];for(let t=0;t<2;t++){const e=2147483648&s[t];let i=2147483647&s[t];if(2139095040&~i)if(e||i<897581056)r[t]=0;else if(i>1199439872)r[t]=1983;else{if(i<947912704){i=(8388608|8388607&i)>>>113-(i>>>23)}else i+=3355443200;r[t]=i+65535+(i>>>17&1)>>>17&2047}else r[t]=1984,8388607&i?r[t]=2047:e&&(r[t]=0)}const a=2147483648&s[2];let n=2147483647&s[2];if(2139095040&~n)if(a)r[2]=0;else if(n>1199308800)r[2]=991;else{if(n<947912704){n=(8388608|8388607&n)>>>113-(n>>>23)}else n+=3355443200;r[2]=n+131071+(n>>>18&1)>>>18&1023}else r[2]=992,8388607&n?r[2]=1023:(a||n<905969664)&&(r[2]=0);return 2047&r[0]|(2047&r[1])<<11|(1023&r[2])<<22}var P=function(t){return t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.TOP=3]="TOP",t[t.FRONT=4]="FRONT",t[t.BACK=5]="BACK",t}({}),$=function(t){return t[t.NOT_CLIPPED=0]="NOT_CLIPPED",t[t.A_INSIDE_B=1]="A_INSIDE_B",t[t.B_INSIDE_A=2]="B_INSIDE_A",t[t.CLIPPED=3]="CLIPPED",t}({}),R=function(t){return t[t.PX=0]="PX",t[t.NX=1]="NX",t[t.PY=2]="PY",t[t.NY=3]="NY",t[t.PZ=4]="PZ",t[t.NZ=5]="NZ",t}({});const F=new Float32Array([1,0,0,0,1,0,0,0,1]),D=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class N extends Float32Array{equalsTo(t,e){if(!t||this.length!==t.length)return!1;if(this===t)return!0;for(let i=0;i<this.length;i++){const s=this[i],r=t[i],a=e??1e-4*Math.max(1,Math.abs(s),Math.abs(r));if(Math.abs(s-r)>a)return!1}return!0}toString(){const t=[...this].map(t=>t.toFixed(3));return`${this.constructor.name}{${t.join(",")}}`}isNaN(){for(let t=0;t<this.length;t++)if(Number.isNaN(this[t]))return!0;return!1}setRandom(t,e){for(let i=0;i<this.length;i++)this[i]=t+(e-t)*Math.random()}}class L extends N{constructor(t,e){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,2);else if(super(2),"number"==typeof t&&"number"==typeof e)this[0]=t,this[1]=e;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=2)this[0]=t[0],this[1]=t[1];else if(void 0!==t)throw new Error("Vector2.constructor(): invalid arguments")}clone(){return new L(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get magnitude(){return Math.hypot(this[0],this[1])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]}setXY(t,e){return this[0]=t,this[1]=e,this}setAndNormalize(t,e){const i=Math.hypot(t,e);return this.setXY(t/i,e/i)}subBy(t){return L.sub(this,t,this),this}addBy(t){return L.add(this,t,this),this}combineBy(t,e,i){return L.combine(this,t,e,i,this),this}mulBy(t){return L.mul(this,t,this),this}divBy(t){return L.div(this,t,this),this}scaleBy(t){return L.scale(this,t,this),this}inplaceNormalize(){return L.normalize(this,this),this}inplaceInverse(){return L.inverse(this,this),this}inplaceMin(t){return L.min(this,t,this),this}inplaceMax(t){return L.max(this,t,this),this}static zero(){return new L(0,0)}static one(){return new L(1,1)}static axisPX(){return new L(1,0)}static axisNX(){return new L(-1,0)}static axisPY(){return new L(0,1)}static axisNY(){return new L(0,-1)}static distance(t,e){return Math.hypot(t.x-e.x,t.y-e.y)}static distanceSq(t,e){const i=t.x-e.x,s=t.y-e.y;return i*i+s*s}static normalize(t,e){const i=t.magnitude,s=t.x/i,r=t.y/i;return(e||new L).setXY(s,r)}static inverse(t,e){const i=1/t.x,s=1/t.y;return(e||new L).setXY(i,s)}static sub(t,e,i){const s=t.x-e.x,r=t.y-e.y;return(i||new L).setXY(s,r)}static add(t,e,i){const s=t.x+e.x,r=t.y+e.y;return(i||new L).setXY(s,r)}static combine(t,e,i,s,r){const a=t.x*i+e.x*s,n=t.y*i+e.y*s;return(r||new L).setXY(a,n)}static mul(t,e,i){const s=t.x*e.x,r=t.y*e.y;return(i||new L).setXY(s,r)}static div(t,e,i){const s=t.x/e.x,r=t.y/e.y;return(i||new L).setXY(s,r)}static scale(t,e,i){const s=t.x*e,r=t.y*e;return(i||new L).setXY(s,r)}static min(t,e,i){const s=t.x<e.x?t.x:e.x,r=t.y<e.y?t.y:e.y;return(i||new L).setXY(s,r)}static max(t,e,i){const s=t.x>e.x?t.x:e.x,r=t.y>e.y?t.y:e.y;return(i||new L).setXY(s,r)}static abs(t,e){const i=t.x<0?-t.x:t.x,s=t.y<0?-t.y:t.y;return(e||new L).setXY(i,s)}static dot(t,e){return t.x*e.x+t.y*e.y}static cross(t,e){return t.x*e.y-t.y*e.x}}class z extends N{constructor(t,e,i){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,3);else if(super(3),"number"==typeof t&&"number"==typeof e&&"number"==typeof i)this[0]=t,this[1]=e,this[2]=i;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=3)this[0]=t[0],this[1]=t[1],this[2]=t[2];else if(void 0!==t)throw new Error("Vector3.constructor(): invalid arguments")}clone(){return new z(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get magnitude(){return Math.hypot(this[0],this[1],this[2])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]}xy(){return new L(this.x,this.y)}setXYZ(t,e,i){return this[0]=t,this[1]=e,this[2]=i,this}setAndNormalize(t,e,i){const s=Math.hypot(t,e,i);return this.setXYZ(t/s,e/s,i/s)}subBy(t){return z.sub(this,t,this),this}addBy(t){return z.add(this,t,this),this}combineBy(t,e,i){return z.combine(this,t,e,i,this),this}mulBy(t){return z.mul(this,t,this),this}divBy(t){return z.div(this,t,this),this}scaleBy(t){return z.scale(this,t,this),this}inplaceNormalize(){return z.normalize(this,this),this}inplaceInverse(){return z.inverse(this,this),this}inplaceMin(t){return z.min(this,t,this),this}inplaceMax(t){return z.max(this,t,this),this}static zero(){return new z(0,0,0)}static one(){return new z(1,1,1)}static axisPX(){return new z(1,0,0)}static axisNX(){return new z(-1,0,0)}static axisPY(){return new z(0,1,0)}static axisNY(){return new z(0,-1,0)}static axisPZ(){return new z(0,0,1)}static axisNZ(){return new z(0,0,-1)}static distance(t,e){return Math.hypot(t.x-e.x,t.y-e.y,t.z-e.z)}static distanceSq(t,e){const i=t.x-e.x,s=t.y-e.y,r=t.z-e.z;return i*i+s*s+r*r}static normalize(t,e){const i=t.magnitude,s=t.x/i,r=t.y/i,a=t.z/i;return(e||new z).setXYZ(s,r,a)}static inverse(t,e){const i=1/t.x,s=1/t.y,r=1/t.z;return(e||new z).setXYZ(i,s,r)}static sub(t,e,i){const s=t.x-e.x,r=t.y-e.y,a=t.z-e.z;return(i||new z).setXYZ(s,r,a)}static add(t,e,i){const s=t.x+e.x,r=t.y+e.y,a=t.z+e.z;return(i||new z).setXYZ(s,r,a)}static combine(t,e,i,s,r){const a=t.x*i+e.x*s,n=t.y*i+e.y*s,o=t.z*i+e.z*s;return(r||new z).setXYZ(a,n,o)}static mul(t,e,i){const s=t.x*e.x,r=t.y*e.y,a=t.z*e.z;return(i||new z).setXYZ(s,r,a)}static div(t,e,i){const s=t.x/e.x,r=t.y/e.y,a=t.z/e.z;return(i||new z).setXYZ(s,r,a)}static scale(t,e,i){const s=t.x*e,r=t.y*e,a=t.z*e;return(i||new z).setXYZ(s,r,a)}static min(t,e,i){const s=t.x<e.x?t.x:e.x,r=t.y<e.y?t.y:e.y,a=t.z<e.z?t.z:e.z;return(i||new z).setXYZ(s,r,a)}static max(t,e,i){const s=t.x>e.x?t.x:e.x,r=t.y>e.y?t.y:e.y,a=t.z>e.z?t.z:e.z;return(i||new z).setXYZ(s,r,a)}static abs(t,e){const i=t.x<0?-t.x:t.x,s=t.y<0?-t.y:t.y,r=t.z<0?-t.z:t.z;return(e||new z).setXYZ(i,s,r)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e,i){const s=t.y*e.z-t.z*e.y,r=t.z*e.x-t.x*e.z,a=t.x*e.y-t.y*e.x;return(i||new z).setXYZ(s,r,a)}}class V extends z{_callback;get callback(){return this._callback}set callback(t){this._callback=t}get x(){return super.x}set x(t){(t=C(t))!==super.x&&(super.x=t,this._callback?.())}get y(){return super.y}set y(t){(t=C(t))!==super.y&&(super.y=t,this._callback?.())}get z(){return super.z}set z(t){(t=C(t))!==super.z&&(super.z=t,this._callback?.())}setXYZ(t,e,i){return t=C(t),e=C(e),i=C(i),t===super.x&&e===super.y&&i===super.z||(super.setXYZ(t,e,i),this._callback?.()),this}copyWithin(t,e,i){return super.copyWithin(t,e,i),this._callback?.(),this}fill(t,e,i){return super.fill(t,e,i),this._callback?.(),this}reverse(){return super.reverse(),this._callback?.(),this}set(t,e){super.set(t,e),this._callback?.()}sort(t){return super.sort(t),this._callback?.(),this}}class O extends N{constructor(t,e,i,s){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,4);else if(super(4),"number"==typeof t&&"number"==typeof e&&"number"==typeof i&&"number"==typeof s)this[0]=t,this[1]=e,this[2]=i,this[3]=s;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=4)this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3];else if(void 0!==t)throw new Error("Vector4.constructor(): invalid arguments")}clone(){return new O(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}get magnitude(){return Math.hypot(this[0],this[1],this[2],this[3])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3]}xy(){return new L(this.x,this.y)}xyz(){return new z(this.x,this.y,this.z)}setXYZW(t,e,i,s){return this[0]=t,this[1]=e,this[2]=i,this[3]=s,this}setAndNormalize(t,e,i,s){const r=Math.hypot(t,e,i,s);return this.setXYZW(t/r,e/r,i/r,s/r)}subBy(t){return O.sub(this,t,this),this}addBy(t){return O.add(this,t,this),this}combineBy(t,e,i){return O.combine(this,t,e,i,this),this}mulBy(t){return O.mul(this,t,this),this}divBy(t){return O.div(this,t,this),this}scaleBy(t){return O.scale(this,t,this),this}inplaceNormalize(){return O.normalize(this,this),this}inplaceInverse(){return O.inverse(this,this),this}inplaceMin(t){return O.min(this,t,this),this}inplaceMax(t){return O.max(this,t,this),this}static zero(){return new O(0,0,0,0)}static one(){return new O(1,1,1,1)}static axisPX(){return new O(1,0,0,0)}static axisNX(){return new O(-1,0,0,0)}static axisPY(){return new O(0,1,0,0)}static axisNY(){return new O(0,-1,0,0)}static axisPZ(){return new O(0,0,1,0)}static axisNZ(){return new O(0,0,-1,0)}static axisPW(){return new O(0,0,0,1)}static axisNW(){return new O(0,0,0,-1)}static normalize(t,e){const i=t.magnitude,s=t.x/i,r=t.y/i,a=t.z/i,n=t.w/i;return(e||new O).setXYZW(s,r,a,n)}static inverse(t,e){const i=1/t.x,s=1/t.y,r=1/t.z,a=1/t.w;return(e||new O).setXYZW(i,s,r,a)}static sub(t,e,i){const s=t.x-e.x,r=t.y-e.y,a=t.z-e.z,n=t.w-e.w;return(i||new O).setXYZW(s,r,a,n)}static add(t,e,i){const s=t.x+e.x,r=t.y+e.y,a=t.z+e.z,n=t.w+e.w;return(i||new O).setXYZW(s,r,a,n)}static combine(t,e,i,s,r){const a=t.x*i+e.x*s,n=t.y*i+e.y*s,o=t.z*i+e.z*s,h=t.w*i+e.w*s;return(r||new O).setXYZW(a,n,o,h)}static mul(t,e,i){const s=t.x*e.x,r=t.y*e.y,a=t.z*e.z,n=t.w*e.w;return(i||new O).setXYZW(s,r,a,n)}static div(t,e,i){const s=t.x/e.x,r=t.y/e.y,a=t.z/e.z,n=t.w/e.w;return(i||new O).setXYZW(s,r,a,n)}static scale(t,e,i){const s=t.x*e,r=t.y*e,a=t.z*e,n=t.w*e;return(i||new O).setXYZW(s,r,a,n)}static min(t,e,i){const s=t.x<e.x?t.x:e.x,r=t.y<e.y?t.y:e.y,a=t.z<e.z?t.z:e.z,n=t.w<e.w?t.w:e.w;return(i||new O).setXYZW(s,r,a,n)}static max(t,e,i){const s=t.x>e.x?t.x:e.x,r=t.y>e.y?t.y:e.y,a=t.z>e.z?t.z:e.z,n=t.w>e.w?t.w:e.w;return(i||new O).setXYZW(s,r,a,n)}static abs(t,e){const i=t.x<0?-t.x:t.x,s=t.y<0?-t.y:t.y,r=t.z<0?-t.z:t.z,a=t.w<0?-t.w:t.w;return(e||new O).setXYZW(i,s,r,a)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}}class k extends O{_callback;get callback(){return this._callback}set callback(t){this._callback=t}get x(){return super.x}set x(t){(t=C(t))!==super.x&&(super.x=t,this._callback?.())}get y(){return super.y}set y(t){(t=C(t))!==super.y&&(super.y=t,this._callback?.())}get z(){return super.z}set z(t){(t=C(t))!==super.z&&(super.z=t,this._callback?.())}get w(){return super.w}set w(t){(t=C(t))!==super.w&&(super.w=t,this._callback?.())}setXYZW(t,e,i,s){return t=C(t),e=C(e),i=C(i),s=C(s),t===super.x&&e===super.y&&i===super.z&&s===super.w||(super.setXYZW(t,e,i,s),this._callback?.()),this}copyWithin(t,e,i){return super.copyWithin(t,e,i),this._callback?.(),this}fill(t,e,i){return super.fill(t,e,i),this._callback?.(),this}reverse(){return super.reverse(),this._callback?.(),this}set(t,e){super.set(t,e),this._callback?.()}sort(t){return super.sort(t),this._callback?.(),this}}class U extends N{constructor(t,e,i,s){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,4);else if(super(4),"number"==typeof t&&"number"==typeof e&&"number"==typeof i&&"number"==typeof s)this[0]=t,this[1]=e,this[2]=i,this[3]=s;else if(t instanceof H||t instanceof W)this.fromRotationMatrix(t);else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=4)this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3];else{if(void 0!==t)throw new Error("Quaternion.constructor(): invalid arguments");this[0]=0,this[1]=0,this[2]=0,this[3]=1}}clone(){return new U(this)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}setXYZW(t,e,i,s){return this[0]=t,this[1]=e,this[2]=i,this[3]=s,this}scaleBy(t){return U.scale(this,t,this),this}setAndNormalize(t,e,i,s){const r=Math.hypot(t,e,i,s);return this.setXYZW(t/r,e/r,i/r,s/r)}get magnitude(){return Math.hypot(this[0],this[1],this[2],this[3])}get magnitudeSq(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3]}identity(){return U.identity(this),this}inplaceNormalize(){return U.normalize(this,this),this}inplaceConjugate(){return U.conjugate(this,this),this}multiplyRight(t){return U.multiply(this,t,this),this}multiplyLeft(t){return U.multiply(t,this,this),this}unitVectorToUnitVector(t,e){return U.unitVectorToUnitVector(t,e,this),this}fromEulerAngle(t,e,i,s="ZYX"){return U.fromEulerAngle(t,e,i,s,this),this}fromAxisAngle(t,e){return U.fromAxisAngle(t,e,this),this}toAxisAngle(t){const e=2*Math.acos(this[3]),i=Math.sin(e/2);return i>1e-6?t.setXYZ(this[0]/i,this[1]/2,this[2]/i):t.setXYZ(1,0,0),e}toEulerAngles(t){t=t??new z;const e=2*(this.w*this.x+this.y*this.z),i=1-2*(this.x*this.x+this.y*this.y),s=Math.atan2(e,i),r=Math.max(-1,Math.min(1,2*(this.w*this.y-this.z*this.x))),a=Math.asin(r),n=2*(this.w*this.z+this.x*this.y),o=1-2*(this.y*this.y+this.z*this.z),h=Math.atan2(n,o);return t.setXYZ(s,a,h)}fromRotationMatrix(t){return U.fromRotationMatrix(t,this),this}toMatrix3x3(t){const e=t||new H;return this.toMatrix(e),e}toMatrix4x4(t){const e=t||W.identity();return this.toMatrix(e),e.m03=0,e.m13=0,e.m23=0,e.m30=0,e.m31=0,e.m32=0,e.m33=1,e}getDirectionX(t){return(t=t??new z).setXYZ(1-2*(this.y*this.y+this.z*this.z),2*(this.x*this.y+this.z*this.w),2*(this.z*this.x-this.y*this.w))}getDirectionY(t){return(t=t??new z).setXYZ(2*(this.x*this.y-this.z*this.w),1-2*(this.z*this.z+this.x*this.x),2*(this.y*this.z+this.x*this.w))}getDirectionZ(t){return(t=t??new z).setXYZ(2*(this.z*this.x+this.y*this.w),2*(this.y*this.z-this.x*this.w),1-2*(this.y*this.y+this.x*this.x))}getAxisAngle(t){t=t??new O;const e=this.w<0?-1:1,i=this.x*e,s=this.y*e,r=this.z*e,a=this.w*e,n=Math.acos(a),o=Math.sin(n);return t.setXYZW(i/o,s/o,r/o,2*n)}transform(t,e){e=e||new z;const i=2*this.x,s=2*this.y,r=2*this.z,a=this.x*i,n=this.y*s,o=this.z*r,h=this.x*s,l=this.x*r,u=this.y*r,c=this.w*i,d=this.w*s,p=this.w*r;return e.setXYZ((1-n-o)*t.x+(h-p)*t.y+(l+d)*t.z,(h+p)*t.x+(1-a-o)*t.y+(u-c)*t.z,(l-d)*t.x+(u+c)*t.y+(1-a-n)*t.z)}static scale(t,e,i){return(i=i||t).setXYZW(t.x*e,t.y*e,t.z*e,t.w*e)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static identity(t){return(t||new U).setXYZW(0,0,0,1)}static normalize(t,e){const i=t.magnitude;return(e||new U).setXYZW(t.x/i,t.y/i,t.z/i,t.w/i)}static conjugate(t,e){return(e||new U).setXYZW(-t.x,-t.y,-t.z,t.w)}static multiply(t,e,i){i=i||new U;const s=t.x*e.w+t.w*e.x+t.y*e.z-t.z*e.y,r=t.y*e.w+t.w*e.y+t.z*e.x-t.x*e.z,a=t.z*e.w+t.w*e.z+t.x*e.y-t.y*e.x,n=t.w*e.w-t.x*e.x-t.y*e.y-t.z*e.z;return i.setXYZW(s,r,a,n)}static slerp(t,e,i,s){if(s=s||new U,i<=0)return s.setXYZW(t.x,t.y,t.z,t.w);if(i>=1)return s.setXYZW(e.x,e.y,e.z,e.w);const r=this.dot(t,e),a=r<0?-1:1,n=t.x,o=t.y,h=t.z,l=t.w,u=e.x*a,c=e.y*a,d=e.z*a,p=e.w*a,m=r*a;if(m>=1)return s.setXYZW(n,o,h,l);const f=1-m*m;if(f<=Number.EPSILON){const r=1-i;return s.setAndNormalize(t.x*r+e.x*i,t.y*r+e.y*i,t.z*r+e.z*i,t.w*r+e.w*i)}const _=Math.sqrt(f),g=Math.atan2(_,m),x=Math.sin((1-i)*g)/_,b=Math.sin(i*g)/_;return s.setXYZW(n*x+u*b,o*x+c*b,h*x+d*b,l*x+p*b)}static angleBetween(t,e){const i=this.dot(t,e),s=i<-1?-1:i>1?1:i;return 2*Math.acos(Math.abs(s))}static unitVectorToUnitVector(t,e,i){i=i||new U;let s=z.dot(t,e)+1;return s<1e-6?(s=0,Math.abs(t.x)>Math.abs(t.z)?i.setAndNormalize(-t.y,t.x,0,s):i.setAndNormalize(0,-t.z,t.y,s)):i.setAndNormalize(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x,s)}static fromEulerAngle(t,e,i,s="ZYX",r){r=r||new U;const a=Math.cos(t/2),n=Math.cos(e/2),o=Math.cos(i/2),h=Math.sin(t/2),l=Math.sin(e/2),u=Math.sin(i/2);switch(s){case"XYZ":return r.setXYZW(h*n*o+a*l*u,a*l*o-h*n*u,a*n*u+h*l*o,a*n*o-h*l*u);case"YXZ":return r.setXYZW(h*n*o+a*l*u,a*l*o-h*n*u,a*n*u-h*l*o,a*n*o+h*l*u);case"ZXY":return r.setXYZW(h*n*o-a*l*u,a*l*o+h*n*u,a*n*u+h*l*o,a*n*o-h*l*u);case"ZYX":return r.setXYZW(h*n*o-a*l*u,a*l*o+h*n*u,a*n*u-h*l*o,a*n*o+h*l*u);case"YZX":return r.setXYZW(h*n*o+a*l*u,a*l*o+h*n*u,a*n*u-h*l*o,a*n*o-h*l*u);case"XZY":return r.setXYZW(h*n*o-a*l*u,a*l*o-h*n*u,a*n*u+h*l*o,a*n*o+h*l*u)}}static fromAxisAngle(t,e,i){i=i||new U;const s=e/2,r=Math.sin(s);return i.setXYZW(t.x*r,t.y*r,t.z*r,Math.cos(s))}static fromRotationMatrix(t,e){e=e||new U;const i=t.m00+t.m11+t.m22;let s;return i>0?(s=.5/Math.sqrt(i+1),e.setXYZW((t.m21-t.m12)*s,(t.m02-t.m20)*s,(t.m10-t.m01)*s,.25/s)):t.m00>t.m11&&t.m00>t.m22?(s=2*Math.sqrt(1+t.m00-t.m11-t.m22),e.setXYZW(.25*s,(t.m01+t.m10)/s,(t.m02+t.m20)/s,(t.m21-t.m12)/s)):t.m11>t.m22?(s=2*Math.sqrt(1-t.m00+t.m11-t.m22),e.setXYZW((t.m10+t.m01)/s,.25*s,(t.m21+t.m12)/s,(t.m02-t.m20)/s)):(s=2*Math.sqrt(1-t.m00-t.m11+t.m22),e.setXYZW((t.m02+t.m20)/s,(t.m12+t.m21)/s,.25*s,(t.m10-t.m01)/s)),e}toMatrix(t){const e=this.x*this.x,i=this.y*this.y,s=this.z*this.z,r=this.x*this.y,a=this.z*this.w,n=this.z*this.x,o=this.y*this.w,h=this.y*this.z,l=this.x*this.w;t.m00=1-2*(i+s),t.m10=2*(r+a),t.m20=2*(n-o),t.m01=2*(r-a),t.m11=1-2*(s+e),t.m21=2*(h+l),t.m02=2*(n+o),t.m12=2*(h-l),t.m22=1-2*(i+e)}}class G extends U{_callback;get callback(){return this._callback}set callback(t){this._callback=t}get x(){return super.x}set x(t){(t=C(t))!==super.x&&(super.x=t,this._callback?.())}get y(){return super.y}set y(t){(t=C(t))!==super.y&&(super.y=t,this._callback?.())}get z(){return super.z}set z(t){(t=C(t))!==super.z&&(super.z=t,this._callback?.())}get w(){return super.w}set w(t){(t=C(t))!==super.w&&(super.w=t,this._callback?.())}setXYZW(t,e,i,s){return t=C(t),e=C(e),i=C(i),s=C(s),t===super.x&&e===super.y&&i===super.z&&s===super.w||(super.setXYZW(t,e,i,s),this._callback?.()),this}copyWithin(t,e,i){return super.copyWithin(t,e,i),this._callback?.(),this}fill(t,e,i){return super.fill(t,e,i),this._callback?.(),this}reverse(){return super.reverse(),this._callback?.(),this}set(t,e){super.set(t,e),this._callback?.()}sort(t){return super.sort(t),this._callback?.(),this}}class H extends N{constructor(t,e,i,s,r,a,n,o,h){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,9);else if(super(9),"number"==typeof t)this[0]=t,this[1]=e,this[2]=i,this[3]=s,this[4]=r,this[5]=a,this[6]=n,this[7]=o,this[8]=h;else if(t instanceof U)t.toMatrix3x3(this);else if(t instanceof W)this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[4],this[4]=t[5],this[5]=t[6],this[6]=t[8],this[7]=t[9],this[8]=t[10];else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=9)this.set(t);else{if(void 0!==t)throw new Error("Matrix3x4.constructor(): invalid arguments");this.identity()}}clone(){return new H(this)}get m00(){return this[0]}set m00(t){this[0]=t}get m10(){return this[1]}set m10(t){this[1]=t}get m20(){return this[2]}set m20(t){this[2]=t}get m01(){return this[3]}set m01(t){this[3]=t}get m11(){return this[4]}set m11(t){this[4]=t}get m21(){return this[5]}set m21(t){this[5]=t}get m02(){return this[6]}set m02(t){this[6]=t}get m12(){return this[7]}set m12(t){this[7]=t}get m22(){return this[8]}set m22(t){this[8]=t}getRow(t,e){return(e||new z).setXYZ(this[3*t],this[3*t+1],this[3*t+2])}setRow(t,e){return this[3*t]=e.x,this[3*t+1]=e.y,this[3*t+2]=e.z,this}setRowXYZ(t,e,i,s){return this[3*t]=e,this[3*t+1]=i,this[3*t+2]=s,this}getCol(t,e){return(e||new z).setXYZ(this[t],this[3+t],this[6+t])}setCol(t,e){return this[t]=e.x,this[3+t]=e.y,this[6+t]=e.z,this}setColXYZ(t,e,i,s){return this[t]=e,this[3+t]=i,this[6+t]=s,this}static add(t,e,i){i=i||new H;for(let s=0;s<9;s++)i[s]=t[s]+e[s];return i}static sub(t,e,i){i=i||new H;for(let s=0;s<9;s++)i[s]=t[s]-e[s];return i}static mul(t,e,i){i=i||new H;for(let s=0;s<9;s++)i[s]=t[s]*e[s];return i}static div(t,e,i){i=i||new H;for(let s=0;s<9;s++)i[s]=t[s]/e[s];return i}static scale(t,e,i){i=i||new H;for(let s=0;s<9;s++)i[s]=t[s]*e;return i}static identity(t){return(t=t||new H).set(F),t}static transpose(t,e){return t===(e=e||new H)?([e[1],e[3]]=[e[3],e[1]],[e[2],e[6]]=[e[6],e[2]],[e[5],e[7]]=[e[7],e[5]]):(e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]),e}static invert(t,e){e=e||new H;const i=t[0],s=t[1],r=t[2],a=t[3],n=t[4],o=t[5],h=t[6],l=t[7],u=t[8],c=u*n-o*l,d=o*h-u*a,p=l*a-h*n,m=1/(i*c+s*d+r*p);return e[0]=c*m,e[1]=(r*l-u*s)*m,e[2]=(o*s-r*n)*m,e[3]=d*m,e[4]=(u*i-r*h)*m,e[5]=(r*a-o*i)*m,e[6]=p*m,e[7]=(s*h-l*i)*m,e[8]=(n*i-s*a)*m,e}static rotationX(t,e){e=e||new H;const i=Math.cos(t),s=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=i,e[5]=s,e[6]=0,e[7]=-s,e[8]=i,e}static rotationY(t,e){e=e||new H;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=0,e[2]=-s,e[3]=0,e[4]=1,e[5]=0,e[6]=s,e[7]=0,e[8]=i,e}static rotationZ(t,e){e=e||new H;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=-s,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}static rotation(t,e,i){i=i||new H;let s=t.x,r=t.y,a=t.z;const n=Math.hypot(s,r,a);s/=n,r/=n,a/=n;const o=s*s,h=r*r,l=a*a,u=Math.cos(e),c=Math.sin(e),d=1-u;return i[0]=o+(1-o)*u,i[1]=s*r*d+a*c,i[2]=s*a*d-r*c,i[3]=s*r*d-a*c,i[4]=h+(1-h)*u,i[5]=r*a*d+s*c,i[6]=s*a*d+r*c,i[7]=r*a*d-s*c,i[8]=l+(1-l)*u,i}static multiply(t,e,i){i=i||new H;const s=t[0],r=t[1],a=t[2],n=t[3],o=t[4],h=t[5],l=t[6],u=t[7],c=t[8],d=e[0],p=e[1],m=e[2],f=e[3],_=e[4],g=e[5],x=e[6],b=e[7],v=e[8];return i[0]=s*d+n*p+l*m,i[1]=r*d+o*p+u*m,i[2]=a*d+h*p+c*m,i[3]=s*f+n*_+l*g,i[4]=r*f+o*_+u*g,i[5]=a*f+h*_+c*g,i[6]=s*x+n*b+l*v,i[7]=r*x+o*b+u*v,i[8]=a*x+h*b+c*v,i}subBy(t){return H.sub(this,t,this),this}addBy(t){return H.add(this,t,this),this}mulBy(t){return H.mul(this,t,this),this}divBy(t){return H.div(this,t,this),this}scaleBy(t){return H.scale(this,t,this),this}identity(){return H.identity(this),this}inplaceInvert(){return H.invert(this,this),this}transpose(){return H.transpose(this,this),this}multiplyRight(t){return H.multiply(this,t,this),this}multiplyLeft(t){return H.multiply(t,this,this),this}rotationX(t){return H.rotationX(t,this),this}rotationY(t){return H.rotationY(t,this),this}rotationZ(t){return H.rotationZ(t,this),this}rotation(t,e){return H.rotation(t,e,this),this}transform(t,e){return(e=e||new z).setXYZ(this[0]*t[0]+this[3]*t[1]+this[6]*t[2],this[1]*t[0]+this[4]*t[1]+this[7]*t[2],this[2]*t[0]+this[5]*t[1]+this[8]*t[2])}transformPoint(t,e){return this.transform(t,e)}transformVector(t,e){return this.transform(t,e)}}class W extends N{constructor(t,e,i,s,r,a,n,o,h,l,u,c,d,p,m,f){if(t instanceof ArrayBuffer&&"number"==typeof e)super(t,e,16);else if(super(16),"number"==typeof t)this[0]=t,this[1]=e,this[2]=i,this[3]=s,this[4]=r,this[5]=a,this[6]=n,this[7]=o,this[8]=h,this[9]=l,this[10]=u,this[11]=c,this[12]=d,this[13]=p,this[14]=m,this[15]=f;else if(t instanceof U)t.toMatrix4x4(this);else if(t instanceof H)this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=0,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=0,this.m20=t.m20,this.m21=t.m21,this.m22=t.m22,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=1;else if((t instanceof Float32Array||Array.isArray(t))&&t.length>=16)this.set(t);else{if(void 0!==t)throw new Error("Matrix4x4.constructor(): invalid arguments");this.identity()}}clone(){return new W(this)}get m00(){return this[0]}set m00(t){this[0]=t}get m10(){return this[1]}set m10(t){this[1]=t}get m20(){return this[2]}set m20(t){this[2]=t}get m30(){return this[3]}set m30(t){this[3]=t}get m01(){return this[4]}set m01(t){this[4]=t}get m11(){return this[5]}set m11(t){this[5]=t}get m21(){return this[6]}set m21(t){this[6]=t}get m31(){return this[7]}set m31(t){this[7]=t}get m02(){return this[8]}set m02(t){this[8]=t}get m12(){return this[9]}set m12(t){this[9]=t}get m22(){return this[10]}set m22(t){this[10]=t}get m32(){return this[11]}set m32(t){this[11]=t}get m03(){return this[12]}set m03(t){this[12]=t}get m13(){return this[13]}set m13(t){this[13]=t}get m23(){return this[14]}set m23(t){this[14]=t}get m33(){return this[15]}set m33(t){this[15]=t}getRow(t,e){return(e||new O).setXYZW(this[4*t],this[4*t+1],this[4*t+2],this[4*t+3])}setRow(t,e){return this[4*t]=e.x,this[4*t+1]=e.y,this[4*t+2]=e.z,this[4*t+3]=e.w,this}setRowXYZW(t,e,i,s,r){return this[4*t]=e,this[4*t+1]=i,this[4*t+2]=s,this[4*t+3]=r,this}getCol(t,e){return(e||new O).setXYZW(this[t],this[4+t],this[8+t],this[12+t])}setCol(t,e){return this[t]=e.x,this[4+t]=e.y,this[8+t]=e.z,this[12+t]=e.w,this}setColXYZW(t,e,i,s,r){return this[t]=e,this[4+t]=i,this[8+t]=s,this[12+t]=r,this}static add(t,e,i){i=i||new W;for(let s=0;s<16;s++)i[s]=t[s]+e[s];return i}static sub(t,e,i){i=i||new W;for(let s=0;s<16;s++)i[s]=t[s]-e[s];return i}static mul(t,e,i){i=i||new W;for(let s=0;s<16;s++)i[s]=t[s]*e[s];return i}static div(t,e,i){i=i||new W;for(let s=0;s<16;s++)i[s]=t[s]/e[s];return i}static scale(t,e,i){i=i||new W;for(let s=0;s<16;s++)i[s]=t[s]*e;return i}static identity(t){return(t=t||new W).set(D),t}static ortho(t,e,i,s,r,a,n){return(n=n||new W)[0]=2/(e-t),n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/(s-i),n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2/(r-a),n[11]=0,n[12]=(t+e)/(t-e),n[13]=(i+s)/(i-s),n[14]=(r+a)/(r-a),n[15]=1,n}static reflection(t,e,i,s,r){return(r=r||new W).m00=1-2*t*t,r.m01=-2*t*e,r.m02=-2*t*i,r.m03=-2*t*s,r.m10=-2*t*e,r.m11=1-2*e*e,r.m12=-2*e*i,r.m13=-2*e*s,r.m20=-2*t*i,r.m21=-2*e*i,r.m22=1-2*i*i,r.m23=-2*i*s,r.m30=0,r.m31=0,r.m32=0,r.m33=1,r}static perspective(t,e,i,s,r){const a=i*Math.tan(.5*t),n=a*e;return this.frustum(-n,n,-a,a,i,s,r)}static obliqueProjection(t,e){const i=new W(t),s=W.invert(t).transform(new O(e.a>0?1:-1,e.b>0?1:-1,1,1)),r=2/(s.x*e.a+s.y*e.b+s.z*e.c+s.w*e.d);return i[2]=e.a*r-i[3],i[6]=e.b*r-i[7],i[10]=e.c*r-i[11],i[14]=e.d*r-i[15],i}static obliquePerspective(t,e){const i=new W(t),s=new O(((e.x>0?1:e.x<0?-1:0)+t.m02)/t.m00,((e.y>0?1:e.y<0?-1:0)+t.m12)/t.m11,-1,(1+t.m22)/t.m23),r=O.scale(e,2/O.dot(e,s));return i.m20=r.x,i.m21=r.y,i.m22=r.z+1,i.m23=r.w,i}static frustum(t,e,i,s,r,a,n){const o=e-t,h=s-i,l=r-a;return(n=n||new W)[0]=2*r/o,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*r/h,n[6]=0,n[7]=0,n[8]=(t+e)/o,n[9]=(s+i)/h,n[10]=(r+a)/l,n[11]=-1,n[12]=0,n[13]=0,n[14]=2*r*a/l,n[15]=0,n}static transpose(t,e){return t===(e=e||new W)?([e[1],e[4]]=[e[4],e[1]],[e[2],e[8]]=[e[8],e[2]],[e[3],e[12]]=[e[12],e[3]],[e[6],e[9]]=[e[9],e[6]],[e[7],e[13]]=[e[13],e[7]],[e[11],e[14]]=[e[14],e[11]]):(e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]),e}static invert(t,e){e=e||new W;const i=t[0],s=t[1],r=t[2],a=t[3],n=t[4],o=t[5],h=t[6],l=t[7],u=t[8],c=t[9],d=t[10],p=t[11],m=t[12],f=t[13],_=t[14],g=t[15],x=d*g,b=_*p,v=h*g,y=_*l,T=h*p,w=d*l,S=r*g,A=_*a,C=r*p,E=d*a,M=r*l,B=h*a,I=u*f,P=m*c,$=n*f,R=m*o,F=n*c,D=u*o,N=i*f,L=m*s,z=i*c,V=u*s,O=i*o,k=n*s,U=x*o+y*c+T*f-(b*o+v*c+w*f),G=b*s+S*c+E*f-(x*s+A*c+C*f),H=v*s+A*o+M*f-(y*s+S*o+B*f),X=w*s+C*o+B*c-(T*s+E*o+M*c),j=1/(i*U+n*G+u*H+m*X);return e[0]=j*U,e[1]=j*G,e[2]=j*H,e[3]=j*X,e[4]=j*(b*n+v*u+w*m-(x*n+y*u+T*m)),e[5]=j*(x*i+A*u+C*m-(b*i+S*u+E*m)),e[6]=j*(y*i+S*n+B*m-(v*i+A*n+M*m)),e[7]=j*(T*i+E*n+M*u-(w*i+C*n+B*u)),e[8]=j*(I*l+R*p+F*g-(P*l+$*p+D*g)),e[9]=j*(P*a+N*p+V*g-(I*a+L*p+z*g)),e[10]=j*($*a+L*l+O*g-(R*a+N*l+k*g)),e[11]=j*(D*a+z*l+k*p-(F*a+V*l+O*p)),e[12]=j*($*d+D*_+P*h-(F*_+I*h+R*d)),e[13]=j*(z*_+I*r+L*d-(N*d+V*_+P*r)),e[14]=j*(N*h+k*_+R*r-(O*_+$*r+L*h)),e[15]=j*(O*d+F*r+V*h-(z*h+k*d+D*r)),e}static invertAffine(t,e){e=e||new W;const i=t[0],s=t[1],r=t[2],a=t[4],n=t[5],o=t[6],h=t[8],l=t[9],u=t[10],c=t[12],d=t[13],p=t[14],m=u*n-o*l,f=r*l-u*s,_=o*s-r*n,g=1/(i*m+a*f+h*_);return e[0]=g*m,e[1]=g*f,e[2]=g*_,e[3]=0,e[4]=g*(o*h-u*a),e[5]=g*(u*i-r*h),e[6]=g*(r*a-o*i),e[7]=0,e[8]=g*(a*l-h*n),e[9]=g*(h*s-i*l),e[10]=g*(i*n-a*s),e[11]=0,e[12]=g*(a*d*u+h*n*p+c*l*o-(a*l*p+h*d*o+c*n*u)),e[13]=g*(i*l*p+h*d*r+c*s*u-(i*d*u+h*s*p+c*l*r)),e[14]=g*(i*d*o+a*s*p+c*n*r-(i*n*p+a*d*r+c*s*o)),e[15]=1,e}static translation(t,e){return(e=e||new W)[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t.x,e[13]=t.y,e[14]=t.z,e[15]=1,e}static scaling(t,e){return(e=e||new W)[0]=t.x,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t.y,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t.z,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotationX(t,e){e=e||new W;const i=Math.cos(t),s=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=s,e[7]=0,e[8]=0,e[9]=-s,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotationY(t,e){e=e||new W;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=0,e[2]=-s,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=s,e[9]=0,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotationZ(t,e){e=e||new W;const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=0,e[4]=-s,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static rotation(t,e,i){i=i||new W;let s=t.x,r=t.y,a=t.z;const n=Math.hypot(s,r,a);s/=n,r/=n,a/=n;const o=s*s,h=r*r,l=a*a,u=Math.cos(e),c=Math.sin(e),d=1-u;return i[0]=o+(1-o)*u,i[1]=s*r*d+a*c,i[2]=s*a*d-r*c,i[3]=0,i[4]=s*r*d-a*c,i[5]=h+(1-h)*u,i[6]=r*a*d+s*c,i[7]=0,i[8]=s*a*d+r*c,i[9]=r*a*d-s*c,i[10]=l+(1-l)*u,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}static compose(t,e,i,s){return(s=s??new W).scaling(t).rotateLeft(e).translateLeft(i)}static lookAt(t,e,i,s){s=s||new W;const r=z.normalize(z.sub(t,e)),a=z.normalize(z.cross(i,r)),n=z.normalize(z.cross(r,a));return s[0]=a.x,s[1]=a.y,s[2]=a.z,s[3]=0,s[4]=n.x,s[5]=n.y,s[6]=n.z,s[7]=0,s[8]=r.x,s[9]=r.y,s[10]=r.z,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1,s}static lookAtCubeFace(t,e,i){switch(t){case R.PX:return this.lookAt(e,new z(e.x+1,e.y,e.z),new z(0,-1,0),i);case R.NX:return this.lookAt(e,new z(e.x-1,e.y,e.z),new z(0,-1,0),i);case R.PY:return this.lookAt(e,new z(e.x,e.y+1,e.z),new z(0,0,1),i);case R.NY:return this.lookAt(e,new z(e.x,e.y-1,e.z),new z(0,0,-1),i);case R.PZ:return this.lookAt(e,new z(e.x,e.y,e.z+1),new z(0,-1,0),i);case R.NZ:return this.lookAt(e,new z(e.x,e.y,e.z-1),new z(0,-1,0),i);default:return null}}static multiply(t,e,i){i=i||new W;const s=t[0],r=t[1],a=t[2],n=t[3],o=t[4],h=t[5],l=t[6],u=t[7],c=t[8],d=t[9],p=t[10],m=t[11],f=t[12],_=t[13],g=t[14],x=t[15],b=e[0],v=e[1],y=e[2],T=e[3],w=e[4],S=e[5],A=e[6],C=e[7],E=e[8],M=e[9],B=e[10],I=e[11],P=e[12],$=e[13],R=e[14],F=e[15];return i[0]=s*b+o*v+c*y+f*T,i[1]=r*b+h*v+d*y+_*T,i[2]=a*b+l*v+p*y+g*T,i[3]=n*b+u*v+m*y+x*T,i[4]=s*w+o*S+c*A+f*C,i[5]=r*w+h*S+d*A+_*C,i[6]=a*w+l*S+p*A+g*C,i[7]=n*w+u*S+m*A+x*C,i[8]=s*E+o*M+c*B+f*I,i[9]=r*E+h*M+d*B+_*I,i[10]=a*E+l*M+p*B+g*I,i[11]=n*E+u*M+m*B+x*I,i[12]=s*P+o*$+c*R+f*F,i[13]=r*P+h*$+d*R+_*F,i[14]=a*P+l*$+p*R+g*F,i[15]=n*P+u*$+m*R+x*F,i}static multiplyAffine(t,e,i){i=i||new W;const s=t[0],r=t[1],a=t[2],n=t[4],o=t[5],h=t[6],l=t[8],u=t[9],c=t[10],d=t[12],p=t[13],m=t[14],f=e[0],_=e[1],g=e[2],x=e[4],b=e[5],v=e[6],y=e[8],T=e[9],w=e[10],S=e[12],A=e[13],C=e[14];return i[0]=s*f+n*_+l*g,i[1]=r*f+o*_+u*g,i[2]=a*f+h*_+c*g,i[3]=0,i[4]=s*x+n*b+l*v,i[5]=r*x+o*b+u*v,i[6]=a*x+h*b+c*v,i[7]=0,i[8]=s*y+n*T+l*w,i[9]=r*y+o*T+u*w,i[10]=a*y+h*T+c*w,i[11]=0,i[12]=s*S+n*A+l*C+d,i[13]=r*S+o*A+u*C+p,i[14]=a*S+h*A+c*C+m,i[15]=1,i}static translateRight(t,e,i){if((i=i||new W)!==t)i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12],i[13]=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13],i[14]=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14],i[15]=t[15];else{const s=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12],r=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13],a=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14];i[12]=s,i[13]=r,i[14]=a}return i}static translateLeft(t,e,i){return(i=i||new W)!==t?(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12]+e.x,i[13]=t[13]+e.y,i[14]=t[14]+e.z,i[15]=t[15]):(i[12]+=e.x,i[13]+=e.y,i[14]+=e.z),i}static scaleRight(t,e,i){return(i=i||new W)!==t?(i[0]=t[0]*e.x,i[1]=t[1]*e.x,i[2]=t[2]*e.x,i[3]=t[3]*e.x,i[4]=t[4]*e.y,i[5]=t[5]*e.y,i[6]=t[6]*e.y,i[7]=t[7]*e.y,i[8]=t[8]*e.z,i[9]=t[9]*e.z,i[10]=t[10]*e.z,i[11]=t[11]*e.z,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):(i[0]*=e.x,i[1]*=e.x,i[2]*=e.x,i[3]*=e.x,i[4]*=e.y,i[5]*=e.y,i[6]*=e.y,i[7]*=e.y,i[8]*=e.z,i[9]*=e.z,i[10]*=e.z,i[11]*=e.z),i}static scaleLeft(t,e,i){return(i=i||new W)[0]=t[0]*e.x,i[1]=t[1]*e.y,i[2]=t[2]*e.z,i[3]=t[3],i[4]=t[4]*e.x,i[5]=t[5]*e.y,i[6]=t[6]*e.z,i[7]=t[7],i[8]=t[8]*e.x,i[9]=t[9]*e.y,i[10]=t[10]*e.z,i[11]=t[11],i[12]=t[12]*e.x,i[13]=t[13]*e.y,i[14]=t[14]*e.z,i[15]=t[15],i}static rotateRight(t,e,i){i=i||new W;const s=e instanceof U?new H(e):e,r=t[0],a=t[1],n=t[2],o=t[3],h=t[4],l=t[5],u=t[6],c=t[7],d=t[8],p=t[9],m=t[10],f=t[11],_=t[12],g=t[13],x=t[14],b=t[15],v=s.m00,y=s.m10,T=s.m20,w=s.m01,S=s.m11,A=s.m21,C=s.m02,E=s.m12,M=s.m22;return i[0]=r*v+h*y+d*T,i[1]=a*v+l*y+p*T,i[2]=n*v+u*y+m*T,i[3]=o*v+c*y+f*T,i[4]=r*w+h*S+d*A,i[5]=a*w+l*S+p*A,i[6]=n*w+u*S+m*A,i[7]=o*w+c*S+f*A,i[8]=r*C+h*E+d*M,i[9]=a*C+l*E+p*M,i[10]=n*C+u*E+m*M,i[11]=o*C+c*E+f*M,i[12]=_,i[13]=g,i[14]=x,i[15]=b,i}static rotateLeft(t,e,i){i=i||new W;const s=e instanceof U?new H(e):e,r=s.m00,a=s.m10,n=s.m20,o=s.m01,h=s.m11,l=s.m21,u=s.m02,c=s.m12,d=s.m22,p=t[0],m=t[1],f=t[2],_=t[3],g=t[4],x=t[5],b=t[6],v=t[7],y=t[8],T=t[9],w=t[10],S=t[11],A=t[12],C=t[13],E=t[14],M=t[15];return i[0]=r*p+o*m+u*f,i[1]=a*p+h*m+c*f,i[2]=n*p+l*m+d*f,i[3]=_,i[4]=r*g+o*x+u*b,i[5]=a*g+h*x+c*b,i[6]=n*g+l*x+d*b,i[7]=v,i[8]=r*y+o*T+u*w,i[9]=a*y+h*T+c*w,i[10]=n*y+l*T+d*w,i[11]=S,i[12]=r*A+o*C+u*E,i[13]=a*A+h*C+c*E,i[14]=n*A+l*C+d*E,i[15]=M,i}subBy(t){return W.sub(this,t,this),this}addBy(t){return W.add(this,t,this),this}mulBy(t){return W.mul(this,t,this),this}divBy(t){return W.div(this,t,this),this}scaleBy(t){return W.scale(this,t,this),this}identity(){return W.identity(this),this}perspective(t,e,i,s){return W.perspective(t,e,i,s,this),this}frustum(t,e,i,s,r,a){return W.frustum(t,e,i,s,r,a,this),this}ortho(t,e,i,s,r,a){return W.ortho(t,e,i,s,r,a,this),this}isOrtho(){return 1===this[15]}isPerspective(){return 0===this[15]}getNearPlaneWidth(){return this.isPerspective()?2*this.getNearPlane()/this[0]:2/this[0]}getNearPlaneHeight(){return this.isPerspective()?2*this.getNearPlane()/this[5]:2/this[5]}getNearPlane(){return this.isPerspective()?this[14]/(this[10]-1):(this[14]+1)/this[10]}getFarPlaneWidth(){return this.isPerspective()?this.getNearPlaneWidth()*this.getFarPlane()/this.getNearPlane():this.getNearPlaneWidth()}getFarPlaneHeight(){return this.isPerspective()?this.getNearPlaneHeight()*this.getFarPlane()/this.getNearPlane():this.getNearPlaneHeight()}getFarPlane(){return this.isPerspective()?this[14]/(this[10]+1):(this[14]-1)/this[10]}getFov(){return this.isOrtho()?0:2*Math.atan(1/this[5])}getTanHalfFov(){return this.isOrtho()?0:1/this[5]}getAspect(){return this[5]/this[0]}getLeftPlane(){return this.isPerspective()?(this[8]-1)*this.getNearPlane()/this[0]:(-1-this[12])/this[0]}getRightPlane(){return this.isPerspective()?(this[8]+1)*this.getNearPlane()/this[0]:(1-this[12])/this[0]}getTopPlane(){return this.isPerspective()?(this[9]+1)*this.getNearPlane()/this[5]:(1-this[13])/this[5]}getBottomPlane(){return this.isPerspective()?(this[9]-1)*this.getNearPlane()/this[5]:(-1-this[13])/this[5]}setNearFar(t,e){return this.isPerspective()?this.perspective(this.getFov(),this.getAspect(),t,e):(this[10]=2/(t-e),this[14]=(t+e)/(t-e)),this}translation(t){return W.translation(t,this),this}scaling(t){return W.scaling(t,this),this}inplaceInvert(){return W.invert(this,this),this}inplaceInvertAffine(){return W.invertAffine(this,this),this}transpose(){return W.transpose(this,this),this}multiplyRight(t){return W.multiply(this,t,this),this}multiplyRightAffine(t){return W.multiplyAffine(this,t,this),this}multiplyLeft(t){return W.multiply(t,this,this),this}multiplyLeftAffine(t){return W.multiplyAffine(t,this,this),this}rotationX(t){return W.rotationX(t,this),this}rotationY(t){return W.rotationY(t,this),this}rotationZ(t){return W.rotationZ(t,this),this}rotation(t,e){return W.rotation(t,e,this),this}translateRight(t){return W.translateRight(this,t,this),this}translateLeft(t){return W.translateLeft(this,t,this),this}scaleRight(t){return W.scaleRight(this,t,this),this}scaleLeft(t){return W.scaleLeft(this,t,this),this}rotateRight(t){return W.rotateRight(this,t,this),this}rotateLeft(t){return W.rotateLeft(this,t,this),this}lookAt(t,e,i){return W.lookAt(t,e,i,this),this}transformPoint(t,e){return(e=e||new O).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14],this[3]*t[0]+this[7]*t[1]+this[11]*t[2]+this[15])}transformPointH(t,e){e=e||new z;const i=this[3]*t[0]+this[7]*t[1]+this[11]*t[2]+this[15];return e.setXYZ((this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12])/i,(this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13])/i,(this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14])/i)}transformPointP(t,e){e=e||new z;const i=this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12],s=this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13],r=this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14],a=this[3]*t[0]+this[7]*t[1]+this[11]*t[2]+this[15];return e.setXYZ(i/a,s/a,r/a)}transformPointAffine(t,e){return(e=e||new z).setXYZ(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14])}transformVector(t,e){return(e=e||new O).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2],this[1]*t[0]+this[5]*t[1]+this[9]*t[2],this[2]*t[0]+this[6]*t[1]+this[10]*t[2],this[3]*t[0]+this[7]*t[1]+this[11]*t[2])}transformVectorAffine(t,e){return(e=e||new z).setXYZ(this[0]*t[0]+this[4]*t[1]+this[8]*t[2],this[1]*t[0]+this[5]*t[1]+this[9]*t[2],this[2]*t[0]+this[6]*t[1]+this[10]*t[2])}transform(t,e){return(e=e||new O).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12]*t[3],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13]*t[3],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14]*t[3],this[3]*t[0]+this[7]*t[1]+this[11]*t[2]+this[15]*t[3])}transformAffine(t,e){return(e=e||new O).setXYZW(this[0]*t[0]+this[4]*t[1]+this[8]*t[2]+this[12]*t[3],this[1]*t[0]+this[5]*t[1]+this[9]*t[2]+this[13]*t[3],this[2]*t[0]+this[6]*t[1]+this[10]*t[2]+this[14]*t[3],t.w)}det(){const t=this[0],e=this[1],i=this[2],s=this[3],r=this[4],a=this[5],n=this[6],o=this[7],h=this[8],l=this[9],u=this[10],c=this[11],d=this[12],p=this[13],m=this[14],f=this[15],_=u*f-m*c,g=l*f-p*c,x=l*m-p*u,b=h*f-d*c,v=h*m-u*d,y=h*p-d*l;return t*+(a*_-n*g+o*x)+e*-(r*_-n*b+o*v)+i*+(r*g-a*b+o*y)+s*-(r*x-a*v+n*y)}compose(t,e,i){return W.compose(t,e,i,this),this}decompose(t,e,i){i&&i.setXYZ(this[12],this[13],this[14]);const s=this.det()<=0?-1:1,r=Math.hypot(this[0],this[1],this[2]),a=Math.hypot(this[4],this[5],this[6])*s,n=Math.hypot(this[8],this[9],this[10]);if(t&&t.setXYZ(r,a,n),e instanceof U){const t=new H(this);t[0]/=r,t[1]/=r,t[2]/=r,t[3]/=a,t[4]/=a,t[5]/=a,t[6]/=n,t[7]/=n,t[8]/=n,e.fromRotationMatrix(t)}else e instanceof H?(e[0]=this[0]/r,e[1]=this[1]/r,e[2]=this[2]/r,e[3]=this[4]/a,e[4]=this[5]/a,e[5]=this[6]/a,e[6]=this[8]/n,e[7]=this[9]/n,e[8]=this[10]/n):e instanceof W&&(e[0]=this[0]/r,e[1]=this[1]/r,e[2]=this[2]/r,e[3]=0,e[4]=this[4]/a,e[5]=this[5]/a,e[6]=this[6]/a,e[7]=0,e[8]=this[8]/n,e[9]=this[9]/n,e[10]=this[10]/n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1);return this}decomposeLookAt(t,e,i){return t?.setXYZ(this[12],this[13],this[14]),i?.setXYZ(this[4],this[5],this[6]),e?.setXYZ(this[12]-this[8],this[13]-this[9],this[14]-this[10]),this}toDualQuaternion(){const t=new z,e=new U,i=new z;this.decompose(i,e,t);const s=new U(.5*this.m03,.5*this.m13,.5*this.m23,0);return{real:e,dual:U.multiply(s,e),scale:i}}}class X extends N{_px;_py;_pz;_nx;_ny;_nz;_npDirty;constructor(t,e,i,s){switch(super(4),arguments.length){case 0:this[0]=0,this[1]=1,this[2]=0,this[3]=0,this._npDirty=!0;break;case 1:this.set(t);break;case 2:this.initWithOriginNormal(t,e);break;case 3:this.initWithPoints(t,e,i);break;case 4:this.setEquation(t,e,i,s);break;default:console.error("Plane constructor must have 0/2/3/4 arguments")}}get a(){return this[0]}set a(t){this[0]=t,this._npDirty=!0}get b(){return this[1]}set b(t){this[1]=t,this._npDirty=!0}get c(){return this[2]}set c(t){this[2]=t,this._npDirty=!0}get d(){return this[3]}set d(t){this[3]=t,this._npDirty=!0}get px(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._px}get py(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._py}get pz(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._pz}get nx(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._nx}get ny(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._ny}get nz(){return this._npDirty&&(this._npDirty=!1,this._calcNP()),this._nz}assign(t){return this._npDirty=!0,super.set(t),this}setEquation(t,e,i,s){return this[0]=t,this[1]=e,this[2]=i,this[3]=s,this._npDirty=!0,this}initWithOriginNormal(t,e){return this.setEquation(e.x,e.y,e.z,-z.dot(t,e))}initWithPoints(t,e,i){const s=z.cross(z.sub(e,t),z.sub(i,t)).inplaceNormalize();return this.initWithOriginNormal(t,s)}distanceToPoint(t){return t.x*this[0]+t.y*this[1]+t.z*this[2]+this[3]}nearestPointToPoint(t,e){const i=this.distanceToPoint(t);return(e||new z).setXYZ(t.x-this[0]*i,t.y-this[1]*i,t.z-this[2]*i)}getNormal(t){return(t||new z).setXYZ(this[0],this[1],this[2])}inplaceFlip(){return X.flip(this,this)}inplaceNormalize(){return X.normalize(this,this)}static flip(t,e){return(e||new X).setEquation(-t[0],-t[1],-t[2],-t[3])}static normalize(t,e){const i=Math.hypot(t[0],t[1],t[2]);return(e||new X).setEquation(t[0]/i,t[1]/i,t[2]/i,t[3]/i)}static transform(t,e,i){const s=W.transpose(W.invertAffine(e)).transform(new O(t[0],t[1],t[2],t[3])),r=i||t;return r.setEquation(s.x,s.y,s.z,s.w),r.inplaceNormalize()}_calcNP(){this._px=this[0]>0?1:-1,this._py=this[1]>0?1:-1,this._pz=this[2]>0?1:-1,this._nx=-this._px,this._ny=-this._py,this._nz=-this._pz}}const j=[[-1,-1,-1],[-1,-1,1],[-1,1,-1],[-1,1,1],[1,-1,-1],[1,-1,1],[1,1,-1],[1,1,1]];class Q{static CORNER_LEFT_TOP_NEAR=0;static CORNER_LEFT_TOP_FAR=1;static CORNER_LEFT_BOTTOM_NEAR=2;static CORNER_LEFT_BOTTOM_FAR=3;static CORNER_RIGHT_TOP_NEAR=4;static CORNER_RIGHT_TOP_FAR=5;static CORNER_RIGHT_BOTTOM_NEAR=6;static CORNER_RIGHT_BOTTOM_FAR=7;_planes;_corners;constructor(t){this._planes=null,this._corners=null,t instanceof Q?(this._planes=t._planes.map(t=>new X(t)),this._corners=t._corners.map(t=>new z(t))):this.initWithMatrix(t)}get planes(){return this._planes}get corners(){return this._corners}getCorner(t){return this.corners[t]}containsPoint(t,e=1e-6){for(const i of this.planes)if(i.distanceToPoint(t)<-e)return!1;return!0}initWithMatrix(t){this._planes=this._planes||Array.from({length:6}).map(()=>new X),this._planes[P.LEFT].setEquation(t.m30+t.m00,t.m31+t.m01,t.m32+t.m02,t.m33+t.m03).inplaceNormalize(),this._planes[P.RIGHT].setEquation(t.m30-t.m00,t.m31-t.m01,t.m32-t.m02,t.m33-t.m03).inplaceNormalize(),this._planes[P.BOTTOM].setEquation(t.m30+t.m10,t.m31+t.m11,t.m32+t.m12,t.m33+t.m13).inplaceNormalize(),this._planes[P.TOP].setEquation(t.m30-t.m10,t.m31-t.m11,t.m32-t.m12,t.m33-t.m13).inplaceNormalize(),this._planes[P.FRONT].setEquation(t.m30+t.m20,t.m31+t.m21,t.m32+t.m22,t.m33+t.m23).inplaceNormalize(),this._planes[P.BACK].setEquation(t.m30-t.m20,t.m31-t.m21,t.m32-t.m22,t.m33-t.m23).inplaceNormalize();const e=W.invert(t),i=j.map(t=>new z(t[0],t[1],t[2]));this._corners=this._corners||[];for(let t=0;t<8;t++){const s=e.transformPoint(i[t]);this._corners[t]=s.scaleBy(1/s.w).xyz()}return this}}class q{static ClipLeft=1<<P.LEFT;static ClipRight=1<<P.RIGHT;static ClipBottom=1<<P.BOTTOM;static ClipTop=1<<P.TOP;static ClipFront=1<<P.FRONT;static ClipBack=1<<P.BACK;_minPoint;_maxPoint;constructor(t,e){t instanceof q?(this._minPoint=new z(t.minPoint),this._maxPoint=new z(t.maxPoint)):t instanceof z?(this._minPoint=new z(t),this._maxPoint=new z(e)):(this._minPoint=new z(-1,-1,-1),this._maxPoint=new z(1,1,1))}get minPoint(){return this._minPoint}set minPoint(t){this._minPoint.set(t)}get maxPoint(){return this._maxPoint}set maxPoint(t){this._maxPoint.set(t)}get extents(){return z.sub(this._maxPoint,this._minPoint).scaleBy(.5)}get center(){return z.add(this._maxPoint,this._minPoint).scaleBy(.5)}get size(){return z.sub(this._maxPoint,this._minPoint)}get diagonalLength(){return z.sub(this._maxPoint,this._minPoint).magnitude}computePoints(){const{x:t,y:e,z:i}=this._minPoint,{x:s,y:r,z:a}=this._maxPoint;return[new z(t,e,i),new z(t,r,i),new z(s,e,i),new z(s,r,i),new z(t,e,a),new z(t,r,a),new z(s,e,a),new z(s,r,a)]}inplaceTransform(t){return q.transform(this,t,this),this}beginExtend(){return this._minPoint.setXYZ(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this._maxPoint.setXYZ(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),this}extend(t){return this._minPoint.inplaceMin(t),this._maxPoint.inplaceMax(t),this}extend3(t,e,i){return t<this._minPoint.x&&(this._minPoint.x=t),t>this._maxPoint.x&&(this._maxPoint.x=t),e<this._minPoint.y&&(this._minPoint.y=e),e>this._maxPoint.y&&(this._maxPoint.y=e),i<this._minPoint.z&&(this._minPoint.z=i),i>this._maxPoint.z&&(this._maxPoint.z=i),this}union(t){return t&&t.isValid()&&(this.extend(t._minPoint),this.extend(t._maxPoint)),this}isValid(){return this._minPoint.x<=this._maxPoint.x&&this._minPoint.y<=this._maxPoint.y&&this._minPoint.z<=this._maxPoint.z}equalsTo(t,e){return this._minPoint.equalsTo(t._minPoint,e)&&this._maxPoint.equalsTo(t._maxPoint,e)}intersectedWithBox(t){return!(this._maxPoint.x<=t._minPoint.x||this._minPoint.x>=t._maxPoint.x||this._maxPoint.y<=t._minPoint.y||this._minPoint.y>=t._maxPoint.y||this._maxPoint.z<=t._minPoint.z||this._minPoint.z>=t._maxPoint.z)}containsPoint(t){return this._minPoint.x<=t.x&&this._maxPoint.x>=t.x&&this._minPoint.y<=t.y&&this._maxPoint.y>=t.y&&this._minPoint.z<=t.z&&this._maxPoint.z>=t.z}containsBox(t){return this._minPoint.x<=t._minPoint.x&&this._maxPoint.x>=t._maxPoint.x&&this._minPoint.y<=t._minPoint.y&&this._maxPoint.y>=t._maxPoint.y&&this._minPoint.z<=t._minPoint.z&&this._maxPoint.z>=t._maxPoint.z}getClipStateMask(t,e){let i=65535,s=0;const r=new z,a=new O,n=e&q.ClipLeft,o=e&q.ClipRight,h=e&q.ClipTop,l=e&q.ClipBottom,u=e&q.ClipFront,c=e&q.ClipBack,d=this._minPoint,p=this._maxPoint;for(let e=0;e<8;e++){let m=0;r.setXYZ(1&e?d.x:p.x,2&e?d.y:p.y,3&e?d.z:p.z),t.transformPoint(r,a),n&&a.x<-a.w?m|=q.ClipLeft:o&&a.x>a.w&&(m|=q.ClipRight),l&&a.y<-a.w?m|=q.ClipBottom:h&&a.y>a.w&&(m|=q.ClipTop),c&&a.z<-a.w?m|=q.ClipBack:u&&a.z>a.w&&(m|=q.ClipFront),i&=m,s|=m}return 0===s?$.A_INSIDE_B:0!==i?$.NOT_CLIPPED:$.CLIPPED}getClipState(t){let e=65535,i=0;const s=new z,r=new O,a=this._minPoint,n=this._maxPoint;for(let o=0;o<8;o++){let h=0;s.setXYZ(1&o?a.x:n.x,2&o?a.y:n.y,3&o?a.z:n.z),t.transformPoint(s,r),r.x<-r.w?h|=q.ClipLeft:r.x>r.w&&(h|=q.ClipRight),r.y<-r.w?h|=q.ClipBottom:r.y>r.w&&(h|=q.ClipTop),r.z<-r.w?h|=q.ClipBack:r.z>r.w&&(h|=q.ClipFront),e&=h,i|=h}return 0===i?$.A_INSIDE_B:0!==e?$.NOT_CLIPPED:$.CLIPPED}behindPlane(t){const e=.5*(this._maxPoint.x+this._minPoint.x),i=.5*(this._maxPoint.y+this._minPoint.y),s=.5*(this._maxPoint.z+this._minPoint.z),r=this._maxPoint.x-e,a=this._maxPoint.y-i,n=this._maxPoint.z-s;return t.a*(e+t.px*r)+t.b*(i+t.py*a)+t.c*(s+t.pz*n)+t.d<0}getClipStateWithFrustum(t){let e=!1;const i=.5*(this._maxPoint.x+this._minPoint.x),s=.5*(this._maxPoint.y+this._minPoint.y),r=.5*(this._maxPoint.z+this._minPoint.z),a=this._maxPoint.x-i,n=this._maxPoint.y-s,o=this._maxPoint.z-r;for(let h=0;h<6;h++){const l=t.planes[h];if(l.a*(i+l.px*a)+l.b*(s+l.py*n)+l.c*(r+l.pz*o)+l.d<0)return $.NOT_CLIPPED;l.a*(i+l.nx*a)+l.b*(s+l.ny*n)+l.c*(r+l.nz*o)+l.d<0&&(e=!0)}return e?$.CLIPPED:$.A_INSIDE_B}getClipStateWithFrustumMask(t,e){let i=!1;const s=.5*(this._maxPoint.x+this._minPoint.x),r=.5*(this._maxPoint.y+this._minPoint.y),a=.5*(this._maxPoint.z+this._minPoint.z),n=this._maxPoint.x-s,o=this._maxPoint.y-r,h=this._maxPoint.z-a;for(let l=0;l<6;l++)if(e&1<<l){const e=t.planes[l];if(e.a*(s+e.px*n)+e.b*(r+e.py*o)+e.c*(a+e.pz*h)+e.d<0)return $.NOT_CLIPPED;e.a*(s+e.nx*n)+e.b*(r+e.ny*o)+e.c*(a+e.nz*h)+e.d<0&&(i=!0)}return i?$.CLIPPED:$.A_INSIDE_B}static transform(t,e,i){const s=i||new q,r=[0,0,0],a=[0,0,0],n=t.minPoint,o=t.maxPoint;let h;for(let t=0;t<3;++t){h=t,r[t]=a[t]=e[12+t];for(let i=0;i<3;++i){const s=e[h]*n[i],l=e[h]*o[i];s<l?(r[t]+=s,a[t]+=l):(r[t]+=l,a[t]+=s),h+=4}}return s.minPoint.set(r),s.maxPoint.set(a),s}}const Y=new z,Z=new z,K=new z,J=new z,tt=new z;class et{_origin;_direction;_ii;_ij;_ik;_ibyj;_jbyi;_kbyj;_jbyk;_ibyk;_kbyi;_c_xy;_c_xz;_c_yx;_c_yz;_c_zx;_c_zy;bboxIntersectionTest;bboxIntersectionTestEx;constructor(t,e){this._origin=t?new z(t):z.zero(),this._direction=e?new z(e):z.axisPZ(),this.prepare()}get origin(){return this._origin}get direction(){return this._direction}set(t,e){this._origin.set(t),this._direction.set(e),this.prepare()}transform(t,e){if(e)t.transformPointAffine(z.add(this._origin,this._direction),e._direction),t.transformPointAffine(this._origin,e._origin),e._direction.subBy(e._origin).inplaceNormalize(),e.prepare();else{const i=t.transformPointAffine(this._origin),s=t.transformPointAffine(z.add(this._origin,this._direction)).subBy(i).inplaceNormalize();e=new et(i,s)}return e}intersectionTestCircle(t,e,i,s){const r=this.origin,a=this.direction,n=t,o=e,h=i,l=z.sub(r,n),u=z.dot(a,o),c=z.dot(l,o);if(Math.abs(u)<.1){const e=this.intersectionTestSphere(t,i+Math.abs(s));if(!e)return null;let n=s,h=-1;for(const i of e){const e=z.dot(z.sub(z.add(r,z.scale(a,i)),t),o);Math.abs(e)<n&&(h=i,n=Math.abs(e))}if(h>=0)return{dist:h,epsl:n}}const d=-c/u;if(d>=0){const t=(t=>{const e=z.sub(t,n).magnitude;return e<1e-12?h:Math.abs(e-h)})(z.add(r,z.scale(a,d)));return t<=s?{dist:d,epsl:t}:null}return null}intersectionTestSphere(t,e){const i=z.sub(this._origin,t),s=z.dot(this._direction,this._direction),r=2*z.dot(i,this._direction),a=r*r-4*s*(z.dot(i,i)-e*e);if(a<0)return null;const n=Math.sqrt(a);let o=(-r-n)/(2*s),h=(-r+n)/(2*s);if(o>h){const t=o;o=h,h=t}if(o>=0||h>=0){const t=[];return o>=0&&t.push(o),h>=0&&t.push(h),t}return null}intersectionTestTriangle(t,e,i,s){const r=this._origin,a=this._direction,n=z.sub(e,t,Y),o=z.sub(i,t,Z),h=z.cross(a,o,K),l=z.dot(n,h);if(s){if(l<0)return null;const e=z.sub(r,t,J),i=z.dot(e,h);if(i<0||i>l)return null;const s=z.cross(e,n,tt),u=z.dot(a,s);return u<0||i+u>l?null:z.dot(o,s)/l}{if(l>-1e-4&&l<1e-4)return null;const e=1/l,i=z.sub(r,t,J),s=e*z.dot(i,h);if(s<0||s>1)return null;const u=z.cross(i,n,tt),c=e*z.dot(a,u);return c<0||s+c>1?null:z.dot(o,u)*e}}qtestMMM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.y<i||this._origin.z<s||this._jbyi*e-a+this._c_xy>0||this._ibyj*i-r+this._c_yx>0||this._jbyk*s-a+this._c_zy>0||this._kbyj*i-n+this._c_yz>0||this._kbyi*e-n+this._c_xz>0||this._ibyk*s-r+this._c_zx>0)}qtestMMMEx(t){if(!this.qtestMMM(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestMMP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.y<i||this._origin.z>n||this._jbyi*e-a+this._c_xy>0||this._ibyj*i-r+this._c_yx>0||this._jbyk*n-a+this._c_zy>0||this._kbyj*i-s+this._c_yz<0||this._kbyi*e-s+this._c_xz<0||this._ibyk*n-r+this._c_zx>0)}qtestMMPEx(t){if(!this.qtestMMP(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestMPM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.y>a||this._origin.z<s||this._jbyi*e-i+this._c_xy<0||this._ibyj*a-r+this._c_yx>0||this._jbyk*s-i+this._c_zy<0||this._kbyj*a-n+this._c_yz>0||this._kbyi*e-n+this._c_xz>0||this._ibyk*s-r+this._c_zx>0)}qtestMPMEx(t){if(!this.qtestMPM(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestMPP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.y>a||this._origin.z>n||this._jbyi*e-i+this._c_xy<0||this._ibyj*a-r+this._c_yx>0||this._jbyk*n-i+this._c_zy<0||this._kbyj*a-s+this._c_yz<0||this._kbyi*e-s+this._c_xz<0||this._ibyk*n-r+this._c_zx>0)}qtestMPPEx(t){if(!this.qtestMPP(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPMM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x>r||this._origin.y<i||this._origin.z<s||this._jbyi*r-a+this._c_xy>0||this._ibyj*i-e+this._c_yx<0||this._jbyk*s-a+this._c_zy>0||this._kbyj*i-n+this._c_yz>0||this._kbyi*r-n+this._c_xz>0||this._ibyk*s-e+this._c_zx<0)}qtestPMMEx(t){if(!this.qtestPMM(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPMP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x>r||this._origin.y<i||this._origin.z>n||this._jbyi*r-a+this._c_xy>0||this._ibyj*i-e+this._c_yx<0||this._jbyk*n-a+this._c_zy>0||this._kbyj*i-s+this._c_yz<0||this._kbyi*r-s+this._c_xz<0||this._ibyk*n-e+this._c_zx<0)}qtestPMPEx(t){if(!this.qtestPMP(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPPM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x>r||this._origin.y>a||this._origin.z<s||this._jbyi*r-i+this._c_xy<0||this._ibyj*a-e+this._c_yx<0||this._jbyk*s-i+this._c_zy<0||this._kbyj*a-n+this._c_yz>0||this._kbyi*r-n+this._c_xz>0||this._ibyk*s-e+this._c_zx<0)}qtestPPMEx(t){if(!this.qtestPPM(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.maxPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestPPP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x>r||this._origin.y>a||this._origin.z>n||this._jbyi*r-i+this._c_xy<0||this._ibyj*a-e+this._c_yx<0||this._jbyk*n-i+this._c_zy<0||this._kbyj*a-s+this._c_yz<0||this._kbyi*r-s+this._c_xz<0||this._ibyk*n-e+this._c_zx<0)}qtestPPPEx(t){if(!this.qtestPPP(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;i>e&&(e=i);const s=(t.minPoint.z-this._origin.z)*this._ik;return s>e&&(e=s),e}qtestOMM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y<i||this._origin.z<s||this._jbyk*s-a+this._c_zy>0||this._kbyj*i-n+this._c_yz>0)}qtestOMMEx(t){if(!this.qtestOMM(t))return null;let e=(t.maxPoint.y-this._origin.y)*this._ij;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestOMP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y<i||this._origin.z>n||this._jbyk*n-a+this._c_zy>0||this._kbyj*i-s+this._c_yz<0)}qtestOMPEx(t){if(!this.qtestOMP(t))return null;let e=(t.maxPoint.y-this._origin.y)*this._ij;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestOPM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y>a||this._origin.z<s||this._jbyk*s-i+this._c_zy<0||this._kbyj*a-n+this._c_yz>0)}qtestOPMEx(t){if(!this.qtestOPM(t))return null;let e=(t.minPoint.y-this._origin.y)*this._ij;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestOPP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.x<e||this._origin.x>r||this._origin.y>a||this._origin.z>n||this._jbyk*n-i+this._c_zy<0||this._kbyj*a-s+this._c_yz<0)}qtestOPPEx(t){if(!this.qtestOPP(t))return null;let e=(t.minPoint.y-this._origin.y)*this._ij;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestMOM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>a||this._origin.x<e||this._origin.z<s||this._kbyi*e-n+this._c_xz>0||this._ibyk*s-r+this._c_zx>0)}qtestMOMEx(t){if(!this.qtestMOM(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestMOP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>a||this._origin.x<e||this._origin.z>n||this._kbyi*e-s+this._c_xz<0||this._ibyk*n-r+this._c_zx>0)}qtestMOPEx(t){if(!this.qtestMOP(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestPOM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>a||this._origin.x>r||this._origin.z<s||this._kbyi*r-n+this._c_xz>0||this._ibyk*s-e+this._c_zx<0)}qtestPOMEx(t){if(!this.qtestPOM(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestPOP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.y<i||this._origin.y>a||this._origin.x>r||this._origin.z>n||this._kbyi*r-s+this._c_xz<0||this._ibyk*n-e+this._c_zx<0)}qtestPOPEx(t){if(!this.qtestPOP(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.z-this._origin.z)*this._ik;return i>e&&(e=i),e}qtestMMO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>n||this._origin.x<e||this._origin.y<i||this._jbyi*e-a+this._c_xy>0||this._ibyj*i-r+this._c_yx>0)}qtestMMOEx(t){if(!this.qtestMMO(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestMPO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>n||this._origin.x<e||this._origin.y>a||this._jbyi*e-i+this._c_xy<0||this._ibyj*a-r+this._c_yx>0)}qtestMPOEx(t){if(!this.qtestMPO(t))return null;let e=(t.maxPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestPMO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>n||this._origin.x>r||this._origin.y<i||this._jbyi*r-a+this._c_xy>0||this._ibyj*i-e+this._c_yx<0)}qtestPMOEx(t){if(!this.qtestPMO(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.maxPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestPPO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y,n=t.maxPoint.z;return!(this._origin.z<s||this._origin.z>n||this._origin.x>r||this._origin.y>a||this._jbyi*r-i+this._c_xy<0||this._ibyj*a-e+this._c_yx<0)}qtestPPOEx(t){if(!this.qtestPPO(t))return null;let e=(t.minPoint.x-this._origin.x)*this._ii;const i=(t.minPoint.y-this._origin.y)*this._ij;return i>e&&(e=i),e}qtestMOO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x<e||this._origin.y<i||this._origin.y>r||this._origin.z<s||this._origin.z>a)}qtestMOOEx(t){if(!this.qtestMOO(t))return null;return(t.maxPoint.x-this._origin.x)*this._ii}qtestPOO(t){const e=t.minPoint.y,i=t.minPoint.z,s=t.maxPoint.x,r=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.x>s||this._origin.y<e||this._origin.y>r||this._origin.z<i||this._origin.z>a)}qtestPOOEx(t){if(!this.qtestPOO(t))return null;return(t.minPoint.x-this._origin.x)*this._ii}qtestOMO(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.z;return!(this._origin.y<i||this._origin.x<e||this._origin.x>r||this._origin.z<s||this._origin.z>a)}qtestOMOEx(t){if(!this.qtestOMO(t))return null;return(t.maxPoint.y-this._origin.y)*this._ij}qtestOPO(t){const e=t.minPoint.x,i=t.minPoint.z,s=t.maxPoint.x,r=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.y>r||this._origin.x<e||this._origin.x>s||this._origin.z<i||this._origin.z>a)}qtestOPOEx(t){if(!this.qtestOPO(t))return null;return(t.minPoint.y-this._origin.y)*this._ij}qtestOOM(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.minPoint.z,r=t.maxPoint.x,a=t.maxPoint.y;return!(this._origin.z<s||this._origin.x<e||this._origin.x>r||this._origin.y<i||this._origin.y>a)}qtestOOMEx(t){if(!this.qtestOOM(t))return null;return(t.maxPoint.z-this._origin.z)*this._ik}qtestOOP(t){const e=t.minPoint.x,i=t.minPoint.y,s=t.maxPoint.x,r=t.maxPoint.y,a=t.maxPoint.z;return!(this._origin.z>a||this._origin.x<e||this._origin.x>s||this._origin.y<i||this._origin.y>r)}qtestOOPEx(t){if(!this.qtestOOP(t))return null;return(t.minPoint.z-this._origin.z)*this._ik}prepare(){const t=this._origin.x,e=this._origin.y,i=this._origin.z,s=this._direction.x,r=this._direction.y,a=this._direction.z;this._ii=1/s,this._ij=1/r,this._ik=1/a,this._ibyj=s*this._ij,this._jbyi=r*this._ii,this._jbyk=r*this._ik,this._kbyj=a*this._ij,this._ibyk=s*this._ik,this._kbyi=a*this._ii,this._c_xy=e-this._jbyi*t,this._c_xz=i-this._kbyi*t,this._c_yx=t-this._ibyj*e,this._c_yz=i-this._kbyj*e,this._c_zx=t-this._ibyk*i,this._c_zy=e-this._jbyk*i,s<0?r<0?a<0?(this.bboxIntersectionTest=this.qtestMMM,this.bboxIntersectionTestEx=this.qtestMMMEx):a>0?(this.bboxIntersectionTest=this.qtestMMP,this.bboxIntersectionTestEx=this.qtestMMPEx):(this.bboxIntersectionTest=this.qtestMMO,this.bboxIntersectionTestEx=this.qtestMMOEx):a<0?(this.bboxIntersectionTest=r>0?this.qtestMPM:this.qtestMOM,this.bboxIntersectionTestEx=r>0?this.qtestMPMEx:this.qtestMOMEx):0===r&&0===a?(this.bboxIntersectionTest=this.qtestMOO,this.bboxIntersectionTestEx=this.qtestMOOEx):0===a?(this.bboxIntersectionTest=this.qtestMPO,this.bboxIntersectionTestEx=this.qtestMPOEx):0===r?(this.bboxIntersectionTest=this.qtestMOP,this.bboxIntersectionTestEx=this.qtestMOPEx):(this.bboxIntersectionTest=this.qtestMPP,this.bboxIntersectionTestEx=this.qtestMPPEx):r<0?a<0?(this.bboxIntersectionTest=s>0?this.qtestPMM:this.qtestOMM,this.bboxIntersectionTestEx=s>0?this.qtestPMMEx:this.qtestOMMEx):0===s&&0===a?(this.bboxIntersectionTest=this.qtestOMO,this.bboxIntersectionTestEx=this.qtestOMOEx):0===a?(this.bboxIntersectionTest=this.qtestPMO,this.bboxIntersectionTestEx=this.qtestPMOEx):0===s?(this.bboxIntersectionTest=this.qtestOMP,this.bboxIntersectionTestEx=this.qtestOMPEx):(this.bboxIntersectionTest=this.qtestPMP,this.bboxIntersectionTestEx=this.qtestPMPEx):a<0?0===s&&0===r?(this.bboxIntersectionTest=this.qtestOOM,this.bboxIntersectionTestEx=this.qtestOOMEx):0===s?(this.bboxIntersectionTest=this.qtestOPM,this.bboxIntersectionTestEx=this.qtestOPMEx):0===r?(this.bboxIntersectionTest=this.qtestPOM,this.bboxIntersectionTestEx=this.qtestPOMEx):(this.bboxIntersectionTest=this.qtestPPM,this.bboxIntersectionTestEx=this.qtestPPMEx):0===s?0===r?(this.bboxIntersectionTest=this.qtestOOP,this.bboxIntersectionTestEx=this.qtestOOPEx):0===a?(this.bboxIntersectionTest=this.qtestOPO,this.bboxIntersectionTestEx=this.qtestOPOEx):(this.bboxIntersectionTest=this.qtestOPP,this.bboxIntersectionTestEx=this.qtestOPPEx):0===r&&0===a?(this.bboxIntersectionTest=this.qtestPOO,this.bboxIntersectionTestEx=this.qtestPOOEx):0===r?(this.bboxIntersectionTest=this.qtestPOP,this.bboxIntersectionTestEx=this.qtestPOPEx):0===a?(this.bboxIntersectionTest=this.qtestPPO,this.bboxIntersectionTestEx=this.qtestPPOEx):(this.bboxIntersectionTest=this.qtestPPP,this.bboxIntersectionTestEx=this.qtestPPPEx)}}const it=new U,st=new U,rt=new U,at={number:1,vec2:2,vec3:3,vec4:4,quat:4};function nt(t,e,i){return t<e?e:t>i?i:t}class ot{_prevKey;_prevT;_inputs;_outputs;_mode;_target;_stride;_maxTime;_a;_h;static getTargetStride(t){return at[t]??0}constructor(t,e,i,s){this._prevKey=0,this._prevT=0,this._inputs=i,this._outputs=s,this._mode=t,this._target=e,this._stride=at[e]??Math.floor(s.length/i.length),this._maxTime=i[i.length-1],this._a=null,this._h=null}get mode(){return this._mode}set mode(t){t!==this._mode&&(this._mode=t,this._stride=at[this._target]??Math.floor(this._outputs.length/this._inputs.length))}get target(){return this._target}set target(t){t!==this._target&&(this._target=t,this._stride=at[this._target]??Math.floor(this._outputs.length/this._inputs.length))}get stride(){return this._stride}get maxTime(){return this._maxTime}get inputs(){return this._inputs}set inputs(t){t!==this._inputs&&(this._inputs=t,this._a=null,this._h=null)}get outputs(){return this._outputs}set outputs(t){t!==this._outputs&&(this._outputs=t,this._a=null,this._h=null)}interpolate(t,e){if(void 0===t)return;const i=t,s=this._inputs,r=this._outputs;if(r.length===this._stride){for(let t=0;t<this._stride;t++)e[t]=r[t];return e}let a;t=nt(t,s[0],s[s.length-1]),this._prevT>t&&(this._prevKey=0),this._prevT=t;for(let e=this._prevKey;e<s.length;++e)if(t<=s[e]){a=nt(e,1,s.length-1);break}this._prevKey=nt(a-1,0,a);const n=s[a]-s[this._prevKey],o=(t-s[this._prevKey])/n;if("quat"===this._target){if("cubicspline"===this._mode)return this.cubicSpline(this._prevKey,a,n,o,e),e;if("cubicspline-natural"!==this._mode)return"linear"===this._mode?(this.getQuat(this._prevKey,it),this.getQuat(a,st),this.slerpQuat(it,st,o,rt),e[0]=rt.x,e[1]=rt.y,e[2]=rt.z,e[3]=rt.w,e):this.getQuat(this._prevKey,e);this.cubicSplineNatural(this._prevKey,a,i,o,e)}switch(this._mode){case"step":return this.step(this._prevKey,e);case"cubicspline":return this.cubicSpline(this._prevKey,a,n,o,e);case"cubicspline-natural":return this.cubicSplineNatural(this._prevKey,a,i,o,e);default:return this.linear(this._prevKey,a,o,e)}}getQuat(t,e){return e[0]=this._outputs[4*t],e[1]=this._outputs[4*t+1],e[2]=this._outputs[4*t+2],e[3]=this._outputs[4*t+3],e}step(t,e){for(let i=0;i<this._stride;i++)e[i]=this._outputs[t*this._stride+i];return e}linear(t,e,i,s){for(let r=0;r<this._stride;r++)s[r]=this._outputs[t*this._stride+r]*(1-i)+this._outputs[e*this._stride+r]*i;return s}cubicSpline(t,e,i,s,r){const a=t*this._stride*3,n=e*this._stride*3,o=this._stride,h=2*this._stride,l=s*s,u=l*s;for(let t=0;t<this._stride;t++){const e=this._outputs[a+t+o],c=i*this._outputs[n+t+0],d=i*this._outputs[a+t+h],p=this._outputs[n+t+o];r[t]=(2*u-3*l+1)*e+(u-2*l+s)*d+(-2*u+3*l)*p+(u-l)*c}return r}cubicSplineNatural(t,e,i,s,r){if(2===this._inputs.length)return this.linear(t,e,s,r);this._a||this._prepareCubicSplineNatural();const a=Math.min(Math.max(this._getSegment(i),0),this._inputs.length-2)+1,n=i-this._inputs[a-1],o=this._h[a]-n;for(let t=0;t<this._stride;t++)r[t]=((-this._a[(a-1)*this._stride+t]/6*(o+this._h[a])*n+this._outputs[(a-1)*this._stride+t])*o+(-this._a[a*this._stride+t]/6*(n+this._h[a])*o+this._outputs[a*this._stride+t])*n)/this._h[a];return r}_prepareCubicSplineNatural(){const t=this._inputs.length,e=new Array(t-1),i=new Array(t-1),s=new Array(t-1);this._h=new Array(t),this._a=new Array(t*this._stride);for(let e=0;e<this._stride;e++)this._a[e]=0,this._a[t*this._stride-1-e]=0;for(let e=1;e<t;++e)this._h[e]=this._inputs[e]-this._inputs[e-1];for(let r=1;r<t-1;++r){i[r]=(this._h[r]+this._h[r+1])/3,s[r]=this._h[r+1]/6,e[r]=this._h[r]/6;for(let t=0;t<this._stride;t++){const e=r*this._stride+t;this._a[e]=(this._outputs[e+this._stride]-this._outputs[e])/this._h[r+1]-(this._outputs[e]-this._outputs[e-this._stride])/this._h[r]}}this.solveTridiag(e,i,s)}solveTridiag(t,e,i){const s=this._inputs.length-2;for(let r=2;r<=s;++r)t[r]/=e[r-1],e[r]-=t[r]*i[r-1],this._a[r]-=this._a[r-1]*t[r];for(let t=0;t<this._stride;t++)this._a[s*this._stride+t]/=e[s];for(let t=s-1;t>=1;--t)for(let s=0;s<this._stride;s++){const r=t*this._stride+s;this._a[r]=(this._a[r]-this._a[r+this._stride]*i[t])/e[t]}}_getSegment(t){if(t<this._inputs[0])return-1;if(t>=this._inputs[this._inputs.length-1])return this._inputs.length;let e=0;for(;e<this._inputs.length-1&&!(t<this._inputs[e+1]);++e);return e==this._inputs.length&&(e=this._inputs.length-1),e}slerpQuat(t,e,i,s){return U.slerp(t,e,i,s).inplaceNormalize()}}class ht{_bins;_maxBins;_width;_height;constructor(t,e,i=0){this._width=t,this._height=e,this._maxBins=i,this._bins=[new lt(this._width,this._height)]}clear(){this._bins=[new lt(this._width,this._height)]}insert(t,e){if(t>this._width||e>this._height)return null;const i=this._bins[this._bins.length-1].insert(t,e);if(i)return{x:i.x,y:i.y,width:i.width,height:i.height,binIndex:this._bins.length-1};if(0===this._maxBins||this._bins.length<this._maxBins){this._bins.push(new lt(this._width,this._height));const i=this._bins[this._bins.length-1].insert(t,e);return{x:i.x,y:i.y,width:i.width,height:i.height,binIndex:this._bins.length-1}}return null}}class lt{freeRects;constructor(t,e){this.freeRects=[{x:0,y:0,width:t,height:e}]}insert(t,e){const i=this.findBestFit(t,e);if(!i)return null;let s=this.freeRects.length,r=0;for(;r<s;)this.splitFreeRect(this.freeRects[r],i)&&(this.freeRects.splice(r,1),--s,--r),++r;return this.pruneFreeRects(),i}findBestFit(t,e){let i=Number.MAX_VALUE,s=null;for(const r of this.freeRects)if(r.width>=t&&r.height>=e){const a=r.width*r.height-t*e;a<i&&(s||(s={width:t,height:e}),s.x=r.x,s.y=r.y,i=a)}return s}splitFreeRect(t,e){return!(e.x>=t.x+t.width||e.x+e.width<=t.x||e.y>=t.y+t.height||e.y+e.height<=t.y)&&(e.x<t.x+t.width&&e.x+e.width>t.x&&(e.y>t.y&&e.y<t.y+t.height&&this.freeRects.push({x:t.x,y:t.y,width:t.width,height:e.y-t.y}),e.y+e.height<t.y+t.height&&this.freeRects.push({x:t.x,y:e.y+e.height,width:t.width,height:t.y+t.height-e.y-e.height})),e.y<t.y+t.height&&e.y+e.height>t.y&&(e.x>t.x&&e.x<t.x+t.width&&this.freeRects.push({x:t.x,y:t.y,width:e.x-t.x,height:t.height}),e.x+e.width<t.x+t.width&&this.freeRects.push({x:e.x+e.width,y:t.y,width:t.x+t.width-e.x-e.width,height:t.height})),!0)}pruneFreeRects(){let t=0,e=0,i=this.freeRects.length;for(;t<i;){e=t+1;const s=this.freeRects[t];for(;e<i;){const r=this.freeRects[e];if(this.isRectInRect(s,r)){this.freeRects.splice(t,1),--t,--i;break}this.isRectInRect(r,s)&&(this.freeRects.splice(e,1),--e,--i),e++}t++}}isRectInRect(t,e){return t.x>=e.x&&t.y>=e.y&&t.x+t.width<=e.x+e.width&&t.y+t.height<=e.y+e.height}}class ut{_generator;constructor(t=0){this._generator=()=>{let e=t+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}}get(){return this._generator()}}class ct{static normalize(t){const e=t.split("/").filter(t=>t&&"."!==t),i=[];for(const t of e)".."===t?i.pop():i.push(t);return"/"+i.join("/")}static join(...t){return this.normalize(t.join("/"))}static dirname(t){const e=this.normalize(t),i=e.lastIndexOf("/");return i<=0?"/":e.slice(0,i)}static basename(t,e){const i=this.normalize(t),s=i.lastIndexOf("/");let r=i.slice(s+1);return e&&r.endsWith(e)&&(r=r.slice(0,-e.length)),r}static extname(t){const e=this.basename(t),i=e.lastIndexOf(".");return-1===i?"":e.slice(i)}static sanitizeFilename(t,e){const{replacement:i="_",maxLength:s=255,asciiOnly:r=!1}=e??{};let a=t.replace(/[<>:"/\\|?*]/g,i);a=Array.from(a).map(t=>{const e=t.charCodeAt(0);return e<=31||127===e||r&&(e<32||e>126)?i:t}).join(""),a=a.replace(/\s+/g," ").replace(/^[\s.]+|[\s.]+$/g,""),a||(a="unnamed");const n=a.split(".")[0];if(/^(CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])$/i.test(n)&&(a=i+a),a.length>s){const t=a.lastIndexOf(".");if(t>0&&a.length-t<=10){const e=a.slice(t),i=a.slice(0,s-e.length);a=i+e}else a=a.slice(0,s)}return a}static isAbsolute(t){return t.startsWith("/")}static relative(t,e){const i=this.normalize(t).split("/").filter(Boolean),s=this.normalize(e).split("/").filter(Boolean);let r=0;for(;r<i.length&&r<s.length&&i[r]===s[r];)r++;return"../".repeat(i.length-r)+s.slice(r).join("/")||"."}}class dt extends Error{code;path;constructor(t,e,i){super(t),this.code=e,this.path=i,this.name="VFSError"}}class pt{pattern;regex;constructor(t,e=!0){this.pattern=t,this.regex=this.compilePattern(t,e)}test(t){return this.regex.test(t)}getPattern(){return this.pattern}compilePattern(t,e){let i="",s=!1;const r=e?"":"i";let a;for(let e=0,r=t.length;e<r;e++)switch(a=t[e],a){case"/":case"$":case"^":case"+":case".":case"(":case")":case"=":case"!":case"|":i+="\\"+a;break;case"?":i+=".";break;case"[":case"]":default:i+=a;break;case"{":s=!0,i+="(";break;case"}":s=!1,i+=")";break;case",":if(s){i+="|";break}i+="\\"+a;break;case"*":{const s=t[e-1];let r=1;for(;"*"===t[e+1];)r++,e++;const a=t[e+1];r>1&&("/"===s||void 0===s)&&("/"===a||void 0===a)?(i+="((?:[^/]*(?:/|$))*)",e++):i+="([^/]*)";break}}return r&&~r.indexOf("g")||(i="^"+i+"$"),new RegExp(i,r)}}class mt extends b{_readOnly;_cwd="/";_dirStack;simpleMounts;sortedMountPaths;mountChangeCallbacks;constructor(t=!1){super(),this._readOnly=t,this._dirStack=[],this.simpleMounts=new Map,this._cwd="/",this.sortedMountPaths=[],this.mountChangeCallbacks=new Map}get readOnly(){return this._readOnly}set readOnly(t){this.setReadonly(t)}getSimpleMountPoints(){return Array.from(this.simpleMounts.keys())}hasMounts(){return this.simpleMounts.size>0}parseDataURI(t){return t?.match(/^data:([^;]+)/)??null}isObjectURL(t){return"string"==typeof t&&t.startsWith("blob:")}isAbsoluteURL(t){return"string"==typeof t&&(t.startsWith("http://")||t.startsWith("https://"))}async deleteFileSystem(){await this._deleteFileSystem()}async wipe(){await this._wipe()}getCwd(){return this._cwd}async chdir(t){const e=this.normalizePath(t);if(!await this.exists(e))throw new dt(`Directory does not exist: ${e}`,"ENOENT",e);if(!(await this.stat(e)).isDirectory)throw new dt(`Not a directory: ${e}`,"ENOTDIR",e);this._cwd=e}async pushd(t){this._dirStack.push(this._cwd),await this.chdir(t)}async popd(){if(0===this._dirStack.length)throw new dt("Directory stack is empty","ENOENT");const t=this._dirStack.pop();this._cwd=t}normalizePath(t){if(!t)return this._cwd;if(t.startsWith("/"))return ct.normalize(t);if(this.isAbsoluteURL(t)||this.isObjectURL(t)||this.parseDataURI(t))return encodeURI(t);const e=ct.join(this._cwd,t);return ct.normalize(e)}join(...t){if(0===t.length)return this._cwd;if(t[0].startsWith("/"))return ct.normalize(ct.join(...t));const e=[this._cwd,...t];return ct.normalize(ct.join(...e))}dirname(t){return ct.dirname(t)}isAbsolute(t){return ct.isAbsolute(t)}basename(t,e){return ct.basename(t,e)}extname(t){return ct.extname(t)}relative(t,e){if(this.isObjectURL(t)||this.parseDataURI(t))return t;const i=this.normalizePath(t);return ct.relative(e??this._cwd,i)}isParentOf(t,e){let i=this.normalizePath(t);"/"===i||i.endsWith("/")||(i+="/");let s=this.normalizePath(e);return"/"===e||s.endsWith("/")||(s+="/"),s.startsWith(i)}async move(t,e,i){const s=this.normalizePath(t),r=this.normalizePath(e);this._validateRootRestrictions(s,r);const a=this.getMountedVFS(s),n=this.getMountedVFS(r);if(a||n){if((a?a.vfs:this)!==(n?n.vfs:this))throw new dt("Cross-VFS move is not supported","EXDEV",s);if(a&&n&&a.vfs===n.vfs)return a.vfs.move(a.relativePath,n.relativePath,i)}if(await this._validateTypeCompatibility(s,r,i),this._readOnly)throw new dt("File system is read-only","EROFS",s);const o=(await this.stat(s)).isDirectory?"directory":"file";await this._move(s,r,i),this.onChange("moved",r,o)}async makeDirectory(t,e){const i=this.normalizePath(t);if(this.simpleMounts.has(i))throw new dt("Is a directory","EISDIR",i);const s=this.getMountedVFS(i);if(s)return s.vfs.makeDirectory(s.relativePath,e);if(this._readOnly)throw new dt("File system is read-only","EROFS",i);await this._makeDirectory(i,e??!1),this.onChange("created",i,"directory")}async readDirectory(t,e){const i=this.normalizePath(t);if(this.simpleMounts.has(i)){const t=this.simpleMounts.get(i);return(await t.readDirectory("/",e).catch(()=>[])).map(t=>({...t,path:ct.normalize(ct.join(i,"/"===t.path?"":t.path))}))}const s=this.getMountedVFS(i);if(s){return(await s.vfs.readDirectory(s.relativePath,e)).map(t=>({...t,path:ct.normalize(ct.join(s.mountPath,"/"===t.path?"":t.path))}))}const r=await this._readDirectory(i,e);return this.injectDirectMountDirs(i,r,e)}async deleteDirectory(t,e){const i=this.normalizePath(t);if(!await this.exists(i))return;if(!(await this.stat(i)).isDirectory)throw new dt("Target path is not a directory","ENOTDIR",i);for(const t of this.sortedMountPaths)if(t.startsWith(i.endsWith("/")?i:i+"/"))throw new dt("Cannot delete a directory that contains mounted subdirectories. Unmount them first.","EBUSY",i);const s=this.getMountedVFS(i);if(s)return s.vfs.deleteDirectory(s.relativePath,e);if(this._readOnly)throw new dt("File system is read-only","EROFS",i);await this._deleteDirectory(i,e??!1),this.onChange("deleted",i,"directory")}async readFile(t,e){if(this.isObjectURL(t)||this.parseDataURI(t))try{const i=await fetch(t);if(!i.ok)throw new dt("Failed to fetch","ENOENT",t);let s;if("utf8"===e?.encoding)s=await i.text();else if("base64"===e?.encoding){const t=await i.arrayBuffer(),e=new Uint8Array(t);s=btoa(String.fromCodePoint(...e))}else s=await i.arrayBuffer();return s}catch(e){throw new dt(`Failed to fetch: ${e}`,"EIO",t)}const i=this.normalizePath(t);if(this.simpleMounts.has(i))throw new dt("Is a directory","EISDIR",i);const s=this.getMountedVFS(i);return s?s.vfs.readFile(s.relativePath,e):this._readFile(i,e)}async writeFile(t,e,i){const s=this.normalizePath(t);if(this.simpleMounts.has(s))throw new dt("Is a directory","EISDIR",s);const r=this.getMountedVFS(s);if(r)return r.vfs.writeFile(r.relativePath,e,i);if(this._readOnly)throw new dt("File system is read-only","EROFS",s);const a=await this._exists(s);if(a){if((await this._stat(s)).isDirectory)throw new dt("Is a directory","EISDIR",s)}await this._writeFile(s,e,i),this.onChange(a?"modified":"created",s,"file")}async deleteFile(t){const e=this.normalizePath(t);if(this.simpleMounts.has(e))throw new dt("Is a directory","EISDIR",e);const i=this.getMountedVFS(e);if(i)return i.vfs.deleteFile(i.relativePath);if(this._readOnly)throw new dt("File system is read-only","EROFS",e);await this._deleteFile(e),this.onChange("deleted",e,"file")}async exists(t){const e=this.normalizePath(t);if(this.simpleMounts.has(e))return!0;const i=this.getMountedVFS(e);return i?i.vfs.exists(i.relativePath):this._exists(e)}async stat(t){const e=this.normalizePath(t);if(this.simpleMounts.has(e))return{size:0,isFile:!1,isDirectory:!0,created:new Date(0),modified:new Date(0)};const i=this.getMountedVFS(e);return i?i.vfs.stat(i.relativePath):this._stat(e)}async copyFile(t,e,i){const s=this.getMountedVFS(e),r=i?.targetVFS??(s?s.vfs:this),a=!!i?.overwrite;if(r._readOnly)throw new dt("Target VFS is read-only","EROFS",e);const n=this.normalizePath(t),o=r.normalizePath(s?s.relativePath:e);if(!await this.exists(n))throw new dt(`Source file does not exist: ${n}`,"ENOENT",n);if(!(await this.stat(n)).isFile)throw new dt("Source path is not a file","EISDIR",n);const h=await r.exists(o);if(h&&!a)throw new dt("Target file already exists","EEXIST",o);if(h){if((await r.stat(o)).isDirectory)throw new dt("Target path is a directory","EISDIR",o)}const l=r.dirname(o);await r.exists(l)||await r.makeDirectory(l,!0);const u=await this.readFile(n,{encoding:"binary"});await r.writeFile(o,u,{create:!0,encoding:"binary"})}async copyFileEx(t,e,i){const s=this.getMountedVFS(e),r=i?.targetVFS??(s?s.vfs:this),a=!!i?.overwrite;if(r._readOnly)throw new dt("Target VFS is read-only","EROFS",e);try{const n=r.normalizePath(s?s.relativePath:e);if(await r.exists(n)){if(!(await r.stat(n)).isDirectory)throw new dt("Target path is not a directory","ENOTDIR",n)}else await r.makeDirectory(n,!0);let o=[];o=Array.isArray(t)?t:await this.expandGlobPattern(t,i?.cwd);let h=0;i?.onProgress?.(h,o.length);for(const e of o)try{if(!await this.exists(e)){console.warn(`Source file missing: ${e}`);continue}const l=await this.stat(e),u=this.calculateTargetPath(t,e,n),c=s?.vfs===r?r.normalizePath(ct.relative(s.mountPath,u)):u;if(l.isDirectory){await r.makeDirectory(c,!0);continue}if(await r.exists(c)&&!a)continue;const d=r.dirname(c);await r.exists(d)||await r.makeDirectory(d,!0);const p=await this.readFile(e,{encoding:"binary"});await r.writeFile(c,p,{create:!0,encoding:"binary"}),i?.onProgress?.(++h,o.length)}catch(t){console.error(String(t))}}catch(t){console.error(String(t))}}async glob(t,e={}){const{recursive:i=!0,includeHidden:s=!1,includeDirs:r=!1,includeFiles:a=!0,caseSensitive:n=!0,cwd:o=this._cwd,ignore:h=[],limit:l}=e,u=(Array.isArray(t)?t:[t]).filter(t=>!!t);if(0===u.length)return[];const c=Array.isArray(h)?h:[h],d=u.map(t=>new pt(t,n)),p=c.map(t=>new pt(t,n)),m=[],f=this.normalizePath(o),_=async(t,e=0)=>{if(!(l&&m.length>=l))try{const n=await this.readDirectory(t,{includeHidden:!0});for(const t of n){if(l&&m.length>=l)break;const n=t.path;let o;if(n===f)o=".";else if(n.startsWith(f+"/"))o=n.substring(f.length+1);else{if("/"!==f||!n.startsWith("/"))continue;o=n.substring(1)}if(!s&&t.name.startsWith(".")){i&&"directory"===t.type&&await _(n,e+1);continue}if(p.some(t=>t.test(o)||t.test(n))){i&&"directory"===t.type&&await _(n,e+1);continue}let h=!1,u="";for(const t of d)if(t.test(o)||t.test(n)){h=!0,u=t.getPattern();break}if("directory"===t.type){if(r){const e={...t,relativePath:o,matchedPattern:h?u:null};m.push(e)}}else if(h&&a){const e={...t,relativePath:o,matchedPattern:u};m.push(e)}i&&"directory"===t.type&&await _(n,e+1)}}catch(i){0===e&&console.warn(`Cannot access directory: ${t}`,i)}};return await _(f),m}guessMIMEType(t){const e=this.parseDataURI(t);return e?e[1]:function(t){return{".txt":"text/plain",".html":"text/html",".js":"text/javascript",".mjs":"text/javascript",".ts":"text/x-typescript",".wasm":"application/wasm",".json":"application/json",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".webp":"image/webp",".gif":"image/gif",".tga":"image/tga",".ico":"image/x-icon",".dds":"image/x-dds",".svg":"image/svg+xml",".hdr":"image/vnd.radiance",".exr":"image/x-exr",".tiff":"image/tiff",".wav":"audio/wav",".mp3":"audio/mpeg",".mp4":"video/mp4",".zip":"application/zip",".fbx":"model/fbx",".obj":"model/obj",".gltf":"model/gltf+json",".glb":"model/gltf-binary",".ktx":"image/ktx",".ktx2":"image/ktx2",".zbpt":"application/vnd.zephyr3d.blueprint+json",".zmsh":"application/vnd.zephyr3d.mesh+json",".zmtl":"application/vnd.zephyr3d.material+json",".zmf":"application/vnd.zephyr3d.blueprint.mf+json",".zscn":"application/vnd.zephyr3d.scene+json",".zprefab":"application/vnd.zephyr3d.prefab+json"}[ct.extname(t).toLowerCase()]||"application/octet-stream"}(t)}async mount(t,e){const i=ct.normalize(t);this.simpleMounts.set(i,e),this.sortedMountPaths=Array.from(this.simpleMounts.keys()).sort((t,e)=>e.length-t.length);const s=(t,e,s)=>{const r="/"===e?"":e,a=ct.normalize(ct.join(i,r));this.onChange(t,a,s)};this.mountChangeCallbacks.set(i,s),e.on("changed",s,this)}async unmount(t){const e=ct.normalize(t),i=this.simpleMounts.get(e);return!!i&&(i.off("changed",this.mountChangeCallbacks.get(e)),this.simpleMounts.delete(e),this.mountChangeCallbacks.delete(e),this.sortedMountPaths=Array.from(this.simpleMounts.keys()).sort((t,e)=>e.length-t.length),!0)}async close(){for(const t of this.simpleMounts.keys())await this.unmount(t);await this.onClose()}setReadonly(t){this._readOnly=!!t}onClose(){}getMountedVFS(t){const e=ct.normalize(t);for(const t of this.sortedMountPaths)if(e===t||e.startsWith(t+"/")){const i=e===t?"/":e.slice(t.length);return{mountPath:t,vfs:this.simpleMounts.get(t),relativePath:i}}return null}onChange(t,e,i){this.dispatchEvent("changed",t,e,i)}calculateTargetPath(t,e,i){if(Array.isArray(t)){const t=this.basename(e);return ct.join(i,t)}const s=this.extractPatternDirectory(t),r=this.normalizePath(s),a=this.normalizePath(e);if(a.startsWith(r)){const t=ct.relative(r,a);return ct.join(i,t)}{const t=this.basename(e);return ct.join(i,t)}}async expandGlobPattern(t,e){const i=[];if(t.includes("*")||t.includes("?")){const s=await this.glob(t,{includeFiles:!0,includeDirs:!0,includeHidden:!0,recursive:t.includes("**"),cwd:e??this._cwd});i.push(...s.map(t=>t.path))}else{const e=this.normalizePath(t);if(await this.exists(e)){(await this.stat(e)).isFile&&i.push(e)}}return i}extractPatternDirectory(t){if(t.startsWith("/")){const e=t.substring(1).split("/"),i=[];for(const t of e){if(t.includes("*")||t.includes("?"))break;i.push(t)}return 0===i.length?"/":"/"+i.join("/")}{const e=t.split("/"),i=[];for(const t of e){if(t.includes("*")||t.includes("?"))break;i.push(t)}return i.length>0?i.join("/"):"."}}_validateRootRestrictions(t,e){if("/"===t)throw new dt("Cannot move root directory","EINVAL",t);if("/"===e)throw new dt("Cannot move to root directory","EINVAL",e);if(e.startsWith(t+"/"))throw new dt("Cannot move directory to its subdirectory","EINVAL",t);const i=this.getCwd();if(t===i)throw new dt("Cannot move current working directory","EBUSY",t);if(i.startsWith(t+"/"))throw new dt("Cannot move parent directory of current working directory","EBUSY",t)}injectDirectMountDirs(t,e,i){const s=new Set(e.map(t=>t.name)),r="/"===t?"/":t+"/";for(const a of this.simpleMounts.keys()){if(!a.startsWith(r))continue;if(a===t)continue;const n=a.slice(r.length);if(0===n.length)continue;if(n.includes("/"))continue;const o=n;if(s.has(o))continue;if(!1===i?.includeHidden&&o.startsWith("."))continue;const h={name:o,path:ct.normalize(ct.join(t,o)),size:0,type:"directory",created:new Date(0),modified:new Date(0)};e.push(h),s.add(o)}return e}async _validateTypeCompatibility(t,e,i){if(!await this.exists(t))throw new dt("Source path does not exist","ENOENT",t);const s=await this.stat(t);if(await this.exists(e)){if(!i?.overwrite)throw new dt("Target already exists","EEXIST",e);const r=await this.stat(e);if(s.isFile!==r.isFile||s.isDirectory!==r.isDirectory)throw new dt("Cannot move file to directory or directory to file","EISDIR",t)}}}class ft extends mt{baseOrigin;basePath;options;dirReaders;constructor(t,e={}){super(!0),t=t||"./";const i=new URL(t,window.location.href);this.basePath=i.pathname,this.basePath.endsWith("/")&&(this.basePath=this.basePath.slice(0,-1)),this.baseOrigin=i.origin,this.options={timeout:3e4,...e},this.dirReaders=Array.isArray(e.directoryReader)?e.directoryReader:e.directoryReader?[e.directoryReader]:[]}get urlResolver(){return this.options.urlResolver??null}set urlResolver(t){this.options.urlResolver=t??null}normalizePath(t){return this.options.urlResolver&&(t=this.options.urlResolver(t)),t=t.trim(),this.parseDataURI(t)||this.isObjectURL(t)||this.isAbsoluteURL(t)?t:super.normalizePath(t)}setReadonly(t){t||console.error("Http VFS is always read-only")}async _makeDirectory(t){throw new dt("HTTP file system is read-only","EROFS",t)}async _readDirectory(t,e){const i=this.normalizePath(t),s=i.endsWith("/")?i:i+"/";if(!this.dirReaders.length)throw new dt("No HttpDirectoryReader configured for HttpFS","ENOTSUP",s);const r={fetch:(t,e)=>this.fetchWithTimeout(t,e),toURL:t=>this.toAbsoluteURL(t),normalizePath:t=>super.normalizePath(t),joinPath:(...t)=>ct.join(...t),guessMimeType:t=>this.guessMIMEType(t)},a=await this.selectReader(s,r);if(!a)return console.warn("No directory reader can handle this directory"),[];let n=await a.readOnce(s,r);const o=e?.includeHidden??!1;if(n=n.filter(t=>o||!t.name.startsWith(".")),e?.pattern){const t=e.pattern;if("string"==typeof t){const e=new pt(t,!0);n=n.filter(t=>e.test(t.name)||e.test(t.path))}else n=n.filter(e=>t.test(e.name)||t.test(e.path))}if(!e?.recursive)return n;const h=[...n];for(const t of n)if("directory"===t.type)try{const i=await this._readDirectory(t.path,e);h.push(...i)}catch{}return h}async _deleteDirectory(t){throw new dt("HTTP file system is read-only","EROFS",t)}async _readFile(t,e){try{const s=await this.fetchWithTimeout(t);if(!s.ok)throw 404===s.status?new dt("File not found","ENOENT",t):403===s.status?new dt("Access denied","EACCES",t):s.status>=500?new dt("Server error","EIO",t):new dt(`HTTP error ${s.status}: ${s.statusText}`,"EIO",t);let r;if("utf8"===e?.encoding)r=await s.text();else if("base64"===e?.encoding){const t=await s.arrayBuffer();r=i(new Uint8Array(t))}else r=await s.arrayBuffer();return r}catch(e){if(e instanceof dt)throw e;throw new dt(`Failed to read file: ${e}`,"EIO",t)}}async _writeFile(t,e,i){throw new dt("HTTP file system is read-only","EROFS",t)}async _deleteFile(t){throw new dt("HTTP file system is read-only","EROFS",t)}async _exists(t){const e=this.normalizePath(t);try{return(await this.fetchWithTimeout(e,{method:"HEAD"})).ok}catch{return!1}}async _stat(t){try{const e=await this.fetchWithTimeout(t,{method:"HEAD"});if(!e.ok)throw 404===e.status?new dt("File not found","ENOENT",t):new dt(`HTTP error ${e.status}`,"EIO",t);const i=parseInt(e.headers.get("content-length")||"0"),s=e.headers.get("last-modified"),r=e.headers.get("content-type"),a=r?.includes("text/html")&&t.endsWith("/"),n=s?new Date(s):new Date;return{size:i,isFile:!a,isDirectory:a,created:n,modified:n,accessed:n}}catch(e){if(e instanceof dt)throw e;throw new dt(`Failed to stat file: ${e}`,"EIO",t)}}async _deleteFileSystem(){}async _wipe(){}async _move(){throw new dt("HTTP file system is read-only","EROFS")}toAbsoluteURL(t){if(this.isObjectURL(t)||this.parseDataURI(t)||this.isAbsoluteURL(t))return t;const[e,...i]=t.split("?"),s=i.join("?"),[r,a]=s?s.split("#"):["",""],n=this.join(this.basePath,e).split("/").map(t=>{if(!t||"."===t||".."===t)return t;try{return decodeURIComponent(t)===t?encodeURIComponent(t):t}catch{return encodeURIComponent(t)}}).join("/"),o=new URL(n,this.baseOrigin);return r&&(o.search=r.includes("%")?r:new URLSearchParams(r).toString()),a&&(o.hash=a),o.href}async fetchWithTimeout(t,e){const i=new AbortController,s=setTimeout(()=>i.abort(),this.options.timeout);t=this.toAbsoluteURL(t);try{return await fetch(t,{...e,signal:i.signal,headers:{...this.options.headers,...e?.headers},credentials:this.options.credentials})}finally{clearTimeout(s)}}async selectReader(t,e){if(1===this.dirReaders.length)return this.dirReaders[0];for(const i of this.dirReaders)if(i.canHandle)try{if(await i.canHandle(t,e))return i}catch{}return null}}class _t extends mt{files;directories;metadata;constructor(t=!1){super(t),this.files=new Map,this.directories=new Set(["/"]),this.metadata=new Map;const e=new Date;this.metadata.set("/",{created:e,modified:e,name:"",path:"/",size:0,type:"directory"})}async _makeDirectory(t,e){if(this.directories.has(t))throw new dt("Directory already exists","EEXIST",t);const i=ct.dirname(t);if(!this.directories.has(i)){if(!e)throw new dt("Parent directory does not exist","ENOENT",i);await this._makeDirectory(i,!0)}this.directories.add(t),this.metadata.set(t,{name:ct.basename(t),path:t,size:0,type:"directory",created:new Date,modified:new Date})}async _readDirectory(t,e){if(!this.directories.has(t))throw new dt("Directory does not exist","ENOENT",t);const i=[],s="/"===t?"/":t+"/";for(const r of this.directories)if(r!==t&&r.startsWith(s)){const t=r.slice(s.length);if(!e?.recursive&&t.includes("/"))continue;const a=this.metadata.get(r);a&&i.push(a)}for(const[t]of this.files)if(t.startsWith(s)){const r=t.slice(s.length);if(!e?.recursive&&r.includes("/"))continue;const a=this.metadata.get(t);a&&i.push(a)}return i}async _deleteDirectory(t,e){if(!this.directories.has(t))throw new dt("Directory does not exist","ENOENT",t);if((await this._readDirectory(t)).length>0&&!e)throw new dt("Directory is not empty","ENOTEMPTY",t);if(e){const e=t+"/";for(const[t]of this.files)t.startsWith(e)&&(this.files.delete(t),this.metadata.delete(t));for(const t of this.directories)t.startsWith(e)&&(this.directories.delete(t),this.metadata.delete(t))}this.directories.delete(t),this.metadata.delete(t)}async _readFile(t,e){if(!this.files.has(t))throw new dt(`File does not exist: ${t}`,"ENOENT",t);let s=this.files.get(t);const r=e?.encoding;if("utf8"===r)s instanceof ArrayBuffer&&(s=(new TextDecoder).decode(s));else if("base64"===r){if(s instanceof ArrayBuffer){s=i(new Uint8Array(s))}else if("string"==typeof s){s=i((new TextEncoder).encode(s))}}else"binary"!==r&&r||"string"==typeof s&&(s=(new TextEncoder).encode(s).buffer);if(void 0!==e?.offset||void 0!==e?.length){const t=e.offset||0,i=e.length;if(s instanceof ArrayBuffer){const e=void 0!==i?t+i:s.byteLength;s=s.slice(t,e)}else if("string"==typeof s){const e=void 0!==i?t+i:s.length;s=s.slice(t,e)}}return s}async _writeFile(t,e,i){const r=ct.dirname(t);if(!this.directories.has(r)){if(!i?.create)throw new dt("Parent directory does not exist","ENOENT",r);await this._makeDirectory(r,!0)}let a=e;if("base64"===i?.encoding&&"string"==typeof e)try{a=s(e).buffer}catch{throw new dt("Invalid base64 data","EINVAL",t)}else"utf8"===i?.encoding?e instanceof ArrayBuffer&&(a=(new TextDecoder).decode(e)):"binary"!==i?.encoding&&i?.encoding||"string"==typeof e&&(a=(new TextEncoder).encode(e).buffer);if(i?.append&&this.files.has(t)){const e=this.files.get(t);if("string"==typeof e&&"string"==typeof a)a=e+a;else if(e instanceof ArrayBuffer&&a instanceof ArrayBuffer){const t=new Uint8Array(e.byteLength+a.byteLength);t.set(new Uint8Array(e),0),t.set(new Uint8Array(a),e.byteLength),a=t.buffer}else{a=("string"==typeof e?e:(new TextDecoder).decode(e))+("string"==typeof a?a:(new TextDecoder).decode(a))}}this.files.set(t,a);const n="string"==typeof a?(new TextEncoder).encode(a).length:a.byteLength;this.metadata.set(t,{name:ct.basename(t),path:t,size:n,type:"file",created:this.metadata.get(t)?.created||new Date,modified:new Date})}async _deleteFile(t){if(!this.files.has(t))throw new dt(`File does not exist: ${t}`,"ENOENT",t);this.files.delete(t),this.metadata.delete(t)}async _exists(t){return this.files.has(t)||this.directories.has(t)}async _stat(t){const e=this.metadata.get(t);if(!e)throw new dt("Path does not exist","ENOENT",t);return{size:e.size,isFile:"file"===e.type,isDirectory:"directory"===e.type,created:e.created,modified:e.modified}}async _deleteFileSystem(){}async _wipe(){}async _move(t,e,i){if(!this.files.has(t)&&!this.directories.has(t))throw new dt("Source path does not exist","ENOENT",t);const s=this.files.has(e)||this.directories.has(e);if(s&&!i?.overwrite)throw new dt("Target already exists","EEXIST",e);const r=ct.dirname(e);if(!this.directories.has(r))throw new dt("Target parent directory does not exist","ENOENT",r);const a=new Date;if(this.files.has(t)){const r=this.files.get(t),n=this.metadata.get(t);s&&i?.overwrite&&(this.files.delete(e),this.directories.delete(e),this.metadata.delete(e)),this.files.set(e,r),this.metadata.set(e,{...n,name:ct.basename(e),path:e,modified:a}),this.files.delete(t),this.metadata.delete(t)}else if(this.directories.has(t)){const r=this.metadata.get(t);s&&i?.overwrite&&(this.directories.has(e)?await this._deleteDirectory(e,!0):(this.files.delete(e),this.metadata.delete(e)));const n="/"===t?"/":t+"/",o="/"===e?"/":e+"/",h=[],l=[];for(const[t]of this.files)t.startsWith(n)&&h.push(t);for(const e of this.directories)e!==t&&e.startsWith(n)&&l.push(e);l.sort();for(const t of h){const e=t.replace(n,o),i=this.files.get(t),s=this.metadata.get(t);this.files.set(e,i),this.metadata.set(e,{...s,name:ct.basename(e),path:e,modified:a}),this.files.delete(t),this.metadata.delete(t)}for(const t of l){const e=t.replace(n,o),i=this.metadata.get(t);this.directories.add(e),this.metadata.set(e,{...i,name:ct.basename(e),path:e,modified:a}),this.directories.delete(t),this.metadata.delete(t)}this.directories.add(e),this.metadata.set(e,{...r,name:ct.basename(e),path:e,modified:a}),this.directories.delete(t),this.metadata.delete(t)}}}class gt extends b{_disposed;constructor(){super(),this._disposed=!1}get disposed(){return this._disposed}dispose(){this._disposed||(this.dispatchEvent("dispose"),this.onDispose(),this._disposed=!0)}onDispose(){}}const xt=new WeakMap,bt=new WeakMap,vt=new Set;function yt(t){if(t){const e=xt.get(t)??0;xt.set(t,e+1),0===e&&vt.delete(t)}}function Tt(t){if(t){let e=xt.get(t)??0;e>0&&(e--,e>0?xt.set(t,e):(xt.delete(t),vt.add(t)))}}class wt{_object;constructor(t){this._object=t??null,yt(this._object)}get(){return this._object}set(t){t!==this._object&&(Tt(this._object),this._object=t??null,yt(this._object))}dispose(){Tt(this._object),this._object=null}}class St{_object;constructor(t){this._object=t??null,this.retain()}get(){return this._object?.disposed&&this.dispose(),this._object}set(t){t!==this._object&&(this.release(),this._object=t??null,this.retain())}dispose(){this.release()}retain(){if(this._object){const t=bt.get(this._object);t?t.add(this):bt.set(this._object,new Set([this]))}}release(){this._object&&(bt.get(this._object)?.delete(this),this._object=null)}}const At=16777216,Ct=33554432,Et=50331648,Mt=67108864,Bt=83886080,It=100663296,Pt=117440512,$t=134217728;function Rt(t,e,i,s,r,a,n,o,h,l,u,c,d,p,m){return t|((e?1:0)|(i?2:0)|(s?4:0)|(r?8:0))|((a?16:0)|(n?32:0))|(o?64:0)|(h?128:0)|(l?256:0)|(u?512:0)|(c?1024:0)|(d<<16|p<<20|m<<11)}const Ft={unknown:0,r8unorm:Rt(0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,1,1,1),r8snorm:Rt(0,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,1,1,1),r16f:Rt(0,!0,!1,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,2),r32f:Rt(0,!0,!1,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,4),r8ui:Rt(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,1),r8i:Rt(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,1),r16ui:Rt(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,2),r16i:Rt(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,2),r32ui:Rt(0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,4),r32i:Rt(0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,4),rg8unorm:Rt(0,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,1,1,2),rg8snorm:Rt(0,!0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,1,1,2),rg16f:Rt(0,!0,!0,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,4),rg32f:Rt(0,!0,!0,!1,!1,!1,!1,!0,!1,!0,!1,!1,1,1,8),rg8ui:Rt(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,2),rg8i:Rt(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,2),rg16ui:Rt(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,4),rg16i:Rt(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,4),rg32ui:Rt(0,!0,!0,!1,!1,!1,!1,!1,!0,!1,!1,!1,1,1,8),rg32i:Rt(0,!0,!0,!1,!1,!1,!1,!1,!0,!0,!1,!1,1,1,8),rgba8unorm:Rt(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,1,1,4),"rgba8unorm-srgb":Rt(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,1,1,4),rgba8snorm:Rt(0,!0,!0,!0,!0,!1,!1,!1,!1,!0,!1,!1,1,1,4),bgra8unorm:Rt(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!0,1,1,4),"bgra8unorm-srgb":Rt(0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!0,1,1,4),rgba16f:Rt(0,!0,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1,1,1,8),rgba32f:Rt(0,!0,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1,1,1,16),rgba8ui:Rt(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,4),rgba8i:Rt(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,4),rgba16ui:Rt(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,8),rgba16i:Rt(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,8),rgba32ui:Rt(0,!0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,1,1,16),rgba32i:Rt(0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!1,!1,1,1,16),rg11b10uf:Rt(0,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,!1,1,1,4),d16:Rt(0,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,1,1,2),d24:Rt(0,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,0,0,0),d32f:Rt(0,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!1,1,1,4),d24s8:Rt(0,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,1,1,4),d32fs8:Rt(0,!1,!1,!1,!1,!0,!0,!0,!1,!0,!1,!1,1,1,5),dxt1:Rt(At,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,8),"dxt1-srgb":Rt(At,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,8),dxt3:Rt(Ct,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"dxt3-srgb":Rt(Ct,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),dxt5:Rt(Et,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"dxt5-srgb":Rt(Et,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),bc4:Rt(Mt,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,4,4,8),"bc4-signed":Rt(Mt,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,4,4,8),bc5:Rt(Bt,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,4,4,16),"bc5-signed":Rt(Bt,!0,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,4,4,16),bc6h:Rt(It,!0,!0,!0,!1,!1,!1,!0,!1,!1,!1,!1,4,4,16),"bc6h-signed":Rt(It,!0,!0,!0,!1,!1,!1,!0,!1,!0,!1,!1,4,4,16),bc7:Rt(Pt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"bc7-srgb":Rt(Pt,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),"astc-4x4":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,4,4,16),"astc-4x4-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,4,4,16),"astc-5x4":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,5,4,16),"astc-5x4-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,5,4,16),"astc-5x5":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,5,5,16),"astc-5x5-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,5,5,16),"astc-6x5":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,6,5,16),"astc-6x5-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,6,5,16),"astc-6x6":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,6,6,16),"astc-6x6-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,6,6,16),"astc-8x5":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,5,16),"astc-8x5-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,5,16),"astc-8x6":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,6,16),"astc-8x6-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,6,16),"astc-8x8":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,8,8,16),"astc-8x8-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,8,8,16),"astc-10x5":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,5,16),"astc-10x5-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,5,16),"astc-10x6":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,6,16),"astc-10x6-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,6,16),"astc-10x8":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,8,16),"astc-10x8-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,8,16),"astc-10x10":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,10,10,16),"astc-10x10-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,10,10,16),"astc-12x10":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,12,10,16),"astc-12x10-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,12,10,16),"astc-12x12":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,12,12,16),"astc-12x12-srgb":Rt($t,!0,!0,!0,!0,!1,!1,!1,!1,!1,!0,!1,12,12,16)};function Dt(t){switch(t){case"rgba8unorm":return"rgba8unorm-srgb";case"bgra8unorm":return"bgra8unorm-srgb";case"dxt1":return"dxt1-srgb";case"dxt3":return"dxt3-srgb";case"dxt5":return"dxt5-srgb";case"bc7":return"bc7-srgb";case"astc-4x4":return"astc-4x4-srgb";case"astc-5x4":return"astc-5x4-srgb";case"astc-5x5":return"astc-5x5-srgb";case"astc-6x5":return"astc-6x5-srgb";case"astc-6x6":return"astc-6x6-srgb";case"astc-8x5":return"astc-8x5-srgb";case"astc-8x6":return"astc-8x6-srgb";case"astc-8x8":return"astc-8x8-srgb";case"astc-10x5":return"astc-10x5-srgb";case"astc-10x6":return"astc-10x6-srgb";case"astc-10x8":return"astc-10x8-srgb";case"astc-10x10":return"astc-10x10-srgb";case"astc-12x10":return"astc-12x10-srgb";case"astc-12x12":return"astc-12x12-srgb";default:return t}}function Nt(t){return!!(16&Ft[t])}function Lt(t){return!!(32&Ft[t])}function zt(t){return!!(64&Ft[t])}function Vt(t){return!!(128&Ft[t])}function Ot(t){return!!(256&Ft[t])}function kt(t){return!!(520093696&Ft[t])}function Ut(t){return!!(512&Ft[t])}function Gt(t){return(63488&Ft[t])>>11}function Ht(t){return(983040&Ft[t])>>16}function Wt(t){return(15728640&Ft[t])>>20}var Xt=function(t){return t[t.Vertex=1]="Vertex",t[t.Fragment=2]="Fragment",t[t.Compute=4]="Compute",t}({});function jt(t,e){return t+e-1&~(e-1)}function Qt(t){if(t.isPrimitiveType())return t.isScalarType()?4:1<<Math.min(4,t.cols+1);if(t.isAtomicI32()||t.isAtomicU32())return 4;if(t.isArrayType())return t.elementType.isAnyType()?1:Qt(t.elementType);{let e=0;for(const i of t.structMembers)e=Math.max(e,Qt(i.type));return Math.max(e,16)}}function qt(t){return 1}function Yt(t){if(t.isPrimitiveType())return t.isMatrixType()?t.rows*Qt(_e.getCachedTypeInfo(t.resizeType(1,t.cols))):4*t.cols;if(t.isArrayType())return t.elementType.isAnyType()?0:t.dimension*jt(Yt(t.elementType),Qt(t.elementType));if(t.isAtomicI32()||t.isAtomicU32())return 4;{let e=0,i=0;for(const s of t.structMembers){const t=Qt(s.type);e=jt(e,t),e+=Yt(s.type),i=Math.max(i,t)}return jt(e,i)}}function Zt(t){if(t.isPrimitiveType()){let e;switch(t.scalarType){case te.U8:case te.U8_NORM:case te.I8:case te.I8_NORM:e=1;break;case te.F16:case te.I16:case te.I16_NORM:case te.U16:case te.U16_NORM:e=2;break;default:e=4}return t.rows*t.cols*e}if(t.isArrayType())return t.elementType.isAnyType()?0:t.dimension*Zt(t.elementType);if(t.isAtomicI32()||t.isAtomicU32())return 4;{let e=0;for(const i of t.structMembers)e+=Zt(i.type);return e}}function Kt(t,e,i,s){return t|e<<4|i<<7|s<<10}function Jt(t){return t.isPrimitiveType()?t.scalarType:t.isArrayType()?t.elementType.isAnyType()?null:Jt(t.elementType):te.U8}var te=function(t){return t[t.NONE=0]="NONE",t[t.F16=Kt(1,1,1,0)]="F16",t[t.F16VEC2=Kt(1,1,2,0)]="F16VEC2",t[t.F16VEC3=Kt(1,1,3,0)]="F16VEC3",t[t.F16VEC4=Kt(1,1,4,0)]="F16VEC4",t[t.F32=Kt(2,1,1,0)]="F32",t[t.F32VEC2=Kt(2,1,2,0)]="F32VEC2",t[t.F32VEC3=Kt(2,1,3,0)]="F32VEC3",t[t.F32VEC4=Kt(2,1,4,0)]="F32VEC4",t[t.BOOL=Kt(3,1,1,0)]="BOOL",t[t.BVEC2=Kt(3,1,2,0)]="BVEC2",t[t.BVEC3=Kt(3,1,3,0)]="BVEC3",t[t.BVEC4=Kt(3,1,4,0)]="BVEC4",t[t.I8=Kt(4,1,1,0)]="I8",t[t.I8VEC2=Kt(4,1,2,0)]="I8VEC2",t[t.I8VEC3=Kt(4,1,3,0)]="I8VEC3",t[t.I8VEC4=Kt(4,1,4,0)]="I8VEC4",t[t.I8_NORM=Kt(4,1,1,1)]="I8_NORM",t[t.I8VEC2_NORM=Kt(4,1,2,1)]="I8VEC2_NORM",t[t.I8VEC3_NORM=Kt(4,1,3,1)]="I8VEC3_NORM",t[t.I8VEC4_NORM=Kt(4,1,4,1)]="I8VEC4_NORM",t[t.I16=Kt(5,1,1,0)]="I16",t[t.I16VEC2=Kt(5,1,2,0)]="I16VEC2",t[t.I16VEC3=Kt(5,1,3,0)]="I16VEC3",t[t.I16VEC4=Kt(5,1,4,0)]="I16VEC4",t[t.I16_NORM=Kt(5,1,1,1)]="I16_NORM",t[t.I16VEC2_NORM=Kt(5,1,2,1)]="I16VEC2_NORM",t[t.I16VEC3_NORM=Kt(5,1,3,1)]="I16VEC3_NORM",t[t.I16VEC4_NORM=Kt(5,1,4,1)]="I16VEC4_NORM",t[t.I32=Kt(6,1,1,0)]="I32",t[t.I32VEC2=Kt(6,1,2,0)]="I32VEC2",t[t.I32VEC3=Kt(6,1,3,0)]="I32VEC3",t[t.I32VEC4=Kt(6,1,4,0)]="I32VEC4",t[t.I32_NORM=Kt(6,1,1,1)]="I32_NORM",t[t.I32VEC2_NORM=Kt(6,1,2,1)]="I32VEC2_NORM",t[t.I32VEC3_NORM=Kt(6,1,3,1)]="I32VEC3_NORM",t[t.I32VEC4_NORM=Kt(6,1,4,1)]="I32VEC4_NORM",t[t.U8=Kt(7,1,1,0)]="U8",t[t.U8VEC2=Kt(7,1,2,0)]="U8VEC2",t[t.U8VEC3=Kt(7,1,3,0)]="U8VEC3",t[t.U8VEC4=Kt(7,1,4,0)]="U8VEC4",t[t.U8_NORM=Kt(7,1,1,1)]="U8_NORM",t[t.U8VEC2_NORM=Kt(7,1,2,1)]="U8VEC2_NORM",t[t.U8VEC3_NORM=Kt(7,1,3,1)]="U8VEC3_NORM",t[t.U8VEC4_NORM=Kt(7,1,4,1)]="U8VEC4_NORM",t[t.U16=Kt(8,1,1,0)]="U16",t[t.U16VEC2=Kt(8,1,2,0)]="U16VEC2",t[t.U16VEC3=Kt(8,1,3,0)]="U16VEC3",t[t.U16VEC4=Kt(8,1,4,0)]="U16VEC4",t[t.U16_NORM=Kt(8,1,1,1)]="U16_NORM",t[t.U16VEC2_NORM=Kt(8,1,2,1)]="U16VEC2_NORM",t[t.U16VEC3_NORM=Kt(8,1,3,1)]="U16VEC3_NORM",t[t.U16VEC4_NORM=Kt(8,1,4,1)]="U16VEC4_NORM",t[t.U32=Kt(9,1,1,0)]="U32",t[t.U32VEC2=Kt(9,1,2,0)]="U32VEC2",t[t.U32VEC3=Kt(9,1,3,0)]="U32VEC3",t[t.U32VEC4=Kt(9,1,4,0)]="U32VEC4",t[t.U32_NORM=Kt(9,1,1,1)]="U32_NORM",t[t.U32VEC2_NORM=Kt(9,1,2,1)]="U32VEC2_NORM",t[t.U32VEC3_NORM=Kt(9,1,3,1)]="U32VEC3_NORM",t[t.U32VEC4_NORM=Kt(9,1,4,1)]="U32VEC4_NORM",t[t.MAT2=Kt(2,2,2,0)]="MAT2",t[t.MAT2x3=Kt(2,2,3,0)]="MAT2x3",t[t.MAT2x4=Kt(2,2,4,0)]="MAT2x4",t[t.MAT3x2=Kt(2,3,2,0)]="MAT3x2",t[t.MAT3=Kt(2,3,3,0)]="MAT3",t[t.MAT3x4=Kt(2,3,4,0)]="MAT3x4",t[t.MAT4x2=Kt(2,4,2,0)]="MAT4x2",t[t.MAT4x3=Kt(2,4,3,0)]="MAT4x3",t[t.MAT4=Kt(2,4,4,0)]="MAT4",t}({});const ee={[te.F32]:"float",[te.F32VEC2]:"vec2",[te.F32VEC3]:"vec3",[te.F32VEC4]:"vec4",[te.BOOL]:"bool",[te.BVEC2]:"bvec2",[te.BVEC3]:"bvec3",[te.BVEC4]:"bvec4",[te.I32]:"int",[te.I32VEC2]:"ivec2",[te.I32VEC3]:"ivec3",[te.I32VEC4]:"ivec4",[te.U32]:"uint",[te.U32VEC2]:"uvec2",[te.U32VEC3]:"uvec3",[te.U32VEC4]:"uvec4",[te.MAT2]:"mat2",[te.MAT2x3]:"mat2x3",[te.MAT2x4]:"mat2x4",[te.MAT3x2]:"mat3x2",[te.MAT3]:"mat3",[te.MAT3x4]:"mat3x4",[te.MAT4x2]:"mat4x2",[te.MAT4x3]:"mat4x3",[te.MAT4]:"mat4"},ie={[te.F32]:"f32",[te.F32VEC2]:"vec2<f32>",[te.F32VEC3]:"vec3<f32>",[te.F32VEC4]:"vec4<f32>",[te.BOOL]:"bool",[te.BVEC2]:"vec2<bool>",[te.BVEC3]:"vec3<bool>",[te.BVEC4]:"vec4<bool>",[te.I32]:"i32",[te.I32VEC2]:"vec2<i32>",[te.I32VEC3]:"vec3<i32>",[te.I32VEC4]:"vec4<i32>",[te.U32]:"u32",[te.U32VEC2]:"vec2<u32>",[te.U32VEC3]:"vec3<u32>",[te.U32VEC4]:"vec4<u32>",[te.MAT2]:"mat2x2<f32>",[te.MAT2x3]:"mat2x3<f32>",[te.MAT2x4]:"mat2x4<f32>",[te.MAT3x2]:"mat3x2<f32>",[te.MAT3]:"mat3x3<f32>",[te.MAT3x4]:"mat3x4<f32>",[te.MAT4x2]:"mat4x2<f32>",[te.MAT4x3]:"mat4x3<f32>",[te.MAT4]:"mat4x4<f32>"},se=16,re=64,ae=128,ne=512,oe=1024;var he=function(t){return t[t.TEX_1D=257]="TEX_1D",t[t.ITEX_1D=513]="ITEX_1D",t[t.UTEX_1D=1025]="UTEX_1D",t[t.TEX_2D=258]="TEX_2D",t[t.ITEX_2D=514]="ITEX_2D",t[t.UTEX_2D=1026]="UTEX_2D",t[t.TEX_2D_ARRAY=274]="TEX_2D_ARRAY",t[t.ITEX_2D_ARRAY=530]="ITEX_2D_ARRAY",t[t.UTEX_2D_ARRAY=1042]="UTEX_2D_ARRAY",t[t.TEX_3D=260]="TEX_3D",t[t.ITEX_3D=516]="ITEX_3D",t[t.UTEX_3D=1028]="UTEX_3D",t[t.TEX_CUBE=264]="TEX_CUBE",t[t.ITEX_CUBE=520]="ITEX_CUBE",t[t.UTEX_CUBE=1032]="UTEX_CUBE",t[t.TEX_CUBE_ARRAY=280]="TEX_CUBE_ARRAY",t[t.ITEX_CUBE_ARRAY=536]="ITEX_CUBE_ARRAY",t[t.UTEX_CUBE_ARRAY=1048]="UTEX_CUBE_ARRAY",t[t.TEX_MULTISAMPLED_2D=290]="TEX_MULTISAMPLED_2D",t[t.ITEX_MULTISAMPLED_2D=546]="ITEX_MULTISAMPLED_2D",t[t.UTEX_MULTISAMPLED_2D=1058]="UTEX_MULTISAMPLED_2D",t[t.TEX_STORAGE_1D=65]="TEX_STORAGE_1D",t[t.TEX_STORAGE_2D=66]="TEX_STORAGE_2D",t[t.TEX_STORAGE_2D_ARRAY=82]="TEX_STORAGE_2D_ARRAY",t[t.TEX_STORAGE_3D=68]="TEX_STORAGE_3D",t[t.TEX_DEPTH_2D=130]="TEX_DEPTH_2D",t[t.TEX_DEPTH_2D_ARRAY=146]="TEX_DEPTH_2D_ARRAY",t[t.TEX_DEPTH_CUBE=136]="TEX_DEPTH_CUBE",t[t.TEX_DEPTH_CUBE_ARRAY=152]="TEX_DEPTH_CUBE_ARRAY",t[t.TEX_DEPTH_MULTISAMPLED_2D=162]="TEX_DEPTH_MULTISAMPLED_2D",t[t.TEX_EXTERNAL=2048]="TEX_EXTERNAL",t}({});const le={[he.TEX_1D]:"highp sampler2D",[he.TEX_2D]:"highp sampler2D",[he.TEX_CUBE]:"highp samplerCube",[he.TEX_EXTERNAL]:"highp sampler2D"},ue={[he.TEX_1D]:"highp sampler2D",[he.TEX_2D]:"highp sampler2D",[he.ITEX_1D]:"highp isampler2D",[he.ITEX_2D]:"highp isampler2D",[he.UTEX_1D]:"highp usampler2D",[he.UTEX_2D]:"highp usampler2D",[he.TEX_2D_ARRAY]:"highp sampler2DArray",[he.ITEX_2D_ARRAY]:"highp isampler2DArray",[he.UTEX_2D_ARRAY]:"highp usampler2DArray",[he.TEX_3D]:"highp sampler3D",[he.ITEX_3D]:"highp isampler3D",[he.UTEX_3D]:"highp usampler3D",[he.TEX_CUBE]:"highp samplerCube",[he.ITEX_CUBE]:"highp isamplerCube",[he.UTEX_CUBE]:"highp usamplerCube",[he.TEX_DEPTH_2D]:"highp sampler2DShadow",[he.TEX_DEPTH_2D_ARRAY]:"highp sampler2DArrayShadow",[he.TEX_DEPTH_CUBE]:"highp samplerCubeShadow",[he.TEX_EXTERNAL]:"highp sampler2D"},ce={[he.TEX_1D]:"texture_1d<f32>",[he.ITEX_1D]:"texture_1d<i32>",[he.UTEX_1D]:"texture_1d<u32>",[he.TEX_2D]:"texture_2d<f32>",[he.ITEX_2D]:"texture_2d<i32>",[he.UTEX_2D]:"texture_2d<u32>",[he.TEX_2D_ARRAY]:"texture_2d_array<f32>",[he.ITEX_2D_ARRAY]:"texture_2d_array<i32>",[he.UTEX_2D_ARRAY]:"texture_2d_array<u32>",[he.TEX_3D]:"texture_3d<f32>",[he.ITEX_3D]:"texture_3d<i32>",[he.UTEX_3D]:"texture_3d<u32>",[he.TEX_CUBE]:"texture_cube<f32>",[he.ITEX_CUBE]:"texture_cube<i32>",[he.UTEX_CUBE]:"texture_cube<u32>",[he.TEX_CUBE_ARRAY]:"texture_cube_array<f32>",[he.ITEX_CUBE_ARRAY]:"texture_cube_array<i32>",[he.UTEX_CUBE_ARRAY]:"texture_cube_array<u32>",[he.TEX_MULTISAMPLED_2D]:"texture_multisampled_2d<f32>",[he.ITEX_MULTISAMPLED_2D]:"texture_multisampled_2d<i32>",[he.UTEX_MULTISAMPLED_2D]:"texture_multisampled_2d<u32>",[he.TEX_STORAGE_1D]:"texture_storage_1d",[he.TEX_STORAGE_2D]:"texture_storage_2d",[he.TEX_STORAGE_2D_ARRAY]:"texture_storage_2d_array",[he.TEX_STORAGE_3D]:"texture_storage_3d",[he.TEX_DEPTH_2D]:"texture_depth_2d",[he.TEX_DEPTH_2D_ARRAY]:"texture_depth_2d_array",[he.TEX_DEPTH_CUBE]:"texture_depth_cube",[he.TEX_DEPTH_CUBE_ARRAY]:"texture_depth_cube_array",[he.TEX_DEPTH_MULTISAMPLED_2D]:"texture_depth_multisampled_2d",[he.TEX_EXTERNAL]:"texture_external"},de={rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",bgra8unorm:"bgra8unorm",rgba8ui:"rgba8uint",rgba8i:"rgba8sint",rgba16ui:"rgba16uint",rgba16i:"rgba16sint",rgba16f:"rgba16float",r32f:"r32float",r32ui:"r32uint",r32i:"r32sint",rg32f:"rg32float",rg32ui:"rg32uint",rg32i:"rg32sint",rgba32f:"rgba32float",rgba32ui:"rgba32uint",rgba32i:"rgba32sint"};var pe=function(t){return t[t.UNKNOWN=0]="UNKNOWN",t[t.SAMPLE=1]="SAMPLE",t[t.COMPARISON=2]="COMPARISON",t}({}),me=function(t){return t.UNKNOWN="unknown",t.FUNCTION="function",t.PRIVATE="private",t.WORKGROUP="workgroup",t.UNIFORM="uniform",t.STORAGE="storage",t}({});class fe{cls;detail;id;constructor(t,e){this.cls=t,this.detail=e,this.id=null}get typeId(){return this.id||(this.id=this.genTypeId()),this.id}isVoidType(){return!1}isAnyType(){return!1}isPrimitiveType(){return!1}haveAtomicMembers(){return!1}isStructType(){return!1}isArrayType(){return!1}isPointerType(){return!1}isAtomicI32(){return!1}isAtomicU32(){return!1}isSamplerType(){return!1}isTextureType(){return!1}isHostSharable(){return!1}isConstructible(){return!1}isStorable(){return!1}getConstructorOverloads(t){return[]}isCompatibleType(t){return t.typeId===this.typeId}}class _e extends fe{static cachedTypes={};static cachedCtorOverloads={};constructor(t){super(1,{primitiveType:t})}static getCachedTypeInfo(t){let e=this.cachedTypes[t];return e||(e=new _e(t),this.cachedTypes[t]=e),e}static getCachedOverloads(t,e){let i=this.cachedCtorOverloads[t];i||(i={},this.cachedCtorOverloads[t]=i);let s=i[e];if(!s){const r=this.getCachedTypeInfo(e),a=r.toTypeName(t);if(s=[new Te(a,r,[])],r.isScalarType())s.push(new Te(a,r,[{type:this.getCachedTypeInfo(te.F32)}])),s.push(new Te(a,r,[{type:this.getCachedTypeInfo(te.I32)}])),s.push(new Te(a,r,[{type:this.getCachedTypeInfo(te.U32)}])),s.push(new Te(a,r,[{type:this.getCachedTypeInfo(te.BOOL)}]));else if(r.isVectorType()){const t={type:this.getCachedTypeInfo(r.scalarType)},e={type:this.getCachedTypeInfo(r.resizeType(1,2))},i={type:this.getCachedTypeInfo(r.resizeType(1,3))};switch(s.push(new Te(a,r,[t])),r.cols){case 2:s.push(new Te(a,r,[t,t])),s.push(new Te(a,r,[{type:Se}])),s.push(new Te(a,r,[{type:Ie}])),s.push(new Te(a,r,[{type:Fe}])),s.push(new Te(a,r,[{type:ze}]));break;case 3:s.push(new Te(a,r,[t,t,t])),s.push(new Te(a,r,[t,e])),s.push(new Te(a,r,[e,t])),s.push(new Te(a,r,[{type:Ae}])),s.push(new Te(a,r,[{type:Pe}])),s.push(new Te(a,r,[{type:De}])),s.push(new Te(a,r,[{type:Ve}]));break;case 4:s.push(new Te(a,r,[t,t,t,t])),s.push(new Te(a,r,[t,t,e])),s.push(new Te(a,r,[t,e,t])),s.push(new Te(a,r,[e,t,t])),s.push(new Te(a,r,[e,e])),s.push(new Te(a,r,[t,i])),s.push(new Te(a,r,[i,t])),s.push(new Te(a,r,[{type:Ce}])),s.push(new Te(a,r,[{type:$e}])),s.push(new Te(a,r,[{type:Ne}])),s.push(new Te(a,r,[{type:Oe}]))}}else if(r.isMatrixType()){const t=this.getCachedTypeInfo(r.resizeType(1,r.cols));s.push(new Te(a,r,Array.from({length:r.rows}).map(()=>({type:t})))),s.push(new Te(a,r,Array.from({length:r.rows*r.cols}).map(()=>({type:we}))))}i[e]=s}return s}get primitiveType(){return this.detail.primitiveType}isInteger(){const t=15&this.primitiveType;return 4===t||7===t||5===t||8===t||6===t||9===t}get scalarType(){return this.resizeType(1,1)}get rows(){return this.primitiveType>>4&7}get cols(){return this.primitiveType>>7&7}get normalized(){return!!(this.primitiveType>>10&1)}getLayoutAlignment(t){return"packed"===t?1:this.isScalarType()?4:1<<Math.min(4,this.cols+1)}getLayoutSize(){return this.getSize()}getSize(){let t;switch(this.scalarType){case te.BOOL:case te.I32:case te.I32_NORM:case te.U32:case te.U32_NORM:case te.F32:t=4;break;case te.F16:case te.I16:case te.I16_NORM:case te.U16:case te.U16_NORM:t=2;break;default:t=1}return t*this.cols*this.rows}resizeType(t,e){return Kt(15&this.primitiveType,t,e,this.normalized?1:0)}isScalarType(){return 1===this.rows&&1===this.cols}isVectorType(){return 1===this.rows&&this.cols>1}isMatrixType(){return this.rows>1&&this.cols>1}isPrimitiveType(){return!0}isHostSharable(){return this.scalarType!==te.BOOL}isConstructible(){return!0}isStorable(){return!0}getConstructorOverloads(t){return _e.getCachedOverloads(t,this.primitiveType)}toTypeName(t,e){if("webgpu"===t){const t=ie[this.primitiveType];return e?`${e}: ${t}`:t}{const t=ee[this.primitiveType];return e?`${t} ${e}`:t}}toBufferLayout(t){return null}genTypeId(){return`PRIM:${this.primitiveType}`}}class ge extends fe{constructor(t,e,i){super(1,{layout:e||"default",structName:t,structMembers:i.map(t=>{const e=Qt(t.type),i=Yt(t.type);return{name:t.name,type:t.type,alignment:e,size:i,defaultAlignment:e,defaultSize:i}})}),"std140"===this.layout?this.calcAlignmentAndSizeSTD140():"std430"===this.layout&&this.calcAlignmentAndSizePacked()}get layout(){return this.detail.layout}get structName(){return this.detail.structName}set structName(t){this.detail.structName=t}get structMembers(){return this.detail.structMembers}haveAtomicMembers(){for(const t of this.structMembers)return!(!t.type.isStructType()||!t.type.haveAtomicMembers())||(!(!t.type.isArrayType()||!t.type.haveAtomicMembers())||(t.type.isAtomicI32()||t.type.isAtomicU32()))}extends(t,e){const i=this.structMembers.map(t=>({name:t.name,type:t.type}));return new ge(t,this.layout,[...i,...e])}isStructType(){return!0}isHostSharable(){return this.detail.structMembers.every(t=>t.type.isHostSharable())}isConstructible(){return this.detail.structMembers.every(t=>t.type.isConstructible())}isStorable(){return!0}getConstructorOverloads(){const t=[new Te(this.structName,this,[])];return this.isConstructible()&&t.push(new Te(this.structName,this,this.structMembers.map(t=>({type:t.type})))),t}toTypeName(t,e){return"webgpu"===t?e?`${e}: ${this.structName}`:this.structName:e?`${this.structName} ${e}`:this.structName}getLayoutAlignment(t){if("packed"===t)return 1;let e=0;for(const i of this.structMembers)e=Math.max(e,i.type.getLayoutAlignment(t));return"std140"===t&&(e=jt(e,16)),e}getLayoutSize(t){let e=0,i=0;for(const s of this.structMembers){const r=s.type.getLayoutAlignment(t);e=jt(e,r),e+=s.type.getLayoutSize(t),i=Math.max(i,r)}return jt(e,i)}toBufferLayout(t,e){const i={byteSize:0,entries:[]},s=t;for(const s of this.structMembers){t=jt(t,s.type.getLayoutAlignment(e));const r=s.type.getLayoutSize(e);i.entries.push({name:s.name,offset:t,byteSize:r,type:Jt(s.type),subLayout:s.type.isStructType()?s.type.toBufferLayout(t,e):null,arraySize:s.type.isArrayType()?s.type.dimension:0}),t+=r}return i.byteSize="std140"===e?jt(t-s,16):t-s,i}clone(t){return new ge(t||this.structName,this.layout,this.structMembers)}reset(t,e,i){this.detail={layout:e||"default",structName:t,structMembers:i.map(t=>{const e=Qt(t.type),i=Yt(t.type);return{name:t.name,type:t.type,alignment:e,size:i,defaultAlignment:e,defaultSize:i}})},"std140"===this.layout?this.calcAlignmentAndSizeSTD140():"std430"===this.layout&&this.calcAlignmentAndSizePacked(),this.id=null}genTypeId(){return`STRUCT:${this.structName}:${this.layout}:${this.structMembers.map(t=>`${t.name}(${t.type.typeId})`).join(":")}`}calcAlignmentAndSizeSTD140(){for(const t of this.structMembers)if(t.type.isPrimitiveType()){if(t.type.isMatrixType()&&2===t.type.cols)throw new Error(`matrix${t.type.rows}x${t.type.cols} can not be used in std140 layout`)}else{if(t.type.isArrayType()&&(t.type.elementType.isAnyType()||16!==Qt(t.type.elementType)))throw new Error("array element must be 16 bytes aligned in std140 layout");t.type.isStructType()&&(t.alignment=16,t.size=jt(t.defaultSize,16))}}calcAlignmentAndSizePacked(){for(const t of this.structMembers)t.alignment=qt(),t.size=Zt(t.type)}}class xe extends fe{constructor(t,e){super(2,{elementType:t,dimension:Number(e)||0})}get elementType(){return this.detail.elementType}get dimension(){return this.detail.dimension}haveAtomicMembers(){return this.elementType.isStructType()||this.elementType.isArrayType()?this.elementType.haveAtomicMembers():this.elementType.isAtomicI32()||this.elementType.isAtomicU32()}isArrayType(){return!0}isHostSharable(){return this.detail.elementType.isHostSharable()}isConstructible(){return this.dimension&&this.detail.elementType.isConstructible()}isStorable(){return!0}getConstructorOverloads(t){const e=this.toTypeName(t),i=[new Te(e,this,[])];return"webgl"!==t&&this.isConstructible()&&i.push(new Te(e,this,Array.from({length:this.dimension}).map(()=>({type:this.elementType})))),i}toTypeName(t,i){if("webgpu"===t){const e=`array<${this.elementType.toTypeName(t)}${this.dimension?", "+this.dimension:""}>`;return i?`${i}: ${e}`:e}e(!!this.dimension,"runtime-sized array not supported for webgl"),e(!this.elementType.isArrayType(),"multi-dimensional arrays not supported for webgl");return`${this.elementType.toTypeName(t,i)}[${this.dimension}]`}getLayoutAlignment(t){return"packed"===t||this.elementType.isAnyType()?1:"std430"===t?this.elementType.getLayoutAlignment(t):jt(this.elementType.getLayoutAlignment(t),16)}getLayoutSize(t){const e=this.elementType.isAnyType()?1:this.elementType.getLayoutAlignment(t);if("std140"===t&&15&e)throw new Error("Error: array element stride of std140 must be multiple of 16");return this.elementType.isAnyType()?0:this.dimension*jt(this.elementType.getLayoutSize(t),e)}toBufferLayout(t){return null}isCompatibleType(t){return!!t.isArrayType()&&((0===this.dimension||t.dimension===this.dimension)&&this.elementType.isCompatibleType(t.elementType))}genTypeId(){return`ARRAY:(${this.elementType.typeId})[${this.dimension}]`}}class be extends fe{writable;constructor(t,i){super(3,{pointerType:t,addressSpace:i}),e(t.isStorable(),"the pointee type must be storable"),this.writable=!1}get pointerType(){return this.detail.pointerType}get addressSpace(){return this.detail.addressSpace}set addressSpace(t){this.detail.addressSpace!==t&&(this.detail.addressSpace=t,this.id=null)}haveAtomicMembers(){return this.pointerType.haveAtomicMembers()}isPointerType(){return!0}toTypeName(t,e){if("webgpu"===t){const i="unknown"===this.addressSpace?"function":this.addressSpace,s="storage"===i&&this.writable?", read_write":"",r=`ptr<${i}, ${this.pointerType.toTypeName(t)} ${s}>`;return e?`${e}: ${r}`:r}throw new Error("pointer type not supported for webgl")}toBufferLayout(t){return null}genTypeId(){return`PTR:(${this.pointerType.typeId})`}}class ve extends fe{constructor(t){super(7,{accessMode:t})}get accessMode(){return this.detail.accessMode}isSamplerType(){return!0}isStorable(){return!0}toTypeName(t,e){if("webgpu"===t){const t=1===this.accessMode?"sampler":"sampler_comparison";return e?`${e}: ${t}`:t}throw new Error("sampler type not supported for webgl")}toBufferLayout(t){return null}genTypeId(){return`SAMPLER:${this.accessMode}`}}class ye extends fe{constructor(t,i,s,r){super(6,{textureType:t,readable:s,writable:r,storageTexelFormat:i||null}),e(!!ce[t],"unsupported texture type"),e(!(t&re&&!de[i]),"invalid texel format for storage texture")}get textureType(){return this.detail.textureType}get storageTexelFormat(){return this.detail.storageTexelFormat}get readable(){return this.detail.readable}set readable(t){this.detail.readable=!!t}get writable(){return this.detail.writable}set writable(t){this.detail.writable=!!t}isStorable(){return!0}is1DTexture(){return!!(1&this.detail.textureType)}is2DTexture(){return!!(2&this.detail.textureType)}is3DTexture(){return!!(4&this.detail.textureType)}isCubeTexture(){return!!(8&this.detail.textureType)}isArrayTexture(){return!!(this.detail.textureType&se)}isStorageTexture(){return!!(this.detail.textureType&re)}isDepthTexture(){return!!(this.detail.textureType&ae)}isMultisampledTexture(){return!!(32&this.detail.textureType)}isExternalTexture(){return!!(2048&this.detail.textureType)}isIntTexture(){return!!(this.detail.textureType&ne)}isUIntTexture(){return!!(this.detail.textureType&oe)}isTextureType(){return!0}toTypeName(t,i){if("webgpu"===t){let t=ce[this.textureType];if(this.isStorageTexture()){t=`${t}<${de[this.storageTexelFormat]}, ${this.writable?this.readable?"read_write":"write":"read"}>`}return i?`${i}: ${t}`:t}{const s=("webgl"===t?le:ue)[this.textureType];return e(!!s,"unsupported texture type"),i?`${s} ${i}`:s}}toBufferLayout(t){return null}genTypeId(){return`TEXTURE:${this.textureType}:${this.textureType&re?this.storageTexelFormat:""}`}}class Te extends fe{constructor(t,e,i){super(8,{name:t,returnType:e,argTypes:i})}get name(){return this.detail.name}get returnType(){return this.detail.returnType}get argTypes(){return this.detail.argTypes}get argHash(){return this.argTypes.map(t=>t.type.typeId).join(",")}genTypeId(){return`fn(${this.argHash}):${this.returnType.typeId}`}toBufferLayout(t){return null}toTypeName(){throw new Error("not supported")}}_e.getCachedTypeInfo(te.F16),_e.getCachedTypeInfo(te.F16VEC2),_e.getCachedTypeInfo(te.F16VEC3),_e.getCachedTypeInfo(te.F16VEC4);const we=_e.getCachedTypeInfo(te.F32),Se=_e.getCachedTypeInfo(te.F32VEC2),Ae=_e.getCachedTypeInfo(te.F32VEC3),Ce=_e.getCachedTypeInfo(te.F32VEC4);_e.getCachedTypeInfo(te.I8),_e.getCachedTypeInfo(te.I8VEC2),_e.getCachedTypeInfo(te.I8VEC3),_e.getCachedTypeInfo(te.I8VEC4),_e.getCachedTypeInfo(te.I8_NORM),_e.getCachedTypeInfo(te.I8VEC2_NORM),_e.getCachedTypeInfo(te.I8VEC3_NORM),_e.getCachedTypeInfo(te.I8VEC4_NORM),_e.getCachedTypeInfo(te.I16),_e.getCachedTypeInfo(te.I16VEC2),_e.getCachedTypeInfo(te.I16VEC3),_e.getCachedTypeInfo(te.I16VEC4),_e.getCachedTypeInfo(te.I16_NORM),_e.getCachedTypeInfo(te.I16VEC2_NORM),_e.getCachedTypeInfo(te.I16VEC3_NORM),_e.getCachedTypeInfo(te.I16VEC4_NORM);const Ee=new class extends fe{constructor(){super(4,null)}haveAtomicMembers(){return!0}isAtomicI32(){return!0}isHostSharable(){return!0}isStorable(){return!0}toTypeName(t,e){if("webgpu"===t){const t="atomic<i32>";return e?`${e}: ${t}`:t}throw new Error("atomic type not supported for webgl")}toBufferLayout(t){return null}getLayoutAlignment(t){return 4}getLayoutSize(){return this.getSize()}getSize(){return 4}genTypeId(){return"ATOMICI32"}},Me=new class extends fe{constructor(){super(5,null)}haveAtomicMembers(){return!0}isAtomicU32(){return!0}isHostSharable(){return!0}isStorable(){return!0}toTypeName(t,e){if("webgpu"===t){const t="atomic<u32>";return e?`${e}: ${t}`:t}throw new Error("atomic type not supported for webgl")}toBufferLayout(t){return null}getLayoutAlignment(t){return 4}getLayoutSize(){return this.getSize()}getSize(){return 4}genTypeId(){return"ATOMICU32"}},Be=_e.getCachedTypeInfo(te.I32),Ie=_e.getCachedTypeInfo(te.I32VEC2),Pe=_e.getCachedTypeInfo(te.I32VEC3),$e=_e.getCachedTypeInfo(te.I32VEC4);_e.getCachedTypeInfo(te.I32),_e.getCachedTypeInfo(te.I32VEC2_NORM),_e.getCachedTypeInfo(te.I32VEC3_NORM),_e.getCachedTypeInfo(te.I32VEC4_NORM),_e.getCachedTypeInfo(te.U8),_e.getCachedTypeInfo(te.U8VEC2),_e.getCachedTypeInfo(te.U8VEC3),_e.getCachedTypeInfo(te.U8VEC4),_e.getCachedTypeInfo(te.U8_NORM),_e.getCachedTypeInfo(te.U8VEC2_NORM),_e.getCachedTypeInfo(te.U8VEC3_NORM),_e.getCachedTypeInfo(te.U8VEC4_NORM),_e.getCachedTypeInfo(te.U16),_e.getCachedTypeInfo(te.U16VEC2),_e.getCachedTypeInfo(te.U16VEC3),_e.getCachedTypeInfo(te.U16VEC4),_e.getCachedTypeInfo(te.U16_NORM),_e.getCachedTypeInfo(te.U16VEC2_NORM),_e.getCachedTypeInfo(te.U16VEC3_NORM),_e.getCachedTypeInfo(te.U16VEC4_NORM);const Re=_e.getCachedTypeInfo(te.U32),Fe=_e.getCachedTypeInfo(te.U32VEC2),De=_e.getCachedTypeInfo(te.U32VEC3),Ne=_e.getCachedTypeInfo(te.U32VEC4);_e.getCachedTypeInfo(te.U32_NORM),_e.getCachedTypeInfo(te.U32VEC2_NORM),_e.getCachedTypeInfo(te.U32VEC3_NORM),_e.getCachedTypeInfo(te.U32VEC4_NORM);const Le=_e.getCachedTypeInfo(te.BOOL),ze=_e.getCachedTypeInfo(te.BVEC2),Ve=_e.getCachedTypeInfo(te.BVEC3),Oe=_e.getCachedTypeInfo(te.BVEC4),ke=_e.getCachedTypeInfo(te.MAT2),Ue=_e.getCachedTypeInfo(te.MAT2x3),Ge=_e.getCachedTypeInfo(te.MAT2x4),He=_e.getCachedTypeInfo(te.MAT3x2),We=_e.getCachedTypeInfo(te.MAT3),Xe=_e.getCachedTypeInfo(te.MAT3x4),je=_e.getCachedTypeInfo(te.MAT4x2),Qe=_e.getCachedTypeInfo(te.MAT4x3),qe=_e.getCachedTypeInfo(te.MAT4),Ye=new ye(he.TEX_1D),Ze=new ye(he.ITEX_1D),Ke=new ye(he.UTEX_1D),Je=new ye(he.TEX_2D),ti=new ye(he.ITEX_2D),ei=new ye(he.UTEX_2D),ii=new ye(he.TEX_2D_ARRAY),si=new ye(he.ITEX_2D_ARRAY),ri=new ye(he.UTEX_2D_ARRAY),ai=new ye(he.TEX_3D),ni=new ye(he.ITEX_3D),oi=new ye(he.UTEX_3D),hi=new ye(he.TEX_CUBE),li=new ye(he.ITEX_CUBE),ui=new ye(he.UTEX_CUBE),ci=new ye(he.TEX_EXTERNAL),di=new ye(he.TEX_CUBE_ARRAY),pi=new ye(he.ITEX_CUBE_ARRAY),mi=new ye(he.UTEX_CUBE_ARRAY),fi=new ye(he.TEX_MULTISAMPLED_2D),_i=new ye(he.ITEX_MULTISAMPLED_2D),gi=new ye(he.UTEX_MULTISAMPLED_2D),xi=new ye(he.TEX_STORAGE_1D,"rgba8unorm"),bi=new ye(he.TEX_STORAGE_1D,"rgba8snorm"),vi=new ye(he.TEX_STORAGE_1D,"rgba8unorm"),yi=new ye(he.TEX_STORAGE_1D,"rgba8ui"),Ti=new ye(he.TEX_STORAGE_1D,"rgba8i"),wi=new ye(he.TEX_STORAGE_1D,"rgba16ui"),Si=new ye(he.TEX_STORAGE_1D,"rgba16i"),Ai=new ye(he.TEX_STORAGE_1D,"rgba16f"),Ci=new ye(he.TEX_STORAGE_1D,"rgba32ui"),Ei=new ye(he.TEX_STORAGE_1D,"rgba32i"),Mi=new ye(he.TEX_STORAGE_1D,"rgba32f"),Bi=new ye(he.TEX_STORAGE_1D,"rg32ui"),Ii=new ye(he.TEX_STORAGE_1D,"rg32i"),Pi=new ye(he.TEX_STORAGE_1D,"rg32f"),$i=new ye(he.TEX_STORAGE_1D,"r32ui"),Ri=new ye(he.TEX_STORAGE_1D,"r32i"),Fi=new ye(he.TEX_STORAGE_1D,"r32f"),Di=new ye(he.TEX_STORAGE_2D,"rgba8unorm"),Ni=new ye(he.TEX_STORAGE_2D,"rgba8snorm"),Li=new ye(he.TEX_STORAGE_2D,"bgra8unorm"),zi=new ye(he.TEX_STORAGE_2D,"rgba8ui"),Vi=new ye(he.TEX_STORAGE_2D,"rgba8i"),Oi=new ye(he.TEX_STORAGE_2D,"rgba16ui"),ki=new ye(he.TEX_STORAGE_2D,"rgba16i"),Ui=new ye(he.TEX_STORAGE_2D,"rgba16f"),Gi=new ye(he.TEX_STORAGE_2D,"rgba32ui"),Hi=new ye(he.TEX_STORAGE_2D,"rgba32i"),Wi=new ye(he.TEX_STORAGE_2D,"rgba32f"),Xi=new ye(he.TEX_STORAGE_2D,"rg32ui"),ji=new ye(he.TEX_STORAGE_2D,"rg32i"),Qi=new ye(he.TEX_STORAGE_2D,"rg32f"),qi=new ye(he.TEX_STORAGE_2D,"r32ui"),Yi=new ye(he.TEX_STORAGE_2D,"r32i"),Zi=new ye(he.TEX_STORAGE_2D,"r32f"),Ki=new ye(he.TEX_STORAGE_2D_ARRAY,"rgba8unorm"),Ji=new ye(he.TEX_STORAGE_2D_ARRAY,"rgba8snorm");new ye(he.TEX_STORAGE_2D_ARRAY,"bgra8unorm");const ts=new ye(he.TEX_STORAGE_2D_ARRAY,"rgba8ui"),es=new ye(he.TEX_STORAGE_2D_ARRAY,"rgba8i"),is=new ye(he.TEX_STORAGE_2D_ARRAY,"rgba16ui"),ss=new ye(he.TEX_STORAGE_2D_ARRAY,"rgba16i"),rs=new ye(he.TEX_STORAGE_2D_ARRAY,"rgba16f"),as=new ye(he.TEX_STORAGE_2D_ARRAY,"rgba32ui"),ns=new ye(he.TEX_STORAGE_2D_ARRAY,"rgba32i"),os=new ye(he.TEX_STORAGE_2D_ARRAY,"rgba32f"),hs=new ye(he.TEX_STORAGE_2D_ARRAY,"rg32ui"),ls=new ye(he.TEX_STORAGE_2D_ARRAY,"rg32i"),us=new ye(he.TEX_STORAGE_2D_ARRAY,"rg32f"),cs=new ye(he.TEX_STORAGE_2D_ARRAY,"r32ui"),ds=new ye(he.TEX_STORAGE_2D_ARRAY,"r32i"),ps=new ye(he.TEX_STORAGE_2D_ARRAY,"r32f"),ms=new ye(he.TEX_STORAGE_3D,"rgba8unorm"),fs=new ye(he.TEX_STORAGE_3D,"rgba8snorm"),_s=new ye(he.TEX_STORAGE_3D,"bgra8unorm"),gs=new ye(he.TEX_STORAGE_3D,"rgba8ui"),xs=new ye(he.TEX_STORAGE_3D,"rgba8i"),bs=new ye(he.TEX_STORAGE_3D,"rgba16ui"),vs=new ye(he.TEX_STORAGE_3D,"rgba16i"),ys=new ye(he.TEX_STORAGE_3D,"rgba16f"),Ts=new ye(he.TEX_STORAGE_3D,"rgba32ui"),ws=new ye(he.TEX_STORAGE_3D,"rgba32i"),Ss=new ye(he.TEX_STORAGE_3D,"rgba32f"),As=new ye(he.TEX_STORAGE_3D,"rg32ui"),Cs=new ye(he.TEX_STORAGE_3D,"rg32i"),Es=new ye(he.TEX_STORAGE_3D,"rg32f"),Ms=new ye(he.TEX_STORAGE_3D,"r32ui"),Bs=new ye(he.TEX_STORAGE_3D,"r32i"),Is=new ye(he.TEX_STORAGE_3D,"r32f"),Ps=new ye(he.TEX_DEPTH_2D),$s=new ye(he.TEX_DEPTH_2D_ARRAY),Rs=new ye(he.TEX_DEPTH_CUBE),Fs=new ye(he.TEX_DEPTH_CUBE_ARRAY),Ds=new ye(he.TEX_DEPTH_MULTISAMPLED_2D),Ns=new ve(1),Ls=new ve(2),zs=new class extends fe{constructor(){super(9,null)}isVoidType(){return!0}toTypeName(){return"void"}genTypeId(){return"void"}toBufferLayout(t){return null}};new class extends fe{constructor(){super(10,null)}isAnyType(){return!0}toTypeName(){return"any"}genTypeId(){return"any"}toBufferLayout(t){return null}isCompatibleType(t){return!0}};const Vs=new ge("FrexpResult","default",[{name:"sig",type:we},{name:"exp",type:Be}]),Os=new ge("FrexpResultVec2","default",[{name:"sig",type:Se},{name:"exp",type:Ie}]),ks=new ge("FrexpResultVec3","default",[{name:"sig",type:Ae},{name:"exp",type:Pe}]),Us=new ge("FrexpResultVec4","default",[{name:"sig",type:Ce},{name:"exp",type:$e}]),Gs=0,Hs=1,Ws=2,Xs=3,js=4,Qs=5,qs=6,Ys=7,Zs=8,Ks=9,Js=10,tr=11,er=12,ir=13,sr={position_u8normx2:[0,te.U8VEC2_NORM,2,"u8norm",2],position_u8normx4:[0,te.U8VEC4_NORM,4,"u8norm",4],position_i8normx2:[0,te.I8VEC2_NORM,2,"i8norm",2],position_i8normx4:[0,te.I8VEC4_NORM,4,"i8norm",4],position_u16x2:[0,te.U16VEC2,4,"u16",2],position_u16x4:[0,te.U16VEC4,8,"u16",4],position_i16x2:[0,te.I16VEC2,4,"i16",2],position_i16x4:[0,te.I16VEC4,8,"i16",4],position_u16normx2:[0,te.U16VEC2_NORM,4,"u16norm",2],position_u16normx4:[0,te.U16VEC4_NORM,8,"u16norm",4],position_i16normx2:[0,te.I16VEC2_NORM,4,"i16norm",2],position_i16normx4:[0,te.I16VEC4_NORM,8,"i16norm",4],position_f16x2:[0,te.F16VEC2,4,"f16",2],position_f16x4:[0,te.F16VEC4,8,"f16",4],position_f32:[0,te.F32,4,"f32",1],position_f32x2:[0,te.F32VEC2,8,"f32",2],position_f32x3:[0,te.F32VEC3,12,"f32",3],position_f32x4:[0,te.F32VEC4,16,"f32",4],position_i32:[0,te.I32,4,"i32",1],position_i32x2:[0,te.I32VEC2,8,"i32",2],position_i32x3:[0,te.I32VEC3,12,"i32",3],position_i32x4:[0,te.I32VEC4,16,"i32",4],position_u32:[0,te.U32,4,"u32",1],position_u32x2:[0,te.U32VEC2,8,"u32",2],position_u32x3:[0,te.U32VEC3,12,"u32",3],position_u32x4:[0,te.U32VEC4,16,"u32",4],normal_f16x4:[1,te.F16VEC4,8,"f16",4],normal_f32x3:[1,te.F32VEC3,12,"f32",3],normal_f32x4:[1,te.F32VEC4,16,"f32",4],diffuse_u8normx4:[2,te.U8VEC4_NORM,4,"u8norm",4],diffuse_u16x4:[2,te.U16VEC4,8,"u16",4],diffuse_u16normx4:[2,te.U16VEC4_NORM,8,"u16norm",4],diffuse_f16x4:[2,te.F16VEC4,8,"f16",4],diffuse_f32x3:[2,te.F32VEC3,12,"f32",3],diffuse_f32x4:[2,te.F32VEC4,16,"f32",4],diffuse_u32x3:[2,te.U32VEC3,12,"u32",3],diffuse_u32x4:[2,te.U32VEC4,16,"u32",4],tangent_f16x4:[3,te.F16VEC4,8,"f16",4],tangent_f32x3:[3,te.F32VEC3,12,"f32",3],tangent_f32x4:[3,te.F32VEC4,16,"f32",4],tex0_u8normx2:[4,te.U8VEC2_NORM,2,"u8norm",2],tex0_u8normx4:[4,te.U8VEC4_NORM,4,"u8norm",4],tex0_i8normx2:[4,te.I8VEC2_NORM,2,"i8norm",2],tex0_i8normx4:[4,te.I8VEC4_NORM,4,"i8norm",4],tex0_u16x2:[4,te.U16VEC2,4,"u16",2],tex0_u16x4:[4,te.U16VEC4,8,"u16",4],tex0_i16x2:[4,te.I16VEC2,4,"i16",2],tex0_i16x4:[4,te.I16VEC4,8,"i16",4],tex0_u16normx2:[4,te.U16VEC2_NORM,4,"u16norm",2],tex0_u16normx4:[4,te.U16VEC4_NORM,8,"u16norm",4],tex0_i16normx2:[4,te.I16VEC2_NORM,4,"i16norm",2],tex0_i16normx4:[4,te.I16VEC4_NORM,8,"i16norm",4],tex0_f16x2:[4,te.F16VEC2,4,"f16",2],tex0_f16x4:[4,te.F16VEC4,8,"f16",4],tex0_f32:[4,te.F32,4,"f32",1],tex0_f32x2:[4,te.F32VEC2,8,"f32",2],tex0_f32x3:[4,te.F32VEC3,12,"f32",3],tex0_f32x4:[4,te.F32VEC4,16,"f32",4],tex0_i32:[4,te.I32,4,"i32",1],tex0_i32x2:[4,te.I32VEC2,8,"i32",2],tex0_i32x3:[4,te.I32VEC3,12,"i32",3],tex0_i32x4:[4,te.I32VEC4,16,"i32",4],tex0_u32:[4,te.U32,4,"u32",1],tex0_u32x2:[4,te.U32VEC2,8,"u32",2],tex0_u32x3:[4,te.U32VEC3,12,"u32",3],tex0_u32x4:[4,te.U32VEC4,16,"u32",4],tex1_u8normx2:[5,te.U8VEC2_NORM,2,"u8norm",2],tex1_u8normx4:[5,te.U8VEC4_NORM,4,"u8norm",4],tex1_i8normx2:[5,te.I8VEC2_NORM,2,"i8norm",2],tex1_i8normx4:[5,te.I8VEC4_NORM,4,"i8norm",4],tex1_u16x2:[5,te.U16VEC2,4,"u16",2],tex1_u16x4:[5,te.U16VEC4,8,"u16",4],tex1_i16x2:[5,te.I16VEC2,4,"i16",2],tex1_i16x4:[5,te.I16VEC4,8,"i16",4],tex1_u16normx2:[5,te.U16VEC2_NORM,4,"u16norm",2],tex1_u16normx4:[5,te.U16VEC4_NORM,8,"u16norm",4],tex1_i16normx2:[5,te.I16VEC2_NORM,4,"i16norm",2],tex1_i16normx4:[5,te.I16VEC4_NORM,8,"i16norm",4],tex1_f16x2:[5,te.F16VEC2,4,"f16",2],tex1_f16x4:[5,te.F16VEC4,8,"f16",4],tex1_f32:[5,te.F32,4,"f32",1],tex1_f32x2:[5,te.F32VEC2,8,"f32",2],tex1_f32x3:[5,te.F32VEC3,12,"f32",3],tex1_f32x4:[5,te.F32VEC4,16,"f32",4],tex1_i32:[5,te.I32,4,"i32",1],tex1_i32x2:[5,te.I32VEC2,8,"i32",2],tex1_i32x3:[5,te.I32VEC3,12,"i32",3],tex1_i32x4:[5,te.I32VEC4,16,"i32",4],tex1_u32:[5,te.U32,4,"u32",1],tex1_u32x2:[5,te.U32VEC2,8,"u32",2],tex1_u32x3:[5,te.U32VEC3,12,"u32",3],tex1_u32x4:[5,te.U32VEC4,16,"u32",4],tex2_u8normx2:[6,te.U8VEC2_NORM,2,"u8norm",2],tex2_u8normx4:[6,te.U8VEC4_NORM,4,"u8norm",4],tex2_i8normx2:[6,te.I8VEC2_NORM,2,"i8norm",2],tex2_i8normx4:[6,te.I8VEC4_NORM,4,"i8norm",4],tex2_u16x2:[6,te.U16VEC2,4,"u16",2],tex2_u16x4:[6,te.U16VEC4,8,"u16",4],tex2_i16x2:[6,te.I16VEC2,4,"i16",2],tex2_i16x4:[6,te.I16VEC4,8,"i16",4],tex2_u16normx2:[6,te.U16VEC2_NORM,4,"u16norm",2],tex2_u16normx4:[6,te.U16VEC4_NORM,8,"u16norm",4],tex2_i16normx2:[6,te.I16VEC2_NORM,4,"i16norm",2],tex2_i16normx4:[6,te.I16VEC4_NORM,8,"i16norm",4],tex2_f16x2:[6,te.F16VEC2,4,"f16",2],tex2_f16x4:[6,te.F16VEC4,8,"f16",4],tex2_f32:[6,te.F32,4,"f32",1],tex2_f32x2:[6,te.F32VEC2,8,"f32",2],tex2_f32x3:[6,te.F32VEC3,12,"f32",3],tex2_f32x4:[6,te.F32VEC4,16,"f32",4],tex2_i32:[6,te.I32,4,"i32",1],tex2_i32x2:[6,te.I32VEC2,8,"i32",2],tex2_i32x3:[6,te.I32VEC3,12,"i32",3],tex2_i32x4:[6,te.I32VEC4,16,"i32",4],tex2_u32:[6,te.U32,4,"u32",1],tex2_u32x2:[6,te.U32VEC2,8,"u32",2],tex2_u32x3:[6,te.U32VEC3,12,"u32",3],tex2_u32x4:[6,te.U32VEC4,16,"u32",4],tex3_u8normx2:[7,te.U8VEC2_NORM,2,"u8norm",2],tex3_u8normx4:[7,te.U8VEC4_NORM,4,"u8norm",4],tex3_i8normx2:[7,te.I8VEC2_NORM,2,"i8norm",2],tex3_i8normx4:[7,te.I8VEC4_NORM,4,"i8norm",4],tex3_u16x2:[7,te.U16VEC2,4,"u16",2],tex3_u16x4:[7,te.U16VEC4,8,"u16",4],tex3_i16x2:[7,te.I16VEC2,4,"i16",2],tex3_i16x4:[7,te.I16VEC4,8,"i16",4],tex3_u16normx2:[7,te.U16VEC2_NORM,4,"u16norm",2],tex3_u16normx4:[7,te.U16VEC4_NORM,8,"u16norm",4],tex3_i16normx2:[7,te.I16VEC2_NORM,4,"i16norm",2],tex3_i16normx4:[7,te.I16VEC4_NORM,8,"i16norm",4],tex3_f16x2:[7,te.F16VEC2,4,"f16",2],tex3_f16x4:[7,te.F16VEC4,8,"f16",4],tex3_f32:[7,te.F32,4,"f32",1],tex3_f32x2:[7,te.F32VEC2,8,"f32",2],tex3_f32x3:[7,te.F32VEC3,12,"f32",3],tex3_f32x4:[7,te.F32VEC4,16,"f32",4],tex3_i32:[7,te.I32,4,"i32",1],tex3_i32x2:[7,te.I32VEC2,8,"i32",2],tex3_i32x3:[7,te.I32VEC3,12,"i32",3],tex3_i32x4:[7,te.I32VEC4,16,"i32",4],tex3_u32:[7,te.U32,4,"u32",1],tex3_u32x2:[7,te.U32VEC2,8,"u32",2],tex3_u32x3:[7,te.U32VEC3,12,"u32",3],tex3_u32x4:[7,te.U32VEC4,16,"u32",4],tex4_u8normx2:[8,te.U8VEC2_NORM,2,"u8norm",2],tex4_u8normx4:[8,te.U8VEC4_NORM,4,"u8norm",4],tex4_i8normx2:[8,te.I8VEC2_NORM,2,"i8norm",2],tex4_i8normx4:[8,te.I8VEC4_NORM,4,"i8norm",4],tex4_u16x2:[8,te.U16VEC2,4,"u16",2],tex4_u16x4:[8,te.U16VEC4,8,"u16",4],tex4_i16x2:[8,te.I16VEC2,4,"i16",2],tex4_i16x4:[8,te.I16VEC4,8,"i16",4],tex4_u16normx2:[8,te.U16VEC2_NORM,4,"u16norm",2],tex4_u16normx4:[8,te.U16VEC4_NORM,8,"u16norm",4],tex4_i16normx2:[8,te.I16VEC2_NORM,4,"i16norm",2],tex4_i16normx4:[8,te.I16VEC4_NORM,8,"i16norm",4],tex4_f16x2:[8,te.F16VEC2,4,"f16",2],tex4_f16x4:[8,te.F16VEC4,8,"f16",4],tex4_f32:[8,te.F32,4,"f32",1],tex4_f32x2:[8,te.F32VEC2,8,"f32",2],tex4_f32x3:[8,te.F32VEC3,12,"f32",3],tex4_f32x4:[8,te.F32VEC4,16,"f32",4],tex4_i32:[8,te.I32,4,"i32",1],tex4_i32x2:[8,te.I32VEC2,8,"i32",2],tex4_i32x3:[8,te.I32VEC3,12,"i32",3],tex4_i32x4:[8,te.I32VEC4,16,"i32",4],tex4_u32:[8,te.U32,4,"u32",1],tex4_u32x2:[8,te.U32VEC2,8,"u32",2],tex4_u32x3:[8,te.U32VEC3,12,"u32",3],tex4_u32x4:[8,te.U32VEC4,16,"u32",4],tex5_u8normx2:[9,te.U8VEC2_NORM,2,"u8norm",2],tex5_u8normx4:[9,te.U8VEC4_NORM,4,"u8norm",4],tex5_i8normx2:[9,te.I8VEC2_NORM,2,"i8norm",2],tex5_i8normx4:[9,te.I8VEC4_NORM,4,"i8norm",4],tex5_u16x2:[9,te.U16VEC2,4,"u16",2],tex5_u16x4:[9,te.U16VEC4,8,"u16",4],tex5_i16x2:[9,te.I16VEC2,4,"i16",2],tex5_i16x4:[9,te.I16VEC4,8,"i16",4],tex5_u16normx2:[9,te.U16VEC2_NORM,4,"u16norm",2],tex5_u16normx4:[9,te.U16VEC4_NORM,8,"u16norm",4],tex5_i16normx2:[9,te.I16VEC2_NORM,4,"i16norm",2],tex5_i16normx4:[9,te.I16VEC4_NORM,8,"i16norm",4],tex5_f16x2:[9,te.F16VEC2,4,"f16",2],tex5_f16x4:[9,te.F16VEC4,8,"f16",4],tex5_f32:[9,te.F32,4,"f32",1],tex5_f32x2:[9,te.F32VEC2,8,"f32",2],tex5_f32x3:[9,te.F32VEC3,12,"f32",3],tex5_f32x4:[9,te.F32VEC4,16,"f32",4],tex5_i32:[9,te.I32,4,"i32",1],tex5_i32x2:[9,te.I32VEC2,8,"i32",2],tex5_i32x3:[9,te.I32VEC3,12,"i32",3],tex5_i32x4:[9,te.I32VEC4,16,"i32",4],tex5_u32:[9,te.U32,4,"u32",1],tex5_u32x2:[9,te.U32VEC2,8,"u32",2],tex5_u32x3:[9,te.U32VEC3,12,"u32",3],tex5_u32x4:[9,te.U32VEC4,16,"u32",4],tex6_u8normx2:[Js,te.U8VEC2_NORM,2,"u8norm",2],tex6_u8normx4:[Js,te.U8VEC4_NORM,4,"u8norm",4],tex6_i8normx2:[Js,te.I8VEC2_NORM,2,"i8norm",2],tex6_i8normx4:[Js,te.I8VEC4_NORM,4,"i8norm",4],tex6_u16x2:[Js,te.U16VEC2,4,"u16",2],tex6_u16x4:[Js,te.U16VEC4,8,"u16",4],tex6_i16x2:[Js,te.I16VEC2,4,"i16",2],tex6_i16x4:[Js,te.I16VEC4,8,"i16",4],tex6_u16normx2:[Js,te.U16VEC2_NORM,4,"u16norm",2],tex6_u16normx4:[Js,te.U16VEC4_NORM,8,"u16norm",4],tex6_i16normx2:[Js,te.I16VEC2_NORM,4,"i16norm",2],tex6_i16normx4:[Js,te.I16VEC4_NORM,8,"i16norm",4],tex6_f16x2:[Js,te.F16VEC2,4,"f16",2],tex6_f16x4:[Js,te.F16VEC4,8,"f16",4],tex6_f32:[Js,te.F32,4,"f32",1],tex6_f32x2:[Js,te.F32VEC2,8,"f32",2],tex6_f32x3:[Js,te.F32VEC3,12,"f32",3],tex6_f32x4:[Js,te.F32VEC4,16,"f32",4],tex6_i32:[Js,te.I32,4,"i32",1],tex6_i32x2:[Js,te.I32VEC2,8,"i32",2],tex6_i32x3:[Js,te.I32VEC3,12,"i32",3],tex6_i32x4:[Js,te.I32VEC4,16,"i32",4],tex6_u32:[Js,te.U32,4,"u32",1],tex6_u32x2:[Js,te.U32VEC2,8,"u32",2],tex6_u32x3:[Js,te.U32VEC3,12,"u32",3],tex6_u32x4:[Js,te.U32VEC4,16,"u32",4],tex7_u8normx2:[tr,te.U8VEC2_NORM,2,"u8norm",2],tex7_u8normx4:[tr,te.U8VEC4_NORM,4,"u8norm",4],tex7_i8normx2:[tr,te.I8VEC2_NORM,2,"i8norm",2],tex7_i8normx4:[tr,te.I8VEC4_NORM,4,"i8norm",4],tex7_u16x2:[tr,te.U16VEC2,4,"u16",2],tex7_u16x4:[tr,te.U16VEC4,8,"u16",4],tex7_i16x2:[tr,te.I16VEC2,4,"i16",2],tex7_i16x4:[tr,te.I16VEC4,8,"i16",4],tex7_u16normx2:[tr,te.U16VEC2_NORM,4,"u16norm",2],tex7_u16normx4:[tr,te.U16VEC4_NORM,8,"u16norm",4],tex7_i16normx2:[tr,te.I16VEC2_NORM,4,"i16norm",2],tex7_i16normx4:[tr,te.I16VEC4_NORM,8,"i16norm",4],tex7_f16x2:[tr,te.F16VEC2,4,"f16",2],tex7_f16x4:[tr,te.F16VEC4,8,"f16",4],tex7_f32:[tr,te.F32,4,"f32",1],tex7_f32x2:[tr,te.F32VEC2,8,"f32",2],tex7_f32x3:[tr,te.F32VEC3,12,"f32",3],tex7_f32x4:[tr,te.F32VEC4,16,"f32",4],tex7_i32:[tr,te.I32,4,"i32",1],tex7_i32x2:[tr,te.I32VEC2,8,"i32",2],tex7_i32x3:[tr,te.I32VEC3,12,"i32",3],tex7_i32x4:[tr,te.I32VEC4,16,"i32",4],tex7_u32:[tr,te.U32,4,"u32",1],tex7_u32x2:[tr,te.U32VEC2,8,"u32",2],tex7_u32x3:[tr,te.U32VEC3,12,"u32",3],tex7_u32x4:[tr,te.U32VEC4,16,"u32",4],blendweights_f16x1:[er,te.F16,2,"f16",1],blendweights_f32x1:[er,te.F32,4,"f32",1],blendweights_f16x2:[er,te.F16VEC2,4,"f16",2],blendweights_f32x2:[er,te.F32VEC2,8,"f32",2],blendweights_f16x3:[er,te.F16VEC3,6,"f16",3],blendweights_f32x3:[er,te.F32VEC3,12,"f32",3],blendweights_f16x4:[er,te.F16VEC4,8,"f16",4],blendweights_f32x4:[er,te.F32VEC4,16,"f32",4],blendindices_u16x1:[ir,te.U16,2,"u16",1],blendindices_f16x1:[ir,te.F16,2,"f16",1],blendindices_f32x1:[ir,te.F32,4,"f32",1],blendindices_u32x1:[ir,te.U32,4,"u32",1],blendindices_u16x2:[ir,te.U16VEC2,4,"u16",2],blendindices_f16x2:[ir,te.F16VEC2,4,"f16",2],blendindices_f32x2:[ir,te.F32VEC2,8,"f32",2],blendindices_u32x2:[ir,te.U32VEC2,8,"u32",2],blendindices_u16x3:[ir,te.U16VEC3,6,"u16",3],blendindices_f16x3:[ir,te.F16VEC3,6,"f16",3],blendindices_f32x3:[ir,te.F32VEC3,12,"f32",3],blendindices_u32x3:[ir,te.U32VEC3,12,"u32",3],blendindices_u16x4:[ir,te.U16VEC4,8,"u16",4],blendindices_f16x4:[ir,te.F16VEC4,8,"f16",4],blendindices_f32x4:[ir,te.F32VEC4,16,"f32",4],blendindices_u32x4:[ir,te.U32VEC4,16,"u32",4]},rr={position:0,normal:1,diffuse:2,tangent:3,blendIndices:ir,blendWeights:er,texCoord0:4,texCoord1:5,texCoord2:6,texCoord3:7,texCoord4:8,texCoord5:9,texCoord6:Js,texCoord7:tr},ar={[Gs]:"position",[Hs]:"normal",[Ws]:"diffuse",[Xs]:"tangent",[ir]:"blendIndices",[er]:"blendWeights",[js]:"texCoord0",[Qs]:"texCoord1",[qs]:"texCoord2",[Ys]:"texCoord3",[Zs]:"texCoord4",[Ks]:"texCoord5",[Js]:"texCoord6",[tr]:"texCoord7"};var nr=function(t){return t[t.TF_LINEAR_COLOR_SPACE=2]="TF_LINEAR_COLOR_SPACE",t[t.TF_NO_MIPMAP=4]="TF_NO_MIPMAP",t[t.TF_WRITABLE=8]="TF_WRITABLE",t[t.TF_NO_GC=16]="TF_NO_GC",t[t.BF_VERTEX=32]="BF_VERTEX",t[t.BF_INDEX=64]="BF_INDEX",t[t.BF_READ=128]="BF_READ",t[t.BF_WRITE=256]="BF_WRITE",t[t.BF_UNIFORM=512]="BF_UNIFORM",t[t.BF_STORAGE=1024]="BF_STORAGE",t[t.BF_PACK_PIXEL=2048]="BF_PACK_PIXEL",t[t.BF_UNPACK_PIXEL=4096]="BF_UNPACK_PIXEL",t[t.DYNAMIC=8192]="DYNAMIC",t[t.MANAGED=16384]="MANAGED",t}({});function or(t){return rr[t]}function hr(t){return ar[t]}function lr(t,e){if(!t)return!1;const i=t.structure.structMembers[0].type;if(!i.isArrayType())return!1;const s=i.elementType;if(!s.isStructType())return t.structure.structMembers[0].name===e;for(const t of s.structMembers)if(t.name===e)return!0}function ur(t){return sr[t][0]}function cr(t){return sr[t][2]}function dr(t,e,i){const s=or(t);for(const t in sr){const r=sr[t];if(r[0]===s&&r[3]===e&&r[4]===i)return t}return null}function pr(t){const e=t.structMembers[0].type.elementType;if(e.isStructType()){let t=0;for(const i of e.structMembers)t+=i.type.getSize();return t}return e.getSize()}function mr(t,e){const i=hr(e);return i?function(t,e){const i=t.structMembers[0],s=i.type.elementType;if(s.isStructType()){for(const t of s.structMembers)if(t.name===e)return t.type;return null}return i.name===e?s:null}(t,i):null}function fr(t,...e){if(0===e.length)return null;if(1===e.length){const i=sr[e[0]];return new ge(null,"packed",[{name:hr(i[0]),type:new xe(_e.getCachedTypeInfo(i[1]),t)}])}{const i=new ge(null,"packed",e.map(t=>({name:hr(sr[t][0]),type:_e.getCachedTypeInfo(sr[t][1])})));return new ge(null,"packed",[{name:"value",type:new xe(i,t)}])}}const _r=function(){const t=[];for(let e=0;e<16;e++)t.push(gr(e));return t}();function gr(t){switch(t){case 0:return"a_position";case 1:return"a_normal";case 2:return"a_diffuse";case 3:return"a_tangent";case 4:return"a_texcoord0";case 5:return"a_texcoord1";case 6:return"a_texcoord2";case 7:return"a_texcoord3";case 8:return"a_texcoord4";case 9:return"a_texcoord5";case Js:return"a_texcoord6";case tr:return"a_texcoord7";case ir:return"a_indices";case er:return"a_weight";default:return null}}function xr(t){return t.isTexture2D()?"texture_2d":t.isTexture2DArray()?"texture_2darray":t.isTexture3D()?"texture_3d":t.isTextureCube()?"texture_cube":t.isTextureVideo()?"texture_video":t.isBuffer()?"buffer":t.isFramebuffer()?"framebuffer":t.isProgram()?"program":t.isSampler()?"sampler":t.isVertexLayout()?"vbo":"unknown"}class br{_vertexBuffers;_indexBuffer;_drawOffset;_numVertices;constructor(){this._vertexBuffers=[];for(let t=0;t<16;t++)this._vertexBuffers.push(null);this._indexBuffer=null,this._drawOffset=0,this._numVertices=0}clone(){const t=new br;return t._vertexBuffers=this._vertexBuffers.slice(),t._indexBuffer=this._indexBuffer,t._drawOffset=this._drawOffset,t.calcNumVertices(),t}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get numVertices(){return this._numVertices}getDrawOffset(){return this._drawOffset}setDrawOffset(t){t!==this._drawOffset&&(this._drawOffset=t,this.calcNumVertices())}getVertexBuffer(t){return this._vertexBuffers[or(t)]?.buffer??null}getVertexBufferInfo(t){return this._vertexBuffers[or(t)]??null}getIndexBuffer(){return this._indexBuffer||null}setVertexBuffer(t,e){if(!t)return null;if(!(t.usage&nr.BF_VERTEX))throw new Error("setVertexBuffer() failed: buffer is null or buffer has not Vertex usage flag");e=e||"vertex";const i=t.structure.structMembers[0].type.elementType;if(i.isStructType()){let s=0;for(const r of i.structMembers){const i=or(r.name);this.internalSetVertexBuffer(i,t,s,e),s+=r.size}}else{const i=or(t.structure.structMembers[0].name);this.internalSetVertexBuffer(i,t,0,e)}return t}removeVertexBuffer(t){let e=!1;for(let i=0;i<this._vertexBuffers.length;i++){const s=this._vertexBuffers[i];s?.buffer===t&&(this._vertexBuffers[i]=null,e=!0)}return e&&this.calcNumVertices(),e}setIndexBuffer(t){return t!==this._indexBuffer&&(this._indexBuffer=t||null),t}calcNumVertices(){this._numVertices=0;for(let t=0;t<16;t++){const e=this._vertexBuffers[t];if(e&&"instance"!==e.stepMode){const t=Math.floor(e.buffer.byteLength/e.stride);t>this._numVertices&&(this._numVertices=t)}}}internalSetVertexBuffer(t,e,i,s){if(t<0||t>=16)throw new Error(`setVertexBuffer() failed: location out of bounds: ${t}`);i=Number(i)||0,s=s||"vertex";const r=this._vertexBuffers[t];return r&&r.buffer===e&&r.offset===i&&r.stepMode===s?null:(this._vertexBuffers[t]={buffer:e,offset:i,type:mr(e.structure,t),stride:pr(e.structure),drawOffset:0,stepMode:s},this.calcNumVertices(),e)}}class vr{_cpuTimer;_cpuStart;_cpuTime;_ended;constructor(){this._cpuTimer=window.performance||window.Date,this._cpuTime=null,this._ended=!1}now(){return this._cpuTimer.now()}begin(){this._cpuStart=this.now(),this._cpuTime=null,this._ended=!1}end(){this._cpuTime=this.now()-this._cpuStart,this._ended=!0}ended(){return this._ended}elapsed(){return this._cpuTime}}class yr{_memCost;_memCostThreshold;_device;_id;_freeTextures={};_allocatedTextures=new WeakMap;_autoReleaseTextures=new Set;_freeFramebuffers={};_allocatedFramebuffers=new WeakMap;_autoReleaseFramebuffers=new Set;constructor(t,e,i=1073741824){this._device=t,this._id=e,this._memCost=0,this._memCostThreshold=i,this._freeTextures={},this._allocatedTextures=new WeakMap,this._autoReleaseTextures=new Set,this._freeFramebuffers={},this._allocatedFramebuffers=new WeakMap,this._autoReleaseFramebuffers=new Set,this._memCost=0}get id(){return this._id}autoRelease(){for(const t of this._autoReleaseTextures)this.releaseTexture(t);this._autoReleaseTextures.clear();for(const t of this._autoReleaseFramebuffers)this.releaseFrameBuffer(t);this._autoReleaseFramebuffers.clear(),this._memCost>=this._memCostThreshold&&this.purge()}fetchTemporalTexture2D(t,e,i,s,r=!1){const a=`2d:${e}:${i}:${s}:${r?1:0}`;let n=null;const o=this._freeTextures[a];return o?(n=o.pop(),0===o.length&&(this._freeTextures[a]=void 0)):(n=this._device.createTexture2D(e,i,s,{mipmapping:r}),this._memCost+=n.memCost),this._allocatedTextures.set(n,{hash:a,refcount:1,dispose:!1}),t&&this._autoReleaseTextures.add(n),n}fetchTemporalTexture2DArray(t,e,i,s,r,a=!1){const n=`2darray:${e}:${i}:${s}:${r}:${a?1:0}`;let o=null;const h=this._freeTextures[n];return h?(o=h.pop(),0===h.length&&(this._freeTextures[n]=void 0)):(o=this._device.createTexture2DArray(e,i,s,r,{mipmapping:a}),this._memCost+=o.memCost),this._allocatedTextures.set(o,{hash:n,refcount:1,dispose:!1}),t&&this._autoReleaseTextures.add(o),o}fetchTemporalTextureCube(t,e,i,s=!1){const r=`cube:${e}:${i}:${s?1:0}`;let a=null;const n=this._freeTextures[r];return n?(a=n.pop(),0===n.length&&(this._freeTextures[r]=void 0)):(a=this._device.createCubeTexture(e,i,{mipmapping:s}),this._memCost+=a.memCost),this._allocatedTextures.set(a,{hash:r,refcount:1,dispose:!1}),t&&this._autoReleaseTextures.add(a),a}fetchTemporalFramebuffer(t,e,i,s,r=null,a=!1,n=1,o=!0,h=0,l=0,u=0){const c=Array.isArray(s)?s:s?[s]:[],d=c.map(t=>"string"==typeof t?this.fetchTemporalTexture2D(!1,t,e,i,a):t),p="string"==typeof r?this.fetchTemporalTexture2D(!1,r,e,i,!1):r,m=this.createTemporalFramebuffer(t,d,p,n,o,h,l,u);for(let t=0;t<c.length;t++)"string"==typeof c[t]&&this.releaseTexture(d[t]);return"string"==typeof r&&this.releaseTexture(p),m}createTemporalFramebuffer(t,e,i=null,s=1,r=!0,a=0,n=0,o=0){e=e??[];let h=`${i?.uid??0}:${s??1}:${r?1:0}`;if(e.length>0){h+=`:${a}:${n}:${o}`;for(const t of e)h+=`:${t.uid}`}let l=null;const u=this._freeFramebuffers[h];if(u)l=u.pop(),0===u.length&&(this._freeFramebuffers[h]=void 0);else{l=this._device.createFrameBuffer(e,i,{ignoreDepthStencil:r,sampleCount:s});for(let t=0;t<l.getColorAttachments().length;t++)l.setColorAttachmentMipLevel(t,a),l.setColorAttachmentCubeFace(t,n),l.setColorAttachmentLayer(t,o)}const c=this._allocatedTextures.get(i);c&&c.refcount++;for(const t of e){const e=this._allocatedTextures.get(t);e&&e.refcount++}return this._allocatedFramebuffers.set(l,{hash:h,refcount:1}),t&&this._autoReleaseFramebuffers.add(l),l}disposeTexture(t){this.safeReleaseTexture(t,!0)}releaseTexture(t){this._allocatedTextures.get(t)?this.safeReleaseTexture(t):console.error("ObjectPool.releaseTexture(): texture is not allocated from pool")}retainTexture(t){const e=this._allocatedTextures.get(t);e?e.refcount++:console.error("ObjectPool.retainTexture(): texture is not allocated from pool")}disposeFrameBuffer(t){this._allocatedFramebuffers.get(t)?(this.internalDisposeFrameBuffer(t),t.dispose()):console.error("ObjectPool.disposeFrameBuffer(): framebuffer is not allocated from pool")}releaseFrameBuffer(t){const e=this._allocatedFramebuffers.get(t);if(e){if(e.refcount--,e.refcount<=0){this.internalDisposeFrameBuffer(t);const i=this._freeFramebuffers[e.hash];i?i.push(t):this._freeFramebuffers[e.hash]=[t]}}else console.error("ObjectPool.releaseFrameBuffer(): framebuffer is not allocated from pool")}retainFrameBuffer(t){const e=this._allocatedFramebuffers.get(t);e?e.refcount++:console.error("ObjectPool.retainFrameBuffer(): framebuffer is not allocated from pool")}purge(){for(const t in this._freeFramebuffers){if(this._freeFramebuffers[t])for(const e of this._freeFramebuffers[t])this.internalDisposeFrameBuffer(e),e.dispose()}this._freeFramebuffers={};for(const t in this._freeTextures){const e=this._freeTextures[t];for(const t of e)this._memCost-=t.memCost,t.dispose()}this._freeTextures={}}internalDisposeFrameBuffer(t){if(t){const e=t.getColorAttachments();if(e)for(const t of e)this.safeReleaseTexture(t);const i=t.getDepthAttachment();i&&this.safeReleaseTexture(i),this._allocatedFramebuffers.delete(t),this._autoReleaseFramebuffers.delete(t)}}safeReleaseTexture(t,e=!1){const i=this._allocatedTextures.get(t);if(i)if(i.refcount--,i.refcount<=0)if(this._allocatedTextures.delete(t),this._autoReleaseTextures.delete(t),e||i.dispose)this._memCost-=t.memCost,t.dispose();else{const e=this._freeTextures[i.hash];e?e.push(t):this._freeTextures[i.hash]=[t]}else e&&(i.dispose=!0)}}class Tr{_builder;_tagList;_attribList;constructor(t){this._builder=t,this._tagList={},this._attribList={}}get vertexAttributes(){return this._builder.getVertexAttributes()}hasVertexAttribute(t){return this.vertexAttributes.indexOf(t)>=0}clear(){this._tagList={},this._attribList={}}tag(t,e){if("string"==typeof t){if(void 0===e)return this.getTag(t);this.addTag(t,e)}else for(const e of Object.keys(t))this.addTag(e,t[e])}attribute(t){return this._attribList[t]||null}setAttrib(t,e){this._attribList[t]=e}addTag(t,e){this._tagList[t]=e}getTag(t){const e=this._tagList[t];return e?e(this._builder.getGlobalScope()):null}}function wr(t,e){return"number"==typeof e||"boolean"==typeof e||Array.isArray(e)?`${e}`:e.$ast?.toString(t)}function Sr(t,e){return e?.toTypeName(t)}class Ar extends Error{}class Cr extends Ar{value;constructor(t){super(),this.value=t}getMessage(t){return`value out of range: ${this.value}`}}class Er extends Ar{value;valueType;expectedType;constructor(t,e,i){super(),this.value=t,this.valueType=e,this.expectedType=i}getMessage(t){return`cannot convert '${"string"==typeof this.value?this.value:wr(t,this.value)}' of type '${"string"==typeof this.valueType?this.valueType:Sr(t,this.valueType)}' to type ${"string"==typeof this.expectedType?this.expectedType:Sr(t,this.expectedType)}`}}class Mr extends Ar{func;constructor(t){super(),this.func=t}getMessage(t){return`wrong argument count for function '${this.func}'`}}class Br extends Ar{func;param;constructor(t,e){super(),this.func=t,this.param=e||null}getMessage(t){return`parameter type error for function '${this.func}': ${this.param}`}}class Ir extends Ar{func;param;reason;constructor(t,e,i){super(),this.func=t,this.param=e||null,this.reason=i||null}getMessage(t){return`invalid parameter value for function '${this.func}'${this.param?": "+this.param:""}${this.reason?": "+this.reason:""}}`}}class Pr extends Ar{func;constructor(t){super(),this.func=t}getMessage(t){return`No matched overloading found for function '${this.func}'`}}class $r extends Ar{value;constructor(t){super(),this.value=t}getMessage(t){return`'${wr(t,this.value)}' is not a reference type`}}class Rr extends Ar{value;constructor(t){super(),this.value=t}getMessage(t){return`'${wr(t,this.value)}' is not a pointer type`}}class Fr extends Ar{feature;constructor(t){super(),this.feature=t}getMessage(t){return`feature not support for ${t} device: ${this.feature}`}}class Dr extends Ar{funcName;constructor(t){super(),this.funcName=t}getMessage(t){return`function call must be made inside a function scope: ${this.funcName}()`}}class Nr extends Ar{ast;text;constructor(t,e){super(),this.ast=t,this.text=e}getMessage(t){return`${this.text}: ${this.ast.toString(t)}`}}class Lr extends Ar{constructor(t){super(t)}getMessage(t){return`Internal error: ${this.message}`}}let zr=null;function Vr(t){zr=t}function Or(){return zr}const kr="zVSInput",Ur="zVSOutput",Gr="zFSInput",Hr="zFSOutput",Wr="zCSInput";var Xr=function(t){return t[t.DECLARE_TYPE_NONE=0]="DECLARE_TYPE_NONE",t[t.DECLARE_TYPE_IN=1]="DECLARE_TYPE_IN",t[t.DECLARE_TYPE_OUT=2]="DECLARE_TYPE_OUT",t[t.DECLARE_TYPE_WORKGROUP=3]="DECLARE_TYPE_WORKGROUP",t[t.DECLARE_TYPE_UNIFORM=4]="DECLARE_TYPE_UNIFORM",t[t.DECLARE_TYPE_STORAGE=5]="DECLARE_TYPE_STORAGE",t}({}),jr=function(t){return t[t.NONE=0]="NONE",t[t.HIGH=1]="HIGH",t[t.MEDIUM=2]="MEDIUM",t[t.LOW=3]="LOW",t}({});function Qr(t){switch(t){case Xt.Vertex:return"zVertexInput";case Xt.Fragment:return"zVertexOutput";case Xt.Compute:return"zComputeInput";default:return null}}function qr(t){switch(t){case Xt.Vertex:return"zVSInputCpy";case Xt.Fragment:return"zFSInputCpy";case Xt.Compute:return"zCSInputCpy";default:return null}}function Yr(t){switch(t){case Xt.Vertex:return"zVSOutputCpy";case Xt.Fragment:return"zFSOutputCpy";case Xt.Compute:return"zCSOutputCpy";default:return null}}function Zr(t){switch(t){case Xt.Vertex:return kr;case Xt.Fragment:return Gr;case Xt.Compute:return Wr;default:return null}}function Kr(t,e){return`ch_auto_sampler_${t}${e?"_comparison":""}`}const Jr={webgl:{position:{name:"gl_Position",type:new _e(te.F32VEC4),stage:"vertex"},pointSize:{name:"gl_PointSize",type:new _e(te.F32),stage:"vertex"},fragCoord:{name:"gl_FragCoord",type:new _e(te.F32VEC4),stage:"fragment"},frontFacing:{name:"gl_FrontFacing",type:new _e(te.BOOL),stage:"fragment"},fragDepth:{name:"gl_FragDepthEXT",type:new _e(te.F32),inOrOut:"out",extension:"GL_EXT_frag_depth",stage:"fragment"}},webgl2:{vertexIndex:{name:"gl_VertexID",semantic:"vertex_index",type:new _e(te.U32),inOrOut:"in",stage:"vertex"},instanceIndex:{name:"gl_InstanceID",semantic:"instance_index",type:new _e(te.U32),inOrOut:"in",stage:"vertex"},position:{name:"gl_Position",type:new _e(te.F32VEC4),stage:"vertex"},pointSize:{name:"gl_PointSize",type:new _e(te.F32),stage:"vertex"},fragCoord:{name:"gl_FragCoord",type:new _e(te.F32VEC4),stage:"fragment"},frontFacing:{name:"gl_FrontFacing",type:new _e(te.BOOL),stage:"fragment"},fragDepth:{name:"gl_FragDepth",type:new _e(te.F32),stage:"fragment"}},webgpu:{vertexIndex:{name:"zVertexId",semantic:"vertex_index",type:new _e(te.U32),inOrOut:"in",stage:"vertex"},instanceIndex:{name:"zInstanceId",semantic:"instance_index",type:new _e(te.U32),inOrOut:"in",stage:"vertex"},position:{name:"zPosition",semantic:"position",type:new _e(te.F32VEC4),inOrOut:"out",stage:"vertex"},fragCoord:{name:"zFragCoord",semantic:"position",type:new _e(te.F32VEC4),inOrOut:"in",stage:"fragment"},frontFacing:{name:"zFrontFacing",semantic:"front_facing",type:new _e(te.BOOL),inOrOut:"in",stage:"fragment"},fragDepth:{name:"zFragDepth",semantic:"frag_depth",type:new _e(te.F32),inOrOut:"out",stage:"fragment"},localInvocationId:{name:"zLocalInvocationId",semantic:"local_invocation_id",type:new _e(te.U32VEC3),inOrOut:"in",stage:"compute"},globalInvocationId:{name:"zGlobalInvocationId",semantic:"global_invocation_id",type:new _e(te.U32VEC3),inOrOut:"in",stage:"compute"},workGroupId:{name:"zWorkGroupId",semantic:"workgroup_id",type:new _e(te.U32VEC3),inOrOut:"in",stage:"compute"},numWorkGroups:{name:"zNumWorkGroups",semantic:"num_workgroups",type:new _e(te.U32VEC3),inOrOut:"in",stage:"compute"},sampleMaskIn:{name:"zSampleMaskIn",semantic:"sample_mask_in",type:new _e(te.U32),inOrOut:"in",stage:"fragment"},sampleMaskOut:{name:"zSampleMaskOut",semantic:"sample_mask_out",type:new _e(te.U32),inOrOut:"out",stage:"fragment"},sampleIndex:{name:"zSampleIndex",semantic:"sample_index",type:new _e(te.U32),inOrOut:"in",stage:"fragment"}}};function ta(t){return t%1==0?t.toFixed(1):String(t)}function ea(t){return String(0|t)}function ia(t){return String(t>>>0)}function sa(t){if("("===(t=t.trim())[0]&&")"===t[t.length-1]){let e=0;for(let i=1;i<t.length-1;i++)if("("===t[i])e++;else if(")"===t[i]&&(e--,e<0))break;if(e>0)throw new Lr(`Invalid expression: ${t}`);if(0===e)return t.substring(1,t.length-1)}return t}class ra{isReference(){return!1}isPointer(){return!!this.getType()?.isPointerType()}getType(){return null}toWebGL(t,e){return""}toWebGL2(t,e){return""}toWGSL(t,e){return""}toString(t){return this.constructor.name}}class aa extends ra{}class na extends aa{paramAST;writable;constructor(t){super(),this.paramAST=t,this.writable=!1}getType(){return this.paramAST.getType()}markWritable(){this.paramAST instanceof ua&&console.warn(`Write to non-output parameter ${this.paramAST.value.$str}`),this.writable=!0}isWritable(){return this.writable}getAddressSpace(){return this.paramAST.getAddressSpace()}isConstExp(){return this.paramAST.isConstExp()}isReference(){return this.paramAST.isReference()}toWebGL(t,e){return this.paramAST.toWebGL(t,e)}toWebGL2(t,e){return this.paramAST.toWebGL2(t,e)}toWGSL(t,e){return this.paramAST.toWGSL(t,e)}}class oa extends ra{statements;constructor(){super(),this.statements=[]}toWebGL(t,e){return this.statements.filter(t=>!(t instanceof $a)||t.isStatement).map(i=>i.toWebGL(t,e)).join("")}toWebGL2(t,e){return this.statements.filter(t=>!(t instanceof $a)||t.isStatement).map(i=>i.toWebGL2(t,e)).join("")}toWGSL(t,e){return this.statements.filter(t=>!(t instanceof $a)||t.isStatement).map(i=>i instanceof $a&&!i.getType().isVoidType()?`${t}_ = ${i.toWGSL("",e)}`:i.toWGSL(t,e)).join("")}}class ha extends oa{toWebGL(t,e){return`${t}{\n${super.toWebGL(t+" ",e)}${t}}\n`}toWebGL2(t,e){return`${t}{\n${super.toWebGL2(t+" ",e)}${t}}\n`}toWGSL(t,e){return`${t}{\n${super.toWGSL(t+" ",e)}${t}}\n`}}class la extends oa{uniforms;constructor(){super(),this.uniforms=[]}findFunctions(t){const e=[];for(const i of this.statements)i instanceof Fa&&i.name===t&&e.push(i);return e}toWebGL(t,e){const i=`${t}precision highp float;\n${t}precision highp int;\n`,s=`${t}#version 100\n`,r=e.types.map(i=>i.toWebGL(t,e)).join("")+this.uniforms.map(i=>i.toWebGL(t,e)).join("")+e.inputs.map(i=>i.toWebGL(t,e)).join("")+e.outputs.map(i=>i.toWebGL(t,e)).join("")+super.toWebGL(t,e);for(const t of e.builtins){const i=Jr.webgl[t];i.extension&&e.extensions.add(i.extension)}return s+[...e.extensions].map(e=>`${t}#extension ${e}: enable\n`).join("")+i+e.defines.join("")+r}toWebGL2(t,e){const i=`${t}precision highp float;\n${t}precision highp int;\n`,s=`${t}#version 300 es\n`,r=e.types.map(i=>i.toWebGL2(t,e)).join("")+this.uniforms.map(i=>i.toWebGL2(t,e)).join("")+e.inputs.map(i=>i.toWebGL2(t,e)).join("")+e.outputs.map(i=>i.toWebGL2(t,e)).join("")+super.toWebGL2(t,e);for(const t of e.builtins){const i=Jr.webgl2[t];i.extension&&e.extensions.add(i.extension)}return s+[...e.extensions].map(e=>`${t}#extension ${e}: enable\n`).join("")+i+e.defines.join("")+r}toWGSL(t,e){const i=e.type===Xt.Vertex?[kr,Ur]:e.type===Xt.Fragment?[Gr,Hr]:[Wr],s=[];for(const t of e.builtins)s.push(Jr.webgpu[t].name);const r=Object.keys(Jr.webgpu).map(t=>Jr.webgpu[t].name);for(const t of e.types)if(t instanceof Va&&i.indexOf(t.type.structName)>=0)for(let e=t.type.structMembers.length-1;e>=0;e--){const i=t.type.structMembers[e];r.indexOf(i.name)>=0&&s.indexOf(i.name)<0&&(t.type.structMembers.splice(e,1),t.prefix.splice(e,1))}return e.types=e.types.filter(t=>!(t instanceof Va)||t.type.structMembers.length>0),e.types.map(i=>i.toWGSL(t,e)).join("")+this.uniforms.map(i=>i.toWGSL(t,e)).join("")+super.toWGSL(t,e)}}class ua extends aa{value;ref;writable;constExp;constructor(t){super(),this.value=t,this.ref=null,this.writable=!1,this.constExp=!1}get name(){return this.value.$str}isReference(){return!0}isConstExp(){return this.constExp}markWritable(){this.writable=!0,this.constExp=!1,this.ref&&this.ref.markWritable()}isWritable(){const t=this.getType();return this.writable||t.isAtomicI32()||t.isAtomicU32()||t.isStructType()&&t.haveAtomicMembers()}getAddressSpace(){switch(this.value.$declareType){case 4:return me.UNIFORM;case 5:return me.STORAGE;case 1:case 2:return null;default:return this.value.$global?me.PRIVATE:me.FUNCTION}}getType(){return this.value.$typeinfo}toWebGL(t,e){return this.name}toWebGL2(t,e){return this.name}toWGSL(t,e){if(1===this.value.$declareType){const i=qr(e.type);return e.global[i][this.name].$ast.toWGSL(t,e)}if(2===this.value.$declareType){const i=Yr(e.type);return e.global[i][this.name].$ast.toWGSL(t,e)}return this.name}toString(t){return this.name}}class ca extends ra{}class da extends ca{value;constructor(t){if(super(),t.getAddressSpace()===me.UNIFORM)throw new Nr(t,"cannot assign to uniform variable");this.value=t,this.value instanceof $a&&(this.value.isStatement=!1)}getType(){return this.value.getType()}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isReference(){return this.value.isReference()}toWebGL(t,e){return this.value.toWebGL(t,e)}toWebGL2(t,e){return this.value.toWebGL2(t,e)}toWGSL(t,e){return this.value.toWGSL(t,e)}toString(t){return this.value.toString(t)}}class pa extends ca{scope;field;type;constructor(t,e,i){super(),this.scope=t,this.field=e,this.type=i}getType(){return this.type}markWritable(){this.scope.markWritable()}isWritable(){return this.scope.isWritable()}isReference(){return this.scope.isReference()}toWebGL(t,e){return`${this.scope.toWebGL(t,e)}.${this.field}`}toWebGL2(t,e){return`${this.scope.toWebGL2(t,e)}.${this.field}`}toWGSL(t,e){return`${(this.scope.isPointer()?new ya(this.scope):this.scope).toWGSL(t,e)}.${this.field}`}toString(t){return`${(this.scope.isPointer()?new ya(this.scope):this.scope).toString(t)}.${this.field}`}}class ma extends ca{value;index;type;constructor(t,e,i){super(),this.value=t,this.index=e,this.type=i,this.index instanceof $a&&(this.index.isStatement=!1)}getType(){return this.type}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isReference(){return this.value.isReference()}toWebGL(t,e){return`${this.value.toWebGL(t,e)}[${this.index.toWebGL(t,e)}]`}toWebGL2(t,e){return`${this.value.toWebGL2(t,e)}[${this.index.toWebGL2(t,e)}]`}toWGSL(t,e){return`${(this.value.isPointer()?new ya(this.value):this.value).toWGSL(t,e)}[${this.index.toWGSL(t,e)}]`}toString(t){return`${(this.value.isPointer()?new ya(this.value):this.value).toString(t)}[${this.index.toString(t)}]`}}class fa extends ca{value;constructor(t){super(),this.value=t,this.value.constExp=!0}getType(){return this.value.getType()}markWritable(){}isWritable(){return!1}isReference(){return!0}toWebGL(t,e){let i="";switch(this.value.value.$declareType){case 1:case 2:case 4:case 5:throw new Error("invalid declare type");default:i=!this.value.constExp||this.value.isWritable()||this.getType().isStructType()?"":"const "}return`${i}${this.getType().toTypeName("webgl",this.value.name)}`}toWebGL2(t,e){let i="";switch(this.value.value.$declareType){case 1:case 2:case 4:case 5:throw new Error("invalid declare type");default:i=!this.value.constExp||this.value.isWritable()||this.getType().isStructType()?"":"const "}return`${i}${this.getType().toTypeName("webgl2",this.value.name)}`}toWGSL(t,e){let i;switch(this.value.value.$declareType){case 1:case 2:case 4:case 5:throw new Error("invalid declare type");default:{const t=this.value.getAddressSpace(),e=this.getType().isPointerType()||!this.value.isWritable()&&(t===me.PRIVATE||t===me.FUNCTION),s=t===me.PRIVATE,r=t===me.STORAGE&&this.value.isWritable()?", read_write":"",a=t!==me.FUNCTION?`<${t}${r}>`:"";i=e?s?"const ":"let ":`var${a} `;break}}{const t=this.getType();t.isPointerType()&&(this.value.isWritable()||this.value.ref.isWritable())&&(t.writable=!0);return`${i}${t.toTypeName("webgpu",this.value.name)}`}}toString(t){return this.value.toString(t)}}class _a extends aa{type;args;constExp;convertedArgs;constructor(t,e){super(),this.type=t,this.args=e,this.convertedArgs=null;for(const t of e){if(null==t)throw new Error("invalid constructor argument");t instanceof $a&&(t.isStatement=!1),this.constExp&&=!(t instanceof aa)||t.isConstExp()}const i=Or().getDevice().type,s=this.type.getConstructorOverloads(i);for(const t of s)if(this.convertedArgs=Oa(this.args,t),this.convertedArgs)break;if(!this.convertedArgs)throw new Error(`no matching overload function found for type ${this.type.toTypeName(i)}`)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.constExp}getAddressSpace(){return null}toWebGL(t,e){const i=this.convertedArgs.args.map(i=>sa(i.toWebGL(t,e))).join(",");return`${this.convertedArgs.name}(${i})`}toWebGL2(t,e){const i=this.convertedArgs.args.map(i=>sa(i.toWebGL2(t,e))).join(",");return`${this.convertedArgs.name}(${i})`}toWGSL(t,e){const i=this.convertedArgs.args.map(i=>sa(i.toWGSL(t,e))).join(",");return`${this.convertedArgs.name}(${i})`}toString(t){return"constructor"}}class ga extends aa{value;type;constructor(t,e){if(super(),this.value=t,this.type=e,"number"==typeof t){if(e.primitiveType===te.BOOL)throw new Er(t,typeof t,e);if(e.primitiveType===te.I32&&(!Number.isInteger(t)||t<-2147483648||t>4294967295))throw new Er(t,typeof t,e);if(t<0&&e.primitiveType===te.U32&&(!Number.isInteger(t)||t<0||t>4294967295))throw new Er(t,typeof t,e)}else if(e.primitiveType!==te.BOOL)throw new Er(t,typeof t,e)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return!0}getAddressSpace(){return null}toWebGL(t,e){switch(this.type.primitiveType){case te.F32:return ta(this.value);case te.I32:return ea(this.value);case te.U32:return`${ia(this.value)}u`;case te.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toWebGL2(t,e){switch(this.type.primitiveType){case te.F32:return ta(this.value);case te.I32:return ea(this.value);case te.U32:return`${ia(this.value)}u`;case te.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toWGSL(t,e){switch(this.type.primitiveType){case te.F32:return ta(this.value);case te.I32:return ea(this.value);case te.U32:return`${ia(this.value)}u`;case te.BOOL:return String(!!this.value);default:throw new Error("Invalid scalar type")}}toString(t){return`${this.value}`}}class xa extends aa{source;field;type;constructor(t,e,i){super(),this.source=t,this.field=e,this.type=i,this.source instanceof $a&&(this.source.isStatement=!1)}getType(){return this.type}isReference(){return this.source.isReference()}isConstExp(){return this.source.isConstExp()}markWritable(){this.source.markWritable()}isWritable(){return this.source.isWritable()}getAddressSpace(){return this.source.getAddressSpace()}toWebGL(t,e){return this.source instanceof ga?`(${this.source.toWebGL(t,e)}).${this.field}`:`${this.source.toWebGL(t,e)}.${this.field}`}toWebGL2(t,e){return this.source instanceof ga?`(${this.source.toWebGL(t,e)}).${this.field}`:`${this.source.toWebGL(t,e)}.${this.field}`}toWGSL(t,e){const i=this.source.isPointer()?new ya(this.source):this.source;return i instanceof ga?`(${i.toWGSL(t,e)}).${this.field}`:`${i.toWGSL(t,e)}.${this.field}`}toString(t){return`${(this.source.isPointer()?new ya(this.source):this.source).toString(t)}.${this.field}`}}class ba extends aa{sourceValue;castType;constructor(t,e){super(),this.sourceValue=t,this.castType=e,this.sourceValue instanceof $a&&(this.sourceValue.isStatement=!1)}getType(){return this.castType}markWritable(){}isWritable(){return!1}isConstExp(){return this.sourceValue.isConstExp()}getAddressSpace(){return null}toWebGL(t,e){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWebGL(t,e):`${this.castType.toTypeName("webgl")}(${sa(this.sourceValue.toWebGL(t,e))})`}toWebGL2(t,e){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWebGL2(t,e):`${this.castType.toTypeName("webgl2")}(${sa(this.sourceValue.toWebGL2(t,e))})`}toWGSL(t,e){return this.castType.isCompatibleType(this.sourceValue.getType())?this.sourceValue.toWGSL(t,e):`${this.castType.toTypeName("webgpu")}(${sa(this.sourceValue.toWGSL(t,e))})`}toString(t){return`${this.castType.toTypeName(t)}(${sa(this.sourceValue.toString(t))})`}}class va extends aa{value;type;constructor(t){super(),e(t.isReference(),"no pointer type for non-reference values"),this.value=t,this.type=new be(t.getType(),t.getAddressSpace())}getType(){return this.type}isConstExp(){return!1}markWritable(){if(this.value.getAddressSpace()===me.UNIFORM)throw new Nr(this.value,"uniforms are not writable");this.value.markWritable()}isWritable(){return this.value.isWritable()}getAddressSpace(){return this.value.getAddressSpace()}toWebGL(t,e){throw new Error("GLSL does not support pointer type")}toWebGL2(t,e){throw new Error("GLSL does not support pointer type")}toWGSL(t,e){const i=this.value instanceof na?this.value.paramAST:this.value;return i instanceof ya?i.value.toWGSL(t,e):`(&${i.toWGSL(t,e)})`}toString(t){const e=this.value instanceof na?this.value.paramAST:this.value;return e instanceof ya?e.value.toString(t):`(&${e.toString(t)})`}}class ya extends aa{value;constructor(t){super(),this.value=t,this.value instanceof $a&&(this.value.isStatement=!1)}getType(){const t=this.value.getType();return t.isPointerType()?t.pointerType:t}isReference(){return!0}markWritable(){this.value.markWritable()}isWritable(){return this.value.isWritable()}isConstExp(){return!1}getAddressSpace(){return this.value instanceof aa?this.value.getAddressSpace():null}toWebGL(t,e){return this.value.toWebGL(t,e)}toWebGL2(t,e){return this.value.toWebGL2(t,e)}toWGSL(t,e){return this.value.getType().isPointerType()?`(*${this.value.toWGSL(t,e)})`:this.value.toWGSL(t,e)}toString(t){return`*${this.value.toString(t)}`}}class Ta extends aa{value;op;type;constructor(t,e,i){super(),this.value=t,this.op=e,this.type=i,this.value instanceof $a&&(this.value.isStatement=!1)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.value.isConstExp()}getAddressSpace(){return null}toWebGL(t,e){return`${this.op}${this.value.toWebGL(t,e)}`}toWebGL2(t,e){return`${this.op}${this.value.toWebGL2(t,e)}`}toWGSL(t,e){const i=this.value.isPointer()?new ya(this.value):this.value;return`${this.op}${i.toWGSL(t,e)}`}toString(t){const e=this.value.isPointer()?new ya(this.value):this.value;return`${this.op}${e.toString(t)}`}}class wa extends aa{left;right;type;op;constructor(t,e,i,s){super(),this.left=t,this.right=e,this.op=i,this.type=s,this.left instanceof $a&&(this.left.isStatement=!1),this.right instanceof $a&&(this.right.isStatement=!1)}getType(){return this.type}markWritable(){}isWritable(){return!1}isConstExp(){return this.left.isConstExp()&&this.right.isConstExp()}getAddressSpace(){return null}toWebGL(t,e){return`(${this.left.toWebGL(t,e)} ${this.op} ${this.right.toWebGL(t,e)})`}toWebGL2(t,e){return`(${this.left.toWebGL2(t,e)} ${this.op} ${this.right.toWebGL2(t,e)})`}toWGSL(t,e){const i=this.left.isPointer()?new ya(this.left):this.left,s=this.right.isPointer()?new ya(this.right):this.right;return`(${i.toWGSL(t,e)} ${this.op} ${s.toWGSL(t,e)})`}toString(t){const e=this.left.isPointer()?new ya(this.left):this.left,i=this.right.isPointer()?new ya(this.right):this.right;return`(${e.toString(t)} ${this.op} ${i.toString(t)})`}}class Sa extends aa{source;index;type;constructor(t,e,i){super(),this.source=t,this.index=e,this.type=i,this.source instanceof $a&&(this.source.isStatement=!1),this.index instanceof $a&&(this.index.isStatement=!1)}getType(){return this.type}isReference(){return this.source.isReference()}markWritable(){this.source.markWritable()}isWritable(){return this.source.isWritable()}isConstExp(){return this.source.isConstExp()&&this.index.isConstExp()}getAddressSpace(){return this.source.getAddressSpace()}toWebGL(t,e){return`${this.source.toWebGL(t,e)}[${sa(this.index.toWebGL(t,e))}]`}toWebGL2(t,e){return`${this.source.toWebGL2(t,e)}[${sa(this.index.toWebGL2(t,e))}]`}toWGSL(t,e){return`${this.source.toWGSL(t,e)}[${sa(this.index.toWGSL(t,e))}]`}toString(t){return`${this.source.toString(t)}[${sa(this.index.toString(t))}]`}}class Aa extends ra{value;constructor(t){if(super(),t.getType().isVoidType())throw new Error("can not touch void type");t instanceof $a&&(t.isStatement=!1),this.value=t}toWebGL(t,e){return`${t}${this.value.toWebGL("",e)};\n`}toWebGL2(t,e){return`${t}${this.value.toWebGL2("",e)};\n`}toWGSL(t,e){return this.value.getType().isVoidType()?`${t}${this.value.toWGSL("",e)};\n`:`${t}_ = ${this.value.toWGSL("",e)};\n`}}class Ca extends aa{condition;first;second;type;constructor(t,e,i){super(),t instanceof $a&&(t.isStatement=!1),e instanceof $a&&(e.isStatement=!1),i instanceof $a&&(i.isStatement=!1),this.condition=t instanceof aa?t:new ga(t,Le);let s=null,r=null;if(e instanceof aa)s=e.getType(),this.first=e,e instanceof $a&&(e.isStatement=!1);else if("number"==typeof e)Number.isInteger(e)||(this.first=new ga(e,we),s=we);else{if("boolean"!=typeof e)throw new Error("select: invalid first value");this.first=new ga(e,Le),s=Le}if(i instanceof aa)r=i.getType(),this.second=i,i instanceof $a&&(i.isStatement=!1);else if("number"==typeof i)Number.isInteger(i)||(this.second=new ga(i,we),r=we);else{if("boolean"!=typeof i)throw new Error("select: invalid second value");this.second=new ga(i,Le),r=Le}if(!s&&!r)throw new Error("select: cannot determine the value types");if(s&&r){if(!s.isCompatibleType(r))throw new Error("select: first value and second value must be the same type");this.type=s}else if(s){if(s.typeId===we.typeId)this.second=new ga(i,we);else if(s.typeId===Be.typeId)this.second=new ga(i,Be);else{if(s.typeId!==Re.typeId)throw new Error("select: invalid type of the second value");this.second=new ga(i,Re)}this.type=s}else{if(r.typeId===we.typeId)this.first=new ga(e,we);else if(r.typeId===Be.typeId)this.first=new ga(e,Be);else{if(r.typeId!==Re.typeId)throw new Error("select: invalid type of the first value");this.first=new ga(e,Re)}this.type=r}}getType(){return this.type}isConstExp(){return!1}markWritable(){}isWritable(){return!1}getAddressSpace(){return null}toWebGL(t,e){return`${t}(${this.condition.toWebGL("",e)} ? ${this.first.toWebGL("",e)} : ${this.second.toWebGL("",e)})`}toWebGL2(t,e){return`${t}(${this.condition.toWebGL2("",e)} ? ${this.first.toWebGL2("",e)} : ${this.second.toWebGL2("",e)})`}toWGSL(t,e){return`${t}select(${this.second.toWGSL("",e)}, ${this.first.toWGSL("",e)}, ${this.condition.toWGSL("",e)})`}}class Ea extends ra{lvalue;rvalue;constructor(t,e){if(super(),!t.isReference())throw new Error("assignment: l-value required");if(this.lvalue=t,this.rvalue=e,this.lvalue instanceof fa)if(this.lvalue.getType().isPointerType())if(this.rvalue instanceof ua)this.lvalue.value.ref=this.rvalue.ref;else{if(!(this.rvalue instanceof va))throw new Nr(this.lvalue,"invalid pointer assignment");this.lvalue.value.ref=this.rvalue.value}else this.rvalue instanceof aa&&(this.lvalue.value.constExp=this.rvalue.isConstExp());else{if(this.lvalue.getType().isPointerType())throw new Nr(this.lvalue,"cannot assign to read-only variable");this.lvalue.markWritable()}this.rvalue instanceof $a&&(this.rvalue.isStatement=!1);const i=this.lvalue.getType(),s=i.isPointerType()?i.pointerType:i,r=this.checkScalarType(this.rvalue,s),a=r&&r.isPointerType()?r.pointerType:r;if(!s.isCompatibleType(a))throw new Er(this.rvalue instanceof aa?this.rvalue.toString(r.isPointerType()?"webgpu":"webgl"):`${this.rvalue}`,r,i)}getType(){return null}toWebGL(t,e){let i=null;const s=this.lvalue.getType(),r=this.checkScalarType(this.rvalue,s);if(!s.isCompatibleType(r))throw new Er(this.rvalue instanceof aa?this.rvalue.toString("webgl"):`${this.rvalue}`,r,s);return i="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?r.primitiveType===te.F32?ta(this.rvalue):String(this.rvalue):sa(this.rvalue.toWebGL(t,e)),this.lvalue instanceof fa&&(this.lvalue.value.constExp&&=!(this.rvalue instanceof aa)||this.rvalue.isConstExp()),`${t}${this.lvalue.toWebGL(t,e)} = ${i};\n`}toWebGL2(t,e){let i=null;const s=this.lvalue.getType(),r=this.checkScalarType(this.rvalue,s);if(!s.isCompatibleType(r))throw new Er(this.rvalue instanceof aa?this.rvalue.toString("webgl2"):`${this.rvalue}`,r,s);return i="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?r.primitiveType===te.F32?ta(this.rvalue):String(this.rvalue):sa(this.rvalue.toWebGL2(t,e)),this.lvalue instanceof fa&&(this.lvalue.value.constExp&&=!(this.rvalue instanceof aa)||this.rvalue.isConstExp()),`${t}${this.lvalue.toWebGL2(t,e)} = ${i};\n`}toWGSL(t,e){const i=this.lvalue.getType(),[s,r]=i.isPointerType()?[i.pointerType,!0]:[i,!1],a=this.checkScalarType(this.rvalue,s),n=a&&a.isPointerType(),o=n?a.pointerType:a;if(!s.isCompatibleType(o))throw new Er(this.rvalue instanceof aa?this.rvalue.toString("webgpu"):`${this.rvalue}`,a,i);if(this.lvalue instanceof da||this.lvalue instanceof fa){const t=s.isStructType()?s.structName:null;if(t&&e.types.findIndex(e=>e instanceof Va&&e.type.structName===t)<0)return""}let h;h="number"==typeof this.rvalue||"boolean"==typeof this.rvalue?a.primitiveType===te.F32?ta(this.rvalue):String(this.rvalue):sa(this.rvalue.toWGSL(t,e));const l=this.lvalue.toWGSL(t,e);if(r&&!n){if(this.lvalue instanceof fa)throw new Error(`rvalue must be pointer type: ${h}`);return`${t}*(${l}) = ${h};\n`}return n&&!r?`${t}${l} = *(${h});\n`:`${t}${l} = ${h};\n`}checkScalarType(t,e){if(t instanceof aa)return t.getType();const i="boolean"==typeof t,s="number"==typeof t&&Number.isInteger(t)&&t>=-2147483648&&t<=2147483647,r="number"==typeof t&&Number.isInteger(t)&&t>=0&&t<=4294967295,a="number"==typeof t;if(!e.isPrimitiveType())return i?Le:s?Be:r?Re:we;switch(e.primitiveType){case te.BOOL:return i?e:s?Be:r?Re:we;case te.F32:return a?e:Le;case te.I32:return s?e:i?Le:r?Re:we;case te.U32:return r?e:i?Le:s?Be:we;default:return null}}}class Ma extends ra{toWebGL(t,e){return`${t}discard;\n`}toWebGL2(t,e){return`${t}discard;\n`}toWGSL(t,e){return`${t}discard;\n`}}class Ba extends ra{toWebGL(t,e){return`${t}break;\n`}toWebGL2(t,e){return`${t}break;\n`}toWGSL(t,e){return`${t}break;\n`}}class Ia extends ra{toWebGL(t,e){return`${t}continue;\n`}toWebGL2(t,e){return`${t}continue;\n`}toWGSL(t,e){return`${t}continue;\n`}}class Pa extends ra{value;constructor(t){super(),this.value=t,this.value instanceof $a&&(this.value.isStatement=!1)}toWebGL(t,e){return this.value?`${t}return ${sa(this.value.toWebGL(t,e))};\n`:`${t}return;\n`}toWebGL2(t,e){return this.value?`${t}return ${sa(this.value.toWebGL2(t,e))};\n`:`${t}return;\n`}toWGSL(t,e){return this.value?`${t}return ${sa(this.value.toWGSL(t,e))};\n`:`${t}return;\n`}}class $a extends aa{name;args;retType;func;isStatement;constructor(t,e,i,s,r){if(super(),this.name=t,this.args=e,this.retType=i?.returnType??r??zs,this.func=i,this.isStatement=!0,i){if(i.funcType.argTypes.length!==this.args.length)throw new Lr("ASTCallFunction(): number of parameters mismatch");for(let r=0;r<this.args.length;r++){const a=i.funcType.argTypes[r];if(a.byRef){if("webgpu"===s){const i=e[r].getAddressSpace();if(i!==me.FUNCTION&&i!==me.PRIVATE)throw new Br(t,"pointer type of function parameter must be function or private");const s=a.type;if(!s.isPointerType())throw new Lr("ASTCallFunction(): invalid reference type");if(s.addressSpace===me.UNKNOWN)s.addressSpace=i;else if(s.addressSpace!==i)throw new Br(t,`invalid pointer parameter address space '${i}', should be '${s.addressSpace}`)}this.args[r].markWritable()}}}for(const t of this.args)t instanceof $a&&(t.isStatement=!1)}getType(){return this.retType}isConstExp(){return!1}markWritable(){}isWritable(){return!1}getAddressSpace(){return null}toWebGL(t,e){"dFdx"===this.name||"dFdy"===this.name||"fwidth"===this.name?e.extensions.add("GL_OES_standard_derivatives"):"texture2DLodEXT"!==this.name&&"texture2DProjLodEXT"!==this.name&&"textureCubeLodEXT"!==this.name&&"texture2DGradEXT"!==this.name&&"texture2DProjGradEXT"!==this.name&&"textureCubeGradEXT"!==this.name||e.extensions.add("GL_EXT_shader_texture_lod");const i=this.args.map(i=>sa(i.toWebGL(t,e)));return`${this.isStatement?t:""}${this.name}(${i.join(",")})${this.isStatement?";\n":""}`}toWebGL2(t,e){const i=this.args.map(i=>sa(i.toWebGL2(t,e)));return`${this.isStatement?t:""}${this.name}(${i.join(",")})${this.isStatement?";\n":""}`}toWGSL(t,e){let i=this.args;if(this.func){let t;const s=Oa(i,this.func.funcType);if(s&&(t=s.args),!t)throw new Error(`no matching overloading found for function '${this.name}'`);i=t.filter(t=>{const i=t.getType();return!(i.isStructType()&&e.types.findIndex(t=>t instanceof Va&&t.type.structName===i.structName)<0)})}const s=i.map(i=>sa(i.toWGSL(t,e)));return`${this.isStatement?t:""}${this.name}(${s.join(",")})${this.isStatement?";\n":""}`}toString(t){return`${this.name}(...)`}}class Ra extends ra{value;group;binding;blockName;constructor(t){super(),this.value=t,this.group=0,this.binding=0}isReference(){return!0}isPointer(){return this.value.getType().isPointerType()}toWebGL(t,e){let i="",s=!1,r=this.value.getType();switch(this.value.value.$declareType){case 1:e.type===Xt.Vertex?(i="attribute ",e.defines.push(`#define ${this.value.name} ${gr(e.vertexAttributes[this.value.value.$location])}\n`)):i="varying ";break;case 2:e.type===Xt.Vertex?i="varying ":(s=!0,e.mrt?(e.defines.push(`#define ${this.value.name} gl_FragData[${this.value.value.$location}]\n`),e.extensions.add("GL_EXT_draw_buffers")):e.defines.push(`#define ${this.value.name} gl_FragColor\n`));break;case 4:i="uniform ",r=e.typeReplacement?.get(this.value.value)||r;break;case 5:throw new Error(`invalid variable declare type: ${this.value.name}`)}if(!s)return`${t}${i}${r.toTypeName("webgl",this.value.name)};\n`}toWebGL2(t,e){let i="",s=this.value.getType();switch(this.value.value.$declareType){case 1:i=e.type===Xt.Fragment&&s.isPrimitiveType()&&s.isInteger()?"flat in ":"in ",e.type===Xt.Vertex&&e.defines.push(`#define ${this.value.name} ${gr(e.vertexAttributes[this.value.value.$location])}\n`);break;case 2:i=e.type===Xt.Vertex?s.isPrimitiveType()&&s.isInteger()?"flat out ":"out ":`layout(location = ${this.value.value.$location}) out `;break;case 4:return s.isStructType()?`${t}layout(std140) uniform ${this.blockName} { ${s.structName} ${this.value.name}; };\n`:(s=e.typeReplacement?.get(this.value.value)||s,`${t}uniform ${s.toTypeName("webgl2",this.value.name)};\n`);case 5:throw new Error(`invalid variable declare type: ${this.value.name}`)}return`${t}${i}${this.value.getType().toTypeName("webgl2",this.value.name)};\n`}toWGSL(t,e){let i;const s=this.value.getType().isPrimitiveType()||this.value.getType().isStructType()||this.value.getType().isArrayType();switch(this.value.value.$declareType){case 1:case 2:throw new Error("Internal error");case 4:i=`@group(${this.group}) @binding(${this.binding}) var${s?"<uniform>":""} `;break;case 5:i=`@group(${this.group}) @binding(${this.binding}) var<storage, ${this.value.value.$readonly?"read":"read_write"}> `;break;case 3:i="var<workgroup> ";break;default:i=`${this.value.getType().isPointerType()?"let":"var"}${this.value.value.$global&&!this.value.getType().isPointerType()?"<private>":""} `}{const s=this.value.getType(),r=s.isStructType()?s.structName:null;return r&&e.types.findIndex(t=>t instanceof Va&&t.type.structName===r)<0?"":`${t}${i}${s.toTypeName("webgpu",this.value.name)};\n`}}toString(t){return this.value.toString(t)}}class Fa extends oa{name;args;isBuiltin;isMainFunc;funcType;builtins;returnType;constructor(t,e,i,s,r=!1){super(),this.name=t,this.args=e,this.funcType=s,this.builtins=[],this.isBuiltin=r,this.isMainFunc=i,this.returnType=s?s.returnType:null}toWebGL(t,e){if(this.isBuiltin)return"";{let i="";const s=[];for(const t of this.args){let e,i,r;t.paramAST instanceof ua?(e=t.paramAST.value,i=t.paramAST.name,r=""):(e=t.paramAST.value.value,i=t.paramAST.value.name,r=`${e.$inout} `),s.push(`${r}${t.getType().toTypeName("webgl",i)}`)}return i+=`${t}${this.returnType.toTypeName("webgl")} ${this.name}(${s.join(",")}) {\n`,i+=super.toWebGL(t+"  ",e),i+=`${t}}\n`,i}}toWebGL2(t,e){if(this.isBuiltin)return"";{let i="";const s=[];for(const t of this.args){let e,i,r;t.paramAST instanceof ua?(e=t.paramAST.value,i=t.paramAST.name,r=""):(e=t.paramAST.value.value,i=t.paramAST.value.name,r=`${e.$inout} `),s.push(`${r}${t.getType().toTypeName("webgl2",i)}`)}return i+=`${t}${this.returnType.toTypeName("webgl2")} ${this.name}(${s.join(",")}) {\n`,i+=super.toWebGL2(t+"  ",e),i+=`${t}}\n`,i}}toWGSL(t,e){if(this.isBuiltin)return"";{let i="";const s=[...this.builtins];for(const t of this.args){const i=t.paramAST instanceof ua?t.paramAST.name:t.paramAST.value.name,r=t.paramAST instanceof ua?t.paramAST.getType():t.paramAST.value.getType(),a=r.isPointerType()?r.pointerType:r;a.isStructType()&&e.types.findIndex(t=>t instanceof Va&&t.type.structName===a.structName)<0||s.push(`${r.toTypeName("webgpu",i)}`)}let r="";if(this.isMainFunc)switch(e.type){case Xt.Vertex:r="@vertex ";break;case Xt.Fragment:r="@fragment ";break;case Xt.Compute:r=`@compute @workgroup_size(${e.workgroupSize[0]}, ${e.workgroupSize[1]}, ${e.workgroupSize[2]}) `}const a=this.returnType.isVoidType()?null:this.returnType.toTypeName("webgpu"),n=a?` -> ${a}`:"";return i+=`${t}${r}fn ${this.name}(${s.join(",")})${n} {\n`,i+=super.toWGSL(t+"  ",e),i+=`${t}}\n`,i}}}class Da extends oa{keyword;condition;nextElse;constructor(t,e){super(),this.keyword=t,this.condition=e,this.nextElse=null,this.condition instanceof $a&&(this.condition.isStatement=!1)}toWebGL(t,e){let i=`${t}${this.keyword} ${this.condition?"("+sa(this.condition.toWebGL(t,e))+")":""} {\n`;return i+=super.toWebGL(t+"  ",e),i+=`${t}}\n`,this.nextElse&&(i+=this.nextElse.toWebGL(t,e)),i}toWebGL2(t,e){let i=`${t}${this.keyword} ${this.condition?"("+sa(this.condition.toWebGL2(t,e))+")":""} {\n`;return i+=super.toWebGL2(t+"  ",e),i+=`${t}}\n`,this.nextElse&&(i+=this.nextElse.toWebGL2(t,e)),i}toWGSL(t,e){let i=`${t}${this.keyword} ${this.condition?"("+sa(this.condition.toWGSL(t,e))+")":""} {\n`;return i+=super.toWGSL(t+"  ",e),i+=`${t}}\n`,this.nextElse&&(i+=this.nextElse.toWGSL(t,e)),i}}class Na extends oa{init;start;end;open;reverse;constructor(t,e,i,s,r){super(),this.init=t,this.start=e,this.end=i,this.open=s,this.reverse=r,this.statements=[],this.start instanceof $a&&(this.start.isStatement=!1),this.end instanceof $a&&(this.end.isStatement=!1)}toWebGL(t,e){const i=this.init.getType().toTypeName("webgl",this.init.name),s=sa(this.start.toWebGL(t,e)),r=sa(this.end.toWebGL(t,e)),a=this.open?this.reverse?">":"<":this.reverse?">=":"<=";let n=`${t}for (${i} = ${s}; ${this.init.name} ${a} ${r}; ${this.init.name}${this.reverse?"--":"++"}) {\n`;return n+=super.toWebGL(t+"  ",e),n+=`${t}}\n`,n}toWebGL2(t,e){const i=this.init.getType().toTypeName("webgl2",this.init.name),s=sa(this.start.toWebGL2(t,e)),r=sa(this.end.toWebGL2(t,e)),a=this.open?this.reverse?">":"<":this.reverse?">=":"<=";let n=`${t}for (${i} = ${s}; ${this.init.name} ${a} ${r}; ${this.init.name}${this.reverse?"--":"++"}) {\n`;return n+=super.toWebGL2(t+"  ",e),n+=`${t}}\n`,n}toWGSL(t,e){const i=`var ${this.init.getType().toTypeName("webgpu",this.init.name)}`,s=sa(this.start.toWGSL(t,e)),r=sa(this.end.toWGSL(t,e)),a=new ga(1,this.init.getType()).toWGSL(t,e),n=this.open?this.reverse?"> ":"<":this.reverse?">=":"<=";let o=`${t}for (${i} = ${s}; ${this.init.name} ${n} ${r}; ${this.init.name} = ${this.init.name} ${this.reverse?"-":"+"} ${a}) {\n`;return o+=super.toWGSL(t+"  ",e),o+=`${t}}\n`,o}}class La extends oa{condition;constructor(t){super(),this.condition=t,this.condition instanceof $a&&(this.condition.isStatement=!1)}toWebGL(t,e){throw new Error("No do-while() loop support for WebGL1.0 device")}toWebGL2(t,e){let i=`${t}do {\n`;return i+=super.toWebGL2(t+" ",e),i+=`${t}} while(${sa(this.condition.toWebGL2(t,e))});\n`,i}toWGSL(t,e){let i=`${t}loop {\n`;return i+=super.toWGSL(t+" ",e),i+=`${t}  if (!(${sa(this.condition.toWGSL(t,e))})) { break; }\n`,i+=`${t}}\n`,i}}class za extends oa{condition;constructor(t){super(),this.condition=t,this.condition instanceof $a&&(this.condition.isStatement=!1)}toWebGL(t,e){let i=`${t}for(int z_tmp_counter = 0; z_tmp_counter == 0; z_tmp_counter += 0) {\n`;const s=t+"  ";return i+=`${s}if(!(${sa(this.condition.toWebGL(t,e))})){ break; }\n`,i+=super.toWebGL(s,e),i+=`${t}}\n`,i}toWebGL2(t,e){let i=`${t}while(${sa(this.condition.toWebGL2(t,e))}) {\n`;return i+=super.toWebGL2(t+"  ",e),i+=`${t}}\n`,i}toWGSL(t,e){let i=`${t}for(;${sa(this.condition.toWGSL(t,e))};) {\n`;return i+=super.toWGSL(t+"  ",e),i+=`${t}}\n`,i}}class Va extends ra{type;prefix;builtin;constructor(t,e){super(),this.prefix=null,this.builtin=e,this.type=t}getType(){return this.type}toWebGL(t,e){if(this.builtin)return"";{let e=`${t}struct ${this.type.structName} {\n`;for(const i of this.type.structMembers)e+=`${t}  ${i.type.toTypeName("webgl",i.name)};\n`;return e+=`${t}};\n`,e}}toWebGL2(t,e){if(this.builtin)return"";{let e=`${t}struct ${this.type.structName} {\n`;for(const i of this.type.structMembers)e+=`${t}  ${i.type.toTypeName("webgl2",i.name)};\n`;return e+=`${t}};\n`,e}}toWGSL(t,e){if(this.builtin)return"";{let e=`${t}struct ${this.type.structName} {\n`;return e+=this.type.structMembers.map((e,i)=>{const s=this.prefix?this.prefix[i]:"",r=e.type.getLayoutSize(this.type.layout)!==e.type.getLayoutSize("default")?`@size(${e.type.getLayoutSize(this.type.layout)}) `:"",a=i>0&&e.type.getLayoutAlignment(this.type.layout)!==e.type.getLayoutAlignment("default")?`@align(${e.type.getLayoutAlignment(this.type.layout)}) `:"";return`${t}  ${s}${a}${r}${e.type.toTypeName("webgpu",e.name)}`}).join(",\n"),e+=`\n${t}};\n`,e}}}function Oa(t,e){if(t.length!==e.argTypes.length)return null;const i=[];for(let s=0;s<t.length;s++){const r=!!e.argTypes[s].byRef,a=r?e.argTypes[s].type.pointerType:e.argTypes[s].type,n=t[s];if("number"==typeof n){if(r||!a.isPrimitiveType()||!a.isScalarType()||a.primitiveType===te.BOOL)return null;i.push(new ga(n,a))}else if("boolean"==typeof n){if(r||!a.isPrimitiveType()||a.primitiveType!==te.BOOL)return null;i.push(new ga(n,a))}else{if(!a.isCompatibleType(n.getType()))return null;r?(n.markWritable(),i.push(new va(n))):i.push(n)}}return{name:e.name,args:i}}const ka=new Map;function Ua(t,e){return new Proxy(t,{get:function(i,s){if("symbol"==typeof s||s in i)return i[s];let r=ka.get(t);r||(r={},ka.set(t,r));let a=r[s];if(!a&&(e.isPrimitiveType()||e.isStructType()||e.isArrayType()||e.isAtomicI32()||e.isAtomicU32()))if("ptr"===s){const t=new be(e,me.FUNCTION);a=function(...e){if(1===e.length&&"string"==typeof e[0])return new Wa(e[0],t);throw new Error("Invalid pointer type constructor")}}else{const t=Number(s);if(Number.isInteger(t)&&t>=0){const i=new xe(e,t);a=Ua(function(...t){if(1===t.length&&"string"==typeof t[0])return new Wa(t[0],i);{const e=new Wa("",i);return e.$ast=new _a(e.$typeinfo,t.map(t=>t instanceof Wa?t.$ast:t)),e}},i)}}return a&&(r[s]=a),a}})}class Ga{proxy;constructor(){return this.proxy=new Proxy(this,{get:function(t,e){return"string"==typeof e?t.$get(e):void 0},set:function(t,e,i){return"string"==typeof e&&t.$set(e,i)}}),this.proxy}get $thisProxy(){return this.proxy}}let Ha=0;class Wa extends Ga{$uid;$str;$location;$typeinfo;$global;$sampleType;$precision;$ast;$inout;$memberCache;$attrib;$tags;$_group;$declareType;$isBuffer;$readonly;$bindingSize;constructor(t,e){if(super(),!t&&e.isPointerType())throw new Error("no default constructor for pointer type");if(this.$uid=Ha++,this.$str=t||"",this.$location=0,this.$global=!1,this.$typeinfo=e,this.$qualifier=null,this.$precision=jr.NONE,this.$ast=new ua(this),this.$inout=null,this.$memberCache={},this.$attrib=null,this.$tags=[],this.$_group=null,this.$declareType=Xr.DECLARE_TYPE_NONE,this.$isBuffer=!1,this.$bindingSize=0,this.$readonly=!1,e.isTextureType())if(e.isDepthTexture())this.$sampleType="depth";else{const t=function(t){switch(t.textureType){case he.TEX_1D:case he.TEX_STORAGE_1D:case he.TEX_2D:case he.TEX_STORAGE_2D:case he.TEX_2D_ARRAY:case he.TEX_STORAGE_2D_ARRAY:case he.TEX_3D:case he.TEX_STORAGE_3D:case he.TEX_CUBE:case he.TEX_EXTERNAL:return new _e(te.F32VEC4);case he.TEX_DEPTH_2D_ARRAY:case he.TEX_DEPTH_2D:case he.TEX_DEPTH_CUBE:return new _e(te.F32);case he.ITEX_2D_ARRAY:case he.ITEX_1D:case he.ITEX_2D:case he.ITEX_3D:case he.ITEX_CUBE:return new _e(te.I32);case he.UTEX_2D_ARRAY:case he.UTEX_1D:case he.UTEX_2D:case he.UTEX_3D:case he.UTEX_CUBE:return new _e(te.U32);default:return null}}(e);t.primitiveType===te.I32?this.$sampleType="sint":t.primitiveType===te.U32?this.$sampleType="uint":this.$sampleType="float"}}get $group(){return this.$_group}set $group(t){this.$_group=t}uniform(t){return this.$declareType=Xr.DECLARE_TYPE_UNIFORM,this.$group=t,this.$isBuffer=!1,this}uniformBuffer(t,e=0){if(!this.$typeinfo.isPrimitiveType()&&!this.$typeinfo.isArrayType()&&!this.$typeinfo.isStructType())throw new Nr(this.$ast,"only primitive type, array type or structure type can be set as uniform buffer");return this.$declareType=Xr.DECLARE_TYPE_UNIFORM,this.$group=t,this.$isBuffer=!0,this.$bindingSize=e,this}workgroup(){return this.$declareType=Xr.DECLARE_TYPE_WORKGROUP,this}storage(t){if(!this.$typeinfo.isHostSharable()){if(this.$typeinfo.isTextureType()){if(!this.$typeinfo.isStorageTexture())throw new Nr(this.$ast,"type cannot be declared as storage texture");return this.uniform(t)}throw new Nr(this.$ast,"type cannot be declared in storage address space")}return this.$declareType=Xr.DECLARE_TYPE_STORAGE,this.$group=t,this.$isBuffer=!1,this.$readonly=!1,this}storageReadonly(t){return this.storage(t),this.$readonly=!0,this}storageBuffer(t,e=0){if(!(this.$typeinfo.isPrimitiveType()||this.$typeinfo.isArrayType()||this.$typeinfo.isStructType()||this.$typeinfo.isAtomicI32()||this.$typeinfo.isAtomicU32()))throw new Nr(this.$ast,"only primitive type, array type or structure type can be set as storage buffer");return this.$declareType=Xr.DECLARE_TYPE_STORAGE,this.$group=t,this.$isBuffer=!0,this.$bindingSize=e,this.$readonly=!1,this}storageBufferReadonly(t,e=0){return this.storageBuffer(t,e),this.$readonly=!0,this}inout(){return this.$inout="inout",this}out(){return this.$inout="out",this}attrib(t){return this.$declareType=Xr.DECLARE_TYPE_IN,this.$attrib=t,this}tag(...t){return t.forEach(t=>{this.$tags.indexOf(t)<0&&this.$tags.push(t)}),this}sampleType(t){return t&&(this.$sampleType=t),this}at(t){const e=this.$ast.getType();if(!(e.isArrayType()||e.isPrimitiveType()&&(e.isVectorType()||e.isMatrixType())))throw new Error("at() function must be used with array types");let i,s=null;e.isArrayType()?(s=e.elementType,i=e.dimension):e.isVectorType()?(s=_e.getCachedTypeInfo(e.resizeType(1,1)),i=e.cols):e.isMatrixType()&&(s=_e.getCachedTypeInfo(e.resizeType(1,e.cols)),i=e.rows);const r=new Wa("",s);if("number"==typeof t){if(!Number.isInteger(t))throw new Error("at() array index must be integer type");if(t<0||i>0&&t>=i)throw new Error("at() array index out of bounds");r.$ast=new Sa(this.$ast,new ga(t,Be),s)}else{const e=t.$ast.getType();if(!e.isPrimitiveType()||!e.isScalarType())throw new Error("at() array index must be scalar type");let i=t.$ast;e.scalarType!==te.I32&&e.scalarType!==te.U32&&(i=new ba(i,Be)),r.$ast=new Sa(this.$ast,i,s)}return r}setAt(t,e){const i=this.$ast.getType();if(!(i.isArrayType()||i.isPrimitiveType()&&i.isVectorType()))throw new Error("setAt() function must be used with array types");if("number"==typeof t){if(!Number.isInteger(t))throw new Error("setAt() array index must be integer type");const e=i.isArrayType()?i.dimension:i.cols;if(t<0||e>0&&t>=e)throw new Error("setAt() array index out of bounds")}Or().getCurrentScope().$ast.statements.push(new Ea(new ma(new da(this.$ast),"number"==typeof t?new ga(t,Be):t.$ast,i.isArrayType()?i.elementType:new _e(i.scalarType)),e instanceof Wa?e.$ast:e))}highp(){return this.$precision=jr.HIGH,this}mediump(){return this.$precision=jr.MEDIUM,this}lowp(){return this.$precision=jr.LOW,this}isConstructor(){return this.$ast instanceof _a&&0===this.$ast.args.length}isVector(){const t=this.$ast.getType();return t.isPrimitiveType()&&t.isVectorType()}numComponents(){const t=this.$ast.getType();return t.isPrimitiveType()?t.cols:0}getTypeName(){return this.$ast.getType().toTypeName(Or().getDevice().type)}$get(t){if("string"==typeof t){if("$"===t[0]||t in this)return this[t];{let e=this.$memberCache[t];if(!e){const i=this.$ast?.getType()||this.$typeinfo,s=Number(t);if(Number.isNaN(s))if(i.isStructType()){const s=i.structMembers.findIndex(e=>e.name===t);if(s<0)return;const r=i.structMembers[s];if(r.type.isStructType()){e=Or().structInfo.structs[r.type.structName].call(Or(),`${this.$str}.${t}`)}else e=new Wa(`${this.$str}.${t}`,r.type);e.$ast=new xa(this.$ast,t,r.type)}else{if(!i.isPrimitiveType()||!i.isVectorType()&&!i.isScalarType())throw new Error(`invalid index operation: ${this.$ast.toString(Or().getDevice().type)}[${t}]`);if(0===t.length||t.length>4||[...t].some(t=>"xyzw".slice(0,i.cols).indexOf(t)<0)&&[...t].some(t=>"rgba".slice(0,i.cols).indexOf(t)<0))throw new Error(`unknown swizzle target: ${this.$ast.toString(Or().getDevice().type)}[${t}]`);const s=_e.getCachedTypeInfo(i.resizeType(1,t.length));e=new Wa("",s),1===i.cols?e.$ast=new _a(s,[this.$ast]):e.$ast=new xa(this.$ast,t,s)}else if(i.isArrayType())e=this.at(s);else if(i.isPrimitiveType()&&i.isVectorType()){if(s>=i.cols)throw new Error(`component index out of bounds: ${this.$str}[${s}]`);e=this.$get("xyzw"[s])}else{if(!i.isPrimitiveType()||!i.isMatrixType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);{const t=_e.getCachedTypeInfo(i.resizeType(1,i.cols));e=new Wa("",t),e.$ast=new Sa(this.$ast,new ga(s,Be),t)}}this.$memberCache[t]=e}return e}}}$set(t,e){if("string"==typeof t){if("$"===t[0]||t in this)this[t]=e;else{if("number"!=typeof e&&"boolean"!=typeof e&&!(e instanceof Wa))throw new Error("Invalid output value assignment");const i=this.$ast?.getType()||this.$typeinfo,s=Number(t);if(Number.isNaN(s))if(i.isStructType()){const s=i.structMembers.findIndex(e=>e.name===t);if(s<0)throw new Error(`unknown struct member '${t}`);const r=i.structMembers[s];let a;if("number"==typeof e||"boolean"==typeof e){if(!r.type.isPrimitiveType()||!r.type.isScalarType())throw new Error(`can not set struct member '${t}: invalid value type`);a=new ga(e,r.type)}else e instanceof Wa&&(a=e.$ast);if(!a)throw new Error(`can not set struct member '${t}: invalid value type`);Or().getCurrentScope().$ast.statements.push(new Ea(new pa(new da(this.$ast),t,r.type),a))}else{if(t.length>1||"xyzw".indexOf(t)<0&&"rgba".indexOf(t)<0)throw new Error(`invalid index operation: ${this.$str}[${s}]`);if(!i.isPrimitiveType()||!i.isVectorType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);const r=_e.getCachedTypeInfo(i.scalarType);Or().getCurrentScope().$ast.statements.push(new Ea(new pa(new da(this.$ast),t,r),e instanceof Wa?e.$ast:e))}else if(i.isArrayType())this.setAt(s,e);else if(i.isPrimitiveType()&&i.isVectorType()){if(s>=i.cols)throw new Error(`component index out of bounds: ${this.$str}[${s}]`);this.$set("xyzw"[s],e)}else{if(!i.isPrimitiveType()||!i.isMatrixType())throw new Error(`invalid index operation: ${this.$str}[${s}]`);{if(!(e instanceof Wa))throw new Error(`invalid matrix column vector assignment: ${this.$str}[${s}]`);const t=_e.getCachedTypeInfo(i.resizeType(1,i.cols));Or().getCurrentScope().$ast.statements.push(new Ea(new ma(new da(this.$ast),new ga(s,Be),t),e.$ast))}}}return!0}return!1}}const Xa=[[we,Se,Ae,Ce],[Be,Ie,Pe,$e],[Re,Fe,De,Ne],[Le,ze,Ve,Oe]],ja=[ke,Ue,Ge,He,We,Xe,je,Qe,qe];function Qa(t,e,...i){const s="webgl"===t.getDevice().type?en:"webgl2"===t.getDevice().type?sn:rn,r=on?.[e].overloads.filter(t=>!!(t[1]&s)).map(t=>t[0]);if(!r||0===r.length)throw new Fr(`builtin shader function '${e}'`);const a=i.map(e=>t.normalizeExpValue(e)),n=t._matchFunctionOverloading(r,a);if(!n)throw new Pr(e);return n}function qa(t,e){return t.$callFunction(e[0].name,e[1],e[0])}function Ya(t,e,...i){return qa(t,Qa(t,e,...i))}function Za(t,e,i,s){const r=[];for(let i=0;i<ja.length;i++){const a=ja[i],n=s.map(t=>({type:t||ja[i]}));r.push([new Fa(t,null,!1,new Te(t,a,n),!0),e])}return r}function Ka(t,e,i,s,r){if(s.findIndex(t=>"number"==typeof t)<0)return[[new Fa(t,null,!1,new Te(t,i,s.map(t=>({type:t}))),!0),e]];{const a=[];let n=r?1:0;for(;n<4;n++){const r="number"==typeof i?Xa[i][n]:i,o=s.map(t=>"number"==typeof t?{type:Xa[t][n]}:{type:t});a.push([new Fa(t,null,!1,new Te(t,r,o),!0),e])}return a}}function Ja(t,e,i){const s=new Wa("",i);return s.$ast=new Ta(t,e,i),s}function tn(t,e,i,s){const r=new Wa("",s);return r.$ast=new wa(t,e,i,s),r}const en=1,sn=2,rn=4,an=en|sn,nn=an|rn,on={add_2:{overloads:[...Ka("",nn,0,[0,0]),...Ka("",nn,1,[1,1]),...Ka("",nn,2,[2,2]),...Ka("",nn,3,[3,3]),...Ka("",nn,Se,[we,Se]),...Ka("",nn,Se,[Se,we]),...Ka("",nn,Ae,[we,Ae]),...Ka("",nn,Ae,[Ae,we]),...Ka("",nn,Ce,[we,Ce]),...Ka("",nn,Ce,[Ce,we]),...Ka("",nn,Ie,[Be,Ie]),...Ka("",nn,Ie,[Ie,Be]),...Ka("",nn,Pe,[Be,Pe]),...Ka("",nn,Pe,[Pe,Be]),...Ka("",nn,$e,[Be,$e]),...Ka("",nn,$e,[$e,Be]),...Ka("",nn,Fe,[Re,Fe]),...Ka("",nn,Fe,[Fe,Re]),...Ka("",nn,De,[Re,De]),...Ka("",nn,De,[De,Re]),...Ka("",nn,Ne,[Re,Ne]),...Ka("",nn,Ne,[Ne,Re]),...Za("",nn,0,[null,null])],normalizeFunc(t,e,...i){if(2===i.length&&"number"==typeof i[0]&&"number"==typeof i[1])return i[0]+i[1];const s=Qa(t,e,...i);return tn(s[1][0],s[1][1],"+",s[0].returnType)}},add:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Mr("add");let s=i[0];for(let e=1;e<i.length;e++)s=t.add_2(s,i[e]);return s}},sub:{overloads:[...Ka("",nn,0,[0,0]),...Ka("",nn,1,[1,1]),...Ka("",nn,2,[2,2]),...Ka("",nn,3,[3,3]),...Ka("",nn,Se,[we,Se]),...Ka("",nn,Se,[Se,we]),...Ka("",nn,Ae,[we,Ae]),...Ka("",nn,Ae,[Ae,we]),...Ka("",nn,Ce,[we,Ce]),...Ka("",nn,Ce,[Ce,we]),...Ka("",nn,Ie,[Be,Ie]),...Ka("",nn,Ie,[Ie,Be]),...Ka("",nn,Pe,[Be,Pe]),...Ka("",nn,Pe,[Pe,Be]),...Ka("",nn,$e,[Be,$e]),...Ka("",nn,$e,[$e,Be]),...Ka("",nn,Fe,[Re,Fe]),...Ka("",nn,Fe,[Fe,Re]),...Ka("",nn,De,[Re,De]),...Ka("",nn,De,[De,Re]),...Ka("",nn,Ne,[Re,Ne]),...Ka("",nn,Ne,[Ne,Re]),...Za("",nn,0,[null,null])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return tn(s[1][0],s[1][1],"-",s[0].returnType)}},div:{overloads:[...Ka("",nn,0,[0,0]),...Ka("",nn,1,[1,1]),...Ka("",nn,2,[2,2]),...Ka("",nn,3,[3,3]),...Ka("",nn,Se,[we,Se]),...Ka("",nn,Se,[Se,we]),...Ka("",nn,Ae,[we,Ae]),...Ka("",nn,Ae,[Ae,we]),...Ka("",nn,Ce,[we,Ce]),...Ka("",nn,Ce,[Ce,we]),...Ka("",nn,Ie,[Be,Ie]),...Ka("",nn,Ie,[Ie,Be]),...Ka("",nn,Pe,[Be,Pe]),...Ka("",nn,Pe,[Pe,Be]),...Ka("",nn,$e,[Be,$e]),...Ka("",nn,$e,[$e,Be]),...Ka("",nn,Fe,[Re,Fe]),...Ka("",nn,Fe,[Fe,Re]),...Ka("",nn,De,[Re,De]),...Ka("",nn,De,[De,Re]),...Ka("",nn,Ne,[Re,Ne]),...Ka("",nn,Ne,[Ne,Re])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return tn(s[1][0],s[1][1],"/",s[0].returnType)}},mul_2:{overloads:[...Ka("",nn,0,[0,0]),...Ka("",nn,1,[1,1]),...Ka("",nn,2,[2,2]),...Ka("",nn,3,[3,3]),...Ka("",nn,Se,[we,Se]),...Ka("",nn,Se,[Se,we]),...Ka("",nn,Ae,[we,Ae]),...Ka("",nn,Ae,[Ae,we]),...Ka("",nn,Ce,[we,Ce]),...Ka("",nn,Ce,[Ce,we]),...Ka("",nn,Ie,[Be,Ie]),...Ka("",nn,Ie,[Ie,Be]),...Ka("",nn,Pe,[Be,Pe]),...Ka("",nn,Pe,[Pe,Be]),...Ka("",nn,$e,[Be,$e]),...Ka("",nn,$e,[$e,Be]),...Ka("",nn,Fe,[Re,Fe]),...Ka("",nn,Fe,[Fe,Re]),...Ka("",nn,De,[Re,De]),...Ka("",nn,De,[De,Re]),...Ka("",nn,Ne,[Re,Ne]),...Ka("",nn,Ne,[Ne,Re]),...Za("",nn,0,[we,null]),...Za("",nn,0,[null,we]),...Ka("",nn,ke,[ke,ke]),...Ka("",nn,He,[ke,He]),...Ka("",nn,je,[ke,je]),...Ka("",nn,Se,[ke,Se]),...Ka("",nn,Se,[Se,ke]),...Ka("",nn,Ue,[Ue,ke]),...Ka("",nn,We,[Ue,He]),...Ka("",nn,Qe,[Ue,je]),...Ka("",nn,Ae,[Ue,Se]),...Ka("",nn,Se,[Ae,Ue]),...Ka("",nn,Ge,[Ge,ke]),...Ka("",nn,Xe,[Ge,He]),...Ka("",nn,qe,[Ge,je]),...Ka("",nn,Ce,[Ge,Se]),...Ka("",nn,Se,[Ce,Ge]),...Ka("",nn,ke,[He,Ue]),...Ka("",nn,He,[He,We]),...Ka("",nn,je,[He,Qe]),...Ka("",nn,Se,[He,Ae]),...Ka("",nn,Ae,[Se,He]),...Ka("",nn,Ue,[We,Ue]),...Ka("",nn,We,[We,We]),...Ka("",nn,Qe,[We,Qe]),...Ka("",nn,Ae,[We,Ae]),...Ka("",nn,Ae,[Ae,We]),...Ka("",nn,Ge,[Xe,Ue]),...Ka("",nn,Xe,[Xe,We]),...Ka("",nn,qe,[Xe,Qe]),...Ka("",nn,Ce,[Xe,Ae]),...Ka("",nn,Ae,[Ce,Xe]),...Ka("",nn,ke,[je,Ge]),...Ka("",nn,He,[je,Xe]),...Ka("",nn,je,[je,qe]),...Ka("",nn,Se,[je,Ce]),...Ka("",nn,Ce,[Se,je]),...Ka("",nn,Ue,[Qe,Ge]),...Ka("",nn,We,[Qe,Xe]),...Ka("",nn,Qe,[Qe,qe]),...Ka("",nn,Ae,[Qe,Ce]),...Ka("",nn,Ce,[Ae,Qe]),...Ka("",nn,Ge,[qe,Ge]),...Ka("",nn,Xe,[qe,Xe]),...Ka("",nn,qe,[qe,qe]),...Ka("",nn,Ce,[qe,Ce]),...Ka("",nn,Ce,[Ce,qe])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return tn(s[1][0],s[1][1],"*",s[0].returnType)}},mul:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Mr("mul");let s=i[0];for(let e=1;e<i.length;e++)s=t.mul_2(s,i[e]);return s}},mod:{overloads:[...Ka("mod",nn,0,[0,0]),...Ka("mod",nn,1,[1,1]),...Ka("mod",nn,2,[2,2]),...Ka("mod",nn,3,[3,3])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i),r=s[1][0].getType(),a=r.isPrimitiveType()&&(r.scalarType===te.I32||r.scalarType===te.U32);if("webgl"===t.getDevice().type&&a)throw new Fr("integer modulus");return"webgpu"===t.getDevice().type||a?tn(s[1][0],s[1][1],"%",s[0].returnType):qa(t,s)}},radians:{overloads:Ka("radians",nn,0,[0])},degrees:{overloads:Ka("degrees",nn,0,[0])},sin:{overloads:Ka("sin",nn,0,[0])},cos:{overloads:Ka("cos",nn,0,[0])},tan:{overloads:Ka("tan",nn,0,[0])},asin:{overloads:Ka("asin",nn,0,[0])},acos:{overloads:Ka("acos",nn,0,[0])},atan:{overloads:Ka("atan",nn,0,[0])},atan2:{overloads:[...Ka("atan",an,0,[0,0]),...Ka("atan2",rn,0,[0,0])]},sinh:{overloads:Ka("sinh",sn|rn,0,[0])},cosh:{overloads:Ka("cosh",sn|rn,0,[0])},tanh:{overloads:Ka("tanh",sn|rn,0,[0])},asinh:{overloads:Ka("asinh",sn,0,[0])},acosh:{overloads:Ka("acosh",sn,0,[0])},atanh:{overloads:Ka("atanh",sn,0,[0])},pow:{overloads:Ka("pow",nn,0,[0,0])},exp:{overloads:Ka("exp",nn,0,[0])},exp2:{overloads:Ka("exp2",nn,0,[0])},log:{overloads:Ka("log",nn,0,[0])},log2:{overloads:Ka("log2",nn,0,[0])},sqrt:{overloads:Ka("sqrt",nn,0,[0])},inverseSqrt:{overloads:[...Ka("inversesqrt",an,0,[0]),...Ka("inverseSqrt",rn,0,[0])]},abs:{overloads:[...Ka("abs",nn,0,[0]),...Ka("abs",sn|rn,1,[1]),...Ka("abs",rn,2,[2])]},sign:{overloads:[...Ka("sign",nn,0,[0]),...Ka("sign",sn,1,[1])]},floor:{overloads:Ka("floor",nn,0,[0])},ceil:{overloads:Ka("ceil",nn,0,[0])},fract:{overloads:Ka("fract",nn,0,[0])},fma:{overloads:Ka("fma",nn,0,[0,0,0]),normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return"webgpu"===t.getDevice().type?qa(t,s):t.add(t.mul(i[0],i[1]),i[2])}},round:{overloads:Ka("round",rn,0,[0])},trunc:{overloads:Ka("trunc",rn,0,[0])},min:{overloads:[...Ka("min",nn,0,[0,0]),...Ka("min",sn|rn,1,[1,1]),...Ka("min",sn|rn,2,[2,2])]},max:{overloads:[...Ka("max",nn,0,[0,0]),...Ka("max",sn|rn,1,[1,1]),...Ka("max",sn|rn,2,[2,2])]},clamp:{overloads:[...Ka("clamp",nn,0,[0,0,0]),...Ka("clamp",sn|rn,1,[1,1,1]),...Ka("clamp",sn|rn,2,[2,2,2])]},saturate:{overloads:[],normalizeFunc(t,e,...i){if(1!==i.length)throw new Mr("saturate");if(!(i[0]instanceof Wa))throw new Ir("saturate","x");const s=i[0].$ast.getType();if(!s.isPrimitiveType()||!s.isScalarType()&&!s.isVectorType())throw new Br("saturate","x");const r=s.isScalarType()?0:t[`vec${s.cols}`](0),a=s.isScalarType()?1:t[`vec${s.cols}`](1);return t.clamp(i[0],r,a)}},mix:{overloads:[...Ka("mix",nn,0,[0,0,0]),...Ka("mix",nn,0,[0,0,we])]},step:{overloads:Ka("step",nn,0,[0,0])},smoothStep:{overloads:Ka("smoothstep",nn,0,[0,0,0])},isnan:{overloads:Ka("isnan",sn,3,[0])},isinf:{overloads:Ka("isinf",sn,3,[0])},length:{overloads:Ka("length",nn,we,[0])},distance:{overloads:Ka("distance",nn,we,[0,0])},dot:{overloads:[...Ka("dot",nn,we,[0,0],!0),...Ka("dot",rn,Be,[1,1],!0),...Ka("dot",rn,Re,[2,2],!0)]},cross:{overloads:Ka("cross",nn,Ae,[Ae,Ae])},normalize:{overloads:Ka("normalize",nn,0,[0],!0)},faceForward:{overloads:[...Ka("faceforward",an,0,[0,0,0],!0),...Ka("faceForward",rn,0,[0,0,0],!0)]},reflect:{overloads:Ka("reflect",nn,0,[0,0],!0)},refract:{overloads:Ka("refract",nn,0,[0,0,we],!0)},frexp:{overloads:[...Ka("frexp",rn,Vs,[we]),...Ka("frexp",rn,Os,[Se]),...Ka("frexp",rn,ks,[Ae]),...Ka("frexp",rn,Us,[Ce])]},outerProduct:{overloads:[...Ka("outerProduct",sn,ke,[Se,Se]),...Ka("outerProduct",sn,We,[Ae,Ae]),...Ka("outerProduct",sn,qe,[Ce,Ce]),...Ka("outerProduct",sn,Ue,[Ae,Se]),...Ka("outerProduct",sn,He,[Se,Ae]),...Ka("outerProduct",sn,Ge,[Ce,Se]),...Ka("outerProduct",sn,je,[Se,Ce]),...Ka("outerProduct",sn,Xe,[Ce,Ae]),...Ka("outerProduct",sn,Qe,[Ae,Ce])]},transpose:{overloads:[...Ka("transpose",sn|rn,ke,[ke]),...Ka("transpose",sn|rn,We,[We]),...Ka("transpose",sn|rn,qe,[qe]),...Ka("transpose",sn|rn,Ue,[He]),...Ka("transpose",sn|rn,He,[Ue]),...Ka("transpose",sn|rn,Ge,[je]),...Ka("transpose",sn|rn,je,[Ge]),...Ka("transpose",sn|rn,Xe,[Qe]),...Ka("transpose",sn|rn,Qe,[Xe])]},determinant:{overloads:[...Ka("determinant",sn|rn,we,[ke]),...Ka("determinant",sn|rn,we,[We]),...Ka("determinant",sn|rn,we,[qe])]},inverse:{overloads:[...Ka("inverse",sn,ke,[ke]),...Ka("inverse",sn,We,[We]),...Ka("inverse",sn,qe,[qe])]},lessThan:{overloads:[...Ka("lessThan",nn,3,[0,0]),...Ka("lessThan",nn,3,[1,1]),...Ka("lessThan",nn,3,[2,2])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?tn(s[1][0],s[1][1],"<",s[0].returnType):qa(t,s)}},lessThanEqual:{overloads:[...Ka("lessThanEqual",nn,3,[0,0]),...Ka("lessThanEqual",nn,3,[1,1]),...Ka("lessThanEqual",nn,3,[2,2])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?tn(s[1][0],s[1][1],"<=",s[0].returnType):qa(t,s)}},greaterThan:{overloads:[...Ka("greaterThan",nn,3,[0,0]),...Ka("greaterThan",nn,3,[1,1]),...Ka("greaterThan",nn,3,[2,2])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?tn(s[1][0],s[1][1],">",s[0].returnType):qa(t,s)}},greaterThanEqual:{overloads:[...Ka("greaterThanEqual",nn,3,[0,0]),...Ka("greaterThanEqual",nn,3,[1,1]),...Ka("greaterThanEqual",nn,3,[2,2])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?tn(s[1][0],s[1][1],">=",s[0].returnType):qa(t,s)}},compEqual:{overloads:[...Ka("equal",nn,3,[0,0]),...Ka("equal",nn,3,[1,1]),...Ka("equal",nn,3,[2,2]),...Ka("equal",nn,3,[3,3])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?tn(s[1][0],s[1][1],"==",s[0].returnType):qa(t,s)}},compNotEqual:{overloads:[...Ka("notEqual",nn,3,[0,0]),...Ka("notEqual",nn,3,[1,1]),...Ka("notEqual",nn,3,[2,2]),...Ka("notEqual",nn,3,[3,3])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?tn(s[1][0],s[1][1],"!=",s[0].returnType):qa(t,s)}},equal:{overloads:[...Ka("equal",nn,Le,[0,0]),...Ka("equal",nn,Le,[1,1]),...Ka("equal",nn,Le,[2,2]),...Ka("equal",nn,Le,[3,3])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type&&r.isPrimitiveType()&&!r.isScalarType()?t.all(t.compEqual(i[0],i[1])):tn(s[1][0],s[1][1],"==",s[0].returnType)}},notEqual:{overloads:[...Ka("notEqual",nn,Le,[0,0]),...Ka("notEqual",nn,Le,[1,1]),...Ka("notEqual",nn,Le,[2,2]),...Ka("notEqual",nn,Le,[3,3])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type&&r.isPrimitiveType()&&!r.isScalarType()?t.any(t.compNotEqual(i[0],i[1])):tn(s[1][0],s[1][1],"!=",s[0].returnType)}},any:{overloads:Ka("any",nn,Le,[3],!0)},all:{overloads:Ka("all",nn,Le,[3],!0)},not:{overloads:Ka("not",nn,3,[3]),normalizeFunc(t,e,...i){const s=Qa(t,e,...i),r=s[1][0].getType();return"webgpu"===t.getDevice().type||r.isPrimitiveType()&&r.isScalarType()?Ja(s[1][0],"!",s[0].returnType):qa(t,s)}},neg:{overloads:[...Ka("neg",nn,0,[0]),...Ka("neg",nn,1,[1])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return Ja(s[1][0],"-",s[0].returnType)}},or_2:{overloads:Ka("or",nn,Le,[3,3]),normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return tn(s[1][0],s[1][1],"||",s[0].returnType)}},or:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Mr("or");let s=i[0];for(let e=1;e<i.length;e++)s=t.or_2(s,i[e]);return s}},compOr:{overloads:[...Ka("compOr",sn|rn,1,[1,1]),...Ka("compOr",sn|rn,2,[2,2])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return tn(s[1][0],s[1][1],"|",s[0].returnType)}},and_2:{overloads:Ka("and",nn,Le,[3,3]),normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return tn(s[1][0],s[1][1],"&&",s[0].returnType)}},and:{overloads:[],normalizeFunc(t,e,...i){if(i.length<2)throw new Mr("and");let s=i[0];for(let e=1;e<i.length;e++)s=t.and_2(s,i[e]);return s}},compAnd:{overloads:[...Ka("compAnd",sn|rn,1,[1,1]),...Ka("compAnd",sn|rn,2,[2,2])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return tn(s[1][0],s[1][1],"&",s[0].returnType)}},compXor:{overloads:[...Ka("compXor",sn|rn,1,[1,1]),...Ka("compXor",sn|rn,2,[2,2])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return tn(s[1][0],s[1][1],"^",s[0].returnType)}},sal:{overloads:[...Ka("sal",sn|rn,1,[1,2]),...Ka("sal",sn|rn,2,[2,2])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return tn(s[1][0],s[1][1],"<<",s[0].returnType)}},sar:{overloads:[...Ka("sar",sn|rn,1,[1,2]),...Ka("sar",sn|rn,2,[2,2])],normalizeFunc(t,e,...i){const s=Qa(t,e,...i);return tn(s[1][0],s[1][1],">>",s[0].returnType)}},arrayLength:{overloads:[],normalizeFunc(t,e,...i){if(1!==i.length)throw new Mr("arrayLength");if(!(i[0]instanceof Wa))throw new Ir("arrayLength","array");const s=i[0].$ast.getType(),r=s.isPointerType()?s.pointerType:s;if(!r.isArrayType()||0!==r.dimension)throw new Br("arrayLength","array");const a=s.isArrayType()?t.addressOf(i[0]).$ast:i[0].$ast;return t.$callFunctionNoCheck(e,[a],Re)}},select:{overloads:[...Ka("select",rn,0,[0,0,Le]),...Ka("select",rn,1,[1,1,Le]),...Ka("select",rn,2,[2,2,Le]),...Ka("select",rn,3,[3,3,Le]),...Ka("select",rn,0,[0,0,3],!0),...Ka("select",rn,1,[1,1,3],!0),...Ka("select",rn,2,[2,2,3],!0),...Ka("select",rn,3,[3,3,3],!0),...Ka("mix",sn,0,[0,0,3]),...Ka("mix",sn,1,[1,1,3]),...Ka("mix",sn,2,[2,2,3])]},floatBitsToInt:{overloads:Ka("floatBitsToInt",sn,1,[0]),normalizeFunc(t,e,...i){if(1!==i.length)throw new Mr("floatBitsToInt");if(i[0]instanceof Wa){if(i[0].$ast.getType().typeId!==we.typeId)throw new Br("floatBitsToInt","x")}else if("number"!=typeof i[0])throw new Ir("floatBitsToInt","x");return"webgpu"===t.getDevice().type?t.$callFunctionNoCheck("bitcast<i32>",[i[0]instanceof Wa?i[0].$ast:new ga(i[0],we)],Be):Ya(t,e,...i)}},floatBitsToUint:{overloads:Ka("floatBitsToUint",sn,2,[0]),normalizeFunc(t,e,...i){if(1!==i.length)throw new Mr("floatBitsToUint");if(i[0]instanceof Wa){if(i[0].$ast.getType().typeId!==we.typeId)throw new Br("floatBitsToUint","x")}else if("number"!=typeof i[0])throw new Ir("floatBitsToUint","x");return"webgpu"===t.getDevice().type?t.$callFunctionNoCheck("bitcast<u32>",[i[0]instanceof Wa?i[0].$ast:new ga(i[0],we)],Re):Ya(t,e,...i)}},intBitsToFloat:{overloads:Ka("intBitsToFloat",sn,0,[1]),normalizeFunc(t,e,...i){if(1!==i.length)throw new Mr("intBitsToFloat");if(i[0]instanceof Wa){if(i[0].$ast.getType().typeId!==Be.typeId)throw new Br("intBitsToFloat","x")}else if("number"!=typeof i[0])throw new Ir("intBitsToFloat","x");return"webgpu"===t.getDevice().type?t.$callFunctionNoCheck("bitcast<f32>",[i[0]instanceof Wa?i[0].$ast:new ga(i[0],Be)],we):Ya(t,e,...i)}},uintBitsToFloat:{overloads:Ka("uintBitsToFloat",sn,0,[2]),normalizeFunc(t,e,...i){if(1!==i.length)throw new Mr("uintBitsToFloat");if(i[0]instanceof Wa){if(i[0].$ast.getType().typeId!==Re.typeId)throw new Br("uintBitsToFloat","x")}else if("number"!=typeof i[0])throw new Ir("uintBitsToFloat","x");return"webgpu"===t.getDevice().type?t.$callFunctionNoCheck("bitcast<f32>",[i[0]instanceof Wa?i[0].$ast:new ga(i[0],Re)],we):Ya(t,e,...i)}},pack4x8snorm:{overloads:Ka("pack4x8snorm",rn,Re,[Ce])},unpack4x8snorm:{overloads:Ka("unpack4x8snorm",rn,Ce,[Re])},pack4x8unorm:{overloads:Ka("pack4x8unorm",rn,Re,[Ce])},unpack4x8unorm:{overloads:Ka("unpack4x8unorm",rn,Ce,[Re])},pack2x16snorm:{overloads:[...Ka("pack2x16snorm",rn,Re,[Se]),...Ka("packSnorm2x16",sn,Re,[Se])]},unpack2x16snorm:{overloads:[...Ka("unpack2x16snorm",rn,Se,[Re]),...Ka("unpackSnorm2x16",sn,Se,[Re])]},pack2x16unorm:{overloads:[...Ka("pack2x16unorm",rn,Re,[Se]),...Ka("packUnorm2x16",sn,Re,[Se])]},unpack2x16unorm:{overloads:[...Ka("unpack2x16unorm",rn,Se,[Re]),...Ka("unpackUnorm2x16",sn,Se,[Re])]},pack2x16float:{overloads:[...Ka("pack2x16float",rn,Re,[Se]),...Ka("packHalf2x16",sn,Re,[Se])]},unpack2x16float:{overloads:[...Ka("unpack2x16float",rn,Se,[Re]),...Ka("unpackHalf2x16",sn,Se,[Re])]},matrixCompMult:{overloads:Za("matrixCompMult",an,0,[null,null])},dpdx:{overloads:[...Ka("dFdx",an,0,[0]),...Ka("dpdx",rn,0,[0])]},dpdy:{overloads:[...Ka("dFdy",an,0,[0]),...Ka("dpdy",rn,0,[0])]},fwidth:{overloads:Ka("fwidth",nn,0,[0])},dpdxCoarse:{overloads:[...Ka("dpdxCoarse",rn,0,[0]),...Ka("dFdx",an,0,[0])]},dpdxFine:{overloads:[...Ka("dpdxFine",rn,0,[0]),...Ka("dFdx",an,0,[0])]},dpdyCoarse:{overloads:[...Ka("dpdyCoarse",rn,0,[0]),...Ka("dFdy",an,0,[0])]},dpdyFine:{overloads:[...Ka("dpdyFine",rn,0,[0]),...Ka("dFdy",an,0,[0])]},textureDimensions:{overloads:[...Ka("textureDimensions",rn,Re,[Ye,Be]),...Ka("textureDimensions",rn,Re,[Ze,Be]),...Ka("textureDimensions",rn,Re,[Ke,Be]),...Ka("textureDimensions",rn,Fe,[Je,Be]),...Ka("textureDimensions",rn,Fe,[ti,Be]),...Ka("textureDimensions",rn,Fe,[ei,Be]),...Ka("textureDimensions",rn,Fe,[ii,Be]),...Ka("textureDimensions",rn,Fe,[si,Be]),...Ka("textureDimensions",rn,Fe,[ri,Be]),...Ka("textureDimensions",rn,De,[ai,Be]),...Ka("textureDimensions",rn,De,[ni,Be]),...Ka("textureDimensions",rn,De,[oi,Be]),...Ka("textureDimensions",rn,Fe,[hi,Be]),...Ka("textureDimensions",rn,Fe,[li,Be]),...Ka("textureDimensions",rn,Fe,[ui,Be]),...Ka("textureDimensions",rn,Fe,[di,Be]),...Ka("textureDimensions",rn,Fe,[pi,Be]),...Ka("textureDimensions",rn,Fe,[mi,Be]),...Ka("textureDimensions",rn,Fe,[fi]),...Ka("textureDimensions",rn,Fe,[_i]),...Ka("textureDimensions",rn,Fe,[gi]),...Ka("textureDimensions",rn,Fe,[Ps,Be]),...Ka("textureDimensions",rn,Fe,[$s,Be]),...Ka("textureDimensions",rn,Fe,[Rs,Be]),...Ka("textureDimensions",rn,Fe,[Fs,Be]),...Ka("textureDimensions",rn,Fe,[Ds]),...Ka("textureDimensions",rn,Re,[xi]),...Ka("textureDimensions",rn,Re,[bi]),...Ka("textureDimensions",rn,Re,[yi]),...Ka("textureDimensions",rn,Re,[Ti]),...Ka("textureDimensions",rn,Re,[wi]),...Ka("textureDimensions",rn,Re,[Si]),...Ka("textureDimensions",rn,Re,[Ai]),...Ka("textureDimensions",rn,Re,[Ci]),...Ka("textureDimensions",rn,Re,[Ei]),...Ka("textureDimensions",rn,Re,[Mi]),...Ka("textureDimensions",rn,Re,[Bi]),...Ka("textureDimensions",rn,Re,[Ii]),...Ka("textureDimensions",rn,Re,[Pi]),...Ka("textureDimensions",rn,Re,[$i]),...Ka("textureDimensions",rn,Re,[Ri]),...Ka("textureDimensions",rn,Re,[Fi]),...Ka("textureDimensions",rn,Fe,[Di]),...Ka("textureDimensions",rn,Fe,[Ni]),...Ka("textureDimensions",rn,Fe,[zi]),...Ka("textureDimensions",rn,Fe,[Vi]),...Ka("textureDimensions",rn,Fe,[Oi]),...Ka("textureDimensions",rn,Fe,[ki]),...Ka("textureDimensions",rn,Fe,[Ui]),...Ka("textureDimensions",rn,Fe,[Gi]),...Ka("textureDimensions",rn,Fe,[Hi]),...Ka("textureDimensions",rn,Fe,[Wi]),...Ka("textureDimensions",rn,Fe,[Xi]),...Ka("textureDimensions",rn,Fe,[ji]),...Ka("textureDimensions",rn,Fe,[Qi]),...Ka("textureDimensions",rn,Fe,[qi]),...Ka("textureDimensions",rn,Fe,[Yi]),...Ka("textureDimensions",rn,Fe,[Zi]),...Ka("textureDimensions",rn,Fe,[Ki]),...Ka("textureDimensions",rn,Fe,[Ji]),...Ka("textureDimensions",rn,Fe,[ts]),...Ka("textureDimensions",rn,Fe,[es]),...Ka("textureDimensions",rn,Fe,[is]),...Ka("textureDimensions",rn,Fe,[ss]),...Ka("textureDimensions",rn,Fe,[rs]),...Ka("textureDimensions",rn,Fe,[as]),...Ka("textureDimensions",rn,Fe,[ns]),...Ka("textureDimensions",rn,Fe,[os]),...Ka("textureDimensions",rn,Fe,[hs]),...Ka("textureDimensions",rn,Fe,[ls]),...Ka("textureDimensions",rn,Fe,[us]),...Ka("textureDimensions",rn,Fe,[cs]),...Ka("textureDimensions",rn,Fe,[ds]),...Ka("textureDimensions",rn,Fe,[ps]),...Ka("textureDimensions",rn,De,[ms]),...Ka("textureDimensions",rn,De,[fs]),...Ka("textureDimensions",rn,De,[gs]),...Ka("textureDimensions",rn,De,[xs]),...Ka("textureDimensions",rn,De,[bs]),...Ka("textureDimensions",rn,De,[vs]),...Ka("textureDimensions",rn,De,[ys]),...Ka("textureDimensions",rn,De,[Ts]),...Ka("textureDimensions",rn,De,[ws]),...Ka("textureDimensions",rn,De,[Ss]),...Ka("textureDimensions",rn,De,[As]),...Ka("textureDimensions",rn,De,[Cs]),...Ka("textureDimensions",rn,De,[Es]),...Ka("textureDimensions",rn,De,[Ms]),...Ka("textureDimensions",rn,De,[Bs]),...Ka("textureDimensions",rn,De,[Is]),...Ka("textureSize",sn,Ie,[Ye,Be]),...Ka("textureSize",sn,Ie,[Je,Be]),...Ka("textureSize",sn,Ie,[Ze,Be]),...Ka("textureSize",sn,Ie,[ti,Be]),...Ka("textureSize",sn,Ie,[Ke,Be]),...Ka("textureSize",sn,Ie,[ei,Be]),...Ka("textureSize",sn,Ie,[ii,Be]),...Ka("textureSize",sn,Ie,[si,Be]),...Ka("textureSize",sn,Ie,[ri,Be]),...Ka("textureSize",sn,Ie,[hi,Be]),...Ka("textureSize",sn,Ie,[li,Be]),...Ka("textureSize",sn,Ie,[ui,Be]),...Ka("textureSize",sn,Pe,[ai,Be]),...Ka("textureSize",sn,Pe,[ni,Be]),...Ka("textureSize",sn,Pe,[oi,Be]),...Ka("textureSize",sn,Ie,[Ps,Be]),...Ka("textureSize",sn,Ie,[Rs,Be]),...Ka("textureSize",sn,Ie,[$s,Be])],normalizeFunc(t,e,...i){if(i.length<1||i.length>2)throw new Mr("textureDimensions");if(!(i[0]instanceof Wa))throw new Ir("textureDimensions","tex");const s=i[0].$ast.getType();if(!s.isTextureType())throw new Br("textureDimensions","tex");if("webgpu"===t.getDevice().type){if((s.isMultisampledTexture()||s.isStorageTexture())&&void 0!==i[1])throw new Ir("textureDimensions","level");return Ya(t,e,...i)}if("webgl2"===t.getDevice().type){const r=i[0],a=i[1]||0;return s.is1DTexture()?Ya(t,e,r,a).x:Ya(t,e,r,a)}}},textureGather:{overloads:[...Ka("textureGather",rn,Ce,[Be,Je,Ns,Se]),...Ka("textureGather",rn,$e,[Be,ti,Ns,Se]),...Ka("textureGather",rn,Ne,[Be,ei,Ns,Se]),...Ka("textureGather",rn,Ce,[Be,hi,Ns,Ae]),...Ka("textureGather",rn,$e,[Be,li,Ns,Ae]),...Ka("textureGather",rn,Ne,[Be,ui,Ns,Ae]),...Ka("textureGather",rn,Ce,[Ps,Ns,Se]),...Ka("textureGather",rn,Ce,[Rs,Ns,Ae])]},textureArrayGather:{overloads:[...Ka("textureGather",rn,Ce,[Be,ii,Ns,Se,Be]),...Ka("textureGather",rn,$e,[Be,si,Ns,Se,Be]),...Ka("textureGather",rn,Ne,[Be,ri,Ns,Se,Be]),...Ka("textureGather",rn,Ce,[Be,di,Ns,Ae,Be]),...Ka("textureGather",rn,$e,[Be,pi,Ns,Ae,Be]),...Ka("textureGather",rn,Ne,[Be,mi,Ns,Ae,Be]),...Ka("textureGather",rn,Ce,[$s,Ns,Se,Be]),...Ka("textureGather",rn,Ce,[Fs,Ns,Ae,Be])]},textureGatherCompare:{overloads:[...Ka("textureGatherCompare",rn,Ce,[Ps,Ls,Se,we]),...Ka("textureGatherCompare",rn,Ce,[Rs,Ls,Ae,we])]},textureArrayGatherCompare:{overloads:[...Ka("textureGatherCompare",rn,Ce,[$s,Ls,Se,Be,we]),...Ka("textureGatherCompare",rn,Ce,[Fs,Ls,Ae,Be,we])]},textureLoad:{overloads:[...Ka("textureLoad",rn,Ce,[Ye,Be,Be]),...Ka("textureLoad",rn,$e,[Ze,Be,Be]),...Ka("textureLoad",rn,Ne,[Ke,Be,Be]),...Ka("textureLoad",rn,Ce,[vi,Be]),...Ka("textureLoad",rn,Ce,[Fi,Be]),...Ka("textureLoad",rn,$e,[Ri,Be]),...Ka("textureLoad",rn,Ne,[$i,Be]),...Ka("textureLoad",rn,Ce,[Pi,Be]),...Ka("textureLoad",rn,$e,[Ii,Be]),...Ka("textureLoad",rn,Ne,[Bi,Be]),...Ka("textureLoad",rn,Ce,[Ai,Be]),...Ka("textureLoad",rn,$e,[Si,Be]),...Ka("textureLoad",rn,Ne,[wi,Be]),...Ka("textureLoad",rn,Ce,[Mi,Be]),...Ka("textureLoad",rn,$e,[Ei,Be]),...Ka("textureLoad",rn,Ne,[Ci,Be]),...Ka("textureLoad",rn,$e,[Ti,Be]),...Ka("textureLoad",rn,Ne,[yi,Be]),...Ka("textureLoad",rn,Ce,[bi,Be]),...Ka("textureLoad",rn,Ce,[xi,Be]),...Ka("textureLoad",rn,Ce,[Je,Ie,Be]),...Ka("textureLoad",rn,$e,[ti,Ie,Be]),...Ka("textureLoad",rn,Ne,[ei,Ie,Be]),...Ka("textureLoad",rn,Ce,[Li,Ie]),...Ka("textureLoad",rn,Ce,[Zi,Ie]),...Ka("textureLoad",rn,$e,[Yi,Ie]),...Ka("textureLoad",rn,Ne,[qi,Ie]),...Ka("textureLoad",rn,Ce,[Qi,Ie]),...Ka("textureLoad",rn,$e,[ji,Ie]),...Ka("textureLoad",rn,Ne,[Xi,Ie]),...Ka("textureLoad",rn,Ce,[Ui,Ie]),...Ka("textureLoad",rn,$e,[ki,Ie]),...Ka("textureLoad",rn,Ne,[Oi,Ie]),...Ka("textureLoad",rn,Ce,[Wi,Ie]),...Ka("textureLoad",rn,$e,[Hi,Ie]),...Ka("textureLoad",rn,Ne,[Gi,Ie]),...Ka("textureLoad",rn,$e,[Vi,Ie]),...Ka("textureLoad",rn,Ne,[zi,Ie]),...Ka("textureLoad",rn,Ce,[Ni,Ie]),...Ka("textureLoad",rn,Ce,[Di,Ie]),...Ka("textureLoad",rn,Ce,[ai,Pe,Be]),...Ka("textureLoad",rn,$e,[ni,Pe,Be]),...Ka("textureLoad",rn,Ne,[oi,Pe,Be]),...Ka("textureLoad",rn,Ce,[_s,Pe]),...Ka("textureLoad",rn,Ce,[Is,Pe]),...Ka("textureLoad",rn,$e,[Bs,Pe]),...Ka("textureLoad",rn,Ne,[Ms,Pe]),...Ka("textureLoad",rn,Ce,[Es,Pe]),...Ka("textureLoad",rn,$e,[Cs,Pe]),...Ka("textureLoad",rn,Ne,[As,Pe]),...Ka("textureLoad",rn,Ce,[ys,Pe]),...Ka("textureLoad",rn,$e,[vs,Pe]),...Ka("textureLoad",rn,Ne,[bs,Pe]),...Ka("textureLoad",rn,Ce,[Ss,Pe]),...Ka("textureLoad",rn,$e,[ws,Pe]),...Ka("textureLoad",rn,Ne,[Ts,Pe]),...Ka("textureLoad",rn,$e,[xs,Pe]),...Ka("textureLoad",rn,Ne,[gs,Pe]),...Ka("textureLoad",rn,Ce,[fs,Pe]),...Ka("textureLoad",rn,Ce,[ms,Pe]),...Ka("textureLoad",rn,Ce,[fi,Ie,Be]),...Ka("textureLoad",rn,$e,[_i,Ie,Be]),...Ka("textureLoad",rn,Ne,[gi,Ie,Be]),...Ka("textureLoad",rn,Ce,[ci,Ie]),...Ka("textureLoad",rn,we,[Ps,Ie,Be]),...Ka("textureLoad",rn,we,[Ds,Ie,Be]),...Ka("texelFetch",sn,Ce,[Ye,Ie,Be]),...Ka("texelFetch",sn,Ce,[Je,Ie,Be]),...Ka("texelFetch",sn,Ce,[ai,Pe,Be]),...Ka("texelFetch",sn,Ne,[ci,Ie,Be]),...Ka("texelFetch",sn,Ce,[Ze,Ie,Be]),...Ka("texelFetch",sn,$e,[ti,Ie,Be]),...Ka("texelFetch",sn,$e,[ni,Pe,Be]),...Ka("texelFetch",sn,Ce,[Ke,Ie,Be]),...Ka("texelFetch",sn,Ne,[ei,Ie,Be]),...Ka("texelFetch",sn,Ne,[oi,Pe,Be])],normalizeFunc(t,e,...i){if(0===i.length)throw new Mr("textureLoad");if(!(i[0]instanceof Wa))throw new Ir("textureLoad","tex");const s=i[0].$ast.getType();if(!s.isTextureType())throw new Br("textureLoad","tex");if("webgl2"===t.getDevice().type){if(3!==i.length)throw new Mr("textureLoad");if(s.is1DTexture()){if("number"==typeof i[1]){if(!Number.isInteger(i[1]))throw new Br("textureLoad","coord")}else{if(!(i[1]instanceof Wa))throw new Br("textureLoad","coord");{const t=i[1].$ast.getType();if(!t.isPrimitiveType()||!t.isScalarType()||t.scalarType!==te.I32)throw new Br("textureLoad","coord")}}i[1]=t.ivec2(i[1],0)}}else"webgpu"===t.getDevice().type&&(s.isExternalTexture()&&(i=i.slice(0,2)),s.isStorageTexture()&&(s.readable=!0));return Ya(t,e,...i)}},textureArrayLoad:{overloads:[...Ka("textureLoad",rn,Ce,[ii,Ie,Be,Be]),...Ka("textureLoad",rn,$e,[si,Ie,Be,Be]),...Ka("textureLoad",rn,Ne,[ri,Ie,Be,Be]),...Ka("textureLoad",rn,we,[$s,Ie,Be,Be]),...Ka("texelFetch",sn,Ce,[ii,Pe,Be]),...Ka("texelFetch",sn,$e,[si,Pe,Be]),...Ka("texelFetch",sn,Ne,[ri,Pe,Be])],normalizeFunc(t,e,...i){if(0===i.length)throw new Mr("textureArrayLoad");const s=i[0];if(!(s instanceof Wa))throw new Ir("textureArrayLoad","tex");const r=s.$ast.getType();if(!r.isTextureType())throw new Br("textureArrayLoad","tex");if("webgl2"===t.getDevice().type){if(4!==i.length)throw new Mr("textureArrayLoad");const r=t.ivec3(i[1],i[2]);return Ya(t,e,s,r,i[3])}return r.isStorageTexture()&&(r.readable=!0),Ya(t,e,...i)}},textureStore:{overloads:[...Ka("textureStore",rn,zs,[xi,Re,Ce]),...Ka("textureStore",rn,zs,[bi,Re,Ce]),...Ka("textureStore",rn,zs,[yi,Re,Ne]),...Ka("textureStore",rn,zs,[Ti,Re,$e]),...Ka("textureStore",rn,zs,[wi,Re,Ne]),...Ka("textureStore",rn,zs,[Si,Re,$e]),...Ka("textureStore",rn,zs,[Ai,Re,Ce]),...Ka("textureStore",rn,zs,[Ci,Re,Ne]),...Ka("textureStore",rn,zs,[Ei,Re,$e]),...Ka("textureStore",rn,zs,[Mi,Re,Ce]),...Ka("textureStore",rn,zs,[Bi,Re,Ne]),...Ka("textureStore",rn,zs,[Ii,Re,$e]),...Ka("textureStore",rn,zs,[Pi,Re,Ce]),...Ka("textureStore",rn,zs,[$i,Re,Ne]),...Ka("textureStore",rn,zs,[Ri,Re,$e]),...Ka("textureStore",rn,zs,[Fi,Re,Ce]),...Ka("textureStore",rn,zs,[Di,Fe,Ce]),...Ka("textureStore",rn,zs,[Ni,Fe,Ce]),...Ka("textureStore",rn,zs,[zi,Fe,Ne]),...Ka("textureStore",rn,zs,[Vi,Fe,$e]),...Ka("textureStore",rn,zs,[Oi,Fe,Ne]),...Ka("textureStore",rn,zs,[ki,Fe,$e]),...Ka("textureStore",rn,zs,[Ui,Fe,Ce]),...Ka("textureStore",rn,zs,[Gi,Fe,Ne]),...Ka("textureStore",rn,zs,[Hi,Fe,$e]),...Ka("textureStore",rn,zs,[Wi,Fe,Ce]),...Ka("textureStore",rn,zs,[Xi,Fe,Ne]),...Ka("textureStore",rn,zs,[ji,Fe,$e]),...Ka("textureStore",rn,zs,[Qi,Fe,Ce]),...Ka("textureStore",rn,zs,[qi,Fe,Ne]),...Ka("textureStore",rn,zs,[qi,Ie,Ne]),...Ka("textureStore",rn,zs,[Yi,Fe,$e]),...Ka("textureStore",rn,zs,[Zi,Fe,Ce]),...Ka("textureStore",rn,zs,[ms,De,Ce]),...Ka("textureStore",rn,zs,[fs,De,Ce]),...Ka("textureStore",rn,zs,[gs,De,Ne]),...Ka("textureStore",rn,zs,[xs,De,$e]),...Ka("textureStore",rn,zs,[bs,De,Ne]),...Ka("textureStore",rn,zs,[vs,De,$e]),...Ka("textureStore",rn,zs,[ys,De,Ce]),...Ka("textureStore",rn,zs,[Ts,De,Ne]),...Ka("textureStore",rn,zs,[ws,De,$e]),...Ka("textureStore",rn,zs,[Ss,De,Ce]),...Ka("textureStore",rn,zs,[As,De,Ne]),...Ka("textureStore",rn,zs,[Cs,De,$e]),...Ka("textureStore",rn,zs,[Es,De,Ce]),...Ka("textureStore",rn,zs,[Ms,De,Ne]),...Ka("textureStore",rn,zs,[Bs,De,$e]),...Ka("textureStore",rn,zs,[Is,De,Ce])],normalizeFunc(t,e,...i){if("webgpu"===t.getDevice().type){const t=i[0];if(t instanceof Wa){const e=t.$ast.getType();e?.isTextureType()&&e.isStorageTexture()&&(e.writable=!0)}}return Ya(t,e,...i)}},textureArrayStore:{overloads:[...Ka("textureStore",rn,zs,[Ki,Fe,Be,Ce]),...Ka("textureStore",rn,zs,[Ji,Fe,Be,Ce]),...Ka("textureStore",rn,zs,[ts,Fe,Be,Ne]),...Ka("textureStore",rn,zs,[es,Fe,Be,$e]),...Ka("textureStore",rn,zs,[is,Fe,Be,Ne]),...Ka("textureStore",rn,zs,[ss,Fe,Be,$e]),...Ka("textureStore",rn,zs,[rs,Fe,Be,Ce]),...Ka("textureStore",rn,zs,[as,Fe,Be,Ne]),...Ka("textureStore",rn,zs,[ns,Fe,Be,$e]),...Ka("textureStore",rn,zs,[os,Fe,Be,Ce]),...Ka("textureStore",rn,zs,[hs,Fe,Be,Ne]),...Ka("textureStore",rn,zs,[ls,Fe,Be,$e]),...Ka("textureStore",rn,zs,[us,Fe,Be,Ce]),...Ka("textureStore",rn,zs,[cs,Fe,Be,Ne]),...Ka("textureStore",rn,zs,[ds,Fe,Be,$e]),...Ka("textureStore",rn,zs,[ps,Fe,Be,Ce])],normalizeFunc(t,e,...i){if("webgpu"===t.getDevice().type){const t=i[0];if(t instanceof Wa){const e=t.$ast.getType();e?.isTextureType()&&e.isStorageTexture()&&(e.writable=!0)}}return Ya(t,e,...i)}},textureNumLayers:{overloads:[...Ka("textureNumLayers",rn,Be,[ii]),...Ka("textureNumLayers",rn,Be,[si]),...Ka("textureNumLayers",rn,Be,[ri]),...Ka("textureNumLayers",rn,Be,[di]),...Ka("textureNumLayers",rn,Be,[pi]),...Ka("textureNumLayers",rn,Be,[mi]),...Ka("textureNumLayers",rn,Be,[$s]),...Ka("textureNumLayers",rn,Be,[Fs]),...Ka("textureNumLayers",rn,Be,[ps]),...Ka("textureNumLayers",rn,Be,[ds]),...Ka("textureNumLayers",rn,Be,[cs]),...Ka("textureNumLayers",rn,Be,[us]),...Ka("textureNumLayers",rn,Be,[ls]),...Ka("textureNumLayers",rn,Be,[hs]),...Ka("textureNumLayers",rn,Be,[rs]),...Ka("textureNumLayers",rn,Be,[ss]),...Ka("textureNumLayers",rn,Be,[is]),...Ka("textureNumLayers",rn,Be,[os]),...Ka("textureNumLayers",rn,Be,[ns]),...Ka("textureNumLayers",rn,Be,[as]),...Ka("textureNumLayers",rn,Be,[es]),...Ka("textureNumLayers",rn,Be,[Ji]),...Ka("textureNumLayers",rn,Be,[ts]),...Ka("textureNumLayers",rn,Be,[Ki])]},textureNumLevels:{overloads:[...Ka("textureNumLevels",rn,Be,[Ye]),...Ka("textureNumLevels",rn,Be,[Ze]),...Ka("textureNumLevels",rn,Be,[Ke]),...Ka("textureNumLevels",rn,Be,[Je]),...Ka("textureNumLevels",rn,Be,[ti]),...Ka("textureNumLevels",rn,Be,[ei]),...Ka("textureNumLevels",rn,Be,[ii]),...Ka("textureNumLevels",rn,Be,[si]),...Ka("textureNumLevels",rn,Be,[ri]),...Ka("textureNumLevels",rn,Be,[ai]),...Ka("textureNumLevels",rn,Be,[ni]),...Ka("textureNumLevels",rn,Be,[oi]),...Ka("textureNumLevels",rn,Be,[hi]),...Ka("textureNumLevels",rn,Be,[li]),...Ka("textureNumLevels",rn,Be,[ui]),...Ka("textureNumLevels",rn,Be,[di]),...Ka("textureNumLevels",rn,Be,[pi]),...Ka("textureNumLevels",rn,Be,[mi]),...Ka("textureNumLevels",rn,Be,[Ps]),...Ka("textureNumLevels",rn,Be,[$s]),...Ka("textureNumLevels",rn,Be,[Rs]),...Ka("textureNumLevels",rn,Be,[Fs])]},textureNumSamples:{overloads:[...Ka("textureNumSamples",rn,Be,[fi]),...Ka("textureNumSamples",rn,Be,[_i]),...Ka("textureNumSamples",rn,Be,[gi]),...Ka("textureNumSamples",rn,Be,[Ds])]},textureSample:{overloads:[...Ka("textureSample",rn,Ce,[Ye,Ns,we]),...Ka("textureSample",rn,Ce,[Je,Ns,Se]),...Ka("textureSample",rn,Ce,[ai,Ns,Ae]),...Ka("textureSample",rn,Ce,[hi,Ns,Ae]),...Ka("textureSample",rn,we,[Ps,Ns,Se]),...Ka("textureSample",rn,we,[Rs,Ns,Ae]),...Ka("textureSampleBaseClampToEdge",rn,Ce,[ci,Ns,Se]),...Ka("texture",sn,Ce,[Ye,Se]),...Ka("texture",sn,Ce,[Je,Se]),...Ka("texture",sn,Ce,[ci,Se]),...Ka("texture",sn,Ce,[Ps,Se]),...Ka("texture",sn,Ce,[ai,Ae]),...Ka("texture",sn,Ce,[hi,Ae]),...Ka("texture",sn,Ce,[Rs,Ae]),...Ka("texture2D",en,Ce,[Ye,Se]),...Ka("texture2D",en,Ce,[Je,Se]),...Ka("texture2D",en,Ce,[ci,Se]),...Ka("texture2D",en,Ce,[Ps,Se]),...Ka("textureCube",en,Ce,[hi,Ae]),...Ka("textureCube",en,Ce,[Rs,Ae])],normalizeFunc(t,e,...i){if(2!==i.length)throw new Mr("textureSample");const s=i[0];if(!(s instanceof Wa))throw new Br("textureSample","texture");const r=s.$ast.getType();if(!r.isTextureType())throw new Br("textureSample","texture");if("webgpu"===t.getDevice().type){if(r.isStorageTexture())throw new Br("textureSample","texture");const a=t.getDefaultSampler(s,!1),n=Ya(t,e,s,a,i[1]);return n.$ast.getType().isCompatibleType(we)?t.vec4(n):n}if(t.getDefaultSampler(s,!1),r.is1DTexture()){if(i[1]instanceof Wa){const t=i[1].$ast.getType();if(!t.isPrimitiveType()||!t.isScalarType()||t.scalarType!==te.F32)throw new Br("textureSample","coord")}else if("number"!=typeof i[1])throw new Br("textureSample","coord");i[1]=t.vec2(i[1],0)}return Ya(t,e,...i)}},textureArraySample:{overloads:[...Ka("textureSample",rn,Ce,[ii,Ns,Se,Be]),...Ka("textureSample",rn,Ce,[di,Ns,Ae,Be]),...Ka("textureSample",rn,we,[$s,Ns,Se,Be]),...Ka("textureSample",rn,we,[Fs,Ns,Ae,Be]),...Ka("texture",sn,Ce,[ii,Ae]),...Ka("texture",sn,Ce,[$s,Ae])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Mr("textureArraySample");const s=i[0];if(!(s instanceof Wa))throw new Br("textureArraySample","texture");if(!s.$ast.getType().isTextureType())throw new Br("textureArraySample","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1),a=Ya(t,e,s,r,i[1],i[2]);return a.$ast.getType().isCompatibleType(we)?t.vec4(a):a}{t.getDefaultSampler(s,!1);const r=i[1],a=i[2],n=t.vec3(r,t.float(a));return Ya(t,e,s,n)}}},textureSampleBias:{overloads:[...Ka("textureSampleBias",rn,Ce,[Je,Ns,Se,we]),...Ka("textureSampleBias",rn,Ce,[ai,Ns,Ae,we]),...Ka("textureSampleBias",rn,Ce,[hi,Ns,Ae,we]),...Ka("texture",sn,Ce,[Je,Se,we]),...Ka("texture",sn,Ce,[ai,Ae,we]),...Ka("texture",sn,Ce,[hi,Ae,we]),...Ka("texture2D",en,Ce,[Je,Se,we]),...Ka("textureCube",en,Ce,[hi,Ae,we])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Mr("textureSampleBias");const s=i[0];if(!(s instanceof Wa))throw new Br("textureSampleBias","texture");if(!s.$ast.getType().isTextureType())throw new Br("textureSampleBias","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return Ya(t,e,s,r,i[1],i[2])}return t.getDefaultSampler(s,!1),Ya(t,e,...i)}},textureArraySampleBias:{overloads:[...Ka("textureSampleBias",rn,Ce,[ii,Ns,Se,Be,we]),...Ka("textureSampleBias",rn,Ce,[di,Ns,Ae,Be,we]),...Ka("texture",sn,Ce,[ii,Ae,we])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Mr("textureArraySampleBias");const s=i[0];if(!(s instanceof Wa))throw new Br("textureArraySampleBias","texture");if(!s.$ast.getType().isTextureType())throw new Br("textureArraySampleBias","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return Ya(t,e,s,r,i[1],i[2],i[3])}if("webgl2"===t.getDevice().type){t.getDefaultSampler(s,!1);const r=i[1],a=i[2],n=t.vec3(r,t.float(a));return Ya(t,e,s,n,i[3])}}},textureSampleCompare:{overloads:[...Ka("textureSampleCompare",rn,we,[Ps,Ls,Se,we]),...Ka("textureSampleCompare",rn,we,[Rs,Ls,Ae,we]),...Ka("texture",sn,we,[Ps,Ae]),...Ka("texture",sn,we,[Rs,Ce])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Mr("textureSampleCompare");const s=i[0];if(!(s instanceof Wa))throw new Br("textureSampleCompare","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Br("textureSampleCompare","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(i[0],!0);return Ya(t,e,s,r,i[1],i[2])}{let a;return t.getDefaultSampler(i[0],!0),a=r.isCubeTexture()||r.isArrayTexture()?t.vec4(i[1],i[2]):t.vec3(i[1],i[2]),Ya(t,e,s,a)}}},textureArraySampleCompare:{overloads:[...Ka("textureSampleCompare",rn,we,[$s,Ls,Se,Be,we]),...Ka("textureSampleCompare",rn,we,[Fs,Ls,Ae,Be,we]),...Ka("texture",sn,we,[$s,Ce])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Mr("textureArraySampleCompare");const s=i[0];if(!(s instanceof Wa))throw new Br("textureArraySampleCompare","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Br("textureArraySampleCompare","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(i[0],!0);return Ya(t,e,s,r,i[1],i[2],i[3])}{t.getDefaultSampler(i[0],!0);const r=t.vec4(i[1],t.float(i[2]),i[3]);return Ya(t,e,s,r)}}},textureSampleLevel:{overloads:[...Ka("textureSampleLevel",rn,Ce,[Je,Ns,Se,we]),...Ka("textureSampleLevel",rn,Ce,[ai,Ns,Ae,we]),...Ka("textureSampleLevel",rn,Ce,[hi,Ns,Ae,we]),...Ka("textureSampleLevel",rn,Ce,[ci,Ns,Se]),...Ka("textureSampleLevel",rn,we,[Ps,Ns,Se,Be]),...Ka("textureSampleLevel",rn,we,[Rs,Ns,Ae,Be]),...Ka("textureLod",sn,Ce,[Je,Se,we]),...Ka("textureLod",sn,Ce,[Ps,Se,we]),...Ka("textureLod",sn,Ce,[ci,Se,we]),...Ka("textureLod",sn,Ce,[ai,Ae,we]),...Ka("textureLod",sn,Ce,[hi,Ae,we]),...Ka("textureLod",sn,Ce,[Rs,Ae,we]),...Ka("texture2DLodEXT",en,Ce,[Je,Se,we]),...Ka("texture2DLodEXT",en,Ce,[Ps,Se,we]),...Ka("texture2DLodEXT",en,Ce,[ci,Se,we]),...Ka("textureCubeLodEXT",en,Ce,[hi,Ae,we]),...Ka("textureCubeLodEXT",en,Ce,[Rs,Ae,we])],normalizeFunc(t,e,...i){const s=i[0];if(!(s instanceof Wa))throw new Br("textureSampleLevel","texture");const r=s.$ast.getType();if(!r.isTextureType())throw new Br("textureSampleLevel","texture");if("webgl"===t.getDevice().type&&"vertex"===t.shaderKind)return t.textureSample(s,i[1]);if("webgpu"===t.getDevice().type){if(r.isExternalTexture())return t.textureLoad(s,t.ivec2(i[1]),0);{const a=t.getDefaultSampler(s,!1),n=r.isDepthTexture()&&("number"==typeof i[2]||i[2]instanceof Wa&&i[2].$ast.getType().isCompatibleType(we))?t.int(i[2]):i[2],o=r.isExternalTexture()?Ya(t,e,s,a,i[1]):Ya(t,e,s,a,i[1],n);return o.$ast.getType().isCompatibleType(we)?t.vec4(o):o}}return t.getDefaultSampler(s,!1),r.isExternalTexture()?Ya(t,e,i[0],i[1],0):Ya(t,e,i[0],i[1],i[2])}},textureArraySampleLevel:{overloads:[...Ka("textureSampleLevel",rn,Ce,[ii,Ns,Se,Be,we]),...Ka("textureSampleLevel",rn,Ce,[di,Ns,Ae,Be,we]),...Ka("textureSampleLevel",rn,we,[$s,Ns,Se,Be,Be]),...Ka("textureSampleLevel",rn,we,[Fs,Ns,Ae,Be,Be]),...Ka("textureLod",sn,Ce,[ii,Ae,we])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Mr("textureArraySampleLevel");const s=i[0];if(!(s instanceof Wa))throw new Br("textureArraySampleLevel","texture");const r=s.$ast.getType();if(!r.isTextureType())throw new Br("textureArraySampleLevel","texture");if("webgpu"===t.getDevice().type){const a=t.getDefaultSampler(s,!1),n=r.isDepthTexture()&&("number"==typeof i[3]||i[3]instanceof Wa&&i[3].$ast.getType().isCompatibleType(we))?t.int(i[3]):i[3],o=Ya(t,e,s,a,i[1],i[2],n);return o.$ast.getType().isCompatibleType(we)?t.vec4(o):o}{t.getDefaultSampler(s,!1);const r=t.vec3(i[1],t.float(i[2]));return Ya(t,e,s,r,i[3])}}},textureSampleCompareLevel:{overloads:[...Ka("textureSampleCompareLevel",rn,we,[Ps,Ls,Se,we]),...Ka("textureSampleCompareLevel",rn,we,[Rs,Ls,Ae,we]),...Ka("textureLod",sn,we,[Ps,Ae,we]),...Ka("texture",sn,we,[Rs,Ce])],normalizeFunc(t,e,...i){if(3!==i.length)throw new Mr("textureSampleCompareLevel");const s=i[0];if(!(s instanceof Wa))throw new Br("textureSampleCompareLevel","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Br("textureSampleCompareLevel","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!0);return Ya(t,e,s,r,i[1],i[2])}{let a;return t.getDefaultSampler(i[0],!0),a=r.isCubeTexture()||r.isArrayTexture()?t.vec4(i[1],i[2]):t.vec3(i[1],i[2]),r.isCubeTexture()?Ya(t,e,s,a):Ya(t,e,s,a,0)}}},textureArraySampleCompareLevel:{overloads:[...Ka("textureSampleCompareLevel",rn,we,[$s,Ls,Se,Be,we]),...Ka("textureSampleCompareLevel",rn,we,[Fs,Ls,Ae,Be,we]),...Ka("texture",sn,we,[$s,Ce])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Mr("textureArraySampleCompareLevel");const s=i[0];if(!(s instanceof Wa))throw new Br("textureArraySampleCompareLevel","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isDepthTexture())throw new Br("textureArraySampleCompareLevel","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!0);return Ya(t,e,s,r,i[1],i[2],i[3])}{t.getDefaultSampler(i[0],!0);const r=t.vec4(i[1],t.float(i[2]),i[3]);return Ya(t,e,s,r)}}},textureSampleGrad:{overloads:[...Ka("textureSampleGrad",rn,Ce,[Je,Ns,Se,Se,Se]),...Ka("textureSampleGrad",rn,Ce,[ai,Ns,Ae,Ae,Ae]),...Ka("textureSampleGrad",rn,Ce,[hi,Ns,Ae,Ae,Ae]),...Ka("textureGrad",sn,Ce,[Je,Se,Se,Se]),...Ka("textureGrad",sn,Ce,[ai,Ae,Ae,Ae]),...Ka("textureGrad",sn,Ce,[hi,Ae,Ae,Ae]),...Ka("texture2DGradEXT",en,Ce,[Je,Se,Se,Se]),...Ka("textureCubeGradEXT",en,Ce,[hi,Ae,Ae,Ae])],normalizeFunc(t,e,...i){if(4!==i.length)throw new Mr("textureSampleGrad");const s=i[0];if(!(s instanceof Wa))throw new Br("textureSampleGrad","texture");if(!s.$ast.getType().isTextureType())throw new Br("textureSampleGrad","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return Ya(t,e,s,r,i[1],i[2],i[3])}return t.getDefaultSampler(s,!1),Ya(t,e,...i)}},textureArraySampleGrad:{overloads:[...Ka("textureSampleGrad",rn,Ce,[ii,Ns,Se,Be,Se,Se]),...Ka("textureSampleGrad",rn,Ce,[di,Ns,Ae,Be,Ae,Ae]),...Ka("textureGrad",sn,Ce,[ii,Ae,Se,Se])],normalizeFunc(t,e,...i){if(5!==i.length)throw new Mr("textureArraySampleGrad");const s=i[0];if(!(s instanceof Wa))throw new Br("textureArraySampleGrad","texture");const r=s.$ast.getType();if(!r.isTextureType()||!r.isArrayTexture())throw new Br("textureArraySampleGrad","texture");if("webgpu"===t.getDevice().type){const r=t.getDefaultSampler(s,!1);return Ya(t,e,s,r,i[1],i[2],i[3],i[4])}{t.getDefaultSampler(s,!1);const r=t.vec3(i[1],t.float(i[2]));return Ya(t,e,s,r,i[3],i[4])}}},storageBarrier:{overloads:Ka("storageBarrier",rn,zs,[])},workgroupBarrier:{overloads:Ka("workgroupBarrier",rn,zs,[])},atomicLoad:{overloades:[],normalizeFunc(t,e,...i){if(1!==i.length)throw new Mr(e);const s=i[0];if(!(s instanceof Wa))throw new Br(e,"ptr");if(s.$ast.getType().typeId===Ee.typeId)return t.$callFunctionNoCheck(e,[new va(s.$ast)],Be);if(s.$ast.getType().typeId===Me.typeId)return t.$callFunctionNoCheck(e,[new va(s.$ast)],Re);throw new Ir(e,"ptr must be atomic type")}},atomicStore:{overloades:[],normalizeFunc(t,e,...i){if(2!==i.length)throw new Mr(e);const s=i[0],r=i[1];if(!(s instanceof Wa))throw new Br(e,"ptr");if(s.$ast.getType().typeId===Ee.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Ir(e,"value");return t.$callFunctionNoCheck(e,[new va(s.$ast),new ga(r,Be)],zs)}if(r instanceof Wa){if(r.$ast.getType().typeId!==Be.typeId)throw new Br(e,"value");return t.$callFunctionNoCheck(e,[new va(s.$ast),r.$ast],zs)}throw new Br(e,"value")}if(s.$ast.getType().typeId===Me.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Ir(e,"value");return t.$callFunctionNoCheck(e,[new va(s.$ast),new ga(r,Re)],zs)}if(r instanceof Wa){if(r.$ast.getType().typeId!==Re.typeId)throw new Br(e,"value");return t.$callFunctionNoCheck(e,[new va(s.$ast),r.$ast],zs)}throw new Br(e,"value")}throw new Ir(e,"ptr must be atomic type")}}};for(const t of["atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange"])on[t]={overloades:[],normalizeFunc(t,e,...i){if(2!==i.length)throw new Mr(e);const s=i[0],r=i[1];if(!(s instanceof Wa))throw new Br(e,"ptr");if(s.$ast.getType().typeId===Ee.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Ir(e,"value");return t.$callFunctionNoCheck(e,[new va(s.$ast),new ga(r,Be)],Be)}if(r instanceof Wa){if(r.$ast.getType().typeId!==Be.typeId)throw new Br(e,"value");return t.$callFunctionNoCheck(e,[new va(s.$ast),r.$ast],Be)}throw new Br(e,"value")}if(s.$ast.getType().typeId===Me.typeId){if("number"==typeof r){if(!Number.isInteger(r))throw new Ir(e,"value");return t.$callFunctionNoCheck(e,[new va(s.$ast),new ga(r,Re)],Re)}if(r instanceof Wa){if(r.$ast.getType().typeId!==Re.typeId)throw new Br(e,"value");return t.$callFunctionNoCheck(e,[new va(s.$ast),r.$ast],Re)}throw new Br(e,"value")}throw new Ir(e,"ptr must be atomic type")}};const hn={rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",rgba8uint:"rgba8ui",rgba8sint:"rgba8i",rgba16uint:"rgba16ui",rgba16sint:"rgba16i",rgba16float:"rgba16f",r32float:"r32f",r32uint:"r32ui",r32sint:"r32i",rg32float:"rg32f",rg32uint:"rg32ui",rg32sint:"rg32i",rgba32float:"rgba32f",rgba32uint:"rgba32ui",rgba32sint:"rgba32i"};function ln(t,...e){if("webgl"===this.getDevice().type){if(t.scalarType===te.U32)throw new Fr("unsigned integer type");if(t.isMatrixType()&&t.cols!==t.rows)throw new Fr("non-square matrix type")}if(1===e.length&&"string"==typeof e[0])return new Wa(e[0],t);{const i=new Wa("",t);return!t.isScalarType()||1!==e.length||"number"!=typeof e[0]&&"boolean"!=typeof e[0]?i.$ast=new _a(i.$typeinfo,e.map(t=>{if("string"==typeof t)throw new Br("vec_n");return t instanceof Wa?t.$ast:t})):i.$ast=new ga(e[0],t),i}}const un={float:we,int:Be,uint:Re,bool:Le,vec2:Se,ivec2:Ie,uvec2:Fe,bvec2:ze,vec3:Ae,ivec3:Pe,uvec3:De,bvec3:Ve,vec4:Ce,ivec4:$e,uvec4:Ne,bvec4:Oe,mat2:ke,mat2x3:Ue,mat2x4:Ge,mat3x2:He,mat3:We,mat3x4:Xe,mat4x2:je,mat4x3:Qe,mat4:qe},cn={tex1D:Ye,tex2D:Je,tex3D:ai,texCube:hi,tex2DShadow:Ps,texCubeShadow:Rs,tex2DArray:ii,tex2DArrayShadow:$s,texExternal:ci,itex1D:Ze,itex2D:ti,itex3D:ni,itexCube:li,itex2DArray:si,utex1D:Ke,utex2D:ei,utex3D:oi,utexCube:ui,utex2DArray:ri,sampler:Ns,samplerComparison:Ls};const dn={texStorage1D:he.TEX_STORAGE_1D,texStorage2D:he.TEX_STORAGE_2D,texStorage2DArray:he.TEX_STORAGE_2D_ARRAY,texStorage3D:he.TEX_STORAGE_3D};const pn="zVSInput_",mn="zVSOutput_";class fn{_device;_workgroupSize;_scopeStack=[];_shaderType=Xt.Vertex|Xt.Fragment|Xt.Compute;_structInfo;_uniforms;_globalScope;_builtinScope;_inputScope;_outputScope;_inputs;_outputs;_vertexAttributes;_depthRangeCorrection;_emulateDepthClamp;_lastError;_reflection;_autoStructureTypeIndex;_nameMap;constructor(t){this._device=t,this._workgroupSize=null,this._structInfo={},this._uniforms=[],this._scopeStack=[],this._globalScope=null,this._builtinScope=null,this._inputScope=null,this._outputScope=null,this._inputs=[],this._outputs=[],this._vertexAttributes=[],this._depthRangeCorrection="webgpu"===t.type,this._emulateDepthClamp=!1,this._lastError=null,this._reflection=new Tr(this),this._autoStructureTypeIndex=0,this._nameMap=[]}get lastError(){return this._lastError}get shaderType(){return this._shaderType}get shaderKind(){return this._shaderType===Xt.Vertex?"vertex":this._shaderType===Xt.Fragment?"fragment":this._shaderType===Xt.Compute?"compute":null}getGlobalScope(){return this._globalScope}get builtinScope(){return this._builtinScope}get inputScope(){return this._inputScope}get outputScope(){return this._outputScope}get depthRangeCorrection(){return this._depthRangeCorrection}get emulateDepthClamp(){return this._emulateDepthClamp}set emulateDepthClamp(t){this._emulateDepthClamp=t}getReflection(){return this._reflection}getDevice(){return this._device}reset(){this._workgroupSize=null,this._structInfo={},this._uniforms=[],this._scopeStack=[],this._globalScope=null,this._builtinScope=null,this._inputScope=null,this._outputScope=null,this._inputs=[],this._outputs=[],this._vertexAttributes=[],this._depthRangeCorrection="webgpu"===this._device.type,this._reflection=new Tr(this),this._autoStructureTypeIndex=0,this._nameMap=[]}queryGlobal(t){return this.getReflection().tag(t)}pushScope(t){this._scopeStack.unshift(t)}popScope(){return this._scopeStack.shift()}getCurrentScope(){return this._scopeStack[0]}getCurrentFunctionScope(){let t=this.getCurrentScope();for(;t&&!(t instanceof wn);)t=t.$parent;return t}buildRender(t){Vr(this),this._lastError=null,this.defineInternalStructs();const e=this.buildRenderSource(t);return Vr(null),this.reset(),e}buildCompute(t){Vr(this),this._lastError=null,this._workgroupSize=t.workgroupSize,this.defineInternalStructs();const e=this.buildComputeSource(t);return Vr(null),this.reset(),e}buildRenderProgram(t){const e=this.buildRender(t);return e?this._device.createGPUProgram({type:"render",label:t.label,params:{vs:e[0],fs:e[1],bindGroupLayouts:e[2],vertexAttributes:e[3]}}):null}buildComputeProgram(t){const e=this.buildCompute(t);return e?this._device.createGPUProgram({type:"compute",params:{source:e[0],bindGroupLayouts:e[1]}}):null}func(t,e,i){this.getGlobalScope().$createFunctionIfNotExists(t,e,i)}main(t){this.getGlobalScope().$mainFunc(t)}addressOf(t){if("webgpu"!==this._device.type)throw new Fr("pointer shader type");if(!t.$ast.isReference())throw new $r(t);const e=new Wa("",t.$ast.getType());return e.$ast=new va(t.$ast),e}referenceOf(t){if("webgpu"!==this._device.type)throw new Fr("pointer shader type");if(!t.$ast.getType().isPointerType())throw new Rr(t);const e=new ya(t.$ast),i=new Wa("",e.getType());return i.$ast=e,i}struct(t,e){let i=null;for(const e of[Xt.Vertex,Xt.Fragment,Xt.Compute])if(e&this._shaderType){const s=this._structInfo[e];if(i=s?.structs[t],i)break}if(!i)throw new Ir("struct","structName",`Struct type ${t} not exists`);return i.call(this,e)}isIdenticalStruct(t,e,i){if(i&&t.structName&&e.structName&&t.structName!==e.structName)return!1;if(t.structMembers.length!==e.structMembers.length)return!1;for(let i=0;i<t.structMembers.length;i++){const s=t.structMembers[i],r=e.structMembers[i];if(s.name!==r.name)return!1;if(s.type.isStructType()){if(!r.type.isStructType())return!1;if(!this.isIdenticalStruct(s.type,r.type,!0))return!1}else if(!s.type.isCompatibleType(r.type))return!1}return!0}generateStructureName(){return"zStruct"+this._autoStructureTypeIndex++}getVertexAttributes(){return this._vertexAttributes}defineHiddenStruct(t){for(const e of[Xt.Vertex,Xt.Fragment,Xt.Compute]){let i=this._structInfo[e];if(i||(i={structs:{},types:[]},this._structInfo[e]=i),i.structs[t.structName])throw new Ir("defineStruct","structName",`cannot re-define struct '${t.structName}'`);i.types.push(new Va(t,!0))}}defineStruct(t,e){const i="default",s=new ge(e??"",i,t.map(t=>{if(!(t.$typeinfo.isPrimitiveType()||t.$typeinfo.isArrayType()||t.$typeinfo.isStructType()||t.$typeinfo.isAtomicI32()||t.$typeinfo.isAtomicU32()))throw new Error(`invalid struct member type: '${t.$str}'`);return{name:t.$str,type:t.$typeinfo}}));for(const t of[Xt.Vertex,Xt.Fragment,Xt.Compute]){let e=null,r=null;const a=this._structInfo[t];if(a){if(Or().shaderType===t&&a.structs[s.structName])throw new Ir("defineStruct","structName",`cannot re-define struct '${s.structName}'`);for(const t of a.types)if(!t.builtin&&this.isIdenticalStruct(t.getType(),s,!1)){e=t,r=a.structs[t.getType().structName];break}}if(e){if(e.type.layout!==i)throw new Error(`Can not redefine struct ${e.type.structName} with different layout`);return t!==Or().shaderType&&(this._structInfo[Or().shaderType]||(this._structInfo[Or().shaderType]={structs:{},types:[]}),this._structInfo[Or().shaderType].types.indexOf(e)<0&&(this._structInfo[Or().shaderType].types.push(e),this._structInfo[Or().shaderType].structs[e.getType().structName]=r)),r}}return this.internalDefineStruct(e??this.generateStructureName(),i,this._shaderType,!1,...t)}defineStructByType(t){const e=t.extends(t.structName||this.generateStructureName(),[]);for(const t of[Xt.Vertex,Xt.Fragment,Xt.Compute]){let i=null,s=null;const r=this._structInfo[t];if(r){if(Or().shaderType===t&&r.structs[e.structName])throw new Ir("defineStruct","structName",`cannot re-define struct '${e.structName}'`);for(const t of r.types)if(!t.builtin&&this.isIdenticalStruct(t.getType(),e,!1)){i=t,s=r.structs[t.getType().structName];break}}if(i){if(i.type.layout!==e.layout)throw new Error(`Can not redefine struct ${i.type.structName} with different layout`);return t!==Or().shaderType&&(this._structInfo[Or().shaderType]||(this._structInfo[Or().shaderType]={structs:{},types:[]}),this._structInfo[Or().shaderType].types.push(i),this._structInfo[Or().shaderType].structs[i.getType().structName]=s),s}}return this.internalDefineStructByType(this._shaderType,!1,e)}internalDefineStruct(t,e,i,s,...r){const a=new ge(t,e,r.map(t=>{if(!(t.$typeinfo.isPrimitiveType()||t.$typeinfo.isArrayType()||t.$typeinfo.isStructType()||t.$typeinfo.isAtomicI32()||t.$typeinfo.isAtomicU32()))throw new Error(`invalid struct member type: '${t.$str}'`);return{name:t.$str,type:t.$typeinfo}}));return this.internalDefineStructByType(i,s,a)}internalDefineStructByType(t,e,i){const s=Ua(function(...t){let e;return 1===t.length&&"string"==typeof t[0]?e=new Wa(t[0],i):(e=new Wa("",i),e.$ast=new _a(e.$typeinfo,t.map(t=>t instanceof Wa?t.$ast:t))),e},i);for(const r of[Xt.Vertex,Xt.Fragment,Xt.Compute])if(t&r){let t=this._structInfo[r];if(t||(t={structs:{},types:[]},this._structInfo[r]=t),t.structs[i.structName])throw new Ir("defineStruct","structName",`cannot re-define struct '${i.structName}'`);t.types.push(new Va(i,e)),t.structs[i.structName]=s}return s}getFunction(t){return this._globalScope?this._globalScope.$getFunctions(t):null}get structInfo(){return this._structInfo[this._shaderType]}getBlockName(t){return`ch_block_name_${t}`}defineBuiltinStruct(t,e){const i="in"===e?Zr(t):function(t){switch(t){case Xt.Vertex:return Ur;case Xt.Fragment:return Hr;case Xt.Compute:return"zCSOutput";default:return null}}(t),s="in"===e?qr(t):Yr(t),r=t===Xt.Vertex?"vertex":t===Xt.Fragment?"fragment":"compute",a=Jr.webgpu,n=[],o=[];for(const t in a)a[t].stage===r&&a[t].inOrOut===e&&(n.push({name:a[t].name,type:a[t].type}),o.push(`@builtin(${a[t].semantic}) `));const h="in"===e?this._inputs:this._outputs;for(const t of h){if(!(t[1]instanceof Ra))throw new Lr("defineBuiltinStruct() failed: input/output is not declare var ast node");const e=t[1].value.getType();if(!e.isPrimitiveType()&&!e.isArrayType()&&!e.isStructType())throw new Error(`invalid in/out variable type: '${t[1].value.name}'`);n.push({name:t[1].value.name,type:e}),o.push(`@location(${t[1].value.value.$location}) ${e.isPrimitiveType()&&e.isInteger()?"@interpolate(flat) ":""}`)}if(n.length>0){const r=this.findStructType(i,t);if(r)return r.getType().reset(i,"default",n),r.prefix=o,null;{const r=this.internalDefineStructByType(this._shaderType,!1,new ge(i,"default",n));this.findStructType(i,t).prefix=o;const a=this.struct(i,s);return[r,a,i,"in"===e?this.struct(i,Qr(t)):a]}}return null}defineInternalStructs(){this.defineHiddenStruct(Vs),this.defineHiddenStruct(Os),this.defineHiddenStruct(ks),this.defineHiddenStruct(Us)}array(...t){if(0===t.length)throw new Mr("array");t=t.map(t=>this.normalizeExpValue(t));let e=!0,i=null,s=!0,r=!0,a=!0,n=!0,o=!1;for(const s of t)if(s instanceof Wa){const t=s.$ast.getType();if(!t.isConstructible()){e=!1;break}i?t.isCompatibleType(i)||(e=!1):i=t}if(e){i&&i.isPrimitiveType()&&i.isScalarType()?(s=i.primitiveType===te.BOOL,r=i.primitiveType===te.F32,n=i.primitiveType===te.U32,a=i.primitiveType===te.I32):i&&(s=!1,r=!1,n=!1,a=!1,o=!0);for(const i of t){if(!(i instanceof Wa)&&o){e=!1;break}"number"==typeof i?(s=!1,(0|i)===i&&(i<0?(n=!1,a=a&&i>=-2147483648):(n=n&&i<=4294967295,a=a&&i<=2147483647))):"boolean"==typeof i&&(r=!1,a=!1,n=!1)}}if(e&&!o&&(s?i=Le:a?i=Be:n?i=Re:r&&(i=we),e=!!i),!e)throw new Br("array");if(!i.isPrimitiveType()&&!i.isArrayType()&&!i.isStructType())throw new Br("array");const h=new xe(i,t.length),l=new Wa("",h);return l.$ast=new _a(h,t.map(t=>{if(t instanceof Wa)return t.$ast;if(!i.isPrimitiveType()||!i.isScalarType())throw new Er(t,typeof t,i);return new ga(t,i)})),l}discard(){this.getCurrentScope().$ast.statements.push(new Ma)}tagShaderExp(t,e){if("string"==typeof e)this._reflection.tag(e,t);else if(Array.isArray(e))e.forEach(e=>this.tagShaderExp(t,e));else for(const i of Object.keys(e))this.tagShaderExp(e=>t(e)[i],e[i])}in(t,e,i){this._inputs[t]?this._inputScope[e]||Object.defineProperty(this._inputScope,e,{get:function(){return i},set:function(){throw new Error(`cannot assign to readonly variable: ${e}`)}}):(i.$location=t,i.$declareType=Xr.DECLARE_TYPE_IN,this._inputs[t]=[e,new Ra(new ua(i))],Object.defineProperty(this._inputScope,e,{get:function(){return i},set:function(){throw new Error(`cannot assign to readonly variable: ${e}`)}}),i.$tags.forEach(t=>this.tagShaderExp(()=>i,t)))}out(t,e,i){if(this._outputs[t])throw new Error(`output location ${t} has already been used`);i.$location=t,i.$declareType=Xr.DECLARE_TYPE_OUT,this._outputs[t]=[e,new Ra(new ua(i))];for(const s of[e,String(t)])Object.defineProperty(this._outputScope,s,{get:function(){return i},set:function(t){Or().getCurrentScope().$ast.statements.push(new Ea(new da(i.$ast),t instanceof Wa?t.$ast:t))}})}getDefaultSampler(t,e){const i=this._uniforms.findIndex(e=>e.texture?.exp===t);if(i<0)return;const s=e?"comparison":"sample";if(this._uniforms[i].texture.autoBindSampler&&this._uniforms[i].texture.autoBindSampler!==s)throw new Error("multiple sampler not supported");if(this._uniforms[i].texture.autoBindSampler=s,"webgpu"===this._device.type){const i=Kr(t.$str,e);if(!this.getGlobalScope()[i])throw new Error(`failed to find sampler name ${i}`);return this.getGlobalScope()[i]}return null}normalizeExpValue(t){if(Array.isArray(t)){const e=t.map(t=>Array.isArray(t)?this.normalizeExpValue(t):t);return this.array(...e)}return t}guessExpValueType(t){const e=this.normalizeExpValue(t);if("boolean"==typeof e)return Le;if("number"==typeof e){if(Number.isInteger(e)){if(e>=-1073741824&&e<=2147483647)return Be;if(e>=0&&e<=4294967295)return Re;throw new Cr(e)}return we}return e instanceof Wa?e.$ast?.getType()||e.$typeinfo:void 0}findStructType(t,e){for(const i of[Xt.Vertex,Xt.Fragment,Xt.Compute])if(i&e){const e=this._structInfo[i];if(e)for(const i of e.types)if(i.type.structName===t)return i}return null}findStructConstructor(t,e){for(const i of[Xt.Vertex,Xt.Fragment,Xt.Compute])if(i&e){const e=this._structInfo[i];if(e&&e.structs?.[t])return e.structs[t]}return null}buildComputeSource(t){try{return this._lastError=null,this._shaderType=Xt.Compute,this._scopeStack=[],this._globalScope=new yn,this._builtinScope=new xn,this._inputs=[],this._outputs=[],this._inputScope=new bn,this._outputScope=new vn,this._reflection.clear(),this.generate(t.compute),this.mergeUniformsCompute(this._globalScope),this.updateUniformBindings([this._globalScope],[Xt.Compute]),[this.generateComputeSource(this._globalScope,this._builtinScope),this.createBindGroupLayouts(t.label)]}catch(t){return t instanceof Ar?(this._lastError=t.getMessage(this._device.type),console.error(this._lastError),null):t instanceof Error?(this._lastError=t.toString(),console.error(this._lastError),null):(this._lastError=Object.prototype.toString.call(t),console.error(`Error: ${this._lastError}`),null)}}buildRenderSource(t){try{this._lastError=null,this._shaderType=Xt.Vertex,this._scopeStack=[],this._globalScope=new yn,this._builtinScope=new xn,this._inputs=[],this._outputs=[],this._inputScope=new bn,this._outputScope=new vn,this._reflection.clear(),this.generate(t.vertex);const e=this._globalScope,i=this._builtinScope,s=this._inputs,r=this._outputs;this._shaderType=Xt.Fragment,this._scopeStack=[],this._globalScope=new yn,this._builtinScope=new xn,this._inputs=[],this._outputs=[],this._inputScope=new bn,this._outputScope=new vn,this._reflection.clear(),r.forEach((t,e)=>{this.in(e,t[0],new Wa(t[1].value.name,t[1].value.getType()).tag(...t[1].value.value.$tags))}),this.generate(t.fragment);const a=this._globalScope,n=this._builtinScope,o=this._inputs,h=this._outputs;return this.mergeUniforms(e,a),this.updateUniformBindings([e,a],[Xt.Vertex,Xt.Fragment]),[this.generateRenderSource(Xt.Vertex,e,i,s.map(t=>t[1]),r.map(t=>t[1])),this.generateRenderSource(Xt.Fragment,a,n,o.map(t=>t[1]),h.map(t=>t[1])),this.createBindGroupLayouts(t.label),this._vertexAttributes]}catch(t){return t instanceof Ar?(this._lastError=t.getMessage(this._device.type),console.error(this._lastError),null):t instanceof Error?(this._lastError=t.toString(),console.error(this._lastError),null):(this._lastError=Object.prototype.toString.call(t),console.error(`Error: ${this._lastError}`),null)}}generate(t){this.pushScope(this._globalScope),this._emulateDepthClamp&&this._shaderType===Xt.Vertex&&(this._globalScope.$outputs.clamppedDepth=this.float().tag("CLAMPPED_DEPTH")),t?.call(this._globalScope,this),this.popScope(),this._globalScope.$ast.statements=[...this._globalScope.$ast.statements.filter(t=>t instanceof Ra||t instanceof Ea),...this._globalScope.$ast.statements.filter(t=>!(t instanceof Ra||t instanceof Ea))]}generateRenderSource(t,e,i,s,r){const a={type:t,mrt:t===Xt.Fragment&&r.length>1,defines:[],extensions:new Set,builtins:[...i.$_usedBuiltins],types:this._structInfo[t]?.types||[],typeReplacement:new Map,inputs:s,outputs:r,global:e,vertexAttributes:this._vertexAttributes,workgroupSize:null};switch(this._device.type){case"webgl":for(const t of this._uniforms)if(t.texture){const e=t.texture.exp.$ast.getType();if(e.isTextureType()&&e.isDepthTexture()){if("comparison"===t.texture.autoBindSampler)throw new Fr("depth texture comparison");"sample"===t.texture.autoBindSampler&&(e.is2DTexture()?a.typeReplacement.set(t.texture.exp,Je):e.isCubeTexture()&&a.typeReplacement.set(t.texture.exp,hi))}}return e.$ast.toWebGL("",a);case"webgl2":for(const t of this._uniforms)if(t.texture){const e=t.texture.exp.$ast.getType();e.isTextureType()&&e.isDepthTexture()&&"sample"===t.texture.autoBindSampler&&(e.is2DTexture()?a.typeReplacement.set(t.texture.exp,e.isArrayTexture()?ii:Je):e.isCubeTexture()&&a.typeReplacement.set(t.texture.exp,hi))}return e.$ast.toWebGL2("",a);case"webgpu":return e.$ast.toWGSL("",a);default:return null}}generateComputeSource(t,e){const i={type:Xt.Compute,mrt:!1,defines:[],extensions:new Set,builtins:[...e.$_usedBuiltins],types:this._structInfo[Xt.Compute]?.types||[],typeReplacement:null,inputs:[],outputs:[],global:t,vertexAttributes:[],workgroupSize:this._workgroupSize};return t.$ast.toWGSL("",i)}mergeUniformsCompute(t){const e=[];for(let t=0;t<this._uniforms.length;t++){const i=this._uniforms[t];if(i.block&&(i.block.exp.$declareType===Xr.DECLARE_TYPE_UNIFORM||i.block.exp.$declareType===Xr.DECLARE_TYPE_STORAGE)){if(i.block.exp.$typeinfo.isStructType()&&i.block.exp.$isBuffer)continue;e[i.group]||(e[i.group]=[]);const s=new Wa(i.block.exp.$str,i.block.exp.$ast.getType());s.$declareType=i.block.exp.$declareType,s.$isBuffer=i.block.exp.$isBuffer,s.$bindingSize=i.block.exp.$bindingSize,s.$readonly=i.block.exp.$readonly,e[i.group].push({member:s,uniform:t})}}for(const i in e)if(e[i].length>0){const s=["std140","std430"],r=["zUBC","zSBC"],a=[e[i].filter(t=>t.member.$declareType===Xr.DECLARE_TYPE_UNIFORM),e[i].filter(t=>t.member.$declareType===Xr.DECLARE_TYPE_STORAGE)];for(let e=0;e<2;e++){if(0===a[e].length)continue;const n=[a[e].filter(t=>!t.member.$isBuffer),...a[e].filter(t=>t.member.$isBuffer).map(t=>[t])];for(let a=0;a<n.length;a++){if(0===n[a].length)continue;const o=`${r[e]}_${i}_${a}`,h=this.generateStructureName(),l=Or().internalDefineStruct(h,s[e],Xt.Compute,!1,...n[a].map(t=>t.member)),u=!(e>0)||n[a].findIndex(t=>!t.member.$readonly)<0,c=l();0===e?c.uniformBuffer(Number(i),a>0?n[a][0].member.$bindingSize:0):(c.storageBuffer(Number(i),a>0?n[a][0].member.$bindingSize:0),c.$readonly=u),t[o]=c;const d=this._uniforms.findIndex(t=>t.block?.name===o);this._uniforms[d].mask=Xt.Compute;let p=this._nameMap[Number(i)];p||(p={},this._nameMap[Number(i)]=p);let m=!1;for(let t=n[a].length-1;t>=0;t--){const e=n[a][t],i=this._uniforms[e.uniform].block.exp;p[i.$str]=o,i.$str=`${o}.${i.$str}`,m||=i.$ast.isWritable()}m&&t[o].$ast.markWritable()}}}this._uniforms=this._uniforms.filter(t=>!t.block||t.block.exp.$typeinfo.isStructType()&&t.block.exp.$isBuffer)}mergeUniforms(t,e){const i=[],s=[],r=[];for(let t=0;t<this._uniforms.length;t++){const e=this._uniforms[t];if(e.block&&(e.block.exp.$declareType===Xr.DECLARE_TYPE_UNIFORM||e.block.exp.$declareType===Xr.DECLARE_TYPE_STORAGE)){if(e.block.exp.$typeinfo.isStructType()&&e.block.exp.$isBuffer)continue;const a=!!(e.mask&Xt.Vertex),n=!!(e.mask&Xt.Fragment);if(a&&n){r[e.group]||(r[e.group]=[]);const i=new Wa(e.block.exp.$str,e.block.exp.$ast.getType());i.$declareType=e.block.exp.$declareType,i.$isBuffer=e.block.exp.$isBuffer,i.$bindingSize=e.block.exp.$bindingSize,i.$readonly=e.block.exp.$readonly,r[e.group].push({member:i,uniform:t})}else if(a){i[e.group]||(i[e.group]=[]);const s=new Wa(e.block.exp.$str,e.block.exp.$ast.getType());s.$declareType=e.block.exp.$declareType,s.$isBuffer=e.block.exp.$isBuffer,s.$bindingSize=e.block.exp.$bindingSize,s.$readonly=e.block.exp.$readonly,i[e.group].push({member:s,uniform:t})}else if(n){s[e.group]||(s[e.group]=[]);const i=new Wa(e.block.exp.$str,e.block.exp.$ast.getType());i.$declareType=e.block.exp.$declareType,i.$isBuffer=e.block.exp.$isBuffer,i.$bindingSize=e.block.exp.$bindingSize,i.$readonly=e.block.exp.$readonly,s[e.group].push({member:i,uniform:t})}}}const a=[i,s,r],n=["zUBV","zUBF","zUBA"],o=["zSBV","zSBF","zSBA"],h=[Xt.Vertex,Xt.Fragment,Xt.Vertex|Xt.Fragment];for(let i=0;i<3;i++)for(const s in a[i])if(a[i][s]?.length>0){const r=[a[i][s].filter(t=>t.member.$declareType===Xr.DECLARE_TYPE_UNIFORM),a[i][s].filter(t=>t.member.$declareType===Xr.DECLARE_TYPE_STORAGE)],l=[n,o],u=["std140","std430"];for(let a=0;a<2;a++){if(0===r[a].length)continue;const n=[r[a].filter(t=>!t.member.$isBuffer),...r[a].filter(t=>t.member.$isBuffer).map(t=>[t])];for(let r=0;r<n.length;r++){if(0===n[r].length)continue;const o=`${l[a][i]}_${s}_${r}`,c=this.generateStructureName(),d=Or().internalDefineStruct(c,u[a],h[i],!1,...n[r].map(t=>t.member)),p=!(a>0)||n[r].findIndex(t=>!t.member.$readonly)<0;if(h[i]&Xt.Vertex){const e=d();if(a>0&&!p)throw new Error("Storage buffer in vertex shader must be read-only");0===a?e.uniformBuffer(Number(s),r>0?n[r][0].member.$bindingSize:0):(e.storageBuffer(Number(s),r>0?n[r][0].member.$bindingSize:0),e.$readonly=p),t[o]=e}if(h[i]&Xt.Fragment){const t=d();0===a?t.uniformBuffer(Number(s),r>0?n[r][0].member.$bindingSize:0):(t.storageBuffer(Number(s),r>0?n[r][0].member.$bindingSize:0),t.$readonly=p),e[o]=t}const m=this._uniforms.findIndex(t=>t.block?.name===o);this._uniforms[m].mask=h[i];let f=this._nameMap[Number(s)];f||(f={},this._nameMap[Number(s)]=f);let _=!1;for(let t=n[r].length-1;t>=0;t--){const e=n[r][t],i=this._uniforms[e.uniform].block.exp;f[i.$str]=o,i.$str=`${o}.${i.$str}`,_||=i.$ast.isWritable()}_&&(h[i]&Xt.Vertex?t[o].$ast.markWritable():e[o].$ast.markWritable())}}}this._uniforms=this._uniforms.filter(t=>!t.block||t.block.exp.$typeinfo.isStructType()&&t.block.exp.$isBuffer)}updateUniformBindings(t,e){this._uniforms=this._uniforms.filter(t=>!!t.mask);const i=Array.from({length:4}).fill(0);for(const t of this._uniforms)t.binding=i[t.group]++;for(let i=0;i<t.length;i++){const s=t[i],r=e[i];for(const t of this._uniforms)if(t.mask&r){const e=s.$ast.uniforms,i=t.block?t.block.name:t.texture?t.texture.exp.$str:t.sampler.$str,r=e.findIndex(t=>t.value.name===i);if(r<0)throw new Error(`updateUniformBindings() failed: unable to find uniform ${i}`);e[r].binding=t.binding}}}createBindGroupLayouts(t){const e=[],i=[0,0,0,0];for(const s of this._uniforms){let r=e[s.group];r||(r={label:`${t||"unknown"}[${s.group}]`,entries:[]},this._nameMap[s.group]&&(r.nameMap=this._nameMap[s.group]),e[s.group]=r);const a={binding:s.binding,visibility:s.mask,type:null,name:""};if(s.block){a.type=s.block.exp.$typeinfo.clone(this.getBlockName(s.block.name));const t=s.block.exp.$declareType===Xr.DECLARE_TYPE_STORAGE;a.buffer={type:t?s.block.exp.$readonly?"read-only-storage":"storage":"uniform",minBindingSize:s.block.bindingSize,hasDynamicOffset:!!s.block.bindingSize,uniformLayout:a.type.toBufferLayout(0,a.type.layout),dynamicOffsetIndex:s.block.bindingSize?i[s.group]++:-1},a.name=s.block.name}else if(s.texture){if(a.type=s.texture.exp.$typeinfo,!a.type.isTextureType())throw new Error("internal error");if(a.type.isStorageTexture()){let t;t=a.type.isArrayTexture()?a.type.isCubeTexture()?"cube-array":"2d-array":a.type.is3DTexture()?"3d":a.type.isCubeTexture()?"cube":a.type.is1DTexture()?"1d":"2d",a.storageTexture={access:"write-only",viewDimension:t,format:a.type.storageTexelFormat}}else if(a.type.isExternalTexture())a.externalTexture={autoBindSampler:s.texture.autoBindSampler?Kr(s.texture.exp.$str,!1):null};else{const t="webgpu"===this._device.type?s.texture.exp.$sampleType:s.texture.autoBindSampler&&a.type.isDepthTexture()?"float":s.texture.exp.$sampleType;let e;e=a.type.isArrayTexture()?a.type.isCubeTexture()?"cube-array":"2d-array":a.type.is3DTexture()?"3d":a.type.isCubeTexture()?"cube":a.type.is1DTexture()?"1d":"2d",a.texture={sampleType:t,viewDimension:e,multisampled:!1,autoBindSampler:null,autoBindSamplerComparison:null},"webgpu"!==this._device.type&&"sample"!==s.texture.autoBindSampler||(a.texture.autoBindSampler=Kr(s.texture.exp.$str,!1)),("webgpu"===this._device.type&&a.type.isDepthTexture()||"comparison"===s.texture.autoBindSampler)&&(a.texture.autoBindSamplerComparison=Kr(s.texture.exp.$str,!0))}a.name=s.texture.exp.$str}else{if(!s.sampler)throw new Lr("invalid uniform entry type");if(a.type=s.sampler.$typeinfo,!a.type.isSamplerType())throw new Error("internal error");a.sampler={type:a.type.accessMode===pe.SAMPLE?"float"===s.sampler.$sampleType?"filtering":"non-filtering":"comparison"},a.name=s.sampler.$str}r.entries.push(a)}for(let i=0;i<e.length;i++)e[i]||(e[i]={label:`${t||"unknown"}[${i}]`,entries:[]});return e}_getFunctionOverload(t,e){const i=e.filter(t=>{if(t instanceof Wa){const e=t.$ast.getType();if(e.isStructType()&&this._structInfo[this._shaderType]?.types.findIndex(t=>t.type.structName===e.structName)<0)return!1}return!0}),s=this.getGlobalScope().$getFunctions(t);return s?this._matchFunctionOverloading(s,i):null}_matchFunctionOverloading(t,e){for(const i of t){if(e.length!==i.funcType.argTypes.length)continue;const t=[];let s=!0;for(let r=0;r<e.length;r++){const a=i.funcType.argTypes[r],n=a.byRef&&a.type instanceof be?a.type.pointerType:a.type,o=e[r];if("boolean"==typeof o){if(!n.isPrimitiveType()||n.primitiveType!==te.BOOL){s=!1;break}t.push(new ga(o,Le))}else if("number"==typeof o){if(!n.isPrimitiveType()||!n.isScalarType()||n.scalarType===te.BOOL){s=!1;break}if(n.scalarType===te.I32){if(!Number.isInteger(o)||o<-2147483648||o>2147483647){s=!1;break}t.push(new ga(o,Be))}else if(n.scalarType===te.U32){if(!Number.isInteger(o)||o<0||o>4294967295){s=!1;break}t.push(new ga(o,Re))}else t.push(new ga(o,n))}else{if(!n.isCompatibleType(o.$ast.getType())){s=!1;break}t.push(o.$ast)}}if(s)return[i,t]}return null}$callFunction(t,e,i){if(this.getCurrentScope()===this.getGlobalScope())throw new Dr(t);const s=new Wa("",i.returnType);return s.$ast=new $a(t,e,i,Or().getDevice().type),this.getCurrentScope().$ast.statements.push(s.$ast),s}$callFunctionNoCheck(t,e,i){if(this.getCurrentScope()===this.getGlobalScope())throw new Dr(t);const s=new Wa("",i);return s.$ast=new $a(t,e,null,Or().getDevice().type,i),this.getCurrentScope().$ast.statements.push(s.$ast),s}}class _n extends Ga{$_variables;$_parentScope;$_AST;$_localScope;constructor(t,e){super(),this.$_parentScope=e||null,this.$_variables={},this.$_AST=t,this.$_localScope=null}get $builder(){return Or()}get $builtins(){return Or().builtinScope}get $inputs(){return Or().inputScope}get $outputs(){return Or().outputScope}get $parent(){return this.$_parentScope}get $ast(){return this.$_AST}set $ast(t){this.$_AST=t}$getVertexAttrib(t){return this.$inputs.$getVertexAttrib(t)}get $l(){return this.$_getLocalScope()}get $g(){return this.$_getGlobalScope()}$local(t,e){const i=Or().normalizeExpValue(e);t.$global=this instanceof yn,this.$_declare(t,i)}$touch(t){this.$ast.statements.push(new Aa(t.$ast))}$query(t){return this.$builder.getReflection().tag(t)}$_declareInternal(t,e){const i=t.$str;if(this.$_variables[i])throw new Error(`cannot re-declare variable '${i}'`);if(!(t.$ast instanceof ua))throw new Error(`invalid variable declaration: '${t.$ast.toString(Or().getDevice().type)}'`);const s=t.$typeinfo;if(s.isPointerType()){if(!e)throw new Error(`cannot declare pointer type variable without initialization: '${t.$str}'`);if(!(e instanceof Wa))throw new Error(`invalid initialization for pointer type declaration: '${t.$str}`);const i=e.$ast.getType();if(!i.isPointerType()||!s.pointerType.isCompatibleType(i.pointerType))throw new Error(`incompatible pointer type assignment: '${t.$str}'`);t.$typeinfo=i}if(this.$_registerVar(t,i),null==e)return new Ra(t.$ast);if(e instanceof Wa&&e.$ast instanceof _a&&0===e.$ast.args.length){if(!e.$ast.getType().isCompatibleType(t.$ast.getType()))throw new Er(e,e.$ast.getType(),t.$ast.getType());return new Ra(t.$ast)}return new Ea(new fa(t.$ast),e instanceof Wa?e.$ast:e)}$_findOrSetUniform(t){const e=t.$str,i={group:t.$group,binding:0,mask:0};t.$typeinfo.isTextureType()?i.texture={autoBindSampler:null,exp:t}:t.$typeinfo.isSamplerType()?i.sampler=t:i.block={name:e,bindingSize:t.$bindingSize,exp:t};let s=!1;for(const e of Or()._uniforms)if(e.group===i.group){if(i.block&&e.block&&e.block.name===i.block.name&&e.block.exp.$typeinfo.isCompatibleType(i.block.exp.$typeinfo)){e.mask|=Or().shaderType,t=e.block.exp,s=!0;break}if(i.texture&&e.texture&&i.texture.exp.$str===e.texture.exp.$str&&i.texture.exp.$typeinfo.isCompatibleType(e.texture.exp.$typeinfo)){e.mask|=Or().shaderType,t=e.texture.exp,s=!0;break}if(i.sampler&&e.sampler&&i.sampler.$str===e.sampler.$str&&i.sampler.$typeinfo.isCompatibleType(e.sampler.$typeinfo)){e.mask|=Or().shaderType,t=e.sampler,s=!0;break}}if(s||(i.mask=Or().shaderType,Or()._uniforms.push(i)),i.texture&&!i.texture.exp.$typeinfo.isStorageTexture()&&"webgpu"===Or().getDevice().type){const e=t.$typeinfo.isTextureType()&&t.$typeinfo.isDepthTexture(),s=Kr(t.$str,!1),r=Or().sampler(s).uniform(i.group).sampleType(t.$sampleType);if(r.$sampleType=t.$sampleType,this.$local(r),e){const e=Kr(t.$str,!0),s=Or().samplerComparison(e).uniform(i.group).sampleType(t.$sampleType);this.$local(s)}}return t}$_declare(t,e){if(this.$_variables[t.$str])throw new Nr(t.$ast,"cannot re-declare variable");if(t.$declareType===Xr.DECLARE_TYPE_UNIFORM||t.$declareType===Xr.DECLARE_TYPE_STORAGE){const e=t.$ast.name;if(!(this instanceof yn))throw new Error(`uniform or storage variables can only be declared within global scope: ${e}`);if(!(t.$declareType!==Xr.DECLARE_TYPE_UNIFORM||t.$typeinfo.isTextureType()||t.$typeinfo.isSamplerType()||t.$typeinfo.isConstructible()&&t.$typeinfo.isHostSharable()))throw new Nr(t.$ast,`type '${t.$typeinfo.toTypeName(Or().getDevice().type)}' cannot be declared in uniform address space`);if(t.$declareType===Xr.DECLARE_TYPE_STORAGE){if("webgpu"!==Or().getDevice().type)throw new Fr("storage buffer binding");if(!t.$typeinfo.isHostSharable())throw new Nr(t.$ast,`type '${t.$typeinfo.toTypeName(Or().getDevice().type)}' cannot be declared in storage address space`)}t=this.$_findOrSetUniform(t);const i=this.$_declareInternal(t);i.group=t.$group,i.binding=0,i.blockName=Or().getBlockName(e);const s=t.$typeinfo;(s.isStructType()&&t.$isBuffer||s.isTextureType()||s.isSamplerType()||s.isStructType()&&("std140"===s.detail.layout||"std430"===s.detail.layout))&&this.$ast.uniforms.push(i),t.$tags.forEach(e=>{Or().tagShaderExp(()=>t,e)})}else{const i=this.$_declareInternal(t,e);this.$ast.statements.push(i)}}$_registerVar(t,e){const i=e||t.$str,s={configurable:!0,get:function(){return t},set:function(e){Or().getCurrentScope().$ast.statements.push(new Ea(new da(t.$ast),e instanceof Wa?e.$ast:e))}};Object.defineProperty(this,i,s),this.$_variables[i]=t}$localGet(t){if("string"==typeof t&&("$"===t[0]||t in this))return this[t]}$localSet(t,e){return("$"===t[0]||t in this)&&(this[t]=e,!0)}$get(t){const e=this.$localGet(t);return void 0===e&&this.$_parentScope?this.$_parentScope.$thisProxy.$get(t):e}$set(t,e){if("$"===t[0])return this[t]=e,!0;{let i=this;for(;i&&!(t in i);)i=i.$_parentScope;if(i)return i[t]=e,!0;if(this.$l)return this.$l[t]=e,!0}return!1}$_getLocalScope(){return this.$_localScope||(this.$_localScope=new gn(this)),this.$_localScope}$_getGlobalScope(){return this.$builder.getGlobalScope()}}class gn extends _n{$_scope;constructor(t){super(null,null),this.$_scope=t}$get(t){return"$"===t[0]?this[t]:this.$_scope.$localGet(t)}$set(t,e){if("$"===t[0])return this[t]=e,!0;if(!(this.$_scope instanceof yn)&&e instanceof Wa&&(e.isConstructor()||e.$typeinfo.isTextureType()&&e.$ast instanceof ua&&!e.$ast.name)&&(e.$declareType===Xr.DECLARE_TYPE_UNIFORM||e.$declareType===Xr.DECLARE_TYPE_STORAGE))return this.$g[t]=e,!0;if(void 0===this.$_scope.$localGet(t)){const i=Or().guessExpValueType(e);if(i.isCompatibleType(zs))throw new Error(`Cannot assign void type to '${t}'`);const s=new Wa(t,i);return e instanceof Wa&&!this.$_scope.$parent&&(s.$declareType=e.$declareType,s.$isBuffer=e.$isBuffer,s.$bindingSize=e.$bindingSize,s.$readonly=e.$readonly,s.$group=e.$group,s.$attrib=e.$attrib,s.$sampleType=e.$sampleType,s.$precision=e.$precision,s.tag(...e.$tags)),this.$_scope.$local(s,e),!0}return this.$_scope.$localSet(t,e)}$_getLocalScope(){return this}}class xn extends _n{$_usedBuiltins;$_builtinVars;constructor(){super(null),this.$_usedBuiltins=new Set;if(!("webgpu"===Or().getDevice().type)){this.$_builtinVars={};const t=Jr[Or().getDevice().type];for(const e in t){const i=t[e];this.$_builtinVars[e]=new Wa(i.name,i.type)}}const t=Jr[Or().getDevice().type],e=this;for(const i of Object.keys(t))Object.defineProperty(this,i,{get:function(){return e.$getBuiltinVar(i)},set:function(t){if("number"!=typeof t&&!(t instanceof Wa))throw new Error("Invalid output value assignment");const s=e.$getBuiltinVar(i);Or().getCurrentScope().$ast.statements.push(new Ea(new da(s.$ast),t instanceof Wa?t.$ast:t))}})}$_getLocalScope(){return null}$getBuiltinVar(t){const e=Or();this.$_usedBuiltins.add(t);if("webgpu"===e.getDevice().type){const i=Jr[e.getDevice().type][t],s=i.inOrOut;if("in"===s)return e.getCurrentFunctionScope()[Qr(e.shaderType)][i.name];const r="in"===s?qr(e.shaderType):Yr(e.shaderType),a=e.getCurrentScope();if(!a[r]||!a[r][i.name])throw new Error(`invalid use of builtin variable ${t}`);return a[r][i.name]}return"webgl2"!==e.getDevice().type||"vertexIndex"!==t&&"instanceIndex"!==t?this.$_builtinVars[t]:e.uint(this.$_builtinVars[t])}}class bn extends _n{$_names;$_aliases;constructor(){super(null),this.$_names={},this.$_aliases={}}$getVertexAttrib(t){const e=this.$_names[t];return e?this[e]:null}$_getLocalScope(){return null}$get(t){if("$"===t[0])return this[t];this.$_aliases[t]&&(t=this.$_aliases[t]);const e=this.$builder;if("webgpu"===e.getDevice().type){const i=e.getCurrentFunctionScope()[Qr(e.shaderType)],s="vertex"===e.shaderKind?pn:mn,r=`${s}${t}`;if(i.$typeinfo.structMembers.findIndex(t=>t.name===r)<0)return;return i[`${s}${t}`]}return super.$get(t)}$set(t,e){if("$"===t[0])this[t]=e;else{if(!(e instanceof Wa))throw new Error("invalid vertex input value");const i=Or().shaderType;if(i!==Xt.Vertex)throw new Error(`shader input variables can only be declared in vertex shader: "${t}"`);const s=or(e.$attrib);if(void 0===s)throw new Error(`can not declare shader input variable: invalid vertex attribute: "${t}"`);if(Or()._vertexAttributes.indexOf(s)>=0){const i=this.$_names[e.$attrib];if(t!==i){if(this[i].$typeinfo.typeId!==e.$typeinfo.typeId)throw new Error(`can not declare shader input variable: attribute already declared with different type: "${t}"`);this.$_aliases[t]=i}return!0}if(!(e instanceof Wa&&e.$ast instanceof _a))throw new Error(`invalid shader input variable declaration: "${t}"`);const r=e.$ast.getType();if(!r.isPrimitiveType()||r.isMatrixType()||r.primitiveType===te.BOOL)throw new Error(`type cannot be used as pipeline input/output: ${t}`);this.$_names[e.$attrib]=t;const a=Or()._inputs.length,n=new Wa(`${pn}${t}`,r).tag(...e.$tags);Or().in(a,t,n),Or()._vertexAttributes.push(s),"webgpu"===Or().getDevice().type&&Or().findStructType(Zr(i),i)&&Or().defineBuiltinStruct(i,"in")}return!0}}class vn extends _n{constructor(){super(null)}$_getLocalScope(){return null}$set(t,e){if("$"===t[0])this[t]=e;else{const i=Or();if(!(t in this)){if(!(i.getCurrentScope()!==i.getGlobalScope()||e instanceof Wa&&e.$ast instanceof _a))throw new Error(`invalid shader output variable declaration: ${t}`);const s=e.$ast.getType();if(!s.isPrimitiveType()||s.isMatrixType()||s.primitiveType===te.BOOL)throw new Error(`type cannot be used as pipeline input/output: ${t}`);const r=i._outputs.length;if(i.out(r,t,new Wa(`${"vertex"===i.shaderKind?mn:"zFSOutput_"}${t}`,s).tag(...e.$tags)),"webgpu"===Or().getDevice().type){const t=Or().shaderType;Or().findStructType(Zr(t),t)&&Or().defineBuiltinStruct(t,"out")}}if(Or().getCurrentScope()!==Or().getGlobalScope()){const i=e.$ast;i instanceof _a&&!(i.args.length>0)||(this[t]=e)}}return!0}}class yn extends _n{$_inputStructInfo;constructor(){super(new la),this.$_inputStructInfo=null}get $inputStructInfo(){return this.$_inputStructInfo||(this.$_inputStructInfo=this.$builder.defineBuiltinStruct(this.$builder.shaderType,"in")),this.$_inputStructInfo}get $inputStruct(){return this.$inputStructInfo[0]}$mainFunc(t){const e=Or();if("webgpu"===e.getDevice().type){const i=this.$inputStructInfo,s=e.shaderType===Xt.Compute,r=s?null:e.defineBuiltinStruct(e.shaderType,"out");r&&this.$local(r[1]),this.$internalCreateFunction("main",i?[i[3]]:[],!0,function(){e.shaderType===Xt.Fragment&&e.emulateDepthClamp&&(this.$builtins.fragDepth=e.clamp(this.$inputs.clamppedDepth,0,1)),t?.call(this),e.shaderType===Xt.Vertex&&(e.depthRangeCorrection&&(this.$builtins.position.z=e.mul(e.add(this.$builtins.position.z,this.$builtins.position.w),.5)),e.emulateDepthClamp&&(this.$outputs.clamppedDepth=e.div(this.$builtins.position.z,this.$builtins.position.w),this.$builtins.position.z=0)),s||this.$return(r[1])})}else this.$internalCreateFunction("main",[],!0,function(){e.shaderType===Xt.Fragment&&e.emulateDepthClamp&&(this.$builtins.fragDepth=e.clamp(this.$inputs.clamppedDepth,0,1)),t?.call(this),e.shaderType===Xt.Vertex&&e.emulateDepthClamp&&(this.$outputs.clamppedDepth=e.div(e.add(e.div(this.$builtins.position.z,this.$builtins.position.w),1),2),this.$builtins.position.z=0)})}$createFunctionIfNotExists(t,e,i){this.$internalCreateFunction(t,e,!1,i)}$getFunctions(t){return this.$ast.findFunctions(t)}$getCurrentFunctionScope(){let t=Or().getCurrentScope();for(;t&&!(t instanceof wn);)t=t.$parent;return t}$internalCreateFunction(t,e,i,s){const r=Or();"webgpu"!==r.getDevice().type||i||e.push(this.$inputStruct(Qr(r.shaderType))),e.forEach(e=>{if(!(e.$ast instanceof ua))throw new Error(`${t}(): invalid function definition`);let i=e.$ast;e.$inout&&("webgpu"===Or().getDevice().type&&(e.$typeinfo=new be(e.$typeinfo,me.UNKNOWN)),i=new ya(e.$ast)),e.$ast=new na(i)});const a=this.$getFunctions(t),n=this.$getCurrentFunctionScope(),o=new Fa(t,e.map(t=>t.$ast),i,null,!1);if(n){const t=this.$ast.statements.indexOf(n.$ast);if(t<0)throw new Error("Internal error");this.$ast.statements.splice(t,0,o)}else this.$ast.statements.push(o);new wn(this,e,o,s),o.returnType||(o.returnType=zs),o.funcType=new Te(o.name,o.returnType,e.map(t=>{const e=t.$ast;return e.paramAST instanceof ya?{type:e.paramAST.value.getType(),byRef:e.paramAST instanceof ya}:{type:e.paramAST.getType(),byRef:!1}}));for(const e of a)if(e.funcType.argHash===o.funcType.argHash){if(e.returnType.isCompatibleType(o.returnType))return void this.$ast.statements.splice(this.$ast.statements.indexOf(o),1);throw new Error(`Invalid function overloading: ${t}`)}0===a.length&&Object.defineProperty(this,t,{get:function(){if(0===this.$getFunctions(t).length)throw new Error(`function ${t} not found`);return(...e)=>{let i=null;if("webgpu"===r.getDevice().type){let t=r.getCurrentScope();for(;t&&!(t instanceof wn);)t=t.$parent;const e=t.$ast.args;i=t[e[e.length-1].paramAST.name]}const s=(i?[...e,i]:e).map(t=>r.normalizeExpValue(t)),a=r._getFunctionOverload(t,s);if(!a)throw new Error(`ERROR: no matching overloads for function ${t}(${s.map(t=>t instanceof Wa?t.$ast?.getType()?.toTypeName()??"?":typeof t).join(", ")})`);return Or().$callFunction(t,a[1],a[0])}}})}}class Tn extends _n{constructor(t){super(new oa,t)}$return(t){const e=this.findOwnerFunction().$ast;let i=null;const s=Or().normalizeExpValue(t);if(null!=s)if("number"==typeof s){if(e.returnType&&e.returnType.isPrimitiveType()&&e.returnType.isScalarType()&&!e.returnType.isCompatibleType(Le)&&(i=e.returnType),!i)if(Number.isInteger(s))if(s<0){if(s<-2147483648)throw new Error(`function ${e.name}: invalid return value: ${s}`);i=Be}else{if(s>4294967295)throw new Error(`function ${e.name}: invalid return value: ${s}`);i=s<=2147483647?Be:Re}else i=we}else i="boolean"==typeof s?Le:s.$ast.getType();else i=zs;if(i.isPointerType())throw new Error("function can not return pointer type");if(e.returnType){if(!e.returnType.isCompatibleType(i))throw new Error(`function ${e.name}: return type must be ${e.returnType?.toTypeName(Or().getDevice().type)||"void"}`)}else e.returnType=i;let r=null;if(null!=s)if(s instanceof Wa)r=s.$ast;else{if(!i.isPrimitiveType()||!i.isScalarType())throw new Er(s,typeof s,i);r=new ga(s,i)}this.$ast.statements.push(new Pa(r))}$scope(t){const e=new ha;return this.$ast.statements.push(e),new En(this,e,t)}$if(t,e){const i=new Da("if",t instanceof Wa?t.$ast:new ga(t,"number"==typeof t?we:Le));return this.$ast.statements.push(i),new Mn(this,i,e)}$choice(t,e,i){const s=new Ca(t instanceof Wa?t.$ast:t,e instanceof Wa?e.$ast:e,i instanceof Wa?i.$ast:i),r=new Wa("",s.getType());return r.$ast=s,r}$break(){this.$ast.statements.push(new Ba)}$continue(){this.$ast.statements.push(new Ia)}$for(t,e,i,s,r,a){const n=t.$ast.getType();if(!n.isPrimitiveType()||!n.isScalarType())throw new Nr(t.$ast,"invalid for range initializer type");const o=e instanceof Wa?e.$ast:new ga(e,n);"function"==typeof s?(a=s,s=!0,r=!1):"function"==typeof r?(a=r,s=!!s,r=!1):(s=!!s,r=!!r);const h=new Na(t.$ast,o,i instanceof Wa?i.$ast:new ga(i,n),s,r);this.$ast.statements.push(h),new Cn(this,t,i,h,a)}$do(t){if("webgl"===this.$builder.getDevice().type)throw new Error("No do-while() loop support for WebGL1.0 device");const e=new La(null);return this.$ast.statements.push(e),new An(this,e,t)}$while(t,e){const i=new za(t instanceof Wa?t.$ast:new ga(t,"number"==typeof t?we:Le));this.$ast.statements.push(i),new Sn(this,i,e)}findOwnerFunction(){for(let t=this;t;t=t.$parent)if(t instanceof wn)return t;return null}$getMainScope(){for(let t=this;t;t=t.$parent)if(t instanceof wn&&t.$isMain())return t;return null}}class wn extends Tn{$typeinfo;constructor(t,e,i,s){super(t),this.$ast=i;for(const t of e){if(this.$_variables[t.$str])throw new Error("Duplicate function parameter name is not allowed");this.$_registerVar(t)}Or().pushScope(this),s?.call(this),Or().popScope()}$isMain(){return this.$ast.isMainFunc}}class Sn extends Tn{constructor(t,e,i){super(t),this.$ast=e,Or().pushScope(this),i?.call(this),Or().popScope()}}class An extends Tn{constructor(t,e,i){super(t),this.$ast=e,Or().pushScope(this),i?.call(this),Or().popScope()}$while(t){this.$ast.condition=t instanceof Wa?t.$ast:new ga(t,"number"==typeof t?we:Le)}}class Cn extends Tn{constructor(t,e,i,s,r){super(t),this.$ast=s,this.$_registerVar(e),Or().pushScope(this),r?.call(this),Or().popScope()}}class En extends Tn{constructor(t,e,i){super(t),this.$ast=e,Or().pushScope(this),i?.call(this),Or().popScope()}}class Mn extends Tn{constructor(t,e,i){super(t),this.$ast=e,Or().pushScope(this),i?.call(this),Or().popScope()}$elseif(t,e){const i=new Da("else if",t instanceof Wa?t.$ast:new ga(t,"number"==typeof t?we:Le));return this.$ast.nextElse=i,new Mn(this.$_parentScope,i,e)}$else(t){const e=new Da("else",null);this.$ast.nextElse=e,new Mn(this.$_parentScope,e,t)}}var Bn;!function(t){for(const e of Object.keys(on))t.prototype[e]=function(...t){return(on?.[e]?.normalizeFunc||Ya)(this,e,...t)}}(fn),Bn=fn,Object.keys(un).forEach(t=>{Bn.prototype[t]=Ua(function(...e){return ln.call(this,un[t],...e)},un[t])}),Object.keys(cn).forEach(t=>{Bn.prototype[t]=function(e){return new Wa(e,cn[t])}}),Object.keys(dn).forEach(t=>{Bn.prototype[t]=function(t){const e={};for(const i of Object.keys(hn))e[i]=function(e){return new Wa(e,new ye(t,hn[i]))};return e}(dn[t])}),Bn.prototype.atomic_int=Ua(function(...t){if(t.length>1)throw new Mr("atomic_int");if(1===t.length){if("string"!=typeof t[0])throw new Br("atomic_int","name");return new Wa(t[0],Ee)}{const t=new Wa("",Ee);return t.$ast=new _a(t.$typeinfo,[]),t}},Ee),Bn.prototype.atomic_uint=Ua(function(...t){if(t.length>1)throw new Mr("atomic_uint");if(1===t.length&&"string"==typeof t[0])return new Wa(t[0],Me);if(0===t.length){const t=new Wa("",Me);return t.$ast=new _a(t.$typeinfo,[]),t}const e=t[0];if("number"==typeof e&&Number.isInteger(e)||e instanceof Wa&&e.$ast.getType().typeId===Re.typeId){const t=new Wa("",Me);return t.$ast=new _a(t.$typeinfo,[e instanceof Wa?e.$ast:e]),t}return null},Me);class In{static _canvas=null;static _context=null;static get canvas(){return this._realize(),this._canvas}static get context(){return this._realize(),this._context}static get font(){return this.context.font}static set font(t){this.context.font=t}static _realize(){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=512,this._canvas.height=512,this._canvas.style.left="-10000px",this._canvas.style.position="absolute",this._context=this._canvas.getContext("2d",{willReadFrequently:!0}),this._context.textBaseline="top",this._context.textAlign="left",this._context.fillStyle="transparent",this._context.fillRect(0,0,this._canvas.width,this._canvas.height),this._context.fillStyle="#ffffff",this._context.imageSmoothingEnabled=!0,this._context.imageSmoothingQuality="high")}}class Pn{static fontCache={};_name;_nameScaled;_scale;_size;_family;_top;_bottom;_topScaled;_bottomScaled;_div;constructor(t,e){this._top=0,this._bottom=0,this._size=0,this._topScaled=0,this._bottomScaled=0,this._family="",this._scale=e,this._name=t,this._nameScaled=null,this._div=document.createElement("div"),this._name&&this._normalizeFont()}static fetchFont(t,e){let i=this.fontCache[t];i||(i={},this.fontCache[t]=i);let s=i[e];return s||(s=new Pn(t,e),i[e]=s),s}get fontName(){return this._name}set fontName(t){this._name=t,this._normalizeFont()}get fontNameScaled(){return this._nameScaled}get size(){return this._size}get family(){return this._family}get top(){return this._top}get bottom(){return this._bottom}get topScaled(){return this._topScaled}get bottomScaled(){return this._bottomScaled}get maxHeight(){return this._bottom-this._top+1}get maxHeightScaled(){return this._bottomScaled-this._topScaled+1}equalTo(t){return this._size===t._size&&this._family===t._family}_measureFontHeight(t){const e=In.context.font,i=In.context.textBaseline,s=In.context.fillStyle;In.context.font=t,this._div.style.font=In.context.font;const r=this._div.style.fontSize,a=parseInt(r.substring(0,r.length-2)),n=this._div.style.fontFamily,o="bdfghijklpq|_~",h=In.context.measureText(o);let l,u;l=0,u=a-1;const c=Math.ceil(h.width)+10,d=a+10;In.context.clearRect(0,0,c,d),In.context.textBaseline="top",In.context.fillStyle="#ffffff",In.context.fillText(o,5,5);const p=In.context.getImageData(0,0,c,d).data;for(let t=0;t<c*d;t++)if(p[4*t+3]>0){l=Math.floor(t/c);break}for(let t=c*d-1;t>=0;t--)if(p[4*t+3]>0){u=Math.floor(t/c);break}return l-=5,u-=5,In.context.font=e,In.context.textBaseline=i,In.context.fillStyle=s,{size:a,family:n,top:l,bottom:u}}_normalizeFont(){const t=this._measureFontHeight(this._name);this._nameScaled=`${Math.round(t.size*this._scale)}px ${t.family}`;const e=this._measureFontHeight(this._nameScaled);this._size=t.size,this._family=t.family,this._top=t.top,this._bottom=t.bottom,this._topScaled=e.top,this._bottomScaled=e.bottom}}class $n{static ATLAS_WIDTH=1024;static ATLAS_HEIGHT=1024;_packer;_device;_binWidth;_binHeight;_rectBorderWidth;_linearSpace;_atlasList;_atlasInfoMap;_atlasRestoreHandler;constructor(t,e,i,s,r){this._device=t,this._binWidth=e,this._binHeight=i,this._rectBorderWidth=s,this._linearSpace=!!r,this._packer=new ht(this._binWidth,this._binHeight),this._atlasList=[],this._atlasInfoMap={},this._atlasRestoreHandler=null}get atlasTextureRestoreHandler(){return this._atlasRestoreHandler}set atlasTextureRestoreHandler(t){this._atlasRestoreHandler=t}getAtlasTexture(t){return this._atlasList[t]}getAtlasInfo(t){return this._atlasInfoMap[t]||null}isEmpty(){return 0===this._atlasList.length}clear(){this._packer.clear();for(const t of this._atlasList)t.dispose();this._atlasList=[],this._atlasInfoMap={}}pushCanvas(t,e,i,s,r,a){const n=this._packer.insert(r+2*this._rectBorderWidth,a+2*this._rectBorderWidth);if(n){const o=n.x+this._rectBorderWidth,h=n.y+this._rectBorderWidth;this._updateAtlasTextureCanvas(n.binIndex,e,o,h,r,a,i,s);const l={atlasIndex:n.binIndex,uMin:o/this._binWidth,vMin:h/this._binHeight,uMax:(o+r)/this._binWidth,vMax:(h+a)/this._binHeight,width:r,height:a};return this._atlasInfoMap[t]=l,l}return null}pushBitmap(t,e){const i=this._packer.insert(e.width+2*this._rectBorderWidth,e.height+2*this._rectBorderWidth);if(i){const s=i.x+this._rectBorderWidth,r=i.y+this._rectBorderWidth;this._updateAtlasTexture(i.binIndex,e,s,r);const a={atlasIndex:i.binIndex,uMin:s/this._binWidth,vMin:r/this._binHeight,uMax:(s+e.width)/this._binWidth,vMax:(r+e.height)/this._binHeight,width:e.width,height:e.height};return this._atlasInfoMap[t]=a,a}return null}_createAtlasTexture(){const t=this._device.createTexture2D("rgba8unorm",this._binWidth,this._binHeight,{mipmapping:!1});return t.update(new Uint8Array(t.width*t.height*4),0,0,t.width,t.height),t.restoreHandler=()=>{t.update(new Uint8Array(t.width*t.height*4),0,0,t.width,t.height),this._atlasRestoreHandler?.(t)},t}_updateAtlasTextureCanvas(t,e,i,s,r,a,n,o){let h=null;t===this._atlasList.length?(h=this._createAtlasTexture(),this._atlasList.push(h)):h=this._atlasList[t],h.updateFromElement(e.canvas,i,s,n,o,r,a)}_updateAtlasTexture(t,e,i,s){let r=null;if(t===this._atlasList.length?(r=this._createAtlasTexture(),this._atlasList.push(r)):r=this._atlasList[t],e instanceof ImageBitmap)r.updateFromElement(e,i,s,0,0,e.width,e.height);else{const t=new Uint8Array(e.data.buffer);r.update(t,i,s,e.width,e.height)}}}class Rn extends $n{constructor(t,e,i,s){super(t,e,i,s,!0),this.atlasTextureRestoreHandler=async()=>{this.isEmpty()||this.clear()}}getGlyphInfo(t,e){if(!t||!e)return null;let i=this.getAtlasInfo(this._hash(t,e));return i||(i=this._cacheGlyph(t,e),i.width=Math.round(i.width*(e.maxHeight/e.maxHeightScaled)),i.height=e.maxHeight),i}measureStringWidth(t,e,i){let s=0;for(const r of t)s+=e+this.getCharWidth(r,i);return s}clipStringToWidth(t,e,i,s,r){let a=0,n=s;for(;n<t.length&&(a+=i+this.getCharWidth(t[n],r),!(a>e));n++);return n-s}getCharWidth(t,e){if(!e)return 0;In.font=e.fontNameScaled;const i=In.context.measureText(t);let s=i.width;return 0===s?0:("number"==typeof i.actualBoundingBoxRight&&(s=Math.floor(Math.max(s,i.actualBoundingBoxRight)+.8)),s=Math.round(s*(e.maxHeight/e.maxHeightScaled)),s)}_getGlyphBitmap(t,e){if(!e)return null;In.font=e.fontNameScaled;const i=In.context.measureText(t);let s=i.width;if(0===s)return null;"number"==typeof i.actualBoundingBoxRight&&(s=Math.floor(Math.max(s,i.actualBoundingBoxRight)+.8));const r=e.maxHeightScaled;return In.context.fillStyle="#fff",In.context.clearRect(0,0,s+2,r),In.context.fillText(t,0,-e.topScaled),In.context.getImageData(0,0,s,r)}_hash(t,e){return`${e.family}@${e.size}&${t}`}_cacheGlyph(t,e){const i=this._getGlyphBitmap(t,e);return this.pushBitmap(this._hash(t,e),i)}}class Fn{static GLYPH_COUNT=1024;static glyphManager=null;static prepared=!1;static textVertexBuffer=null;static textVertexLayout=null;static textProgram=null;static textBindGroup=null;static textRenderStates=null;static textOffset=0;static textMatrix=new W;static font=null;static vertexCache=null;static colorValue=new O;static calculateTextMatrix(t,e){const i=t.getViewport(),s=W.ortho(0,i.width,0,i.height,1,100),r=W.translation(new z(0,i.height,0)).scaleRight(new z(1,-1,1));W.multiply(s,r,e)}static setFont(t,e){this.font=Pn.fetchFont(e,t.getScale())||Pn.fetchFont("12px arial",t.getScale())}static drawText(e,i,s,r,a){if(i.length>0){e.pushDeviceStates(),this.prepareDrawText(e),this.calculateTextMatrix(e,this.textMatrix);const n=function(e){e=e.trim().toLowerCase();let i=null;if("#"===(e=t[e]||e)[0]){const t=(e.length-1)/3,s=[17,1,.062272][t-1];i={r:parseInt(e.substring(1,1+t),16)*s/255,g:parseInt(e.substring(1+t,1+2*t),16)*s/255,b:parseInt(e.substring(1+2*t,1+3*t),16)*s/255,a:1}}else{let t;(t=e.match(/^\s*rgb\s*\(\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\s*,\s*(\d\.?\d*)\s*\)\s*$/i))?i={r:Number(t[1])/255,g:Number(t[2])/255,b:Number(t[3])/255,a:1}:(t=e.match(/^\s*rgba\s*\(\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\s*,\s*([\d*.?\d*]+)\s*,\s*(\d*\.?\d*)\s*\)\s*$/i))&&(i={r:Number(t[1])/255,g:Number(t[2])/255,b:Number(t[3])/255,a:Number(t[4])})}if(!i||Number.isNaN(i.r)||Number.isNaN(i.g)||Number.isNaN(i.b)||Number.isNaN(i.a))throw new Error(`parseColor(): invalid color '${e}'`);return i.r=Math.pow(Math.min(1,i.r),2.2),i.g=Math.pow(Math.min(1,i.g),2.2),i.b=Math.pow(Math.min(1,i.b),2.2),i.a=Math.min(1,i.a),i}(s);this.colorValue.x=n.r,this.colorValue.y=n.g,this.colorValue.z=n.b,this.colorValue.w=n.a,this.textBindGroup.setValue("flip","webgpu"===e.type&&e.getFramebuffer()?1:0),this.textBindGroup.setValue("srgbOut",e.getFramebuffer()?0:1),this.textBindGroup.setValue("textMatrix",this.textMatrix),this.textBindGroup.setValue("textColor",this.colorValue),e.setProgram(this.textProgram),e.setVertexLayout(this.textVertexLayout),e.setRenderStates(this.textRenderStates),e.setBindGroup(0,this.textBindGroup);let o=0;const h=i.length;for(;o<h;){const t=Math.min(h-o,this.GLYPH_COUNT-this.textOffset);t>0&&(r=this.drawTextNoOverflow(e,i,o,t,r,a),o+=t,this.textOffset+=t),this.GLYPH_COUNT===this.textOffset&&(this.textOffset=0,e.flush())}e.popDeviceStates()}}static drawTextNoOverflow(t,e,i,s,r,a){let n=0,o=-1,h=0;for(;h<s;h++){const s=this.glyphManager.getGlyphInfo(e[h+i],this.font)||this.glyphManager.getGlyphInfo("?",this.font);o>=0&&s.atlasIndex!==o&&(this.textVertexBuffer.bufferSubData(16*(this.textOffset+n)*4,this.vertexCache,16*(this.textOffset+n),16*(h-n)),this.textBindGroup.setTexture("tex",this.glyphManager.getAtlasTexture(o)),t.draw("triangle-list",6*(this.textOffset+n),6*(h-n)),n=h),o=s.atlasIndex;const l=16*(this.textOffset+h);this.vertexCache[l+0]=r,this.vertexCache[l+1]=a,this.vertexCache[l+2]=s.uMin,this.vertexCache[l+3]=s.vMin,this.vertexCache[l+4]=r+s.width,this.vertexCache[l+5]=a,this.vertexCache[l+6]=s.uMax,this.vertexCache[l+7]=s.vMin,this.vertexCache[l+8]=r+s.width,this.vertexCache[l+9]=a+s.height,this.vertexCache[l+10]=s.uMax,this.vertexCache[l+11]=s.vMax,this.vertexCache[l+12]=r,this.vertexCache[l+13]=a+s.height,this.vertexCache[l+14]=s.uMin,this.vertexCache[l+15]=s.vMax,r+=s.width}return this.textVertexBuffer.bufferSubData(16*(this.textOffset+n)*4,this.vertexCache,16*(this.textOffset+n),16*(h-n)),this.textBindGroup.setTexture("tex",this.glyphManager.getAtlasTexture(o)),t.draw("triangle-list",6*(this.textOffset+n),6*(h-n)),r}static prepareDrawText(t){if(!this.prepared){this.prepared=!0,this.font=this.font||Pn.fetchFont("16px arial",t.getScale()),this.glyphManager=new Rn(t,1024,1024,1),this.vertexCache=new Float32Array(16*this.GLYPH_COUNT),this.textVertexBuffer=t.createInterleavedVertexBuffer(["position_f32x2","tex0_f32x2"],this.vertexCache,{dynamic:!0});const e=new Uint16Array(6*this.GLYPH_COUNT);for(let t=0;t<this.GLYPH_COUNT;t++){const i=4*t;e[6*t+0]=i+0,e[6*t+1]=i+1,e[6*t+2]=i+2,e[6*t+3]=i+0,e[6*t+4]=i+2,e[6*t+5]=i+3}const i=t.createIndexBuffer(e);this.textVertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:this.textVertexBuffer}],indexBuffer:i}),this.textOffset=0,this.textProgram=t.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.$inputs.uv=t.vec2().attrib("texCoord0"),this.$outputs.uv=t.vec2(),this.flip=t.int(0).uniform(0),this.textMatrix=t.mat4().uniform(0),t.main(function(){this.$builtins.position=t.mul(this.textMatrix,t.vec4(this.$inputs.pos,-50,1)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)}),this.$outputs.uv=this.$inputs.uv})},fragment(t){this.$outputs.color=t.vec4(),this.textColor=t.vec4().uniform(0),this.tex=t.tex2D().uniform(0),this.srgbOut=t.int().uniform(0),t.main(function(){this.alpha=t.mul(t.textureSample(this.tex,this.$inputs.uv).a,this.textColor.a),this.$if(t.notEqual(this.srgbOut,0),function(){this.$outputs.color=t.vec4(t.mul(t.pow(this.textColor.rgb,t.vec3(1/2.2)),this.alpha),this.alpha)}).$else(function(){this.$outputs.color=t.vec4(t.mul(this.textColor.rgb,this.alpha),this.alpha)})})}}),this.textProgram.name="@DrawText",this.textBindGroup=t.createBindGroup(this.textProgram.bindGroupLayouts[0]),this.textRenderStates=t.createRenderStateSet(),this.textRenderStates.useBlendingState().enable(!0).setBlendFuncRGB("one","inv-src-alpha").setBlendFuncAlpha("zero","one"),this.textRenderStates.useDepthState().enableTest(!1).enableWrite(!1),this.textRenderStates.useRasterizerState().setCullMode("none")}}}class Dn extends b{_canvas;_canvasClientWidth;_canvasClientHeight;_gpuObjectList;_gpuMemCost;_disposeObjectList;_beginFrameTime;_endFrameTime;_frameInfo;_cpuTimer;_gpuTimer;_runningLoop;_fpsCounter;_runLoopFunc;_backend;_beginFrameCounter;_programBuilder;_poolMap;_defaultPoolKey;_temporalFramebuffer;_vSync;_stateStack;constructor(t,e){super(),this._backend=e,this._gpuObjectList={textures:[],samplers:[],buffers:[],programs:[],framebuffers:[],vertexArrayObjects:[],bindGroups:[]},this._canvas=t,this._canvas.setAttribute("tabindex","1"),this._canvasClientWidth=t.clientWidth,this._canvasClientHeight=t.clientHeight,this._gpuMemCost=0,this._disposeObjectList=[],this._beginFrameTime=0,this._endFrameTime=0,this._runLoopFunc=null,this._frameInfo={frameCounter:0,frameTimestamp:0,elapsedTimeCPU:0,elapsedTimeGPU:0,elapsedFrame:0,elapsedOverall:0,FPS:0,drawCalls:0,computeCalls:0,nextFrameCall:[],nextFrameCallNext:[]},this._programBuilder=new fn(this),this._cpuTimer=new vr,this._gpuTimer=null,this._runningLoop=null,this._fpsCounter={time:0,frame:0},this._stateStack=[],this._beginFrameCounter=0,this._poolMap=new Map,this._defaultPoolKey=Symbol("defaultPool"),this._poolMap.set(this._defaultPoolKey,new yr(this,this._defaultPoolKey)),this._temporalFramebuffer=!1,this._temporalFramebuffer=!1,this._vSync=!0,this._registerEventHandlers()}get backend(){return this._backend}get videoMemoryUsage(){return this._gpuMemCost}get frameInfo(){return this._frameInfo}get isRendering(){return null!==this._runningLoop}get canvas(){return this._canvas}get type(){return this._backend.typeName()}get vSync(){return this._vSync}set vSync(t){this._vSync=!!t}get pool(){return this._poolMap.get(this._defaultPoolKey)}get runLoopFunction(){return this._runLoopFunc}get programBuilder(){return this._programBuilder}poolExists(t){return this._poolMap.has(t)}getPool(t){let e=this._poolMap.get(t);return e||(e=new yr(this,t),this._poolMap.set(t,e)),e}setFont(t){Fn.setFont(this,t)}drawText(t,e,i,s){Fn.drawText(this,t,s,e,i)}setFramebuffer(t,e,i){let s=null,r=!1;Array.isArray(t)?(s=this.pool.fetchTemporalFramebuffer(!1,0,0,t,e,!0,i),r=!0):s=t??null;const a=this.getFramebuffer();a!==s&&(this._temporalFramebuffer&&this.pool.releaseFrameBuffer(a),this._temporalFramebuffer=r,this._setFramebuffer(s))}disposeObject(t,e=!0){t&&(e&&this.removeGPUObject(t),this.isContextLost()?t.destroy():this._disposeObjectList.push(t))}restoreObject(t){t&&t.disposed&&!this.isContextLost()&&(t.restore(),t.restoreHandler?.(t))}enableGPUTimeRecording(t){t&&!this._gpuTimer?this._gpuTimer=this.createGPUTimer():t||(this._gpuTimer?.end(),this._gpuTimer=null)}beginFrame(){if(0===this._beginFrameCounter){for(const t of this._disposeObjectList)t.destroy();this._disposeObjectList=[]}return this._beginFrameCounter++,this._beginFrameTime=this._cpuTimer.now(),this.updateFrameInfo(),this._poolMap.forEach(t=>t.autoRelease()),this.onBeginFrame()}endFrame(){this._beginFrameCounter>0&&(this._beginFrameCounter--,0===this._beginFrameCounter&&(this._endFrameTime=this._cpuTimer.now(),this._frameInfo.frameCounter++,this.onEndFrame()))}getVertexAttribFormat(t,e,i){return dr(t,e,i)}createInterleavedVertexBuffer(t,e,i){if(i&&i.usage&&"vertex"!==i.usage)return console.error("createInterleavedVertexBuffer() failed: options.usage must be 'vertex' or not set"),null;let s=0;for(const e of t)s+=cr(e);const r=fr(e.byteLength/s|0,...t),a=Object.assign({usage:"vertex",dynamic:!1,managed:!0,storage:!1},i||{});return a.storage&&(a.dynamic=!1,a.managed=!1),a.dynamic&&(a.managed=!1),this.createStructuredBuffer(r,a,e)}createVertexBuffer(t,e,i){if(i&&i.usage&&"vertex"!==i.usage)return console.error("createVertexBuffer() failed: options.usage must be 'vertex' or not set"),null;const s=cr(t),r=fr(e.byteLength/s|0,t),a=Object.assign({usage:"vertex",dynamic:!1,managed:!0,storage:!1},i||{});return a.storage&&(a.dynamic=!1,a.managed=!1),a.dynamic&&(a.managed=!1),this.createStructuredBuffer(r,a,e)}draw(t,e,i){this._frameInfo.drawCalls++,this._draw(t,e,i)}drawInstanced(t,e,i,s){this._frameInfo.drawCalls++,this._drawInstanced(t,e,i,s)}executeRenderBundle(t){this._frameInfo.drawCalls+=this._executeRenderBundle(t)}compute(t,e,i){this._frameInfo.computeCalls++,this._compute(t,e,i)}runNextFrame(t){t&&this._frameInfo.nextFrameCall.push(t)}async runNextFrameAsync(t){return new Promise(e=>{t?this._frameInfo.nextFrameCall.push(()=>{const i=t();i instanceof Promise?i.then(()=>e()):e()}):e()})}exitLoop(){null!==this._runningLoop&&(0!==this._runningLoop?cancelAnimationFrame(this._runningLoop):this.cancelNextFrame(this._runningLoop),this._runningLoop=null)}runLoop(t){if(null!==this._runningLoop)return void console.error("Device.runLoop() can not be nested");if(!t)return void console.error("Device.runLoop() argment error");const e=this;e._runLoopFunc=t,function t(){e._vSync?e._runningLoop=requestAnimationFrame(t):e._runningLoop=e.nextFrame(()=>{null!==e._runningLoop&&t()}),e.beginFrame()&&(e._runLoopFunc(e),e.endFrame())}()}pushDeviceStates(){this._stateStack.push({windowOrderReversed:this.isWindingOrderReversed(),framebuffer:this.getFramebuffer(),viewport:this.getViewport(),scissor:this.getScissor(),program:this.getProgram(),renderStateSet:this.getRenderStates(),vertexLayout:this.getVertexLayout(),bindGroups:[this.getBindGroup(0),this.getBindGroup(1),this.getBindGroup(2),this.getBindGroup(3)]})}popDeviceStates(){if(0===this._stateStack.length)console.error("Device.popDeviceStates(): stack is empty");else{const t=this._stateStack.pop();this.setFramebuffer(t.framebuffer),this.setViewport(t.viewport),this.setScissor(t.scissor),this.setProgram(t.program),this.setRenderStates(t.renderStateSet),this.setVertexLayout(t.vertexLayout),this.setBindGroup(0,...t.bindGroups[0]),this.setBindGroup(1,...t.bindGroups[1]),this.setBindGroup(2,...t.bindGroups[2]),this.setBindGroup(3,...t.bindGroups[3]),this.reverseVertexWindingOrder(t.windowOrderReversed)}}getGPUObjects(){return this._gpuObjectList}getGPUObjectById(t){for(const e of[this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.buffers,this._gpuObjectList.framebuffers,this._gpuObjectList.programs,this._gpuObjectList.vertexArrayObjects])for(const i of e)if(i.uid===t)return i;return null}screenToDevice(t){return this.getFramebuffer()?t:Math.round(t*this.getScale())}deviceToScreen(t){return this.getFramebuffer()?t:Math.round(t/this.getScale())}buildRenderProgram(t){return this._programBuilder.buildRenderProgram(t)}buildComputeProgram(t){return this._programBuilder.buildComputeProgram(t)}addGPUObject(t){const e=this.getGPUObjectList(t);e&&e.indexOf(t)<0&&(e.push(t),this.dispatchEvent("gpuobject_added",t))}removeGPUObject(t){const e=this.getGPUObjectList(t);if(e){const i=e.indexOf(t);i>=0&&(e.splice(i,1),this.dispatchEvent("gpuobject_removed",t))}}updateVideoMemoryCost(t){this._gpuMemCost+=t}_onresize(){this._canvasClientWidth===this._canvas.clientWidth&&this._canvasClientHeight===this._canvas.clientHeight||(this._canvasClientWidth=this._canvas.clientWidth,this._canvasClientHeight=this._canvas.clientHeight,this.dispatchEvent("resize",this._canvasClientWidth,this._canvasClientHeight))}_registerEventHandlers(){const t=this._canvas,e=this;window.ResizeObserver?new window.ResizeObserver(()=>{e._onresize()}).observe(t,{}):(window.MutationObserver&&new MutationObserver(function(t){t.length>0&&e._onresize()}).observe(t,{attributes:!0,attributeFilter:["style"]}),window.addEventListener("resize",()=>{this._onresize()}))}updateFrameInfo(){this._frameInfo.drawCalls=0,this._frameInfo.computeCalls=0;const t=this._beginFrameTime;if(0===this._frameInfo.frameTimestamp)this._frameInfo.frameTimestamp=t,this._frameInfo.elapsedTimeCPU=0,this._frameInfo.elapsedTimeGPU=0,this._frameInfo.elapsedFrame=0,this._frameInfo.elapsedOverall=0,this._frameInfo.FPS=0,this._fpsCounter.time=t,this._fpsCounter.frame=this._frameInfo.frameCounter,this._gpuTimer&&this._gpuTimer.begin();else{this._frameInfo.elapsedFrame=t-this._frameInfo.frameTimestamp,this._frameInfo.elapsedOverall+=this._frameInfo.elapsedFrame;let e=0,i=0;0!==this._endFrameTime&&(e=t-this._endFrameTime,i=this._endFrameTime-this._frameInfo.frameTimestamp),this._frameInfo.frameTimestamp=t,t>=this._fpsCounter.time+1e3&&(this._frameInfo.FPS=1e3*(this._frameInfo.frameCounter-this._fpsCounter.frame)/(t-this._fpsCounter.time),this._fpsCounter.time=t,this._fpsCounter.frame=this._frameInfo.frameCounter,this._frameInfo.elapsedTimeGPU=e,this._frameInfo.elapsedTimeCPU=i)}const e=this._frameInfo.nextFrameCall;this._frameInfo.nextFrameCall=this._frameInfo.nextFrameCallNext,this._frameInfo.nextFrameCallNext=e;for(const t of this._frameInfo.nextFrameCallNext)t();this._frameInfo.nextFrameCallNext.length=0}getGPUObjectList(t){let e=null;return t.isTexture()?e=this._gpuObjectList.textures:t.isSampler()?e=this._gpuObjectList.samplers:t.isBuffer()?e=this._gpuObjectList.buffers:t.isFramebuffer()?e=this._gpuObjectList.framebuffers:t.isProgram()?e=this._gpuObjectList.programs:t.isVertexLayout()?e=this._gpuObjectList.vertexArrayObjects:t.isBindGroup()&&(e=this._gpuObjectList.bindGroups),e}invalidateAll(){for(const t of[this._gpuObjectList.buffers,this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.programs,this._gpuObjectList.framebuffers,this._gpuObjectList.vertexArrayObjects,this._gpuObjectList.bindGroups])for(const e of t)this.disposeObject(e,!1);if(this.isContextLost()){for(const t of this._disposeObjectList)t.destroy();this._disposeObjectList=[]}}reloadAll(){for(const t of[this._gpuObjectList.buffers,this._gpuObjectList.textures,this._gpuObjectList.samplers,this._gpuObjectList.programs,this._gpuObjectList.framebuffers,this._gpuObjectList.vertexArrayObjects,this._gpuObjectList.bindGroups])for(const e of t.slice())e.reload()}parseTextureOptions(t){const e=!1===t?.mipmapping?nr.TF_NO_MIPMAP:0,i=t?.writable?nr.TF_WRITABLE:0,s=t?.dynamic?nr.DYNAMIC:0;return e&&t?.samplerOptions&&(t.samplerOptions.mipFilter="none"),e|i|s}parseBufferOptions(t,e){let i;switch(t?.usage||e){case"uniform":i=nr.BF_UNIFORM,t.managed=!1,t.dynamic=t.dynamic??!0;break;case"vertex":i=nr.BF_VERTEX;break;case"index":i=nr.BF_INDEX;break;case"read":i=nr.BF_READ,t.managed=!1;break;case"write":i=nr.BF_WRITE,t.managed=!1;break;case"pack-pixel":i=nr.BF_PACK_PIXEL,t.managed=!1;break;case"unpack-pixel":i=nr.BF_UNPACK_PIXEL,t.managed=!1;break;default:i=0}const s=t?.storage?nr.BF_STORAGE:0,r=t?.dynamic?nr.DYNAMIC:0;return i|s|r|(0===r&&(t?.managed??1)?nr.MANAGED:0)}}class Nn{_cache;_buffer;_size;_uniformMap;_uniformPositions;constructor(t,e){if(this._size=t.byteSize+15&-16,this._size<=0)throw new Error(`UniformBuffer(): invalid uniform buffer byte size: ${this._size}`);this._uniformMap={},this._uniformPositions={},this._cache=e instanceof ArrayBuffer?e:null,this._buffer=e instanceof ArrayBuffer?null:e,this.init(t,0,"")}get byteLength(){return this._size}get buffer(){return this._cache}get uniforms(){return this._uniformMap}set(t,e){if(void 0!==e){const i=this._uniformMap[t];if(i)if(this._cache)if("number"==typeof e)i[0]=e;else if(e?._v)i.set(e._v);else{if("number"!=typeof e?.length)throw new Error("invalid uniform value");i.set(e.length>i.length?e.subarray(0,i.length):e)}else{const s=this._uniformPositions[t][1];if("number"==typeof e)i[0]=e,this._buffer.bufferSubData(this._uniformPositions[t][0],i);else{if(!(e.BYTES_PER_ELEMENT&&s<=e.byteLength))throw new Error("invalid uniform value");{const i=e;this._buffer.bufferSubData(this._uniformPositions[t][0],i,0,s/i.BYTES_PER_ELEMENT|0)}}}else{if(Object.getPrototypeOf(e)!==Object.getPrototypeOf({}))throw new Error("invalid uniform value");this.setStruct(t,e)}}}setStruct(t,e){for(const i in e)this.set(`${t}.${i}`,e[i])}init(t,e,i){for(const s of t.entries)if(s.subLayout)e=this.init(s.subLayout,e,`${i}${s.name}.`);else{const t=`${i}${s.name}`;if(this._uniformPositions[t])throw new Error(`UniformBuffer(): duplicate uniform name: ${t}`);if(s.offset<e||s.byteSize<0)throw new Error("UniformBuffer(): invalid layout");this._uniformPositions[t]=[s.offset,s.byteSize];let r=null;switch(s.type){case te.F32:r=Float32Array;break;case te.U32:case te.BOOL:r=Uint32Array;break;case te.I32:r=Int32Array;break;case te.U16:case te.U16_NORM:case te.F16:r=Uint16Array;break;case te.I16:case te.I16_NORM:r=Int16Array;break;case te.U8:case te.U8_NORM:r=Uint8Array;break;case te.I8:case te.I8_NORM:r=Int8Array}if(!r)throw new Error(`UniformBuffer(): invalid data type for uniform: ${t}`);if(s.byteSize%r.BYTES_PER_ELEMENT)throw new Error(`UniformBuffer(): invalid byte size for uniform: ${t}`);this._cache?this._uniformMap[t]=new r(this._cache,s.offset,s.byteSize/r.BYTES_PER_ELEMENT):this._uniformMap[t]=new r(1),e=s.offset+s.byteSize}return e}}var Ln=function(t){return t[t.READ_BUFFER=3074]="READ_BUFFER",t[t.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",t[t.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",t[t.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",t[t.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",t[t.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",t[t.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",t[t.COLOR=6144]="COLOR",t[t.DEPTH=6145]="DEPTH",t[t.STENCIL=6146]="STENCIL",t[t.RED=6403]="RED",t[t.RGB8=32849]="RGB8",t[t.RGBA8=32856]="RGBA8",t[t.RGB10_A2=32857]="RGB10_A2",t[t.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",t[t.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",t[t.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",t[t.TEXTURE_3D=32879]="TEXTURE_3D",t[t.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",t[t.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",t[t.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",t[t.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",t[t.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",t[t.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",t[t.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",t[t.MIN=32775]="MIN",t[t.MAX=32776]="MAX",t[t.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",t[t.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",t[t.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",t[t.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",t[t.CURRENT_QUERY=34917]="CURRENT_QUERY",t[t.QUERY_RESULT=34918]="QUERY_RESULT",t[t.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",t[t.STREAM_READ=35041]="STREAM_READ",t[t.STREAM_COPY=35042]="STREAM_COPY",t[t.STATIC_READ=35045]="STATIC_READ",t[t.STATIC_COPY=35046]="STATIC_COPY",t[t.DYNAMIC_READ=35049]="DYNAMIC_READ",t[t.DYNAMIC_COPY=35050]="DYNAMIC_COPY",t[t.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",t[t.DRAW_BUFFER0=34853]="DRAW_BUFFER0",t[t.DRAW_BUFFER1=34854]="DRAW_BUFFER1",t[t.DRAW_BUFFER2=34855]="DRAW_BUFFER2",t[t.DRAW_BUFFER3=34856]="DRAW_BUFFER3",t[t.DRAW_BUFFER4=34857]="DRAW_BUFFER4",t[t.DRAW_BUFFER5=34858]="DRAW_BUFFER5",t[t.DRAW_BUFFER6=34859]="DRAW_BUFFER6",t[t.DRAW_BUFFER7=34860]="DRAW_BUFFER7",t[t.DRAW_BUFFER8=34861]="DRAW_BUFFER8",t[t.DRAW_BUFFER9=34862]="DRAW_BUFFER9",t[t.DRAW_BUFFER10=34863]="DRAW_BUFFER10",t[t.DRAW_BUFFER11=34864]="DRAW_BUFFER11",t[t.DRAW_BUFFER12=34865]="DRAW_BUFFER12",t[t.DRAW_BUFFER13=34866]="DRAW_BUFFER13",t[t.DRAW_BUFFER14=34867]="DRAW_BUFFER14",t[t.DRAW_BUFFER15=34868]="DRAW_BUFFER15",t[t.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",t[t.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",t[t.SAMPLER_3D=35679]="SAMPLER_3D",t[t.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",t[t.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",t[t.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",t[t.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",t[t.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",t[t.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",t[t.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",t[t.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",t[t.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",t[t.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",t[t.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",t[t.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",t[t.SRGB=35904]="SRGB",t[t.SRGB8=35905]="SRGB8",t[t.SRGB_ALPHA=35906]="SRGB_ALPHA",t[t.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",t[t.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",t[t.RGBA32F=34836]="RGBA32F",t[t.RGB32F=34837]="RGB32F",t[t.RGBA16F=34842]="RGBA16F",t[t.RGB16F=34843]="RGB16F",t[t.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",t[t.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",t[t.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",t[t.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",t[t.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",t[t.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",t[t.R11F_G11F_B10F=35898]="R11F_G11F_B10F",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.RGB9_E5=35901]="RGB9_E5",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",t[t.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",t[t.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",t[t.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",t[t.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",t[t.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",t[t.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",t[t.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",t[t.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",t[t.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",t[t.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",t[t.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",t[t.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",t[t.RGBA32UI=36208]="RGBA32UI",t[t.RGB32UI=36209]="RGB32UI",t[t.RGBA16UI=36214]="RGBA16UI",t[t.RGB16UI=36215]="RGB16UI",t[t.RGBA8UI=36220]="RGBA8UI",t[t.RGB8UI=36221]="RGB8UI",t[t.RGBA32I=36226]="RGBA32I",t[t.RGB32I=36227]="RGB32I",t[t.RGBA16I=36232]="RGBA16I",t[t.RGB16I=36233]="RGB16I",t[t.RGBA8I=36238]="RGBA8I",t[t.RGB8I=36239]="RGB8I",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",t[t.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",t[t.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",t[t.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",t[t.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",t[t.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",t[t.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",t[t.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",t[t.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",t[t.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",t[t.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",t[t.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",t[t.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",t[t.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",t[t.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",t[t.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",t[t.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",t[t.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",t[t.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",t[t.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",t[t.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",t[t.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",t[t.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",t[t.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",t[t.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",t[t.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",t[t.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",t[t.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",t[t.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",t[t.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",t[t.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",t[t.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",t[t.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",t[t.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",t[t.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",t[t.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",t[t.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",t[t.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",t[t.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",t[t.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",t[t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",t[t.MAX_SAMPLES=36183]="MAX_SAMPLES",t[t.HALF_FLOAT=36193]="HALF_FLOAT",t[t.RG=33319]="RG",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.R8=33321]="R8",t[t.RG8=33323]="RG8",t[t.R16F=33325]="R16F",t[t.R32F=33326]="R32F",t[t.RG16F=33327]="RG16F",t[t.RG32F=33328]="RG32F",t[t.R8I=33329]="R8I",t[t.R8UI=33330]="R8UI",t[t.R16I=33331]="R16I",t[t.R16UI=33332]="R16UI",t[t.R32I=33333]="R32I",t[t.R32UI=33334]="R32UI",t[t.RG8I=33335]="RG8I",t[t.RG8UI=33336]="RG8UI",t[t.RG16I=33337]="RG16I",t[t.RG16UI=33338]="RG16UI",t[t.RG32I=33339]="RG32I",t[t.RG32UI=33340]="RG32UI",t[t.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",t[t.R8_SNORM=36756]="R8_SNORM",t[t.RG8_SNORM=36757]="RG8_SNORM",t[t.RGB8_SNORM=36758]="RGB8_SNORM",t[t.RGBA8_SNORM=36759]="RGBA8_SNORM",t[t.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",t[t.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",t[t.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",t[t.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",t[t.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",t[t.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",t[t.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",t[t.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",t[t.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",t[t.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",t[t.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",t[t.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",t[t.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",t[t.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",t[t.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",t[t.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",t[t.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",t[t.UNIFORM_TYPE=35383]="UNIFORM_TYPE",t[t.UNIFORM_SIZE=35384]="UNIFORM_SIZE",t[t.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",t[t.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",t[t.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",t[t.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",t[t.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",t[t.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",t[t.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",t[t.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",t[t.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",t[t.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",t[t.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",t[t.INVALID_INDEX=4294967295]="INVALID_INDEX",t[t.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",t[t.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",t[t.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",t[t.OBJECT_TYPE=37138]="OBJECT_TYPE",t[t.SYNC_CONDITION=37139]="SYNC_CONDITION",t[t.SYNC_STATUS=37140]="SYNC_STATUS",t[t.SYNC_FLAGS=37141]="SYNC_FLAGS",t[t.SYNC_FENCE=37142]="SYNC_FENCE",t[t.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",t[t.UNSIGNALED=37144]="UNSIGNALED",t[t.SIGNALED=37145]="SIGNALED",t[t.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",t[t.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",t[t.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",t[t.WAIT_FAILED=37149]="WAIT_FAILED",t[t.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",t[t.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",t[t.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",t[t.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",t[t.SAMPLER_BINDING=35097]="SAMPLER_BINDING",t[t.RGB10_A2UI=36975]="RGB10_A2UI",t[t.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",t[t.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",t[t.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",t[t.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",t[t.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",t[t.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",t[t.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",t[t.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",t[t.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",t[t.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",t[t.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",t[t.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN",t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_COLOR=768]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",t[t.SRC_ALPHA=770]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=772]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",t[t.DST_COLOR=774]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",t[t.FUNC_ADD=32774]="FUNC_ADD",t[t.FUNC_MIN=32775]="FUNC_MIN",t[t.FUNC_MAX=32776]="FUNC_MAX",t[t.BLEND_EQUATION=32777]="BLEND_EQUATION",t[t.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",t[t.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",t[t.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",t[t.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",t[t.BLEND_DST_RGB=32968]="BLEND_DST_RGB",t[t.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",t[t.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",t[t.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",t[t.CONSTANT_COLOR=32769]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",t[t.BLEND_COLOR=32773]="BLEND_COLOR",t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",t[t.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",t[t.STREAM_DRAW=35040]="STREAM_DRAW",t[t.STATIC_DRAW=35044]="STATIC_DRAW",t[t.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",t[t.BUFFER_SIZE=34660]="BUFFER_SIZE",t[t.BUFFER_USAGE=34661]="BUFFER_USAGE",t[t.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK",t[t.FRONT_AND_BACK=1032]="FRONT_AND_BACK",t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.CULL_FACE=2884]="CULL_FACE",t[t.BLEND=3042]="BLEND",t[t.DITHER=3024]="DITHER",t[t.STENCIL_TEST=2960]="STENCIL_TEST",t[t.DEPTH_TEST=2929]="DEPTH_TEST",t[t.SCISSOR_TEST=3089]="SCISSOR_TEST",t[t.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",t[t.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",t[t.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",t[t.NO_ERROR=0]="NO_ERROR",t[t.INVALID_ENUM=1280]="INVALID_ENUM",t[t.INVALID_VALUE=1281]="INVALID_VALUE",t[t.INVALID_OPERATION=1282]="INVALID_OPERATION",t[t.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",t[t.CW=2304]="CW",t[t.CCW=2305]="CCW",t[t.LINE_WIDTH=2849]="LINE_WIDTH",t[t.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",t[t.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",t[t.CULL_FACE_MODE=2885]="CULL_FACE_MODE",t[t.FRONT_FACE=2886]="FRONT_FACE",t[t.DEPTH_RANGE=2928]="DEPTH_RANGE",t[t.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",t[t.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",t[t.DEPTH_FUNC=2932]="DEPTH_FUNC",t[t.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",t[t.STENCIL_FUNC=2962]="STENCIL_FUNC",t[t.STENCIL_FAIL=2964]="STENCIL_FAIL",t[t.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",t[t.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",t[t.STENCIL_REF=2967]="STENCIL_REF",t[t.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",t[t.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",t[t.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",t[t.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",t[t.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",t[t.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",t[t.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",t[t.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",t[t.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",t[t.VIEWPORT=2978]="VIEWPORT",t[t.SCISSOR_BOX=3088]="SCISSOR_BOX",t[t.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",t[t.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",t[t.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",t[t.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",t[t.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",t[t.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",t[t.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",t[t.RED_BITS=3410]="RED_BITS",t[t.GREEN_BITS=3411]="GREEN_BITS",t[t.BLUE_BITS=3412]="BLUE_BITS",t[t.ALPHA_BITS=3413]="ALPHA_BITS",t[t.DEPTH_BITS=3414]="DEPTH_BITS",t[t.STENCIL_BITS=3415]="STENCIL_BITS",t[t.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",t[t.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",t[t.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",t[t.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",t[t.SAMPLES=32937]="SAMPLES",t[t.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",t[t.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",t[t.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",t[t.DONT_CARE=4352]="DONT_CARE",t[t.FASTEST=4353]="FASTEST",t[t.NICEST=4354]="NICEST",t[t.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.ALPHA=6406]="ALPHA",t[t.RGB=6407]="RGB",t[t.RGBA=6408]="RGBA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",t[t.VERTEX_SHADER=35633]="VERTEX_SHADER",t[t.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",t[t.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",t[t.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",t[t.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",t[t.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",t[t.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",t[t.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",t[t.SHADER_TYPE=35663]="SHADER_TYPE",t[t.DELETE_STATUS=35712]="DELETE_STATUS",t[t.LINK_STATUS=35714]="LINK_STATUS",t[t.VALIDATE_STATUS=35715]="VALIDATE_STATUS",t[t.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",t[t.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",t[t.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",t[t.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",t[t.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",t[t.NEVER=512]="NEVER",t[t.LESS=513]="LESS",t[t.EQUAL=514]="EQUAL",t[t.LEQUAL=515]="LEQUAL",t[t.GREATER=516]="GREATER",t[t.NOTEQUAL=517]="NOTEQUAL",t[t.GEQUAL=518]="GEQUAL",t[t.ALWAYS=519]="ALWAYS",t[t.KEEP=7680]="KEEP",t[t.REPLACE=7681]="REPLACE",t[t.INCR=7682]="INCR",t[t.DECR=7683]="DECR",t[t.INVERT=5386]="INVERT",t[t.INCR_WRAP=34055]="INCR_WRAP",t[t.DECR_WRAP=34056]="DECR_WRAP",t[t.VENDOR=7936]="VENDOR",t[t.RENDERER=7937]="RENDERER",t[t.VERSION=7938]="VERSION",t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9729]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",t[t.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",t[t.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",t[t.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",t[t.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",t[t.TEXTURE=5890]="TEXTURE",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",t[t.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",t[t.TEXTURE0=33984]="TEXTURE0",t[t.TEXTURE1=33985]="TEXTURE1",t[t.TEXTURE2=33986]="TEXTURE2",t[t.TEXTURE3=33987]="TEXTURE3",t[t.TEXTURE4=33988]="TEXTURE4",t[t.TEXTURE5=33989]="TEXTURE5",t[t.TEXTURE6=33990]="TEXTURE6",t[t.TEXTURE7=33991]="TEXTURE7",t[t.TEXTURE8=33992]="TEXTURE8",t[t.TEXTURE9=33993]="TEXTURE9",t[t.TEXTURE10=33994]="TEXTURE10",t[t.TEXTURE11=33995]="TEXTURE11",t[t.TEXTURE12=33996]="TEXTURE12",t[t.TEXTURE13=33997]="TEXTURE13",t[t.TEXTURE14=33998]="TEXTURE14",t[t.TEXTURE15=33999]="TEXTURE15",t[t.TEXTURE16=34e3]="TEXTURE16",t[t.TEXTURE17=34001]="TEXTURE17",t[t.TEXTURE18=34002]="TEXTURE18",t[t.TEXTURE19=34003]="TEXTURE19",t[t.TEXTURE20=34004]="TEXTURE20",t[t.TEXTURE21=34005]="TEXTURE21",t[t.TEXTURE22=34006]="TEXTURE22",t[t.TEXTURE23=34007]="TEXTURE23",t[t.TEXTURE24=34008]="TEXTURE24",t[t.TEXTURE25=34009]="TEXTURE25",t[t.TEXTURE26=34010]="TEXTURE26",t[t.TEXTURE27=34011]="TEXTURE27",t[t.TEXTURE28=34012]="TEXTURE28",t[t.TEXTURE29=34013]="TEXTURE29",t[t.TEXTURE30=34014]="TEXTURE30",t[t.TEXTURE31=34015]="TEXTURE31",t[t.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",t[t.REPEAT=10497]="REPEAT",t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",t[t.FLOAT_VEC2=35664]="FLOAT_VEC2",t[t.FLOAT_VEC3=35665]="FLOAT_VEC3",t[t.FLOAT_VEC4=35666]="FLOAT_VEC4",t[t.INT_VEC2=35667]="INT_VEC2",t[t.INT_VEC3=35668]="INT_VEC3",t[t.INT_VEC4=35669]="INT_VEC4",t[t.BOOL=35670]="BOOL",t[t.BOOL_VEC2=35671]="BOOL_VEC2",t[t.BOOL_VEC3=35672]="BOOL_VEC3",t[t.BOOL_VEC4=35673]="BOOL_VEC4",t[t.FLOAT_MAT2=35674]="FLOAT_MAT2",t[t.FLOAT_MAT3=35675]="FLOAT_MAT3",t[t.FLOAT_MAT4=35676]="FLOAT_MAT4",t[t.SAMPLER_2D=35678]="SAMPLER_2D",t[t.SAMPLER_CUBE=35680]="SAMPLER_CUBE",t[t.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",t[t.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",t[t.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",t[t.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",t[t.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",t[t.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",t[t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",t[t.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",t[t.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",t[t.COMPILE_STATUS=35713]="COMPILE_STATUS",t[t.LOW_FLOAT=36336]="LOW_FLOAT",t[t.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",t[t.HIGH_FLOAT=36338]="HIGH_FLOAT",t[t.LOW_INT=36339]="LOW_INT",t[t.MEDIUM_INT=36340]="MEDIUM_INT",t[t.HIGH_INT=36341]="HIGH_INT",t[t.FRAMEBUFFER=36160]="FRAMEBUFFER",t[t.RENDERBUFFER=36161]="RENDERBUFFER",t[t.RGBA4=32854]="RGBA4",t[t.RGB5_A1=32855]="RGB5_A1",t[t.RGB565=36194]="RGB565",t[t.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",t[t.STENCIL_INDEX8=36168]="STENCIL_INDEX8",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t[t.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",t[t.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",t[t.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",t[t.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",t[t.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",t[t.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",t[t.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",t[t.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",t[t.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",t[t.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",t[t.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",t[t.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",t[t.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",t[t.NONE=0]="NONE",t[t.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",t[t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",t[t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",t[t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",t[t.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",t[t.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",t[t.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",t[t.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",t[t.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",t[t.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",t[t.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",t[t.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",t[t.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",t[t.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",t[t.TEXTURE_MAX_ANISOTROPY=34046]="TEXTURE_MAX_ANISOTROPY",t[t.MAX_TEXTURE_MAX_ANISOTROPY=34047]="MAX_TEXTURE_MAX_ANISOTROPY",t}({});function zn(t){return!(!t||!t.texStorage2D)}class Vn extends Error{static errorToString={[Ln.NO_ERROR]:"NO_ERROR",[Ln.INVALID_ENUM]:"INVALID_ENUM",[Ln.INVALID_VALUE]:"INVALID_VALUE",[Ln.INVALID_OPERATION]:"INVALID_OPERATION",[Ln.INVALID_FRAMEBUFFER_OPERATION]:"INVALID_FRAMEBUFFER_OPERATION",[Ln.OUT_OF_MEMORY]:"OUT_OF_MEMORY",[Ln.CONTEXT_LOST_WEBGL]:"CONTEXT_LOST_WEBGL"};code;constructor(t){super(Vn.errorToString[t]),this.code=t}}const On={add:Ln.FUNC_ADD,subtract:Ln.FUNC_SUBTRACT,"reverse-subtract":Ln.FUNC_REVERSE_SUBTRACT,max:Ln.FUNC_MAX,min:Ln.FUNC_MIN},kn={[Ln.FUNC_ADD]:"add",[Ln.FUNC_SUBTRACT]:"subtract",[Ln.FUNC_REVERSE_SUBTRACT]:"reverse-subtract",[Ln.FUNC_MAX]:"max",[Ln.FUNC_MIN]:"min"},Un={zero:Ln.ZERO,one:Ln.ONE,"src-alpha":Ln.SRC_ALPHA,"inv-src-alpha":Ln.ONE_MINUS_SRC_ALPHA,"src-alpha-saturate":Ln.BLEND,"dst-alpha":Ln.DST_ALPHA,"inv-dst-alpha":Ln.ONE_MINUS_DST_ALPHA,"src-color":Ln.SRC_COLOR,"inv-src-color":Ln.ONE_MINUS_SRC_COLOR,"dst-color":Ln.DST_COLOR,"inv-dst-color":Ln.ONE_MINUS_DST_COLOR,"const-color":Ln.CONSTANT_COLOR,"inv-const-color":Ln.ONE_MINUS_CONSTANT_COLOR,"const-alpha":Ln.CONSTANT_ALPHA,"inv-const-alpha":Ln.ONE_MINUS_CONSTANT_ALPHA},Gn={[Ln.ZERO]:"zero",[Ln.ONE]:"one",[Ln.SRC_ALPHA]:"src-alpha",[Ln.ONE_MINUS_SRC_ALPHA]:"inv-src-alpha",[Ln.SRC_ALPHA_SATURATE]:"src-alpha-saturate",[Ln.DST_ALPHA]:"dst-alpha",[Ln.ONE_MINUS_DST_ALPHA]:"inv-dst-alpha",[Ln.SRC_COLOR]:"src-color",[Ln.ONE_MINUS_SRC_COLOR]:"inv-src-color",[Ln.DST_COLOR]:"dst-color",[Ln.ONE_MINUS_DST_COLOR]:"inv-dst-color",[Ln.CONSTANT_COLOR]:"const-color",[Ln.ONE_MINUS_CONSTANT_COLOR]:"inv-const-color",[Ln.CONSTANT_ALPHA]:"const-alpha",[Ln.ONE_MINUS_CONSTANT_ALPHA]:"inv-const-alpha"},Hn={none:Ln.NONE,front:Ln.FRONT,back:Ln.BACK},Wn={[Ln.NONE]:"none",[Ln.FRONT]:"front",[Ln.BACK]:"back"};Ln.CW,Ln.CCW,Ln.CW,Ln.CCW;const Xn={keep:Ln.KEEP,zero:Ln.ZERO,replace:Ln.REPLACE,incr:Ln.INCR,"incr-wrap":Ln.INCR_WRAP,decr:Ln.DECR,"decr-wrap":Ln.DECR_WRAP,invert:Ln.INVERT},jn={[Ln.KEEP]:"keep",[Ln.ZERO]:"zero",[Ln.REPLACE]:"replace",[Ln.INCR]:"incr",[Ln.INCR_WRAP]:"incr-wrap",[Ln.DECR]:"decr",[Ln.DECR_WRAP]:"decr-wrap",[Ln.INVERT]:"invert"},Qn={always:Ln.ALWAYS,le:Ln.LEQUAL,ge:Ln.GEQUAL,lt:Ln.LESS,gt:Ln.GREATER,eq:Ln.EQUAL,ne:Ln.NOTEQUAL,never:Ln.NEVER},qn={[Ln.NONE]:null,[Ln.ALWAYS]:"always",[Ln.LEQUAL]:"le",[Ln.GEQUAL]:"ge",[Ln.LESS]:"lt",[Ln.GREATER]:"gt",[Ln.EQUAL]:"eq",[Ln.NOTEQUAL]:"ne",[Ln.NEVER]:"never"},Yn={repeat:Ln.REPEAT,"mirrored-repeat":Ln.MIRRORED_REPEAT,clamp:Ln.CLAMP_TO_EDGE},Zn={[te.BOOL]:Ln.BOOL,[te.BVEC2]:Ln.BOOL_VEC2,[te.BVEC3]:Ln.BOOL_VEC3,[te.BVEC4]:Ln.BOOL_VEC4,[te.F32]:Ln.FLOAT,[te.F32VEC2]:Ln.FLOAT_VEC2,[te.F32VEC3]:Ln.FLOAT_VEC3,[te.F32VEC4]:Ln.FLOAT_VEC4,[te.I8]:Ln.BYTE,[te.I16]:Ln.SHORT,[te.I32]:Ln.INT,[te.I32VEC2]:Ln.INT_VEC2,[te.I32VEC3]:Ln.INT_VEC3,[te.I32VEC4]:Ln.INT_VEC4,[te.U8]:Ln.UNSIGNED_BYTE,[te.U8_NORM]:Ln.UNSIGNED_BYTE,[te.I8_NORM]:Ln.BYTE,[te.U16]:Ln.UNSIGNED_SHORT,[te.U16_NORM]:Ln.UNSIGNED_SHORT,[te.I16_NORM]:Ln.SHORT,[te.U32]:Ln.UNSIGNED_INT,[te.U32VEC2]:Ln.UNSIGNED_INT_VEC2,[te.U32VEC3]:Ln.UNSIGNED_INT_VEC3,[te.U32VEC4]:Ln.UNSIGNED_INT_VEC4},Kn={"triangle-list":Ln.TRIANGLES,"triangle-strip":Ln.TRIANGLE_STRIP,"triangle-fan":Ln.TRIANGLE_FAN,"line-list":Ln.LINES,"line-strip":Ln.LINE_STRIP,"point-list":Ln.POINTS},Jn={"2d":Ln.TEXTURE_2D,"3d":Ln.TEXTURE_3D,cube:Ln.TEXTURE_CUBE_MAP,"2darray":Ln.TEXTURE_2D_ARRAY},to={[R.PX]:Ln.TEXTURE_CUBE_MAP_POSITIVE_X,[R.NX]:Ln.TEXTURE_CUBE_MAP_NEGATIVE_X,[R.PY]:Ln.TEXTURE_CUBE_MAP_POSITIVE_Y,[R.NY]:Ln.TEXTURE_CUBE_MAP_NEGATIVE_Y,[R.PZ]:Ln.TEXTURE_CUBE_MAP_POSITIVE_Z,[R.NZ]:Ln.TEXTURE_CUBE_MAP_NEGATIVE_Z};function eo(t){switch(t){case"nearest":return Ln.NEAREST;case"linear":return Ln.LINEAR;default:return Ln.NONE}}function io(t,e){switch(t){case"nearest":switch(e){case"none":return Ln.NEAREST;case"nearest":return Ln.NEAREST_MIPMAP_NEAREST;case"linear":return Ln.NEAREST_MIPMAP_LINEAR}break;case"linear":switch(e){case"none":return Ln.LINEAR;case"nearest":return Ln.LINEAR_MIPMAP_NEAREST;case"linear":return Ln.LINEAR_MIPMAP_LINEAR}}return Ln.NONE}let so=0;class ro extends gt{_device;_object;_uid;_cid;_name;_restoreHandler;constructor(t){super(),this._device=t,this._object=null,this._uid=++so,this._cid=1,this._name=xr(this),this._restoreHandler=null,this._device.addGPUObject(this)}get device(){return this._device}get object(){return this._object}get restoreHandler(){return this._restoreHandler}set restoreHandler(t){this._restoreHandler=t}get uid(){return this._uid}get cid(){return this._cid}get name(){return this._name}set name(t){if(t!==this._name){const e=this._name;this._name=t,this._device.dispatchEvent("gpuobject_rename",this,e)}}isVertexLayout(){return!1}isFramebuffer(){return!1}isSampler(){return!1}isTexture(){return!1}isTexture2D(){return!1}isTexture2DArray(){return!1}isTexture3D(){return!1}isTextureCube(){return!1}isTextureVideo(){return!1}isProgram(){return!1}isBuffer(){return!1}isBindGroup(){return!1}reload(){this.disposed&&(this._device.restoreObject(this),this._cid++)}destroy(){throw new Error("Abstract function call: destroy()")}restore(){throw new Error("Abstract function call: restore()")}onDispose(){super.onDispose(),this._device.disposeObject(this,!0)}}class ao extends ro{_target;_memCost;_flags;_width;_height;_depth;_format;_mipLevelCount;_samplerOptions;_webgl1fallback;_readFrameBuffers;constructor(t,e){super(t),this._target=e||"2d",this._memCost=0,this._flags=0,this._width=0,this._height=0,this._depth=1,this._format="unknown",this._mipLevelCount=0,this._samplerOptions=null,this._webgl1fallback=!1,this._readFrameBuffers=[]}get target(){return this._target}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get memCost(){return this._memCost}get format(){return this._format}get mipLevelCount(){return this._mipLevelCount}get samplerOptions(){return this._samplerOptions}set samplerOptions(t){const e=this.getTextureCaps().getTextureFormatInfo(this._format);this._samplerOptions=t?Object.assign({},this._getSamplerOptions(e,!!t.compare),t):null}get isWebGL1Fallback(){return this._webgl1fallback}isFilterable(){return!!this.getTextureCaps().getTextureFormatInfo(this._format)?.filterable&&!!(this.device.isWebGL2||E(this._width)||E(this._height))}destroy(){if(this._object){this._device.context.deleteTexture(this._object),this._device.invalidateBindingTextures(),this._object=null,this._device.updateVideoMemoryCost(-this._memCost);for(const t of this._readFrameBuffers)if(t)for(const e of t)e&&e.dispose();this._readFrameBuffers=[],this._memCost=0}}restore(){this._object||this._device.isContextLost()||this.init()}isTexture(){return!0}getTextureCaps(){return this._device.getDeviceCaps().textureCaps}isSRGBFormat(){return Ut(this._format)}isFloatFormat(){return zt(this._format)}isIntegerFormat(){return Vt(this._format)}isSignedFormat(){return Ot(this._format)}isCompressedFormat(){return kt(this._format)}isDepth(){return Nt(this._format)}getDefaultSampler(t){const e=this.getTextureCaps().getTextureFormatInfo(this._format);return this._device.createSampler(this._samplerOptions&&!this._samplerOptions.compare==!t?this._samplerOptions:this._getSamplerOptions(e,t))}_getFramebufferForRead(t,e){let i=this._readFrameBuffers[t];i||(i=[],this._readFrameBuffers[t]=i);let s=i[e];return s||(s=this._device.createFrameBuffer([this],null),this.isTextureCube()?s.setColorAttachmentCubeFace(0,t):(this.isTexture2DArray()||this.isTexture3D())&&s.setColorAttachmentLayer(0,t),s.setColorAttachmentMipLevel(0,e),s.setColorAttachmentGenerateMipmaps(0,!1),i[e]=s),s}allocInternal(t,e,i,s,r){if(this._device.isWebGL2||E(e)&&E(i)?this._webgl1fallback=!1:(r=1,this._webgl1fallback=!0),this._device.setCurrentSamplerForTexture(this,null),0===r)r=this._calcMipLevelCount(t,e,i,s);else if(1!==r){let t=Math.max(e,i);this.isTexture3D()&&(t=Math.max(t,s));const a=Math.floor(Math.log2(t))+1;(!Number.isInteger(r)||r<0||r>a)&&(r=a)}if(this._object&&(this._format!==t||this._width!==e||this._height!==i||this._depth,this._mipLevelCount!==r)){const t=this._object;this._device.runNextFrame(()=>{this._device.context.deleteTexture(t),this._device.invalidateBindingTextures()}),this._object=null}if(!this._object&&(this._format=t,this._width=e,this._height=i,this._depth=s,this._mipLevelCount=r,!this._device.isContextLost())){this._object=this._device.context.createTexture();const t=this._device.context;this._device.bindTexture(Jn[this._target],0,this);const e=this.getTextureCaps().getTextureFormatInfo(this._format);if(zn(t)&&!this.isTextureVideo())this.isTexture3D()||this.isTexture2DArray()?t.texStorage3D(Jn[this._target],this._mipLevelCount,e.glInternalFormat,this._width,this._height,this._depth):t.texStorage2D(Jn[this._target],this._mipLevelCount,e.glInternalFormat,this._width,this._height),this._device.context.texParameteri(Jn[this._target],Ln.TEXTURE_BASE_LEVEL,0),this._device.context.texParameteri(Jn[this._target],Ln.TEXTURE_MAX_LEVEL,this._mipLevelCount-1);else{let t=this._width,i=this._height;const s=kt(this._format),a=Ht(this._format),n=Wt(this._format),o=Gt(this._format);for(let h=0;h<r;h++){const r=s?new Uint8Array(Math.ceil(t/a)*Math.ceil(i/n)*o):null;if(r?.fill(255),this.isTextureCube())for(let a=0;a<6;a++){const n=to[a];s?this._device.context.compressedTexImage2D(n,h,e.glInternalFormat,t,i,0,r):this._device.context.texImage2D(n,h,e.glInternalFormat,t,i,0,e.glFormat,e.glType[0],null)}else s?this._device.context.compressedTexImage2D(Jn[this._target],h,e.glInternalFormat,t,i,0,r):this._device.context.texImage2D(Jn[this._target],h,e.glInternalFormat,t,i,0,e.glFormat,e.glType[0],null);t=Math.max(t>>1,1),i=Math.max(i>>1,1)}}const i=this.isTextureCube()?6:1,s=this.getTextureCaps().calcMemoryUsage(this._format,e.glType[0],this._width*this._height*this._depth*i);this._device.updateVideoMemoryCost(s-this._memCost),this._memCost=s}}_calcMipLevelCount(t,e,i,s){if(Nt(t)||this.isTextureVideo())return 1;if(this._flags&nr.TF_NO_MIPMAP)return 1;if(!(this._device.isWebGL2||E(e)&&E(i)))return 1;const r=this.getTextureCaps().getTextureFormatInfo(t);if(!r||!r.renderable)return 1;let a=Math.max(e,i);return this.isTexture3D()&&(a=Math.max(a,s)),Math.floor(Math.log2(a))+1}_getSamplerOptions(t,e){const i=this.isDepth()&&e,s=t.filterable||i;return{addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:s?"linear":"nearest",minFilter:s?"linear":"nearest",mipFilter:this._mipLevelCount>1?s?"linear":"nearest":"none",compare:i?"le":null}}}class no extends ao{constructor(t){super(t,"2d")}isTexture2D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._mipLevelCount)}update(t,e,i,s,r){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const a=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(Jn[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texSubImage2D(Jn[this._target],0,e,i,s,r,a.glFormat,a.glType[0],t),this._mipLevelCount>1&&this.generateMipmaps()}updateFromElement(t,e,i,s,r,a,n){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format);if(this._device.bindTexture(Jn[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===s&&0===r&&a===t.width&&n===t.height)this._device.context.texSubImage2D(Jn[this._target],0,e,i,o.glFormat,o.glType[0],t);else{const h=document.createElement("canvas");h.width=a,h.height=n;h.getContext("2d").drawImage(t,s,r,a,n,0,0,a,n),this._device.context.texSubImage2D(Jn[this._target],0,e,i,o.glFormat,o.glType[0],h),h.width=0,h.height=0}this._mipLevelCount>1&&this.generateMipmaps()}async readPixels(t,e,i,s,r,a,n){if(0!==r)throw new Error("Texture2D.readPixels(): parameter 'faceOrLayer' must be 0");if(a>=this.mipLevelCount||a<0)throw new Error(`Texture2D.readPixels(): invalid miplevel: ${a}`);if(!this.device.isContextLost()&&!this.disposed){const r=this._getFramebufferForRead(0,a);this._device.pushDeviceStates(),this._device.setFramebuffer(r);const o=this._device.readPixels(0,t,e,i,s,n);return this._device.popDeviceStates(),o}}readPixelsToBuffer(t,e,i,s,r,a,n){if(0!==r)throw new Error("Texture2D.readPixelsToBuffer(): parameter 'faceOrLayer' must be 0");if(a>=this.mipLevelCount||a<0)throw new Error(`Texture2D.readPixelsToBuffer(): invalid miplevel: ${a}`);if(!this.device.isContextLost()&&!this.disposed){const r=this._device.createFrameBuffer([this],null);r.setColorAttachmentMipLevel(0,a),r.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(r),this._device.readPixelsToBuffer(0,t,e,i,s,n),this._device.popDeviceStates(),r.dispose()}}loadFromElement(t,e,i){if(this._flags=Number(i)||0,this._flags&nr.TF_WRITABLE)console.error(new Error("webgl device does not support storage texture"));else{const i=e?"rgba8unorm-srgb":"rgba8unorm";this.loadImage(t,i)}}createEmpty(t,e,i,s){this._flags=Number(s)||0,this._flags&nr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,i,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Jn[this._target];this._device.bindTexture(t,0,this),this._device.context.generateMipmap(t)}}createWithMipmapData(t,e,i){t.isCubemap||t.isVolume?console.error("loading 2d texture with mipmap data failed: data is not 2d texture"):(this._flags=Number(i)||0,this._flags&nr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadLevels(t,e))}loadEmpty(t,e,i,s){this.allocInternal(t,e,i,1,s),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(t,e){let i=e?Dt(t.format):t.format,s=!1;"bgra8unorm"===i?(i="rgba8unorm",s=!0):"bgra8unorm-srgb"===i&&(i="rgba8unorm-srgb",s=!0);const r=t.width,a=t.height,n=t.mipLevels;if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(i,r,a,1,n),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format),i=Jn[this._target];this._device.bindTexture(i,0,this),this.device.clearErrors();for(let r=0;r<this._mipLevelCount;r++){if(t.isCompressed)this._device.context.compressedTexSubImage2D(i,r,0,0,t.mipDatas[0][r].width,t.mipDatas[0][r].height,e.glInternalFormat,t.mipDatas[0][r].data);else{if(s)for(let e=0;e<t.mipDatas[0][r].width*t.mipDatas[0][r].height;e++){const i=t.mipDatas[0][r].data[4*e];t.mipDatas[0][r].data[4*e]=t.mipDatas[0][r].data[4*e+2],t.mipDatas[0][r].data[4*e+2]=i}this._device.context.texSubImage2D(i,r,0,0,t.mipDatas[0][r].width,t.mipDatas[0][r].height,e.glFormat,e.glType[0],t.mipDatas[0][r].data)}const a=this.device.getError();if(a)return void console.error(a)}}}else console.warn("No s3tc compression format support")}loadImage(t,e){if(this.allocInternal(e,Number(t.width),Number(t.height),1,0),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format);this.device.clearErrors();const i=Jn[this._target];this._device.bindTexture(i,0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,4),this._device.context.texSubImage2D(i,0,0,0,e.glFormat,e.glType[0],t),this._mipLevelCount>1&&this.generateMipmaps()}}}class oo extends ao{constructor(t){if(!t.isWebGL2)throw new Error("device does not support 2d texture array");super(t,"2darray")}isTexture2DArray(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(t,e,i,s,r,a,n){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format),h=this._device.context;this._device.bindTexture(Jn[this._target],0,this),h.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),h.texSubImage3D(Jn[this._target],0,e,i,s,r,a,n,o.glFormat,o.glType[0],t),this._mipLevelCount>1&&this.generateMipmaps()}createWithMipmapData(t,e){t.arraySize?(this._flags=Number(e)||0,this._flags&nr.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(t)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}loadLevels(t){const e=t.format,i=t.width,s=t.height,r=1!==t.mipLevels||this._flags&nr.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,i,s,1);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(e,i,s,t.arraySize,r),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format),i=this._device.context;this._device.bindTexture(Jn[this._target],0,this),this.device.clearErrors();for(let s=0;s<t.arraySize;s++){if(t.mipDatas[s].length!==t.mipLevels)return void console.error("Texture2DArray.loadLevels() failed: Invalid texture data");for(let r=0;r<t.mipLevels;r++){t.isCompressed?i.compressedTexSubImage3D(i.TEXTURE_2D_ARRAY,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glInternalFormat,t.mipDatas[s][r].data):i.texSubImage3D(i.TEXTURE_2D_ARRAY,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glFormat,e.glType[0],t.mipDatas[s][r].data);const a=this.device.getError();if(a)return void console.error(a)}}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture2DArray.loadLevels(): No s3tc compression format support")}updateFromElement(t,e,i,s,r,a,n,o){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const h=this.getTextureCaps().getTextureFormatInfo(this._format),l=this._device.context;if(this._device.bindTexture(Jn[this._target],0,this),l.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===r&&0===a&&n===t.width&&o===t.height)l.texSubImage3D(Jn[this._target],0,e,i,s,n,o,1,h.glFormat,h.glType[0],t);else{const u=document.createElement("canvas");u.width=n,u.height=o;u.getContext("2d").drawImage(t,r,a,n,o,0,0,n,o),l.texSubImage3D(Jn[this._target],0,e,i,s,n,o,1,h.glFormat,h.glType[0],u),u.width=0,u.height=0}this._mipLevelCount>1&&this.generateMipmaps()}createEmpty(t,e,i,s,r){this._flags=Number(r)||0,this._flags&nr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,i,s,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Jn[this._target];this._device.bindTexture(t,0,this),this._device.context.generateMipmap(t)}}async readPixels(t,e,i,s,r,a,n){if(r<0||r>=this._depth)throw new Error(`Texture2DArray.readPixels(): invalid layer: ${r}`);if(a<0||a>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixels(): invalid miplevel: ${a}`);if(!this.device.isContextLost()&&!this.disposed){const o=this._getFramebufferForRead(r,a);this._device.pushDeviceStates(),this._device.setFramebuffer(o);const h=this._device.readPixels(0,t,e,i,s,n);return this._device.popDeviceStates(),h}}readPixelsToBuffer(t,e,i,s,r,a,n){if(r<0||r>=this._depth)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid layer: ${r}`);if(a<0||a>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid miplevel: ${a}`);const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentLayer(0,r),o.setColorAttachmentMipLevel(0,a),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,t,e,i,s,n),this._device.popDeviceStates(),o.dispose()}loadEmpty(t,e,i,s,r){this.allocInternal(t,e,i,s,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}}class ho extends ao{constructor(t){if(!t.isWebGL2)throw new Error("device does not support 3D texture");super(t,"3d")}get depth(){return this._depth}isTexture3D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(t,e,i,s,r,a,n){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount);const o=this.getTextureCaps().getTextureFormatInfo(this._format),h=this._device.context;this._device.bindTexture(Jn[this._target],0,this),h.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),h.texSubImage3D(Jn[this._target],0,e,i,s,r,a,n,o.glFormat,o.glType[0],t)}createEmpty(t,e,i,s,r){this._flags=Number(r)||0,this._flags&nr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,i,s,0)}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Jn[this._target];this._device.bindTexture(t,0,this),this._device.context.generateMipmap(t)}}async readPixels(t,e,i,s,r,a,n){if(0!==a)throw new Error("Texture3D.readPixels(): parameter mipLevel must be 0");if(!this.device.isContextLost()&&!this.disposed){const o=this._getFramebufferForRead(r,a);this._device.pushDeviceStates(),this._device.setFramebuffer(o);const h=this._device.readPixels(0,t,e,i,s,n);return this._device.popDeviceStates(),h}}readPixelsToBuffer(t,e,i,s,r,a,n){if(0!==a)throw new Error("Texture3D.readPixelsToBuffer(): parameter mipLevel must be 0");const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentLayer(0,r),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,t,e,i,s,n),this._device.popDeviceStates(),o.dispose()}createWithMipmapData(t,e){t.arraySize?(this._flags=Number(e)||0,this._flags&nr.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(t)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}loadLevels(t){const e=t.format,i=t.width,s=t.height,r=t.depth,a=1!==t.mipLevels||this._flags&nr.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,i,s,r);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(e,i,s,t.arraySize,a),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format),i=this._device.context;this._device.bindTexture(Jn[this._target],0,this),this.device.clearErrors();for(let s=0;s<r;s++){if(t.mipDatas[s].length!==t.mipLevels)return void console.error("Texture2DArray.loadLevels() failed: Invalid texture data");for(let r=0;r<t.mipLevels;r++){t.isCompressed?i.compressedTexSubImage3D(i.TEXTURE_3D,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glInternalFormat,t.mipDatas[s][r].data):i.texSubImage3D(i.TEXTURE_3D,r,0,0,s,t.mipDatas[s][r].width,t.mipDatas[s][r].height,1,e.glFormat,e.glType[0],t.mipDatas[s][r].data);const a=this.device.getError();if(a)return void console.error(a)}}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture2DArray.loadLevels(): No s3tc compression format support")}loadEmpty(t,e,i,s,r){this.allocInternal(t,e,i,s,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}}class lo extends ao{constructor(t){super(t,"cube")}init(){this.loadEmpty(this._format,this._width,this._mipLevelCount)}update(t,e,i,s,r,a){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const n=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(Jn[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texSubImage2D(to[a],0,e,i,s,r,n.glFormat,n.glType[0],t),this._mipLevelCount>1&&this.generateMipmaps()}updateFromElement(t,e,i,s,r,a,n,o){if(this._device.isContextLost())return;this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount);const h=this.getTextureCaps().getTextureFormatInfo(this._format);if(this._device.bindTexture(Jn[this._target],0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),0===r&&0===a&&n===t.width&&o===t.height)this._device.context.texSubImage2D(to[s],0,e,i,h.glFormat,h.glType[0],t);else{const s=document.createElement("canvas");s.width=n,s.height=o;s.getContext("2d").drawImage(t,r,a,n,o,0,0,n,o),this._device.context.texSubImage2D(Jn[this._target],0,e,i,h.glFormat,h.glType[0],s),s.width=0,s.height=0}this._mipLevelCount>1&&this.generateMipmaps()}createEmpty(t,e,i){this._flags=Number(i)||0,this._flags&nr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadEmpty(t,e,0)}async readPixels(t,e,i,s,r,a,n){if(a<0||a>=this.mipLevelCount)throw new Error(`TextureCube.readPixels(): invalid miplevel: ${a}`);if(!this.device.isContextLost()&&!this.disposed){const o=this._getFramebufferForRead(r,a);this._device.pushDeviceStates(),this._device.setFramebuffer(o);const h=this._device.readPixels(0,t,e,i,s,n);return this._device.popDeviceStates(),h}}readPixelsToBuffer(t,e,i,s,r,a,n){if(a<0||a>=this.mipLevelCount)throw new Error(`TextureCube.readPixels(): invalid miplevel: ${a}`);const o=this._device.createFrameBuffer([this],null);o.setColorAttachmentCubeFace(0,r),o.setColorAttachmentMipLevel(0,a),o.setColorAttachmentGenerateMipmaps(0,!1),this._device.pushDeviceStates(),this._device.setFramebuffer(o),this._device.readPixelsToBuffer(0,t,e,i,s,n),this._device.popDeviceStates(),o.dispose()}isTextureCube(){return!0}generateMipmaps(){if(this._object&&this._mipLevelCount>1){const t=Jn[this._target];this._device.bindTexture(t,0,this),this._device.context.generateMipmap(t)}}createWithMipmapData(t,e,i){t.isCubemap?(this._flags=Number(i)||0,this._flags&nr.TF_WRITABLE?console.error("webgl device does not support storage texture"):this.loadLevels(t,e)):console.error("loading cubmap with mipmap data failed: data is not cubemap")}loadEmpty(t,e,i){this.allocInternal(t,e,e,1,i),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(t,e){const i=e?Dt(t.format):t.format,s=t.width,r=t.height,a=t.mipLevels;if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(i,s,r,1,a),!this._device.isContextLost()){const e=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(Jn[this._target],0,this),this.device.clearErrors();for(let i=0;i<6;i++){const s=to[i];if(this._mipLevelCount>1&&t.mipDatas[i].length!==this._mipLevelCount)return void console.error("invalid texture data");for(let r=0;r<this._mipLevelCount;r++){t.isCompressed?this._device.context.compressedTexSubImage2D(s,r,0,0,t.mipDatas[i][r].width,t.mipDatas[i][r].height,e.glInternalFormat,t.mipDatas[i][r].data):this._device.context.texSubImage2D(s,r,0,0,t.mipDatas[i][r].width,t.mipDatas[i][r].height,e.glFormat,e.glType[0],t.mipDatas[i][r].data);const a=this.device.getError();if(a)return void console.error(a)}}}}else console.warn("No s3tc compression format support")}}class uo extends ao{_source;_callbackId;constructor(t,e){super(t,"2d"),this._source=null,this._callbackId=null,this._format="unknown",this.loadFromElement(e)}isTextureVideo(){return!0}get source(){return this._source}destroy(){this._source&&null!==this._callbackId&&this._source.cancelVideoFrameCallback(this._callbackId),super.destroy()}init(){this.loadElement(this._source)}loadFromElement(t){this._flags=nr.TF_NO_MIPMAP,this.loadElement(t)}generateMipmaps(){}readPixels(t,e,i,s,r,a,n){throw new Error("Video texture does not support readPixels()")}readPixelsToBuffer(t,e,i,s,r,a,n){throw new Error("Video texture does not support readPixelsToBuffer()")}updateVideoFrame(){return!(!(this.object&&this._source.currentTime>0)||this._source.requestVideoFrameCallback)&&(this.update(),!0)}update(){if(this.allocInternal("rgba8unorm",this._source.videoWidth,this._source.videoHeight,1,1),!this._device.isContextLost()){const t=Jn[this._target],e=this.getTextureCaps().getTextureFormatInfo(this._format);this._device.bindTexture(t,0,this),this._device.context.pixelStorei(this._device.context.UNPACK_ALIGNMENT,1),this._device.context.texImage2D(t,0,e.glInternalFormat,e.glFormat,e.glType[0],this._source)}}loadElement(t){if(this._source&&null!==this._callbackId&&(this._source.cancelVideoFrameCallback(this._callbackId),this._callbackId=null),this._source=t,this._source?.requestVideoFrameCallback){const t=this;t._callbackId=this._source.requestVideoFrameCallback(function e(){t._object&&(t.update(),t._callbackId=t._source.requestVideoFrameCallback(e))})}this.allocInternal("rgba8unorm",Math.max(this._source.videoWidth,1),Math.max(this._source.videoHeight,1),1,1)}}class co extends ro{_vertexData;_dirty;constructor(t,e){super(t),this._vertexData=new br,this._dirty=!1;for(const t of e.vertexBuffers)this._vertexData.setVertexBuffer(t.buffer,t.stepMode);e.indexBuffer&&this._vertexData.setIndexBuffer(e.indexBuffer),this.load()}destroy(){this._object&&this._device.vaoExt&&this._device.vaoExt.deleteVertexArray(this._object),this._object=null}restore(){this._device.isContextLost()||this.load()}get vertexBuffers(){return this._vertexData.vertexBuffers}get indexBuffer(){return this._vertexData.indexBuffer}setDrawOffset(t,e){for(const i of this._vertexData.vertexBuffers)i?.buffer===t&&i.drawOffset!==e&&(i.drawOffset=e,this._dirty=!0)}getVertexBuffer(t){return this._vertexData.getVertexBuffer(t)}getVertexBufferInfo(t){return this._vertexData.getVertexBufferInfo(t)}getIndexBuffer(){return this._vertexData.getIndexBuffer()}bind(){this._object&&this._device.vaoExt?(this._device.vaoExt.bindVertexArray(this._object),this._dirty&&(this._dirty=!1,this.bindBuffers())):this.bindBuffers()}draw(t,e,i){this._device.setVertexLayout(this),this._device.draw(t,e,i)}drawInstanced(t,e,i,s){this._device.setVertexLayout(this),this._device.drawInstanced(t,e,i,s)}isVertexLayout(){return!0}load(){this._device.isContextLost()||(this._device.vaoExt?this._object||(this._object=this._device.vaoExt.createVertexArray(),this._device.vaoExt.bindVertexArray(this._object),this.bindBuffers(),this._device.vaoExt.bindVertexArray(null)):this._object={})}bindBuffers(){const t=this._vertexData.vertexBuffers,e=this._device.context;for(let i=0;i<t.length;i++){const s=t[i],r=s?.buffer;r?(r.disposed&&r.reload(),e.bindBuffer(Ln.ARRAY_BUFFER,r.object),e.enableVertexAttribArray(i),"instance"===s.stepMode&&this._device.instancedArraysExt?(e.vertexAttribPointer(i,s.type.cols,Zn[s.type.scalarType],s.type.normalized,s.stride,s.offset),this._device.instancedArraysExt.vertexAttribDivisor(i,1)):e.vertexAttribPointer(i,s.type.cols,Zn[s.type.scalarType],s.type.normalized,s.stride,s.drawOffset+s.offset)):e.disableVertexAttribArray(i)}this._vertexData.indexBuffer?.disposed&&this._vertexData.indexBuffer.reload(),e.bindBuffer(Ln.ELEMENT_ARRAY_BUFFER,this._vertexData.indexBuffer?this._vertexData.indexBuffer.object:null)}}class po extends ro{_size;_usage;_systemMemoryBuffer;_systemMemory;_memCost;constructor(t,e,i,s=!1){if(super(t),e&nr.BF_VERTEX&&e&nr.BF_INDEX)throw new Error("buffer usage must not have Vertex and Index simultaneously");if(!(t.isWebGL2||e&nr.BF_VERTEX||e&nr.BF_INDEX||e&nr.BF_UNIFORM))throw new Error("no Vertex or Index or Uniform usage set when creating buffer");if(t.isWebGL2&&!(e&~nr.DYNAMIC))throw new Error("buffer usage not set when creating buffer");if(e&nr.DYNAMIC&&e&nr.MANAGED)throw new Error("buffer usage DYNAMIC and MANAGED can not be both set");if(this._object=null,this._memCost=0,this._usage=e,this._size="number"==typeof i?i:i.byteLength,this._size<=0)throw new Error("can not create buffer with zero size");this._systemMemory=!!s,this._systemMemory||this._usage&nr.MANAGED?(this._systemMemoryBuffer=new Uint8Array(this._size),i&&"number"!=typeof i&&this._systemMemoryBuffer.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength))):this._systemMemoryBuffer=null,this._systemMemory||this.load(this._systemMemoryBuffer||("number"==typeof i?null:i))}get byteLength(){return this._size}get systemMemoryBuffer(){return this._systemMemoryBuffer?.buffer||null}get usage(){return this._usage}bufferSubData(t,e,i,s){if(i=Number(i)||0,t=Number(t)||0,i+(s=Number(s)||e.length-i)>e.length)throw new Error("bufferSubData() failed: source buffer is too small");if(t+s*e.BYTES_PER_ELEMENT>this.byteLength)throw new Error("bufferSubData() failed: dest buffer is too small");if((this._systemMemory||this._usage&nr.MANAGED)&&this._systemMemoryBuffer.set(new Uint8Array(e.buffer,e.byteOffset+i*e.BYTES_PER_ELEMENT,s*e.BYTES_PER_ELEMENT),t),!this._systemMemory&&!this.device.isContextLost()){let r;if(this.disposed&&this.reload(),this._device.isWebGL2||0===i&&s===e.length||(e=e.subarray(i,i+s)),this._device.vaoExt?.bindVertexArray(null),this._usage&nr.BF_INDEX)r=Ln.ELEMENT_ARRAY_BUFFER;else if(this._usage&nr.BF_VERTEX)r=Ln.ARRAY_BUFFER;else if(this._usage&nr.BF_UNIFORM)r=Ln.UNIFORM_BUFFER;else if(this._usage&(nr.BF_READ|nr.BF_WRITE))r=Ln.COPY_WRITE_BUFFER;else{if(!(this._usage&(nr.BF_PACK_PIXEL|nr.BF_UNPACK_PIXEL)))throw new Error("Invalid buffer usage");r=Ln.PIXEL_PACK_BUFFER}this._device.context.bindBuffer(r,this._object),this._device.isWebGL2?this._device.context.bufferSubData(r,t,e,i,s):this._device.context.bufferSubData(r,t,e)}}async getBufferSubData(t,e,i){return this.disposed&&this.reload(),this._getBufferData(t,e,i)}async _getBufferData(t,e,i){if(e=Number(e)||0,i=Number(i)||this.byteLength-e,e<0||e+i>this.byteLength)throw new Error("data query range out of bounds");if(t&&t.byteLength<i)throw new Error("no enough space for querying buffer data");if(t=t||new Uint8Array(i),this._systemMemoryBuffer)t.set(new Uint8Array(this._systemMemoryBuffer.buffer,e,i));else{const s=this._device.context;if(zn(s)){const t=s.fenceSync(Ln.SYNC_GPU_COMMANDS_COMPLETE,0);await this.clientWaitAsync(s,t,0,10),s.deleteSync(t)}let r;if(this._device.vaoExt?.bindVertexArray(null),this._usage&nr.BF_INDEX)r=Ln.ELEMENT_ARRAY_BUFFER;else if(this._usage&nr.BF_VERTEX)r=Ln.ARRAY_BUFFER;else if(this._usage&nr.BF_UNIFORM)r=Ln.UNIFORM_BUFFER;else if(this._usage&(nr.BF_READ|nr.BF_WRITE))r=Ln.COPY_READ_BUFFER;else{if(!(this._usage&(nr.BF_PACK_PIXEL|nr.BF_UNPACK_PIXEL)))throw new Error("Invalid buffer usage");r=Ln.PIXEL_UNPACK_BUFFER}s.bindBuffer(r,this._object),s.getBufferSubData(r,e,t,0,i),s.bindBuffer(r,null)}return t}restore(){this._systemMemory||this._object||this._device.isContextLost()||this.load(this._systemMemoryBuffer)}destroy(){!this._systemMemory&&this._object&&(this._device.context.deleteBuffer(this._object),this._object=null,this._device.updateVideoMemoryCost(-this._memCost),this._memCost=0)}isBuffer(){return!0}load(t){if(!this._device.isContextLost()){this._object||(this._object=this._device.context.createBuffer()),this._device.vaoExt?.bindVertexArray(null);let e,i=this._usage&nr.DYNAMIC?Ln.DYNAMIC_DRAW:Ln.STATIC_DRAW;if(this._usage&nr.BF_INDEX)e=Ln.ELEMENT_ARRAY_BUFFER;else if(this._usage&nr.BF_VERTEX)e=Ln.ARRAY_BUFFER;else if(this._usage&nr.BF_UNIFORM)e=Ln.UNIFORM_BUFFER;else if(this._usage&nr.BF_READ)e=Ln.PIXEL_PACK_BUFFER,i=Ln.STREAM_READ;else if(this._usage&nr.BF_WRITE)e=Ln.COPY_WRITE_BUFFER;else if(this._usage&nr.BF_PACK_PIXEL)e=Ln.PIXEL_PACK_BUFFER,i=Ln.STREAM_READ;else{if(!(this._usage&nr.BF_UNPACK_PIXEL))throw new Error(`WebGLGPUBuffer.load() failed: invalid buffer usage: ${this._usage}`);e=Ln.PIXEL_UNPACK_BUFFER}this._device.context.bindBuffer(e,this._object),t?this._device.context.bufferData(e,t,i):this._device.context.bufferData(e,this._size+15&-16,i)}this._device.updateVideoMemoryCost(this._size-this._memCost),this._memCost=this._size}async clientWaitAsync(t,e,i,s){return new Promise((r,a)=>{!function n(){const o=t.clientWaitSync(e,i,0);o!=t.WAIT_FAILED?o!=t.TIMEOUT_EXPIRED?r():setTimeout(n,s):a()}()})}}const mo=_e.getCachedTypeInfo(te.U16),fo=_e.getCachedTypeInfo(te.U32);class _o extends po{indexType;length;constructor(t,e,i){if(!(e instanceof Uint16Array||e instanceof Uint32Array))throw new Error("invalid index data");super(t,nr.BF_INDEX|i,e),this.indexType=e instanceof Uint16Array?mo:fo,this.length=e.length}}class go extends ro{_options;_needBindBuffers;_drawTags;_lastDrawTag;_status;_statusAA;_width;_height;_isMRT;_drawBuffers;_hash;_needGenerateMipmaps;_depthAttachmentTarget;_colorAttachmentsAA;_depthAttachmentAA;_intermediateAttachments;_framebufferAA;_initialized;constructor(t,e,i,s){if(super(t),e.length>0&&e.findIndex(t=>!t)>=0)throw new Error("WebGLFramebuffer(): invalid color attachments");if(this._object=null,this._framebufferAA=null,this._colorAttachmentsAA=null,this._depthAttachmentAA=null,this._intermediateAttachments=null,this._needBindBuffers=!1,this._drawTags=0,this._lastDrawTag=-1,this._status=0,this._statusAA=0,this._options={colorAttachments:e?.length>0?e.map(t=>({texture:t,face:0,layer:0,level:0,generateMipmaps:!0})):null,depthAttachment:i?{texture:i,face:0,layer:0,level:0,generateMipmaps:!1}:null,sampleCount:"webgl"===t.type?1:s?.sampleCount??1,ignoreDepthStencil:s?.ignoreDepthStencil??!1},!this._options.colorAttachments&&!this._options.depthAttachment)throw new Error("WebGLFramebuffer(): colorAttachments or depthAttachment must be specified");if(this._width=this._options.colorAttachments?this._options.colorAttachments[0].texture.width:this._options.depthAttachment.texture.width,this._height=this._options.colorAttachments?this._options.colorAttachments[0].texture.height:this._options.depthAttachment.texture.height,this._options.colorAttachments&&this._options.colorAttachments.findIndex(t=>t.texture.width!==this._width||t.texture.height!==this._height)>=0||this._options.depthAttachment&&(this._options.depthAttachment.texture.width!==this._width||this._options.depthAttachment.texture.height!==this._height))throw new Error("WebGLFramebuffer(): attachment textures must have same width and height");if(this._drawBuffers=this._options.colorAttachments?.map((t,e)=>Ln.COLOR_ATTACHMENT0+e)??[],this._isMRT=this._drawBuffers.length>1,this._options.depthAttachment){const t=this._options.depthAttachment.texture.format;this._depthAttachmentTarget=Lt(t)?Ln.DEPTH_STENCIL_ATTACHMENT:Ln.DEPTH_ATTACHMENT}else this._depthAttachmentTarget=Ln.NONE;const r=this._options.colorAttachments?.map(t=>t.texture.format).join(":")??"",a=this._options.depthAttachment?.texture.format??"";this._hash=`${r}-${a}-${this._options.sampleCount??1}`,this._needGenerateMipmaps=!1,this._initialized=!1}tagDraw(){this._drawTags++}isMRT(){return this._isMRT}invalidateMipmaps(){this._needGenerateMipmaps=!0}getWidth(){const t=this._options.colorAttachments?.[0]??this._options.depthAttachment;return Math.max(t.texture.width>>t.level,1)}getHeight(){const t=this._options.colorAttachments?.[0]??this._options.depthAttachment;return Math.max(t.texture.height>>t.level,1)}getHash(){return this._hash}restore(){if(!this._object&&!this._device.isContextLost()&&(this._options?.depthAttachment?.texture?.disposed&&this._options.depthAttachment.texture.reload(),this._options?.colorAttachments))for(const t of this._options.colorAttachments)t?.texture?.disposed&&t.texture.reload();this._init()}destroy(){if(this._object){if(this._device.context.deleteFramebuffer(this._object),this._object=null,this._colorAttachmentsAA){for(const t of this._colorAttachmentsAA)this._device.context.deleteRenderbuffer(t);this._colorAttachmentsAA=null}if(this._depthAttachmentAA&&(this._device.context.deleteRenderbuffer(this._depthAttachmentAA),this._depthAttachmentAA=null),this._framebufferAA&&(this._device.context.deleteFramebuffer(this._framebufferAA),this._framebufferAA=null),this._intermediateAttachments){for(const t of this._intermediateAttachments)for(const e of t[1])e&&(this._device.context.deleteTexture(e.texture),this._device.invalidateBindingTextures());this._intermediateAttachments=null}}}setColorAttachmentGenerateMipmaps(t,e){const i=this._options.colorAttachments?.[t];i&&(i.generateMipmaps=!!e)}getColorAttachmentGenerateMipmaps(t){return this._options.colorAttachments?.[t]?.generateMipmaps}setColorAttachmentCubeFace(t,e){const i=this._options.colorAttachments?.[t];i&&i.face!==e&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),i.face=e,this.bind()):i.face=e)}getColorAttachmentCubeFace(t){return this._options.colorAttachments?.[t]?.face}setColorAttachmentMipLevel(t,e){const i=this._options.colorAttachments?.[t];i&&i.level!==e&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),i.level=e,this.bind()):i.level=e)}getColorAttachmentMipLevel(t){return this._options.colorAttachments?.[t]?.level}setColorAttachmentLayer(t,e){const i=this._options.colorAttachments?.[t];i&&i.layer!==e&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),i.layer=e,this.bind()):i.layer=e)}getColorAttachmentLayer(t){return this._options?.colorAttachments?.[t]?.layer}setDepthAttachmentCubeFace(t){const e=this._options.depthAttachment;e&&e.face!==t&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),e.face=t,this.bind()):e.face=t)}getDepthAttachmentCubeFace(){return this._options.depthAttachment?.face}setDepthAttachmentLayer(t){const e=this._options.depthAttachment;e&&e.layer!==t&&(this._needBindBuffers=!0,this._device.context._currentFramebuffer===this?(this.unbind(),e.layer=t,this.bind()):e.layer=t)}getDepthAttachmentLayer(){return this._options.depthAttachment?.layer}getDepthAttachment(){return this._options?.depthAttachment?.texture||null}getColorAttachments(){return this._options.colorAttachments?.map(t=>t.texture||null)||[]}getColorAttachment(t){return this.getColorAttachments()[t]??null}bind(){if(this._initialized||(this._init(),this._initialized=!0),this._object){if(this._device.context._currentFramebuffer=this,this._lastDrawTag=-1,this._needBindBuffers&&(this._needBindBuffers=!1,!this._bindBuffersAA()||!this._bindBuffers()))return this._device.context.bindFramebuffer(Ln.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null,!1;this._device.context.bindFramebuffer(Ln.FRAMEBUFFER,this._framebufferAA||this._object);const t=this._device.drawBuffersExt;return t?t.drawBuffers(this._drawBuffers):this._isMRT&&console.error("device does not support multiple framebuffer color attachments"),this._device.setViewport(null),this._device.setScissor(null),this._needGenerateMipmaps=!1,!0}return!1}unbind(){if(this._device.context._currentFramebuffer===this){this._updateMSAABuffer(),this._device.context.bindFramebuffer(Ln.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null,this._device.setViewport(),this._device.setScissor();const t=this._device.drawBuffersExt;if(t&&t.drawBuffers([Ln.BACK]),this._options.colorAttachments)for(const t of this._options.colorAttachments){const e=t.texture;if(t.level>0){const i=this._intermediateAttachments?.get(e)?.[t.level];if(i){const s=this._device.context.createFramebuffer();this._device.context.bindFramebuffer(Ln.FRAMEBUFFER,s),this._device.context.framebufferTexture2D(Ln.FRAMEBUFFER,Ln.COLOR_ATTACHMENT0,Ln.TEXTURE_2D,i.texture,0),e.isTexture2D()?(this._device.bindTexture(Ln.TEXTURE_2D,0,e),this._device.context.copyTexSubImage2D(Ln.TEXTURE_2D,t.level,0,0,0,0,i.width,i.height)):e.isTextureCube()&&(this._device.bindTexture(Ln.TEXTURE_CUBE_MAP,0,e),this._device.context.copyTexSubImage2D(to[t.face??R.PX],t.level,0,0,0,0,i.width,i.height)),this._device.context.bindFramebuffer(Ln.FRAMEBUFFER,null),this._device.context.deleteFramebuffer(s)}}this._needGenerateMipmaps&&t.generateMipmaps&&e.mipLevelCount>1&&e.generateMipmaps()}}}_updateMSAABuffer(){if(this._options.sampleCount>1&&this._lastDrawTag!==this._drawTags){const t=this._device.context;t.bindFramebuffer(Ln.READ_FRAMEBUFFER,this._framebufferAA),t.bindFramebuffer(Ln.DRAW_FRAMEBUFFER,this._object);let e=0;this._options.ignoreDepthStencil||this._depthAttachmentTarget===Ln.NONE||(e=Ln.DEPTH_BUFFER_BIT|(this._depthAttachmentTarget===Ln.DEPTH_STENCIL_ATTACHMENT?Ln.STENCIL_BUFFER_BIT:0));for(let i=0;i<this._drawBuffers.length;i++){for(let t=0;t<this._drawBuffers.length;t++)this._drawBuffers[t]=t===i?Ln.COLOR_ATTACHMENT0+i:Ln.NONE;t.readBuffer(this._drawBuffers[i]),t.drawBuffers(this._drawBuffers),t.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,Ln.COLOR_BUFFER_BIT|e,Ln.NEAREST),e=0}0!==e&&t.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,e,Ln.NEAREST);for(let t=0;t<this._drawBuffers.length;t++)this._drawBuffers[t]=Ln.COLOR_ATTACHMENT0+t;t.bindFramebuffer(Ln.READ_FRAMEBUFFER,null),t.bindFramebuffer(Ln.DRAW_FRAMEBUFFER,null),this._lastDrawTag=this._drawTags}}_load(){this._device.isContextLost()||(this._options.sampleCount>1&&(this._framebufferAA=this._device.context.createFramebuffer(),this._colorAttachmentsAA=[],this._depthAttachmentAA=null,!this._bindBuffersAA())?this.dispose():(this._object=this._device.context.createFramebuffer(),this._device.context.bindFramebuffer(Ln.FRAMEBUFFER,this._object),this._bindBuffers()||this.dispose()),this._lastDrawTag=-1,this._device.context.bindFramebuffer(Ln.FRAMEBUFFER,null),this._device.context._currentFramebuffer=null)}_bindAttachment(t,e){if(e.texture){let i=null;if("webgl"===this.device.type&&!this.device.getDeviceCaps().framebufferCaps.supportRenderMipmap&&e.level>0){this._intermediateAttachments||(this._intermediateAttachments=new Map);let t=this._intermediateAttachments.get(e.texture);if(t||(t=[],this._intermediateAttachments.set(e.texture,t)),t[e.level])i=t[e.level].texture;else{let s=e.texture.width,r=e.texture.height,a=e.level;for(;a-- >0;)s=Math.max(s>>1,1),r=Math.max(r>>1,1);const n=this.device.getDeviceCaps().textureCaps.getTextureFormatInfo(e.texture.format);i=this._device.context.createTexture(),this._device.context.activeTexture(Ln.TEXTURE0),this._device.context.bindTexture(Ln.TEXTURE_2D,i),this._device.context.texImage2D(Ln.TEXTURE_2D,0,n.glInternalFormat,s,r,0,n.glFormat,n.glType[0],null),t[e.level]={texture:i,width:s,height:r},this._device.bindTexture(Ln.TEXTURE_2D,0,null)}}if(i)this._device.context.framebufferTexture2D(Ln.FRAMEBUFFER,t,Ln.TEXTURE_2D,i,0);else if(e.texture.isTexture2D())this._device.context.framebufferTexture2D(Ln.FRAMEBUFFER,t,Ln.TEXTURE_2D,e.texture.object,e.level??0);else if(e.texture.isTextureCube())this._device.context.framebufferTexture2D(Ln.FRAMEBUFFER,t,to[e.face??R.PX],e.texture.object,e.level??0);else{if(!e.texture.isTexture2DArray()&&!e.texture.isTexture3D())return!1;this._device.context.framebufferTextureLayer(Ln.FRAMEBUFFER,t,e.texture.object,e.level??0,e.layer??0)}return!0}return!1}_bindBuffers(){if(!this._object)return!1;if(this._device.context.bindFramebuffer(Ln.FRAMEBUFFER,this._object),this._depthAttachmentTarget!==Ln.NONE&&!this._bindAttachment(this._depthAttachmentTarget,this._options.depthAttachment))return!1;if(this._options.colorAttachments)for(let t=0;t<this._options.colorAttachments.length;t++){const e=this._options.colorAttachments[t];if(e.texture&&!this._bindAttachment(Ln.COLOR_ATTACHMENT0+t,e))return!1}if(0===this._status){const t=this._device.context.checkFramebufferStatus(Ln.FRAMEBUFFER);t!==Ln.FRAMEBUFFER_COMPLETE?(console.error(`Framebuffer not complete: ${t}`),this._status=2):this._status=1}return 1===this._status}_createRenderbufferAA(t){const e=this._device.context.createRenderbuffer(),i=this.device.getDeviceCaps().textureCaps.getTextureFormatInfo(t.format);return this._device.context.bindRenderbuffer(Ln.RENDERBUFFER,e),this._device.context.renderbufferStorageMultisample(Ln.RENDERBUFFER,this._options.sampleCount,i.glInternalFormat,this._options.depthAttachment.texture.width,this._options.depthAttachment.texture.height),e}_bindBuffersAA(){if(!this._framebufferAA)return!0;if(this._device.context.bindFramebuffer(Ln.FRAMEBUFFER,this._framebufferAA),this._depthAttachmentTarget!==Ln.NONE&&(this._depthAttachmentAA||(this._depthAttachmentAA=this._createRenderbufferAA(this._options.depthAttachment.texture)),this._device.context.framebufferRenderbuffer(Ln.FRAMEBUFFER,this._depthAttachmentTarget,Ln.RENDERBUFFER,this._depthAttachmentAA)),this._options.colorAttachments)for(let t=0;t<this._options.colorAttachments.length;t++){this._options.colorAttachments[t].texture&&(this._colorAttachmentsAA[t]||(this._colorAttachmentsAA[t]=this._createRenderbufferAA(this._options.colorAttachments[t].texture)),this._device.context.framebufferRenderbuffer(Ln.FRAMEBUFFER,Ln.COLOR_ATTACHMENT0+t,Ln.RENDERBUFFER,this._colorAttachmentsAA[t]))}if(0===this._statusAA){const t=this._device.context.checkFramebufferStatus(Ln.FRAMEBUFFER);t!==Ln.FRAMEBUFFER_COMPLETE?(console.error(`Framebuffer not complete: ${t}`),this._statusAA=2):this._statusAA=1}return 1===this._statusAA}_init(){if(1!==this._options.sampleCount&&4!==this._options.sampleCount)throw new Error(`WebGLFramebuffer(): Sample should be 1 or 4, got ${this._options.sampleCount}`);if(this._options.sampleCount>1&&!this._device.getDeviceCaps().framebufferCaps.supportMultisampledFramebuffer)throw new Error("WebGLFramebuffer(): Multisampled frame buffer not supported");this._load()}isFramebuffer(){return!0}getSampleCount(){return this._options.sampleCount}}class xo{static _defaultState;static _currentState;apply(t,e){const i=this.constructor;(e||i._currentState!==this)&&this._apply(t),i._currentState=this}static get defaultState(){return xo._defaultState}static applyDefaults(t,e){(e||this._currentState!==this._defaultState)&&this._defaultState.apply(t,e)}}class bo extends xo{static _defaultState=new bo;static _currentState=null;redMask;greenMask;blueMask;alphaMask;constructor(){super(),this.redMask=this.greenMask=this.blueMask=this.alphaMask=!0}clone(){return(new bo).setColorMask(this.redMask,this.greenMask,this.blueMask,this.alphaMask)}setColorMask(t,e,i,s){return this.redMask=t,this.greenMask=e,this.blueMask=i,this.alphaMask=s,this}_apply(t){t.colorMask(this.redMask,this.greenMask,this.blueMask,this.alphaMask)}}class vo extends xo{static _defaultState=new vo;static _currentState=null;_srcBlendRGB;_dstBlendRGB;_srcBlendAlpha;_dstBlendAlpha;_rgbEquation;_alphaEquation;enabled;alphaToCoverageEnabled;constructor(){super(),this.enabled=!1,this.alphaToCoverageEnabled=!1,this.srcBlendRGB="one",this.dstBlendRGB="zero",this.srcBlendAlpha="one",this.dstBlendAlpha="zero",this.rgbEquation="add",this.alphaEquation="add"}clone(){const t=new vo;return t.enable(this.enabled),t.enableAlphaToCoverage(this.alphaToCoverageEnabled),t.setBlendFuncRGB(this.srcBlendRGB,this.dstBlendRGB),t.setBlendFuncAlpha(this.srcBlendAlpha,this.dstBlendAlpha),t.setBlendEquation(this.rgbEquation,this.alphaEquation),t}get srcBlendRGB(){return Gn[this._srcBlendRGB]}set srcBlendRGB(t){this._srcBlendRGB=Un[t]}get dstBlendRGB(){return Gn[this._dstBlendRGB]}set dstBlendRGB(t){this._dstBlendRGB=Un[t]}get srcBlendAlpha(){return Gn[this._srcBlendAlpha]}set srcBlendAlpha(t){this._srcBlendAlpha=Un[t]}get dstBlendAlpha(){return Gn[this._dstBlendAlpha]}set dstBlendAlpha(t){this._dstBlendAlpha=Un[t]}get rgbEquation(){return kn[this._rgbEquation]}set rgbEquation(t){this._rgbEquation=On[t]}get alphaEquation(){return kn[this._alphaEquation]}set alphaEquation(t){this._alphaEquation=On[t]}enable(t){return this.enabled=!!t,this}enableAlphaToCoverage(t){return this.alphaToCoverageEnabled=!!t,this}setBlendFunc(t,e){return this.srcBlendRGB=t,this.dstBlendRGB=e,this.srcBlendAlpha=t,this.dstBlendAlpha=e,this}setBlendFuncRGB(t,e){return this.srcBlendRGB=t,this.dstBlendRGB=e,this}setBlendFuncAlpha(t,e){return this.srcBlendAlpha=t,this.dstBlendAlpha=e,this}setBlendEquation(t,e){return this.rgbEquation=t,this.alphaEquation=e,this}_apply(t){this.enabled?(t.enable(Ln.BLEND),t.blendEquationSeparate(this._rgbEquation,this._alphaEquation),this._srcBlendRGB===this._srcBlendAlpha&&this._dstBlendRGB===this._dstBlendAlpha?t.blendFunc(this._srcBlendRGB,this._dstBlendRGB):t.blendFuncSeparate(this._srcBlendRGB,this._dstBlendRGB,this._srcBlendAlpha,this._dstBlendAlpha)):t.disable(Ln.BLEND),this.alphaToCoverageEnabled?t.enable(Ln.SAMPLE_ALPHA_TO_COVERAGE):t.disable(Ln.SAMPLE_ALPHA_TO_COVERAGE)}}class yo extends xo{static _defaultState=new yo;static _currentState=null;_cullMode;constructor(){super(),this.cullMode="back"}clone(){return(new yo).setCullMode(this.cullMode)}get cullMode(){return Wn[this._cullMode]}set cullMode(t){this._cullMode=Hn[t]}setCullMode(t){return this.cullMode=t,this}get depthClampEnabled(){return!1}set depthClampEnabled(t){this.enableDepthClamp(t)}enableDepthClamp(t){return t&&console.error("Depth clamp not supported"),this}_apply(t){"none"==this.cullMode?t.disable(Ln.CULL_FACE):(t.enable(Ln.CULL_FACE),t.cullFace(this._cullMode))}}class To extends xo{static _defaultState=new To;static _currentState=null;testEnabled;writeEnabled;depthBias;depthBiasSlopeScale;_compareFunc;constructor(){super(),this.testEnabled=!0,this.writeEnabled=!0,this.compareFunc="le",this.depthBias=0,this.depthBiasSlopeScale=0}clone(){const t=new To;return t.enableTest(this.testEnabled),t.enableWrite(this.writeEnabled),t.setCompareFunc(this.compareFunc),t.setDepthBias(this.depthBias),t.setDepthBiasSlopeScale(this.depthBiasSlopeScale),t}get compareFunc(){return qn[this._compareFunc]}set compareFunc(t){this._compareFunc=Qn[t]}enableTest(t){return this.testEnabled=t,this}enableWrite(t){return this.writeEnabled=t,this}setCompareFunc(t){return this.compareFunc=t,this}setDepthBias(t){return this.depthBias=t,this}setDepthBiasSlopeScale(t){return this.depthBiasSlopeScale=t,this}_apply(t){this.testEnabled?(t.enable(Ln.DEPTH_TEST),t.depthFunc(this._compareFunc)):t.disable(Ln.DEPTH_TEST),t.depthMask(this.writeEnabled),0!==this.depthBias||0!==this.depthBiasSlopeScale?(t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(this.depthBiasSlopeScale,this.depthBias)):t.disable(t.POLYGON_OFFSET_FILL)}}class wo extends xo{static _defaultState=new wo;static _currentState=null;enabled;writeMask;ref;readMask;_failOp;_failOpBack;_zFailOp;_zFailOpBack;_passOp;_passOpBack;_func;_funcBack;constructor(){super(),this.enabled=!1,this.failOp=this.failOpBack="keep",this.zFailOp=this.zFailOpBack="keep",this.passOp=this.passOpBack="keep",this.func=this.funcBack="always",this.ref=0,this.writeMask=4294967295,this.readMask=4294967295}clone(){const t=new wo;return t.enable(this.enabled),t.setWriteMask(this.writeMask),t.setFrontOp(this.failOp,this.zFailOp,this.passOp),t.setBackOp(this.failOpBack,this.zFailOpBack,this.passOpBack),t.setFrontCompareFunc(this.func),t.setBackCompareFunc(this.funcBack),t.setReference(this.ref),t.setReadMask(this.readMask),t}get failOp(){return jn[this._failOp]}set failOp(t){this._failOp=Xn[t]}get failOpBack(){return jn[this._failOpBack]}set failOpBack(t){this._failOpBack=Xn[t]}get zFailOp(){return jn[this._zFailOp]}set zFailOp(t){this._zFailOp=Xn[t]}get zFailOpBack(){return jn[this._zFailOpBack]}set zFailOpBack(t){this._zFailOpBack=Xn[t]}get passOp(){return jn[this._passOp]}set passOp(t){this._passOp=Xn[t]}get passOpBack(){return jn[this._passOpBack]}set passOpBack(t){this._passOpBack=Xn[t]}get func(){return qn[this._func]}set func(t){this._func=Qn[t]}get funcBack(){return qn[this._funcBack]}set funcBack(t){this._funcBack=Qn[t]}enable(t){return this.enabled=t,this}setWriteMask(t){return this.writeMask=t,this}setFrontOp(t,e,i){return this.failOp=t,this.zFailOp=e,this.passOp=i,this}setBackOp(t,e,i){return this.failOpBack=t,this.zFailOpBack=e,this.passOpBack=i,this}setFrontCompareFunc(t){return this.func=t,this}setBackCompareFunc(t){return this.funcBack=t,this}setReference(t){return this.ref=t,this}setReadMask(t){return this.readMask=t,this}_apply(t){this.enabled?(t.enable(Ln.STENCIL_TEST),t.stencilMaskSeparate(Ln.FRONT,this.writeMask),t.stencilMaskSeparate(Ln.BACK,this.writeMask),t.stencilFuncSeparate(Ln.FRONT,this._func,this.ref,this.readMask),t.stencilFuncSeparate(Ln.BACK,this._funcBack,this.ref,this.readMask),t.stencilOpSeparate(Ln.FRONT,this._failOp,this._zFailOp,this._passOp),t.stencilOpSeparate(Ln.BACK,this._failOpBack,this._zFailOpBack,this._passOpBack)):t.disable(Ln.STENCIL_TEST)}}class So{_gl;colorState;blendingState;rasterizerState;depthState;stencilState;constructor(t){this._gl=t,this.colorState=null,this.blendingState=null,this.rasterizerState=null,this.depthState=null,this.stencilState=null}clone(){const t=new So(this._gl);return t.colorState=this.colorState?.clone()??null,t.blendingState=this.blendingState?.clone()??null,t.rasterizerState=this.rasterizerState?.clone()??null,t.depthState=this.depthState?.clone()??null,t.stencilState=this.stencilState?.clone()??null,t}copyFrom(t){this.colorState=t.colorState,this.blendingState=t.blendingState,this.rasterizerState=t.rasterizerState,this.depthState=t.depthState,this.stencilState=t.stencilState}apply(t){const e=this._gl;this.colorState?this.colorState.apply(e,t):bo.applyDefaults(e,t),this.blendingState?this.blendingState.apply(e,t):vo.applyDefaults(e,t),this.rasterizerState?this.rasterizerState.apply(e,t):yo.applyDefaults(e,t),this.depthState?this.depthState.apply(e,t):To.applyDefaults(e,t),this.stencilState?this.stencilState.apply(e,t):wo.applyDefaults(e,t)}useColorState(t){return this.colorState=t??this.colorState??new bo}defaultColorState(){this.colorState=null}useBlendingState(t){return this.blendingState=t??this.blendingState??new vo}defaultBlendingState(){this.blendingState=null}useRasterizerState(t){return this.rasterizerState=t??this.rasterizerState??new yo}defaultRasterizerState(){this.rasterizerState=null}useDepthState(t){return this.depthState=t??this.depthState??new To}defaultDepthState(){this.depthState=null}useStencilState(t){return this.stencilState=t??this.stencilState??new wo}defaultStencilState(){this.stencilState=null}static applyDefaults(t,e){bo.applyDefaults(t,e),vo.applyDefaults(t,e),yo.applyDefaults(t,e),To.applyDefaults(t,e),wo.applyDefaults(t,e)}}class Ao{_device;_query;_state;_timerQuery;_gpuTime;constructor(t){this._device=t,this._state=0,this._gpuTime=null;const e=this._device.context;if(zn(e)){const t=e.getExtension("EXT_disjoint_timer_query_webgl2");t&&(this._timerQuery={createQuery:e.createQuery.bind(e),deleteQuery:e.deleteQuery.bind(e),beginQuery:e.beginQuery.bind(e),endQuery:e.endQuery.bind(e),isQuery:e.isQuery.bind(e),getQuery:e.getQuery.bind(e),getQueryObject:e.getQueryParameter.bind(e),queryCounter:t.queryCounterEXT.bind(t)})}else{const t=e.getExtension("EXT_disjoint_timer_query");t&&(this._timerQuery={createQuery:t.createQueryEXT.bind(t),deleteQuery:t.deleteQueryEXT.bind(t),beginQuery:t.beginQueryEXT.bind(t),endQuery:t.endQueryEXT.bind(t),isQuery:t.isQueryEXT.bind(t),getQuery:t.getQueryEXT.bind(t),getQueryObject:t.getQueryObjectEXT.bind(t),queryCounter:t.queryCounterEXT.bind(t)})}this._query=this._timerQuery?this._timerQuery.createQuery():null}get gpuTimerSupported(){return!!this._query}begin(){1===this._state&&this.end(),this._query&&this._timerQuery.beginQuery(35007,this._query),this._gpuTime=null,this._state=1}end(){1===this._state&&(this._query&&this._timerQuery.endQuery(35007),this._state=2)}ended(){return 1!==this._state}elapsed(){if(2===this._state&&null===this._gpuTime&&this._query&&this._timerQuery.getQueryObject(this._query,Ln.QUERY_RESULT_AVAILABLE)){this._device.context.getParameter(36795)||(this._gpuTime=Number(this._timerQuery.getQueryObject(this._query,Ln.QUERY_RESULT))/1e6)}return this._gpuTime}}class Co{_isWebGL2;_extDrawBuffers;_extFloatBlending;_extRenderMipmap;maxDrawBuffers;maxColorAttachmentBytesPerSample;supportRenderMipmap;supportMultisampledFramebuffer;supportFloatBlending;supportDepth32float;supportDepth32floatStencil8;constructor(t){this._isWebGL2=zn(t),this._extDrawBuffers=this._isWebGL2?null:t.getExtension("WEBGL_draw_buffers"),this._extFloatBlending=t.getExtension("EXT_float_blend"),this._extRenderMipmap=this._isWebGL2?null:t.getExtension("OES_fbo_render_mipmap"),this.maxDrawBuffers=this._isWebGL2||this._extDrawBuffers?Math.min(t.getParameter(Ln.MAX_COLOR_ATTACHMENTS),t.getParameter(Ln.MAX_DRAW_BUFFERS)):1,this.maxColorAttachmentBytesPerSample=16*this.maxDrawBuffers,this.supportRenderMipmap=zn(t)||!!this._extRenderMipmap,this.supportMultisampledFramebuffer=zn(t),this.supportFloatBlending=!!this._extFloatBlending,this.supportDepth32float=this._isWebGL2,this.supportDepth32floatStencil8=this._isWebGL2}}class Eo{_isWebGL2;_extIndexUint32;_extBlendMinMax;supportOversizedViewport;supportBlendMinMax;support32BitIndex;supportDepthClamp;maxBindGroups;maxTexCoordIndex;constructor(t){this._isWebGL2=zn(t),this._extBlendMinMax=null,this._extIndexUint32=t.getExtension("OES_element_index_uint"),this._isWebGL2?(this.supportBlendMinMax=!0,this.support32BitIndex=!0):(this._extBlendMinMax=t.getExtension("EXT_blend_minmax"),this.supportBlendMinMax=!!this._extBlendMinMax,this.support32BitIndex=!!this._extIndexUint32),this.supportOversizedViewport=!0,this.supportDepthClamp=!1,this.maxBindGroups=4,this.maxTexCoordIndex=8}}class Mo{_extFragDepth;_extStandardDerivatives;_extShaderTextureLod;supportFragmentDepth;supportStandardDerivatives;supportShaderTextureLod;supportHighPrecisionFloat;supportHighPrecisionInt;maxUniformBufferSize;uniformBufferOffsetAlignment;maxStorageBufferSize;storageBufferOffsetAlignment;constructor(t){this._extFragDepth=null,this._extStandardDerivatives=null,this.maxStorageBufferSize=0,this.storageBufferOffsetAlignment=0,zn(t)?(this.supportFragmentDepth=!0,this.supportStandardDerivatives=!0,this.supportShaderTextureLod=!0,this.supportHighPrecisionFloat=!0,this.maxUniformBufferSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE)||16384,this.uniformBufferOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT)||256):(this._extFragDepth=t.getExtension("EXT_frag_depth"),this.supportFragmentDepth=!!this._extFragDepth,this._extStandardDerivatives=t.getExtension("OES_standard_derivatives"),this.supportStandardDerivatives=!!this._extStandardDerivatives,this._extShaderTextureLod=t.getExtension("EXT_shader_texture_lod"),this.supportShaderTextureLod=!!this._extShaderTextureLod,this.supportHighPrecisionFloat=t.getShaderPrecisionFormat&&!!t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT)?.precision&&!!t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT)?.precision,this.maxUniformBufferSize=0,this.uniformBufferOffsetAlignment=1)}}class Bo{_isWebGL2;_extS3TC;_extS3TCSRGB;_extBPTC;_extRGTC;_extASTC;_extTextureFilterAnisotropic;_extDepthTexture;_extSRGB;_extTextureFloat;_extTextureFloatLinear;_extTextureHalfFloat;_extTextureHalfFloatLinear;_textureFormatInfos;maxTextureSize;maxCubeTextureSize;npo2Mipmapping;npo2Repeating;supportS3TC;supportS3TCSRGB;supportBPTC;supportRGTC;supportASTC;supportDepthTexture;support3DTexture;supportSRGBTexture;supportFloatTexture;supportLinearFloatTexture;supportHalfFloatTexture;supportLinearHalfFloatTexture;supportAnisotropicFiltering;supportFloatColorBuffer;supportHalfFloatColorBuffer;supportFloatBlending;constructor(t){if(this._isWebGL2=zn(t),this._extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.supportAnisotropicFiltering=!!this._extTextureFilterAnisotropic,this._isWebGL2?this.supportDepthTexture=!0:(this._extDepthTexture=t.getExtension("WEBGL_depth_texture"),this.supportDepthTexture=!!this._extDepthTexture),this.support3DTexture=this._isWebGL2,this._extSRGB=this._isWebGL2?null:t.getExtension("EXT_sRGB"),this.supportSRGBTexture=this._isWebGL2||!!this._extSRGB,this._isWebGL2?this.supportFloatTexture=!0:(this._extTextureFloat=t.getExtension("OES_texture_float"),this.supportFloatTexture=!!this._extTextureFloat),this._extTextureFloatLinear=t.getExtension("OES_texture_float_linear"),this.supportLinearFloatTexture=!!this._extTextureFloatLinear,this._isWebGL2?(this.supportHalfFloatTexture=!0,this.supportLinearHalfFloatTexture=!0):(this._extTextureHalfFloat=t.getExtension("OES_texture_half_float"),this.supportHalfFloatTexture=!!this._extTextureHalfFloat,this._extTextureHalfFloatLinear=t.getExtension("OES_texture_half_float_linear"),this.supportLinearHalfFloatTexture=!!this._extTextureHalfFloatLinear),this._isWebGL2?t.getExtension("EXT_color_buffer_float")?(this.supportHalfFloatColorBuffer=!0,this.supportFloatColorBuffer=!0):t.getExtension("EXT_color_buffer_half_float")?(this.supportHalfFloatColorBuffer=!0,this.supportFloatColorBuffer=!1):(this.supportHalfFloatColorBuffer=!1,this.supportFloatColorBuffer=!1):(this.supportFloatColorBuffer=!!t.getExtension("WEBGL_color_buffer_float"),this.supportHalfFloatColorBuffer=!!t.getExtension("EXT_color_buffer_half_float")),this.supportFloatBlending=this.supportFloatColorBuffer&&!!t.getExtension("EXT_float_blend"),this._extS3TC=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),this.supportS3TC=!!this._extS3TC,this._extS3TCSRGB=t.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.supportS3TCSRGB=!!this._extS3TCSRGB,this._extBPTC=t.getExtension("EXT_texture_compression_bptc"),this.supportBPTC=!!this._extBPTC,this._extRGTC=t.getExtension("EXT_texture_compression_rgtc"),this.supportRGTC=!!this._extRGTC,this._extASTC=t.getExtension("WEBGL_compressed_texture_astc"),this.supportASTC=!!this._extASTC,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._isWebGL2?(this.npo2Mipmapping=!0,this.npo2Repeating=!0):(this.npo2Mipmapping=!1,this.npo2Repeating=!1),this._textureFormatInfos={rgba8unorm:{glFormat:t.RGBA,glInternalFormat:this._isWebGL2?t.RGBA8:t.RGBA,glType:[t.UNSIGNED_BYTE,t.UNSIGNED_SHORT_4_4_4_4,t.UNSIGNED_SHORT_5_5_5_1],filterable:!0,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4}},this.supportASTC)for(const e of["4x4","5x4","5x5","6x5","6x6","8x5","8x6","8x8","10x5","10x6","10x8","10x10","12x10","12x12"]){const[i,s]=e.split("x").map(t=>Number(t));this._textureFormatInfos[`astc-${e}`]={glFormat:t.NONE,glInternalFormat:this._extASTC[`COMPRESSED_RGBA_ASTC_${e}_KHR`],glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:i,blockHeight:s},this._textureFormatInfos[`astc-${e}-srgb`]={glFormat:t.NONE,glInternalFormat:this._extASTC[`COMPRESSED_SRGB8_ALPHA8_ASTC_${e}_KHR`],glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:i,blockHeight:s}}this.supportS3TC&&(this._textureFormatInfos.dxt1={glFormat:t.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:8,blockWidth:4,blockHeight:4},this._textureFormatInfos.dxt3={glFormat:t.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos.dxt5={glFormat:t.NONE,glInternalFormat:this._extS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4}),this.supportS3TCSRGB&&(this._textureFormatInfos["dxt1-srgb"]={glFormat:t.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:8,blockWidth:4,blockHeight:4},this._textureFormatInfos["dxt3-srgb"]={glFormat:t.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["dxt5-srgb"]={glFormat:t.NONE,glInternalFormat:this._extS3TCSRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4}),this.supportRGTC&&(this._textureFormatInfos.bc4={glFormat:t.NONE,glInternalFormat:this._extRGTC.COMPRESSED_RED_RGTC1_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:8,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc4-signed"]={glFormat:t.NONE,glInternalFormat:this._extRGTC.COMPRESSED_SIGNED_RED_RGTC1_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:8,blockWidth:4,blockHeight:4},this._textureFormatInfos.bc5={glFormat:t.NONE,glInternalFormat:this._extRGTC.COMPRESSED_RED_GREEN_RGTC2_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc5-signed"]={glFormat:t.NONE,glInternalFormat:this._extRGTC.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4}),this.supportBPTC&&(this._textureFormatInfos.bc6h={glFormat:t.NONE,glInternalFormat:this._extBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc6h-signed"]={glFormat:t.NONE,glInternalFormat:this._extBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos.bc7={glFormat:t.NONE,glInternalFormat:this._extBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc7-srgb"]={glFormat:t.NONE,glInternalFormat:this._extBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT,glType:[t.NONE],filterable:!0,renderable:!1,compressed:!0,size:16,blockWidth:4,blockHeight:4}),zn(t)?(this._textureFormatInfos.r8unorm={glFormat:t.RED,glInternalFormat:t.R8,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r8snorm={glFormat:t.RED,glInternalFormat:t.R8_SNORM,glType:[t.BYTE],filterable:!0,renderable:!1,compressed:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r16f={glFormat:t.RED,glInternalFormat:t.R16F,glType:[t.HALF_FLOAT,t.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.r32f={glFormat:t.RED,glInternalFormat:t.R32F,glType:[t.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.r8ui={glFormat:t.RED_INTEGER,glInternalFormat:t.R8UI,glType:[t.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r8i={glFormat:t.RED_INTEGER,glInternalFormat:t.R8I,glType:[t.BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r16ui={glFormat:t.RED_INTEGER,glInternalFormat:t.R16UI,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.r16i={glFormat:t.RED_INTEGER,glInternalFormat:t.R16I,glType:[t.SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.r32ui={glFormat:t.RED_INTEGER,glInternalFormat:t.R32UI,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.r32i={glFormat:t.RED_INTEGER,glInternalFormat:t.R32I,glType:[t.INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg8unorm={glFormat:t.RG,glInternalFormat:t.RG8,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg8snorm={glFormat:t.RG,glInternalFormat:t.RG8_SNORM,glType:[t.BYTE],filterable:!0,renderable:!1,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg16f={glFormat:t.RG,glInternalFormat:t.RG16F,glType:[t.HALF_FLOAT,t.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg32f={glFormat:t.RG,glInternalFormat:t.RG32F,glType:[t.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rg8ui={glFormat:t.RG,glInternalFormat:t.RG8UI,glType:[t.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg8i={glFormat:t.RG,glInternalFormat:t.RG8I,glType:[t.BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg16ui={glFormat:t.RG,glInternalFormat:t.RG16UI,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg16i={glFormat:t.RG,glInternalFormat:t.RG16I,glType:[t.SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg32ui={glFormat:t.RG,glInternalFormat:t.RG32UI,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rg32i={glFormat:t.RG,glInternalFormat:t.RG32I,glType:[t.INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos["rgba8unorm-srgb"]={glFormat:t.RGBA,glInternalFormat:t.SRGB8_ALPHA8,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rgba8snorm={glFormat:t.RGBA,glInternalFormat:t.RGBA8_SNORM,glType:[t.BYTE],filterable:!0,renderable:!1,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rgba16f={glFormat:t.RGBA,glInternalFormat:t.RGBA16F,glType:[t.HALF_FLOAT,t.FLOAT],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rgba32f={glFormat:t.RGBA,glInternalFormat:t.RGBA32F,glType:[t.FLOAT],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:16},this._textureFormatInfos.rgba8ui={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA8UI,glType:[t.UNSIGNED_BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rgba8i={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA8I,glType:[t.BYTE],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rgba16ui={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA16UI,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rgba16i={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA16I,glType:[t.SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rgba32ui={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA32UI,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:16},this._textureFormatInfos.rgba32i={glFormat:t.RGBA_INTEGER,glInternalFormat:t.RGBA32I,glType:[t.INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:16},this._textureFormatInfos.rg11b10uf={glFormat:t.RGB,glInternalFormat:t.R11F_G11F_B10F,glType:[t.UNSIGNED_INT_10F_11F_11F_REV],filterable:!0,renderable:!1,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d16={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT16,glType:[t.UNSIGNED_SHORT,t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.d24={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT24,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d32f={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT32F,glType:[t.FLOAT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d24s8={glFormat:t.DEPTH_STENCIL,glInternalFormat:t.DEPTH24_STENCIL8,glType:[t.UNSIGNED_INT_24_8],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d32fs8={glFormat:t.DEPTH_STENCIL,glInternalFormat:t.DEPTH32F_STENCIL8,glType:[t.FLOAT_32_UNSIGNED_INT_24_8_REV],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:8}):(this.supportFloatTexture&&(this._textureFormatInfos.rgba32f={glFormat:t.RGBA,glInternalFormat:t.RGBA,glType:[t.FLOAT,t.UNSIGNED_BYTE,t.UNSIGNED_SHORT_4_4_4_4,t.UNSIGNED_SHORT_5_5_5_1],filterable:this.supportLinearFloatTexture,renderable:this.supportFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:16}),this.supportHalfFloatTexture&&(this._textureFormatInfos.rgba16f={glFormat:t.RGBA,glInternalFormat:t.RGBA,glType:[this._extTextureHalfFloat.HALF_FLOAT_OES,t.UNSIGNED_BYTE,t.UNSIGNED_SHORT_4_4_4_4,t.UNSIGNED_SHORT_5_5_5_1],filterable:this.supportLinearHalfFloatTexture,renderable:this.supportHalfFloatColorBuffer,compressed:!1,blockWidth:1,blockHeight:1,size:8}),this.supportSRGBTexture&&(this._textureFormatInfos["rgba8unorm-srgb"]={glFormat:this._extSRGB.SRGB_ALPHA_EXT,glInternalFormat:this._extSRGB.SRGB_ALPHA_EXT,glType:[t.UNSIGNED_BYTE],filterable:!0,renderable:!1,compressed:!1,blockWidth:1,blockHeight:1,size:4}),this.supportDepthTexture&&(this._textureFormatInfos.d16={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT,glType:[t.UNSIGNED_SHORT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.d24={glFormat:t.DEPTH_COMPONENT,glInternalFormat:t.DEPTH_COMPONENT,glType:[t.UNSIGNED_INT],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d24s8={glFormat:t.DEPTH_STENCIL,glInternalFormat:t.DEPTH_STENCIL,glType:[this._extDepthTexture.UNSIGNED_INT_24_8_WEBGL],filterable:!1,renderable:!0,compressed:!1,blockWidth:1,blockHeight:1,size:4}))}calcMemoryUsage(t,e,i){switch(t){case"d16":case"d24":case"d24s8":case"d32f":return e===Ln.UNSIGNED_SHORT?2*i:4*i;case"d32fs8":case"rg32f":case"rg32i":case"rg32ui":case"rgba16i":case"rgba16ui":return 8*i;case"dxt1":case"dxt1-srgb":return i/2;case"dxt3":case"dxt3-srgb":case"dxt5":case"dxt5-srgb":case"r8unorm":case"r8snorm":case"r8i":case"r8ui":return i;case"r16f":return e===Ln.HALF_FLOAT?2*i:4*i;case"r16i":case"r16ui":case"rg8unorm":case"rg8snorm":case"rg8i":case"rg8ui":return 2*i;case"r32f":case"r32i":case"r32ui":case"rg16i":case"rg16ui":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8i":case"rgba8ui":return 4*i;case"rg16f":return e===Ln.HALF_FLOAT?4*i:8*i;case"rgba16f":return e===Ln.HALF_FLOAT?8*i:16*i;case"rgba32f":case"rgba32i":case"rgba32ui":return 16*i;default:return 0}}getTextureFormatInfo(t){return this._textureFormatInfos[t]}}class Io extends po{_structure;_data;constructor(t,e,i,s){if(!e?.isStructType())throw new Error("invalid structure type");if(i&nr.BF_INDEX)throw new Error("structured buffer must not have Index usage flag");if(i&(nr.BF_READ|nr.BF_WRITE|nr.BF_PACK_PIXEL|nr.BF_UNPACK_PIXEL))throw new Error("structured buffer must not have Read or Write usage flags");if(i&nr.BF_VERTEX){if(1!==e.structMembers.length||!e.structMembers[0].type.isArrayType())throw new Error("structured buffer for vertex usage must have only one array member");if(!Io.isValidArrayElementType(e.structMembers[0].type.elementType))throw new Error("invalid vertex data type when creating vertex buffer")}const r=e.toBufferLayout(0,e.layout);if(s&&r.byteSize!==s.byteLength)throw new Error(`create structured buffer failed: invalid source size: ${s.byteLength}, should be ${r.byteSize}`);const a=!t.isWebGL2&&0!==(i&nr.BF_UNIFORM);super(t,i,s||r.byteSize,a),this._data=new Nn(r,a?this.systemMemoryBuffer:this),this._structure=e}set(t,e){this._data.set(t,e)}get structure(){return this._structure}set structure(t){if(t&&!t.isCompatibleType(this._structure)){const e=t.toBufferLayout(0,t.layout);if(e.byteSize>this.byteLength)throw new Error(`set structure type failed: new structure type is too large: ${e.byteSize}`);this._data=new Nn(e,this),this._structure=t}}getUniformData(){return this._data}static isValidArrayElementType(t){if(t.isPrimitiveType())return t.scalarType!==te.BOOL&&!t.isMatrixType();if(t.isStructType()){for(const e of t.structMembers)if(!e.type.isPrimitiveType()||e.type.scalarType===te.BOOL||e.type.isMatrixType())return!1;return!0}return!1}}class Po extends ro{_layout;_dynamicOffsets;_resources;_createdBuffers;constructor(t,e){super(t),this._device=t,this._layout=e,this._dynamicOffsets=null,this._resources={},this._object={},this._createdBuffers=[];for(const t of this._layout.entries)t.buffer&&t.buffer.hasDynamicOffset&&(this._dynamicOffsets||(this._dynamicOffsets=[]),this._dynamicOffsets[t.buffer.dynamicOffsetIndex]=0)}getGPUId(){return String(this._uid)}getLayout(){return this._layout}getBuffer(t,e=!0){return this._getBuffer(t,e)}getDynamicOffsets(){return this._dynamicOffsets}setBuffer(t,e,i,s,r){const a=this._layout.nameMap?.[t]??t;for(const s of this._layout.entries)if(s.name===a)return void(s.buffer?(!e||e.usage&nr.BF_UNIFORM?e!==this._resources[s.name]&&(this._resources[s.name]=e):console.error(`setBuffer() failed: buffer resource '${t}' must be type '${s.buffer.type}'`),s.buffer.hasDynamicOffset&&(this._dynamicOffsets[s.buffer.dynamicOffsetIndex]=i??0)):console.error(`setBuffer() failed: resource '${t}' is not buffer`));console.error(`setBuffer() failed: no buffer resource named '${t}'`)}setRawData(t,e,i,s,r){const a=this._layout.nameMap?.[t];if(a)this.setRawData(a,e,i,s,r);else{const a=this._getBuffer(t,!1);a?a.bufferSubData(e,i,s,r):console.error(`set(): no uniform buffer named '${t}'`)}}setValue(t,e){const i=this._layout.nameMap?.[t];if(i)this.setValue(i,{[t]:e});else{const i=this._getBuffer(t,!1);if(i){if(!(i instanceof Io))throw new Error(`BindGroup.setValue() failed: '${t}' is not structured buffer`);if(e?.BYTES_PER_ELEMENT)i.bufferSubData(0,e);else for(const t in e)i.set(t,e[t])}else console.error(`set(): no uniform buffer named '${t}'`)}}setTextureView(t,e,i,s,r,a){throw new Error("setTextureView() not supported for webgl device")}getTexture(t){if(this._findTextureLayout(t))return this._resources[t]?.[0]||null;throw new Error(`getTexture() failed:${t} is not a texture`)}setTexture(t,e,i){const s=this._findTextureLayout(t);s?this._resources[t]=[e,i||e.getDefaultSampler(!!s.texture?.autoBindSamplerComparison)]:console.error(`setTexture() failed: no texture uniform named '${t}'`)}setSampler(t,e){}apply(t,e){const i=this._device.isWebGL2,s=e??this.getDynamicOffsets();for(let e=0;e<this._layout.entries.length;e++){const r=this._layout.entries[e],a=this._resources[r.name];a instanceof po?i?r.buffer.hasDynamicOffset?t.setBlock(r.type.structName,a,s[r.buffer.dynamicOffsetIndex]):t.setBlock(r.type.structName,a,0):a instanceof Io&&t.setUniform(r.name,a.getUniformData().uniforms):Array.isArray(a)&&(a[0].isTextureVideo()&&a[0].updateVideoFrame(),t.setUniform(r.name,a))}}destroy(){this._resources={},this._object=null;for(const t of this._createdBuffers)t.dispose();this._createdBuffers=[]}restore(){this._object={}}isBindGroup(){return!0}_getBuffer(t,e=!1){const i=this._layout.nameMap?.[t]??t;for(const t of this._layout.entries)if(t.buffer&&t.name===i){let i=this._resources[t.name];return i||e||(i=this._device.createStructuredBuffer(t.type,{usage:"uniform"}),this._resources[t.name]=i,this._createdBuffers.push(i)),i}return null}_findTextureLayout(t){for(const e of this._layout.entries)if((e.texture||e.storageTexture||e.externalTexture)&&e.name===t)return e;return null}}class $o extends ro{_vs;_fs;_unitCounter;_uniformSetters;_uniformInfo;_blockInfo;_bindGroupLayouts;_vertexAttributes;_error;_vertexShader;_fragmentShader;constructor(t,e,i,s,r){super(t),this._object=this._device.context.createProgram(),this._unitCounter=0,this._uniformSetters=null,this._uniformInfo=null,this._blockInfo=null,this._error="",this._vertexShader=null,this._fragmentShader=null,this._vs=e,this._fs=i,this._bindGroupLayouts=[...s],this._vertexAttributes=[...r],this.load()}get type(){return"render"}getCompileError(){return this._error}getShaderSource(t){switch(t){case"vertex":return this._vs;case"fragment":return this._fs;case"compute":return null}}getBindingInfo(t){for(let e=0;e<this._bindGroupLayouts.length;e++){const i=this._bindGroupLayouts[e],s=i.nameMap?.[t]??t;for(let t=0;t<i.entries.length;t++){const r=i.entries[t];if(r.name===s)return{group:e,binding:t,type:r.type}}}return null}get bindGroupLayouts(){return this._bindGroupLayouts}get vertexAttributes(){return this._vertexAttributes}setUniform(t,e){const i=this._uniformSetters[t];if(i)i(e);else{const i=Object.getPrototypeOf(e);i===Object.getPrototypeOf({})?this._setUniformStruct(t,e):i==Object.getPrototypeOf([])&&this._setUniformArray(t,e)}}setBlock(t,e,i){const s=this._blockInfo[t];s?this._device.bindUniformBuffer(s.index,e,i):console.error(`Block not found: ${t}`)}destroy(){this._object&&(this._device.context.deleteProgram(this._object),this._object=null,this._unitCounter=0,this._uniformSetters=null,this._uniformInfo=null,this._blockInfo=null,this._error="",this._vertexShader=null,this._fragmentShader=null)}restore(){this._object||this._device.isContextLost()||this.load()}isProgram(){return!0}use(){return!(this!==this._device.context._currentProgram&&!this.checkLoad())}createUniformBuffer(t){const e=this.getBindingInfo(t)?.type;return e?this.device.createStructuredBuffer(e,{usage:"uniform"}):null}_setUniformStruct(t,e){for(const i in e)this.setUniform(`${t}.${i}`,e[i])}_setUniformArray(t,e){for(let i=0;i<e.length;i++)this.setUniform(`${t}[${i}]`,e[i])}load(){if(this._device.isContextLost())return;const t=this._device.context;this._error=null,this._uniformSetters={},this._object||(this._object=this._device.context.createProgram()),this._vertexShader=t.createShader(Ln.VERTEX_SHADER),t.attachShader(this._object,this._vertexShader),t.shaderSource(this._vertexShader,this._vs),t.compileShader(this._vertexShader),this._fragmentShader=t.createShader(Ln.FRAGMENT_SHADER),t.attachShader(this._object,this._fragmentShader),t.shaderSource(this._fragmentShader,this._fs),t.compileShader(this._fragmentShader);for(let e=0;e<_r.length;e++)t.bindAttribLocation(this._object,e,_r[e]);t.linkProgram(this._object)}checkLoad(){if(!this._object)return!1;if(this._vertexShader){const t=this._device.context;if(this._device.isContextLost()||t.getProgramParameter(this._object,Ln.LINK_STATUS)||(t.getShaderParameter(this._vertexShader,Ln.COMPILE_STATUS)?t.getShaderParameter(this._fragmentShader,Ln.COMPILE_STATUS)?(this._error=t.getProgramInfoLog(this._object),console.error(new Error(`Load program failed: \n${this._error}`))):(this._error=t.getShaderInfoLog(this._fragmentShader),console.error(new Error(`Compile shader failed: ${this._error}`))):(this._error=t.getShaderInfoLog(this._vertexShader),console.error(new Error(`Compile shader failed: ${this._error}`)))),t.deleteShader(this._vertexShader),this._vertexShader=null,t.deleteShader(this._fragmentShader),this._fragmentShader=null,this._error)return t.deleteProgram(this._object),this._object=null,!1;this._device.context._currentProgram=this,this._device.context.useProgram(this._object),this._uniformSetters=this.createUniformSetters()}else this._device.context._currentProgram=this,this._device.context.useProgram(this._object);return!0}createUniformSetter(t){const e=t.location,i=t.isArray,s=this._device.context;switch(t.type){case Ln.FLOAT:return this.getUniformSetterfv(e);case Ln.FLOAT_VEC2:return this.getUniformSetter2fv(e);case Ln.FLOAT_VEC3:return this.getUniformSetter3fv(e);case Ln.FLOAT_VEC4:return this.getUniformSetter4fv(e);case Ln.INT:return this.getUniformSetteriv(e);case Ln.INT_VEC2:return this.getUniformSetter2iv(e);case Ln.INT_VEC3:return this.getUniformSetter3iv(e);case Ln.INT_VEC4:return this.getUniformSetter4iv(e);case Ln.UNSIGNED_INT:return this.getUniformSetteruiv(e);case Ln.UNSIGNED_INT_VEC2:return this.getUniformSetter2uiv(e);case Ln.UNSIGNED_INT_VEC3:return this.getUniformSetter3uiv(e);case Ln.UNSIGNED_INT_VEC4:return this.getUniformSetter4uiv(e);case Ln.BOOL:return this.getUniformSetteriv(e);case Ln.BOOL_VEC2:return this.getUniformSetter2iv(e);case Ln.BOOL_VEC3:return this.getUniformSetter3iv(e);case Ln.BOOL_VEC4:return this.getUniformSetter4iv(e);case Ln.FLOAT_MAT2:return this.getUniformSetterMatrix2(e);case Ln.FLOAT_MAT2x3:return this.getUniformSetterMatrix23(e);case Ln.FLOAT_MAT2x4:return this.getUniformSetterMatrix24(e);case Ln.FLOAT_MAT3:return this.getUniformSetterMatrix3(e);case Ln.FLOAT_MAT3x2:return this.getUniformSetterMatrix32(e);case Ln.FLOAT_MAT3x4:return this.getUniformSetterMatrix34(e);case Ln.FLOAT_MAT4:return this.getUniformSetterMatrix4(e);case Ln.FLOAT_MAT4x2:return this.getUniformSetterMatrix42(e);case Ln.FLOAT_MAT4x3:return this.getUniformSetterMatrix43(e);case Ln.SAMPLER_2D:case Ln.SAMPLER_2D_SHADOW:case Ln.INT_SAMPLER_2D:case Ln.UNSIGNED_INT_SAMPLER_2D:{const r=this._unitCounter;if(this._unitCounter+=t.size,!i)return s.uniform1i(e,r),this.getSamplerSetter(e,Ln.TEXTURE_2D,r)}case Ln.SAMPLER_2D_ARRAY:case Ln.SAMPLER_2D_ARRAY_SHADOW:case Ln.INT_SAMPLER_2D_ARRAY:case Ln.UNSIGNED_INT_SAMPLER_2D_ARRAY:{const r=this._unitCounter;if(this._unitCounter+=t.size,!i)return s.uniform1i(e,r),this.getSamplerSetter(e,Ln.TEXTURE_2D_ARRAY,r)}case Ln.SAMPLER_CUBE:case Ln.SAMPLER_CUBE_SHADOW:case Ln.INT_SAMPLER_CUBE:case Ln.UNSIGNED_INT_SAMPLER_CUBE:{const r=this._unitCounter;if(this._unitCounter+=t.size,!i)return s.uniform1i(e,r),this.getSamplerSetter(e,Ln.TEXTURE_CUBE_MAP,r)}case Ln.SAMPLER_3D:case Ln.INT_SAMPLER_3D:case Ln.UNSIGNED_INT_SAMPLER_3D:{const r=this._unitCounter;if(this._unitCounter+=t.size,!i)return s.uniform1i(e,r),this.getSamplerSetter(e,Ln.TEXTURE_3D,r)}}return console.error(`Error: unsupported uniform type: ${t.name}`),null}createUniformSetters(){const t={},e=this._device.context,i=e.getProgramParameter(this._object,Ln.ACTIVE_UNIFORMS);this._uniformInfo=[];for(let s=0;s<i;s++){const i=e.getActiveUniform(this._object,s);let r=i.name,a=!1;if(r.startsWith("gl_")||r.startsWith("webgl_"))this._uniformInfo.push(null);else{"[0]"===r.substr(-3)&&(r=r.substr(0,r.length-3),a=!0);const n=i.size,o=i.type,h=-1,l=0,u=e.getUniformLocation(this._object,i.name),c=null,{ctor:d,elementSize:p}=this.getTypedArrayInfo(i.type),m={index:s,name:r,size:n,type:o,blockIndex:h,offset:l,isArray:a,location:u,view:c,viewCtor:d,viewElementSize:p};this._uniformInfo.push(m),u&&(t[r]=this.createUniformSetter(m))}}if(zn(e)){this._blockInfo={};const t=e.getProgramParameter(this._object,Ln.ACTIVE_UNIFORM_BLOCKS);for(let i=0;i<t;i++){const t=e.getActiveUniformBlockName(this._object,i),s=e.getUniformBlockIndex(this._object,t),r=!!e.getActiveUniformBlockParameter(this._object,i,Ln.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER),a=!!e.getActiveUniformBlockParameter(this._object,i,Ln.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER),n=r||a,o=e.getActiveUniformBlockParameter(this._object,i,Ln.UNIFORM_BLOCK_DATA_SIZE),h=e.getActiveUniformBlockParameter(this._object,i,Ln.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES);this._blockInfo[t]={index:s,used:n,size:o,uniformIndices:h},e.uniformBlockBinding(this._object,s,s)}}return t}getUniformSetterfv(t){return e=>{this._device.context.uniform1fv(t,e)}}getUniformSetter2fv(t){return e=>{this._device.context.uniform2fv(t,e)}}getUniformSetter3fv(t){return e=>{this._device.context.uniform3fv(t,e)}}getUniformSetter4fv(t){return e=>{this._device.context.uniform4fv(t,e)}}getUniformSetteriv(t){return e=>{this._device.context.uniform1iv(t,e)}}getUniformSetter2iv(t){return e=>{this._device.context.uniform2iv(t,e)}}getUniformSetter3iv(t){return e=>{this._device.context.uniform3iv(t,e)}}getUniformSetter4iv(t){return e=>{this._device.context.uniform4iv(t,e)}}getUniformSetteruiv(t){return e=>{this._device.context.uniform1uiv(t,e)}}getUniformSetter2uiv(t){return e=>{this._device.context.uniform2uiv(t,e)}}getUniformSetter3uiv(t){return e=>{this._device.context.uniform3uiv(t,e)}}getUniformSetter4uiv(t){return e=>{this._device.context.uniform4uiv(t,e)}}getUniformSetterMatrix2(t){return e=>{this._device.context.uniformMatrix2fv(t,!1,e)}}getUniformSetterMatrix23(t){return e=>{this._device.context.uniformMatrix2x3fv(t,!1,e)}}getUniformSetterMatrix24(t){return e=>{this._device.context.uniformMatrix2x4fv(t,!1,e)}}getUniformSetterMatrix32(t){return e=>{this._device.context.uniformMatrix3x2fv(t,!1,e)}}getUniformSetterMatrix3(t){return e=>{this._device.context.uniformMatrix3fv(t,!1,e)}}getUniformSetterMatrix34(t){return e=>{this._device.context.uniformMatrix3x4fv(t,!1,e)}}getUniformSetterMatrix42(t){return e=>{this._device.context.uniformMatrix4x2fv(t,!1,e)}}getUniformSetterMatrix43(t){return e=>{this._device.context.uniformMatrix4x3fv(t,!1,e)}}getUniformSetterMatrix4(t){return e=>{this._device.context.uniformMatrix4fv(t,!1,e)}}getSamplerSetter(t,e,i){return t=>this._device.bindTexture(e,i,t[0],t[1])}getTypedArrayInfo(t){let e=null,i=0;switch(t){case Ln.INT:e=Int32Array,i=4;break;case Ln.INT_VEC2:e=Int32Array,i=8;break;case Ln.INT_VEC3:e=Int32Array,i=12;break;case Ln.INT_VEC4:e=Int32Array,i=16;break;case Ln.UNSIGNED_INT:case Ln.BOOL:e=Uint32Array,i=4;break;case Ln.UNSIGNED_INT_VEC2:case Ln.BOOL_VEC2:e=Uint32Array,i=8;break;case Ln.UNSIGNED_INT_VEC3:case Ln.BOOL_VEC3:e=Uint32Array,i=12;break;case Ln.UNSIGNED_INT_VEC4:case Ln.BOOL_VEC4:e=Uint32Array,i=16;break;case Ln.FLOAT:e=Float32Array,i=4;break;case Ln.FLOAT_VEC2:e=Float32Array,i=8;break;case Ln.FLOAT_VEC3:e=Float32Array,i=12;break;case Ln.FLOAT_VEC4:case Ln.FLOAT_MAT2:e=Float32Array,i=16;break;case Ln.FLOAT_MAT2x3:case Ln.FLOAT_MAT3x2:e=Float32Array,i=24;break;case Ln.FLOAT_MAT2x4:case Ln.FLOAT_MAT4x2:e=Float32Array,i=32;break;case Ln.FLOAT_MAT3:e=Float32Array,i=36;break;case Ln.FLOAT_MAT3x4:case Ln.FLOAT_MAT4x3:e=Float32Array,i=48;break;case Ln.FLOAT_MAT4:e=Float32Array,i=64}return{ctor:e,elementSize:i}}}class Ro extends ro{_options;constructor(t,e){super(t),this._options=Object.assign({addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:"nearest",minFilter:"nearest",mipFilter:"none",lodMin:0,lodMax:32,compare:null,maxAnisotropy:1},e||{}),this._load()}get addressModeU(){return this._options.addressU}get addressModeV(){return this._options.addressV}get addressModeW(){return this._options.addressW}get magFilter(){return this._options.magFilter}get minFilter(){return this._options.minFilter}get mipFilter(){return this._options.mipFilter}get lodMin(){return this._options.lodMin}get lodMax(){return this._options.lodMax}get compare(){return this._options.compare}get maxAnisotropy(){return this._options.maxAnisotropy}destroy(){this._object&&zn(this._device.context)&&this._device.context.deleteSampler(this._object),this._object=null}restore(){this._object||this._device.isContextLost()||this._load()}apply(t){if(t?.object&&!this._device.isWebGL2&&!this._device.isContextLost()){const e=this._device.context,i=Jn[t.target];this._device.bindTexture(i,0,t),e.texParameteri(i,Ln.TEXTURE_WRAP_S,Yn[this._options.addressU]),e.texParameteri(i,Ln.TEXTURE_WRAP_T,Yn[this._options.addressV]),e.texParameteri(i,Ln.TEXTURE_MAG_FILTER,eo(this._options.magFilter)),e.texParameteri(i,Ln.TEXTURE_MIN_FILTER,io(this._options.minFilter,this._options.mipFilter)),this._device.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&e.texParameterf(i,Ln.TEXTURE_MAX_ANISOTROPY,this._options.maxAnisotropy)}}_load(){if(!zn(this._device.context))return this._object={},!0;if(!this._device.isContextLost()){const t=this._device.context;this._object||(this._object=t.createSampler()),t.samplerParameteri(this._object,Ln.TEXTURE_WRAP_S,Yn[this._options.addressU]),t.samplerParameteri(this._object,Ln.TEXTURE_WRAP_T,Yn[this._options.addressV]),t.samplerParameteri(this._object,Ln.TEXTURE_WRAP_R,Yn[this._options.addressW]),t.samplerParameteri(this._object,Ln.TEXTURE_MAG_FILTER,eo(this._options.magFilter)),t.samplerParameteri(this._object,Ln.TEXTURE_MIN_FILTER,io(this._options.minFilter,this._options.mipFilter)),t.samplerParameterf(this._object,Ln.TEXTURE_MIN_LOD,this._options.lodMin),t.samplerParameterf(this._object,Ln.TEXTURE_MAX_LOD,this._options.lodMax),null===this._options.compare?t.samplerParameteri(this._object,Ln.TEXTURE_COMPARE_MODE,Ln.NONE):(t.samplerParameteri(this._object,Ln.TEXTURE_COMPARE_MODE,Ln.COMPARE_REF_TO_TEXTURE),t.samplerParameteri(this._object,Ln.TEXTURE_COMPARE_FUNC,Qn[this._options.compare])),this._device.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&t.samplerParameterf(this._object,Ln.TEXTURE_MAX_ANISOTROPY,this._options.maxAnisotropy)}return!0}isSampler(){return!0}}let Fo=class{_device;_samplers;constructor(t){this._device=t,this._samplers={}}fetchSampler(t){const e=this.hash(t);let i=this._samplers[e];return i||(i=this.createSampler(t),this._samplers[e]=i),i}hash(t){return`${t.addressU?String(t.addressU):""}:${t.addressV?String(t.addressV):""}:${t.addressW?String(t.addressW):""}:${t.magFilter?String(t.magFilter):""}:${t.minFilter?String(t.minFilter):""}:${t.mipFilter?String(t.mipFilter):""}:${t.lodMin?String(t.lodMin):""}:${t.lodMax?String(t.lodMax):""}:${t.compare?String(t.compare):""}:${t.maxAnisotropy?String(t.maxAnisotropy):""}`}createSampler(t){return new Ro(this._device,t)}};const Do=_e.getCachedTypeInfo(te.U16),No=new Int32Array(4),Lo=new Uint32Array(4);let zo=null,Vo=null;const Oo=v(class extends Dn{_context;_isWebGL2;_msaaSampleCount;_loseContextExtension;_contextLost;_isRendering;_dpr;_reverseWindingOrder;_deviceCaps;_vaoExt;_instancedArraysExt;_drawBuffersExt;_currentProgram;_currentVertexData;_currentStateSet;_currentBindGroups;_currentBindGroupOffsets;_currentViewport;_currentScissorRect;_samplerCache;_textureSamplerMap;_captureRenderBundle;_deviceUniformBuffers;_deviceUniformBufferOffsets;_bindTextures;_bindSamplers;_readFormats;_adapterInfo;constructor(t,e,i){super(e,t),this._dpr=Math.max(1,Math.floor(i?.dpr??window.devicePixelRatio)),this._isRendering=!1,this._captureRenderBundle=null,this._msaaSampleCount=i?.msaa?4:1;let s=null;if(s=this.canvas.getContext(t===Uo?"webgl":"webgl2",{antialias:!!i?.msaa,depth:!0,stencil:!0,premultipliedAlpha:!1}),!s)throw new Error("Invalid argument or no webgl support");this._isWebGL2=zn(s),this._adapterInfo={vendor:s.getParameter(s.VENDOR),renderer:s.getParameter(s.RENDERER),version:s.getParameter(s.VERSION)},this._contextLost=!1,this._reverseWindingOrder=!1,this._deviceCaps=null,this._context=s,this._currentProgram=null,this._currentVertexData=null,this._currentStateSet=null,this._currentBindGroups=[],this._currentBindGroupOffsets=[],this._currentViewport=null,this._currentScissorRect=null,this._deviceUniformBuffers=[],this._deviceUniformBufferOffsets=[],this._bindTextures={[Ln.TEXTURE_2D]:[],[Ln.TEXTURE_CUBE_MAP]:[],[Ln.TEXTURE_3D]:[],[Ln.TEXTURE_2D_ARRAY]:[]},this._bindSamplers=[],this._samplerCache=new Fo(this),this._textureSamplerMap=new WeakMap,this._loseContextExtension=this._context.getExtension("WEBGL_lose_context"),this._readFormats={},this.canvas.addEventListener("webglcontextlost",t=>{this._contextLost=!0,t.preventDefault(),this.handleContextLost()},!1),this.canvas.addEventListener("webglcontextrestored",()=>{this._contextLost=!1,this.handleContextRestored()},!1)}get context(){return this._context}getAdapterInfo(){return this._adapterInfo}getFrameBufferSampleCount(){return this.getFramebuffer()?.getSampleCount()??this._msaaSampleCount}get isWebGL2(){return this._isWebGL2}get drawingBufferWidth(){return this.getDrawingBufferWidth()}get drawingBufferHeight(){return this.getDrawingBufferHeight()}get clientWidth(){return this.canvas.clientWidth}get clientHeight(){return this.canvas.clientHeight}getScale(){return this._dpr}isContextLost(){return this._contextLost}getDeviceCaps(){return this._deviceCaps}get vaoExt(){return this._vaoExt}get instancedArraysExt(){return this._instancedArraysExt}get drawBuffersExt(){return this._drawBuffersExt}getDrawingBufferWidth(){return this._context._currentFramebuffer?.getWidth()||this._context.drawingBufferWidth}getDrawingBufferHeight(){return this._context._currentFramebuffer?.getHeight()||this._context.drawingBufferHeight}getBackBufferWidth(){return this.canvas.width}getBackBufferHeight(){return this.canvas.height}invalidateBindingTextures(){this._bindTextures={[Ln.TEXTURE_2D]:[],[Ln.TEXTURE_CUBE_MAP]:[],[Ln.TEXTURE_3D]:[],[Ln.TEXTURE_2D_ARRAY]:[]}}bindTexture(t,e,i,s){const r=i?.object??null,a=this._context;if(a.activeTexture(Ln.TEXTURE0+e),this._bindTextures[t][e]!==r&&(a.bindTexture(t,r),this._bindTextures[t][e]=r),this._isWebGL2){const t=s?.object??null;t&&this._bindSamplers[e]!==t&&(a.bindSampler(e,t),this._bindSamplers[e]=t)}else if(i&&s&&this._textureSamplerMap.get(i)!==s){const e=i.isWebGL1Fallback;this._textureSamplerMap.set(i,s),a.texParameteri(t,Ln.TEXTURE_WRAP_S,Yn[s.addressModeU]),a.texParameteri(t,Ln.TEXTURE_WRAP_T,Yn[s.addressModeV]),a.texParameteri(t,Ln.TEXTURE_MAG_FILTER,eo(s.magFilter)),a.texParameteri(t,Ln.TEXTURE_MIN_FILTER,io(s.minFilter,e?"none":s.mipFilter)),this.getDeviceCaps().textureCaps.supportAnisotropicFiltering&&a.texParameterf(t,Ln.TEXTURE_MAX_ANISOTROPY,s.maxAnisotropy)}}bindUniformBuffer(t,e,i){this._deviceUniformBuffers[t]===e.object&&this._deviceUniformBufferOffsets[t]===i||(i?this.context.bindBufferRange(Ln.UNIFORM_BUFFER,t,e.object,i,e.byteLength-i):this.context.bindBufferBase(Ln.UNIFORM_BUFFER,t,e.object),this._deviceUniformBuffers[t]=e.object,this._deviceUniformBufferOffsets[t]=i)}async initContext(){this.initContextState(),this.on("resize",()=>{const t=Math.max(1,Math.round(this.canvas.clientWidth*this._dpr)),e=Math.max(1,Math.round(this.canvas.clientHeight*this._dpr));t===this.canvas.width&&e===this.canvas.height||(this.canvas.width=t,this.canvas.height=e,this.setViewport(this._currentViewport),this.setScissor(this._currentScissorRect))}),this.dispatchEvent("resize",this.canvas.clientWidth,this.canvas.clientHeight)}clearFrameBuffer(t,e,i){const s=this._context,r=t?s.COLOR_BUFFER_BIT:0,a="number"==typeof e?s.DEPTH_BUFFER_BIT:0,n="number"==typeof i?s.STENCIL_BUFFER_BIT:0;if(r||a||n){if(To.applyDefaults(this._context),zn(s)&&s._currentFramebuffer){if(a||n){s._currentFramebuffer.getDepthAttachment()&&s.clearBufferfi(Ln.DEPTH_STENCIL,0,e??1,i??0)}if(r){const e=s._currentFramebuffer.getColorAttachments();for(let i=0;i<e.length;i++)Vt(e[i].format)?Ot(e[i].format)?(No[0]=t[0],No[1]=t[1],No[2]=t[2],No[3]=t[3],s.clearBufferiv(Ln.COLOR,i,No)):(Lo[0]=t[0],Lo[1]=t[1],Lo[2]=t[2],Lo[3]=t[3],s.clearBufferuiv(Ln.COLOR,i,Lo)):s.clearBufferfv(Ln.COLOR,i,t)}}else r&&s.clearColor(t[0],t[1],t[2],t[3]),a&&s.clearDepth(e),n&&s.clearStencil(i),s.clear(r|a|n);s._currentFramebuffer?.tagDraw(),s._currentFramebuffer?.invalidateMipmaps()}}createGPUTimer(){return new Ao(this)}createRenderStateSet(){return new So(this._context)}createBlendingState(){return new vo}createColorState(){return new bo}createRasterizerState(){return new yo}createDepthState(){return new To}createStencilState(){return new wo}createSampler(t){return this._samplerCache.fetchSampler(t)}createTextureFromMipmapData(t,e,i){if(!t)return console.error("Device.createTextureFromMipmapData() failed: invalid data"),null;if(t.isCubemap){const s=new lo(this);return s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s}if(t.isVolume){const e=new ho(this);return e.createWithMipmapData(t,this.parseTextureOptions(i)),e.samplerOptions=i?.samplerOptions??null,e}if(t.isArray){const e=new oo(this);return e.createWithMipmapData(t,this.parseTextureOptions(i)),e.samplerOptions=i?.samplerOptions??null,e}{const s=new no(this);return s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s}}createTexture2D(t,e,i,s){const r=s?.texture??new no(this);return r.isTexture2D()?(r.createEmpty(t,e,i,this.parseTextureOptions(s)),r.samplerOptions=s?.samplerOptions??null,r):(console.error("createTexture2D() failed: options.texture must be 2d texture"),null)}createTexture2DFromImage(t,e,i){const s=i?.texture??new no(this);return s.isTexture2D()?(s.loadFromElement(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createTexture2DFromImage() failed: options.texture must be 2d texture"),null)}createTexture2DArray(t,e,i,s,r){const a=r?.texture??new oo(this);return a.isTexture2DArray()?(a.createEmpty(t,e,i,s,this.parseTextureOptions(r)),a.samplerOptions=r?.samplerOptions??null,a):(console.error("createTexture2DArray() failed: options.texture must be 2d array texture"),null)}createTexture2DArrayFromImages(t,e,i){if(!t||0===t.length)return console.error("createTexture2DArrayFromImages() failed: Invalid image elements"),null;let s=0,r=0;for(const e of t)if(0===s||0===r)s=e.width,r=e.height;else if(s!==e.width||r!==e.height)return console.error("createTexture2DArrayFromImages() failed: Image elements must have the same size"),null;if(i?.texture&&!i.texture.isTexture2DArray())return console.error("createTexture2DArrayFromImages() failed: options.texture must be 2d array texture"),null;let a=i?.texture;if(a){if(a.depth!==t.length)return console.error("createTexture2DArrayFromImages() failed: Layer count of options.texture not match the given image elements"),null;if(a.width!==s||a.height!==r)return console.error("createTexture2DArrayFromImages() failed: Size of options.texture not match the given image elements"),null}else{a=this.createTexture2DArray(e?"rgba8unorm-srgb":"rgba8unorm",s,r,t.length,i);for(let e=0;e<t.length;e++)a.updateFromElement(t[e],0,0,e,0,0,s,r)}return a.samplerOptions=i?.samplerOptions??null,a}createTexture3D(t,e,i,s,r){if(!this.isWebGL2)return console.error("device does not support 3d texture"),null;const a=r?.texture??new ho(this);return a.isTexture3D()?(a.createEmpty(t,e,i,s,this.parseTextureOptions(r)),a.samplerOptions=r?.samplerOptions??null,a):(console.error("createTexture3D() failed: options.texture must be 3d texture"),null)}createCubeTexture(t,e,i){const s=i?.texture??new lo(this);return s.isTextureCube()?(s.createEmpty(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createCubeTexture() failed: options.texture must be cube texture"),null)}createTextureVideo(t,e){const i=new uo(this,t);return i.samplerOptions=e??null,i}copyFramebufferToTexture2D(t,e,i,s){if(!t?.isFramebuffer()||!i?.isTexture2D())return void console.error("copyFramebufferToTexture2D(): invalid framebuffer or texture");if(!Number.isInteger(s)||s<0||s>=i.mipLevelCount)return void console.error("copyFramebufferToTexture2D(): invalid mipmap level");const r=t.getColorAttachments()[e];if(!r||!r.isTexture2D())return void console.error("copyFramebufferToTexture2D(): Color attachment is not a 2D texture");const a=t.getColorAttachmentMipLevel(e),n=Math.max(r.width>>a,1),o=Math.max(r.height>>a,1),h=Math.max(i.width>>s,1),l=Math.max(i.height>>s,1);if(n!==h||o!==l)return void console.error("Source texture and destination texture must have same size");if(r.format!==i.format)return void console.error("copyFramebufferToTexture2D(): Color attachment must have same format with destination texture");if(e>0&&!this.isWebGL2)return void console.error("copyFramebufferToTexture2D(): Non-zero color attachment index requires WebGL2 or WebGPU device");this.pushDeviceStates(),this.setFramebuffer(null),this.setFramebuffer(t);const u=this._context;this.isWebGL2&&u.readBuffer(u.COLOR_ATTACHMENT0+e),this.bindTexture(u.TEXTURE_2D,0,i),u.copyTexSubImage2D(u.TEXTURE_2D,s,0,0,0,0,n,o),this.popDeviceStates()}copyTexture2D(t,e,i,s){if(!t||!i)return void console.error("CopyTexture2D(): invalid texture");if(!Number.isInteger(e)||e<0||e>=t.mipLevelCount)return void console.error("CopyTexture2D(): invalid source mipmap level");const r=this.createFrameBuffer([t],null);r.setColorAttachmentGenerateMipmaps(0,!1),r.setColorAttachmentMipLevel(0,e),this.copyFramebufferToTexture2D(r,0,i,s),r.dispose()}createGPUProgram(t){if("compute"===t.type)throw new Error("device does not support compute shader");const e=t.params;return new $o(this,e.vs,e.fs,e.bindGroupLayouts,e.vertexAttributes)}createBindGroup(t){return new Po(this,t)}createBuffer(t,e){return new po(this,this.parseBufferOptions(e),t,!this._isWebGL2)}copyBuffer(t,e,i,s,r){if(!this.isWebGL2)return void console.error("copyBuffer() is not supported for current device");const a=this._context;a.bindBuffer(a.COPY_READ_BUFFER,t.object),a.bindBuffer(a.COPY_WRITE_BUFFER,e.object),a.copyBufferSubData(a.COPY_READ_BUFFER,a.COPY_WRITE_BUFFER,i,s,r)}createIndexBuffer(t,e){return new _o(this,t,this.parseBufferOptions(e,"index"))}createStructuredBuffer(t,e,i){return new Io(this,t,this.parseBufferOptions(e),i)}createVertexLayout(t){return new co(this,t)}createFrameBuffer(t,e,i){return new go(this,t,e,i)}setBindGroup(t,e,i){if(i&&!zn(this._context))throw new Error("setBindGroup(): no dynamic offset buffer support for WebGL1 device");this._currentBindGroups[t]=e,this._currentBindGroupOffsets[t]=i||null}getBindGroup(t){return[this._currentBindGroups[t],this._currentBindGroupOffsets[t]]}setViewport(t){null==t||!Array.isArray(t)&&t.default?this._currentViewport={x:0,y:0,width:this.deviceToScreen(this.drawingBufferWidth),height:this.deviceToScreen(this.drawingBufferHeight),default:!0}:Array.isArray(t)?this._currentViewport={x:t[0],y:t[1],width:t[2],height:t[3],default:!1}:this._currentViewport=Object.assign({default:!1},t),this._context.viewport(this.screenToDevice(this._currentViewport.x),this.screenToDevice(this._currentViewport.y),this.screenToDevice(this._currentViewport.width),this.screenToDevice(this._currentViewport.height))}getViewport(){return Object.assign({},this._currentViewport)}setScissor(t){null==t||!Array.isArray(t)&&t.default?this._currentScissorRect={x:0,y:0,width:this.deviceToScreen(this.drawingBufferWidth),height:this.deviceToScreen(this.drawingBufferHeight),default:!0}:Array.isArray(t)?this._currentScissorRect={x:t[0],y:t[1],width:t[2],height:t[3],default:!1}:this._currentScissorRect=Object.assign({default:!1},t),this._context.scissor(this.screenToDevice(this._currentScissorRect.x),this.screenToDevice(this._currentScissorRect.y),this.screenToDevice(this._currentScissorRect.width),this.screenToDevice(this._currentScissorRect.height))}getScissor(){return Object.assign({},this._currentScissorRect)}setProgram(t){this._currentProgram=t}getProgram(){return this._currentProgram}setVertexLayout(t){this._currentVertexData=t}getVertexLayout(){return this._currentVertexData}setRenderStates(t){this._currentStateSet=t}getRenderStates(){return this._currentStateSet}getFramebuffer(){return this._context._currentFramebuffer??null}reverseVertexWindingOrder(t){this._reverseWindingOrder!==!!t&&(this._reverseWindingOrder=!!t,this._context.frontFace(t?this._context.CW:this._context.CCW))}isWindingOrderReversed(){return!!this._reverseWindingOrder}flush(){this.context.flush()}async readPixels(t,e,i,s,r,a){const n=this.getFramebuffer(),o=n?n.getColorAttachments()[t]:null,h=o?o.format:"rgba8unorm";let l=this._readFormats[h];l||(l={format:this.context.getParameter(Ln.IMPLEMENTATION_COLOR_READ_FORMAT),type:this.context.getParameter(Ln.IMPLEMENTATION_COLOR_READ_TYPE)},this._readFormats[h]=l);const u=l.format,c=l.type,d=Gt(h);if((u!==Ln.RGBA||c!==Ln.UNSIGNED_BYTE&&c!==Ln.FLOAT&&c!==Ln.HALF_FLOAT)&&!zn(this.context))throw new Error(`readPixels() failed: invalid format: ${h}`);const p=s*r*d;if(a.byteLength<p)throw new Error(`readPixels() failed: destination buffer must have at least ${p} bytes`);if(zn(this.context)){const o=this.createBuffer(p,{usage:"pack-pixel",managed:!1});this.context.bindBuffer(Ln.PIXEL_PACK_BUFFER,o.object),this.context.readBuffer(n?Ln.COLOR_ATTACHMENT0+t:Ln.COLOR_ATTACHMENT0),this.context.readPixels(e,i,s,r,u,c,0),this.context.bindBuffer(Ln.PIXEL_PACK_BUFFER,null);const h=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);await o.getBufferSubData(h),o.dispose()}else this.context.readPixels(e,i,s,r,u,c,a)}readPixelsToBuffer(t,e,i,s,r,a){const n=this.getFramebuffer(),o=n?n.getColorAttachments()[t]:null,h=o?o.format:"rgba8unorm";let l=Ln.NONE,u=Ln.NONE;if(!zn(this.context))throw new Error("readPixels() failed: readPixels() requires webgl2 device");if(kt(h)||Nt(h))throw new Error(`readPixels() failed: invalid format: ${h}`);const c=function(t){return!!(1&Ft[t])}(h),d=function(t){return!!(2&Ft[t])}(h),p=function(t){return!!(4&Ft[t])}(h),m=function(t){return!!(8&Ft[t])}(h),f=(c?1:0)+(d?1:0)+(p?1:0)+(m?1:0),_=Gt(h)/f,g=Vt(h),x=zt(h),b=Ot(h);c&&d&&p&&m?l=g?Ln.RGBA_INTEGER:Ln.RGBA:c&&d?l=g?Ln.RG_INTEGER:Ln.RG:c&&(l=g?Ln.RED_INTEGER:Ln.RED),1===_?u=b?Ln.BYTE:Ln.UNSIGNED_BYTE:2===_?u=x?Ln.HALF_FLOAT:b?Ln.SHORT:Ln.UNSIGNED_SHORT:4===_&&(u=x?Ln.FLOAT:b?Ln.INT:Ln.UNSIGNED_INT),this.context.bindBuffer(Ln.PIXEL_PACK_BUFFER,a.object),this.context.readBuffer(n?Ln.COLOR_ATTACHMENT0+t:Ln.COLOR_ATTACHMENT0),this.context.readPixels(e,i,s,r,l,u,0),this.context.bindBuffer(Ln.PIXEL_PACK_BUFFER,null)}looseContext(){this.context.isContextLost()||this._loseContextExtension?.loseContext()}restoreContext(){if(this.context.isContextLost()){this.clearErrors(),this._loseContextExtension?.restoreContext();const t=this.getError();t&&console.error(t)}}beginCapture(){if(this._captureRenderBundle)throw new Error("Device.beginCapture() failed: device is already capturing draw commands");this._captureRenderBundle=[]}endCapture(){if(!this._captureRenderBundle)throw new Error("Device.endCapture() failed: device is not capturing draw commands");const t=this._captureRenderBundle;return this._captureRenderBundle=null,t}_executeRenderBundle(t){for(const e of t){this.setProgram(e.program),this.setVertexLayout(e.vertexLayout),this.setRenderStates(e.renderStateSet);for(let t=0;t<4;t++)this.setBindGroup(t,e.bindGroups[t],e.bindGroupOffsets[t]);0===e.numInstances?this.draw(e.primitiveType,e.first,e.count):this.drawInstanced(e.primitiveType,e.first,e.count,e.numInstances)}return t.length}_setFramebuffer(t){t!==this._context._currentFramebuffer&&(this._context._currentFramebuffer?.unbind(),t?.bind())}onBeginFrame(){return this._contextLost&&(this._context.isContextLost()||(this._contextLost=!1,this.handleContextRestored())),!this._contextLost}nextFrame(t){return requestAnimationFrame(t)}cancelNextFrame(t){cancelAnimationFrame(t)}onEndFrame(){}_draw(t,e,i){if(this._currentVertexData){if(this._currentVertexData.bind(),this._currentProgram){if(!this._currentProgram.use())return;for(let t=0;t<this._currentProgram.bindGroupLayouts.length;t++){const e=this._currentBindGroups[t];if(!e)return void console.error(`Missing bind group (${t}) when drawing with program '${this._currentProgram.name}'`);{const i=this._currentBindGroupOffsets[t];e.apply(this._currentProgram,i)}}}this._currentStateSet?this._currentStateSet.apply():So.applyDefaults(this._context);const s=this._currentVertexData.indexBuffer;s?this.context.drawElements(Kn[t],i,Zn[s.indexType.primitiveType],e*(s.indexType===Do?2:4)):this.context.drawArrays(Kn[t],e,i),this._context._currentFramebuffer?.tagDraw(),this.getFramebuffer()?.invalidateMipmaps()}if(this._captureRenderBundle){const s=this._currentStateSet?.clone()??this.createRenderStateSet();if(this._reverseWindingOrder){const t=s.rasterizerState;t?"back"===t.cullMode?t.cullMode="front":"front"===t.cullMode&&(t.cullMode="back"):s.useRasterizerState().setCullMode("front")}this._captureRenderBundle.push({bindGroups:[...this._currentBindGroups],bindGroupOffsets:this._currentBindGroupOffsets.map(t=>t?[...t]:null),program:this._currentProgram,vertexLayout:this._currentVertexData,primitiveType:t,renderStateSet:s,count:i,first:e,numInstances:0})}}_drawInstanced(t,e,i,s){if(this.instancedArraysExt&&this._currentVertexData){if(this._currentVertexData.bind(),this._currentProgram){if(!this._currentProgram.use())return;for(let t=0;t<this._currentProgram.bindGroupLayouts.length;t++){const e=this._currentBindGroups[t];if(!e)return void console.error(`Missing bind group (${t}) when drawing with program '${this._currentProgram.name}'`);{const i=this._currentBindGroupOffsets[t];e.apply(this._currentProgram,i)}}}this._currentStateSet?.apply();const r=this._currentVertexData.indexBuffer;r?this.instancedArraysExt.drawElementsInstanced(Kn[t],i,Zn[r.indexType.primitiveType],e*(r.indexType===Do?2:4),s):this.instancedArraysExt.drawArraysInstanced(Kn[t],e,i,s),this._context._currentFramebuffer?.tagDraw(),this._context._currentFramebuffer?.invalidateMipmaps()}this._captureRenderBundle&&this._captureRenderBundle.push({bindGroups:[...this._currentBindGroups],bindGroupOffsets:this._currentBindGroupOffsets.map(t=>t?[...t]:null),program:this._currentProgram,vertexLayout:this._currentVertexData,primitiveType:t,renderStateSet:this._currentStateSet?.clone()??null,count:i,first:e,numInstances:s})}_compute(){throw new Error("WebGL device does not support compute shader")}createInstancedArraysEXT(){const t=this._context;if(zn(t))return{vertexAttribDivisor:t.vertexAttribDivisor.bind(t),drawArraysInstanced:t.drawArraysInstanced.bind(t),drawElementsInstanced:t.drawElementsInstanced.bind(t)};{const e=t.getExtension("ANGLE_instanced_arrays");return e?{vertexAttribDivisor:e.vertexAttribDivisorANGLE.bind(e),drawArraysInstanced:e.drawArraysInstancedANGLE.bind(e),drawElementsInstanced:e.drawElementsInstancedANGLE.bind(e)}:null}}createDrawBuffersEXT(){const t=this._context;if(zn(t))return{drawBuffers:t.drawBuffers.bind(t)};{const e=t.getExtension("WEBGL_draw_buffers");return e?{drawBuffers:e.drawBuffersWEBGL.bind(e)}:null}}createVertexArrayObjectEXT(){const t=this._context;if(zn(t))return{createVertexArray:t.createVertexArray.bind(t),bindVertexArray:t.bindVertexArray.bind(t),deleteVertexArray:t.deleteVertexArray.bind(t),isVertexArray:t.isVertexArray.bind(t)};{const e=t.getExtension("OES_vertex_array_object");return e?{createVertexArray:e.createVertexArrayOES.bind(e),bindVertexArray:e.bindVertexArrayOES.bind(e),deleteVertexArray:e.deleteVertexArrayOES.bind(e),isVertexArray:e.isVertexArrayOES.bind(e)}:null}}handleContextLost(){this._isRendering=this.isRendering,this.invalidateAll(),this.dispatchEvent("devicelost")}handleContextRestored(){console.info("handle context restored"),this.initContextState(),this._textureSamplerMap=new WeakMap,this._currentProgram=null,this._currentVertexData=null,this._currentStateSet=null,this._currentBindGroups=[],this._currentBindGroupOffsets=[],this._currentViewport=null,this._currentScissorRect=null,this._samplerCache=new Fo(this),this._isRendering&&(this._isRendering=!1,this.reloadAll(),this.dispatchEvent("devicerestored"))}initContextState(){this._deviceCaps={miscCaps:new Eo(this._context),framebufferCaps:new Co(this._context),shaderCaps:new Mo(this._context),textureCaps:new Bo(this._context)},this._vaoExt=this.createVertexArrayObjectEXT(),this._instancedArraysExt=this.createInstancedArraysEXT(),this._drawBuffersExt=this.createDrawBuffersEXT(),this._context.pixelStorei(Ln.UNPACK_COLORSPACE_CONVERSION_WEBGL,Ln.NONE),this._context.pixelStorei(Ln.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),this.setViewport(null),this.setScissor(null),this._context.enable(Ln.SCISSOR_TEST),this.enableGPUTimeRecording(!0),this._context._currentFramebuffer=void 0,this._context._currentProgram=void 0,this._deviceUniformBuffers=[],this._deviceUniformBufferOffsets=[],this._bindTextures={[Ln.TEXTURE_2D]:[],[Ln.TEXTURE_CUBE_MAP]:[],[Ln.TEXTURE_3D]:[],[Ln.TEXTURE_2D_ARRAY]:[]},this._bindSamplers=[]}clearErrors(){for(;this._context.getError(););}getCurrentSamplerForTexture(t){return this._textureSamplerMap.get(t)}setCurrentSamplerForTexture(t,e){this._textureSamplerMap.set(t,e)}getError(t){const e=this._context.getError(),i=e===Ln.NO_ERROR?null:new Vn(e);if(i&&t)throw i;return i}})();async function ko(t,e,i){try{const s=new Oo(t,e,i);return await s.initContext(),s.setViewport(),s.setScissor(),s}catch(t){return console.error(t),null}}const Uo={typeName:()=>"webgl",supported(){if(null===zo){const t=document.createElement("canvas"),e=t.getContext("webgl");zo=!!e,t.width=0,t.height=0}return zo},async createDevice(t,e){return ko(this,t,e)}},Go=Uo,Ho={typeName:()=>"webgl2",supported(){if(null===Vo){const t=document.createElement("canvas"),e=t.getContext("webgl2");Vo=!!e,t.width=0,t.height=0}return Vo},async createDevice(t,e){return ko(this,t,e)}};let Wo=0;class Xo extends gt{_device;_object;_uid;_cid;_name;_queueState;_restoreHandler;constructor(t){super(),this._device=t,this._object=null,this._uid=++Wo,this._cid=1,this._name=xr(this),this._queueState=0,this._restoreHandler=null,this._device.addGPUObject(this)}get device(){return this._device}get object(){return this._object}get uid(){return this._uid}get cid(){return this._cid}get restoreHandler(){return this._restoreHandler}set restoreHandler(t){this._restoreHandler=t}get name(){return this._name}set name(t){if(t!==this._name){const e=this._name;this._name=t,this._device.dispatchEvent("gpuobject_rename",this,e)}}get queueState(){return this._queueState}set queueState(t){this._queueState=t}isVertexLayout(){return!1}isFramebuffer(){return!1}isSampler(){return!1}isTexture(){return!1}isTexture2D(){return!1}isTexture2DArray(){return!1}isTexture3D(){return!1}isTextureCube(){return!1}isTextureVideo(){return!1}isProgram(){return!1}isBuffer(){return!1}isBindGroup(){return!1}reload(){this.disposed&&(this._device.restoreObject(this),this._cid++)}destroy(){throw new Error("Abstract function call: dispose()")}restore(){throw new Error("Abstract function call: restore()")}onDispose(){super.onDispose(),this._device.disposeObject(this,!0)}}class jo extends Xo{static _hashCounter=0;_type;_vs;_fs;_cs;_label;_hash;_error;_bindGroupLayouts;_vertexAttributes;_csModule;_vsModule;_fsModule;_pipelineLayout;constructor(t,e){if(super(t),this._type=e.type,this._label=e.label??`Program ${this.uid}`,this._bindGroupLayouts=[...e.params.bindGroupLayouts],this._error="","render"===e.type){const t=e.params;this._vs=t.vs,this._fs=t.fs,this._vertexAttributes=t.vertexAttributes?t.vertexAttributes.join(":"):""}else{const t=e.params;this._cs=t.source}this._load(),this._hash=String(++jo._hashCounter)}get type(){return this._type}get label(){return this._label}getCompileError(){return this._error}getShaderSource(t){switch(t){case"vertex":return this._vs;case"fragment":return this._fs;case"compute":return this._cs}}getBindingInfo(t){for(let e=0;e<this._bindGroupLayouts.length;e++){const i=this._bindGroupLayouts[e],s=i.nameMap?.[t]??t;for(let t=0;t<i.entries.length;t++){const r=i.entries[t];if(r.name===s)return{group:e,binding:t,type:r.type}}}return null}get bindGroupLayouts(){return this._bindGroupLayouts}get vertexAttributes(){return this._vertexAttributes}get hash(){return this._hash}getPipelineLayout(){return this._pipelineLayout}getShaderModule(){return{vsModule:this._vsModule,fsModule:this._fsModule,csModule:this._csModule,pipelineLayout:this._pipelineLayout}}get fsModule(){return this._fsModule}destroy(){this._vsModule=null,this._fsModule=null,this._pipelineLayout=null,this._object=null}restore(){this._object||this._load()}isProgram(){return!0}createUniformBuffer(t){const e=this.getBindingInfo(t)?.type;return e?this.device.createStructuredBuffer(e,{usage:"uniform"}):null}_load(){"render"===this._type?(this._vsModule=this.createShaderModule(this._vs),this._fsModule=this.createShaderModule(this._fs)):this._csModule=this.createShaderModule(this._cs),this._pipelineLayout=this.createPipelineLayout(this._bindGroupLayouts),this._object={}}createPipelineLayout(t){const e=[];return t.forEach(t=>{e.push(this._device.fetchBindGroupLayout(t)[1])}),this._device.device.createPipelineLayout({bindGroupLayouts:e})}createShaderModule(t){let e=this._device.device.createShaderModule({label:this._label,code:t});if(e){const i=e.compilationInfo||e.getCompilationInfo;if(!i)return e;i.call(e).then(i=>{let s=!1;if(i?.messages?.length>0){let e="";for(const r of i.messages)"error"===r.type&&(s=!0),e+=`Line ${r.lineNum}:${r.linePos} - ${t.slice(r.offset,r.offset+r.length)}\n`,e+=`${r.message}\n`,"error"===r.type?(s=!0,console.error(e)):"warning"===r.type?console.warn(e):console.info(e),this._error+=e}s&&(e=null)})}return e}use(){this._device.setProgram(this)}}class Qo{_device;_bufferList;_defaultSize;_unmappedBufferList;constructor(t,e=65536){this._device=t,this._bufferList=[],this._defaultSize=e,this._unmappedBufferList=[]}uploadBuffer(t,e,i,s,r,a){const n=r+3&-4,o=this.fetchBufferMapped(n,!!a);if(t){const e=o.mappedRange;new Uint8Array(e,o.offset,n).set(new Uint8Array(t,i,r))}const h={mappedBuffer:{...o},uploadSize:n,uploadBuffer:e,uploadOffset:s};return o.offset+=n,o.offset=o.offset+7&-8,h}beginUploads(){for(let t=this._bufferList.length-1;t>=0;t--){const e=this._bufferList[t];e.used&&(e.buffer.unmap(),this._unmappedBufferList.push(e),this._bufferList.splice(t,1),e.mappedRange=null)}return this._unmappedBufferList.length}endUploads(){for(const t of this._unmappedBufferList)t.buffer.mapAsync(GPUMapMode.WRITE).then(()=>{t.offset=0,t.used=!1,t.mappedRange=t.buffer.getMappedRange(),this._bufferList.push(t)});this._unmappedBufferList=[]}purge(){for(let t=this._bufferList.length-1;t>=0;t--){const e=this._bufferList[t];e.mappedRange&&(e.buffer.unmap(),e.buffer.destroy())}this._bufferList=[];for(const t of this._unmappedBufferList)t.buffer.destroy();this._unmappedBufferList=[]}fetchBufferMapped(t,e){for(const i of this._bufferList)if(e||i.size-i.offset>=t)return i.used=!0,i;const i=Math.max(t,this._defaultSize)+3&-4,s=this._device.device.createBuffer({label:`StagingRingBuffer${this._bufferList.length}:${i}`,size:i,usage:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,mappedAtCreation:!0});return this._bufferList.push({buffer:s,size:i,offset:0,used:!0,mappedRange:s.getMappedRange()}),this._bufferList[this._bufferList.length-1]}}class qo extends Xo{_size;_usage;_gpuUsage;_memCost;_ringBuffer;_pendingUploads;constructor(t,e,i){if(super(t),this._object=null,this._memCost=0,this._usage=e,this._gpuUsage=0,this._size="number"==typeof i?i:i.byteLength,this._size<=0)throw new Error("can not create buffer with zero size");this._ringBuffer=new Qo(t,this._size+15&-16),this._pendingUploads=[],this.load("number"==typeof i?null:i)}get hash(){return this._object?this._device.gpuGetObjectHash(this._object):0}get byteLength(){return this._size}get usage(){return this._usage}get gpuUsage(){return this._gpuUsage}searchInsertPosition(t){let e=0,i=this._pendingUploads.length-1,s=this._pendingUploads.length;for(;e<=i;){const r=Math.floor((e+i)/2);this._pendingUploads[r].uploadOffset<t?e=r+1:(s=r,i=r-1)}return s}bufferSubData(t,e,i,s){if(i=Number(i)||0,t=Number(t)||0,i+(s=Number(s)||e.length-i)>e.length)throw new Error("bufferSubData() failed: source buffer is too small");if(t+s*e.BYTES_PER_ELEMENT>this.byteLength)throw new Error("bufferSubData() failed: dest buffer is too small");const r=s*e.BYTES_PER_ELEMENT;if(3&t||3&r)throw new Error("bufferSubData() failed: destination byte offset or upload size must be 4 bytes aligned");const a=e.byteOffset+i*e.BYTES_PER_ELEMENT,n=this.searchInsertPosition(t);if(n<this._pendingUploads.length){const e=this._pendingUploads[n];e.uploadOffset<t+r&&e.uploadOffset+e.uploadSize>t&&this._device.bufferUpload(this)}let o=!1;if(0===this._pendingUploads.length)this.pushUpload(t,r,0),o=!0;else{let e=t,i=t+r;for(;n<this._pendingUploads.length;){const t=this._pendingUploads[n],s=t.uploadOffset,r=s+t.uploadSize;if(!(s<i&&r>e))break;e=Math.min(e,s),i=Math.max(i,r),this._pendingUploads.splice(n,1)}this.pushUpload(e,i-e,n)}new Uint8Array(this._pendingUploads[0].mappedBuffer.mappedRange,t,r).set(new Uint8Array(e.buffer,a,r)),o&&this._device.bufferUpload(this)}async getBufferSubData(t,e,i){let s=this;if(e=Number(e)||0,i=Number(i)||this.byteLength-e,e<0||e+i>this.byteLength)throw new Error("data query range out of bounds");if(t&&t.byteLength<i)throw new Error("no enough space for querying buffer data");if(this._usage&(nr.BF_READ|nr.BF_PACK_PIXEL))this.sync();else{if(!(this._gpuUsage&GPUBufferUsage.COPY_SRC))throw new Error("getBufferSubData() failed: buffer does not have BF_READ or BF_PACK_PIXEL flag set");s=this._device.createBuffer(i,{usage:"read"}),this.sync(),this._device.copyBuffer(this,s,e,0,i)}const r=s.object;await r.mapAsync(GPUMapMode.READ);const a=r.getMappedRange();return(t=t||new Uint8Array(i)).set(new Uint8Array(a,e,i)),r.unmap(),s!==this&&s.dispose(),t}restore(){this._device.isContextLost()||this.load()}destroy(){this._object&&(this._object.destroy(),this._object=null,this._gpuUsage=0,this._memCost=0)}isBuffer(){return!0}beginSyncChanges(t){if(this._pendingUploads.length>0){const e=t||this._device.device.createCommandEncoder();for(const t of this._pendingUploads)e.copyBufferToBuffer(t.mappedBuffer.buffer,t.mappedBuffer.offset,this._object,t.uploadOffset,t.uploadSize);t||this._device.device.queue.submit([e.finish()]),this._pendingUploads.length=0,this._ringBuffer.beginUploads()}}endSyncChanges(){this._usage&nr.DYNAMIC?this._ringBuffer.endUploads():this._ringBuffer.purge()}load(t){if(!this._device.isContextLost()&&(this._memCost=0,!this._device.isContextLost()&&!this._object)){this._gpuUsage=0;let e="";if(this._usage&nr.BF_VERTEX&&(this._gpuUsage|=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC,e+="[vertex]"),this._usage&nr.BF_INDEX&&(this._gpuUsage|=GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC,e+="[index]"),this._usage&nr.BF_UNIFORM&&(this._gpuUsage|=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC,e+="[uniform]"),this._usage&nr.BF_STORAGE&&(this._gpuUsage|=GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC,e+="[storage]"),this._usage&(nr.BF_READ|nr.BF_PACK_PIXEL)&&(this._gpuUsage|=GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ,e+="[mapRead]"),this._usage&(nr.BF_WRITE|nr.BF_UNPACK_PIXEL)&&(this._gpuUsage|=GPUBufferUsage.COPY_SRC|GPUBufferUsage.MAP_WRITE,e+="[mapWrite]"),t){this._object=this._device.gpuCreateBuffer({label:e,size:t.byteLength+15&-16,usage:this._gpuUsage,mappedAtCreation:!0});const i=this._object.getMappedRange();new t.constructor(i).set(t),this._object.unmap()}else this._object=this._device.gpuCreateBuffer({label:e,size:this.byteLength+15&-16,usage:this._gpuUsage});const i=this.byteLength;this._device.updateVideoMemoryCost(i-this._memCost),this._memCost=i}}sync(){this._pendingUploads&&this._device.flushUploads()}pushUpload(t,e,i){const s=this._ringBuffer.fetchBufferMapped(e,!0);this._pendingUploads.splice(i,0,{mappedBuffer:{buffer:s.buffer,size:s.size,offset:t,used:s.used,mappedRange:s.mappedRange},uploadSize:e,uploadOffset:t,uploadBuffer:this._object})}}const Yo=_e.getCachedTypeInfo(te.U8VEC2_NORM),Zo=_e.getCachedTypeInfo(te.U8VEC4_NORM),Ko=_e.getCachedTypeInfo(te.I8VEC2_NORM),Jo=_e.getCachedTypeInfo(te.I8VEC4_NORM),th=_e.getCachedTypeInfo(te.U16VEC2),eh=_e.getCachedTypeInfo(te.U16VEC4),ih=_e.getCachedTypeInfo(te.I16VEC2),sh=_e.getCachedTypeInfo(te.I16VEC4),rh=_e.getCachedTypeInfo(te.U16VEC2_NORM),ah=_e.getCachedTypeInfo(te.U16VEC4_NORM),nh=_e.getCachedTypeInfo(te.I16VEC2_NORM),oh=_e.getCachedTypeInfo(te.I16VEC4_NORM),hh=_e.getCachedTypeInfo(te.F16VEC2),lh=_e.getCachedTypeInfo(te.F16VEC4),uh=_e.getCachedTypeInfo(te.F32),ch=_e.getCachedTypeInfo(te.F32VEC2),dh=_e.getCachedTypeInfo(te.F32VEC3),ph=_e.getCachedTypeInfo(te.F32VEC4),mh=_e.getCachedTypeInfo(te.U32),fh=_e.getCachedTypeInfo(te.U32VEC2),_h=_e.getCachedTypeInfo(te.U32VEC3),gh=_e.getCachedTypeInfo(te.U32VEC4),xh=_e.getCachedTypeInfo(te.I32),bh=_e.getCachedTypeInfo(te.I32VEC2),vh=_e.getCachedTypeInfo(te.I32VEC3),yh=_e.getCachedTypeInfo(te.I32VEC4),Th={[Yo.typeId]:"unorm8x2",[Zo.typeId]:"unorm8x4",[Ko.typeId]:"snorm8x2",[Jo.typeId]:"snorm8x4",[th.typeId]:"uint16x2",[eh.typeId]:"uint16x4",[ih.typeId]:"sint16x2",[sh.typeId]:"sint16x4",[rh.typeId]:"unorm16x2",[ah.typeId]:"unorm16x4",[nh.typeId]:"snorm16x2",[oh.typeId]:"snorm16x4",[hh.typeId]:"float16x2",[lh.typeId]:"float16x4",[uh.typeId]:"float32",[ch.typeId]:"float32x2",[dh.typeId]:"float32x3",[ph.typeId]:"float32x4",[mh.typeId]:"uint32",[fh.typeId]:"uint32x2",[_h.typeId]:"uint32x3",[gh.typeId]:"uint32x4",[xh.typeId]:"sint32",[bh.typeId]:"sint32x2",[vh.typeId]:"sint32x3",[yh.typeId]:"sint32x4"};class wh extends qo{_structure;_data;constructor(t,e,i,s){if(!e?.isStructType())throw new Error("invalid structure type");if(i&nr.BF_INDEX)throw new Error("structured buffer must not have Index usage flag");if(i&(nr.BF_READ|nr.BF_WRITE|nr.BF_PACK_PIXEL|nr.BF_UNPACK_PIXEL))throw new Error("structured buffer must not have Read or Write usage flags");if(i&nr.BF_VERTEX&&(1!==e.structMembers.length||!e.structMembers[0].type.isArrayType()))throw new Error("structured buffer for vertex usage must have only one array member");(i&nr.BF_UNIFORM||i&nr.BF_STORAGE)&&(i|=nr.DYNAMIC);const r=e.toBufferLayout(0,e.layout);if(s&&r.byteSize!==s.byteLength)throw new Error(`create structured buffer failed: invalid source size: ${s.byteLength}, should be ${r.byteSize}`);super(t,i,s||r.byteSize),this._data=new Nn(r,this),this._structure=e}set(t,e){this._data.set(t,e)}get structure(){return this._structure}set structure(t){if(t&&!t.isCompatibleType(this._structure)){const e=t.toBufferLayout(0,t.layout);if(e.byteSize>this.byteLength)throw new Error(`set structure type failed: new structure type is too large: ${e.byteSize}`);this._data=new Nn(e,this),this._structure=t}}static getGPUVertexFormat(t){return Th[t.typeId]}}class Sh extends Xo{_layout;_layoutDesc;_entries;_bindGroup;_buffers;_textures;_createdBuffers;_gpuId;_videoTextures;_dynamicOffsets;_resources;constructor(t,e){super(t),this._device=t,this._layout=e,this._layoutDesc=null,this._entries=null,this._bindGroup=null,this._dynamicOffsets=null,this._gpuId=0,this._resources={},this._buffers=[],this._textures=[],this._createdBuffers=[],this._videoTextures=null;for(const t of this._layout.entries)t.buffer&&t.buffer.hasDynamicOffset&&(this._dynamicOffsets||(this._dynamicOffsets=[]),this._dynamicOffsets[t.buffer.dynamicOffsetIndex]=0)}get bindGroup(){return this._bindGroup||(this._bindGroup=this._create()),this._bindGroup}get layoutDescriptor(){return this._bindGroup||(this._bindGroup=this._create()),this._layoutDesc}get entries(){return this._bindGroup||(this._bindGroup=this._create()),this._entries}getGPUId(){return`${this._uid}:${this._gpuId}`}get bufferList(){return this._buffers}get textureList(){return this._textures}invalidate(){this._bindGroup=null,this._gpuId++}getLayout(){return this._layout}getDynamicOffsets(){return this._dynamicOffsets}getBuffer(t,e=!0){return this._getBuffer(t,nr.BF_UNIFORM|nr.BF_STORAGE,e)}setBuffer(t,e,i,s,r){const a=this._layout.nameMap?.[t]??t;for(const n of this._layout.entries)if(n.name===a){if(n.buffer){s=s??0,r=r??(e?Math.max(0,e.byteLength-s):0);const a=this._resources[n.name],o="uniform"===n.buffer.type?nr.BF_UNIFORM:nr.BF_STORAGE;e&&e.usage&o?e===a?.[0]&&s===a?.[1]&&r===a?.[2]||(this._resources[n.name]=[e,s,r],this.invalidate()):console.error(`setBuffer() failed: buffer resource '${t}' must be type '${n.buffer.type}'`),n.buffer.hasDynamicOffset&&(this._dynamicOffsets[n.buffer.dynamicOffsetIndex]=i??0)}else console.error(`setBuffer() failed: resource '${t}' is not buffer`);return}console.error(`setBuffer() failed: no buffer resource named '${t}'`)}setValue(t,e){const i=this._layout.nameMap?.[t];if(i)this.setValue(i,{[t]:e});else{const i=this._getBuffer(t,nr.BF_UNIFORM|nr.BF_STORAGE,!1);if(i){if(!(i instanceof wh))throw new Error(`BindGroup.setValue() failed: '${t}' is not structured buffer`);if(e?.BYTES_PER_ELEMENT)i.bufferSubData(0,e);else for(const t in e)i.set(t,e[t])}else console.error(`setValue() failed: no uniform buffer named '${t}'`)}}setRawData(t,e,i,s,r){const a=this._layout.nameMap?.[t];if(a)this.setRawData(a,e,i,s,r);else{const a=this._getBuffer(t,nr.BF_UNIFORM|nr.BF_STORAGE,!1);a?a.bufferSubData(e,i,s,r):console.error(`set(): no uniform buffer named '${t}'`)}}getTexture(t){if(this._findTextureLayout(t)){const e=this._resources[t];return e?e[0]:null}throw new Error(`getTexture() failed:${t} is not a texture`)}setTextureView(t,e,i,s,r,a){if(!e)throw new Error(`WebGPUBindGroup.setTextureView() failed: invalid texture uniform value: ${e}`);{const n=this._findTextureLayout(t);if(!n)throw new Error(`WebGPUBindGroup.setView() failed: no texture uniform named '${t}'`);{if(n.externalTexture)throw new Error("WebGPUBindGroup.setTextureView() failed: video texture does not have view");if(e.isTextureVideo())throw new Error("WebGPUBindGroup.setTextureView() failed: invalid texture type");const o=this._resources[t],h=e.getView(i,s,r);if(o&&o[1]===h||(this._resources[t]=[e,h],this.invalidate()),n.texture?.autoBindSampler){const t=this._findSamplerLayout(n.texture.autoBindSampler);if(!t||!t.sampler)throw new Error(`WebGPUBindGroup.setTextureView() failed: sampler entry not found: ${n.texture.autoBindSampler}`);const i=!a||a.compare?e.getDefaultSampler(!1):a;i.object!==this._resources[n.texture.autoBindSampler]&&(this._resources[n.texture.autoBindSampler]=i.object,this.invalidate())}if(n.texture?.autoBindSamplerComparison){const t=this._findSamplerLayout(n.texture.autoBindSamplerComparison);if(!t||!t.sampler)throw new Error(`WebGPUBindGroup.setTextureView() failed: sampler entry not found: ${n.texture.autoBindSamplerComparison}`);const i=a&&a.compare?a:e.getDefaultSampler(!0);i.object!==this._resources[n.texture.autoBindSamplerComparison]&&(this._resources[n.texture.autoBindSamplerComparison]=i.object,this.invalidate())}}}}setTexture(t,e,i){if(!e)throw new Error(`WebGPUBindGroup.setTexture() failed: invalid texture uniform value: ${e}`);{const s=this._findTextureLayout(t);if(!s)throw new Error(`WebGPUBindGroup.setTexture() failed: no texture uniform named '${t}'`);{const r=this._resources[t];if(s.externalTexture){if(!e.isTextureVideo())throw new Error(`WebGPUBindGroup.setTexture() failed: invalid texture type of resource '${t}'`);if(!r||r!==e){r&&r.removeBindGroupReference(this),e&&e.addBindGroupReference(this),this._resources[t]=e,this.invalidate(),this._videoTextures=[];for(const t of this._layout.entries)if(t.externalTexture){const e=this._resources[t.name];e&&this._videoTextures.indexOf(e)<0&&this._videoTextures.push(e)}}}else{if(e.isTextureVideo())throw new Error(`WebGPUBindGroup.setTexture() failed: invalid texture type of resource '${t}'`);const i=e.getDefaultView();if(!s.externalTexture&&!i)throw new Error("WebGPUBindGroup.setTexture() failed: create texture view failed");r&&r[0]===e||(this._resources[t]=[e,i],this.invalidate())}const a=s.texture?.autoBindSampler||s.externalTexture?.autoBindSampler;if(a){const t=this._findSamplerLayout(a);if(!t||!t.sampler)throw new Error(`WebGPUBindGroup.setTexture() failed: sampler entry not found: ${a}`);const s=!i||i.compare?e.getDefaultSampler(!1):i;s.object!==this._resources[a]&&(this._resources[a]=s.object,this.invalidate())}const n=s.texture?.autoBindSamplerComparison;if(n){const t=this._findSamplerLayout(n);if(!t||!t.sampler)throw new Error(`WebGPUBindGroup.setTexture() failed: sampler entry not found: ${n}`);const s=i&&i.compare?i:e.getDefaultSampler(!0);s.object!==this._resources[n]&&(this._resources[n]=s.object,this.invalidate())}}}}setSampler(t,e){const i=e?.object;i?this._resources[t]!==i&&(this._findSamplerLayout(t)?(this._resources[t]=i,this.invalidate()):console.error(`WebGPUBindGroup.setSampler() failed: no sampler uniform named '${t}'`)):console.error(`WebGPUBindGroup.setSampler() failed: invalid sampler uniform value: ${e}`)}destroy(){this.invalidate(),this._resources={},this._buffers=[],this._textures=[],this._videoTextures=null,this._object=null;for(const t of this._createdBuffers)t.dispose();this._createdBuffers=[]}restore(){this.invalidate(),this._object={}}isBindGroup(){return!0}updateVideoTextures(){this._videoTextures?.forEach(t=>{t.updateVideoFrame()&&this.invalidate()})}_findTextureLayout(t){for(const e of this._layout.entries)if((e.texture||e.storageTexture||e.externalTexture)&&e.name===t)return e;return null}_findSamplerLayout(t){for(const e of this._layout.entries)if(e.sampler&&e.name===t)return e;return null}_getBuffer(t,e,i=!1){const s=this._getBufferInfo(t,e,i);return s?.[0]??null}_getBufferInfo(t,e,i=!1){const s=this._layout.nameMap?.[t]??t;for(const t of this._layout.entries)if(t.buffer&&t.name===s){const s="uniform"===t.buffer.type?nr.BF_UNIFORM:nr.BF_STORAGE;if(!(e&s))return null;let r=this._resources[t.name];if(!i&&r?.[0]?.disposed&&(r[0]=null,this.invalidate()),!(r&&r[0]||i)){const e={usage:s===nr.BF_UNIFORM?"uniform":null,storage:s===nr.BF_STORAGE,dynamic:!0},i=this._device.createStructuredBuffer(t.type,e);r=[i,0,i.byteLength],this._resources[t.name]=r,this._createdBuffers.push(i)}return r}return null}_create(){let t=null;this._layoutDesc=null,this._entries=null,this._textures=[],this._buffers=[];const e=[];let i=!0;for(const t of this._layout.entries){const s={binding:t.binding};if(t.buffer){const e=this._getBufferInfo(t.name,"uniform"===t.buffer.type?nr.BF_UNIFORM:nr.BF_STORAGE,!0);if(!e)throw new Error(`Uniform buffer '${t.name}' not exists, maybe you forgot settings some uniform values`);this._buffers.indexOf(e[0])<0&&this._buffers.push(e[0]),s.resource={buffer:e[0].object,offset:e[1],size:e[2]},i=i&&!!e[0].object}else if(t.texture||t.storageTexture){const e=this._resources[t.name];e?(this._textures.indexOf(e[0])<0&&this._textures.push(e[0]),s.resource=e[1],i=i&&!!e[1]):(console.error(`Missing texture in bind group: ${t.name}`),i=!1)}else if(t.externalTexture){const e=this._resources[t.name];s.resource=e.object,i=i&&!!e.object}else if(t.sampler){const e=this._resources[t.name];s.resource=e,i=i&&!!e}e.push(s)}if(!i)return null;const[s,r]=this._device.fetchBindGroupLayout(this._layout),a={layout:r,entries:e};return r.label&&(a.label=`${r.label}.bindgroup`),t=this._device.gpuCreateBindGroup(a),t||console.error("Create bindgroup failed"),this._layoutDesc=s,this._entries=e,t}}const Ah={repeat:"repeat","mirrored-repeat":"mirror-repeat",clamp:"clamp-to-edge"},Ch={nearest:"nearest",linear:"linear",none:void 0},Eh={always:"always",le:"less-equal",ge:"greater-equal",lt:"less",gt:"greater",eq:"equal",ne:"not-equal",never:"never"},Mh={keep:"keep",replace:"replace",zero:"zero",invert:"invert",incr:"increment-clamp",decr:"decrement-clamp","incr-wrap":"increment-wrap","decr-wrap":"decrement-wrap"},Bh={"triangle-list":"triangle-list","triangle-strip":"triangle-strip","triangle-fan":null,"line-list":"line-list","line-strip":"line-strip","point-list":"point-list"},Ih={back:"back",front:"front",none:"none"},Ph={add:"add",subtract:"subtract","reverse-subtract":"reverse-subtract",min:"min",max:"max"},$h={"const-color":"constant","const-alpha":"constant","dst-color":"dst","dst-alpha":"dst-alpha","inv-const-color":"one-minus-constant","inv-const-alpha":"one-minus-constant","inv-dst-color":"one-minus-dst","inv-dst-alpha":"one-minus-dst-alpha","src-color":"src","src-alpha":"src-alpha","inv-src-color":"one-minus-src","inv-src-alpha":"one-minus-src-alpha","src-alpha-saturate":"src-alpha-saturated",one:"one",zero:"zero"},Rh={float32:"0",float32x2:"1",float32x3:"2",float32x4:"3",uint32:"4",uint32x2:"5",uint32x3:"6",uint32x4:"7",sint32:"8",sint32x2:"9",sint32x3:"a",sint32x4:"b",uint16x2:"c",uint16x4:"d",unorm16x2:"e",unorm16x4:"f",sint16x2:"g",sint16x4:"h",snorm16x2:"i",snorm16x4:"j",uint8x2:"k",uint8x4:"l",unorm8x2:"m",unorm8x4:"n",sint8x2:"o",sint8x4:"p",snorm8x2:"q",snorm8x4:"r"},Fh={unknown:null,rgba8unorm:"rgba8unorm",rgba8snorm:"rgba8snorm",bgra8unorm:"bgra8unorm",dxt1:"bc1-rgba-unorm",dxt3:"bc2-rgba-unorm",dxt5:"bc3-rgba-unorm","dxt1-srgb":"bc1-rgba-unorm-srgb","dxt3-srgb":"bc2-rgba-unorm-srgb","dxt5-srgb":"bc3-rgba-unorm-srgb",bc4:"bc4-r-unorm","bc4-signed":"bc4-r-snorm",bc5:"bc5-rg-unorm","bc5-signed":"bc5-rg-snorm",bc6h:"bc6h-rgb-ufloat","bc6h-signed":"bc6h-rgb-float",bc7:"bc7-rgba-unorm","bc7-srgb":"bc7-rgba-unorm-srgb","astc-4x4":"astc-4x4-unorm","astc-4x4-srgb":"astc-4x4-unorm-srgb","astc-5x4":"astc-5x4-unorm","astc-5x4-srgb":"astc-5x4-unorm-srgb","astc-5x5":"astc-5x5-unorm","astc-5x5-srgb":"astc-5x5-unorm-srgb","astc-6x5":"astc-6x5-unorm","astc-6x5-srgb":"astc-6x5-unorm-srgb","astc-6x6":"astc-6x6-unorm","astc-6x6-srgb":"astc-6x6-unorm-srgb","astc-8x5":"astc-8x5-unorm","astc-8x5-srgb":"astc-8x5-unorm-srgb","astc-8x6":"astc-8x6-unorm","astc-8x6-srgb":"astc-8x6-unorm-srgb","astc-8x8":"astc-8x8-unorm","astc-8x8-srgb":"astc-8x8-unorm-srgb","astc-10x5":"astc-10x5-unorm","astc-10x5-srgb":"astc-10x5-unorm-srgb","astc-10x6":"astc-10x6-unorm","astc-10x6-srgb":"astc-10x6-unorm-srgb","astc-10x8":"astc-10x8-unorm","astc-10x8-srgb":"astc-10x8-unorm-srgb","astc-10x10":"astc-10x10-unorm","astc-10x10-srgb":"astc-10x10-unorm-srgb","astc-12x10":"astc-12x10-unorm","astc-12x10-srgb":"astc-12x10-unorm-srgb","astc-12x12":"astc-12x12-unorm","astc-12x12-srgb":"astc-12x12-unorm-srgb",r8unorm:"r8unorm",r8snorm:"r8snorm",r16f:"r16float",r32f:"r32float",r8ui:"r8uint",r8i:"r8sint",r16ui:"r16uint",r16i:"r16sint",r32ui:"r32uint",r32i:"r32sint",rg8unorm:"rg8unorm",rg8snorm:"rg8snorm",rg16f:"rg16float",rg32f:"rg32float",rg8ui:"rg8uint",rg8i:"rg8sint",rg16ui:"rg16uint",rg16i:"rg16sint",rg32ui:"rg32uint",rg32i:"rg32sint","rgba8unorm-srgb":"rgba8unorm-srgb","bgra8unorm-srgb":"bgra8unorm-srgb",rgba16f:"rgba16float",rgba32f:"rgba32float",rgba8ui:"rgba8uint",rgba8i:"rgba8sint",rgba16ui:"rgba16uint",rgba16i:"rgba16sint",rgba32ui:"rgba32uint",rgba32i:"rgba32sint",rg11b10uf:"rg11b10ufloat",d16:"depth16unorm",d24:"depth24plus",d32f:"depth32float",d32fs8:"depth32float-stencil8",d24s8:"depth24plus-stencil8"};function Dh(t,e){const i={},s=t.length;for(let r=0;r<s;r++)i[t[r]]=e[r];return i}const Nh=Dh(Object.values(Fh),Object.keys(Fh)),Lh=Dh(Object.values(Rh),Object.keys(Rh));class zh{static _clearPrograms={};static _clearStateSet=null;static _defaultClearColor=new O(0,0,0,1);static drawClearQuad(t,e,i,s){this._clearStateSet||this.initClearQuad(t);const r=t.getFrameBufferInfo().clearHash,a=this.getClearProgram(t.getDevice(),r),n=!!e,o=!(null==i),h=!(null==s);a.bindGroup.setValue("clearDepth",i??1),a.bindGroup.setValue("clearColor",e??this._defaultClearColor),this._clearStateSet.useDepthState().enableWrite(o),this._clearStateSet.useColorState().setColorMask(n,n,n,n),this._clearStateSet.useStencilState().enable(h).setReference(h?s:0),t.getDevice().commandQueue.draw(a.program,null,this._clearStateSet,[a.bindGroup],null,"triangle-strip",0,4,1)}static getClearProgram(t,e){let i=this._clearPrograms[e];if(!i){const s=e.split(""),r=t.buildRenderProgram({label:`ClearQuad-${e}`,vertex(t){this.clearDepth=t.float().uniform(0),this.coords=[t.vec2(-1,1),t.vec2(1,1),t.vec2(-1,-1),t.vec2(1,-1)],t.main(function(){this.$builtins.position=t.vec4(this.coords.at(this.$builtins.vertexIndex),this.clearDepth,1)})},fragment(t){if(this.clearColor=t.vec4().uniform(0),0===s.length)this.$outputs.outColor=t.vec4(),t.main(function(){this.$outputs.outColor=this.clearColor});else{for(let e=0;e<s.length;e++)this.$outputs[`outColor${e}`]="f"===s[e]?t.vec4():"i"===s[e]?t.ivec4():t.uvec4();t.main(function(){for(let e=0;e<s.length;e++)this.$outputs[`outColor${e}`]="f"===s[e]?this.clearColor:"i"===s[e]?t.ivec4(this.clearColor):t.uvec4(this.clearColor)})}}});i={program:r,bindGroup:t.createBindGroup(r.bindGroupLayouts[0])},this._clearPrograms[e]=i}return i}static initClearQuad(t){this._clearStateSet=t.getDevice().createRenderStateSet(),this._clearStateSet.useDepthState().enableTest(!1),this._clearStateSet.useRasterizerState().setCullMode("none"),this._clearStateSet.useStencilState().enable(!0).setFrontOp("replace","replace","replace").setBackOp("replace","replace","replace").setFrontCompareFunc("always").setBackCompareFunc("always")}}class Vh{static _frameBufferInfo=null;static _mipmapGenerationProgram=null;static _mipmapGenerationStateSet=null;static getMipmapGenerationBindGroupLayout(t){return this._mipmapGenerationProgram||this.initMipmapGeneration(t),this._mipmapGenerationProgram.bindGroupLayouts[0]}static generateMipmap(t,e,i){if(!e.isRenderable())return;this._mipmapGenerationProgram||this.initMipmapGeneration(t);const s=i??t.device.createCommandEncoder(),r=e.mipLevelCount,a=e.isTextureCube()?6:e.isTexture2DArray()?e.depth:1;e.setMipmapDirty(!1);for(let i=0;i<a;i++)for(let a=1;a<r;a++)this.generateMiplevel(t,s,e,e.object,e.gpuFormat,a,a,i);i||t.device.queue.submit([s.finish()])}static generateMipmapsForBindGroups(t,e){for(const i of e)if(i)for(const e of i.textureList)!e.disposed&&e.isMipmapDirty()&&Vh.generateMipmap(t,e)}static generateMiplevel(t,e,i,s,r,a,n,o){const h=this.beginMipmapGenerationPass(e,s,r,a,o);h.setBindGroup(0,i.getMipmapGenerationBindGroup(n,o).bindGroup);const l=t.pipelineCache.fetchRenderPipeline(this._mipmapGenerationProgram,null,this._mipmapGenerationStateSet,"triangle-strip",this._frameBufferInfo);l&&(h.setPipeline(l),h.draw(4,1,0)),h.end()}static beginMipmapGenerationPass(t,e,i,s,r){const a={colorAttachments:[{view:e.createView({dimension:"2d",baseMipLevel:s||0,mipLevelCount:1,baseArrayLayer:r||0,arrayLayerCount:1}),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}]};this._frameBufferInfo={frameBuffer:null,colorFormats:[i],depthFormat:null,sampleCount:1,hash:null,clearHash:null},this._frameBufferInfo.hash=`${this._frameBufferInfo.colorFormats.join("-")}:${this._frameBufferInfo.depthFormat}:${this._frameBufferInfo.sampleCount}`;const n=t.beginRenderPass(a);return n.insertDebugMarker("MipmapGeneration"),n}static initMipmapGeneration(t){this._mipmapGenerationProgram=t.buildRenderProgram({label:"MipmapGeneration",vertex(t){this.$outputs.outUV=t.vec2(),this.coords=[t.vec2(-1,1),t.vec2(1,1),t.vec2(-1,-1),t.vec2(1,-1)],this.uv=[t.vec2(0,0),t.vec2(1,0),t.vec2(0,1),t.vec2(1,1)],t.main(function(){this.$builtins.position=t.vec4(this.coords.at(this.$builtins.vertexIndex),0,1),this.$outputs.outUV=this.uv.at(this.$builtins.vertexIndex)})},fragment(t){this.$outputs.color=t.vec4(),this.tex=t.tex2D().uniform(0),t.main(function(){this.$outputs.color=t.textureSampleLevel(this.tex,this.$inputs.outUV,0)})}}),this._mipmapGenerationStateSet=t.createRenderStateSet(),this._mipmapGenerationStateSet.useDepthState().enableTest(!1).enableWrite(!1),this._mipmapGenerationStateSet.useRasterizerState().setCullMode("none")}}class Oh extends Xo{_target;_hash;_memCost;_views;_defaultView;_mipmapDirty;_flags;_width;_height;_depth;_format;_renderable;_fb;_gpuFormat;_mipLevelCount;_samplerOptions;_ringBuffer;_mipBindGroups;_pendingUploads;constructor(t,e){super(t),this._target=e,this._flags=0,this._width=0,this._height=0,this._depth=0,this._renderable=!1,this._fb=!1,this._format="unknown",this._gpuFormat=null,this._mipLevelCount=0,this._samplerOptions=null,this._memCost=0,this._mipmapDirty=!1,this._mipBindGroups=[],this._views=[],this._defaultView=null,this._ringBuffer=new Qo(t),this._pendingUploads=[]}get hash(){return this._object?this._device.gpuGetObjectHash(this._object):0}get target(){return this._target}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get memCost(){return this._memCost}get format(){return this._format}get mipLevelCount(){return this._mipLevelCount}get gpuFormat(){return this._gpuFormat}get samplerOptions(){return this._samplerOptions}set samplerOptions(t){const e=this.getTextureCaps().getTextureFormatInfo(this._format);this._samplerOptions=t?Object.assign({},this._getSamplerOptions(e,!!t.compare),t):null}isTexture(){return!0}isFilterable(){return!!this.getTextureCaps().getTextureFormatInfo(this._format)?.filterable}clearPendingUploads(){this._pendingUploads.length>0&&(this._pendingUploads=[],this.beginSyncChanges(null),this.endSyncChanges())}isMipmapDirty(){return this._mipmapDirty}setMipmapDirty(t){this._mipmapDirty=t}destroy(){if(this._object){this.isTextureVideo()||this._object.destroy(),this._object=null,this._device.updateVideoMemoryCost(-this._memCost),this._memCost=0,this._ringBuffer.purge(),this._views=[];for(const t of this._mipBindGroups)for(const e of t)e?.dispose();this._mipBindGroups=[]}}restore(){this._object||this._device.isContextLost()||this.init()}getTextureCaps(){return this._device.getDeviceCaps().textureCaps}isSRGBFormat(){return Ut(this._format)}isFloatFormat(){return zt(this._format)}isIntegerFormat(){return Vt(this._format)}isSignedFormat(){return Ot(this._format)}isCompressedFormat(){return kt(this._format)}isDepth(){return Nt(this._format)}isRenderable(){return this._renderable}getView(t,e,i){return t=Number(t)||0,e=Number(e)||0,i=Number(i)||0,this._views[e]||(this._views[e]=[]),this._views[e][t]||(this._views[e][t]=[]),this._views[e][t][i]||(this._views[e][t][i]=this.createView(t,e,i)),this._views[e][t][i]}getDefaultView(){return this._defaultView||!this._object||this.isTextureVideo()||(this._defaultView=this._device.gpuCreateTextureView(this._object,{dimension:this.isTextureCube()?"cube":this.isTexture3D()?"3d":this.isTexture2DArray()?"2d-array":"2d",arrayLayerCount:this.isTextureCube()?6:this.isTexture2DArray()?this._depth:1,aspect:Nt(this.format)?"depth-only":"all"})),this._defaultView}copyPixelDataToBuffer(t,e,i,s,r,a,n){if(this.isTextureVideo())throw new Error("copyPixelDataToBuffer() failed: can not copy pixel data of video texture");this.sync(),Oh.copyTexturePixelsToBuffer(this._device.device,this.object,this.format,t,e,i,s,r,a,n)}generateMipmaps(){this._mipmapDirty=!0,this._device.textureUpload(this)}beginSyncChanges(t){if(!this.isTextureVideo()&&this._pendingUploads.length>0&&this._object){const e=t||this._device.device.createCommandEncoder();for(const t of this._pendingUploads)if(t.mappedBuffer){const i=t;e.copyBufferToTexture({buffer:i.mappedBuffer.buffer,offset:i.mappedBuffer.offset,bytesPerRow:i.bufferStride,rowsPerImage:i.uploadHeight},{texture:this._object,origin:{x:i.uploadOffsetX,y:i.uploadOffsetY,z:i.uploadOffsetZ},mipLevel:i.mipLevel},{width:i.uploadWidth,height:i.uploadHeight,depthOrArrayLayers:i.uploadDepth})}else if(t.image){const e=t,i={texture:this._object,origin:{x:e.offsetX,y:e.offsetY,z:e.offsetZ},mipLevel:e.mipLevel,premultipliedAlpha:!1};this._device.device.queue.copyExternalImageToTexture({source:e.image,origin:{x:e.srcX,y:e.srcY}},i,{width:e.width,height:e.height,depthOrArrayLayers:e.depth})}this._pendingUploads.length=0,t||this._device.device.queue.submit([e.finish()]),this._ringBuffer.beginUploads()}}endSyncChanges(){this._flags&nr.DYNAMIC?this._ringBuffer.endUploads():this._ringBuffer.purge()}getDefaultSampler(t){const e=this.getTextureCaps().getTextureFormatInfo(this._format);return this._device.createSampler(this._samplerOptions&&!this._samplerOptions.compare==!t?this._samplerOptions:this._getSamplerOptions(e,t))}sync(){this._device.flush()}_calcMipLevelCount(t,e,i,s){if(Nt(t)||this.isTexture3D()||this.isTextureVideo())return 1;if(this._flags&nr.TF_NO_MIPMAP)return 1;const r=this.getTextureCaps().getTextureFormatInfo(t);return r&&r.renderable?Math.floor(Math.log2(Math.max(e,i)))+1:1}allocInternal(t,e,i,s,r){if(!this.isTextureVideo()){if(0===r)r=this._calcMipLevelCount(t,e,i,s);else if(1!==r){let t=Math.max(e,i);this.isTexture3D()&&(t=Math.max(t,s));const a=Math.floor(Math.log2(t))+1;(!Number.isInteger(r)||r<0||r>a)&&(r=a)}if(this._object&&(this._format!==t||this._width!==e||this._height!==i||this._depth,this._mipLevelCount!==r)){const t=this._object;this._device.runNextFrame(()=>{t.destroy()}),this._object=null}if(!this._object&&(this._format=t,this._width=e,this._height=i,this._depth=s,this._mipLevelCount=r,!this._device.isContextLost())){this._gpuFormat=Fh[this._format];const t=this.getTextureCaps().getTextureFormatInfo(this._format);this._renderable=t.renderable&&!(this._flags&nr.TF_WRITABLE),this._object=this._device.gpuCreateTexture({size:{width:this._width,height:this._height,depthOrArrayLayers:this.isTextureCube()?6:this._depth},format:this._gpuFormat,mipLevelCount:this._mipLevelCount,sampleCount:1,dimension:this.isTexture3D()?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(this._renderable&&!this.isTexture3D()?GPUTextureUsage.RENDER_ATTACHMENT:0)|(this._flags&nr.TF_WRITABLE?GPUTextureUsage.STORAGE_BINDING:0)});const e=this.getTextureCaps().calcMemoryUsage(this._format,this._width*this._height*(this.isTextureCube()?6:this._depth));this._device.updateVideoMemoryCost(e-this._memCost),this._memCost=e}}}static calculateBufferSizeForCopy(t,e,i){const s=Ht(i),r=Wt(i),a=Gt(i),n=Math.ceil(t/s),o=Math.ceil(e/r),h=n*a,l=h+255&-256;return{size:o*h,sizeAligned:o*l,strideAligned:l,stride:h,numRows:o}}static copyTexturePixelsToBuffer(t,e,i,s,r,a,n,o,h,l){if(!(l.gpuUsage&GPUBufferUsage.COPY_DST))return void console.error("copyTexturePixelsToBuffer() failed: destination buffer does not have COPY_DST usage set");const{size:u,sizeAligned:c,stride:d,strideAligned:p,numRows:m}=this.calculateBufferSizeForCopy(a,n,i);if(l.byteLength<u)return void console.error(`copyTexturePixelsToBuffer() failed: destination buffer size is ${l.byteLength}, should be at least ${u}`);const f=t.createBuffer({size:c,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),_=t.createCommandEncoder();if(_.copyTextureToBuffer({texture:e,mipLevel:h??0,origin:{x:s,y:r,z:o??0}},{buffer:f,offset:0,bytesPerRow:p},{width:a,height:n,depthOrArrayLayers:1}),u!==c)for(let t=0;t<m;t++)_.copyBufferToBuffer(f,t*p,l.object,t*d,d);else _.copyBufferToBuffer(f,0,l.object,0,u);t.queue.submit([_.finish()]),f.destroy()}uploadRaw(t,e,i,s,r,a,n,o){if(this.isTextureVideo())return void console.error("BaseTexture.uploadRaw(): Cannot upload to video texture");const h=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),l=this.getTextureCaps().getTextureFormatInfo(this._format),u=l.blockWidth||1,c=l.blockHeight||1,d=Math.ceil(e/u),p=Math.ceil(i/c),m=d*l.size;if(m*p*s>h.byteLength)throw new Error(`WebGPUTexture.update() invalid data size: ${h.byteLength}`);if(this._device.isTextureUploading(this)){const t=m+255&-256,e=t*p*s,i=this._ringBuffer.uploadBuffer(null,null,0,0,e),l=i.mappedBuffer.mappedRange,f=new Uint8Array(h),_=new Uint8Array(l,i.mappedBuffer.offset,e);if(e===h.byteLength)_.set(new Uint8Array(h));else for(let e=0;e<s;e++){const i=e*m*d,s=e*t*p;for(let e=0;e<p;e++)_.set(f.subarray(i+e*m,i+(e+1)*m),s+e*t)}this._pendingUploads.push({mappedBuffer:i.mappedBuffer,uploadOffsetX:r,uploadOffsetY:a,uploadOffsetZ:n,uploadWidth:u*d,uploadHeight:c*p,uploadDepth:s,bufferStride:t,mipLevel:o}),this._device.textureUpload(this)}else{this.clearPendingUploads();const t={texture:this._object,mipLevel:o,origin:{x:r,y:a,z:n}},e={bytesPerRow:m,rowsPerImage:c*p},i={width:u*d,height:c*p,depthOrArrayLayers:s};this._device.device.queue.writeTexture(t,h,e,i)}}uploadImageData(t,e,i,s,r,a,n,o,h){if(this.isTextureVideo())console.error("BaseTexture.uploadImageData(): Cannot upload to video texture");else if(!this._device.isTextureUploading(this)&&this._device.device.queue.copyExternalImageToTexture){this.clearPendingUploads();const e={texture:this._object,origin:{x:a,y:n,z:h??0},mipLevel:o??0,premultipliedAlpha:!1};this._device.device.queue.copyExternalImageToTexture({source:t},e,{width:s,height:r,depthOrArrayLayers:1})}else this._pendingUploads.push({image:t,offsetX:a,offsetY:n,offsetZ:h??0,srcX:e??0,srcY:i??0,srcZ:0,width:s,height:r,depth:1,mipLevel:o??0}),this._device.textureUpload(this)}getMipmapGenerationBindGroup(t,e){const i=this._mipBindGroups;let s=i[e];s||(s=[],i[e]=s);let r=s[t];return r||(r=this._device.createBindGroup(Vh.getMipmapGenerationBindGroupLayout(this._device)),r.setTextureView("tex",this,t-1,e,1),s[t]=r),r}_getSamplerOptions(t,e){const i=this.isDepth()&&e,s=t.filterable||i;return{addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:s?"linear":"nearest",minFilter:t.filterable?"linear":"nearest",mipFilter:this._mipLevelCount>1?s?"linear":"nearest":"none",compare:i?"lt":null}}_markAsCurrentFB(t){this._fb=t}_isMarkedAsCurrentFB(){return this._fb}}class kh extends Oh{constructor(t){super(t,"2d")}isTexture2D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._mipLevelCount)}update(t,e,i,s,r){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),this.uploadRaw(t,s,r,1,e,i,0,0),this._mipLevelCount>1&&this.generateMipmaps())}updateFromElement(t,e,i,s,r,a,n){if(!this._device.isContextLost())if(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),t instanceof HTMLCanvasElement||this._device.isTextureUploading(this)){const o=document.createElement("canvas");o.width=a,o.height=n;const h=o.getContext("2d");h.drawImage(t,s,r,a,n,0,0,a,n);const l=h.getImageData(0,0,a,n);this.update(l.data,e,i,a,n),o.width=0,o.height=0}else this.uploadImageData(t,s,r,a,n,e,i,0,0)}async readPixels(t,e,i,s,r,a,n){if(0!==r)throw new Error("Texture2D.readPixels(): parameter faceOrLayer must be 0");if(a>=this.mipLevelCount||a<0)throw new Error(`Texture2D.readPixels(): invalid miplevel: ${a}`);const{size:o}=Oh.calculateBufferSizeForCopy(i,s,this.format);if(n.byteLength<o)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${n.byteLength}, should be at least ${o}`);const h=this._device.createBuffer(o,{usage:"read"});await this.copyPixelDataToBuffer(t,e,i,s,0,a,h),await h.getBufferSubData(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),0,o),h.dispose()}readPixelsToBuffer(t,e,i,s,r,a,n){if(0!==r)throw new Error("Texture2D.readPixels(): parameter faceOrLayer must be 0");if(a>=this.mipLevelCount||a<0)throw new Error(`Texture2D.readPixels(): invalid miplevel: ${a}`);this.copyPixelDataToBuffer(t,e,i,s,0,a,n)}loadFromElement(t,e,i){this._flags=Number(i)||0;const s=e?"rgba8unorm-srgb":"rgba8unorm";this.loadImage(t,s)}createEmpty(t,e,i,s){this._flags=Number(s)||0,this.loadEmpty(t,e,i,0)}createView(t,e,i){return this._object?this._device.gpuCreateTextureView(this._object,{dimension:"2d",baseMipLevel:t??0,mipLevelCount:i||this._mipLevelCount-(t??0),baseArrayLayer:0,arrayLayerCount:1}):null}createWithMipmapData(t,e,i){t.isCubemap||t.isVolume?console.error("loading 2d texture with mipmap data failed: data is not 2d texture"):(this._flags=Number(i)||0,this._flags&nr.TF_WRITABLE?console.error(new Error("webgl device does not support storage texture")):this.loadLevels(t,e))}loadEmpty(t,e,i,s){this.allocInternal(t,e,i,1,s),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(t,e){let i=e?Dt(t.format):t.format,s=!1;"bgra8unorm"===i?(i="rgba8unorm",s=!0):"bgra8unorm-srgb"===this._format&&(i="rgba8unorm-srgb",s=!0);const r=t.width,a=t.height,n=t.mipLevels;if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(i,r,a,1,n),!this._device.isContextLost())for(let e=0;e<t.mipDatas[0].length;e++){if(s)for(let i=0;i<t.mipDatas[0][e].width*t.mipDatas[0][e].height;i++){const s=t.mipDatas[0][e].data[4*i];t.mipDatas[0][e].data[4*i]=t.mipDatas[0][e].data[4*i+2],t.mipDatas[0][e].data[4*i+2]=s}this.uploadRaw(t.mipDatas[0][e].data,t.mipDatas[0][e].width,t.mipDatas[0][e].height,1,0,0,0,e)}}else console.error("No s3tc compression format support")}loadImage(t,e){this.allocInternal(e,Number(t.width),Number(t.height),1,0),this._device.isContextLost()||(this.updateFromElement(t,0,0,0,0,this._width,this._height),this._mipLevelCount>1&&this.generateMipmaps())}}class Uh extends Oh{constructor(t){super(t,"2darray")}isTexture2DArray(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(t,e,i,s,r,a,n){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount),this.uploadRaw(t,r,a,n,e,i,s,0),this._mipLevelCount>1&&this.generateMipmaps())}updateFromElement(t,e,i,s,r,a,n,o){if(!this._device.isContextLost())if(this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount),t instanceof HTMLCanvasElement||this._device.isTextureUploading(this)){const h=document.createElement("canvas");h.width=n,h.height=o;const l=h.getContext("2d");l.drawImage(t,r,a,n,o,0,0,n,o);const u=l.getImageData(0,0,n,o);this.update(u.data,e,i,s,n,o,1),h.width=0,h.height=0}else this.uploadImageData(t,r,a,n,o,e,i,0,s)}createEmpty(t,e,i,s,r){this._flags=Number(r)||0,this.loadEmpty(t,e,i,s,0)}createWithMipmapData(t,e){t.arraySize?(this._flags=Number(e)||0,this._flags&nr.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(t)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}createView(t,e,i){return this._object?this._device.gpuCreateTextureView(this._object,{dimension:"2d",baseMipLevel:t??0,mipLevelCount:i||this._mipLevelCount-(t??0),baseArrayLayer:e??0,arrayLayerCount:1}):null}async readPixels(t,e,i,s,r,a,n){if(r<0||r>=this._depth)throw new Error(`Texture2DArray.readPixels(): invalid layer: ${r}`);if(a<0||a>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixels(): invalid miplevel: ${a}`);const{size:o}=Oh.calculateBufferSizeForCopy(i,s,this.format);if(n.byteLength<o)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${n.byteLength}, should be at least ${o}`);const h=this._device.createBuffer(o,{usage:"read"});await this.copyPixelDataToBuffer(t,e,i,s,r,a,h),await h.getBufferSubData(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),0,o),h.dispose()}readPixelsToBuffer(t,e,i,s,r,a,n){if(r<0||r>=this._depth)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid layer: ${r}`);if(a<0||a>=this.mipLevelCount)throw new Error(`Texture2DArray.readPixelsToBuffer(): invalid miplevel: ${a}`);this.copyPixelDataToBuffer(t,e,i,s,r,a,n)}loadEmpty(t,e,i,s,r){this.allocInternal(t,e,i,s,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(t){const e=t.format,i=t.width,s=t.height,r=t.arraySize,a=1!==t.mipLevels||this._flags&nr.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,i,s,r);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(e,i,s,t.arraySize,a),!this._device.isContextLost()){for(let e=0;e<t.arraySize;e++){if(t.mipDatas[e].length!==t.mipLevels)return void console.error("Texture2DArray.loadLevels() failed: Invalid texture data");for(let i=0;i<t.mipLevels;i++)this.uploadRaw(t.mipDatas[e][i].data,t.mipDatas[e][i].width,t.mipDatas[e][i].height,1,0,0,e,i)}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture2DArray.loadLevels(): No s3tc compression format support")}}class Gh extends Oh{constructor(t){super(t,"3d")}isTexture3D(){return!0}init(){this.loadEmpty(this._format,this._width,this._height,this._depth,this._mipLevelCount)}update(t,e,i,s,r,a,n){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,this._depth,this._mipLevelCount),this.uploadRaw(t,r,a,n,e,i,s,0))}createEmpty(t,e,i,s,r){this._flags=Number(r)||0,this.loadEmpty(t,e,i,s,0)}createView(t,e,i){return this._object?this._device.gpuCreateTextureView(this._object,{dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:e,arrayLayerCount:1}):null}async readPixels(t,e,i,s,r,a,n){if(0!==a)throw new Error("Texture3D.readPixels(): parameter mipLevel must be 0");const{size:o}=Oh.calculateBufferSizeForCopy(i,s,this.format);if(n.byteLength<o)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${n.byteLength}, should be at least ${o}`);const h=this._device.createBuffer(o,{usage:"read"});await this.copyPixelDataToBuffer(t,e,i,s,r,0,h),await h.getBufferSubData(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),0,o),h.dispose()}readPixelsToBuffer(t,e,i,s,r,a,n){if(0!==a)throw new Error("Texture3D.readPixelsToBuffer(): parameter mipLevel must be 0");this.copyPixelDataToBuffer(t,e,i,s,r,0,n)}createWithMipmapData(t,e){t.arraySize?(this._flags=Number(e)||0,this._flags&nr.TF_WRITABLE?console.error("Texture2DArray.createWithMipmapData() failed: Webgl device does not support storage texture"):this.loadLevels(t)):console.error("Texture2DArray.createWithMipmapData() failed: Data is not texture array")}loadLevels(t){const e=t.format,i=t.width,s=t.height,r=t.depth,a=1!==t.mipLevels||this._flags&nr.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,i,s,r);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(e,i,s,r,a),!this._device.isContextLost()){for(let e=0;e<r;e++){if(t.mipDatas[e].length!==t.mipLevels)return void console.error("Texture3D.loadLevels() failed: Invalid texture data");for(let i=0;i<t.mipLevels;i++)this.uploadRaw(t.mipDatas[e][i].data,t.mipDatas[e][i].width,t.mipDatas[e][i].height,1,0,0,e,i)}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}}else console.error("Texture3D.loadLevels(): No s3tc compression format support")}loadEmpty(t,e,i,s,r){this.allocInternal(t,e,i,s,r),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}}class Hh extends Oh{constructor(t){super(t,"cube")}init(){this.loadEmpty(this._format,this._width,this._mipLevelCount)}update(t,e,i,s,r,a){this._device.isContextLost()||(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),this.uploadRaw(t,s,r,1,e,i,a,0),this._mipLevelCount>1&&this.generateMipmaps())}updateFromElement(t,e,i,s,r,a,n,o){if(!this._device.isContextLost())if(this._object||this.allocInternal(this._format,this._width,this._height,1,this._mipLevelCount),t instanceof HTMLCanvasElement||this._device.isTextureUploading(this)){const h=document.createElement("canvas");h.width=n,h.height=o;const l=h.getContext("2d");l.drawImage(t,r,a,n,o,0,0,n,o);const u=l.getImageData(0,0,n,o);this.update(u.data,e,i,n,o,s),h.width=0,h.height=0}else this.uploadImageData(t,r,a,n,o,e,i,0,s)}createEmpty(t,e,i){this._flags=Number(i)||0,this._flags&nr.TF_WRITABLE?console.error(new Error("storage texture can not be cube texture")):this.loadEmpty(t,e,0)}isTextureCube(){return!0}createView(t,e,i){return this._object?this._device.gpuCreateTextureView(this._object,{format:this._gpuFormat,dimension:"2d",baseMipLevel:t??0,mipLevelCount:i||this._mipLevelCount-(t??0),baseArrayLayer:e??0,arrayLayerCount:1,aspect:"all"}):null}async readPixels(t,e,i,s,r,a,n){if(a<0||a>=this.mipLevelCount)throw new Error(`TextureCube.readPixels(): invalid miplevel: ${a}`);const{size:o}=Oh.calculateBufferSizeForCopy(i,s,this.format);if(n.byteLength<o)throw new Error(`Texture2D.readPixels() failed: destination buffer size is ${n.byteLength}, should be at least ${o}`);const h=this._device.createBuffer(o,{usage:"read"});await this.copyPixelDataToBuffer(t,e,i,s,r,a,h),await h.getBufferSubData(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),0,o),h.dispose()}readPixelsToBuffer(t,e,i,s,r,a,n){if(a<0||a>=this.mipLevelCount)throw new Error(`TextureCube.readPixelsToBuffer(): invalid miplevel: ${a}`);this.copyPixelDataToBuffer(t,e,i,s,r,a,n)}createWithMipmapData(t,e,i){t.isCubemap?(this._flags=Number(i)||0,this._flags&nr.TF_WRITABLE?console.error("webgl device does not support storage texture"):this.loadLevels(t,e)):console.error("loading cubmap with mipmap data failed: data is not cubemap")}loadEmpty(t,e,i){this.allocInternal(t,e,e,1,i),this._mipLevelCount>1&&!this._device.isContextLost()&&this.generateMipmaps()}loadLevels(t,e){const i=e?Dt(t.format):t.format,s=t.width,r=t.height,a=1!==t.mipLevels||this._flags&nr.TF_NO_MIPMAP?t.mipLevels:this._calcMipLevelCount(t.format,s,r,1);if(!t.isCompressed||this.getTextureCaps().supportS3TCSRGB&&this.getTextureCaps().supportS3TC){if(this.allocInternal(i,s,r,1,a),!this._device.isContextLost())for(let e=0;e<6;e++){if(t.mipDatas[e].length!==t.mipLevels)return void console.error("TextureCube.loadLevels() failed: Invalid texture data");for(let i=0;i<t.mipLevels;i++)this.uploadRaw(t.mipDatas[e][i].data,t.mipDatas[e][i].width,t.mipDatas[e][i].height,1,0,0,e,i)}t.mipLevels!==this.mipLevelCount&&this.generateMipmaps()}else console.error("TextureCube.loadLevels(): No s3tc compression format support")}}class Wh extends Oh{_source;_refBindGroups;constructor(t,e){super(t,"2d"),this._source=e,this._width=0,this._height=0,this._refBindGroups=[],this.loadFromElement()}isTextureVideo(){return!0}addBindGroupReference(t){this._refBindGroups.push(t)}removeBindGroupReference(t){const e=this._refBindGroups.indexOf(t);e>=0&&this._refBindGroups.splice(e,1)}get width(){return this._width}get height(){return this._height}get source(){return this._source}restore(){this._object||this._device.isContextLost()||this.loadElement(this._source)}updateVideoFrame(){if(this._source.readyState>2){return new window.VideoFrame(this._source).close(),this._object=this._device.gpuImportExternalTexture(this._source),!0}return!1}createView(t,e,i){return null}init(){this.loadFromElement()}readPixels(t,e,i,s,r,a,n){throw new Error("Video texture does not support readPixels()")}readPixelsToBuffer(t,e,i,s,r,a,n){throw new Error("Video texture does not support readPixelsToBuffer()")}loadFromElement(){this.loadElement(this._source)}loadElement(t){if(this._format="rgba8unorm",this._width=t.videoWidth,this._height=t.videoHeight,this._depth=1,this._mipLevelCount=1,!this._device.isContextLost()&&t.readyState>2){this._object=this._device.gpuImportExternalTexture(t);const e=this;this._device.runNextFrame(function t(){if(!e.disposed){if(e._source.readyState>2){new window.VideoFrame(e._source).close(),e._object=e._device.gpuImportExternalTexture(e._source);for(const t of e._refBindGroups)t.invalidate()}e._device.runNextFrame(t)}})}return!!this._object}}class Xh{maxDrawBuffers;maxColorAttachmentBytesPerSample;supportRenderMipmap;supportMultisampledFramebuffer;supportFloatBlending;supportDepth32float;supportDepth32floatStencil8;constructor(t){this.maxDrawBuffers=t.device.limits.maxColorAttachments,this.maxColorAttachmentBytesPerSample=t.device.limits.maxColorAttachmentBytesPerSample,this.supportRenderMipmap=!0,this.supportMultisampledFramebuffer=!0,this.supportFloatBlending=t.device.features.has("float32-blendable"),this.supportDepth32float=!0,this.supportDepth32floatStencil8=t.device.features.has("depth32float-stencil8")}}class jh{supportOversizedViewport;supportBlendMinMax;support32BitIndex;supportDepthClamp;maxBindGroups;maxTexCoordIndex;constructor(t){this.supportOversizedViewport=!1,this.supportBlendMinMax=!0,this.support32BitIndex=!0,this.supportDepthClamp=t.device.features.has("depth-clip-control"),this.maxBindGroups=4,this.maxTexCoordIndex=8}}class Qh{supportFragmentDepth;supportStandardDerivatives;supportShaderTextureLod;supportHighPrecisionFloat;supportHighPrecisionInt;maxUniformBufferSize;uniformBufferOffsetAlignment;maxStorageBufferSize;storageBufferOffsetAlignment;constructor(t){this.supportFragmentDepth=!0,this.supportStandardDerivatives=!0,this.supportShaderTextureLod=!0,this.supportHighPrecisionFloat=!0,this.maxUniformBufferSize=t.device.limits.maxUniformBufferBindingSize||65536,this.uniformBufferOffsetAlignment=t.device.limits.minUniformBufferOffsetAlignment||256,this.maxStorageBufferSize=t.device.limits.maxStorageBufferBindingSize||134217728,this.storageBufferOffsetAlignment=t.device.limits.minStorageBufferOffsetAlignment||256}}class qh{_textureFormatInfos;maxTextureSize;maxCubeTextureSize;npo2Mipmapping;npo2Repeating;supportS3TC;supportS3TCSRGB;supportBPTC;supportRGTC;supportASTC;supportDepthTexture;support3DTexture;supportSRGBTexture;supportFloatTexture;supportLinearFloatTexture;supportHalfFloatTexture;supportLinearHalfFloatTexture;supportAnisotropicFiltering;supportFloatColorBuffer;supportHalfFloatColorBuffer;supportFloatBlending;constructor(t){if(this.supportAnisotropicFiltering=!0,this.supportDepthTexture=!0,this.support3DTexture=!0,this.supportSRGBTexture=!0,this.supportFloatTexture=!0,this.supportFloatColorBuffer=!0,this.supportHalfFloatColorBuffer=!0,this.supportFloatBlending=!0,this.supportS3TC=t.device.features.has("texture-compression-bc"),this.supportS3TCSRGB=this.supportS3TC,this.supportBPTC=this.supportS3TC,this.supportRGTC=this.supportS3TC,this.supportASTC=t.device.features.has("texture-compression-astc"),this.supportHalfFloatTexture=!0,this.maxTextureSize=t.device.limits.maxTextureDimension2D,this.maxCubeTextureSize=t.device.limits.maxTextureDimension2D,this.npo2Mipmapping=!0,this.npo2Repeating=!0,this._textureFormatInfos={rgba8unorm:{gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:4},rgba8snorm:{gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:4},bgra8unorm:{gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:4}},this.supportASTC)for(const t of["4x4","5x4","5x5","6x5","6x6","8x5","8x6","8x8","10x5","10x6","10x8","10x10","12x10","12x12"]){const[e,i]=t.split("x").map(t=>Number(t));this._textureFormatInfos[`astc-${t}`]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:16,blockWidth:e,blockHeight:i},this._textureFormatInfos[`astc-${t}-srgb`]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,size:16,writable:!1,blockWidth:e,blockHeight:i}}this.supportS3TC&&(this._textureFormatInfos.dxt1={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:8,blockWidth:4,blockHeight:4},this._textureFormatInfos.dxt3={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos.dxt5={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:16,blockWidth:4,blockHeight:4}),this.supportRGTC&&(this._textureFormatInfos.bc4={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:8,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc4-signed"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:8,blockWidth:4,blockHeight:4}),this._textureFormatInfos.bc5={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc5-signed"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:16,blockWidth:4,blockHeight:4},this.supportBPTC&&(this._textureFormatInfos.bc6h={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc6h-signed"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos.bc7={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["bc7-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:16,blockWidth:4,blockHeight:4}),this.supportS3TCSRGB&&(this._textureFormatInfos["dxt1-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:8,blockWidth:4,blockHeight:4},this._textureFormatInfos["dxt3-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:16,blockWidth:4,blockHeight:4},this._textureFormatInfos["dxt5-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!0,writable:!1,size:16,blockWidth:4,blockHeight:4}),this._textureFormatInfos.r8unorm={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r8snorm={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r16f={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.r32f={gpuSampleType:"unfilterable-float",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.r8ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r8i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:1},this._textureFormatInfos.r16ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.r16i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.r32ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.r32i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg8unorm={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg8snorm={gpuSampleType:"float",filterable:!0,renderable:!1,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg16f={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg32f={gpuSampleType:"unfilterable-float",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rg8ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg8i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.rg16ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg16i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rg32ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rg32i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos["rgba8unorm-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos["bgra8unorm-srgb"]={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rgba16f={gpuSampleType:"float",filterable:!0,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rgba32f={gpuSampleType:"unfilterable-float",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:16},this._textureFormatInfos.rgba8ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rgba8i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.rgba16ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rgba16i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.rgba32ui={gpuSampleType:"uint",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:16},this._textureFormatInfos.rgba32i={gpuSampleType:"sint",filterable:!1,renderable:!0,compressed:!1,writable:!0,blockWidth:1,blockHeight:1,size:16},this._textureFormatInfos.rg11b10uf={gpuSampleType:"float",filterable:!0,renderable:t.device.features.has("rg11b10ufloat-renderable"),compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d16={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:2},this._textureFormatInfos.d24={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d32f={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:4},this._textureFormatInfos.d32fs8={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:8},this._textureFormatInfos.d24s8={gpuSampleType:"depth",filterable:!1,renderable:!0,compressed:!1,writable:!1,blockWidth:1,blockHeight:1,size:4},this.supportLinearFloatTexture=this._textureFormatInfos.r32f.filterable&&this._textureFormatInfos.rg32f.filterable&&this._textureFormatInfos.rgba32f.filterable,this.supportLinearHalfFloatTexture=this._textureFormatInfos.r16f.filterable&&this._textureFormatInfos.rg16f.filterable&&this._textureFormatInfos.rgba16f.filterable}calcMemoryUsage(t,e){return this._textureFormatInfos[t]?this._textureFormatInfos[t].size*e:0}getTextureFormatInfo(t){return this._textureFormatInfos[t]}}class Yh extends Xo{static _hashCounter=0;static _defaultBuffers=[];_vertexData;_hash;_layouts;constructor(t,e){super(t),this._vertexData=new br;for(const t of e.vertexBuffers)this._vertexData.setVertexBuffer(t.buffer,t.stepMode);e.indexBuffer&&this._vertexData.setIndexBuffer(e.indexBuffer),this._hash=String(++Yh._hashCounter),this._layouts={}}destroy(){this._object=null}restore(){this._object={}}setDrawOffset(t,e){for(const i of this._vertexData.vertexBuffers)i?.buffer===t&&(i.drawOffset=e)}get hash(){return this._hash}get vertexBuffers(){return this._vertexData.vertexBuffers}get indexBuffer(){return this._vertexData.indexBuffer}getDrawOffset(){return this._vertexData.getDrawOffset()}getVertexBuffer(t){return this._vertexData.getVertexBuffer(t)}getVertexBufferInfo(t){return this._vertexData.getVertexBufferInfo(t)}getIndexBuffer(){return this._vertexData.getIndexBuffer()}getLayouts(t){if(!t)return null;let e=this._layouts[t];return e||(e=this.calcHash(t),this._layouts[t]=e),e}getDefaultBuffer(t,e){let i=Yh._defaultBuffers[0];if(i){Math.floor(i.byteLength/4*4)<e&&(i=null)}return i||(i=this._device.createVertexBuffer(dr(hr(t),"f32",4),new Float32Array(4*e)),Yh._defaultBuffers.unshift(i)),i}calcHash(t){const e=[],i=[],s=this._vertexData.vertexBuffers,r=t.split(":").map(t=>Number(t));for(let t=0;t<r.length;t++){const a=r[t];let n=s[a],o=n?.buffer;o||(console.warn(`No vertex buffer set for location <${hr(a)}>`),o=this.getDefaultBuffer(a,this._vertexData.numVertices),n={buffer:o,offset:0,drawOffset:0,type:new _e(te.F32VEC4),stride:16,stepMode:"vertex"});const h=wh.getGPUVertexFormat(n.type);if(!h)throw new Error("Invalid vertex buffer format");const l=i.findIndex(t=>t.buffer===o),u=n.stride;let c=l>=0?e[l]:`${u}-${Number("instance"===n.stepMode)}`;c+=`-${Rh[h]}-${n.offset}-${t}`,l>=0?e[l]=c:(e.push(c),i.push(n))}return{layoutHash:e.join(":"),buffers:i}}bind(){this._device.setVertexLayout(this)}draw(t,e,i){this.bind(),this._device.draw(t,e,i)}drawInstanced(t,e,i,s){this.bind(),this._device.drawInstanced(t,e,i,s)}}class Zh{static _defaultState;_hash;static get defaultState(){return this._defaultState}constructor(){this._hash=null}get hash(){return this._getHash(this.constructor)}invalidateHash(){this._hash=null}_getHash(t){return this===t.defaultState?"":(null===this._hash&&(this._hash=this.computeHash()),this._hash)}}class Kh extends Zh{static _defaultState=new Kh;_redMask;_greenMask;_blueMask;_alphaMask;constructor(){super(),this._redMask=this._greenMask=this._blueMask=this._alphaMask=!0}clone(){return(new Kh).setColorMask(this._redMask,this._greenMask,this._blueMask,this._alphaMask)}get redMask(){return this._redMask}set redMask(t){this._redMask!==!!t&&(this._redMask=!!t,this.invalidateHash())}get greenMask(){return this._greenMask}set greenMask(t){this._greenMask!==!!t&&(this._greenMask=!!t,this.invalidateHash())}get blueMask(){return this._blueMask}set blueMask(t){this._blueMask!==!!t&&(this._blueMask=!!t,this.invalidateHash())}get alphaMask(){return this._alphaMask}set alphaMask(t){this._alphaMask!==!!t&&(this._alphaMask=!!t,this.invalidateHash())}setColorMask(t,e,i,s){return this.redMask=t,this.greenMask=e,this.blueMask=i,this.alphaMask=s,this}computeHash(){let t=0;return this.redMask&&(t+=1),this.greenMask&&(t+=2),this.blueMask&&(t+=4),this.alphaMask&&(t+=8),String(t)}}class Jh extends Zh{static _defaultState=new Jh;_enabled;_alphaToCoverageEnabled;_srcBlendRGB;_dstBlendRGB;_srcBlendAlpha;_dstBlendAlpha;_rgbEquation;_alphaEquation;constructor(){super(),this._enabled=!1,this._alphaToCoverageEnabled=!1,this._srcBlendRGB="one",this._dstBlendRGB="zero",this._srcBlendAlpha="one",this._dstBlendAlpha="zero",this._rgbEquation="add",this._alphaEquation="add"}clone(){const t=new Jh;return t.enable(this._enabled),t.enableAlphaToCoverage(this._alphaToCoverageEnabled),t.setBlendFuncRGB(this._srcBlendRGB,this._dstBlendRGB),t.setBlendFuncAlpha(this._srcBlendAlpha,this._dstBlendAlpha),t.setBlendEquation(this._rgbEquation,this._alphaEquation),t}get enabled(){return this._enabled}set enabled(t){this._enabled!==!!t&&(this._enabled=!!t,this.invalidateHash())}get alphaToCoverageEnabled(){return this._alphaToCoverageEnabled}set alphaToCoverageEnabled(t){this._alphaToCoverageEnabled!==!!t&&(this._alphaToCoverageEnabled=!!t,this.invalidateHash())}get srcBlendRGB(){return this._srcBlendRGB}set srcBlendRGB(t){this._srcBlendRGB!==t&&(this._srcBlendRGB=t,this.invalidateHash())}get srcBlendAlpha(){return this._srcBlendAlpha}set srcBlendAlpha(t){this._srcBlendAlpha!==t&&(this._srcBlendAlpha=t,this.invalidateHash())}get dstBlendRGB(){return this._dstBlendRGB}set dstBlendRGB(t){this._dstBlendRGB!==t&&(this._dstBlendRGB=t,this.invalidateHash())}get dstBlendAlpha(){return this._dstBlendAlpha}set dstBlendAlpha(t){this._dstBlendAlpha!==t&&(this._dstBlendAlpha=t,this.invalidateHash())}get rgbEquation(){return this._rgbEquation}set rgbEquation(t){this._rgbEquation!==t&&(this._rgbEquation=t,this.invalidateHash())}get alphaEquation(){return this._alphaEquation}set alphaEquation(t){this._alphaEquation!==t&&(this._alphaEquation=t,this.invalidateHash())}enable(t){return this.enabled=t,this}enableAlphaToCoverage(t){return this.alphaToCoverageEnabled=t,this}setBlendFunc(t,e){return this.srcBlendRGB=t,this.dstBlendRGB=e,this.srcBlendAlpha=t,this.dstBlendAlpha=e,this}setBlendFuncRGB(t,e){return this.srcBlendRGB=t,this.dstBlendRGB=e,this}setBlendFuncAlpha(t,e){return this.srcBlendAlpha=t,this.dstBlendAlpha=e,this}setBlendEquation(t,e){return this.rgbEquation=t,this.alphaEquation=e,this}computeHash(){return this._enabled?`${this._srcBlendRGB}-${this._srcBlendAlpha}-${this._dstBlendRGB}-${this._dstBlendAlpha}-${this._rgbEquation}-${this._alphaEquation}-${Number(!!this._alphaToCoverageEnabled)}`:`${Number(!!this._alphaToCoverageEnabled)}`}}class tl extends Zh{static _defaultState=new tl;_cullMode;_depthClampEnabled;constructor(){super(),this._cullMode="back",this._depthClampEnabled=!1}clone(){return(new tl).setCullMode(this._cullMode).enableDepthClamp(this._depthClampEnabled)}get cullMode(){return this._cullMode}set cullMode(t){this._cullMode!==t&&(this._cullMode=t,this.invalidateHash())}setCullMode(t){return this.cullMode=t,this}get depthClampEnabled(){return this._depthClampEnabled}set depthClampEnabled(t){this.enableDepthClamp(t)}enableDepthClamp(t){return this._depthClampEnabled!==!!t&&(this._depthClampEnabled=!!t,this.invalidateHash()),this}computeHash(){return`${this._cullMode}-${this._depthClampEnabled?1:0}`}}class el extends Zh{static _defaultState=new el;_testEnabled;_writeEnabled;_compareFunc;_depthBias;_depthBiasSlopeScale;constructor(){super(),this._testEnabled=!0,this._writeEnabled=!0,this._compareFunc="le",this._depthBias=0,this._depthBiasSlopeScale=0}clone(){const t=new el;return t.enableTest(this._testEnabled),t.enableWrite(this._writeEnabled),t.setCompareFunc(this._compareFunc),t.setDepthBias(this._depthBias),t.setDepthBiasSlopeScale(this._depthBiasSlopeScale),t}get testEnabled(){return this._testEnabled}set testEnabled(t){this._testEnabled!==!!t&&(this._testEnabled=t,this.invalidateHash())}get writeEnabled(){return this._writeEnabled}set writeEnabled(t){this._writeEnabled!==!!t&&(this._writeEnabled=t,this.invalidateHash())}get compareFunc(){return this._compareFunc}set compareFunc(t){this._compareFunc!==t&&(this._compareFunc=t,this.invalidateHash())}get depthBias(){return this._depthBias}set depthBias(t){this.setDepthBias(t)}setDepthBias(t){return this._depthBias!==t&&(this._depthBias=t,this.invalidateHash()),this}get depthBiasSlopeScale(){return this._depthBiasSlopeScale}set depthBiasSlopeScale(t){this.setDepthBiasSlopeScale(t)}setDepthBiasSlopeScale(t){return this._depthBiasSlopeScale!==t&&(this._depthBiasSlopeScale=t,this.invalidateHash()),this}enableTest(t){return this.testEnabled=t,this}enableWrite(t){return this.writeEnabled=t,this}setCompareFunc(t){return this.compareFunc=t,this}computeHash(){return`${Number(this._testEnabled)}-${Number(this._writeEnabled)}-${this._compareFunc}-${this._depthBias}-${this._depthBiasSlopeScale}`}}class il extends Zh{static _defaultState=new il;_enabled;_writeMask;_failOp;_failOpBack;_zFailOp;_zFailOpBack;_passOp;_passOpBack;_func;_funcBack;_ref;_readMask;constructor(){super(),this._enabled=!1,this._failOp=this.failOpBack="keep",this._zFailOp=this.zFailOpBack="keep",this._passOp=this.passOpBack="keep",this._func=this.funcBack="always",this._ref=0,this._writeMask=4294967295,this._readMask=4294967295}clone(){const t=new il;return t.enable(this._enabled),t.setWriteMask(this._writeMask),t.setFrontOp(this._failOp,this._zFailOp,this._passOp),t.setBackOp(this._failOpBack,this._zFailOpBack,this._passOpBack),t.setFrontCompareFunc(this._func),t.setBackCompareFunc(this._funcBack),t.setReference(this._ref),t.setReadMask(this._readMask),t}get enabled(){return this._enabled}set enabled(t){this._enabled!==!!t&&(this._enabled=!!t,this.invalidateHash())}get writeMask(){return this._writeMask}set writeMask(t){this._writeMask!==t&&(this._writeMask=t,this.invalidateHash())}get failOp(){return this._failOp}set failOp(t){this._failOp!==t&&(this._failOp=t,this.invalidateHash())}get failOpBack(){return this._failOpBack}set failOpBack(t){this._failOpBack!==t&&(this._failOpBack=t,this.invalidateHash())}get zFailOp(){return this._zFailOp}set zFailOp(t){this._zFailOp!==t&&(this._zFailOp=t,this.invalidateHash())}get zFailOpBack(){return this._zFailOpBack}set zFailOpBack(t){this._zFailOpBack!==t&&(this._zFailOpBack=t,this.invalidateHash())}get passOp(){return this._passOp}set passOp(t){this._passOp!==t&&(this._passOp=t,this.invalidateHash())}get passOpBack(){return this._passOpBack}set passOpBack(t){this._passOpBack!==t&&(this._passOpBack=t,this.invalidateHash())}get func(){return this._func}set func(t){this._func!==t&&(this._func=t,this.invalidateHash())}get funcBack(){return this._funcBack}set funcBack(t){this._funcBack!==t&&(this._funcBack=t,this.invalidateHash())}get ref(){return this._ref}set ref(t){this._ref!==t&&(this._ref=t,this.invalidateHash())}get readMask(){return this._readMask}set readMask(t){this._readMask!==t&&(this._readMask=t,this.invalidateHash())}enable(t){return this.enabled=t,this}setWriteMask(t){return this.writeMask=t,this}setFrontOp(t,e,i){return this.failOp=t,this.zFailOp=e,this.passOp=i,this}setBackOp(t,e,i){return this.failOpBack=t,this.zFailOpBack=e,this.passOpBack=i,this}setFrontCompareFunc(t){return this.func=t,this}setBackCompareFunc(t){return this.funcBack=t,this}setReference(t){return this.ref=t,this}setReadMask(t){return this.readMask=t,this}computeHash(){return this._enabled?`${this.sideHash(!1)}-${this.sideHash(!0)}-${this.readMask.toString(16)}-${this.writeMask.toString(16)}-${this.ref.toString(16)}`:""}sideHash(t){return t?`${this._failOpBack}-${this._zFailOpBack}-${this._passOpBack}-${this._funcBack}`:`${this._failOp}-${this._zFailOp}-${this._passOp}-${this._func}`}}class sl{_device;colorState;blendingState;rasterizerState;depthState;stencilState;constructor(t){this._device=t,this.colorState=null,this.blendingState=null,this.rasterizerState=null,this.depthState=null,this.stencilState=null}clone(){const t=new sl(this._device);return t.colorState=this.colorState?.clone()??null,t.blendingState=this.blendingState?.clone()??null,t.rasterizerState=this.rasterizerState?.clone()??null,t.depthState=this.depthState?.clone()??null,t.stencilState=this.stencilState?.clone()??null,t}copyFrom(t){this.colorState=t.colorState,this.blendingState=t.blendingState,this.rasterizerState=t.rasterizerState,this.depthState=t.depthState,this.stencilState=t.stencilState}get hash(){return`${this.colorState?.hash||""}:${this.blendingState?.hash||""}:${this.rasterizerState?.hash||""}:${this.depthState?.hash||""}:${this.stencilState?.hash||""}`}useColorState(t){return this.colorState=t??this.colorState??new Kh}defaultColorState(){this.colorState=null}useBlendingState(t){return this.blendingState=t??this.blendingState??new Jh}defaultBlendingState(){this.blendingState=null}useRasterizerState(t){return this.rasterizerState=t??this.rasterizerState??new tl}defaultRasterizerState(){this.rasterizerState=null}useDepthState(t){return this.depthState=t??this.depthState??new el}defaultDepthState(){this.depthState=null}useStencilState(t){return this.stencilState=t??this.stencilState??new il}defaultStencilState(){this.stencilState=null}apply(t){this._device.setRenderStates(this)}}const rl=_e.getCachedTypeInfo(te.U16),al=["stencil8","depth24plus-stencil8","depth24unorm-stencil8","depth32float-stencil8"],nl=["depth16unorm","depth24plus","depth24plus-stencil8","depth32float","depth24unorm-stencil8","depth32float-stencil8"];class ol{_device;_renderPipelines;_computePipelines;constructor(t){this._device=t,this._renderPipelines={},this._computePipelines={}}wipeCache(){this._renderPipelines={},this._computePipelines={}}fetchComputePipeline(t){const e=this.getComputePipelineHash(t);let i=this._computePipelines[e];if(void 0===i){const s=t.getShaderModule(),r={layout:s.pipelineLayout,compute:{module:s.csModule,entryPoint:"main"}};i=this._device.gpuCreateComputePipeline(r),this._computePipelines[e]=i}return i}fetchRenderPipeline(t,e,i,s,r){if(!r.hash)return null;t.vertexAttributes||(e=null);const a=this.getRenderPipelineHash(r.hash,t,e,i,s);let n=this._renderPipelines[a];if(void 0===n){const o=e?this._device.fetchVertexLayout(e.getLayouts(t.vertexAttributes).layoutHash):null,h=t.getShaderModule(),l={module:h.vsModule,entryPoint:"main"};o&&(l.buffers=o);const u=this.createPrimitiveState(e,i,s),c=this.createDepthStencilState(r.depthFormat,i),d=r.colorFormats.map(t=>this.createColorTargetState(i,t)),p={label:a,layout:h.pipelineLayout,vertex:l,primitive:u,depthStencil:c,multisample:this.createMultisampleState(r.sampleCount,i),fragment:{module:h.fsModule,entryPoint:"main",targets:d}};n=this._device.gpuCreateRenderPipeline(p),this._renderPipelines[a]=n}return n}createPrimitiveState(t,e,i){const s=Bh[i];if(!s)throw new Error(`createPrimitiveState() failed: invalid primitive type: ${i}`);const r=e?.rasterizerState||tl.defaultState,a=Ih[r.cullMode];if(!a)throw new Error(`createPrimitiveState() failed: invalid cull mode: ${r.cullMode}`);const n={topology:s,frontFace:this._device.isWindingOrderReversed()?"cw":"ccw",cullMode:a};return this._device.device.features.has("depth-clip-control")&&(n.unclippedDepth=r.depthClampEnabled),"triangle-strip"!==s&&"line-strip"!==s||(n.stripIndexFormat=t?.getIndexBuffer()?.indexType===rl?"uint16":"uint32"),n}createMultisampleState(t,e){return{count:t,alphaToCoverageEnabled:t>1&&(e?.blendingState??Jh.defaultState).alphaToCoverageEnabled}}createDepthStencilState(t,e){if(!t)return;const i=e?.depthState||el.defaultState,s=e?.stencilState||il.defaultState,r=al.indexOf(t)>=0,a=nl.indexOf(t)>=0,n={format:t,depthWriteEnabled:!!a&&i.writeEnabled,depthCompare:a&&i.testEnabled?Eh[i.compareFunc]:"always"};if(0===i.depthBias&&0===i.depthBiasSlopeScale||(n.depthBias=i.depthBias,n.depthBiasSlopeScale=i.depthBiasSlopeScale),r){const t=s.enabled?this.createStencilFaceState(s.func,s.failOp,s.zFailOp,s.passOp):void 0,e=s.enabled?this.createStencilFaceState(s.funcBack,s.failOpBack,s.zFailOpBack,s.passOpBack):void 0,i=s.enabled?s.readMask:void 0,r=s.enabled?s.writeMask:void 0;n.stencilFront=t,n.stencilBack=e,n.stencilReadMask=i,n.stencilWriteMask=r}return n}createStencilFaceState(t,e,i,s){return{compare:Eh[t],failOp:Mh[e],depthFailOp:Mh[i],passOp:Mh[s]}}createColorTargetState(t,e){const i=t?.blendingState||Jh.defaultState,s=t?.colorState||Kh.defaultState,r={format:e,writeMask:(s.redMask?GPUColorWrite.RED:0)|(s.greenMask?GPUColorWrite.GREEN:0)|(s.blueMask?GPUColorWrite.BLUE:0)|(s.alphaMask?GPUColorWrite.ALPHA:0)};return i.enabled&&(r.blend=this.createBlendState(i)),r}createBlendState(t){return{color:this.createBlendComponent(t.rgbEquation,t.srcBlendRGB,t.dstBlendRGB),alpha:this.createBlendComponent(t.alphaEquation,t.srcBlendAlpha,t.dstBlendAlpha)}}createBlendComponent(t,e,i){const s=Ph[t];if(!s)throw new Error(`createBlendComponent() failed: invalid blend op: ${t}`);const r=$h[e];if(!r)throw new Error(`createBlendComponent() failed: invalid source blend func ${e}`);const a=$h[i];if(!a)throw new Error(`createBlendComponent() failed: invalid dest blend func ${i}`);return{operation:s,srcFactor:r,dstFactor:a}}getRenderPipelineHash(t,e,i,s,r){return`${e.hash}:${i?.getLayouts(e.vertexAttributes).layoutHash||""}:${t}:${r}:${s?.hash||""}:${Number(this._device.isWindingOrderReversed())}`}getComputePipelineHash(t){return t.hash}}class hl extends Xo{_options;_width;_height;_bindFlag;_hash;_msaaColorTextures;_msaaDepthTexture;constructor(t,e,i,s){if(super(t),e.length>0&&e.findIndex(t=>!t)>=0)throw new Error("WebGPUFramebuffer(): invalid color attachments");if(this._object=null,this._options={colorAttachments:e?.length>0?e.map(t=>({texture:t,face:0,layer:0,level:0,generateMipmaps:!0})):null,depthAttachment:i?{texture:i,face:0,layer:0,level:0,generateMipmaps:!1}:null,sampleCount:s?.sampleCount??1,ignoreDepthStencil:s?.ignoreDepthStencil??!1},!this._options.colorAttachments&&!this._options.depthAttachment)throw new Error("WebGPUFramebuffer(): colorAttachments or depthAttachment must be specified");if(this._width=this._options.colorAttachments?this._options.colorAttachments[0].texture.width:this._options.depthAttachment.texture.width,this._height=this._options.colorAttachments?this._options.colorAttachments[0].texture.height:this._options.depthAttachment.texture.height,this._options.colorAttachments&&this._options.colorAttachments.findIndex(t=>t.texture.width!==this._width||t.texture.height!==this._height)>=0||this._options.depthAttachment&&(this._options.depthAttachment.texture.width!==this._width||this._options.depthAttachment.texture.height!==this._height))throw new Error("WebGPUFramebuffer(): attachment textures must have same width and height");this._bindFlag=0,this._msaaColorTextures=null,this._msaaDepthTexture=null;const r=this._options.colorAttachments?.map(t=>t.texture.format).join(":")??"",a=this._options.depthAttachment?.texture.format??"";this._hash=`${r}-${a}-${this._options.sampleCount??1}`,this._init()}getOptions(){return this._options}get bindFlag(){return this._bindFlag}getHash(){return this._hash}getWidth(){const t=this._options.colorAttachments?.[0]??this._options.depthAttachment;return t?Math.max(t.texture.width>>t.level,1):0}getHeight(){const t=this._options.colorAttachments?.[0]??this._options.depthAttachment;return t?Math.max(t.texture.height>>t.level,1):0}restore(){if(this._options?.depthAttachment?.texture?.disposed&&this._options.depthAttachment.texture.reload(),this._options?.colorAttachments)for(const t of this._options.colorAttachments)t?.texture?.disposed&&t.texture.reload();this._device.isContextLost()||this._init()}destroy(){if(this._object=null,this._msaaColorTextures){for(const t of this._msaaColorTextures)t.destroy();this._msaaColorTextures=null}this._msaaDepthTexture&&(this._msaaDepthTexture.destroy(),this._msaaDepthTexture=null)}setColorAttachmentGenerateMipmaps(t,e){const i=this._options.colorAttachments?.[t];i&&(i.generateMipmaps=!!e)}getColorAttachmentGenerateMipmaps(t){return this._options.colorAttachments?.[t]?.generateMipmaps}setColorAttachmentCubeFace(t,e){const i=this._options.colorAttachments?.[t];i&&i.face!==e&&(i.face=e,this._bindFlag++)}getColorAttachmentCubeFace(t){return this._options.colorAttachments?.[t].face}setColorAttachmentMipLevel(t,e){const i=this._options.colorAttachments?.[t];i&&i.level!==e&&(i.level=e,this._bindFlag++)}getColorAttachmentMipLevel(t){return this._options.colorAttachments?.[t].level}setColorAttachmentLayer(t,e){const i=this._options.colorAttachments?.[t];i&&i.layer!==e&&(i.layer=e,this._bindFlag++)}getColorAttachmentLayer(t){return this._options.colorAttachments?.[t].layer}setDepthAttachmentCubeFace(t){const e=this._options.depthAttachment;e&&e.face!==t&&(e.face=t,this._bindFlag++)}getDepthAttachmentCubeFace(){return this._options.depthAttachment?.face}setDepthAttachmentLayer(t){const e=this._options.depthAttachment;e&&e.layer!==t&&(e.layer=t,this._bindFlag++)}getDepthAttachmentLayer(){return this._options.depthAttachment?.layer}getDepthAttachment(){return this._options?.depthAttachment?.texture||null}getColorAttachments(){return this._options?.colorAttachments?.map(t=>t?.texture||null)||[]}getColorAttachment(t){return this.getColorAttachments()[t]??null}getMSAADepthAttachment(){return this._msaaDepthTexture}getMSAAColorAttacments(){return this._msaaColorTextures}getColorFormats(){return this._options?.colorAttachments?.map(t=>t?.texture?.gpuFormat||null)}getDepthFormat(){return this._options.depthAttachment?.texture?.gpuFormat||null}bind(){throw new Error("no bind operatation for WebGPU")}unbind(){throw new Error("no unbind operatation for WebGPU")}_init(){if(this._options.sampleCount>1){this._msaaColorTextures=[];for(const t of this._options.colorAttachments){const e=this.device.gpuCreateTexture({size:{width:this._width,height:this._height,depthOrArrayLayers:1},format:t.texture.gpuFormat,mipLevelCount:1,sampleCount:this._options.sampleCount,dimension:"2d",usage:GPUTextureUsage.COPY_SRC|GPUTextureUsage.RENDER_ATTACHMENT});this._msaaColorTextures.push(e)}if(this._options.depthAttachment){const t=this.device.gpuCreateTexture({size:{width:this._width,height:this._height,depthOrArrayLayers:1},format:this._options.depthAttachment.texture.gpuFormat,mipLevelCount:1,sampleCount:this._options.sampleCount,dimension:"2d",usage:GPUTextureUsage.COPY_SRC|GPUTextureUsage.RENDER_ATTACHMENT});this._msaaDepthTexture=t}}this._object={}}isFramebuffer(){return!0}getSampleCount(){return this._options.sampleCount}}const ll=_e.getCachedTypeInfo(te.U16),ul=_e.getCachedTypeInfo(te.U32);class cl extends qo{indexType;length;constructor(t,e,i){if(!(e instanceof Uint16Array||e instanceof Uint32Array))throw new Error("invalid index data");super(t,nr.BF_INDEX|i,e),this.indexType=e instanceof Uint16Array?ll:ul,this.length=e.length}}class dl{_device;_bindGroupLayoutCache;constructor(t){this._device=t,this._bindGroupLayoutCache={}}fetchBindGroupLayout(t){const e=t?this.getLayoutHash(t):"";let i=this._bindGroupLayoutCache[e];if(!i){if(i=this.createBindGroupLayout(t),!i)throw new Error(`fetchBindGroupLayout() failed: hash: ${e}`);this._bindGroupLayoutCache[e]=i}return i}getLayoutHash(t){let e="";for(const i of t.entries){let t=`${i.binding}:${i.visibility}:`;i.buffer?t+=`b:${i.buffer.type}:${i.buffer.hasDynamicOffset}:${i.buffer.minBindingSize}`:i.sampler?t+=`s${i.sampler.type}:`:i.texture?t+=`t${i.texture.sampleType}-${i.texture.viewDimension}-${Number(!!i.texture.multisampled)}:`:i.storageTexture?t+=`k${i.storageTexture.access}-${i.storageTexture.format}-${i.storageTexture.viewDimension}:`:i.externalTexture&&(t+="v:"),e=`${e} ${t}`}return e}createBindGroupLayout(t){const e={entries:t?.entries.map(t=>{const e=t.binding,i=(t.visibility&Xt.Vertex?GPUShaderStage.VERTEX:0)|(t.visibility&Xt.Fragment?GPUShaderStage.FRAGMENT:0)|(t.visibility&Xt.Compute?GPUShaderStage.COMPUTE:0),s=t.buffer?{type:t.buffer.type,hasDynamicOffset:t.buffer.hasDynamicOffset,minBindingSize:Number(t.buffer.minBindingSize)||0}:void 0,r=t.sampler?{type:t.sampler.type}:void 0,a=t.texture?{sampleType:t.texture.sampleType,viewDimension:t.texture.viewDimension}:void 0,n=t.storageTexture?{access:t.storageTexture.access,viewDimension:t.storageTexture.viewDimension,format:Fh[t.storageTexture.format]}:void 0,o=t.externalTexture?{}:void 0,h={binding:e,visibility:i};return s?h.buffer=s:r?h.sampler=r:a?h.texture=a:n?h.storageTexture=n:o&&(h.externalTexture=o),h})||[]};return t?.label&&(e.label=t.label),[e,this._device.device.createBindGroupLayout(e)]}}class pl{_layouts;constructor(){this._layouts={}}fetchVertexLayout(t){let e=this._layouts[t];return e||(e=[],t.split(":").forEach(t=>{const i=t.split("-"),s={arrayStride:Number(i[0]),stepMode:Number(i[1])?"instance":"vertex",attributes:[]};for(let t=2;t<i.length;t+=3)s.attributes.push({format:Lh[i[t]],offset:Number(i[t+1]),shaderLocation:Number(i[t+2])});e.push(s)}),this._layouts[t]=e),e}}class ml extends Xo{_options;constructor(t,e){super(t),this._options=Object.assign({addressU:"clamp",addressV:"clamp",addressW:"clamp",magFilter:"nearest",minFilter:"nearest",mipFilter:"none",lodMin:0,lodMax:32,compare:null,maxAnisotropy:1},e||{}),this._load()}get hash(){return this._object?this._device.gpuGetObjectHash(this._object):0}get addressModeU(){return this._options.addressU}get addressModeV(){return this._options.addressV}get addressModeW(){return this._options.addressW}get magFilter(){return this._options.magFilter}get minFilter(){return this._options.minFilter}get mipFilter(){return this._options.mipFilter}get lodMin(){return this._options.lodMin}get lodMax(){return this._options.lodMax}get compare(){return this._options.compare}get maxAnisotropy(){return this._options.maxAnisotropy}destroy(){this._object=null}restore(){this._device.isContextLost()||this._load()}_load(){return this._object=this._device.gpuCreateSampler({addressModeU:Ah[this._options.addressU],addressModeV:Ah[this._options.addressV],addressModeW:Ah[this._options.addressW],magFilter:Ch[this._options.magFilter],minFilter:Ch[this._options.minFilter],mipmapFilter:Ch[this._options.mipFilter],lodMinClamp:this._options.lodMin,lodMaxClamp:this._options.lodMax,compare:Eh[this._options.compare]||void 0,maxAnisotropy:this._options.maxAnisotropy}),!!this._object}isSampler(){return!0}}class fl{_device;_samplers;constructor(t){this._device=t,this._samplers={}}fetchSampler(t){const e=this.hash(t);let i=this._samplers[e];return i||(i=this.createSampler(t),this._samplers[e]=i),i}hash(t){return`${t.addressU?String(t.addressU):""}:${t.addressV?String(t.addressV):""}:${t.addressW?String(t.addressW):""}:${t.magFilter?String(t.magFilter):""}:${t.minFilter?String(t.minFilter):""}:${t.mipFilter?String(t.mipFilter):""}:${t.lodMin?String(t.lodMin):""}:${t.lodMax?String(t.lodMax):""}:${t.compare?String(t.compare):""}:${t.maxAnisotropy?String(t.maxAnisotropy):""}`}createSampler(t){return new ml(this._device,t)}}const _l=_e.getCachedTypeInfo(te.U16);class gl{_device;_renderCommandEncoder;_renderPassEncoder;_fbBindFlag;_currentViewport;_currentScissor;_frameBufferInfo;constructor(t){this._device=t,this._renderCommandEncoder=this._device.device.createCommandEncoder(),this._renderPassEncoder=null,this._fbBindFlag=null,this._currentViewport=null,this._currentScissor=null,this._frameBufferInfo=this.createFrameBufferInfo(null)}get active(){return!!this._renderPassEncoder}createFrameBufferInfo(t){const e=t?{frameBuffer:t,colorFormats:t.getColorAttachments().map(t=>t.gpuFormat),depthFormat:t.getDepthAttachment()?.gpuFormat,sampleCount:t.getOptions().sampleCount,hash:null,clearHash:t.getColorAttachments().map(t=>{const e=Nh[t.gpuFormat];return Vt(e)?Ot(e)?"i":"u":"f"}).join("")}:{frameBuffer:null,colorFormats:[this._device.backbufferFormat],depthFormat:this._device.backbufferDepthFormat,sampleCount:this._device.sampleCount,hash:null,clearHash:"f"};return e.hash=`${e.colorFormats.join("-")}:${e.depthFormat}:${e.sampleCount}`,e}setFramebuffer(t){this._frameBufferInfo.frameBuffer!==t&&(this.end(),this._frameBufferInfo=this.createFrameBufferInfo(t),this.setViewport(null),this.setScissor(null))}getFramebuffer(){return this._frameBufferInfo.frameBuffer}setViewport(t){!t||!Array.isArray(t)&&t.default?this._currentViewport={x:0,y:0,width:this._device.deviceToScreen(this._device.drawingBufferWidth),height:this._device.deviceToScreen(this._device.drawingBufferHeight),default:!0}:Array.isArray(t)?this._currentViewport={x:t[0],y:t[1],width:t[2],height:t[3],default:!1}:this._currentViewport=Object.assign({default:!1},t);const e=this._device.screenToDevice(this._currentViewport.x),i=this._device.screenToDevice(this._currentViewport.y),s=this._device.screenToDevice(this._currentViewport.width),r=this._device.screenToDevice(this._currentViewport.height);this._renderPassEncoder&&this._renderPassEncoder.setViewport(e,this._device.drawingBufferHeight-i-r,s,r,0,1)}getViewport(){return Object.assign({},this._currentViewport)}setScissor(t){const e=this._device.deviceToScreen(this._device.drawingBufferWidth),i=this._device.deviceToScreen(this._device.drawingBufferHeight);null==t||!Array.isArray(t)&&t.default?this._currentScissor={x:0,y:0,width:e,height:i,default:!0}:Array.isArray(t)?this._currentScissor={x:t[0],y:t[1],width:t[2],height:t[3],default:!1}:this._currentScissor=Object.assign({default:!1},t);let s=this._device.screenToDevice(this._currentScissor.x),r=this._device.screenToDevice(this._currentScissor.y),a=this._device.screenToDevice(this._currentScissor.width),n=this._device.screenToDevice(this._currentScissor.height);s<0&&(a+=s,s=0),r<0&&(n+=r,r=0),a=Math.min(this._device.screenToDevice(e)-s,a),n=Math.min(this._device.screenToDevice(i)-r,n),(a<0||n<0)&&(s=0,r=0,a=0,n=0),this._renderPassEncoder&&this._renderPassEncoder.setScissorRect(s,this._device.drawingBufferHeight-r-n,a,n)}getScissor(){return Object.assign({},this._currentScissor)}executeRenderBundle(t){this.active||this.begin(),this._renderPassEncoder.executeBundles([t])}draw(t,e,i,s,r,a,n,o,h){const l=this.validateDraw(t,s);2&l||(1&l&&this.end(),this.active||this.begin(),this.drawInternal(this._renderPassEncoder,t,e,i,s,r,a,n,o,h))}clear(t,e,i){this._currentScissor?(this._renderPassEncoder||this.begin(),this._renderPassEncoder.insertDebugMarker("clear"),zh.drawClearQuad(this,t,e,i),this._renderPassEncoder.insertDebugMarker("end clear")):(this.end(),this.begin(t,e,i))}getDevice(){return this._device}getFrameBufferInfo(){return this._frameBufferInfo}begin(t,e,i){if(this.active)return void console.error("WebGPURenderPass.begin() failed: begin() has already been called");this._renderCommandEncoder=this._device.device.createCommandEncoder();const s=this._frameBufferInfo.frameBuffer;if(s){const r=s.getDepthAttachment();let a;if(r){r._markAsCurrentFB(!0);const t=s.getOptions().depthAttachment,e=r.isTexture2DArray()||r.isTexture3D()?t.layer:r.isTextureCube()?t.face:0;a=r.getView(0,e??0,1)}this._fbBindFlag=s.bindFlag;const n={label:`customRenderPass:${this._frameBufferInfo.hash}`,colorAttachments:s.getOptions().colorAttachments?.map((e,i)=>{const r=e.texture;if(r){r._markAsCurrentFB(!0);const a=r.isTexture2DArray()||r.isTexture3D()?e.layer:r.isTextureCube()?e.face:0;if(1===s.getOptions().sampleCount)return{view:r.getView(e.level??0,a??0,1),loadOp:t?"clear":"load",clearValue:t,storeOp:"store"};{const n=s.getMSAAColorAttacments()[i];return{view:this._device.gpuCreateTextureView(n,{dimension:"2d",baseMipLevel:e.level??0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}),resolveTarget:r.getView(e.level??0,a??0,1),loadOp:t?"clear":"load",clearValue:t,storeOp:"store"}}}return null})??[],depthStencilAttachment:r?1===s.getOptions().sampleCount?{view:a,depthLoadOp:"number"==typeof e?"clear":"load",depthClearValue:e,depthStoreOp:"store",stencilLoadOp:Lt(r.format)?"number"==typeof i?"clear":"load":void 0,stencilClearValue:i,stencilStoreOp:Lt(r.format)?"store":void 0}:{view:s.getMSAADepthAttachment().createView(),depthLoadOp:"number"==typeof e?"clear":"load",depthClearValue:e,depthStoreOp:"store",stencilLoadOp:Lt(r.format)?"number"==typeof i?"clear":"load":void 0,stencilClearValue:i,stencilStoreOp:Lt(r.format)?"store":void 0}:void 0};this._renderPassEncoder=this._renderCommandEncoder.beginRenderPass(n)}else{const s=this._device.defaultRenderPassDesc,r=this._device.defaultRenderPassDesc.colorAttachments[0];this._frameBufferInfo.sampleCount>1?r.resolveTarget=this._device.context.getCurrentTexture().createView():r.view=this._device.context.getCurrentTexture().createView(),r.loadOp=t?"clear":"load",r.clearValue=t;const a=this._device.defaultRenderPassDesc.depthStencilAttachment;a.depthLoadOp="number"==typeof e?"clear":"load",a.depthClearValue=e,a.stencilLoadOp="number"==typeof i?"clear":"load",a.stencilClearValue=i,this._renderPassEncoder=this._renderCommandEncoder.beginRenderPass(s)}this.setViewport(this._currentViewport),this.setScissor(this._currentScissor)}end(){if(this.active&&(this._renderPassEncoder&&(this._renderPassEncoder.end(),this._renderPassEncoder=null),this._renderCommandEncoder&&(this._device.device.queue.submit([this._renderCommandEncoder.finish()]),this._renderCommandEncoder=null),this._frameBufferInfo.frameBuffer)){const t=this._frameBufferInfo.frameBuffer.getOptions();if(t.colorAttachments)for(const e of t.colorAttachments)e.texture._markAsCurrentFB(!1),e.generateMipmaps&&e.texture.mipLevelCount>1&&e.texture.generateMipmaps();t.depthAttachment?.texture?._markAsCurrentFB(!1)}}capture(t,e,i,s,r,a,n,o,h,l){this.drawInternal(this._renderPassEncoder,e,i,s,r,a,n,o,h,l,t)}drawInternal(t,e,i,s,r,a,n,o,h,l,u){if(this.setBindGroupsForRender(t,e,r,a,u)){const r=this._device.pipelineCache.fetchRenderPipeline(e,i,s,n,this._frameBufferInfo);if(r){t.setPipeline(r),u?.setPipeline(r);const a=s?.stencilState;if(a&&t.setStencilReference(a.ref),i){const s=i.getLayouts(e.vertexAttributes)?.buffers;s?.forEach((e,i)=>{t.setVertexBuffer(i,e.buffer.object,e.drawOffset),u?.setVertexBuffer(i,e.buffer.object,e.drawOffset)});const r=i.getIndexBuffer();r?(t.setIndexBuffer(r.object,r.indexType===_l?"uint16":"uint32"),u?.setIndexBuffer(r.object,r.indexType===_l?"uint16":"uint32"),t.drawIndexed(h,l,o),u?.drawIndexed(h,l,o)):(t.draw(h,l,o),u?.draw(h,l,o))}else t.draw(h,l,o),u?.draw(h,l,o)}}}validateDraw(t,e){let i=0;if(e)for(let s=0;s<t.bindGroupLayouts.length;s++){const r=e[s];if(!r)return console.error(`Missing bind group (${s}) when drawing with program '${t.name}'`),2;if(r.bindGroup){for(const t of r.bufferList)t.disposed&&(i|=2);for(const t of r.textureList)t.disposed&&(i|=2),t._isMarkedAsCurrentFB()&&(console.error("bind resource texture can not be current render target"),i|=2)}}return this._frameBufferInfo.frameBuffer&&this._frameBufferInfo.frameBuffer.bindFlag!==this._fbBindFlag&&(i|=1),i}setBindGroupsForRender(t,e,i,s,r){if(i)for(let a=0;a<4;a++)if(a<e.bindGroupLayouts.length){const e=i[a].bindGroup;if(!e)return!1;const n=i[a].getDynamicOffsets()??s?.[a];n?(t.setBindGroup(a,e,n),r?.setBindGroup(a,e,n)):(t.setBindGroup(a,e),r?.setBindGroup(a,e))}else t.setBindGroup(a,this._device.emptyBindGroup),r?.setBindGroup(a,this._device.emptyBindGroup);return!0}}class xl{_device;_computeCommandEncoder;_computePassEncoder;constructor(t){this._device=t,this._computeCommandEncoder=this._device.device.createCommandEncoder(),this._computePassEncoder=null}get active(){return!!this._computePassEncoder}compute(t,e,i,s,r,a){if(1&this.validateCompute(t,e))return;this.active||this.begin(),this.setBindGroupsForCompute(this._computePassEncoder,t,e,i);const n=this._device.pipelineCache.fetchComputePipeline(t);n&&(this._computePassEncoder.setPipeline(n),this._computePassEncoder.dispatchWorkgroups(s,r,a))}setBindGroupsForCompute(t,e,i,s){if(i)for(let r=0;r<4;r++)if(r<e.bindGroupLayouts.length){const e=i[r].bindGroup;if(!e)return!1;const a=s?.[r];a?t.setBindGroup(r,e,a):t.setBindGroup(r,e)}else t.setBindGroup(r,this._device.emptyBindGroup);return!0}begin(){this.active?console.error("WebGPUComputePass.begin() failed: WebGPUComputePass.begin() has already been called"):(this._computeCommandEncoder=this._device.device.createCommandEncoder(),this._computePassEncoder=this._computeCommandEncoder.beginComputePass())}end(){this.active&&(this._computePassEncoder.end(),this._computePassEncoder=null,this._device.device.queue.submit([this._computeCommandEncoder.finish()]),this._computeCommandEncoder=null)}validateCompute(t,e){let i=0;if(e)for(let s=0;s<t.bindGroupLayouts.length;s++){const r=e[s];if(!r)return console.error(`Missing bind group (${s}) when compute with program '${t.name}'`),1;if(r.bindGroup){for(const t of r.bufferList)t.disposed&&(i|=1);for(const t of r.textureList)t.disposed&&(i|=1)}}return i}}class bl{_renderPass;_computePass;_bufferUploads;_textureUploads;_device;_drawcallCounter;constructor(t){this._device=t,this._bufferUploads=new Map,this._textureUploads=new Map,this._renderPass=new gl(t),this._computePass=new xl(t),this._drawcallCounter=0}isBufferUploading(t){return!!this._bufferUploads.has(t)}isTextureUploading(t){return!!this._textureUploads.has(t)}flushUploads(){if(this._bufferUploads.size>0||this._textureUploads.size>0){this._drawcallCounter=0;const t=this._bufferUploads;this._bufferUploads=new Map;const e=this._textureUploads;this._textureUploads=new Map;const i=this._device.device.createCommandEncoder();t.forEach((t,e)=>e.beginSyncChanges(i)),e.forEach((t,e)=>{e.beginSyncChanges(i),!e.disposed&&e.isMipmapDirty()&&Vh.generateMipmap(this._device,e,i)}),this._device.device.queue.submit([i.finish()]),t.forEach((t,e)=>e.endSyncChanges()),e.forEach((t,e)=>e.endSyncChanges())}}get currentPass(){return this._renderPass.active?this._renderPass:this._computePass.active?this._computePass:null}beginFrame(){}endFrame(){this.flush()}flush(){this.flushUploads(),this._renderPass.active&&this._renderPass.end(),this._computePass.active&&this._computePass.end()}setFramebuffer(t){this._renderPass.active&&this.flushUploads(),this._renderPass.setFramebuffer(t)}getFramebuffer(){return this._renderPass.getFramebuffer()}getFramebufferInfo(){return this._renderPass.getFrameBufferInfo()}executeRenderBundle(t){this._computePass.active&&(this.flushUploads(),this._computePass.end()),this._renderPass.executeRenderBundle(t)}bufferUpload(t){this._bufferUploads.has(t)?this._drawcallCounter>this._bufferUploads.get(t)&&this.flush():this._bufferUploads.set(t,this._drawcallCounter)}textureUpload(t){this._textureUploads.has(t)?this._drawcallCounter>this._textureUploads.get(t)&&this.flush():this._textureUploads.set(t,this._drawcallCounter)}copyBuffer(t,e,i,s,r){this.flush();const a=this._device.device.createCommandEncoder();a.copyBufferToBuffer(t.object,i,e.object,s,r),this._device.device.queue.submit([a.finish()])}compute(t,e,i,s,r,a){this._drawcallCounter++,this._renderPass.active&&(this.flushUploads(),this._renderPass.end()),this._computePass.compute(t,e,i,s,r,a)}draw(t,e,i,s,r,a,n,o,h){this._computePass.active&&(this.flushUploads(),this._computePass.end()),this._drawcallCounter++,this._renderPass.draw(t,e,i,s,r,a,n,o,h)}capture(t,e,i,s,r,a,n,o,h,l){this._drawcallCounter++,this._computePass.active&&(this.flushUploads(),this._computePass.end()),this._renderPass.capture(t,e,i,s,r,a,n,o,h,l)}setViewport(t){this._renderPass.setViewport(t)}getViewport(){return this._renderPass.getViewport()}setScissor(t){this._renderPass.setScissor(t)}getScissor(){return this._renderPass.getScissor()}clear(t,e,i){this._renderPass.clear(t,e,i)}finish(){return this._device.device.queue.onSubmittedWorkDone()}}class vl extends Dn{_context;_dpr;_device;_adapter;_deviceCaps;_reverseWindingOrder;_canRender;_backBufferFormat;_depthFormat;_defaultMSAAColorTexture;_defaultMSAAColorTextureView;_defaultDepthTexture;_defaultDepthTextureView;_pipelineCache;_bindGroupCache;_vertexLayoutCache;_samplerCache;_currentProgram;_currentVertexData;_currentStateSet;_currentBindGroups;_currentBindGroupOffsets;_commandQueue;_gpuObjectHashCounter;_gpuObjectHasher;_defaultRenderPassDesc;_sampleCount;_emptyBindGroup;_captureRenderBundle;_adapterInfo;constructor(t,e,i){super(e,t),this._dpr=Math.max(1,Math.floor(i?.dpr??window.devicePixelRatio)),this._device=null,this._adapter=null,this._context=null,this._reverseWindingOrder=!1,this._defaultMSAAColorTexture=null,this._defaultMSAAColorTextureView=null,this._defaultDepthTexture=null,this._defaultDepthTextureView=null,this._pipelineCache=null,this._bindGroupCache=null,this._vertexLayoutCache=null,this._currentProgram=null,this._currentVertexData=null,this._currentStateSet=null,this._currentBindGroups=[],this._currentBindGroupOffsets=[],this._defaultRenderPassDesc=null,this._sampleCount=i?.msaa?4:1,this._deviceCaps=null,this._gpuObjectHasher=new WeakMap,this._gpuObjectHashCounter=1,this._emptyBindGroup=null,this._captureRenderBundle=null,this._samplerCache=new fl(this),this._adapterInfo={}}get context(){return this._context}getFrameBufferSampleCount(){return this.getFramebuffer()?.getSampleCount()??this._sampleCount}get device(){return this._device}get adapter(){return this._adapter}get commandQueue(){return this._commandQueue}get drawingBufferWidth(){return this.getDrawingBufferWidth()}get drawingBufferHeight(){return this.getDrawingBufferHeight()}get clientWidth(){return this.canvas.clientWidth}get clientHeight(){return this.canvas.clientHeight}get pipelineCache(){return this._pipelineCache}get backbufferFormat(){return this._backBufferFormat}get backbufferDepthFormat(){return this._depthFormat}get defaultDepthTexture(){return this._defaultDepthTexture}get defaultDepthTextureView(){return this._defaultDepthTextureView}get defaultMSAAColorTextureView(){return this._defaultMSAAColorTextureView}get defaultRenderPassDesc(){return this._defaultRenderPassDesc}get sampleCount(){return this._sampleCount}get currentPass(){return this._commandQueue.currentPass}get emptyBindGroup(){return this._emptyBindGroup}getScale(){return this._dpr}getAdapterInfo(){return this._adapterInfo}isContextLost(){return!1}getDeviceCaps(){return this._deviceCaps}getDrawingBufferWidth(){return this.getFramebuffer()?.getWidth()||this.canvas.width}getDrawingBufferHeight(){return this.getFramebuffer()?.getHeight()||this.canvas.height}getBackBufferWidth(){return this.canvas.width}getBackBufferHeight(){return this.canvas.height}async initContext(){if(!navigator.gpu)throw new Error("No browser support for WebGPU");if(this._adapter=await navigator.gpu.requestAdapter(),!this._adapter)throw new Error("WebGPU: requestAdapter() failed");this._adapterInfo=this._adapter.requestAdapterInfo?await this._adapter.requestAdapterInfo():{},this._device=await this._adapter.requestDevice({requiredFeatures:[...this._adapter.features],requiredLimits:{...this._adapter.limits}}),console.info("WebGPU device features:");for(const t of this._device.features)console.info(` - ${t}`);if(this.device.lost.then(t=>{console.error(`WebGPU device was lost: ${t.message}`),this._canRender=!1}),this._emptyBindGroup=this.device.createBindGroup({layout:this.device.createBindGroupLayout({entries:[]}),entries:[]}),this._context=this.canvas.getContext("webgpu")||null,!this._context)throw this._canRender=!1,new Error("WebGPU: getContext() failed");this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this._deviceCaps={textureCaps:new qh(this),framebufferCaps:new Xh(this),miscCaps:new jh(this),shaderCaps:new Qh(this)},this.configure(),this._pipelineCache=new ol(this),this._bindGroupCache=new dl(this),this._vertexLayoutCache=new pl,this._commandQueue=new bl(this),this._canRender=!0,this.setViewport(null),this.setScissor(null),this.on("resize",()=>{const t=Math.max(1,Math.round(this.canvas.clientWidth*this._dpr)),e=Math.max(1,Math.round(this.canvas.clientHeight*this._dpr));t===this.canvas.width&&e===this.canvas.height||(this.canvas.width=t,this.canvas.height=e,this.createDefaultRenderAttachments(),this.setViewport(null),this.setScissor(null))}),this.dispatchEvent("resize",this.canvas.clientWidth,this.canvas.clientHeight)}nextFrame(t){return this._commandQueue.finish().then(t),0}cancelNextFrame(t){}clearFrameBuffer(t,e,i){this._commandQueue.clear(t,e,i)}createGPUTimer(){return null}createRenderStateSet(){return new sl(this)}createBlendingState(){return new Jh}createColorState(){return new Kh}createRasterizerState(){return new tl}createDepthState(){return new el}createStencilState(){return new il}createSampler(t){return this.fetchSampler(t)}createTextureFromMipmapData(t,e,i){if(!t)return console.error("Device.createTextureFromMipmapData() failed: invalid data"),null;if(t.isCubemap){const s=new Hh(this);return s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s}if(t.isVolume){const e=new Gh(this);return e.createWithMipmapData(t,this.parseTextureOptions(i)),e.samplerOptions=i?.samplerOptions??null,e}if(t.isArray){const e=new Uh(this);return e.createWithMipmapData(t,this.parseTextureOptions(i)),e.samplerOptions=i?.samplerOptions??null,e}{const s=new kh(this);return s.createWithMipmapData(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s}}createTexture2D(t,e,i,s){const r=s?.texture??new kh(this);return r.isTexture2D()?(r.createEmpty(t,e,i,this.parseTextureOptions(s)),r.samplerOptions=s?.samplerOptions??null,r):(console.error("createTexture2D() failed: options.texture must be 2d texture"),null)}createTexture2DFromImage(t,e,i){const s=i?.texture??new kh(this);return s.isTexture2D()?(s.loadFromElement(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createTexture2DFromImage() failed: options.texture must be 2d texture"),null)}createTexture2DArray(t,e,i,s,r){const a=r?.texture??new Uh(this);return a.isTexture2DArray()?(a.createEmpty(t,e,i,s,this.parseTextureOptions(r)),a.samplerOptions=r?.samplerOptions??null,a):(console.error("createTexture2DArray() failed: options.texture must be 2d array texture"),null)}createTexture2DArrayFromImages(t,e,i){if(!t||0===t.length)return console.error("createTexture2DArrayFromImages() failed: Invalid image elements"),null;let s=0,r=0;for(const e of t)if(0===s||0===r)s=e.width,r=e.height;else if(s!==e.width||r!==e.height)return console.error("createTexture2DArrayFromImages() failed: Image elements must have the same size"),null;if(i?.texture&&!i.texture.isTexture2DArray())return console.error("createTexture2DArrayFromImages() failed: options.texture must be 2d array texture"),null;let a=i?.texture;if(a){if(a.depth!==t.length)return console.error("createTexture2DArrayFromImages() failed: Layer count of options.texture not match the given image elements"),null;if(a.width!==s||a.height!==r)return console.error("createTexture2DArrayFromImages() failed: Size of options.texture not match the given image elements"),null}else{a=this.createTexture2DArray(e?"rgba8unorm-srgb":"rgba8unorm",s,r,t.length,i);for(let e=0;e<t.length;e++)a.updateFromElement(t[e],0,0,e,0,0,s,r)}return a.samplerOptions=i?.samplerOptions??null,a}createTexture3D(t,e,i,s,r){const a=r?.texture??new Gh(this);return a.isTexture3D()?(a.createEmpty(t,e,i,s,this.parseTextureOptions(r)),a.samplerOptions=r?.samplerOptions??null,a):(console.error("createTexture3D() failed: options.texture must be 3d texture"),null)}createCubeTexture(t,e,i){const s=i?.texture??new Hh(this);return s.isTextureCube()?(s.createEmpty(t,e,this.parseTextureOptions(i)),s.samplerOptions=i?.samplerOptions??null,s):(console.error("createCubeTexture() failed: options.texture must be cube texture"),null)}createTextureVideo(t,e){const i=new Wh(this,t);return i.samplerOptions=e??null,i}copyFramebufferToTexture2D(t,e,i,s){if(!t?.isFramebuffer()||!i?.isTexture2D())return void console.error("copyFramebufferToTexture2D(): invalid texture");const r=t.getColorAttachments()?.[e];r&&r.isTexture2D()?this.copyTexture2D(r,t.getColorAttachmentMipLevel(e),i,s):console.error("copyFramebufferToTexture2D(): Color attachment is not a 2D texture")}copyTexture2D(t,e,i,s){if(!t?.isTexture2D()||!i?.isTexture2D())return void console.error("CopyTexture2D(): invalid texture");if(!Number.isInteger(e)||e<0||e>=t.mipLevelCount)return void console.error("CopyTexture2D(): invalid source mipmap level");if(!Number.isInteger(s)||s<0||s>=i.mipLevelCount)return void console.error("CopyTexture2D(): invalid destination mipmap level");const r=Math.max(t.width>>e,1),a=Math.max(t.height>>e,1),n=Math.max(i.width>>s,1),o=Math.max(i.height>>s,1);if(r!==n||a!==o)return void console.error("Source texture and destination texture must have same size");if(t.format!==i.format)return void console.error("CopyTexture2D(): Source texture and destination texture must have same format");this.flush();const h=t,l=i,u=this._device.createCommandEncoder();u.copyTextureToTexture({texture:h.object,mipLevel:e,origin:{x:0,y:0,z:0}},{texture:l.object,mipLevel:s,origin:{x:0,y:0,z:0}},{width:r,height:a,depthOrArrayLayers:1}),this._device.queue.submit([u.finish()])}createGPUProgram(t){return new jo(this,t)}createBindGroup(t){return new Sh(this,t)}createBuffer(t,e){return new qo(this,this.parseBufferOptions(e),t)}copyBuffer(t,e,i,s,r){this._commandQueue.copyBuffer(t,e,i,s,r)}createIndexBuffer(t,e){return new cl(this,t,this.parseBufferOptions(e,"index"))}createStructuredBuffer(t,e,i){return new wh(this,t,this.parseBufferOptions(e),i)}createVertexLayout(t){return new Yh(this,t)}createFrameBuffer(t,e,i){return new hl(this,t,e,i)}setBindGroup(t,e,i){this._currentBindGroups[t]=e,this._currentBindGroupOffsets[t]=i??e?.getDynamicOffsets()??null}getBindGroup(t){return[this._currentBindGroups[t],this._currentBindGroupOffsets[t]]}setViewport(t){this._commandQueue.setViewport(t)}getViewport(){return this._commandQueue.getViewport()}setScissor(t){this._commandQueue.setScissor(t)}getScissor(){return this._commandQueue.getScissor()}setProgram(t){this._currentProgram=t}getProgram(){return this._currentProgram}setVertexLayout(t){this._currentVertexData=t}getVertexLayout(){return this._currentVertexData}setRenderStates(t){this._currentStateSet=t}getRenderStates(){return this._currentStateSet}getFramebuffer(){return this._commandQueue.getFramebuffer()??null}reverseVertexWindingOrder(t){this._reverseWindingOrder=!!t}isWindingOrderReversed(){return this._reverseWindingOrder}isBufferUploading(t){return this._commandQueue.isBufferUploading(t)}isTextureUploading(t){return this._commandQueue.isTextureUploading(t)}getFramebufferInfo(){return this._commandQueue.getFramebufferInfo()}gpuGetObjectHash(t){return this._gpuObjectHasher.get(t)}gpuCreateTexture(t){const e=this._device.createTexture(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuImportExternalTexture(t){const e=this._device.importExternalTexture({source:t});return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuCreateSampler(t){const e=this._device.createSampler(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuCreateBindGroup(t){const e=this._device.createBindGroup(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuCreateBuffer(t){const e=this._device.createBuffer(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuCreateTextureView(t,e){const i=t?.createView(e);return i&&this._gpuObjectHasher.set(i,++this._gpuObjectHashCounter),i}gpuCreateRenderPipeline(t){const e=this._device.createRenderPipeline(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}gpuCreateComputePipeline(t){const e=this._device.createComputePipeline(t);return e&&this._gpuObjectHasher.set(e,++this._gpuObjectHashCounter),e}fetchVertexLayout(t){return this._vertexLayoutCache.fetchVertexLayout(t)}fetchSampler(t){return this._samplerCache.fetchSampler(t)}fetchBindGroupLayout(t){return this._bindGroupCache.fetchBindGroupLayout(t)}flush(){this._commandQueue.flush()}async readPixels(t,e,i,s,r,a){const n=this.getFramebuffer(),o=n?n.getColorAttachments()[t]?.object:this.context.getCurrentTexture(),h=n?n.getColorAttachments()[t]?.format:Nh[this._backBufferFormat];if(o&&h){const t=s*r*Gt(h),n=this.createBuffer(t,{usage:"read"});this.readPixelsToBuffer(0,e,i,s,r,n);const o=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);await n.getBufferSubData(o),n.dispose()}else console.error("readPixels() failed: no color attachment0 or unrecoganized color attachment format")}readPixelsToBuffer(t,e,i,s,r,a){const n=this.getFramebuffer(),o=n?n.getColorAttachments()[t]?.object:this.context.getCurrentTexture(),h=n?n.getColorAttachments()[t]?.format:Nh[this._backBufferFormat];o&&h?(this.flush(),Oh.copyTexturePixelsToBuffer(this._device,o,h,e,i,s,r,0,0,a)):console.error("readPixelsToBuffer() failed: no color attachment0 or unrecoganized color attachment format")}looseContext(){}restoreContext(){}beginCapture(){if(this._captureRenderBundle)throw new Error("Device.beginCapture() failed: device is already capturing draw commands");const t=this.getFramebufferInfo(),e={colorFormats:t.colorFormats,depthStencilFormat:t.depthFormat,sampleCount:t.sampleCount};this._captureRenderBundle={dc:0,encoder:this._device.createRenderBundleEncoder(e),renderBundle:null}}endCapture(){if(!this._captureRenderBundle)throw new Error("Device.endCapture() failed: device is not capturing draw commands");this._captureRenderBundle.renderBundle=this._captureRenderBundle.encoder.finish();const t=this._captureRenderBundle;return this._captureRenderBundle=null,t}_executeRenderBundle(t){return this._commandQueue.executeRenderBundle(t.renderBundle),t.dc}bufferUpload(t){this._commandQueue.bufferUpload(t)}textureUpload(t){this._commandQueue.textureUpload(t)}flushUploads(){this._commandQueue.flushUploads()}_setFramebuffer(t){this._commandQueue.setFramebuffer(t)}onBeginFrame(){return!!this._canRender&&(this._commandQueue.beginFrame(),!0)}onEndFrame(){this._commandQueue.endFrame()}_draw(t,e,i){this._commandQueue.draw(this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,t,e,i,1),this._captureRenderBundle&&(this._captureRenderBundle.dc++,this._commandQueue.capture(this._captureRenderBundle.encoder,this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,t,e,i,1))}_drawInstanced(t,e,i,s){this._commandQueue.draw(this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,t,e,i,s),this._captureRenderBundle&&(this._captureRenderBundle.dc++,this._commandQueue.capture(this._captureRenderBundle.encoder,this._currentProgram,this._currentVertexData,this._currentStateSet,this._currentBindGroups,this._currentBindGroupOffsets,t,e,i,s))}_compute(t,e,i){this._commandQueue.compute(this._currentProgram,this._currentBindGroups,this._currentBindGroupOffsets,t,e,i)}configure(){this._backBufferFormat=navigator.gpu.getPreferredCanvasFormat(),this._depthFormat=this._deviceCaps.framebufferCaps.supportDepth32floatStencil8?"depth32float-stencil8":"depth24plus-stencil8",this._context.configure({device:this._device,format:this._backBufferFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:"opaque",colorSpace:"srgb"}),this.createDefaultRenderAttachments()}createDefaultRenderAttachments(){const t=Math.max(1,this.canvas.width),e=Math.max(1,this.canvas.height);this._defaultMSAAColorTexture?.destroy(),this._defaultMSAAColorTexture=null,this._defaultMSAAColorTextureView=null,this._defaultDepthTexture?.destroy(),this._defaultDepthTexture=null,this._defaultDepthTextureView=null,this._sampleCount>1&&(this._defaultMSAAColorTexture=this.gpuCreateTexture({size:{width:t,height:e,depthOrArrayLayers:1},format:this._backBufferFormat,dimension:"2d",mipLevelCount:1,sampleCount:this._sampleCount,usage:GPUTextureUsage.RENDER_ATTACHMENT}),this._defaultMSAAColorTextureView=this._defaultMSAAColorTexture.createView()),this._defaultDepthTexture=this.gpuCreateTexture({size:{width:t,height:e,depthOrArrayLayers:1},format:this._depthFormat,dimension:"2d",mipLevelCount:1,sampleCount:this._sampleCount,usage:GPUTextureUsage.RENDER_ATTACHMENT}),this._defaultDepthTextureView=this._defaultDepthTexture.createView(),this._defaultRenderPassDesc={label:`mainRenderPass:${this._sampleCount}`,colorAttachments:[{view:this._sampleCount>1?this._defaultMSAAColorTextureView:null,resolveTarget:void 0,loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}],depthStencilAttachment:{view:this._defaultDepthTextureView,depthLoadOp:"clear",depthClearValue:1,depthStoreOp:"store",stencilLoadOp:"clear",stencilClearValue:0,stencilStoreOp:"store"}}}}const yl={typeName:()=>"webgpu",supported:()=>!!window.GPU&&navigator.gpu instanceof window.GPU,async createDevice(t,e){try{const i=new(v(vl)())(this,t,e);return await i.initContext(),i.setViewport(),i.setScissor(),i}catch(t){return console.error(t),null}}};let Tl;function wl(){return Tl?.engine??null}function Sl(){return Tl?.device??null}class Al extends gt{_renderBundles;static _drawableContainer=new WeakMap;static _materialContainer=new WeakMap;static _primitiveContainer=new WeakMap;static addDrawable(t,e,i,s,r){let a=this._drawableContainer.get(t);a||(a=[],this._drawableContainer.set(t,a));const n=a.findIndex(t=>t.wrapper===s);if(n<0?a.push({wrapper:s,hashes:[r]}):a[n].hashes.includes(r)||a[n].hashes.push(r),e){let i=this._materialContainer.get(e);i||(i=new Set,this._materialContainer.set(e,i)),i.add(t)}if(i){let e=this._primitiveContainer.get(i);e||(e=new Set,this._primitiveContainer.set(i,e)),e.add(t)}}static drawableChanged(t){const e=this._drawableContainer.get(t);if(e)for(let t=e.length-1;t>=0;t--){if(e[t].wrapper.disposed)e.splice(t,1);else for(const i of e[t].hashes)e[t].wrapper.invalidate(i)}}static primitiveChanged(t){const e=this._primitiveContainer.get(t);if(e)for(const t of e)this.drawableChanged(t)}static primitiveAttached(t,e){if(this._drawableContainer.has(e)){const i=this._primitiveContainer.get(t);i?i.add(e):this._primitiveContainer.set(t,new Set([e])),this.drawableChanged(e)}}static primitiveDetached(t,e){const i=this._primitiveContainer.get(t);i&&i.has(e)&&(i.delete(e),this.drawableChanged(e))}static materialChanged(t){const e=this._materialContainer.get(t);if(e)for(const t of e)this.drawableChanged(t)}static materialUniformsChanged(t){const e=this._materialContainer.get(t);if(e)for(const t of e)t.isBatchable()&&t.applyMaterialUniformsAll()}static materialAttached(t,e){if(this._drawableContainer.has(e)){const i=this._materialContainer.get(t);i?i.add(e):this._materialContainer.set(t,new Set([e])),this.drawableChanged(e)}}static materialDetached(t,e){const i=this._materialContainer.get(t);i&&i.has(e)&&(i.delete(e),this.drawableChanged(e))}constructor(){super(),this._renderBundles={}}getRenderBundle(t){return this._renderBundles[t]??null}beginRenderBundle(){Sl().beginCapture()}endRenderBundle(t){this._renderBundles[t]=Sl().endCapture()}invalidate(t){this._renderBundles[t]=void 0}onDispose(){super.onDispose(),this._renderBundles={}}}class Cl extends(v(gt)()){_vertexLayout;_vertexLayoutOptions;_primitiveType;_indexStart;_indexCount;_defaultIndexCount;_vertexLayoutDirty;static _nextId=0;_id;_bbox;_changeTag;constructor(){super(),this._vertexLayout=null,this._vertexLayoutOptions={vertexBuffers:[]},this._primitiveType="triangle-list",this._indexStart=0,this._indexCount=null,this._defaultIndexCount=0,this._vertexLayoutDirty=!1,this._id=++Cl._nextId,this._changeTag=0,this._bbox=null}get id(){return this._id}get changeTag(){return this._changeTag}clone(){const t=new Cl;return t.copyFrom(this),t}copyFrom(t){for(const e of t._vertexLayoutOptions.vertexBuffers)this.setVertexBuffer(e.buffer,e.stepMode);this.setIndexBuffer(t._vertexLayoutOptions.indexBuffer),this.primitiveType=t.primitiveType,this.indexStart=t.indexStart,this.indexCount=t.indexCount}get primitiveType(){return this._primitiveType}set primitiveType(t){t!==this._primitiveType&&(this._primitiveType=t,this._changeTag++,Al.primitiveChanged(this))}get indexStart(){return this._indexStart}set indexStart(t){t!==this._indexStart&&(this._indexStart=t,this._changeTag++,Al.primitiveChanged(this))}get indexCount(){return this._indexCount=this._indexCount??this.calcDefaultIndexCount(),this._indexCount}set indexCount(t){t!==this._indexCount&&(this._indexCount=t,this._changeTag++,Al.primitiveChanged(this))}getNumVertices(){const t=this.getVertexBufferInfo("position");return t?.buffer?t.buffer.byteLength/t.stride|0:0}getNumFaces(){const t=this.getIndexBuffer(),e=t?t.byteLength>>(t.indexType.primitiveType===te.U16?1:2):this.getNumVertices();switch(this.primitiveType){case"line-list":return e>>1;case"point-list":return e;case"line-strip":return e-1;case"triangle-fan":case"triangle-strip":return e-2;case"triangle-list":return e/3|0;default:return 0}}removeVertexBuffer(t){for(let e=this._vertexLayoutOptions.vertexBuffers.length-1;e>=0;e--){const i=this._vertexLayoutOptions.vertexBuffers[e];lr(i.buffer,t)&&(Tt(i.buffer),this._vertexLayoutOptions.vertexBuffers.splice(e,1),this._vertexLayoutDirty=!0)}this._vertexLayoutDirty&&(this._changeTag++,Al.primitiveChanged(this))}getVertexBuffer(t){for(const e of this._vertexLayoutOptions.vertexBuffers)if(e.buffer&&lr(e.buffer,t))return e.buffer;return null}getVertexBufferInfo(t){return this.checkVertexLayout(),this._vertexLayout?.getVertexBufferInfo(t)??null}createAndSetVertexBuffer(t,e,i){const s=Sl(),r=Array.isArray(t)?s.createInterleavedVertexBuffer(t,e):s.createVertexBuffer(t,e);return this.setVertexBuffer(r,i)}setVertexBuffer(t,e){return yt(t),this._vertexLayoutOptions.vertexBuffers.push({buffer:t,stepMode:e}),this._vertexLayoutDirty=!0,this._changeTag++,Al.primitiveChanged(this),t}createAndSetIndexBuffer(t,e){const i=Sl().createIndexBuffer(t,{dynamic:!!e,managed:!e});return this.setIndexBuffer(i),i}setIndexBuffer(t){this._vertexLayoutOptions.indexBuffer!==t&&(yt(t),Tt(this._vertexLayoutOptions.indexBuffer),this._vertexLayoutOptions.indexBuffer=t,this._vertexLayoutDirty=!0,this._changeTag++,Al.primitiveChanged(this))}getIndexBuffer(){return this._vertexLayoutOptions.indexBuffer}draw(){this.checkVertexLayout(),this.indexCount>0&&this._vertexLayout?.draw(this._primitiveType,this._indexStart,this.indexCount)}drawInstanced(t){this.checkVertexLayout(),this.indexCount>0&&this._vertexLayout?.drawInstanced(this._primitiveType,this._indexStart,this.indexCount,t)}onDispose(){if(super.onDispose(),this._vertexLayout?.dispose(),this._vertexLayout=null,this._vertexLayoutOptions){Tt(this._vertexLayoutOptions.indexBuffer);for(const t of this._vertexLayoutOptions.vertexBuffers)Tt(t.buffer);this._vertexLayoutOptions=null}}getBoundingVolume(){return this._bbox}setBoundingVolume(t){t!==this._bbox&&(this._bbox=t,this.dispatchEvent("bv_changed"))}raycast(t){const e=this.getBoundingVolume()?.toAABB();return e?t.bboxIntersectionTestEx(e):null}checkVertexLayout(){if(this._vertexLayoutDirty){this._vertexLayout?.dispose();const t=Sl();this._vertexLayout=t.createVertexLayout(this._vertexLayoutOptions),this._vertexLayoutDirty=!1}}calcDefaultIndexCount(){const t=this.getIndexBuffer();if(t)return Math.max(0,t.length-this._indexStart);const e=this.getVertexBufferInfo("position");return e?Math.max(0,Math.floor((e.buffer.byteLength-e.drawOffset)/e.stride)-this._indexStart):0}}function El(t,e){const i=t.$builder;if(!e||!e.$typeinfo.isPrimitiveType()||e.$typeinfo.primitiveType!==te.F32VEC4)throw new Error("decodeNormalizedFloatFromRGBA() failed: parameter type must be vec4");if(!(t&&t instanceof Tn))throw new Error("decodeNormalizedFloatFromRGBA() failed: decodeNormalizedFloatFromRGBA() must be called inside a function");const s="Z_decodeNormalizedFloatFromRGBA";return i.func(s,[i.vec4("value")],function(){this.$l.bitShift=i.vec4(1/16777216,1/65536,1/256,1),this.$return(i.dot(this.value,this.bitShift))}),t[s](e)}function Ml(t,e){const i=t.$builder,s="Z_encodeNormalizedFloatToRGBA";return i.func(s,[i.float("value")],function(){this.$l.bitShift=i.vec4(16777216,65536,256,1),this.$l.bitMask=i.vec4(0,1/256,1/256,1/256),this.$l.t=i.fract(i.mul(this.value,this.bitShift)),this.$return(i.sub(this.t,i.mul(this.t.xxyz,this.bitMask)))}),i.getGlobalScope()[s](e)}function Bl(t,e){const i=t.$builder,s="Z_decode2HalfFromRGBA";return i.func(s,[i.vec4("value")],function(){this.$return(i.vec2(i.add(this.value.x,i.div(this.value.y,255)),i.add(this.value.z,i.div(this.value.w,255))))}),i.getGlobalScope()[s](e)}function Il(t,e){const i=t.$builder,s="Z_linearToGamma";return i.func(s,[i.vec3("color")],function(){this.$return(i.max(i.sub(i.mul(i.pow(this.color,i.vec3(.416666667)),1.055),i.vec3(.055)),i.vec3(0)))}),i.getGlobalScope()[s](e)}class Pl{_hash;_renderStates;_srgbOut;_flip;_viewport;_scissor;_destRect;_offsetParams;constructor(){this._hash=null,this._renderStates=null,this._srgbOut=!1,this._flip=!1,this._viewport=null,this._scissor=null,this._destRect=null,this._offsetParams=new O}get viewport(){return this._viewport}set viewport(t){this._viewport=t??null}get scissor(){return this._scissor}set scissor(t){this._scissor=t??null}get destRect(){return this._destRect}set destRect(t){!!this._destRect!=!!t&&this.invalidateHash(),this._destRect=t??null}get srgbOut(){return this._srgbOut}set srgbOut(t){this._srgbOut!==!!t&&(this._srgbOut=!!t,this.invalidateHash())}get renderStates(){return this._renderStates}set renderStates(t){this._renderStates=t}get hash(){return this._hash||(this._hash=`${this.constructor.name}:${this._srgbOut?1:0}:${this._flip?1:0}:${this._destRect?1:0}:${this.calcHash()}`),this._hash}invalidateHash(){this._hash=null}readTexel(t,e,i,s,r,a){const n=t.$builder;if("float"===a||"depth"===a)switch(e){case"2d":case"cube":return Sl().getDeviceCaps().shaderCaps.supportShaderTextureLod?n.textureSampleLevel(i,s,0):n.textureSample(i,s);case"2d-array":return n.textureArraySampleLevel(i,s,r,0);default:return null}else switch(e){case"2d":return n.textureLoad(i,n.ivec2(n.mul(n.vec2(n.textureDimensions(i,0)),s)),0);case"cube":throw new Error("Integer format cube texture not supported");case"2d-array":return n.textureArrayLoad(i,n.ivec2(n.mul(n.vec2(n.textureDimensions(i,0)),s)),r,0);default:return null}}writeTexel(t,e,i,s){return s}setup(t,e){}setUniforms(t,e){}blit2D(t,e,i){const s=Sl(),r=!e&&"webgpu"===s.type,a=Ll("2d",this,i?"linear"===i.magFilter||"linear"===i.minFilter||"linear"===i.mipFilter:t.isFilterable(),t.isIntegerFormat()?t.isSignedFormat()?"int":"uint":"float",r);if(a.bindGroup.setTexture("srcTex",t,i),this._destRect){const t=this._viewport?.[2]??e?.getWidth()??s.getBackBufferWidth(),i=this._viewport?.[3]??e?.getHeight()??s.getBackBufferHeight();this._offsetParams.setXYZW(this._destRect[2]/t,this._destRect[3]/i,(this._destRect[2]+2*this._destRect[0])/t-1,(this._destRect[3]+2*this._destRect[1])/i-1),a.bindGroup.setValue("scaleBias",this._offsetParams)}this.setUniforms(a.bindGroup,t),s.setFramebuffer(e??null),s.setViewport(this._viewport),s.setScissor(this._scissor),s.setProgram(a.program),s.setBindGroup(0,a.bindGroup),s.setRenderStates(this._renderStates??Nl()),Dl().draw()}blit2DArray(t,e,i,s){const r=Sl(),a=!e&&"webgpu"===r.type,n=Ll("2d-array",this,s?"linear"===s.magFilter||"linear"===s.minFilter||"linear"===s.mipFilter:t.isFilterable(),t.isIntegerFormat()?t.isSignedFormat()?"int":"uint":"float",a);n.bindGroup.setTexture("srcTex",t,s),n.bindGroup.setValue("srcLayer",i),this.setUniforms(n.bindGroup,t),r.setFramebuffer(e??null),r.setViewport(this._viewport),r.setScissor(this._scissor),r.setProgram(n.program),r.setBindGroup(0,n.bindGroup),r.setRenderStates(this._renderStates??Nl()),Dl().draw()}blitCubeMap(t,e,i,s){const r=Sl(),a=!e&&"webgpu"===r.type,n=Ll("cube",this,s?"linear"===s.magFilter||"linear"===s.minFilter||"linear"===s.mipFilter:t.isFilterable(),t.isIntegerFormat()?t.isSignedFormat()?"int":"uint":"float",a);n.bindGroup.setTexture("srcTex",t,s),n.bindGroup.setValue("texelSize",1/t.width),n.bindGroup.setValue("cubeFace",i),this.setUniforms(n.bindGroup,t),r.setFramebuffer(e??null),r.setViewport(this._viewport),r.setScissor(this._scissor),r.setProgram(n.program),r.setBindGroup(0,n.bindGroup),r.setRenderStates(this._renderStates??Nl()),Dl().draw()}blit(t,e,i,s){const r=Sl();if(r.pushDeviceStates(),e){const a=e.isFramebuffer()?e:r.pool.createTemporalFramebuffer(!1,[e],null),n=e.isFramebuffer()?e.getColorAttachments()?.[0]:e;if(t.isTexture2D()){if(!n?.isTexture2D()&&!n?.isTexture2DArray())throw new Error("Blitter.blit() failed: invalid destination texture type");n.isTexture2DArray()&&a.setColorAttachmentLayer(0,i||0),this.blit2D(t,a,s)}else if(t.isTexture2DArray()){if(!n?.isTexture2D()&&!n.isTexture2DArray())throw new Error("Blitter.blit() failed: invalid destination texture type");if(n.isTexture2D())this.blit2DArray(t,a,i||0,s);else{const e=Math.min(t.depth,n.depth);for(let s=0;s<e;s++)a.setColorAttachmentLayer(0,s),this.blit2DArray(t,a,s,i)}}else{if(!t.isTextureCube())throw new Error("Blitter.blit() failed: invalid texture type");if(!n.isTextureCube()&&!n.isTexture2D())throw new Error("Blitter.blit() failed: invalid destination texture type");if(n.isTextureCube())for(let e=0;e<6;e++)a.setColorAttachmentCubeFace(0,e),this.blitCubeMap(t,a,e,i);else this.blitCubeMap(t,a,i||0,s)}a&&a!==e&&r.pool.releaseFrameBuffer(a)}else if(t.isTexture2D())this.blit2D(t,null,s);else if(t.isTexture2DArray())this.blit2DArray(t,null,i||0,s);else{if(!t.isTextureCube())throw new Error("Blitter.blit() failed: invalid texture type");this.blitCubeMap(t,null,i||0,s)}r.popDeviceStates()}}const $l={};let Rl=null,Fl=null;function Dl(){return Rl||(Rl=new Cl,Rl.createAndSetVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1])),Rl.indexCount=4,Rl.indexStart=0,Rl.primitiveType="triangle-strip"),Rl}function Nl(){return Fl||(Fl=Sl().createRenderStateSet(),Fl.useDepthState().enableTest(!1).enableWrite(!1),Fl.useRasterizerState().setCullMode("none")),Fl}function Ll(t,e,i,s,r){const a=`${t}:${e.hash}:${i}:${s}:${r?1:0}`;let n=$l[a];return void 0===n&&(n=function(t,e,i,s,r,a){const n=Sl().buildRenderProgram({vertex(i){this.$inputs.pos=i.vec2().attrib("position"),this.$outputs.uv=i.vec2(),a&&(this.scaleBias=i.vec4().uniform(0)),e.setup(this,t),i.main(function(){this.$builtins.position=i.vec4(this.$inputs.pos,1,1),this.$outputs.uv="cube"===t?i.mul(i.vec2(1,-1),this.$inputs.pos.xy):i.add(i.mul(this.$inputs.pos.xy,.5),i.vec2(.5)),"webgpu"===Sl().type&&(this.$builtins.position.y=i.neg(this.$builtins.position.y)),a&&(this.$l.xy=i.add(i.mul(this.$builtins.position.xy,this.scaleBias.xy),this.scaleBias.zw),this.$builtins.position=i.vec4(this.xy,1,1))})},fragment(a){switch(t){case"2d":this.srcTex="int"===s?a.itex2D().sampleType("sint").uniform(0):"uint"===s?a.utex2D().sampleType("uint").uniform(0):"depth"===s?a.tex2DShadow().uniform(0):a.tex2D().sampleType(i?"float":"unfilterable-float").uniform(0);break;case"2d-array":this.srcTex="int"===s?a.itex2DArray().sampleType("sint").uniform(0):"uint"===s?a.utex2DArray().sampleType("uint").uniform(0):"depth"===s?a.tex2DArrayShadow().uniform(0):a.tex2DArray().sampleType(i?"float":"unfilterable-float").uniform(0),this.srcLayer=a.int().uniform(0);break;case"cube":this.srcTex="int"===s?a.itexCube().sampleType("sint").uniform(0):"uint"===s?a.utexCube().sampleType("uint").uniform(0):"depth"===s?a.texCubeShadow().uniform(0):a.texCube().sampleType(i?"float":"unfilterable-float").uniform(0),this.texelSize=a.float().uniform(0),this.cubeFace=a.int().uniform(0);break;default:throw new Error(`invalid blit type: ${t}`)}this.$outputs.outColor=a.vec4(),e.setup(this,t),a.main(function(){"cube"===t?(this.uv=a.vec3(),this.$if(a.equal(this.cubeFace,0),function(){this.uv=a.vec3(1,this.$inputs.uv.y,a.neg(this.$inputs.uv.x))}).$elseif(a.equal(this.cubeFace,1),function(){this.uv=a.vec3(-1,this.$inputs.uv.y,this.$inputs.uv.x)}).$elseif(a.equal(this.cubeFace,2),function(){this.uv=a.vec3(this.$inputs.uv.x,1,a.neg(this.$inputs.uv.y))}).$elseif(a.equal(this.cubeFace,3),function(){this.uv=a.vec3(this.$inputs.uv.x,-1,this.$inputs.uv.y)}).$elseif(a.equal(this.cubeFace,4),function(){this.uv=a.vec3(this.$inputs.uv.x,this.$inputs.uv.y,1)}).$else(function(){this.uv=a.vec3(a.neg(this.$inputs.uv.x),this.$inputs.uv.y,-1)})):this.uv=this.$inputs.uv,r&&(this.uv.y=a.sub(1,this.uv.y)),this.$l.outTexel=e.filter(this,t,this.srcTex,this.uv,"2d"===t?null:this.srcLayer,s),this.$outputs.outColor=e.writeTexel(this,t,this.$inputs.uv,this.outTexel),e.srgbOut&&(this.$outputs.outColor=a.vec4(Il(this,this.$outputs.outColor.rgb),this.$outputs.outColor.a))})}});n&&(n.name=`@Blit_${t}_${s}_${i?"bilinear":"point"}_${r?"flip":"noflip"}`);return n?{program:n,bindGroup:Sl().createBindGroup(n.bindGroupLayouts[0])}:null}(t,e,i,s,r,!!e.destRect)||null,$l[a]=n),n}class zl extends Pl{filter(t,e,i,s,r,a){return this.readTexel(t,e,i,s,r,a)}calcHash(){return""}}const Vl={clamp_linear:{addressU:"clamp",addressV:"clamp",magFilter:"linear",minFilter:"linear",mipFilter:"linear"},clamp_linear_nomip:{addressU:"clamp",addressV:"clamp",magFilter:"linear",minFilter:"linear",mipFilter:"none"},clamp_nearest:{addressU:"clamp",addressV:"clamp",magFilter:"nearest",minFilter:"nearest",mipFilter:"nearest"},clamp_nearest_nomip:{addressU:"clamp",addressV:"clamp",magFilter:"nearest",minFilter:"nearest",mipFilter:"none"},repeat_linear:{addressU:"repeat",addressV:"repeat",magFilter:"linear",minFilter:"linear",mipFilter:"linear"},repeat_linear_nomip:{addressU:"repeat",addressV:"repeat",magFilter:"linear",minFilter:"linear",mipFilter:"none"},repeat_nearest:{addressU:"repeat",addressV:"repeat",magFilter:"nearest",minFilter:"nearest",mipFilter:"nearest"},repeat_nearest_nomip:{addressU:"repeat",addressV:"repeat",magFilter:"nearest",minFilter:"nearest",mipFilter:"none"}},Ol={};let kl=null,Ul=null;function Gl(t){let e=Ol[t];if(!e){const i=Vl[t];i&&(e=Sl().createSampler(i),Ol[t]=e)}return e}function Hl(t,e,i=null,s=null,r=0,a=!1){s||Ul||(Ul=t.device.createRenderStateSet(),Ul.useDepthState().enableTest(!1).enableWrite(!1),Ul.useRasterizerState().setCullMode("none")),kl||(kl=new zl),kl.renderStates=s??Ul,kl.srgbOut=a,kl.blit(t,e,r,i)}let Wl=null,Xl=null;const jl={},Ql=[[new z(0,0,-1),new z(0,-1,0),new z(1,0,0)],[new z(0,0,1),new z(0,-1,0),new z(-1,0,0)],[new z(1,0,0),new z(0,0,1),new z(0,1,0)],[new z(1,0,0),new z(0,0,-1),new z(0,-1,0)],[new z(1,0,0),new z(0,-1,0),new z(0,0,1)],[new z(-1,0,0),new z(0,-1,0),new z(0,0,-1)]];function ql(t,e){const i=Sl(),s=`${t}:${e}`;let r=jl[s];if(!r){const t=function(t,e){const i=Sl(),s=i;return s.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.up=t.vec3().uniform(0),this.right=t.vec3().uniform(0),this.front=t.vec3().uniform(0),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.direction=t.mul(t.mat3(this.up,this.right,this.front),t.vec3(this.$inputs.pos,1)),"webgpu"===i.type&&(this.$builtins.position.y=t.neg(this.$builtins.position.y))})},fragment(t){this.alphaG=t.float().uniform(0),this.vFilteringInfo=t.vec3().uniform(0),this.hdrScale=t.float().uniform(0),this.inputTexture=t.texCube().uniform(0),this.NUM_SAMPLES_FLOAT=t.float(e),this.NUM_SAMPLES_FLOAT_INVERSED=t.float(1/e),this.K=t.float(4),this.$outputs.outcolor=t.vec4(),"webgl"===i.type?(t.func("radicalInverse_VdC",[t.int("bits")],function(){this.$l.rand=t.float(0),this.$l.denom=t.float(1),this.$l.invBase=t.float(.5),this.$l.n=this.bits,this.$for(t.int("i"),0,32,function(){this.denom=t.mul(this.denom,2),this.rand=t.add(this.rand,t.div(t.mod(t.float(this.n),2),this.denom)),this.n=t.div(this.n,2),this.$if(t.equal(this.n,0),function(){this.$break()})}),this.$return(this.rand)}),t.func("hammersley2d",[t.int("i"),t.int("N")],function(){this.$return(t.vec2(t.div(t.float(this.i),t.float(this.N)),this.radicalInverse_VdC(this.i)))})):(t.func("radicalInverse_VdC",[t.uint("bits")],function(){this.$l.n=this.bits,this.n=t.compOr(t.sal(this.n,16),t.sar(this.n,16)),this.n=t.compOr(t.sal(t.compAnd(this.n,1431655765),1),t.sar(t.compAnd(this.n,2863311530),1)),this.n=t.compOr(t.sal(t.compAnd(this.n,858993459),2),t.sar(t.compAnd(this.n,3435973836),2)),this.n=t.compOr(t.sal(t.compAnd(this.n,252645135),4),t.sar(t.compAnd(this.n,4042322160),4)),this.n=t.compOr(t.sal(t.compAnd(this.n,16711935),8),t.sar(t.compAnd(this.n,4278255360),8)),this.$return(t.mul(t.float(this.n),2.3283064365386963e-10))}),t.func("hammersley2d",[t.int("i"),t.int("N")],function(){this.$return(t.vec2(t.div(t.float(this.i),t.float(this.N)),this.radicalInverse_VdC(t.uint(this.i))))})),t.func("log4",[t.float("x")],function(){this.$return(t.mul(t.log2(this.x),.5))}),t.func("hemisphereImportanceSampleDggx",[t.vec2("u"),t.float("a")],function(){this.$l.phi=t.mul(this.u.x,2*Math.PI),this.$l.cosTheta2=t.div(t.sub(1,this.u.y),t.add(t.mul(t.add(this.a,1),t.sub(this.a,1),this.u.y),1)),this.$l.cosTheta=t.sqrt(this.cosTheta2),this.$l.sinTheta=t.sqrt(t.sub(1,this.cosTheta2)),this.$return(t.vec3(t.mul(t.cos(this.phi),this.sinTheta),t.mul(t.sin(this.phi),this.sinTheta),this.cosTheta))}),t.func("normalDistributionFunction_TrowbridgeReitzGGX",[t.float("NoH"),t.float("alphaG")],function(){this.$l.a2=t.mul(this.alphaG,this.alphaG),this.$l.d=t.add(t.mul(this.NoH,this.NoH,t.sub(this.a2,1)),1),this.$return(t.div(this.a2,t.mul(this.d,this.d,Math.PI)))}),t.func("radiance",[t.float("alphaG"),t.vec3("direction"),t.vec3("vFilteringInfo")],function(){this.$l.n=t.normalize(this.direction),this.$if(t.equal(this.alphaG,0),function(){this.$l.c=t.textureSampleLevel(this.inputTexture,this.n,0).rgb,this.$return(this.c)}).$else(function(){this.$l.result=t.vec3(0),this.$l.tangent=t.vec3(),this.$if(t.lessThan(t.abs(this.n.z),.999),function(){this.tangent=t.vec3(0,0,1)}).$else(function(){this.tangent=t.vec3(1,0,0)}),this.tangent=t.normalize(t.cross(this.tangent,this.n)),this.$l.bitangent=t.cross(this.n,this.tangent),this.$l.tbn=t.mat3(this.tangent,this.bitangent,this.n),this.$l.maxLevel=this.vFilteringInfo.y,this.$l.dim0=this.vFilteringInfo.x,this.$l.omegaP=t.div(4*Math.PI,t.mul(this.dim0,this.dim0,6)),this.$l.weight=t.float(0),this.$for(t.int("i"),0,e,function(){this.$l.Xi=this.hammersley2d(this.i,e),this.$l.H=this.hemisphereImportanceSampleDggx(this.Xi,this.alphaG),this.$l.NoV=t.float(1),this.$l.NoH=this.H.z,this.$l.NoH2=t.mul(this.H.z,this.H.z),this.$l.NoL=t.sub(t.mul(this.NoH2,2),1),this.$l.L=t.normalize(t.vec3(t.mul(this.NoH,this.H.x,2),t.mul(this.NoH,this.H.y,2),this.NoL)),this.$if(t.greaterThan(this.NoL,0),function(){this.$l.pdf_inversed=t.div(4,this.normalDistributionFunction_TrowbridgeReitzGGX(this.NoH,this.alphaG)),this.$l.omegaS=t.mul(this.pdf_inversed,this.NUM_SAMPLES_FLOAT_INVERSED),this.$l.l=t.add(t.sub(this.log4(this.omegaS),this.log4(this.omegaP)),this.log4(this.K)),this.$l.mipLevel=t.clamp(this.l,0,this.maxLevel),this.weight=t.add(this.weight,this.NoL),this.$l.c=t.textureSampleLevel(this.inputTexture,t.mul(this.tbn,this.L),this.mipLevel).rgb,this.result=t.add(this.result,t.mul(this.c,this.NoL))})}),this.result=t.div(this.result,this.weight),this.$return(this.result)})}),t.main(function(){this.$l.color=this.radiance(this.alphaG,this.$inputs.direction,this.vFilteringInfo),this.$outputs.outcolor=t.vec4(t.mul(this.color,this.hdrScale),1)})}})}(0,e),a=i.createBindGroup(t.bindGroupLayouts[0]);jl[s]=r={program:t,bindgroup:a}}return r}function Yl(t,e,i,s,r,a,n,o){const h=Sl(),l=a;l.setColorAttachmentMipLevel(0,i),l.setColorAttachmentGenerateMipmaps(0,!1);const{program:u,bindgroup:c}=ql(t,o);c.setValue("vFilteringInfo",n),c.setValue("hdrScale",1),c.setTexture("inputTexture",s),c.setValue("alphaG",e),h.setProgram(u),h.setBindGroup(0,c),h.setFramebuffer(l);for(let t=0;t<6;t++)l.setColorAttachmentCubeFace(0,t),h.setVertexLayout(Wl),h.setRenderStates(Xl),c.setValue("up",Ql[t][0]),c.setValue("right",Ql[t][1]),c.setValue("front",Ql[t][2]),h.draw("triangle-list",0,6)}function Zl(t,e,i,s,r){if(!t||!t.isTextureCube())return void console.error("prefilterCubemap(): source texture must be cube texture");const a=Sl();Wl||function(){const t=Sl(),e=new Float32Array([1,1,-1,1,-1,-1,1,-1]),i=new Uint16Array([0,1,2,0,2,3]);Wl=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",e)}],indexBuffer:t.createIndexBuffer(i)}),Xl=t.createRenderStateSet(),Xl.useRasterizerState().setCullMode("none"),Xl.useDepthState().enableTest(!1).enableWrite(!1)}(),a.pushDeviceStates(),r=r??!0;const n=a.getRenderStates(),o=t,h=t.width,l=t.mipLevelCount,u=new z(h,l,r?1:Math.PI),c=i.isFramebuffer()?i:a.createFrameBuffer([i],null),d=c.getColorAttachmentMipLevel(0),p=c.getColorAttachmentGenerateMipmaps(0),m=c.getColorAttachments()[0].mipLevelCount;for(let t=0;t<m;t++){Yl(e,0===t?0:Math.pow(2,t)/h,t,o,Gl("clamp_nearest_nomip"),c,u,s??64)}a.popDeviceStates(),a.setRenderStates(n),c.setColorAttachmentMipLevel(0,d),c.setColorAttachmentGenerateMipmaps(0,p),i.isFramebuffer()||c.dispose()}let Kl=null,Jl=null,tu=null,eu=null,iu=null,su=null;const ru=[[new z(0,0,-1),new z(0,-1,0),new z(1,0,0)],[new z(0,0,1),new z(0,-1,0),new z(-1,0,0)],[new z(1,0,0),new z(0,0,1),new z(0,1,0)],[new z(1,0,0),new z(0,0,-1),new z(0,-1,0)],[new z(1,0,0),new z(0,-1,0),new z(0,0,1)],[new z(-1,0,0),new z(0,-1,0),new z(0,0,-1)]];function au(t){const e=Sl().buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.up=t.vec3().uniform(0),this.right=t.vec3().uniform(0),this.front=t.vec3().uniform(0),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.direction=t.mul(t.mat3(this.up,this.right,this.front),t.vec3(this.$inputs.pos,1)),"webgpu"===t.getDevice().type&&(this.$builtins.position.y=t.neg(this.$builtins.position.y))})},fragment(e){this.u_panoramaTexture=e.tex2D().uniform(0),this.$outputs.outcolor=e.vec4(),e.func("dirToUV",[e.vec3("dir")],function(){this.$l.x=e.add(.5,e.div(e.atan2(this.dir.z,this.dir.x),2*Math.PI)),this.$l.y=e.div(e.acos(this.dir.y),Math.PI),this.$return(e.vec2(this.x,this.y))}),e.main(function(){this.$l.uv=this.dirToUV(e.normalize(this.$inputs.direction)),this.$l.color=e.textureSampleLevel(this.u_panoramaTexture,this.uv,0),t?(this.$l.rgb=e.mul(this.color.rgb,this.color.a,6),this.rgb=function(t,e){const i=t.$builder,s="Z_gammaToLinear";return i.func(s,[i.vec3("color")],function(){this.$return(i.mul(this.color,i.add(i.mul(this.color,i.add(i.mul(this.color,.305306011),i.vec3(.682171111))),i.vec3(.012522878))))}),i.getGlobalScope()[s](e)}(this,this.rgb),this.$outputs.outcolor=e.vec4(this.rgb,1)):this.$outputs.outcolor=e.vec4(this.color.rgb,1)})}});return e.name=t?"@PanoramaToCubemap_RGBM":"@PanoramaToCubemap",e}function nu(t,e){const i=Sl();Kl||function(){const t=Sl(),e=new Float32Array([1,1,-1,1,-1,-1,1,-1]),i=new Uint16Array([0,1,2,0,2,3]);Kl=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",e)}],indexBuffer:t.createIndexBuffer(i)}),Jl=t.createRenderStateSet(),Jl.useRasterizerState().setCullMode("none"),Jl.useDepthState().enableTest(!1).enableWrite(!1),tu=au(!1),eu=t.createBindGroup(tu.bindGroupLayouts[0]),iu=au(!0),su=t.createBindGroup(iu.bindGroupLayouts[0])}(),i.pushDeviceStates(),function(t,e){const i=Sl(),s="rgba8unorm"===t.format,r=s?iu:tu,a=s?su:eu,n=i.createFrameBuffer([e],null);i.pushDeviceStates(),i.setFramebuffer(n);for(let e=0;e<6;e++)n.setColorAttachmentCubeFace(0,e),i.setVertexLayout(Kl),i.setRenderStates(Jl),i.setProgram(r),i.setBindGroup(0,a),a.setValue("up",ru[e][0]),a.setValue("right",ru[e][1]),a.setValue("front",ru[e][2]),a.setTexture("u_panoramaTexture",t),i.draw("triangle-list",0,6);i.popDeviceStates()}(t,e),i.popDeviceStates()}class ou extends gt{static _programInst=null;static _bindGroupInst=null;static _renderStats=null;_primitive;_renderTarget;_numSamples;constructor(t=1e4){super(),this._numSamples=t,this._primitive=new wt,this._renderTarget=new wt}projectCubemap(t,e,i=!0){this.projectCubemapToTexture(t,this._renderTarget.get(),i),this._renderTarget.get().getColorAttachments()[0].readPixelsToBuffer(0,0,3,3,0,0,e)}projectCubemapToTexture(t,e,i=!0){const s=Sl(),r=new O(0,0,0,1);this.init(s),s.pushDeviceStates(),s.setRenderStates(ou._renderStats),s.setProgram(ou._programInst),s.setFramebuffer(e),s.clearFrameBuffer(r,null,null);const a=ou._bindGroupInst;a.setTexture("cubemap",t,Gl("clamp_linear_nomip")),a.setValue("scale",i?1:Math.PI),s.setBindGroup(0,a),this._primitive.get().drawInstanced(9),s.popDeviceStates()}onDispose(){super.onDispose(),this._primitive.dispose(),this._renderTarget.get()&&(this._renderTarget.get().getColorAttachments()[0].dispose(),this._renderTarget.dispose())}init(t){if(!this._primitive.get()){const e=new Float32Array(4*this._numSamples);for(let t=0;t<this._numSamples;t++){let i,s,r;do{i=2*Math.random()-1,s=2*Math.random()-1,r=i*i+s*s}while(r>=1);const a=Math.sqrt(1-r);e[4*t+0]=2*i*a,e[4*t+1]=2*s*a,e[4*t+2]=1-2*r,e[4*t+3]=4*Math.PI/this._numSamples}const i=new Cl;i.createAndSetVertexBuffer("position_f32x4",e),"webgl"===t.type&&i.createAndSetVertexBuffer("tex0_f32",new Float32Array([0,1,2,3,4,5,6,7,8]),"instance"),i.indexCount=this._numSamples,i.indexStart=0,i.primitiveType="point-list",this._primitive.set(i)}if(!this._renderTarget.get()){const e=t.createTexture2D("rgba32f",3,3,{mipmapping:!1});this._renderTarget.set(t.createFrameBuffer([e],null))}ou._renderStats||(ou._renderStats=t.createRenderStateSet(),ou._renderStats.useDepthState().enableTest(!1).enableWrite(!1),ou._renderStats.useBlendingState().enable(!0).setBlendEquation("add","add").setBlendFuncRGB("one","one").setBlendFuncAlpha("zero","one"),ou._renderStats.useRasterizerState().setCullMode("none")),ou._programInst||(ou._programInst=ou._createProgram(t),ou._bindGroupInst=t.createBindGroup(ou._programInst.bindGroupLayouts[0]))}static _createProgram(t){const e=t.buildRenderProgram({vertex(e){this.$inputs.directionWeight=e.vec4().attrib("position"),"webgl"===t.type&&(this.$inputs.instanceId=e.float().attrib("texCoord0")),e.main(function(){this.$outputs.direction=this.$inputs.directionWeight.xyz,this.$outputs.weight=this.$inputs.directionWeight.w,"webgpu"!==e.getDevice().type&&(this.$builtins.pointSize=1),this.$outputs.shIndex="webgl"===t.type?this.$inputs.instanceId:e.int(this.$builtins.instanceIndex),this.$l.x=e.mod(this.$outputs.shIndex,3),this.$l.y=e.div(this.$outputs.shIndex,3),this.$l.ndcX=e.sub(e.div(e.add(e.float(this.x),.5),1.5),1),this.$l.ndcY=e.sub(e.div(e.add(e.float(this.y),.5),1.5),1),this.$l.$builtins.position=e.vec4(this.ndcX,this.ndcY,0,1),"webgpu"===e.getDevice().type&&(this.$builtins.position=e.mul(this.$builtins.position,e.vec4(1,-1,1,1)))})},fragment(t){this.$outputs.color=t.vec4(),this.cubemap=t.texCube().uniform(0),this.scale=t.float().uniform(0),t.func("cosineLobeBandFactor",[t.int("l")],function(){this.$if(t.equal(this.l,0),function(){this.$return(t.float(1))}),this.$if(t.lessThanEqual(this.l,3),function(){this.$return(2/3)}),this.$return(1/4)}),t.func("Y0",[t.vec3("v")],function(){this.$return(.282094791773878)}),t.func("Y1",[t.vec3("v")],function(){this.$return(t.mul(this.v.y,-.4886025119))}),t.func("Y2",[t.vec3("v")],function(){this.$return(t.mul(this.v.z,.4886025119))}),t.func("Y3",[t.vec3("v")],function(){this.$return(t.mul(this.v.x,-.4886025119))}),t.func("Y4",[t.vec3("v")],function(){this.$return(t.mul(this.v.x,this.v.y,1.0925484306))}),t.func("Y5",[t.vec3("v")],function(){this.$return(t.mul(this.v.y,this.v.z,-1.0925484306))}),t.func("Y6",[t.vec3("v")],function(){this.$return(t.mul(t.sub(t.mul(this.v.z,this.v.z,3),1),.3153915652))}),t.func("Y7",[t.vec3("v")],function(){this.$return(t.mul(this.v.x,this.v.z,-1.0925484306))}),t.func("Y8",[t.vec3("v")],function(){this.$return(t.mul(t.sub(t.mul(this.v.x,this.v.x),t.mul(this.v.y,this.v.y)),.5462742153))}),t.func("evalBasis",[t.vec3("dir"),t.int("c")],function(){this.$if(t.equal(this.c,0),function(){this.$return(this.Y0(this.dir))}).$elseif(t.equal(this.c,1),function(){this.$return(this.Y1(this.dir))}).$elseif(t.equal(this.c,2),function(){this.$return(this.Y2(this.dir))}).$elseif(t.equal(this.c,3),function(){this.$return(this.Y3(this.dir))}).$elseif(t.equal(this.c,4),function(){this.$return(this.Y4(this.dir))}).$elseif(t.equal(this.c,5),function(){this.$return(this.Y5(this.dir))}).$elseif(t.equal(this.c,6),function(){this.$return(this.Y6(this.dir))}).$elseif(t.equal(this.c,7),function(){this.$return(this.Y7(this.dir))}).$elseif(t.equal(this.c,8),function(){this.$return(this.Y8(this.dir))}).$else(function(){this.$return(0)})}),t.main(function(){this.$l.radiance=t.textureSampleLevel(this.cubemap,this.$inputs.direction,0).rgb,this.$l.bandFactor=this.cosineLobeBandFactor("webgl"===t.getDevice().type?t.int(this.$inputs.shIndex):this.$inputs.shIndex),this.$l.sh=this.evalBasis(this.$inputs.direction,"webgl"===t.getDevice().type?t.int(this.$inputs.shIndex):this.$inputs.shIndex),this.$outputs.color=t.vec4(t.mul(this.radiance,this.sh,this.$inputs.weight,this.bandFactor,this.scale),1)})}});return e.name="@CubemapSHProjector_SHProject",e}}class hu extends q{constructor(t,e){super(t,e)}behindPlane(t){return this.toAABB().behindPlane(t)}clone(){return new hu(this)}transform(t){return new hu(q.transform(this,t))}outsideFrustum(t){return(t instanceof Q?this.getClipStateWithFrustum(t):this.getClipState(t))===$.NOT_CLIPPED}toAABB(){return this}}class lu extends gt{_name;_animationSet;_embedded;_duration;_autoPlay;_tracks;_weight;_skeletons;constructor(t,e,i=!1){super(),this._name=t,this._animationSet=e,this._embedded=i,this._tracks=new Map,this._duration=0,this._weight=1,this._autoPlay=!1,this._skeletons=new Set}get embedded(){return this._embedded}get animationSet(){return this._animationSet}get weight(){return this._weight}set weight(t){this._weight=t}get autoPlay(){return this._autoPlay}set autoPlay(t){this._autoPlay=t}get name(){return this._name}get tracks(){return this._tracks}get skeletons(){return this._skeletons}set skeletons(t){this._skeletons=t}get timeDuration(){return this._duration}set timeDuration(t){this._duration=t}addSkeleton(t){this._skeletons.add(t)}deleteTrack(t){t?.animation!==this&&console.error("Cannot delete animation track which is not belongs to THIS animation");for(const e of this._tracks.keys()){const i=this._tracks.get(e),s=i.indexOf(t);s>=0&&i.splice(s,1)}return this}addTrack(t,e){if(!e)return;if(e.animation)return e.animation===this?void 0:void console.error("Track is already in another animation");const i=e.getBlendId(),s=this._tracks.get(t);if(s&&s.findIndex(t=>t.getBlendId()===i)>=0)return void console.error("Tracks with same BlendId could not be added to same animation");e.animation=this;let r=this._tracks.get(t);return r||(r=[],this._tracks.set(t,r)),r.push(e),this._duration=Math.max(this._duration,e.getDuration()??0),e.reset(t),this}resample(t,e){for(let i=0;i<=t;i++){const t=i/this.timeDuration;for(const[e,i]of this.tracks)for(const s of i){const i=s.calculateState(e,t);s.applyState(e,i)}for(const t of this.skeletons){const e=this._animationSet.model.findSkeletonById(t);e&&e.computeJoints()}e(i)}}onDispose(){super.onDispose(),this._tracks=null,this._skeletons=null}}class uu extends gt{_model;_animations;_skeletons;_activeTracks;_activeSkeletons;_activeAnimations;constructor(t){super(),this._model=new St(t),this._animations={},this._activeTracks=new Map,this._activeSkeletons=new Map,this._activeAnimations=new Map,this._skeletons=[]}get model(){return this._model.get()}get numAnimations(){return Object.getOwnPropertyNames(this._animations).length}get skeletons(){return this._skeletons}get(t){return this._animations[t]??null}createAnimation(t,e=!1){if(!t||this._animations[t])return console.error("Animation must have unique name"),null;{const i=new lu(t,this,e);return this._animations[t]=i,this._model.get().scene.queueUpdateNode(this._model.get()),i}}deleteAnimation(t){const e=this._animations[t];e&&(this.stopAnimation(t),delete this._animations[t],e.dispose())}getAnimationNames(){return Object.keys(this._animations)}update(t){this._activeAnimations.forEach((e,i)=>{if(e.fadeOut>0&&e.fadeOutStart<0&&(e.fadeOutStart=e.animateTime),e.firstFrame)e.firstFrame=!1;else{const s=t*e.speedRatio;e.currentTime+=s,e.animateTime+=s,e.currentTime>i.timeDuration?(e.repeatCounter++,e.currentTime=0):e.currentTime<0&&(e.repeatCounter++,e.currentTime=i.timeDuration),(0!==e.repeat&&e.repeatCounter>=e.repeat||e.fadeOut>0&&e.animateTime-e.fadeOutStart>=e.fadeOut)&&this.stopAnimation(i.name)}}),this._activeTracks.forEach((t,e)=>{t.forEach(t=>{const i=t.filter(t=>t.animation&&this.isPlayingAnimation(t.animation.name));if(i.length>0){const t=function(t,e,i){let s=t[0],r=e[0];for(let a=1;a<t.length;a++)s+=t[a],r=i(r,e[a],t[a]/s);return r}(i.map(t=>{const e=this._activeAnimations.get(t.animation),i=e.weight,s=0===e.fadeIn?1:Math.min(1,e.animateTime/e.fadeIn);let r=1;return 0!==e.fadeOut&&(r=1-(e.animateTime-e.fadeOutStart)/e.fadeOut),i*s*r}),i.map(t=>{const i=this._activeAnimations.get(t.animation).currentTime/t.animation.timeDuration*t.getDuration();return t.calculateState(e,i)}),(t,e,s)=>i[0].mixState(t,e,s));i[0].applyState(e,t)}})}),this._activeSkeletons.forEach((t,e)=>{e.apply()})}isPlayingAnimation(t){return t?this._activeAnimations.has(this._animations[t]):this._activeAnimations.size>0}getAnimationClip(t){return this._animations[t]??null}setAnimationWeight(t,e){const i=this._animations[t],s=this._activeAnimations.get(i);s&&(s.weight=e)}playAnimation(t,e){const i=this._animations[t];if(!i)return void console.error(`Animation ${t} not exists`);const s=Math.max(e?.fadeIn??0,0),r=this._activeAnimations.get(i);if(r)r.fadeOut=0,r.fadeIn=s;else{const t=e?.repeat??0,r=e?.speedRatio??1,a=e?.weight??i.weight??1;this._activeAnimations.set(i,{repeat:t,weight:a,speedRatio:r,fadeIn:s,fadeOut:0,repeatCounter:0,currentTime:r<0?i.timeDuration:0,animateTime:0,fadeOutStart:0,firstFrame:!0}),i.tracks?.forEach((t,e)=>{let i=this._activeTracks.get(e);i||(i=new Map,this._activeTracks.set(e,i));for(const e of t){const t=e.getBlendId();let s=i.get(t);s||(s=[],i.set(t,s)),s.push(e)}}),i.skeletons?.forEach((t,e)=>{const i=this.model.findSkeletonById(e);if(i){const t=this._activeSkeletons.get(i);t?this._activeSkeletons.set(i,t+1):this._activeSkeletons.set(i,1),i.playing=!0}})}}stopAnimation(t,e){const i=this._animations[t],s=this._activeAnimations.get(i);if(s){const t=Math.max(e?.fadeOut??0,0);0!==t?(s.fadeOut=t,s.fadeOutStart=-1):(this._activeAnimations.delete(i),this._activeTracks.forEach(t=>{t.forEach((e,s)=>{t.set(s,e.filter(t=>t.animation!==i))})}),i.skeletons?.forEach((t,e)=>{const i=this.model.findSkeletonById(e);if(i){const t=this._activeSkeletons.get(i);1===t?(i.reset(),this._activeSkeletons.delete(i)):this._activeSkeletons.set(i,t-1)}}))}}onDispose(){super.onDispose(),this._model?.dispose(),this._model=null;for(const t in this._animations)this._animations[t].dispose();this._animations={},this._activeAnimations.clear(),this._activeSkeletons.clear(),this._activeTracks.clear()}}class cu{_name;_embedded;_animation;_target;_jointIndex;constructor(t){this._name="noname",this._embedded=!!t,this._target="",this._jointIndex=-1}get name(){return this._name}set name(t){this._name=t}get embedded(){return this._embedded}get animation(){return this._animation}set animation(t){this._animation=t}get target(){return this._target}set target(t){this._target=t}get jointIndex(){return this._jointIndex}set jointIndex(t){this._jointIndex=t}reset(t){}}const du=new z;class pu extends cu{_state;_interpolator;constructor(t,e,i){if(void 0===t)super(!1),this._interpolator=null;else if(t instanceof ot){if("vec3"!==t.target)throw new Error("EulerRotationTrack(): interpolator target must be 'vec3'");super(e??!1),this._interpolator=t}else{const s=e,r=new Float32Array(s.map(t=>t.time)),a=new Float32Array(3*s.length);for(let t=0;t<s.length;t++)a[3*t+0]=s[t].value.x,a[3*t+1]=s[t].value.y,a[3*t+2]=s[t].value.z;super(i??!1),this._interpolator=new ot(t,"vec3",r,a)}this._state=new U}get interpolator(){return this._interpolator}set interpolator(t){if(t&&"vec3"!==t.target)throw new Error("EulerRotationTrack(): interpolator target must be 'vec3'");this._interpolator=t??null}calculateState(t,e){return this._interpolator.interpolate(e,du),this._state.fromEulerAngle(du.x,du.y,du.z),this._state}applyState(t,e){t.rotation.set(e)}mixState(t,e,i){return U.slerp(t,e,i)}getBlendId(){return"node-rotation"}getDuration(){return this._interpolator.maxTime}}const mu="LUT_Sheen",fu=255,_u=256;var gu=function(t){return t[t.MORPH_ANIMATION=1]="MORPH_ANIMATION",t[t.SKIN_ANIMATION=2]="SKIN_ANIMATION",t[t.INSTANCING=4]="INSTANCING",t[t.SSR_STORE_ROUGHNESS=8]="SSR_STORE_ROUGHNESS",t[t.APPLY_FOG=16]="APPLY_FOG",t}({});const xu=[new z(-.7838,-.620933,.00996137),new z(.106751,.965982,.235549),new z(-.215177,-.687115,-.693954),new z(.318002,.0640084,-.945927),new z(.357396,.555673,.750664),new z(.866397,-.19756,.458613),new z(.130216,.232736,-.963783),new z(-.00174431,.376657,.926351),new z(.663478,.704806,-.251089),new z(.0327851,.110534,-.993331),new z(.0561973,.0234288,.998145),new z(.0905264,-.169771,.981317),new z(.26694,.95222,-.148393),new z(-.812874,-.559051,-.163393),new z(-.323378,-.25855,-.910263),new z(-.1333,.591356,-.795317),new z(.480876,.408711,.775702),new z(-.332263,-.533895,-.777533),new z(-.0392473,-.704457,-.708661),new z(.427015,.239811,.871865),new z(-.416624,-.563856,.713085),new z(.12793,.334479,-.933679),new z(-.0343373,-.160593,-.986423),new z(.580614,.0692947,.811225),new z(-.459187,.43944,.772036),new z(.215474,-.539436,-.81399),new z(-.378969,-.31988,-.868366),new z(-.279978,-.0109692,.959944),new z(.692547,.690058,.210234),new z(.53227,-.123044,-.837585),new z(-.772313,-.283334,-.568555),new z(-.0311218,.995988,-.0838977),new z(-.366931,-.276531,-.888196),new z(.488778,.367878,-.791051),new z(-.885561,-.453445,.100842),new z(.71656,.443635,.538265),new z(.645383,-.152576,-.748466),new z(-.171259,.91907,.354939),new z(-.0031122,.9457,.325026),new z(.731503,.623089,-.276881),new z(-.91466,.186904,.358419),new z(.15595,.828193,-.538309),new z(.175396,.584732,.792038),new z(-.0838381,-.943461,.320707),new z(.305876,.727604,.614029),new z(.754642,-.197903,-.62558),new z(.217255,-.0177771,-.975953),new z(.140412,-.844826,.516287),new z(-.549042,.574859,-.606705),new z(.570057,.17459,.802841),new z(-.0330304,.775077,.631003),new z(-.938091,.138937,.317304),new z(.483197,-.726405,-.48873),new z(.485263,.52926,.695991),new z(.224189,.742282,-.631472),new z(-.322429,.662214,-.676396),new z(.625577,-.12711,.769738),new z(-.714032,-.584461,-.385439),new z(-.0652053,-.892579,-.446151),new z(.408421,-.912487,.0236566),new z(.0900381,.319983,.943135),new z(-.708553,.483646,.513847),new z(.803855,-.0902273,.587942),new z(-.0555802,-.374602,-.925519)];var bu=function(t){return t[t.FOG_TYPE_NONE=0]="FOG_TYPE_NONE",t[t.FOG_TYPE_HEIGHT=4]="FOG_TYPE_HEIGHT",t}({});const vu=new z,yu=new z,Tu=new z,wu=new z;class Su extends gt{static _registry=new Map;_id;_joints;_inverseBindMatrices;_bindPoseMatrices;_jointMatrices;_jointTransforms;_jointOffsets;_jointMatrixArray;_jointTexture;_playing;constructor(t,e,i,s){if(super(),this._id=r(),this._joints=t,this._inverseBindMatrices=e,this._bindPoseMatrices=i,this._jointMatrixArray=null,this._jointMatrices=null,this._jointOffsets=null,this._jointTexture=new wt,this._playing=!1,s){this._jointTransforms=s;for(let t=0;t<s.length;t++)this._joints[t].scale=s[t].scale,this._joints[t].rotation=s[t].rotation,this._joints[t].position=s[t].position}else this._jointTransforms=this._joints.map(t=>({scale:t.scale.clone(),rotation:t.rotation.clone(),position:t.position.clone()}));this.updateJointMatrices(),Su._registry.set(this._id,new St(this))}static findSkeletonById(t){const e=this._registry.get(t);return e&&!e.get()?(this._registry.delete(t),null):e?e.get():null}get joints(){return this._joints}get jointTransforms(){return this._jointTransforms}get inverseBindMatrices(){return this._inverseBindMatrices}get bindPoseMatrices(){return this._bindPoseMatrices}get playing(){return this._playing}set playing(t){this._playing=t}get persistentId(){return this._id}set persistentId(t){if(t!==this._id){const e=Su._registry.get(this._id);if(!e||e.get()!==this)throw new Error("Registry skeleton mismatch");Su._registry.delete(this._id),this._id=t,Su._registry.set(this._id,e)}}get jointTexture(){return this._jointTexture.get()}updateJointMatrices(t,e){this._jointTexture.get()||this._createJointTexture(),0===this._jointOffsets[0]?(this._jointOffsets[0]=1,this._jointOffsets[1]=1):(this._jointOffsets[1]=this._jointOffsets[0],this._jointOffsets[0]=this._joints.length-this._jointOffsets[0]+2);for(let i=0;i<this._joints.length;i++){const s=this._jointMatrices[i+this._jointOffsets[0]-1],r=t?t[i]:this._joints[i].worldMatrix;e&&W.multiplyAffine(e,r,r),W.multiply(r,this._inverseBindMatrices[i],s)}}computeBindPose(t){this.updateJointMatrices(this._bindPoseMatrices,t.worldMatrix),this._jointOffsets[1]=this._jointOffsets[0];const e=this._jointTexture.get();e.update(this._jointMatrixArray,0,0,e.width,e.height)}computeJoints(){this.updateJointMatrices();const t=this._jointTexture.get();t.update(this._jointMatrixArray,0,0,t.width,t.height)}apply(){this.computeJoints()}reset(){this.updateJointMatrices(this._bindPoseMatrices),this._playing=!1}computeBoundingBox(t,e){t.boundingBox.beginExtend();for(let i=0;i<t.boundingVertices.length;i++)this._jointMatrices[t.boundingVertexBlendIndices[4*i+0]+this._jointOffsets[0]-1].transformPointAffine(t.boundingVertices[i],vu).scaleBy(t.boundingVertexJointWeights[4*i+0]),this._jointMatrices[t.boundingVertexBlendIndices[4*i+1]+this._jointOffsets[0]-1].transformPointAffine(t.boundingVertices[i],yu).scaleBy(t.boundingVertexJointWeights[4*i+1]),this._jointMatrices[t.boundingVertexBlendIndices[4*i+2]+this._jointOffsets[0]-1].transformPointAffine(t.boundingVertices[i],Tu).scaleBy(t.boundingVertexJointWeights[4*i+2]),this._jointMatrices[t.boundingVertexBlendIndices[4*i+3]+this._jointOffsets[0]-1].transformPointAffine(t.boundingVertices[i],wu).scaleBy(t.boundingVertexJointWeights[4*i+3]),vu.addBy(yu).addBy(Tu).addBy(wu),e.transformPointAffine(vu,vu),t.boundingBox.extend(vu)}onDispose(){super.onDispose(),this._jointTexture.dispose(),this._joints=null,this._inverseBindMatrices=null,this._bindPoseMatrices=null,this._jointMatrices=null,this._jointMatrixArray=null;const t=Su._registry.get(this._id);t?.get()===this&&(Su._registry.delete(this._id),t.dispose())}_createJointTexture(){const t=M(Math.max(4,Math.ceil(Math.sqrt(4*(2*this._joints.length+1))))),e=Sl();this._jointTexture.set(e.createTexture2D("rgba32f",t,t,{mipmapping:!1,samplerOptions:{magFilter:"nearest",minFilter:"nearest"}})),this._jointMatrixArray=new Float32Array(t*t*4);const i=this._jointMatrixArray.buffer;this._jointOffsets=new Float32Array(i),this._jointOffsets[0]=0,this._jointOffsets[1]=0,this._jointMatrices=Array.from({length:2*this._joints.length}).map((t,e)=>new W(i,16*(e+1)*Float32Array.BYTES_PER_ELEMENT))}getBoundingInfo(t){const e=[0,0,0,0,0,0];let i=Number.MAX_VALUE,s=-Number.MAX_VALUE,r=Number.MAX_VALUE,a=-Number.MAX_VALUE,n=Number.MAX_VALUE,o=-Number.MAX_VALUE;const h=t.positions,l=new z,u=new z,c=new z,d=new z,p=new z,m=Math.floor(h.length/3);for(let f=0;f<m;f++)l.setXYZ(h[3*f],h[3*f+1],h[3*f+2]),this._jointMatrices[t.blendIndices[4*f+0]+this._jointOffsets[0]-1].transformPointAffine(l,u).scaleBy(t.weights[4*f+0]),this._jointMatrices[t.blendIndices[4*f+1]+this._jointOffsets[0]-1].transformPointAffine(l,c).scaleBy(t.weights[4*f+1]),this._jointMatrices[t.blendIndices[4*f+2]+this._jointOffsets[0]-1].transformPointAffine(l,d).scaleBy(t.weights[4*f+2]),this._jointMatrices[t.blendIndices[4*f+3]+this._jointOffsets[0]-1].transformPointAffine(l,p).scaleBy(t.weights[4*f+3]),u.addBy(c).addBy(d).addBy(p),u.x<i&&(i=u.x,e[0]=f),u.x>s&&(s=u.x,e[1]=f),u.y<r&&(r=u.y,e[2]=f),u.y>a&&(a=u.y,e[3]=f),u.z<n&&(n=u.z,e[4]=f),u.z>o&&(o=u.z,e[5]=f);return{boundingVertexBlendIndices:new Float32Array(Array.from({length:24}).map((i,s)=>t.blendIndices[4*e[s>>2]+s%4])),boundingVertexJointWeights:new Float32Array(Array.from({length:24}).map((i,s)=>t.weights[4*e[s>>2]+s%4])),boundingVertices:Array.from({length:6}).map((i,s)=>new z(t.positions[3*e[s]],t.positions[3*e[s]+1],t.positions[3*e[s]+2])),boundingBox:new hu}}}class Au extends(v(gt)()){static _runTimeId=1;static BBOXDRAW_INHERITED=-1;static BBOXDRAW_DISABLED=0;static BBOXDRAW_LOCAL=1;static BBOXDRAW_WORLD=2;_runtimeId;_id;_prefabId;_animationSet;_sharedModel;_jointTypeT;_jointTypeS;_jointTypeR;_clipMode;_boxDrawMode;_visible;_pickable;_gpuPickable;_name;_scene;_bv;_bvDirty;_bvWorld;_placeToOctree;_sealed;_parent;_children;_position;_scaling;_rotation;_localMatrix;_worldMatrix;_worldMatrixDet;_invWorldMatrix;_tmpLocalMatrix;_tmpWorldMatrix;_transformTag;_transformChangeCallback;_metaData;_disableCallback;_script;constructor(t){super(),this._runtimeId=Au._runTimeId++,this._id=r(),this._prefabId="",this._scene=t,this._name="",this._animationSet=new wt,this._sharedModel=new wt,this._jointTypeT="none",this._jointTypeS="none",this._jointTypeR="none",this._bv=null,this._bvWorld=null,this._bvDirty=!0,this._clipMode=!0,this._boxDrawMode=Au.BBOXDRAW_DISABLED,this._visible="inherit",this._pickable=!1,this._gpuPickable=!0,this._placeToOctree=!0,this._parent=null,this._sealed=!1,this._children=[],this._transformChangeCallback=()=>this._onTransformChanged(!0),this._position=new V(0,0,0),this._position.callback=this._transformChangeCallback,this._scaling=new V(1,1,1),this._scaling.callback=this._transformChangeCallback,this._rotation=new G,this._rotation.callback=this._transformChangeCallback,this._worldMatrix=null,this._worldMatrixDet=null,this._invWorldMatrix=null,this._localMatrix=null,this._transformTag=0,this._disableCallback=!1,this._tmpLocalMatrix=W.identity(),this._tmpWorldMatrix=W.identity(),this._script="",this._metaData=null,t&&this!==t.rootNode&&this.reparent(t.rootNode)}get placeToOctree(){return this._placeToOctree}set placeToOctree(t){!!t!==this._placeToOctree&&(this._placeToOctree=!!t,this.isGraphNode()&&this.scene?.invalidateNodePlacement(this))}get runtimeId(){return this._runtimeId}get persistentId(){return this._id}set persistentId(t){this._id=t}get prefabId(){return this._prefabId}set prefabId(t){this._prefabId=t}getPrefabNode(){return this._prefabId?this:this.parent?.getPrefabNode()??null}get jointTypeT(){return this._jointTypeT}set jointTypeT(t){this._jointTypeT=t}get jointTypeS(){return this._jointTypeS}set jointTypeS(t){this._jointTypeS=t}get jointTypeR(){return this._jointTypeR}set jointTypeR(t){this._jointTypeR=t}get metaData(){return this._metaData}set metaData(t){this._metaData=t}get script(){return this._script}set script(t){this._script=t??""}get name(){return this._name}set name(t){this._name=t||""}get scene(){return this._scene}get attached(){let t=this;for(;t&&t!==this._scene.rootNode;)t=t.parent;return t===this._scene.rootNode}get sealed(){return this._sealed}set sealed(t){this._sealed=t}get animationSet(){return this._animationSet.get()||(this._animationSet.set(new uu(this)),this.scene.queueUpdateNode(this)),this._animationSet.get()}get sharedModel(){return this._sharedModel.get()}set sharedModel(t){this._sharedModel.set(t)}async clone(){this.iterate(t=>{if(t.isTerrain()||t.isClipmapTerrain())throw new Error("Cloning terrain node is not allowed")});const t=this.parent,e=new Au(this.scene),i=await wl().resourceManager.serializeObject(this),s=await wl().resourceManager.deserializeObject(e,i);s.persistentId=r(),s.parent=t,e.dispose();const a=[];return s.iterate(t=>{const e=t.onPostClone();e instanceof Promise&&a.push(e)}),a.length>0&&await Promise.all(a),s}hasChild(t){return t&&t.parent===this}removeChildren(){for(;this._children.length;)this._children[0].get().remove()}isParentOf(t){for(;t&&t!==this;)t=t.parent;return t===this}remove(){return this.parent=null,this}traverse(t){t.visit(this);for(const e of this._children)e.get().traverse(t)}iterate(t){if(t(this))return!0;for(const e of this._children)if(e.get().iterate(t))return!0;return!1}iterateBottomToTop(t){for(let e=this._children.length-1;e>=0;e--){if(this._children[e].get().iterateBottomToTop(t))return!0}return!!t(this)}isGraphNode(){return!1}isLight(){return!1}isMesh(){return!1}isWater(){return!1}isParticleSystem(){return!1}isBatchGroup(){return!1}isTerrain(){return!1}isClipmapTerrain(){return!1}isCamera(){return!1}isPunctualLight(){return!1}computeBoundingVolume(){return null}getBoundingVolume(){return this._bvDirty&&(this._bv=this.computeBoundingVolume(),this._bvDirty=!1),this._bv}setBoundingVolume(t){t!==this._bv&&(this._bv=t,this._bvDirty=!this._bv,this.invalidateWorldBoundingVolume(!1))}getWorldBoundingVolume(){return this._bvWorld||(this._bvWorld=this.computeWorldBoundingVolume(this.getBoundingVolume())),this._bvWorld}computeWorldBoundingVolume(t){return t?.transform(this.worldMatrix)??null}invalidateBoundingVolume(){this._bvDirty=!0,this.invalidateWorldBoundingVolume(!1)}invalidateWorldBoundingVolume(t){this._bvWorld=null,this._scene&&(t?this.iterate(t=>{t.isGraphNode()&&this._scene.invalidateNodePlacement(t)}):this.isGraphNode()&&this._scene.invalidateNodePlacement(this),this.dispatchEvent("bvchanged",this))}get clipTestEnabled(){return this._clipMode}set clipTestEnabled(t){this._clipMode=t}get hidden(){let t=this;for(;t&&"inherit"===t._visible;)t=t.parent;return!!t&&"hidden"===t._visible}get showState(){return this._visible}set showState(t){if(t!==this._visible){const e=this.hidden;if(this._visible=t,e!==this.hidden){this.isGraphNode()&&this._scene?.invalidateNodePlacement(this);let t=this;for(;t;)t.dispatchEvent("visiblechanged",this),t=t.parent;this.notifyHiddenChanged()}}}get pickable(){return this._pickable}set pickable(t){this._pickable=!!t}get gpuPickable(){return this._gpuPickable}set gpuPickable(t){this._gpuPickable=!!t}findNodeById(t){let e=null;return this.iterate(i=>{if(i.persistentId===t)return e=i,!0}),e}findSkeletonById(t){const e=this.getPrefabNode()??this;let i=null;return e.iterate(e=>(i=e.animationSet.skeletons.find(e=>e.get().persistentId===t),!!i)),i?.get()??null}findNodeByName(t){let e=null;return this.iterate(i=>{if(i.name===t)return e=i,!0}),e}get computedBoundingBoxDrawMode(){if(this._boxDrawMode===Au.BBOXDRAW_INHERITED){let t=this.parent;for(;t&&!t.isGraphNode();)t=t.parent;return t?.computedBoundingBoxDrawMode??Au.BBOXDRAW_DISABLED}return this._boxDrawMode}get boundingBoxDrawMode(){return this._boxDrawMode}set boundingBoxDrawMode(t){this._boxDrawMode=t}onPostClone(){}onDispose(){super.onDispose(),this.remove(),this.removeChildren(),this._animationSet?.dispose(),this._animationSet=null,this._sharedModel?.dispose(),this._sharedModel=null}_setParent(t){if(t&&t._scene!==this._scene)throw new Error("Parent node and child node must belongs to the same scene");let e=this._parent,i=t;if(i!==e){const s=(!t||!t.attached)&&this.attached,r=!this.attached&&t&&t.attached;if(i&&i._children.push(new wt(this)),this._parent){const t=this._parent._children.findIndex(t=>t.get()===this);this._parent.children[t].dispose(),this._parent._children.splice(t,1)}for(this._parent=t,this._onTransformChanged(!1),s&&this._detached(),r&&this._attached();e;)e.dispatchEvent("noderemoved",this),e=e.parent;for(;i;)i.dispatchEvent("nodeattached",this),i=i.parent}}_onTransformChanged(t){if(!this._disableCallback){t&&(this._localMatrix=null),this._worldMatrix=null,this._invWorldMatrix=null,this._worldMatrixDet=null,this._transformTag++;for(const t of this._children)t.get()._onTransformChanged(!1);this.invalidateWorldBoundingVolume(!0),this.dispatchEvent("transformchanged",this)}}_onAttached(){}_onDetached(){}_attached(){this.iterate(t=>{this.scene.queueUpdateNode(t),t._onAttached()})}_detached(){this.iterate(t=>{t._onDetached()})}notifyHiddenChanged(){this._visibleChanged();for(const t of this._children)"inherit"===t.get().showState&&t.get().notifyHiddenChanged()}_visibleChanged(){}get parent(){return this._parent}set parent(t){(t=t||null)!==this._parent&&this._setParent(t)}get children(){return this._children}get position(){return this._position}set position(t){this._position.setXYZ(t[0],t[1],t[2])}get scale(){return this._scaling}set scale(t){this._scaling.setXYZ(t[0],t[1],t[2])}get rotation(){return this._rotation}set rotation(t){this._rotation.setXYZW(t[0],t[1],t[2],t[3])}worldToThis(t,e){return t instanceof z?(e=e||new z,this.invWorldMatrix.transformPointAffine(t,e),e):(e=e||new O,this.invWorldMatrix.transformAffine(t,e),e)}otherToThis(t,e,i){return this.worldToThis(t.thisToWorld(e,i),i)}thisToWorld(t,e){return t instanceof z?(e=e||new z,this.worldMatrix.transformPointAffine(t,e),e):(e=e||new O,this.worldMatrix.transformAffine(t,e),e)}thisToOther(t,e,i){return t.worldToThis(this.thisToWorld(e,i),i)}getWorldPosition(t){return t?.setXYZ(this.worldMatrix.m03,this.worldMatrix.m13,this.worldMatrix.m23)??new z(this.worldMatrix.m03,this.worldMatrix.m13,this.worldMatrix.m23)}moveBy(t){return this._position.addBy(t),this}scaleBy(t){return this._scaling.mulBy(t),this}setLocalTransform(t){return this._disableCallback=!0,t.decompose(this._scaling,this._rotation,this._position),this._disableCallback=!1,this._onTransformChanged(!0),this}get localMatrix(){return this._localMatrix||(this.calculateLocalTransform(this._tmpLocalMatrix),this._localMatrix=this._tmpLocalMatrix),this._localMatrix}set localMatrix(t){this.setLocalTransform(t)}get worldMatrix(){return this._worldMatrix||(this._worldMatrix=this._tmpWorldMatrix,this.calculateWorldTransform(this._worldMatrix)),this._worldMatrix}get worldMatrixDet(){return null===this._worldMatrixDet&&(this._worldMatrixDet=this.worldMatrix.det()),this._worldMatrixDet}get invWorldMatrix(){return this._invWorldMatrix||(this._invWorldMatrix=W.invertAffine(this.worldMatrix)),this._invWorldMatrix}calculateLocalTransform(t){t.compose(this._scaling,this._rotation,this._position)}calculateWorldTransform(t){this._parent?W.multiplyAffine(this._parent.worldMatrix,this.localMatrix,t):t.set(this.localMatrix)}lookAt(t,e,i){return this.setLocalTransform(W.lookAt(t,e,i)),this}update(t,e,i){if(!this.attached)return;const s=this._animationSet.get();s&&(s.numAnimations>0||s.skeletons.length>0?(s.update(i),this.scene.queueUpdateNode(this)):this._animationSet.dispose())}updatePerCamera(t,e,i){}reparent(t){return this.parent=t,this}get transformTag(){return this._transformTag}}class Cu{_chunk;_position;_nodes;_box;_boxLoosed;constructor(){this._chunk=null,this._position=0,this._nodes=[],this._box=null,this._boxLoosed=null}getNodes(){return this._nodes}getLevel(){return this._chunk.getLevel()}addNode(t){t&&this._nodes.indexOf(t)<0&&(this._nodes.push(t),t.octreeNode=this)}removeNode(t){const e=this._nodes.indexOf(t);e>=0&&(this._nodes.splice(e,1),t.octreeNode=null)}clearNodes(){for(const t of this._nodes)t.octreeNode=null;this._nodes=[]}setChunk(t){e(!!t,"Invalid chunk"),this._chunk=t}getChunk(){return this._chunk}setPosition(t){this._position=t}getPosition(){return this._position}getBox(){if(null===this._box){const t=new q;t.beginExtend();for(let e=0;e<8;e++){const i=this.getChild(e);if(i){const e=i.getBox();e&&(t.extend(e.minPoint),t.extend(e.maxPoint))}}t.isValid()&&(this._box=t)}return this._box}getBoxLoosed(){if(null===this._boxLoosed){e(!!this._chunk,"Invalid chunk");const t=this._chunk.getDimension(),i=this._chunk.getNodeSize(),s=.5*this._chunk.getWorldSize(),r=this._position%t,a=Math.floor(this._position/t)%t,n=Math.floor(Math.floor(this._position/t)/t),o=new z(r-.5,a-.5,n-.5).scaleBy(i).subBy(new z(s,s,s)),h=new z(o.x+2*i,o.y+2*i,o.z+2*i);this._boxLoosed=new q(o,h)}return this._boxLoosed}getMinPoint(){e(!!this._chunk,"Invalid chunk");const t=this._chunk.getDimension(),i=this._chunk.getNodeSize(),s=.5*this._chunk.getWorldSize(),r=this._position%t,a=Math.floor(this._position/t)%t,n=Math.floor(Math.floor(this._position/t)/t);return new z(r,a,n).scaleBy(i).subBy(new z(s,s,s))}getMaxPoint(){e(!!this._chunk,"Invalid chunk");const t=this._chunk.getDimension(),i=this._chunk.getNodeSize(),s=.5*this._chunk.getWorldSize(),r=this._position%t+1,a=Math.floor(this._position/t)%t+1,n=Math.floor(Math.floor(this._position/t)/t)+1;return new z(r,a,n).scaleBy(i).subBy(new z(s,s,s))}getMinPointLoosed(){const t=.5*this._chunk.getNodeSize();return this.getMinPoint().subBy(new z(t,t,t))}getMaxPointLoosed(){const t=.5*this._chunk.getNodeSize();return this.getMaxPoint().addBy(new z(t,t,t))}getChild(t){e(!!this._chunk,"Invalid chunk");const i=this._chunk.getNext();return i?i.getNode(this._chunk.getChildIndex(this._position,t)):null}getOrCreateChild(t){e(!!this._chunk,"Invalid chunk");const i=this._chunk.getNext();return i?i.getOrCreateNode(this._chunk.getChildIndex(this._position,t)):null}getParent(){e(!!this._chunk,"Invalid chunk");const t=this._chunk.getPrev();return t?t.getNode(this._chunk.getParentIndex(this._position)):null}getOrCreateParent(){e(!!this._chunk,"Invalid chunk");const t=this._chunk.getPrev();return t?t.getOrCreateNode(this._chunk.getParentIndex(this._position)):null}createChildren(){this.getOrCreateChild(0),this.getOrCreateChild(1),this.getOrCreateChild(2),this.getOrCreateChild(3),this.getOrCreateChild(4),this.getOrCreateChild(5),this.getOrCreateChild(6),this.getOrCreateChild(7)}traverse(t){if(t.visit(this))for(let e=0;e<8;e++){const i=this.getChild(e);i&&i.traverse(t)}}}class Eu{_level;_dimension;_nodeSize;_prev;_next;_octree;_nodeMap;constructor(t){this._octree=t,this._level=0,this._dimension=0,this._nodeSize=0,this._next=null,this._prev=null,this._nodeMap=new Map}get nodeMap(){return this._nodeMap}getNode(t){return this._nodeMap.get(t)||null}getOrCreateNode(t){let e=this.getNode(t);return e||(e=new Cu,e.setChunk(this),e.setPosition(t),this._nodeMap.set(t,e)),e}getOrCreateNodeChain(t){const e=this.getOrCreateNode(t);return this._prev&&this._prev.getOrCreateNodeChain(this.getParentIndex(t)),e}clearNodes(){for(const t of this._nodeMap.keys())this._nodeMap.get(t).clearNodes(),this._nodeMap.delete(t)}getChildIndex(t,i){const s=this._dimension;let r=t%s*2,a=Math.floor(t/s)%s*2,n=2*Math.floor(Math.floor(t/s)/s);switch(i){case 0:++r,++a,++n;break;case 1:++r,++a;break;case 2:++r,++n;break;case 3:++r;break;case 4:++a,++n;break;case 5:++a;break;case 6:++n;break;case 7:break;default:return e(!1,"getChildIndex: Got invalid index"),0}const o=2*s;return n*o*o+a*o+r}getParentIndex(t){const e=this._dimension,i=e>>1;return(t%e>>1)+(Math.floor(t/e)%e>>1)*i+(Math.floor(Math.floor(t/e)/e)>>1)*i*i}getNodeSize(){return this._nodeSize}getWorldSize(){return this._octree.getRootSize()}getDimension(){return this._dimension}getLevel(){return this._level}empty(){return 0===this._nodeMap.size}getNext(){return this._next}getPrev(){return this._prev}getOctree(){return this._octree}setLevel(t){this._level=t}setDimension(t){this._dimension=t}setNodeSize(t){this._nodeSize=t}setNext(t){this._next=t}setPrev(t){this._prev=t}}class Mu{_scene;_chunks;_rootSize;_maxRootSize;_leafSize;_rootNode;_nodeMap;_nodes;constructor(t,e=8,i=8,s=65536){this._scene=t,this._chunks=[],this._rootSize=0,this._leafSize=0,this._rootNode=null,this._nodeMap=new WeakMap,this._nodes=new Set,this.initialize(e,i),this._maxRootSize=Math.max(s,this._rootSize)}initialize(t,e){this.finalize(),this._leafSize=e,this._rootSize=Math.max(e,t);let i=1;for(;t>=2*e;e*=2,++i);for(let e=0;e<i;++e,t*=.5){const i=new Eu(this);i.setLevel(e),i.setNodeSize(t),i.setDimension(1<<e),this._chunks.push(i),e>0&&(this._chunks[e-1].setNext(i),i.setPrev(this._chunks[e-1]))}}finalize(){this._chunks.forEach(t=>t.clearNodes()),this._chunks=[],this._rootSize=0,this._leafSize=0,this._rootNode=null,this._nodeMap=new WeakMap}getScene(){return this._scene}getRootSize(){return this._rootSize}getLeafSize(){return this._leafSize}locateNodeChain(t,e,i){let s=this._chunks.length-1;for(;s>=0&&this._chunks[s].getNodeSize()<4*i;)--s;if(s<0)return null;const r=this._chunks[s].getDimension(),a=1/this._chunks[s].getNodeSize(),n=Math.floor((e.x+.5*this._rootSize)*a),o=Math.floor((e.y+.5*this._rootSize)*a),h=Math.floor((e.z+.5*this._rootSize)*a);if(n>=r||n<0||o>=r||o<0||h>=r||h<0)return null;const l=n+o*r+h*r*r;return t&&t.getChunk().getLevel()===s&&t.getPosition()===l?t:this._chunks[s].getOrCreateNodeChain(l)}getRootNode(){return this._rootNode||(this._rootNode=this._chunks[0].getOrCreateNode(0)),this._rootNode}getNumChunks(){return this._chunks.length}getChunk(t){return this._chunks[t]}placeNode(t){const e=this._nodeMap.get(t)||null;let i=this.getRootNode();if(t.clipTestEnabled){const s=t.getWorldBoundingVolume()?.toAABB();if(s&&s.isValid()){const r=s.center,a=s.extents;let n=Math.min(Math.max(Math.max(a.x,a.y),a.z),this._maxRootSize);if(Number.isNaN(n)&&(n=this._maxRootSize),i=this.locateNodeChain(e,r,n),!i){let e=Math.min(Math.max(...z.abs(s.minPoint),...z.abs(s.maxPoint)),this._maxRootSize);Number.isNaN(e)&&(e=this._maxRootSize);const r=M(Math.ceil(Math.max(2*e,4*n)));if(r<=this._maxRootSize)return this.resize(r),void this.placeNode(t);i=this.getRootNode()}}}e!==i&&(e?.removeNode(t),i?.addNode(t),this._nodeMap.set(t,i)),this._nodes.add(t)}removeNode(t){if(t.isGraphNode()){const e=this._nodeMap.get(t)||null;e&&(e.removeNode(t),this._nodeMap.delete(t)),this._nodes.delete(t)}}prune(){if(1!==this._chunks.length){for(const t of this._chunks[1].nodeMap)if(t[1].getNodes().length>0)return;this.resize(this._leafSize)}}resize(t){if((t=Math.max(M(Math.ceil(t)),this._leafSize))===this._rootSize)return;const e=[];for(const t of this._chunks)t.nodeMap.forEach(t=>{e.push(...t.getNodes())});this.initialize(t,this._leafSize);for(const t of e)this.placeNode(t)}}const Bu=new z;class Iu{_ray;_rayLocal;_intersected;_intersectedDist;_intersectedPoint;constructor(t,e){this._ray=t,this._rayLocal=new et,this._intersected=null,this._intersectedDist=e,this._intersectedPoint=new z}get intersected(){return this._intersected}get intersectedDist(){return this._intersectedDist}get intersectedPoint(){return this._intersectedPoint}visit(t){return t instanceof Cu?this.visitOctreeNode(t):t.isMesh()?this.visitMesh(t):t.isTerrain()?this.visitTerrain(t):!!t.isWater()&&this.visitWater(t)}visitTerrain(t){if(!t.hidden&&t.pickable){this._ray.transform(t.invWorldMatrix,this._rayLocal);const e=t.rayIntersect(this._rayLocal);if(this.updateVisitResult(e,t))return this._intersectedDist=e,this._intersected={node:t},!0}return!1}visitWater(t){if(!t.hidden&&t.pickable){const e=t.getWorldBoundingVolume().toAABB(),i=this._ray.bboxIntersectionTestEx(e);if(this.updateVisitResult(i,t))return this._intersectedDist=i,this._intersected=t.getPickTarget(),!0}return!1}visitMesh(t){if(!t.hidden&&t.pickable){this._ray.transform(t.invWorldMatrix,this._rayLocal);const e=t.primitive.raycast(this._rayLocal);if(this.updateVisitResult(e,t))return this._intersected=t.getPickTarget(),!0}return!1}visitOctreeNode(t){if(0===t.getLevel()||null!==this._ray.bboxIntersectionTest(t.getBoxLoosed())){const e=t.getNodes();for(let t=0;t<e.length;t++)this.visit(e[t]);return!0}return!1}updateVisitResult(t,e){if(null!==t){z.combine(this._rayLocal.origin,this._rayLocal.direction,1,t,Bu),e.worldMatrix.transformPointAffine(Bu,Bu);const i=z.distance(Bu,this._ray.origin);if(i<this._intersectedDist)return this._intersectedDist=i,this._intersectedPoint.set(Bu),!0}return!1}}let Pu=null,$u=null;function Ru(t){const e=Sl();Pu||(Pu=e.createVertexLayout({vertexBuffers:[{buffer:e.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]})),$u||($u=e.createRenderStateSet(),$u.useRasterizerState().setCullMode("none"),$u.useDepthState().enableTest(!1).enableWrite(!1));const i=e.getRenderStates();e.setRenderStates(t??$u),e.setVertexLayout(Pu),e.draw("triangle-strip",0,4),e.setRenderStates(i)}const Fu=[5.802,13.558,33.1],Du=[.65,1.881,.085];function Nu(){return{plantRadius:636e4,atmosphereHeight:6e4,rayleighScatteringHeight:8e3,mieScatteringHeight:1200,mieAnstropy:.8,ozoneCenter:25e3,ozoneWidth:15e3,apDistance:4e3,cameraWorldMatrix:W.identity(),lightDir:new z(1,0,0),lightColor:new O(1,1,1,10),cameraAspect:1,cameraHeightScale:1}}const Lu=Nu();let zu,Vu,Ou,ku,Uu,Gu,Hu,Wu,Xu,ju,Qu,qu,Yu,Zu,Ku,Ju,tc,ec=null;function ic(t,e,i,s,r){const a=t.$builder,n="z_rayIntersectSphere";return a.func(n,[a.vec3("center"),a.float("radius"),a.vec3("rayStart"),a.vec3("rayDir")],function(){this.$l.OS=a.length(a.sub(this.center,this.rayStart)),this.$l.SH=a.dot(a.sub(this.center,this.rayStart),this.rayDir),this.$l.OH=a.sqrt(a.sub(a.mul(this.OS,this.OS),a.mul(this.SH,this.SH))),this.$l.PH=a.sqrt(a.sub(a.mul(this.radius,this.radius),a.mul(this.OH,this.OH))),this.$if(a.greaterThan(this.OH,this.radius),function(){this.$return(a.float(-1))}),this.$l.t1=a.sub(this.SH,this.PH),this.$l.t2=a.add(this.SH,this.PH),this.$return(this.$choice(a.lessThan(this.t1,0),this.t2,this.t1))}),t[n](e,i,s,r)}function sc(t,e,i,s,r){const a=t.$builder,n="z_transmittanceToSky",o=_c(a);return a.func(n,[o("params"),a.vec3("p"),a.vec3("dir")],function(){this.$l.bottomRadius=this.params.plantRadius,this.$l.topRadius=a.add(this.params.plantRadius,this.params.atmosphereHeight),this.$l.upVector=a.normalize(this.p),this.$l.cosTheta=a.dot(this.upVector,this.dir),this.$l.r=a.length(this.p),this.$l.uv=function(t,e,i,s,r){const a=t.$builder,n="z_transmittanceToUV";return a.func(n,[a.float("bottomRadius"),a.float("topRadius"),a.float("mu"),a.float("r")],function(){this.$l.H=a.sqrt(a.max(0,a.sub(a.mul(this.topRadius,this.topRadius),a.mul(this.bottomRadius,this.bottomRadius)))),this.$l.rho=a.sqrt(a.max(0,a.sub(a.mul(this.r,this.r),a.mul(this.bottomRadius,this.bottomRadius)))),this.$l.discriminant=a.add(a.mul(this.r,this.r,a.sub(a.mul(this.mu,this.mu),1)),a.mul(this.topRadius,this.topRadius)),this.$l.d=a.max(0,a.sub(a.sqrt(this.discriminant),a.mul(this.mu,this.r))),this.$l.d_min=a.sub(this.topRadius,this.r),this.$l.d_max=a.add(this.rho,this.H),this.$l.x_mu=a.div(a.sub(this.d,this.d_min),a.sub(this.d_max,this.d_min)),this.$l.x_r=a.div(this.rho,this.H),this.$return(a.vec2(this.x_mu,this.x_r))}),t[n](e,i,s,r)}(this,this.bottomRadius,this.topRadius,this.cosTheta,this.r),this.$return(a.textureSampleLevel(r,this.uv,0).rgb)}),t[n](e,i,s)}function rc(t,e,i){const s=t.$builder,r="z_rayleighCoefficient";return s.func(r,[s.float("rayleighScatteringHeight"),s.float("h")],function(){this.$l.sigma=s.mul(s.vec3(Fu[0],Fu[1],Fu[2]),1e-6),this.$l.rho_h=s.exp(s.neg(s.div(this.h,this.rayleighScatteringHeight))),this.$return(s.mul(this.sigma,this.rho_h))}),t[r](e,i)}function ac(t,e,i){const s=t.$builder,r="z_mieCoefficient";return s.func(r,[s.float("mieScatteringHeight"),s.float("h")],function(){this.$l.sigma=s.mul(s.vec3(3.996),1e-6),this.$l.rho_h=s.exp(s.neg(s.div(this.h,this.mieScatteringHeight))),this.$return(s.mul(this.sigma,this.rho_h))}),t[r](e,i)}function nc(t,e,i){const s=t.$builder,r="z_mieAbsorption";return s.func(r,[s.float("mieScatteringHeight"),s.float("h")],function(){this.$l.sigma=s.mul(s.vec3(4.4),1e-6),this.$l.rho_h=s.exp(s.neg(s.div(this.h,this.mieScatteringHeight))),this.$return(s.mul(this.sigma,this.rho_h))}),t[r](e,i)}function oc(t,e,i,s){const r=t.$builder,a="z_ozoneAbsorption";return r.func(a,[r.float("center"),r.float("width"),r.float("h")],function(){this.$l.sigma=r.mul(r.vec3(Du[0],Du[1],Du[2]),1e-6),this.$l.rho_h=r.max(0,r.sub(1,r.div(r.abs(r.sub(this.h,this.center)),this.width))),this.$return(r.mul(this.sigma,this.rho_h))}),t[a](e,i,s)}function hc(t,e,i,s,r,a,n,o=!0){const h=t.$builder,l=_c(h),u="z_getSkyView";return h.func(u,[l("params"),h.vec3("eyePos"),h.vec3("viewDir"),h.float("maxDis")],function(){this.$l.color=h.vec3(0),this.$l.dis=ic(this,h.vec3(0),h.add(this.params.plantRadius,this.params.atmosphereHeight),this.eyePos,this.viewDir),this.$if(h.lessThan(this.dis,0),function(){this.$return(h.vec3(0))}),o&&(this.$l.d=ic(this,h.vec3(0),this.params.plantRadius,this.eyePos,this.viewDir),this.$if(h.greaterThan(this.d,0),function(){this.dis=h.min(this.dis,this.d)})),this.$if(h.greaterThanEqual(this.maxDis,0),function(){this.dis=h.min(this.dis,this.maxDis)}),this.$l.ds=h.div(this.dis,32),this.$l.p=h.add(this.eyePos,h.mul(this.viewDir,this.ds,.5)),this.$l.sunLuminance=h.mul(this.params.lightColor.rgb,this.params.lightColor.a),this.$l.opticalDepth=h.vec3(0),this.$for(h.int("i"),0,32,function(){this.$l.h=h.sub(h.length(this.p),this.params.plantRadius),this.$l.extinction=h.add(rc(this,this.params.rayleighScatteringHeight,this.h),ac(this,this.params.mieScatteringHeight,this.h),oc(this,this.params.ozoneCenter,this.params.ozoneWidth,this.h),nc(this,this.params.mieScatteringHeight,this.h)),this.opticalDepth=h.add(this.opticalDepth,h.mul(this.extinction,this.ds)),this.$l.t1=sc(this,this.params,this.p,this.params.lightDir,a),this.$l.s=lc(this,this.params,this.p,this.viewDir),this.$l.t2=h.exp(h.neg(this.opticalDepth)),this.$l.inScattering=h.mul(this.t1,this.s,this.t2,this.ds,this.sunLuminance),this.color=h.add(this.color,this.inScattering),this.$l.multiScattering=function(t,e,i,s){const r=t.$builder,a="z_getMultiScattering",n=_c(r);return r.func(a,[n("params"),r.vec3("p")],function(){this.$l.h=r.sub(r.length(this.p),this.params.plantRadius),this.$l.sigma_s=r.add(rc(this,this.params.rayleighScatteringHeight,this.h),ac(this,this.params.mieScatteringHeight,this.h)),this.$l.zenithAngle=r.dot(r.normalize(this.p),this.params.lightDir),this.$l.uv=r.vec2(r.add(r.mul(this.zenithAngle,.5),.5),r.div(this.h,this.params.atmosphereHeight)),this.$l.G_ALL=r.textureSampleLevel(s,this.uv,0).rgb,this.$return(r.mul(this.G_ALL,this.sigma_s))}),t[a](e,i)}(this,this.params,this.p,n),this.color=h.add(this.color,h.mul(this.multiScattering,this.t2,this.ds,this.sunLuminance)),this.p=h.add(this.p,h.mul(this.viewDir,this.ds))}),this.$return(this.color)}),t[u](e,i,s,r)}function lc(t,e,i,s){const r=t.$builder,a=_c(r),n="z_scattering";return r.func(n,[a("params"),r.vec3("p"),r.vec3("viewDir")],function(){this.$l.cosTheta=r.dot(this.params.lightDir,this.viewDir),this.$l.h=r.sub(r.length(this.p),this.params.plantRadius),this.$l.rayleigh=r.mul(rc(this,this.params.rayleighScatteringHeight,this.h),function(t,e){const i=t.$builder,s="z_rayleighPhase";return i.func(s,[i.float("cosTheta")],function(){this.$return(i.mul(3/(16*Math.PI),i.add(1,i.mul(this.cosTheta,this.cosTheta))))}),t[s](e)}(this,this.cosTheta)),this.$l.mie=r.mul(ac(this,this.params.mieScatteringHeight,this.h),function(t,e,i){const s=t.$builder,r="z_miePhase";return s.func(r,[s.float("g"),s.float("cosTheta")],function(){this.$l.g2=s.mul(this.g,this.g),this.$l.a=3/(8*Math.PI),this.$l.b=s.div(s.sub(1,this.g2),s.add(2,this.g2)),this.$l.c=s.add(1,s.mul(this.cosTheta,this.cosTheta)),this.$l.d=s.pow(s.sub(s.add(1,this.g2),s.mul(this.g,this.cosTheta,2)),1.5),this.$return(s.div(s.mul(this.a,this.b,this.c),this.d))}),t[r](e,i)}(this,this.params.mieAnstropy,this.cosTheta)),this.$return(r.add(this.rayleigh,this.mie))}),t[n](e,i,s)}function uc(t,e,i,s){const r=t.$builder,a=_c(r),n="z_transmittance";return r.func(n,[a("params"),r.vec3("p1"),r.vec3("p2")],function(){this.$l.dir=r.normalize(r.sub(this.p2,this.p1)),this.$l.distance=r.length(r.sub(this.p2,this.p1)),this.$l.ds=r.div(this.distance,16),this.$l.sum=r.vec3(0),this.$l.p=r.add(this.p1,r.mul(this.dir,this.ds,.5)),this.$for(r.int("i"),0,16,function(){this.$l.h=r.sub(r.length(this.p),this.params.plantRadius),this.$l.scattering=r.add(rc(this,this.params.rayleighScatteringHeight,this.h),ac(this,this.params.mieScatteringHeight,this.h)),this.$l.absorption=r.add(oc(this,this.params.ozoneCenter,this.params.ozoneWidth,this.h),nc(this,this.params.mieScatteringHeight,this.h)),this.$l.extinction=r.add(this.scattering,this.absorption),this.sum=r.add(this.sum,r.mul(this.extinction,this.ds)),this.p=r.add(this.p,r.mul(this.dir,this.ds))}),this.$return(r.exp(r.neg(this.sum)))}),t[n](e,i,s)}function cc(t,e,i,s,r,a,n){const o=t.$builder,h="v_skybox",l=_c(o);return o.func(h,[l("params"),o.vec4("sunColor").out(),o.vec3("worldPos"),o.float("sunSolidAngle")],function(){this.$l.rgb=o.vec3(0),this.$l.viewDir=o.normalize(this.worldPos),this.rgb=o.add(this.rgb,o.textureSampleLevel(n,function(t,e){const i=t.$builder,s="z_viewDirToUV";return i.func(s,[i.vec3("viewDir")],function(){this.$l.uv=i.vec2(i.atan2(this.viewDir.z,this.viewDir.x),i.asin(this.viewDir.y)),this.uv=i.div(this.uv,i.vec2(2*Math.PI,Math.PI)),this.uv=i.add(this.uv,i.vec2(.5)),this.$return(this.uv)}),t[s](e)}(this,this.viewDir),0).rgb),this.$l.groundDistance=ic(this,o.vec3(0),this.params.plantRadius,o.vec3(0,o.add(this.params.plantRadius,o.mul(1,this.params.cameraHeightScale)),0),this.viewDir),this.$l.sunTransmittance=sc(this,this.params,o.vec3(0,o.add(this.params.cameraHeightScale,this.params.plantRadius),0),this.params.lightDir,a),this.sunColor=o.mul(this.params.lightColor,o.vec4(this.sunTransmittance,1)),this.$if(o.lessThan(this.groundDistance,0),function(){this.rgb=o.add(this.rgb,function(t,e,i,s,r){const a=t.$builder,n="v_sunBloom";return a.func(n,[a.vec3("viewDir"),a.vec3("lightDir"),a.vec4("sunColorAndIntensity"),a.float("sunSolidAngle")],function(){this.$l.minSunCosTheta=a.cos(this.sunSolidAngle),this.$l.cosTheta=a.dot(this.viewDir,this.lightDir),this.$l.luminance=a.mul(this.sunColorAndIntensity.rgb,this.sunColorAndIntensity.a),this.$if(a.lessThan(this.cosTheta,this.minSunCosTheta),function(){this.$l.offset=a.sub(this.minSunCosTheta,this.cosTheta),this.$l.gaussianBloom=a.mul(a.exp(a.mul(this.offset,-5e4)),.5),this.$l.invBloom=a.mul(a.div(1,a.add(.02,a.mul(this.offset,300))),.01),this.luminance=a.mul(this.luminance,a.add(this.gaussianBloom,this.invBloom))}),this.$return(this.luminance)}),t[n](e,i,s,r)}(this,this.viewDir,this.params.lightDir,this.sunColor,this.sunSolidAngle))}),this.$return(o.vec4(this.rgb,1))}),t[h](e,i,s,r)}function dc(t,e,i,s,r){const a=t.$builder,n=_c(a),o="v_skyViewLut";return a.func(o,[n("params"),a.vec2("uv"),a.float("cameraPosY")],function(){this.$l.viewDir=function(t,e){const i=t.$builder,s="z_uvToViewDir";return i.func(s,[i.vec2("uv")],function(){this.$l.theta=i.mul(i.sub(1,this.uv.y),Math.PI),this.$l.phi=i.mul(i.sub(i.mul(this.uv.x,2),1),Math.PI),this.$l.x=i.mul(i.sin(this.theta),i.cos(this.phi)),this.$l.z=i.mul(i.sin(this.theta),i.sin(this.phi)),this.$l.y=i.cos(this.theta),this.$return(i.vec3(this.x,this.y,this.z))}),t[s](e)}(this,this.uv),this.$l.h=a.add(this.params.plantRadius,a.mul(this.cameraPosY,this.params.cameraHeightScale)),this.$l.eyePos=a.vec3(0,this.h,0),this.$l.rgb=hc(this,this.params,this.eyePos,this.viewDir,a.float(-1),s,r),this.$return(a.vec4(this.rgb,1))}),t[o](e,i,1)}function pc(t,e,i,s){const r=t.$builder,a=_c(r),n="v_multiScatteringLut";return r.func(n,[a("params"),r.vec2("uv")],function(){this.$l.mu_s=r.sub(r.mul(this.uv.x,2),1),this.$l.r=r.add(r.mul(this.uv.y,this.params.atmosphereHeight),this.params.plantRadius),this.$l.cosTheta=this.mu_s,this.$l.sinTheta=r.sqrt(r.sub(1,r.mul(this.cosTheta,this.cosTheta))),this.$l.lightDir=r.vec3(this.sinTheta,this.cosTheta,0),this.$l.p=r.vec3(0,this.r,0),this.$l.rgb=function(t,e,i,s,r){const a=t.$builder,n=_c(a),o="z_integralMultiScattering";return a.func(o,[n("params"),a.vec3("lightDir"),a.vec3("samplePoint")],function(){const t=1/(4*Math.PI),e=4*Math.PI/64;this.$l.G_2=a.vec3(0),this.$l.f_ms=a.vec3(0),this.$for(a.int("i"),0,64,function(){this.$l.viewDir=this.uniformSphereSamples.at(this.i).xyz,this.$l.dis=ic(this,a.vec3(0),a.add(this.params.plantRadius,this.params.atmosphereHeight),this.samplePoint,this.viewDir),this.$l.d=ic(this,a.vec3(0),this.params.plantRadius,this.samplePoint,this.viewDir),this.$if(a.greaterThan(this.d,0),function(){this.dis=a.min(this.dis,this.d)}),this.$l.ds=a.div(this.dis,32),this.$l.p=a.add(this.samplePoint,a.mul(this.viewDir,this.ds,.5)),this.$l.opticalDepth=a.vec3(0),this.$for(a.int("j"),0,32,function(){this.$l.h=a.sub(a.length(this.p),this.params.plantRadius),this.$l.sigma_s=a.add(rc(this,this.params.rayleighScatteringHeight,this.h),ac(this,this.params.mieScatteringHeight,this.h)),this.$l.sigma_a=a.add(oc(this,this.params.ozoneCenter,this.params.ozoneWidth,this.h),nc(this,this.params.mieScatteringHeight,this.h)),this.$l.sigma_t=a.add(this.sigma_s,this.sigma_a),this.opticalDepth=a.add(this.opticalDepth,a.mul(this.sigma_t,this.ds)),this.$l.t1=sc(this,this.params,this.p,this.lightDir,r),this.$l.s=lc(this,this.params,this.p,this.viewDir),this.$l.t2=a.exp(a.neg(this.opticalDepth)),this.G_2=a.add(this.G_2,a.mul(this.t1,this.s,this.t2,t,this.ds)),this.f_ms=a.add(this.f_ms,a.mul(this.t2,this.sigma_s,t,this.ds)),this.p=a.add(this.p,a.mul(this.viewDir,this.ds))})}),this.G_2=a.mul(this.G_2,e),this.f_ms=a.mul(this.f_ms,e),this.$return(a.div(this.G_2,a.sub(a.vec3(1),this.f_ms)))}),t[o](e,i,s)}(this,this.params,this.lightDir,this.p,s),this.$return(r.vec4(this.rgb,1))}),t[n](e,i)}function mc(t){const e=function(t){const e={transmittance:!1,multiScattering:!1,skyView:!1,aerialPerspective:!1};return t={...Lu,...t},ec?(e.transmittance=ec.plantRadius!==t.plantRadius||ec.atmosphereHeight!==t.atmosphereHeight||ec.rayleighScatteringHeight!==t.rayleighScatteringHeight||ec.mieScatteringHeight!==t.mieScatteringHeight||ec.ozoneCenter!==t.ozoneCenter||ec.ozoneWidth!==t.ozoneWidth,e.multiScattering=e.transmittance||ec.mieAnstropy!==t.mieAnstropy,e.skyView=e.transmittance||e.multiScattering||ec.cameraHeightScale!==t.cameraHeightScale||!ec.lightDir.equalsTo(t.lightDir)||!ec.lightColor.equalsTo(t.lightColor)||!ec.cameraWorldMatrix.equalsTo(t.cameraWorldMatrix),e.aerialPerspective=e.transmittance||e.multiScattering||e.skyView||ec.apDistance!==t.apDistance||ec.cameraAspect!==t.cameraAspect):(ec={...Lu,lightDir:new z(Lu.lightDir),lightColor:new O(Lu.lightColor),cameraWorldMatrix:new W(Lu.cameraWorldMatrix)},e.transmittance=!0,e.multiScattering=!0,e.skyView=!0,e.aerialPerspective=!0),e.transmittance&&(ec.plantRadius=t.plantRadius,ec.atmosphereHeight=t.atmosphereHeight,ec.rayleighScatteringHeight=t.rayleighScatteringHeight,ec.mieScatteringHeight=t.mieScatteringHeight,ec.ozoneCenter=t.ozoneCenter,ec.ozoneWidth=t.ozoneWidth),e.multiScattering&&(ec.mieAnstropy=t.mieAnstropy),e.skyView&&(ec.cameraHeightScale=t.cameraHeightScale,ec.lightDir.set(t.lightDir),ec.lightColor.set(t.lightColor),ec.cameraWorldMatrix.set(t.cameraWorldMatrix)),e.aerialPerspective&&(ec.apDistance=t.apDistance,ec.cameraAspect=t.cameraAspect),e}(t);!e.transmittance&&Gu||function(t){const e=Sl();if(void 0===zu)try{zu=gc(e),Uu=e.createBindGroup(zu.bindGroupLayouts[0]),Gu=e.createTexture2D("rgba16f",256,64,{mipmapping:!1}),Gu.name="DebugTransmittanceLut",Hu=e.createFrameBuffer([Gu],null)}catch(t){console.error(t),zu=null,Uu=null,Hu=null}zu&&(Uu.setValue("flip","webgpu"===e.type?1:0),Uu.setValue("params",t),e.pushDeviceStates(),e.setFramebuffer(Hu),e.setProgram(zu),e.setBindGroup(0,Uu),Ru(),e.popDeviceStates())}(ec),!e.multiScattering&&Xu||function(t){const e=Sl();if(void 0===Vu)try{Vu=xc(e),Wu=e.createBindGroup(Vu.bindGroupLayouts[0]),Xu=e.createTexture2D("rgba16f",32,32,{mipmapping:!1}),Xu.name="DebugMultiScatteringLut",Qu=e.createFrameBuffer([Xu],null),ju=Wu.getBuffer("uniformSphereSamples",!1);const t=new Float32Array(256);for(let e=0;e<64;e++)t[4*e+0]=xu[e].x,t[4*e+1]=xu[e].y,t[4*e+2]=xu[e].z,t[4*e+3]=0;ju.bufferSubData(0,t)}catch(t){console.error(t),Vu=null,Wu=null,Qu=null}Vu&&(Wu.setValue("flip","webgpu"===e.type?1:0),Wu.setValue("params",t),Wu.setTexture("transmittanceLut",Gu,Gl("clamp_linear_nomip")),e.pushDeviceStates(),e.setFramebuffer(Qu),e.setProgram(Vu),e.setBindGroup(0,Wu),Ru(),e.popDeviceStates())}(ec),!e.skyView&&Yu||function(t){const e=Sl();if(void 0===Ou)try{Ou=bc(e),qu=e.createBindGroup(Ou.bindGroupLayouts[0]),Yu=e.createTexture2D("rgba16f",256,128,{mipmapping:!1}),Yu.name="DebugSkyViewLut",Zu=e.createFrameBuffer([Yu],null)}catch(t){console.error(t),Ou=null,qu=null,Zu=null}Ou&&(qu.setValue("flip","webgpu"===e.type?1:0),qu.setValue("params",t),qu.setTexture("transmittanceLut",Gu,Gl("clamp_linear_nomip")),qu.setTexture("multiScatteringLut",Xu,Gl("clamp_linear_nomip")),e.pushDeviceStates(),e.setFramebuffer(Zu),e.setProgram(Ou),e.setBindGroup(0,qu),Ru(),e.popDeviceStates())}(ec),!e.aerialPerspective&&Ju||function(t){const e=Sl();if(void 0===ku)try{ku=vc(e),Ku=e.createBindGroup(ku.bindGroupLayouts[0]),Ju=e.createTexture2D("rgba16f",1024,32,{mipmapping:!1}),Ju.name="DebugAPLut",tc=e.createFrameBuffer([Ju],null)}catch(t){console.error(t),ku=null,Ku=null,tc=null}ku&&(Ku.setValue("flip","webgpu"===e.type?1:0),Ku.setValue("params",t),Ku.setTexture("transmittanceLut",Gu,Gl("clamp_linear_nomip")),Ku.setTexture("multiScatteringLut",Xu,Gl("clamp_linear_nomip")),e.pushDeviceStates(),e.setFramebuffer(tc),e.setProgram(ku),e.setBindGroup(0,Ku),Ru(),e.popDeviceStates())}(ec)}function fc(){return Ju}function _c(t){return t.defineStruct([t.mat4("cameraWorldMatrix"),t.vec4("lightColor"),t.vec3("lightDir"),t.float("cameraAspect"),t.float("plantRadius"),t.float("atmosphereHeight"),t.float("rayleighScatteringHeight"),t.float("mieScatteringHeight"),t.float("mieAnstropy"),t.float("ozoneCenter"),t.float("ozoneWidth"),t.float("apDistance"),t.float("cameraHeightScale")])}function gc(t){const e=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){const e=_c(t);this.params=e().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$outputs.outColor=function(t,e,i){const s=t.$builder,r=_c(s),a="transmittanceLut";return s.func(a,[r("params"),s.vec2("uv")],function(){this.$l.color=s.vec4(0,0,0,1),this.$l.bottomRadius=this.params.plantRadius,this.$l.topRadius=s.add(this.bottomRadius,this.params.atmosphereHeight),this.$l.lutParams=function(t,e,i,s){const r=t.$builder,a="z_uvToTransmittanceLut";return r.func(a,[r.vec2("uv"),r.float("bottomRadius"),r.float("topRadius")],function(){this.$l.x_mu=this.uv.x,this.$l.x_r=this.uv.y,this.$l.H=r.sqrt(r.max(0,r.sub(r.mul(this.topRadius,this.topRadius),r.mul(this.bottomRadius,this.bottomRadius)))),this.$l.rho=r.mul(this.H,this.x_r),this.$l.r=r.sqrt(r.max(0,r.add(r.mul(this.rho,this.rho),r.mul(this.bottomRadius,this.bottomRadius)))),this.$l.d_min=r.sub(this.topRadius,this.r),this.$l.d_max=r.add(this.rho,this.H),this.$l.d=r.add(this.d_min,r.mul(this.x_mu,r.sub(this.d_max,this.d_min))),this.$l.mu=this.$choice(r.equal(this.d,0),r.float(1),r.div(r.sub(r.mul(this.H,this.H),r.add(r.mul(this.rho,this.rho),r.mul(this.d,this.d))),r.mul(this.r,this.d,2))),this.mu=r.clamp(this.mu,-1,1),this.$return(r.vec2(this.mu,this.r))}),t[a](e,i,s)}(this,this.uv,this.bottomRadius,this.topRadius),this.$l.cos_theta=this.lutParams.x,this.$l.r=this.lutParams.y,this.$l.sin_theta=s.sqrt(s.sub(1,s.mul(this.cos_theta,this.cos_theta))),this.$l.viewDir=s.vec3(this.sin_theta,this.cos_theta,0),this.$l.eyePos=s.vec3(0,this.r,0),this.$l.dis=ic(this,s.vec3(0),this.topRadius,this.eyePos,this.viewDir),this.$l.hitPoint=s.add(this.eyePos,s.mul(this.viewDir,this.dis)),this.$return(s.vec4(uc(this,this.params,this.eyePos,this.hitPoint),1))}),t[a](e,i)}(this,this.params,this.$inputs.uv)})}});return e.name="@TransmittanceLutProgram",e}function xc(t){const e=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){const e=_c(t);this.params=e().uniform(0),this.uniformSphereSamples=t.vec4[64]().uniformBuffer(0),this.transmittanceLut=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$outputs.outColor=pc(this,this.params,this.$inputs.uv,this.transmittanceLut)})}});return e.name="@MultiScatteringLutProgram",e}function bc(t){const e=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){const e=_c(t);this.params=e().uniform(0),this.transmittanceLut=t.tex2D().uniform(0),this.multiScatteringLut=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$outputs.outColor=dc(this,this.params,this.$inputs.uv,this.transmittanceLut,this.multiScatteringLut)})}});return e.name="@SkyViewLutProgram",e}function vc(t){const e=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){const e=_c(t);this.params=e().uniform(0),this.transmittanceLut=t.tex2D().uniform(0),this.multiScatteringLut=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$outputs.outColor=function(t,e,i,s,r,a){const n=t.$builder,o=_c(n);n.func("z_fixVoxel",[o("params"),n.vec3("eyePos"),n.vec3("viewDir").inout(),n.float("maxDis"),n.float("adjustedMaxDis").inout()],function(){this.$l.voxelPos=n.add(this.eyePos,n.mul(this.viewDir,this.maxDis)),this.$l.voxelHeight=n.length(this.voxelPos),this.$l.underGround=n.lessThan(this.voxelHeight,this.params.plantRadius),this.$l.cameraToVoxel=n.sub(this.voxelPos,this.eyePos),this.$l.cameraToVoxelLen=n.length(this.cameraToVoxel),this.$l.cameraToVoxelDir=n.div(this.cameraToVoxel,this.cameraToVoxelLen),this.$l.planetNearT=ic(this,n.vec3(0),this.params.plantRadius,this.eyePos,this.cameraToVoxelDir),this.$l.belowHorizon=n.and(n.greaterThan(this.planetNearT,0),n.greaterThan(this.cameraToVoxelLen,this.planetNearT)),this.$l.eyePos2=this.eyePos,this.$if(n.or(this.underGround,this.belowHorizon),function(){this.eyePos2=n.add(this.eyePos2,n.mul(n.normalize(this.eyePos2),.02)),this.$if(this.belowHorizon,function(){this.$l.voxelWorldPosNorm=n.normalize(this.voxelPos),this.$l.camProjOnGround=n.mul(n.normalize(this.eyePos2),this.params.plantRadius),this.$l.voxProjOnGround=n.mul(this.voxelWorldPosNorm,this.params.plantRadius),this.$l.voxelGroundToRayStart=n.sub(this.eyePos2,this.voxProjOnGround),this.$if(n.lessThan(n.dot(n.normalize(this.voxelGroundToRayStart),this.voxelWorldPosNorm),1e-4),function(){this.$l.middlePoint=n.mul(n.add(this.camProjOnGround,this.voxProjOnGround),.5),this.$l.middlePointOnGround=n.mul(n.normalize(this.middlePoint),this.params.plantRadius),this.voxelPos=n.add(this.eyePos2,n.mul(n.sub(this.middlePointOnGround,this.eyePos2),2))})}).$else(function(){this.voxelPos=n.mul(n.normalize(this.voxelPos),this.params.plantRadius)}),this.$l.V=n.sub(this.voxelPos,this.eyePos2),this.adjustedMaxDis=n.length(this.V),this.viewDir=n.div(this.V,this.adjustedMaxDis)}),this.$return(this.eyePos2)});const h="z_aerialPerspectiveLut";return n.func(h,[o("params"),n.vec2("uv"),n.vec3("dim"),n.float("cameraPosY")],function(){this.$l.uvw=n.vec3(this.uv,0),this.uvw.x=n.mul(this.uvw.x,this.dim.x,this.dim.z),this.uvw.z=n.div(n.floor(n.div(this.uvw.x,this.dim.z)),this.dim.x),this.uvw.x=n.div(n.mod(this.uvw.x,this.dim.z),this.dim.x),this.uvw=n.add(this.uvw,n.div(n.vec3(.5),this.dim)),this.$l.slice=this.uvw.z,this.$l.viewDir=n.normalize(n.mul(this.params.cameraWorldMatrix,n.vec4(n.sub(n.mul(this.uvw.x,2),1),n.div(n.sub(n.mul(this.uvw.y,2),1),this.params.cameraAspect),-1,0)).xyz),this.$l.eyePos=n.vec3(0,n.add(n.mul(this.cameraPosY,this.params.cameraHeightScale),this.params.plantRadius),0),this.$l.maxDis=n.mul(this.slice,this.params.apDistance),this.$l.voxelPos=n.add(this.eyePos,n.mul(this.viewDir,this.maxDis)),this.$if(n.lessThan(n.length(this.voxelPos),this.params.plantRadius),function(){this.voxelPos=n.mul(n.normalize(this.voxelPos),this.params.plantRadius),this.maxDis=n.length(n.sub(this.eyePos,this.voxelPos))}),this.$l.color=hc(this,this.params,this.eyePos,this.viewDir,this.maxDis,r,a),this.$l.t1=sc(this,this.params,this.eyePos,this.viewDir,r),this.$l.t2=sc(this,this.params,this.voxelPos,this.viewDir,r),this.$l.t=n.clamp(n.div(this.t1,n.max(this.t2,n.vec3(1e-4))),n.vec3(0),n.vec3(1)),this.$return(n.vec4(this.color,n.dot(this.t,n.vec3(1/3,1/3,1/3))))}),t[h](e,i,s,1)}(this,this.params,this.$inputs.uv,t.vec3(32,32,32),this.transmittanceLut,this.multiScatteringLut)})}});return e.name="@APLutProgram",e}function yc(){return{parameter1:new O(0,0,0,.1),parameter2:new O(.01,0,0,1e4),parameter3:new O(.8,1,0,4),parameter4:new O(0,0,0,0),lightDir:new z(0,1,0),lightColor:new z(0,0,0)}}function Tc(t){return t.defineStruct([t.vec4("parameter1"),t.vec4("parameter2"),t.vec4("parameter3"),t.vec4("parameter4"),t.float("dirInscatteringStartDistance"),t.vec3("dirInscatteringColor"),t.vec3("lightDir"),t.vec3("lightColor")])}function wc(t,e,i,s,r,a,n,o,h,l,u,c){const d=t.$builder,p="Z_calculateFog",m=_c(d),f=Tc(d);return d.func(p,[d.int("withAerialPerspective"),d.int("fogType"),m("atmosphereParams"),f("heightFogParams"),d.bool("isSky"),d.vec2("uv"),d.vec3("cameraPos"),d.vec3("worldPos"),d.int("additive")],function(){this.$l.fogging=d.vec4(0,0,0,1),this.$if(d.equal(this.fogType,bu.FOG_TYPE_HEIGHT),function(){this.fogging=function(t,e,i,s,r,a){const n=t.$builder,o="Z_calcHeightFog",h=Tc(n);return n.func(o,[h("params"),n.vec3("cameraPosition"),n.vec3("worldPosition"),n.bool("isSky")],function(){this.$l.cameraPos=this.$choice(this.isSky,this.cameraPosition,n.vec3(this.cameraPosition.x,n.min(this.cameraPosition.y,n.add(this.params.parameter2.y,100)),this.cameraPosition.z)),this.$l.ray=n.sub(this.worldPosition,this.cameraPos),this.$l.d=n.length(this.ray),this.$l.rayNorm=n.div(this.ray,this.d),this.$l.origin=n.add(this.cameraPos,n.mul(this.rayNorm,this.params.parameter2.z)),this.$l.term=this.params.parameter3.z,this.$l.worldPos=this.$choice(this.isSky,n.add(this.cameraPosition,n.mul(this.rayNorm,1e8)),this.worldPosition),this.$l.falloff=n.clamp(n.mul(this.params.parameter1.w,n.sub(this.worldPos.y,this.origin.y)),-125,126),this.$l.fading=this.$choice(this.isSky,n.smoothStep(5e6,0,this.worldPos.y),0),this.$l.factor=this.$choice(n.greaterThan(n.abs(this.falloff),.01),n.div(n.sub(1,n.exp2(n.neg(this.falloff))),this.falloff),n.sub(Math.log(2),n.mul(.5*Math.log(2)*Math.log(2),this.falloff))),this.$l.worldDistance=n.dot(n.sub(this.worldPos,this.origin),this.rayNorm),this.$l.lineIntegral=n.mul(this.term,this.factor,n.max(0,this.worldDistance)),this.$l.directionalInscattering=n.mul(n.add(this.params.parameter4.rgb,n.mul(this.params.lightColor,this.params.parameter3.y)),n.pow(n.clamp(n.dot(this.rayNorm,this.params.lightDir),0,1),this.params.parameter3.w)),this.$l.fogFactor=n.sub(1,n.clamp(n.exp2(n.neg(this.lineIntegral)),0,1)),this.$l.distanceFactor=n.clamp(n.div(this.worldDistance,this.params.parameter2.w),0,1),this.fogFactor=n.mul(this.fogFactor,n.sub(1,this.distanceFactor)),this.$l.directionalInscattering=n.mul(this.$l.directionalInscattering,n.max(this.fogFactor,this.fading)),this.$l.fogColor=this.params.parameter1.rgb,this.$if(n.greaterThan(this.params.parameter3.y,0),function(){this.$l.skyContrib=n.textureSampleLevel(a,n.vec2(.5),0).rgb,this.fogColor=n.add(this.fogColor,n.mul(this.skyContrib,this.params.parameter3.y))}),this.$l.fogFactor=n.max(n.min(this.fogFactor,this.params.parameter3.x),this.fading),this.$l.fogColor=n.add(n.mul(this.fogColor,this.fogFactor),this.directionalInscattering),this.$return(n.vec4(this.fogColor,n.sub(1,this.fogFactor)))}),t[o](e,i,s,r)}(this,this.heightFogParams,this.cameraPos,this.worldPos,this.isSky,c)}),this.$if(d.and(d.notEqual(this.withAerialPerspective,0),d.not(this.isSky)),function(){this.$l.atmosphericFogging=function(t,e,i,s,r,a,n){const o=t.$builder,h=_c(o),l="z_aerialPerspective";return o.func(l,[h("params"),o.vec2("uv"),o.vec3("cameraPos"),o.vec3("worldPos"),o.vec3("dim")],function(){this.$l.V=o.sub(this.worldPos,this.cameraPos),this.$l.dis=o.length(this.V),this.$l.viewDir=o.normalize(this.V),this.$l.apDistance=o.div(this.params.apDistance,this.params.cameraHeightScale),this.$l.d0=o.clamp(o.div(this.dis,this.apDistance),0,1),this.$l.weight=o.clamp(o.mul(this.d0,2),0,1),this.$l.dz=o.mul(this.d0,o.sub(this.dim.z,1)),this.$l.slice=o.floor(this.dz),this.$l.nextSlice=o.min(o.add(this.slice,1),o.sub(this.dim.z,1)),this.$l.factor=o.sub(this.dz,o.floor(this.dz)),this.t=o.div(this.uv,o.vec2(this.dim.x,1)),this.$l.uv1=o.add(this.t,o.vec2(o.div(this.slice,this.dim.z),0)),this.$l.uv2=o.add(this.t,o.vec2(o.div(this.nextSlice,this.dim.z),0)),this.$l.data1=o.textureSampleLevel(n,this.uv1,0),this.$l.data2=o.textureSampleLevel(n,this.uv2,0),this.$l.data=o.mix(this.data1,this.data2,this.factor),this.$l.inscattering=o.mul(this.data.rgb,this.weight),this.$l.planetTranslate=o.vec3(0,this.params.plantRadius,0),this.$l.transmittance=o.dot(uc(this,this.params,o.add(this.cameraPos,this.planetTranslate),o.add(this.worldPos,this.planetTranslate)),o.vec3(1/3,1/3,1/3)),this.$return(o.vec4(this.inscattering,this.transmittance))}),t[l](i,e,s,r,a)}(this,this.uv,this.atmosphereParams,this.cameraPos,this.worldPos,d.vec3(32),u),this.$if(d.notEqual(this.fogType,bu.FOG_TYPE_NONE),function(){this.fogging=function(t,e,i){const s=t.$builder,r="Z_combineAerialPerspectiveFog";return s.func(r,[s.vec4("fogging"),s.vec4("aerialPerspectiveFog")],function(){this.$l.rgb=s.add(this.fogging.rgb,s.mul(this.aerialPerspectiveFog.rgb,this.fogging.a)),this.$l.a=s.mul(this.fogging.a,this.aerialPerspectiveFog.a),this.$return(s.vec4(this.rgb,this.a))}),t[r](e,i)}(this,this.fogging,this.atmosphericFogging)}).$else(function(){this.fogging=this.atmosphericFogging})}),this.$if(d.notEqual(this.additive,0),function(){this.fogging=d.vec4(d.vec3(0),this.fogging.a)}),this.$return(this.fogging)}),t[p](e,i,s,r,n,a,o,h,l)}const Sc="Z_UniformLightBuffer",Ac="Z_UniformLightIndexTex",Cc="Z_UniformBakedSky",Ec="Z_UniformAerialPerspectiveLUT",Mc="Z_UniformSkyDistantLightLUT",Bc="Z_UniformShadowMap",Ic="Z_UniformLinearDepth",Pc="Z_UniformLinearDepthSize",$c="Z_UniformSceneColor",Rc="Z_UniformSceneColorSize",Fc="Z_UniformHiZDepth",Dc="Z_UniformHiZDepthInfo",Nc="Z_ObjectColor",Lc="Z_UniformWorldMatrix",zc="Z_UniformPrevWorldMatrix",Vc="Z_UniformPrevWorldMatrixFrame",Oc="Z_UniformInstanceDataStride",kc="Z_UniformInstanceData",Uc="Z_UniformInstanceDataOffset",Gc="Z_UniformBoneMatrices",Hc="Z_UniformBoneTexSize",Wc="Z_UniformBoneInvBindMatrix",Xc="Z_UniformMorphData",jc="Z_UniformMorphInfo";class Qc{static BILLBOARD_SPHERICAL=1;static BILLBOARD_SYLINDRAL=2;static MATERIAL_INSTANCE_DATA_OFFSET=9;static defaultSunDir=z.one().inplaceNormalize();static SKIN_MATRIX_NAME="Z_SkinMatrix";static SKIN_PREV_MATRIX_NAME="Z_PrevSkinMatrix";static SKIN_BONE_OFFSET="Z_boneOffset";static _drawableBindGroupLayouts={};static _lightUniformShadow={sunDir:new z,envLightStrength:1,shadowCascades:1,positionAndRange:new O,directionAndCutoff:new O,diffuseAndIntensity:new O,cascadeDistances:new O,depthBiasValues:new O,shadowCameraParams:new O,depthBiasScales:new O,shadowMatrices:new Float32Array(64)};static _fogUniforms={withAerialPerspective:0,fogType:0,additive:0,atmosphereParams:Nu(),heightFogParams:yc()};static getObjectColorUniformName(){return Nc}static getWorldMatrixUniformName(){return Lc}static getPrevWorldMatrixUniformName(){return zc}static getPrevWorldMatrixFrameUniformName(){return Vc}static getInstanceDataUniformName(){return kc}static getInstanceDataOffsetUniformName(){return Uc}static getInstanceDataStrideUniformName(){return Oc}static getBoneMatricesUniformName(){return Gc}static getBoneTextureSizeUniformName(){return Hc}static getBoneInvBindMatrixUniformName(){return Wc}static getMorphDataUniformName(){return Xc}static getMorphInfoUniformName(){return jc}static getLightBufferUniformName(){return Sc}static getDrawableBindGroupLayout(t,e,i){const s=`${t?1:0}${e?1:0}${i?1:0}`;let r=this._drawableBindGroupLayouts[s];if(!r){const a=Sl();r=new fn(a).buildRender({vertex(s){Qc.vertexShaderDrawableStuff(this,t,e,i),s.main(function(){})},fragment(t){t.main(function(){})}})[2][1],this._drawableBindGroupLayouts[s]=r}return r}static prepareFragmentShader(t,e){this.setupGlobalUniforms(t,e)}static prepareVertexShader(t,e){this.setupGlobalUniforms(t,e),this.prepareVertexShaderCommon(t,e)}static setupGlobalUniforms(t,e){const i=t.getGlobalScope(),s=t.defineStruct([t.vec4("position"),t.vec4("clipPlane"),t.mat4("viewProjectionMatrix"),t.mat4("invViewProjectionMatrix"),t.mat4("unjitteredVPMatrix"),t.mat4("jitteredInvVPMatrix"),t.mat4("viewMatrix"),t.mat4("worldMatrix"),t.mat4("projectionMatrix"),t.mat4("invProjectionMatrix"),t.vec4("params"),...e.motionVectors&&2===e.renderPass.type?[t.mat4("prevUnjitteredVPMatrix")]:[],t.vec2("renderSize"),t.vec2("jitterValue"),t.float("roughnessFactor"),t.float("frameDeltaTime"),t.float("elapsedTime"),t.int("framestamp")]);if(1===e.renderPass.type){const e=t.defineStruct([t.vec4("positionAndRange"),t.vec4("directionCutoff"),t.mat4("viewMatrix"),t.vec4("depthBias"),t.int("lightType")]);i.camera=s().uniform(0),i.light=e().uniform(0)}else if(2===e.renderPass.type||3===e.renderPass.type)i.camera=s().uniform(0);else if(0===e.renderPass.type){const r=!e.currentShadowLight;if(e.materialFlags&gu.APPLY_FOG){const e=[t.int("withAerialPerspective"),t.int("fogType"),t.int("additive"),_c(t)("atmosphereParams"),Tc(t)("heightFogParams")],s=t.defineStruct(e);i.fog=s().uniform(0),i[Ec]=t.tex2D().uniform(0),i[Mc]=t.tex2D().uniform(0)}const a=e.currentShadowLight?t.defineStruct([t.vec3("sunDir"),t.int("shadowCascades"),t.vec4("positionAndRange"),t.vec4("directionAndCutoff"),t.vec4("diffuseAndIntensity"),t.vec4("cascadeDistances"),t.vec4("depthBiasValues"),t.vec4("shadowCameraParams"),t.vec4("depthBiasScales"),t.vec4[16]("shadowMatrices"),t.float("envLightStrength")]):t.defineStruct([t.vec3("sunDir"),t.float("envLightStrength"),t.vec4("clusterParams"),t.ivec4("countParams"),t.ivec2("lightIndexTexSize")]);if(i.camera=s().uniform(0),i.light=a().uniform(0),r&&(i[Sc]=t.vec4[768]().uniformBuffer(0),i[Ac]=("webgl"===t.getDevice().type?t.tex2D():t.utex2D()).uniform(0)),i[Cc]=t.texCube().uniform(0),e.currentShadowLight){const i=t.getGlobalScope(),s=e.shadowMapInfo.get(e.currentShadowLight),r=s.shadowMap.isTextureCube()?s.shadowMap.isDepth()?i.$builder.texCubeShadow():i.$builder.texCube():s.shadowMap.isTexture2D()?s.shadowMap.isDepth()?i.$builder.tex2DShadow():i.$builder.tex2D():s.shadowMap.isDepth()?i.$builder.tex2DArrayShadow():i.$builder.tex2DArray();s.shadowMap.isDepth()||e.device.getDeviceCaps().textureCaps.getTextureFormatInfo(s.shadowMap.format).filterable||r.sampleType("unfilterable-float"),i[Bc]=r.uniform(0)}e.drawEnvLight&&e.env.light.envLight.initShaderBindings(t),e.linearDepthTexture&&(i[Ic]=t.tex2D().uniform(0),i[Pc]=t.vec2().uniform(0)),e.sceneColorTexture&&(i[$c]=t.tex2D().uniform(0),i[Rc]=t.vec2().uniform(0)),e.HiZTexture&&(i[Fc]=t.tex2D().uniform(0),i[Dc]=t.vec4().uniform(0))}}static hasSkinning(t){return!!t[Gc]}static hasMorphing(t){return!!t[Xc]}static calculateSkinMatrix(t){if(!this.hasSkinning(t))return null;const e=t.$builder,i="Z_getBoneMatrixFromTexture";e.func(i,[e.int("boneIndex")],function(){const t=this[Gc];this.$l.uvOffsets=e.textureSampleLevel(t,e.div(e.vec2(.5),this[Hc]),0),this.$l.currentOffset=e.int(this.uvOffsets.x),this.$l.w=this[Hc].x,this.$l.pixelIndex=e.float(e.mul(e.add(this.boneIndex,this.currentOffset),4)),this.$l.xIndex=e.mod(this.pixelIndex,this.w),this.$l.yIndex=e.floor(e.div(this.pixelIndex,this.w)),this.$l.u1=e.div(e.add(this.xIndex,.5),this.w),this.$l.u2=e.div(e.add(this.xIndex,1.5),this.w),this.$l.u3=e.div(e.add(this.xIndex,2.5),this.w),this.$l.u4=e.div(e.add(this.xIndex,3.5),this.w),this.$l.v=e.div(e.add(this.yIndex,.5),this.w),this.$l.row1=e.textureSampleLevel(t,e.vec2(this.u1,this.v),0),this.$l.row2=e.textureSampleLevel(t,e.vec2(this.u2,this.v),0),this.$l.row3=e.textureSampleLevel(t,e.vec2(this.u3,this.v),0),this.$l.row4=e.textureSampleLevel(t,e.vec2(this.u4,this.v),0),this.$return(e.mat4(this.row1,this.row2,this.row3,this.row4))});const s="Z_getSkinningMatrix";return e.func(s,[],function(){const s=this[Wc],r=t.$getVertexAttrib("blendIndices"),a=t.$getVertexAttrib("blendWeights");this.$l.m0=t.$g[i](e.int(r[0])),this.$l.m1=t.$g[i](e.int(r[1])),this.$l.m2=t.$g[i](e.int(r[2])),this.$l.m3=t.$g[i](e.int(r[3])),this.$l.m=e.add(e.mul(this.m0,a.x),e.mul(this.m1,a.y),e.mul(this.m2,a.z),e.mul(this.m3,a.w)),this.$return(e.mul(s,this.m))}),t.$g[s]()}static calculateMorphDelta(t,e){const i=t.$builder,s="webgl"===i.getDevice().type;if("vertex"!==i.shaderKind)throw new Error("ShaderHelper.calculateMorphDelta(): must be called at vertex stage");const r="Z_calculateMorph",a=this;i.func(r,[i.int("offset")],function(){this.$if(i.lessThan(this.offset,0),function(){this.$return(i.vec4(0))}),this.$l.vertexIndex=s?i.int(t.$inputs.zFakeVertexID):i.int(t.$builtins.vertexIndex);const e=t[a.getMorphInfoUniformName()];this.$l.metaData=i.ivec4(e[0]),this.$l.texWidth=i.float(this.metaData.x),this.$l.texHeight=i.float(this.metaData.y),this.$l.numVertices=this.metaData.z,this.$l.numTargets=this.metaData.w,this.$l.value=i.vec4(0),s?this.$for(i.int("i"),0,64,function(){this.$for(i.int("j"),0,4,function(){this.$l.index=i.add(i.mul(this.i,4),this.j),this.$if(i.greaterThanEqual(this.index,this.numTargets),function(){this.$return(this.value)}),this.$l.weight=e.at(i.add(1,this.i)).at(this.j),this.$l.pixelIndex=i.float(i.add(this.offset,i.mul(this.index,this.numVertices),this.vertexIndex)),this.$l.xIndex=i.mod(this.pixelIndex,this.texWidth),this.$l.yIndex=i.floor(i.div(this.pixelIndex,this.texWidth)),this.$l.u=i.div(i.add(this.xIndex,.5),this.texWidth),this.$l.v=i.div(i.add(this.yIndex,.5),this.texHeight),this.$l.morphValue=i.textureSampleLevel(this[a.getMorphDataUniformName()],i.vec2(this.u,this.v),0),this.value=i.add(this.value,i.mul(this.morphValue,this.weight))})}):this.$for(i.int("t"),0,this.numTargets,function(){this.$l.i=i.sar(this.t,2),this.$l.j=i.compAnd(this.t,3),this.$l.weight=e.at(i.add(1,this.i)).at(this.j),this.$l.pixelIndex=i.float(i.add(this.offset,i.mul(this.t,this.numVertices),this.vertexIndex)),this.$l.xIndex=i.mod(this.pixelIndex,this.texWidth),this.$l.yIndex=i.floor(i.div(this.pixelIndex,this.texWidth)),this.$l.u=i.div(i.add(this.xIndex,.5),this.texWidth),this.$l.v=i.div(i.add(this.yIndex,.5),this.texHeight),this.$l.morphValue=i.textureSampleLevel(this[a.getMorphDataUniformName()],i.vec2(this.u,this.v),0),this.value=i.add(this.value,i.mul(this.morphValue,this.weight))}),this.$return(this.value)});const n=65+(e>>2),o=3&e,h=t[this.getMorphInfoUniformName()][n][o];return t[r](i.int(h))}static prepareSkinAnimation(t){if(!this.hasSkinning(t))return;const e=this,i=t.$builder,s="Z_getBoneMatrixFromTexture";i.func(s,[i.float("boneIndex"),i.float("boneOffset")],function(){const t=this[Gc];this.$l.w=this[Hc].x,this.$l.pixelIndex=i.mul(i.add(this.boneIndex,this.boneOffset),4),this.$l.xIndex=i.mod(this.pixelIndex,this.w),this.$l.yIndex=i.floor(i.div(this.pixelIndex,this.w)),this.$l.u1=i.div(i.add(this.xIndex,.5),this.w),this.$l.u2=i.div(i.add(this.xIndex,1.5),this.w),this.$l.u3=i.div(i.add(this.xIndex,2.5),this.w),this.$l.u4=i.div(i.add(this.xIndex,3.5),this.w),this.$l.v=i.div(i.add(this.yIndex,.5),this.w),this.$l.row1=i.textureSampleLevel(t,i.vec2(this.u1,this.v),0),this.$l.row2=i.textureSampleLevel(t,i.vec2(this.u2,this.v),0),this.$l.row3=i.textureSampleLevel(t,i.vec2(this.u3,this.v),0),this.$l.row4=i.textureSampleLevel(t,i.vec2(this.u4,this.v),0),this.$return(i.mat4(this.row1,this.row2,this.row3,this.row4))});const r="Z_getSkinningMatrix";i.func(r,[i.float("boneOffset")],function(){const e=this[Wc],r=t.$getVertexAttrib("blendIndices"),a=t.$getVertexAttrib("blendWeights");this.$l.m0=t.$g[s](r[0],this.boneOffset),this.$l.m1=t.$g[s](r[1],this.boneOffset),this.$l.m2=t.$g[s](r[2],this.boneOffset),this.$l.m3=t.$g[s](r[3],this.boneOffset),this.$l.m=i.add(i.mul(this.m0,a.x),i.mul(this.m1,a.y),i.mul(this.m2,a.z),i.mul(this.m3,a.w)),this.$return(i.mul(e,this.m))});const a=!!this.getUnjitteredViewProjectionMatrix(t),n=t[Gc];t.$l[e.SKIN_BONE_OFFSET]=i.textureSampleLevel(n,i.div(i.vec2(.5),t[Hc]),0).xy,t.$l[e.SKIN_MATRIX_NAME]=t[r](t[e.SKIN_BONE_OFFSET].x),a&&(t.$l[e.SKIN_PREV_MATRIX_NAME]=t[r](t[e.SKIN_BONE_OFFSET].y))}static resolveVertexPosition(t){const e=t.$builder;if("vertex"!==e.shaderKind)throw new Error("ShaderHelper.resolveVertexPosition(): must be called at vertex stage");e.getGlobalScope().$getVertexAttrib("position")||(e.getGlobalScope().$inputs.Z_pos=e.vec3().attrib("position"));const i=this,s=t[i.SKIN_MATRIX_NAME]&&t[i.SKIN_PREV_MATRIX_NAME]?[e.mat4("skinMatrix"),e.mat4("prevSkinMatrix")]:t[i.SKIN_MATRIX_NAME]?[e.mat4("skinMatrix")]:[];return e.func("Z_resolveVertexPosition",s,function(){this.$l.opos=this.$getVertexAttrib("position").xyz,i.hasMorphing(t)&&(this.opos=e.add(this.opos,i.calculateMorphDelta(this,0).xyz)),this.skinMatrix?this.$l.pos=e.mul(this.skinMatrix,e.vec4(this.opos,1)).xyz:this.$l.pos=this.opos;const s=i.getPrevUnjitteredViewProjectionMatrix(this);s&&(this.$l.unjitteredVPMatrix=i.getUnjitteredViewProjectionMatrix(this),this.$l.worldPos=e.mul(i.getWorldMatrix(this),e.vec4(this.pos,1)),this.prevSkinMatrix?this.$l.prevWorldPos=e.mul(i.getPrevWorldMatrix(this),e.mul(this.prevSkinMatrix,e.vec4(this.opos,1))):this.$l.prevWorldPos=e.mul(i.getPrevWorldMatrix(this),e.vec4(this.pos,1)),this.$outputs.zMotionVectorPosCurrent=e.mul(this.unjitteredVPMatrix,this.worldPos),this.$outputs.zMotionVectorPosPrev=e.mul(s,this.prevWorldPos)),this.$return(this.pos)}),t[i.SKIN_MATRIX_NAME]&&t[i.SKIN_PREV_MATRIX_NAME]?t.Z_resolveVertexPosition(t[i.SKIN_MATRIX_NAME],t[i.SKIN_PREV_MATRIX_NAME]):t[i.SKIN_MATRIX_NAME]?t.Z_resolveVertexPosition(t[i.SKIN_MATRIX_NAME]):t.Z_resolveVertexPosition()}static resolveMotionVector(t,e,i){const s=this,r=t.$builder,a=s.getPrevUnjitteredViewProjectionMatrix(t);if(a){const n=s.getUnjitteredViewProjectionMatrix(t);t.$outputs.zMotionVectorPosCurrent=r.mul(n,r.vec4(e.xyz,1)),t.$outputs.zMotionVectorPosPrev=r.mul(a,r.vec4(i.xyz,1))}}static resolveVertexNormal(t,e){const i=t.$builder;if("vertex"!==i.shaderKind)throw new Error("ShaderHelper.resolveVertexNormal(): must be called in vertex stage");const s=i.getCurrentFunctionScope();if(!s||!s.$isMain())throw new Error("ShaderHelper.resolveVertexNormal(): must be called at entry function");return e||(t.$getVertexAttrib("normal")||(t.$inputs.Z_normal=i.vec3().attrib("normal")),e=t.$getVertexAttrib("normal")),this.hasMorphing(t)&&(e=i.normalize(i.add(e,this.calculateMorphDelta(t,1).xyz))),t[this.SKIN_MATRIX_NAME]?i.mul(t[this.SKIN_MATRIX_NAME],i.vec4(e,0)).xyz:e}static resolveVertexTangent(t,e){const i=t.$builder;if("vertex"!==i.shaderKind)throw new Error("ShaderHelper.resolveVertexTangent(): must be called in vertex stage");const s=i.getCurrentFunctionScope();if(!s||!s.$isMain())throw new Error("ShaderHelper.resolveVertexTangent(): must be called at entry function");return e||(t.$getVertexAttrib("tangent")||(t.$inputs.Z_tangent=i.vec4().attrib("tangent")),e=t.$getVertexAttrib("tangent")),this.hasMorphing(t)&&(e=i.normalize(i.add(e,i.vec4(this.calculateMorphDelta(t,2).xyz,0)))),t[this.SKIN_MATRIX_NAME]?i.vec4(i.mul(t[this.SKIN_MATRIX_NAME],i.vec4(e.xyz,0)).xyz,e.w):e}static getWorldMatrix(t){const e=t.$builder;return t[Lc]??e.mat4(this.getInstancedUniform(t,0),this.getInstancedUniform(t,1),this.getInstancedUniform(t,2),this.getInstancedUniform(t,3))}static getPrevWorldMatrix(t){const e=t.$builder,i=this,s=this.getFramestamp(t);return t[Lc]?"webgpu"===e.getDevice().type?(e.func("Z_getPrevWorldMatrix",[e.int("framestamp")],function(){this.$if(e.equal(this.framestamp,this[Vc]),function(){this.$return(this[zc])}).$else(function(){this.$return(this[Lc])})}),t.Z_getPrevWorldMatrix(s)):t.$choice(e.equal(s,t[Vc]),t[zc],t[Lc]):(e.func("Z_getPrevWorldMatrix",[e.int("framestamp")],function(){this.$l.prevFrame=e.floatBitsToInt(i.getInstancedUniform(this,4).x),this.$l.index=this.$choice(e.equal(this.framestamp,this.prevFrame),e.int(5),e.int(0)),this.$return(e.mat4(i.getInstancedUniform(t,this.index),i.getInstancedUniform(t,e.add(this.index,1)),i.getInstancedUniform(t,e.add(this.index,2)),i.getInstancedUniform(t,e.add(this.index,3))))}),t.Z_getPrevWorldMatrix(s))}static getInstancedUniform(t,e){const i=t.$builder;return t[kc].at(i.add(i.mul(t[Oc],i.uint(t.$builtins.instanceIndex)),t[Uc],i.uint(e)))}static getNormalMatrix(t){return this.getWorldMatrix(t)}static vertexShaderDrawableStuff(t,e,i,s){const r=t.$builder;s?(t[Oc]=r.uint().uniform(1),t[Uc]=r.uint().uniform(1),t[kc]=r.vec4[4096]().uniformBuffer(3)):(t[Lc]=r.mat4().uniform(1),t[zc]=r.mat4().uniform(1),t[Vc]=r.int().uniform(1),t[Nc]=r.vec4().uniform(1)),e&&(t[Gc]=r.tex2D().uniform(1).sampleType("unfilterable-float"),t[Wc]=r.mat4().uniform(1),t[Hc]=r.vec2().uniform(1)),i&&(t[Xc]=r.tex2D().uniform(1).sampleType("unfilterable-float"),t[jc]=r.vec4[67]().uniformBuffer(1))}static prepareVertexShaderCommon(t,e){this.vertexShaderDrawableStuff(t.getGlobalScope(),!!(e.materialFlags&gu.SKIN_ANIMATION),!!(e.materialFlags&gu.MORPH_ANIMATION),!!(e.materialFlags&gu.INSTANCING))}static setCameraUniforms(t,e,i){const s=e.camera.getWorldPosition(),r=e.motionVectors&&1!==e.renderPass.type&&3!==e.renderPass.type,a={position:new O(s.x,s.y,s.z,e.camera.clipPlane?1:0),clipPlane:e.camera.clipPlane??O.zero(),renderSize:new L(e.renderWidth,e.renderHeight),viewProjectionMatrix:r?e.camera.jitteredVPMatrix:e.camera.viewProjectionMatrix,unjitteredVPMatrix:e.camera.viewProjectionMatrix,jitteredInvVPMatrix:r?e.camera.jitteredInvVPMatrix:e.camera.invViewProjectionMatrix,jitterValue:e.camera.jitterValue,invViewProjectionMatrix:e.camera.invViewProjectionMatrix,projectionMatrix:e.camera.getProjectionMatrix(),invProjectionMatrix:e.camera.getInvProjectionMatrix(),viewMatrix:e.camera.viewMatrix,worldMatrix:e.camera.worldMatrix,params:new O(e.camera.getNearPlane(),e.camera.getFarPlane(),e.flip?-1:1,i?0:1),roughnessFactor:e.camera.SSR?e.camera.ssrRoughnessFactor:1,frameDeltaTime:.001*Sl().frameInfo.elapsedFrame,elapsedTime:.001*Sl().frameInfo.elapsedOverall,framestamp:Sl().frameInfo.frameCounter};e.motionVectors&&2===e.renderPass.type&&(a.prevUnjitteredVPMatrix=e.camera.prevVPMatrix),0===e.renderPass.type&&(e.linearDepthTexture&&(t.setTexture(Ic,e.linearDepthTexture),t.setValue(Pc,new L(e.linearDepthTexture.width,e.linearDepthTexture.height))),e.sceneColorTexture&&(t.setTexture($c,e.sceneColorTexture),t.setValue(Rc,new L(e.sceneColorTexture.width,e.sceneColorTexture.height))),e.HiZTexture&&(t.setTexture(Fc,e.HiZTexture,Gl("clamp_nearest")),t.setValue(Dc,new O(e.HiZTexture.width,e.HiZTexture.height,e.HiZTexture.mipLevelCount,0)))),t.setValue("camera",a)}static setLightUniformsShadowMap(t,e,i){if(i){const s=e.shadowMapInfo.get(i);t.setValue("light",{positionAndRange:i.positionAndRange,directionCutoff:i.directionAndCutoff,viewMatrix:i.viewMatrix,depthBias:s.depthBiasValues[0],lightType:i.lightType})}}static setFogUniforms(t,e,i,s,r,a,n,o){this._fogUniforms.withAerialPerspective=e,this._fogUniforms.fogType=i,this._fogUniforms.additive=s,this._fogUniforms.atmosphereParams=r,this._fogUniforms.heightFogParams=a,t.setValue("fog",this._fogUniforms),t.setTexture(Ec,n),t.setTexture(Mc,o)}static setLightUniforms(t,e,i,s,r,a){t.setValue("light",{sunDir:e.sunLight?e.sunLight.directionAndCutoff.xyz().scaleBy(-1):this.defaultSunDir,clusterParams:i,countParams:s,envLightStrength:e.env.light.strength??0,lightIndexTexSize:new Int32Array([a.width,a.height])}),t.setBuffer(Sc,r),t.setTexture(Ac,a),t.setTexture(Cc,e.scene.env.sky.getBakedSkyTexture(e)),e.drawEnvLight&&e.env.light.envLight.updateBindGroup(t)}static setLightUniformsShadow(t,e,i){const s=e.shadowMapInfo.get(i);this._lightUniformShadow.sunDir=e.sunLight?e.sunLight.directionAndCutoff.xyz().scaleBy(-1):this.defaultSunDir,this._lightUniformShadow.envLightStrength=e.env?.light.strength??0,this._lightUniformShadow.shadowCascades=s.numShadowCascades,this._lightUniformShadow.positionAndRange.set(i.positionAndRange),this._lightUniformShadow.directionAndCutoff.set(i.directionAndCutoff),this._lightUniformShadow.diffuseAndIntensity.set(i.diffuseAndIntensity),this._lightUniformShadow.cascadeDistances.set(s.cascadeDistances),this._lightUniformShadow.depthBiasValues.set(s.depthBiasValues[0]),this._lightUniformShadow.shadowCameraParams.set(s.cameraParams),this._lightUniformShadow.depthBiasScales.set(s.depthBiasScales),this._lightUniformShadow.shadowMatrices.set(s.shadowMatrices),t.setValue("light",this._lightUniformShadow),t.setTexture(Bc,s.shadowMap,s.shadowMapSampler),t.setTexture(Cc,e.scene.env.sky.getBakedSkyTexture(e)),e.drawEnvLight&&e.env.light.envLight.updateBindGroup(t)}static getEnvLightStrength(t){return t.light.envLightStrength}static getSceneColorTexture(t){return t[$c]}static getSceneColorTextureSize(t){return t[Rc]}static getLinearDepthTexture(t){return t[Ic]}static getLinearDepthTextureSize(t){return t[Pc]}static getHiZDepthTexture(t){return t[Fc]}static getHiZDepthTextureSize(t){return t[Dc].xy}static getHiZDepthTextureMipLevelCount(t){return t[Dc].z}static getBakedSkyTexture(t){return t[Cc]}static getElapsedTime(t){return t.camera.elapsedTime}static getElapsedTimeFrame(t){return t.camera.frameDeltaTime}static getCameraPosition(t){return t.camera.position.xyz}static getCameraRoughnessFactor(t){return t.camera.roughnessFactor}static getRenderSize(t){return t.camera.renderSize}static getFramestamp(t){return t.camera.framestamp}static discardIfClipped(t,e){const i="Z_discardIfClippped",s=t.$builder,r=this;s.func(i,[s.vec3("worldPos")],function(){this.$if(s.notEqual(r.getCameraClipPlaneFlag(this),0),function(){this.$l.clipPlane=r.getCameraClipPlane(this),this.$if(s.greaterThan(s.add(s.dot(this.worldPos.xyz,this.clipPlane.xyz),this.clipPlane.w),0),function(){s.discard()})})}),s.getGlobalScope()[i](e)}static getCameraClipPlaneFlag(t){return t.camera.position.w}static getCameraClipPlane(t){return t.camera.clipPlane}static getCameraParams(t){return t.camera.params}static getClusterParams(t){return t.light.clusterParams}static getCountParams(t){return t.light.countParams}static getClusteredLightIndexTexture(t){return t[Ac]}static getAtmosphereParams(t){return t.fog.atmosphereParams}static getAerialPerspectiveLUT(t){return t[Ec]}static getViewProjectionMatrix(t){return t.camera.viewProjectionMatrix}static getInvViewProjectionMatrix(t){return t.camera.invViewProjectionMatrix}static getProjectionMatrix(t){return t.camera.projectionMatrix}static getInvProjectionMatrix(t){return t.camera.invProjectionMatrix}static getUnjitteredViewProjectionMatrix(t){return t.camera.unjitteredVPMatrix}static getProjectionMatrixJitterValue(t){return t.camera.jitterValue}static getJitteredInvVPMatrix(t){return t.camera.jitteredInvVPMatrix}static getPrevUnjitteredViewProjectionMatrix(t){return t.camera.prevUnjitteredVPMatrix}static getViewMatrix(t){return t.camera.viewMatrix}static getInvViewMatrix(t){return t.camera.worldMatrix}static getCascadeDistances(t){return t.light.cascadeDistances}static getDepthBiasValues(t){return t.light.depthBiasValues}static getShadowCameraParams(t){return t.light.shadowCameraParams}static getDepthBiasScales(t){return t.light.depthBiasScales}static getNumLights(t){return t.light.numLights}static getSunLightDir(t){return t.light.sunDir}static getLightTypeForShadow(t){return t.light.lightType}static getLightPositionAndRangeForShadow(t){return t.light.positionAndRange}static getLightViewMatrixForShadow(t){return t.light.viewMatrix}static calculateShadowSpaceVertex(t,e,i=0){const s=t.$builder;return"number"==typeof i?s.vec4(s.dot(t.light.shadowMatrices.at(4*i+0),e),s.dot(t.light.shadowMatrices.at(4*i+1),e),s.dot(t.light.shadowMatrices.at(4*i+2),e),s.dot(t.light.shadowMatrices.at(4*i+3),e)):s.vec4(s.dot(t.light.shadowMatrices.at(s.add(s.mul(i,4),0)),e),s.dot(t.light.shadowMatrices.at(s.add(s.mul(i,4),1)),e),s.dot(t.light.shadowMatrices.at(s.add(s.mul(i,4),2)),e),s.dot(t.light.shadowMatrices.at(s.add(s.mul(i,4),3)),e))}static getLightPositionAndRange(t,e){return t[Sc].at(t.$builder.mul(e,3))}static getLightDirectionAndCutoff(t,e){return t[Sc].at(t.$builder.add(t.$builder.mul(e,3),1))}static getLightColorAndIntensity(t,e){return t[Sc].at(t.$builder.add(t.$builder.mul(e,3),2))}static setClipSpacePosition(t,e){const i=t.$builder,s=this.getCameraParams(t);t.$builtins.position=s?i.mul(e,i.vec4(1,s.z,1,1)):e}static getShadowMap(t){return t[Bc]}static calculateShadow(t,e,i,s){const r=t.$builder,a=this,n=s.shadowMapInfo.get(s.currentShadowLight),o="Z_calculateShadow";return r.func(o,[r.vec3("worldPos"),r.float("NoL")],function(){if(n.numShadowCascades>1){this.$l.shadowCascades=this.light.shadowCascades,this.$l.shadowBound=r.vec4(0,0,1,1),this.$l.linearDepth=a.nonLinearDepthToLinear(this,this.$builtins.fragCoord.z),this.$l.splitDistances=a.getCascadeDistances(this),this.$l.comparison=r.vec4(r.greaterThan(r.vec4(this.linearDepth),this.splitDistances)),this.$l.cascadeFlags=r.vec4(r.float(r.greaterThan(this.shadowCascades,0)),r.float(r.greaterThan(this.shadowCascades,1)),r.float(r.greaterThan(this.shadowCascades,2)),r.float(r.greaterThan(this.shadowCascades,3))),this.$l.split=r.int(r.dot(this.comparison,this.cascadeFlags)),"webgl"===s.device.type?(this.$l.shadowVertex=r.vec4(),this.$for(r.int("cascade"),0,4,function(){this.$if(r.equal(this.cascade,this.split),function(){this.shadowVertex=a.calculateShadowSpaceVertex(this,r.vec4(this.worldPos,1),this.cascade),this.$break()})})):this.$l.shadowVertex=a.calculateShadowSpaceVertex(this,r.vec4(this.worldPos,1),this.split);const e=s.shadowMapInfo.get(s.currentShadowLight);this.$l.shadow=e.impl.computeShadowCSM(e,this,this.shadowVertex,this.NoL,this.split),this.$l.shadowDistance=a.getShadowCameraParams(t).w,this.shadow=r.mix(this.shadow,1,r.smoothStep(r.mul(this.shadowDistance,.8),this.shadowDistance,r.distance(a.getCameraPosition(this),this.worldPos))),this.$return(this.shadow)}else{this.$l.shadowVertex=a.calculateShadowSpaceVertex(this,r.vec4(this.worldPos,1));const e=s.shadowMapInfo.get(s.currentShadowLight);this.$l.shadow=e.impl.computeShadow(e,this,this.shadowVertex,this.NoL),this.$l.shadowDistance=a.getShadowCameraParams(t).w,this.shadow=r.mix(this.shadow,1,r.smoothStep(r.mul(this.shadowDistance,.8),this.shadowDistance,r.distance(a.getCameraPosition(this),this.worldPos))),this.$return(this.shadow)}}),r.getGlobalScope()[o](e,i)}static applyFog(t,e,i,s){const r=t.$builder,a=this;if(s.materialFlags&gu.APPLY_FOG){const s="Z_applyFog";r.func(s,[r.vec3("worldPos"),r.vec4("color").inout()],function(){this.$l.uv=r.div(r.vec2(this.$builtins.fragCoord.xy),a.getRenderSize(this)),this.$l.fogging=wc(this,this.fog.withAerialPerspective,this.fog.fogType,this.fog.atmosphereParams,this.fog.heightFogParams,this.uv,!1,a.getCameraPosition(this).xyz,this.worldPos,this.fog.additive,this[Ec],this[Mc]),this.color=r.vec4(r.add(r.mul(this.color.rgb,this.fogging.a),this.fogging.rgb),this.color.a)}),t[s](e,i)}}static linearDepthToNonLinear(t,e,i){const s=t.$builder;return i=i??this.getCameraParams(t),s.div(s.sub(i.y,s.div(s.mul(i.x,i.y),e)),s.sub(i.y,i.x))}static nonLinearDepthToLinear(t,e,i){const s=t.$builder;return i=i??this.getCameraParams(t),s.div(s.mul(i.x,i.y),s.mix(i.y,i.x,e))}static nonLinearDepthToLinearNormalized(t,e,i){const s=t.$builder;return i=i??this.getCameraParams(t),s.div(i.x,s.mix(i.y,i.x,e))}static sampleLinearDepth(t,e,i,s){const r=t.$builder,a=r.textureSampleLevel(e,i,s);return"webgl"===r.getDevice().type?El(t,a):a.r}static samplePositionFromDepth(t,e,i,s,r){const a=t.$builder,n=this;return a.func("zSamplePositionFromDepth",[a.vec2("uv"),a.vec2("cameraNearFar"),a.mat4("mat")],function(){this.$l.linearDepth=n.sampleLinearDepth(this,e,this.uv,0),this.$l.nonLinearDepth=a.div(a.sub(a.div(this.cameraNearFar.x,this.linearDepth),this.cameraNearFar.y),a.sub(this.cameraNearFar.x,this.cameraNearFar.y)),this.$l.clipSpacePos=a.vec4(a.sub(a.mul(this.uv,2),a.vec2(1)),a.sub(a.mul(a.clamp(this.nonLinearDepth,0,1),2),1),1),this.$l.wPos=a.mul(this.mat,this.clipSpacePos),this.$return(a.vec4(a.div(this.wPos.xyz,this.wPos.w),this.linearDepth))}),t.zSamplePositionFromDepth(i,r,s)}static sampleLinearDepthWithBackface(t,e,i,s){return t.$builder.textureSampleLevel(e,i,s).rg}static encodeColorOutput(t,e){const i=t.$builder,s=this,r="Z_encodeColorOutput";return i.func(r,[i.vec4("outputColor")],function(){const t=s.getCameraParams(this);this.$if(i.notEqual(t.w,0),function(){this.$return(i.vec4(Il(this,this.outputColor.rgb),this.outputColor.w))}).$else(function(){this.$return(this.outputColor)})}),i.getGlobalScope()[r](e)}}class qc extends gt{static _nextId=0;_states;_numPasses;_hash;_optionTag;_id;_currentHash;_changeTag;_nextProgramId=0;constructor(){super(),this._id=++qc._nextId,this._nextProgramId=0,this._states={},this._numPasses=1,this._hash=[null],this._optionTag=0,this._changeTag=0,this._currentHash=[]}clone(){const t=new qc;return t.copyFrom(this),t}copyFrom(t){this.clearCache(),this._numPasses=t._numPasses,wl().resourceManager.setAssetId(this,wl().resourceManager.getAssetId(t.coreMaterial))}get changeTag(){return this._changeTag}get instanceId(){return this._id}get numPasses(){return this._numPasses}set numPasses(t){for(;this._hash.length<t;)this._hash.push(null);this._numPasses=t}getHash(t){return null===this._hash[t]&&(this._hash[t]=this.createHash(t)),this._hash[t]}getQueueType(){return 1}isTransparentPass(t){return!1}supportLighting(){return!0}supportInstancing(){return!0}isBatchable(){return!1}needSceneColor(){return!1}needSceneDepth(){return!1}createInstance(){return null}get coreMaterial(){return this}apply(t){for(let e=0;e<this._numPasses;e++){const i=this.calcGlobalHash(t,e);let s=this._states[i];if(!s){const r=this.createProgram(t,e)??null;r.name=`@${this.constructor.name}_program_${this._nextProgramId++}`;const a=r.bindGroupLayouts.length>2?t.device.createBindGroup(r.bindGroupLayouts[2]):null;s={program:r,bindGroup:a,bindGroupTag:a?.getGPUId()??"",renderStateSet:t.device.createRenderStateSet(),materialTag:-1},this._states[i]=s}if(!s.program)return!1;if(this.applyUniforms(s.bindGroup,t,s.materialTag!==this._optionTag,e),s.materialTag=this._optionTag,this.updateRenderStates(e,s.renderStateSet,t),this._currentHash[e]=i,s.bindGroup){const t=s.bindGroup.getGPUId();t!==s.bindGroupTag&&(s.bindGroupTag=t,this._changeTag++,Al.materialChanged(this.coreMaterial))}}}bind(t,e){const i=this._currentHash[e],s=this._states[i];return s?!!s.program&&(t.setProgram(s.program),t.setBindGroup(2,s.bindGroup),void t.setRenderStates(s.renderStateSet)):(console.error("Material.bind() failed: state not found"),!1)}calcGlobalHash(t,e){return`${this.getHash(e)}:${t.materialFlags}:${t.renderPassHash}`}draw(t,e,i=0){for(let s=0;s<this._numPasses;s++)this.bind(e.device,s),this.drawPrimitive(s,t,e,i)}applyUniforms(t,e,i,s){i&&this._applyUniforms(t,e,s)}optionChanged(t){if(this._optionTag++,t){for(let t=0;t<this._numPasses;t++)this._hash[t]=null;this._changeTag++,Al.materialChanged(this.coreMaterial)}}clearCache(){for(const t in this._states)this._states[t]?.bindGroup?.dispose(),this._states[t]?.program?.dispose();this._states={}}passToHash(t){return String(t)}createHash(t){return`${this.constructor.name}|${t}|${this._createHash()}`}drawPrimitive(t,e,i,s){s>0?e.drawInstanced(s):i.instanceData?e.drawInstanced(i.instanceData.numInstances):e.draw()}onDispose(){super.onDispose(),this.clearCache()}createProgram(t,e){const i=new fn(t.device);return this._createProgram(i,t,e)}_createProgram(t,e,i){return null}_applyUniforms(t,e,i){}updateRenderStates(t,e,i){}_createHash(){return""}get $isInstance(){return!1}get $instanceUniforms(){return null}}function Yc(t,...e){return a(t,...e)}let Zc=0,Kc=0,Jc=0,td=0;class ed extends qc{static INSTANCE_UNIFORMS=[];static NEXT_FEATURE_INDEX=3;static OBJECT_COLOR_UNIFORM=this.defineInstanceUniform("objectColor","rgba");static OPACITY_UNIFORM=this.defineInstanceUniform("opacity","float","Opacity");_featureStates;_alphaCutoff;_blendMode;_cullMode;_opacity;_taaStrength;_objectColor;_ctx;_materialPass;constructor(){super(),this._featureStates=[],this._alphaCutoff=0,this._blendMode="none",this._cullMode="back",this._opacity=1,this._taaStrength=.9375,this._objectColor=O.one(),this._ctx=null,this._materialPass=-1,this.useFeature(Kc,this._blendMode)}clone(){const t=new ed;return t.copyFrom(this),t}copyFrom(t){super.copyFrom(t),this.alphaCutoff=t.alphaCutoff,this.blendMode=t.blendMode,this.cullMode=t.cullMode,this.opacity=t.opacity,this.objectColor=t.objectColor}uniformChanged(){this.optionChanged(!1)}static defineFeature(){const t=this.NEXT_FEATURE_INDEX;return this.NEXT_FEATURE_INDEX++,t}static getNumComponents(t){return"float"===t?1:"vec2"===t?2:"rgb"===t||"vec3"===t?3:"rgba"===t||"vec4"===t?4:0}static defineInstanceUniform(t,e,i=""){if(this.INSTANCE_UNIFORMS.findIndex(e=>e.prop===t)>=0)throw new Error(`${this.name}.defineInstanceUniform(): ${t} was already defined`);const s=this.getNumComponents(e);if(0===s)throw new Error(`${this.name}.defineInstanceUniform(): invalid uniform type ${e}`);let r=this.INSTANCE_UNIFORMS.length,a=0;if(this.INSTANCE_UNIFORMS.length>0){const t=this.INSTANCE_UNIFORMS[this.INSTANCE_UNIFORMS.length-1].offset+4&-4;a=t;for(let e=0;e<this.INSTANCE_UNIFORMS.length;e++){const i=this.INSTANCE_UNIFORMS[e].offset,n=this.getNumComponents(this.INSTANCE_UNIFORMS[e].type),o=e===this.INSTANCE_UNIFORMS.length-1?t:this.INSTANCE_UNIFORMS[e+1].offset;if(i+n+s<=o&&(r=e+1,a=i+n,a+s===o))break}}return this.INSTANCE_UNIFORMS=this.INSTANCE_UNIFORMS.slice(),this.INSTANCE_UNIFORMS.splice(r,0,{prop:t,offset:a,type:e,name:i}),a<<2|s-1}getInstancedUniform(t,e){const i=t.$builder,s=t.$builtins.instanceIndex,r=Qc.getInstanceDataUniformName(),a=Qc.getInstanceDataStrideUniformName(),n=Qc.getInstanceDataOffsetUniformName(),o=1+(3&e),h=e>>4,l=e>>2&3;return t[r].at(i.add(i.mul(t[a],s),Qc.MATERIAL_INSTANCE_DATA_OFFSET+h,t[n]))[["x","y","z","w"].slice(l,l+o).join("")]}getInstancedUniforms(){return this.constructor.INSTANCE_UNIFORMS}createInstance(){if(this.$isInstance)return this.coreMaterial.createInstance();if("webgl"===Sl().type||!this.supportInstancing())return this.clone();const t=this.getInstancedUniforms(),e=t.length>0?new Float32Array(t[t.length-1].offset+4&-4):null,i={},s=this,r=new wt(s);let a=!1;i.isBatchable=()=>!0,i.dispose=()=>{a||(a=!0,r.dispose())},i.$instanceUniforms=e,i.$isInstance=!0,Object.defineProperty(i,"coreMaterial",{get:function(){return r.get()}});for(let r=0;r<t.length;r++){const{prop:a,offset:n,type:o}=t[r],h=s[a];switch(o){case"float":e[n]=Number(h),Object.defineProperty(i,a,{get:()=>e[n],set(t){e[n]=t,Al.materialUniformsChanged(i)}});break;case"vec2":if(!(h instanceof L))throw new Error(`Instance uniform property ${a} must be of type Vector2`);e[n]=h.x,e[n+1]=h.y,Object.defineProperty(i,a,{get:()=>new L(e[n],e[n+1]),set(t){if(!(t instanceof L))throw new Error(`Instance uniform property ${a} must be of type Vector2`);e[n]=t.x,e[n+1]=t.y,Al.materialUniformsChanged(i)}});break;case"vec3":case"rgb":if(!(h instanceof z))throw new Error(`Instance uniform property ${a} must be of type Vector3`);e[n]=h.x,e[n+1]=h.y,e[n+2]=h.z,Object.defineProperty(i,a,{get:()=>new z(e[n],e[n+1],e[n+2]),set(t){if(!(t instanceof z))throw new Error(`Instance uniform property ${a} must be of type Vector3`);e[n]=t.x,e[n+1]=t.y,e[n+2]=t.z,Al.materialUniformsChanged(i)}});break;case"vec4":case"rgba":if(!(h instanceof O))throw new Error(`Instance uniform property ${a} must be of type Vector4`);e[n]=h.x,e[n+1]=h.y,e[n+2]=h.z,e[n+3]=h.w,Object.defineProperty(i,a,{get:()=>new O(e[n],e[n+1],e[n+2],e[n+3]),set(t){if(!(t instanceof O))throw new Error(`Instance uniform property ${a} must be of type Vector4`);e[n]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,Al.materialUniformsChanged(i)}})}}return Object.setPrototypeOf(i,s),i}get drawContext(){return this._ctx}get pass(){return this._materialPass}get alphaCutoff(){return this._alphaCutoff}set alphaCutoff(t){this._alphaCutoff!==t&&(this.useFeature(Zc,t>0),this._alphaCutoff=t,this.uniformChanged())}get TAADisabled(){return!!this.featureUsed(td)}set TAADisabled(t){this.useFeature(td,!!t)}get TAAStrength(){return this._taaStrength}set TAAStrength(t){t=t>1?1:t<0?0:t,this._taaStrength!==t&&(this._taaStrength=t,this.uniformChanged())}get alphaToCoverage(){return this.featureUsed(Jc)}set alphaToCoverage(t){this.useFeature(Jc,!!t)}get blendMode(){return this._blendMode}set blendMode(t){this._blendMode!==t&&(this._blendMode=t,this.useFeature(Kc,this._blendMode))}get cullMode(){return this._cullMode}set cullMode(t){this._cullMode=t}get opacity(){return this._opacity}set opacity(t){t=t<0?0:t>1?1:t,this._opacity!==t&&(this._opacity=t,this.uniformChanged())}get objectColor(){return this._objectColor}set objectColor(t){t!==this._objectColor&&(this._objectColor.set(t??O.one()),this.uniformChanged())}supportLighting(){return!0}updateRenderStates(t,e,i){const s=3===i.renderPass.type,r=!s&&("none"!==this.featureUsed(Kc)||i.lightBlending),a=!s&&this.featureUsed(Jc),n=1===i.queue&&!!i.depthTexture&&!i.sceneColorTexture;if(r||a){const t=e.useBlendingState();r?(t.enable(!0),t.setBlendFuncAlpha("zero","one"),t.setBlendEquation("add","add"),"additive"===this._blendMode||i.lightBlending?t.setBlendFuncRGB("one","one"):t.setBlendFuncRGB("one","inv-src-alpha")):t.enable(!1),t.enableAlphaToCoverage(a),n?e.useDepthState().setCompareFunc("eq").enableTest(!0).enableWrite(!1):t.enabled?e.useDepthState().enableTest(!0).enableWrite(!1):e.defaultDepthState()}else e.defaultBlendingState(),n?e.useDepthState().setCompareFunc("eq").enableTest(!0).enableWrite(!1):e.defaultDepthState();i.forceCullMode||"back"!==this._cullMode?e.useRasterizerState().cullMode=i.forceCullMode||this._cullMode:1===i.renderPass.type?e.useRasterizerState().cullMode="none":e.defaultRasterizerState(),i.forceColorState?e.useColorState(i.forceColorState):e.defaultColorState(),e.defaultStencilState(),i.oit&&i.oit.setRenderStates(e)}applyUniformValues(t,e,i){this.featureUsed(Zc)&&t.setValue("zAlphaCutoff",this._alphaCutoff),!this.isTransparentPass(i)||0!==e.renderPass.type||e.materialFlags&gu.INSTANCING||t.setValue("zOpacity",this._opacity),e.oit&&e.oit.applyUniforms(e,t),2===e.renderPass.type&&e.motionVectors&&t.setValue("zTAAStrength",5e4*(1-this._taaStrength))}getQueueType(){return this.isTransparentPass(0)?2:1}isTransparentPass(t){return"none"!==this.featureUsed(Kc)}createProgram(t,e){const i=new fn(t.device);if(1===t.renderPass.type){const e=t.shadowMapInfo.get(t.renderPass.light);i.emulateDepthClamp=!!e.depthClampEnabled}return this._createProgram(i,t,e)}featureUsed(t){return this._featureStates[t]}useFeature(t,e){this._featureStates[t]!==e&&(this._featureStates[t]=e,this.optionChanged(!0))}_createHash(){return this._featureStates.map(t=>void 0===t?"":t).join("|")}_applyUniforms(t,e,i){this.applyUniformValues(t,e,i)}needFragmentColor(t){return 0===(t??this.drawContext).renderPass.type||this._alphaCutoff>0||this.alphaToCoverage}vertexShader(t){const e=t.$builder;Qc.prepareVertexShader(e,this.drawContext),this.drawContext.materialFlags&gu.SKIN_ANIMATION&&(t.$inputs.zBlendIndices=e.vec4().attrib("blendIndices"),t.$inputs.zBlendWeights=e.vec4().attrib("blendWeights"),Qc.prepareSkinAnimation(t)),this.drawContext.materialFlags&gu.MORPH_ANIMATION&&"webgl"===this.drawContext.device.type&&(t.$inputs.zFakeVertexID=e.float().attrib("texCoord7")),this.drawContext.materialFlags&gu.INSTANCING?(3===this.drawContext.renderPass.type&&(t.$outputs.zObjectColor=this.getInstancedUniform(t,ed.OBJECT_COLOR_UNIFORM)),this.isTransparentPass(this.pass)&&(t.$outputs.zOpacity=this.getInstancedUniform(t,ed.OPACITY_UNIFORM))):3===this.drawContext.renderPass.type&&(t.$outputs.zObjectColor=t[Qc.getObjectColorUniformName()])}fragmentShader(t){const e=t.$builder;Qc.prepareFragmentShader(e,this.drawContext),this._alphaCutoff>0&&(t.zAlphaCutoff=e.float().uniform(2)),0===this.drawContext.renderPass.type&&(!this.isTransparentPass(this.pass)||this.drawContext.materialFlags&gu.INSTANCING||(t.zOpacity=e.float().uniform(2)))}_createProgram(t,e,i){const s=this;this._ctx=e,this._materialPass=i;const r=t.buildRenderProgram({vertex(t){t.main(function(){s.vertexShader(this)})},fragment(t){s.drawContext.oit?s.drawContext.oit.setupFragmentOutput(this):(this.$outputs.zFragmentOutput=t.vec4(),e.materialFlags&gu.SSR_STORE_ROUGHNESS&&(this.$outputs.zSSRRoughness=t.vec4(),this.$outputs.zSSRNormal=t.vec4()),2===e.renderPass.type&&e.motionVectors&&(this.$outputs.zMotionVector=t.vec4(),this.zTAAStrength=t.float().uniform(2)),3===e.renderPass.type&&(this.$outputs.zDistance=t.vec4())),t.main(function(){s.fragmentShader(this)})}});return r}outputFragmentColor(t,e,i,s,r){const a=t.$builder,n=this,o="Z_outputFragmentColor";a.func(o,i?[a.vec3("worldPos"),a.vec4("color")]:[a.vec3("worldPos")],function(){if(this.$l.outColor=i?this.color:a.vec4(),0===n.drawContext.renderPass.type){Qc.discardIfClipped(this,this.worldPos);let t=!0;if(n.isTransparentPass(n.pass)||n.alphaToCoverage){if(n.isTransparentPass(n.pass)){const t=n.drawContext.materialFlags&gu.INSTANCING?this.$inputs.zOpacity:this.zOpacity;this.outColor.a=a.mul(this.outColor.a,t)}}else this.outColor.a=1;n.isTransparentPass(n.pass)&&(this.zAlphaCutoff&&this.$if(a.lessThan(this.outColor.a,this.zAlphaCutoff),function(){a.discard()}),n.drawContext.oit&&!n.drawContext.oit.wantsPremultipliedAlpha()||(this.outColor=a.vec4(a.mul(this.outColor.rgb,this.outColor.a),"additive"===n.featureUsed(Kc)?0:this.outColor.a)),t=!n.drawContext.oit||!n.drawContext.oit.outputFragmentColor(this,this.outColor)),t&&(Qc.applyFog(this,this.worldPos,this.outColor,n.drawContext),this.$outputs.zFragmentOutput=Qc.encodeColorOutput(this,this.outColor))}else if(2===n.drawContext.renderPass.type){i&&this.zAlphaCutoff&&this.$if(a.lessThan(this.outColor.a,this.zAlphaCutoff),function(){a.discard()}),Qc.discardIfClipped(this,this.worldPos);const t=n.drawContext.renderPass;this.$l.depth=Qc.nonLinearDepthToLinearNormalized(this,this.$builtins.fragCoord.z),t.encodeDepth?this.$outputs.zFragmentOutput=Ml(this,this.depth):t.renderBackface?this.$outputs.zFragmentOutput=a.vec4(0,this.depth,0,1):this.$outputs.zFragmentOutput=a.vec4(this.depth,0,0,1),n.drawContext.motionVectors&&(n.featureUsed(td)?this.$outputs.zMotionVector=a.vec4(6e4,6e4,1,1):this.$inputs.zMotionVectorPosCurrent&&this.$inputs.zMotionVectorPosPrev?this.$outputs.zMotionVector=a.vec4(a.mul(a.sub(a.div(this.$inputs.zMotionVectorPosCurrent.xy,this.$inputs.zMotionVectorPosCurrent.w),a.div(this.$inputs.zMotionVectorPosPrev.xy,this.$inputs.zMotionVectorPosPrev.w)),.5),this.zTAAStrength,1):this.$outputs.zMotionVector=a.vec4(0,0,1,1))}else if(3===n.drawContext.renderPass.type)i&&this.$if(a.lessThan(this.outColor.a,this.zAlphaCutoff),function(){a.discard()}),Qc.discardIfClipped(this,this.worldPos),this.$outputs.zFragmentOutput=t.$inputs.zObjectColor,"webgl"===n.drawContext.device.type?(this.$l.linearDepth=Qc.nonLinearDepthToLinearNormalized(this,this.$builtins.fragCoord.z),this.$outputs.zDistance=Ml(this,this.linearDepth)):this.$outputs.zDistance=a.vec4(this.worldPos,a.distance(Qc.getCameraPosition(this),this.worldPos));else{i&&this.$if(a.lessThan(this.outColor.a,this.zAlphaCutoff),function(){a.discard()}),Qc.discardIfClipped(this,this.worldPos);const t=n.drawContext.shadowMapInfo.get(n.drawContext.renderPass.light);this.$outputs.zFragmentOutput=t.impl.computeShadowMapDepth(t,this,this.worldPos)}}),i?a.getGlobalScope()[o](e,i):a.getGlobalScope()[o](e),n.drawContext.materialFlags&gu.SSR_STORE_ROUGHNESS&&(t.$outputs.zSSRRoughness=s??a.vec4(1,0,0,1),t.$outputs.zSSRNormal=r??a.vec4(0))}}function id(t){return function(e,i=!1){var s,r,a;const n=`${t[0].toUpperCase()}${t.slice(1)}`,o=`mixinTexture${n}`;let h=0,l=0,u=0;if(e[o])return e;s=`sample${n}Texture`,r=`get${n}TextureUniform`,a=`get${n}TexCoord`;const c=class extends e{constructor(){super();const e=new wt;let i=null,s=0,r=null;Object.defineProperty(this,`${t}Texture`,{get:function(){return e.get()},set:function(t){e.get()!==t&&(e.set(t),this.useFeature(h,!!t),t&&(this.useFeature(l,s),this.useFeature(u,!!r),this.uniformChanged()))},enumerable:!0,configurable:!0}),Object.defineProperty(this,`${t}TextureSampler`,{get:function(){return i},set:function(t){i!==t&&(i=t,this.uniformChanged())},enumerable:!0,configurable:!0}),Object.defineProperty(this,`${t}TexCoordMatrix`,{get:function(){return r},set:function(t){r=t,this.useFeature(u,!!r),this.uniformChanged()},enumerable:!0,configurable:!0}),Object.defineProperty(this,`${t}TexCoordIndex`,{get:function(){return s},set:function(t){s!==t&&(s=t,this.useFeature(l,s),this.uniformChanged())},enumerable:!0,configurable:!0})}[s](t,e){const i=this[`get${n}TextureUniform`](t),s=e??this[`get${n}TexCoord`](t);return t.$builder.textureSample(i,s)}[r](t){return"fragment"===t.$builder.shaderKind?t[`z${n}Tex`]:null}[a](e){const s=this[`${t}TexCoordIndex`];if(s<0)return null;const r=e.$builder;if("vertex"===r.shaderKind!=!!i)throw new Error(`mixinTextureProps.get${n}TexCoord(): must be called in ${i?"vertex":"fragment"} stage`);return"fragment"===e.$builder.shaderKind?e.$inputs[`z${n}TexCoord`]:this.featureUsed(u)?r.mul(e[`z${n}TextureMatrix`],r.vec4(e.$inputs[`texCoord${s}`],0,1)).xy:e.$inputs[`texCoord${s}`]}copyFrom(e){super.copyFrom(e);const i=this;i[`${t}Texture`]=e[`${t}Texture`],i[`${t}TextureSampler`]=e[`${t}TextureSampler`],i[`${t}TexCoordMatrix`]=e[`${t}TexCoordMatrix`],i[`${t}TexCoordIndex`]=e[`${t}TexCoordIndex`]}vertexShader(e){if(super.vertexShader(e),i||this.needFragmentColor()){const s=e.$builder,r=this;if(this.featureUsed(h)){if(r[`${t}TexCoordIndex`]>=0){const a=`texCoord${r[`${t}TexCoordIndex`]}`;e.$getVertexAttrib(a)||(e.$inputs[a]=s.vec2().attrib(a)),this.featureUsed(u)?(e[`z${n}TextureMatrix`]=s.mat4().uniform(2),i||(e.$outputs[`z${n}TexCoord`]=s.mul(e[`z${n}TextureMatrix`],s.vec4(e.$inputs[a],0,1)).xy)):i||(e.$outputs[`z${n}TexCoord`]=e.$inputs[a])}}}}fragmentShader(t){if(super.fragmentShader(t),this.needFragmentColor()){const e=t.$builder;this.featureUsed(h)&&(t[`z${n}Tex`]=e.tex2D().uniform(2))}}applyUniformValues(e,i,s){if(super.applyUniformValues(e,i,s),this.needFragmentColor(i)&&this.featureUsed(h)){const i=this;e.setTexture(`z${n}Tex`,i[`${t}Texture`],i[`${t}TextureSampler`]),this.featureUsed(u)&&e.setValue(`z${n}TextureMatrix`,i[`${t}TexCoordMatrix`])}}onDispose(){super.onDispose(),this[`${t}Texture`]=null}};return h=c.defineFeature(),l=c.defineFeature(),u=c.defineFeature(),c[o]=!0,c}}function sd(t){if(t.albedoColorMixed)return t;const e=Yc(t,id("albedo")),i=e.defineInstanceUniform("albedoColor","rgba","AlbedoColor");return class extends e{static albedoColorMixed=!0;_albedoColor;constructor(){super(),this._albedoColor=O.one()}copyFrom(t){super.copyFrom(t),this.albedoColor=t.albedoColor}get albedoColor(){return this._albedoColor}set albedoColor(t){this._albedoColor.set(t),this.uniformChanged()}getUniformValueAlbedoColor(t){return this.drawContext.materialFlags&gu.INSTANCING?t.$inputs.zAlbedo:t.zAlbedo}calculateAlbedoColor(t,e){const i=t.$builder;if(!this.needFragmentColor())return console.warn("mixinAlbedoColor.calculateAlbedoColor(): No need to calculate albedo color, make sure needFragmentColor() returns true"),i.vec4(1);let s=this.getUniformValueAlbedoColor(t);return this.albedoTexture&&(s=i.mul(s,this.sampleAlbedoTexture(t,e))),s}vertexShader(t){super.vertexShader(t),this.needFragmentColor()&&this.drawContext.materialFlags&gu.INSTANCING&&(t.$outputs.zAlbedo=this.getInstancedUniform(t,i))}fragmentShader(t){if(super.fragmentShader(t),this.needFragmentColor()&&!(this.drawContext.materialFlags&gu.INSTANCING)){const e=t.$builder;t.zAlbedo=e.vec4().uniform(2)}}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),!this.needFragmentColor(e)||e.materialFlags&gu.INSTANCING||t.setValue("zAlbedo",this._albedoColor)}}}function rd(t){if(t.lightMixed)return t;const e=Yc(t,sd,id("normal"));let i=0,s=0;const r=class extends e{static lightMixed=!0;_normalScale;constructor(){super(),this._normalScale=1,this.useFeature(i,!0)}copyFrom(t){super.copyFrom(t),this.normalScale=t.normalScale,this.normalMapMode=t.normalMapMode,this.doubleSidedLighting=t.doubleSidedLighting}get normalScale(){return this._normalScale}set normalScale(t){t!==this._normalScale&&(this._normalScale=t,this.uniformChanged())}get normalMapMode(){return this.featureUsed(s)}set normalMapMode(t){this.useFeature(s,t)}get doubleSidedLighting(){return this.featureUsed(i)}set doubleSidedLighting(t){this.useFeature(i,!!t)}calculateViewVector(t,e){const i=t.$builder;return i.normalize(i.sub(Qc.getCameraPosition(t),e.xyz))}calculateReflectionVector(t,e,i){const s=t.$builder;return s.reflect(s.neg(i),e)}calculateNormal(t,e,i,s,r){const a=t.$builder,n=this,o=[e],h=[a.vec3("worldPos")];let l="Z_calculateNormal";return i&&(h.push(a.vec3("worldNormal")),o.push(i),l+="_N",s&&r&&(h.push(a.vec3("worldTangent"),a.vec3("worldBinormal")),o.push(s,r),l+="_T")),a.func(l,h,function(){if(this.$l.uv=n.normalTexture?n.getNormalTexCoord(this)??a.vec2(0):n.albedoTexture?n.getAlbedoTexCoord(this)??a.vec2(0):a.vec2(0),this.$l.TBN=n.calculateTBN(this,this.worldPos,this.worldNormal,this.worldTangent,this.worldBinormal),0===n.drawContext.renderPass.type&&n.normalTexture)if("object-space"===n.normalMapMode){const t=a.sub(a.mul(a.textureSample(n.getNormalTextureUniform(this),this.uv).rgb,2),a.vec3(1)),e=a.mul(t,a.vec3(a.vec3(this.zNormalScale).xx,1));this.$return(a.normalize(e))}else{const t=a.sub(a.mul(a.textureSample(n.getNormalTextureUniform(this),this.uv).rgb,2),a.vec3(1)),e=a.mul(t,a.vec3(a.vec3(this.zNormalScale).xx,1));this.$return(a.normalize(a.mul(this.TBN,e)))}else this.$return(this.TBN[2])}),a.getGlobalScope()[l](...o)}getUniformNormalScale(t){return t.zNormalScale}calculateNormalAndTBN(t,e,i,s,r){const a=t.$builder,n=a.defineStruct([a.mat3("TBN"),a.vec3("normal")]),o=this,h=[e.xyz],l=[a.vec3("worldPos")];let u="Z_calculateNormalAndTBN";return i&&(l.push(a.vec3("worldNormal")),h.push(i),u+="_N",s&&r&&(l.push(a.vec3("worldTangent"),a.vec3("worldBinormal")),h.push(s,r),u+="_T")),a.func(u,l,function(){if(this.$l.uv=o.normalTexture?o.getNormalTexCoord(this)??a.vec2(0):o.albedoTexture?o.getAlbedoTexCoord(this)??a.vec2(0):a.vec2(0),this.$l.TBN=o.calculateTBN(this,this.worldPos,this.worldNormal,this.worldTangent,this.worldBinormal),0===o.drawContext.renderPass.type&&o.normalTexture)if("object-space"===o.normalMapMode){const t=a.sub(a.mul(a.textureSample(o.getNormalTextureUniform(this),this.uv).rgb,2),a.vec3(1)),e=a.mul(t,a.vec3(a.vec3(this.zNormalScale).xx,1));this.$return(n(this.TBN,a.normalize(e)))}else{const t=a.sub(a.mul(a.textureSample(o.getNormalTextureUniform(this),this.uv).rgb,2),a.vec3(1)),e=a.mul(t,a.vec3(a.vec3(this.zNormalScale).xx,1));this.$return(n(this.TBN,a.normalize(a.mul(this.TBN,e))))}else this.$return(n(this.TBN,this.TBN[2]))}),a.getGlobalScope()[u](...h)}calculateTBN(t,e,i,s,r){const a=t.$builder,n=this,o=[e.xyz],h=[a.vec3("worldPos")];let l="Z_calculateTBN";return i&&(h.push(a.vec3("worldNormal")),o.push(i),l+="_N",s&&r&&(h.push(a.vec3("worldTangent"),a.vec3("worldBinormal")),o.push(s,r),l+="_T")),a.func(l,h,function(){const t=this.worldPos;this.$l.uv=n.normalTexture?n.getNormalTexCoord(this)??a.vec2(0):n.albedoTexture?n.getAlbedoTexCoord(this)??a.vec2(0):a.vec2(0),this.$l.TBN=a.mat3(),i?s?(this.$l.ng=a.normalize(this.worldNormal),this.$l.t=a.normalize(this.worldTangent),this.$l.b=a.normalize(this.worldBinormal),n.doubleSidedLighting&&this.$if(a.not(this.$builtins.frontFacing),function(){this.t=a.mul(this.t,-1),this.b=a.mul(this.b,-1),this.ng=a.mul(this.ng,-1)}),this.TBN=a.mat3(this.t,this.b,this.ng)):(this.$l.uv_dx=a.dpdx(a.vec3(this.uv,0)),this.$l.uv_dy=a.dpdy(a.vec3(this.uv,0)),this.$if(a.lessThanEqual(a.add(a.length(this.uv_dx),a.length(this.uv_dy)),1e-6),function(){this.uv_dx=a.vec3(1,0,0),this.uv_dy=a.vec3(0,1,0)}),this.$l.t_=a.div(a.sub(a.mul(a.dpdx(t),this.uv_dy.y),a.mul(a.dpdy(t),this.uv_dx.y)),a.sub(a.mul(this.uv_dx.x,this.uv_dy.y),a.mul(this.uv_dx.y,this.uv_dy.x))),this.$l.ng=a.normalize(this.worldNormal),this.$l.t=a.normalize(a.sub(this.t_,a.mul(this.ng,a.dot(this.ng,this.t_)))),this.$l.b=a.cross(this.ng,this.t),n.doubleSidedLighting&&this.$if(a.not(this.$builtins.frontFacing),function(){this.t=a.mul(this.t,-1),this.b=a.mul(this.b,-1),this.ng=a.mul(this.ng,-1)}),this.TBN=a.mat3(this.t,this.b,this.ng)):(this.$l.uv_dx=a.dpdx(a.vec3(this.uv,0)),this.$l.uv_dy=a.dpdy(a.vec3(this.uv,0)),this.$if(a.lessThanEqual(a.add(a.length(this.uv_dx),a.length(this.uv_dy)),1e-6),function(){this.uv_dx=a.vec3(1,0,0),this.uv_dy=a.vec3(0,1,0)}),this.$l.t_=a.div(a.sub(a.mul(a.dpdx(t),this.uv_dy.y),a.mul(a.dpdy(t),this.uv_dx.y)),a.sub(a.mul(this.uv_dx.x,this.uv_dy.y),a.mul(this.uv_dx.y,this.uv_dy.x))),this.$l.ng=a.normalize(a.cross(a.dpdx(t),a.dpdy(t))),this.$l.t=a.normalize(a.sub(this.t_,a.mul(this.ng,a.dot(this.ng,this.t_)))),this.$l.b=a.cross(this.ng,this.t),n.doubleSidedLighting&&this.$if(a.not(this.$builtins.frontFacing),function(){this.t=a.mul(this.t,-1),this.b=a.mul(this.b,-1),this.ng=a.mul(this.ng,-1)}),this.TBN=a.mat3(this.t,this.b,this.ng)),this.$return(this.TBN)}),a.getGlobalScope()[l](...o)}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),0===e.renderPass.type&&this.normalTexture&&t.setValue("zNormalScale",this._normalScale)}needCalculateEnvLight(){return 0===this.drawContext.renderPass.type&&this.drawContext.drawEnvLight}getEnvLightIrradiance(t,e){return this.needCalculateEnvLight()?this.drawContext.env.light.envLight.hasIrradiance()?t.$builder.mul(this.drawContext.env.light.envLight.getIrradiance(t,e).rgb,Qc.getEnvLightStrength(t)):t.$builder.vec3(0):(console.warn("getEnvLightIrradiance(): No need to calculate environment lighting"),t.$builder.vec3(0))}getEnvLightRadiance(t,e,i){return this.needCalculateEnvLight()?this.drawContext.env.light.envLight.hasRadiance()?t.$builder.mul(this.drawContext.env.light.envLight.getRadiance(t,e,i).rgb,Qc.getEnvLightStrength(t)):t.$builder.vec3(0):(console.warn("getEnvLightRadiance(): No need to calculate environment lighting"),t.$builder.vec3(0))}needCalculateShadow(){return 0===this.drawContext.renderPass.type&&!!this.drawContext.currentShadowLight}calculateShadow(t,e,i){const s=t.$builder;return this.needCalculateShadow()?Qc.calculateShadow(t,e,i,this.drawContext):(console.warn("calculateShadow(): No need to calculate shadow"),s.float(1))}getClusterIndex(t,e){const i=t.$builder,s="lm_getClusterIndex";return i.func(s,[i.vec3("fragCoord")],function(){const t=Qc.getClusterParams(this),e=Qc.getCountParams(this);this.$l.zTile=i.int(i.max(i.add(i.mul(i.log2(Qc.nonLinearDepthToLinear(this,this.fragCoord.z)),t.z),t.w),0)),this.$l.f=i.vec2(this.fragCoord.x,i.sub(t.y,i.add(this.fragCoord.y,1))),this.$l.xyTile=i.ivec2(i.div(this.f,i.div(t.xy,i.vec2(e.xy)))),this.$return(i.ivec3(this.xyTile,this.zTile))}),i.getGlobalScope()[s](e)}calculatePointLightAttenuation(t,e,i){const s=t.$builder,r="Z_calculatePointLightAttenuation";return s.func(r,[s.vec3("worldPos"),s.vec4("posRange")],function(){this.$l.dist=s.distance(this.posRange.xyz,this.worldPos),this.$l.falloff=s.max(0,s.sub(1,s.div(this.dist,this.posRange.w))),this.$return(s.mul(this.falloff,this.falloff))}),s.getGlobalScope()[r](e,i)}calculateSpotLightAttenuation(t,e,i,s){const r=t.$builder,a="Z_calculateSpotLightAttenuation";return r.func(a,[r.vec3("worldPos"),r.vec4("posRange"),r.vec4("dirCutoff")],function(){this.$l.dist=r.distance(this.posRange.xyz,this.worldPos),this.$l.falloff=r.max(0,r.sub(1,r.div(this.dist,this.posRange.w))),this.$l.spotFactor=r.dot(r.normalize(r.sub(this.worldPos,this.posRange.xyz)),this.dirCutoff.xyz),this.spotFactor=r.smoothStep(this.dirCutoff.w,r.mix(this.dirCutoff.w,1,.5),this.spotFactor),this.$return(r.mul(this.spotFactor,this.falloff,this.falloff))}),r.getGlobalScope()[a](e,i,s)}calculateLightAttenuation(t,e,i,s,r){const a=t.$builder;return t.$choice(a.equal(e,1),a.float(1),t.$choice(a.equal(e,2),this.calculatePointLightAttenuation(t,i.xyz,s),this.calculateSpotLightAttenuation(t,i.xyz,s,r)))}calculateLightDirection(t,e,i,s,r){const a=t.$builder;return t.$choice(a.equal(e,1),a.neg(r.xyz),a.normalize(a.sub(s.xyz,i.xyz)))}forEachLight(t,e){const i=t.$builder,s=this;if(0===s.drawContext.renderPass.type)if(s.drawContext.currentShadowLight){const s=t.light.positionAndRange,r=t.light.directionAndCutoff,a=t.light.diffuseAndIntensity;t.$scope(function(){const n=t.$choice(i.lessThan(s.w,0),i.int(1),t.$choice(i.lessThan(r.w,0),i.int(2),i.int(3)));e.call(this,n,s,r,a,!0)})}else t.$scope(function(){const r=Qc.getCountParams(this);this.$l.cluster=s.getClusterIndex(this,this.$builtins.fragCoord.xyz),this.$l.clusterIndex=i.add(this.cluster.x,i.mul(this.cluster.y,r.x),i.mul(this.cluster.z,r.x,r.y)),this.$l.texSize=t.light.lightIndexTexSize,"webgl"===i.getDevice().type?(this.$l.texCoordX=i.div(i.add(i.mod(i.float(this.clusterIndex),i.float(this.texSize.x)),.5),i.float(this.texSize.x)),this.$l.texCoordY=i.div(i.add(i.float(i.div(this.clusterIndex,this.texSize.x)),.5),i.float(this.texSize.y)),this.$l.samp=i.textureSample(Qc.getClusteredLightIndexTexture(this),i.vec2(this.texCoordX,this.texCoordY))):(this.$l.texCoordX=i.mod(this.clusterIndex,this.texSize.x),this.$l.texCoordY=i.div(this.clusterIndex,this.texSize.x),this.$l.samp=i.textureLoad(Qc.getClusteredLightIndexTexture(this),i.ivec2(this.texCoordX,this.texCoordY),0)),"webgl"===i.getDevice().type?this.$for(i.int("i"),0,4,function(){this.$l.k=this.samp.at(this.i),this.$l.lights=i.int[2](),this.$l.lights[0]=i.int(i.mod(this.k,256)),this.$l.lights[1]=i.int(i.div(this.k,256)),this.$for(i.int("k"),0,2,function(){this.$l.li=this.lights.at(this.k),this.$if(i.greaterThan(this.li,0),function(){this.$for(i.int("j"),1,256,function(){this.$if(i.equal(this.j,this.li),function(){this.$l.positionRange=Qc.getLightPositionAndRange(this,this.j),this.$l.directionCutoff=Qc.getLightDirectionAndCutoff(this,this.j),this.$l.diffuseIntensity=Qc.getLightColorAndIntensity(this,this.j),this.$l.lightType=this.$choice(i.lessThan(this.positionRange.w,0),i.int(1),this.$choice(i.lessThan(this.directionCutoff.w,0),i.int(2),i.int(3))),this.$scope(function(){e.call(this,this.lightType,this.positionRange,this.directionCutoff,this.diffuseIntensity,!1)}),this.$break()})})})})}):this.$for(i.uint("i"),0,4,function(){this.$for(i.uint("k"),0,4,function(){this.$l.c=i.compAnd(i.sar(this.samp.at(this.i),i.mul(this.k,8)),255),this.$if(i.greaterThan(this.c,0),function(){this.$l.positionRange=Qc.getLightPositionAndRange(this,this.c),this.$l.directionCutoff=Qc.getLightDirectionAndCutoff(this,this.c),this.$l.diffuseIntensity=Qc.getLightColorAndIntensity(this,this.c),this.$l.lightType=this.$choice(i.lessThan(this.positionRange.w,0),i.int(1),this.$choice(i.lessThan(this.directionCutoff.w,0),i.int(2),i.int(3))),this.$scope(function(){e.call(this,this.lightType,this.positionRange,this.directionCutoff,this.diffuseIntensity,!1)})})})})});else console.warn("LitMaterial.forEachLight(): must be called in forward render pass")}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;0===this.drawContext.renderPass.type&&this.normalTexture&&(t.zNormalScale=e.float().uniform(2))}supportLighting(){return!0}};return i=r.defineFeature(),s=r.defineFeature(),r}function ad(t){if(t.vertexColorMixed)return t;let e=0;const i=class extends t{static vertexColorMixed=!0;constructor(){super()}copyFrom(t){super.copyFrom(t),this.vertexColor=t.vertexColor}get vertexColor(){return this.featureUsed(e)}set vertexColor(t){this.useFeature(e,!!t)}vertexShader(t){if(super.vertexShader(t),this.needFragmentColor()&&this.vertexColor){if(t.$getVertexAttrib("diffuse"))throw new Error("mixinVertexColor.vertexShader(): diffuse vertex stream already defined");t.$inputs.zDiffuse=t.$builder.vec4().attrib("diffuse"),t.$outputs.zOutDiffuse=t.$inputs.zDiffuse}}getVertexColor(t){if(!this.needFragmentColor())throw new Error("mixinVertexColor.getVertexColor(): No need to calculate albedo color, make sure needFragmentColor() returns true");return"fragment"===t.$builder.shaderKind?t.$inputs.zOutDiffuse:t.$inputs.zDiffuse}};return e=i.defineFeature(),i}Zc=ed.defineFeature(),Kc=ed.defineFeature(),Jc=ed.defineFeature(),td=ed.defineFeature();class nd extends(Yc(ed,rd,ad)){static FEATURE_VERTEX_NORMAL=this.defineFeature();static FEATURE_VERTEX_TANGENT=this.defineFeature();constructor(){super(),this.useFeature(nd.FEATURE_VERTEX_NORMAL,!0)}clone(){const t=new nd;return t.copyFrom(this),t}get vertexNormal(){return this.featureUsed(nd.FEATURE_VERTEX_NORMAL)}set vertexNormal(t){this.useFeature(nd.FEATURE_VERTEX_NORMAL,!!t)}get vertexTangent(){return this.featureUsed(nd.FEATURE_VERTEX_TANGENT)}set vertexTangent(t){this.useFeature(nd.FEATURE_VERTEX_TANGENT,!!t)}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$l.oPos=Qc.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(Qc.getWorldMatrix(t),e.vec4(t.oPos,1)).xyz,Qc.setClipSpacePosition(t,e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),this.vertexNormal&&(t.$l.oNorm=Qc.resolveVertexNormal(t),t.$outputs.wNorm=e.mul(Qc.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz,this.vertexTangent&&(t.$l.oTangent=Qc.resolveVertexTangent(t),t.$outputs.wTangent=e.mul(Qc.getNormalMatrix(t),e.vec4(t.oTangent.xyz,0)).xyz,t.$outputs.wBinormal=e.mul(e.cross(t.$outputs.wNorm,t.$outputs.wTangent),t.oTangent.w)))}fragmentShader(t){super.fragmentShader(t);const e=t.$builder,i=this;this.needFragmentColor()?(t.$l.albedo=this.calculateAlbedoColor(t),this.vertexColor&&(t.albedo=e.mul(t.albedo,this.getVertexColor(t))),0===this.drawContext.renderPass.type?(t.$l.color=e.vec3(0),t.$l.normal=this.calculateNormal(t,t.$inputs.worldPos,t.$inputs.wNorm,t.$inputs.wTangent,t.$inputs.wBinormal),this.needCalculateEnvLight()&&(t.color=e.add(t.color,this.getEnvLightIrradiance(t,t.normal))),this.forEachLight(t,function(s,r,a,n,o){this.$l.lightAtten=i.calculateLightAttenuation(this,s,t.$inputs.worldPos,r,a),this.$l.lightDir=i.calculateLightDirection(this,s,t.$inputs.worldPos,r,a),this.$l.NoL=e.clamp(e.dot(this.normal,this.lightDir),0,1),this.$l.lightContrib=e.mul(n.rgb,n.a,this.NoL,this.lightAtten,1/Math.PI),o&&(this.$l.shadow=e.vec3(i.calculateShadow(this,t.$inputs.worldPos,this.NoL)),this.lightContrib=e.mul(this.lightContrib,this.shadow)),this.color=e.add(this.color,this.lightContrib)}),t.$l.litColor=e.mul(t.albedo,e.vec4(t.color,1)),this.drawContext.materialFlags&gu.SSR_STORE_ROUGHNESS?this.outputFragmentColor(t,t.$inputs.worldPos,t.litColor,e.vec4(0,0,0,1),e.vec4(e.add(e.mul(t.normal,.5),e.vec3(.5)),1)):this.outputFragmentColor(t,t.$inputs.worldPos,t.litColor)):this.outputFragmentColor(t,t.$inputs.worldPos,t.albedo)):this.outputFragmentColor(t,t.$inputs.worldPos,null)}}function od(t){if(t.blinnPhongMixed)return t;const e=Yc(t,rd),i=e.defineInstanceUniform("shininess","float","Shininess");return class extends e{static blinnPhongMixed=!0;_shininess;constructor(){super(),this._shininess=32}copyFrom(t){super.copyFrom(t),this.shininess=t.shininess}get shininess(){return this._shininess}set shininess(t){t!==this._shininess&&(this._shininess=t,this.uniformChanged())}vertexShader(t){super.vertexShader(t),this.needFragmentColor()&&this.drawContext.materialFlags&gu.INSTANCING&&(t.$outputs.zShininess=this.getInstancedUniform(t,i))}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;!this.needFragmentColor()||this.drawContext.materialFlags&gu.INSTANCING||(t.zShininess=e.float().uniform(2))}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),!this.needFragmentColor(e)||e.materialFlags&gu.INSTANCING||t.setValue("zShininess",this._shininess)}blinnPhongLight(t,e,i,s,r,a){const n=t.$builder,o="Z_blinnPhongLight",h=this;return n.func(o,[n.vec3("worldPos"),n.vec3("normal"),n.vec3("viewVec"),n.vec4("albedo"),...a?[n.vec4("outRoughness").out()]:[]],function(){if(h.needFragmentColor()){const t=h.drawContext.materialFlags&gu.INSTANCING?this.$inputs.zShininess:this.zShininess;h.needCalculateEnvLight()&&!a?this.$l.diffuseColor=h.getEnvLightIrradiance(this,this.normal):this.$l.diffuseColor=n.vec3(0),this.$l.specularColor=n.vec3(0),h.forEachLight(this,function(e,i,s,r,a){this.$l.lightAtten=h.calculateLightAttenuation(this,e,this.worldPos,i,s),this.$l.lightDir=h.calculateLightDirection(this,e,this.worldPos,i,s),this.$l.NoL=n.clamp(n.dot(this.normal,this.lightDir),0,1),this.$l.halfVec=n.normalize(n.add(this.viewVec,this.lightDir)),this.$l.NoH=n.clamp(n.dot(this.normal,this.halfVec),0,1),this.$l.lightColor=n.mul(r.rgb,r.a,this.lightAtten),this.$l.diffuse=n.mul(this.lightColor,1/Math.PI,this.NoL),this.$l.specular=n.mul(this.lightColor,n.pow(this.NoH,t)),a&&this.$if(n.greaterThan(this.NoL,0),function(){this.$l.shadow=n.vec3(h.calculateShadow(this,this.worldPos,this.NoL)),this.diffuse=n.mul(this.diffuse,this.shadow),this.specular=n.mul(this.specular,this.shadow)}),this.diffuseColor=n.add(this.diffuseColor,this.diffuse),this.specularColor=n.add(this.specularColor,this.specular)}),this.$l.litColor=n.add(n.mul(this.albedo.rgb,this.diffuseColor),this.specularColor),a&&(this.$l.roughness=n.sqrt(n.div(2,n.add(t,2))),this.outRoughness=n.vec4(n.mul(this.albedo.rgb,n.sub(1,this.roughness)),n.mul(this.roughness,Qc.getCameraRoughnessFactor(this)))),this.$return(this.litColor)}else this.$return(this.albedo.rgb)}),a?n.getGlobalScope()[o](e,i,s,r,a):n.getGlobalScope()[o](e,i,s,r)}}}class hd extends(Yc(ed,od,ad)){static FEATURE_VERTEX_NORMAL=this.defineFeature();static FEATURE_VERTEX_TANGENT=this.defineFeature();constructor(){super(),this.useFeature(hd.FEATURE_VERTEX_NORMAL,!0)}clone(){const t=new hd;return t.copyFrom(this),t}get vertexNormal(){return this.featureUsed(hd.FEATURE_VERTEX_NORMAL)}set vertexNormal(t){this.useFeature(hd.FEATURE_VERTEX_NORMAL,!!t)}get vertexTangent(){return this.featureUsed(hd.FEATURE_VERTEX_TANGENT)}set vertexTangent(t){this.useFeature(hd.FEATURE_VERTEX_TANGENT,!!t)}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$l.oPos=Qc.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(Qc.getWorldMatrix(t),e.vec4(t.oPos,1)).xyz,Qc.setClipSpacePosition(t,e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),this.vertexNormal&&(t.$l.oNorm=Qc.resolveVertexNormal(t),t.$outputs.wNorm=e.mul(Qc.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz,this.vertexTangent&&(t.$l.oTangent=Qc.resolveVertexTangent(t),t.$outputs.wTangent=e.mul(Qc.getNormalMatrix(t),e.vec4(t.oTangent.xyz,0)).xyz,t.$outputs.wBinormal=e.mul(e.cross(t.$outputs.wNorm,t.$outputs.wTangent),t.oTangent.w)))}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;this.needFragmentColor()?(t.$l.albedo=this.calculateAlbedoColor(t),this.vertexColor&&(t.albedo=e.mul(t.albedo,this.getVertexColor(t))),0===this.drawContext.renderPass.type?(t.$l.normal=this.calculateNormal(t,t.$inputs.worldPos,t.$inputs.wNorm,t.$inputs.wTangent,t.$inputs.wBinormal),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),this.drawContext.materialFlags&gu.SSR_STORE_ROUGHNESS?(t.$l.outRoughness=e.vec4(),t.$l.litColor=this.blinnPhongLight(t,t.$inputs.worldPos,t.normal,t.viewVec,t.albedo,t.outRoughness),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a),t.outRoughness,e.vec4(e.add(e.mul(t.normal,.5),e.vec3(.5)),1))):(t.$l.litColor=this.blinnPhongLight(t,t.$inputs.worldPos,t.normal,t.viewVec,t.albedo),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a)))):this.outputFragmentColor(t,t.$inputs.worldPos,t.albedo)):this.outputFragmentColor(t,t.$inputs.worldPos,null)}}class ld extends(Yc(ed,ad,sd)){static FEATURE_VERTEX_COLOR="um_vertexcolor";constructor(){super()}clone(){const t=new ld;return t.copyFrom(this),t}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$l.oPos=Qc.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(Qc.getWorldMatrix(t),e.vec4(t.oPos,1)).xyz,Qc.setClipSpacePosition(t,e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1)))}fragmentShader(t){if(super.fragmentShader(t),this.needFragmentColor()){let e=this.calculateAlbedoColor(t);this.vertexColor&&(e=t.$builder.mul(e,this.getVertexColor(t))),this.outputFragmentColor(t,t.$inputs.worldPos,e)}else this.outputFragmentColor(t,t.$inputs.worldPos,null)}}class ud extends ed{static FEATURE_ALPHA_MAP=this.defineFeature();static FEATURE_RAMP_MAP=this.defineFeature();_params;_alphaMap;_rampMap;constructor(){super(),this.cullMode="none",this.blendMode="blend",this._params=new O(0,1,0,0),this._alphaMap=new wt,this._rampMap=new wt}clone(){const t=new ud;return t.copyFrom(this),t}copyFrom(t){super.copyFrom(t),this.jitterPower=t.jitterPower,this.aspect=t.aspect,this.directional=t.directional}supportInstancing(){return!1}get alphaMap(){return this._alphaMap.get()}set alphaMap(t){t!==this._alphaMap.get()&&(this._alphaMap.set(t),this.useFeature(ud.FEATURE_ALPHA_MAP,!!this._alphaMap.get()),this.uniformChanged())}get rampMap(){return this._rampMap.get()}set rampMap(t){t!==this._rampMap.get()&&(this._rampMap.set(t),this.useFeature(ud.FEATURE_RAMP_MAP,!!this._rampMap.get()),this.uniformChanged())}get jitterPower(){return this._params.x}set jitterPower(t){t!==this._params.x&&(this._params.x=t,this.uniformChanged())}get aspect(){return this._params.y}set aspect(t){t!==this._params.y&&(this._params.y=t,this.uniformChanged())}get directional(){return 0!==this._params.z}set directional(t){const e=t?1:0;this._params.z!==e&&(this._params.z=e,this.uniformChanged())}vertexShader(t){super.vertexShader(t);const e=t.$builder;e.func("rotation2d",[e.float("t"),e.vec2("v")],function(){this.$l.s=e.sin(this.t),this.$l.c=e.cos(this.t),this.$l.rc1=e.vec3(this.c,this.s,e.mul(e.sub(e.sub(1,this.c),this.s),.5)),this.$l.rc2=e.vec3(e.neg(this.s),this.c,e.mul(e.add(e.sub(1,this.c),this.s),.5)),this.$l.uv=e.vec3(this.v,1),this.$return(e.vec2(e.dot(this.rc1,this.uv),e.dot(this.rc2,this.uv)))}),e.func("rotation3d",[e.float("t"),e.vec3("v")],function(){this.$l.s=e.sin(this.t),this.$l.c=e.cos(this.t),this.$l.rot=e.mat3(e.vec3(this.c,e.neg(this.s),0),e.vec3(this.s,this.c,0),e.vec3(0,0,1)),this.$return(e.mul(this.rot,this.v))}),t.$inputs.pos=e.vec4().attrib("position"),t.$inputs.particlePos=e.vec3().attrib("texCoord0"),t.$inputs.particleParams=e.vec4().attrib("texCoord1"),t.$inputs.particleVelocity=e.vec3().attrib("texCoord2"),t.params=e.vec4().uniform(2),t.$l.vertexID=e.int(t.$inputs.pos.w),t.$l.z=e.normalize(t.$inputs.particleVelocity),t.$l.x=e.vec3(e.neg(t.z.y),t.z.x,0),t.$l.y=e.cross(t.z,t.x),t.$l.offset=e.add(e.mul(e.sin(t.$inputs.particleParams.z),t.x),e.mul(e.cos(t.$inputs.particleParams.z),t.y)),t.$l.jitterVec=e.mul(t.offset,t.params.x),t.$l.centerPosWS=e.mul(Qc.getWorldMatrix(t),e.vec4(e.add(t.$inputs.particlePos,t.jitterVec),1)).xyz;const i=Qc.getViewMatrix(t);t.$l.forward=e.vec3(i[0].z,i[1].z,i[2].z),t.$l.axis=t.$choice(e.notEqual(t.params.z,0),t.z,t.$choice(e.lessThan(e.abs(t.forward.y),.999),e.vec3(0,1,0),e.vec3(1,0,0))),t.$l.right=e.normalize(e.cross(t.axis,t.forward)),t.$l.up=e.normalize(e.cross(t.forward,t.right)),t.$l.pos=e.vec2(),t.$l.uv=e.vec2(),t.$if(e.equal(t.vertexID,0),function(){t.pos=e.vec2(-.5,-.5),t.uv=e.vec2(0,0)}).$elseif(e.equal(t.vertexID,1),function(){t.pos=e.vec2(.5,-.5),t.uv=e.vec2(0,1)}).$elseif(e.equal(t.vertexID,2),function(){t.pos=e.vec2(-.5,.5),t.uv=e.vec2(1,0)}).$else(function(){t.pos=e.vec2(.5,.5),t.uv=e.vec2(1,1)}),t.pos=e.mul(t.pos,t.$inputs.particleParams.x),t.centerPosWS=e.add(t.centerPosWS,e.mul(t.right,t.pos.x,t.params.y),e.mul(t.up,t.pos.y)),t.$outputs.zUV=t.uv,t.$outputs.worldPos=t.centerPosWS,t.$outputs.zParticleParams=t.$inputs.particleParams,Qc.setClipSpacePosition(t,e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.centerPosWS,1)))}fragmentShader(t){if(super.fragmentShader(t),this.needFragmentColor()){const e=t.$builder;this.alphaMap&&(t.alphaMap=e.tex2D().uniform(2)),this.rampMap&&(t.rampMap=e.tex2D().uniform(2)),t.$l.alpha=this.alphaMap?e.textureSample(t.alphaMap,t.$inputs.zUV).r:e.float(1),t.$l.rampValue=this.rampMap?e.textureSample(t.rampMap,e.vec2(t.$inputs.zParticleParams.w,0)):e.vec4(1),this.outputFragmentColor(t,t.$inputs.worldPos,e.mul(t.rampValue,e.vec4(1,1,1,t.alpha)))}else this.outputFragmentColor(t,t.$inputs.worldPos,null)}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),t.setValue("params",this._params),this.needFragmentColor(e)&&(this.alphaMap&&t.setTexture("alphaMap",this.alphaMap),this.rampMap&&t.setTexture("rampMap",this.rampMap))}}const cd=new Map;function dd(t){let e=cd.get(t);return e||(e=function(t){const e=Sl(),i=e.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),"webgpu"===e.type&&(this.$builtins.position.y=t.neg(this.$builtins.position.y))})},fragment(t){this.$outputs.color=t.vec4();const i=1024;"webgl"===e.type?(t.func("radicalInverse_VdC",[t.int("bits")],function(){this.$l.rand=t.float(0),this.$l.denom=t.float(1),this.$l.invBase=t.float(.5),this.$l.n=this.bits,this.$for(t.int("i"),0,32,function(){this.denom=t.mul(this.denom,2),this.rand=t.add(this.rand,t.div(t.mod(t.float(this.n),2),this.denom)),this.n=t.div(this.n,2),this.$if(t.equal(this.n,0),function(){this.$break()})}),this.$return(this.rand)}),t.func("hammersley2d",[t.int("i"),t.int("N")],function(){this.$return(t.vec2(t.div(t.float(this.i),t.float(this.N)),this.radicalInverse_VdC(this.i)))})):(t.func("radicalInverse_VdC",[t.uint("bits")],function(){this.$l.n=this.bits,this.n=t.compOr(t.sal(this.n,16),t.sar(this.n,16)),this.n=t.compOr(t.sal(t.compAnd(this.n,1431655765),1),t.sar(t.compAnd(this.n,2863311530),1)),this.n=t.compOr(t.sal(t.compAnd(this.n,858993459),2),t.sar(t.compAnd(this.n,3435973836),2)),this.n=t.compOr(t.sal(t.compAnd(this.n,252645135),4),t.sar(t.compAnd(this.n,4042322160),4)),this.n=t.compOr(t.sal(t.compAnd(this.n,16711935),8),t.sar(t.compAnd(this.n,4278255360),8)),this.$return(t.mul(t.float(this.n),2.3283064365386963e-10))}),t.func("hammersley2d",[t.int("i"),t.int("N")],function(){this.$return(t.vec2(t.div(t.float(this.i),t.float(this.N)),this.radicalInverse_VdC(t.uint(this.i))))})),t.func("generateTBN",[t.vec3("normal")],function(){this.$l.bitangent=t.vec3(0,1,0),this.$l.NoU=this.normal.y,this.$l.epsl=1e-7,this.$if(t.lessThanEqual(t.sub(1,t.abs(this.normal.y)),this.epsl),function(){this.bitangent=this.$choice(t.greaterThan(this.normal.y,0),t.vec3(0,0,1),t.vec3(0,0,-1))}),this.$l.tangent=t.normalize(t.cross(this.bitangent,this.normal)),this.bitangent=t.cross(this.normal,this.tangent),this.$return(t.mat3(this.tangent,this.bitangent,this.normal))}),t.func("D_Charlie",[t.float("sheenRoughness"),t.float("NdotH")],function(){this.$l.roughness=t.max(this.sheenRoughness,1e-6),this.$l.invR=t.div(1,this.roughness),this.$l.cos2h=t.mul(this.NdotH,this.NdotH),this.$l.sin2h=t.sub(1,this.cos2h),this.$return(t.div(t.mul(t.add(this.invR,2),t.pow(this.sin2h,t.mul(this.invR,.5))),2*Math.PI))}),t.func("smithGGXCorrelated",[t.float("NoV"),t.float("NoL"),t.float("roughness")],function(){this.$l.a2=t.mul(this.roughness,this.roughness,this.roughness,this.roughness),this.$l.GGXV=t.mul(this.NoL,t.sqrt(t.add(t.mul(this.NoV,this.NoV,t.sub(1,this.a2)),this.a2))),this.$l.GGXL=t.mul(this.NoV,t.sqrt(t.add(t.mul(this.NoL,this.NoL,t.sub(1,this.a2)),this.a2))),this.$return(t.div(.5,t.add(this.GGXV,this.GGXL)))}),t.func("V_Ashikhmin",[t.float("NdotL"),t.float("NdotV")],function(){this.$return(t.clamp(t.div(1,t.mul(t.sub(t.add(this.NdotL,this.NdotV),t.mul(this.NdotL,this.NdotV)),4)),0,1))}),t.func("importanceSample",[t.vec2("xi"),t.vec3("normal"),t.float("roughness"),t.vec3("ggx").out(),t.vec3("charlie").out()],function(){this.$l.alphaRoughness=t.mul(this.roughness,this.roughness),this.$l.cosTheta=t.clamp(t.sqrt(t.div(t.sub(1,this.xi.y),t.add(1,t.mul(t.sub(t.mul(this.alphaRoughness,this.alphaRoughness),1),this.xi.y)))),0,1),this.$l.sinTheta=t.sqrt(t.sub(1,t.mul(this.cosTheta,this.cosTheta))),this.$l.phi=t.mul(this.xi.x,2*Math.PI),this.$l.TBN=this.generateTBN(this.normal),this.$l.localSpaceDir=t.normalize(t.vec3(t.mul(this.sinTheta,t.cos(this.phi)),t.mul(this.sinTheta,t.sin(this.phi)),this.cosTheta)),this.ggx=t.mul(this.TBN,this.localSpaceDir),this.sinTheta=t.pow(this.xi.y,t.div(this.alphaRoughness,t.add(t.mul(this.alphaRoughness,2),1))),this.cosTheta=t.sqrt(t.sub(1,t.mul(this.sinTheta,this.sinTheta))),this.localSpaceDir=t.normalize(t.vec3(t.mul(this.sinTheta,t.cos(this.phi)),t.mul(this.sinTheta,t.sin(this.phi)),this.cosTheta)),this.charlie=t.mul(this.TBN,this.localSpaceDir)}),t.func("integrateBRDF",[t.float("NoV"),t.float("roughness")],function(){this.$l.V=t.vec3(t.sub(1,t.mul(this.NoV,this.NoV)),0,this.NoV),this.$l.a=t.float(0),this.$l.b=t.float(0),this.$l.c=t.float(0),this.$l.n=t.vec3(0,0,1),this.$for(t.int("i"),0,i,function(){this.$l.xi=this.hammersley2d(this.i,i),this.$l.ggxSample=t.vec3(),this.$l.charlieSample=t.vec3(),this.importanceSample(this.xi,this.n,this.roughness,this.ggxSample,this.charlieSample),this.$l.ggxL=t.normalize(t.reflect(t.neg(this.V),this.ggxSample.xyz)),this.$l.ggxNoL=t.clamp(this.ggxL.z,0,1),this.$l.ggxNoH=t.clamp(this.ggxSample.z,0,1),this.$l.ggxVoH=t.clamp(t.dot(this.V,this.ggxSample.xyz),0,1),this.$l.charlieL=t.normalize(t.reflect(t.neg(this.V),this.charlieSample.xyz)),this.$l.charlieNoL=t.clamp(this.charlieL.z,0,1),this.$l.charlieNoH=t.clamp(this.charlieSample.z,0,1),this.$l.charlieVoH=t.clamp(t.dot(this.V,this.charlieSample.xyz),0,1),this.$if(t.greaterThan(this.ggxNoL,0),function(){this.$l.pdf=t.div(t.mul(this.smithGGXCorrelated(this.NoV,this.ggxNoL,this.roughness),this.ggxVoH,this.ggxNoL),this.ggxNoH),this.$l.Fc=t.pow(t.sub(1,this.ggxVoH),5),this.a=t.add(this.a,t.mul(t.sub(1,this.Fc),this.pdf)),this.b=t.add(this.b,t.mul(this.Fc,this.pdf))}),this.$if(t.greaterThan(this.charlieNoL,0),function(){this.$l.sheenDistribution=this.D_Charlie(this.roughness,this.charlieNoH),this.$l.sheenVis=this.V_Ashikhmin(this.charlieNoL,this.NoV),this.c=t.add(this.c,t.mul(this.sheenVis,this.sheenDistribution,this.charlieNoL,this.charlieVoH))})}),this.$return(t.div(t.vec3(t.mul(this.a,4),t.mul(this.b,4),t.mul(this.c,8*Math.PI)),i))}),t.main(function(){this.$outputs.color=t.vec4(this.integrateBRDF(this.$inputs.uv.x,this.$inputs.uv.y),1)})}});i.name="@GGXLUT_Generation";const s=e.createVertexLayout({vertexBuffers:[{buffer:e.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]}),r=e.createRenderStateSet();r.useRasterizerState().setCullMode("none"),r.useDepthState().enableTest(!1).enableWrite(!1);const a=e.createTexture2D("rgba8unorm",t,t,{mipmapping:!1});a.name="GGXLUT";const n=e.createFrameBuffer([a],null);return e.pushDeviceStates(),e.setProgram(i),e.setVertexLayout(s),e.setRenderStates(r),e.setFramebuffer(n),e.draw("triangle-strip",0,4),e.popDeviceStates(),n.dispose(),s.dispose(),i.dispose(),a}(t),cd.set(t,e)),e}function pd(t){if(t.pbrBRDFMixed)return t;return class extends t{static pbrBRDFMixed=!0;fresnel0ToIor(t,e){const i=t.$builder,s="Z_fresnel0ToIor";return i.func(s,[i.vec3("fresnel0")],function(){this.$l.sqrtF0=i.sqrt(this.fresnel0),this.$return(i.div(i.add(this.sqrtF0,i.vec3(1)),i.sub(i.vec3(1),this.sqrtF0)))}),i.getGlobalScope()[s](e)}iorToFresnel0v(t,e,i){const s=t.$builder,r="Z_iorToFresnel0v";return s.func(r,[s.vec3("transmittedIor"),s.float("incidentIor")],function(){this.$l.t=s.div(s.sub(this.transmittedIor,s.vec3(this.incidentIor)),s.add(this.transmittedIor,s.vec3(this.incidentIor))),this.$return(s.mul(this.t,this.t))}),s.getGlobalScope()[r](e,i)}iorToFresnel0(t,e,i){const s=t.$builder,r="Z_iorToFresnel0";return s.func(r,[s.float("transmittedIor"),s.float("incidentIor")],function(){this.$l.t=s.div(s.sub(this.transmittedIor,this.incidentIor),s.add(this.transmittedIor,this.incidentIor)),this.$return(s.mul(this.t,this.t))}),s.getGlobalScope()[r](e,i)}evalSensitivity(t,e,i){const s=t.$builder,r="Z_evalSensitivity";return s.func(r,[s.float("OPD"),s.vec3("shift")],function(){this.$l.phase=s.mul(2*Math.PI,this.OPD,1e-9),this.$l.val=s.vec3(54856e-17,44201e-17,52481e-17),this.$l.pos=s.vec3(1681e3,1795300,2208400),this.$l.va=s.vec3(43278e5,93046e5,66121e5),this.$l.xyz=s.mul(this.val,s.sqrt(s.mul(2*Math.PI,this.va)),s.cos(s.add(s.mul(this.pos,this.phase),this.shift)),s.exp(s.neg(s.mul(this.phase,this.phase,this.va)))),this.xyz.x=s.add(this.xyz.x,s.mul(9747e-17,Math.sqrt(2*Math.PI*45282e5),s.cos(s.add(s.mul(this.phase,2239900),this.shift.x)),s.exp(s.mul(-45282e5,this.phase,this.phase)))),this.xyz=s.div(this.xyz,1.0685e-7),this.$return(s.mul(s.mat3(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),this.xyz))}),s.getGlobalScope()[r](e,i)}schlickToF0(t,e,i,s){const r=t.$builder,a="Z_schlickToF0";return r.func(a,[r.vec3("f"),r.vec3("f90"),r.float("VdotH")],function(){this.$l.x=r.clamp(r.sub(1,this.VdotH),0,1),this.$l.x2=r.mul(this.x,this.x),this.$l.x5=r.clamp(r.mul(this.x,this.x2,this.x2),0,.9999),this.$return(r.div(r.sub(this.f,r.mul(this.f90,this.x5)),r.sub(1,this.x5)))}),r.getGlobalScope()[a](e,i,s)}fresnelSchlick(t,e,i,s){const r=t.$builder,a="Z_fresnelSchlick";return r.func(a,[r.float("cosTheta"),r.vec3("f0"),r.vec3("f90")],function(){this.$return(r.add(this.f0,r.mul(r.sub(this.f90,this.f0),r.pow(r.clamp(r.sub(1,this.cosTheta),0,1),5))))}),t.$g[a](e,i,s)}distributionGGX(t,e,i){const s=t.$builder,r="Z_distributionGGX";return s.func(r,[s.float("NdotH"),s.float("roughness")],function(){this.$l.a2=s.mul(this.roughness,this.roughness),this.$l.NdotH2=s.mul(this.NdotH,this.NdotH),this.$l.num=this.a2,this.$l.denom=s.add(s.mul(this.NdotH2,s.sub(this.a2,1)),1),this.denom=s.mul(s.mul(3.14159265,this.denom),this.denom),this.$return(s.div(this.num,this.denom))}),t.$g[r](e,i)}visGGX(t,e,i,s){const r=t.$builder,a="Z_visGGX";return r.func(a,[r.float("NdotV"),r.float("NdotL"),r.float("roughness")],function(){this.$l.a=this.roughness,this.$l.ggxV=r.mul(this.NdotL,r.sqrt(r.add(r.mul(this.NdotV,this.NdotV,r.sub(1,this.a)),this.a))),this.$l.ggxL=r.mul(this.NdotV,r.sqrt(r.add(r.mul(this.NdotL,this.NdotL,r.sub(1,this.a)),this.a))),this.$l.ggx=r.add(this.ggxV,this.ggxL,1e-5),this.$if(r.greaterThan(this.ggx,0),function(){this.$return(r.div(.5,this.ggx))}).$else(function(){this.$return(r.float(0))})}),t.$g[a](e,i,s)}}}function md(t){if(t.pbrCommonMixed)return t;const e=Yc(t,pd,id("occlusion"),id("emissive"),id("sheenColor"),id("sheenRoughness"),id("clearcoatIntensity"),id("clearcoatRoughness"),id("clearcoatNormal"),id("transmission"),id("thickness"),id("iridescence"),id("iridescenceThickness"));let i=0,s=0,r=0,a=0;const n=e.defineInstanceUniform("emissiveColor","rgb","EmissiveColor"),o=e.defineInstanceUniform("emissiveStrength","float","EmissiveStrength"),h=class extends e{static pbrCommonMixed=!0;_f0;_emissiveColor;_emissiveStrength;_occlusionStrength;_sheenFactor;_clearcoatFactor;_transmissionFactor;_thicknessFactor;_attenuationColor;_attenuationDistance;_iridescenceFactor;constructor(){super(),this._f0=new O(.04,.04,.04,1.5),this._occlusionStrength=1,this._emissiveColor=new z(0,0,0),this._emissiveStrength=1,this._sheenFactor=O.zero(),this._clearcoatFactor=new O(0,0,1,0),this._transmissionFactor=0,this._thicknessFactor=0,this._attenuationColor=z.one(),this._attenuationDistance=99999,this._iridescenceFactor=new O(0,1.3,100,400)}copyFrom(t){super.copyFrom(t),this.ior=t.ior,this.transmissionFactor=t.transmissionFactor,this.thicknessFactor=t.thicknessFactor,this.attenuationColor=t.attenuationColor,this.attenuationDistance=t.attenuationDistance,this.iridescenceFactor=t.iridescenceFactor,this.iridescenceIor=t.iridescenceIor,this.iridescenceThicknessMin=t.iridescenceThicknessMin,this.iridescenceThicknessMax=t.iridescenceThicknessMax,this.occlusionStrength=t.occlusionStrength,this.emissiveColor=t.emissiveColor,this.emissiveStrength=t.emissiveStrength,this.transmission=t.transmission,this.iridescence=t.iridescence,this.clearcoat=t.clearcoat,this.clearcoatIntensity=t.clearcoatIntensity,this.clearcoatRoughnessFactor=t.clearcoatRoughnessFactor,this.sheen=t.sheen,this.sheenColorFactor=t.sheenColorFactor,this.sheenRoughnessFactor=t.sheenRoughnessFactor}get ior(){return this._f0.w}set ior(t){if(t!==this._f0.w){let e=(t-1)/(t+1);e*=e,this._f0.setXYZW(e,e,e,t),this.uniformChanged()}}get transmissionFactor(){return this._transmissionFactor}set transmissionFactor(t){t!==this._transmissionFactor&&(this._transmissionFactor=t,this.uniformChanged())}get thicknessFactor(){return this._thicknessFactor}set thicknessFactor(t){this._thicknessFactor!==t&&(this._thicknessFactor=t,this.uniformChanged())}get attenuationColor(){return this._attenuationColor}set attenuationColor(t){t.equalsTo(this._attenuationColor)||(this._attenuationColor.set(t),this.uniformChanged())}get attenuationDistance(){return this._attenuationDistance}set attenuationDistance(t){t!==this._attenuationDistance&&(this._attenuationDistance=t,this.uniformChanged())}get iridescenceFactor(){return this._iridescenceFactor.x}set iridescenceFactor(t){this._iridescenceFactor.x!==t&&(this._iridescenceFactor.x=t,this.uniformChanged())}get iridescenceIor(){return this._iridescenceFactor.y}set iridescenceIor(t){this._iridescenceFactor.y!==t&&(this._iridescenceFactor.y=t,this.uniformChanged())}get iridescenceThicknessMin(){return this._iridescenceFactor.z}set iridescenceThicknessMin(t){this._iridescenceFactor.z!==t&&(this._iridescenceFactor.z=t,this.uniformChanged())}get iridescenceThicknessMax(){return this._iridescenceFactor.w}set iridescenceThicknessMax(t){this._iridescenceFactor.w!==t&&(this._iridescenceFactor.w=t,this.uniformChanged())}get occlusionStrength(){return this._occlusionStrength}set occlusionStrength(t){t!==this._occlusionStrength&&(this._occlusionStrength=t,this.uniformChanged())}get emissiveColor(){return this._emissiveColor}set emissiveColor(t){t.x===this._emissiveColor.x&&t.y===this._emissiveColor.y&&t.z===this._emissiveColor.z||(this._emissiveColor.set(t),this.uniformChanged())}get emissiveStrength(){return this._emissiveStrength}set emissiveStrength(t){this._emissiveStrength!==t&&(this._emissiveStrength=t,this.uniformChanged())}get transmission(){return this.featureUsed(r)}set transmission(t){this.useFeature(r,!!t)}get iridescence(){return this.featureUsed(a)}set iridescence(t){this.useFeature(a,!!t)}get clearcoat(){return this.featureUsed(s)}set clearcoat(t){this.useFeature(s,!!t)}get clearcoatIntensity(){return this._clearcoatFactor.x}set clearcoatIntensity(t){t!==this._clearcoatFactor.x&&(this._clearcoatFactor.x=t,this.uniformChanged())}get clearcoatRoughnessFactor(){return this._clearcoatFactor.y}set clearcoatRoughnessFactor(t){t!==this._clearcoatFactor.y&&(this._clearcoatFactor.y=t,this.uniformChanged())}get sheen(){return this.featureUsed(i)}set sheen(t){this.useFeature(i,!!t)}get sheenColorFactor(){return this._sheenFactor.xyz()}set sheenColorFactor(t){t.x===this._sheenFactor.x&&t.y===this._sheenFactor.y&&t.z===this._sheenFactor.z||(this._sheenFactor.x=t.x,this._sheenFactor.y=t.y,this._sheenFactor.z=t.z,this.uniformChanged())}get sheenRoughnessFactor(){return this._sheenFactor.w}set sheenRoughnessFactor(t){t!==this._sheenFactor.w&&(this._sheenFactor.w=t,this.uniformChanged())}vertexShader(t){super.vertexShader(t),this.needFragmentColor()&&this.drawContext.materialFlags&gu.INSTANCING&&(t.$outputs.zEmissiveColor=this.getInstancedUniform(t,n),t.$outputs.zEmissiveStrength=this.getInstancedUniform(t,o))}fragmentShader(t){const e=t.$builder;super.fragmentShader(t),this.needFragmentColor()&&(t.zF0=e.vec4().uniform(2),this.drawContext.materialFlags&gu.INSTANCING||(t.zEmissiveColor=e.vec3().uniform(2),t.zEmissiveStrength=e.float().uniform(2)),this.occlusionTexture&&(t.zOcclusionStrength=e.float().uniform(2)),this.sheen&&(t.zSheenFactor=e.vec4().uniform(2)),this.clearcoat&&(t.zClearcoatFactor=e.vec4().uniform(2)),this.transmission&&0===this.drawContext.renderPass.type&&(t.zTransmissionFactor=e.float().uniform(2),t.zThicknessFactor=e.float().uniform(2),t.zAttenuationColor=e.vec3().uniform(2),t.zAttenuationDistance=e.float().uniform(2)),this.iridescence&&(t.zIridescenceFactor=e.vec4().uniform(2)),this.drawContext.drawEnvLight&&(t.zGGXLut=e.tex2D().uniform(2)))}needSceneColor(){return this.transmission}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),this.needFragmentColor(e)&&(t.setValue("zF0",this._f0),e.materialFlags&gu.INSTANCING||(t.setValue("zEmissiveColor",this._emissiveColor),t.setValue("zEmissiveStrength",this._emissiveStrength)),this.occlusionTexture&&t.setValue("zOcclusionStrength",this._occlusionStrength),this.sheen&&t.setValue("zSheenFactor",this._sheenFactor),this.clearcoat&&t.setValue("zClearcoatFactor",this._clearcoatFactor),this.transmission&&0===e.renderPass.type&&(t.setValue("zTransmissionFactor",this._transmissionFactor),t.setValue("zThicknessFactor",this._thicknessFactor),t.setValue("zAttenuationColor",this._attenuationColor),t.setValue("zAttenuationDistance",this._attenuationDistance)),this.iridescence&&t.setValue("zIridescenceFactor",this._iridescenceFactor),e.drawEnvLight&&t.setTexture("zGGXLut",dd(1024)))}getF0(t){return t.zF0}getCommonDatasStruct(t){const e=t.$builder;return e.defineStruct([e.vec4("f0"),e.vec3("f90"),e.vec4("diffuse"),e.float("metallic"),e.float("roughness"),e.float("specularWeight"),...this.sheen?[e.float("sheenAlbedoScaling"),e.vec3("sheenColor"),e.float("sheenRoughness")]:[],...this.clearcoat?[e.vec4("ccFactor"),e.vec3("ccNormal"),e.float("ccNoV"),e.float("ccFresnel")]:[],...this.transmission&&0===this.drawContext.renderPass.type?[e.float("transmissionFactor"),e.float("thicknessFactor"),e.vec3("attenuationColor"),e.float("attenuationDistance")]:[],...this.iridescence?[e.vec4("iridescenceFactor"),e.vec3("iridescenceFresnel"),e.vec3("iridescenceF0")]:[]])}getCommonData(t,e,i,s,r){const a=t.$builder,n=this,o="Z_getCommonData";return a.func(o,[a.vec4("albedo"),a.vec3("normal"),a.vec3("viewVec"),a.mat3("TBN")],function(){this.$l.data=n.getCommonDatasStruct(this)(),n.calculateCommonData(this,this.albedo,this.normal,this.viewVec,this.TBN,this.data),this.$return(this.data)}),t.$g[o](e,i,s,r)}calculateCommonData(t,e,i,s,r,a){const n=t.$builder;if(this.sheen&&(this.sheenColorTexture?a.sheenColor=n.mul(this.sampleSheenColorTexture(t).rgb,t.zSheenFactor.rgb):a.sheenColor=t.zSheenFactor.rgb,this.sheenRoughnessTexture?a.sheenRoughness=n.mul(this.sampleSheenRoughnessTexture(t).a,t.zSheenFactor.a):a.sheenRoughness=t.zSheenFactor.a,t.$l.sheenDFG=.157,a.sheenAlbedoScaling=n.sub(1,n.mul(n.max(n.max(a.sheenColor.r,a.sheenColor.g),a.sheenColor.b),t.sheenDFG))),this.clearcoat){if(this.clearcoatNormalTexture){const e=n.mul(n.sub(n.mul(this.sampleClearcoatNormalTexture(t).rgb,2),n.vec3(1)),n.vec3(t.zClearcoatFactor.zz,1));a.ccNormal=n.normalize(n.mul(r,e))}else a.ccNormal=r[2];a.ccNoV=n.clamp(n.dot(a.ccNormal,s),1e-4,1),a.ccFactor=t.zClearcoatFactor,this.clearcoatIntensityTexture&&(a.ccFactor.x=n.mul(a.ccFactor.x,this.sampleClearcoatIntensityTexture(t).r)),this.clearcoatRoughnessTexture&&(a.ccFactor.y=n.clamp(n.mul(a.ccFactor.y,this.sampleClearcoatRoughnessTexture(t).g),0,1))}this.transmission&&0===this.drawContext.renderPass.type&&(this.transmissionTexture?a.transmissionFactor=n.mul(this.sampleTransmissionTexture(t).r,t.zTransmissionFactor):a.transmissionFactor=t.zTransmissionFactor,this.thicknessTexture?a.thicknessFactor=n.mul(this.sampleThicknessTexture(t).g,t.zThicknessFactor):a.thicknessFactor=t.zThicknessFactor,a.attenuationColor=t.zAttenuationColor,a.attenuationDistance=t.zAttenuationDistance),this.iridescence&&(a.iridescenceFactor=t.zIridescenceFactor,this.iridescenceTexture&&(a.iridescenceFactor.x=n.mul(this.sampleIridescenceTexture(t).r,a.iridescenceFactor.x)),this.iridescenceThicknessTexture&&(a.iridescenceFactor.w=n.mix(a.iridescenceFactor.z,a.iridescenceFactor.w,this.sampleIridescenceThicknessTexture(t).g)),a.iridescenceFresnel=this.evalIridescence(t,1,a.iridescenceFactor.y,n.clamp(n.dot(i,s),0,1),a.iridescenceFactor.w,a.f0.rgb),a.iridescenceF0=this.schlickToF0(t,a.iridescenceFresnel,n.vec3(1),n.clamp(n.dot(i,s),0,1)))}getEmissiveColor(t){return!!(this.drawContext.materialFlags&gu.INSTANCING)?t.$inputs.zEmissiveColor:t.zEmissiveColor}getEmissiveStrength(t){return!!(this.drawContext.materialFlags&gu.INSTANCING)?t.$inputs.zEmissiveStrength:t.zEmissiveStrength}calculateEmissiveColor(t){const e=t.$builder;return this.emissiveTexture?e.mul(this.sampleEmissiveTexture(t).rgb,this.getEmissiveColor(t),this.getEmissiveStrength(t)):e.mul(this.getEmissiveColor(t),this.getEmissiveStrength(t))}D_Charlie(t,e,i){const s="Z_DCharlie",r=t.$builder;return r.func(s,[r.float("NdotH"),r.float("sheenRoughness")],function(){this.$l.alphaG=r.mul(this.sheenRoughness,this.sheenRoughness),this.$l.invR=r.div(1,this.alphaG),this.$l.cos2h=r.mul(this.NdotH,this.NdotH),this.$l.sin2h=r.max(r.sub(1,this.cos2h),.0078125),this.$return(r.div(r.mul(r.add(this.invR,2),r.pow(this.sin2h,r.mul(this.invR,.5))),2*Math.PI))}),t.$g[s](e,i)}V_Ashikhmin(t,e,i){const s="Z_VAshikhmin",r=t.$builder;return r.func(s,[r.float("NdotL"),r.float("NdotV")],function(){this.$return(r.clamp(r.div(1,r.mul(r.sub(r.add(this.NdotL,this.NdotV),r.mul(this.NdotL,this.NdotV)),4)),0,1))}),t.$g[s](e,i)}getVolumeTransmissionRay(t,e,i,s,r){const a=t.$builder,n="getVolumeTransmissionRay";return a.func(n,[a.vec3("normal"),a.vec3("viewVec"),a.float("thickness"),a.float("ior")],function(){this.$l.refractionVector=a.refract(a.neg(this.viewVec),this.normal,a.div(1,this.ior)),this.$return(a.mul(this.refractionVector,this.$inputs.modelScale,this.thickness))}),a.getGlobalScope()[n](e,i,s,r)}getTransmissionSample(t,e,i,s){const r=t.$builder,a="getTransmissionSample";return r.func(a,[r.vec2("fragCoord"),r.float("roughness"),r.float("ior")],function(){this.$l.applyIorToRoughness=r.mul(this.roughness,r.clamp(r.sub(r.mul(this.ior,2),2),0,1)),this.$l.framebufferLod=r.mul(r.log2(Qc.getSceneColorTextureSize(this).x),this.applyIorToRoughness),this.$return(r.textureSampleLevel(Qc.getSceneColorTexture(this),this.fragCoord,this.framebufferLod).rgb)}),r.getGlobalScope()[a](e,i,s)}getPunctualRadianceTransmission(t,e,i,s,r,a,n,o,h){const l=t.$builder,u=this,c="getPunctualRadianceTransmission";return l.func(c,[l.vec3("normal"),l.vec3("viewVec"),l.vec3("L"),l.float("alphaRoughness"),l.vec3("f0"),l.vec3("f90"),l.vec3("baseColor"),l.float("ior")],function(){this.$l.transmissionRoughness=l.mul(this.alphaRoughness,l.clamp(l.sub(l.mul(this.ior,2),2),0,1)),this.$l.mirrorL=l.normalize(l.add(this.L,l.mul(this.normal,l.dot(l.neg(this.L),this.normal),2))),this.$l.h=l.normalize(l.add(this.viewVec,this.mirrorL)),this.$l.D=u.distributionGGX(this,l.clamp(l.dot(this.normal,this.h),0,1),this.transmissionRoughness),this.$l.F=u.fresnelSchlick(this,l.clamp(l.dot(this.viewVec,this.h),0,1),this.f0,this.f90),this.$l.V=u.visGGX(this,l.clamp(l.dot(this.normal,this.viewVec),0,1),l.clamp(l.dot(this.normal,this.mirrorL),0,1),this.transmissionRoughness),this.$return(l.mul(l.sub(l.vec3(1),this.F),this.baseColor,this.D,this.V))}),l.getGlobalScope()[c](e,i,s,r,a,n,o,h)}applyVolumeAttenuation(t,e,i,s,r){const a=t.$builder,n="applyVolumeAttenuation";return a.func(n,[a.vec3("radiance"),a.float("transmissionDistance"),a.vec3("attenuationColor"),a.float("attenuationDistance")],function(){this.$if(a.equal(this.attenuationDistance,0),function(){this.$return(this.radiance)}).$else(function(){this.$l.attenuationCoefficient=a.div(a.neg(a.log(this.attenuationColor)),this.attenuationDistance),this.$l.transmittance=a.exp(a.mul(a.neg(this.attenuationCoefficient),this.transmissionDistance)),this.$return(a.mul(this.radiance,this.transmittance))})}),a.getGlobalScope()[n](e,i,s,r)}getIBLVolumnRefraction(t,e,i,s,r,a,n,o,h,l,u,c,d){const p=t.$builder,m="getIBLVolumeRefraction",f=this;return p.func(m,[p.vec2("brdf"),p.vec3("normal"),p.vec3("viewVec"),p.float("roughness"),p.vec3("baseColor"),p.vec3("f0"),p.vec3("f90"),p.vec3("position"),p.float("ior"),p.float("thickness"),p.vec3("attenuationColor"),p.float("attenuationDistance")],function(){this.$l.transmissionRay=f.getVolumeTransmissionRay(this,this.normal,this.viewVec,this.thickness,this.ior),this.$l.transmissionRayLength=p.length(this.transmissionRay),this.$l.refractedRayExit=p.add(this.position,this.transmissionRay),this.$l.ndcPos=p.mul(Qc.getViewProjectionMatrix(this),p.vec4(this.refractedRayExit,1)),this.$l.refractionCoords=p.add(p.mul(p.div(this.ndcPos.xy,this.ndcPos.w),.5),p.vec2(.5)),this.$l.transmittedLight=f.getTransmissionSample(this,this.refractionCoords,this.roughness,this.ior),this.$l.attColor=f.applyVolumeAttenuation(this,this.transmittedLight,this.transmissionRayLength,this.attenuationColor,this.attenuationDistance),this.$l.specularColor=p.add(p.mul(this.f0,this.brdf.x),p.mul(this.f90,this.brdf.y)),this.$return(p.mul(p.sub(p.vec3(1),this.specularColor),this.attColor,this.baseColor))}),p.getGlobalScope()[m](e,i,s,r,a,n,o,h,l,u,c,d)}directLighting(t,e,i,s,r,a,n){const o=t.$builder,h=this,l="Z_PBRDirectLighting";o.func(l,[o.vec3("L"),o.vec3("lightColor"),o.vec3("normal"),o.vec3("viewVec"),h.getCommonDatasStruct(t)("data"),o.vec3("outColor").inout()],function(){this.$l.H=o.normalize(o.add(this.viewVec,this.L)),this.$l.NoH=o.clamp(o.dot(this.normal,this.H),0,1),this.$l.NoL=o.clamp(o.dot(this.normal,this.L),0,1),this.$l.NoV=o.clamp(o.dot(this.normal,this.viewVec),0,1),this.$if(o.greaterThan(this.NoL,0),function(){this.$l.VoH=o.clamp(o.dot(this.viewVec,this.H),0,1),this.$l.schlickFresnel=h.fresnelSchlick(this,this.VoH,this.data.f0.rgb,this.data.f90),h.iridescence?this.$l.F=o.mix(this.schlickFresnel,this.data.iridescenceFresnel,this.data.iridescenceFactor.x):this.$l.F=this.schlickFresnel,this.$l.alphaRoughness=o.mul(this.data.roughness,this.data.roughness),this.$l.D=h.distributionGGX(this,this.NoH,this.alphaRoughness),this.$l.V=h.visGGX(this,this.NoV,this.NoL,this.alphaRoughness),this.$l.specular=o.mul(this.lightColor,this.D,this.V,this.F,this.data.specularWeight),h.sheen&&(this.specular=o.mul(this.specular,this.data.sheenAlbedoScaling)),this.outColor=o.add(this.outColor,this.specular),h.iridescence&&(this.$l.iridescenceFresnelMax=o.vec3(o.max(o.max(this.data.iridescenceFresnel.r,this.data.iridescenceFresnel.g),this.data.iridescenceFresnel.b)),this.F=o.mix(this.schlickFresnel,this.iridescenceFresnelMax,this.data.iridescenceFactor.x)),this.$l.diffuseBRDF=o.mul(o.sub(o.vec3(1),o.mul(this.F,this.data.specularWeight)),o.div(this.data.diffuse.rgb,Math.PI)),this.$l.diffuse=o.mul(this.lightColor,o.max(this.diffuseBRDF,o.vec3(0))),h.transmission&&0===h.drawContext.renderPass.type&&(this.$l.transmissionRay=h.getVolumeTransmissionRay(this,this.normal,this.viewVec,this.data.thicknessFactor,this.data.f0.a),this.$l.pointToLight=o.normalize(o.sub(this.L,this.transmissionRay)),this.$l.transmittedLight=o.mul(this.lightColor,h.getPunctualRadianceTransmission(this,this.normal,this.viewVec,this.pointToLight,this.alphaRoughness,this.data.f0.rgb,this.data.f90.rgb,this.data.diffuse.rgb,this.data.f0.a)),this.transmittedLight=h.applyVolumeAttenuation(this,this.transmittedLight,o.length(this.transmissionRay),this.data.attenuationColor,this.data.attenuationDistance),this.diffuse=o.mix(this.diffuse,this.transmittedLight,this.data.transmissionFactor)),h.sheen&&(this.diffuse=o.mul(this.diffuse,this.data.sheenAlbedoScaling)),this.outColor=o.add(this.outColor,this.diffuse),h.sheen&&(this.$l.sheenD=h.D_Charlie(this,this.NoH,this.data.sheenRoughness),this.$l.sheenV=h.V_Ashikhmin(this,this.NoL,this.NoV),this.outColor=o.add(this.outColor,o.mul(this.lightColor,this.data.sheenColor,this.sheenD,this.sheenV))),h.clearcoat&&(this.alphaRoughness=o.mul(this.data.ccFactor.y,this.data.ccFactor.y),this.NoH=o.clamp(o.dot(this.data.ccNormal,this.H),0,1),this.NoL=o.clamp(o.dot(this.data.ccNormal,this.L),0,1),this.ccF0=o.vec3(o.pow(o.div(o.sub(this.data.f0.a,1),o.add(this.data.f0.a,1)),2)),this.F=h.fresnelSchlick(this,this.VoH,this.ccF0,o.vec3(1)),this.D=h.distributionGGX(this,this.NoH,this.alphaRoughness),this.V=h.visGGX(this,this.data.ccNoV,this.NoL,this.alphaRoughness),this.outColor=o.add(this.outColor,o.mul(this.D,this.V,this.F,this.data.ccFactor.x)))})}),t.$g[l](e,i,s,r,a,n)}fresnel0ToIor(t,e){const i=t.$builder,s="Z_fresnel0ToIor";return i.func(s,[i.vec3("fresnel0")],function(){this.$l.sqrtF0=i.sqrt(this.fresnel0),this.$return(i.div(i.add(this.sqrtF0,i.vec3(1)),i.sub(i.vec3(1),this.sqrtF0)))}),i.getGlobalScope()[s](e)}iorToFresnel0v(t,e,i){const s=t.$builder,r="Z_iorToFresnel0v";return s.func(r,[s.vec3("transmittedIor"),s.float("incidentIor")],function(){this.$l.t=s.div(s.sub(this.transmittedIor,s.vec3(this.incidentIor)),s.add(this.transmittedIor,s.vec3(this.incidentIor))),this.$return(s.mul(this.t,this.t))}),s.getGlobalScope()[r](e,i)}iorToFresnel0(t,e,i){const s=t.$builder,r="Z_iorToFresnel0";return s.func(r,[s.float("transmittedIor"),s.float("incidentIor")],function(){this.$l.t=s.div(s.sub(this.transmittedIor,this.incidentIor),s.add(this.transmittedIor,this.incidentIor)),this.$return(s.mul(this.t,this.t))}),s.getGlobalScope()[r](e,i)}evalSensitivity(t,e,i){const s=t.$builder,r="Z_evalSensitivity";return s.func(r,[s.float("OPD"),s.vec3("shift")],function(){this.$l.phase=s.mul(2*Math.PI,this.OPD,1e-9),this.$l.val=s.vec3(54856e-17,44201e-17,52481e-17),this.$l.pos=s.vec3(1681e3,1795300,2208400),this.$l.va=s.vec3(43278e5,93046e5,66121e5),this.$l.xyz=s.mul(this.val,s.sqrt(s.mul(2*Math.PI,this.va)),s.cos(s.add(s.mul(this.pos,this.phase),this.shift)),s.exp(s.neg(s.mul(this.phase,this.phase,this.va)))),this.xyz.x=s.add(this.xyz.x,s.mul(9747e-17,Math.sqrt(2*Math.PI*45282e5),s.cos(s.add(s.mul(this.phase,2239900),this.shift.x)),s.exp(s.mul(-45282e5,this.phase,this.phase)))),this.xyz=s.div(this.xyz,1.0685e-7),this.$return(s.mul(s.mat3(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),this.xyz))}),s.getGlobalScope()[r](e,i)}schlickToF0(t,e,i,s){const r=t.$builder,a="Z_schlickToF0";return r.func(a,[r.vec3("f"),r.vec3("f90"),r.float("VdotH")],function(){this.$l.x=r.clamp(r.sub(1,this.VdotH),0,1),this.$l.x2=r.mul(this.x,this.x),this.$l.x5=r.clamp(r.mul(this.x,this.x2,this.x2),0,.9999),this.$return(r.div(r.sub(this.f,r.mul(this.f90,this.x5)),r.sub(1,this.x5)))}),r.getGlobalScope()[a](e,i,s)}evalIridescence(t,e,i,s,r,a){const n=t.$builder,o=this,h="Z_evalIridescence";return n.func(h,[n.float("outsideIOR"),n.float("eta2"),n.float("cosTheta1"),n.float("thinFilmThickness"),n.vec3("baseF0")],function(){this.$l.iridescenceIor=n.mix(this.outsideIOR,this.eta2,n.smoothStep(0,.03,this.thinFilmThickness)),this.$l.t=n.div(this.outsideIOR,this.iridescenceIor),this.$l.sinTheta2Sq=n.mul(this.t,this.t,n.sub(1,n.mul(this.cosTheta1,this.cosTheta1))),this.$l.cosTheta2Sq=n.sub(1,this.sinTheta2Sq),this.$if(n.lessThan(this.cosTheta2Sq,0),function(){this.$return(n.vec3(1))}),this.$l.cosTheta2=n.sqrt(this.cosTheta2Sq),this.$l.R0=o.iorToFresnel0(this,this.iridescenceIor,this.outsideIOR),this.$l.R12=o.fresnelSchlick(this,this.cosTheta1,n.vec3(this.R0),n.vec3(1)).x,this.$l.R21=this.R12,this.$l.T121=n.sub(1,this.R12),this.$l.phi12=n.float(0),this.$if(n.lessThan(this.iridescenceIor,this.outsideIOR),function(){this.phi12=Math.PI}),this.$l.phi21=n.sub(Math.PI,this.phi12),this.$l.baseIOR=o.fresnel0ToIor(this,n.clamp(this.baseF0,n.vec3(0),n.vec3(.9999))),this.$l.R1=o.iorToFresnel0v(this,this.baseIOR,this.iridescenceIor),this.$l.R23=o.fresnelSchlick(this,this.cosTheta2,this.R1,n.vec3(1)),this.$l.phi23=n.vec3(0),this.$if(n.lessThan(this.baseIOR.x,this.iridescenceIor),function(){this.phi23.x=Math.PI}),this.$if(n.lessThan(this.baseIOR.y,this.iridescenceIor),function(){this.phi23.y=Math.PI}),this.$if(n.lessThan(this.baseIOR.z,this.iridescenceIor),function(){this.phi23.z=Math.PI}),this.$l.OPD=n.mul(this.iridescenceIor,this.thinFilmThickness,this.cosTheta2,2),this.$l.phi=n.add(n.vec3(this.phi21),this.phi23),this.$l.R123=n.clamp(n.mul(this.R12,this.R23),n.vec3(1e-5),n.vec3(.9999)),this.$l.r123=n.sqrt(this.R123),this.$l.Rs=n.div(n.mul(this.T121,this.T121,this.R23),n.sub(n.vec3(1),this.R123)),this.$l.C0=n.add(n.vec3(this.R12),this.Rs),this.$l.I=this.C0,this.$l.Cm=n.sub(this.Rs,n.vec3(this.T121)),this.$for(n.int("m"),1,3,function(){this.Cm=n.mul(this.Cm,this.r123),this.$l.Sm=n.mul(o.evalSensitivity(this,n.mul(this.OPD,n.float(this.m)),n.mul(this.phi,n.float(this.m))),2),this.I=n.add(this.I,n.mul(this.Cm,this.Sm))}),this.$return(n.max(this.I,n.vec3(0)))}),n.getGlobalScope()[h](e,i,s,r,a)}indirectLighting(t,e,i,s,r,a){const n=t.$builder,o=this,h=o.drawContext,l="Z_PBRIndirectLighting";n.func(l,[n.vec3("normal"),n.vec3("viewVec"),o.getCommonDatasStruct(t)("data"),n.vec3("outColor").inout(),...a?[n.vec4("outRoughness").out()]:[]],function(){if(!h.drawEnvLight||!h.env.light.envLight.hasRadiance()&&!h.env.light.envLight.hasIrradiance())return;const t=Qc.getEnvLightStrength(this);if(o.occlusionTexture){const e=o.sampleOcclusionTexture(this).r;this.$l.occlusion=n.mul(n.add(n.mul(this.zOcclusionStrength,n.sub(e,1)),1),t)}else this.$l.occlusion=t;this.$l.NoV=n.clamp(n.dot(this.normal,this.viewVec),1e-4,1),this.$l.ggxLutSample=n.clamp(n.textureSampleLevel(this.zGGXLut,n.clamp(n.vec2(this.NoV,this.data.roughness),n.vec2(0),n.vec2(1)),0),n.vec4(0),n.vec4(1)),this.$l.f_ab=this.ggxLutSample.rg,this.$l.Fr=n.sub(n.max(n.vec3(n.sub(1,this.data.roughness)),this.data.f0.rgb),this.data.f0.rgb),o.iridescence?this.$l.k_S=n.mix(n.add(this.data.f0.rgb,n.mul(this.Fr,n.pow(n.sub(1,this.NoV),5))),this.data.iridescenceFresnel,this.data.iridescenceFactor.x):this.$l.k_S=n.add(this.data.f0.rgb,n.mul(this.Fr,n.pow(n.sub(1,this.NoV),5))),(a||h.env.light.envLight.hasRadiance())&&(this.$l.FssEss=n.add(n.mul(this.k_S,this.f_ab.x),n.vec3(this.f_ab.y)),this.$l.specularFactor=n.mul(this.FssEss,this.data.specularWeight,this.occlusion),o.sheen&&(this.specularFactor=n.mul(this.specularFactor,this.data.sheenAlbedoScaling)),a?this.outRoughness=n.vec4(this.specularFactor,this.data.roughness):h.env.light.envLight.hasRadiance()&&(this.$l.radiance=h.env.light.envLight.getRadiance(this,n.reflect(n.neg(this.viewVec),this.normal),this.data.roughness),this.outColor=n.add(this.outColor,n.mul(this.radiance,this.specularFactor)))),h.env.light.envLight.hasIrradiance()&&(this.$l.irradiance=h.env.light.envLight.getIrradiance(this,this.normal),o.iridescence?(this.$l.iridescenceF0Max=n.vec3(n.max(n.max(this.data.iridescenceF0.r,this.data.iridescenceF0.g),this.data.iridescenceF0.b)),this.$l.mixedF0=n.mix(this.data.f0.rgb,this.iridescenceF0Max,this.data.iridescenceFactor.x),this.Fr=n.sub(n.max(n.vec3(n.sub(1,this.data.roughness)),this.mixedF0),this.mixedF0),this.k_S=n.add(this.mixedF0,n.mul(this.Fr,n.pow(n.sub(1,this.NoV),5)))):this.$l.mixedF0=this.data.f0.rgb,this.$l.FssEss=n.add(n.mul(this.k_S,this.f_ab.x,this.data.specularWeight),n.vec3(this.f_ab.y)),this.$l.Ems=n.sub(1,n.add(this.f_ab.x,this.f_ab.y)),this.$l.F_avg=n.mul(n.add(this.mixedF0,n.div(n.sub(n.vec3(1),this.mixedF0),21)),this.data.specularWeight),this.$l.FmsEms=n.div(n.mul(this.FssEss,this.F_avg,this.Ems),n.sub(n.vec3(1),n.mul(this.F_avg,this.Ems))),this.$l.k_D=n.mul(this.data.diffuse.rgb,n.add(n.sub(n.vec3(1),this.FssEss),this.FmsEms)),this.$l.iblDiffuse=n.mul(n.add(this.FmsEms,this.k_D),n.div(this.irradiance,Math.PI),this.occlusion),o.sheen&&(this.iblDiffuse=n.mul(this.iblDiffuse,this.data.sheenAlbedoScaling)),o.transmission&&0===o.drawContext.renderPass.type&&(this.$l.iblTransmission=o.getIBLVolumnRefraction(this,this.ggxLutSample.rg,this.normal,this.viewVec,this.data.roughness,this.data.diffuse.rgb,this.data.f0.rgb,this.data.f90,this.$inputs.worldPos,this.data.f0.a,this.data.thicknessFactor,this.data.attenuationColor,this.data.attenuationDistance),this.iblDiffuse=n.mix(this.iblDiffuse,this.iblTransmission,this.data.transmissionFactor)),this.outColor=n.add(this.outColor,this.iblDiffuse)),o.sheen&&h.env.light.envLight.hasIrradiance()&&(this.$l.refl=n.reflect(n.neg(this.viewVec),this.normal),this.$l.sheenBRDF=n.clamp(n.textureSampleLevel(this.zGGXLut,n.clamp(n.vec2(this.NoV,this.data.sheenRoughness),n.vec2(0),n.vec2(1)),0),n.vec4(0),n.vec4(1)).b,this.outColor=n.add(this.outColor,n.mul(this.data.sheenColor,this.irradiance.rgb,this.sheenBRDF))),o.clearcoat&&h.env.light.envLight.hasRadiance()&&(this.$l.NoV=n.clamp(n.dot(this.data.ccNormal,this.viewVec),1e-4,1),this.$l.ggxLutSample=n.clamp(n.textureSampleLevel(this.zGGXLut,n.clamp(n.vec2(this.NoV,this.data.ccFactor.y),n.vec2(0),n.vec2(1)),0),n.vec4(0),n.vec4(1)),this.$l.f_ab=this.ggxLutSample.rg,this.$l.Fr=n.sub(n.max(n.vec3(n.sub(1,this.data.ccFactor.y)),this.data.f0.rgb),this.data.f0.rgb),this.$l.k_S=n.add(this.data.f0.rgb,n.mul(this.Fr,n.pow(n.sub(1,this.NoV),5))),this.$l.radiance=h.env.light.envLight.getRadiance(this,n.reflect(n.neg(this.viewVec),this.data.ccNormal),this.data.ccFactor.y),this.$l.FssEss=n.add(n.mul(this.k_S,this.f_ab.x),n.vec3(this.f_ab.y)),this.$l.ccSpecular=n.mul(this.radiance,this.FssEss,this.data.specularWeight,this.occlusion),this.outColor=n.add(this.outColor,n.mul(this.ccSpecular,this.data.ccFactor.x)))}),a?t.$g[l](e,i,s,r,a):t.$g[l](e,i,s,r)}};return i=h.defineFeature(),s=h.defineFeature(),r=h.defineFeature(),a=h.defineFeature(),h}function fd(t){if(t.pbrMetallicRoughnessMixed)return t;const e=Yc(t,md,rd,id("metallicRoughness"),id("specular"),id("specularColor")),i=e.defineInstanceUniform("metallic","float","Metallic"),s=e.defineInstanceUniform("roughness","float","Roughness"),r=e.defineInstanceUniform("specularFactor","rgba","SpecularFactor");return class extends e{static pbrMetallicRoughnessMixed=!0;_metallic;_roughness;_specularFactor;constructor(){super(),this._metallic=1,this._roughness=1,this._specularFactor=O.one()}copyFrom(t){super.copyFrom(t),this.metallic=t.metallic,this.roughness=t.roughness,this.specularFactor=t.specularFactor}get metallic(){return this._metallic}set metallic(t){t!==this._metallic&&(this._metallic=t,this.uniformChanged())}get roughness(){return this._roughness}set roughness(t){t!==this._roughness&&(this._roughness=t,this.uniformChanged())}get specularFactor(){return this._specularFactor}set specularFactor(t){t.equalsTo(this._specularFactor)||(this._specularFactor.set(t),this.uniformChanged())}PBRLight(t,e,i,s,r,a,n){const o=t.$builder,h="Z_PBRMetallicRoughnessLight",l=this;return o.func(h,[o.vec3("worldPos"),o.vec3("normal"),o.mat3("TBN"),o.vec3("viewVec"),o.vec4("albedo"),...n?[o.vec4("outRoughness").out()]:[]],function(){this.$l.pbrData=l.getCommonData(this,this.albedo,this.normal,this.viewVec,this.TBN),this.$l.lightingColor=o.vec3(0),this.$l.emissiveColor=l.calculateEmissiveColor(this),n?l.indirectLighting(this,this.normal,this.viewVec,this.pbrData,this.lightingColor,this.outRoughness):l.indirectLighting(this,this.normal,this.viewVec,this.pbrData,this.lightingColor),l.forEachLight(this,function(t,e,i,s,r){this.$l.diffuse=o.vec3(),this.$l.specular=o.vec3(),this.$l.lightAtten=l.calculateLightAttenuation(this,t,this.worldPos,e,i),this.$l.lightDir=l.calculateLightDirection(this,t,this.worldPos,e,i),this.$l.NoL=o.clamp(o.dot(this.normal,this.lightDir),0,1),this.$l.lightColor=o.mul(s.rgb,s.a,this.lightAtten,this.NoL),r&&(this.lightColor=o.mul(this.lightColor,l.calculateShadow(this,this.worldPos,this.NoL))),l.directLighting(this,this.lightDir,this.lightColor,this.normal,this.viewVec,this.pbrData,this.lightingColor)}),this.$return(o.add(this.lightingColor,this.emissiveColor))}),n?o.getGlobalScope()[h](e,i,a,s,r,n):o.getGlobalScope()[h](e,i,a,s,r)}vertexShader(t){super.vertexShader(t),this.needFragmentColor()&&this.drawContext.materialFlags&gu.INSTANCING&&(t.$outputs.zMetallic=this.getInstancedUniform(t,i),t.$outputs.zRoughness=this.getInstancedUniform(t,s),t.$outputs.zSpecularFactor=this.getInstancedUniform(t,r))}fragmentShader(t){if(super.fragmentShader(t),this.needFragmentColor()){const e=t.$builder;this.drawContext.materialFlags&gu.INSTANCING||(t.zMetallic=e.float().uniform(2),t.zRoughness=e.float().uniform(2),t.zSpecularFactor=e.vec4().uniform(2))}}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),this.needFragmentColor(e)&&(e.materialFlags&gu.INSTANCING||(t.setValue("zMetallic",this._metallic),t.setValue("zRoughness",this._roughness),t.setValue("zSpecularFactor",this._specularFactor)))}calculateMetallic(t,e,i){return!!(this.drawContext.materialFlags&gu.INSTANCING)?t.$inputs.zMetallic:t.zMetallic}calculateRoughness(t,e,i){return!!(this.drawContext.materialFlags&gu.INSTANCING)?t.$inputs.zRoughness:t.zRoughness}calculateSpecularFactor(t,e,i){return!!(this.drawContext.materialFlags&gu.INSTANCING)?t.$inputs.zSpecularFactor:t.zSpecularFactor}calculateCommonData(t,e,i,s,r,a){const n=t.$builder,o=this.calculateMetallic(t,e,i),h=this.calculateRoughness(t,e,i),l=this.calculateSpecularFactor(t,e,i);this.metallicRoughnessTexture?(t.$l.metallicRoughnessSample=this.sampleMetallicRoughnessTexture(t),a.metallic=n.mul(o,t.metallicRoughnessSample.z),a.roughness=n.mul(h,t.metallicRoughnessSample.y)):(a.metallic=o,a.roughness=h),a.roughness=n.mul(a.roughness,Qc.getCameraRoughnessFactor(t)),this.specularColorTexture?t.$l.specularColor=n.mul(l.rgb,this.sampleSpecularColorTexture(t).rgb):t.$l.specularColor=l.rgb,this.specularTexture?a.specularWeight=n.mul(l.a,this.sampleSpecularTexture(t).a):a.specularWeight=l.a,a.f0=n.vec4(n.mix(n.min(n.mul(this.getF0(t).rgb,t.specularColor),n.vec3(1)),e.rgb,a.metallic),this.getF0(t).a),a.f90=n.vec3(1),a.diffuse=n.vec4(n.mix(e.rgb,n.vec3(0),a.metallic),e.a),super.calculateCommonData(t,e,i,s,r,a)}}}function _d(t){return t.foliageMixed?t:class extends t{static foliageMixed=!0;constructor(){super(),this.cullMode="none"}calculateFoliageAlbedo(t,e,i){const s=t.$builder,r=this,a="Z_CalcFoliageMipLevel";s.func(a,[s.vec2("coord")],function(){this.$l.dx=s.dpdx(this.coord),this.$l.dy=s.dpdy(this.coord),this.$l.deltaMaxSqr=s.max(s.dot(this.dx,this.dx),s.dot(this.dy,this.dy)),this.$return(s.max(0,s.mul(s.log2(this.deltaMaxSqr),.5)))});const n="Z_calcFoliageAlbedo";return s.func(n,[s.vec4("albedo"),s.vec2("coord")],function(){this.$l.a=s.mul(this.albedo.a,s.add(1,s.mul(s.max(0,t[a](this.coord)),.5))),r.alphaToCoverage&&(this.a=s.add(s.div(s.sub(this.a,.4),s.max(s.fwidth(this.albedo.a),1e-4)),.5)),this.$return(s.vec4(this.albedo.rgb,this.a))}),s.getGlobalScope()[n](e,i)}}}class gd extends(Yc(ed,fd,_d)){_terrainSize;_terrainNormalMap;_textureSize;constructor(t,e,i){super(),this.metallic=0,this.roughness=1,this.specularFactor=new O(1,1,1,.2),this.doubleSidedLighting=!1,this._terrainSize=t,this._terrainNormalMap=e,this._textureSize=L.one(),i&&(this.albedoTexture=i,this._textureSize.setXY(i.width,i.height))}clone(){const t=new gd(this._terrainSize,this._terrainNormalMap,this.albedoTexture);return t.copyFrom(this),t}isTransparentPass(t){return!1}supportLighting(){return!0}supportInstancing(){return!1}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),t.setTexture("terrainNormalMap",this._terrainNormalMap),t.setValue("terrainSize",this._terrainSize),this.needFragmentColor(e)&&t.setValue("albedoTextureSize",this._textureSize)}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$inputs.pos=e.vec3().attrib("position"),t.$inputs.placement=e.vec4().attrib("texCoord1"),t.terrainNormalMap=e.tex2D().uniform(2),t.terrainSize=e.vec2().uniform(2);const i=e.textureSampleLevel(t.terrainNormalMap,e.div(t.$inputs.placement.xz,t.terrainSize),0).rgb;t.$l.normal=e.normalize(e.sub(e.mul(i,2),e.vec3(1))),t.$l.axisX=e.vec3(1,0,0),t.$l.axisZ=e.cross(t.axisX,t.normal),t.$l.axisX=e.cross(t.normal,t.axisZ),t.$l.rotPos=e.mul(e.mat3(t.axisX,t.normal,t.axisZ),t.$inputs.pos),t.$outputs.worldPos=e.mul(Qc.getWorldMatrix(t),e.vec4(e.add(t.rotPos,t.$inputs.placement.xyz),1)).xyz,Qc.setClipSpacePosition(t,e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),t.$outputs.worldNorm=e.mul(Qc.getNormalMatrix(t),e.vec4(t.normal,0)).xyz}fragmentShader(t){super.fragmentShader(t);const e=t.$builder,i=this;this.needFragmentColor()?(t.albedoTextureSize=e.vec2().uniform(2),t.$l.albedo=this.calculateAlbedoColor(t),t.albedo=i.calculateFoliageAlbedo(t,t.albedo,e.mul(i.getAlbedoTexCoord(t),t.albedoTextureSize)),t.$l.litColor=e.vec3(0),0===this.drawContext.renderPass.type&&(t.$l.normalInfo=this.calculateNormalAndTBN(t,t.$inputs.worldPos,t.$inputs.worldNorm),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN)),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a))):this.outputFragmentColor(t,t.$inputs.worldPos,null)}apply(t){return this.alphaToCoverage=t.device.getFrameBufferSampleCount()>1,this.alphaCutoff=this.alphaToCoverage?1:.8,super.apply(t)}updateRenderStates(t,e,i){super.updateRenderStates(t,e,i),e.useRasterizerState().setCullMode("none")}}class xd extends(Yc(ed,rd,fd)){static _metallicRoughnessGenerationProgram=null;static _metallicRoughnessGenerationBindGroup=null;_options;_uvScales;_numDetailMaps;_terrainInfo;constructor(t){if(super(),this.normalMapMode="object-space",this._options=null,this._numDetailMaps=0,this._uvScales=null,this._terrainInfo=null,t&&t.splatMap&&t.detailMaps&&t.detailMaps.albedoTextures){this._options=Object.assign({},t),yt(this._options.splatMap);const e=this._options.detailMaps.albedoTextures;if(Array.isArray(e)){for(const t of e){if(!t)throw new Error("TerrainMaterial(): Invalid detail albedo texture");yt(t),t.samplerOptions={addressU:"repeat",addressV:"repeat"}}this._numDetailMaps=e.length}else e.samplerOptions={addressU:"repeat",addressV:"repeat"},yt(e),this._numDetailMaps=e.depth;if(!this._numDetailMaps)throw new Error("TerrainMaterial(): Invalid detail textures");if(this._numDetailMaps>4)throw new Error("TerrainMaterial(): The maximum detail levels is 4");if(!this._options.detailMaps.uvScale||this._options.detailMaps.uvScale.length!==this._numDetailMaps)throw new Error("TerrainMaterial(): Invalid uv scale");this._uvScales=new Float32Array(4*this._numDetailMaps);for(let t=0;t<this._numDetailMaps;t++)this._uvScales[4*t]=this._options.detailMaps.uvScale[t],this._uvScales[4*t+1]=1,this._uvScales[4*t+2]=.01,this._uvScales[4*t+3]=.99;if(this._options.detailMaps.metallic){if(this._options.detailMaps.metallic.length!==this._numDetailMaps)throw new Error("TerrainMaterial(): Invalid metallic values");for(let t=0;t<this._numDetailMaps;t++)this._uvScales[4*t+2]=this._options.detailMaps.metallic[t]}if(this._options.detailMaps.roughness){if(this._options.detailMaps.roughness.length!==this._numDetailMaps)throw new Error("TerrainMaterial(): Invalid roughness values");for(let t=0;t<this._numDetailMaps;t++)this._uvScales[4*t+3]=this._options.detailMaps.roughness[t]}const i=t.detailMaps.normalTextures;if(i){let e;if(Array.isArray(i)){for(const t of i){if(!t)throw new Error("TerrainMaterial(): Invalid detail normal texture");yt(t),t.samplerOptions={addressU:"repeat",addressV:"repeat"}}e=i.length}else i.samplerOptions={addressU:"repeat",addressV:"repeat"},yt(i),e=i.depth;if(e!==this._numDetailMaps)throw new Error("TerrainMaterial(): The number of normal textures not match the number of albedo textures");if(t.detailMaps.normalScale){if(t.detailMaps.normalScale.length!==this._numDetailMaps)throw new Error("TerrainMaterial(): Invalid normal scale");for(let e=0;e<this._numDetailMaps;e++)this._uvScales[4*e+1]=t.detailMaps.normalScale[e]}}}this.metallicRoughnessTexture=this.generateMetallicRoughnessMap(),this.metallicRoughnessTexCoordIndex=-1,this.albedoTexCoordIndex=-1,this.normalTexCoordIndex=-1}clone(){const t=new xd(this._options);return t.copyFrom(this),t}get terrainInfo(){return this._terrainInfo}set terrainInfo(t){this._terrainInfo=t,this.uniformChanged()}isTransparentPass(t){return!1}supportLighting(){return!0}supportInstancing(){return!1}applyUniformValues(t,e,i){if(super.applyUniformValues(t,e,i),this.needFragmentColor(e)&&(t.setValue("terrainInfo",this._terrainInfo),this._options)){if(t.setValue("detailScales",this._uvScales),t.setTexture("splatMap",this._options.splatMap),Array.isArray(this._options.detailMaps.albedoTextures))for(let e=0;e<this._numDetailMaps;e++)t.setTexture(`detailAlbedoMap${e}`,this._options.detailMaps.albedoTextures[e]);else t.setTexture("detailAlbedoMap",this._options.detailMaps.albedoTextures);if(Array.isArray(this._options.detailMaps.normalTextures))for(let e=0;e<this._numDetailMaps;e++)t.setTexture(`detailNormalMap${e}`,this._options.detailMaps.normalTextures[e]);else t.setTexture("detailNormalMap",this._options.detailMaps.normalTextures)}}getMetallicRoughnessTexCoord=function(t){return t.$inputs.mapUV};getNormalTexCoord=function(t){return t.$inputs.mapUV};getAlbedoTexCoord=function(t){return t.$inputs.mapUV};calculateAlbedoColor(t){if(!this._options)return super.calculateAlbedoColor(t);const e=this,i=t.$builder,s="getTerrainAlbedo";return i.func(s,[],function(){this.$l.mask=i.textureSample(this.splatMap,this.$inputs.mapUV),this.$l.color=i.vec3(0);const t=!Array.isArray(e._options.detailMaps.albedoTextures);for(let s=0;s<e._numDetailMaps;s++){const e=i.mul(this.$inputs.mapUV,this.detailScales.at(s).x),r=t?i.textureArraySample(this.detailAlbedoMap,e,s).rgb:i.textureSample(this[`detailAlbedoMap${s}`],e).rgb;this.color=i.add(this.color,i.mul(r,this.mask[s]))}this.$return(i.vec4(this.color,1))}),i.getGlobalScope()[s]()}sampleDetailNormalMap(t,e,i,s,r){const a=t.$builder,n=a.sub(a.mul(a.textureSample(e,i).rgb,2),a.vec3(1)),o=a.mul(n,a.vec3(a.vec3(s).xx,1));return a.normalize(a.mul(r,o))}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$l.oPos=Qc.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(Qc.getWorldMatrix(t),e.vec4(t.oPos,1)).xyz,Qc.setClipSpacePosition(t,e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),this.needFragmentColor()&&(t.terrainInfo=e.vec4().uniform(2),t.$l.oNorm=Qc.resolveVertexNormal(t),t.$outputs.worldNorm=e.mul(Qc.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz,t.$outputs.mapUV=e.div(t.oPos.xz,t.terrainInfo.xy))}fragmentShader(t){super.fragmentShader(t);const e=t.$builder,i=this;if(this.needFragmentColor()){if(this._options){t.detailScales=e.vec4[this._numDetailMaps]().uniform(2),t.splatMap=e.tex2D().uniform(2);if(!Array.isArray(i._options.detailMaps.albedoTextures))t.detailAlbedoMap=e.tex2DArray().uniform(2);else for(let s=0;s<i._numDetailMaps;s++)t[`detailAlbedoMap${s}`]=e.tex2D().uniform(2);if(!Array.isArray(i._options.detailMaps.normalTextures))t.detailNormalMap=e.tex2DArray().uniform(2);else for(let s=0;s<i._numDetailMaps;s++)t[`detailNormalMap${s}`]=e.tex2D().uniform(2)}t.$l.albedo=this.calculateAlbedoColor(t),t.$l.normalInfo=this.calculateNormalAndTBN(t,t.$inputs.worldPos,t.$inputs.worldNorm);let s=!1;if(this._options&&this._options.detailMaps.normalTextures)if(t.$l.detailMask=e.textureSample(t.splatMap,t.$inputs.mapUV),Array.isArray(this._options.detailMaps.normalTextures))for(let i=0;i<this._options.detailMaps.normalTextures.length;i++){const r=t[`detailNormalMap${i}`],a=t.detailScales.at(i).y,n=e.mul(t.$inputs.mapUV,t.detailScales.at(i).x);t.normalInfo.normal=e.add(t.normalInfo.normal,e.mul(this.sampleDetailNormalMap(t,r,n,a,t.normalInfo.TBN),t.detailMask[i])),s=!0}else{const i=t.detailNormalMap;for(let r=0;r<this._numDetailMaps;r++){const a=t.detailScales.at(r).y,n=e.mul(t.$inputs.mapUV,t.detailScales.at(r).x),o=e.sub(e.mul(e.textureArraySample(i,n,r).rgb,2),e.vec3(1)),h=e.mul(o,e.vec3(e.vec3(a).xx,1)),l=e.normalize(e.mul(t.normalInfo.TBN,h));t.normalInfo.normal=e.add(t.normalInfo.normal,e.mul(l,t.detailMask[r])),s=!0}}s&&(t.normalInfo.normal=e.normalize(t.normalInfo.normal)),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a))}else this.outputFragmentColor(t,t.$inputs.worldPos,null)}generateMetallicRoughnessMap(){const t=Sl();if(!this._options){const e=t.createTexture2D("rgba8unorm",1,1,{mipmapping:!1});return e.update(new Uint8Array([0,1,0,0]),0,0,1,1),e.name="TerrainMetallicRoughnessMap",e}xd._metallicRoughnessGenerationProgram||(xd._metallicRoughnessGenerationProgram=t.buildRenderProgram({vertex(e){this.$inputs.pos=e.vec2().attrib("position"),this.$outputs.uv=e.vec2(),e.main(function(){this.$builtins.position=e.vec4(this.$inputs.pos,0,1),this.$outputs.uv=e.add(e.mul(this.$inputs.pos.xy,.5),e.vec2(.5)),"webgpu"===t.type&&(this.$builtins.position.y=e.neg(this.$builtins.position.y))})},fragment(t){this.$outputs.outColor=t.vec4(),this.roughness=t.vec4().uniform(0),this.metallic=t.vec4().uniform(0),this.splatMap=t.tex2D().uniform(0),t.main(function(){this.weights=t.textureSample(this.splatMap,this.$inputs.uv),this.roughnessValue=t.dot(this.weights,this.roughness),this.metallicValue=t.dot(this.weights,this.metallic),this.$outputs.outColor=t.vec4(0,this.roughnessValue,this.metallicValue,1)})}}),xd._metallicRoughnessGenerationProgram.name="@TerrainMetallicRoughnessGeneration",xd._metallicRoughnessGenerationBindGroup=t.createBindGroup(xd._metallicRoughnessGenerationProgram.bindGroupLayouts[0]));const e=O.one(),i=O.zero();for(let t=0;t<this._numDetailMaps;t++)i[t]=this._uvScales[4*t+2],e[t]=this._uvScales[4*t+3];const s=t.createTexture2D("rgba8unorm",this._options.splatMap.width,this._options.splatMap.height);s.name="TerrainMetallicRoughnessMap";const r=xd._metallicRoughnessGenerationProgram,a=xd._metallicRoughnessGenerationBindGroup;a.setValue("roughness",e),a.setValue("metallic",i),a.setTexture("splatMap",this._options.splatMap);const n=t.createFrameBuffer([s],null);return t.pushDeviceStates(),t.setFramebuffer(n),t.setProgram(r),t.setBindGroup(0,a),Ru(),t.popDeviceStates(),n.dispose(),s}updateRenderStates(t,e,i){super.updateRenderStates(t,e,i);1===i.renderPass.type?e.useRasterizerState().setCullMode("front"):e.defaultRasterizerState()}}class bd extends(Yc(ed,rd,fd)){static FEATURE_DETAIL_MAP=this.defineFeature();static FEATURE_DEBUG_MODE=this.defineFeature();static _defaultDetailMap=new wt;static _defaultNormalMap=new wt;_region;_clipmapGridInfo;_heightMap;_terrainScale;_detailMapInfo;_detailMapSize;_splatMapSize;_heightMapSize;_levelDataBuffer;constructor(t){super(),this.metallic=0,this.roughness=1,this.albedoTexCoordIndex=-1,this.normalTexCoordIndex=-1,this._region=new O(-99999,-99999,99999,99999),this._clipmapGridInfo=new O,this._heightMap=new wt(t),this._detailMapSize=256,this._splatMapSize=512,this._levelDataBuffer=new wt(Sl().createBuffer(2048,{usage:"uniform"})),this._detailMapInfo=this.createDetailMapInfo(),this._terrainScale=z.one(),this._heightMapSize=new O(this.heightMap.width,this.heightMap.height,1/this.heightMap.width,1/this.heightMap.height),this.useFeature(bd.FEATURE_DETAIL_MAP,0),this.useFeature(bd.FEATURE_DEBUG_MODE,"none")}static get MAX_DETAIL_MAP_COUNT(){return 8}get debugMode(){return this.featureUsed(bd.FEATURE_DEBUG_MODE)}set debugMode(t){this.useFeature(bd.FEATURE_DEBUG_MODE,t)}setLevelData(t,e){this._levelDataBuffer.get().bufferSubData(0,t,0,e)}get region(){return this._region}set region(t){t.equalsTo(this._region)||(this._region.set(t),this.uniformChanged())}setClipmapGridInfo(t,e,i){this._clipmapGridInfo.x===t&&this._clipmapGridInfo.y===e&&this._clipmapGridInfo.z===i||(this._clipmapGridInfo.setXYZW(t,e,i,0),this.uniformChanged())}get terrainScale(){return this._terrainScale}set terrainScale(t){this._terrainScale.equalsTo(t)||(this._terrainScale.set(t),this.uniformChanged())}get numDetailMaps(){return this._detailMapInfo.numDetailMaps}set numDetailMaps(t){if(t>8||t<0||!Number.isInteger(t))return void console.error("Invalid number of detail maps");if("webgl"===Sl().type&&t>4)return void console.error("Only 4 detail map layers is supported for WebGL1");const e=this._detailMapInfo.numDetailMaps,i=bd.getDefaultDetailMap(),s=bd.getDefaultNormalMap();if(t>e){this._detailMapInfo.numDetailMaps=t;for(let r=e;r<t;r++)this.setDetailMap(r,i),this.setDetailNormalMap(r,s),this.setDetailMapUVScale(r,80),this.setDetailMapRoughness(r,1),this._detailMapInfo.detailMapList[r].dispose(),this._detailMapInfo.detailNormalMapList[r].dispose()}else if(t<e){for(let r=t;r<e;r++)this.setDetailMap(r,i),this.setDetailNormalMap(r,s),this.setDetailMapUVScale(r,80),this.setDetailMapRoughness(r,1),this._detailMapInfo.detailMapList[r].dispose(),this._detailMapInfo.detailNormalMapList[r].dispose();this._detailMapInfo.numDetailMaps=t}this.useFeature(bd.FEATURE_DETAIL_MAP,this._detailMapInfo.numDetailMaps)}getSplatMap(){return this._detailMapInfo.splatMap?.get()??null}setSplatMap(t){if(t!==this._detailMapInfo.splatMap.get()){if(!t||2!==t.depth)return void console.error("Invalid splat map");this._detailMapInfo.splatMap.set(t),this.uniformChanged()}}getDetailMapUVScale(t){return t>=this._detailMapInfo.numDetailMaps||t<0||!Number.isInteger(t)?(console.error("Invalid detail map index"),0):this._detailMapInfo.detailMapParams[4*t]}setDetailMapUVScale(t,e){t>=this._detailMapInfo.numDetailMaps||t<0||!Number.isInteger(t)?console.error("Invalid detail map index"):this._detailMapInfo.detailMapParams[4*t]!==e&&(this._detailMapInfo.detailMapParams[4*t]=e,this.uniformChanged())}getDetailMapRoughness(t){return t>=this._detailMapInfo.numDetailMaps||t<0||!Number.isInteger(t)?(console.error("Invalid detail map index"),0):this._detailMapInfo.detailMapParams[4*t+1]}setDetailMapRoughness(t,e){t>=this._detailMapInfo.numDetailMaps||t<0||!Number.isInteger(t)?console.error("Invalid detail map index"):this._detailMapInfo.detailMapParams[4*t+1]!==e&&(this._detailMapInfo.detailMapParams[4*t+1]=e,this.uniformChanged())}getDetailMap(t){return t>=this._detailMapInfo.numDetailMaps||t<0||!Number.isInteger(t)?(console.error("Invalid detail map index"),null):this._detailMapInfo.detailMapList[t].get()}setDetailMap(t,e){if(t>=this._detailMapInfo.numDetailMaps||t<0||!Number.isInteger(t))console.error("Invalid detail map index");else if(e=e??bd.getDefaultDetailMap(),this._detailMapInfo.detailMapList[t]||(this._detailMapInfo.detailMapList[t]=new wt),this._detailMapInfo.detailMapList[t].set(e===bd.getDefaultDetailMap()?null:e),"webgl"!==Sl().type){const i=new zl,s=Sl().createFrameBuffer([this._detailMapInfo.detailMap.get()],null);i.blit(e,s,t,e.width===this._detailMapSize&&e.height===this._detailMapSize?Gl("clamp_nearest_nomip"):Gl("clamp_linear_nomip")),s.dispose()}}getDetailNormalMap(t){return t>=this._detailMapInfo.numDetailMaps||t<0||!Number.isInteger(t)?(console.error("Invalid detail map index"),null):this._detailMapInfo.detailNormalMapList[t].get()}setDetailNormalMap(t,e){if(t>=this._detailMapInfo.numDetailMaps||t<0||!Number.isInteger(t))console.error("Invalid detail map index");else if(e=e??bd.getDefaultNormalMap(),this._detailMapInfo.detailNormalMapList[t]||(this._detailMapInfo.detailNormalMapList[t]=new wt),this._detailMapInfo.detailNormalMapList[t].set(e===bd.getDefaultNormalMap()?null:e),"webgl"!==Sl().type){const i=new zl,s=Sl().createFrameBuffer([this._detailMapInfo.detailNormalMap.get()],null);i.blit(e,s,t,e.width===this._detailMapSize&&e.height===this._detailMapSize?Gl("clamp_nearest_nomip"):Gl("clamp_linear_nomip")),s.dispose()}}update(t,e){t.equalsTo(this._region)&&e.equalsTo(this._terrainScale)||(this._region.set(t),this._terrainScale.set(e),this.uniformChanged())}get heightMap(){return this._heightMap.get()}set heightMap(t){t!==this._heightMap.get()&&(this._heightMap.set(t),this._heightMapSize.setXYZW(this.heightMap.width,this.heightMap.height,1/this.heightMap.width,1/this.heightMap.height),this.uniformChanged())}needSceneColor(){return!1}needSceneDepth(){return!1}supportInstancing(){return!1}supportLighting(){return!0}getMetallicRoughnessTexCoord=function(t){return t.$inputs.uv};sampleDetailNormalMap(t,e,i){const s=t.$builder,r="webgl"===this.drawContext.device.type?s.textureSample(t[`detailNormalMap${e}`],i).rgb:s.textureArraySample(t.detailNormalMap,i,e).rgb,a=s.sub(s.mul(r,2),s.vec3(1));return s.normalize(a)}calculateDetailNormal(t,e){const i=this,s=t.$builder,r="getTerrainNormal";return s.func(r,[s.mat3("TBN")],function(){const t=i.featureUsed(bd.FEATURE_DETAIL_MAP);this.$l.detailNormal=s.vec3(0);for(let e=0;e<t+3>>2;e++)this.$l[`mask${e}`]="webgl"===i.drawContext.device.type?s.textureSample(this.splatMap,this.$inputs.uv):s.textureArraySample(this.splatMap,this.$inputs.uv,e);for(let e=0;e<t;e++){const t=s.mul(this.$inputs.uv,this.detailParams[e].x);this.detailNormal=s.add(this.detailNormal,s.mul(i.sampleDetailNormalMap(this,e,t),this["mask"+(e>>2)][3&e]))}this.$return(s.normalize(s.mul(this.TBN,this.detailNormal)))}),s.getGlobalScope()[r](e)}getNormalTexCoord=function(t){return t.$inputs.uv};calculateAlbedoColor(t){const e=this,i=t.$builder,s="getTerrainAlbedo";return i.func(s,[],function(){const t=e.featureUsed(bd.FEATURE_DETAIL_MAP);if(0===t)this.$l.checkerPos=i.mul(this.$inputs.uv,i.sub(this.region.zw,this.region.xy)),this.$l.ddx=i.dpdx(this.checkerPos),this.$l.ddy=i.dpdy(this.checkerPos),this.$l.w=i.add(i.max(i.abs(this.ddx),i.abs(this.ddy)),.01),this.$l.i=i.div(i.mul(2,i.sub(i.abs(i.sub(i.fract(i.mul(i.sub(this.checkerPos,i.mul(this.w,.5)),.5)),.5)),i.abs(i.sub(i.fract(i.mul(i.add(this.checkerPos,i.mul(this.w,.5)),.5)),.5)))),this.w),this.$l.changeRate=i.add(i.length(this.ddx),i.length(this.ddy)),this.$l.fadeStart=i.float(0),this.$l.fadeEnd=i.float(10),this.$l.fadeFactor=i.sub(1,i.smoothStep(this.fadeStart,this.fadeEnd,this.changeRate)),this.$l.checker=i.mix(.5,i.sub(.5,i.mul(.5,this.i.x,this.i.y)),this.fadeFactor),this.$l.checkerColor=i.mix(i.vec3(.4),i.vec3(1),i.vec3(this.checker)),this.$return(i.vec4(this.checkerColor,1));else{this.$l.color=i.vec3(0);for(let s=0;s<t+3>>2;s++)this.$l[`mask${s}`]="webgl"===e.drawContext.device.type?i.textureSample(this.splatMap,this.$inputs.uv):i.textureArraySample(this.splatMap,this.$inputs.uv,s);for(let s=0;s<t;s++){const t=i.mul(this.$inputs.uv,this.detailParams[s].x),r="webgl"===e.drawContext.device.type?i.textureSample(this[`detailAlbedoMap${s}`],t).rgb:i.textureArraySample(this.detailAlbedoMap,t,s).rgb;this.color=i.add(this.color,i.mul(r,this["mask"+(s>>2)][3&s]))}this.$return(i.vec4(this.color,1))}}),i.getGlobalScope()[s]()}sampleHeightMap(t,e,i,s,r){const a=t.$builder,n=.5;return a.func("sampleHeightMap",[a.vec2("uv"),a.vec2("pos"),a.vec4("levelStart"),a.vec4("levelDiff")],function(){this.$l.h1=a.textureSampleLevel(this.heightMap,this.uv,this.$inputs.miplevel).r,this.$l.ratio=a.mul(a.sub(this.pos.xyxy,this.levelStart),this.levelDiff),this.$l.maxVal=a.clamp(a.max(a.max(this.ratio.x,this.ratio.y),a.max(this.ratio.z,this.ratio.w)),0,1),this.$l.morphFactor=a.float(0),this.$if(a.greaterThan(this.maxVal,.5),function(){this.$l.h2=a.textureSampleLevel(this.heightMap,this.uv,a.add(this.$inputs.miplevel,1)).r,this.morphFactor=a.div(a.sub(this.maxVal,.5),1),this.h1=a.mix(this.h1,this.h2,this.morphFactor)}),this.$if(a.lessThan(this.maxVal,n),function(){this.$l.h2=a.textureSampleLevel(this.heightMap,this.uv,a.max(a.sub(this.$inputs.miplevel,1),0)).r,this.morphFactor=a.mul(a.add(a.div(this.maxVal,n),1),.5),this.h1=a.mix(this.h1,this.h2,this.morphFactor)}),this.$return(this.h1)}),t.sampleHeightMap(e,i,s,r)}calculateTerrainTBN(t,e,i,s,r,a,n,o,h,l){const u=this,c=t.$builder;return c.func("calcTerrainTBN",[c.vec2("clipmapPos"),c.vec2("uv"),c.vec4("texSize"),c.vec3("scale"),c.vec4("levelStart"),c.vec4("levelDiff"),c.vec3("t").out(),c.vec3("b").out(),c.vec3("n").out()],function(){this.$l.texelSize=c.mul(this.texSize.zw,c.exp2(this.$inputs.miplevel)),this.$l.delta=c.exp2(c.add(this.$inputs.miplevel,1)),this.$l.hL=u.sampleHeightMap(this,c.sub(this.uv,c.vec2(this.texelSize.x,0)),this.clipmapPos,this.levelStart,this.levelDiff),this.$l.hR=u.sampleHeightMap(this,c.add(this.uv,c.vec2(this.texelSize.x,0)),this.clipmapPos,this.levelStart,this.levelDiff),this.$l.hD=u.sampleHeightMap(this,c.add(this.uv,c.vec2(0,this.texelSize.y)),this.clipmapPos,this.levelStart,this.levelDiff),this.$l.hU=u.sampleHeightMap(this,c.sub(this.uv,c.vec2(0,this.texelSize.y)),this.clipmapPos,this.levelStart,this.levelDiff),this.$l.dHdU=c.div(c.mul(c.sub(this.hR,this.hL),this.scale.y),c.mul(this.scale.x,this.delta)),this.$l.dHdV=c.div(c.mul(c.sub(this.hD,this.hU),this.scale.y),c.mul(this.scale.z,this.delta)),this.t=c.normalize(c.vec3(1,this.dHdU,0)),this.b=c.normalize(c.vec3(0,this.dHdV,1)),this.n=c.normalize(c.cross(this.b,this.t))}),t.calcTerrainTBN(e,i,s,r,a,n,o,h,l)}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$inputs.position=e.vec3().attrib("position"),t.$inputs.clipmapInfo=e.vec4().attrib("texCoord0"),t.$inputs.miplevel=e.float().attrib("texCoord1"),t.clipmapGridInfo=e.vec4().uniform(2),t.levelData=e.vec4[128]().uniformBuffer(2),t.heightMap=e.tex2D().uniform(2),t.heightMapSize=e.vec4().uniform(2),t.region=e.vec4().uniform(2),t.terrainScale=e.vec3().uniform(2),t.$l.s=e.sin(t.$inputs.clipmapInfo.x),t.$l.c=e.cos(t.$inputs.clipmapInfo.x),t.$l.scale2=e.mul(t.$inputs.clipmapInfo.y,t.clipmapGridInfo.x),t.$l.clipmapMatrix=e.mat4(e.mul(t.c,t.scale2),e.mul(t.s,t.scale2),0,0,e.neg(e.mul(t.s,t.scale2)),e.mul(t.c,t.scale2),0,0,0,0,1,0,e.sub(e.mul(t.$inputs.clipmapInfo.z,t.clipmapGridInfo.x),t.clipmapGridInfo.y),e.sub(e.mul(t.$inputs.clipmapInfo.w,t.clipmapGridInfo.x),t.clipmapGridInfo.z),0,1),t.$l.clipmapPos=e.mul(t.clipmapMatrix,e.vec4(t.$inputs.position,1)).xy,t.$l.clipmapWorldPos=e.mul(Qc.getWorldMatrix(t),e.vec4(t.clipmapPos.x,0,t.clipmapPos.y,1)).xyz,t.$outputs.uv=e.div(e.sub(t.clipmapWorldPos.xz,t.region.xy),e.sub(t.region.zw,t.region.xy)),"webgl"===this.drawContext.device.type?(t.$l.levelStart=e.vec4(),t.$l.levelDiff=e.vec4(),t.$l.index=e.mul(e.int(t.$inputs.miplevel),2),t.$for(e.int("i"),0,32,function(){this.$if(e.equal(this.i,this.index),function(){this.levelStart=this.levelData.at(this.i),this.levelDiff=this.levelData.at(e.add(this.i,1)),this.$break()})})):(t.$l.levelStart=t.levelData.at(e.mul(e.int(t.$inputs.miplevel),2)),t.$l.levelDiff=t.levelData.at(e.add(e.mul(e.int(t.$inputs.miplevel),2),1))),t.$l.height=this.sampleHeightMap(t,t.$outputs.uv,t.clipmapWorldPos.xz,t.levelStart,t.levelDiff),t.$outputs.worldPos=e.add(t.clipmapWorldPos,e.vec3(0,e.mul(t.height,t.terrainScale.y),0)),t.$l.t=e.vec3(),t.$l.b=e.vec3(),t.$l.n=e.vec3(),this.calculateTerrainTBN(t,t.clipmapWorldPos.xz,t.$outputs.uv,t.heightMapSize,t.terrainScale,t.levelStart,t.levelDiff,t.t,t.b,t.n),t.$outputs.clipmapPos=t.clipmapWorldPos,t.$outputs.worldTangent=t.t,t.$outputs.worldBinormal=t.b,t.$outputs.worldNormal=t.n,Qc.setClipSpacePosition(t,e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),Qc.resolveMotionVector(t,t.$outputs.worldPos,t.$outputs.worldPos)}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;if(t.region=e.vec4().uniform(2),t.$l.discardable=e.or(e.any(e.lessThan(t.$inputs.uv,e.vec2(0))),e.any(e.greaterThan(t.$inputs.uv,e.vec2(1)))),t.$if(t.discardable,function(){e.discard()}),this.needFragmentColor()){t.heightMap=e.tex2D().uniform(2);const i=this.featureUsed(bd.FEATURE_DETAIL_MAP);if(i>0)if(t.detailParams=e.vec4[i]().uniform(2),"webgl"===this.drawContext.device.type){t.splatMap=e.tex2D().uniform(2);for(let s=0;s<i;s++)t[`detailAlbedoMap${s}`]=e.tex2D().uniform(2),t[`detailNormalMap${s}`]=e.tex2D().uniform(2)}else t.splatMap=e.tex2DArray().uniform(2),t.detailAlbedoMap=e.tex2DArray().uniform(2),t.detailNormalMap=e.tex2DArray().uniform(2);switch(t.$l.albedo=this.calculateAlbedoColor(t),t.$l.worldNormal=e.normalize(t.$inputs.worldNormal),t.$l.normalInfo=this.calculateNormalAndTBN(t,t.$inputs.worldPos,t.$inputs.worldNormal,t.$inputs.worldTangent,t.$inputs.worldBinormal),this.featureUsed(bd.FEATURE_DETAIL_MAP)>0&&(t.normalInfo.normal=this.calculateDetailNormal(t,t.normalInfo.TBN)),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN),this.featureUsed(bd.FEATURE_DEBUG_MODE)){case"albedo":t.$l.outColor=t.albedo;break;case"vertex_normal":t.$l.outColor=e.vec4(e.add(e.mul(t.normalInfo.TBN[2],.5),e.vec3(.5)),1);break;case"detail_normal":t.$l.outColor=e.vec4(e.add(e.mul(t.normalInfo.normal,.5),e.vec3(.5)),1);break;case"tangent":t.$l.outColor=e.vec4(e.add(e.mul(t.normalInfo.TBN[0],.5),e.vec3(.5)),1);break;case"bitangent":t.$l.outColor=e.vec4(e.add(e.mul(t.normalInfo.TBN[1],.5),e.vec3(.5)),1);break;case"uv":t.$l.outColor=e.vec4(t.$inputs.uv,0,1);break;default:t.$l.outColor=e.vec4(t.litColor,1)}this.drawContext.materialFlags&gu.SSR_STORE_ROUGHNESS?(t.$l.outRoughness=e.vec4(0,0,0,0),this.outputFragmentColor(t,t.$inputs.worldPos,t.outColor,t.outRoughness,t.outColor)):this.outputFragmentColor(t,t.$inputs.worldPos,t.outColor)}else this.outputFragmentColor(t,t.$inputs.worldPos,null)}applyUniformValues(t,e,i){if(super.applyUniformValues(t,e,i),t.setValue("clipmapGridInfo",this._clipmapGridInfo),t.setValue("region",this._region),t.setValue("terrainScale",this._terrainScale),t.setTexture("heightMap",this._heightMap.get(),Gl("clamp_linear_nomip")),t.setValue("heightMapSize",this._heightMapSize),t.setBuffer("levelData",this._levelDataBuffer.get()),this.needFragmentColor(e)&&this._detailMapInfo.numDetailMaps>0){if(t.setTexture("splatMap",this._detailMapInfo.splatMap.get()),"webgl"===e.device.type)for(let e=0;e<this._detailMapInfo.numDetailMaps;e++)t.setTexture(`detailAlbedoMap${e}`,this._detailMapInfo.detailMapList[e]?.get()??bd.getDefaultDetailMap(),Gl("repeat_linear")),t.setTexture(`detailNormalMap${e}`,this._detailMapInfo.detailNormalMapList[e]?.get()??bd.getDefaultNormalMap(),Gl("repeat_linear"));else t.setTexture("detailAlbedoMap",this._detailMapInfo.detailMap.get(),Gl("repeat_linear")),t.setTexture("detailNormalMap",this._detailMapInfo.detailNormalMap.get(),Gl("repeat_linear"));t.setValue("detailParams",this._detailMapInfo.detailMapParams)}}createDetailMapInfo(){const t=Sl(),e="webgl"===t.type,i=e?null:t.createTexture2DArray("rgba8unorm",this._detailMapSize,this._detailMapSize,8),s=e?null:t.createTexture2DArray("rgba8unorm",this._detailMapSize,this._detailMapSize,8),r=e?t.createTexture2D("rgba8unorm",this._splatMapSize,this._splatMapSize):t.createTexture2DArray("rgba8unorm",this._splatMapSize,this._splatMapSize,2);if(t.pushDeviceStates(),!e){const e=t.createFrameBuffer([i],null);t.setFramebuffer(e);for(let s=0;s<i.depth;s++)e.setColorAttachmentLayer(0,s),t.clearFrameBuffer(O.zero(),1,0);e.dispose();const r=t.createFrameBuffer([s],null);t.setFramebuffer(r);for(let e=0;e<s.depth;e++)r.setColorAttachmentLayer(0,e),t.clearFrameBuffer(new O(.5,.5,1,1),1,0);r.dispose()}const a=t.createFrameBuffer([r],null);t.setFramebuffer(a);for(let e=0;e<r.depth;e++)a.setColorAttachmentLayer(0,e),t.clearFrameBuffer(0===e?new O(1,0,0,0):O.zero(),1,0);return t.popDeviceStates(),a.dispose(),{detailMap:new wt(i),detailNormalMap:new wt(s),detailMapList:[],detailNormalMapList:[],splatMap:new wt(r),detailMapParams:new Float32Array(32),numDetailMaps:0}}onDispose(){if(super.onDispose(),this._heightMap.dispose(),this._levelDataBuffer.dispose(),this._detailMapInfo){this._detailMapInfo.detailMap?.dispose(),this._detailMapInfo.detailNormalMap?.dispose(),this._detailMapInfo.splatMap?.dispose();for(const t of this._detailMapInfo.detailMapList)t.dispose();for(const t of this._detailMapInfo.detailNormalMapList)t.dispose();this._detailMapInfo=null}}static getDefaultDetailMap(){if(!bd._defaultDetailMap.get()){const t=Sl().createTexture2D("rgba8unorm",1,1);t.update(new Uint8Array([0,0,0,255]),0,0,1,1),bd._defaultDetailMap.set(t)}return bd._defaultDetailMap.get()}static getDefaultNormalMap(){if(!bd._defaultNormalMap.get()){const t=Sl().createTexture2D("rgba8unorm",1,1);t.update(new Uint8Array([128,128,255,255]),0,0,1,1),bd._defaultNormalMap.set(t)}return bd._defaultNormalMap.get()}}class vd extends(Yc(ed,fd,ad)){static FEATURE_VERTEX_NORMAL=this.defineFeature();static FEATURE_VERTEX_TANGENT=this.defineFeature();constructor(){super(),this.useFeature(vd.FEATURE_VERTEX_NORMAL,!0)}clone(){const t=new vd;return t.copyFrom(this),t}copyFrom(t){super.copyFrom(t),this.vertexNormal=t.vertexNormal,this.vertexTangent=t.vertexTangent}get vertexNormal(){return this.featureUsed(vd.FEATURE_VERTEX_NORMAL)}set vertexNormal(t){this.useFeature(vd.FEATURE_VERTEX_NORMAL,!!t)}get vertexTangent(){return this.featureUsed(vd.FEATURE_VERTEX_TANGENT)}set vertexTangent(t){this.useFeature(vd.FEATURE_VERTEX_TANGENT,!!t)}vertexShader(t){super.vertexShader(t);const e=t.$builder,i=Qc.getWorldMatrix(t);t.$l.oPos=Qc.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(i,e.vec4(t.oPos,1)).xyz,t.$l.csPos=e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1)),Qc.setClipSpacePosition(t,t.csPos),this.transmission&&(t.$outputs.screenUV=e.add(e.mul(e.div(t.csPos.xy,t.csPos.w),.5),e.vec2(.5)),t.$outputs.modelScale=e.vec3(e.length(i[0].xyz),e.length(i[1].xyz),e.length(i[2].xyz))),this.vertexNormal&&(t.$l.oNorm=Qc.resolveVertexNormal(t),t.$outputs.wNorm=e.mul(Qc.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz,this.vertexTangent&&(t.$l.oTangent=Qc.resolveVertexTangent(t),t.$outputs.wTangent=e.mul(Qc.getNormalMatrix(t),e.vec4(t.oTangent.xyz,0)).xyz,t.$outputs.wBinormal=e.mul(e.cross(t.$outputs.wNorm,t.$outputs.wTangent),t.oTangent.w)))}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;this.needFragmentColor()?(t.$l.albedo=this.calculateAlbedoColor(t),this.vertexColor&&(t.albedo=e.mul(t.albedo,this.getVertexColor(t))),0===this.drawContext.renderPass.type?(t.$l.normalInfo=this.calculateNormalAndTBN(t,t.$inputs.worldPos,t.$inputs.wNorm,t.$inputs.wTangent,t.$inputs.wBinormal),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),this.drawContext.materialFlags&gu.SSR_STORE_ROUGHNESS?(t.$l.outRoughness=e.vec4(),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN,t.outRoughness),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a),t.outRoughness,e.vec4(e.add(e.mul(t.normalInfo.normal,.5),e.vec3(.5)),1))):(t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a)))):this.outputFragmentColor(t,t.$inputs.worldPos,t.albedo)):this.outputFragmentColor(t,t.$inputs.worldPos,null)}}function yd(t){if(t.pbrSpecularGlossnessMixed)return t;const e=Yc(t,md,rd,id("specular")),i=e.defineInstanceUniform("specularFactor","rgb","SpecularFactor"),s=e.defineInstanceUniform("glossinessFactor","float","GlossinessFactor");return class extends e{static pbrSpecularGlossnessMixed=!0;_specularFactor;_glossinessFactor;constructor(){super(),this._specularFactor=z.one(),this._glossinessFactor=1}copyFrom(t){super.copyFrom(t),this.specularFactor=t.specularFactor,this.glossinessFactor=t.glossinessFactor}get specularFactor(){return this._specularFactor}set specularFactor(t){t.equalsTo(this._specularFactor)||(this._specularFactor.set(t),this.uniformChanged())}get glossinessFactor(){return this._glossinessFactor}set glossinessFactor(t){t!==this._glossinessFactor&&(this._glossinessFactor=t,this.uniformChanged())}vertexShader(t){super.vertexShader(t),this.needFragmentColor()&&this.drawContext.materialFlags&gu.INSTANCING&&(t.$outputs.zSpecularFactor=this.getInstancedUniform(t,i),t.$outputs.zGlossinessFactor=this.getInstancedUniform(t,s))}fragmentShader(t){if(super.fragmentShader(t),this.needFragmentColor()&&!(this.drawContext.materialFlags&gu.INSTANCING)){const e=t.$builder;t.zSpecularFactor=e.vec3().uniform(2),t.zGlossinessFactor=e.float().uniform(2)}}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),!this.needFragmentColor(e)||e.materialFlags&gu.INSTANCING||(t.setValue("zSpecularFactor",this._specularFactor),t.setValue("zGlossinessFactor",this._glossinessFactor))}PBRLight(t,e,i,s,r,a,n){const o=t.$builder,h="Z_PBRSpecularGlossinessLight",l=this;return o.func(h,[o.vec3("worldPos"),o.vec3("normal"),o.mat3("TBN"),o.vec3("viewVec"),o.vec4("albedo"),...n?[o.vec4("outRoughness").out()]:[]],function(){this.$l.pbrData=l.getCommonData(this,this.albedo,this.normal,this.viewVec,this.TBN),this.$l.lightingColor=o.vec3(0),this.$l.emissiveColor=l.calculateEmissiveColor(this),n?l.indirectLighting(this,this.normal,this.viewVec,this.pbrData,this.lightingColor,this.outRoughness):l.indirectLighting(this,this.normal,this.viewVec,this.pbrData,this.lightingColor),l.forEachLight(this,function(t,e,i,s,r){this.$l.diffuse=o.vec3(),this.$l.specular=o.vec3(),this.$l.lightAtten=l.calculateLightAttenuation(this,t,this.worldPos,e,i),this.$l.lightDir=l.calculateLightDirection(this,t,this.worldPos,e,i),this.$l.NoL=o.clamp(o.dot(this.normal,this.lightDir),0,1),this.$l.lightColor=o.mul(s.rgb,s.a,this.lightAtten,this.NoL),r&&(this.lightColor=o.mul(this.lightColor,l.calculateShadow(this,this.worldPos,this.NoL))),l.directLighting(this,this.lightDir,this.lightColor,this.normal,this.viewVec,this.pbrData,this.lightingColor)}),this.$return(o.add(this.lightingColor,this.emissiveColor))}),n?o.getGlobalScope()[h](e,i,a,s,r,n):o.getGlobalScope()[h](e,i,a,s,r)}calculateCommonData(t,e,i,s,r,a){super.calculateCommonData(t,e,i,s,r,a);const n=t.$builder,o=!!(this.drawContext.materialFlags&gu.INSTANCING),h=o?t.$inputs.zSpecularFactor:t.zSpecularFactor,l=o?t.$inputs.zGlossinessFactor:t.zGlossinessFactor;this.specularTexture?(t.$l.specularTextureSample=this.sampleSpecularTexture(t),a.roughness=n.sub(1,n.mul(l,t.specularTextureSample.a)),a.f0=n.vec4(n.mul(t.specularTextureSample.rgb,h),this.getF0(t).a)):(a.roughness=n.sub(1,l),a.f0=n.vec4(h,this.getF0(t).a)),a.roughness=n.mul(a.roughness,Qc.getCameraRoughnessFactor(t)),a.metallic=n.max(n.max(a.f0.r,a.f0.g),a.f0.b),a.diffuse=n.vec4(n.mul(e.rgb,n.sub(1,a.metallic)),e.a),a.specularWeight=1,a.f90=n.vec3(1)}}}class Td extends(Yc(ed,yd,ad)){static FEATURE_VERTEX_NORMAL=this.defineFeature();static FEATURE_VERTEX_TANGENT=this.defineFeature();constructor(){super(),this.useFeature(Td.FEATURE_VERTEX_NORMAL,!0)}clone(){const t=new Td;return t.copyFrom(this),t}copyFrom(t){super.copyFrom(t),this.vertexNormal=t.vertexNormal,this.vertexTangent=t.vertexTangent}get vertexNormal(){return this.featureUsed(Td.FEATURE_VERTEX_NORMAL)}set vertexNormal(t){this.useFeature(Td.FEATURE_VERTEX_NORMAL,!!t)}get vertexTangent(){return this.featureUsed(Td.FEATURE_VERTEX_TANGENT)}set vertexTangent(t){this.useFeature(Td.FEATURE_VERTEX_TANGENT,!!t)}vertexShader(t){super.vertexShader(t);const e=t.$builder,i=Qc.getWorldMatrix(t);t.$l.oPos=Qc.resolveVertexPosition(t),t.$outputs.worldPos=e.mul(i,e.vec4(t.oPos,1)).xyz,t.$l.csPos=e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1)),Qc.setClipSpacePosition(t,t.csPos),this.transmission&&(t.$outputs.screenUV=e.add(e.mul(e.div(t.csPos.xy,t.csPos.w),.5),e.vec2(.5)),t.$outputs.modelScale=e.vec3(e.length(i[0].xyz),e.length(i[1].xyz),e.length(i[2].xyz))),this.vertexNormal&&(t.$l.oNorm=Qc.resolveVertexNormal(t),t.$outputs.wNorm=e.mul(Qc.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz,this.vertexTangent&&(t.$l.oTangent=Qc.resolveVertexTangent(t),t.$outputs.wTangent=e.mul(Qc.getNormalMatrix(t),e.vec4(t.oTangent.xyz,0)).xyz,t.$outputs.wBinormal=e.mul(e.cross(t.$outputs.wNorm,t.$outputs.wTangent),t.oTangent.w)))}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;this.needFragmentColor()?(t.$l.albedo=this.calculateAlbedoColor(t),this.vertexColor&&(t.albedo=e.mul(t.albedo,this.getVertexColor(t))),0===this.drawContext.renderPass.type?(t.$l.normalInfo=this.calculateNormalAndTBN(t,t.$inputs.worldPos,t.$inputs.wNorm,t.$inputs.wTangent,t.$inputs.wBinormal),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),this.drawContext.materialFlags&gu.SSR_STORE_ROUGHNESS?(t.$l.outRoughness=e.vec4(),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN,t.outRoughness),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a),t.outRoughness,e.vec4(e.add(e.mul(t.normalInfo.normal,.5),e.vec3(.5)),1))):(t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a)))):this.outputFragmentColor(t,t.$inputs.worldPos,t.albedo)):this.outputFragmentColor(t,t.$inputs.worldPos,null)}}function wd(t){if(t.pbrBluePrint)return t;const e=Yc(t,pd,rd);return class extends e{static pbrBluePrint=!0;constructor(){super()}copyFrom(t){super.copyFrom(t)}getCommonData(t,e,i,s,r,a,n,o,h,l){this.calculateCommonData(t,l,i,s,r,a,n,o,h,e)}getCommonDatasStruct(t){const e=t.$builder;return e.defineStruct([e.vec4("f0"),e.vec3("f90"),e.vec4("albedo"),e.vec4("diffuse"),e.float("metallic"),e.float("roughness"),e.vec3("normal"),e.mat3("TBN"),e.vec3("emissive"),e.vec3("specular")])}PBRLight(t,e,i,s,r){const a=t.$builder,n="Z_PBRBluePrintLight",o=this;return a.func(n,[o.getCommonDatasStruct(t)("pbrData"),a.vec3("viewVec"),a.vec3("worldPos"),...r?[a.vec4("outRoughness").out()]:[]],function(){this.$l.lightingColor=a.vec3(0),this.$l.emissiveColor=this.pbrData.emissive,r?o.indirectLighting(this,this.viewVec,this.pbrData,this.lightingColor,this.outRoughness):o.indirectLighting(this,this.viewVec,this.pbrData,this.lightingColor),o.forEachLight(this,function(t,e,i,s,r){this.$l.diffuse=a.vec3(),this.$l.specular=a.vec3(),this.$l.lightAtten=o.calculateLightAttenuation(this,t,this.worldPos,e,i),this.$l.lightDir=o.calculateLightDirection(this,t,this.worldPos,e,i),this.$l.NoL=a.clamp(a.dot(this.pbrData.normal,this.lightDir),0,1),this.$l.lightColor=a.mul(s.rgb,s.a,this.lightAtten,this.NoL),r&&(this.lightColor=a.mul(this.lightColor,o.calculateShadow(this,this.worldPos,this.NoL))),o.directLighting(this,this.lightDir,this.lightColor,this.viewVec,this.pbrData,this.lightingColor)}),this.$return(a.vec4(a.add(this.lightingColor,this.emissiveColor),this.pbrData.albedo.a))}),r?a.getGlobalScope()[n](s,i,e,r):a.getGlobalScope()[n](s,i,e)}vertexShader(t){super.vertexShader(t)}fragmentShader(t){const e=t.$builder;super.fragmentShader(t),this.needFragmentColor()&&this.drawContext.drawEnvLight&&(t.zGGXLut=e.tex2D().uniform(2))}calculateCommonData(t,e,i,s,r,a,n,o,h,l){const u=this,c=t.$builder,d="zCalculateCommonDataPBRBluePrint",p=[this.getCommonDatasStruct(t)("zCommonData").out(),c.vec3("zViewVec"),c.vec3("zWorldPos"),c.vec3("zVertexNormal"),c.vec3("zVertexTangent"),c.vec3("zVertexBinormal"),c.vec4("zVertexColor"),c.vec2("zVertexUV")],m=[l,i,s,r,a,n,o,h];c.func(d,p,function(){const i=e.create(c);this.zCommonData.albedo=c.vec4(u.getOutput(i,"BaseColor")?.rgb??c.vec3(1),u.getOutput(i,"Opacity")??1),this.zCommonData.metallic=u.getOutput(i,"Metallic")??0,this.zCommonData.roughness=u.getOutput(i,"Roughness")?c.mul(u.getOutput(i,"Roughness"),Qc.getCameraRoughnessFactor(t)):Qc.getCameraRoughnessFactor(t),this.zCommonData.specular=u.getOutput(i,"Specular")??c.vec3(1),this.zCommonData.emissive=u.getOutput(i,"Emissive")??c.vec3(0),this.zCommonData.f90=c.vec3(1),this.zCommonData.f0=c.vec4(c.mix(c.min(c.mul(c.vec3(.04),this.zCommonData.specular),c.vec3(1)),this.zCommonData.albedo.rgb,this.zCommonData.metallic),1.5),this.$l.tangent=u.getOutput(i,"Tangent")??this.zVertexTangent,this.$l.ng=c.normalize(this.zVertexNormal),this.$l.t_=c.normalize(this.tangent),this.$l.t=c.normalize(c.sub(this.t_,c.mul(this.ng,c.dot(this.ng,this.t_)))),this.$l.b=c.cross(this.ng,this.t),this.zCommonData.TBN=c.mat3(this.t,this.b,this.ng),u.getOutput(i,"Normal")?this.zCommonData.normal=c.normalize(c.mul(this.zCommonData.TBN,u.getOutput(i,"Normal"))):this.zCommonData.normal=this.ng,this.zCommonData.diffuse=c.vec4(c.mix(this.zCommonData.albedo.rgb,c.vec3(0),this.zCommonData.metallic),this.zCommonData.albedo.a)}),t[d](...m)}getOutput(t,e){return t.find(t=>t.name===e)?.exp}directLighting(t,e,i,s,r,a){const n=t.$builder,o=this,h="Z_PBRDirectLighting";n.func(h,[n.vec3("L"),n.vec3("lightColor"),n.vec3("viewVec"),o.getCommonDatasStruct(t)("data"),n.vec3("outColor").inout()],function(){this.$l.H=n.normalize(n.add(this.viewVec,this.L)),this.$l.NoH=n.clamp(n.dot(this.data.normal,this.H),0,1),this.$l.NoL=n.clamp(n.dot(this.data.normal,this.L),0,1),this.$l.NoV=n.clamp(n.dot(this.data.normal,this.viewVec),0,1),this.$if(n.greaterThan(this.NoL,0),function(){this.$l.VoH=n.clamp(n.dot(this.viewVec,this.H),0,1),this.$l.schlickFresnel=o.fresnelSchlick(this,this.VoH,this.data.f0.rgb,this.data.f90),this.$l.F=this.schlickFresnel,this.$l.alphaRoughness=n.mul(this.data.roughness,this.data.roughness),this.$l.D=o.distributionGGX(this,this.NoH,this.alphaRoughness),this.$l.V=o.visGGX(this,this.NoV,this.NoL,this.alphaRoughness),this.$l.specular=n.mul(this.lightColor,this.D,this.V,this.F),this.outColor=n.add(this.outColor,this.specular),this.$l.diffuseBRDF=n.mul(n.sub(n.vec3(1),this.F),n.div(this.data.diffuse.rgb,Math.PI)),this.$l.diffuse=n.mul(this.lightColor,n.max(this.diffuseBRDF,n.vec3(0))),this.outColor=n.add(this.outColor,this.diffuse)})}),t.$g[h](e,i,s,r,a)}indirectLighting(t,e,i,s,r){const a=t.$builder,n=this.drawContext,o="Z_PBRIndirectLighting";a.func(o,[a.vec3("viewVec"),this.getCommonDatasStruct(t)("data"),a.vec3("outColor").inout(),...r?[a.vec4("outRoughness").out()]:[]],function(){if(!n.drawEnvLight||!n.env.light.envLight.hasRadiance()&&!n.env.light.envLight.hasIrradiance())return;const t=Qc.getEnvLightStrength(this);this.$l.occlusion=t,this.$l.NoV=a.clamp(a.dot(this.data.normal,this.viewVec),1e-4,1),this.$l.ggxLutSample=a.clamp(a.textureSampleLevel(this.zGGXLut,a.clamp(a.vec2(this.NoV,this.data.roughness),a.vec2(0),a.vec2(1)),0),a.vec4(0),a.vec4(1)),this.$l.f_ab=this.ggxLutSample.rg,this.$l.Fr=a.sub(a.max(a.vec3(a.sub(1,this.data.roughness)),this.data.f0.rgb),this.data.f0.rgb),this.$l.k_S=a.add(this.data.f0.rgb,a.mul(this.Fr,a.pow(a.sub(1,this.NoV),5))),(r||n.env.light.envLight.hasRadiance())&&(this.$l.FssEss=a.add(a.mul(this.k_S,this.f_ab.x),a.vec3(this.f_ab.y)),this.$l.specularFactor=a.mul(this.FssEss,this.occlusion),r?this.outRoughness=a.vec4(this.specularFactor,this.data.roughness):n.env.light.envLight.hasRadiance()&&(this.$l.radiance=n.env.light.envLight.getRadiance(this,a.reflect(a.neg(this.viewVec),this.data.normal),this.data.roughness),this.outColor=a.add(this.outColor,a.mul(this.radiance,this.specularFactor)))),n.env.light.envLight.hasIrradiance()&&(this.$l.irradiance=n.env.light.envLight.getIrradiance(this,this.data.normal),this.$l.mixedF0=this.data.f0.rgb,this.$l.FssEss=a.add(a.mul(this.k_S,this.f_ab.x),a.vec3(this.f_ab.y)),this.$l.Ems=a.sub(1,a.add(this.f_ab.x,this.f_ab.y)),this.$l.F_avg=a.add(this.mixedF0,a.div(a.sub(a.vec3(1),this.mixedF0),21)),this.$l.FmsEms=a.div(a.mul(this.FssEss,this.F_avg,this.Ems),a.sub(a.vec3(1),a.mul(this.F_avg,this.Ems))),this.$l.k_D=a.mul(this.data.diffuse.rgb,a.add(a.sub(a.vec3(1),this.FssEss),this.FmsEms)),this.$l.iblDiffuse=a.mul(a.add(this.FmsEms,this.k_D),this.irradiance,this.occlusion),this.outColor=a.add(this.outColor,this.iblDiffuse))}),r?t.$g[o](e,i,s,r):t.$g[o](e,i,s)}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),this.needFragmentColor(e)&&e.drawEnvLight&&t.setTexture("zGGXLut",dd(1024))}}}let Sd=1;function Ad(){return"Param"+Sd++}class Cd extends b{_inputs;_outputs;_error;constructor(){super(),this._inputs=[],this._outputs=[],this._error=""}get isUniform(){return!1}get paramName(){return""}getOutputType(t){return this.getType(t)}get inputs(){return this._inputs}get outputs(){return this._outputs}get error(){return this._error}set error(t){this._error=t}toString(){return""}check(){this._error=this.validate()}reset(){this._error=""}setInput(t,e,i){const s=this._inputs.find(e=>e.id===t);if(!s)throw new Error(`Input with id ${t} not found`);s.inputNode=e,s.inputId=i}validate(){for(let t=0;t<this._inputs.length;t++){const e=this._inputs[t];if(e.required&&!e.inputNode)return`Missing required argument: input[${t}]`}return""}}class Ed extends Cd{_value;_isUniform;_paramName;constructor(){super(),this._value=0,this._isUniform=!1,this._paramName="",this._outputs=[{id:1,name:""}]}toString(){return this._isUniform?this._paramName:""+Math.round(1e3*this._value)/1e3}static getSerializationCls(){return{ctor:Ed,name:"ConstantScalarNode",getProps:()=>[{name:"isUniform",type:"bool",get(t){t.bool[0]=this.isUniform},set(t){this.isUniform=t.bool[0]}},{name:"paramName",type:"string",get(t){t.str[0]=this.paramName},set(t){this.paramName=t.str[0]}},{name:"x",type:"float",get(t){t.num[0]=this.x},set(t){this.x=t.num[0]}}]}}get isUniform(){return this._isUniform}set isUniform(t){this._isUniform!==!!t&&(this._isUniform=!!t,this._paramName||(this._paramName=Ad()))}get paramName(){return this._paramName}set paramName(t){t!==this.paramName&&(this._paramName=t,this.dispatchEvent("changed"))}get x(){return this._value}set x(t){t!==this._value&&(this._value=t,this.dispatchEvent("changed"))}validate(){return""}getType(){return"float"}}class Md extends Cd{_value;_isUniform;_paramName;constructor(){super(),this._value=[0,0],this._isUniform=!1,this._paramName="",this._outputs=[{id:1,name:""},{id:2,name:"x",swizzle:"x"},{id:3,name:"y",swizzle:"y"}]}toString(){return this._isUniform?this._paramName:`${Math.round(1e3*this._value[0])/1e3},${Math.round(1e3*this._value[1])/1e3}`}get isUniform(){return this._isUniform}set isUniform(t){this._isUniform!==!!t&&(this._isUniform=!!t,this._paramName||(this._paramName=Ad()))}get paramName(){return this._paramName}set paramName(t){t!==this._paramName&&(this._paramName=t,this.dispatchEvent("changed"))}get x(){return this._value[0]}set x(t){t!==this._value[0]&&(this._value[0]=t,this.dispatchEvent("changed"))}get y(){return this._value[1]}set y(t){t!==this._value[1]&&(this._value[1]=t,this.dispatchEvent("changed"))}static getSerializationCls(){return{ctor:Md,name:"ConstantVec2Node",getProps:()=>[{name:"isUniform",type:"bool",get(t){t.bool[0]=this.isUniform},set(t){this.isUniform=t.bool[0]}},{name:"paramName",type:"string",get(t){t.str[0]=this.paramName},set(t){this.paramName=t.str[0]}},{name:"x",type:"float",get(t){t.num[0]=this.x},set(t){this.x=t.num[0]}},{name:"y",type:"float",get(t){t.num[0]=this.y},set(t){this.y=t.num[0]}}]}}validate(){return""}getType(t){return t>1?"float":"vec2"}}class Bd extends Cd{_value;_isUniform;_paramName;constructor(){super(),this._value=[0,0,0],this._isUniform=!1,this._paramName="",this._outputs=[{id:1,name:""},{id:2,name:"x",swizzle:"x"},{id:3,name:"y",swizzle:"y"},{id:4,name:"z",swizzle:"z"}]}toString(){return this._isUniform?this._paramName:`${Math.round(1e3*this._value[0])/1e3},${Math.round(1e3*this._value[1])/1e3},${Math.round(1e3*this._value[2])/1e3}`}get isUniform(){return this._isUniform}set isUniform(t){this._isUniform!==!!t&&(this._isUniform=!!t,this._paramName||(this._paramName=Ad()))}get paramName(){return this._paramName}set paramName(t){t!==this._paramName&&(this._paramName=t,this.dispatchEvent("changed"))}get x(){return this._value[0]}set x(t){t!==this._value[0]&&(this._value[0]=t,this.dispatchEvent("changed"))}get y(){return this._value[1]}set y(t){t!==this._value[1]&&(this._value[1]=t,this.dispatchEvent("changed"))}get z(){return this._value[2]}set z(t){t!==this._value[2]&&(this._value[2]=t,this.dispatchEvent("changed"))}static getSerializationCls(){return{ctor:Bd,name:"ConstantVec3Node",getProps:()=>[{name:"isUniform",type:"bool",get(t){t.bool[0]=this.isUniform},set(t){this.isUniform=t.bool[0]}},{name:"paramName",type:"string",get(t){t.str[0]=this.paramName},set(t){this.paramName=t.str[0]}},{name:"x",type:"float",get(t){t.num[0]=this.x},set(t){this.x=t.num[0]}},{name:"y",type:"float",get(t){t.num[0]=this.y},set(t){this.y=t.num[0]}},{name:"z",type:"float",get(t){t.num[0]=this.z},set(t){this.z=t.num[0]}},{name:"rgb",type:"rgb",get(t){t.num[0]=this.x,t.num[1]=this.y,t.num[2]=this.z},set(t){this.x=t.num[0],this.y=t.num[1],this.z=t.num[2]}}]}}validate(){return""}getType(t){return t>1?"float":"vec3"}}class Id extends Cd{_value;_paramName;_isUniform;constructor(){super(),this._value=[0,0,0,0],this._isUniform=!1,this._paramName="",this._outputs=[{id:1,name:""},{id:2,name:"x",swizzle:"x"},{id:3,name:"y",swizzle:"y"},{id:4,name:"z",swizzle:"z"},{id:5,name:"w",swizzle:"w"}]}toString(){return this._isUniform?this._paramName:`${Math.round(1e3*this._value[0])/1e3},${Math.round(1e3*this._value[1])/1e3},${Math.round(1e3*this._value[2])/1e3},${Math.round(1e3*this._value[3])/1e3}`}get isUniform(){return this._isUniform}set isUniform(t){this._isUniform!==!!t&&(this._isUniform=!!t,this._paramName||(this._paramName=Ad()))}get paramName(){return this._paramName}set paramName(t){t!==this._paramName&&(this._paramName=t,this.dispatchEvent("changed"))}get x(){return this._value[0]}set x(t){t!==this._value[0]&&(this._value[0]=t,this.dispatchEvent("changed"))}get y(){return this._value[1]}set y(t){t!==this._value[1]&&(this._value[1]=t,this.dispatchEvent("changed"))}get z(){return this._value[2]}set z(t){t!==this._value[2]&&(this._value[2]=t,this.dispatchEvent("changed"))}get w(){return this._value[3]}set w(t){t!==this._value[3]&&(this._value[3]=t,this.dispatchEvent("changed"))}static getSerializationCls(){return{ctor:Id,name:"ConstantVec4Node",getProps:()=>[{name:"isUniform",type:"bool",get(t){t.bool[0]=this.isUniform},set(t){this.isUniform=t.bool[0]}},{name:"paramName",type:"string",get(t){t.str[0]=this.paramName},set(t){this.paramName=t.str[0]}},{name:"x",type:"float",get(t){t.num[0]=this.x},set(t){this.x=t.num[0]}},{name:"y",type:"float",get(t){t.num[0]=this.y},set(t){this.y=t.num[0]}},{name:"z",type:"float",get(t){t.num[0]=this.z},set(t){this.z=t.num[0]}},{name:"w",type:"float",get(t){t.num[0]=this.w},set(t){this.w=t.num[0]}},{name:"rgba",type:"rgba",get(t){t.num[0]=this.x,t.num[1]=this.y,t.num[2]=this.z,t.num[3]=this.w},set(t){this.x=t.num[0],this.y=t.num[1],this.z=t.num[2],this.w=t.num[3]}}]}}validate(){return""}getType(t){return t>1?"float":"vec4"}}new wt,new wt,new wt;const Pd=[{name:"Name",type:"string",isNullable:()=>!1,get(t){t.str[0]=this.paramName},set(t){this.paramName=t.str[0]}},{name:"sRGB",type:"bool",default:!0,get(t){t.bool[0]=this.sRGB},set(t){this.sRGB=t.bool[0]}},{name:"AddressU",type:"string",default:"clamp",options:{enum:{labels:["clamp","repeat","mirrored-repeat"],values:["clamp","repeat","mirrored-repeat"]}},isNullable:()=>!1,get(t){t.str[0]=this.addressU},set(t){this.addressU=t.str[0]}},{name:"AddressV",type:"string",default:"clamp",options:{enum:{labels:["clamp","repeat","mirrored-repeat"],values:["clamp","repeat","mirrored-repeat"]}},isNullable:()=>!1,get(t){t.str[0]=this.addressV},set(t){this.addressV=t.str[0]}},{name:"MinFilter",type:"string",default:"linear",options:{enum:{labels:["nearest","linear"],values:["nearest","linear"]}},isNullable:()=>!1,get(t){t.str[0]=this.filterMin},set(t){this.filterMin=t.str[0]}},{name:"MagFilter",type:"string",default:"linear",options:{enum:{labels:["nearest","linear"],values:["nearest","linear"]}},isNullable:()=>!1,get(t){t.str[0]=this.filterMag},set(t){this.filterMag=t.str[0]}},{name:"MipFilter",type:"string",default:"nearest",options:{enum:{labels:["nearest","linear","none"],values:["nearest","linear","none"]}},isNullable:()=>!1,get(t){t.str[0]=this.filterMip},set(t){this.filterMip=t.str[0]}}];class $d extends Cd{_paramName;sRGB;addressU;addressV;filterMin;filterMag;filterMip;textureId;constructor(){super(),this._paramName=Ad(),this.sRGB=!0,this.addressU="clamp",this.addressV="clamp",this.filterMin="linear",this.filterMag="linear",this.filterMip="nearest",this.textureId=""}get paramName(){return this._paramName}set paramName(t){t!==this._paramName&&(this._paramName=t,this.dispatchEvent("changed"))}get isUniform(){return!0}toString(){return this._paramName}validate(){return""}getType(){return""}}class Rd extends $d{constructor(){super(),this._outputs=[{id:1,name:""}]}static getSerializationCls(){return{ctor:Rd,name:"Texture2DNode",noTitle:!0,getProps:()=>[{name:"Texture",type:"object",default:null,options:{mimeTypes:["image/jpeg","image/png","image/tga","image/vnd.radiance","image/x-dds","image/webp"]},isNullable:()=>!0,get(t){t.str[0]=this.textureId},async set(t){this.textureId=t.str[0]??""}},...Pd]}}validate(){return""}getType(){return"tex2D"}}class Fd extends $d{constructor(){super(),this._outputs=[{id:1,name:""}]}static getSerializationCls(){return{ctor:Fd,name:"Texture2DArrayNode",noTitle:!0,getProps:()=>[{name:"Texture",type:"object",default:null,options:{mimeTypes:["image/x-dds"]},isNullable:()=>!0,get(t){t.str[0]=this.textureId},async set(t){this.textureId=t.str[0]??""}},...Pd]}}validate(){return""}getType(){return"tex2DArray"}}class Dd extends $d{constructor(){super(),this._inputs=[],this._outputs=[{id:1,name:""}]}static getSerializationCls(){return{ctor:Dd,name:"TextureCubeNode",noTitle:!0,getProps:()=>[{name:"Texture",type:"object",default:null,options:{mimeTypes:["image/x-dds"]},isNullable:()=>!0,get(t){t.str[0]=this.textureId},async set(t){this.textureId=t.str[0]??""}},...Pd]}}validate(){return""}getType(){return"texCube"}}class Nd extends Cd{samplerType;constructor(){super(),this.samplerType="Color",this._outputs=[{id:1,name:""}],this._inputs=[{id:1,name:"texture",type:["tex2D","tex2DArray","texCube"],required:!0},{id:2,name:"coord",type:["vec2","vec3"],required:!0}]}static getSerializationCls(){return{ctor:Nd,name:"TextureSampleNode",getProps:()=>[{name:"SamplerType",type:"string",options:{enum:{labels:["Color","Normal"],values:["Color","Normal"]}},get(t){t.str[0]=this.samplerType},set(t){this.samplerType=t.str[0]}}]}}toString(){return"textureSample"}validate(){const t=super.validate();if(t)return t;const e=this._inputs[0].inputNode.getOutputType(this._inputs[0].inputId);if(!e)return`Cannot determine type of argument \`${this._inputs[0].name}\``;if(!this._inputs[0].type.includes(e))return`Invalid input type of argument \`${this._inputs[0].name}\`: ${e}`;const i=this._inputs[1].inputNode.getOutputType(this._inputs[1].inputId);if(!i)return`Cannot determine type of argument \`${this._inputs[1].name}\``;const s="tex2D"===e?"vec2":"vec3";return i!==s?`Texture coordinate type should be ${s}`:""}getType(){return"vec4"}}class Ld extends Cd{constructor(){super(),this._inputs=[{id:1,name:"a",type:["float","vec2","vec3"],required:!0},{id:2,name:"b",type:["float","vec2","vec3"]},{id:3,name:"c",type:["float","vec2","vec3"]},{id:4,name:"d",type:["float","vec2","vec3"]}],this._outputs=[{id:1,name:""}]}toString(){return"MakeVector"}static getSerializationCls(){return{ctor:Ld,name:"MakeVectorNode",getProps:()=>[]}}validate(){const t=super.validate();if(t)return t;let e=this._inputs.length-1;for(;e>=0&&!this._inputs[e].inputNode;)e--;if(e<0)return"Missing arguments";let i=0;const s=[];for(let t=0;t<=e;t++){const e=this._inputs[t].name;if(!this._inputs[t].inputNode)return`Missing argument \`${e}\``;const r=this._inputs[t].inputNode.getOutputType(this._inputs[t].inputId);if(!r)return`Cannot determine type of argument \`${e}\``;if(!this._inputs[t].type.includes(r))return`Invalid input type ${r}`;s.push(r),i+="float"===r?1:"vec2"===r?2:"vec3"===r?3:0}return i<2||i>4?`Invalid type combination ${s.join(",")}`:""}getType(){let t=this._inputs.length-1;for(;t>=0&&!this._inputs[t].inputNode;)t--;if(t<0)return"";let e=0;for(let i=0;i<=t;i++){if(!this._inputs[i].inputNode)return"";const t=this._inputs[i].inputNode.getOutputType(this._inputs[i].inputId);if(!t)return"";e+="float"===t?1:"vec2"===t?2:"vec3"===t?3:0}return e<2||e>4?"":`vec${e}`}}class zd extends Cd{_swizzle;constructor(){super(),this._swizzle="",this._inputs=[{id:1,name:"",type:["float","vec2","vec3","vec4"],required:!0}],this._outputs=[{id:1,name:""}]}get swizzle(){return this._swizzle}set swizzle(t){this._swizzle=t}toString(){return"Swizzle"}static getSerializationCls(){return{ctor:zd,name:"SwizzleNode",getProps:()=>[{name:"Swizzle",type:"string",get(t){t.str[0]=this.swizzle},set(t){this.swizzle=t.str[0]}}]}}validate(){const t=super.validate();if(t)return t;if(!this._inputs[0].inputNode)return`Missing argument \`${name}\``;const e=this._inputs[0].inputNode.getOutputType(this._inputs[0].inputId);if(!e)return`Cannot determine type of argument \`${name}\``;if(!this._inputs[0].type.includes(e))return`Invalid input type ${e}`;let i;return i="float"===e?1:"vec2"===e?2:"vec3"===e?3:4,0===this._swizzle.length||this._swizzle.length>4||[...this._swizzle].some(t=>"xyzw".slice(0,i).indexOf(t)<0)&&[...this._swizzle].some(t=>"rgba".slice(0,i).indexOf(t)<0)?`Invalid swizzle pattern: ${this._swizzle}`:""}getType(){if(super.validate())return"";if(!this._inputs[0].inputNode)return"";const t=this._inputs[0].inputNode.getOutputType(this._inputs[0].inputId);if(!t)return"";if(!this._inputs[0].type.includes(t))return"";let e;return e="float"===t?1:"vec2"===t?2:"vec3"===t?3:4,0===this._swizzle.length||this._swizzle.length>4||[...this._swizzle].some(t=>"xyzw".slice(0,e).indexOf(t)<0)&&[...this._swizzle].some(t=>"rgba".slice(0,e).indexOf(t)<0)?"":1===this._swizzle.length?"float":`vec${this._swizzle.length}`}}class Vd extends Cd{constructor(){super(),this._inputs=[{id:1,name:"a",type:["vec2","vec3","vec4","mat2","mat3","mat4"],required:!0},{id:2,name:"b",type:["vec2","vec3","vec4","mat2","mat3","mat4"]}],this._outputs=[{id:1,name:""}]}toString(){return"Transform"}static getSerializationCls(){return{ctor:Vd,name:"TransformNode",getProps:()=>[]}}validate(){const t=super.validate();if(t)return t;const e=[];for(let t=0;t<2;t++){const i=this._inputs[t].name;if(!this._inputs[t].inputNode)return`Missing argument \`${i}\``;const s=this._inputs[t].inputNode.getOutputType(this._inputs[t].inputId);if(!s)return`Cannot determine type of argument \`${i}\``;if(!this._inputs[t].type.includes(s))return`Invalid input type ${s}`;e.push(s)}return"vec2"===e[0]&&"mat2"===e[1]||"vec3"===e[0]&&"mat3"===e[1]||"vec4"===e[0]&&"mat4"===e[1]?"":("mat2"!==e[0]||"mat2"!==e[1]&&"vec2"!==e[1])&&("mat3"!==e[0]||"mat3"!==e[1]&&"vec3"!==e[1])&&("mat4"!==e[0]||"mat4"!==e[1]&&"vec4"!==e[1])?"Invalid argument types of transformation":""}getType(){if(super.validate())return"";const t=[];for(let e=0;e<2;e++){if(!this._inputs[e].inputNode)return"";const i=this._inputs[e].inputNode.getOutputType(this._inputs[e].inputId);if(!i)return"";if(!this._inputs[e].type.includes(i))return"";t.push(i)}return"vec2"===t[0]&&"mat2"===t[1]?"vec2":"vec3"===t[0]&&"mat3"===t[1]?"vec3":"vec4"===t[0]&&"mat4"===t[1]?"vec4":"mat2"!==t[0]||"mat2"!==t[1]&&"vec2"!==t[1]?"mat3"!==t[0]||"mat3"!==t[1]&&"vec3"!==t[1]?"mat4"!==t[0]||"mat4"!==t[1]&&"vec4"!==t[1]?"":"mat4"===t[1]?"mat4":"vec4":"mat3"===t[1]?"mat3":"vec3":"mat2"===t[1]?"mat2":"vec2"}}class Od extends Cd{func;outType;explicitInTypes;additionalInTypes;constructor(t,e,i,s,r,a,n){super(),this.func=t,this.outType=i??"",this.explicitInTypes=r??null,this.additionalInTypes=a??null,s=s??["float","vec2","vec3","vec4"],this._inputs=Array.from({length:e}).map((t,e)=>({id:e+1,name:"abcdefghijklmn"[e],type:this.explicitInTypes?.[e+1]??[...new Set([...s,...this.additionalInTypes?.[e+1]??[]])],required:!0,originType:n?.[e]})),this._outputs=[{id:1,name:""}]}toString(){return this.func}validate(){const t=super.validate();if(t)return t;let e="";for(let t=0;t<this._inputs.length;t++){const i="abcdefghijklmn"[t],s=this._inputs[t].inputNode.getOutputType(this._inputs[t].inputId);if(!s)return`Cannot determine type of argument \`${i}\``;if(!this._inputs[t].type.includes(s))return`Invalid input type ${s}`;if(!(this.explicitInTypes&&this.explicitInTypes[this._inputs[t].id]||this.additionalInTypes&&this.additionalInTypes[this._inputs[t].id]?.includes(s))){if(e&&s!==e)return"Invalid Arguments types";e=s}}return""}getType(){if(this.outType)return this.outType;let t="";for(let e=0;e<this._inputs.length;e++){if(!this._inputs[e].inputNode)return"";const i=this._inputs[e].inputNode.getOutputType(this._inputs[e].inputId);if(!i)return"";if(!(this.explicitInTypes&&this.explicitInTypes[this._inputs[e].id]||this.additionalInTypes&&this.additionalInTypes[this._inputs[e].id]?.includes(i))){if(t&&i!==t)return"Invalid Arguments types";t=i}}return t}}class kd extends Od{constructor(){super("degrees2radians",1)}static getSerializationCls(){return{ctor:kd,name:"Degrees2RadiansNode",getProps:()=>[]}}}class Ud extends Od{constructor(){super("radians2degrees",1)}static getSerializationCls(){return{ctor:Ud,name:"Radians2DegreesNode",getProps:()=>[]}}}class Gd extends Od{constructor(){super("sin",1)}static getSerializationCls(){return{ctor:Gd,name:"SinNode",getProps:()=>[]}}}class Hd extends Od{constructor(){super("cos",1)}static getSerializationCls(){return{ctor:Hd,name:"CosNode",getProps:()=>[]}}}class Wd extends Od{constructor(){super("tan",1)}static getSerializationCls(){return{ctor:Wd,name:"TanNode",getProps:()=>[]}}}class Xd extends Od{constructor(){super("asin",1)}static getSerializationCls(){return{ctor:Xd,name:"ArcSinNode",getProps:()=>[]}}}class jd extends Od{constructor(){super("acos",1)}static getSerializationCls(){return{ctor:jd,name:"ArcCosNode",getProps:()=>[]}}}class Qd extends Od{constructor(){super("atan",1)}static getSerializationCls(){return{ctor:Qd,name:"ArcTanNode",getProps:()=>[]}}}class qd extends Od{constructor(){super("atan2",2)}static getSerializationCls(){return{ctor:qd,name:"ArcTan2Node",getProps:()=>[]}}}class Yd extends Od{constructor(){super("sinh",1)}static getSerializationCls(){return{ctor:Yd,name:"SinHNode",getProps:()=>[]}}}class Zd extends Od{constructor(){super("cosh",1)}static getSerializationCls(){return{ctor:Zd,name:"CosHNode",getProps:()=>[]}}}class Kd extends Od{constructor(){super("tanh",1)}static getSerializationCls(){return{ctor:Kd,name:"TanHNode",getProps:()=>[]}}}class Jd extends Od{constructor(){super("asinh",1)}static getSerializationCls(){return{ctor:Jd,name:"ArcsineHNode",getProps:()=>[]}}}class tp extends Od{constructor(){super("acosh",1)}static getSerializationCls(){return{ctor:tp,name:"ArccosineHNode",getProps:()=>[]}}}class ep extends Od{constructor(){super("atanh",1)}static getSerializationCls(){return{ctor:ep,name:"ArctangentHNode",getProps:()=>[]}}}class ip extends Od{constructor(){super("exp",1)}static getSerializationCls(){return{ctor:ip,name:"ExpNode",getProps:()=>[]}}}class sp extends Od{constructor(){super("exp2",1)}static getSerializationCls(){return{ctor:sp,name:"Exp2Node",getProps:()=>[]}}}class rp extends Od{constructor(){super("log",1)}static getSerializationCls(){return{ctor:rp,name:"LogNode",getProps:()=>[]}}}class ap extends Od{constructor(){super("log2",1)}static getSerializationCls(){return{ctor:ap,name:"Log2Node",getProps:()=>[]}}}class np extends Od{constructor(){super("sqrt",1)}static getSerializationCls(){return{ctor:np,name:"SqrtNode",getProps:()=>[]}}}class op extends Od{constructor(){super("inverseSqrt",1)}static getSerializationCls(){return{ctor:op,name:"InvSqrtNode",getProps:()=>[]}}}class hp extends Od{constructor(){super("abs",1)}static getSerializationCls(){return{ctor:hp,name:"AbsNode",getProps:()=>[]}}}class lp extends Od{constructor(){super("sign",1)}static getSerializationCls(){return{ctor:lp,name:"SignNode",getProps:()=>[]}}}class up extends Od{constructor(){super("floor",1)}static getSerializationCls(){return{ctor:up,name:"FloorNode",getProps:()=>[]}}}class cp extends Od{constructor(){super("ceil",1)}static getSerializationCls(){return{ctor:cp,name:"CeilNode",getProps:()=>[]}}}class dp extends Od{constructor(){super("fract",1)}static getSerializationCls(){return{ctor:dp,name:"FractNode",getProps:()=>[]}}}class pp extends Od{constructor(){super("dpdx",1)}static getSerializationCls(){return{ctor:pp,name:"DDXNode",getProps:()=>[]}}}class mp extends Od{constructor(){super("dpdy",1)}static getSerializationCls(){return{ctor:mp,name:"DDYNode",getProps:()=>[]}}}class fp extends Od{constructor(){super("fwidth",1)}static getSerializationCls(){return{ctor:fp,name:"FWidthNode",getProps:()=>[]}}}class _p extends Od{constructor(){super("add",2)}static getSerializationCls(){return{ctor:_p,name:"CompAddNode",getProps:()=>[]}}}class gp extends Od{constructor(){super("sub",2)}static getSerializationCls(){return{ctor:gp,name:"CompSubNode",getProps:()=>[]}}}class xp extends Od{constructor(){super("mul",2,null,null,null,{1:["float"],2:["float"]})}static getSerializationCls(){return{ctor:xp,name:"CompMulNode",getProps:()=>[]}}getType(){const t=this.inputs[0].inputNode?this.inputs[0].inputNode.getOutputType(this.inputs[0].inputId):"",e=this.inputs[1].inputNode?this.inputs[1].inputNode.getOutputType(this.inputs[1].inputId):"";return t&&e?"float"===t?e:t:""}}class bp extends Od{constructor(){super("div",2)}static getSerializationCls(){return{ctor:bp,name:"CompDivNode",getProps:()=>[]}}}class vp extends Od{constructor(){super("mod",2)}static getSerializationCls(){return{ctor:vp,name:"ModNode",getProps:()=>[]}}}class yp extends Od{constructor(){super("min",2)}static getSerializationCls(){return{ctor:yp,name:"MinNode",getProps:()=>[]}}}class Tp extends Od{constructor(){super("max",2)}static getSerializationCls(){return{ctor:Tp,name:"MaxNode",getProps:()=>[]}}}class wp extends Od{constructor(){super("pow",2)}static getSerializationCls(){return{ctor:wp,name:"PowNode",getProps:()=>[]}}}class Sp extends Od{constructor(){super("step",2)}static getSerializationCls(){return{ctor:Sp,name:"StepNode",getProps:()=>[]}}}class Ap extends Od{constructor(){super("fma",3)}static getSerializationCls(){return{ctor:Ap,name:"FmaNode",getProps:()=>[]}}}class Cp extends Od{constructor(){super("clamp",3)}static getSerializationCls(){return{ctor:Cp,name:"ClampNode",getProps:()=>[]}}}class Ep extends Od{constructor(){super("saturate",1)}static getSerializationCls(){return{ctor:Ep,name:"SaturateNode",getProps:()=>[]}}}class Mp extends Od{constructor(){super("mix",3,null,null,null,{3:["float"]})}static getSerializationCls(){return{ctor:Mp,name:"MixNode",getProps:()=>[]}}}class Bp extends Od{constructor(){super("normalize",1,null,["vec2","vec3","vec4"])}static getSerializationCls(){return{ctor:Bp,name:"NormalizeNode",getProps:()=>[]}}}class Ip extends Od{constructor(){super("faceForward",3,null,["vec2","vec3"])}static getSerializationCls(){return{ctor:Ip,name:"FaceForwardNode",getProps:()=>[]}}}class Pp extends Od{constructor(){super("reflect",2,null,["vec2","vec3"])}static getSerializationCls(){return{ctor:Pp,name:"ReflectNode",getProps:()=>[]}}}class $p extends Od{constructor(){super("refract",3,null,["vec2","vec3"],{3:["float"]})}static getSerializationCls(){return{ctor:$p,name:"RefractNode",getProps:()=>[]}}}class Rp extends Od{constructor(){super("length",1,"float")}static getSerializationCls(){return{ctor:Rp,name:"LengthNode",getProps:()=>[]}}}class Fp extends Od{constructor(){super("distance",2,"float")}static getSerializationCls(){return{ctor:Fp,name:"DistanceNode",getProps:()=>[]}}}class Dp extends Od{constructor(){super("dot",2,"float",["vec2","vec3","vec4"])}static getSerializationCls(){return{ctor:Dp,name:"DotProductNode",getProps:()=>[]}}}class Np extends Od{constructor(){super("cross",2,null,["vec3"])}static getSerializationCls(){return{ctor:Np,name:"CrossProductNode",getProps:()=>[]}}}class Lp extends Od{constructor(){super("Z_simplexNoise2D",2,"float",null,{1:["vec2"],2:["float"]})}static getSerializationCls(){return{ctor:Lp,name:"SimplexNoise2DNode",getProps:()=>[]}}}class zp extends Od{constructor(){super("Z_perlinNoise2D",2,"float",null,{1:["vec2"],2:["float"]})}static getSerializationCls(){return{ctor:zp,name:"PerlinNoise2DNode",getProps:()=>[]}}}class Vp extends Od{constructor(){super("Z_hash1",1,"float",null,{1:["float","vec2","vec3"]})}static getSerializationCls(){return{ctor:Vp,name:"Hash1Node",getProps:()=>[]}}}class Op extends Od{constructor(){super("Z_hash2",1,"vec2",null,{1:["float","vec2","vec3"]})}static getSerializationCls(){return{ctor:Op,name:"Hash2Node",getProps:()=>[]}}}class kp extends Od{constructor(){super("Z_hash3",1,"vec3",null,{1:["float","vec2","vec3"]})}static getSerializationCls(){return{ctor:kp,name:"Hash3Node",getProps:()=>[]}}}class Up extends Cd{constructor(){super(),this._outputs=[{id:1,name:""},{id:2,name:"r",swizzle:"x"},{id:3,name:"g",swizzle:"y"},{id:4,name:"b",swizzle:"z"},{id:5,name:"a",swizzle:"w"}]}static getSerializationCls(){return{ctor:Up,name:"VertexColorNode",getProps:()=>[]}}toString(){return"vertex color"}validate(){return""}getType(t){return t>1?"float":"vec4"}}class Gp extends Cd{constructor(){super(),this._outputs=[{id:1,name:""},{id:2,name:"x",swizzle:"x"},{id:3,name:"y",swizzle:"y"}]}static getSerializationCls(){return{ctor:Gp,name:"VertexUVNode",getProps:()=>[]}}toString(){return"vertex UV"}validate(){return""}getType(t){return t>1?"float":"vec2"}}class Hp extends Cd{constructor(){super(),this._outputs=[{id:1,name:""},{id:2,name:"x",swizzle:"x"},{id:3,name:"y",swizzle:"y"},{id:4,name:"z",swizzle:"z"}]}toString(){return"world position"}static getSerializationCls(){return{ctor:Hp,name:"VertexPositionNode",getProps:()=>[]}}validate(){return""}getType(t){return t>1?"float":"vec3"}}class Wp extends Cd{constructor(){super(),this._outputs=[{id:1,name:""},{id:2,name:"x",swizzle:"x"},{id:3,name:"y",swizzle:"y"},{id:4,name:"z",swizzle:"z"}]}toString(){return"vertex normal"}static getSerializationCls(){return{ctor:Wp,name:"VertexNormalNode",getProps:()=>[]}}validate(){return""}getType(t){return t>1?"float":"vec3"}}class Xp extends Cd{constructor(){super(),this._outputs=[{id:1,name:""},{id:2,name:"x",swizzle:"x"},{id:3,name:"y",swizzle:"y"},{id:4,name:"z",swizzle:"z"}]}toString(){return"vertex tangent"}static getSerializationCls(){return{ctor:Xp,name:"VertexTangentNode",getProps:()=>[]}}validate(){return""}getType(t){return t>1?"float":"vec3"}}class jp extends Cd{constructor(){super(),this._outputs=[{id:1,name:""},{id:2,name:"x",swizzle:"x"},{id:3,name:"y",swizzle:"y"},{id:4,name:"z",swizzle:"z"}]}toString(){return"vertex binormal"}static getSerializationCls(){return{ctor:jp,name:"VertexBinormalNode",getProps:()=>[]}}validate(){return""}getType(t){return t>1?"float":"vec3"}}class Qp extends Cd{constructor(){super(),this._outputs=[{id:1,name:""}]}toString(){return"ViewToClipMatrix"}static getSerializationCls(){return{ctor:Qp,name:"ProjectionMatrixNode",getProps:()=>[]}}validate(){return""}getType(){return"mat4"}}class qp extends Cd{constructor(){super(),this._outputs=[{id:1,name:""}]}toString(){return"WorldToViewMatrix"}static getSerializationCls(){return{ctor:qp,name:"ViewMatrixNode",getProps:()=>[]}}validate(){return""}getType(){return"mat4"}}class Yp extends Cd{constructor(){super(),this._outputs=[{id:1,name:""}]}toString(){return"WorldToClipMatrix"}static getSerializationCls(){return{ctor:Yp,name:"ViewProjMatrixNode",getProps:()=>[]}}validate(){return""}getType(){return"mat4"}}class Zp extends Cd{constructor(){super(),this._outputs=[{id:1,name:""}]}toString(){return"ClipToViewMatrix"}static getSerializationCls(){return{ctor:Zp,name:"InvProjMatrixNode",getProps:()=>[]}}validate(){return""}getType(){return"mat4"}}class Kp extends Cd{constructor(){super(),this._outputs=[{id:1,name:""}]}toString(){return"ClipToWorldMatrix"}static getSerializationCls(){return{ctor:Kp,name:"InvViewProjMatrixNode",getProps:()=>[]}}validate(){return""}getType(){return"mat4"}}class Jp extends Cd{constructor(){super(),this._outputs=[{id:1,name:""}]}toString(){return"BillboardMatrix"}static getSerializationCls(){return{ctor:Jp,name:"BillboardMatrixNode",getProps:()=>[]}}validate(){return""}getType(){return"mat3"}}class tm extends Cd{constructor(){super(),this._outputs=[{id:1,name:""}]}toString(){return"Elapsed time"}static getSerializationCls(){return{ctor:tm,name:"ElapsedTimeNode",getProps:()=>[]}}validate(){return""}getType(){return"float"}}class em extends Cd{constructor(){super(),this._outputs=[{id:1,name:""},{id:2,name:"x",swizzle:"x"},{id:3,name:"y",swizzle:"y"},{id:4,name:"z",swizzle:"z"}]}toString(){return"camera position"}static getSerializationCls(){return{ctor:em,name:"CameraPositionNode",getProps:()=>[]}}validate(){return""}getType(t){return t>1?"float":"vec3"}}class im extends Cd{constructor(){super(),this._outputs=[{id:1,name:""}]}toString(){return"SkyEnvTexture"}static getSerializationCls(){return{ctor:im,name:"SkyEnvTextureNode",getProps:()=>[]}}validate(){return""}getType(){return"texCube"}}class sm extends Cd{constructor(){super(),this._outputs=[{id:1,name:""},{id:2,name:"near",swizzle:"x"},{id:3,name:"far",swizzle:"y"}]}toString(){return"camera near far"}static getSerializationCls(){return{ctor:sm,name:"CameraNearFarNode",getProps:()=>[]}}validate(){return""}getType(t){return t>1?"float":"vec2"}}class rm extends Cd{constructor(){super(),this._outputs=[{id:1,name:""}]}toString(){return"vertex position resolved"}static getSerializationCls(){return{ctor:rm,name:"ResolveVertexPositionNode",getProps:()=>[]}}validate(){return""}getType(){return"vec3"}}class am extends Cd{constructor(){super(),this._outputs=[{id:1,name:""}]}toString(){return"vertex normal resolved"}static getSerializationCls(){return{ctor:am,name:"ResolveVertexNormalNode",getProps:()=>[]}}validate(){return""}getType(){return"vec3"}}class nm extends Cd{constructor(){super(),this._outputs=[{id:1,name:""}]}toString(){return"vertex tangent resolved"}static getSerializationCls(){return{ctor:nm,name:"ResolveVertexTangentNode",getProps:()=>[]}}validate(){return""}getType(){return"vec4"}}class om extends Cd{_name;_path;_IR;_args;_outs;constructor(t,e,i){super(),this._path=t,this._name=e,this._IR=i,this._args=[],this._outs=[],this._inputs=[],this._outputs=[];for(const t of Object.keys(this._IR.DAG.nodeMap)){const e=this._IR.DAG.nodeMap[t];if(e instanceof hm){const i=e.name||`arg_${t}`;this._args.push({index:Number(t),name:i,type:e.type}),this._inputs.push({id:this._inputs.length+1,name:i,type:[e.type]})}else if(e instanceof lm){const i=e.name||`out_${t}`;this._outs.push({index:Number(t),name:i,type:e.type}),this._outputs.push({id:this._outputs.length+1,name:i,swizzle:i})}}}get path(){return this._path}get name(){return this._name}get IR(){return this._IR}get args(){return this._args}get outs(){return this._outs}static getSerializationCls(t){return{ctor:om,name:"FunctionCallNode",async createFunc(e,i){const s=await t.loadBluePrint(i),r=t.VFS.basename(i,t.VFS.extname(i));return{obj:new om(i,r,s.func)}},getInitParams:t=>t.path,getProps:()=>[]}}toString(){return this._name}validate(){for(let t=0;t<this._inputs.length;t++){const e=this._inputs[t].name;if(!this._inputs[t].inputNode)return`Missing argument \`${e}\``;const i=this._inputs[t].inputNode.getOutputType(this._inputs[t].inputId);if(!i)return`Cannot determine type of argument \`${e}\``;if(!this._inputs[t].type.includes(i))return`Invalid input type ${i}`}return""}getType(t){return this._outs[t-1].type}}class hm extends Cd{static argId=1;_type;constructor(){super(),this._type="vec4",this._outputs=[{id:1,name:"arg_"+hm.argId++}]}get type(){return this._type}get name(){return this._outputs[0].name}set name(t){t&&(this._outputs[0].name=t)}static getSerializationCls(){return{ctor:hm,name:"FunctionInputNode",getProps:()=>[{name:"type",type:"string",options:{enum:{labels:["float","vec2","vec3","vec4","mat2","mat3","mat4"],values:["float","vec2","vec3","vec4","mat2","mat3","mat4"]}},get(t){t.str[0]=this._type},set(t){this._type=t.str[0]}},{name:"name",type:"string",get(t){t.str[0]=this.name},set(t){this.name=t.str[0]}}]}}toString(){return"FunctionInput"}validate(){return""}getType(){return this._type}}class lm extends Cd{static outId=1;constructor(){super(),this._inputs=[{id:1,name:"out_"+lm.outId++,type:["float","vec2","vec3","vec4","mat2","mat3","mat4"]}]}get name(){return this._inputs[0].name}set name(t){t&&(this._inputs[0].name=t)}get type(){return this.getType()}static getSerializationCls(){return{ctor:lm,name:"FunctionOutputNode",getProps:()=>[{name:"name",type:"string",get(t){t.str[0]=this.name},set(t){this.name=t.str[0]}}]}}toString(){return"FunctionOutput"}validate(){if(!this._inputs[0].inputNode)return"Missing result";return this._inputs[0].inputNode.getOutputType(this._inputs[0].inputId)?"":"Cannot determin result type"}getType(){return this._inputs[0].inputNode?this._inputs[0].inputNode.getOutputType(this._inputs[0].inputId):""}}function um(t,e){const i=t.$builder,s="Z_whiteNoise";return i.func(s,[i.vec2("p")],function(){this.$return(i.fract(i.mul(i.sin(i.dot(this.p,i.vec2(12.9898,78.233))),43758.5453)))}),t[s](e)}function cm(t,e){const i=t.$builder,s="Z_valueNoise";return i.func(s,[i.vec2("p")],function(){this.$l.i=i.floor(this.p),this.$l.f=i.fract(this.p),this.f=i.mul(this.f,this.f,i.sub(i.vec2(3),i.mul(this.f,2))),this.$l.c0=this.i,this.$l.c1=i.add(this.i,i.vec2(1,0)),this.$l.c2=i.add(this.i,i.vec2(0,1)),this.$l.c3=i.add(this.i,i.vec2(1)),this.$l.r0=um(this,this.c0),this.$l.r1=um(this,this.c1),this.$l.r2=um(this,this.c2),this.$l.r3=um(this,this.c3),this.$return(i.mix(i.mix(this.r0,this.r1,this.f.x),i.mix(this.r2,this.r3,this.f.x),this.f.y))}),t[s](e)}function dm(t,e){const i=t.$builder,s="Z_noise3d";return i.func(s,[i.vec3("p")],function(){this.$l.p3=i.fract(i.mul(this.p,.1031)),this.$l.p3=i.add(this.p3,i.vec3(i.dot(this.p3,i.add(this.p3.yzx,i.vec3(33.33))))),this.$return(i.fract(i.mul(i.add(this.p3.x,this.p3.y),this.p3.z)))}),i.getGlobalScope()[s](e)}function pm(t,e){const i=t.$builder,s="Z_smoothNoise3D";return i.func(s,[i.vec3("p")],function(){this.$l.cell=i.floor(this.p),this.$l.local=i.fract(this.p),this.$l.local=i.mul(this.local,i.mul(this.local,i.sub(i.vec3(3),i.mul(this.local,2)))),this.$l.ldb=dm(this,this.cell),this.$l.rdb=dm(this,i.add(this.cell,i.vec3(1,0,0))),this.$l.ldf=dm(this,i.add(this.cell,i.vec3(0,0,1))),this.$l.rdf=dm(this,i.add(this.cell,i.vec3(1,0,1))),this.$l.lub=dm(this,i.add(this.cell,i.vec3(0,1,0))),this.$l.rub=dm(this,i.add(this.cell,i.vec3(1,1,0))),this.$l.luf=dm(this,i.add(this.cell,i.vec3(0,1,1))),this.$l.ruf=dm(this,i.add(this.cell,i.vec3(1,1,1))),this.$return(i.mix(i.mix(i.mix(this.ldb,this.rdb,this.local.x),i.mix(this.ldf,this.rdf,this.local.x),this.local.z),i.mix(i.mix(this.lub,this.rub,this.local.x),i.mix(this.luf,this.ruf,this.local.x),this.local.z),this.local.y))}),i.getGlobalScope()[s](e)}class mm extends Cd{constructor(){super(),this._inputs=[{id:1,name:"BaseColor",type:["float","vec2","vec3","vec4"],defaultValue:[1,1,1,1],originType:"vec4"},{id:2,name:"Metallic",type:["float"],defaultValue:1,originType:"float"},{id:3,name:"Roughness",type:["float"],defaultValue:1,originType:"float"},{id:4,name:"Specular",type:["float","vec2","vec3","vec4"],defaultValue:[1,1,1],originType:"vec3"},{id:5,name:"Emissive",type:["float","vec2","vec3","vec4"],defaultValue:[0,0,0],originType:"vec3"},{id:6,name:"Normal",type:["vec3","vec4"],originType:"vec3"},{id:7,name:"Tangent",type:["vec3"],originType:"vec3"},{id:8,name:"Opacity",type:["float"],defaultValue:1,originType:"float"}]}static getSerializationCls(){return{ctor:mm,name:"PBRBlockNode",getProps:()=>[]}}toString(){return"Output"}validate(){return""}getType(){return""}}class fm extends Cd{constructor(){super(),this._inputs=[{id:1,name:"Position",type:["vec3"],originType:"vec3"},{id:2,name:"Normal",type:["vec3"],originType:"vec3"},{id:3,name:"Tangent",type:["vec4"],originType:"vec4"},{id:4,name:"Color",type:["vec4"],defaultValue:[1,1,1,1],originType:"vec4"},{id:5,name:"UV",type:["vec2"],originType:"vec2"}]}static getSerializationCls(){return{ctor:fm,name:"VertexBlockNode",getProps:()=>[]}}toString(){return"VertexOutput"}validate(){return""}getType(){return""}}class _m{_ref;_outputs;constructor(){this._ref=0,this._outputs=[]}get outputs(){return this._outputs}addRef(){return this._ref++,this}getTmpName(t){let e=0;for(;;){const i="tmp"+e++;if(!t[i])return i}}asUniformValue(t){return null}asUniformTexture(t){return null}reset(){}}class gm extends _m{value;name;constructor(t,e){super(),this.value=t,this.name=e}create(t){return this.name?(t.getGlobalScope()[this.name]||(t.getGlobalScope()[this.name]=t.float().uniform(2)),t.getGlobalScope()[this.name]):this.value}asUniformValue(){return this.name?{name:this.name,value:[this.value],type:"float"}:null}}class xm extends _m{value;name;type;constructor(t,e,i){super(),this.value=t,this.name=e,this.type=i}create(t){return this.name?(t.getGlobalScope()[this.name]||(t.getGlobalScope()[this.name]=t[`vec${this.value.length}`]().uniform(2)),t.getGlobalScope()[this.name]):Array.isArray(this.value)?t[`vec${this.value.length}`](...this.value):this.value}asUniformValue(){return this.name?{name:this.name,type:this.type,value:this.value}:null}}class bm extends _m{func;constructor(t){super(),this.func=t}create(t){return"string"==typeof this.func?t.getCurrentScope()[this.func]:this.func(t.getCurrentScope())}}class vm extends _m{params;func;tmpName;constructor(t,e){super(),this.params=t.map(t=>t instanceof _m?t.addRef():t),this.func=e,this.tmpName=""}reset(){this.tmpName=""}create(t){if(this.tmpName){const i=t.getCurrentScope()[this.tmpName];return e(i,"expression not exists"),i}const i=this.params.map(e=>e instanceof _m?e.create(t):e),s="string"==typeof this.func?t[this.func](...i):this.func(t,...i);return 1===this._ref?s:(this.tmpName=this.getTmpName(t.getCurrentScope()),t.getCurrentScope()[this.tmpName]=s,t.getCurrentScope()[this.tmpName])}}class ym extends _m{tmpName;input;constructor(t){super(),this.input=t,this.tmpName=""}reset(){this.tmpName=""}create(t){if(this.tmpName)return t.getCurrentScope()[this.tmpName];const e=this.input instanceof _m?this.input.create(t):this.input;return 1===this._ref?e:(this.tmpName=this.getTmpName(t.getCurrentScope()),t.getCurrentScope()[this.tmpName]=e,t.getCurrentScope()[this.tmpName])}}class Tm extends _m{node;args;tmpName;constructor(t,e){super(),this.node=t,this.args=e,this.tmpName=""}reset(){this.tmpName=""}create(t){if(this.tmpName)return t.getCurrentScope()[this.tmpName];const e=this,i=this.node.IR,s=this.node.args.map(e=>t[e.type](e.name));t.func(this.node.name,s,function(){const s=i.create(t),r=t.defineStruct(e.node.outputs.map((i,s)=>t[e.node.outs[s].type](i.swizzle)));this.$return(r(...s.map(t=>t.exp)))});const r=this.args.map(e=>e.create(t)),a=t.getGlobalScope()[this.node.name](...r);return 1===this._ref?a:(this.tmpName=this.getTmpName(t.getCurrentScope()),t.getCurrentScope()[this.tmpName]=a,t.getCurrentScope()[this.tmpName])}}class wm extends _m{src;hash;constructor(t,e){super(),this.src=t.addRef(),this.hash=e}create(t){const e=this.src.create(t);return"number"==typeof e?t[`vec${this.hash.length}`](e):e[this.hash]}}class Sm extends _m{src;type;cast;constructor(t,e,i){super(),this.src=t.addRef(),this.cast=i,this.type=e}create(t){return t[this.type](this.src.create(t),...Array.from({length:this.cast}).fill(0))}}class Am extends _m{tex;coord;samplerType;tmpName;constructor(t,e,i){super(),this.tex=t.addRef(),this.coord=e.addRef(),this.samplerType=i,this.tmpName=""}reset(){this.tmpName=""}create(t){if(this.tmpName)return t.getCurrentScope()[this.tmpName];const e=this.tex.create(t),i=this.coord.create(t);let s;if(i instanceof Wa)s=i;else{if(!Array.isArray(i))throw new Error("Invalid texture coordinate");s=t[`vec${i.length}`](...i)}let r=t.textureSample(e,s);return"Normal"===this.samplerType&&(r=t.sub(t.mul(r,t.vec4(2,2,2,1)),t.vec4(1,1,1,0))),1===this._ref?r:(this.tmpName=this.getTmpName(t.getCurrentScope()),t.getCurrentScope()[this.tmpName]=r,t.getCurrentScope()[this.tmpName])}}class Cm extends _m{name;id;type;sRGB;addressU;addressV;filterMin;filterMag;filterMip;useParams;constructor(t,e,i,s,r,a,n,o,h){super(),this.name=t,this.id=e,this.type=i,this.sRGB=s,this.addressU=r,this.addressV=a,this.filterMin=n,this.filterMag=o,this.filterMip=h,this.useParams=!1}create(t){return t.getGlobalScope()[this.name]||(t.getGlobalScope()[this.name]=t[this.type]().uniform(2)),t.getGlobalScope()[this.name]}asUniformTexture(){return{name:this.name,texture:this.id,wrapS:this.addressU,wrapT:this.addressV,minFilter:this.filterMin,magFilter:this.filterMag,mipFilter:this.filterMip,type:this.type,sRGB:this.sRGB}}}class Em{_dag;_hash;_expressions;_expressionMap;_uniformValues;_uniformTextures;_behaviors;_outputs;constructor(t,e){this._dag=t??{nodeMap:{},roots:[],graph:{outgoing:{},incoming:{}},order:[]},this._hash=e,this.compile()}get ok(){return this._outputs?.length>0}get hash(){return this._hash}get behaviors(){return this._behaviors}get DAG(){return this._dag}set DAG(t){this._dag=t}get uniformValues(){return this._uniformValues}get uniformTextures(){return this._uniformTextures}compile(){this.reset(),this._outputs=[];for(const t of this._dag.roots){const e=this._dag.nodeMap[t];for(const t of e.inputs){const i=t.name;if(t.inputNode)this._outputs.push({name:i,expr:this.ir(t.inputNode,t.inputId,t.originType).addRef()});else if("number"==typeof t.defaultValue)this._outputs.push({name:i,expr:new gm(t.defaultValue,"").addRef()});else if(Array.isArray(t.defaultValue))this._outputs.push({name:i,expr:new xm(t.defaultValue,"",`vec${t.defaultValue.length}`).addRef()});else if(t.required)return this._outputs=null,!1;!t.inputNode&&e instanceof fm&&("Color"===t.name?this._behaviors.useVertexColor=!0:"UV"===t.name&&(this._behaviors.useVertexUV=!0))}}return!0}create(t){if(!this._outputs)return null;for(const t of this._expressions)t.reset();const e=[];for(const i of this._outputs)e.push({name:i.name,exp:i.expr.create(t)});return e}reset(){this._expressions=[],this._expressionMap=new Map,this._uniformTextures=[],this._uniformValues=[],this._outputs=null,this._behaviors={useVertexColor:!1,useVertexUV:!1}}ir(t,e,i){let s=null;if(t instanceof Ed?s=this.constantf(t,e):t instanceof Md||t instanceof Bd||t instanceof Id?s=this.constantfv(t,e):t instanceof $d?s=this.constantTexture(t,e):t instanceof Nd?s=this.textureSample(t,e):t instanceof Ld?s=this.makeVector(t,e):t instanceof zd?s=this.swizzle(t,e):t instanceof rm?s=this.resolveVertexPosition(t,e):t instanceof am?s=this.resolveVertexNormal(t,e):t instanceof nm?s=this.resolveVertexTangent(t,e):t instanceof Vp?s=this.hash1(t,e):t instanceof Op?s=this.hash2(t,e):t instanceof kp?s=this.hash3(t,e):t instanceof Lp?s=this.simplexNoise2d(t,e):t instanceof zp?s=this.perlinNoise2d(t,e):t instanceof Od?s=this.func(t,e):t instanceof Vd?s=this.transform(t,e):t instanceof Up?s=this.vertexColor(t,e):t instanceof Gp?s=this.vertexUV(t,e):t instanceof Hp?s=this.vertexPosition(t,e):t instanceof Wp?s=this.vertexNormal(t,e):t instanceof Xp?s=this.vertexTangent(t,e):t instanceof jp?s=this.vertexBinormal(t,e):t instanceof qp?s=this.viewMatrix(t,e):t instanceof Qp?s=this.projectionMatrix(t,e):t instanceof Yp?s=this.viewProjectionMatrix(t,e):t instanceof Zp?s=this.invProjectionMatrix(t,e):t instanceof Kp?s=this.invViewProjectionMatrix(t,e):t instanceof Jp?s=this.billboardMatrix(t,e):t instanceof em?s=this.cameraPosition(t,e):t instanceof sm?s=this.cameraNearFar(t,e):t instanceof im?s=this.skyEnvTexture(t,e):t instanceof tm?s=this.elapsedTime(t,e):t instanceof om?s=this.functionCall(t,e):t instanceof hm?s=this.functionInput(t,e):t instanceof lm&&(s=this.functionOutput(t,e)),s&&i){const r=t.getOutputType(e);if(i!==r){if("float"===i){if("vec2"!==r&&"vec3"!==r&&"vec4"!==r)throw new Error(`Cannot cast type \`${r}\` to \`${i}`);return new wm(s,"x")}if("float"===r){if("vec2"!==i&&"vec3"!==i&&"vec4"!==i)throw new Error(`Cannot cast type \`${r}\` to \`${i}`);return new Sm(s,i,0)}if("vec2"===r||"vec3"===r||"vec4"===r){const t=Number(r[r.length-1]),e=Number(i[i.length-1]);return t>e?new wm(s,"xyzw".slice(0,e)):new Sm(s,i,e-t)}throw new Error(`Cannot cast type \`${r}\` to \`${i}`)}}return s}getOrCreateIRExpression(t,e,i,...s){let r;if(this._expressionMap.has(t))r=this._expressions[this._expressionMap.get(t)];else{r=new i(...s),this._expressions.push(r),this._expressionMap.set(t,this._expressions.length-1);const e=r.asUniformValue(t);e&&this._uniformValues.push(e);const a=r.asUniformTexture(t);a&&this._uniformTextures.push(a)}if(!r.outputs[e]){const i=t.outputs.find(t=>t.id===e);r.outputs[e]=r,"number"==typeof i.cast&&(r.outputs[e]=new Sm(r,t.getOutputType(e),i.cast)),i.swizzle&&(r.outputs[e]=new wm(r.outputs[e],i.swizzle))}return r.outputs[e]}makeVector(t,e){const i=[];for(const e of t.inputs)e.inputNode&&i.push(this.ir(e.inputNode,e.inputId,e.originType));const s=t.getOutputType(e);return this.getOrCreateIRExpression(t,e,vm,i,s)}swizzle(t,e){return this.getOrCreateIRExpression(t,e,wm,this.ir(t.inputs[0].inputNode,t.inputs[0].inputId,t.inputs[0].originType),t.swizzle)}transform(t,e){const i=[];for(const e of t.inputs)e.inputNode&&i.push(this.ir(e.inputNode,e.inputId,e.originType));return this.getOrCreateIRExpression(t,e,vm,i,"mul")}func(t,e){const i=[];for(const e of t.inputs)e.inputNode&&i.push(this.ir(e.inputNode,e.inputId,e.originType));const s=t.func;return this.getOrCreateIRExpression(t,e,vm,i,s)}functionOutput(t,e){const i=this.ir(t.inputs[0].inputNode,t.inputs[0].inputId,t.inputs[0].originType);return this.getOrCreateIRExpression(t,e,ym,i)}vertexColor(t,e){return this._behaviors.useVertexColor=!0,this.getOrCreateIRExpression(t,e,bm,t=>t.$inputs.zVertexColor)}vertexUV(t,e){return this._behaviors.useVertexUV=!0,this.getOrCreateIRExpression(t,e,bm,t=>t.$inputs.zVertexUV)}vertexNormal(t,e){return this.getOrCreateIRExpression(t,e,bm,t=>"vertex"===t.$builder.getDevice().type?t.$getVertexAttrib("normal")??Qc.resolveVertexNormal(t):t.$inputs.zVertexNormal)}vertexTangent(t,e){return this.getOrCreateIRExpression(t,e,bm,t=>"vertex"===t.$builder.getDevice().type?t.$getVertexAttrib("tangent")??Qc.resolveVertexTangent(t):t.$inputs.zVertexTangent)}vertexBinormal(t,e){return this.getOrCreateIRExpression(t,e,bm,"zVertexBinormal")}vertexPosition(t,e){return this.getOrCreateIRExpression(t,e,bm,"zWorldPos")}viewMatrix(t,e){return this.getOrCreateIRExpression(t,e,bm,t=>Qc.getViewMatrix(t))}projectionMatrix(t,e){return this.getOrCreateIRExpression(t,e,bm,t=>Qc.getProjectionMatrix(t))}viewProjectionMatrix(t,e){return this.getOrCreateIRExpression(t,e,bm,t=>Qc.getViewProjectionMatrix(t))}invProjectionMatrix(t,e){return this.getOrCreateIRExpression(t,e,bm,t=>Qc.getInvProjectionMatrix(t))}invViewProjectionMatrix(t,e){return this.getOrCreateIRExpression(t,e,bm,t=>Qc.getInvViewProjectionMatrix(t))}cameraPosition(t,e){return this.getOrCreateIRExpression(t,e,bm,t=>Qc.getCameraPosition(t))}cameraNearFar(t,e){return this.getOrCreateIRExpression(t,e,bm,t=>Qc.getCameraParams(t).xy)}skyEnvTexture(t,e){return this.getOrCreateIRExpression(t,e,bm,t=>Qc.getBakedSkyTexture(t))}elapsedTime(t,e){return this.getOrCreateIRExpression(t,e,bm,t=>Qc.getElapsedTime(t))}functionInput(t,e){return this.getOrCreateIRExpression(t,e,bm,e=>e[t.name])}resolveVertexPosition(t,e){return this.getOrCreateIRExpression(t,e,vm,[],t=>Qc.resolveVertexPosition(t.getCurrentScope()))}resolveVertexNormal(t,e){return this.getOrCreateIRExpression(t,e,vm,[],t=>Qc.resolveVertexNormal(t.getCurrentScope()))}resolveVertexTangent(t,e){return this.getOrCreateIRExpression(t,e,vm,[],t=>Qc.resolveVertexTangent(t.getCurrentScope()))}billboardMatrix(t,e){return this.getOrCreateIRExpression(t,e,vm,[],t=>(t.func("Z_calcBillboardMatrix",[],function(){this.$l.objScale=t.vec3(t.length(Qc.getWorldMatrix(this)[0].xyz),t.length(Qc.getWorldMatrix(this)[1].xyz),t.length(Qc.getWorldMatrix(this)[2].xyz)),this.$l.rotation=t.mat3(t.div(Qc.getWorldMatrix(this)[0].xyz,this.objScale.x),t.div(Qc.getWorldMatrix(this)[1].xyz,this.objScale.y),t.div(Qc.getWorldMatrix(this)[2].xyz,this.objScale.z)),this.$l.cameraForward=t.normalize(Qc.getInvViewMatrix(this)[2].xyz),this.$l.cameraUp=t.normalize(Qc.getInvViewMatrix(this)[1].xyz),this.$l.cameraRight=t.normalize(Qc.getInvViewMatrix(this)[0].xyz),this.$l.objForward=t.normalize(t.div(t.mul(this.cameraForward,this.rotation),this.objScale)),this.$l.objUp=t.normalize(t.div(t.mul(this.cameraUp,this.rotation),this.objScale)),this.$l.objRight=t.normalize(t.div(t.mul(this.cameraRight,this.rotation),this.objScale)),this.$l.billboardMatrix=t.mat3(this.objRight.x,this.objUp.x,this.objForward.x,this.objRight.y,this.objUp.y,this.objForward.y,this.objRight.z,this.objUp.z,this.objForward.z),this.$return(t.transpose(this.billboardMatrix))}),t.getGlobalScope().Z_calcBillboardMatrix()))}hash1(t,i){const s=[],r=t.inputs[0];e(!!r.inputNode);const a=r.inputNode.getOutputType(r.inputId);return e("float"===a||"vec2"===a||"vec3"===a),s.push(this.ir(r.inputNode,r.inputId,r.originType)),this.getOrCreateIRExpression(t,i,vm,s,(t,...e)=>{const i=t.getCurrentScope(),s=e[0];return"float"===a?function(t,e){const i=t.$builder,s="Z_hash11";return i.func(s,[i.float("p")],function(){this.$l.x=i.fract(i.mul(this.p,.1031)),this.x=i.mul(this.x,i.add(this.x,33.33)),this.x=i.mul(this.x,i.add(this.x,this.x)),this.$return(i.fract(this.x))}),t[s](e)}(i,s):"vec2"===a?function(t,e){const i=t.$builder,s="Z_hash21";return i.func(s,[i.vec2("p")],function(){this.$l.p3=i.fract(i.mul(this.p.xyx,.1031)),this.p3=i.add(this.p3,i.dot(this.p3,i.add(this.p3.yzx,i.vec3(33.33)))),this.$return(i.fract(i.mul(i.add(this.p3.x,this.p3.y),this.p3.z)))}),t[s](e)}(i,s):function(t,e){const i=t.$builder,s="Z_hash31";return i.func(s,[i.vec3("p")],function(){this.$l.p3=i.fract(i.mul(this.p,.1031)),this.p3=i.add(this.p3,i.dot(this.p3,i.add(this.p3.zyx,i.vec3(31.32)))),this.$return(i.fract(i.mul(i.add(this.p3.x,this.p3.y),this.p3.z)))}),t[s](e)}(i,s)})}hash2(t,i){const s=[],r=t.inputs[0];e(!!r.inputNode);const a=r.inputNode.getOutputType(r.inputId);return e("float"===a||"vec2"===a||"vec3"===a),s.push(this.ir(r.inputNode,r.inputId,r.originType)),this.getOrCreateIRExpression(t,i,vm,s,(t,...e)=>{const i=t.getCurrentScope(),s=e[0];return"float"===a?function(t,e){const i=t.$builder,s="Z_hash12";return i.func(s,[i.float("p")],function(){this.$l.p3=i.fract(i.mul(i.vec3(.1031,.103,.0973),this.p)),this.p3=i.add(this.p3,i.dot(this.p3,i.add(this.p3.yzx,i.vec3(33.33)))),this.$return(i.fract(i.mul(i.add(this.p3.xx,this.p3.yz),this.p3.zy)))}),t[s](e)}(i,s):"vec2"===a?function(t,e){const i=t.$builder,s="Z_hash22";return i.func(s,[i.vec2("p")],function(){this.$l.p3=i.fract(i.mul(this.p.xyx,i.vec3(.1031,.103,.0973))),this.p3=i.add(this.p3,i.dot(this.p3,i.add(this.p3.yzx,i.vec3(33.33)))),this.$return(i.fract(i.mul(i.add(this.p3.xx,this.p3.yz),this.p3.zy)))}),t[s](e)}(i,s):function(t,e){const i=t.$builder,s="Z_hash32";return i.func(s,[i.vec3("p")],function(){this.$l.p3=i.fract(i.mul(this.p,i.vec3(.1031,.103,.0973))),this.p3=i.add(this.p3,i.dot(this.p3,i.add(this.p3.yzx,i.vec3(33.33)))),this.$return(i.fract(i.mul(i.add(this.p3.xx,this.p3.yz),this.p3.zy)))}),t[s](e)}(i,s)})}hash3(t,i){const s=[],r=t.inputs[0];e(!!r.inputNode);const a=r.inputNode.getOutputType(r.inputId);return e("float"===a||"vec2"===a||"vec3"===a),s.push(this.ir(r.inputNode,r.inputId,r.originType)),this.getOrCreateIRExpression(t,i,vm,s,(t,...e)=>{const i=t.getCurrentScope(),s=e[0];return"float"===a?function(t,e){const i=t.$builder,s="Z_hash13";return i.func(s,[i.float("p")],function(){this.$l.p3=i.fract(i.mul(i.vec3(.1031,.103,.0973),this.p)),this.p3=i.add(this.p3,i.dot(this.p3,i.add(this.p3.yzx,i.vec3(33.33)))),this.$return(i.fract(i.mul(i.add(this.p3.xxy,this.p3.yzz),this.p3.zyx)))}),t[s](e)}(i,s):"vec2"===a?function(t,e){const i=t.$builder,s="Z_hash23";return i.func(s,[i.vec2("p")],function(){this.$l.p3=i.fract(i.mul(i.vec3(.1031,.103,.0973),this.p.xyx)),this.p3=i.add(this.p3,i.dot(this.p3,i.add(this.p3.yzx,i.vec3(33.33)))),this.$return(i.fract(i.mul(i.add(this.p3.xxy,this.p3.yzz),this.p3.zyx)))}),t[s](e)}(i,s):function(t,e){const i=t.$builder,s="Z_hash33";return i.func(s,[i.vec3("p")],function(){this.$l.p3=i.fract(i.mul(i.vec3(.1031,.103,.0973),this.p)),this.p3=i.add(this.p3,i.dot(this.p3,i.add(this.p3.yzx,i.vec3(33.33)))),this.$return(i.fract(i.mul(i.add(this.p3.xxy,this.p3.yzz),this.p3.zyx)))}),t[s](e)}(i,s)})}simplexNoise2d(t,e){const i=[];for(const e of t.inputs)e.inputNode&&i.push(this.ir(e.inputNode,e.inputId,e.originType));return this.getOrCreateIRExpression(t,e,vm,i,(e,...i)=>(e.func(t.toString(),[e.vec2("uv"),e.float("scale")],function(){this.$l.t=e.float(0);let t=1,i=.125;this.t=e.add(this.t,e.mul(cm(this,e.mul(this.uv,this.scale,1/t)),i)),t*=2,i*=2,this.t=e.add(this.t,e.mul(cm(this,e.mul(this.uv,this.scale,1/t)),i)),t*=2,i*=2,this.t=e.add(this.t,e.mul(cm(this,e.mul(this.uv,this.scale,1/t)),i)),this.$return(this.t)}),e.getGlobalScope()[t.toString()](i[0],i[1])))}perlinNoise2d(t,e){const i=[];for(const e of t.inputs)e.inputNode&&i.push(this.ir(e.inputNode,e.inputId,e.originType));return this.getOrCreateIRExpression(t,e,vm,i,(e,...i)=>(e.func("Z_perlinNoise2dDir",[e.vec2("uv")],function(){this.$l.p=e.mod(this.uv,e.vec2(289)),this.$l.x=e.add(e.mod(e.mul(e.add(e.mul(this.p.x,34),1),this.p.x),289),this.p.y),this.x=e.mod(e.mul(e.add(e.mul(this.x,34),1),this.x),289),this.x=e.sub(e.mul(e.fract(e.div(this.x,41)),2),1),this.$return(e.normalize(e.vec2(e.sub(this.x,e.floor(e.add(this.x,.5))),e.sub(e.abs(this.x),.5))))}),e.func("Z_perlinNoise2dImpl",[e.vec2("uv")],function(){this.$l.i=e.floor(this.uv),this.$l.f=e.fract(this.uv),this.$l.r00=e.dot(this.Z_perlinNoise2dDir(this.i),this.f),this.$l.r01=e.dot(this.Z_perlinNoise2dDir(e.add(this.i,e.vec2(0,1))),e.sub(this.f,e.vec2(0,1))),this.$l.r10=e.dot(this.Z_perlinNoise2dDir(e.add(this.i,e.vec2(1,0))),e.sub(this.f,e.vec2(1,0))),this.$l.r11=e.dot(this.Z_perlinNoise2dDir(e.add(this.i,e.vec2(1,1))),e.sub(this.f,e.vec2(1,1))),this.f=e.mul(this.f,this.f,this.f,e.add(e.mul(this.f,e.sub(e.mul(this.f,6),e.vec2(15))),10)),this.$return(e.mix(e.mix(this.r00,this.r01,this.f.y),e.mix(this.r10,this.r11,this.f.y),this.f.x))}),e.func(t.toString(),[e.vec2("uv"),e.float("scale")],function(){this.$return(e.add(this.Z_perlinNoise2dImpl(e.mul(this.uv,this.scale)),.5))}),e.getGlobalScope()[t.toString()](i[0],i[1])))}functionCall(t,e){const i=t.inputs.map(t=>this.ir(t.inputNode,t.inputId,t.originType));return this.getOrCreateIRExpression(t,e,Tm,t,i)}constantf(t,e){return this.getOrCreateIRExpression(t,e,gm,t.x,t.paramName)}constantfv(t,e){const i=t instanceof Md?[t.x,t.y]:t instanceof Bd?[t.x,t.y,t.z]:[t.x,t.y,t.z,t.w];return this.getOrCreateIRExpression(t,e,xm,i,t.paramName,`vec${i.length}`)}constantTexture(t,e){return this.getOrCreateIRExpression(t,e,Cm,t.paramName,t.textureId,t.getOutputType(1),t.sRGB,t.addressU,t.addressV,t.filterMin,t.filterMag,t.filterMip)}textureSample(t,e){const i=this.ir(t.inputs[0].inputNode,t.inputs[0].inputId),s=this.ir(t.inputs[1].inputNode,t.inputs[1].inputId);return this.getOrCreateIRExpression(t,e,Am,i,s,t.samplerType)}}class Mm extends(Yc(ed,wd)){static FEATURE_VERTEX_COLOR=this.defineFeature();static FEATURE_VERTEX_UV=this.defineFeature();_irFrag;_irVertex;_uniformValues;_uniformTextures;constructor(t,e,i,s){super(),this._irFrag=t??new Em(null,""),this._irVertex=e??new Em(null,""),this._uniformValues=i,this._uniformTextures=s,this.useFeature(Mm.FEATURE_VERTEX_COLOR,this._irVertex.behaviors.useVertexColor),this.useFeature(Mm.FEATURE_VERTEX_UV,this._irVertex.behaviors.useVertexUV)}get fragmentIR(){return this._irFrag}set fragmentIR(t){t!==this._irFrag&&(this._irFrag=t,this.clearCache(),this.optionChanged(!0))}get vertexIR(){return this._irVertex}set vertexIR(t){t!==this._irVertex&&(this._irVertex=t,this.clearCache(),this.optionChanged(!0))}get uniformValues(){return this._uniformValues}set uniformValues(t){this._uniformValues=t,this.uniformChanged()}get uniformTextures(){return this._uniformTextures}set uniformTextures(t){if(t!==this._uniformTextures){const e=t.map(t=>({finalTexture:new wt(t.finalTexture.get()),finalSampler:t.finalSampler,name:t.name,params:t.params?.clone()??O.zero(),texture:t.texture,type:t.type,sRGB:t.sRGB,wrapS:t.wrapS,wrapT:t.wrapT,inFragmentShader:t.inFragmentShader,inVertexShader:t.inVertexShader,minFilter:t.minFilter,magFilter:t.magFilter,mipFilter:t.mipFilter}));for(const t of this._uniformTextures)t.finalTexture.dispose();this._uniformTextures=e,this.uniformChanged()}}clone(){const t=new Mm(this._irFrag,this._irVertex,this._uniformValues,this._uniformTextures);return t.copyFrom(this),t}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$inputs.zVertexPos=e.vec3().attrib("position"),t.$inputs.zVertexNormal=e.vec3().attrib("normal"),t.$inputs.zVertexTangent=e.vec4().attrib("tangent"),this.featureUsed(Mm.FEATURE_VERTEX_COLOR)&&(t.$inputs.zVertexColor=e.vec4().attrib("diffuse")),this.featureUsed(Mm.FEATURE_VERTEX_UV)&&(t.$inputs.zVertexUV=e.vec2().attrib("texCoord0"));for(const t of[...this._uniformValues,...this._uniformTextures])t.inVertexShader&&(e.getGlobalScope()[t.name]=e[t.type]().uniform(2));const i=this._irVertex.create(e);t.$l.oPos=this.getOutput(i,"Position")??Qc.resolveVertexPosition(t);const s=Qc.getWorldMatrix(t);t.$outputs.worldPos=e.mul(s,e.vec4(t.oPos,1)).xyz,t.$l.csPos=e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1)),Qc.setClipSpacePosition(t,t.csPos),t.$outputs.zVertexColor=this.getOutput(i,"Color")??(this.featureUsed(Mm.FEATURE_VERTEX_COLOR)?t.$inputs.zVertexColor:e.vec4(1)),t.$outputs.zVertexUV=this.getOutput(i,"UV")??(this.featureUsed(Mm.FEATURE_VERTEX_UV)?t.$inputs.zVertexUV:e.vec2(0)),t.$l.oNorm=this.getOutput(i,"Normal")??Qc.resolveVertexNormal(t),t.$outputs.zVertexNormal=e.mul(Qc.getNormalMatrix(t),e.vec4(t.oNorm,0)).xyz,t.$l.oTangent=this.getOutput(i,"Tangent")??Qc.resolveVertexTangent(t),t.$outputs.zVertexTangent=e.mul(Qc.getNormalMatrix(t),e.vec4(t.oTangent.xyz,0)).xyz,t.$outputs.zVertexBinormal=e.mul(e.cross(t.$outputs.zVertexNormal,t.$outputs.zVertexTangent),t.oTangent.w)}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;if(this.needFragmentColor()){for(const t of[...this._uniformValues,...this._uniformTextures])t.inFragmentShader&&(e.getGlobalScope()[t.name]=e[t.type]().uniform(2));t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),t.$l.commonData=this.getCommonDatasStruct(t)(),this.getCommonData(t,t.commonData,t.viewVec,t.$inputs.worldPos,t.$inputs.zVertexNormal,t.$inputs.zVertexTangent,t.$inputs.zVertexBinormal,t.$inputs.zVertexColor,t.$inputs.zVertexUV,this._irFrag),0===this.drawContext.renderPass.type?this.drawContext.materialFlags&gu.SSR_STORE_ROUGHNESS?(t.$l.outRoughness=e.vec4(),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.viewVec,t.commonData,t.outRoughness),this.outputFragmentColor(t,t.$inputs.worldPos,t.litColor,t.outRoughness,e.vec4(e.add(e.mul(t.commonData.normal,.5),e.vec3(.5)),1))):(t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.viewVec,t.commonData),this.outputFragmentColor(t,t.$inputs.worldPos,t.litColor)):this.outputFragmentColor(t,t.$inputs.worldPos,t.commonData.albedo)}else this.outputFragmentColor(t,t.$inputs.worldPos,null)}applyUniformValues(t,e,i){if(super.applyUniformValues(t,e,i),this.needFragmentColor(e)){for(const e of this._uniformValues)t.setValue(e.name,e.finalValue);for(const e of this._uniformTextures)t.setTexture(e.name,e.finalTexture.get(),e.finalSampler)}}_createHash(){return this._irFrag.hash}createProgram(t,e){return super.createProgram(t,e)}onDispose(){super.onDispose();for(const t of this._uniformTextures)t.finalTexture.dispose()}getOutput(t,e){return t.find(t=>t.name===e)?.exp}}class Bm{_primaryCamera;_camera;_skipClipTest;_renderQueue;_renderPass;_isGPUPicking;_isShadowMapping;constructor(t,e,i,s){this._primaryCamera=s,this._camera=e,this._renderQueue=i,this._skipClipTest=!1,this._renderPass=t,this._isGPUPicking=3===this._renderPass.type,this._isShadowMapping=1===this._renderPass.type}get camera(){return this._camera}set camera(t){this._camera=t||null}get frustumCulling(){return!this._skipClipTest}set frustumCulling(t){this._skipClipTest=!t}get primaryCamera(){return this._primaryCamera}get renderPass(){return this._renderPass}get renderQueue(){return this._renderQueue}set renderQueue(t){this._renderQueue=t}get frustum(){return this._camera?.frustum||null}push(t,e){this.renderQueue.push(t,e)}pushRenderQueue(t){this.renderQueue.pushRenderQueue(t)}visit(t){return t instanceof Cu?this.visitOctreeNode(t):t.isMesh()?this.visitMesh(t):t.isWater()?this.visitWater(t):t.isParticleSystem()?this.visitParticleSystem(t):t.isTerrain()?this.visitTerrain(t):t.isClipmapTerrain()?this.visitClipmapTerrain(t):t.isPunctualLight()?this.visitPunctualLight(t):t.isBatchGroup()?this.visitBatchGroup(t):void 0}visitPunctualLight(t){if(!t.hidden){if(this.getClipStateWithNode(t)!==$.NOT_CLIPPED)return this.renderQueue.pushLight(t),!0}return!1}visitTerrain(t){if(!t.hidden&&(t.castShadow||!this._isShadowMapping)&&(t.gpuPickable||!this._isGPUPicking)){if(this.getClipStateWithNode(t)!==$.NOT_CLIPPED)return t.cull(this)>0}return!1}visitClipmapTerrain(t){if(!t.hidden&&(t.castShadow||!this._isShadowMapping)&&(t.gpuPickable||!this._isGPUPicking)){if(this.getClipStateWithNode(t)!==$.NOT_CLIPPED)return this.push(this._camera,t),!0}return!1}visitBatchGroup(t){if(!t.hidden){if(this.getClipStateWithNode(t)!==$.NOT_CLIPPED)return t.cull(this),!0}return!1}visitParticleSystem(t){if(!t.hidden&&!this._isShadowMapping&&(t.gpuPickable||!this._isGPUPicking)){if(this.getClipStateWithNode(t)!==$.NOT_CLIPPED)return this.push(this._camera,t),!0}return!1}visitMesh(t){if(!t.hidden&&(t.castShadow||!this._isShadowMapping)&&(t.gpuPickable||!this._isGPUPicking)){if(this.getClipStateWithNode(t)!==$.NOT_CLIPPED)return this.push(this._camera,t),!0}return!1}visitWater(t){if(!t.hidden&&!this._isShadowMapping&&(t.gpuPickable||!this._isGPUPicking)){if(this.getClipStateWithNode(t)!==$.NOT_CLIPPED)return this.push(this._camera,t),!0}return!1}visitOctreeNode(t){const e=t.getLevel()>0?this.getClipStateWithAABB(t.getBoxLoosed()):$.CLIPPED;if(e!==$.NOT_CLIPPED){const i=this._skipClipTest;this._skipClipTest=this._skipClipTest||e===$.A_INSIDE_B;const s=t.getNodes();for(let t=0;t<s.length;t++)this.visit(s[t]);return this._skipClipTest=i,!0}return!1}getClipStateWithNode(t){let e;if(this._skipClipTest)e=$.A_INSIDE_B;else if(t.clipTestEnabled){const i=t.getWorldBoundingVolume();e=i?this.getClipStateWithAABB(i.toAABB()):$.CLIPPED}else e=$.CLIPPED;return e}getClipStateWithAABB(t){return this.camera.clipMask?t.getClipStateWithFrustumMask(this.frustum,this.camera.clipMask):t.getClipStateWithFrustum(this.frustum)}}const Im=16384;class Pm{static _instanceBindGroupLayout=null;_bindGroupList=[];_allocFrameStamp;constructor(){this._allocFrameStamp=-1,this._bindGroupList=[]}allocateInstanceBindGroup(t,e){if(this._allocFrameStamp!==t){this._allocFrameStamp=t;for(const t of this._bindGroupList)t.offset=0}for(const t of this._bindGroupList)if(t.offset+e<=Im)return t.dirty=!0,t;if(!Pm._instanceBindGroupLayout){const t=new fn(Sl()).buildRender({vertex(t){this[Qc.getInstanceDataUniformName()]=t.vec4[4096]().uniformBuffer(3),t.main(function(){})},fragment(t){t.main(function(){})}});Pm._instanceBindGroupLayout=t[2][3]}const i={bindGroup:Sl().createBindGroup(Pm._instanceBindGroupLayout),buffer:new Float32Array(Im),offset:0,dirty:!0};return this._bindGroupList.push(i),i}}const $m=new Pm;class Rm extends gt{_itemList;_renderPass;_shadowedLightList;_unshadowedLightList;_sunLight;_bindGroupAllocator;_ref;_instanceInfo;_needSceneColor;_needSceneDepth;_needSceneColorWithDepth;_drawTransparent;_objectColorMaps;constructor(t,e){super(),this._bindGroupAllocator=e??$m,this._itemList=null,this._renderPass=t,this._shadowedLightList=[],this._unshadowedLightList=[],this._sunLight=null,this._ref={ref:this},this._instanceInfo=new Map,this._needSceneColor=!1,this._needSceneDepth=!1,this._needSceneColorWithDepth=!1,this._drawTransparent=!1,this._objectColorMaps=[new Map]}get sunLight(){return this._sunLight}set sunLight(t){this._sunLight=t}needSceneColor(){return this._needSceneColor}needSceneDepth(){return this._needSceneDepth}needSceneColorWithDepth(){return this._needSceneColorWithDepth}get drawTransparent(){return this._drawTransparent}get renderPass(){return this._renderPass}get itemList(){return this._itemList}get shadowedLights(){return this._shadowedLightList}get unshadowedLights(){return this._unshadowedLightList}get ref(){return this._ref}getInstanceInfo(t){return this._instanceInfo.get(t)}getMaxBatchSize(){return Sl().getDeviceCaps().shaderCaps.maxUniformBufferSize/64}pushLight(t){t.castShadow?this._shadowedLightList.push(t):this._unshadowedLightList.push(t),t.isDirectionLight()&&t.sunLight&&(this.sunLight=t)}pushRenderQueue(t){const e=t._itemList;e&&(this._itemList||(this._itemList=this.newRenderItemList()),this._itemList.opaque.lit.push(...e.opaque.lit),this._itemList.opaque.unlit.push(...e.opaque.unlit),this._itemList.transmission.lit.push(...e.transmission.lit),this._itemList.transmission.unlit.push(...e.transmission.unlit),this._itemList.transparent.lit.push(...e.transparent.lit),this._itemList.transparent.unlit.push(...e.transparent.unlit),this._itemList.transmission_trans.lit.push(...e.transmission_trans.lit),this._itemList.transmission_trans.unlit.push(...e.transmission_trans.unlit),this._needSceneColor||=t._needSceneColor,this._needSceneDepth||=t._needSceneDepth,this._needSceneColorWithDepth||=t._needSceneColorWithDepth,this._drawTransparent||=t._drawTransparent,this._objectColorMaps.push(...t._objectColorMaps))}push(t,e){if(e){e.pushRenderQueueRef(this._ref),this._itemList||(this._itemList=this.newRenderItemList());const i=2===e.getQueueType(),s=e.isUnlit(),r=!!e.needSceneDepth(),a=!!e.needSceneColor()||r;if(this._needSceneColor||=a,this._needSceneDepth||=e.needSceneDepth(),this._needSceneColorWithDepth||=a&&r,this._drawTransparent||=i,t.getPickResultResolveFunc()&&(e.getMaterial().objectColor=e.getObjectColor(),this._objectColorMaps[0].set(e.getDrawableId(),e)),e.isBatchable()){const t=i?a?s?this._itemList.transmission_trans.unlit[0].instanceList:this._itemList.transmission_trans.lit[0].instanceList:s?this._itemList.transparent.unlit[0].instanceList:this._itemList.transparent.lit[0].instanceList:a?s?this._itemList.transmission.unlit[0].instanceList:this._itemList.transmission.lit[0].instanceList:s?this._itemList.opaque.unlit[0].instanceList:this._itemList.opaque.lit[0].instanceList,r=e.getInstanceId(this._renderPass);let n=t[r];n||(n=[],t[r]=n),n.push(e)}else{const r=i?a?s?this._itemList.transmission_trans.unlit[0]:this._itemList.transmission_trans.lit[0]:s?this._itemList.transparent.unlit[0]:this._itemList.transparent.lit[0]:a?s?this._itemList.transmission.unlit[0]:this._itemList.transmission.lit[0]:s?this._itemList.opaque.unlit[0]:this._itemList.opaque.lit[0],n=!!e.getBoneMatrices(),o=!!e.getMorphData();let h;h=n&&o?r.skinAndMorphItemList:n?r.skinItemList:o?r.morphItemList:r.itemList,this.binaryInsert(h,{drawable:e,sortDistance:e.getSortDistance(t),instanceData:null});const l=e.getMaterial();l&&r.materialList.add(l.coreMaterial),e.applyTransformUniforms(this)}}}getDrawableByColor(t){const e=(t[0]<<24)+(t[1]<<16)+(t[2]<<8)+t[3];for(const t of this._objectColorMaps){const i=t.get(e);if(i)return i}return null}reset(){if(this._itemList){for(const t in this._itemList){const e=this._itemList[t];for(const t in e){const i=e[t];for(const t of i)t.renderQueue===this&&(t.renderBundle&&t.renderBundle.dispose(),t.skinRenderBundle&&t.skinRenderBundle.dispose(),t.morphRenderBundle&&t.morphRenderBundle.dispose(),t.skinAndMorphRenderBundle&&t.skinAndMorphRenderBundle.dispose(),t.instanceRenderBundle&&t.instanceRenderBundle.dispose())}}this._itemList=null}this._shadowedLightList=[],this._unshadowedLightList=[],this._sunLight=null,this._needSceneColor=!1,this._needSceneDepth=!1,this._needSceneColorWithDepth=!1,this._drawTransparent=!1}end(t,e){const i=Sl().frameInfo.frameCounter,s=this._itemList;if(!this.itemList)return this;const r=[s.opaque.lit,s.opaque.unlit,s.transmission.lit,s.transmission.unlit,s.transparent.lit,s.transparent.unlit,s.transmission_trans.lit,s.transmission_trans.unlit];for(let s=0;s<r.length;s++){const a=r[s];for(const s of a){if(s.renderQueue!==this)continue;const r=s.instanceList;for(const e in r){const a=r[e];let n=null,o=null;for(let e=0;e<a.length;e++){const r=a[e],h=r.getInstanceUniforms(),l=h?.length??0,u=4*Qc.MATERIAL_INSTANCE_DATA_OFFSET+l;(!n||n.offset+u>Im)&&(n=this._bindGroupAllocator.allocateInstanceBindGroup(i,u),o={drawable:r,sortDistance:r.getSortDistance(t),instanceData:{bindGroup:n,offset:n.offset,numInstances:0,stride:u}},this.binaryInsert(s.instanceItemList,o),r.applyInstanceOffsetAndStride(this,u,n.offset));const c={bindGroup:n,offset:n.offset};this._instanceInfo.set(r,c),r.applyTransformUniforms(this),r.applyMaterialUniforms(c),n.offset+=u,o.instanceData.numInstances++;const d=r.getMaterial();d&&s.materialList.add(d.coreMaterial)}}s.instanceList={},e&&(s.itemList.length>0&&(s.renderBundle=new Al),s.skinItemList.length>0&&(s.skinRenderBundle=new Al),s.morphItemList.length>0&&(s.morphRenderBundle=new Al),s.skinAndMorphItemList.length>0&&(s.skinAndMorphRenderBundle=new Al),s.instanceItemList.length>0&&(s.instanceRenderBundle=new Al))}}return this}binaryInsert(t,e){let i=0,s=t.length-1;const r=e.drawable.getMaterial().instanceId;for(;i<=s;){const a=Math.floor((i+s)/2),n=t[a].drawable.getMaterial().instanceId;if(n===r)return void t.splice(a+1,0,e);n<r?i=a+1:s=a-1}t.splice(i,0,e)}sortTransparentItems(t){this._itemList&&(this._itemList.transparent.lit[0].itemList.sort((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t)),this._itemList.transparent.lit[0].skinItemList.sort((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t)),this._itemList.transparent.lit[0].morphItemList.sort((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t)),this._itemList.transparent.lit[0].skinAndMorphItemList.sort((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t)),this._itemList.transparent.unlit[0].itemList.sort((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t)),this._itemList.transparent.unlit[0].skinItemList.sort((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t)),this._itemList.transparent.unlit[0].morphItemList.sort((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t)),this._itemList.transparent.unlit[0].skinAndMorphItemList.sort((e,i)=>this.drawableDistanceToCamera(i.drawable,t)-this.drawableDistanceToCamera(e.drawable,t)))}onDispose(){super.onDispose(),this.reset()}drawableDistanceToCamera(t,e){const i=t.getNode().position;return z.distanceSq(i,e)}newRenderItemListInfo(){return{itemList:[],skinItemList:[],morphItemList:[],skinAndMorphItemList:[],instanceItemList:[],materialList:new Set,instanceList:{},renderQueue:this}}newRenderItemListBundle(){return{lit:[this.newRenderItemListInfo()],unlit:[this.newRenderItemListInfo()]}}newRenderItemList(){return{opaque:this.newRenderItemListBundle(),transmission:this.newRenderItemListBundle(),transparent:this.newRenderItemListBundle(),transmission_trans:this.newRenderItemListBundle()}}}class Fm extends gt{_type;_globalBindGroups;_clearColor;_clearDepth;_clearStencil;constructor(t){super(),this._type=t,this._clearColor=new O(0,0,0,1),this._clearDepth=1,this._clearStencil=0,this._globalBindGroups={}}get clearColor(){return this._clearColor}set clearColor(t){this._clearColor=t??null}get clearDepth(){return this._clearDepth}set clearDepth(t){this._clearDepth=t??null}get clearStencil(){return this._clearStencil}set clearStencil(t){this._clearStencil=t??null}get type(){return this._type}isAutoFlip(t){return!(!t.device.getFramebuffer()||"webgpu"!==t.device.type)}render(t,e,i){t.renderPass=this,this.drawScene(t,e??t.camera,i)}getGlobalBindGroup(t){const e=this.getGlobalBindGroupHash(t);let i=this._globalBindGroups[e];if(!i){const s=t.device.programBuilder.buildRender({vertex(e){Qc.prepareVertexShader(e,t),e.main(function(){})},fragment(e){Qc.prepareFragmentShader(e,t),e.main(function(){})}});i=t.device.createBindGroup(s[2][0]),this._globalBindGroups[e]=i}return i}getGlobalBindGroupHash(t){return`${this.constructor.name}:${this._getGlobalBindGroupHash(t)}`}drawScene(t,e,i){const s=t.device;this.clearFramebuffer();const r=i??this.cullScene(t,e);if(r){const e=s.isWindingOrderReversed();s.reverseVertexWindingOrder(this.isAutoFlip(t)?!e:e),this.renderItems(t,r),s.reverseVertexWindingOrder(e),r!==i&&r.dispose()}}cullScene(t,e){if(e){const i=new Rm(this),s=new Bm(this,e,i,t.primaryCamera);return t.scene.octree?t.scene.octree.getRootNode().traverse(s):t.scene.rootNode.traverse(s),i.end(e),t.sunLight=i.sunLight,i}return null}internalDrawItemList(t,e,i,s,r){let a=!1;if(i&&t.primaryCamera.commandBufferReuse){const e=i.getRenderBundle(r);if(e)return void t.device.executeRenderBundle(e);a=!0,i.beginRenderBundle()}for(const n of e){t.instanceData=n.instanceData;const e=s!==n.drawable.getNode().worldMatrixDet<0;e&&t.device.reverseVertexWindingOrder(!t.device.isWindingOrderReversed()),a&&Al.addDrawable(n.drawable,n.drawable.getMaterial()?.coreMaterial,n.drawable.getPrimitive(),i,r),n.drawable.draw(t,a?void 0:r),e&&t.device.reverseVertexWindingOrder(!t.device.isWindingOrderReversed())}i&&t.primaryCamera.commandBufferReuse&&i.endRenderBundle(r)}drawItemList(t,e,i){e.renderQueue=t.renderQueue,e.instanceData=null;const s=`${i?"1":"0"}-${e.device.getBindGroup(0)[0].getGPUId()}-${e.device.getFramebuffer()?.getHash()??""}-${`${e.sceneColorTexture?.uid??0}-${e.linearDepthTexture?.uid??0}`}-${e.renderPassHash}`;t&&(t.itemList.length>0&&(e.materialFlags&=~(gu.SKIN_ANIMATION|gu.INSTANCING|gu.MORPH_ANIMATION),t.materialList.forEach(t=>t.apply(e)),this.internalDrawItemList(e,t.itemList,t.renderBundle,i,s)),t.skinItemList.length>0&&(e.materialFlags|=gu.SKIN_ANIMATION,e.materialFlags&=~(gu.MORPH_ANIMATION|gu.INSTANCING),t.materialList.forEach(t=>t.apply(e)),this.internalDrawItemList(e,t.skinItemList,t.skinRenderBundle,i,s)),t.morphItemList.length>0&&(e.materialFlags|=gu.MORPH_ANIMATION,e.materialFlags&=~(gu.SKIN_ANIMATION|gu.INSTANCING),t.materialList.forEach(t=>t.apply(e)),this.internalDrawItemList(e,t.morphItemList,t.morphRenderBundle,i,s)),t.skinAndMorphItemList.length>0&&(e.materialFlags|=gu.SKIN_ANIMATION|gu.MORPH_ANIMATION,e.materialFlags&=~gu.INSTANCING,t.materialList.forEach(t=>t.apply(e)),this.internalDrawItemList(e,t.skinAndMorphItemList,t.skinAndMorphRenderBundle,i,s)),t.instanceItemList.length>0&&(e.materialFlags|=gu.INSTANCING,e.materialFlags&=~(gu.SKIN_ANIMATION|gu.MORPH_ANIMATION),t.materialList.forEach(t=>t.apply(e)),this.internalDrawItemList(e,t.instanceItemList,t.instanceRenderBundle,i,s))),e.renderQueue=null}onDispose(){super.onDispose(),this._globalBindGroups={}}clearFramebuffer(){(this._clearColor||this._clearDepth||this._clearStencil)&&Sl().clearFrameBuffer(this._clearColor,this._clearDepth,this._clearStencil)}}var Dm=function(t){return t[t.opaque=0]="opaque",t[t.transparent=1]="transparent",t[t.end=2]="end",t}({});class Nm extends gt{static _defaultRenderStates={};_enabled;_layer;constructor(){super(),this._enabled=!0,this._layer=2}get enabled(){return this._enabled}set enabled(t){this._enabled=!!t}get layer(){return this._layer}needFlip(t){return"webgpu"===t.type&&!!t.getFramebuffer()}requireLinearDepthTexture(t){return!1}requireDepthAttachment(t){return!1}apply(t,e,i,s){this.passThrough(t,e,s)}passThrough(t,e,i,s){Hl(e,t.device.getFramebuffer(),Gl("clamp_nearest_nomip"),s,0,i)}drawFullscreenQuad(t){Ru(t)}createVertexLayout(t){return t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]})}onDispose(){super.onDispose(),this.destroy()}createRenderStates(t){const e=t.createRenderStateSet();return e.useRasterizerState().setCullMode("none"),e.useDepthState().enableTest(!1).enableWrite(!1),e}destroy(){}static getDefaultRenderState(t,e){let i=this._defaultRenderStates[e];return i||(i=t.device.createRenderStateSet(),i.useRasterizerState().setCullMode("none"),i.useDepthState().enableTest("always"!==e).enableWrite(!1).setCompareFunc(e),this._defaultRenderStates[e]=i),i}}class Lm extends Fm{_shadowMapHash;_transmission;constructor(){super(0),this._shadowMapHash=null,this._clearColor=O.zero()}get transmission(){return this._transmission}set transmission(t){this._transmission=t}_getGlobalBindGroupHash(t){return`${this._shadowMapHash}:${t.oit?.calculateHash()??""}:${t.env.getHash(t)}:${t.materialFlags}:${t.linearDepthTexture?.uid??0}:${t.sceneColorTexture?.uid??0}:${t.HiZTexture?.uid??0}`}renderLightPass(t,e,i,s){const r=!t.lightBlending;t.drawEnvLight=r&&"none"!==t.env.light.type&&(t.env.light.envLight.hasRadiance()||t.env.light.envLight.hasIrradiance()),t.renderPassHash=this.getGlobalBindGroupHash(t);const a=t.globalBindGroupAllocator.getGlobalBindGroup(t);s.cameraSet[t.renderPassHash]||(Qc.setCameraUniforms(a,t,!!t.device.getFramebuffer()),s.cameraSet[t.renderPassHash]=1),t.currentShadowLight?Qc.setLightUniformsShadow(a,t,i[0]):s.lightSet[t.renderPassHash]||(Qc.setLightUniforms(a,t,t.clusteredLight.clusterParam,t.clusteredLight.countParam,t.clusteredLight.lightBuffer,t.clusteredLight.lightIndexTexture),s.lightSet[t.renderPassHash]=1),t.materialFlags&gu.APPLY_FOG&&!s.fogSet[t.renderPassHash]&&(Qc.setFogUniforms(a,"scatter"===t.env.sky.skyType?1:0,t.env.sky.mappedFogType,r?0:1,t.env.sky.atmosphereParams,t.env.sky.heightFogParams,t.env.sky.getAerialPerspectiveLUT(t),t.env.sky.getSkyDistantLightLUT(t)),s.fogSet[t.renderPassHash]=1),t.device.setBindGroup(0,a);const n=t.camera.worldMatrixDet<0;for(const i of e.lit)this.drawItemList(i,t,n);if(!t.lightBlending)for(const i of e.unlit)this.drawItemList(i,t,n)}renderItems(t,e){t.fogFlags=0,t.renderPassHash=null,t.env=t.scene.env,t.drawEnvLight=!1,t.flip=this.isAutoFlip(t);const i=!!(t.materialFlags&gu.SSR_STORE_ROUGHNESS)?t.device.pool.fetchTemporalFramebuffer(!1,t.device.getDrawingBufferWidth(),t.device.getDrawingBufferHeight(),t.device.getFramebuffer().getColorAttachments()[0],t.device.getFramebuffer().getDepthAttachment()):null,s=e.drawTransparent&&t.primaryCamera.oit&&t.primaryCamera.oit.supportDevice(t.device.type)?t.primaryCamera.oit:null;!s&&e.drawTransparent&&e.sortTransparentItems(t.primaryCamera.getWorldPosition());const r={lightSet:{},cameraSet:{},fogSet:{}},a=e.itemList,n=this._transmission?[a?.transmission,a?.transmission_trans,a?.transparent]:[a?.opaque,a?.transparent],o=n.length-1;for(let h=0;h<n.length;h++){if(n[h]){t.queue=0===h?1:2,t.oit=0!==h&&a?s:null,(2===t.queue||this._transmission)&&t.scene.env.sky.fogPresents&&(t.materialFlags|=gu.APPLY_FOG);const o=t.oit?t.oit.begin(t):1;for(let s=0;s<o;s++){if(t.oit&&!t.oit.beginPass(t,s))continue;let a=0;if(t.shadowMapInfo)for(const e of t.shadowMapInfo.keys())t.currentShadowLight=e,t.lightBlending=a>0,this._shadowMapHash=t.shadowMapInfo.get(e).shaderHash,this.renderLightPass(t,n[h],[e],r),a++;(0===a||e.unshadowedLights.length>0)&&(t.currentShadowLight=null,t.lightBlending=a>0,this._shadowMapHash="",t.lightBlending&&i&&(t.materialFlags&=~gu.SSR_STORE_ROUGHNESS,t.device.pushDeviceStates(),t.device.setFramebuffer(i)),this.renderLightPass(t,n[h],e.unshadowedLights,r),t.lightBlending&&i&&(t.materialFlags|=gu.SSR_STORE_ROUGHNESS,t.device.popDeviceStates())),t.oit&&t.oit.endPass(t,s)}t.oit&&t.oit.end(t),t.materialFlags&=~gu.APPLY_FOG}0!==h||t.sceneColorTexture||(i&&(t.device.pushDeviceStates(),t.device.setFramebuffer(i)),t.env.sky.skyWorldMatrix=t.scene.rootNode.worldMatrix,t.env.sky.renderSky(t),t.env.sky.fogPresents&&t.env.sky.renderFog(t.camera),i&&t.device.popDeviceStates()),e.needSceneColor()&&!t.sceneColorTexture||0!==h&&h!==o||t.compositor?.drawPostEffects(t,0===h?Dm.opaque:Dm.transparent,t.linearDepthTexture)}i&&t.device.pool.releaseFrameBuffer(i)}}class zm extends Fm{_currentLight;constructor(){super(1),this._currentLight=null}get light(){return this._currentLight}set light(t){this._currentLight=t}_getGlobalBindGroupHash(t){return`${t.shadowMapInfo.get(this.light).shaderHash}`}renderItems(t,e){const i=e.itemList;if(i){t.drawEnvLight=!1,t.env=null,t.fogFlags=0,t.flip=this.isAutoFlip(t),t.renderPassHash=this.getGlobalBindGroupHash(t);const e=t.globalBindGroupAllocator.getGlobalBindGroup(t);t.device.setBindGroup(0,e),Qc.setLightUniformsShadowMap(e,t,this._currentLight),Qc.setCameraUniforms(e,t,!0);const s=t.camera.worldMatrixDet<0;for(const e of i.opaque.lit)this.drawItemList(e,t,s);for(const e of i.opaque.unlit)this.drawItemList(e,t,s);for(const e of i.transmission.lit)this.drawItemList(e,t,s);for(const e of i.transmission.unlit)this.drawItemList(e,t,s)}}}class Vm extends Fm{_renderBackface;_encodeDepth;_transmission;constructor(){super(2),this._renderBackface=!1,this._encodeDepth=!1,this._transmission=!1}get transmission(){return this._transmission}set transmission(t){this._transmission=t}get renderBackface(){return this._renderBackface}set renderBackface(t){this._renderBackface=!!t}get encodeDepth(){return this._encodeDepth}set encodeDepth(t){this._encodeDepth=!!t}_getGlobalBindGroupHash(t){return`${Number(this._renderBackface)}:${Number(this._encodeDepth)}:${Number(t.motionVectors)}`}renderItems(t,e){const i=e.itemList;if(i){t.fogFlags=0,t.drawEnvLight=!1,t.env=null,t.flip=this.isAutoFlip(t),t.renderPassHash=this.getGlobalBindGroupHash(t);const e=t.globalBindGroupAllocator.getGlobalBindGroup(t);t.device.setBindGroup(0,e),Qc.setCameraUniforms(e,t,!0);const s=t.camera.worldMatrixDet<0,r=this._transmission?i.transmission:i.opaque;for(const e of r.lit)this.drawItemList(e,t,s);for(const e of r.unlit)this.drawItemList(e,t,s)}}}class Om{_postEffects;_finalFramebuffer;_prevInputTexture;_prevFrameBuffer;_textureFormat;static _blitProgram=null;static _blitBindgroup=null;static _blitRenderStates=null;static _blitVertexLayout=null;constructor(){this._postEffects=[],this._postEffects[Dm.opaque]=[],this._postEffects[Dm.transparent]=[],this._postEffects[Dm.end]=[],this._finalFramebuffer=null,this._prevInputTexture=null,this._prevFrameBuffer=null,this._textureFormat="rgba16f"}requireLinearDepth(t){for(const e of this._postEffects)for(const i of e)if(i.get().requireLinearDepthTexture(t))return!0;return!1}appendPostEffect(t){if(t){for(const e of this._postEffects)if(e.findIndex(e=>e.get()===t)>=0)return void console.error("Posteffect cannot be added to same compositor multiple times");this._postEffects[t.layer].push(new wt(t))}}removePostEffect(t){for(const e of this._postEffects){const i=e.findIndex(e=>e.get()===t);if(i>=0)return e[i].dispose(),void e.splice(i,1)}}clear(){for(const t of this._postEffects){for(const e of t)e.dispose();t.splice(0,t.length)}}begin(t){const e=t.device;this._textureFormat=t.camera.HDR&&e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"rgba16f":"rgba8unorm",this._finalFramebuffer=e.getFramebuffer();const i=!!(t.materialFlags&gu.SSR_STORE_ROUGHNESS);if(this._postEffects.every(t=>0===t.length))return;const s=this._finalFramebuffer?.getDepthAttachment(),r=s?s.width:e.getDrawingBufferWidth(),a=s?s.height:e.getDrawingBufferHeight(),n=e.pool.fetchTemporalFramebuffer(!0,r,a,i?[this._textureFormat,t.SSRRoughnessTexture,t.SSRNormalTexture]:this._textureFormat,s??t.depthFormat);e.setFramebuffer(n)}drawPostEffects(t,e,i){const s=this._postEffects[e];if(s.length>0){const r=t.device,a=r.getFramebuffer(),n=a.getColorAttachments()[0];let o=null;for(let h=0;h<s.length;h++){const l=s[h].get();if(!l.enabled)continue;this._prevFrameBuffer&&(r.pool.releaseFrameBuffer(this._prevFrameBuffer),this._prevFrameBuffer=null);this.isLastPostEffect(e,h)&&(!l.requireDepthAttachment(t)||!!this._finalFramebuffer)?r.setFramebuffer(this._finalFramebuffer):(this._prevFrameBuffer=r.pool.fetchTemporalFramebuffer(!1,a.getWidth(),a.getHeight(),this._textureFormat,a.getDepthAttachment()??null),r.setFramebuffer(this._prevFrameBuffer));const u=o??n;l.apply(t,u,i,!r.getFramebuffer()),this._prevInputTexture&&(r.pool.releaseTexture(this._prevInputTexture),this._prevInputTexture=null),this._prevFrameBuffer&&(o=this._prevFrameBuffer.getColorAttachments()[0],r.pool.retainTexture(o),this._prevInputTexture=o)}}}end(t){const e=t.device;if(e.getFramebuffer()!==this._finalFramebuffer){const t=e.getFramebuffer().getColorAttachments()[0];e.setFramebuffer(this._finalFramebuffer),e.setViewport(null),e.setScissor(null),Om._blit(e,t,!this._finalFramebuffer)}this._prevInputTexture&&(e.pool.releaseTexture(this._prevInputTexture),this._prevInputTexture=null),this._prevFrameBuffer&&(e.pool.releaseFrameBuffer(this._prevFrameBuffer),this._prevFrameBuffer=null)}isLastPostEffect(t,e){for(let i=t;i<this._postEffects.length;i++){for(let s=i===t?e+1:0;s<this._postEffects[i].length;s++)if(this._postEffects[i][s].get().enabled)return!1}return!0}static _blit(t,e,i){this._blitProgram||(this._blitProgram=t.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),this.flip=t.int().uniform(0),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){this.srcTex=t.tex2D().sampleType("unfilterable-float").uniform(0),this.srgbOutput=t.int().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$outputs.outColor=t.textureSample(this.srcTex,this.$inputs.uv),this.$if(t.notEqual(this.srgbOutput,0),function(){this.$outputs.outColor=t.vec4(Il(this,this.$outputs.outColor.rgb),1)})})}}),this._blitProgram.name="@Compositor_blit",this._blitBindgroup=t.createBindGroup(this._blitProgram.bindGroupLayouts[0]),this._blitVertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]}),this._blitRenderStates=t.createRenderStateSet(),this._blitRenderStates.useRasterizerState().setCullMode("none"),this._blitRenderStates.useDepthState().enableTest(!1).enableWrite(!1)),this._blitBindgroup.setTexture("srcTex",e,Gl("clamp_nearest_nomip")),this._blitBindgroup.setValue("srgbOutput",i?1:0),this._blitBindgroup.setValue("flip","webgpu"===t.type&&t.getFramebuffer()?1:0),t.setRenderStates(this._blitRenderStates),t.setProgram(this._blitProgram),t.setBindGroup(0,this._blitBindgroup),t.setVertexLayout(this._blitVertexLayout),t.draw("triangle-strip",0,4)}}class km extends Cl{static _defaultOptions={needNormal:!0,needTangent:!0,needUV:!0};_options;constructor(t){super(),this._create(t)}static computeTangent(t,e,i,s,r,a,n){const o=new z(e[0]-t[0],e[1]-t[1],e[2]-t[2]),h=new z(i[0]-t[0],i[1]-t[1],i[2]-t[2]),l=r[0]-s[0],u=r[1]-s[1],c=a[0]-s[0],d=a[1]-s[1],p=l*d-u*c;if(Math.abs(p)<=1e-8)return[1,0,0,1];const m=1/p;let f=(o.x*d-h.x*u)*m,_=(o.y*d-h.y*u)*m,g=(o.z*d-h.z*u)*m;const x=(h.x*l-o.x*c)*m,b=(h.y*l-o.y*c)*m,v=(h.z*l-o.z*c)*m,y=n[0]*f+n[1]*_+n[2]*g;f-=n[0]*y,_-=n[1]*y,g-=n[2]*y;const T=Math.hypot(f,_,g);T>1e-8?(f/=T,_/=T,g/=T):(f=1,_=0,g=0);return[f,_,g,(n[1]*g-n[2]*_)*x+(n[2]*f-n[0]*g)*b+(n[0]*_-n[1]*f)*v<0?-1:1]}get options(){return this._options}set options(t){this._create(t)}normalizeOptions(t){const e=this.constructor._defaultOptions;return Object.assign({},e,t??{})}_create(t){this._options=this.normalizeOptions(t);const e=[],i=[],s=this._options.needNormal?[]:null,r=this._options.needTangent?[]:null,a=this._options.needUV?[]:null,n=new hu;n.beginExtend(),this.primitiveType=this.constructor.generateData(this._options,e,s,r,a,i,n,null,null);for(const t of["position","normal","tangent","texCoord0"])this.removeVertexBuffer(t);return this.setIndexBuffer(null),this.createAndSetVertexBuffer("position_f32x3",new Float32Array(e)),s&&this.createAndSetVertexBuffer("normal_f32x3",new Float32Array(s)),r&&this.createAndSetVertexBuffer("tangent_f32x4",new Float32Array(r)),a&&this.createAndSetVertexBuffer("tex0_f32x2",new Float32Array(a)),this.createAndSetIndexBuffer(new Uint16Array(i)),this.setBoundingVolume(n),this.indexCount=i.length,!0}static _transform(t,e,i,s){if(t){const r=new z;for(let a=s;a<e.length-2;a+=3)r.setXYZ(e[a],e[a+1],e[a+2]),t.transformPointAffine(r,r),e[a]=r.x,e[a+1]=r.y,e[a+2]=r.z,i&&(r.setXYZ(i[a],i[a+1],i[a+2]),t.transformVectorAffine(r,r),r.inplaceNormalize(),i[a]=r.x,i[a+1]=r.y,i[a+2]=r.z)}}}class Um extends km{static _defaultOptions={...km._defaultOptions,size:1,anchor:.5};constructor(t){super(t)}clone(){return new Um(this._options)}get type(){return"Box"}static generateData(t,e,i,s,r,a,n,o,h){t=Object.assign({},this._defaultOptions,t??{}),o=o??0;const l=e.length,u=t?.sizeX??t?.size??1,c=t?.sizeY??t?.size??1,d=t?.sizeZ??t?.size??1,p=-(t.anchorX??t.anchor)*u,m=p+u,f=-(t.anchorY??t.anchor)*c,_=f+c,g=-(t.anchorZ??t.anchor)*d,x=g+d,b=r?[0,0,0,1,1,1,1,0]:null,v=[p,_,g,p,_,x,m,_,x,m,_,g],y=i?[0,1,0,0,1,0,0,1,0,0,1,0]:null,T=[p,_,x,p,f,x,m,f,x,m,_,x],w=i?[0,0,1,0,0,1,0,0,1,0,0,1]:null,S=[m,_,x,m,f,x,m,f,g,m,_,g],A=i?[1,0,0,1,0,0,1,0,0,1,0,0]:null,C=[m,_,g,m,f,g,p,f,g,p,_,g],E=i?[0,0,-1,0,0,-1,0,0,-1,0,0,-1]:null,M=[p,_,g,p,f,g,p,f,x,p,_,x],B=i?[-1,0,0,-1,0,0,-1,0,0,-1,0,0]:null,I=[p,f,x,p,f,g,m,f,g,m,f,x],P=i?[0,-1,0,0,-1,0,0,-1,0,0,-1,0]:null;if(a?.push(0+o,1+o,2+o,0+o,2+o,3+o,4+o,5+o,6+o,4+o,6+o,7+o,8+o,9+o,10+o,8+o,10+o,11+o,12+o,13+o,14+o,12+o,14+o,15+o,16+o,17+o,18+o,16+o,18+o,19+o,20+o,21+o,22+o,20+o,22+o,23+o),e?.push(...v,...T,...S,...C,...M,...I),i?.push(...y,...w,...A,...E,...B,...P),r?.push(...b,...b,...b,...b,...b,...b),s){const t=(t,e,i)=>{s.push(t,e,i,1,t,e,i,1,t,e,i,1,t,e,i,1)};t(1,0,0),t(1,0,0),t(0,0,-1),t(-1,0,0),t(0,0,1),t(1,0,0)}if(km._transform(t.transform,e,i,l),n||h)for(let t=l;t<e.length-2;t+=3)n&&(n.minPoint.x=Math.min(n.minPoint.x,e[t]),n.minPoint.y=Math.min(n.minPoint.y,e[t+1]),n.minPoint.z=Math.min(n.minPoint.z,e[t+2]),n.maxPoint.x=Math.max(n.maxPoint.x,e[t]),n.maxPoint.y=Math.max(n.maxPoint.y,e[t+1]),n.maxPoint.z=Math.max(n.maxPoint.z,e[t+2])),h?.((t-l)/3,e[t],e[t+1],e[t+2]);return"triangle-list"}get width(){return this._options.sizeX??this._options.size??1}get height(){return this._options.sizeY??this._options.size??1}get depth(){return this._options.sizeZ??this._options.size??1}}class Gm extends km{static _defaultOptions={...km._defaultOptions,size:1,anchor:.5};constructor(t){super(t)}clone(){return new Gm(this._options)}get type(){return"BoxFrame"}static generateData(t,e,i,s,r,a,n,o,h){t=Object.assign({},this._defaultOptions,t??{}),o=o??0;const l=e.length,u=t?.sizeX??t?.size??1,c=t?.sizeY??t?.size??1,d=t?.sizeZ??t?.size??1,p=-(t.anchorX??t.anchor)*u,m=p+u,f=-(t.anchorY??t.anchor)*c,_=f+c,g=-(t.anchorZ??t.anchor)*d,x=g+d,b=r?[0,0,0,1,1,1,1,0]:null,v=[p,_,g,p,_,x,m,_,x,m,_,g],y=i?[0,1,0,0,1,0,0,1,0,0,1,0]:null,T=[p,f,x,p,f,g,m,f,g,m,f,x],w=i?[0,-1,0,0,-1,0,0,-1,0,0,-1,0]:null;if(a?.push(0+o,1+o,1+o,2+o,2+o,3+o,3+o,0+o,0+o,5+o,1+o,4+o,2+o,7+o,3+o,6+o,6+o,5+o,5+o,4+o,4+o,7+o,7+o,6+o),e?.push(...v,...T),i?.push(...y,...w),r?.push(...b,...b,...b,...b,...b,...b),s){const t=(t,e,i)=>{s.push(t,e,i,1,t,e,i,1,t,e,i,1,t,e,i,1)};t(1,0,0),t(1,0,0),t(0,0,-1),t(-1,0,0),t(0,0,1),t(1,0,0)}if(km._transform(t.transform,e,i,l),n||h)for(let t=l;t<e.length-2;t+=3)n&&(n.minPoint.x=Math.min(n.minPoint.x,e[t]),n.minPoint.y=Math.min(n.minPoint.y,e[t+1]),n.minPoint.z=Math.min(n.minPoint.z,e[t+2]),n.maxPoint.x=Math.max(n.maxPoint.x,e[t]),n.maxPoint.y=Math.max(n.maxPoint.y,e[t+1]),n.maxPoint.z=Math.max(n.maxPoint.z,e[t+2])),h?.((t-l)/3,e[t],e[t+1],e[t+2]);return"line-list"}}class Hm extends km{static _defaultOptions={...km._defaultOptions,topCap:!0,bottomCap:!0,bottomRadius:1,topRadius:1,heightDetail:1,radialDetail:20,height:1,anchor:0};constructor(t){super(t)}clone(){return new Hm(this._options)}get type(){return"Cylinder"}static addPatch(t,e,i,s,r){const a=t+1,n=(i+1)*a+e,o=n+1,h=n-a,l=h+1;s?.push(n+r,h+r,l+r,n+r,l+r,o+r)}static generateData(t,e,i,s,r,a,n,o,h){t=Object.assign({},this._defaultOptions,t??{}),o=o??0;const l=e.length,u=(t.topRadius-t.bottomRadius)/t.height;for(let n=0;n<=t.heightDetail;n++){const h=n/t.heightDetail,l=(t.topRadius-t.bottomRadius)*h+t.bottomRadius;for(let c=0;c<=t.radialDetail;c++){const d=c/t.radialDetail,p=d*Math.PI*2,m=Math.sin(p),f=Math.cos(p),_=1/Math.hypot(m,u,f);e?.push(l*m,(h-t.anchor)*t.height,l*f),i?.push(m*_,u*_,f*_),r?.push(d,1-h),s?.push(f,0,-m,1),n<t.heightDetail&&c<t.radialDetail&&this.addPatch(t.radialDetail,c,n,a,o)}}let c=l+(t.heightDetail+1)*(t.radialDetail+1);if(t.bottomCap){e?.push(0,-t.anchor*t.height,0),i?.push(0,-1,0),r?.push(.5,.5),s?.push(1,0,0,1);const n=c-l;c++;for(let h=0;h<=t.radialDetail;h++){const l=h/t.radialDetail*Math.PI*2,u=Math.sin(l),d=Math.cos(l);e?.push(t.bottomRadius*u,-t.anchor*t.height,t.bottomRadius*d),i?.push(0,-1,0),r?.push(.5+.5*u,.5+.5*d),s?.push(1,0,0,1),c++,h<t.radialDetail&&a?.push(n+o,n+h+2+o,n+h+1+o)}}if(t.topCap){e?.push(0,(1-t.anchor)*t.height,0),i?.push(0,1,0),r?.push(.5,.5),s?.push(1,0,0,1);const n=c-l;c++;for(let h=0;h<=t.radialDetail;h++){const l=h/t.radialDetail*Math.PI*2,u=Math.sin(l),d=Math.cos(l);e?.push(t.topRadius*u,(1-t.anchor)*t.height,t.topRadius*d),i?.push(0,1,0),r?.push(.5+.5*u,.5+.5*d),s?.push(1,0,0,1),c++,h<t.radialDetail&&a?.push(n+o,n+h+1+o,n+h+2+o)}}if(km._transform(t.transform,e,i,l),n||h)for(let t=l;t<e.length-2;t+=3)n&&(n.minPoint.x=Math.min(n.minPoint.x,e[t]),n.minPoint.y=Math.min(n.minPoint.y,e[t+1]),n.minPoint.z=Math.min(n.minPoint.z,e[t+2]),n.maxPoint.x=Math.max(n.maxPoint.x,e[t]),n.maxPoint.y=Math.max(n.maxPoint.y,e[t+1]),n.maxPoint.z=Math.max(n.maxPoint.z,e[t+2])),h?.((t-l)/3,e[t],e[t+1],e[t+2]);return"triangle-list"}}class Wm extends km{static _defaultOptions={...km._defaultOptions,numSlices:40,numSegments:16,outerRadius:1,innerRadius:.3,radialDetail:20};constructor(t){super(t)}clone(){return new Wm(this._options)}get type(){return"Torus"}static generateData(t,e,i,s,r,a,n,o,h){t=Object.assign({},this._defaultOptions,t??{}),o=o??0;const l=e.length,u=t.numSlices,c=t.numSegments,d=t.outerRadius,p=t.innerRadius;for(let t=0;t<=u;t++){const a=t%u/u*Math.PI*2,n=Math.cos(a),o=Math.sin(a),h=d*n,l=0,m=d*o;for(let a=0;a<=c;a++){const f=a%c/c*Math.PI*2,_=Math.cos(f),g=Math.sin(f),x=1+p*_/d,b=h*x,v=l*x+p*g,y=m*x;if(e.push(b,v,y),i){const t=b-h,e=v-l,s=y-m,r=Math.hypot(t,e,s);i.push(t/r,e/r,s/r)}if(r&&r.push(a/c,t/u),s){const t=-g*n,e=_,i=-g*o;s.push(t,e,i,1)}}}for(let t=0;t<u;t++)for(let e=0;e<c;e++)a.push(t*(c+1)+e+o),a.push((t+1)*(c+1)+e+1+o),a.push((t+1)*(c+1)+e+o),a.push(t*(c+1)+e+o),a.push(t*(c+1)+e+1+o),a.push((t+1)*(c+1)+e+1+o);if(km._transform(t.transform,e,i,l),n||h)for(let t=l;t<e.length-2;t+=3)n&&(n.minPoint.x=Math.min(n.minPoint.x,e[t]),n.minPoint.y=Math.min(n.minPoint.y,e[t+1]),n.minPoint.z=Math.min(n.minPoint.z,e[t+2]),n.maxPoint.x=Math.max(n.maxPoint.x,e[t]),n.maxPoint.y=Math.max(n.maxPoint.y,e[t+1]),n.maxPoint.z=Math.max(n.maxPoint.z,e[t+2])),h?.((t-l)/3,e[t],e[t+1],e[t+2]);return"triangle-list"}}class Xm extends km{static _defaultOptions={...km._defaultOptions,size:1,resolution:1,twoSided:!1,anchor:.5};constructor(t){super(t)}clone(){return new Xm(this._options)}get type(){return"Plane"}static generateData(t,e,i,s,r,a,n,o,h){t=Object.assign({},this._defaultOptions,t??{}),o=o??0;const l=e.length,u=Math.abs(t.sizeX||t.size)||1,c=Math.abs(t.sizeY||t.size)||1,d=-(t.anchorX??t.anchor)*u,p=d+u,m=-(t.anchorY??t.anchor)*c,f=m+c,_=Math.max(t.resolutionX??t.resolution,1),g=Math.max(t.resolutionY??t.resolution,1),x=(p-d)/_,b=(f-m)/g;for(let t=0;t<=_;t++)for(let a=0;a<=g;a++)r?.push(t/_,a/g),e?.push(d+x*t,0,m+b*a),i?.push(0,1,0),s?.push(1,0,0,1);if(a)for(let e=0;e<_;e++)for(let i=0;i<g;i++){const s=i*(g+1)+e,r=(i+1)*(g+1)+e,n=s+1,h=r+1;a.push(s+o,n+o,h+o,s+o,h+o,r+o),t.twoSided&&a.push(s+o,h+o,n+o,s+o,r+o,h+o)}if(km._transform(t.transform,e,i,l),n||h)for(let t=l;t<e.length-2;t+=3)n&&(n.minPoint.x=Math.min(n.minPoint.x,e[t]),n.minPoint.y=Math.min(n.minPoint.y,e[t+1]),n.minPoint.z=Math.min(n.minPoint.z,e[t+2]),n.maxPoint.x=Math.max(n.maxPoint.x,e[t]),n.maxPoint.y=Math.max(n.maxPoint.y,e[t+1]),n.maxPoint.z=Math.max(n.maxPoint.z,e[t+2])),h?.((t-l)/3,e[t],e[t+1],e[t+2]);return"triangle-list"}}class jm extends km{static _defaultOptions={...km._defaultOptions,radius:1,verticalDetail:20,horizonalDetail:20};constructor(t){super(t)}clone(){return new jm(this._options)}get type(){return"Sphere"}raycast(t){const e=this._options.radius*this._options.radius,i=z.dot(t.origin,t.origin);if(i<e)return null;const s=-z.dot(t.origin,t.direction),r=i-s*s;return e<r?null:s-Math.sqrt(e-r)}get radius(){return this._options.radius??1}static generateData(t,e,i,s,r,a,n,o,h){t=Object.assign({},this._defaultOptions,t??{}),o=o??0;const l=e.length,u=[],c=t.radius??1,d=t.verticalDetail??20,p=t.horizonalDetail??20,m=Math.PI/d,f=2*Math.PI/p;for(let t=0;t<=d;t++){const a=t*m,n=Math.sin(a),o=Math.cos(a);for(let a=0;a<=p;a++){const h=a*f,l=Math.sin(h),u=Math.cos(h),m=c*n*l,_=c*o,g=c*n*u;if(e.push(m,_,g),r?.push(a/p,t/d),i){const t=1/c;i.push(m*t,_*t,g*t)}if(s){const t=1;let e,i,r;n>1e-6?(e=u,i=0,r=-l):(e=1,i=0,r=0),s.push(e,i,r,t)}}}for(let t=0;t<d;t++){for(let e=0;e<=p;e++){const i=t*(p+1);u.push(i+e+o,i+e+p+1+o)}u.push(u[u.length-1]),u.push((t+1)*(p+1)+o)}for(let t=0;t<u.length-2;t++)t%2==0?a.push(u[t],u[t+1],u[t+2]):a.push(u[t],u[t+2],u[t+1]);if(km._transform(t.transform,e,i,l),n)for(let t=l;t<e.length-2;t+=3)n&&(n.minPoint.x=Math.min(n.minPoint.x,e[t]),n.minPoint.y=Math.min(n.minPoint.y,e[t+1]),n.minPoint.z=Math.min(n.minPoint.z,e[t+2]),n.maxPoint.x=Math.max(n.maxPoint.x,e[t]),n.maxPoint.y=Math.max(n.maxPoint.y,e[t+1]),n.maxPoint.z=Math.max(n.maxPoint.z,e[t+2])),h?.((t-l)/3,e[t],e[t+1],e[t+2]);return"triangle-list"}}class Qm extends km{static _defaultOptions={...km._defaultOptions,height:1,sizeX:1,sizeZ:1};constructor(t){super(t)}clone(){return new Qm(this._options)}get type(){return"Tetrahedron"}static calculateTriangleNormal(t,e,i){const s=z.sub(e,t),r=z.sub(i,t);return z.normalize(z.cross(s,r))}static addTriangle(t,e,i,s,r,a,n,o,h,l){const u=this.calculateTriangleNormal(t,e,i);s.push(t.x,t.y,t.z),s.push(e.x,e.y,e.z),s.push(i.x,i.y,i.z),r?.push(u.x,u.y,u.z),r?.push(u.x,u.y,u.z),r?.push(u.x,u.y,u.z);const c=[.5,0],d=[0,1],p=[1,1];if(n?.push(...c),n?.push(...d),n?.push(...p),a){const s=this.computeTangent([t.x,t.y,t.z],[e.x,e.y,e.z],[i.x,i.y,i.z],c,d,p,[u.x,u.y,u.z]);a.push(...s),a.push(...s),a.push(...s)}return o.push(h+l),o.push(h+l+1),o.push(h+l+2),l+3}static generateData(t,e,i,s,r,a,n,o,h){t=Object.assign({},this._defaultOptions,t??{}),o=o??0;const l=e.length,u=t.height,c=t.sizeX,d=t.sizeZ,p=new z(0,u,0),m=[new z(c,0,d),new z(c,0,-d),new z(-c,0,-d),new z(-c,0,d)];let f=0;if(f=this.addTriangle(p,m[0],m[1],e,i,s,r,a,o,f),f=this.addTriangle(p,m[1],m[2],e,i,s,r,a,o,f),f=this.addTriangle(p,m[2],m[3],e,i,s,r,a,o,f),f=this.addTriangle(p,m[3],m[0],e,i,s,r,a,o,f),f=this.addTriangle(m[0],m[3],m[1],e,i,s,r,a,o,f),f=this.addTriangle(m[1],m[3],m[2],e,i,s,r,a,o,f),km._transform(t.transform,e,i,l),n||h)for(let t=l;t<e.length-2;t+=3)n&&(n.minPoint.x=Math.min(n.minPoint.x,e[t]),n.minPoint.y=Math.min(n.minPoint.y,e[t+1]),n.minPoint.z=Math.min(n.minPoint.z,e[t+2]),n.maxPoint.x=Math.max(n.maxPoint.x,e[t]),n.maxPoint.y=Math.max(n.maxPoint.y,e[t+1]),n.maxPoint.z=Math.max(n.maxPoint.z,e[t+2])),h?.((t-l)/3,e[t],e[t+1],e[t+2]);return"triangle-list"}}km._defaultOptions;const qm=1e-8;class Ym extends Nm{static _resolveProgram=[];static _skyMotionVectorProgram=null;static _box;static _texSize=new L;_bindGroup;_skyMotionVectorBindGroup;constructor(){super(),this._bindGroup=null,this._layer=Dm.end,this._skyMotionVectorBindGroup=null}renderSkyMotionVectors(t){const e=t.device.pool.fetchTemporalFramebuffer(!1,0,0,t.motionVectorTexture,t.depthTexture),i=Ym._getSkyMotionVectorProgram(t);this._skyMotionVectorBindGroup||(this._skyMotionVectorBindGroup=t.device.createBindGroup(i.bindGroupLayouts[0]));const s=Ym._getBox(t);this._skyMotionVectorBindGroup.setValue("VPMatrix",t.camera.viewProjectionMatrix),this._skyMotionVectorBindGroup.setValue("prevVPMatrix",t.camera.prevVPMatrix),this._skyMotionVectorBindGroup.setValue("cameraPos",t.camera.getWorldPosition()),this._skyMotionVectorBindGroup.setValue("prevCameraPos",t.camera.prevPosition),t.device.pushDeviceStates(),t.device.setProgram(i),t.device.setBindGroup(0,this._skyMotionVectorBindGroup),t.device.setRenderStates(Nm.getDefaultRenderState(t,"le")),t.device.setFramebuffer(e),s.draw(),t.device.popDeviceStates(),t.device.pool.releaseFrameBuffer(e)}apply(t,e,i,s){const r=t.camera.getHistoryData();if(r.prevColorTex&&r.prevMotionVectorTex&&r.prevColorTex.width===e.width&&r.prevColorTex.height===e.height){let a=Ym._resolveProgram[t.camera.TAADebug];a||(a=Ym._getResolveProgram(t,t.camera.TAADebug),Ym._resolveProgram[t.camera.TAADebug]=a),this._bindGroup||(this._bindGroup=t.device.createBindGroup(a.bindGroupLayouts[0])),this._bindGroup.setTexture("historyColorTex",r.prevColorTex,Gl("clamp_linear_nomip")),this._bindGroup.setTexture("currentColorTex",e,Gl("clamp_nearest_nomip")),this._bindGroup.setTexture("currentDepthTex",i,Gl("clamp_nearest_nomip")),this._bindGroup.setTexture("motionVector",t.motionVectorTexture,Gl("clamp_nearest_nomip")),this._bindGroup.setTexture("prevMotionVector",r.prevMotionVectorTex,Gl("clamp_nearest_nomip")),this._bindGroup.setValue("flip",this.needFlip(t.device)?1:0),this._bindGroup.setValue("srgbOut",s?1:0),Ym._texSize.setXY(i.width,i.height),this._bindGroup.setValue("texSize",Ym._texSize),t.device.setProgram(a),t.device.setBindGroup(0,this._bindGroup),this.drawFullscreenQuad()}else this.passThrough(t,e,s);r.prevColorTex&&t.device.pool.releaseTexture(r.prevColorTex);const a=t.device.getFramebuffer().getColorAttachments()[0];t.device.pool.retainTexture(a),r.prevColorTex=a,r.prevMotionVectorTex&&t.device.pool.releaseTexture(r.prevMotionVectorTex),t.device.pool.retainTexture(t.motionVectorTexture),r.prevMotionVectorTex=t.motionVectorTexture}requireLinearDepthTexture(t){return!0}requireDepthAttachment(t){return!0}static _getSkyMotionVectorProgram(t){return this._skyMotionVectorProgram||(this._skyMotionVectorProgram=t.device.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec3().attrib("position"),this.VPMatrix=t.mat4().uniform(0),this.prevVPMatrix=t.mat4().uniform(0),this.cameraPos=t.vec3().uniform(0),this.prevCameraPos=t.vec3().uniform(0),t.main(function(){this.$l.worldPos=t.add(this.$inputs.pos,this.cameraPos),this.$l.prevWorldPos=t.add(this.$inputs.pos,this.prevCameraPos),this.$l.clipPos=t.mul(this.VPMatrix,t.vec4(this.worldPos,1)),this.$l.prevClipPos=t.mul(this.prevVPMatrix,t.vec4(this.prevWorldPos,1)),this.clipPos.z=this.clipPos.w,this.$builtins.position=this.clipPos,this.$outputs.currentPos=this.clipPos,this.$outputs.prevPos=this.prevClipPos})},fragment(t){this.$outputs.color=t.vec4(),t.main(function(){this.$l.motionVector=t.mul(t.sub(t.div(this.$inputs.currentPos.xy,this.$inputs.currentPos.w),t.div(this.$inputs.prevPos.xy,this.$inputs.prevPos.w)),.5),this.$outputs.color=t.vec4(this.motionVector,0,1)})}}),this._skyMotionVectorProgram.name="@TAA_SkyMotionVector"),this._skyMotionVectorProgram}static _getBox(t){return this._box||(this._box=new Um({size:2,needNormal:!1,needUV:!1})),this._box}static _getResolveProgram(t,e){const i=t.device.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,1,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){this.historyColorTex=t.tex2D().uniform(0),this.currentColorTex=t.tex2D().uniform(0),this.currentDepthTex=t.tex2D().uniform(0),this.motionVector=t.tex2D().uniform(0),this.prevMotionVector=t.tex2D().uniform(0),this.texSize=t.vec2().uniform(0),this.srgbOut=t.int().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$l.screenUV=t.div(t.vec2(this.$builtins.fragCoord.xy),this.texSize),this.$l.resolvedColor=function(t,e,i,s,r,a,n,o,h=0){const l=t.$builder;return l.func("getClosestVelocity",[l.vec2("uv"),l.vec2("texSize")],function(){this.$l.minDepth=l.float(1),this.$l.closestUV=this.uv,this.$l.tmpDepth=l.float(),this.$l.tmpUV=l.vec2();for(let t=-1;t<=1;t++)for(let e=-1;e<=1;e++)this.tmpUV=l.add(this.uv,l.div(l.vec2(t,e),this.texSize)),this.tmpDepth=l.textureSampleLevel(s,this.tmpUV,0).r,this.$if(l.lessThan(this.tmpDepth,this.minDepth),function(){this.minDepth=this.tmpDepth,this.closestUV=this.tmpUV});this.$l.motionVector=l.textureSampleLevel(r,this.closestUV,0),this.$return(this.motionVector.xyz)}),l.func("clipAABB",[l.vec3("aabbMin"),l.vec3("aabbMax"),l.vec3("p"),l.vec3("q")],function(){this.$l.r=l.sub(this.q,this.p),this.$l.rMax=l.sub(this.aabbMax,this.p),this.$l.rMin=l.sub(this.aabbMin,this.p),this.$if(l.greaterThan(this.r.x,l.add(this.rMax.x,qm)),function(){this.r=l.mul(this.r,l.div(this.rMax.x,this.r.x))}),this.$if(l.greaterThan(this.r.y,l.add(this.rMax.y,qm)),function(){this.r=l.mul(this.r,l.div(this.rMax.y,this.r.y))}),this.$if(l.greaterThan(this.r.z,l.add(this.rMax.z,qm)),function(){this.r=l.mul(this.r,l.div(this.rMax.z,this.r.z))}),this.$if(l.lessThan(this.r.x,l.sub(this.rMin.x,qm)),function(){this.r=l.mul(this.r,l.div(this.rMin.x,this.r.x))}),this.$if(l.lessThan(this.r.y,l.sub(this.rMin.y,qm)),function(){this.r=l.mul(this.r,l.div(this.rMin.y,this.r.y))}),this.$if(l.lessThan(this.r.z,l.sub(this.rMin.z,qm)),function(){this.r=l.mul(this.r,l.div(this.rMin.z,this.r.z))}),this.$return(l.add(this.p,this.r))}),l.func("clipHistoryColor",[l.vec2("uv"),l.vec3("historyColor"),l.vec2("closestVelocity"),l.vec2("texSize")],function(){let t=1;this.$l.colorAvg=l.vec3(0),this.$l.colorAvg2=l.vec3(0);for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++)this.$l[`s${t}`]=l.textureSampleLevel(e,l.add(this.uv,l.div(l.vec2(i,s),this.texSize)),0).rgb,this.colorAvg=l.add(this.colorAvg,this[`s${t}`]),this.colorAvg2=l.add(this.colorAvg2,l.mul(this[`s${t}`],this[`s${t}`])),t++;this.colorAvg=l.div(this.colorAvg,t-1),this.colorAvg2=l.div(this.colorAvg2,t-1),this.$l.boxSize=l.mix(2.5,0,l.smoothStep(0,.02,l.length(this.closestVelocity))),this.$l.dev=l.mul(l.sqrt(l.abs(l.sub(this.colorAvg2,l.mul(this.colorAvg,this.colorAvg)))),this.boxSize),this.$l.colorMin=l.sub(this.colorAvg,this.dev),this.$l.colorMax=l.add(this.colorAvg,this.dev),this.$l.color=this.clipAABB(this.colorMin,this.colorMax,l.clamp(this.colorAvg,this.colorMin,this.colorMax),this.historyColor),this.color=l.clamp(this.color,l.vec3(qm),l.vec3(32767)),this.$return(this.color)}),l.func("reinhard",[l.vec3("hdr")],function(){this.$return(l.div(this.hdr,l.add(this.hdr,l.vec3(1))))}),l.func("reinhardInv",[l.vec3("sdr")],function(){this.$return(l.div(this.sdr,l.sub(l.vec3(1),this.sdr)))}),l.func("luminance",[l.vec3("color")],function(){this.$return(l.max(l.dot(this.color,l.vec3(.299,.587,.114)),1e-4))}),l.func("getDisocclusionFactor",[l.vec2("uv"),l.vec2("velocity"),l.vec2("texSize")],function(){this.$l.prevVelocitySample=l.textureSampleLevel(a,this.uv,0),this.$l.prevVelocity=this.prevVelocitySample.xy,this.$l.disocclusion=l.sub(l.length(l.mul(l.sub(this.velocity,this.prevVelocity),this.texSize)),2.5),this.$return(l.clamp(l.mul(this.disocclusion,.01),0,1))}),l.func("sampleHistoryColorCatmulRom9",[l.vec2("uv"),l.vec2("texSize")],function(){this.$l.samplePos=l.mul(this.uv,this.texSize),this.$l.texPos1=l.add(l.floor(l.sub(this.samplePos,l.vec2(.5))),l.vec2(.5)),this.$l.f=l.sub(this.samplePos,this.texPos1),this.$l.w0=l.mul(this.f,l.sub(l.mul(this.f,l.sub(l.vec2(1),l.mul(this.f,.5))),l.vec2(.5))),this.$l.w1=l.add(l.vec2(1),l.mul(this.f,this.f,l.sub(l.mul(this.f,1.5),l.vec2(2.5)))),this.$l.w2=l.mul(this.f,l.add(l.vec2(.5),l.mul(this.f,l.sub(l.vec2(2),l.mul(this.f,1.5))))),this.$l.w3=l.mul(this.f,this.f,l.sub(l.mul(this.f,.5),l.vec2(.5))),this.$l.w12=l.add(this.w1,this.w2),this.$l.offset12=l.div(this.w2,l.add(this.w1,this.w2)),this.$l.texPos0=l.sub(this.texPos1,l.vec2(1)),this.$l.texPos3=l.add(this.texPos1,l.vec2(2)),this.$l.texPos12=l.add(this.texPos1,this.offset12),this.texPos0=l.div(this.texPos0,this.texSize),this.texPos3=l.div(this.texPos3,this.texSize),this.texPos12=l.div(this.texPos12,this.texSize),this.$l.result=l.vec3(0),this.result=l.add(this.result,l.mul(l.textureSampleLevel(i,this.texPos0,0).rgb,this.w0.x,this.w0.y)),this.result=l.add(this.result,l.mul(l.textureSampleLevel(i,l.vec2(this.texPos12.x,this.texPos0.y),0).rgb,this.w12.x,this.w0.y)),this.result=l.add(this.result,l.mul(l.textureSampleLevel(i,l.vec2(this.texPos3.x,this.texPos0.y),0).rgb,this.w3.x,this.w0.y)),this.result=l.add(this.result,l.mul(l.textureSampleLevel(i,l.vec2(this.texPos0.x,this.texPos12.y),0).rgb,this.w0.x,this.w12.y)),this.result=l.add(this.result,l.mul(l.textureSampleLevel(i,this.texPos12,0).rgb,this.w12.x,this.w12.y)),this.result=l.add(this.result,l.mul(l.textureSampleLevel(i,l.vec2(this.texPos3.x,this.texPos12.y),0).rgb,this.w3.x,this.w12.y)),this.result=l.add(this.result,l.mul(l.textureSampleLevel(i,l.vec2(this.texPos0.x,this.texPos3.y),0).rgb,this.w0.x,this.w3.y)),this.result=l.add(this.result,l.mul(l.textureSampleLevel(i,l.vec2(this.texPos12.x,this.texPos3.y),0).rgb,this.w12.x,this.w3.y)),this.result=l.add(this.result,l.mul(l.textureSampleLevel(i,this.texPos3,0).rgb,this.w3.x,this.w3.y)),this.$return(l.max(this.result,l.vec3(0)))}),l.func("temporalResolve",[l.vec2("screenUV"),l.vec2("texSize")],function(){this.$l.velocitySample=l.textureSampleLevel(r,this.screenUV,0),this.$l.velocity=this.velocitySample.xy,this.$l.sampleColor=l.textureSampleLevel(e,this.screenUV,0).rgb,this.$if(l.and(l.greaterThanEqual(this.velocity.x,5e4),l.greaterThanEqual(this.velocity.y,5e4)),function(){this.$return(this.sampleColor)}),this.$l.reprojectedUV=l.sub(this.screenUV,this.velocity),this.$l.historyColor=this.sampleHistoryColorCatmulRom9(this.reprojectedUV,this.texSize),this.$l.velocityClosest=this.getClosestVelocity(this.screenUV,this.texSize),this.$l.blendFactor=l.div(this.velocityClosest.z,5e4),this.prevColor=this.clipHistoryColor(this.screenUV,this.historyColor,this.velocityClosest.xy,this.texSize),this.$l.screenFactor=this.$choice(l.or(l.any(l.lessThan(this.reprojectedUV,l.vec2(0))),l.any(l.greaterThan(this.reprojectedUV,l.vec2(1)))),l.float(1),l.float(0)),this.$l.disocclusionFactor=this.getDisocclusionFactor(this.reprojectedUV,this.velocity,this.texSize),this.$l.alpha=l.clamp(l.add(this.blendFactor,this.screenFactor,this.disocclusionFactor),0,1),this.prevColor=this.reinhard(this.prevColor),this.currentColor=this.reinhard(this.sampleColor),this.$l.currentLum=this.luminance(this.currentColor),this.$l.prevLum=this.luminance(this.prevColor),this.$l.diff=l.div(l.abs(l.sub(this.currentLum,this.prevLum)),l.max(this.currentLum,l.max(this.prevLum,1.001))),this.diff=l.sub(1,this.diff),this.diff=l.mul(this.diff,this.diff),this.alpha=l.clamp(l.mix(0,this.alpha,this.diff),.1,1),this.$l.resolvedColor=l.vec3(),1===h?(this.resolvedColor=this.currentColor.rgb,this.resolvedColor=this.reinhardInv(this.resolvedColor)):2===h?(this.resolvedColor=this.prevColor.rgb,this.resolvedColor=this.reinhardInv(this.resolvedColor)):4===h?this.resolvedColor=l.vec3(this.screenFactor):5===h?this.resolvedColor=l.vec3(this.alpha):3===h?this.resolvedColor=l.abs(l.sub(this.sampleColor,this.historyColor)):6===h?this.resolvedColor=l.abs(l.mul(this.velocityClosest,20)):7===h?this.resolvedColor=l.vec3(this.blendFactor):(this.resolvedColor=l.mix(this.prevColor.rgb,this.currentColor.rgb,this.alpha),this.resolvedColor=this.reinhardInv(this.resolvedColor)),this.$return(this.resolvedColor)}),t.temporalResolve(n,o)}(this,this.currentColorTex,this.historyColorTex,this.currentDepthTex,this.motionVector,this.prevMotionVector,this.screenUV,this.texSize,e),this.$if(t.equal(this.srgbOut,0),function(){this.$outputs.outColor=t.vec4(this.resolvedColor,1)}).$else(function(){this.$outputs.outColor=t.vec4(Il(this,this.resolvedColor),1)})})}});return i.name="@TAA_Resolve",i}}const Zm=3402823466e29;function Km(t,e,i){const s=t.$builder;return s.func("SSR_calcJitter",[s.vec3("viewPos"),s.float("roughness")],function(){this.$l.h=s.fract(s.mul(this.viewPos,.8)),this.h=s.add(this.h,s.dot(this.h,s.add(this.h.yxz,s.vec3(19.19)))),this.h=s.fract(s.mul(s.add(this.h.xxy,this.h.yxx),this.h.zyx)),this.h=s.sub(this.h,s.vec3(.5)),this.$return(s.mix(s.vec3(0),this.h,this.roughness))}),t.SSR_calcJitter(e,i)}function Jm(t,e,i){const s=t.$builder;return s.func("invProjectPosition",[s.vec3("p"),s.mat4("mat")],function(){this.$l.c=s.sub(s.mul(this.p,2),s.vec3(1)),this.$l.u=s.mul(this.mat,s.vec4(this.c,1)),this.u=s.div(this.u,this.u.w),this.$return(this.u.xyz)}),t.invProjectPosition(e,i)}function tf(t,e,i,s,r,a,n,o,h,l,u){const c=t.$builder,d=i?"SSR_validateHit_HiZ":"SSR_validateHit";return c.func(d,[c.vec2("hit2d"),...i?[c.vec3("hit3d")]:[],...i?[c.float("thickness")]:[],c.float("surfaceZ"),c.vec2("uv"),c.vec3("viewSpaceRayDirection"),c.mat4("viewMatrix"),c.mat4("invProjMatrix"),c.vec4("textureSize")],function(){this.$if(c.or(c.any(c.lessThan(this.hit2d,c.vec2(0))),c.any(c.greaterThan(this.hit2d,c.vec2(1)))),function(){this.$return(c.float(0))}),this.$l.manhattanDist=c.abs(c.sub(this.hit2d,this.uv)),this.$if(c.all(c.lessThan(this.manhattanDist,c.vec2(c.div(c.vec2(2),this.textureSize.xy)))),function(){this.$return(c.float(0))}),u&&(this.$l.hitNormalWS=c.sub(c.mul(c.textureSampleLevel(u,this.hit2d,0).rgb,2),c.vec3(1)),this.$l.hitNormalVS=c.mul(this.viewMatrix,c.vec4(this.hitNormalWS,0)).xyz,this.$if(c.greaterThan(c.dot(this.hitNormalVS,this.viewSpaceRayDirection),0),function(){this.$return(c.float(0))})),this.$l.viewSpaceSurface=Jm(this,c.vec3(this.hit2d,this.surfaceZ),this.invProjMatrix),this.$l.fov=c.mul(c.vec2(c.div(this.textureSize.y,this.textureSize.x),1),.05),this.$l.border=c.mul(c.smoothStep(c.vec2(0),this.fov,this.hit2d),c.sub(c.vec2(1),c.smoothStep(c.sub(c.vec2(1),this.fov),c.vec2(1),this.hit2d))),this.$l.vignette=c.mul(this.border.x,this.border.y),this.hit3d?(this.$l.distance=c.distance(this.viewSpaceSurface,this.hit3d),this.$l.confidence=c.sub(1,c.smoothStep(0,this.thickness,this.distance)),this.$return(c.mul(this.vignette,this.confidence,this.confidence))):this.$return(this.vignette)}),i?t[d](e,i,r,s,a,n,o,h,l):t[d](e,s,a,n,o,h,l)}function ef(t,e,i,s,r,a,n,o,h,l,u,c,d,p,m){const f=t.$builder;return f.func("distanceSquared",[f.vec2("a"),f.vec2("b")],function(){this.$l.x=f.sub(this.a,this.b),this.$return(f.dot(this.x,this.x))}),f.func("rayIntersectDepth",[f.float("zA"),f.float("zB"),f.float("thickness"),f.vec2("uv"),f.float("cameraFar")],function(){let t=this.thickness;m?(this.$l.sceneZ=Qc.sampleLinearDepthWithBackface(this,d,this.uv,0),this.$l.sceneZMax01=this.sceneZ.x,t=f.max(this.thickness,f.mul(f.sub(this.sceneZ.y,this.sceneZ.x),this.cameraFar))):this.$l.sceneZMax01=Qc.sampleLinearDepth(this,d,this.uv,0),this.sceneZMax=f.neg(f.mul(this.sceneZMax01,this.cameraFar)),this.$return(f.and(f.lessThan(this.sceneZMax01,1),f.greaterThanEqual(this.zA,f.sub(this.sceneZMax,t)),f.lessThanEqual(this.zB,this.sceneZMax)))}),f.func("traceRayLinear2D",[f.vec3("rayOrigin"),f.vec3("rayDirection"),f.float("stride"),f.float("maxDistance"),f.float("maxIterations"),f.float("thickness"),f.vec2("cameraNearFar"),f.mat4("projMatrix"),f.vec4("textureSize"),f.vec3("hit2D").out(),f.vec3("hit3D").out(),f.vec2("origin").out(),f.float("numIterations").out()],function(){this.$l.rayLen=this.$choice(f.greaterThan(f.add(this.rayOrigin.z,f.mul(this.rayDirection.z,this.maxDistance)),f.neg(this.cameraNearFar.x)),f.div(f.sub(f.neg(this.cameraNearFar.x),this.rayOrigin.z),this.rayDirection.z),this.maxDistance),this.$l.rayEnd=f.add(this.rayOrigin,f.mul(this.rayDirection,this.rayLen)),this.$l.zMin=f.min(this.rayOrigin.z,this.rayEnd.z),this.$l.zMax=f.max(this.rayOrigin.z,this.rayEnd.z),this.$l.rayOriginH=f.mul(this.projMatrix,f.vec4(this.rayOrigin,1)),this.$l.rayEndH=f.mul(this.projMatrix,f.vec4(this.rayEnd,1)),this.$l.k0=f.div(1,this.rayOriginH.w),this.$l.k1=f.div(1,this.rayEndH.w),this.$l.Q0=f.mul(this.rayOrigin,this.k0),this.$l.Q1=f.mul(this.rayEnd,this.k1),this.$l.rayOriginNDC=f.mul(this.rayOriginH,this.k0),this.$l.rayEndNDC=f.mul(this.rayEndH,this.k1),this.origin=f.add(f.mul(this.rayOriginNDC.xy,.5),f.vec2(.5)),this.$l.P0=f.mul(this.origin,this.textureSize.zw),this.$l.P1=f.mul(f.add(f.mul(this.rayEndNDC.xy,.5),f.vec2(.5)),this.textureSize.zw),this.$l.xMin=.5,this.$l.xMax=f.sub(this.textureSize.z,.5),this.$l.yMin=.5,this.$l.yMax=f.sub(this.textureSize.w,.5),this.$l.t=f.float(),this.$if(f.or(f.greaterThan(this.P1.y,this.yMax),f.lessThan(this.P1.y,this.yMin)),function(){this.t=f.div(f.sub(this.P1.y,this.$choice(f.greaterThan(this.P1.y,this.yMax),this.yMax,this.yMin)),f.sub(this.P1.y,this.P0.y))}),this.$if(f.or(f.greaterThan(this.P1.x,this.xMax),f.lessThan(this.P1.x,this.xMin)),function(){this.t2=f.div(f.sub(this.P1.x,this.$choice(f.greaterThan(this.P1.x,this.xMax),this.xMax,this.xMin)),f.sub(this.P1.x,this.P0.x)),this.t=f.max(this.t,this.t2)}),this.P1=f.mix(this.P1,this.P0,this.t),this.k1=f.mix(this.k1,this.k0,this.t),this.Q1=f.mix(this.Q1,this.Q0,this.t),this.P1=this.$choice(f.lessThan(this.distanceSquared(this.P0,this.P1),1e-4),f.add(this.P1,f.vec2(.01)),this.P1),this.$l.delta=f.sub(this.P1,this.P0),this.$l.permute=!1,this.$if(f.lessThan(f.abs(this.delta.x),f.abs(this.delta.y)),function(){this.permute=!0,this.delta=this.delta.yx,this.P0=this.P0.yx,this.P1=this.P1.yx}),this.$l.stepDir=f.sign(this.delta.x),this.$l.invdx=f.div(this.stepDir,this.delta.x),this.$l.dQ=f.mul(f.sub(this.Q1,this.Q0),this.invdx),this.$l.dK=f.mul(f.sub(this.k1,this.k0),this.invdx),this.$l.dP=f.vec2(this.stepDir,f.mul(this.delta.y,this.invdx)),this.$l.pixelStride=this.stride,this.dP=f.mul(this.dP,this.pixelStride),this.dQ=f.mul(this.dQ,this.pixelStride),this.dK=f.mul(this.dK,this.pixelStride),this.$l.jitter=f.float(1),this.P0=f.add(this.P0,f.mul(this.dP,this.jitter)),this.Q0=f.add(this.Q0,f.mul(this.dQ,this.jitter)),this.k0=f.add(this.k0,f.mul(this.dK,this.jitter)),this.$l.prevZMaxEstimate=this.rayOrigin.z,this.$l.zA=this.prevZMaxEstimate,this.$l.zB=this.prevZMaxEstimate,this.$l.pqk=f.vec4(this.P0,this.Q0.z,this.k0),this.$l.dpqk=f.vec4(this.dP,this.dQ.z,this.dK),this.$l.invRenderTargetSize=f.div(f.vec2(1),this.textureSize.zw),this.$l.intersected=!1,this.$l.hitUV=f.vec2(),this.$l.hitZ=f.float(),this.numIterations=0,this.skippedIterations=f.min(this.maxIterations,1),this.$for(f.float("i"),0,"webgl"===f.getDevice().type?1e3:this.maxIterations,function(){"webgl"===f.getDevice().type&&this.$if(f.greaterThanEqual(this.i,this.maxIterations),function(){this.$break()}),this.$if(f.and(this.intersected,f.greaterThanEqual(this.i,this.skippedIterations)),function(){this.$break()}),this.numIterations=f.add(this.numIterations,1),this.pqk=f.add(this.pqk,this.dpqk),this.zA=this.prevZMaxEstimate,this.zB=f.div(f.add(f.mul(this.dpqk.z,.5),this.pqk.z),f.add(f.mul(this.dpqk.w,.5),this.pqk.w)),this.zB=f.clamp(this.zB,this.zMin,this.zMax),this.prevZMaxEstimate=this.zB,this.hitZ=this.zB,this.$if(f.greaterThan(this.zB,this.zA),function(){this.$l.t=this.zB,this.zB=this.zA,this.zA=this.t}),this.hitUV=this.$choice(this.permute,this.pqk.yx,this.pqk.xy),this.hitUV=f.mul(this.hitUV,this.invRenderTargetSize),this.intersected=this.rayIntersectDepth(this.zA,this.zB,this.thickness,this.hitUV,this.cameraNearFar.y)}),this.hit2D=f.vec3(this.hitUV,this.hitZ),this.Q0=f.vec3(f.add(this.Q0.xy,f.mul(this.dQ.xy,this.numIterations)),this.pqk.z),this.hit3D=f.div(this.Q0,this.pqk.w),this.$return(this.intersected)}),f.func("SSR_Linear2D",[f.vec3("rayOrigin"),f.vec3("rayDirection"),f.mat4("viewMatrix"),f.mat4("projMatrix"),f.mat4("invProjMatrix"),f.float("stride"),f.float("maxDistance"),f.float("maxIterations"),f.float("thickness"),f.vec2("cameraNearFar"),f.vec4("textureSize")],function(){this.$l.hit2D=f.vec3(),this.$l.hit3D=f.vec3(),this.$l.origin=f.vec2(),this.$l.numIterations=f.float(),this.$l.intersected=this.traceRayLinear2D(this.rayOrigin,this.rayDirection,this.stride,this.maxDistance,this.maxIterations,this.thickness,this.cameraNearFar,this.projMatrix,this.textureSize,this.hit2D,this.hit3D,this.origin,this.numIterations),this.$if(f.not(this.intersected),function(){this.$return(f.vec4(0))}),this.$l.surfaceZ01=Qc.sampleLinearDepth(this,d,this.hit2D.xy,0),this.$if(f.equal(this.surfaceZ01,1),function(){this.$return(f.vec4(0))}),this.$l.surfaceZ=Qc.linearDepthToNonLinear(this,f.mul(this.surfaceZ01,this.cameraNearFar.y),this.cameraNearFar),this.$l.confidence=tf(this,this.hit2D.xy,null,this.surfaceZ,null,this.origin,this.rayDirection,this.viewMatrix,this.invProjMatrix,this.textureSize,p),this.$l.iterationAttenuation=f.sub(1,f.smoothStep(0,this.maxIterations,this.numIterations)),this.confidence=f.mul(this.confidence,this.iterationAttenuation),this.$l.hitPixel=f.mul(this.hit2D.xy,this.textureSize.zw),this.$l.startPixel=f.mul(this.origin.xy,this.textureSize.zw),this.$l.hitDistance=f.length(f.sub(this.hitPixel,this.startPixel)),this.$return(f.vec4(this.hit2D.xy,this.hitDistance,this.confidence))}),t.SSR_Linear2D(e,i,s,r,a,u,o,h,l,n,c)}function sf(t,e,i,s,r,a,n,o,h,l,u,c,d){const p=t.$builder;return p.func("getMipResolution",[p.int("mipLevel")],function(){this.$return(p.vec2(p.textureDimensions(c,this.mipLevel)))}),p.func("SSR_loadDepth",[p.vec2("uv"),p.float("level")],function(){this.$return(p.textureSampleLevel(c,this.uv,this.level).r)}),p.func("invProjectPosition",[p.vec3("p"),p.mat4("mat")],function(){this.$l.c=p.sub(p.mul(this.p,2),p.vec3(1)),this.$l.u=p.mul(this.mat,p.vec4(this.c,1)),this.u=p.div(this.u,this.u.w),this.$return(this.u.xyz)}),p.func("projectPosition",[p.vec3("p"),p.mat4("mat")],function(){this.$l.projected=p.mul(this.mat,p.vec4(this.p,1)),this.projected=p.div(this.projected,this.projected.w),this.projected=p.add(p.mul(this.projected,.5),p.vec4(.5)),this.$return(this.projected.xyz)}),p.func("projectDirection",[p.vec3("p"),p.vec3("d"),p.vec3("screenSpacePos"),p.mat4("mat")],function(){this.$return(p.sub(this.projectPosition(p.add(this.p,this.d),this.mat),this.screenSpacePos))}),p.func("SSR_initialAdvanceRay",[p.vec3("origin"),p.vec3("direction"),p.vec3("invDirection"),p.vec2("currentMipResolution"),p.vec2("invCurrentMipResolution"),p.vec2("floorOffset"),p.vec2("uvOffset"),p.vec3("position").out(),p.float("currentT").out()],function(){this.$l.currentMipPosition=p.mul(this.currentMipResolution,this.origin.xy),this.$l.xyPlane=p.add(p.floor(this.currentMipPosition),this.floorOffset),this.xyPlane=p.add(p.mul(this.xyPlane,this.invCurrentMipResolution),this.uvOffset),this.$l.t=p.mul(p.sub(this.xyPlane,this.origin.xy),this.invDirection.xy),this.currentT=p.min(this.t.x,this.t.y),this.position=p.add(this.origin,p.mul(this.direction,this.currentT))}),p.func("SSR_advanceRay",[p.vec3("origin"),p.vec3("direction"),p.vec3("invDirection"),p.vec2("currentMipPosition"),p.vec2("invCurrentMipResolution"),p.vec2("floorOffset"),p.vec2("uvOffset"),p.float("surfaceZ"),p.vec3("position").inout(),p.float("currentT").inout()],function(){this.$l.xyPlane=p.add(p.floor(this.currentMipPosition),this.floorOffset),this.xyPlane=p.add(p.mul(this.xyPlane,this.invCurrentMipResolution),this.uvOffset),this.$l.boundaryPlanes=p.vec3(this.xyPlane,this.surfaceZ),this.$l.t=p.mul(p.sub(this.boundaryPlanes,this.origin),this.invDirection),this.t.z=this.$choice(p.greaterThan(this.direction.z,0),this.t.z,Zm),this.$l.tMin=p.min(p.min(this.t.x,this.t.y),this.t.z),this.$l.aboveSurface=p.greaterThan(this.surfaceZ,this.position.z),this.$l.skippedTile=p.and(p.notEqual(p.floatBitsToUint(this.tMin),p.floatBitsToUint(this.t.z)),this.aboveSurface),this.currentT=this.$choice(this.aboveSurface,this.tMin,this.currentT),this.position=p.add(this.origin,p.mul(this.direction,this.currentT)),this.$return(this.skippedTile)}),p.func("SSR_RaymarchHiZ",[p.vec3("screenSpacePos"),p.vec3("screenSpaceDirection"),p.vec2("cameraNearFar"),p.vec2("screenSize"),p.int("mostDetailMip"),p.int("maxMipLevel"),p.float("maxIterations"),p.float("numIterations").out()],function(){this.$l.invDirection=this.$choice(p.all(p.compNotEqual(this.screenSpaceDirection,p.vec3(0))),p.div(p.vec3(1),this.screenSpaceDirection),p.vec3(Zm)),this.$l.currentMip=this.mostDetailMip,this.$l.currentMipResolution=this.getMipResolution(this.currentMip),this.$l.invCurrentMipResolution=p.div(p.vec2(1),this.currentMipResolution),this.$l.uvOffset=p.div(p.mul(.005,p.exp2(p.float(this.mostDetailMip))),this.screenSize),this.uvOffset=p.vec2(this.$choice(p.lessThan(this.screenSpaceDirection.x,0),p.neg(this.uvOffset.x),this.uvOffset.x),this.$choice(p.lessThan(this.screenSpaceDirection.y,0),p.neg(this.uvOffset.y),this.uvOffset.y)),this.$l.floorOffset=p.vec2(this.$choice(p.lessThan(this.screenSpaceDirection.x,0),p.float(0),p.float(1)),this.$choice(p.lessThan(this.screenSpaceDirection.y,0),p.float(0),p.float(1))),this.$l.currentT=p.float(),this.$l.position=p.vec3(),this.SSR_initialAdvanceRay(this.screenSpacePos,this.screenSpaceDirection,this.invDirection,this.currentMipResolution,this.invCurrentMipResolution,this.floorOffset,this.uvOffset,this.position,this.currentT),this.numIterations=p.float(0),this.$while(p.and(p.lessThan(this.numIterations,this.maxIterations),p.greaterThanEqual(this.currentMip,this.mostDetailMip)),function(){this.$l.currentMipPosition=p.mul(this.currentMipResolution,this.position.xy),this.$l.surfaceZ=p.textureLoad(c,p.ivec2(this.currentMipPosition),this.currentMip).r,this.$l.skippedTile=this.SSR_advanceRay(this.screenSpacePos,this.screenSpaceDirection,this.invDirection,this.currentMipPosition,this.invCurrentMipResolution,this.floorOffset,this.uvOffset,this.surfaceZ,this.position,this.currentT),this.$l.nextMipIsOutOfRange=p.and(this.skippedTile,p.greaterThanEqual(this.currentMip,this.maxMipLevel)),this.$if(p.not(this.nextMipIsOutOfRange),function(){this.currentMip=p.add(this.currentMip,this.$choice(this.skippedTile,p.int(1),p.int(-1))),this.currentMipResolution=p.mul(this.currentMipResolution,this.$choice(this.skippedTile,.5,2)),this.invCurrentMipResolution=p.mul(this.invCurrentMipResolution,this.$choice(this.skippedTile,2,.5))}),this.numIterations=p.add(this.numIterations,1)}),this.$l.validHit=this.$choice(p.lessThanEqual(this.numIterations,this.maxIterations),p.float(1),p.float(0)),this.$return(p.vec4(this.position,this.validHit))}),p.func("SSR_HiZ",[p.vec3("viewPos"),p.vec3("traceRay"),p.mat4("viewMatrix"),p.mat4("projMatrix"),p.mat4("invProjMatrix"),p.vec2("cameraNearFar"),p.float("thickness"),p.vec4("textureSize"),p.int("maxMipLevel"),p.float("maxIterations")],function(){this.$if(p.greaterThan(this.traceRay.z,0),function(){this.$return(p.vec4(0))}),this.$l.originH=p.mul(this.projMatrix,p.vec4(this.viewPos,1)),this.$l.originCS=p.div(this.originH.xyz,this.originH.w),this.$l.originTS=p.add(p.mul(this.originCS,.5),p.vec3(.5)),this.$l.directionTS=this.projectDirection(this.viewPos,this.traceRay,this.originTS,this.projMatrix),this.$l.mostDetailMip=p.int(0),this.$l.numIterations=p.float(),this.$l.hit=this.SSR_RaymarchHiZ(this.originTS,this.directionTS,this.cameraNearFar,this.textureSize.zw,this.mostDetailMip,this.maxMipLevel,this.maxIterations,this.numIterations),this.$l.confidence=p.float(0),this.$if(p.notEqual(this.hit.w,0),function(){this.$l.surfaceZ=p.textureSampleLevel(c,this.hit.xy,0).r,this.$if(p.equal(this.surfaceZ,1),function(){this.$return(p.vec4(0))}),this.$l.hit3D=Jm(this,this.hit.xyz,this.invProjMatrix),this.confidence=tf(this,this.hit.xy,this.hit3D,this.surfaceZ,this.thickness,this.originTS.xy,this.traceRay,this.viewMatrix,this.invProjMatrix,this.textureSize,d)}),this.$l.iterationAttenuation=p.sub(1,p.smoothStep(0,this.maxIterations,this.numIterations)),this.$l.viewAttenuation=p.sub(1,p.smoothStep(-.5,0,this.traceRay.z)),this.confidence=p.mul(this.confidence,this.iterationAttenuation,this.viewAttenuation),this.$l.hitPixel=p.mul(this.hit.xy,this.textureSize.zw),this.$l.startPixel=p.mul(this.originTS.xy,this.textureSize.zw),this.$l.hitDistance=p.length(p.sub(this.hitPixel,this.startPixel)),this.$return(p.vec4(this.hit.xy,this.hitDistance,this.confidence))}),t.SSR_HiZ(e,i,s,r,a,n,l,u,p.sub(o,1),h)}class rf extends Pl{_depthTex;_sampler;_blurSizeTex;_blurSizeScale;_blurSizeIndex;_kernelRadius;_cameraNearFar;_depthCutoff;_stepSize;_uvStep;_size;_stdDev;_offsetsAndWeights;_finalPhase;constructor(t){super(),this._depthTex=null,this._depthCutoff=2,this._blurSizeTex=null,this._blurSizeScale=1,this._blurSizeIndex=0,this._sampler=null,this._blurSizeTex=null,this._kernelRadius=8,this._cameraNearFar=L.zero(),this._size=L.zero(),this._stdDev=2,this._offsetsAndWeights=new Float32Array(4*(this._kernelRadius+1)),this._finalPhase=!!t,this._stepSize=1,this._uvStep=this._finalPhase?new L(1,0):new L(0,1),this.calcGaussion()}get depthTex(){return this._depthTex}set depthTex(t){this._depthTex=t}get blurSizeTex(){return this._blurSizeTex}set blurSizeTex(t){this._blurSizeTex=t}get blurSizeIndex(){return this._blurSizeIndex}set blurSizeIndex(t){this._blurSizeIndex=t}get blurSizeScale(){return this._blurSizeScale}set blurSizeScale(t){this._blurSizeScale=t}get sampler(){return this._sampler}set sampler(t){this._sampler=t}get cameraNearFar(){return this._cameraNearFar}set cameraNearFar(t){this._cameraNearFar.set(t)}get depthCutoff(){return this._depthCutoff}set depthCutoff(t){this._depthCutoff=t}get size(){return this._size}set size(t){this._size.set(t)}get stepSize(){return this._stepSize}set stepSize(t){t!==this._stepSize&&(this._stepSize=t,this.calcGaussion())}get stdDev(){return this._stdDev}set stdDev(t){t!==this._stdDev&&(this._stdDev=t,this.calcGaussion())}get kernelRadius(){return this._kernelRadius}set kernelRadius(t){(t=Math.max(t,0)|0)!==this._kernelRadius&&(this._kernelRadius=t,this._offsetsAndWeights=new Float32Array(4*(this._kernelRadius+1)),this.calcGaussion(),this.invalidateHash())}calcHash(){return`${Number(!!this._blurSizeTex)}:${this._blurSizeIndex}:${this._kernelRadius}:${this._finalPhase}`}calcGaussion(){const t=[],e=2*this.kernelRadius+1;let i=0;for(let s=0;s<e;s++){const e=1/(Math.sqrt(2*Math.PI)*this._stdDev)*Math.exp(-((s-this.kernelRadius)**2)/(2*this._stdDev**2));t.push(e),i+=e}for(let e=0;e<=this.kernelRadius;e++)this._offsetsAndWeights[4*e]=this._uvStep.x*e,this._offsetsAndWeights[4*e+1]=this._uvStep.y*e,this._offsetsAndWeights[4*e+2]=t[this.kernelRadius-e]/i,this._offsetsAndWeights[4*e+3]=this._stepSize}setup(t,e){super.setup(t,e);const i=t.$builder;"fragment"===i.shaderKind&&(t.depthTex=i.tex2D().uniform(0),this._blurSizeTex&&(t.blurSizeTex=i.tex2D().uniform(0),t.blurSizeScale=i.float().uniform(0)),t.depthCutoff=i.float().uniform(0),t.offsetsAndWeights=i.vec4[this._kernelRadius+1]().uniform(0),t.cameraNearFar=i.vec2().uniform(0),t.size=i.vec2().uniform(0))}setUniforms(t,e){super.setUniforms(t,e),t.setTexture("depthTex",this._depthTex,this._sampler??Gl("clamp_nearest_nomip")),this._blurSizeTex&&(t.setTexture("blurSizeTex",this._blurSizeTex,Gl("clamp_linear_nomip")),t.setValue("blurSizeScale",this._blurSizeScale)),t.setValue("depthCutoff",this._depthCutoff),t.setValue("offsetsAndWeights",this._offsetsAndWeights),t.setValue("cameraNearFar",this._cameraNearFar),t.setValue("size",this._size)}filter(t,e,i,s,r,a){const n=this,o=t.$builder;return o.func("getLinearDepth",[o.vec2("uv")],function(){this.$l.depthValue=o.textureSample(this.depthTex,this.uv),this.$l.depth01="webgl"===o.getDevice().type?El(this,this.depthValue):this.depthValue.r,this.$return(o.mul(this.depth01,this.cameraNearFar.y))}),o.func("getLogDepth",[o.float("linearDepth")],function(){this.$return(o.log(o.add(this.linearDepth,1)))}),t.centerDepth=t.getLogDepth(t.getLinearDepth(s)),t.depthDiff=o.div(t.depthCutoff,o.sub(t.getLogDepth(t.cameraNearFar.y),t.getLogDepth(t.cameraNearFar.x))),t.weightSum=t.offsetsAndWeights[0].z,t.srcTexel=n.readTexel(t,e,i,s,r,a),t.colorSum=o.mul(t.srcTexel,t.weightSum),n._blurSizeTex&&(t.blurSize=o.textureSample(t.blurSizeTex,s)["rgba"[this._blurSizeIndex]]),t.$for(o.int("i"),0,n._kernelRadius,function(){this.$l.offsetAndWeight=this.offsetsAndWeights.at(o.add(this.i,1)),this.$l.weight=this.offsetAndWeight.z,this.$l.offset=this.offsetAndWeight.xy,n._blurSizeTex&&(this.offset=o.mul(this.offset,this.blurSize,this.blurSizeScale)),this.$l.offset=o.div(this.offset,this.size),this.$l.uvRight=o.add(s,this.offset),this.$l.depthRight=this.getLogDepth(this.getLinearDepth(this.uvRight)),this.$if(o.lessThan(o.abs(o.sub(this.depthRight,this.centerDepth)),this.depthDiff),function(){this.$l.srcTexelRight=n.readTexel(this,e,i,this.uvRight,r,a),this.$l.colorWeight=o.mul(this.weight,o.exp(o.neg(o.distance(this.srcTexelRight.rgb,this.srcTexel.rgb)))),this.colorSum=o.add(this.colorSum,o.mul(this.srcTexelRight,this.colorWeight)),this.weightSum=o.add(this.weightSum,this.colorWeight)}),this.$l.uvLeft=o.sub(s,this.offset),this.$l.depthLeft=this.getLogDepth(this.getLinearDepth(this.uvLeft)),this.$if(o.lessThan(o.abs(o.sub(this.depthLeft,this.centerDepth)),this.depthDiff),function(){this.$l.srcTexelLeft=n.readTexel(this,e,i,this.uvLeft,r,a),this.$l.colorWeight=o.mul(this.weight,o.exp(o.neg(o.distance(this.srcTexelLeft.rgb,this.srcTexel.rgb)))),this.colorSum=o.add(this.colorSum,o.mul(this.srcTexelLeft,this.colorWeight)),this.weightSum=o.add(this.weightSum,this.colorWeight)})}),t.colorSum=o.div(t.colorSum,t.weightSum),t.colorSum}}class af extends Nm{static _programs={};static _resolveProgram={};static _combineProgram=void 0;static _blurBlitterH=null;static _blurBlitterV=null;_bindgroups;_resolveBindGroup;_combineBindGroup;constructor(){super(),this._layer=Dm.opaque,this._bindgroups={},this._resolveBindGroup={},this._combineBindGroup=null}requireLinearDepthTexture(){return!0}requireDepthAttachment(){return!0}blurPass(t,e,i,s,r,a,n,o,h,l){const u=new L(h.getWidth(),h.getHeight());e.kernelRadius=a,e.stdDev=n,e.size=u,e.depthTex=t.linearDepthTexture,e.depthCutoff=o,e.blurSizeTex=i,e.blurSizeIndex=s,e.blurSizeScale=r,e.sampler=Gl("clamp_nearest_nomip"),e.cameraNearFar.setXY(t.camera.getNearPlane(),t.camera.getFarPlane()),e.srgbOut=!1,e.blit(h.getColorAttachments()[0],l,Gl("clamp_linear_nomip"))}combine(t,e,i,s){const r=t.device;let a=af._combineProgram;void 0===a&&(a=this._createCombineProgrm(t),af._combineProgram=a),this._combineBindGroup||(this._combineBindGroup=r.createBindGroup(a.bindGroupLayouts[0]));const n=Gl("clamp_linear");this._combineBindGroup.setTexture("colorTex",e,n),this._combineBindGroup.setTexture("reflectanceTex",i,n),this._combineBindGroup.setTexture("roughnessTex",t.SSRRoughnessTexture,n),this._combineBindGroup.setValue("ssrMaxRoughness",t.camera.ssrMaxRoughness),this._combineBindGroup.setValue("targetSize",new O(r.getDrawingBufferWidth(),r.getDrawingBufferHeight(),r.getDrawingBufferWidth(),r.getDrawingBufferHeight())),this._combineBindGroup.setValue("flip",this.needFlip(r)?1:0),this._combineBindGroup.setValue("srgbOut",s?1:0),r.setProgram(a),r.setBindGroup(0,this._combineBindGroup),this.drawFullscreenQuad(Nm.getDefaultRenderState(t,"gt"))}resolve(t,e,i,s){const r=t.device,a=t.env.light.envLight?t.env.light.getHash():"";let n=af._resolveProgram[a];void 0===n&&(n=this._createResolveProgram(t),af._resolveProgram[a]=n);let o=this._resolveBindGroup[a];o||(o=r.createBindGroup(n.bindGroupLayouts[0]),this._resolveBindGroup[a]=o);const h=Gl("clamp_nearest"),l=Gl("clamp_linear");o.setTexture("colorTex",e,l),o.setTexture("intersectTex",s,h),o.setTexture("roughnessTex",t.SSRRoughnessTexture,h),o.setTexture("normalTex",t.SSRNormalTexture,h),o.setTexture("depthTex",i,h),o.setValue("ssrMaxRoughness",t.camera.ssrMaxRoughness),o.setValue("cameraNearFar",new L(t.camera.getNearPlane(),t.camera.getFarPlane())),o.setValue("targetSize",new O(r.getDrawingBufferWidth(),r.getDrawingBufferHeight(),i.width,i.height)),o.setValue("invProjMatrix",W.invert(t.camera.getProjectionMatrix())),o.setValue("viewMatrix",t.camera.viewMatrix),o.setValue("invViewMatrix",t.camera.worldMatrix),t.env.light.envLight&&(o.setValue("envLightStrength",t.env.light.strength),t.env.light.envLight.updateBindGroup(o)),o.setValue("flip",this.needFlip(r)?1:0),r.setProgram(n),r.setBindGroup(0,o),this.drawFullscreenQuad(Nm.getDefaultRenderState(t,"gt"))}intersect(t,e,i,s,r){const a=t.device,n=`${Number(s)}:${t.env.light.envLight?t.env.light.getHash():""}:${!!t.HiZTexture}:${!!t.primaryCamera.ssrCalcThickness}`;let o=af._programs[n];void 0===o&&(o=this._createIntersectProgram(t,s),af._programs[n]=o);let h=this._bindgroups[n];h||(h=a.createBindGroup(o.bindGroupLayouts[0]),this._bindgroups[n]=h);const l=Gl("clamp_nearest"),u=Gl("clamp_linear");s||(h.setTexture("colorTex",e,u),t.env.light.envLight&&(h.setValue("envLightStrength",t.env.light.strength),t.env.light.envLight.updateBindGroup(h))),h.setTexture("roughnessTex",t.SSRRoughnessTexture,l),h.setTexture("normalTex",t.SSRNormalTexture,l),h.setTexture("depthTex",i,l),h.setValue("cameraNearFar",new L(t.camera.getNearPlane(),t.camera.getFarPlane())),h.setValue("cameraPos",t.camera.getWorldPosition()),h.setValue("invProjMatrix",W.invert(t.camera.getProjectionMatrix())),h.setValue("projMatrix",t.camera.getProjectionMatrix()),h.setValue("viewMatrix",t.camera.viewMatrix),h.setValue("invViewMatrix",t.camera.worldMatrix),h.setValue("ssrParams",t.camera.ssrParams),h.setValue("ssrMaxRoughness",t.camera.ssrMaxRoughness),t.HiZTexture?(h.setTexture("hizTex",t.HiZTexture,l),h.setValue("depthMipLevels",t.HiZTexture.mipLevelCount),h.setValue("targetSize",new O(a.getDrawingBufferWidth(),a.getDrawingBufferHeight(),t.HiZTexture.width,t.HiZTexture.height))):(h.setValue("ssrStride",t.camera.ssrStride),h.setValue("targetSize",new O(a.getDrawingBufferWidth(),a.getDrawingBufferHeight(),i.width,i.height))),h.setValue("flip",this.needFlip(a)?1:0),h.setValue("srgbOut",r?1:0),a.setProgram(o),a.setBindGroup(0,h),this.drawFullscreenQuad(Nm.getDefaultRenderState(t,"gt"))}apply(t,e,i,s){const r=t.device;r.pushDeviceStates(),Hl(e,r.getFramebuffer(),Gl("clamp_nearest_nomip"),Nm.getDefaultRenderState(t,"eq"));const a=r.pool.fetchTemporalFramebuffer(!1,e.width,e.height,"rgba16f",t.depthTexture,!1),n=[r.pool.fetchTemporalFramebuffer(!1,e.width,e.height,"rgba16f",t.depthTexture,!1),r.pool.fetchTemporalFramebuffer(!1,e.width,e.height,"rgba16f",t.depthTexture,!1)];r.setFramebuffer(a),this.intersect(t,e,i,!0,!1);const o=a.getColorAttachments()[0];if(r.setFramebuffer(n[0]),this.resolve(t,e,i,o),t.camera.ssrBlurScale>0&&t.camera.ssrBlurKernelSize>0){const e=255*t.camera.ssrBlurScale,i=Math.max(1,t.camera.ssrBlurKernelSize|0)-1>>1,s=t.camera.ssrBlurStdDev,r=t.camera.ssrBlurDepthCutoff,a=af._blurBlitterH=af._blurBlitterH??new rf(!1);a.renderStates=Nm.getDefaultRenderState(t,"gt"),this.blurPass(t,a,o,2,e,i,s,r,n[0],n[1]);const h=af._blurBlitterV=af._blurBlitterV??new rf(!0);h.renderStates=Nm.getDefaultRenderState(t,"gt"),this.blurPass(t,h,o,2,e,i,s,r,n[1],n[0])}r.popDeviceStates(),this.combine(t,e,n[0].getColorAttachments()[0],s),r.pool.releaseFrameBuffer(a),r.pool.releaseFrameBuffer(n[0]),r.pool.releaseFrameBuffer(n[1])}_createCombineProgrm(t){const e=t.device.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,1,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){this.colorTex=t.tex2D().uniform(0),this.reflectanceTex=t.tex2D().uniform(0),this.roughnessTex=t.tex2D().uniform(0),this.targetSize=t.vec4().uniform(0),this.ssrMaxRoughness=t.float().uniform(0),this.srgbOut=t.int().uniform(0),this.$outputs.outColor=t.vec4(),t.func("resolveSample",[t.vec3("sceneColor"),t.vec3("reflectance"),t.vec4("roughnessValue")],function(){this.$l.r=t.div(this.reflectance,t.add(this.reflectance,t.vec3(1))),this.$l.strength=t.clamp(this.roughnessValue.rgb,t.vec3(0),t.vec3(1)),this.color=t.add(t.mul(this.r,this.strength),t.mul(this.sceneColor,t.sub(t.vec3(1),this.strength))),this.$return(this.color)}),t.main(function(){this.$l.screenUV=t.div(t.vec2(this.$builtins.fragCoord.xy),this.targetSize.xy),this.$l.sceneColor=t.textureSampleLevel(this.colorTex,this.screenUV,0).rgb,this.$l.roughnessInfo=t.textureSampleLevel(this.roughnessTex,this.screenUV,0),this.$l.combined=t.vec3(),this.$if(t.greaterThanEqual(this.roughnessInfo.a,this.ssrMaxRoughness),function(){this.combined=this.sceneColor}).$else(function(){this.$l.reflectance=t.textureSampleLevel(this.reflectanceTex,this.screenUV,0).rgb,this.combined=this.resolveSample(this.sceneColor,this.reflectance,this.roughnessInfo)}),this.$if(t.equal(this.srgbOut,0),function(){this.$outputs.outColor=t.vec4(this.combined,1)}).$else(function(){this.$outputs.outColor=t.vec4(Il(this,this.combined),1)})})}});return e.name="@SSR_Combine",e}_createResolveProgram(t){const e=t.device.buildRenderProgram({vertex(e){this.flip=e.int().uniform(0),this.$inputs.pos=e.vec2().attrib("position"),this.$outputs.uv=e.vec2(),t.env.light.envLight&&t.env.light.envLight.initShaderBindings(e),e.main(function(){this.$builtins.position=e.vec4(this.$inputs.pos,1,1),this.$outputs.uv=e.add(e.mul(this.$inputs.pos.xy,.5),e.vec2(.5)),this.$if(e.notEqual(this.flip,0),function(){this.$builtins.position.y=e.neg(this.$builtins.position.y)})})},fragment(e){this.colorTex=e.tex2D().uniform(0),this.intersectTex=e.tex2D().uniform(0),this.roughnessTex=e.tex2D().uniform(0),this.normalTex=e.tex2D().uniform(0),this.depthTex=e.tex2D().uniform(0),this.cameraNearFar=e.vec2().uniform(0),this.targetSize=e.vec4().uniform(0),this.viewMatrix=e.mat4().uniform(0),this.invViewMatrix=e.mat4().uniform(0),this.invProjMatrix=e.mat4().uniform(0),this.ssrMaxRoughness=e.float().uniform(0),t.env.light.envLight&&(this.envLightStrength=e.float().uniform(0),t.env.light.envLight.initShaderBindings(e)),this.$outputs.outColor=e.vec4(),e.func("getPosition",[e.vec2("uv"),e.mat4("mat")],function(){this.$l.linearDepth=Qc.sampleLinearDepth(this,this.depthTex,this.uv,0),this.$l.nonLinearDepth=e.div(e.sub(e.div(this.cameraNearFar.x,this.linearDepth),this.cameraNearFar.y),e.sub(this.cameraNearFar.x,this.cameraNearFar.y)),this.$l.clipSpacePos=e.vec4(e.sub(e.mul(this.uv,2),e.vec2(1)),e.sub(e.mul(e.clamp(this.nonLinearDepth,0,1),2),1),1),this.$l.wPos=e.mul(this.mat,this.clipSpacePos),this.$return(e.vec4(e.div(this.wPos.xyz,this.wPos.w),this.linearDepth))}),e.func("resolveSample",[e.vec3("sceneColor"),e.vec3("reflectance"),e.vec4("roughnessValue")],function(){this.$l.r=e.div(this.reflectance,e.add(this.reflectance,e.vec3(1))),this.$l.strength=e.clamp(this.roughnessValue.rgb,e.vec3(0),e.vec3(1)),this.color=e.add(e.mul(this.r,this.strength),e.mul(this.sceneColor,e.sub(e.vec3(1),this.strength))),this.$return(this.color)}),e.func("resolveEnvRadiance",[e.vec2("uv"),e.vec4("roughnessInfo")],function(){t.env.light.envLight?(this.$l.pos=this.getPosition(this.uv,this.invProjMatrix),this.$if(e.greaterThanEqual(this.pos.w,1),function(){this.$return(e.vec3(0))}),this.$l.roughness=this.roughnessInfo.a,this.$l.viewPos=this.pos.xyz,this.$l.worldNormal=e.sub(e.mul(e.textureSampleLevel(this.normalTex,this.uv,0).rgb,2),e.vec3(1)),this.$l.viewVec=e.normalize(this.viewPos),this.$l.viewNormal=e.mul(this.viewMatrix,e.vec4(this.worldNormal,0)).xyz,this.$l.reflectVec=e.add(e.reflect(this.viewVec,this.viewNormal),Km(this,this.viewPos,this.roughness)),this.$l.reflectVecW=e.mul(this.invViewMatrix,e.vec4(this.reflectVec,0)).xyz,this.$l.roughness2=e.float(0),this.$l.env=e.mul(t.env.light.envLight.getRadiance(this,this.reflectVecW,this.roughness2),this.envLightStrength),this.$return(e.min(this.env,e.vec3(1)))):this.$return(e.vec3(0))}),e.func("resolveReflectance",[e.vec2("uv"),e.vec3("reflectSceneColor"),e.vec4("roughnessInfo"),e.float("alpha")],function(){this.$l.env=this.resolveEnvRadiance(this.uv,this.roughnessInfo),this.$l.reflectance=e.mix(this.env,this.reflectSceneColor,this.alpha),this.$return(this.reflectance)}),e.main(function(){this.$l.screenUV=e.div(e.vec2(this.$builtins.fragCoord.xy),this.targetSize.xy),this.$l.roughnessInfo=e.textureSampleLevel(this.roughnessTex,this.screenUV,0),this.$if(e.greaterThanEqual(this.roughnessInfo.a,this.ssrMaxRoughness),function(){e.discard()}),this.$l.intersectSample=e.textureSampleLevel(this.intersectTex,this.screenUV,0),this.$l.reflectance=e.vec3(),this.$if(e.greaterThan(this.intersectSample.w,0),function(){this.$l.indirectIntersectSample=e.textureSampleLevel(this.intersectTex,this.intersectSample.xy,0),this.$l.indirectRoughnessInfo=e.textureSampleLevel(this.roughnessTex,this.intersectSample.xy,0),this.$l.indirectReflectance=e.vec3(),this.$if(e.greaterThan(this.indirectIntersectSample.w,0),function(){this.$l.indirectReflectSceneColor=e.textureSampleLevel(this.colorTex,this.indirectIntersectSample.xy,0).rgb,this.indirectReflectance=this.resolveReflectance(this.intersectSample.xy,this.indirectReflectSceneColor,this.indirectRoughnessInfo,this.indirectIntersectSample.w)}).$else(function(){this.indirectReflectance=this.resolveEnvRadiance(this.intersectSample.xy,this.indirectRoughnessInfo)}),this.$l.reflectSceneColor=e.textureSampleLevel(this.colorTex,this.intersectSample.xy,0).rgb,this.$l.reflectSceneColor=this.resolveSample(this.reflectSceneColor,this.indirectReflectance,this.indirectRoughnessInfo),this.reflectance=this.resolveReflectance(this.screenUV,this.reflectSceneColor,this.roughnessInfo,this.intersectSample.w)}).$else(function(){this.reflectance=this.resolveEnvRadiance(this.screenUV,this.roughnessInfo)}),this.$outputs.outColor=e.vec4(this.reflectance,this.intersectSample.z)})}});return e.name="@SSR_Resolve",e}_createIntersectProgram(t,e){const i=t.device.buildRenderProgram({vertex(i){this.flip=i.int().uniform(0),this.$inputs.pos=i.vec2().attrib("position"),this.$outputs.uv=i.vec2(),!e&&t.env.light.envLight&&t.env.light.envLight.initShaderBindings(i),i.main(function(){this.$builtins.position=i.vec4(this.$inputs.pos,1,1),this.$outputs.uv=i.add(i.mul(this.$inputs.pos.xy,.5),i.vec2(.5)),this.$if(i.notEqual(this.flip,0),function(){this.$builtins.position.y=i.neg(this.$builtins.position.y)})})},fragment(i){e||(this.colorTex=i.tex2D().uniform(0),t.env.light.envLight&&(this.envLightStrength=i.float().uniform(0),t.env.light.envLight.initShaderBindings(i))),this.roughnessTex=i.tex2D().uniform(0),this.normalTex=i.tex2D().uniform(0),this.depthTex=i.tex2D().uniform(0),this.cameraNearFar=i.vec2().uniform(0),this.cameraPos=i.vec3().uniform(0),this.invProjMatrix=i.mat4().uniform(0),this.projMatrix=i.mat4().uniform(0),this.viewMatrix=i.mat4().uniform(0),this.invViewMatrix=i.mat4().uniform(0),this.ssrParams=i.vec4().uniform(0),this.ssrMaxRoughness=i.float().uniform(0),this.targetSize=i.vec4().uniform(0),t.HiZTexture?(this.hizTex=i.tex2D().uniform(0),this.depthMipLevels=i.int().uniform(0)):this.ssrStride=i.float().uniform(0),this.srgbOut=i.int().uniform(0),this.$outputs.outColor=i.vec4(),i.func("getPosition",[i.vec2("uv"),i.mat4("mat")],function(){this.$l.linearDepth=Qc.sampleLinearDepth(this,this.depthTex,this.uv,0),this.$l.nonLinearDepth=i.div(i.sub(i.div(this.cameraNearFar.x,this.linearDepth),this.cameraNearFar.y),i.sub(this.cameraNearFar.x,this.cameraNearFar.y)),this.$l.clipSpacePos=i.vec4(i.sub(i.mul(this.uv,2),i.vec2(1)),i.sub(i.mul(i.clamp(this.nonLinearDepth,0,1),2),1),1),this.$l.wPos=i.mul(this.mat,this.clipSpacePos),this.$return(i.vec4(i.div(this.wPos.xyz,this.wPos.w),this.linearDepth))}),i.main(function(){this.$l.screenUV=i.div(i.vec2(this.$builtins.fragCoord.xy),this.targetSize.xy),this.$l.roughnessValue=i.textureSampleLevel(this.roughnessTex,this.screenUV,0),this.$l.roughness=this.roughnessValue.a,this.$if(i.greaterThanEqual(this.roughness,this.ssrMaxRoughness),function(){i.discard()}),e||(this.$l.sceneColor=i.textureSampleLevel(this.colorTex,this.screenUV,0).rgb),this.$l.pos=this.getPosition(this.screenUV,this.invProjMatrix),this.$l.linearDepth=this.pos.w,this.$l.color=i.vec3(0),this.$l.a=i.float(),this.$if(i.greaterThanEqual(this.linearDepth,1),function(){e||(this.color=this.sceneColor,this.a=1)}).$else(function(){this.$l.viewPos=this.pos.xyz,this.$l.worldNormal=i.sub(i.mul(i.textureSampleLevel(this.normalTex,this.screenUV,0).rgb,2),i.vec3(1)),this.$l.viewVec=i.normalize(this.viewPos),this.$l.viewNormal=i.mul(this.viewMatrix,i.vec4(this.worldNormal,0)).xyz,this.$l.reflectVec=i.add(i.reflect(this.viewVec,this.viewNormal),Km(this,this.viewPos,this.roughness)),this.$l.hitInfo=t.HiZTexture?sf(this,this.viewPos,this.reflectVec,this.viewMatrix,this.projMatrix,this.invProjMatrix,this.cameraNearFar,this.depthMipLevels,this.ssrParams.y,this.ssrParams.z,this.targetSize,this.hizTex,this.normalTex):ef(this,this.viewPos,this.reflectVec,this.viewMatrix,this.projMatrix,this.invProjMatrix,this.cameraNearFar,this.ssrParams.x,this.ssrParams.y,this.ssrParams.z,this.ssrStride,this.targetSize,this.depthTex,this.normalTex,!!t.primaryCamera.ssrCalcThickness),e?(this.blurRadius=i.float(0),this.$if(i.greaterThan(this.roughness,.001),function(){this.$l.coneAngle=i.mul(i.min(this.roughness,.999),.5*Math.PI),this.$l.coneLen=this.$choice(i.greaterThan(this.hitInfo.w,0),this.hitInfo.z,i.min(this.targetSize.z,this.targetSize.w)),this.$l.opLen=i.mul(i.tan(this.coneAngle),this.coneLen,2),this.$l.a2=i.mul(this.opLen,this.opLen),this.$l.fh2=i.mul(this.coneLen,this.coneLen,4),this.blurRadius=i.div(i.mul(this.opLen,i.sub(i.sqrt(i.add(this.a2,this.fh2)),this.opLen)),i.mul(this.coneLen,4))}),this.a=this.hitInfo.w,this.color=i.vec3(this.hitInfo.xy,i.clamp(i.div(this.blurRadius,255),0,1))):(t.env.light.envLight?(this.$l.reflectVecW=i.mul(this.invViewMatrix,i.vec4(this.reflectVec,0)).xyz,this.$l.env=i.mul(t.env.light.envLight.getRadiance(this,this.reflectVecW,this.roughness),this.envLightStrength)):this.$l.env=i.vec3(0),this.$l.reflectance=i.mix(this.env,i.textureSampleLevel(this.colorTex,this.hitInfo.xy,0).rgb,this.hitInfo.w),this.reflectance=i.div(this.reflectance,i.add(this.reflectance,i.vec3(1))),this.$l.strength=i.clamp(this.roughnessValue.rgb,i.vec3(0),i.vec3(1)),this.color=i.add(i.mul(this.reflectance,this.strength),i.mul(this.sceneColor,i.sub(i.vec3(1),this.strength))))}),this.$if(i.equal(this.srgbOut,0),function(){this.$outputs.outColor=i.vec4(this.color,this.a)}).$else(function(){this.$outputs.outColor=i.vec4(Il(this,this.color),this.a)})})}});return i.name=e?"@SSR_Intersect_Blur":"@SSR_Intersect",i}}class nf extends Nm{static _programTonemap=null;static _bindgroupTonemap=null;_exposure;constructor(){super(),this._layer=Dm.transparent,this._exposure=1}get exposure(){return this._exposure}set exposure(t){this._exposure=t}requireLinearDepthTexture(){return!1}requireDepthAttachment(){return!1}apply(t,e,i,s){const r=t.device;this._prepare(r,e),this._tonemap(r,e,s)}_tonemap(t,e,i){nf._bindgroupTonemap.setValue("srgbOut",i?1:0),nf._bindgroupTonemap.setValue("exposure",this._exposure),nf._bindgroupTonemap.setValue("flip",this.needFlip(t)?1:0),nf._bindgroupTonemap.setTexture("tex",e,Gl("clamp_nearest_nomip")),t.setProgram(nf._programTonemap),t.setBindGroup(0,nf._bindgroupTonemap),this.drawFullscreenQuad()}_prepare(t,e){nf._programTonemap||(nf._programTonemap=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){this.srgbOut=t.int().uniform(0),this.exposure=t.float().uniform(0),this.tex=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.func("RRTAndODTFit",[t.vec3("v")],function(){this.$l.a=t.sub(t.mul(this.v,t.add(this.v,t.vec3(.0245786))),t.vec3(90537e-9)),this.$l.b=t.add(t.mul(this.v,t.add(t.mul(this.v,.983729),t.vec3(.432951))),t.vec3(.238081)),this.$return(t.div(this.a,this.b))}),t.main(function(){this.$l.vSample=t.textureSample(this.tex,this.$inputs.uv),this.$l.ACESInputMat=t.mat3(.59719,.076,.0284,.35458,.90834,.13383,.04823,.01566,.83777),this.$l.ACESOutputMat=t.mat3(1.60475,-.10208,-.00327,-.53108,1.10813,-.07276,-.07367,-.00605,1.07602),this.$l.color=t.mul(this.vSample.rgb,t.div(this.exposure,.6)),this.color=t.mul(this.ACESInputMat,this.color),this.color=this.RRTAndODTFit(this.color),this.color=t.mul(this.ACESOutputMat,this.color),this.color=t.clamp(this.color,t.vec3(0),t.vec3(1)),this.$if(t.notEqual(this.srgbOut,0),function(){this.$l.color=Il(this,this.color)}),this.$outputs.outColor=t.vec4(this.color,1)})}}),nf._programTonemap.name="@Tonemap",nf._bindgroupTonemap=t.createBindGroup(nf._programTonemap.bindGroupLayouts[0]))}}class of extends Nm{static _program=null;static _bindgroup=null;_invTexSize;constructor(){super(),this._layer=Dm.transparent,this._invTexSize=new L}requireLinearDepthTexture(){return!1}requireDepthAttachment(){return!1}apply(t,e,i,s){const r=t.device;this._prepare(r),this._invTexSize.setXY(1/e.width,1/e.height),of._bindgroup.setTexture("srcTex",e,Gl("clamp_linear_nomip")),of._bindgroup.setValue("flip",this.needFlip(r)?1:0),of._bindgroup.setValue("srgbOut",s?1:0),of._bindgroup.setValue("invTexSize",this._invTexSize),r.setProgram(of._program),r.setBindGroup(0,of._bindgroup),this.drawFullscreenQuad()}_prepare(t){of._program||(of._program=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){this.srcTex=t.tex2D().uniform(0),this.srgbOut=t.int().uniform(0),this.invTexSize=t.vec2().uniform(0),this.$outputs.outColor=t.vec4(),t.func("getLuma",[t.vec3("vSample")],function(){this.$return(t.dot(this.vSample,t.vec3(.299,.587,.114)))}),t.func("FXAA",[t.vec2("uv")],function(){this.$l.posM=this.uv,this.$l.rgbyM=t.textureSampleLevel(this.srcTex,this.uv,0),this.$l.lumaM=this.getLuma(this.rgbyM.rgb),this.$l.lumaN=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(0,-1),this.invTexSize)),0).rgb),this.$l.lumaW=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(-1,0),this.invTexSize)),0).rgb),this.$l.lumaE=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(1,0),this.invTexSize)),0).rgb),this.$l.lumaS=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(0,1),this.invTexSize)),0).rgb),this.$l.rangeMin=t.min(this.lumaM,t.min(t.min(this.lumaN,this.lumaW),t.min(this.lumaS,this.lumaE))),this.$l.rangeMax=t.max(this.lumaM,t.max(t.max(this.lumaN,this.lumaW),t.max(this.lumaS,this.lumaE))),this.$l.range=t.sub(this.rangeMax,this.rangeMin),this.$if(t.lessThan(this.range,t.max(1/16,t.div(this.rangeMax,8))),function(){this.$return(this.rgbyM)}),this.$l.lumaNW=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(-1,-1),this.invTexSize)),0).rgb),this.$l.lumaNE=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(1,-1),this.invTexSize)),0).rgb),this.$l.lumaSW=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(-1,1),this.invTexSize)),0).rgb),this.$l.lumaSE=this.getLuma(t.textureSampleLevel(this.srcTex,t.add(this.uv,t.mul(t.vec2(1,1),this.invTexSize)),0).rgb),this.$l.lumaNS=t.add(this.lumaN,this.lumaS),this.$l.lumaWE=t.add(this.lumaW,this.lumaE),this.$l.subpixRcpRange=t.div(1,this.range),this.$l.subpixNSWE=t.add(this.lumaNS,this.lumaWE),this.$l.edgeHorz1=t.add(t.mul(-2,this.lumaM),this.lumaNS),this.$l.edgeVert1=t.add(t.mul(-2,this.lumaM),this.lumaWE),this.$l.lumaNESE=t.add(this.lumaNE,this.lumaSE),this.$l.lumaNWNE=t.add(this.lumaNW,this.lumaNE),this.$l.edgeHorz2=t.add(t.mul(-2,this.lumaE),this.lumaNESE),this.$l.edgeVert2=t.add(t.mul(-2,this.lumaN),this.lumaNWNE),this.$l.lumaNWSW=t.add(this.lumaNW,this.lumaSW),this.$l.lumaSWSE=t.add(this.lumaSW,this.lumaSE),this.$l.edgeHorz4=t.add(t.mul(t.abs(this.edgeHorz1),2),t.abs(this.edgeHorz2)),this.$l.edgeVert4=t.add(t.mul(t.abs(this.edgeVert1),2),t.abs(this.edgeVert2)),this.$l.edgeHorz3=t.add(t.mul(-2,this.lumaW),this.lumaNWSW),this.$l.edgeVert3=t.add(t.mul(-2,this.lumaS),this.lumaSWSE),this.$l.edgeHorz=t.add(t.abs(this.edgeHorz3),this.edgeHorz4),this.$l.edgeVert=t.add(t.abs(this.edgeVert3),this.edgeVert4),this.$l.subpixNWSWNESE=t.add(this.lumaNWSW,this.lumaNESE),this.$l.lengthSign=this.invTexSize.x,this.$l.horzSpan=t.greaterThanEqual(this.edgeHorz,this.edgeVert),this.$l.subpixA=t.add(t.mul(this.subpixNSWE,2),this.subpixNWSWNESE),this.$if(t.not(this.horzSpan),function(){this.lumaN=this.lumaW,this.lumaS=this.lumaE}).$else(function(){this.lengthSign=this.invTexSize.y}),this.$l.subpixB=t.sub(t.div(this.subpixA,12),this.lumaM),this.$l.gradientN=t.sub(this.lumaN,this.lumaM),this.$l.gradientS=t.sub(this.lumaS,this.lumaM),this.$l.lumaNN=t.add(this.lumaN,this.lumaM),this.$l.lumaSS=t.add(this.lumaS,this.lumaM),this.$l.pairN=t.greaterThanEqual(t.abs(this.gradientN),t.abs(this.gradientS)),this.$l.gradient=t.max(t.abs(this.gradientN),t.abs(this.gradientS)),this.$if(this.pairN,function(){this.lengthSign=t.neg(this.lengthSign)}),this.$l.subpixC=t.clamp(t.mul(t.abs(this.subpixB),this.subpixRcpRange),0,1),this.$l.posB=this.posM,this.$l.offNP=t.vec2(),this.$if(t.not(this.horzSpan),function(){this.offNP.x=0,this.offNP.y=this.invTexSize.y,this.posB.x=t.add(this.posB.x,t.mul(this.lengthSign,.5))}).$else(function(){this.offNP.x=this.invTexSize.x,this.offNP.y=0,this.posB.y=t.add(this.posB.y,t.mul(this.lengthSign,.5))}),this.$l.posN=t.sub(this.posB,this.offNP),this.$l.posP=t.add(this.posB,this.offNP),this.$l.subpixD=t.add(t.mul(-2,this.subpixC),3),this.$l.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN,0).rgb),this.$l.subpixE=t.mul(this.subpixC,this.subpixC),this.$l.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP,0).rgb),this.$if(t.not(this.pairN),function(){this.lumaNN=this.lumaSS}),this.$l.gradientScaled=t.div(this.gradient,4),this.$l.lumaMM=t.sub(this.lumaM,t.mul(this.lumaNN,.5)),this.$l.subpixF=t.mul(this.subpixD,this.subpixE),this.$l.lumaMLTZero=t.lessThan(this.lumaMM,0),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5)),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5)),this.$l.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.$l.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),function(){this.posN=t.sub(this.posN,t.mul(this.offNP,1.5))}),this.$l.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),function(){this.posP=t.add(this.posP,t.mul(this.offNP,1.5))}),this.$if(this.doneNP,function(){this.$if(t.not(this.doneN),function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))}),this.$if(t.not(this.doneP),function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))}),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),function(){this.posN=t.sub(this.posN,t.mul(this.offNP,2))}),this.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),function(){this.posP=t.add(this.posP,t.mul(this.offNP,2))}),this.$if(this.doneNP,function(){this.$if(t.not(this.doneN),function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))}),this.$if(t.not(this.doneP),function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))}),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),function(){this.posN=t.sub(this.posN,t.mul(this.offNP,2))}),this.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),function(){this.posP=t.add(this.posP,t.mul(this.offNP,2))}),this.$if(this.doneNP,function(){this.$if(t.not(this.doneN),function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))}),this.$if(t.not(this.doneP),function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))}),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),function(){this.posN=t.sub(this.posN,t.mul(this.offNP,4))}),this.doneNP=t.or(t.not(this.doneN),t.not(this.doneP)),this.$if(t.not(this.doneP),function(){this.posP=t.add(this.posP,t.mul(this.offNP,4))}),this.$if(this.doneNP,function(){this.$if(t.not(this.doneN),function(){this.lumaEndN=this.getLuma(t.textureSampleLevel(this.srcTex,this.posN.xy,0).rgb),this.lumaEndN=t.sub(this.lumaEndN,t.mul(this.lumaNN,.5))}),this.$if(t.not(this.doneP),function(){this.lumaEndP=this.getLuma(t.textureSampleLevel(this.srcTex,this.posP.xy,0).rgb),this.lumaEndP=t.sub(this.lumaEndP,t.mul(this.lumaNN,.5))}),this.doneN=t.greaterThanEqual(t.abs(this.lumaEndN),this.gradientScaled),this.doneP=t.greaterThanEqual(t.abs(this.lumaEndP),this.gradientScaled),this.$if(t.not(this.doneN),function(){this.posN=t.sub(this.posN,t.mul(this.offNP,2))}),this.$if(t.not(this.doneP),function(){this.posP=t.add(this.posP,t.mul(this.offNP,2))})})})})}),this.$l.dstN=t.sub(this.posM.x,this.posN.x),this.$l.dstP=t.sub(this.posP.x,this.posM.x),this.$if(t.not(this.horzSpan),function(){this.dstN=t.sub(this.posM.y,this.posN.y),this.dstP=t.sub(this.posP.y,this.posM.y)}),this.$l.goodSpanN=t.notEqual(t.lessThan(this.lumaEndN,0),this.lumaMLTZero),this.$l.spanLength=t.add(this.dstP,this.dstN),this.$l.goodSpanP=t.notEqual(t.lessThan(this.lumaEndP,0),this.lumaMLTZero),this.$l.spanLengthRcp=t.div(1,this.spanLength),this.$l.directionN=t.lessThan(this.dstN,this.dstP),this.$l.dst=t.min(this.dstN,this.dstP),this.$l.goodSpan=this.$choice(this.directionN,this.goodSpanN,this.goodSpanP),this.$l.subpixG=t.mul(this.subpixF,this.subpixF),this.$l.pixelOffset=t.add(t.mul(this.dst,t.neg(this.spanLengthRcp)),.5),this.$l.subpixH=t.mul(this.subpixG,.75),this.$l.pixelOffsetGood=this.$choice(this.goodSpan,this.pixelOffset,0),this.$l.pixelOffsetSubpix=t.max(this.pixelOffsetGood,this.subpixH),this.$if(t.not(this.horzSpan),function(){this.posM.x=t.add(this.posM.x,t.mul(this.pixelOffsetSubpix,this.lengthSign))}).$else(function(){this.posM.y=t.add(this.posM.y,t.mul(this.pixelOffsetSubpix,this.lengthSign))}),this.$return(t.textureSampleLevel(this.srcTex,this.posM,0).xyzw)}),t.main(function(){this.$l.color=this.FXAA(this.$inputs.uv),this.$if(t.equal(this.srgbOut,0),function(){this.$outputs.outColor=this.color}).$else(function(){this.$outputs.outColor=t.vec4(Il(this,this.color.rgb),this.color.a)})})}}),of._program.name="@FXAA_program",of._bindgroup=t.createBindGroup(of._program.bindGroupLayouts[0]))}}class hf extends Nm{static className="Bloom";static _programDownsampleH=null;static _programDownsampleV=null;static _programUpsample=null;static _programFinalCompose=null;static _programPrefilter=null;static _renderStateAdditive=null;static _bindgroupDownsampleH=null;static _bindgroupDownsampleV=null;static _bindgroupUpsample=null;static _bindgroupFinalCompose=null;static _bindgroupPrefilter=null;_thresholdValue;_invTexSize;_maxDownsampleLevels;_downsampleLimit;_threshold;_thresholdKnee;_intensity;constructor(){super(),this._layer=Dm.transparent,this._thresholdValue=new O,this._invTexSize=new L,this._maxDownsampleLevels=4,this._downsampleLimit=32,this._threshold=.8,this._thresholdKnee=0,this._intensity=1}get maxDownsampleLevel(){return this._maxDownsampleLevels}set maxDownsampleLevel(t){this._maxDownsampleLevels=t}get downsampleLimit(){return this._downsampleLimit}set downsampleLimit(t){this._downsampleLimit=t}get threshold(){return this._threshold}set threshold(t){this._threshold=t}get thresholdKnee(){return this._thresholdKnee}set thresholdKnee(t){this._thresholdKnee=t}get intensity(){return this._intensity}set intensity(t){this._intensity=t}requireLinearDepthTexture(){return!1}requireDepthAttachment(){return!1}apply(t,e,i,s){const r=t.device,a=[];this._prepare(r,e),r.pushDeviceStates();const n=Math.max(e.width>>1,1),o=Math.max(e.height>>1,1),h=r.pool.fetchTemporalTexture2D(!1,e.format,n,o,!1);this.prefilter(r,e,h),this.downsample(r,h,a),this.upsample(r,a),r.popDeviceStates(),this.finalCompose(r,e,a[0]);for(const t of a)r.pool.releaseTexture(t);r.pool.releaseTexture(h)}prefilter(t,e,i){this._thresholdValue.x=this._threshold*this._threshold,this._thresholdValue.y=this._thresholdValue.x*this._thresholdKnee,this._thresholdValue.z=2*this._thresholdValue.y,this._thresholdValue.w=.25/(this._thresholdValue.y+1e-5),this._thresholdValue.y-=this._thresholdValue.x,t.setFramebuffer([i]),t.setProgram(hf._programPrefilter),t.setBindGroup(0,hf._bindgroupPrefilter),hf._bindgroupPrefilter.setTexture("tex",e),hf._bindgroupPrefilter.setValue("flip","webgpu"===t.type?1:0),hf._bindgroupPrefilter.setValue("threshold",this._thresholdValue),this.drawFullscreenQuad()}finalCompose(t,e,i){t.setProgram(hf._programFinalCompose),t.setBindGroup(0,hf._bindgroupFinalCompose),hf._bindgroupFinalCompose.setTexture("srcTex",e),hf._bindgroupFinalCompose.setTexture("bloomTex",i),hf._bindgroupFinalCompose.setValue("intensity",this._intensity),hf._bindgroupFinalCompose.setValue("flip","webgpu"===t.type&&t.getFramebuffer()?1:0),this.drawFullscreenQuad()}upsample(t,e){t.setProgram(hf._programUpsample),t.setBindGroup(0,hf._bindgroupUpsample),hf._bindgroupUpsample.setValue("flip","webgpu"===t.type?1:0);for(let i=e.length-2;i>=0;i--)hf._bindgroupUpsample.setTexture("tex",e[i+1]),t.setFramebuffer([e[i]]),this.drawFullscreenQuad(hf._renderStateAdditive)}downsample(t,e,i){const s=Math.max(2,this._downsampleLimit);let r=Math.max(s,e.width>>1),a=Math.max(s,e.height>>1),n=Math.max(this._maxDownsampleLevels,1),o=e;for(hf._bindgroupDownsampleH.setValue("flip","webgpu"===t.type?1:0),hf._bindgroupDownsampleV.setValue("flip","webgpu"===t.type?1:0);(r>=s||a>=s)&&n>0;){const s=t.pool.fetchTemporalTexture2D(!1,e.format,r,a,!1);i.push(s);const h=t.pool.fetchTemporalTexture2D(!1,e.format,r,a,!1);this._invTexSize.setXY(1/o.width,1/o.height),t.setFramebuffer([h]),t.setProgram(hf._programDownsampleH),t.setBindGroup(0,hf._bindgroupDownsampleH),hf._bindgroupDownsampleH.setTexture("tex",o),hf._bindgroupDownsampleH.setValue("invTexSize",this._invTexSize),this.drawFullscreenQuad(),this._invTexSize.setXY(1/h.width,1/h.height),t.setFramebuffer([s]),t.setProgram(hf._programDownsampleV),t.setBindGroup(0,hf._bindgroupDownsampleV),hf._bindgroupDownsampleV.setTexture("tex",h),hf._bindgroupDownsampleV.setValue("invTexSize",this._invTexSize),this.drawFullscreenQuad(),n--,r=Math.max(1,r>>1),a=Math.max(1,a>>1),o=s,t.pool.releaseTexture(h)}}_prepare(t,e){if(hf._programFinalCompose||(hf._programFinalCompose=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){this.srcTex=t.tex2D().uniform(0),this.bloomTex=t.tex2D().uniform(0),this.intensity=t.float().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$l.srcSample=t.textureSampleLevel(this.srcTex,this.$inputs.uv,0),this.$l.bloomSample=t.textureSampleLevel(this.bloomTex,this.$inputs.uv,0),this.$outputs.outColor=t.vec4(t.add(this.srcSample.rgb,t.mul(this.bloomSample.rgb,this.intensity)),1)})}}),hf._programFinalCompose.name="@Bloom_FinalCompose",hf._bindgroupFinalCompose=t.createBindGroup(hf._programFinalCompose.bindGroupLayouts[0])),hf._programPrefilter||(hf._programPrefilter=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){this.tex=t.tex2D().uniform(0),this.threshold=t.vec4().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$l.p=t.textureSampleLevel(this.tex,this.$inputs.uv,0),this.$l.brightness=t.max(t.max(this.p.r,this.p.g),this.p.b),this.$l.soft=t.clamp(t.add(this.brightness,this.threshold.y),0,this.threshold.z),this.soft=t.mul(this.soft,this.soft,this.threshold.w),this.$l.contrib=t.div(t.max(this.soft,t.sub(this.brightness,this.threshold.x)),t.max(this.brightness,1e-5)),this.$outputs.outColor=t.vec4(t.mul(this.p.rgb,this.contrib),1)})}}),hf._programPrefilter.name="@Bloom_Prefilter",hf._bindgroupPrefilter=t.createBindGroup(hf._programPrefilter.bindGroupLayouts[0])),hf._programUpsample||(hf._programUpsample=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){this.tex=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$outputs.outColor=t.textureSampleLevel(this.tex,this.$inputs.uv,0)})}}),hf._programUpsample.name="@Bloom_Upsample",hf._bindgroupUpsample=t.createBindGroup(hf._programUpsample.bindGroupLayouts[0])),!hf._programDownsampleH){const e=[-4,-3,-2,-1,0,1,2,3,4],i=[.01621622,.05405405,.12162162,.19459459,.22702703,.19459459,.12162162,.05405405,.01621622];hf._programDownsampleH=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){this.invTexSize=t.vec2().uniform(0),this.tex=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$l.sum=t.vec3(0),this.$l.offset=t.float();for(let s=0;s<9;s++)this.offset=t.mul(this.invTexSize.x,2*e[s]),this.sum=t.add(this.sum,t.mul(t.textureSampleLevel(this.tex,t.add(this.$inputs.uv,t.vec2(this.offset,0)),0).rgb,i[s]));this.$outputs.outColor=t.vec4(this.sum,1)})}}),hf._programDownsampleH.name="@Bloom_DownsampleH",hf._bindgroupDownsampleH=t.createBindGroup(hf._programDownsampleH.bindGroupLayouts[0])}if(!hf._programDownsampleV){const e=[-3.23076923,-1.38461538,0,1.38461538,3.23076923],i=[.07027027,.31621622,.22702703,.31621622,.07027027];hf._programDownsampleV=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){this.invTexSize=t.vec2().uniform(0),this.tex=t.tex2D().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$l.sum=t.vec3(0),this.$l.offset=t.float();for(let s=0;s<5;s++)this.offset=t.mul(this.invTexSize.y,e[s]),this.sum=t.add(this.sum,t.mul(t.textureSampleLevel(this.tex,t.add(this.$inputs.uv,t.vec2(0,this.offset)),0).rgb,i[s]));this.$outputs.outColor=t.vec4(this.sum,1)})}}),hf._programDownsampleV.name="@Bloom_DownsampleV",hf._bindgroupDownsampleV=t.createBindGroup(hf._programDownsampleV.bindGroupLayouts[0])}hf._renderStateAdditive||(hf._renderStateAdditive=t.createRenderStateSet(),hf._renderStateAdditive.useRasterizerState().setCullMode("none"),hf._renderStateAdditive.useDepthState().enableTest(!1).enableWrite(!1),hf._renderStateAdditive.useBlendingState().enable(!0).setBlendFuncRGB("one","one").setBlendFuncAlpha("one","zero"))}}class lf extends rf{_packed;constructor(t){super(t),this._packed=!1}get packed(){return this._packed}set packed(t){this._packed!==!!t&&(this._packed=!!t,this.invalidateHash())}calcHash(){return`${this._packed}:${super.calcHash()}`}readTexel(t,e,i,s,r,a){const n=t.$builder,o=super.readTexel(t,e,i,s,r,a);return this._packed?n.vec4(n.vec3(El(t,o)),1):n.vec4(o.rrr,1)}writeTexel(t,e,i,s){const r=t.$builder,a=super.writeTexel(t,e,i,r.vec4(s.rrr,1));return this._finalPhase||!this._packed?r.vec4(a.rrr,1):Ml(t,a.r)}}class uf extends Nm{static _program=null;static _programPacked=null;static _renderState=null;static _renderStateBlend=null;static _bindgroup=null;static _bindgroupPacked=null;_saoScale;_saoBias;_saoIntensity;_saoRadius;_saoMinResolution;_saoRandomSeed;_saoBlurDepthCutoff;_blitterH;_blitterV;_supported;constructor(){super(),this._supported=!0,this._layer=Dm.opaque,this._saoScale=10,this._saoBias=1,this._saoIntensity=.025,this._saoRadius=100,this._saoMinResolution=0,this._saoRandomSeed=0,this._saoBlurDepthCutoff=2,this._blitterH=new lf(!1),this._blitterH.kernelRadius=8,this._blitterH.stdDev=10,this._blitterV=new lf(!0),this._blitterV.kernelRadius=8,this._blitterV.stdDev=10}get scale(){return this._saoScale}set scale(t){this._saoScale=t}get bias(){return this._saoBias}set bias(t){this._saoBias=t}get radius(){return this._saoRadius}set radius(t){this._saoRadius=t}get intensity(){return this._saoIntensity}set intensity(t){this._saoIntensity=t}get minResolution(){return this._saoMinResolution}set minResolution(t){this._saoMinResolution=t}get blurKernelSize(){return this._blitterH.kernelRadius}set blurKernelSize(t){t=Math.min(64,Math.max(0,t|0)),this._blitterH.kernelRadius=t,this._blitterV.kernelRadius=t}get blurStdDev(){return this._blitterH.stdDev}set blurStdDev(t){this._blitterH.stdDev=t,this._blitterV.stdDev=t}get blurDepthCutoff(){return this._saoBlurDepthCutoff}set blurDepthCutoff(t){this._saoBlurDepthCutoff=t}requireLinearDepthTexture(){return!0}requireDepthAttachment(){return!0}apply(t,e,i,s){const r=t.device,a=r.getViewport();if(this._prepare(r,e),this.passThrough(t,e,s),!this._supported)return;const n=this._getIntermediateTextureFormat(r),o=r.getFramebuffer().getDepthAttachment(),h=r.pool.fetchTemporalTexture2D(!1,n,o.width,o.height,!1),l=r.pool.fetchTemporalTexture2D(!1,n,o.width,o.height,!1),u="rgba8unorm"===h.format,c=new L(t.camera.getNearPlane(),t.camera.getFarPlane());r.pushDeviceStates(),r.setFramebuffer([h],o),r.clearFrameBuffer(new O(u?0:1,0,0,1),null,null);const d=u?uf._bindgroupPacked:uf._bindgroup;d.setValue("flip",this.needFlip(r)?1:0),d.setTexture("depthTex",i),d.setValue("scale",this._saoScale),d.setValue("invProj",W.invert(t.camera.getProjectionMatrix())),d.setValue("bias",this._saoBias),d.setValue("cameraNearFar",c),d.setValue("intensity",this._saoIntensity),d.setValue("kernelRadius",this._saoRadius),d.setValue("minResolution",this._saoMinResolution),d.setValue("size",new L(a.width,a.height)),d.setValue("randomSeed",this._saoRandomSeed),r.setRenderStates(uf._renderState),r.setProgram(u?uf._programPacked:uf._program),r.setBindGroup(0,d),this.drawFullscreenQuad(uf._renderState),this._blitterH.size=new L(e.width,e.height),this._blitterH.depthTex=i,this._blitterH.depthCutoff=this._saoBlurDepthCutoff,this._blitterH.sampler=Gl("clamp_nearest_nomip"),this._blitterH.cameraNearFar=c,this._blitterH.packed=u,this._blitterH.renderStates=uf._renderState,this._blitterV.size=new L(e.width,e.height),this._blitterV.depthTex=i,this._blitterV.depthCutoff=this._saoBlurDepthCutoff,this._blitterV.sampler=Gl("clamp_nearest_nomip"),this._blitterV.cameraNearFar=c,this._blitterV.packed=u,this._blitterV.srgbOut=s,this._blitterV.renderStates=uf._renderStateBlend,this._blitterH.blit(h,l),r.popDeviceStates(),this._blitterV.blit(l,r.getFramebuffer()),r.pool.releaseTexture(h),r.pool.releaseTexture(l)}_getIntermediateTextureFormat(t){const e=t.getDeviceCaps().textureCaps;return"webgl"===t.type||!e.supportHalfFloatColorBuffer&&!e.supportFloatColorBuffer?"rgba8unorm":e.supportHalfFloatColorBuffer?"r16f":"r32f"}_prepare(t,e){const i=t.getFramebuffer(),s=i&&zt(i.getColorAttachments()[0].format);if(this._supported=!s||t.getDeviceCaps().framebufferCaps.supportFloatBlending,this._supported){function r(e){const i=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,1,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(i){this.depthTex=i.tex2D().sampleType("unfilterable-float").uniform(0),this.scale=i.float().uniform(0),this.invProj=i.mat4().uniform(0),this.cameraNearFar=i.vec2().uniform(0),this.intensity=i.float().uniform(0),this.bias=i.float().uniform(0),this.kernelRadius=i.float().uniform(0),this.minResolution=i.float().uniform(0),this.size=i.vec2().uniform(0),this.randomSeed=i.float().uniform(0),this.$l.scaleDividedByCameraFar=i.float(),this.$l.minResolutionMultipliedByCameraFar=i.float(),i.func("rand",[i.vec2("uv")],function(){this.$l.a=12.9898,this.$l.b=78.233,this.$l.c=43758.5453,this.$l.dt=i.dot(this.uv,i.vec2(this.a,this.b)),this.$l.sn=i.mod(this.dt,Math.PI),this.$return(i.fract(i.mul(i.sin(this.sn),this.c)))}),i.func("getPositionVS",[i.vec2("uv")],function(){this.$l.depthValue=i.textureSample(this.depthTex,this.uv),"webgl"===t.type?this.$l.linearDepth=El(this,this.depthValue):this.$l.linearDepth=this.depthValue.r,this.$l.nonLinearDepth=i.div(i.sub(i.div(this.cameraNearFar.x,this.linearDepth),this.cameraNearFar.y),i.sub(this.cameraNearFar.x,this.cameraNearFar.y)),this.$l.clipSpacePos=i.vec4(i.sub(i.mul(this.uv,2),i.vec2(1)),i.sub(i.mul(this.nonLinearDepth,2),1),1),this.$l.vPos=i.mul(this.invProj,this.clipSpacePos),this.vPos=i.div(this.vPos,this.vPos.w),this.$return(this.vPos.xyz)}),i.func("getOcclusion",[i.vec3("centerPos"),i.vec3("centerNormal"),i.vec3("samplePos")],function(){this.$l.viewDelta=i.sub(this.samplePos,this.centerPos),this.$l.viewDistance=i.length(this.viewDelta),this.$l.scaledScreenDistance=i.mul(this.scaleDividedByCameraFar,this.viewDistance),this.$return(i.div(i.max(0,i.sub(i.div(i.sub(i.dot(this.centerNormal,this.viewDelta),this.minResolutionMultipliedByCameraFar),this.scaledScreenDistance),this.bias)),i.add(i.mul(this.scaledScreenDistance,this.scaledScreenDistance),1)))}),i.func("getAO",[i.vec3("vPos")],function(){this.scaleDividedByCameraFar=i.div(this.scale,this.cameraNearFar.y),this.minResolutionMultipliedByCameraFar=i.mul(this.minResolution,this.cameraNearFar.y),this.$l.centerViewNormal=i.normalize(i.cross(i.dpdx(this.vPos),i.dpdy(this.vPos))),this.$l.angle=i.mul(this.rand(i.add(this.$inputs.uv,i.vec2(this.randomSeed))),2*Math.PI),this.$l.radius=i.div(i.vec2(i.mul(this.kernelRadius,1/7)),this.size),this.$l.radiusStep=this.radius,this.$l.occlusionSum=i.float(0),this.$l.weightSum=i.float(0),this.$for(i.int("i"),0,7,function(){this.$l.sampleUV=i.add(this.$inputs.uv,i.mul(i.vec2(i.cos(this.angle),i.sin(this.angle)),this.radius)),this.radius=i.add(this.radius,this.radiusStep),this.angle=i.add(this.angle,4*Math.PI/7),this.samplePos=this.getPositionVS(this.sampleUV),this.occlusionSum=i.add(this.occlusionSum,this.getOcclusion(this.vPos,this.centerViewNormal,this.samplePos)),this.weightSum=i.add(this.weightSum,1)}),this.$if(i.equal(this.weightSum,0),function(){i.discard()}),this.$return(i.div(i.mul(this.occlusionSum,this.intensity),this.weightSum))}),i.main(function(){this.$l.vPos=this.getPositionVS(this.$inputs.uv),this.$l.ao=i.clamp(i.sub(1,this.getAO(this.vPos)),0,e?.999:1),this.$outputs.outColor=e?Ml(this,this.ao):i.vec4(this.ao,this.ao,this.ao,1)})}});return i.name=e?"@SAO_Packed":"@SAO",i}uf._renderState||(uf._renderState=t.createRenderStateSet(),uf._renderState.useDepthState().enableTest(!0).enableWrite(!1).setCompareFunc("gt"),uf._renderState.useRasterizerState().setCullMode("none"),uf._renderStateBlend=t.createRenderStateSet(),uf._renderStateBlend.useDepthState().enableTest(!0).enableWrite(!1).setCompareFunc("gt"),uf._renderStateBlend.useRasterizerState().setCullMode("none"),uf._renderStateBlend.useBlendingState().enable(!0).setBlendFuncRGB("zero","src-color").setBlendFuncAlpha("zero","one")),uf._program||(uf._program=r(!1),uf._programPacked=r(!0),uf._bindgroup=t.createBindGroup(uf._program.bindGroupLayouts[0]),uf._bindgroupPacked=t.createBindGroup(uf._programPacked.bindGroupLayouts[0]))}}}class cf extends Nm{static _programMotionBlur=null;static _bindgroupMotionBlur=null;_intensity;_aspect;constructor(){super(),this._intensity=1,this._aspect=new L,this._layer=Dm.transparent}get strength(){return this._intensity}set strength(t){this._intensity=t}requireLinearDepthTexture(){return!1}requireDepthAttachment(){return!1}apply(t,e,i,s){const r=t.device;this._prepare(r),this._aspect.setXY(e.width/e.height,1),cf._bindgroupMotionBlur.setTexture("inputTexture",e,Gl("clamp_nearest_nomip")),cf._bindgroupMotionBlur.setTexture("motionVectorTexture",t.motionVectorTexture,Gl("clamp_nearest_nomip")),cf._bindgroupMotionBlur.setValue("flip",this.needFlip(r)?1:0),cf._bindgroupMotionBlur.setValue("srgbOut",s?1:0),cf._bindgroupMotionBlur.setValue("frameDeltaTime",r.frameInfo.elapsedFrame),cf._bindgroupMotionBlur.setValue("intensity",this._intensity),cf._bindgroupMotionBlur.setValue("aspect",this._aspect),r.setProgram(cf._programMotionBlur),r.setBindGroup(0,cf._bindgroupMotionBlur),this.drawFullscreenQuad()}_prepare(t){cf._programMotionBlur||(cf._programMotionBlur=t.buildRenderProgram({vertex(t){this.flip=t.int().uniform(0),this.$inputs.pos=t.vec2().attrib("position"),this.$outputs.uv=t.vec2(),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.pos,0,1),this.$outputs.uv=t.add(t.mul(this.$inputs.pos.xy,.5),t.vec2(.5)),this.$if(t.notEqual(this.flip,0),function(){this.$builtins.position.y=t.neg(this.$builtins.position.y)})})},fragment(t){this.srgbOut=t.int().uniform(0),this.frameDeltaTime=t.float().uniform(0),this.inputTexture=t.tex2D().uniform(0),this.motionVectorTexture=t.tex2D().uniform(0),this.intensity=t.float().uniform(0),this.aspect=t.vec2().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$l.color=t.vec3(),this.$l.velocity=t.textureSampleLevel(this.motionVectorTexture,this.$inputs.uv,0).xy,this.velocity=t.div(t.mul(this.velocity,.5),this.aspect),this.$l.sourceSample=t.textureSampleLevel(this.inputTexture,this.$inputs.uv,0),this.$l.color=this.sourceSample.rgb,this.$if(t.greaterThan(t.dot(this.velocity,this.velocity),1e-7),function(){this.velocity=t.mul(this.velocity,this.intensity,this.frameDeltaTime),this.$l.uv0=t.clamp(t.sub(this.$inputs.uv,this.velocity),t.vec2(0),t.vec2(1)),this.$l.uv1=t.clamp(t.add(this.$inputs.uv,this.velocity),t.vec2(0),t.vec2(1));this.$for(t.float("i"),0,17,function(){this.$l.t=t.div(this.i,16),this.color=t.add(this.color,t.textureSampleLevel(this.inputTexture,t.mix(this.uv0,this.uv1,this.t),0).rgb)}),this.color=t.mul(this.color,1/17)}),this.$if(t.notEqual(this.srgbOut,0),function(){this.color=Il(this,this.color)}),this.$outputs.outColor=t.vec4(this.color,this.sourceSample.a)})}}),cf._programMotionBlur.name="@MotionBlur",cf._bindgroupMotionBlur=t.createBindGroup(cf._programMotionBlur.bindGroupLayouts[0]),console.log(cf._programMotionBlur.getShaderSource("fragment")))}}class df extends Au{static _halton23=function(t){function e(t,e){let i=0,s=1;for(;e>0;)s/=t,i+=s*(e%t),e=Math.floor(e/t);return i}const i=[];for(let s=1;s<=t;s++)i.push([e(2,s)-.5,e(3,s)-.5]);return i}(16);static _historyData=new WeakMap;_projMatrix;_invProjMatrix;_viewMatrix;_viewProjMatrix;_rotationMatrix;_invViewProjMatrix;_clearColor;_clearDepth;_clearStencil;_clipPlane;_controller;_frustum;_frustumV;_dirty;_viewport;_scissor;_clipMask;_oit;_depthPrePass;_commandBufferReuse;_HiZ;_HDR;_toneMap;_postEffectTonemap;_tonemapExposure;_motionBlur;_postEffectMotionBlur;_motionBlurStrength;_bloom;_postEffectBloom;_bloomMaxDownsampleLevels;_bloomDownsampleLimit;_bloomThreshold;_bloomThresholdKnee;_bloomIntensity;_FXAA;_postEffectFXAA;_TAA;_postEffectTAA;_TAADebug;_SSR;_postEffectSSR;_ssrParams;_ssrMaxRoughness;_ssrRoughnessFactor;_ssrStride;_ssrCalcThickness;_ssrBlurriness;_ssrBlurDepthCutoff;_ssrBlurKernelSize;_ssrBlurStdDev;_SSAO;_postEffectSSAO;_SSAOScale;_SSAOBias;_SSAORadius;_SSAOIntensity;_SSAOBlurDepthCutoff;_pickResultPromise;_pickResultResolve;_pickPosX;_pickPosY;_pickResult;_jitterValue;_prevJitterValue;_jitteredVPMatrix;_jitteredInvVPMatrix;_prevVPMatrix;_prevPosition;_prevJitteredVPMatrix;_compositor;_interactionRect;_capturedButton;constructor(t,e){super(t),this._projMatrix=e||W.identity(),this._invProjMatrix=W.invert(this._projMatrix),this._viewMatrix=W.identity(),this._viewProjMatrix=W.identity(),this._invViewProjMatrix=W.identity(),this._clipPlane=null,this._clearColor=new O(0,0,0,1),this._clearDepth=1,this._clearStencil=0,this._dirty=!0,this._controller=null,this._viewport=null,this._scissor=null,this._clipMask=0,this._frustum=null,this._frustumV=null,this._oit=new wt,this._depthPrePass=!1,this._HiZ=!1,this._HDR=!0,this._toneMap=!0,this._postEffectTonemap=new wt,this._tonemapExposure=1,this._motionBlur=!1,this._postEffectMotionBlur=new wt,this._motionBlurStrength=1,this._bloom=!1,this._postEffectBloom=new wt,this._bloomMaxDownsampleLevels=4,this._bloomDownsampleLimit=32,this._bloomThreshold=.8,this._bloomThresholdKnee=0,this._bloomIntensity=1,this._FXAA=!1,this._postEffectFXAA=new wt,this._TAA=!1,this._postEffectTAA=new wt,this._TAADebug=0,this._SSR=!1,this._postEffectSSR=new wt,this._ssrParams=new O(100,120,.5,0),this._ssrMaxRoughness=.8,this._ssrRoughnessFactor=1,this._ssrStride=2,this._ssrCalcThickness=!1,this._ssrBlurriness=.01,this._ssrBlurDepthCutoff=2,this._ssrBlurKernelSize=10,this._ssrBlurStdDev=10,this._SSAO=!1,this._postEffectSSAO=new wt,this._SSAOScale=10,this._SSAOBias=1,this._SSAOIntensity=.025,this._SSAORadius=100,this._SSAOBlurDepthCutoff=2,this._pickResult=null,this._commandBufferReuse=!0,this._jitteredVPMatrix=new W,this._jitteredInvVPMatrix=new W,this._jitterValue=new L(0,0),this._prevVPMatrix=null,this._prevPosition=null,this._prevJitteredVPMatrix=null,this._prevJitterValue=null,this._pickResultPromise=null,this._pickResultResolve=null,this._pickPosX=0,this._pickPosY=0,this._compositor=new Om,this._capturedButton=-1,this._interactionRect=null,this.updatePostProcessing(),t&&!t.mainCamera&&(t.mainCamera=this)}get compositor(){return this._compositor}get interactionRect(){return this._interactionRect}set interactionRect(t){this._interactionRect=t}get clipPlane(){return this._clipPlane}set clipPlane(t){this._clipPlane=t,this._invalidate(!1)}get clearColor(){return this._clearColor}set clearColor(t){this._clearColor=t?.clone()??null}get clearDepth(){return this._clearDepth}set clearDepth(t){this._clearDepth=t}get clearStencil(){return this._clearStencil}set clearStencil(t){this._clearStencil=t}get HiZ(){return this._HiZ}set HiZ(t){this._HiZ=!!t}get HDR(){return this._HDR}set HDR(t){this._HDR=!!t}get toneMap(){return this._postEffectTonemap.get().enabled}set toneMap(t){this._postEffectTonemap.get().enabled=!!t}get motionBlur(){return this._postEffectMotionBlur.get().enabled}set motionBlur(t){this._postEffectMotionBlur.get().enabled=!!t}get motionBlurStrength(){return this._motionBlurStrength}set motionBlurStrength(t){this._motionBlurStrength=t,this._postEffectMotionBlur.get()&&(this._postEffectMotionBlur.get().strength=this._motionBlurStrength)}get bloom(){return this._postEffectBloom.get().enabled}set bloom(t){this._postEffectBloom.get().enabled=!!t}get bloomMaxDownsampleLevels(){return this._bloomMaxDownsampleLevels}set bloomMaxDownsampleLevels(t){this._bloomMaxDownsampleLevels=t,this._postEffectBloom.get()&&(this._postEffectBloom.get().maxDownsampleLevel=t)}get bloomDownsampleLimit(){return this._bloomDownsampleLimit}set bloomDownsampleLimit(t){this._bloomDownsampleLimit=t,this._postEffectBloom.get()&&(this._postEffectBloom.get().downsampleLimit=t)}get bloomThreshold(){return this._bloomThreshold}set bloomThreshold(t){this._bloomThreshold=t,this._postEffectBloom.get()&&(this._postEffectBloom.get().threshold=t)}get bloomThresholdKnee(){return this._bloomThresholdKnee}set bloomThresholdKnee(t){this._bloomThresholdKnee=t,this._postEffectBloom.get()&&(this._postEffectBloom.get().thresholdKnee=t)}get bloomIntensity(){return this._bloomIntensity}set bloomIntensity(t){this._bloomIntensity=t,this._postEffectBloom.get()&&(this._postEffectBloom.get().intensity=t)}get FXAA(){return this._postEffectFXAA.get().enabled}set FXAA(t){this._postEffectFXAA.get().enabled=!!t}get toneMapExposure(){return this._tonemapExposure}set toneMapExposure(t){this._tonemapExposure=t,this._postEffectTonemap.get()&&(this._postEffectTonemap.get().exposure=t)}get TAA(){return this._postEffectTAA.get().enabled}set TAA(t){this._postEffectTAA.get().enabled=!!t}get TAADebug(){return this._TAADebug}set TAADebug(t){this._TAADebug=t}get SSR(){return this._postEffectSSR.get().enabled}set SSR(t){this._postEffectSSR.get().enabled=!!t}get ssrMaxRoughness(){return this._ssrMaxRoughness}set ssrMaxRoughness(t){this._ssrMaxRoughness=t}get ssrRoughnessFactor(){return this._ssrRoughnessFactor}set ssrRoughnessFactor(t){this._ssrRoughnessFactor=t}get ssrStride(){return this._ssrStride}set ssrStride(t){this._ssrStride=t}get ssrMaxDistance(){return this._ssrParams.x}set ssrMaxDistance(t){this._ssrParams.x=t}get ssrIterations(){return this._ssrParams.y}set ssrIterations(t){this._ssrParams.y=t}get ssrThickness(){return this._ssrParams.z}set ssrThickness(t){this._ssrParams.z=t}get ssrCalcThickness(){return this._ssrCalcThickness}set ssrCalcThickness(t){this._ssrCalcThickness=!!t}get ssrBlurScale(){return this._ssrBlurriness}set ssrBlurScale(t){this._ssrBlurriness=t}get ssrBlurDepthCutoff(){return this._ssrBlurDepthCutoff}set ssrBlurDepthCutoff(t){this._ssrBlurDepthCutoff=t}get ssrBlurKernelSize(){return this._ssrBlurKernelSize}set ssrBlurKernelSize(t){this._ssrBlurKernelSize=t}get ssrBlurStdDev(){return this._ssrBlurStdDev}set ssrBlurStdDev(t){this._ssrBlurStdDev=t}get ssrParams(){return this._ssrParams}get SSAO(){return this._postEffectSSAO.get().enabled}set SSAO(t){this._postEffectSSAO.get().enabled=!!t}get SSAOScale(){return this._SSAOScale}set SSAOScale(t){this._SSAOScale=t,this._postEffectSSAO.get()&&(this._postEffectSSAO.get().scale=t)}get SSAOBias(){return this._SSAOBias}set SSAOBias(t){this._SSAOBias=t,this._postEffectSSAO.get()&&(this._postEffectSSAO.get().bias=t)}get SSAORadius(){return this._SSAORadius}set SSAORadius(t){this._SSAORadius=t,this._postEffectSSAO.get()&&(this._postEffectSSAO.get().radius=t)}get SSAOIntensity(){return this._SSAOIntensity}set SSAOIntensity(t){this._SSAOIntensity=t,this._postEffectSSAO.get()&&(this._postEffectSSAO.get().intensity=t)}get SSAOBlurDepthCutoff(){return this._SSAOBlurDepthCutoff}set SSAOBlurDepthCutoff(t){this._SSAOBlurDepthCutoff=t,this._postEffectSSAO.get()&&(this._postEffectSSAO.get().blurDepthCutoff=t)}get depthPrePass(){return this._depthPrePass}set depthPrePass(t){this._depthPrePass=!!t}get commandBufferReuse(){return this._commandBufferReuse}set commandBufferReuse(t){this._commandBufferReuse=!!t}get oit(){return this._oit.get()}set oit(t){this._oit.set(t)}get clipMask(){return this._clipMask}set clipMask(t){this._clipMask=t}get viewport(){return this._viewport?[...this._viewport]:null}set viewport(t){this._viewport=t?.slice()??null}get scissor(){return this._scissor?[...this._scissor]:null}set scissor(t){this._scissor=t?.slice()??null}handleEvent(t,e){let i=!1;if(this._controller){if(this._capturedButton<0&&(t instanceof PointerEvent||t instanceof WheelEvent)&&!this.posInViewport(t.offsetX,t.offsetY))return!1;"pointerdown"===(e=e??t.type)?(this._capturedButton<0&&(this._capturedButton=t.button),i=this._controller.onMouseDown(t)):"pointerup"===e?(i=this._controller.onMouseUp(t),this._capturedButton===t.button&&(this._capturedButton=-1)):"pointermove"===e?i=this._controller.onMouseMove(t):"wheel"===e?i=this._controller.onMouseWheel(t):"keydown"===e?i=this._controller.onKeyDown(t):"keyup"===e&&(i=this._controller.onKeyUp(t)),i&&t.preventDefault&&t.preventDefault()}return i}constructRay(t,e){const i=2*t/(this.viewport?this.viewport[2]:Sl().getViewport().width)-1,s=1-2*e/(this.viewport?this.viewport[3]:Sl().getViewport().height),r=new O(i,s,0,1),a=new O(i,s,1,1),n=this.invViewProjectionMatrix.transform(r),o=this.invViewProjectionMatrix.transform(a);this.isPerspective()&&(n.scaleBy(1/n.w),o.scaleBy(1/o.w));const h=this.isPerspective()?this.getWorldPosition():n.xyz(),l=z.sub(o.xyz(),h).inplaceNormalize();return new et(h,l)}lookAt(t,e,i){return this.setLocalTransform(W.lookAt(t,e,i))}lookAtCubeFace(t,e){return this.setLocalTransform(W.lookAtCubeFace(t,e??this.position))}setPerspective(t,e,i,s){return this._projMatrix.perspective(t,e,i,s),W.invert(this._projMatrix,this._invProjMatrix),this._invalidate(!0),this}setOrtho(t,e,i,s,r,a){return this._projMatrix.ortho(t,e,i,s,r,a),W.invert(this._projMatrix,this._invProjMatrix),this._invalidate(!0),this}setProjectionMatrix(t){t&&t!==this._projMatrix&&(this._projMatrix=t,W.invert(this._projMatrix,this._invProjMatrix),this._invalidate(!0))}getProjectionMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._projMatrix}getInvProjectionMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._invProjMatrix}getRotationMatrix(){const t=new W;this.worldMatrix.decompose(null,t,null);const e=t.getRow(0).xyz().scaleBy(-1),i=t.getRow(1).xyz(),s=t.getRow(2).xyz().scaleBy(-1);return t.setRow(0,new O(e.x,e.y,e.z,0)),t.setRow(1,new O(i.x,i.y,i.z,0)),t.setRow(2,new O(s.x,s.y,s.z,0)),t}get viewMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._viewMatrix}get viewProjectionMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._viewProjMatrix}get invViewProjectionMatrix(){return this._dirty&&(this._dirty=!1,this._compute()),this._invViewProjMatrix}get frustum(){return this._dirty&&(this._dirty=!1,this._compute()),this._frustum}get frustumViewSpace(){return this._dirty&&(this._dirty=!1,this._compute()),this._frustumV||(this._frustumV=new Q(this._projMatrix)),this._frustumV}get controller(){return this._controller||null}set controller(t){this.setController(t)}isCamera(){return!0}getNearPlane(){return this.getProjectionMatrix().getNearPlane()}getFarPlane(){return this.getProjectionMatrix().getFarPlane()}getFOV(){return this.getProjectionMatrix().getFov()}getTanHalfFovy(){return this.getProjectionMatrix().getTanHalfFov()}getAspect(){return this.getProjectionMatrix().getAspect()}isPerspective(){return this.getProjectionMatrix().isPerspective()}isOrtho(){return this.getProjectionMatrix().isOrtho()}getHistoryData(){let t=df._historyData.get(this);return t||(t={prevColorTex:null,prevMotionVectorTex:null},df._historyData.set(this,t)),t}clearHistoryData(){const t=df._historyData.get(this);t&&(t.prevColorTex&&Sl().pool.releaseTexture(t.prevColorTex),t.prevMotionVectorTex&&Sl().pool.releaseTexture(t.prevMotionVectorTex),df._historyData.delete(this)),this._prevVPMatrix=null,this._prevPosition=null,this._prevJitteredVPMatrix=null,this._prevJitterValue=null}updatePostProcessing(){if(this._compositor.clear(),!this._postEffectSSR.get()){const t=new af;t.enabled=!1,this._postEffectSSR.set(t),this._compositor.appendPostEffect(t)}if(!this._postEffectSSAO.get()){const t=new uf;t.enabled=!1,t.scale=this._SSAOScale,t.bias=this._SSAOBias,t.radius=this._SSAORadius,t.intensity=this._SSAOIntensity,t.blurDepthCutoff=this._SSAOBlurDepthCutoff,this._postEffectSSAO.set(t),this._compositor.appendPostEffect(t)}if(!this._postEffectTAA.get()){const t=new Ym;t.enabled=!1,this._postEffectTAA.set(t),this._compositor.appendPostEffect(t)}if(!this._postEffectMotionBlur.get()){const t=new cf;t.enabled=!1,t.strength=this._motionBlurStrength,this._postEffectMotionBlur.set(t),this._compositor.appendPostEffect(t)}if(!this._postEffectTonemap.get()){const t=new nf;t.enabled=!0,t.exposure=this._tonemapExposure,this._postEffectTonemap.set(t),this._compositor.appendPostEffect(t)}if(!this._postEffectFXAA.get()){const t=new of;t.enabled=!1,this._postEffectFXAA.set(t),this._compositor.appendPostEffect(t)}if(!this._postEffectBloom.get()){const t=new hf;t.enabled=!1,t.maxDownsampleLevel=this._bloomMaxDownsampleLevels,t.downsampleLimit=this._bloomDownsampleLimit,t.threshold=this._bloomThreshold,t.thresholdKnee=this._bloomThresholdKnee,t.intensity=this._bloomIntensity,this._postEffectBloom.set(t),this._compositor.appendPostEffect(t)}}render(t){const e=Sl(),i=(this.TAA||this.motionBlur)&&"webgl"!==e.type,s=i&&this.TAA;if(t.dispatchEvent("startrender",t,this,this._compositor),i){const t=e.getDrawingBufferWidth(),i=e.getDrawingBufferHeight();if(s){const s=df._halton23[e.frameInfo.frameCounter%df._halton23.length];this._jitterValue.setXY(2*s[0]/t,2*s[1]/i)}else this._jitterValue.setXY(0,0);this._jitteredVPMatrix.set(this.getProjectionMatrix()),this._jitteredVPMatrix[8]+=this._jitterValue.x,this._jitteredVPMatrix[9]+=this._jitterValue.y,this._jitteredVPMatrix.multiplyRight(this.viewMatrix),W.invert(this._jitteredVPMatrix,this._jitteredInvVPMatrix),this._prevJitteredVPMatrix||(this._prevJitteredVPMatrix=new W,this._prevJitteredVPMatrix.set(this._jitteredVPMatrix),this._prevJitterValue=new L(this._jitterValue)),this._prevVPMatrix||(this._prevVPMatrix=new W,this._prevVPMatrix.set(this.viewProjectionMatrix),this._prevPosition=this.getWorldPosition())}else this._jitterValue.setXY(0,0),this._prevVPMatrix=null,this._prevPosition=null,this._prevJitteredVPMatrix=null,this._prevJitterValue=null,this._jitteredInvVPMatrix.set(this.invViewProjectionMatrix);e.pushDeviceStates(),e.reverseVertexWindingOrder(!1),t.getRenderer().renderScene(t,this),e.popDeviceStates(),i&&(this._prevJitteredVPMatrix.set(this._jitteredVPMatrix),this._prevJitterValue.set(this._jitterValue),this._prevVPMatrix.set(this.viewProjectionMatrix),this._prevPosition=this.getWorldPosition()),t.dispatchEvent("endrender",t,this,this._compositor)}async pickAsync(t,e){return this._pickPosX=t,this._pickPosY=e,this._pickResultPromise||(this._pickResultPromise=new Promise(t=>{this._pickResultResolve=e=>{t(e),this._pickResultPromise=null,this._pickResultResolve=null}})),this._pickResultPromise}getPickResultResolveFunc(){return this._pickResultResolve}getPickPosX(){return this._pickPosX}getPickPosY(){return this._pickPosY}updateController(){this._controller?.update()}resetController(){this._controller?.reset()}get jitteredVPMatrix(){return this._jitteredVPMatrix}get jitteredInvVPMatrix(){return this._jitteredInvVPMatrix}get jitterValue(){return this._jitterValue}get prevJitteredVPMatrix(){return this._prevJitteredVPMatrix}get prevJitterValue(){return this._prevJitterValue}get prevVPMatrix(){return this._prevVPMatrix}get prevPosition(){return this._prevPosition}setController(t){if(this._controller!==t){if(t&&t._getCamera()&&t._getCamera()!==this)throw new Error("Camera.setController failed: one camera controller object cannot be assigned to multiple camera");this._controller?._setCamera(null),this._controller=t,this._controller?._setCamera(this)}return this}_invalidate(t){this._dirty=!0,t&&(this._frustumV=null)}_compute(){this._computeProj(),W.invertAffine(this.worldMatrix,this._viewMatrix),W.multiply(this._projMatrix,this._viewMatrix,this._viewProjMatrix),W.invert(this._viewProjMatrix,this._invViewProjMatrix),this._frustum?this._frustum.initWithMatrix(this._viewProjMatrix):this._frustum=new Q(this._viewProjMatrix)}_computeProj(){}_onTransformChanged(t){super._onTransformChanged(t),this._invalidate(!1)}onDispose(){super.onDispose(),this.setController(null),this.clearHistoryData(),this._projMatrix=null,this._viewMatrix=null,this._viewProjMatrix=null,this._postEffectBloom.dispose(),this._postEffectFXAA.dispose(),this._postEffectMotionBlur.dispose(),this._postEffectSSAO.dispose(),this._postEffectSSR.dispose(),this._postEffectTAA.dispose(),this._postEffectTonemap.dispose(),this._oit.dispose()}posInViewport(t,e){let i=this._interactionRect;if(!i&&this.viewport){const t=Sl().canvas,e=this.viewport;i=[e[0],t.clientHeight-e[1]-e[3],e[2],e[3]]}return!i||(t-=i[0],e-=i[1],t>=0&&t<i[2]&&e>=0&&e<i[3])}}class pf{_tileCountX;_tileCountY;_tileCountZ;_lights;_lightIndexTexture;_lightIndexFramebuffer;_lightIndexProgram;_bindGroup;_lightIndexVertexLayout;_lightIndexRenderStates;_lightBuffer;_sizeParam;_countParam;_clusterParam;constructor(){this._tileCountX=16,this._tileCountY=16,this._tileCountZ=32,this._lights=new Float32Array(3072),this._lightIndexTexture=null,this._lightIndexFramebuffer=null,this._lightIndexProgram=null,this._lightBuffer=null,this._bindGroup=null,this._lightIndexVertexLayout=null,this._lightIndexRenderStates=null,this._sizeParam=new O,this._countParam=new Int32Array(4),this._clusterParam=new O}get lightBuffer(){return this._lightBuffer}get clusterParam(){return this._clusterParam}get countParam(){return this._countParam}get lightIndexTexture(){return this._lightIndexTexture}createVertexLayout(t,e,i){let s;if("webgl"===t.type){const r=new Float32Array(this._tileCountX*this._tileCountY*this._tileCountZ*3);for(let t=0;t<r.length;t++){const s=t%e,a=Math.floor(t/e);r[3*t+0]=2*(s+.5)/e-1,r[3*t+1]=2*(a+.5)/i-1,r[3*t+2]=t}s=t.createVertexBuffer("position_f32x3",r)}else{const r=new Float32Array(this._tileCountX*this._tileCountY*this._tileCountZ*2);for(let t=0;t<r.length;t++){const s=t%e,a=Math.floor(t/e);r[2*t+0]=2*(s+.5)/e-1,r[2*t+1]=2*(a+.5)/i-1}s=t.createVertexBuffer("position_f32x2",r)}this._lightIndexVertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:s}]})}createRenderState(t){this._lightIndexRenderStates=t.createRenderStateSet(),this._lightIndexRenderStates.useDepthState().enableTest(!1).enableWrite(!1),this._lightIndexRenderStates.useRasterizerState().setCullMode("none")}createProgram(t){const e="webgl"===t.type;this._lightIndexProgram=t.buildRenderProgram({vertex(t){this.$inputs.pos=(e?t.vec3():t.vec2()).attrib("position"),this.$outputs.value=e?t.vec4():t.uvec4(),this.invProjMatrix=t.mat4().uniform(0),this.viewMatrix=t.mat4().uniform(0),this.sizeParam=t.vec4().uniform(0),this.countParam=t.ivec4().uniform(0),this[Qc.getLightBufferUniformName()]=t.vec4[768]().uniformBuffer(0),t.func("lineIntersectionToZPlane",[t.vec3("a"),t.vec3("b"),t.float("zDistance")],function(){this.$l.normal=t.vec3(0,0,1),this.$l.ab=t.sub(this.b,this.a),this.$l.t=t.div(t.sub(this.zDistance,t.dot(this.normal,this.a)),t.dot(this.normal,this.ab)),this.$return(t.add(this.a,t.mul(this.t,this.ab)))}),t.func("clipToView",[t.vec4("clip")],function(){this.$l.view=t.mul(this.invProjMatrix,this.clip),this.$return(t.div(this.view,this.view.w))}),t.func("screenToView",[t.vec4("screen")],function(){this.$l.texCoord=t.div(this.screen.xy,this.sizeParam.xy),this.$l.clip=t.vec4(t.sub(t.mul(t.vec2(this.texCoord.x,t.sub(1,this.texCoord.y)),2),t.vec2(1)),this.screen.z,this.screen.w),this.$return(this.clipToView(this.clip))}),t.func("sphereIntersectsAABB",[t.vec4("sphere"),t.vec3("aabbMin"),t.vec3("aabbMax")],function(){this.$l.dmin=t.float(0),this.$if(t.lessThanEqual(this.sphere.w,0),function(){this.$return(!0)}),this.$for(t.int("i"),0,3,function(){this.$if(t.lessThan(this.sphere.at(this.i),this.aabbMin.at(this.i)),function(){this.$l.delta=t.sub(this.sphere.at(this.i),this.aabbMin.at(this.i)),this.dmin=t.add(this.dmin,t.mul(this.delta,this.delta))}).$elseif(t.greaterThan(this.sphere.at(this.i),this.aabbMax.at(this.i)),function(){this.$l.delta=t.sub(this.sphere.at(this.i),this.aabbMax.at(this.i)),this.dmin=t.add(this.dmin,t.mul(this.delta,this.delta))})}),this.$if(t.lessThanEqual(this.dmin,t.mul(this.sphere.w,this.sphere.w)),function(){this.$return(!0)}),this.$return(!1)}),t.main(function(){"webgpu"!==t.getDevice().type&&(this.$builtins.pointSize=1),this.$builtins.position=t.vec4(this.$inputs.pos.xy,0,1),"webgpu"===t.getDevice().type&&(this.$builtins.position=t.mul(this.$builtins.position,t.vec4(1,-1,1,1))),this.$l.tileIndex=e?t.int(this.$inputs.pos.z):t.int(this.$builtins.vertexIndex),this.$l.tileSize=t.div(this.sizeParam.xy,t.vec2(this.countParam.xy)),this.$l.zIndex=t.div(this.tileIndex,t.mul(this.countParam.x,this.countParam.y)),this.$l.yIndex=t.div(t.sub(this.tileIndex,t.mul(this.zIndex,this.countParam.x,this.countParam.y)),this.countParam.x),this.$l.xIndex=t.sub(this.tileIndex,t.add(t.mul(this.zIndex,this.countParam.x,this.countParam.y),t.mul(this.yIndex,this.countParam.x))),this.$l.maxPoint_sS=t.vec4(t.mul(t.vec2(t.float(t.add(this.xIndex,1)),t.float(t.add(this.yIndex,1))),this.tileSize),0,1),this.$l.minPoint_sS=t.vec4(t.mul(t.vec2(t.float(this.xIndex),t.float(this.yIndex)),this.tileSize),0,1),this.$l.maxPoint_vS=this.screenToView(this.maxPoint_sS).xyz,this.$l.minPoint_vS=this.screenToView(this.minPoint_sS).xyz,this.$l.tileNear=t.mul(t.neg(this.sizeParam.z),t.pow(t.div(this.sizeParam.w,this.sizeParam.z),t.div(t.float(this.zIndex),t.float(this.countParam.z)))),this.$l.tileFar=t.mul(t.neg(this.sizeParam.z),t.pow(t.div(this.sizeParam.w,this.sizeParam.z),t.div(t.add(t.float(this.zIndex),1),t.float(this.countParam.z)))),this.$l.eyePos=t.vec3(0),this.$l.minPointNear=this.lineIntersectionToZPlane(this.eyePos,this.minPoint_vS,this.tileNear),this.$l.minPointFar=this.lineIntersectionToZPlane(this.eyePos,this.minPoint_vS,this.tileFar),this.$l.maxPointNear=this.lineIntersectionToZPlane(this.eyePos,this.maxPoint_vS,this.tileNear),this.$l.maxPointFar=this.lineIntersectionToZPlane(this.eyePos,this.maxPoint_vS,this.tileFar),this.$l.aabbMin=t.min(t.min(this.minPointNear,this.minPointFar),t.min(this.maxPointNear,this.maxPointFar)),this.$l.aabbMax=t.max(t.max(this.minPointNear,this.minPointFar),t.max(this.maxPointNear,this.maxPointFar)),this.$l.n=t.int(0),e?(this.$l.lightIndices=t.float[8](),this.$for(t.int("i"),0,8,function(){this.lightIndices.setAt(this.i,0)}),this.$for(t.int("i"),1,256,function(){this.$if(t.equal(this.i,this.countParam.w),function(){this.$break()}),this.$l.light=this[Qc.getLightBufferUniformName()].at(t.mul(this.i,3)),this.$l.lightPos=t.mul(this.viewMatrix,t.vec4(this.light.xyz,1)),this.$l.lightPos.w=this.light.w,this.$if(this.sphereIntersectsAABB(this.lightPos,this.aabbMin,this.aabbMax),function(){this.$for(t.int("j"),0,8,function(){this.$if(t.equal(this.j,this.n),function(){this.lightIndices.setAt(this.j,t.float(this.i)),this.n=t.add(this.n,1),this.$break()})}),this.$if(t.equal(this.n,8),function(){this.$break()})})}),this.$outputs.value.r=t.add(t.mul(this.lightIndices[0],256),this.lightIndices[1]),this.$outputs.value.g=t.add(t.mul(this.lightIndices[2],256),this.lightIndices[3]),this.$outputs.value.b=t.add(t.mul(this.lightIndices[4],256),this.lightIndices[5]),this.$outputs.value.a=t.add(t.mul(this.lightIndices[6],256),this.lightIndices[7])):(this.$l.lightIndex=[t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0),t.uint(0)],this.$for(t.uint("i"),1,t.uint(this.countParam.w),function(){this.$l.light=this[Qc.getLightBufferUniformName()].at(t.mul(this.i,3)),this.$l.lightPos=t.mul(this.viewMatrix,t.vec4(this.light.xyz,1)),this.$l.lightPos.w=this.light.w,this.$if(this.sphereIntersectsAABB(this.lightPos,this.aabbMin,this.aabbMax),function(){this.lightIndex.setAt(this.n,this.i),this.n=t.add(this.n,1),this.$if(t.equal(this.n,16),function(){this.$break()})})}),this.$l.r=t.add(t.sal(this.lightIndex[0],24),t.sal(this.lightIndex[1],16),t.sal(this.lightIndex[2],8),this.lightIndex[3]),this.$l.g=t.add(t.sal(this.lightIndex[4],24),t.sal(this.lightIndex[5],16),t.sal(this.lightIndex[6],8),this.lightIndex[7]),this.$l.b=t.add(t.sal(this.lightIndex[8],24),t.sal(this.lightIndex[9],16),t.sal(this.lightIndex[10],8),this.lightIndex[11]),this.$l.a=t.add(t.sal(this.lightIndex[12],24),t.sal(this.lightIndex[13],16),t.sal(this.lightIndex[14],8),this.lightIndex[15]),this.$outputs.value=t.uvec4(this.r,this.g,this.b,this.a))})},fragment(t){this.$outputs.color=e?t.vec4():t.uvec4(),t.main(function(){this.$outputs.color=this.$inputs.value})}}),this._lightIndexProgram.name="@ClusteredLight_Index",this._bindGroup=t.createBindGroup(this._lightIndexProgram.bindGroupLayouts[0]),this._lightBuffer?.dispose();const i=this._lightIndexProgram.getBindingInfo(Qc.getLightBufferUniformName()).type;this._lightBuffer=t.createStructuredBuffer(i,{usage:"uniform"})}createLightIndexTexture(t){const e=Math.log2(this._tileCountX*this._tileCountY*this._tileCountZ),i=e+1>>>1,s=2<<i-1,r=2<<e-i-1;if(s*r!==this._tileCountX*this._tileCountY*this._tileCountZ)throw new Error("Internal error");this._lightIndexTexture=t.createTexture2D("webgl"===t.type?"rgba32f":"rgba32ui",s,r,{mipmapping:!1}),this._lightIndexTexture.name="ClusterLightIndex",this._lightIndexFramebuffer?.dispose(),this._lightIndexFramebuffer=t.createFrameBuffer([this._lightIndexTexture],null)}calculateLightIndex(t,e){const i=this.getVisibleLights(e,this._lights),s=Sl();this._lightIndexTexture||this.createLightIndexTexture(s),this._lightIndexProgram||this.createProgram(s),this._lightIndexVertexLayout||this.createVertexLayout(s,this._lightIndexTexture.width,this._lightIndexTexture.height),this._lightIndexRenderStates||this.createRenderState(s);const r=s.getViewport(),a=s.screenToDevice(r.width),n=s.screenToDevice(r.height),o=this._tileCountZ/Math.log2(t.getFarPlane()/t.getNearPlane()),h=-this._tileCountZ*Math.log2(t.getNearPlane())/Math.log2(t.getFarPlane()/t.getNearPlane());if(this._clusterParam.setXYZW(a,n,o,h),s.pushDeviceStates(),s.setFramebuffer(this._lightIndexFramebuffer),i>0){this._lightBuffer.disposed&&this._lightBuffer.reload(),this._lightBuffer.bufferSubData(0,this._lights),this._sizeParam.setXYZW(a,n,t.getNearPlane(),t.getFarPlane()),this._countParam[0]=this._tileCountX,this._countParam[1]=this._tileCountY,this._countParam[2]=this._tileCountZ,this._countParam[3]=i+1,this._bindGroup.setValue("invProjMatrix",W.invert(t.getProjectionMatrix())),this._bindGroup.setValue("viewMatrix",t.viewMatrix),this._bindGroup.setValue("sizeParam",this._sizeParam),this._bindGroup.setValue("countParam",this._countParam),this._bindGroup.setBuffer(Qc.getLightBufferUniformName(),this._lightBuffer),s.setProgram(this._lightIndexProgram),s.setVertexLayout(this._lightIndexVertexLayout),s.setBindGroup(0,this._bindGroup);const e=s.getRenderStates();s.setRenderStates(this._lightIndexRenderStates),s.draw("point-list",0,this._tileCountX*this._tileCountY*this._tileCountZ),s.setRenderStates(e)}else s.clearFrameBuffer(new O(0,0,0,0),1,0);s.popDeviceStates()}getVisibleLights(t,e){const i=Math.min(t.unshadowedLights.length,fu);for(let s=1;s<=i;s++){const i=t.unshadowedLights[s-1];e.set(i.positionAndRange,12*s),e.set(i.directionAndCutoff,12*s+4),e.set(i.diffuseAndIntensity,12*s+8)}return i}}class mf{static _layouts={};static _allocators=[];_bindGroups;constructor(){this._bindGroups={}}static get(){return this._allocators.pop()??new mf}static release(t){this._allocators.push(t)}getGlobalBindGroup(t){const e=t.renderPassHash;let i=this._bindGroups[e];if(!i){let s=mf._layouts[e];if(!s){s=t.device.programBuilder.buildRender({vertex(e){Qc.prepareVertexShader(e,t),e.main(function(){})},fragment(e){Qc.prepareFragmentShader(e,t),e.main(function(){})}})[2][0],mf._layouts[e]=s}i=t.device.createBindGroup(s),this._bindGroups[e]=i}return i}}class ff extends Fm{constructor(){super(3)}_getGlobalBindGroupHash(t){return""}renderItems(t,e){const i=e.itemList;if(i){t.fogFlags=0,t.drawEnvLight=!1,t.env=null,t.picking=!0,t.flip=this.isAutoFlip(t),t.renderPassHash=this.getGlobalBindGroupHash(t);const e=t.globalBindGroupAllocator.getGlobalBindGroup(t);t.device.setBindGroup(0,e),Qc.setCameraUniforms(e,t,!0);const s=t.camera.worldMatrixDet<0;for(const e of[i.opaque,i.transmission,i.transparent,i.transmission_trans])if(e){for(const i of e.lit)this.drawItemList(i,t,s);for(const i of e.unlit)this.drawItemList(i,t,s)}t.picking=!1}}}let _f=null,gf=null,xf=null,bf=null;function vf(t,e,i,s){const r=Gl("clamp_nearest"),a=t.pool.fetchTemporalFramebuffer(!1,0,0,[s],null,!1,1,!0,e+1);a.setColorAttachmentGenerateMipmaps(0,!1),bf[0]=Math.max(i.width>>e,1),bf[1]=Math.max(i.height>>e,1),gf.setValue("srcSize",bf),"webgpu"===t.type?gf.setTextureView("srcTex",i,e,0,1,r):(gf.setTexture("srcTex",i,r),gf.setValue("srcMipLevel",e)),t.setProgram(_f),t.setBindGroup(0,gf),t.setFramebuffer(a),Ru(),i!==s&&t.copyFramebufferToTexture2D(a,0,i,e+1),t.pool.releaseFrameBuffer(a)}class yf{static _skyMotionVectorProgram=null;static _skyMotionVectorBindGroup=null;static _box=null;static _pickCamera=new df(null);static _scenePass=new Lm;static _depthPass=new Vm;static _shadowMapPass=new zm;static _objectColorPass=new ff;static _frontDepthColorState=null;static _backDepthColorState=null;static _clusters=[];static get sceneRenderPass(){return this._scenePass}static get depthRenderPass(){return this._depthPass}static get shadowMapRenderPass(){return this._shadowMapPass}static getClusteredLight(){return this._clusters.length>0?this._clusters.pop():new pf}static freeClusteredLight(t){this._clusters.push(t)}static renderScene(t,e){const i=Sl(),s=e.HDR&&i.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"rgba16f":"rgba8unorm",r=i.getDeviceCaps().framebufferCaps.supportDepth32floatStencil8?"d32fs8":"d24s8",a=mf.get();if(t.frameUpdate(),t.frameUpdatePerCamera(e),e&&!i.isContextLost()){const n=!e.viewport&&!e.scissor,o=e.viewport?i.screenToDevice(e.viewport[0]):0,h=e.viewport?i.screenToDevice(e.viewport[1]):0,l=e.viewport?i.screenToDevice(e.viewport[2]):i.getDrawingBufferWidth(),u=e.viewport?i.screenToDevice(e.viewport[3]):i.getDrawingBufferHeight();if(l<=0||u<=0)return void e.getPickResultResolveFunc()?.(null);const c=n?null:i.pool.fetchTemporalFramebuffer(!1,l,u,s,r),d=i.getFramebuffer();c&&(i.pushDeviceStates(),i.setFramebuffer(c)),i.clearFrameBuffer(e.clearColor,e.clearDepth,e.clearStencil);const p=e.SSR&&t.env.light.envLight&&t.env.light.envLight.hasRadiance(),m={device:i,scene:t,renderWidth:l,renderHeight:u,primaryCamera:e,picking:!1,oit:null,motionVectors:"webgl"!==i.type&&(e.TAA||e.motionBlur),HiZ:e.HiZ&&"webgl"!==i.type,HiZTexture:null,globalBindGroupAllocator:a,camera:e,compositor:e.compositor,timestamp:i.frameInfo.frameTimestamp,queue:0,lightBlending:!1,renderPass:null,renderPassHash:null,fogFlags:0,flip:!1,depthFormat:r,colorFormat:s,drawEnvLight:!1,env:null,materialFlags:0,TAA:e.TAA,SSR:p,SSRCalcThickness:p&&e.ssrCalcThickness,SSRRoughnessTexture:i.pool.fetchTemporalTexture2D(!0,"rgba8unorm",l,u),SSRNormalTexture:i.pool.fetchTemporalTexture2D(!0,"rgba8unorm",l,u),finalFramebuffer:i.getFramebuffer(),intermediateFramebuffer:null};if(this._renderScene(m),c){i.popDeviceStates();const t=o<0||h<0||o+l>i.getDrawingBufferWidth()||h+u>i.getDrawingBufferHeight(),s=new zl;t?s.destRect=[o,h,l,u]:s.viewport=e.viewport,s.scissor=e.scissor,s.srgbOut=!d,s.blit(c.getColorAttachments()[0],d??null,Gl("clamp_nearest_nomip")),i.pool.releaseFrameBuffer(c)}}mf.release(a)}static renderSceneDepth(t,e,i){const s=!!i;if(!i){const e="webgl"===t.device.type?t.SSRCalcThickness?"rgba16f":"rgba8unorm":t.SSRCalcThickness?"rg32f":"r32f",s="rgba16f";if(t.finalFramebuffer){const r=t.finalFramebuffer?.getDepthAttachment();i=r?.isTexture2D()?t.device.pool.fetchTemporalFramebuffer(!0,r.width,r.height,t.motionVectors?[e,s]:e,r,!1):t.device.pool.fetchTemporalFramebuffer(!0,t.renderWidth,t.renderHeight,t.motionVectors?[e,s]:e,t.depthFormat,!1)}else i=t.device.pool.fetchTemporalFramebuffer(!0,t.renderWidth,t.renderHeight,t.motionVectors?[e,s]:e,t.depthFormat,!1)}if(t.device.pushDeviceStates(),t.device.setFramebuffer(i),this._depthPass.encodeDepth="rgba8unorm"===i.getColorAttachments()[0].format,this._depthPass.clearColor=s?null:this._depthPass.encodeDepth?new O(0,0,0,1):new O(1,1,1,1),this._depthPass.clearDepth=s?null:1,this._depthPass.clearStencil=null,this._depthPass.transmission=s,t.SSRCalcThickness&&!s&&(this._backDepthColorState||(this._backDepthColorState=t.device.createColorState().setColorMask(!1,!0,!1,!1)),this._frontDepthColorState||(this._frontDepthColorState=t.device.createColorState().setColorMask(!0,!1,!1,!1)),t.forceColorState=this._backDepthColorState,t.forceCullMode="front",this._depthPass.renderBackface=!0,this._depthPass.transmission=!1,this._depthPass.render(t,null,e),this._depthPass.clearColor=null,this._depthPass.renderBackface=!1,t.forceColorState=this._frontDepthColorState,t.forceCullMode=null),this._depthPass.render(t,null,e),t.forceColorState=null,t.device.popDeviceStates(),!s&&(t.motionVectorTexture=t.motionVectors?i.getColorAttachments()[1]:null,t.linearDepthTexture=i.getColorAttachments()[0],t.depthTexture=i.getDepthAttachment(),t.motionVectorTexture&&this.renderSkyMotionVectors(t),t.HiZ)){let e=E(t.linearDepthTexture.width)?t.linearDepthTexture.width:M(t.linearDepthTexture.width),i=E(t.linearDepthTexture.height)?t.linearDepthTexture.height:M(t.linearDepthTexture.height);e=Math.max(1,e>>1),i=Math.max(1,i>>1),e=t.linearDepthTexture.width,i=t.linearDepthTexture.height;const s=t.device.pool.fetchTemporalFramebuffer(!0,e,i,t.linearDepthTexture.format,null,!0);!function(t,e){const i=Sl();_f||(_f=function(t){const e=t.buildRenderProgram({label:"HZBBuilder",vertex(e){this.$inputs.pos=e.vec2().attrib("position"),this.$outputs.uv=e.vec2(),e.main(function(){this.$builtins.position=e.vec4(this.$inputs.pos,1,1),this.$outputs.uv=e.add(e.mul(this.$inputs.pos.xy,.5),e.vec2(.5)),"webgpu"===t.type&&(this.$builtins.position.y=e.neg(this.$builtins.position.y))})},fragment(e){this.$outputs.color=e.vec4(),this.srcTex=e.tex2D().sampleType("unfilterable-float").uniform(0),this.srcSize=e.ivec2().uniform(0),"webgpu"!==t.type&&(this.srcMipLevel=e.int().uniform(0)),e.main(function(){this.$l.coord=e.mul(e.ivec2(this.$builtins.fragCoord.xy),2),this.$l.minCoord=e.ivec2(0,0),this.$l.maxCoord=e.sub(this.srcSize,e.ivec2(1,1));for(let i=0;i<4;i++)this.$l[`d${i}`]=e.textureLoad(this.srcTex,e.clamp(e.add(this.coord,e.ivec2(i>>1,1&i)),this.minCoord,this.maxCoord),"webgpu"===t.type?0:this.srcMipLevel).r;this.$l.d=e.min(e.min(this.d0,this.d1),e.min(this.d2,this.d3)),this.$outputs.color=e.vec4(this.d,0,0,1)})}});return e.name="@HZB_Builder",e}(i),gf=i.createBindGroup(_f.bindGroupLayouts[0]),xf=new zl,bf=new Int32Array(2)),xf.blit(t,e,Gl("clamp_nearest")),i.pushDeviceStates();const s=e.getColorAttachments()[0];if("webgpu"===i.type)for(let t=0;t<s.mipLevelCount-1;t++)vf(i,t,s,s);else{const t=i.pool.fetchTemporalFramebuffer(!1,e.getWidth(),e.getHeight(),e.getColorAttachments()[0].format,null,!0),r=t.getColorAttachments()[0];for(let t=0;t<s.mipLevelCount-1;t++)vf(i,t,s,r);i.pool.releaseFrameBuffer(t)}i.popDeviceStates()}(t.depthTexture,s),t.HiZTexture=s.getColorAttachments()[0]}return i}static _renderScene(t){const e=t.device,i=this._scenePass.cullScene(t,t.camera),s=t.scene.env.sky.update(t);t.clusteredLight=this.getClusteredLight(),t.clusteredLight.calculateLightIndex(t.camera,i);const r=t.camera.getPickResultResolveFunc();r&&this.renderObjectColors(t,r,i),this.renderShadowMaps(t,i.shadowedLights);const a=this.renderSceneDepth(t,i,null);if(t.depthTexture===t.finalFramebuffer?.getDepthAttachment()?t.intermediateFramebuffer=t.finalFramebuffer:t.intermediateFramebuffer=e.pool.fetchTemporalFramebuffer(!1,t.depthTexture.width,t.depthTexture.height,t.colorFormat,t.depthTexture),t.intermediateFramebuffer&&t.intermediateFramebuffer!==t.finalFramebuffer?(e.pushDeviceStates(),e.setFramebuffer(t.intermediateFramebuffer)):(e.setViewport(null),e.setScissor(null)),this._scenePass.transmission=!1,this._scenePass.clearDepth=t.depthTexture?null:1,this._scenePass.clearStencil=t.depthTexture?null:0,t.SSR&&!i.needSceneColor()&&(t.materialFlags|=gu.SSR_STORE_ROUGHNESS),t.compositor?.begin(t),i.needSceneColor()){const s=t.compositor;t.compositor=null;const r=e.pool.fetchTemporalFramebuffer(!0,t.depthTexture.width,t.depthTexture.height,t.materialFlags&gu.SSR_STORE_ROUGHNESS?[t.colorFormat,e.getFramebuffer().getColorAttachments()[1],e.getFramebuffer().getColorAttachments()[2]]:t.colorFormat,t.depthTexture,!1);e.pushDeviceStates(),e.setFramebuffer(r),this._scenePass.transmission=!1,this._scenePass.render(t,null,i),e.popDeviceStates(),t.sceneColorTexture=r.getColorAttachments()[0],(new zl).blit(t.sceneColorTexture,e.getFramebuffer()??null,Gl("clamp_nearest_nomip")),this._scenePass.transmission=!0,this._scenePass.clearColor=null,this._scenePass.clearDepth=null,this._scenePass.clearStencil=null,t.compositor=s}if(this._scenePass.render(t,null,i),i.needSceneColor()&&this.renderSceneDepth(t,i,a),t.compositor?.drawPostEffects(t,Dm.end,t.linearDepthTexture),t.compositor?.end(t),i.dispose(),t.materialFlags&=~gu.SSR_STORE_ROUGHNESS,t.intermediateFramebuffer&&t.intermediateFramebuffer!==t.finalFramebuffer){const i=new zl;i.srgbOut=!t.finalFramebuffer;const s=t.intermediateFramebuffer.getColorAttachments()[0];i.blit(s,t.finalFramebuffer??null,Gl("clamp_nearest_nomip")),e.popDeviceStates(),e.pool.releaseFrameBuffer(t.intermediateFramebuffer)}this.freeClusteredLight(t.clusteredLight),s&&(t.sunLight.color=s)}static _getSkyMotionVectorProgram(t){return this._skyMotionVectorProgram||(this._skyMotionVectorProgram=t.device.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec3().attrib("position"),this.VPMatrix=t.mat4().uniform(0),this.prevVPMatrix=t.mat4().uniform(0),this.cameraPos=t.vec3().uniform(0),this.prevCameraPos=t.vec3().uniform(0),t.main(function(){this.$l.worldPos=t.add(this.$inputs.pos,this.cameraPos),this.$l.prevWorldPos=t.add(this.$inputs.pos,this.prevCameraPos),this.$l.clipPos=t.mul(this.VPMatrix,t.vec4(this.worldPos,1)),this.$l.prevClipPos=t.mul(this.prevVPMatrix,t.vec4(this.prevWorldPos,1)),this.clipPos.z=this.clipPos.w,this.$builtins.position=this.clipPos,this.$outputs.currentPos=this.clipPos,this.$outputs.prevPos=this.prevClipPos})},fragment(t){this.$outputs.color=t.vec4(),t.main(function(){this.$l.motionVector=t.mul(t.sub(t.div(this.$inputs.currentPos.xy,this.$inputs.currentPos.w),t.div(this.$inputs.prevPos.xy,this.$inputs.prevPos.w)),.5),this.$outputs.color=t.vec4(this.motionVector,0,1)})}}),this._skyMotionVectorProgram.name="@TAA_SkyMotionVector"),this._skyMotionVectorProgram}static _getBox(t){return this._box||(this._box=new Um({size:2,needNormal:!1,needUV:!1})),this._box}static renderSkyMotionVectors(t){if(!t.motionVectorTexture)return;const e=t.device.pool.fetchTemporalFramebuffer(!1,0,0,t.motionVectorTexture,t.depthTexture),i=this._getSkyMotionVectorProgram(t);this._skyMotionVectorBindGroup||(this._skyMotionVectorBindGroup=t.device.createBindGroup(i.bindGroupLayouts[0]));const s=this._getBox(t);this._skyMotionVectorBindGroup.setValue("VPMatrix",t.camera.viewProjectionMatrix),this._skyMotionVectorBindGroup.setValue("prevVPMatrix",t.camera.prevVPMatrix),this._skyMotionVectorBindGroup.setValue("cameraPos",t.camera.getWorldPosition()),this._skyMotionVectorBindGroup.setValue("prevCameraPos",t.camera.prevPosition),t.device.pushDeviceStates(),t.device.setProgram(i),t.device.setBindGroup(0,this._skyMotionVectorBindGroup),t.device.setRenderStates(Nm.getDefaultRenderState(t,"le")),t.device.setFramebuffer(e),s.draw(),t.device.popDeviceStates(),t.device.pool.releaseFrameBuffer(e)}static renderShadowMaps(t,e){t.renderPass=this._shadowMapPass,t.device.pushDeviceStates();for(const i of e)i.shadow.render(t,this._shadowMapPass);t.device.popDeviceStates()}static decodeNormalizedFloat(t){return t[0]/255/16777216+t[1]/255/65536+t[2]/255/256+t[3]/255}static renderObjectColors(t,e,i){const s=t.camera,r="webgl"===t.device.type;t.renderPass=this._objectColorPass,t.device.pushDeviceStates();const a=t.device.pool.fetchTemporalFramebuffer(!1,1,1,r?["rgba8unorm","rgba8unorm"]:["rgba8unorm","rgba32f"],t.depthFormat,!1);t.device.setViewport(s.viewport);const n=t.device.getViewport(),o=s.getPickPosX()/n.width,h=(n.height-s.getPickPosY()-1)/n.height,l=1/n.width,u=1/n.height;s.worldMatrix.decompose(this._pickCamera.scale,this._pickCamera.rotation,this._pickCamera.position);let c=s.getProjectionMatrix().getLeftPlane(),d=s.getProjectionMatrix().getRightPlane(),p=s.getProjectionMatrix().getBottomPlane(),m=s.getProjectionMatrix().getTopPlane();const f=s.getProjectionMatrix().getNearPlane(),_=s.getProjectionMatrix().getFarPlane(),g=d-c,x=m-p;c+=g*o,p+=x*h,d=c+g*l,m=p+x*u,this._pickCamera.setProjectionMatrix(s.isPerspective()?W.frustum(c,d,p,m,f,_):W.ortho(c,d,p,m,f,_));const b=r?new z(this._pickCamera.position):null,v=r?s.constructRay(s.getPickPosX(),s.getPickPosY()):null;t.device.setFramebuffer(a),this._objectColorPass.clearColor=O.zero(),this._objectColorPass.clearDepth=1;const y=this._objectColorPass.cullScene(t,this._pickCamera);t.camera=this._pickCamera,this._objectColorPass.render(t,null,y),y.dispose(),t.camera=s,t.device.popDeviceStates();const T=a.getColorAttachments()[0],w=a.getColorAttachments()[1],S=new Uint8Array(4),A=r?new Uint8Array(4):new Float32Array(4),C=t.device;let E;E="webgl"===t.device.type?Promise.all([t.device.runNextFrameAsync(()=>T.readPixels(0,0,1,1,0,0,S)),t.device.runNextFrameAsync(()=>w.readPixels(0,0,1,1,0,0,A))]):Promise.all([T.readPixels(0,0,1,1,0,0,S),w.readPixels(0,0,1,1,0,0,A)]),E.then(()=>{const t=i.getDrawableByColor(S);let s=r?this.decodeNormalizedFloat(A)*_:A[0];const n=new z(A[0],A[1],A[2]);r&&(n.x=b.x+v.direction.x*s,n.y=b.y+v.direction.y*s,n.z=b.z+v.direction.z*s,s=z.distance(n,b)),e(t?{distance:s,intersectedPoint:n,drawable:t,target:t.getPickTarget()}:null),C.pool.releaseFrameBuffer(a)}).catch(t=>{s.getPickResultResolveFunc()?.(null),C.pool.releaseFrameBuffer(a)})}}const Tf={height_fog:bu.FOG_TYPE_HEIGHT,none:bu.FOG_TYPE_NONE},wf=W.identity();class Sf extends gt{static _skyCamera=(()=>{const t=new df(null);return t.setPerspective(Math.PI/2,1,1,20),t})();static transmittanceLutProgram=null;static multiScatteringLutProgram=null;static skyViewLutProgram=null;static APLutProgram=null;static _programSky={};static _programDistantLight=null;static _programFog=null;static _programFogNoDepth=null;static _vertexLayout=null;static _primitiveSky=null;static _primitiveDistantLight=null;static _renderStatesSky=null;static _renderStatesSkyNoDepthTest=null;static _renderStatesFog=null;static _renderStatesFogScatter=null;static _renderStatesDistantLight=null;static _defaultSkyImage=new wt;_skyType;_skyColor;_skyImage;_bakedSkyboxDirty;_bakedSkyboxTextureSize;_skyboxTextureSize;_skyboxTexture;_bakedSkyboxTexture;_bakedSkyboxFrameBuffer;_radianceMap;_radianceFrameBuffer;_irradianceSH;_irradianceSHFB;_skyDistantLightLut;_irradianceFrameBuffer;_radianceMapWidth;_atmosphereParams;_atmosphereExposure;_fogType;_heightFogParams;_cloudy;_cloudIntensity;_debugAerialPerspective;_wind;_skyWorldMatrix;_lastSunDir;_lastSunColor;_panoramaAsset;_shProjector;_shWindowWeights;_radianceConvSamples;_irradianceConvSamples;_bindgroupDistantLight=null;_bindgroupSky={};_bindgroupFog=null;_bindgroupFogNoDepth=null;_format;constructor(){super(),this._skyType="scatter",this._skyColor=O.one(),this._skyImage=new wt,this._skyboxTexture=new wt,this._skyboxTextureSize=1024,this._bakedSkyboxTexture=new wt,this._bakedSkyboxFrameBuffer=new wt,this._bakedSkyboxDirty=!0,this._bakedSkyboxTextureSize=256,this._radianceMap=new wt,this._radianceFrameBuffer=new wt,this._radianceMapWidth=128,this._irradianceSH=new wt,this._irradianceSHFB=new wt,this._skyDistantLightLut=new wt,this._irradianceFrameBuffer=new wt,this._atmosphereParams=Nu(),this._atmosphereExposure=1,this._debugAerialPerspective=0,this._fogType="height_fog",this._heightFogParams=yc(),this._cloudy=.45,this._cloudIntensity=15,this._wind=new L(0,0),this._skyWorldMatrix=wf,this._lastSunDir=Sf._getSunDir(null),this._lastSunColor=Sf._getSunColor(null),this._panoramaAsset="",this._shProjector=new ou(1e4),this._shWindowWeights=new z(1,.8,.6),this._radianceConvSamples=64,this._irradianceConvSamples=256,this._bindgroupDistantLight=new wt,this._bindgroupSky={},this._bindgroupFog=new wt,this._bindgroupFogNoDepth=new wt;const t=Sl().getDeviceCaps().textureCaps;this._format=t.getTextureFormatInfo("rg11b10uf")?.renderable?"rg11b10uf":t.supportHalfFloatColorBuffer&&t.supportLinearHalfFloatTexture?"rgba16f":"rgba32f"}getHash(t){return`${this.skyType}:${this.fogType}`}get envTextureFormat(){return this._format}get skyType(){return this._skyType}set skyType(t){t!==this._skyType&&(this._skyType=t,this.invalidate())}get panoramaTextureAsset(){return this._panoramaAsset}set panoramaTextureAsset(t){if(t!==this._panoramaAsset){if(this._panoramaAsset=t??"",!this._panoramaAsset)return void(this.skyboxTexture=null);this._updateSkyboxTexture()}}get skyboxTextureSize(){return this._skyboxTextureSize}set skyboxTextureSize(t){t!==this._skyboxTextureSize&&(this._skyboxTextureSize=t,this._updateSkyboxTexture())}getBakedSkyTexture(t){return this._bakedSkyboxDirty&&this.update(t),this._bakedSkyboxTexture.get()}get skyColor(){return this._skyColor}set skyColor(t){t.equalsTo(this._skyColor)||(this._skyColor.set(t),this.invalidate())}get skyImage(){return this._skyImage.get()}set skyImage(t){t!==this._skyImage.get()&&(this._skyImage.set(t),this.invalidate())}get shWindowWeights(){return this._shWindowWeights}set shWindowWeights(t){this._shWindowWeights.set(t),this.invalidate()}get radianceConvSamples(){return this._radianceConvSamples}set radianceConvSamples(t){t!==this._radianceConvSamples&&(this._radianceConvSamples=t,this.invalidate())}get irradianceConvSamples(){return this._irradianceConvSamples}set irradianceConvSamples(t){t!==this._irradianceConvSamples&&(this._irradianceConvSamples=t,this.invalidate())}get aerialPerspectiveDistance(){return this._atmosphereParams.apDistance}set aerialPerspectiveDistance(t){t!==this._atmosphereParams.apDistance&&(this._atmosphereParams.apDistance=t,this.invalidate())}get atmosphereExposure(){return this._atmosphereExposure}set atmosphereExposure(t){t!==this._atmosphereExposure&&(this._atmosphereExposure=t,this.invalidate())}get cameraHeightScale(){return this._atmosphereParams.cameraHeightScale}set cameraHeightScale(t){t!==this._atmosphereParams.cameraHeightScale&&(this._atmosphereParams.cameraHeightScale=t,this.invalidate())}get heightFogColor(){return this._heightFogParams.parameter1.xyz()}set heightFogColor(t){t.equalsTo(this._heightFogParams.parameter1.xyz())||(this._heightFogParams.parameter1.set(t),this.invalidate())}get heightFogDensity(){return this._heightFogParams.parameter2.x}set heightFogDensity(t){t!==this._heightFogParams.parameter2.x&&(this._heightFogParams.parameter2.x=t,this.invalidate())}get heightFogFalloff(){return this._heightFogParams.parameter1.w}set heightFogFalloff(t){t!==this._heightFogParams.parameter1.w&&(this._heightFogParams.parameter1.w=t,this.invalidate())}get heightFogStartHeight(){return this._heightFogParams.parameter2.y}set heightFogStartHeight(t){t!==this._heightFogParams.parameter2.y&&(this._heightFogParams.parameter2.y=t,this.invalidate())}get heightFogStartDistance(){return this._heightFogParams.parameter2.z}set heightFogStartDistance(t){t!==this._heightFogParams.parameter2.z&&(this._heightFogParams.parameter2.z=t,this.invalidate())}get heightFogEndDistance(){return this._heightFogParams.parameter2.w}set heightFogEndDistance(t){t!==this._heightFogParams.parameter2.w&&(this._heightFogParams.parameter2.w=t,this.invalidate())}get heightFogMaxOpacity(){return this._heightFogParams.parameter3.x}set heightFogMaxOpacity(t){t!==this._heightFogParams.parameter3.x&&(this._heightFogParams.parameter3.x=t,this.invalidate())}get heightFogAtmosphereContribution(){return this._heightFogParams.parameter3.y}set heightFogAtmosphereContribution(t){t!==this._heightFogParams.parameter3.y&&(this._heightFogParams.parameter3.y=t,this.invalidate())}get heightFogDirExponent(){return this._heightFogParams.parameter3.w}set heightFogDirExponent(t){t!==this._heightFogParams.parameter3.w&&(this._heightFogParams.parameter3.w=t,this.invalidate())}get heightFogDirColor(){return this._heightFogParams.parameter4.xyz()}set heightFogDirColor(t){t.equalsTo(this._heightFogParams.parameter4.xyz())||(this._heightFogParams.parameter4.set(t),this.invalidate())}get cloudy(){return this._cloudy}set cloudy(t){t!==this._cloudy&&"scatter"===this._skyType&&(this._cloudy=t,this.invalidate())}get cloudIntensity(){return this._cloudIntensity}set cloudIntensity(t){t!==this._cloudIntensity&&"scatter"===this._skyType&&(this._cloudIntensity=t,this.invalidate())}get wind(){return this._wind}set wind(t){this._wind.set(t)}get radianceMap(){return this._radianceMap.get()||(this._radianceMap.set(Sl().createCubeTexture(this._format,this._radianceMapWidth)),this._radianceMap.get().name="SkyRadianceMap"),this._radianceMap.get()}get atmosphereParams(){return this._atmosphereParams}get heightFogParams(){return this._heightFogParams}get radianceFramebuffer(){return this._radianceFrameBuffer.get()||this._radianceFrameBuffer.set(Sl().createFrameBuffer([this.radianceMap],null)),this._radianceFrameBuffer.get()}get irradianceSH(){if(!this._irradianceSH.get()){const t=Sl().createBuffer(144,{usage:"uniform"});this._irradianceSH.set(t)}return this._irradianceSH.get()}get irradianceSHFB(){if(!this._irradianceSHFB.get()){const t=Sl(),e=t.createTexture2D("rgba32f",3,3,{mipmapping:!1});this._irradianceSHFB.set(t.createFrameBuffer([e],null))}return this._irradianceSHFB.get()}get skyboxTexture(){return this._skyboxTexture.get()}set skyboxTexture(t){t!==this.skyboxTexture&&(this._skyboxTexture.set(t),"skybox"===this._skyType&&this.invalidate())}get skyWorldMatrix(){return this._skyWorldMatrix}set skyWorldMatrix(t){(t=t??wf)!==this._skyWorldMatrix&&(this._skyWorldMatrix=t,this.invalidate())}get mappedFogType(){return Tf[this._fogType]}get fogType(){return this._fogType}set fogType(t){t!==this._fogType&&(this._fogType=t,this.invalidate())}get aerialPerspectiveDebug(){return this._debugAerialPerspective}set aerialPerspectiveDebug(t){this._debugAerialPerspective=t}get fogPresents(){return"scatter"===this._skyType||"none"!==this._fogType}invalidate(){this._bakedSkyboxDirty=!0}drawScatteredFog(t){return"scatter"===this.skyType}getAerialPerspectiveLUT(t){return fc()}getSkyDistantLightLUT(t){return this._skyDistantLightLut.get().getColorAttachments()[0]}update(t){const e="scatter"===this._skyType;!e&&Gu&&Xu&&Yu&&Ju||this.renderAtmosphereLUTs(t);const i=t.sunLight&&e?t.sunLight.color:null,s=Sf._getSunDir(t.sunLight),r=Sf._getSunColor(t.sunLight);if("scatter"!==this._skyType||0===this._wind.x&&0===this._wind.y||(this._bakedSkyboxDirty=!0),!this._skyDistantLightLut.get()){const e=t.device.createTexture2D(this._format,1,1,{mipmapping:!1});e.name="DistantSkyLut",this._skyDistantLightLut.set(t.device.createFrameBuffer([e],null)),this._bakedSkyboxDirty=!0}s.equalsTo(this._lastSunDir)&&r.equalsTo(this._lastSunColor)||(this._lastSunDir.set(s),this._lastSunColor.set(r),this._bakedSkyboxDirty=!0),this._bakedSkyboxDirty&&(this._bakedSkyboxDirty=!1,this.updateBakedSkyMap(t),this.renderSkyDistantLut(t,this._bakedSkyboxTexture.get()),t.scene.env.light.radianceMap&&(t.scene.env.light.radianceMap===this.radianceMap||this._irradianceSH.get()&&t.scene.env.light.irradianceSH===this.irradianceSH||this._irradianceSHFB.get()&&t.scene.env.light.irradianceSHFB===this.irradianceSHFB)&&(Zl(this._bakedSkyboxTexture.get(),"ggx",this.radianceFramebuffer,this._radianceConvSamples),"webgl"!==t.device.type&&t.device.getDeviceCaps().framebufferCaps.supportFloatBlending?this._shProjector.projectCubemap(this._bakedSkyboxTexture.get(),this.irradianceSH):this._shProjector.projectCubemapToTexture(this._bakedSkyboxTexture.get(),this.irradianceSHFB),t.scene.env.light.irradianceSH=this.irradianceSH,t.scene.env.light.irradianceWindow=this._shWindowWeights));const a=i?z.mul(t.sunLight.color.xyz(),this.sunTransmittance(t.sunLight)):z.zero();if(i&&t.sunLight.setColor(a),"height_fog"===this._fogType){const e=Math.min(this._heightFogParams.parameter2.y+100,t.camera.getWorldPosition().y),i=Math.max(-125,Math.min(126,-this._heightFogParams.parameter1.w*(e-this._heightFogParams.parameter2.y)));this._heightFogParams.parameter3.z=this._heightFogParams.parameter2.x*Math.pow(2,i),this._heightFogParams.lightColor.set(a),this._heightFogParams.lightDir.set(Sf._getSunDir(t.sunLight))}return i}renderAtmosphereLUTs(t){this._atmosphereParams.lightDir.set(Sf._getSunDir(t.sunLight)),this._atmosphereParams.lightColor.set(Sf._getSunColor(t.sunLight)),this._atmosphereParams.lightColor.w*=this._atmosphereExposure,this._atmosphereParams.cameraAspect=t.camera.getAspect(),this._atmosphereParams.cameraWorldMatrix.set(t.camera.worldMatrix),mc(this._atmosphereParams)}renderSkyDistantLut(t,e){this._prepareSkyBox(t.device),t.device.pushDeviceStates(),t.device.setRenderStates(Sf._renderStatesDistantLight),t.device.setProgram(Sf._programDistantLight),t.device.setFramebuffer(this._skyDistantLightLut.get()),t.device.clearFrameBuffer(new O(0,0,0,1),null,null),this._bindgroupDistantLight.get().setTexture("skybox",e,Gl("clamp_linear_nomip")),t.device.setBindGroup(0,this._bindgroupDistantLight.get()),Sf._primitiveDistantLight.draw(),t.device.popDeviceStates()}updateBakedSkyMap(t){const e=t.device,i=this._bakedSkyboxTexture.get()&&this._bakedSkyboxTexture.get().width===this._bakedSkyboxTextureSize?this._bakedSkyboxTexture.get():e.createCubeTexture(this._format,this._bakedSkyboxTextureSize,{mipmapping:!1});i.name="BakedSkyboxTexture",i!==this._bakedSkyboxTexture.get()&&this._bakedSkyboxFrameBuffer.set(e.createFrameBuffer([i],null));const s=Sf._skyCamera,r=e.getRenderStates();e.pushDeviceStates(),e.setFramebuffer(this._bakedSkyboxFrameBuffer.get());for(const t of[R.PX,R.NX,R.PY,R.NY,R.PZ,R.NZ])s.lookAtCubeFace(t),this._bakedSkyboxFrameBuffer.get().setColorAttachmentCubeFace(0,t),this._renderSky(s,!1);e.popDeviceStates(),this.renderSkyDistantLut(t,i),e.pushDeviceStates(),e.setFramebuffer(this._bakedSkyboxFrameBuffer.get());for(const t of[R.PX,R.NX,R.PY,R.NY,R.PZ,R.NZ])s.lookAtCubeFace(t),this._bakedSkyboxFrameBuffer.get().setColorAttachmentCubeFace(0,t),this.renderFog(s);e.popDeviceStates(),e.setRenderStates(r),this._bakedSkyboxTexture.set(i)}renderUberFog(t,e){const i=Sl(),s=e?Sf._programFog:Sf._programFogNoDepth,r=Sf._renderStatesFog,a=e?this._bindgroupFog.get():this._bindgroupFogNoDepth.get();e&&a.setTexture("depthTex",e,Gl("clamp_nearest_nomip")),a.setTexture("skyDistantLightLut",this._skyDistantLightLut.get().getColorAttachments()[0],Gl("clamp_nearest_nomip")),a.setTexture("apLut",fc(),Gl("clamp_linear_nomip")),a.setValue("rt",i.getFramebuffer()?1:0),a.setValue("invProjViewMatrix",t.invViewProjectionMatrix),a.setValue("cameraNearFar",new L(t.getNearPlane(),t.getFarPlane())),a.setValue("cameraPosition",t.getWorldPosition()),a.setValue("srgbOut",i.getFramebuffer()?0:1),a.setValue("withAerialPerspective","scatter"===this.skyType?1:0),a.setValue("fogType",this.mappedFogType),a.setValue("atmosphereParams",this._atmosphereParams),a.setValue("heightFogParams",this._heightFogParams),i.setProgram(s),i.setBindGroup(0,a),i.setVertexLayout(Sf._vertexLayout),i.setRenderStates(r),i.draw("triangle-strip",0,4)}renderFog(t){const e=Sl(),i=e.getFramebuffer(),s=i?.getDepthAttachment()??null,r=i?.getColorAttachments()[0]??null,a=s&&r?e.pool.fetchTemporalFramebuffer(!1,0,0,r,null,!1):null;if(a){const t=e.getViewport(),i=e.getScissor();e.pushDeviceStates(),e.setFramebuffer(a),e.setViewport(t),e.setScissor(i)}const n=e.getRenderStates();this._prepareSkyBox(e),this.renderUberFog(t,s),e.setRenderStates(n),a&&(e.popDeviceStates(),e.pool.releaseFrameBuffer(a))}renderSky(t){let e=t.camera;e.isPerspective()||(e=Sf._skyCamera,t.camera.worldMatrix.decompose(null,e.rotation,null)),this._renderSky(e,!0)}onDispose(){super.onDispose(),this._skyboxTexture.dispose(),this._bakedSkyboxTexture.dispose(),this._bakedSkyboxFrameBuffer.dispose(),this._radianceMap.dispose(),this._radianceFrameBuffer.dispose(),this._irradianceSH.dispose(),this._irradianceSHFB.dispose(),this._irradianceFrameBuffer.dispose(),this._shProjector.dispose(),this._skyDistantLightLut.get()&&(this._skyDistantLightLut.get().getColorAttachments()[0].dispose(),this._skyDistantLightLut.dispose()),this._bindgroupDistantLight.dispose();for(const t in this._bindgroupSky)this._bindgroupSky[t].dispose();this._bindgroupSky={},this._bindgroupFog.dispose(),this._bindgroupFogNoDepth.dispose()}_updateSkyboxTexture(){this._panoramaAsset&&wl().resourceManager.fetchTexture(this._panoramaAsset).then(t=>{if(t.isTexture2D()){const e=Sl().createCubeTexture(this._format,this._skyboxTextureSize,{mipmapping:!1});nu(t,e),e.name="SkyboxTexture",this.skyboxTexture=e}else console.error(`Invalid panorama texture asset: ${this._panoramaAsset}`)}).catch(t=>{console.error(`Load asset failed: ${this._panoramaAsset}: ${t}`)})}_renderSky(t,e){const i=Sl(),s=i.getRenderStates();this._prepareSkyBox(i),"scatter"===this._skyType?this._drawScattering(t,e):"skybox"===this._skyType&&this.skyboxTexture?this._drawSkybox(t,e):this._drawSkyColor(t,e),i.setRenderStates(s)}_drawSkyColor(t,e){const i=Sl(),s=this._bindgroupSky.image.get();s.setValue("color",this._skyColor),s.setTexture("texture",this._skyImage.get()??Sf._defaultSkyImage.get(),Gl("clamp_linear_nomip")),s.setValue("flip",i.getFramebuffer()&&"webgpu"===i.type?-1:1),s.setValue("srgbOut",i.getFramebuffer()?0:1),i.setProgram(Sf._programSky.image),i.setBindGroup(0,s),Ru(e?Sf._renderStatesSky:Sf._renderStatesSkyNoDepthTest)}_drawSkybox(t,e){const i=Sl(),s=this._bindgroupSky.skybox.get();s.setTexture("skyCubeMap",this.skyboxTexture,Gl("clamp_linear_nomip")),s.setValue("flip",i.getFramebuffer()&&"webgpu"===i.type?new O(1,-1,1,1):new O(1,1,1,1)),s.setValue("viewProjMatrix",t.viewProjectionMatrix),s.setValue("worldMatrix",this._skyWorldMatrix),s.setValue("cameraPos",t.getWorldPosition()),s.setValue("srgbOut",i.getFramebuffer()?0:1),i.setProgram(Sf._programSky.skybox),i.setBindGroup(0,s),i.setRenderStates(e?Sf._renderStatesSky:Sf._renderStatesSkyNoDepthTest),Sf._primitiveSky.draw()}_rayIntersectSphere(t,e,i){const s=e.magnitude,r=-z.dot(e,i),a=Math.sqrt(Math.max(0,s*s-r*r)),n=Math.sqrt(Math.max(0,t*t-a*a));if(a>t)return-1;const o=r-n;return o<0?r+n:o}sunTransmittance(t){const e=[5.802,13.558,33.1],i=3.996,s=[.65,1.881,.085];function r(t,i){const s=new z(1e-6*e[0],1e-6*e[1],1e-6*e[2]),r=Math.exp(-i/t.rayleighScatteringHeight);return z.scale(s,r)}function a(t,e){const s=new z(1e-6*i,1e-6*i,1e-6*i),r=Math.exp(-e/t.mieScatteringHeight);return z.scale(s,r)}function n(t,e){const i=new z(44e-7,44e-7,44e-7),s=Math.exp(-e/t.mieScatteringHeight);return z.scale(i,s)}function o(t,e){const i=new z(1e-6*s[0],1e-6*s[1],1e-6*s[2]),r=Math.max(0,1-.5*Math.abs(e-t.ozoneCenter)/t.ozoneWidth);return z.scale(i,r)}const h=new z(0,this._atmosphereParams.plantRadius+this._atmosphereParams.cameraHeightScale,0),l=Sf._getSunDir(t),u=this._rayIntersectSphere(this._atmosphereParams.plantRadius+this._atmosphereParams.atmosphereHeight,h,l);if(u<0)return new z(0,0,0);const c=u/32,d=new z(0,0,0),p=z.combine(h,l,1,.5*c);for(let t=0;t<32;t++){const t=p.magnitude-this._atmosphereParams.plantRadius,e=z.add(r(this._atmosphereParams,t),a(this._atmosphereParams,t)),i=z.add(o(this._atmosphereParams,t),n(this._atmosphereParams,t)),s=z.add(e,i);z.add(d,z.scale(s,c),d),z.add(p,z.scale(l,c),p)}return new z(Math.exp(-d.x),Math.exp(-d.y),Math.exp(-d.z))}_drawScattering(t,e){const i=Sl(),s=Gu,r=Yu,a=Sf._programSky.scatter,n=this._bindgroupSky.scatter.get();n.setValue("flip",i.getFramebuffer()&&"webgpu"===i.type?new O(1,-1,1,1):new O(1,1,1,1)),n.setValue("params",this._atmosphereParams),n.setValue("viewProjMatrix",t.viewProjectionMatrix),n.setValue("worldMatrix",this._skyWorldMatrix),n.setValue("cameraPos",t.getWorldPosition()),n.setValue("srgbOut",i.getFramebuffer()?0:1),n.setTexture("tLut",s,Gl("clamp_linear_nomip")),n.setTexture("skyLut",r,Gl("clamp_linear_nomip")),n.setValue("cloudy",this._cloudy),n.setValue("cloudIntensity",this._cloudIntensity),n.setValue("time",.001*i.frameInfo.elapsedOverall),n.setValue("velocity",this._wind),i.setProgram(a),i.setBindGroup(0,n),i.setRenderStates(e?Sf._renderStatesSky:Sf._renderStatesSkyNoDepthTest),Sf._primitiveSky.draw()}_prepareSkyBox(t){if(Sf._createAtmosphereLUTPrograms(t),!Sf._defaultSkyImage.get()){const e=t.createTexture2D("rgba8unorm",1,1,{mipmapping:!1});e.update(new Uint8Array([255,255,255,255]),0,0,1,1),Sf._defaultSkyImage.set(e)}if(Sf._programDistantLight||(Sf._programDistantLight=t.buildRenderProgram({vertex(t){this.$inputs.vector=t.vec3().attrib("position"),t.main(function(){this.$outputs.vector=this.$inputs.vector,this.$builtins.position=t.vec4(0,0,0,1),"webgpu"!==t.getDevice().type&&(this.$builtins.pointSize=1)})},fragment(t){this.$outputs.color=t.vec4(),this.skybox=t.texCube().uniform(0),t.main(function(){this.$l.sunColor=t.vec4(),this.$l.skyColor=t.textureSampleLevel(this.skybox,this.$inputs.vector,0).rgb,this.$outputs.color=t.vec4(t.mul(this.skyColor,1/64),1)})}}),Sf._programDistantLight.name="@SkyDistantLight"),this._bindgroupDistantLight.get()||this._bindgroupDistantLight.set(t.createBindGroup(Sf._programDistantLight.bindGroupLayouts[0])),Sf._programFog||(Sf._programFog=Sf._createFogProgram(t,!1)),Sf._programFogNoDepth||(Sf._programFogNoDepth=Sf._createFogProgram(t,!0)),this._bindgroupFog.get()||this._bindgroupFog.set(t.createBindGroup(Sf._programFog.bindGroupLayouts[0])),this._bindgroupFogNoDepth.get()||this._bindgroupFogNoDepth.set(t.createBindGroup(Sf._programFogNoDepth.bindGroupLayouts[0])),Sf._programSky.image||(Sf._programSky.image=t.buildRenderProgram({label:"ImageSky",vertex(e){this.$inputs.pos=e.vec2().attrib("position"),this.$outputs.uv=e.vec2(),this.flip=e.int().uniform(0),e.main(function(){this.$builtins.position=e.vec4(this.$inputs.pos,1,1),this.$outputs.uv=e.add(e.mul(this.$inputs.pos.xy,.5),e.vec2(.5)),"webgpu"!==t.type&&(this.$builtins.position.y=e.neg(this.$builtins.position.y))})},fragment(t){this.$outputs.outColor=t.vec4(),this.color=t.vec4().uniform(0),this.texture=t.tex2D().uniform(0),this.srgbOut=t.int().uniform(0),t.main(function(){this.$l.sampleColor=t.textureSampleLevel(this.texture,this.$inputs.uv,0),this.$l.outColor=t.mul(this.sampleColor,this.color),this.$if(t.equal(this.srgbOut,0),function(){this.$outputs.outColor=t.vec4(this.outColor.rgb,1)}).$else(function(){this.$outputs.outColor=t.vec4(Il(this,this.outColor.rgb),1)})})}}),Sf._programSky.image.name="@SkyImage"),this._bindgroupSky.image||(this._bindgroupSky.image=new wt(t.createBindGroup(Sf._programSky.image.bindGroupLayouts[0]))),Sf._programSky.scatter||(Sf._programSky.scatter=Sf._createScatterProgram(t,!0)),this._bindgroupSky.scatter||(this._bindgroupSky.scatter=new wt(t.createBindGroup(Sf._programSky.scatter.bindGroupLayouts[0]))),Sf._programSky.skybox||(Sf._programSky.skybox=t.buildRenderProgram({label:"SkyBoxSky",vertex(t){this.$inputs.pos=t.vec3().attrib("position"),this.$outputs.texCoord=t.vec3(),this.worldMatrix=t.mat4().uniform(0),this.viewProjMatrix=t.mat4().uniform(0),this.cameraPos=t.vec3().uniform(0),this.flip=t.vec4().uniform(0),t.main(function(){this.$outputs.texCoord=this.$inputs.pos,this.$l.worldPos=t.add(this.cameraPos,t.mul(this.worldMatrix,t.vec4(this.$inputs.pos,0)).xyz),this.$builtins.position=t.mul(this.viewProjMatrix,t.vec4(this.worldPos,1),this.flip),this.$builtins.position.z=this.$builtins.position.w})},fragment(t){this.$outputs.outColor=t.vec4(),this.skyCubeMap=t.texCube().uniform(0),this.srgbOut=t.int().uniform(0),t.main(function(){this.$l.texCoord=t.normalize(this.$inputs.texCoord),this.$l.color=t.textureSampleLevel(this.skyCubeMap,this.texCoord,0).rgb,this.$if(t.equal(this.srgbOut,0),function(){this.$outputs.outColor=t.vec4(this.color,1)}).$else(function(){this.$outputs.outColor=t.vec4(Il(this,this.color),1)})})}}),Sf._programSky.skybox.name="@SkySkybox"),this._bindgroupSky.skybox||(this._bindgroupSky.skybox=new wt(t.createBindGroup(Sf._programSky.skybox.bindGroupLayouts[0]))),Sf._renderStatesSky||(Sf._renderStatesSky=t.createRenderStateSet(),Sf._renderStatesSky.useDepthState().enableTest(!0).enableWrite(!1).setCompareFunc("le"),Sf._renderStatesSky.useRasterizerState().setCullMode("none")),Sf._renderStatesSkyNoDepthTest||(Sf._renderStatesSkyNoDepthTest=t.createRenderStateSet(),Sf._renderStatesSkyNoDepthTest.useDepthState().enableTest(!1).enableWrite(!1),Sf._renderStatesSkyNoDepthTest.useRasterizerState().setCullMode("none")),Sf._renderStatesFog||(Sf._renderStatesFog=t.createRenderStateSet(),Sf._renderStatesFog.useRasterizerState().setCullMode("none"),Sf._renderStatesFog.useBlendingState().enable(!0).setBlendFunc("one","src-alpha"),Sf._renderStatesFog.useDepthState().enableTest(!1).enableWrite(!1)),Sf._renderStatesFogScatter||(Sf._renderStatesFogScatter=t.createRenderStateSet(),Sf._renderStatesFogScatter.useRasterizerState().setCullMode("none"),Sf._renderStatesFogScatter.useBlendingState().enable(!0).setBlendFunc("one","src-alpha"),Sf._renderStatesFogScatter.useDepthState().enableTest(!0).enableWrite(!1).setCompareFunc("gt")),Sf._renderStatesDistantLight||(Sf._renderStatesDistantLight=t.createRenderStateSet(),Sf._renderStatesDistantLight.useDepthState().enableTest(!1).enableWrite(!1),Sf._renderStatesDistantLight.useBlendingState().enable(!0).setBlendEquation("add","add").setBlendFuncRGB("one","one").setBlendFuncAlpha("zero","one"),Sf._renderStatesDistantLight.useRasterizerState().setCullMode("none")),Sf._vertexLayout||(Sf._vertexLayout=t.createVertexLayout({vertexBuffers:[{buffer:t.createVertexBuffer("position_f32x2",new Float32Array([-1,-1,1,-1,-1,1,1,1]))}]})),Sf._primitiveSky||(Sf._primitiveSky=new Um({size:8})),!Sf._primitiveDistantLight){const t=new Float32Array(3*xu.length);let e=0;for(const i of xu)t[e++]=i.x,t[e++]=i.y,t[e++]=i.z;Sf._primitiveDistantLight=new Cl,Sf._primitiveDistantLight.createAndSetVertexBuffer("position_f32x3",t),Sf._primitiveDistantLight.indexCount=xu.length,Sf._primitiveDistantLight.indexStart=0,Sf._primitiveDistantLight.primitiveType="point-list"}}static _createFogProgram(t,e){const i=t.buildRenderProgram({label:"Fog",vertex(e){this.rt=e.int().uniform(0),this.$inputs.pos=e.vec2().attrib("position"),this.$outputs.uv=e.vec2(),e.main(function(){this.$builtins.position=e.vec4(this.$inputs.pos,1,1),this.$outputs.uv=e.add(e.mul(this.$inputs.pos.xy,.5),e.vec2(.5)),"webgpu"===t.type&&this.$if(e.notEqual(this.rt,0),function(){this.$builtins.position.y=e.neg(this.$builtins.position.y)})})},fragment(t){const i=_c(t),s=Tc(t);e||(this.depthTex=t.tex2D().sampleType("unfilterable-float").uniform(0)),this.apLut=t.tex2D().uniform(0),this.skyDistantLightLut=t.tex2D().uniform(0),this.invProjViewMatrix=t.mat4().uniform(0),this.cameraNearFar=t.vec2().uniform(0),this.cameraPosition=t.vec3().uniform(0),this.withAerialPerspective=t.int().uniform(0),this.fogType=t.int().uniform(0),this.atmosphereParams=i().uniform(0),this.heightFogParams=s().uniform(0),this.srgbOut=t.int().uniform(0),this.$outputs.outColor=t.vec4(),t.main(function(){this.$l.depthValue=e?t.float(1):t.textureSample(this.depthTex,this.$inputs.uv).r,this.$l.clipSpacePos=t.vec4(t.sub(t.mul(this.$inputs.uv,2),t.vec2(1)),t.sub(t.mul(this.depthValue,2),1),1),this.$l.hPos=t.mul(this.invProjViewMatrix,this.clipSpacePos),this.$l.worldPos=t.div(this.$l.hPos,this.$l.hPos.w).xyz,this.$l.isSky=t.equal(this.$l.depthValue,1),this.$l.color=wc(this,this.withAerialPerspective,this.fogType,this.atmosphereParams,this.heightFogParams,this.$inputs.uv,this.isSky,this.cameraPosition,this.worldPos,0,this.apLut,this.skyDistantLightLut),this.$if(t.equal(this.srgbOut,0),function(){this.$outputs.outColor=this.color}).$else(function(){this.$outputs.outColor=t.vec4(Il(this,this.color.rgb),this.color.a)})})}});return i.name=e?"@FogNoDepth":"@Fog",i}static _getSunDir(t){return t?.directionAndCutoff.xyz().scaleBy(-1)??Qc.defaultSunDir}static _getSunColor(t){return t?.diffuseAndIntensity??new O(1,1,1,10)}static _createAtmosphereLUTPrograms(t){this.transmittanceLutProgram||(this.transmittanceLutProgram=gc(t)),this.multiScatteringLutProgram||(this.multiScatteringLutProgram=xc(t)),this.skyViewLutProgram||(this.skyViewLutProgram=bc(t)),this.APLutProgram||(this.APLutProgram=vc(t))}static _createScatterProgram(t,e){const i=t.buildRenderProgram({vertex(t){this.$inputs.pos=t.vec3().attrib("position"),this.worldMatrix=t.mat4().uniform(0),this.viewProjMatrix=t.mat4().uniform(0),this.cameraPos=t.vec3().uniform(0),this.flip=t.vec4().uniform(0),t.main(function(){this.$outputs.worldDirection=t.mul(this.worldMatrix,t.vec4(this.$inputs.pos,0)).xyz,this.$builtins.position=t.mul(this.viewProjMatrix,t.vec4(t.add(this.$outputs.worldDirection,this.cameraPos),1),this.flip),this.$builtins.position.z=this.$builtins.position.w})},fragment(t){this.$outputs.outColor=t.vec4(),this.tLut=t.tex2D().uniform(0),this.skyLut=t.tex2D().uniform(0),this.params=_c(t)().uniform(0),e&&(this.cloudy=t.float().uniform(0),this.cloudIntensity=t.float().uniform(0),this.time=t.float().uniform(0),this.velocity=t.vec2().uniform(0)),this.srgbOut=t.int().uniform(0),t.func("noise",[t.vec3("p"),t.float("t")],function(){this.p2=t.mul(this.p,.25),this.f=t.mul(pm(this,this.p2),.5),this.p2=t.mul(this.p2,3.02),this.p2.y=t.sub(this.p2.y,t.mul(this.t,.02)),this.f=t.add(this.f,t.mul(pm(this,this.p2),.25)),this.p2=t.mul(this.p2,3.03),this.p2.y=t.add(this.p2.y,t.mul(this.t,.01)),this.f=t.add(this.f,t.mul(pm(this,this.p2),.125)),this.p2=t.mul(this.p2,3.02),this.f=t.add(this.f,t.mul(pm(this,this.p2),.0625)),this.p2=t.mul(this.p2,3.01),this.f=t.add(this.f,t.mul(pm(this,this.p2),.03125)),this.p2=t.mul(this.p2,3.01),this.f=t.add(this.f,t.mul(pm(this,this.p2),.015625)),this.$return(this.f)}),t.main(function(){this.$l.sunColor=t.vec4(),this.$l.skyColor=cc(this,this.params,this.sunColor,this.$inputs.worldDirection,t.float(.01),this.tLut,this.skyLut).rgb,this.$l.rayDir=t.normalize(this.$inputs.worldDirection),this.$l.sunDir=this.params.lightDir,this.$l.sunIntensity=t.sqrt(t.max(0,t.mul(this.sunDir.y,this.rayDir.y))),e&&(this.$l.noiseValue=t.float(),this.$if(t.lessThanEqual(this.rayDir.y,0),function(){this.noiseValue=0}).$else(function(){this.$l.tMin=t.div(3e3,this.rayDir.y),this.$l.cloudPoint=t.mul(this.rayDir,this.tMin),this.speed=t.mul(t.vec3(this.velocity.x,0,this.velocity.y),this.time),this.$l.noiseScale=t.float(4e-4),this.noiseValue=this.noise(t.mul(t.add(this.cloudPoint,this.speed),this.noiseScale),this.time),this.noiseValue=t.add(this.noiseValue,this.cloudy),this.noiseValue=t.smoothStep(1,t.add(1,this.cloudy),this.noiseValue)}),this.$l.cloudColor=t.mul(this.sunColor.rgb,this.sunIntensity,t.mul(this.noiseValue,this.cloudIntensity))),e?(this.$l.vfactor=t.clamp(t.div(t.sub(this.rayDir.y,.01),t.sub(.03,.01)),0,1),this.$l.factor=t.clamp(t.mul(this.noiseValue,this.vfactor),0,1),this.$l.color=t.mix(this.skyColor,this.cloudColor,this.factor)):this.$l.color=this.skyColor,this.$if(t.equal(this.srgbOut,0),function(){this.$outputs.outColor=t.vec4(this.color,1)}).$else(function(){this.$outputs.outColor=t.vec4(Il(this,this.color),1)})})}});return i.name=e?"@SkyScatterCloud":"@SkyScatter",i}}const Af=new q,Cf=new z,Ef=[0,1.5*Math.PI,.5*Math.PI,Math.PI];class Mf extends gt{_instanceDataPool;_instanceDataPoolSize;_mipLevelDataPool;_mipLevelDataPoolSize;_nonInstanceDataPool;_nonInstanceDataPoolSize;_nonInstanceMipLevelDataPool;_nonInstanceMipLevelDataPoolSize;_extraInstanceBuffers;_tileResolution;_maxMipLevels;_tileMesh;_tileMeshLines;_tileMeshBBox;_fillerMesh;_fillerMeshLines;_fillerMeshAABB;_trimMesh;_trimMeshLines;_trimMeshAABB;_crossMesh;_crossMeshLines;_crossMeshAABB;_seamMesh;_seamMeshLines;_seamMeshAABB;_wireframe;constructor(t,e,i=64){if(super(),e&&e.findIndex(t=>0===ur(t)||4===ur(t)||"f32"!==sr[t][3])>=0)throw new Error("Extra instance buffers must be f32 format and cannot have vertex attribute of POSITOIN and TEXCOORD0");this._extraInstanceBuffers=e?.slice()??[],this._tileResolution=t,this._maxMipLevels=Math.min(64,Math.max(1,i>>>0)),this._instanceDataPool=[],this._instanceDataPoolSize=0,this._mipLevelDataPool=[],this._mipLevelDataPoolSize=0,this._nonInstanceDataPool=[],this._nonInstanceDataPoolSize=0,this._nonInstanceMipLevelDataPool=[],this._nonInstanceMipLevelDataPoolSize=0,this._wireframe=!1,this.generateCrossMesh(),this.generateFillerMesh(),this.generateSeamMesh(),this.generateTileMesh(),this.generateTrimMesh()}get wireframe(){return this._wireframe}set wireframe(t){this._wireframe=!!t}get tileResolution(){return this._tileResolution}set tileResolution(t){t!==this._tileResolution&&(this._tileResolution=t,this.generateCrossMesh(),this.generateFillerMesh(),this.generateSeamMesh(),this.generateTileMesh(),this.generateTrimMesh())}allocInstanceBuffer(){if(0===this._instanceDataPoolSize){const t=new Float32Array(16*this._maxMipLevels*4);return this._instanceDataPool.push(t),t}return this._instanceDataPool[--this._instanceDataPoolSize]}allocNonInstanceBuffer(t,e,i,s){let r;return 0===this._nonInstanceDataPoolSize?(r=new Float32Array(4),this._nonInstanceDataPool.push(r)):r=this._nonInstanceDataPool[--this._nonInstanceDataPoolSize],r[0]=t,r[1]=e,r[2]=i,r[3]=s,r}allocMipLevelBuffer(){if(0===this._mipLevelDataPoolSize){const t=new Float32Array(16*this._maxMipLevels);return this._mipLevelDataPool.push(t),t}return this._mipLevelDataPool[--this._mipLevelDataPoolSize]}allocNonInstanceMipLevelBuffer(t){let e;return 0===this._nonInstanceMipLevelDataPoolSize?(e=new Float32Array(1),this._nonInstanceMipLevelDataPool.push(e)):e=this._nonInstanceMipLevelDataPool[--this._nonInstanceMipLevelDataPoolSize],e[0]=t,e}patch2d(t,e,i){return i*(t+1)+e}calcAABB(t){let e=-Number.MAX_VALUE,i=-Number.MAX_VALUE,s=Number.MAX_VALUE,r=Number.MAX_VALUE;for(let a=0;a<t.length/3;a++){const n=t[3*a+0],o=t[3*a+1];n>e&&(e=n),n<s&&(s=n),o>i&&(i=o),o<r&&(r=o)}return new q(new z(s,r,0),new z(e,i,0))}generateTileMesh(){this._tileMesh?.dispose(),this._tileMesh=new Cl;const t=this._tileResolution+1,e=new Float32Array(t*t*3);let i=0;for(let s=0;s<t;s++)for(let r=0;r<t;r++)e[i++]=r,e[i++]=s,e[i++]=0;i=0;const s=new Uint16Array(this._tileResolution*this._tileResolution*6);for(let t=0;t<this._tileResolution;t++)for(let e=0;e<this._tileResolution;e++)s[i++]=this.patch2d(this._tileResolution,e,t),s[i++]=this.patch2d(this._tileResolution,e,t+1),s[i++]=this.patch2d(this._tileResolution,e+1,t+1),s[i++]=this.patch2d(this._tileResolution,e,t),s[i++]=this.patch2d(this._tileResolution,e+1,t+1),s[i++]=this.patch2d(this._tileResolution,e+1,t);this._tileMesh.createAndSetVertexBuffer("position_f32x3",e),this._tileMesh.createAndSetVertexBuffer("tex0_f32x4",this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;for(const t of this._extraInstanceBuffers)this._tileMesh.createAndSetVertexBuffer(t,this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;this._tileMesh.createAndSetIndexBuffer(s),this._tileMesh.indexStart=0,this._tileMesh.indexCount=s.length,this._tileMesh.primitiveType="triangle-list",this._tileMeshBBox=this.calcAABB(e);const r=new Uint16Array(2*s.length);for(let t=0;t<s.length/3;t++)r[6*t+0]=s[3*t+0],r[6*t+1]=s[3*t+1],r[6*t+2]=s[3*t+1],r[6*t+3]=s[3*t+2],r[6*t+4]=s[3*t+2],r[6*t+5]=s[3*t+0];this._tileMeshLines?.dispose(),this._tileMeshLines=new Cl,this._tileMeshLines.setVertexBuffer(this._tileMesh.getVertexBuffer("position")),this._tileMeshLines.createAndSetVertexBuffer("tex0_f32x4",this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;for(const t of this._extraInstanceBuffers)this._tileMeshLines.createAndSetVertexBuffer(t,this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;this._tileMeshLines.createAndSetIndexBuffer(r),this._tileMeshLines.indexStart=0,this._tileMeshLines.indexCount=r.length,this._tileMeshLines.primitiveType="line-list"}generateFillerMesh(){this._fillerMesh?.dispose(),this._fillerMesh=new Cl;const t=this._tileResolution+1,e=new Float32Array(8*t*3);let i=0;const s=this._tileResolution;for(let r=0;r<t;r++)e[i++]=s+r+1,e[i++]=0,e[i++]=0,e[i++]=s+r+1,e[i++]=1,e[i++]=0;for(let r=0;r<t;r++)e[i++]=1,e[i++]=s+r+1,e[i++]=0,e[i++]=0,e[i++]=s+r+1,e[i++]=0;for(let r=0;r<t;r++)e[i++]=-s-r,e[i++]=1,e[i++]=0,e[i++]=-s-r,e[i++]=0,e[i++]=0;for(let r=0;r<t;r++)e[i++]=0,e[i++]=-s-r,e[i++]=0,e[i++]=1,e[i++]=-s-r,e[i++]=0;i=0;const r=new Uint16Array(24*this._tileResolution);for(let t=0;t<4*this._tileResolution;t++){const e=t/this._tileResolution|0,s=2*(e+t)+0,a=2*(e+t)+1,n=2*(e+t)+2,o=2*(e+t)+3;e%2==0?(r[i++]=a,r[i++]=o,r[i++]=s,r[i++]=s,r[i++]=o,r[i++]=n):(r[i++]=a,r[i++]=n,r[i++]=s,r[i++]=a,r[i++]=o,r[i++]=n)}this._fillerMesh.createAndSetVertexBuffer("position_f32x3",e),this._fillerMesh.createAndSetVertexBuffer("tex0_f32x4",this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;for(const t of this._extraInstanceBuffers)this._fillerMesh.createAndSetVertexBuffer(t,this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;this._fillerMesh.createAndSetIndexBuffer(r),this._fillerMesh.indexStart=0,this._fillerMesh.indexCount=r.length,this._fillerMesh.primitiveType="triangle-list",this._fillerMeshAABB=this.calcAABB(e);const a=new Uint16Array(2*r.length);for(let t=0;t<r.length/3;t++)a[6*t+0]=r[3*t+0],a[6*t+1]=r[3*t+1],a[6*t+2]=r[3*t+1],a[6*t+3]=r[3*t+2],a[6*t+4]=r[3*t+2],a[6*t+5]=r[3*t+0];this._fillerMeshLines?.dispose(),this._fillerMeshLines=new Cl,this._fillerMeshLines.setVertexBuffer(this._fillerMesh.getVertexBuffer("position")),this._fillerMeshLines.createAndSetVertexBuffer("tex0_f32x4",this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;for(const t of this._extraInstanceBuffers)this._fillerMeshLines.createAndSetVertexBuffer(t,this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;this._fillerMeshLines.createAndSetIndexBuffer(a),this._fillerMeshLines.indexStart=0,this._fillerMeshLines.indexCount=a.length,this._fillerMeshLines.primitiveType="line-list"}generateTrimMesh(){this._trimMesh?.dispose(),this._trimMesh=new Cl;const t=4*this._tileResolution+2,e=new Float32Array(2*(2*t+1)*3);let i=0;const s=.5*(t+1);for(let r=0;r<t+1;r++)e[i++]=0-s,e[i++]=t-r-s,e[i++]=0,e[i++]=1-s,e[i++]=t-r-s,e[i++]=0;const r=i/3;for(let r=0;r<t;r++)e[i++]=r+1-s,e[i++]=0-s,e[i++]=0,e[i++]=r+1-s,e[i++]=1-s,e[i++]=0;i=0;const a=new Uint16Array(6*(2*t-1));for(let e=0;e<t;e++)a[i++]=2*(e+0)+1,a[i++]=2*(e+1)+0,a[i++]=2*(e+0)+0,a[i++]=2*(e+1)+1,a[i++]=2*(e+1)+0,a[i++]=2*(e+0)+1;for(let e=0;e<t-1;e++)a[i++]=r+2*(e+0)+1,a[i++]=r+2*(e+1)+0,a[i++]=r+2*(e+0)+0,a[i++]=r+2*(e+1)+1,a[i++]=r+2*(e+1)+0,a[i++]=r+2*(e+0)+1;this._trimMesh.createAndSetVertexBuffer("position_f32x3",e),this._trimMesh.createAndSetVertexBuffer("tex0_f32x4",this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;for(const t of this._extraInstanceBuffers)this._trimMesh.createAndSetVertexBuffer(t,this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;this._trimMesh.createAndSetIndexBuffer(a),this._trimMesh.indexStart=0,this._trimMesh.indexCount=a.length,this._trimMesh.primitiveType="triangle-list",this._trimMeshAABB=this.calcAABB(e);const n=new Uint16Array(2*a.length);for(let t=0;t<a.length/3;t++)n[6*t+0]=a[3*t+0],n[6*t+1]=a[3*t+1],n[6*t+2]=a[3*t+1],n[6*t+3]=a[3*t+2],n[6*t+4]=a[3*t+2],n[6*t+5]=a[3*t+0];this._trimMeshLines?.dispose(),this._trimMeshLines=new Cl,this._trimMeshLines.setVertexBuffer(this._trimMesh.getVertexBuffer("position")),this._trimMeshLines.createAndSetVertexBuffer("tex0_f32x4",this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;for(const t of this._extraInstanceBuffers)this._trimMeshLines.createAndSetVertexBuffer(t,this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;this._trimMeshLines.createAndSetIndexBuffer(n),this._trimMeshLines.indexStart=0,this._trimMeshLines.indexCount=n.length,this._trimMeshLines.primitiveType="line-list"}generateCrossMesh(){const t=this._tileResolution+1,e=new Float32Array(8*t*3);let i=0;for(let s=0;s<2*t;s++)e[i++]=s-this._tileResolution,e[i++]=0,e[i++]=0,e[i++]=s-this._tileResolution,e[i++]=1,e[i++]=0;const s=i/3;for(let s=0;s<2*t;s++)e[i++]=0,e[i++]=s-this._tileResolution,e[i++]=0,e[i++]=1,e[i++]=s-this._tileResolution,e[i++]=0;i=0;const r=new Uint16Array(24*this._tileResolution+6);for(let t=0;t<2*this._tileResolution+1;t++){const e=2*t+0,s=2*t+1,a=2*t+2,n=2*t+3;r[i++]=s,r[i++]=n,r[i++]=e,r[i++]=e,r[i++]=n,r[i++]=a}for(let t=0;t<2*this._tileResolution+1;t++){if(t===this._tileResolution)continue;const e=2*t+0,a=2*t+1,n=2*t+2,o=2*t+3;r[i++]=s+a,r[i++]=s+e,r[i++]=s+o,r[i++]=s+e,r[i++]=s+n,r[i++]=s+o}this._crossMesh?.dispose(),this._crossMesh=new Cl,this._crossMesh.createAndSetVertexBuffer("position_f32x3",e),this._crossMesh.createAndSetVertexBuffer("tex0_f32x4",this.allocNonInstanceBuffer(0,0,0,0),"instance"),this._nonInstanceDataPoolSize++;for(const t of this._extraInstanceBuffers)this._crossMesh.createAndSetVertexBuffer(t,this.allocNonInstanceBuffer(0,0,0,0),"instance"),this._nonInstanceDataPoolSize++;this._crossMesh.createAndSetIndexBuffer(r),this._crossMesh.indexStart=0,this._crossMesh.indexCount=r.length,this._crossMesh.primitiveType="triangle-list",this._crossMeshAABB=this.calcAABB(e);const a=new Uint16Array(2*r.length);for(let t=0;t<r.length/3;t++)a[6*t+0]=r[3*t+0],a[6*t+1]=r[3*t+1],a[6*t+2]=r[3*t+1],a[6*t+3]=r[3*t+2],a[6*t+4]=r[3*t+2],a[6*t+5]=r[3*t+0];this._crossMeshLines?.dispose(),this._crossMeshLines=new Cl,this._crossMeshLines.setVertexBuffer(this._crossMesh.getVertexBuffer("position")),this._crossMeshLines.createAndSetVertexBuffer("tex0_f32x4",this.allocNonInstanceBuffer(0,0,0,0),"instance"),this._nonInstanceDataPoolSize++;for(const t of this._extraInstanceBuffers)this._crossMeshLines.createAndSetVertexBuffer(t,this.allocNonInstanceBuffer(0,0,0,0),"instance"),this._nonInstanceDataPoolSize++;this._crossMeshLines.createAndSetIndexBuffer(a),this._crossMeshLines.indexStart=0,this._crossMeshLines.indexCount=a.length,this._crossMeshLines.primitiveType="line-list"}generateSeamMesh(){this._seamMesh?.dispose(),this._seamMesh=new Cl;const t=4*this._tileResolution+2,e=new Float32Array(4*t*3);for(let i=0;i<t;i++)e[3*(0*t+i)+0]=i,e[3*(0*t+i)+1]=0,e[3*(0*t+i)+2]=0,e[3*(1*t+i)+0]=t,e[3*(1*t+i)+1]=i,e[3*(1*t+i)+2]=0,e[3*(2*t+i)+0]=t-i,e[3*(2*t+i)+1]=t,e[3*(2*t+i)+2]=0,e[3*(3*t+i)+0]=0,e[3*(3*t+i)+1]=t-i,e[3*(3*t+i)+2]=0;const i=new Uint16Array(6*t);let s=0;for(let e=0;e<4*t;e+=2)i[s++]=e+1,i[s++]=e+2,i[s++]=e;i[i.length-1]=0,this._seamMesh.createAndSetVertexBuffer("position_f32x3",e),this._seamMesh.createAndSetVertexBuffer("tex0_f32x4",this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;for(const t of this._extraInstanceBuffers)this._seamMesh.createAndSetVertexBuffer(t,this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;this._seamMesh.createAndSetIndexBuffer(i),this._seamMesh.indexStart=0,this._seamMesh.indexCount=i.length,this._seamMesh.primitiveType="triangle-list",this._seamMeshAABB=this.calcAABB(e);const r=new Uint16Array(2*i.length);for(let t=0;t<i.length/3;t++)r[6*t+0]=i[3*t+0],r[6*t+1]=i[3*t+1],r[6*t+2]=i[3*t+1],r[6*t+3]=i[3*t+2],r[6*t+4]=i[3*t+2],r[6*t+5]=i[3*t+0];this._seamMeshLines?.dispose(),this._seamMeshLines=new Cl,this._seamMeshLines.setVertexBuffer(this._seamMesh.getVertexBuffer("position")),this._seamMeshLines.createAndSetVertexBuffer("tex0_f32x4",this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;for(const t of this._extraInstanceBuffers)this._seamMeshLines.createAndSetVertexBuffer(t,this.allocInstanceBuffer(),"instance"),this._instanceDataPoolSize++;this._seamMeshLines.createAndSetIndexBuffer(r),this._seamMeshLines.indexStart=0,this._seamMeshLines.indexCount=r.length,this._seamMeshLines.primitiveType="line-list"}intervalsOverlap(t,e,i,s){return t<=s&&i<=e}updateAABB(t,e,i,s,r,a){e?q.transform(t,W.rotationZ(e),Af):(Af.minPoint.set(t.minPoint),Af.maxPoint.set(t.maxPoint));const n=(Af.minPoint.x*s+i.x)*r,o=(Af.maxPoint.x*s+i.x)*r,h=(Af.minPoint.y*s+i.y)*r,l=(Af.maxPoint.y*s+i.y)*r;n<a.minPoint.x&&(a.minPoint.x=n),o>a.maxPoint.x&&(a.maxPoint.x=o),h<a.minPoint.z&&(a.minPoint.z=h),l>a.maxPoint.z&&(a.maxPoint.z=l)}visible(t,e,i,s,r,a,n,o){s?q.transform(e,W.rotationZ(s),Af):(Af.minPoint.set(e.minPoint),Af.maxPoint.set(e.maxPoint));const h=(Af.minPoint.x*a+r.x)*n,l=(Af.maxPoint.x*a+r.x)*n,u=(Af.minPoint.y*a+r.y)*n,c=(Af.maxPoint.y*a+r.y)*n;return t.calcAABB(t.userData,h,l,u,c,Af,o),Af.getClipStateWithFrustum(i.frustum)!==$.NOT_CLIPPED}calcLevelAABB(t,e,i){const s=this.calcMipLevels(t,e,i);t.getWorldPosition(Cf);const r=new L,a=new L,n=new L,o=new L,h=Cf.x/i,l=Cf.z/i,u=[];for(let t=0;t<s;t++){const t=new q;t.beginExtend(),u.push(t)}r.setXY(Math.floor(h),Math.floor(l)),this.updateAABB(this._crossMeshAABB,null,r,1,i,u[0]);for(let t=0;t<s;t++){const e=u[t],s=1<<t;r.setXY(Math.floor(h/s)*s,Math.floor(l/s)*s),a.setXY(this._tileResolution<<t,this._tileResolution<<t),n.setXY(r.x-(this._tileResolution<<t+1),r.y-(this._tileResolution<<t+1));for(let r=0;r<4;r++)for(let h=0;h<4;h++){if(!(0===t||1!==r&&2!==r||1!==h&&2!==h))continue;const l=r>=2?s:0,u=h>=2?s:0;o.setXY(n.x+r*a.x+l,n.y+h*a.y+u),this.updateAABB(this._tileMeshBBox,null,o,s,i,e)}this.updateAABB(this._fillerMeshAABB,null,r,s,i,e);const c=2*s,d=new L(Math.floor(h/c)*c,Math.floor(l/c)*c),p=new L(r.x+.5*s,r.y+.5*s),m=new L(h-d.x,l-d.y);let f=0;f|=m.x>=s?0:2,f|=m.y>=s?0:1,this.updateAABB(this._trimMeshAABB,Ef[f],p,s,i,e);const _=new L(d.x-(this._tileResolution<<t+1),d.y-(this._tileResolution<<t+1));this.updateAABB(this._seamMeshAABB,null,_,s,i,e)}return u}calcMipLevels(t,e,i){t.getWorldPosition(Cf);const s=Math.max(Math.abs(Cf.x-e.x),Math.abs(Cf.x-e.z)),r=Math.max(Math.abs(Cf.z-e.y),Math.abs(Cf.z-e.w)),a=Math.min(Math.max(s,r),t.getFarPlane());return Math.min(Math.max(Math.ceil(Math.log2(a/(this._tileResolution*i))),0)+1,this._maxMipLevels)}addInstance(t,e,i,s,r,a){t.mipLevels[t.numInstances]=a,t.instanceDatas[4*t.numInstances+0]=e,t.instanceDatas[4*t.numInstances+1]=r,t.instanceDatas[4*t.numInstances+2]=i,t.instanceDatas[4*t.numInstances+3]=s,t.maxMiplevel=a,t.numInstances++}gather(t){this._instanceDataPoolSize=this._instanceDataPool.length,this._mipLevelDataPoolSize=this._mipLevelDataPool.length,this._nonInstanceDataPoolSize=this._nonInstanceDataPool.length,this._nonInstanceMipLevelDataPoolSize=this._nonInstanceMipLevelDataPool.length;const e=[],i=this.calcMipLevels(t.camera,t.minMaxWorldPos,t.gridScale);t.camera.getWorldPosition(Cf);const s=new L,r=new L,a=new L,n=new L,o=Cf.x/t.gridScale,h=Cf.z/t.gridScale;if(s.setXY(Math.floor(o),Math.floor(h)),!t.frustumCulling||this.visible(t,this._crossMeshAABB,t.camera,null,s,1,t.gridScale,0)){const t={primitive:this._wireframe?this._crossMeshLines:this._crossMesh,numInstances:1,instanceDatas:this.allocNonInstanceBuffer(Ef[0],1,s.x,s.y),mipLevels:this.allocNonInstanceMipLevelBuffer(0),maxMiplevel:0};e.push(t)}const l={primitive:this._wireframe?this._tileMeshLines:this._tileMesh,numInstances:0,instanceDatas:this.allocInstanceBuffer(),mipLevels:this.allocMipLevelBuffer(),maxMiplevel:0},u={primitive:this._wireframe?this._fillerMeshLines:this._fillerMesh,numInstances:0,instanceDatas:this.allocInstanceBuffer(),mipLevels:this.allocMipLevelBuffer(),maxMiplevel:0},c={primitive:this._wireframe?this._trimMeshLines:this._trimMesh,numInstances:0,instanceDatas:this.allocInstanceBuffer(),mipLevels:this.allocMipLevelBuffer(),maxMiplevel:0},d={primitive:this._wireframe?this._seamMeshLines:this._seamMesh,numInstances:0,instanceDatas:this.allocInstanceBuffer(),mipLevels:this.allocMipLevelBuffer(),maxMiplevel:0};for(let e=0;e<i;e++){const p=1<<e;s.setXY(Math.floor(o/p)*p,Math.floor(h/p)*p),r.setXY(this._tileResolution<<e,this._tileResolution<<e),a.setXY(s.x-(this._tileResolution<<e+1),s.y-(this._tileResolution<<e+1));for(let i=0;i<4;i++)for(let s=0;s<4;s++){if(!(0===e||1!==i&&2!==i||1!==s&&2!==s))continue;const o=i>=2?p:0,h=s>=2?p:0;n.setXY(a.x+i*r.x+o,a.y+s*r.y+h),this.intervalsOverlap(n.x*t.gridScale,(n.x+r.x)*t.gridScale,t.minMaxWorldPos.x,t.minMaxWorldPos.z)&&this.intervalsOverlap(n.y*t.gridScale,(n.y+r.y)*t.gridScale,t.minMaxWorldPos.y,t.minMaxWorldPos.w)&&(t.frustumCulling&&!this.visible(t,this._tileMeshBBox,t.camera,null,n,p,t.gridScale,e)||this.addInstance(l,Ef[0],n.x,n.y,p,e))}if(t.frustumCulling&&!this.visible(t,this._fillerMeshAABB,t.camera,null,s,p,t.gridScale,e)||this.addInstance(u,Ef[0],s.x,s.y,p,e),e!==i-1){const i=2*p,r=new L(Math.floor(o/i)*i,Math.floor(h/i)*i),a=new L(s.x+.5*p,s.y+.5*p),n=new L(o-r.x,h-r.y);let l=0;l|=n.x>=p?0:2,l|=n.y>=p?0:1,t.frustumCulling&&!this.visible(t,this._trimMeshAABB,t.camera,Ef[l],a,p,t.gridScale,e)||this.addInstance(c,Ef[l],a.x,a.y,p,e);const u=new L(r.x-(this._tileResolution<<e+1),r.y-(this._tileResolution<<e+1));t.frustumCulling&&!this.visible(t,this._seamMeshAABB,t.camera,null,u,p,t.gridScale,e)||this.addInstance(d,Ef[0],u.x,u.y,p,e)}}l.numInstances>0&&e.push(l),u.numInstances>0&&e.push(u),c.numInstances>0&&e.push(c),d.numInstances>0&&e.push(d);for(const t of e)t.primitive.getVertexBuffer("texCoord0").bufferSubData(0,t.instanceDatas,0,4*t.numInstances);return e}onDispose(){super.onDispose(),this._crossMesh.dispose(),this._crossMesh=null,this._crossMeshLines.dispose(),this._crossMeshLines=null,this._fillerMesh.dispose(),this._fillerMesh=null,this._fillerMeshLines.dispose(),this._fillerMeshLines=null,this._seamMesh.dispose(),this._seamMesh=null,this._seamMeshLines.dispose(),this._seamMeshLines=null,this._trimMesh.dispose(),this._trimMesh=null,this._trimMeshLines.dispose(),this._trimMeshLines=null,this._tileMesh.dispose(),this._tileMesh=null,this._tileMeshLines.dispose(),this._tileMeshLines=null}}class Bf extends gt{}class If extends Bf{static UNIFORM_NAME_IBL_RADIANCE_MAP="zIBLRadianceMap";static UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD="zIBLRadianceMapMaxLOD";static UNIFORM_NAME_IBL_IRRADIANCE_SH="zIBLIrradianceSH";static UNIFORM_NAME_IBL_IRRADIANCE_WINDOW="zIBLIrradianceWindow";_radianceMap;_irradianceSH;_irradianceSHFB;_irraidanceWindow;constructor(t,e,i){super(),this._radianceMap=new wt(t||null),this._irradianceSH=new wt(e||null),this._irradianceSHFB=new wt(i||null),this._irraidanceWindow=new z}getType(){return"ibl"}get radianceMap(){return this._radianceMap.get()}set radianceMap(t){this._radianceMap.set(t)}get irradianceSH(){return this._irradianceSH.get()}set irradianceSH(t){this._irradianceSH.set(t)}get irradianceSHFB(){return this._irradianceSHFB.get()}set irradianceSHFB(t){this._irradianceSHFB.set(t)}get irradianceWindow(){return this._irraidanceWindow}set irradianceWindow(t){this._irraidanceWindow=t}initShaderBindings(t){"fragment"===t.shaderKind&&(this.radianceMap&&(t.getGlobalScope()[If.UNIFORM_NAME_IBL_RADIANCE_MAP]=t.texCube().uniform(0),t.getGlobalScope()[If.UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD]=t.float().uniform(0)),"webgl"!==Sl().type&&Sl().getDeviceCaps().framebufferCaps.supportFloatBlending?this.irradianceSH&&(t.getGlobalScope()[If.UNIFORM_NAME_IBL_IRRADIANCE_SH]=t.vec4[9]().uniformBuffer(0),t.getGlobalScope()[If.UNIFORM_NAME_IBL_IRRADIANCE_WINDOW]=t.vec3().uniform(0)):this.irradianceSHFB&&(t.getGlobalScope()[If.UNIFORM_NAME_IBL_IRRADIANCE_SH]=t.tex2D().uniform(0),t.getGlobalScope()[If.UNIFORM_NAME_IBL_IRRADIANCE_WINDOW]=t.vec3().uniform(0)))}updateBindGroup(t){this.radianceMap&&(t.setValue(If.UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD,this.radianceMap.mipLevelCount-1),t.setTexture(If.UNIFORM_NAME_IBL_RADIANCE_MAP,this.radianceMap)),"webgl"!==Sl().type&&Sl().getDeviceCaps().framebufferCaps.supportFloatBlending?this.irradianceSH&&(t.setBuffer(If.UNIFORM_NAME_IBL_IRRADIANCE_SH,this.irradianceSH),t.setValue(If.UNIFORM_NAME_IBL_IRRADIANCE_WINDOW,this.irradianceWindow)):this.irradianceSHFB&&(t.setTexture(If.UNIFORM_NAME_IBL_IRRADIANCE_SH,this.irradianceSHFB.getColorAttachments()[0],Gl("clamp_nearest_nomip")),t.setValue(If.UNIFORM_NAME_IBL_IRRADIANCE_WINDOW,this.irradianceWindow))}getRadiance(t,e,i){const s=t.$builder;return Sl().getDeviceCaps().shaderCaps.supportShaderTextureLod?s.textureSampleLevel(t[If.UNIFORM_NAME_IBL_RADIANCE_MAP],e,s.mul(i,t[If.UNIFORM_NAME_IBL_RADIANCE_MAP_MAX_LOD])).rgb:s.textureSample(t[If.UNIFORM_NAME_IBL_RADIANCE_MAP],e).rgb}getIrradiance(t,e){const i=t.$builder;return i.func("Z_sh_Y0",[i.vec3("v")],function(){this.$return(.2820947917)}),i.func("Z_sh_Y1",[i.vec3("v")],function(){this.$return(i.mul(this.v.y,-.4886025119))}),i.func("Z_sh_Y2",[i.vec3("v")],function(){this.$return(i.mul(this.v.z,.4886025119))}),i.func("Z_sh_Y3",[i.vec3("v")],function(){this.$return(i.mul(this.v.x,-.4886025119))}),i.func("Z_sh_Y4",[i.vec3("v")],function(){this.$return(i.mul(this.v.x,this.v.y,1.0925484306))}),i.func("Z_sh_Y5",[i.vec3("v")],function(){this.$return(i.mul(this.v.y,this.v.z,-1.0925484306))}),i.func("Z_sh_Y6",[i.vec3("v")],function(){this.$return(i.mul(i.sub(i.mul(this.v.z,this.v.z,3),1),.3153915652))}),i.func("Z_sh_Y7",[i.vec3("v")],function(){this.$return(i.mul(this.v.x,this.v.z,-1.0925484306))}),i.func("Z_sh_Y8",[i.vec3("v")],function(){this.$return(i.mul(i.sub(i.mul(this.v.x,this.v.x),i.mul(this.v.y,this.v.y)),.5462742153))}),i.func("Z_sh_eval",[i.vec3("v")],function(){this.$l.window=this[If.UNIFORM_NAME_IBL_IRRADIANCE_WINDOW],"webgl"!==Sl().type&&Sl().getDeviceCaps().framebufferCaps.supportFloatBlending?(this.$l.c=i.mul(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH][0].xyz,this.Z_sh_Y0(this.v),this.window.x),this.c=i.add(this.c,i.mul(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH][1].xyz,this.Z_sh_Y1(this.v),this.window.y)),this.c=i.add(this.c,i.mul(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH][2].xyz,this.Z_sh_Y2(this.v),this.window.y)),this.c=i.add(this.c,i.mul(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH][3].xyz,this.Z_sh_Y3(this.v),this.window.y)),this.c=i.add(this.c,i.mul(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH][4].xyz,this.Z_sh_Y4(this.v),this.window.z)),this.c=i.add(this.c,i.mul(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH][5].xyz,this.Z_sh_Y5(this.v),this.window.z)),this.c=i.add(this.c,i.mul(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH][6].xyz,this.Z_sh_Y6(this.v),this.window.z)),this.c=i.add(this.c,i.mul(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH][7].xyz,this.Z_sh_Y7(this.v),this.window.z)),this.c=i.add(this.c,i.mul(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH][8].xyz,this.Z_sh_Y8(this.v),this.window.z))):(this.$l.c=i.mul(i.textureSampleLevel(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH],i.vec2(.5/3,.5/3),0).rgb,this.Z_sh_Y0(this.v),this.window.x),this.c=i.add(this.c,i.mul(i.textureSampleLevel(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH],i.vec2(.5,.5/3),0).rgb,this.Z_sh_Y1(this.v),this.window.y)),this.c=i.add(this.c,i.mul(i.textureSampleLevel(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH],i.vec2(2.5/3,.5/3),0).rgb,this.Z_sh_Y2(this.v),this.window.y)),this.c=i.add(this.c,i.mul(i.textureSampleLevel(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH],i.vec2(.5/3,.5),0).rgb,this.Z_sh_Y3(this.v),this.window.y)),this.c=i.add(this.c,i.mul(i.textureSampleLevel(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH],i.vec2(.5,.5),0).rgb,this.Z_sh_Y4(this.v),this.window.z)),this.c=i.add(this.c,i.mul(i.textureSampleLevel(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH],i.vec2(2.5/3,.5),0).rgb,this.Z_sh_Y5(this.v),this.window.z)),this.c=i.add(this.c,i.mul(i.textureSampleLevel(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH],i.vec2(.5/3,2.5/3),0).rgb,this.Z_sh_Y6(this.v),this.window.z)),this.c=i.add(this.c,i.mul(i.textureSampleLevel(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH],i.vec2(.5,2.5/3),0).rgb,this.Z_sh_Y7(this.v),this.window.z)),this.c=i.add(this.c,i.mul(i.textureSampleLevel(this[If.UNIFORM_NAME_IBL_IRRADIANCE_SH],i.vec2(2.5/3,2.5/3),0).rgb,this.Z_sh_Y8(this.v),this.window.z))),this.$return(this.c)}),i.getGlobalScope().Z_sh_eval(e)}hasRadiance(){return!!this._radianceMap}hasIrradiance(){return!!this._irradianceSH}onDispose(){super.onDispose(),this._radianceMap.dispose(),this._irradianceSH.dispose(),this._irradianceSHFB.dispose()}}class Pf extends Bf{static UNIFORM_NAME_CONSTANT_AMBIENT="zConstantAmbient";_ambientColor;constructor(t){super(),this._ambientColor=t?new O(t):new O(0,0,0,1)}get ambientColor(){return this._ambientColor}set ambientColor(t){t&&this._ambientColor.set(t)}getType(){return"constant"}initShaderBindings(t){"fragment"===t.shaderKind&&(t.getGlobalScope()[Pf.UNIFORM_NAME_CONSTANT_AMBIENT]=t.vec4().uniform(0))}updateBindGroup(t){t.setValue(Pf.UNIFORM_NAME_CONSTANT_AMBIENT,this._ambientColor)}getRadiance(t,e,i){return null}getIrradiance(t,e){return t[Pf.UNIFORM_NAME_CONSTANT_AMBIENT].rgb}hasRadiance(){return!1}hasIrradiance(){return!0}}class $f extends Bf{static UNIFORM_NAME_AMBIENT_UP="zHemisphericAmbientUp";static UNIFORM_NAME_AMBIENT_DOWN="zHemisphericAmbientDown";_ambientUp;_ambientDown;constructor(t,e){super(),this._ambientUp=new O(t),this._ambientDown=new O(e)}get ambientUp(){return this._ambientUp}set ambientUp(t){t&&this._ambientUp.set(t)}get ambientDown(){return this._ambientDown}set ambientDown(t){t&&this._ambientDown.set(t)}getType(){return"hemisphere"}initShaderBindings(t){"fragment"===t.shaderKind&&(t.getGlobalScope()[$f.UNIFORM_NAME_AMBIENT_UP]=t.vec4().uniform(0),t.getGlobalScope()[$f.UNIFORM_NAME_AMBIENT_DOWN]=t.vec4().uniform(0))}updateBindGroup(t){t.setValue($f.UNIFORM_NAME_AMBIENT_UP,this._ambientUp),t.setValue($f.UNIFORM_NAME_AMBIENT_DOWN,this._ambientDown)}getRadiance(t,e,i){const s=t.$builder,r=s.add(s.mul(e.y,.5),.5);return s.mix(t[$f.UNIFORM_NAME_AMBIENT_DOWN],t[$f.UNIFORM_NAME_AMBIENT_UP],r).rgb}getIrradiance(t,e){const i=t.$builder,s=i.add(i.mul(e.y,.5),.5);return i.mix(t[$f.UNIFORM_NAME_AMBIENT_DOWN],t[$f.UNIFORM_NAME_AMBIENT_UP],s).rgb}hasRadiance(){return!0}hasIrradiance(){return!0}}class Rf extends gt{_envLight;_ambientColor;_ambientDown;_ambientUp;_radianceMap;_irradianceMap;_irradianceSH;_irradianceSHFB;_irradianceWindow;_strength;constructor(){super(),this._envLight=new If,this._ambientColor=new k(.2,.2,.2,1),this._ambientColor.callback=()=>{"constant"===this.type&&this._envLight.ambientColor.set(this._ambientColor)},this._ambientDown=new k(.2,.2,.2,1),this._ambientDown.callback=()=>{"hemisphere"===this.type&&this._envLight.ambientDown.set(this._ambientDown)},this._ambientUp=new k(.3,.5,.8,1),this._ambientUp.callback=()=>{"hemisphere"===this.type&&this._envLight.ambientUp.set(this._ambientUp)},this._radianceMap=new wt,this._irradianceMap=new wt,this._irradianceSH=new wt,this._irradianceSHFB=new wt,this._irradianceWindow=new z,this._strength=1}getHash(t){return!t||t.drawEnvLight?`${this.type}:${this._envLight.hasRadiance()?"1":"0"}:${this._envLight.hasIrradiance()?"1":"0"}`:"none"}get envLight(){return this._envLight}get strength(){return this._strength}set strength(t){this._strength=t}get ambientColor(){return this._ambientColor}set ambientColor(t){this._ambientColor.set(t)}get ambientUp(){return this._ambientUp}set ambientUp(t){this._ambientUp.set(t)}get ambientDown(){return this._ambientDown}set ambientDown(t){this._ambientDown.set(t)}get radianceMap(){return this._radianceMap.get()}set radianceMap(t){this._radianceMap.set(t),"ibl"===this.type&&(this._envLight.radianceMap=this.radianceMap)}get irradianceSH(){return this._irradianceSH.get()}set irradianceSH(t){this._irradianceSH.set(t),"ibl"===this.type&&(this._envLight.irradianceSH=this.irradianceSH)}get irradianceSHFB(){return this._irradianceSHFB.get()}set irradianceSHFB(t){this._irradianceSHFB.set(t),"ibl"===this.type&&(this._envLight.irradianceSHFB=this.irradianceSHFB)}get irradianceWindow(){return this._irradianceWindow}set irradianceWindow(t){this._irradianceWindow.set(t),"ibl"===this.type&&(this._envLight.irradianceWindow=this._irradianceWindow)}get type(){return this._envLight?.getType()??"none"}set type(t){switch(t){case"none":this._envLight=null;break;case"ibl":this._envLight?.getType()!==t&&(this._envLight=new If(this.radianceMap,this.irradianceSH)),this._envLight.radianceMap=this.radianceMap,this._envLight.irradianceSH=this.irradianceSH,this._envLight.irradianceWindow=this.irradianceWindow;break;case"constant":this._envLight?.getType()!==t&&(this._envLight=new Pf(this._ambientColor));break;case"hemisphere":this._envLight?.getType()!==t&&(this._envLight=new $f(this._ambientUp,this._ambientDown))}}onDispose(){super.onDispose(),this._envLight?.dispose(),this._radianceMap.dispose(),this._irradianceMap.dispose(),this._irradianceSHFB.dispose(),this._irradianceSH.dispose()}}class Ff extends gt{_sky;_light;constructor(){super(),this._sky=new Sf,this._light=new Rf}get sky(){return this._sky}get light(){return this._light}getHash(t){return`${this.light?.getHash(t)}:${this._sky?.getHash(t)}`}needSceneDepthTexture(){return"none"!==this._sky.fogType}onDispose(){super.onDispose(),this._sky.dispose(),this._light.dispose()}}class Df extends(v(gt)()){static _nextId=0;_name;_rootNode;_octree;_nodePlaceList;_env;_updateFrame;_id;_nodeUpdateQueue;_perCameraUpdateQueue;_mainCamera;_metaData;_script;constructor(t){super(),this._id=++Df._nextId,this._name=t??"",this._octree=new Mu(this,8,8),this._nodePlaceList=new Set,this._nodeUpdateQueue=[],this._perCameraUpdateQueue=[],this._env=new Ff,this._updateFrame=-1,this._rootNode=new wt(new Au(this)),this._rootNode.get().name="Root",this._metaData=null,this._script="",this._mainCamera=new wt}get id(){return this._id}get name(){return this._name}set name(t){this._name=t??""}get mainCamera(){return this._mainCamera.get()}set mainCamera(t){this._mainCamera.set(t)}get rootNode(){return this._rootNode?.get()??null}get octree(){return this.updateNodePlacement(this._octree,this._nodePlaceList),this._octree}get boundingBox(){return this.updateNodePlacement(this._octree,this._nodePlaceList),this._octree.getRootNode().getBoxLoosed()}get env(){return this._env}get metaData(){return this._metaData}set metaData(t){this._metaData=t}get script(){return this._script}set script(t){this._script=t??""}findNodeById(t){return this._rootNode.get().findNodeById(t)}findNodeByName(t){return this._rootNode.get().findNodeByName(t)}raycast(t,e=1/0){const i=new Iu(t,e);return this.octree.getRootNode().traverse(i),i.intersected?{target:i.intersected,dist:i.intersectedDist,point:i.intersectedPoint}:null}constructRay(t,e,i,s,r,a){const n=new O(2*s/e-1,1-2*r/i,1,1),o=t.invViewProjectionMatrix.transform(n);o.scaleBy(1/o.w);let h=t.getWorldPosition(),l=z.sub(o.xyz(),h).inplaceNormalize();return a&&(h=a.transformPointAffine(h),l=a.transformVectorAffine(l)),new et(h,l)}queueUpdateNode(t){t&&this._nodeUpdateQueue.findIndex(e=>e.get()===t)<0&&this._nodeUpdateQueue.push(new St(t))}queuePerCameraUpdateNode(t){t&&this._perCameraUpdateQueue.findIndex(e=>e.get()===t)<0&&this._perCameraUpdateQueue.push(new St(t))}render(){this.mainCamera&&this.mainCamera.render(this)}invalidateNodePlacement(t){this._nodePlaceList.add(t)}updateEnvLight(){if("ibl"===this.env.light.type){const t="webgl"===Sl().type||!Sl().getDeviceCaps().framebufferCaps.supportFloatBlending;this.env.light.radianceMap||(this.env.light.radianceMap=this.env.sky.radianceMap),t&&!this.env.light.irradianceSHFB&&(this.env.light.irradianceSHFB=this.env.sky.irradianceSHFB),t||this.env.light.irradianceSH||(this.env.light.irradianceSH=this.env.sky.irradianceSH)}}getRenderer(){return yf}frameUpdate(){const t=Sl().frameInfo;if(t.frameCounter!==this._updateFrame){if(this._updateFrame=t.frameCounter,this.updateEnvLight(),this.dispatchEvent("update",this),this.mainCamera?.updateController(),this._nodeUpdateQueue.length>0){const e=.001*t.elapsedOverall,i=.001*t.elapsedFrame,s=this._nodeUpdateQueue;for(this._nodeUpdateQueue=[];s.length>0;){const r=s.shift(),a=r.get();a?.attached&&a.update(t.frameCounter,e,i),r.dispose()}}this.updateNodePlacement(this._octree,this._nodePlaceList)}}frameUpdatePerCamera(t){if(this._perCameraUpdateQueue.length>0){const e=Sl().frameInfo,i=.001*e.elapsedOverall,s=.001*e.elapsedFrame,r=this._perCameraUpdateQueue;for(this._perCameraUpdateQueue=[];r.length>0;){const e=r.shift();e.get()?.updatePerCamera(t,i,s),e.dispose()}}this.updateNodePlacement(this._octree,this._nodePlaceList)}updateNodePlacement(t,e){function i(i){!i.disposed&&i.attached&&!i.hidden&&i.placeToOctree?t.placeNode(i):t.removeNode(i),e.delete(i)}if(e.size>0)for(;e.size>0;){const s=e.keys().next().value;t?i(s):e.delete(s)}}onDispose(){this._env.dispose(),this._rootNode.dispose(),this._mainCamera.dispose()}}class Nf extends Au{_octreeNode;constructor(t){super(t),this._octreeNode=null}get octreeNode(){return this._octreeNode}set octreeNode(t){this._octreeNode=t}getName(){return this._name}isGraphNode(){return!0}getNode(){return this}getBoneMatrices(){return null}getSortDistance(t){const e=t.worldMatrix,i=this.worldMatrix,s=e.m03-i.m03,r=e.m13-i.m13,a=e.m23-i.m23;return s*s+r*r*a*a}isBatchable(){return!1}_visibleChanged(){this._scene?.invalidateNodePlacement(this)}}class Lf{_resourceDirty;constructor(){this._resourceDirty=!0}invalidateResource(){this._resourceDirty=!0}updateResources(t){this.doUpdateResources(t)}}const zf=[[.511749,.547686],[.58929,.257224],[.165018,.57663],[.407692,.742285],[.707012,.646523],[.31463,.466825],[.801257,.485186],[.418136,.146517],[.579889,.0368284],[.79801,.140114],[-.0413185,.371455],[-.0529108,.627352],[.0821375,.882071],[.17308,.301207],[-.120452,.867216],[.371096,.916454],[-.178381,.146101],[-.276489,.550525],[.12542,.126643],[-.296654,.286879],[.261744,-.00604975],[-.213417,.715776],[.425684,-.153211],[-.480054,.321357],[-.0717878,-.0250567],[-.328775,-.169666],[-.394923,.130802],[-.553681,-.176777],[-.722615,.120616],[-.693065,.309017],[.603193,.791471],[-.0754941,-.297988],[.109303,-.156472],[.260605,-.280111],[.129731,-.487954],[-.537315,.520494],[-.42758,.800607],[.77309,-.0728102],[.908777,.328356],[.985341,.0759158],[.947536,-.11837],[-.103315,-.610747],[.337171,-.584],[.210919,-.720055],[.41894,-.36769],[-.254228,-.49368],[-.428562,-.404037],[-.831732,-.189615],[-.922642,.0888026],[-.865914,.427795],[.706117,-.311662],[.545465,-.520942],[-.695738,.664492],[.389421,-.899007],[.48842,-.708054],[.760298,-.62735],[-.390788,-.707388],[-.591046,-.686721],[-.769903,-.413775],[-.604457,-.502571],[-.557234,.00451362],[.147572,-.924353],[-.0662488,-.892081],[.863832,-.4072]];function Vf(t){return t.$builder.div(1,Qc.getShadowCameraParams(t).z)}function Of(t,e,i){const s="Z_computeShadowMapDepth",r=t.$builder;return r.func(s,[r.vec3("worldPos")],function(){Nt(i)?this.$return(r.vec4(r.emulateDepthClamp?r.clamp(t.$inputs.clamppedDepth,0,1):t.$builtins.fragCoord.z,0,0,1)):(this.$l.depth=r.float(),this.$l.lightType=Qc.getLightTypeForShadow(this),this.$if(r.equal(this.lightType,1),function(){this.depth=r.emulateDepthClamp?r.clamp(this.$inputs.clamppedDepth,0,1):this.$builtins.fragCoord.z}).$elseif(r.equal(this.lightType,2),function(){this.$l.lightSpacePos=r.mul(Qc.getLightViewMatrixForShadow(this),r.vec4(this.worldPos,1)),this.depth=r.clamp(r.div(r.length(this.lightSpacePos.xyz),Qc.getLightPositionAndRangeForShadow(this).w),0,1)}).$else(function(){this.$l.lightSpacePos=r.mul(Qc.getLightViewMatrixForShadow(this),r.vec4(this.worldPos,1)),this.depth=r.clamp(r.div(r.neg(this.lightSpacePos.z),Qc.getLightPositionAndRangeForShadow(this).w),0,1)}),this.$return("rgba8unorm"===i?Ml(this,this.depth):r.vec4(this.depth,0,0,1)))}),r.getGlobalScope()[s](e)}function kf(t,e){const i="lib_computeReceiverPlaneDepthBias",s=t.$builder;return s.func(i,[s.vec4("coords")],function(){this.$l.dx=s.dpdx(this.coords),this.$l.dy=s.dpdy(this.coords),this.$l.biasMultiply=s.float(1),this.$l.uv=s.vec2(s.sub(s.mul(this.dy.y,this.dx.z),s.mul(this.dx.y,this.dy.z)),s.sub(s.mul(this.dx.x,this.dy.z),s.mul(this.dy.x,this.dx.z))),this.$l.uv=s.mul(this.$l.uv,s.div(this.biasMultiply,s.sub(s.mul(this.dx.x,this.dy.y),s.mul(this.dx.y,this.dy.x)))),this.$l.minFractionalError=s.float(.01),this.$l.fractionalSamplingError=s.dot(s.vec2(Vf(this)),s.abs(this.$l.uv)),this.$l.staticBias=s.min(this.$l.fractionalSamplingError,this.$l.minFractionalError),this.$return(s.vec3(this.$l.uv,this.$l.staticBias))}),s.getGlobalScope()[i](e)}function Uf(t,e,i,s,r,a){const n=a?"lib_sampleShadowMapCascadePCF":"lib_sampleShadowMapPCF",o=t.$builder,h=Nt(e);return o.func(n,[o.vec2("coords"),o.float("z"),o.vec2("offset"),...a?[o.int("cascade")]:[]],function(){const t=this.z,i=o.add(this.coords,this.offset);h?this.$return(a&&"webgl"!==Sl().type?o.textureArraySampleCompareLevel(Qc.getShadowMap(this),i,this.cascade,t):o.textureSampleCompareLevel(Qc.getShadowMap(this),i,t)):(this.$l.shadowTex=a&&"webgl"!==Sl().type?o.textureArraySampleLevel(Qc.getShadowMap(this),i,this.cascade,0):o.textureSampleLevel(Qc.getShadowMap(this),i,0),"rgba8unorm"===e&&(this.shadowTex.x=El(this,this.shadowTex)),this.$return(o.step(t,this.shadowTex.x)))}),o.getGlobalScope()[n](i,r,s,...a?[a]:[])}function Gf(t,e,i,s,r,a){const n="lib_sampleShadowMap",o=t.$builder,h=Nt(i);return o.func(n,[2===e?o.vec3("coords"):o.vec2("coords"),o.float("z"),...a?[o.int("cascade")]:[]],function(){2===e?h?this.$return(o.clamp(o.textureSampleCompareLevel(Qc.getShadowMap(this),this.coords,this.z),0,1)):(this.$l.shadowTex=o.textureSampleLevel(Qc.getShadowMap(this),this.coords,0),"rgba8unorm"===i&&(this.shadowTex.x=El(this,this.shadowTex)),this.$return(o.step(this.z,this.shadowTex.x))):h?this.$return(a&&"webgl"!==Sl().type?o.textureArraySampleCompareLevel(Qc.getShadowMap(this),this.coords,this.cascade,this.z):o.textureSampleCompareLevel(Qc.getShadowMap(this),this.coords,this.z)):(this.$l.shadowTex=a&&"webgl"!==Sl().type?o.textureArraySampleLevel(Qc.getShadowMap(this),this.coords,this.cascade,0):o.textureSampleLevel(Qc.getShadowMap(this),this.coords,0),"rgba8unorm"===i&&(this.shadowTex.x=El(this,this.shadowTex)),this.$return(o.step(this.z,this.shadowTex.x)))}),a?o.getGlobalScope()[n](s,r,a):o.getGlobalScope()[n](s,r)}function Hf(t,e,i){const s="lib_chebyshevUpperBound",r=t.$builder;return r.func(s,[r.float("distance"),r.vec2("occluder")],function(){this.$l.shadow=r.float(1),this.$l.test=r.step(this.distance,this.occluder.x),this.$if(r.notEqual(this.test,1),function(){this.$l.d=r.sub(this.distance,this.occluder.x),this.$l.variance=r.max(r.mul(this.occluder.y,this.occluder.y),0);const t=Qc.getDepthBiasValues(this).z;this.shadow=r.div(this.variance,r.add(this.variance,r.mul(this.d,this.d))),this.shadow=r.clamp(r.div(r.sub(this.shadow,t),r.sub(1,t)),0,1)}),this.$return(this.shadow)}),r.getGlobalScope()[s](e,i)}function Wf(t,e,i,s,r){const a="lib_filterShadowVSM",n=t.$builder;return n.func(a,[n.vec4("texCoord"),...r?[n.int("cascade")]:[]],function(){2===e?(this.$l.shadowTex=n.textureSampleLevel(Qc.getShadowMap(this),this.texCoord.xyz,0),this.$return(Hf(this,this.texCoord.w,"rgba8unorm"===i?Bl(this,this.shadowTex):this.shadowTex.rg))):("webgl"!==Sl().type&&r?this.$l.shadowTex=n.textureArraySampleLevel(Qc.getShadowMap(this),this.texCoord.xy,this.cascade,0):this.$l.shadowTex=n.textureSampleLevel(Qc.getShadowMap(this),this.texCoord.xy,0),this.$return(Hf(this,this.texCoord.z,"rgba8unorm"===i?Bl(this,this.shadowTex):this.shadowTex.rg)))}),n.getGlobalScope()[a](s,...r?[r]:[])}function Xf(t,e,i,s,r){const a="lib_filterShadowESM",n=t.$builder;return n.func(a,[2===e?n.vec3("shadowVertex"):n.vec4("shadowVertex"),...r?[n.int("cascade")]:[]],function(){2===e?(this.$l.depth=n.div(n.length(this.shadowVertex.xyz),Qc.getLightPositionAndRangeForShadow(this).w),this.$l.shadowTex=n.textureSampleLevel(Qc.getShadowMap(this),this.shadowVertex.xyz,0),"rgba8unorm"===i&&(this.shadowTex.x=El(this,this.shadowTex))):(r&&"webgl"!==Sl().type?this.$l.shadowTex=n.textureArraySampleLevel(Qc.getShadowMap(this),this.shadowVertex.xy,this.cascade,0):this.$l.shadowTex=n.textureSampleLevel(Qc.getShadowMap(this),this.shadowVertex.xy,0),"rgba8unorm"===i&&(this.shadowTex.x=El(this,this.shadowTex)),3===e?(this.$l.nearFar=Qc.getShadowCameraParams(this).xy,this.$l.depth=Qc.nonLinearDepthToLinearNormalized(this,this.shadowVertex.z,this.nearFar)):this.$l.depth=this.shadowVertex.z);const t=Qc.getDepthBiasValues(this).z;this.$return(n.clamp(n.exp(n.min(87,n.mul(t,n.sub(this.shadowTex.x,this.depth)))),0,1))}),n.getGlobalScope()[a](s,...r?[r]:[])}function jf(t,e,i,s,r,a,n){const o=`lib_filterShadowPCF${s}x${s}`,h=t.$builder;return h.func(o,[h.vec4("texCoord"),...a?[h.vec3("receiverPlaneDepthBias")]:[],...n?[h.int("cascade")]:[]],function(){this.$l.lightDepth=this.texCoord.z,a&&(this.lightDepth=h.sub(this.lightDepth,this.receiverPlaneDepthBias.z));const t=Vf(this);this.$l.uv=h.add(h.mul(this.texCoord.xy,h.vec2(function(t){return Qc.getShadowCameraParams(t).z}(this))),h.vec2(0)),this.$l.st=h.fract(this.uv),this.$l.baseUV=h.sub(h.floor(this.uv),h.vec2(.5)),this.baseUV=h.mul(this.baseUV,t),this.$l.shadow=h.float(0),3===s?(this.$l.uvw0=h.sub(h.vec2(3),h.mul(2,this.st)),this.$l.uvw1=h.add(h.vec2(1),h.mul(2,this.st)),this.$l.u=h.mul(h.vec2(h.sub(h.div(h.sub(2,this.st.x),this.uvw0.x),1),h.add(h.div(this.st.x,this.uvw1.x),1)),t),this.$l.v=h.mul(h.vec2(h.sub(h.div(h.sub(2,this.st.y),this.uvw0.y),1),h.add(h.div(this.st.y,this.uvw1.y),1)),t),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.x,this.v.x),this.lightDepth,this.cascade),this.uvw0.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.y,this.v.x),this.lightDepth,this.cascade),this.uvw1.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.x,this.v.y),this.lightDepth,this.cascade),this.uvw0.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.y,this.v.y),this.lightDepth,this.cascade),this.uvw1.x,this.uvw1.y)),this.shadow=h.div(this.shadow,16)):5===s?(this.$l.uvw0=h.sub(h.vec2(4),h.mul(this.st,3)),this.$l.uvw1=h.vec2(7),this.$l.uvw2=h.add(h.vec2(1),h.mul(this.st,3)),this.$l.u=h.mul(h.vec3(h.sub(h.div(h.sub(3,h.mul(this.st.x,2)),this.uvw0.x),2),h.div(h.add(this.st.x,3),this.uvw1.x),h.add(h.div(this.st.x,this.uvw2.x),2)),t),this.$l.v=h.mul(h.vec3(h.sub(h.div(h.sub(3,h.mul(this.st.y,2)),this.uvw0.y),2),h.div(h.add(this.st.y,3),this.uvw1.y),h.add(h.div(this.st.y,this.uvw2.y),2)),t),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.x,this.v.x),this.lightDepth,this.cascade),this.uvw0.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.y,this.v.x),this.lightDepth,this.cascade),this.uvw1.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.z,this.v.x),this.lightDepth,this.cascade),this.uvw2.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.x,this.v.y),this.lightDepth,this.cascade),this.uvw0.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.y,this.v.y),this.lightDepth,this.cascade),this.uvw1.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.z,this.v.y),this.lightDepth,this.cascade),this.uvw2.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.x,this.v.z),this.lightDepth,this.cascade),this.uvw0.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.y,this.v.z),this.lightDepth,this.cascade),this.uvw1.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.vec2(this.u.z,this.v.z),this.lightDepth,this.cascade),this.uvw2.x,this.uvw2.y)),this.shadow=h.div(this.shadow,144)):7===s&&(this.$l.uvw0=h.sub(h.mul(this.st,5),h.vec2(6)),this.$l.uvw1=h.sub(h.mul(this.st,11),h.vec2(28)),this.$l.uvw2=h.sub(h.mul(this.st,-11),h.vec2(17)),this.$l.uvw3=h.sub(h.mul(this.st,-5),1),this.$l.u=h.vec4(h.sub(h.div(h.sub(h.mul(this.st.x,4),5),this.uvw0.x),3),h.sub(h.div(h.sub(h.mul(this.st.x,4),16),this.uvw1.x),1),h.add(h.div(h.sub(h.mul(this.st.x,-7),5),this.uvw2.x),1),h.add(h.div(h.neg(this.st.x),this.uvw3.x),3)),this.$l.v=h.vec4(h.sub(h.div(h.sub(h.mul(this.st.y,4),5),this.uvw0.y),3),h.sub(h.div(h.sub(h.mul(this.st.y,4),16),this.uvw1.y),1),h.add(h.div(h.sub(h.mul(this.st.y,-7),5),this.uvw2.y),1),h.add(h.div(h.neg(this.st.y),this.uvw3.y),3)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.x),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.x),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.x),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.x),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw0.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.y),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.y),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.y),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.y),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw1.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.z),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.z),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.z),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.z),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw2.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.x,this.v.w),t),this.lightDepth,this.cascade),this.uvw0.x,this.uvw3.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.y,this.v.w),t),this.lightDepth,this.cascade),this.uvw1.x,this.uvw3.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.z,this.v.w),t),this.lightDepth,this.cascade),this.uvw2.x,this.uvw3.y)),this.shadow=h.add(this.shadow,h.mul(Uf(this,i,this.baseUV,h.mul(h.vec2(this.u.w,this.v.w),t),this.lightDepth,this.cascade),this.uvw3.x,this.uvw3.y)),this.shadow=h.div(this.shadow,2704)),this.$return(this.shadow)}),h.getGlobalScope()[o](r,...a?[a]:[],...n?[n]:[])}function Qf(t,e,i,s,r,a,n){const o="lib_filterShadowPoissonDisc",h=t.$builder;return h.func(o,[h.vec4("texCoord"),...a?[h.vec3("receiverPlaneDepthBias")]:[],...n?[h.int("cascade")]:[]],function(){this.$l.lightDepth=this.texCoord.z,a&&(this.lightDepth=h.sub(this.lightDepth,this.receiverPlaneDepthBias.z)),this.$l.duv=h.vec2(),this.$l.filterRadius=h.mul(Vf(this),function(t){return Qc.getDepthBiasValues(t).z}(this)),this.$l.matrix=function(t,e){const i="lib_getRandomRotationMatrix",s=t.$builder;return s.func(i,[s.vec2("fragCoord")],function(){this.$l.randomAngle=s.mul(function(t,e){const i=t.$builder;return i.fract(i.mul(52.9829189,i.fract(i.dot(e,i.vec2(.06711056,.00583715)))))}(this,e),2*Math.PI),this.$l.randomBase=s.vec2(s.cos(this.randomAngle),s.sin(this.randomAngle)),this.$return(s.mat2(this.randomBase.x,this.randomBase.y,s.neg(this.randomBase.y),this.randomBase.x))}),s.getGlobalScope()[i](e)}(this,this.$builtins.fragCoord.xy),this.$l.shadow=h.float(0);for(let t=0;t<s;t++){this.duv=h.mul(this.matrix,h.mul(h.vec2(zf[t][0],zf[t][1]),this.filterRadius));const s=a?h.add(this.lightDepth,h.dot(this.duv,this.receiverPlaneDepthBias.xy)):this.lightDepth;this.shadow=h.add(this.shadow,Gf(this,e,i,h.add(this.texCoord.xy,this.duv),s,this.cascade))}this.shadow=h.div(this.shadow,s),this.$return(this.shadow)}),h.getGlobalScope()[o](r,...a?[a]:[],...n?[n]:[])}function qf(t,e,i){const s=t.$builder,r=Qc.getDepthBiasValues(t),a=s.vec4(s.float(s.equal(i,0)),s.float(s.equal(i,1)),s.float(s.equal(i,2)),s.float(s.equal(i,3))),n=s.dot(Qc.getDepthBiasScales(t),a);return s.dot(s.mul(r.xy,s.vec2(1,s.sub(1,e)),n),s.vec2(1,1))}function Yf(t,e,i,s,r){const a=e.$builder,n=Qc.getDepthBiasValues(e);if(t)return a.dot(a.mul(n.xy,a.vec2(1,a.sub(1,s))),a.vec2(1,1));{const t=Qc.getShadowCameraParams(e).xy,o=r?i:Qc.nonLinearDepthToLinearNormalized(e,i,t),h=a.mix(1,n.w,o);return a.dot(a.mul(n.xy,a.vec2(1,a.sub(1,s)),h),a.vec2(1,1))}}class Zf extends Lf{static instance=new Zf;constructor(){super()}resourceDirty(){return!1}getType(){return"hard"}getShadowMapBorder(t){return 0}getShadowMap(t){return this.useNativeShadowMap(t)?t.shadowMapFramebuffer.getDepthAttachment():t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(this.useNativeShadowMap(t))||null}postRenderShadowMap(){}getDepthScale(){return 1}setDepthScale(t){}getShaderHash(){return""}getShadowMapColorFormat(t){if(this.useNativeShadowMap(t))return null;{const t=Sl();return"webgl"===t.type?t.getDeviceCaps().textureCaps.supportFloatColorBuffer?"rgba32f":t.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"rgba16f":"rgba8unorm":"r32f"}}getShadowMapDepthFormat(t){return"webgl"===Sl().type?"d24s8":"d32f"}computeShadowMapDepth(t,e,i){return Of(e,i,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const a="lib_computeShadowCSM",n=e.$builder,o=this;return n.func(a,[n.vec4("shadowVertex"),n.float("NdotL"),n.int("split")],function(){const e="rgba8unorm"!==t.shadowMap.format;this.$l.shadowCoord=n.div(this.shadowVertex.xyz,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord.xyz,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$if(this.inShadow,function(){this.$l.shadowBias=qf(this,this.NdotL,this.split),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),o.useNativeShadowMap(t)?t.shadowMap.isTexture2DArray()?this.shadow=n.textureArraySampleCompareLevel(Qc.getShadowMap(this),this.shadowCoord.xy,this.split,this.shadowCoord.z):this.shadow=n.textureSampleCompareLevel(Qc.getShadowMap(this),this.shadowCoord.xy,this.shadowCoord.z):(t.shadowMap.isTexture2DArray()?this.$l.shadowTex=n.textureArraySampleLevel(Qc.getShadowMap(this),this.shadowCoord.xy,this.split,0):this.$l.shadowTex=n.textureSampleLevel(Qc.getShadowMap(this),this.shadowCoord.xy,0),e||(this.shadowTex.x=El(this,this.shadowTex)),this.shadow=n.step(this.shadowCoord.z,this.shadowTex.x))}),this.$return(this.shadow)}),n.getGlobalScope()[a](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",a=e.$builder,n=this;return a.func(r,[a.vec4("shadowVertex"),a.float("NdotL")],function(){const e="rgba8unorm"!==t.shadowMap.format;2===t.lightType?(this.$l.dir=a.sub(this.shadowVertex.xyz,Qc.getLightPositionAndRangeForShadow(this).xyz),n.useNativeShadowMap(t)?(this.$l.nearFar=Qc.getShadowCameraParams(this).xy,this.$l.maxZ=a.max(a.max(a.abs(this.dir.x),a.abs(this.dir.y)),a.abs(this.dir.z)),this.$l.distance=Qc.linearDepthToNonLinear(this,this.maxZ,this.nearFar),this.$l.shadowBias=Yf(t.lightType,this,a.div(this.maxZ,Qc.getLightPositionAndRangeForShadow(this).w),this.NdotL,!0),this.$return(a.textureSampleCompareLevel(Qc.getShadowMap(this),this.dir,a.sub(this.distance,this.shadowBias)))):(this.$l.distance=a.div(a.length(this.dir),Qc.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=Yf(t.lightType,this,this.distance,this.NdotL,!0),this.$l.shadowTex=a.textureSampleLevel(Qc.getShadowMap(this),this.dir,0),e||(this.shadowTex.x=El(this,this.shadowTex)),this.distance=a.sub(this.distance,this.shadowBias),this.$return(a.step(this.distance,this.shadowTex.x)))):(this.$l.shadowCoord=a.div(this.shadowVertex.xyz,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord.xyz,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$if(this.inShadow,function(){n.useNativeShadowMap(t)?(this.$l.shadowBias=Yf(t.lightType,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.shadow=a.textureSampleCompareLevel(Qc.getShadowMap(this),this.shadowCoord.xy,this.shadowCoord.z)):(3===t.lightType?(this.$l.nearFar=Qc.getShadowCameraParams(this).xy,this.shadowCoord.z=Qc.nonLinearDepthToLinearNormalized(this,this.shadowCoord.z,this.nearFar),this.$l.shadowBias=Yf(t.lightType,this,this.shadowCoord.z,this.NdotL,!0)):this.$l.shadowBias=Yf(t.lightType,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.$l.shadowTex=a.textureSampleLevel(Qc.getShadowMap(this),this.shadowCoord.xy,0),e||(this.shadowTex.x=El(this,this.shadowTex)),this.shadow=a.step(this.shadowCoord.z,this.shadowTex.x))}),this.$return(this.shadow))}),a.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return"webgl"!==Sl().type}}class Kf extends Pl{_phase;_kernelSize;_sigma;_blurSize;_logSpace;_logSpaceMultiplier;_depthTex;_depthCutoff;constructor(t,e,i,s){super(),this._phase=t,this._kernelSize=e,this._sigma=i,this._blurSize=s,this._logSpace=!1,this._logSpaceMultiplier=1,this._depthTex=null,this._depthCutoff=.7}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}get kernelSize(){return this._kernelSize}set kernelSize(t){this._kernelSize!==t&&(this._kernelSize=t,this.invalidateHash())}get logSpace(){return this._logSpace}set logSpace(t){this._logSpace!==!!t&&(this._logSpace=!!t,this.invalidateHash())}get logSpaceMultiplier(){return this._logSpaceMultiplier}set logSpaceMultiplier(t){this._logSpaceMultiplier=t}get depthTexture(){return this._depthTex}set depthTexture(t){this._depthTex!==t&&(t&&this._depthTex||this.invalidateHash(),this._depthTex=t)}get depthCutoff(){return this._depthCutoff}set depthCutoff(t){this._depthCutoff=t}setup(t,e){const i=t.$builder;if("fragment"===i.shaderKind){if(this._depthTex&&(t.depthTex=i.tex2D().sampleType("unfilterable-float").uniform(0),t.depthCutoff=i.float().uniform(0)),t.sigma=i.float().uniform(0),t.blurSize=i.float().uniform(0),this._logSpace&&"horizonal"===this._phase&&(t.multiplier=i.float().uniform(0)),"horizonal"!==this._phase&&"vertical"!==this._phase)throw new Error(`GaussianBlurFilter.setupFilter() failed: invalid phase: ${this._phase}`);if(!Number.isInteger(this._kernelSize)||this._kernelSize<0||!(1&this._kernelSize))throw new Error(`GaussianBlurFilter.setupFilter() failed: invalid kernel size: ${this._kernelSize}`);t.blurMultiplyVec="cube"===e?"horizonal"===this._phase?i.vec3(1,0,0):i.vec3(0,1,0):"horizonal"===this._phase?i.vec2(1,0):i.vec2(0,1),t.numBlurPixelsPerSide=i.float((this._kernelSize+1)/2)}}setUniforms(t){t.setValue("sigma",this._sigma),t.setValue("blurSize",this._blurSize),this._logSpace&&"horizonal"===this._phase&&t.setValue("multiplier",this._logSpaceMultiplier),this._depthTex&&(t.setTexture("depthTex",this._depthTex),t.setValue("depthCutoff",this._depthCutoff))}filter(t,e,i,s,r,a){const n=this,o=t.$builder;return n._depthTex&&o.func("getLinearDepth",[o.vec2("uv")],function(){this.$l.depthValue=o.textureSample(this.depthTex,this.uv),"webgl"===o.getDevice().type?this.$return(El(this,this.depthValue)):this.$return(this.depthValue.r)}),t.incrementalGaussian=o.vec3(),t.incrementalGaussian.x=o.div(1,o.mul(t.sigma,Math.sqrt(2*Math.PI))),t.incrementalGaussian.y=o.exp(o.div(-.5,o.mul(t.sigma,t.sigma))),t.incrementalGaussian.z=o.mul(t.incrementalGaussian.y,t.incrementalGaussian.y),t.coefficientSum=o.float(0),t.minExpValue=o.vec4(87,87,87,87),t.d0=n.readTexel(t,e,i,s,r,a),n._logSpace?t.avgValue=o.vec4(t.incrementalGaussian.x):t.avgValue=o.mul(n.readTexel(t,e,i,s,r,a),t.incrementalGaussian.x),n._depthTex&&(t.centerDepth=t.getLinearDepth(s)),t.coefficientSum=o.add(t.coefficientSum,t.incrementalGaussian.x),t.incrementalGaussian=o.vec3(o.mul(t.incrementalGaussian.xy,t.incrementalGaussian.yz),t.incrementalGaussian.z),t.$for(o.float("i"),1,t.numBlurPixelsPerSide,function(){this.$l.uv1=o.sub(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),this.$l.d1=o.vec4(),n._depthTex?(this.$l.depth1=this.getLinearDepth(this.uv1),this.$l.test1=o.lessThan(o.abs(o.sub(this.depth1,this.centerDepth)),this.depthCutoff)):this.$l.test1=!0,this.$if(this.test1,function(){this.d1=n.readTexel(t,e,i,this.uv1,r,a)}),this.$l.uv2=o.add(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),this.$l.d2=o.vec4(),n._depthTex?(this.$l.depth2=this.getLinearDepth(this.uv2),this.$l.test2=o.lessThan(o.abs(o.sub(this.depth2,this.centerDepth)),this.depthCutoff)):this.$l.test2=!0,this.$if(this.test2,function(){this.d2=n.readTexel(t,e,i,o.add(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),r,a)}),n._logSpace?"horizonal"===n._phase?(this.$if(this.test1,function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.mul(o.sub(this.d1,this.d0),this.multiplier))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)}),this.$if(this.test2,function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.mul(o.sub(this.d2,this.d0),this.multiplier))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)})):(this.$if(this.test1,function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.sub(this.d1,this.d0))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)}),this.$if(this.test2,function(){this.avgValue=o.add(this.avgValue,o.mul(o.exp(o.min(this.minExpValue,o.sub(this.d2,this.d0))),this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)})):(this.$if(this.test1,function(){this.avgValue=o.add(this.avgValue,o.mul(this.d1,this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)}),this.$if(this.test2,function(){this.avgValue=o.add(this.avgValue,o.mul(this.d2,this.incrementalGaussian.x)),this.coefficientSum=o.add(this.coefficientSum,this.incrementalGaussian.x)})),this.incrementalGaussian=o.vec3(o.mul(this.incrementalGaussian.xy,this.incrementalGaussian.yz),this.incrementalGaussian.z)}),t.$l.outColor=o.div(t.avgValue,t.coefficientSum),n._logSpace&&("horizonal"===n._phase?t.outColor=o.add(o.mul(t.multiplier,t.d0),o.log(t.outColor)):t.outColor=o.add(t.d0,o.log(t.outColor))),t.outColor}calcHash(){return`${this._depthTex?1:0}-${this._phase}-${this._kernelSize}-${Number(!!this._logSpace)}`}}class Jf extends Kf{_packFloat;get packFloat(){return this._packFloat}set packFloat(t){this._packFloat!==!!t&&(this._packFloat=!!t,this.invalidateHash())}readTexel(t,e,i,s,r,a){const n=t.$builder,o=super.readTexel(t,e,i,s,r,a);return this.packFloat?n.vec4(El(t,o),0,0,1):o}writeTexel(t,e,i,s){const r=super.writeTexel(t,e,i,s);return this.packFloat?Ml(t,r.r):r}calcHash(){return`${super.calcHash()}-${Number(this.packFloat)}`}}class t_ extends Lf{_depthScale;_blur;_kernelSize;_blurSize;_logSpace;_blitterH;_blitterV;_mipmap;constructor(t,e,i){super(),this._blur=!0,this._depthScale=i??500,this._kernelSize=t??5,this._blurSize=e??1,this._logSpace=!0,this._mipmap=!0,this._blitterH=new Jf("horizonal",this._kernelSize,4,1/1024),this._blitterV=new Jf("vertical",this._kernelSize,4,1/1024)}resourceDirty(){return this._resourceDirty}get blur(){return this._blur}set blur(t){this._blur!==!!t&&(this._blur=!!t,this._resourceDirty=!0)}get mipmap(){return this._mipmap}set mipmap(t){this._mipmap!==!!t&&(this._mipmap=!!t,this._blur&&(this._resourceDirty=!0))}get kernelSize(){return this._kernelSize}set kernelSize(t){this._kernelSize=t}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}get logSpace(){return this._logSpace}set logSpace(t){this._logSpace=!!t}getType(){return"esm"}getShadowMapBorder(t){return this._blur?Math.ceil((this._kernelSize+1)/2*this._blurSize):0}getShadowMap(t){const e=t.implData;return e?e.blurFramebuffer2.getColorAttachments()[0]:t.shadowMapFramebuffer.getColorAttachments()[0]}fetchTemporalFramebuffer(t,e,i,s,r,a,n,o){const h=Sl(),l=i>1&&"webgl"!==h.type,u=a?l?[h.pool.fetchTemporalTexture2DArray(!1,a,s,r,i,o)]:2===e?[h.pool.fetchTemporalTextureCube(!1,a,s,o)]:[h.pool.fetchTemporalTexture2D(!1,a,s,r,o)]:null,c=n?l?h.pool.fetchTemporalTexture2DArray(!1,n,s,r,i,!1):"webgl"!==h.type&&2===e?h.pool.fetchTemporalTextureCube(!1,n,s,!1):h.pool.fetchTemporalTexture2D(!1,n,s,r,!1):null,d=h.pool.createTemporalFramebuffer(t,u,c);return u&&h.pool.releaseTexture(u[0]),c&&h.pool.releaseTexture(c),d}doUpdateResources(t){t.implData={blurFramebuffer:null,blurFramebuffer2:null};const e=this.getShadowMapColorFormat(t),i=t.shadowMapFramebuffer.getColorAttachments()[0].width,s=t.shadowMapFramebuffer.getColorAttachments()[0].height;this._blur?t.implData={blurFramebuffer:this.fetchTemporalFramebuffer(!0,t.lightType,t.numShadowCascades,i,s,e,null,!1),blurFramebuffer2:this.fetchTemporalFramebuffer(!0,t.lightType,t.numShadowCascades,i,s,e,null,!0)}:t.implData=null,t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(!1)??null}postRenderShadowMap(t){if(t.implData){const e=t.implData,i=t.shadowMapFramebuffer.getColorAttachments()[0];this._blitterH.blurSize=this._blurSize/i.width,this._blitterH.kernelSize=this._kernelSize,this._blitterH.logSpace=this._logSpace,this._blitterH.packFloat="rgba8unorm"===i.format,this._blitterV.blurSize=this._blurSize/i.height,this._blitterV.kernelSize=this._kernelSize,this._blitterV.logSpace=this._logSpace,this._blitterV.packFloat="rgba8unorm"===i.format,this._blitterH.blit(i,e.blurFramebuffer),this._blitterV.blit(e.blurFramebuffer.getColorAttachments()[0],e.blurFramebuffer2)}}getDepthScale(){return this._depthScale}setDepthScale(t){this._depthScale=t}getShaderHash(){return""}getShadowMapColorFormat(t){const e=Sl();return e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"webgl"===e.type?"rgba16f":"r16f":e.getDeviceCaps().textureCaps.supportFloatColorBuffer?"webgl"===e.type?"rgba32f":"r32f":"rgba8unorm"}getShadowMapDepthFormat(t){return"d24s8"}computeShadowMapDepth(t,e,i){return Of(e,i,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const a="lib_computeShadowCSM",n=e.$builder;return n.func(a,[n.vec4("shadowVertex"),n.float("NdotL"),n.int("split")],function(){this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$if(this.inShadow,function(){this.shadow=Xf(this,t.lightType,t.shadowMap.format,this.shadowCoord,this.split)}),this.$return(this.shadow)}),n.getGlobalScope()[a](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",a=e.$builder;return a.func(r,[a.vec4("shadowVertex"),a.float("NdotL")],function(){2===t.lightType?(this.$l.dir=a.sub(this.shadowVertex.xyz,Qc.getLightPositionAndRangeForShadow(this).xyz),this.$return(Xf(this,2,t.shadowMap.format,this.dir))):(this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$if(this.inShadow,function(){this.shadow=Xf(this,t.lightType,t.shadowMap.format,this.shadowCoord)}),this.$return(this.shadow))}),a.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return!1}}class e_ extends Pl{_phase;_packFloat;_blurSize;_kernelSize;constructor(t,e,i,s){super(),this._phase=t,this._blurSize=i,this._kernelSize=e,this._packFloat=s}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}get kernelSize(){return this._kernelSize}set kernelSize(t){t!==this._kernelSize&&(this._kernelSize=t,this.invalidateHash())}get packFloat(){return this._packFloat}set packFloat(t){this._packFloat!==!!t&&(this._packFloat=!!t,this.invalidateHash())}setup(t,e){const i=t.$builder;"fragment"===i.shaderKind&&(t.blurSize=i.float().uniform(0),t.blurMultiplyVec="cube"===e?"horizonal"===this._phase?i.vec3(1,0,0):i.vec3(0,1,0):"horizonal"===this._phase?i.vec2(1,0):i.vec2(0,1),t.numBlurPixelsPerSide=i.float((this._kernelSize+1)/2),t.weight=i.float(1/(this._kernelSize*this._kernelSize)))}setUniforms(t){t.setValue("blurSize",this._blurSize)}readTexel(t,e,i,s,r,a){const n=t.$builder,o=super.readTexel(t,e,i,s,r,a);return this._packFloat?"horizonal"===this._phase?n.vec4(El(t,o)):n.vec4(Bl(t,o),0,0):o}writeTexel(t,e,i,s){const r=super.writeTexel(t,e,i,s);return this._packFloat?function(t,e,i){const s=t.$builder,r="Z_encode2HalfToRGBA";return s.func(r,[s.float("a"),s.float("b")],function(){this.$l.t=s.vec4(this.a,s.fract(s.mul(this.a,255)),this.b,s.fract(s.mul(this.b,255))),this.$return(s.vec4(s.sub(this.t.x,s.div(this.t.y,255)),this.t.y,s.sub(this.t.z,s.div(this.t.w,255)),this.t.w))}),s.getGlobalScope()[r](e,i)}(t,r.x,r.y):r}filter(t,e,i,s,r,a){const n=this,o=t.$builder;return t.d0=n.readTexel(t,e,i,s,r,a),t.mean=o.float(0),t.squaredMean=o.float(0),t.$for(o.float("i"),1,t.numBlurPixelsPerSide,function(){this.d1=n.readTexel(this,e,i,o.sub(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),r,a),this.d2=n.readTexel(this,e,i,o.add(s,o.mul(this.blurMultiplyVec,this.blurSize,this.i)),r,a),this.mean=o.add(this.mean,this.d1.x),this.mean=o.add(this.mean,this.d2.x),"horizonal"===n._phase?(this.squaredMean=o.add(this.squaredMean,o.mul(this.d1.x,this.d1.x)),this.squaredMean=o.add(this.squaredMean,o.mul(this.d2.x,this.d2.x))):(this.squaredMean=o.add(this.squaredMean,o.dot(this.d1.xy,this.d1.xy)),this.squaredMean=o.add(this.squaredMean,o.dot(this.d2.xy,this.d2.xy)))}),t.mean=o.div(t.mean,n._kernelSize),t.squaredMean=o.div(t.squaredMean,n._kernelSize),t.stdDev=o.sqrt(o.max(0,o.sub(t.squaredMean,o.mul(t.mean,t.mean)))),o.vec4(t.mean,t.stdDev,0,1)}calcHash(){return`${this._phase}-${this._kernelSize}-${Number(this._packFloat)}`}}class i_ extends Lf{_blur;_kernelSize;_blurSize;_blitterH;_blitterV;_mipmap;_darkness;constructor(t,e,i){super(),this._blur=!0,this._kernelSize=t??5,this._blurSize=e??1,this._darkness=i??0,this._mipmap=!0,this._blitterH=new e_("horizonal",this._kernelSize,1/1024,!1),this._blitterV=new e_("vertical",this._kernelSize,1/1024,!1)}resourceDirty(){return this._resourceDirty}get blur(){return this._blur}set blur(t){this._blur!==!!t&&(this._blur=!!t,this._resourceDirty=!0)}get mipmap(){return this._mipmap}set mipmap(t){this._mipmap!==!!t&&(this._mipmap=!!t,this._blur&&(this._resourceDirty=!0))}get kernelSize(){return this._kernelSize}set kernelSize(t){this._kernelSize=t}get blurSize(){return this._blurSize}set blurSize(t){this._blurSize=t}getDepthScale(){return this._darkness}setDepthScale(t){this._darkness=t}getType(){return"vsm"}getShadowMapBorder(t){return this._blur?Math.ceil((this._kernelSize+1)/2*this._blurSize):0}getShadowMap(t){const e=t.implData;return e?e.blurFramebuffer2.getColorAttachments()[0]:t.shadowMapFramebuffer.getColorAttachments()[0]}fetchTemporalFramebuffer(t,e,i,s,r,a,n,o){const h=Sl(),l=i>1&&"webgl"!==h.type,u=a?l?[h.pool.fetchTemporalTexture2DArray(!1,a,s,r,i,o)]:2===e?[h.pool.fetchTemporalTextureCube(!1,a,s,o)]:[h.pool.fetchTemporalTexture2D(!1,a,s,r,o)]:null,c=n?l?h.pool.fetchTemporalTexture2DArray(!1,n,s,r,i,!1):"webgl"!==h.type&&2===e?h.pool.fetchTemporalTextureCube(!1,n,s,!1):h.pool.fetchTemporalTexture2D(!1,n,s,r,!1):null,d=h.pool.createTemporalFramebuffer(t,u,c);return u&&h.pool.releaseTexture(u[0]),c&&h.pool.releaseTexture(c),d}doUpdateResources(t){const e=this.getShadowMapColorFormat(t),i=t.shadowMapFramebuffer.getColorAttachments()[0].width,s=t.shadowMapFramebuffer.getColorAttachments()[0].height;this._blur&&(t.implData={blurFramebuffer:this.fetchTemporalFramebuffer(!0,t.lightType,t.numShadowCascades,i,s,e,null,!1),blurFramebuffer2:this.fetchTemporalFramebuffer(!0,t.lightType,t.numShadowCascades,i,s,e,null,this._mipmap)}),t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(!1)??null}postRenderShadowMap(t){if(this._blur){const e=t.implData;this._blitterH.blurSize=this._blurSize/t.shadowMap.width,this._blitterH.kernelSize=this._kernelSize,this._blitterH.packFloat="rgba8unorm"===t.shadowMap.format,this._blitterV.blurSize=this._blurSize/t.shadowMap.height,this._blitterV.kernelSize=this._kernelSize,this._blitterV.packFloat="rgba8unorm"===t.shadowMap.format,this._blitterH.blit(t.shadowMapFramebuffer.getColorAttachments()[0],e.blurFramebuffer),this._blitterV.blit(e.blurFramebuffer.getColorAttachments()[0],e.blurFramebuffer2)}}getShaderHash(){return""}getShadowMapColorFormat(t){const e=Sl();return e.getDeviceCaps().textureCaps.supportFloatColorBuffer&&e.getDeviceCaps().textureCaps.supportLinearFloatTexture?"webgl"===e.type?"rgba32f":"rg32f":e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer&&e.getDeviceCaps().textureCaps.supportLinearHalfFloatTexture?"webgl"===e.type?"rgba16f":"rg16f":"rgba8unorm"}getShadowMapDepthFormat(t){return"d24s8"}computeShadowMapDepth(t,e,i){return Of(e,i,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const a="lib_computeShadowCSM",n=e.$builder;return n.func(a,[n.vec4("shadowVertex"),n.float("NdotL"),n.int("split")],function(){this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$if(this.inShadow,function(){this.$l.shadowBias=qf(this,this.NdotL,this.split),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),this.shadow=Wf(this,t.lightType,t.shadowMap.format,this.shadowCoord,this.split)}),this.$return(this.shadow)}),n.getGlobalScope()[a](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",a=e.$builder;return a.func(r,[a.vec4("shadowVertex"),a.float("NdotL")],function(){2===t.lightType?(this.$l.dir=a.sub(this.shadowVertex.xyz,Qc.getLightPositionAndRangeForShadow(this).xyz),this.$l.distance=a.div(a.length(this.dir),Qc.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=Yf(t.lightType,this,this.distance,this.NdotL,!0),this.$l.coord=a.vec4(this.dir,a.sub(this.distance,this.shadowBias)),this.$return(Wf(this,t.lightType,t.shadowMap.format,this.coord))):(this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$if(this.inShadow,function(){3===t.lightType?(this.$l.nearFar=Qc.getShadowCameraParams(this).xy,this.shadowCoord.z=Qc.nonLinearDepthToLinearNormalized(this,this.shadowCoord.z,this.nearFar),this.$l.shadowBias=Yf(t.lightType,this,this.shadowCoord.z,this.NdotL,!0)):this.$l.shadowBias=Yf(t.lightType,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.shadow=Wf(this,t.lightType,t.shadowMap.format,this.shadowCoord)}),this.$return(this.shadow))}),a.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return!1}}class s_ extends Lf{_tapCount;_sampleRadius;_shadowSampler;constructor(t,e){super(),this._tapCount=t??3,this._sampleRadius=e??1,this._shadowSampler=null}get tapCount(){return this._tapCount}set tapCount(t){this._tapCount=t}getType(){return"pcf-pd"}dispose(){this._shadowSampler=null}resourceDirty(){return!1}getShadowMapBorder(t){return this._sampleRadius+1}getShadowMap(t){return this.useNativeShadowMap(t)?t.shadowMapFramebuffer.getDepthAttachment():t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(this.useNativeShadowMap(t))||null}postRenderShadowMap(){}getDepthScale(){return this._sampleRadius}setDepthScale(t){this._sampleRadius=t}getShaderHash(){return`${this._tapCount}`}getShadowMapColorFormat(t){if(this.useNativeShadowMap(t))return null;{const t=Sl();return t.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?"webgl"===t.type?"rgba16f":"r16f":t.getDeviceCaps().textureCaps.supportFloatColorBuffer?"webgl"===t.type?"rgba32f":"r32f":"rgba8unorm"}}getShadowMapDepthFormat(t){return"webgl"===Sl().type?"d24s8":"d32f"}computeShadowMapDepth(t,e,i){return Of(e,i,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const a="lib_computeShadowCSM",n=e.$builder,o=this;return n.func(a,[n.vec4("shadowVertex"),n.float("NdotL"),n.int("split")],function(){this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$l.receiverPlaneDepthBias=kf(this,this.shadowCoord),this.$if(this.inShadow,function(){this.$l.shadowBias=qf(this,this.NdotL,this.split),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),this.shadow=Qf(this,t.lightType,t.shadowMap.format,o._tapCount,this.shadowCoord,this.receiverPlaneDepthBias,this.split)}),this.$return(this.shadow)}),n.getGlobalScope()[a](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",a=e.$builder,n=this;return a.func(r,[a.vec4("shadowVertex"),a.float("NdotL")],function(){2===t.lightType?(this.$l.dir=a.sub(this.shadowVertex.xyz,Qc.getLightPositionAndRangeForShadow(this).xyz),n.useNativeShadowMap(t)?(this.$l.nearFar=Qc.getShadowCameraParams(this).xy,this.$l.maxZ=a.max(a.max(a.abs(this.dir.x),a.abs(this.dir.y)),a.abs(this.dir.z)),this.$l.distance=Qc.linearDepthToNonLinear(this,this.maxZ,this.nearFar),this.$l.shadowBias=Yf(t.lightType,this,a.div(this.maxZ,Qc.getLightPositionAndRangeForShadow(this).w),this.NdotL,!0),this.$return(n.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias))):(this.$l.distance=a.div(a.length(this.dir),Qc.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=Yf(t.lightType,this,this.distance,this.NdotL,!0),this.$return(n.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias)))):(this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$l.receiverPlaneDepthBias=kf(this,this.shadowCoord),this.$if(this.inShadow,function(){this.$l.shadowBias=Yf(t.lightType,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.shadow=Qf(this,t.lightType,t.shadowMap.format,n._tapCount,this.shadowCoord,this.receiverPlaneDepthBias)}),this.$return(this.shadow))}),a.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return"webgl"!==Sl().type}sampleShadowMap(t,e,i,s,r){const a="lib_sampleShadowMap",n=e.$builder,o=this;return n.func(a,[n.vec3("coords"),n.float("z"),n.float("bias")],function(){const e="rgba8unorm"!==t.shadowMap.format;o.useNativeShadowMap(t)?this.$return(n.clamp(n.textureSampleCompareLevel(Qc.getShadowMap(this),this.coords,n.sub(this.z,this.bias)),0,1)):(this.$l.shadowTex=n.textureSampleLevel(Qc.getShadowMap(this),this.coords,0),e||(this.shadowTex.x=El(this,this.shadowTex)),this.$l.distance=n.sub(this.z,this.bias),this.$return(n.step(this.distance,this.shadowTex.x)))}),n.getGlobalScope()[a](i,s,r)}sampleShadowMapCSM(t,e,i,s,r,a){const n="lib_sampleShadowMapCSM",o=e.$builder,h=this;return o.func(n,[o.vec4("coords"),o.int("split"),o.float("z"),o.float("bias")],function(){const e="rgba8unorm"!==t.shadowMap.format;this.$l.distance=o.sub(this.z,this.bias),h.useNativeShadowMap(t)?t.shadowMap.isTexture2DArray()?this.$return(o.clamp(o.textureArraySampleCompareLevel(Qc.getShadowMap(this),this.coords.xy,this.split,this.distance),0,1)):this.$return(o.clamp(o.textureSampleCompareLevel(Qc.getShadowMap(this),this.coords.xy,this.distance),0,1)):(t.shadowMap.isTexture2DArray()?this.$l.shadowTex=o.textureArraySampleLevel(Qc.getShadowMap(this),this.coords.xy,this.split,0):this.$l.shadowTex=o.textureSampleLevel(Qc.getShadowMap(this),this.coords.xy,0),e||(this.shadowTex.x=El(this,this.shadowTex)),this.$return(o.step(this.distance,this.shadowTex.x)))}),o.getGlobalScope()[n](i,s,r,a)}}class r_ extends Lf{_kernelSize;_shadowSampler;constructor(t){super(),this._kernelSize=t??5,this._shadowSampler=null}get kernelSize(){return this._kernelSize}set kernelSize(t){t=3!==t&&5!==t&&7!==t?5:t,this._kernelSize=t}getType(){return"pcf-opt"}dispose(){this._shadowSampler=null}resourceDirty(){return!1}getShadowMapBorder(t){return this._kernelSize}getShadowMap(t){return this.useNativeShadowMap(t)?t.shadowMapFramebuffer.getDepthAttachment():t.shadowMapFramebuffer.getColorAttachments()[0]}doUpdateResources(t){t.shadowMap=this.getShadowMap(t),t.shadowMapSampler=t.shadowMap?.getDefaultSampler(this.useNativeShadowMap(t))||null}postRenderShadowMap(){}getDepthScale(){return 1}setDepthScale(t){}getShaderHash(){return`${this._kernelSize}`}getShadowMapColorFormat(t){return this.useNativeShadowMap(t)?null:"rgba8unorm"}getShadowMapDepthFormat(t){return"webgl"===Sl().type?"d24s8":"d32f"}computeShadowMapDepth(t,e,i){return Of(e,i,t.shadowMap.format)}computeShadowCSM(t,e,i,s,r){const a="lib_computeShadowCSM",n=e.$builder,o=this;return n.func(a,[n.vec4("shadowVertex"),n.float("NdotL"),n.int("split")],function(){this.$l.shadowCoord=n.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=n.add(n.mul(this.shadowCoord,.5),.5),this.$l.inShadow=n.all(n.bvec2(n.all(n.bvec4(n.greaterThanEqual(this.shadowCoord.x,0),n.lessThanEqual(this.shadowCoord.x,1),n.greaterThanEqual(this.shadowCoord.y,0),n.lessThanEqual(this.shadowCoord.y,1))),n.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=n.float(1),this.$l.receiverPlaneDepthBias=kf(this,this.shadowCoord),this.$if(this.inShadow,function(){this.$l.shadowBias=qf(this,this.NdotL,this.split),this.shadowCoord.z=n.sub(this.shadowCoord.z,this.shadowBias),this.shadow=jf(this,t.lightType,t.shadowMap.format,o._kernelSize,this.shadowCoord,this.receiverPlaneDepthBias,this.split)}),this.$return(this.shadow)}),n.getGlobalScope()[a](i,s,r)}computeShadow(t,e,i,s){const r="lib_computeShadow",a=e.$builder,n=this;return a.func(r,[a.vec4("shadowVertex"),a.float("NdotL")],function(){2===t.lightType?(this.$l.dir=a.sub(this.shadowVertex.xyz,Qc.getLightPositionAndRangeForShadow(this).xyz),n.useNativeShadowMap(t)?(this.$l.nearFar=Qc.getShadowCameraParams(this).xy,this.$l.maxZ=a.max(a.max(a.abs(this.dir.x),a.abs(this.dir.y)),a.abs(this.dir.z)),this.$l.distance=Qc.linearDepthToNonLinear(this,this.maxZ,this.nearFar),this.$l.shadowBias=Yf(t.lightType,this,a.div(this.maxZ,Qc.getLightPositionAndRangeForShadow(this).w),this.NdotL,!0),this.$return(n.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias))):(this.$l.distance=a.div(a.length(this.dir),Qc.getLightPositionAndRangeForShadow(this).w),this.$l.shadowBias=Yf(t.lightType,this,this.distance,this.NdotL,!0),this.$return(n.sampleShadowMap(t,this,this.dir,this.distance,this.shadowBias)))):(this.$l.shadowCoord=a.div(this.shadowVertex,this.shadowVertex.w),this.$l.shadowCoord=a.add(a.mul(this.shadowCoord,.5),.5),this.$l.inShadow=a.all(a.bvec2(a.all(a.bvec4(a.greaterThanEqual(this.shadowCoord.x,0),a.lessThanEqual(this.shadowCoord.x,1),a.greaterThanEqual(this.shadowCoord.y,0),a.lessThanEqual(this.shadowCoord.y,1))),a.lessThanEqual(this.shadowCoord.z,1))),this.$l.shadow=a.float(1),this.$l.receiverPlaneDepthBias=kf(this,this.shadowCoord),this.$if(this.inShadow,function(){this.$l.shadowBias=Yf(t.lightType,this,this.shadowCoord.z,this.NdotL,!1),this.shadowCoord.z=a.sub(this.shadowCoord.z,this.shadowBias),this.shadow=jf(this,t.lightType,t.shadowMap.format,n._kernelSize,this.shadowCoord,this.receiverPlaneDepthBias)}),this.$return(this.shadow))}),a.getGlobalScope()[r](i,s)}useNativeShadowMap(t){return"webgl"!==Sl().type}sampleShadowMap(t,e,i,s,r){const a="lib_sampleShadowMap",n=e.$builder,o=this;return n.func(a,[n.vec3("coords"),n.float("z"),n.float("bias")],function(){const e="rgba8unorm"!==t.shadowMap.format;o.useNativeShadowMap(t)?this.$return(n.clamp(n.textureSampleCompareLevel(Qc.getShadowMap(this),this.coords,n.sub(this.z,this.bias)),0,1)):(this.$l.shadowTex=n.textureSampleLevel(Qc.getShadowMap(this),this.coords,0),e||(this.shadowTex.x=El(this,this.shadowTex)),this.$l.distance=n.sub(this.z,this.bias),this.$return(n.step(this.distance,this.shadowTex.x)))}),n.getGlobalScope()[a](i,s,r)}sampleShadowMapCSM(t,e,i,s,r,a){const n="lib_sampleShadowMapCSM",o=e.$builder,h=this;return o.func(n,[o.vec4("coords"),o.int("split"),o.float("z"),o.float("bias")],function(){const e="rgba8unorm"!==t.shadowMap.format;this.$l.distance=o.sub(this.z,this.bias),h.useNativeShadowMap(t)?t.shadowMap.isTexture2DArray()?this.$return(o.clamp(o.textureArraySampleCompareLevel(Qc.getShadowMap(this),this.coords.xy,this.split,this.distance),0,1)):this.$return(o.clamp(o.textureSampleCompareLevel(Qc.getShadowMap(this),this.coords.xy,this.distance),0,1)):(t.shadowMap.isTexture2DArray()?this.$l.shadowTex=o.textureArraySampleLevel(Qc.getShadowMap(this),this.coords.xy,this.split,0):this.$l.shadowTex=o.textureSampleLevel(Qc.getShadowMap(this),this.coords.xy,0),e||(this.shadowTex.x=El(this,this.shadowTex)),this.$return(o.step(this.distance,this.shadowTex.x)))}),o.getGlobalScope()[n](i,s,r,a)}}const a_=new W,n_=new Q(W.identity());class o_{static _snapMatrix=new W;static _target=new z;static _up=new z;static _frustumMin=new z;static _frustumMax=new z;static _frustumCenter=new z;static _lightCameras=new WeakMap;static _shadowMapParams=[];_light;_config;_resourceDirty;_shadowMode;_shadowDistance;_impl;_pdSampleCount;_pdSampleRadius;_pcfKernelSize;_vsmBlurKernelSize;_vsmBlurRadius;_vsmDarkness;_esmBlur;_esmBlurKernelSize;_esmBlurRadius;_esmDepthScale;_shadowRegion;constructor(t){this._light=t,this._config={shadowMapSize:1024,numCascades:1,splitLambda:.5,depthBias:.5,normalBias:.2,nearClip:1},this._resourceDirty=!0,this._shadowMode="hard",this._shadowDistance=2e3,this._impl=null,this._pdSampleCount=12,this._pdSampleRadius=4,this._pcfKernelSize=5,this._vsmBlurKernelSize=5,this._vsmBlurRadius=4,this._vsmDarkness=.3,this._esmBlur=!0,this._esmBlurKernelSize=5,this._esmBlurRadius=4,this._esmDepthScale=200,this._shadowRegion=null,this.applyMode(this._shadowMode)}copyFrom(t){this.shadowMapSize=t.shadowMapSize,this.shadowRegion=t.shadowRegion?new q(t.shadowRegion):null,this.shadowDistance=t.shadowDistance,this.numShadowCascades=t.numShadowCascades,this.splitLambda=t.splitLambda,this.depthBias=t.depthBias,this.normalBias=t.normalBias,this.nearClip=t.nearClip,this.mode=t.mode,this.pdSampleCount=t.pdSampleCount,this.pdSampleRadius=t.pdSampleRadius,this.pcfKernelSize=t.pcfKernelSize,this.vsmBlurKernelSize=t.vsmBlurKernelSize,this.vsmBlurRadius=t.vsmBlurRadius,this.vsmDarkness=t.vsmDarkness,this.esmBlur=t.esmBlur,this.esmBlurKernelSize=t.esmBlurKernelSize,this.esmBlurRadius=t.esmBlurRadius,this.esmDepthScale=t.esmDepthScale}get light(){return this._light}get shadowMapSize(){return this._config.shadowMapSize}set shadowMapSize(t){!Number.isInteger(t)||t<1?console.error(`invalid shadow map size: ${t}`):this._config.shadowMapSize!==t&&(this._config.shadowMapSize=t,this._resourceDirty=!0)}get shadowRegion(){return this._shadowRegion}set shadowRegion(t){this._shadowRegion=t}get shadowDistance(){return this._shadowDistance}set shadowDistance(t){this._shadowDistance=Math.max(0,t)}get numShadowCascades(){return this._config.numCascades}set numShadowCascades(t){1===t||2===t||3===t||4===t?!this._light.isDirectionLight()&&t>1?console.error("only directional light can have more than one shadow cascades"):t!==this._config.numCascades&&(this._config.numCascades=t,this._resourceDirty=!0):console.error(`invalid shadow cascade number: ${t}`)}get splitLambda(){return this._config.splitLambda}set splitLambda(t){this._config.splitLambda!==t&&(this._config.splitLambda=t)}get depthBias(){return this._config.depthBias}set depthBias(t){this._config.depthBias=t}get normalBias(){return this._config.normalBias}set normalBias(t){this._config.normalBias=t}get nearClip(){return this._config.nearClip}set nearClip(t){this._config.nearClip!==t&&(this._config.nearClip=t)}get mode(){return this._shadowMode}set mode(t){t!==this._shadowMode&&(this._shadowMode=t,this.applyMode(this._shadowMode))}getShaderHash(t){return`${t.impl.constructor.name}_${t.impl.getShaderHash()}_${t.lightType}_${t.shadowMap.target}_${Number(t.numShadowCascades>1)}_${Number(Sl().getDeviceCaps().textureCaps.getTextureFormatInfo(t.shadowMap.format).filterable)}`}get pdSampleCount(){return this._pdSampleCount}set pdSampleCount(t){if((t=Math.min(Math.max(1,Number(t)|0),64))!==this._pdSampleCount){this._pdSampleCount=t;const e=this.asPCFPD();e&&(e.tapCount=this._pdSampleCount)}}get pdSampleRadius(){return this._pdSampleRadius}set pdSampleRadius(t){(t=Math.max(0,Number(t)|0))!==this._pdSampleRadius&&(this._pdSampleRadius=t,this.asPCFPD()?.setDepthScale(this._pdSampleRadius))}get pcfKernelSize(){return this._pcfKernelSize}set pcfKernelSize(t){if((t=3!==t&&5!==t&&7!==t?5:t)!==this._pcfKernelSize){this._pcfKernelSize=t;const e=this.asPCFOPT();e&&(e.kernelSize=this._pcfKernelSize)}}get vsmBlurKernelSize(){return this._vsmBlurKernelSize}set vsmBlurKernelSize(t){if((t=1|Math.max(3,Number(t)|0))!==this._vsmBlurKernelSize){this._vsmBlurKernelSize=t;const e=this.asVSM();e&&(e.kernelSize=this._vsmBlurKernelSize)}}get vsmBlurRadius(){return this._vsmBlurRadius}set vsmBlurRadius(t){if((t=Math.max(0,Number(t)||0))!==this._vsmBlurRadius){this._vsmBlurRadius=t;const e=this.asVSM();e&&(e.blurSize=this._vsmBlurRadius)}}get vsmDarkness(){return this._vsmDarkness}set vsmDarkness(t){(t=Math.min(.999,Math.max(0,Number(t)||0)))!==this._vsmDarkness&&(this._vsmDarkness=t,this.asVSM()?.setDepthScale(this._vsmDarkness))}get esmBlur(){return this._esmBlur}set esmBlur(t){if(!!t!==this.esmBlur){this._esmBlur=!!t;const e=this.asESM();e&&(e.blur=this._esmBlur)}}get esmBlurKernelSize(){return this._esmBlurKernelSize}set esmBlurKernelSize(t){if((t=1|Math.max(3,Number(t)|0))!==this._esmBlurKernelSize){this._esmBlurKernelSize=t;const e=this.asESM();e&&(e.kernelSize=this._esmBlurKernelSize)}}get esmBlurRadius(){return this._esmBlurRadius}set esmBlurRadius(t){if((t=Math.max(0,Number(t)||0))!==this._esmBlurRadius){this._esmBlurRadius=t;const e=this.asESM();e&&(e.blurSize=this._esmBlurRadius)}}get esmDepthScale(){return this._esmDepthScale}set esmDepthScale(t){(t=Math.max(0,Number(t)||0))!==this._esmDepthScale&&(this._esmDepthScale=t,this.asESM()?.setDepthScale(this._esmDepthScale))}computeShadow(t,e,i,s){return this._impl.computeShadow(t,e,i,s)}computeShadowCSM(t,e,i,s,r){return this._impl.computeShadowCSM(t,e,i,s,r)}static releaseTemporalResources(t){if(t.shadowMapInfo){for(const e of t.shadowMapInfo.keys()){const i=t.shadowMapInfo.get(e);i.lightType=0,i.depthClampEnabled=!1,i.shaderHash="",i.numShadowCascades=1,i.shadowMapFramebuffer=null,i.impl=null,i.shadowMap=null,i.shadowMapSampler=null,i.implData=null,this._shadowMapParams.push(i)}t.shadowMapInfo=null}}static computeShadowBias(t,e,i,s,r){const a=e.$builder,n=Qc.getDepthBiasValues(e);if(1===t.lightType)return a.dot(a.mul(n.xy,a.vec2(1,a.sub(1,s))),a.vec2(1,1));{const t=Qc.getShadowCameraParams(e).xy,o=r?i:Qc.nonLinearDepthToLinearNormalized(e,i,t),h=a.mix(1,n.w,o);return a.dot(a.mul(n.xy,a.vec2(1,a.sub(1,s)),h),a.vec2(1,1))}}static computeShadowBiasCSM(t,e,i,s){const r=e.$builder,a=Qc.getDepthBiasValues(e),n=r.vec4(r.float(r.equal(s,0)),r.float(r.equal(s,1)),r.float(r.equal(s,2)),r.float(r.equal(s,3))),o=r.dot(Qc.getDepthBiasScales(e),n);return r.dot(r.mul(a.xy,r.vec2(1,r.sub(1,i)),o),r.vec2(1,1))}isTextureInvalid(t,e,i,s,r){return t&&(t.target!==e||t.format!==i||t.width!==s||t.height!==r||t.depth!==this.numShadowCascades)}createTexture(t,e,i,s,r){const a=Sl(),n={mipmapping:!1};switch(t){case"2d":return a.createTexture2D(e,i,s,n);case"cube":return a.createCubeTexture(e,i,n);case"2darray":return a.createTexture2DArray(e,i,s,r,n);default:return null}}static fetchTemporalFramebuffer(t,e,i,s,r,a,n,o){const h=Sl(),l=i>1&&"webgl"!==h.type,u=a?l?[h.pool.fetchTemporalTexture2DArray(!1,a,s,r,i,o)]:2===e?[h.pool.fetchTemporalTextureCube(!1,a,s,o)]:[h.pool.fetchTemporalTexture2D(!1,a,s,r,o)]:null,c=n?l?h.pool.fetchTemporalTexture2DArray(!1,n,s,r,i,!1):"webgl"!==h.type&&2===e?h.pool.fetchTemporalTextureCube(!1,n,s,!1):h.pool.fetchTemporalTexture2D(!1,n,s,r,!1):null,d=h.pool.createTemporalFramebuffer(t,u,c);return u&&h.pool.releaseTexture(u[0]),c&&h.pool.releaseTexture(c),d}updateResources(t){const e=Sl(),i=t.impl.getShadowMapColorFormat(t),s=t.impl.getShadowMapDepthFormat(t),r=t.numShadowCascades,a=r>1&&"webgl"!==e.type,n=r>1&&!a?2*this._config.shadowMapSize:this._config.shadowMapSize,o=r>2&&!a?2*this._config.shadowMapSize:this._config.shadowMapSize;t.shadowMapFramebuffer=o_.fetchTemporalFramebuffer(!0,this._light.lightType,r,n,o,i,s),t.impl=this._impl,this._impl.updateResources(t)}createLightCameraPoint(t){t.parent=t.scene.rootNode,t.position.setXYZ(0,0,0),t.rotation.identity(),t.scale.setXYZ(1,1,1),t.setPerspective(Math.PI/2,1,this._config.nearClip,Math.min(this._shadowDistance,this._light.range)),t.position.set(this._light.positionAndRange.xyz())}createLightCameraSpot(t){t.parent=this._light,t.position.setXYZ(0,0,0),t.rotation.identity(),t.scale.setXYZ(1,1,1),t.setPerspective(2*Math.acos(this._light.cutoff),1,this._config.nearClip,Math.min((this._shadowDistance,this._light).range))}createLightCameraDirectional(t,e,i,s,r){let a=e.frustumViewSpace;this._shadowDistance<e.getFarPlane()&&(a_.set(e.getProjectionMatrix()),a_.setNearFar(a_.getNearPlane(),this._shadowDistance),n_.initWithMatrix(a_),a=n_),r=r||0;const n=(this.shadowMapSize-2*r)/this.shadowMapSize,o=o_._frustumMin,h=o_._frustumMax,l=o_._frustumCenter,u=o_._target,c=o_._up;o.setXYZ(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),h.setXYZ(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),a.corners.forEach(t=>{o.inplaceMin(t),h.inplaceMax(t)});let d=.5*z.distance(o,h)*n;const p=e.thisToWorld(z.add(o,h,l).scaleBy(.5),l),m=.5*t.diagonalLength*n;if(m<d&&(d=m,z.add(t.minPoint,t.maxPoint,p).scaleBy(.5)),u.setXYZ(p.x+this._light.directionAndCutoff.x,p.y+this._light.directionAndCutoff.y,p.z+this._light.directionAndCutoff.z),c.setXYZ(0,1,0),i.lookAt(p,u,c),i.position.set(p),i.setOrtho(-d,d,-d,d,-d,Math.max(z.distance(p,e.getWorldPosition()),e.getFarPlane())),p.setXYZ(0,0,0),i.viewProjectionMatrix.transformPointP(p,p),s){const t=p.x*this.shadowMapSize*.5,e=p.y*this.shadowMapSize*.5,i=Math.round(t),r=Math.round(e);p.setXYZ(2*(i-t)/this.shadowMapSize,2*(r-e)/this.shadowMapSize,0),s.translation(p)}}static fetchShadowMapParams(){return this._shadowMapParams.length>0?this._shadowMapParams.pop():{lightType:0,depthClampEnabled:!1,shaderHash:"",cameraParams:new O,cascadeDistances:new O,depthBiasScales:new O,depthBiasValues:[new O,new O,new O,new O],numShadowCascades:1,shadowMatrices:new Float32Array(64),shadowMap:null,shadowMapSampler:null,shadowMapFramebuffer:null,impl:null,implData:null}}static fetchCameraForScene(t){const e=this._lightCameras.get(t);if(e&&0!==e.length){const i=e.pop();return i.parent=t.rootNode,i.position.setXYZ(0,0,0),i.rotation.identity(),i.scale.setXYZ(1,1,1),i.clipMask=0,i}{const e=new df(t);return yt(e),e}}static releaseCamera(t){let e=this._lightCameras.get(t.scene);e||(e=[],this._lightCameras.set(t.scene,e)),t.remove(),e.push(t)}calcSplitDistances(t,e,i){const s=[0,0,0,0,0];for(let r=0;r<=i;++r){const a=r/i,n=t*Math.pow(e/t,a),o=t+(e-t)*a;s[r]=n*this._config.splitLambda+o*(1-this._config.splitLambda)}return s}calcDepthBiasParams(t,e,i,s,r,a){const n=Math.min(t.getProjectionMatrix().getNearPlaneWidth(),t.getProjectionMatrix().getNearPlaneHeight()),o=Math.min(t.getProjectionMatrix().getFarPlaneWidth(),t.getProjectionMatrix().getFarPlaneHeight()),h=n/e*2;a.setXYZW(i*h,1e-4*s,r,o/n)}postRenderShadowMap(t){this._impl.postRenderShadowMap(t)}render(t,e){t.shadowMapInfo||(t.shadowMapInfo=new Map);const i=o_.fetchShadowMapParams();i.impl=this._impl,i.lightType=this.light.lightType,i.numShadowCascades=1===i.lightType?this._config.numCascades:1,t.shadowMapInfo.set(this.light,i);const s=t.scene,r=t.camera;e.light=this._light,this.updateResources(i),i.shaderHash=this.getShaderHash(i);const a=Sl(),n=i.shadowMapFramebuffer;i.depthClampEnabled=!1,e.clearColor=n.getColorAttachments()[0]?n.getColorAttachments()[0].isFloatFormat()?new O(1,1,1,1):new O(0,0,0,1):null;const o=this._impl.getDepthScale(),h=this._light.isDirectionLight()&&this._shadowRegion&&this._shadowRegion.isValid()?this._shadowRegion:s.boundingBox;if(this._light.isPointLight()){const h=o_.fetchCameraForScene(s);this.createLightCameraPoint(h),this.calcDepthBiasParams(r,this._config.shadowMapSize,this._config.depthBias,this._config.normalBias,o,i.depthBiasValues[0]),i.cameraParams.setXYZW(h.getNearPlane(),h.getFarPlane(),this._config.shadowMapSize,this._shadowDistance),a.setFramebuffer(n),i.shadowMatrices.set(W.transpose(h.viewMatrix));for(const i of[R.PX,R.NX,R.PY,R.NY,R.PZ,R.NZ])h.lookAtCubeFace(i),n.setColorAttachmentCubeFace(0,i),n.setDepthAttachmentCubeFace(i),t.camera=h,e.render(t);i.shadowMatrices.set(W.identity()),o_.releaseCamera(h)}else if(this._config.numCascades>1){const l=this.calcSplitDistances(r.getNearPlane(),Math.min(this._shadowDistance,r.getFarPlane()),this._config.numCascades),u=o_.fetchCameraForScene(s),c=o_.fetchCameraForScene(s),d=o_.fetchCameraForScene(s);d.clipMask=q.ClipLeft|q.ClipRight|q.ClipBottom|q.ClipTop,u.parent=r,i.depthClampEnabled=Sl().getDeviceCaps().shaderCaps.supportFragmentDepth;for(let s=0;s<this._config.numCascades;s++){u.setPerspective(r.getFOV(),r.getAspect(),l[s],l[s+1]);const p=o_._snapMatrix,m=i.impl.getShadowMapBorder(i);this.createLightCameraDirectional(h,u,c,p,m),this.createLightCameraDirectional(h,u,d,null,m),this.calcDepthBiasParams(r,this._config.shadowMapSize,this._config.depthBias,this._config.normalBias,o,i.depthBiasValues[s]),i.depthBiasScales[s]=1,i.cameraParams.setXYZW(c.getNearPlane(),c.getFarPlane(),this._config.shadowMapSize,this._shadowDistance);let f=null;if(n.getColorAttachments()[0]?.isTexture2DArray()||n.getDepthAttachment()?.isTexture2DArray())c.setProjectionMatrix(W.multiply(p,c.getProjectionMatrix())),n.setColorAttachmentLayer(0,s),n.setDepthAttachmentLayer(s);else{const t=this._config.numCascades>2?2:1,e=this._config.numCascades>1?2:1,i=new W,r=s%2,n=s>>1;i.setRowXYZW(0,1.5-.5*e,0,0,0),i.setRowXYZW(1,0,1.5-.5*t,0,0),i.setRowXYZW(2,0,0,1,0),i.setRowXYZW(3,r-.5*e+.5,n-.5*t+.5,0,1),c.setProjectionMatrix(W.multiply(i,W.multiply(p,c.getProjectionMatrix()))),f="webgpu"===a.type?[r*this._config.shadowMapSize,(t-1-n)*this._config.shadowMapSize,this._config.shadowMapSize,this._config.shadowMapSize]:[r*this._config.shadowMapSize,n*this._config.shadowMapSize,this._config.shadowMapSize,this._config.shadowMapSize]}a.setFramebuffer(n),a.setScissor(f),t.camera=c,e.render(t,d),i.shadowMatrices.set(W.transpose(c.viewProjectionMatrix),16*s),i.cascadeDistances[s]=l[s+1]}o_.releaseCamera(u),o_.releaseCamera(c),o_.releaseCamera(d)}else{const l=o_.fetchCameraForScene(s),u=o_._snapMatrix;l.clipMask=q.ClipLeft|q.ClipRight|q.ClipBottom|q.ClipTop,this._light.isDirectionLight()?this.createLightCameraDirectional(h,r,l,u,i.impl.getShadowMapBorder(i)):this.createLightCameraSpot(l),this.calcDepthBiasParams(r,this._config.shadowMapSize,this._config.depthBias,this._config.normalBias,o,i.depthBiasValues[0]),i.cameraParams.setXYZW(l.getNearPlane(),l.getFarPlane(),this._config.shadowMapSize,this._shadowDistance),a.setFramebuffer(n),l.setProjectionMatrix(W.multiply(u,l.getProjectionMatrix())),t.camera=l,e.render(t),i.shadowMatrices.set(W.transpose(l.viewProjectionMatrix)),o_.releaseCamera(l)}t.camera=r,this.postRenderShadowMap(i)}applyMode(t){"hard"===t||"vsm"===t||"esm"===t||"pcf-pd"===t||"pcf-opt"===t?(this._impl=null,"hard"===t?this._impl=new Zf:"vsm"===t?this._impl=new i_(this._vsmBlurKernelSize,this._vsmBlurRadius,this._vsmDarkness):"esm"===t?this._impl=new t_(this._esmBlurKernelSize,this._esmBlurRadius,this._esmDepthScale):"pcf-pd"===t?this._impl=new s_(this._pdSampleCount,this._pdSampleRadius):"pcf-opt"===t&&(this._impl=new r_(this._pcfKernelSize))):console.error(`ShadowMapper.setShadowMode() failed: invalid mode: ${t}`)}asVSM(){return"vsm"===this._impl?.getType()?this._impl:null}asESM(){return"esm"===this._impl?.getType()?this._impl:null}asPCFPD(){return"pcf-pd"===this._impl?.getType()?this._impl:null}asPCFOPT(){return"pcf-opt"===this._impl?.getType()?this._impl:null}}let h_=0;const l_=new L,u_=new WeakMap,c_=new WeakMap,d_={},p_=new WeakMap;function m_(t){if(t){const e=p_.get(t);if(e){p_.delete(t),c_.delete(t);const i=d_[e];i?i.push(t):d_[e]=[t]}else t.dispose()}}function f_(t){return class extends t{_mdRenderQueueRef;_mdDrawableBindGroup;_mdDrawableBindGroupInstanced;_mdDrawableBindGroupSkin;_mdDrawableBindGroupMorph;_mdDrawableBindGroupSkinMorph;_worldMatrixBuffer;_framestampBuffer;_currentWorldMatrixBuffer;_prevWorldMatrixBuffer;_drawableId;_objectColor;constructor(...t){super(...t),this._drawableId=++h_,this._objectColor=null,this._mdRenderQueueRef=[],this._mdDrawableBindGroup=null,this._mdDrawableBindGroupInstanced=new Map,this._mdDrawableBindGroupSkin=null,this._mdDrawableBindGroupMorph=null,this._mdDrawableBindGroupSkinMorph=null,this._worldMatrixBuffer=new Float32Array(36),this._framestampBuffer=new Int32Array(this._worldMatrixBuffer.buffer,64),this._currentWorldMatrixBuffer=this._worldMatrixBuffer.subarray(0,16),this._prevWorldMatrixBuffer=this._worldMatrixBuffer.subarray(20,36),this._currentWorldMatrixBuffer.set(this.getNode().worldMatrix),this._framestampBuffer[0]=Sl().frameInfo.frameCounter,this._framestampBuffer[1]=this._framestampBuffer[0],this._prevWorldMatrixBuffer.set(this.getNode().worldMatrix),this.getNode().on("transformchanged",()=>{const t=Sl().frameInfo.frameCounter;t!==this._framestampBuffer[1]&&(this._prevWorldMatrixBuffer.set(this._currentWorldMatrixBuffer),this._framestampBuffer[0]=t,this._framestampBuffer[1]=t),this._currentWorldMatrixBuffer.set(this.getNode().worldMatrix);for(const t of this._mdRenderQueueRef)t.ref&&this.applyTransformUniforms(t.ref)})}getDrawableId(){return this._drawableId}getObjectColor(){if(!this._objectColor){const t=(255&this._drawableId)/255,e=(this._drawableId>>>8&255)/255,i=(this._drawableId>>>16&255)/255,s=(this._drawableId>>>24&255)/255;this._objectColor=new O(s,i,e,t)}return this._objectColor}pushRenderQueueRef(t){this.renderQueueRefPrune(),this._mdRenderQueueRef.push(t)}renderQueueRefPrune(t=!1){for(let e=this._mdRenderQueueRef.length-1;e>=0;e--){const i=this._mdRenderQueueRef[e].ref;if(t||i.disposed){this._mdRenderQueueRef.splice(e,1);const t=this._mdDrawableBindGroupInstanced.get(i);t&&(m_(t),this._mdDrawableBindGroupInstanced.delete(i))}}}applyInstanceOffsetAndStride(t,e,i){const s=this.getDrawableBindGroup(Sl(),!0,t);s.setValue(Qc.getInstanceDataStrideUniformName(),e>>2),s.setValue(Qc.getInstanceDataOffsetUniformName(),i>>2)}applyTransformUniforms(t){const e=t.getInstanceInfo(this),i=this.getNode().transformTag;if(e){(u_.get(e)??-1)!==i&&(e.bindGroup.bindGroup.setRawData(Qc.getInstanceDataUniformName(),4*e.offset,this._worldMatrixBuffer,0,36),u_.set(e,i))}else{const e=this.getDrawableBindGroup(Sl(),!1,t);(c_.get(e)??-1)!==i&&(e.setValue(Qc.getWorldMatrixUniformName(),this._currentWorldMatrixBuffer),e.setValue(Qc.getPrevWorldMatrixUniformName(),this._prevWorldMatrixBuffer),e.setValue(Qc.getPrevWorldMatrixFrameUniformName(),this._framestampBuffer[0]),this.getBoneMatrices()&&e.setValue(Qc.getBoneInvBindMatrixUniformName(),this.invWorldMatrix),c_.set(e,i))}}applyMaterialUniformsAll(){for(const t of this._mdRenderQueueRef)if(t.ref){const e=t.ref.getInstanceInfo(this);e&&this.applyMaterialUniforms(e)}}applyMaterialUniforms(t){const e=this.getInstanceUniforms();e&&t.bindGroup.bindGroup.setRawData(Qc.getInstanceDataUniformName(),4*(t.offset+4*Qc.MATERIAL_INSTANCE_DATA_OFFSET),e,0,e.length)}bind(t){const e=t.device,i=this.getDrawableBindGroup(e,!!t.instanceData,t.renderQueue);if(e.setBindGroup(1,i),e.setBindGroup(3,t.instanceData?t.instanceData.bindGroup.bindGroup:null),t.materialFlags&gu.SKIN_ANIMATION){const t=this.getBoneMatrices();i.setTexture(Qc.getBoneMatricesUniformName(),t),i.setValue(Qc.getBoneInvBindMatrixUniformName(),this.invWorldMatrix),l_.setXY(t.width,t.height),i.setValue(Qc.getBoneTextureSizeUniformName(),l_)}if(t.materialFlags&gu.MORPH_ANIMATION){const t=this.getMorphData(),e=this.getMorphInfo();i.setTexture(Qc.getMorphDataUniformName(),t.texture.get()),i.setBuffer(Qc.getMorphInfoUniformName(),e.buffer.get())}}getDrawableBindGroup(t,e,i){const s=!!this.getBoneMatrices(),r=!!this.getMorphData();let a=e?this._mdDrawableBindGroupInstanced.get(i):s&&r?this._mdDrawableBindGroupSkinMorph:s?this._mdDrawableBindGroupSkin:r?this._mdDrawableBindGroupMorph:this._mdDrawableBindGroup;return a||(a=function(t,e,i){const s=`${i}:${e}:${t}`,r=d_[s];let a=null;if(r&&r.length>0)a=r.pop();else{const s=Qc.getDrawableBindGroupLayout(t,e,i);a=Sl().createBindGroup(s)}return p_.set(a,s),a}(s,r,e),e?this._mdDrawableBindGroupInstanced.set(i,a):s&&r?this._mdDrawableBindGroupSkinMorph=a:s?this._mdDrawableBindGroupSkin=a:r?this._mdDrawableBindGroupMorph=a:this._mdDrawableBindGroup=a,e||a.setValue(Qc.getObjectColorUniformName(),this.getObjectColor())),a}onDispose(){super.onDispose(),this.renderQueueRefPrune(!0),m_(this._mdDrawableBindGroup),m_(this._mdDrawableBindGroupSkin),m_(this._mdDrawableBindGroupMorph)}}}class __ extends(a(Nf,f_)){_primitive;_material;_castShadow;_skinnedBoundingInfo;_animatedBoundingBox;_skeletonName;_boneMatrices;_morphData;_morphInfo;_instanceHash;_batchable;_pickTarget;_skinAnimation;_morphAnimation;_renderBundle;_useRenderBundle;_materialChangeTag;_primitiveChangeTag;constructor(t,e,i){super(t),this._primitive=new wt,this._material=new wt,this._castShadow=!0,this._skinnedBoundingInfo=null,this._animatedBoundingBox=null,this._boneMatrices=new wt,this._morphData=null,this._morphInfo=null,this._instanceHash=null,this._pickTarget={node:this},this._batchable="webgl"!==Sl().type,this.primitive=e??null,this.material=i??__._getDefaultMaterial(),this._skinAnimation=!1,this._skeletonName="",this._morphAnimation=!1,this._renderBundle={},this._useRenderBundle=!0,this._materialChangeTag=null,this._primitiveChangeTag=null}getName(){return this._name}getInstanceId(t){return`${this._instanceHash}:${this.worldMatrixDet>=0}`}getInstanceUniforms(){return this._material.get().$instanceUniforms}getPickTarget(){return this._pickTarget}setPickTarget(t,e){this._pickTarget={node:t,label:e}}get skeletonName(){return this._skeletonName}set skeletonName(t){t!==this._skeletonName&&(this._skeletonName=t,this.updateSkeletonState())}get skinnedBoundingInfo(){return this._skinnedBoundingInfo}get skinAnimation(){return this._skinAnimation}set skinAnimation(t){this._skinAnimation=t}get morphAnimation(){return this._morphAnimation}set morphAnimation(t){this._morphAnimation=t}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t}get primitive(){return this._primitive.get()}set primitive(t){const e=this._primitive.get();t!==e&&(e&&e.off("bv_changed",this._onBoundingboxChange,this),this._primitive.set(t),t&&t.on("bv_changed",this._onBoundingboxChange,this),this._instanceHash=t&&this._material.get()?`${this.constructor.name}:${this._scene.id}:${t.id}:${this._material.get().instanceId}`:null,this.invalidateBoundingVolume(),Al.drawableChanged(this),this._primitiveChangeTag=null)}get material(){return this._material.get()}set material(t){this._material.get()!==t&&(this._material.set(t),t&&Al.materialAttached(t.coreMaterial,this),this._instanceHash=this._primitive.get()&&t?`${this.constructor.name}:${this._scene?.id??0}:${this._primitive.get().id}:${t.instanceId}`:null,Al.drawableChanged(this),this._materialChangeTag=null)}isMesh(){return!0}setAnimatedBoundingBox(t){this._animatedBoundingBox=t,this.invalidateBoundingVolume()}getAnimatedBoundingBox(){return this._animatedBoundingBox??null}setBoneMatrices(t){this._boneMatrices.get()!==t&&(this._boneMatrices.set(t),this._renderBundle={},Al.drawableChanged(this))}setMorphData(t){if(t){if(this._morphData||(this._morphData={width:0,height:0,data:null,texture:new wt}),this._morphData.width=t.width,this._morphData.height=t.height,this._morphData.data=t.data.slice(),t.texture?.get())this._morphData.texture.set(t.texture.get());else{const e=Sl().createTexture2D("rgba32f",t.width,t.height,{mipmapping:!1,samplerOptions:{minFilter:"nearest",magFilter:"nearest",mipFilter:"none"}});e.update(t.data,0,0,t.width,t.height),this._morphData.texture.set(e)}this._renderBundle={},Al.drawableChanged(this)}else this._morphData&&(this._morphData?.texture.dispose(),this._morphData=null,this._renderBundle={},Al.drawableChanged(this))}setSkinnedBoundingInfo(t){this._skinnedBoundingInfo=t}getMorphData(){return this._morphData}setMorphInfo(t){if(t){if(this._morphInfo||(this._morphInfo={data:null,buffer:new wt}),this._morphInfo.data=t.data.slice(),t.buffer?.get())this._morphInfo.buffer.set(t.buffer.get());else{const e=new ge("dummy","std140",[{name:Qc.getMorphInfoUniformName(),type:new xe(new _e(te.F32VEC4),67)}]),i=Sl().createStructuredBuffer(e,{usage:"uniform"},t.data);this._morphInfo.buffer.set(i)}this._renderBundle={},Al.drawableChanged(this)}else this._morphInfo&&(this._morphInfo.buffer.dispose(),this._morphInfo=null,this._renderBundle={},Al.drawableChanged(this))}getMorphInfo(){return this._morphInfo}update(t,e,i){super.update(t,e,i),this.updateSkeletonState()}isBatchable(){return this._batchable&&!this._boneMatrices.get()&&!this._morphData&&this._material.get()?.isBatchable()}getQueueType(){return this.material?.getQueueType()??1}isUnlit(){return!this.material?.supportLighting()}needSceneColor(){return this.material?.needSceneColor()}needSceneDepth(){return this.material?.needSceneDepth()}updateSkeletonState(){if(this._skeletonName){const t=this.findSkeletonById(this._skeletonName);t?.playing?(this.setBoneMatrices(t.jointTexture),t.computeBoundingBox(this._skinnedBoundingInfo,this.invWorldMatrix),this.setAnimatedBoundingBox(this._skinnedBoundingInfo.boundingBox)):(this.setBoneMatrices(null),this.setAnimatedBoundingBox(null)),this.scene.queueUpdateNode(this)}else this.setBoneMatrices(null),this.setAnimatedBoundingBox(null)}draw(t,e){const i=this.material,s=this.primitive;if(i&&s)if(this._useRenderBundle&&!t.instanceData&&e){this._primitiveChangeTag===s.changeTag&&this._materialChangeTag===i.changeTag||(this._renderBundle={},this._primitiveChangeTag=s.changeTag,this._materialChangeTag=i.changeTag);const r=this._renderBundle[e];r?t.device.executeRenderBundle(r):(t.device.beginCapture(),this.bind(t),i.draw(s,t),this._renderBundle[e]=t.device.endCapture())}else this.bind(t),i.draw(s,t)}getMaterial(){return this.material}getPrimitive(){return this.primitive}getBoneMatrices(){return this._boneMatrices.get()}getNode(){return this}computeBoundingVolume(){let t;return t=this._animatedBoundingBox?this._animatedBoundingBox:this._primitive.get()?.getBoundingVolume()??null,t}onDispose(){super.onDispose(),this.skeletonName=null,this._primitive.get()?.off("bv_changed",this._onBoundingboxChange,this),this._primitive.dispose(),this._material.dispose(),this._boneMatrices.dispose(),this.setMorphData(null),this.setMorphInfo(null),this._renderBundle=null,Al.drawableChanged(this)}_onBoundingboxChange(){this.invalidateBoundingVolume()}static _defaultMaterial=null;static _getDefaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=new nd),this._defaultMaterial}}class g_ extends gt{_version;_windVelocity;_numOctaves;_amplitude;_frequency;_lacunarity;_gain;constructor(){super(),this._version=0,this._numOctaves=4,this._windVelocity=new L(.1,0),this._amplitude=.3,this._frequency=3,this._lacunarity=1.83,this._gain=.57}clone(){const t=new g_;return t.numOctaves=this.numOctaves,t.wind=this.wind,t.amplitude=this.amplitude,t.frequency=this.frequency,t}get version(){return this._version}get numOctaves(){return this._numOctaves}set numOctaves(t){t!==this.numOctaves&&(this._numOctaves=t,this._version++)}get amplitude(){return this._amplitude}set amplitude(t){t!==this._amplitude&&(this._amplitude=t,this._version++)}get frequency(){return this._frequency}set frequency(t){t!==this._frequency&&(this._frequency=t,this._version++)}get wind(){return this._windVelocity}set wind(t){t.equalsTo(this._windVelocity)||(this._windVelocity.set(t),this._version++)}calcWaveNormal(t,e,i,s,r,a,n,o,h){const l=t.$builder,u="calcWaveNormal",c=this;return l.func(u,[l.vec2("worldPos"),l.float("time"),l.vec2("windVelocity"),l.float("amplitude"),l.float("frequency"),l.float("gain"),l.float("lacunarity"),l.int("numOctaves")],function(){this.$l.epsilon=l.float(.1),this.$l.hr=c.calcWaveHeight(this,l.add(this.worldPos,l.vec2(this.epsilon,0)),this.windVelocity,this.amplitude,this.frequency,this.gain,this.lacunarity,this.numOctaves),this.$l.hl=c.calcWaveHeight(this,l.sub(this.worldPos,l.vec2(this.epsilon,0)),this.windVelocity,this.amplitude,this.frequency,this.gain,this.lacunarity,this.numOctaves),this.$l.hu=c.calcWaveHeight(this,l.add(this.worldPos,l.vec2(0,this.epsilon)),this.windVelocity,this.amplitude,this.frequency,this.gain,this.lacunarity,this.numOctaves),this.$l.hd=c.calcWaveHeight(this,l.sub(this.worldPos,l.vec2(0,this.epsilon)),this.windVelocity,this.amplitude,this.frequency,this.gain,this.lacunarity,this.numOctaves),this.$l.dHdx=l.div(l.sub(this.hr,this.hl),l.mul(this.epsilon,2)),this.$l.dHdz=l.div(l.sub(this.hu,this.hd),l.mul(this.epsilon,2)),this.$l.normal=l.normalize(l.vec3(l.neg(this.dHdx),1,l.neg(this.dHdz))),this.$return(this.normal)}),t[u](e,i,s,r,a,n,o,h)}calcWaveHeight(t,e,i,s,r,a,n,o){const h=t.$builder,l="calcWaveHeight",u=this;return h.func(l,[h.vec2("worldPos"),h.vec2("windVelocity"),h.float("amplitude"),h.float("frequency"),h.float("gain"),h.float("lacunarity"),h.int("numOctaves")],function(){this.$l.windOffset=h.mul(this.windVelocity,Qc.getElapsedTime(this)),this.$l.height=u.fbm(this,h.add(h.mul(this.worldPos,.01),this.windOffset),this.frequency,this.gain,this.lacunarity,this.numOctaves),this.height=h.add(this.height,h.mul(.3,u.fbm(this,h.add(h.mul(this.worldPos,.05),h.mul(this.windOffset,1.5)),this.frequency,this.gain,this.lacunarity,this.numOctaves))),this.height=h.add(this.height,h.mul(.1,u.fbm(this,h.add(h.mul(this.worldPos,.1),h.mul(this.windOffset,2)),this.frequency,this.gain,this.lacunarity,this.numOctaves))),this.$return(h.mul(this.height,this.amplitude))}),t[l](e,i,s,r,a,n,o)}fbm(t,e,i,s,r,a){const n=t.$builder;return n.func("FBM",[n.vec2("st"),n.float("frequency"),n.float("gain"),n.float("lacunarity"),n.int("numOctaves")],function(){this.$l.m2=n.mat2(.8,.6,-.6,.8),this.$l.p=this.st,this.$l.a=n.float(0),this.$l.b=n.float(1),this.$l.c=n.float(0),this.$for(n.int("i"),0,"webgl"===n.getDevice().type?16:this.numOctaves,function(){"webgl"===n.getDevice().type&&this.$if(n.greaterThanEqual(this.i,this.numOctaves),function(){this.$break()}),this.$l.n=n.sub(cm(this,this.p),.5),this.a=n.add(this.a,n.mul(this.n,this.b)),this.c=n.add(this.c,this.b),this.b=n.mul(this.b,this.gain),this.p=n.mul(this.m2,this.p,this.frequency)}),this.$return(n.div(this.a,this.c))}),t.FBM(e,i,s,r,a)}update(){}needUpdate(){return!1}calcClipmapTileAABB(t,e,i,s,r,a){const n=1.5*this._amplitude;a.minPoint.setXYZ(t,r-n,i),a.maxPoint.setXYZ(e,r+n,s)}calcFragmentNormal(t,e){const i=t.$builder,s=this;return i.func("calcFragmentNormal",[i.vec2("xz")],function(){this.$l.normal=s.calcWaveNormal(this,this.xz,Qc.getElapsedTime(this),this.windVelocity,this.waveAmplitude,this.waveFrequency,this.waveGain,this.waveLacunarity,this.numOctaves),this.$return(this.normal)}),t.calcFragmentNormal(e)}calcFragmentNormalAndFoam(t,e){return t.$builder.vec4(this.calcFragmentNormal(t,e),0)}setupUniforms(t,e){const i=t.$builder;t.numOctaves=i.int().uniform(e),t.windVelocity=i.vec2().uniform(e),t.waveAmplitude=i.float().uniform(e),t.waveFrequency=i.float().uniform(e),t.waveGain=i.float().uniform(e),t.waveLacunarity=i.float().uniform(e)}calcNormalAndPos(t,e,i,s){const r=t.$builder,a=this;r.func("calcPositionAndNormal",[r.vec3("inPos"),r.vec3("outPos").out(),r.vec3("outNormal").out()],function(){this.outNormal=a.calcWaveNormal(this,this.inPos.xz,Qc.getElapsedTime(this),this.windVelocity,this.waveAmplitude,this.waveFrequency,this.waveGain,this.waveLacunarity,this.numOctaves),this.$l.h=a.calcWaveHeight(this,this.inPos.xz,this.windVelocity,this.waveAmplitude,this.waveFrequency,this.waveGain,this.waveLacunarity,this.numOctaves),this.outPos=r.add(this.inPos,r.vec3(0,this.h,0))}),t.calcPositionAndNormal(e,i,s)}calcVertexPositionAndNormal(t,e,i,s){this.calcNormalAndPos(t,e,i,s)}applyWaterBindGroup(t){t.setValue("numOctaves",this._numOctaves),t.setValue("windVelocity",this._windVelocity),t.setValue("waveAmplitude",this._amplitude),t.setValue("waveFrequency",this._frequency),t.setValue("waveGain",this._gain),t.setValue("waveLacunarity",this._lacunarity)}isOk(){return!0}getHash(){return"FBMWaveGenerator"}}class x_ extends(Yc(ed,rd)){static _absorptionGrad=new ot("linear","vec3",new Float32Array([0,.082,.318,.665,1]),new Float32Array([1,1,1,.22,.87,.87,0,.47,.49,0,.275,.44,0,0,0]));static _scatterGrad=new ot("linear","vec3",new Float32Array([0,.15,.42,1]),new Float32Array([0,0,0,.08,.41,.34,.13,.4,.45,.21,.5,.6]));static _defaultScatterRampTexture=new St;static _defaultAbsorptionRampTexture=new St;static _waveUpdateState=new WeakMap;_region;_displace;_depthMulti;_refractionStrength;_scatterRampTexture;_absorptionRampTexture;_waveGenerator;_waveVersion;_clipmapInfo;_clipmapGridInfo;_ssrParams;constructor(){super(),this._region=new O(-99999,-99999,99999,99999),this._clipmapInfo=new O,this._clipmapGridInfo=new O,this._waveGenerator=new wt,this._waveVersion=-1,this._ssrParams=new O(1e3,160,.5,2),this._scatterRampTexture=new wt,this._absorptionRampTexture=new wt,this._displace=16,this._depthMulti=.1,this._refractionStrength=0,this.cullMode="none"}onDispose(){super.onDispose(),this._waveGenerator.dispose(),this._scatterRampTexture.dispose(),this._absorptionRampTexture.dispose()}get region(){return this._region}set region(t){t.equalsTo(this._region)||(this._region.set(t),this.uniformChanged())}get waveGenerator(){return this._waveGenerator.get()}set waveGenerator(t){this._waveGenerator.get()!==t&&(this._waveGenerator.set(t),this._waveVersion=-1,this.optionChanged(!0))}get scatterRampTexture(){const t=this._getScatterRampTexture(Sl());return t===x_._defaultScatterRampTexture.get()?null:t}set scatterRampTexture(t){t!==this.scatterRampTexture&&(this._scatterRampTexture.set(t),this.uniformChanged())}get absorptionRampTexture(){const t=this._getAbsorptionRampTexture(Sl());return t===x_._defaultAbsorptionRampTexture.get()?null:t}set absorptionRampTexture(t){t!==this.absorptionRampTexture&&(this._absorptionRampTexture.set(t),this.uniformChanged())}get depthMulti(){return this._depthMulti}set depthMulti(t){t!==this._depthMulti&&(this._depthMulti=t,this.uniformChanged())}get displace(){return this._displace}set displace(t){t!==this._displace&&(this._displace=t,this.uniformChanged())}get refractionStrength(){return this._refractionStrength}set refractionStrength(t){t!==this._refractionStrength&&(this._refractionStrength=t,this.uniformChanged())}needSceneColor(){return!0}needSceneDepth(){return!0}_createHash(){return`${super._createHash()}:${this.waveGenerator?.getHash()??""}`}setClipmapInfo(t,e,i,s){this._clipmapInfo.setXYZW(t,e,i,s),this.uniformChanged()}setClipmapGridInfo(t,e,i){this._clipmapGridInfo.x===t&&this._clipmapGridInfo.y===e&&this._clipmapGridInfo.z===i||(this._clipmapGridInfo.setXYZW(t,e,i,0),this.uniformChanged())}supportInstancing(){return!1}supportLighting(){return!0}vertexShader(t){super.vertexShader(t);const e=t.$builder;this.waveGenerator?.setupUniforms(t,2),t.$inputs.position=e.vec3().attrib("position"),t.$inputs.clipmapInfo=e.vec4().attrib("texCoord0"),t.clipmapGridInfo=e.vec4().uniform(2),t.$l.s=e.sin(t.$inputs.clipmapInfo.x),t.$l.c=e.cos(t.$inputs.clipmapInfo.x),t.$l.scale2=e.mul(t.$inputs.clipmapInfo.y,t.clipmapGridInfo.x),t.$l.clipmapMatrix=e.mat4(e.mul(t.c,t.scale2),e.mul(t.s,t.scale2),0,0,e.neg(e.mul(t.s,t.scale2)),e.mul(t.c,t.scale2),0,0,0,0,1,0,e.sub(e.mul(t.$inputs.clipmapInfo.z,t.clipmapGridInfo.x),t.clipmapGridInfo.y),e.sub(e.mul(t.$inputs.clipmapInfo.w,t.clipmapGridInfo.x),t.clipmapGridInfo.z),0,1),t.$l.clipmapPos=e.mul(t.clipmapMatrix,e.vec4(t.$inputs.position,1)).xy,t.clipmapWorldPos=e.mul(Qc.getWorldMatrix(t),e.vec4(t.clipmapPos.x,0,t.clipmapPos.y,1)).xyz,t.worldNormal=e.vec3(0,1,0),t.worldPos=t.clipmapWorldPos,this.waveGenerator?.calcVertexPositionAndNormal(t,t.clipmapWorldPos,t.worldPos,t.worldNormal),t.$outputs.worldPos=t.worldPos,t.$outputs.clipmapPos=t.clipmapWorldPos,t.$outputs.worldNormal=t.worldNormal,Qc.setClipSpacePosition(t,e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),Qc.resolveMotionVector(t,t.$outputs.worldPos,t.$outputs.worldPos)}fragmentShader(t){super.fragmentShader(t);const e=t.$builder;this.waveGenerator?.setupUniforms(t,2),t.region=e.vec4().uniform(2),this.needFragmentColor()&&(t.displace=e.float().uniform(2),t.depthMulti=e.float().uniform(2),t.refractionStrength=e.float().uniform(2),t.ssrParams=e.vec4().uniform(2),t.scatterRampTex=e.tex2D().uniform(2),t.absorptionRampTex=e.tex2D().uniform(2)),t.$l.discardable=e.or(e.any(e.lessThan(t.$inputs.worldPos.xz,t.region.xy)),e.any(e.greaterThan(t.$inputs.worldPos.xz,t.region.zw))),t.$if(t.discardable,function(){e.discard()}),this.needFragmentColor()?(t.$l.normal=this.waveGenerator?this.waveGenerator.calcFragmentNormalAndFoam(t,t.$inputs.clipmapPos.xz,t.$inputs.worldNormal):e.vec4(t.$inputs.worldNormal,0),t.$l.outColor=e.vec4(this.waterShading(t,t.$inputs.worldPos,t.normal.xyz,t.normal.w),1),this.drawContext.materialFlags&gu.SSR_STORE_ROUGHNESS?(t.$l.outRoughness=e.vec4(1,1,1,0),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(1),t.outRoughness,t.outColor)):this.outputFragmentColor(t,t.$inputs.worldPos,t.outColor)):this.outputFragmentColor(t,t.$inputs.worldPos,null)}waterShading(t,e,i,s){const r=t.$builder,a=this;return r.func("getAbsorption",[r.float("depth")],function(){this.$l.c=r.textureSampleLevel(this.absorptionRampTex,r.vec2(r.mul(this.depth,this.depthMulti),.5),0).rgb,this.$return(r.mul(this.c,this.c))}),r.func("getScattering",[r.float("depth")],function(){this.$l.c=r.textureSampleLevel(this.scatterRampTex,r.vec2(r.mul(this.depth,this.depthMulti),.5),0).rgb,this.$return(r.mul(this.c,this.c))}),r.func("fresnel",[r.vec3("normal"),r.vec3("eyeVec")],function(){this.$return(r.clamp(r.sub(r.pow(r.sub(1,r.dot(this.normal,this.eyeVec)),5),this.refractionStrength),0,1))}),r.func("lightSpecular",[r.vec3("lightDir"),r.vec3("eyeVecNorm"),r.vec3("normal"),r.vec3("lightColor")],function(){this.$l.roughness=r.float(.04),this.$l.f0=r.vec3(.02),this.$l.f90=r.vec3(1),this.$l.L=this.lightDir,this.$l.V=r.neg(this.eyeVecNorm),this.$l.halfVec=r.normalize(r.add(this.L,this.V)),this.$l.NoH=r.clamp(r.dot(this.normal,this.halfVec),0,1),this.$l.NoL=r.clamp(r.dot(this.normal,this.L),0,1),this.$l.specular=r.vec3(0),this.$if(r.greaterThan(this.NoL,0),function(){this.$l.VoH=r.clamp(r.dot(this.V,this.halfVec),0,1),this.$l.NoV=r.clamp(r.dot(this.normal,this.V),0,1),this.$l.F=function(t,e,i,s){const r=t.$builder,a="fresnelSchlick";return r.func(a,[r.float("VdotH"),r.vec3("F0"),r.vec3("F90")],function(){this.$return(r.add(this.F0,r.mul(r.sub(this.F90,this.F0),r.pow(r.clamp(r.sub(1,this.VdotH),0,1),5))))}),r.getGlobalScope()[a](e,i,s)}(this,this.VoH,this.f0,this.f90),this.$l.alphaRoughness=r.mul(this.roughness,this.roughness),this.$l.D=function(t,e,i){const s=t.$builder,r="distributionGGX";return s.func(r,[s.float("NdotH"),s.float("roughness")],function(){this.$l.a2=s.mul(this.roughness,this.roughness),this.$l.NdotH2=s.mul(this.NdotH,this.NdotH),this.$l.num=this.a2,this.$l.denom=s.add(s.mul(this.NdotH2,s.sub(this.a2,1)),1),this.denom=s.mul(s.mul(3.14159265,this.denom),this.denom),this.$return(s.div(this.num,this.denom))}),s.getGlobalScope()[r](e,i)}(this,this.NoH,this.alphaRoughness),this.$l.VIS=function(t,e,i,s){const r=t.$builder,a="visGGX";return r.func(a,[r.float("NdotV"),r.float("NdotL"),r.float("roughness")],function(){this.$l.a2=r.mul(this.roughness,this.roughness),this.$l.ggxV=r.mul(this.NdotL,r.sqrt(r.add(r.mul(this.NdotV,this.NdotV,r.sub(1,this.a2)),this.a2))),this.$l.ggxL=r.mul(this.NdotV,r.sqrt(r.add(r.mul(this.NdotL,this.NdotL,r.sub(1,this.a2)),this.a2))),this.$l.ggx=r.add(this.ggxV,this.ggxL),this.$if(r.greaterThan(this.ggx,0),function(){this.$return(r.div(.5,this.ggx))}).$else(function(){this.$return(r.float(0))})}),r.getGlobalScope()[a](e,i,s)}(this,this.NoV,this.NoL,this.alphaRoughness),this.specular=r.mul(this.D,this.VIS,this.F,this.lightColor)}),this.$return(this.specular)}),r.func("waterShading",[r.vec3("worldPos"),r.vec3("worldNormal"),r.float("foamFactor")],function(){this.$l.screenUV=r.div(r.vec2(this.$builtins.fragCoord.xy),Qc.getRenderSize(this)),this.$l.dist=r.length(r.sub(this.worldPos,Qc.getCameraPosition(this))),this.$l.normalScale=r.clamp(r.div(100,this.dist),0,1),this.$l.normal=r.normalize(r.mul(this.worldNormal,r.vec3(this.normalScale,1,this.normalScale))),this.$l.displacedTexCoord=r.add(this.screenUV,r.mul(this.normal.xz,this.displace)),this.$l.wPos=Qc.samplePositionFromDepth(this,Qc.getLinearDepthTexture(this),this.screenUV,Qc.getInvViewProjectionMatrix(this),Qc.getCameraParams(this).xy),this.$l.eyeVec=r.sub(this.worldPos.xyz,Qc.getCameraPosition(this)),this.$l.eyeVecNorm=r.normalize(this.eyeVec),this.$l.depth=r.length(r.sub(this.wPos.xyz,this.worldPos)),this.$l.viewPos=r.mul(Qc.getViewMatrix(this),r.vec4(this.worldPos,1)).xyz,this.incidentVec=r.normalize(r.sub(this.worldPos,Qc.getCameraPosition(this))),this.reflectVecW=r.reflect(this.incidentVec,this.normal),this.$l.reflectance=r.vec3(),this.$l.hitInfo=r.vec4(0),this.$if(r.greaterThan(this.reflectVecW.y,0),function(){this.reflectVec=r.mul(Qc.getViewMatrix(this),r.vec4(this.reflectVecW,0)).xyz,this.hitInfo=Qc.getHiZDepthTexture(this)?sf(this,this.viewPos,this.reflectVec,Qc.getViewMatrix(this),Qc.getProjectionMatrix(this),Qc.getInvProjectionMatrix(this),Qc.getCameraParams(this).xy,r.int(Qc.getHiZDepthTextureMipLevelCount(this)),this.ssrParams.y,this.ssrParams.z,r.vec4(Qc.getRenderSize(this),Qc.getHiZDepthTextureSize(this)),Qc.getHiZDepthTexture(this)):ef(this,this.viewPos,this.reflectVec,Qc.getViewMatrix(this),Qc.getProjectionMatrix(this),Qc.getInvProjectionMatrix(this),Qc.getCameraParams(this).xy,this.ssrParams.x,this.ssrParams.y,this.ssrParams.z,this.ssrParams.w,r.vec4(Qc.getRenderSize(this),Qc.getLinearDepthTextureSize(this)),Qc.getLinearDepthTexture(this))}),this.$l.refl=r.reflect(r.normalize(r.sub(this.worldPos,Qc.getCameraPosition(this))),this.normal),this.refl.y=r.max(this.refl.y,.1),this.reflectance=r.mix(r.textureSampleLevel(Qc.getBakedSkyTexture(this),this.refl,0).rgb,r.textureSampleLevel(Qc.getSceneColorTexture(this),this.hitInfo.xy,0).rgb,this.hitInfo.w),this.$l.refractUV=this.displacedTexCoord,this.$l.displacedPos=Qc.samplePositionFromDepth(this,Qc.getLinearDepthTexture(this),this.refractUV,Qc.getInvProjectionMatrix(this),Qc.getCameraParams(this).xy),this.$if(r.or(r.greaterThanEqual(this.displacedPos.w,.99999),r.greaterThan(this.displacedPos.z,this.viewPos.z)),function(){this.refractUV=this.screenUV}).$else(function(){this.depth=r.length(r.sub(this.displacedPos.xyz,this.viewPos))}),this.$l.refraction=r.textureSampleLevel(Qc.getSceneColorTexture(this),this.refractUV,0).rgb,this.refraction=r.mul(this.refraction,this.getAbsorption(this.depth)),this.$l.fresnelTerm=this.fresnel(this.normal,r.neg(this.eyeVecNorm)),this.$l.finalColor=r.mix(r.mix(this.refraction,this.reflectance,this.fresnelTerm),r.vec3(1),this.foamFactor),a.forEachLight(this,function(t,e,i,s,n){this.$l.lightAtten=a.calculateLightAttenuation(this,t,this.worldPos,e,i),this.$l.lightDir=a.calculateLightDirection(this,t,this.worldPos,e,i),this.$l.NoL=r.clamp(r.dot(this.normal,this.lightDir),0,1),this.$l.lightContrib=this.lightSpecular(this.lightDir,this.eyeVecNorm,this.normal,r.mul(s.rgb,s.a,this.lightAtten)),n&&(this.$l.shadow=r.vec3(a.calculateShadow(this,this.worldPos,this.NoL)),this.lightContrib=r.mul(this.lightContrib,this.shadow)),this.finalColor=r.add(this.finalColor,this.lightContrib)}),a.needCalculateEnvLight()&&(this.$l.irradiance=a.getEnvLightIrradiance(this,this.normal),this.$l.sss=r.mul(this.getScattering(this.depth),this.irradiance,1/Math.PI),this.finalColor=r.add(this.finalColor,this.sss)),this.$return(this.finalColor)}),t.waterShading(e,i,s)}applyUniforms(t,e,i,s){super.applyUniforms(t,e,i,s);const r=this._waveGenerator.get();r&&this._waveVersion!==r.version&&(r.applyWaterBindGroup(t),this._waveVersion=r.version)}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i),t.setValue("clipmapGridInfo",this._clipmapGridInfo),t.setValue("region",this._region),this.needFragmentColor(e)&&(t.setValue("displace",this._displace/e.renderWidth),t.setValue("depthMulti",this._depthMulti),t.setValue("refractionStrength",this._refractionStrength),t.setValue("ssrParams",this._ssrParams),t.setTexture("scatterRampTex",this._getScatterRampTexture(e.device),Gl("clamp_linear_nomip")),t.setTexture("absorptionRampTex",this._getAbsorptionRampTexture(e.device),Gl("clamp_linear_nomip"))),this.waveGenerator&&this.waveGenerator.applyWaterBindGroup(t)}needUpdate(){return!!this._waveGenerator.get()?.needUpdate()}update(t,e){const i=this._waveGenerator.get();if(i){x_._waveUpdateState.get(i)!==t&&(i.update(e),x_._waveUpdateState.set(i,t))}}_getRampTexture(t,e){const i=128,s=t.createTexture2D("rgba8unorm",i,1,{mipmapping:!1}),r=new Uint8Array(512),a=new z;for(let t=0;t<128;t++)e.interpolate(t%i/i,a),r[4*t+0]=255*a.x|0,r[4*t+1]=255*a.y|0,r[4*t+2]=255*a.z|0,r[4*t+3]=255;return s.update(r,0,0,i,1),s}_getScatterRampTexture(t){return this._scatterRampTexture.get()||(x_._defaultScatterRampTexture.get()||x_._defaultScatterRampTexture.set(this._getRampTexture(t,x_._scatterGrad)),this._scatterRampTexture.set(x_._defaultScatterRampTexture.get())),this._scatterRampTexture.get()}_getAbsorptionRampTexture(t){return this._absorptionRampTexture.get()||(x_._defaultAbsorptionRampTexture.get()||x_._defaultAbsorptionRampTexture.set(this._getRampTexture(t,x_._absorptionGrad)),this._absorptionRampTexture.set(x_._defaultAbsorptionRampTexture.get())),this._absorptionRampTexture.get()}}class b_ extends(a(Nf,f_)){_pickTarget;_clipmap;_renderData;_gridScale;_animationSpeed;_timeStart;_feedbackProgram;_feedbackBindGroup;_feedbackPrimitive;_feedbackRenderTarget;_feedbackRenderStates;_material;constructor(t){super(t),this._pickTarget={node:this},this._clipmap=new Mf(32,[]),this._renderData=null,this._gridScale=1,this._animationSpeed=1,this._timeStart=0,this._material=new wt(new x_),this._material.get().region=new O(-1,-1,1,1),this._material.get().TAAStrength=.4,this.waveGenerator=new g_,this._feedbackProgram=new wt,this._feedbackBindGroup=new wt,this._feedbackPrimitive=new wt,this._feedbackRenderTarget=new wt,this._feedbackRenderStates=null,t.queuePerCameraUpdateNode(this)}onDispose(){super.onDispose(),this._clipmap.dispose(),this._clipmap=null,this._renderData=null,this._feedbackBindGroup.dispose(),this._feedbackPrimitive.dispose(),this._feedbackProgram.dispose(),this._feedbackRenderStates=null,this._feedbackRenderTarget.get()&&(this._feedbackRenderTarget.get().getColorAttachment(0).dispose(),this._feedbackRenderTarget.get().getColorAttachment(1).dispose(),this._feedbackRenderTarget.dispose()),this._material.dispose()}get wireframe(){return this._clipmap.wireframe}set wireframe(t){this._clipmap.wireframe=!!t}get material(){return this._material.get()}get waveGenerator(){return this.material.waveGenerator}set waveGenerator(t){this.material.waveGenerator=t,this.material.needUpdate()&&this.scene.queueUpdateNode(this)}get animationSpeed(){return this._animationSpeed}set animationSpeed(t){this._animationSpeed=t}get TAAStrength(){return this.material.TAAStrength}set TAAStrength(t){this.material.TAAStrength=t}update(t,e){this.material.needUpdate()&&(this.scene.queueUpdateNode(this),0===this._timeStart&&(this._timeStart=e),this.material.update(t,(e-this._timeStart)*this._animationSpeed),this.invalidateWorldBoundingVolume(!1))}updatePerCamera(t,e,i){const s=this._material.get(),r=this;this._renderData=this._clipmap.gather({camera:t,minMaxWorldPos:s.region,gridScale:Math.max(.01,this._gridScale),userData:this,frustumCulling:!0,calcAABB(t,e,i,s,a,n){const o=r.worldMatrix.transformPointAffine(z.zero());r.waveGenerator?r.waveGenerator.calcClipmapTileAABB(e,i,s,a,o.y,n):(n.minPoint.setXYZ(e,o.y,s),n.maxPoint.setXYZ(i,o.y+1,a))}}),this.scene.queuePerCameraUpdateNode(this)}getPickTarget(){return this._pickTarget}getMorphData(){return null}getMorphInfo(){return null}getQueueType(){return this._material.get()?.getQueueType()??1}isUnlit(){return!this._material.get()?.supportLighting()}needSceneColor(){return this._material.get()?.needSceneColor()}needSceneDepth(){return this._material.get()?.needSceneDepth()}getMaterial(){return this._material.get()}getPrimitive(){return null}isWater(){return!0}computeBoundingVolume(){return null}computeWorldBoundingVolume(){const t=this.worldMatrix.transformPointAffine(z.zero()),e=this._material?.get();if(e){const i=new hu;return e.waveGenerator?e.waveGenerator.calcClipmapTileAABB(e.region.x,e.region.z,e.region.y,e.region.w,t.y,i):(i.minPoint.setXYZ(e.region.x,t.y,e.region.y),i.maxPoint.setXYZ(e.region.z,t.y+1,e.region.w)),i}return null}get gridScale(){return this._gridScale}set gridScale(t){this._gridScale=t}calculateLocalTransform(t){t.translation(this._position)}calculateWorldTransform(t){t.set(this.localMatrix),this.parent&&(t.m03+=this.parent.worldMatrix.m03,t.m13+=this.parent.worldMatrix.m13,t.m23+=this.parent.worldMatrix.m23)}_onTransformChanged(t){super._onTransformChanged(t);const e=this._material?.get();if(e){const t=Math.abs(this.scale.x),i=Math.abs(this.scale.z),s=this.position.x,r=this.position.z;e.region=new O(s-t,r-i,s+t,r+i)}}draw(t){const e=this._material?.get();this.bind(t),e.setClipmapGridInfo(this._gridScale,this.worldMatrix.m03,this.worldMatrix.m23),e.apply(t);for(const i of this._renderData)e.draw(i.primitive,t,i.numInstances)}async getSurfacePoint(t,e,i){const s=Sl();t&&0!==t.length&&(t=t.map(t=>t.clone()),await s.runNextFrameAsync(async()=>{this._feedbackProgram.get()||(this._feedbackProgram.set(this._createFeedbackProgram(s)),this._feedbackBindGroup.set(s.createBindGroup(this._feedbackProgram.get().bindGroupLayouts[0]))),this._feedbackPrimitive.get()||(this._feedbackPrimitive.set(new Cl),this._feedbackPrimitive.get().primitiveType="point-list"),this._feedbackRenderStates||(this._feedbackRenderStates=s.createRenderStateSet(),this._feedbackRenderStates.useDepthState().enableTest(!1).enableWrite(!1),this._feedbackRenderStates.useRasterizerState().setCullMode("none"));const r=this._feedbackPrimitive.get(),a=new Float32Array(4*t.length);for(let e=0;e<t.length;e++)a[4*e+0]=t[e].x,a[4*e+1]=t[e].y,a[4*e+2]=t[e].z,a[4*e+3]=e;let n=r.getVertexBuffer("position");n&&n.byteLength===a.byteLength?n.bufferSubData(0,a):(n=s.createVertexBuffer("position_f32x4",a,{dynamic:!0}),r.setVertexBuffer(n));const o=this._feedbackRenderTarget.get();if(!o||o.getColorAttachment(0).width<t.length){const e=s.createTexture2D("rgba32f",t.length,1,{mipmapping:!1}),i=s.createTexture2D("rgba32f",t.length,1,{mipmapping:!1});o&&(o.getColorAttachment(0).dispose(),o.getColorAttachment(1).dispose(),this._feedbackRenderTarget.dispose()),this._feedbackRenderTarget.set(s.createFrameBuffer([e,i],null))}r.indexCount=t.length;const h=this._feedbackBindGroup.get();h.setValue("textureWidth",this._feedbackRenderTarget.get().getWidth()),this.waveGenerator.applyWaterBindGroup(h),s.pushDeviceStates(),s.setProgram(this._feedbackProgram.get()),s.setBindGroup(0,this._feedbackBindGroup.get()),s.setFramebuffer(this._feedbackRenderTarget.get()),this._feedbackPrimitive.get().draw(),s.popDeviceStates();const l=new Float32Array(4*t.length),u=new Float32Array(4*t.length);await Promise.all([this._feedbackRenderTarget.get().getColorAttachment(0).readPixels(0,0,t.length,1,0,0,l),this._feedbackRenderTarget.get().getColorAttachment(1).readPixels(0,0,t.length,1,0,0,u)]);for(let s=0;s<t.length;s++)e&&e[s].setXYZ(l[4*s+0],l[4*s+1],l[4*s+2]),i&&i[s].setXYZ(u[4*s+0],u[4*s+1],u[4*s+2])}))}_createFeedbackProgram(t){const e=this,i=t.buildRenderProgram({vertex(t){this.$inputs.position=t.vec4().attrib("position"),this.textureWidth=t.float().uniform(0),e.waveGenerator.setupUniforms(this,0),t.main(function(){this.$l.worldPos=t.vec3(),this.$l.worldNorm=t.vec3(),e.waveGenerator.calcVertexPositionAndNormal(this,this.$inputs.position.xyz,this.worldPos,this.worldNorm),this.$outputs.worldPos=this.worldPos,this.$outputs.worldNorm=this.worldNorm,this.$outputs.xz=this.$inputs.position.xz,this.$l.ndcX=t.sub(t.mul(t.div(t.add(this.$inputs.position.w,.5),this.textureWidth),2),1),"webgpu"!==t.getDevice().type&&(this.$builtins.pointSize=1),this.$l.$builtins.position=t.vec4(this.ndcX,0,0,1)})},fragment(t){this.$outputs.worldPos=t.vec4(),this.$outputs.worldNorm=t.vec4(),e.waveGenerator.setupUniforms(this,0),t.main(function(){this.$outputs.worldPos=t.vec4(this.$inputs.worldPos,1),this.$outputs.worldNorm=t.vec4(e.waveGenerator.calcFragmentNormal(this,this.$inputs.xz,this.$inputs.worldNorm),1)})}});return i.name="@Water_Feedback",i}}const v_=new z,y_=256;class T_ extends(a(Nf,f_)){static updateFuncMap=new WeakMap;_activeParticleList;_maxParticleCount;_emitInterval;_emitCount;_startTick;_startEmitTime;_numEmitCount;_delay;_airResistence;_flags;_gravity;_wind;_scalar;_particleRotationMin;_particleRotationMax;_jitterSpeed;_emitterShape;_emitterBehavior;_emitterConeRadiusMin;_emitterConeRadiusMax;_particleVelocityMin;_particleVelocityMax;_particleLifeMin;_particleLifeMax;_particleSize1Min;_particleSize1Max;_particleSize2Min;_particleSize2Max;_particleAccelMin;_particleAccelMax;_emitterShapeSizeMin;_emitterShapeSizeMax;_primitive;_material;_wsBoundingBox;_pickTarget;_instanceData;constructor(t){super(t),this._activeParticleList=[],this._maxParticleCount=100,this._emitInterval=100,this._emitCount=1,this._gravity=z.zero(),this._wind=z.zero(),this._startEmitTime=0,this._numEmitCount=0,this._scalar=1,this._airResistence=!1,this._startTick=0,this._delay=0,this._particleRotationMin=0,this._particleRotationMax=0,this._jitterSpeed=1,this._emitterShape="point",this._emitterBehavior="surface",this._emitterConeRadiusMin=0,this._emitterConeRadiusMax=.1,this._emitterShapeSizeMin=z.one(),this._emitterShapeSizeMax=z.one(),this._particleVelocityMin=2,this._particleVelocityMax=3,this._particleLifeMin=1,this._particleLifeMax=1.5,this._particleSize1Min=.4,this._particleSize1Max=.5,this._particleSize2Min=0,this._particleSize2Max=.1,this._particleAccelMin=-.01,this._particleAccelMax=-.02,this._pickTarget={node:this},this._flags=y_,this._primitive=new wt,this._wsBoundingBox=new hu,this._instanceData=null,this._material=new wt(new ud),t.queueUpdateNode(this)}get material(){return this._material.get()}set material(t){this._material.set(t)}get maxParticleCount(){return this._maxParticleCount}set maxParticleCount(t){t!==this._maxParticleCount&&(this._maxParticleCount=t,this.invalidateBoundingVolume())}get emitInterval(){return this._emitInterval}set emitInterval(t){t!==this._emitInterval&&(this._emitInterval=Math.max(t,1),this._startEmitTime=0)}get emitCount(){return this._emitCount}set emitCount(t){this._emitCount=t}get gravity(){return this._gravity}set gravity(t){t.equalsTo(this._gravity)||(this._gravity.set(t),this.invalidateBoundingVolume())}get wind(){return this._wind}set wind(t){t.equalsTo(this._wind)||(this._wind.set(t),this.invalidateBoundingVolume())}get scalar(){return this._scalar}set scalar(t){t!==this._scalar&&(this._scalar=t,this.invalidateBoundingVolume())}get aspect(){return this._material.get().aspect}set aspect(t){this._material.get().aspect=t}get airResistence(){return this._airResistence}set airResistence(t){this._airResistence=t}get particleRotationMin(){return this._particleRotationMin}set particleRotationMin(t){this._particleRotationMin=t}get particleRotationMax(){return this._particleRotationMax}set particleRotationMax(t){this._particleRotationMax=t}get jitterSpeed(){return this._jitterSpeed}set jitterSpeed(t){this._jitterSpeed=t}get jitterPower(){return this._material.get().jitterPower}set jitterPower(t){this._material.get().jitterPower=t}get emitterShape(){return this._emitterShape}set emitterShape(t){this._emitterShape=t}get emitterBehavior(){return this._emitterBehavior}set emitterBehavior(t){this._emitterBehavior=t}get emitterConeRadiusMin(){return this._emitterConeRadiusMin}set emitterConeRadiusMin(t){this._emitterConeRadiusMin=t}get emitterConeRadiusMax(){return this._emitterConeRadiusMax}set emitterConeRadiusMax(t){this._emitterConeRadiusMax=t}get particleVelocityMin(){return this._particleVelocityMin}set particleVelocityMin(t){this._particleVelocityMin=t}get particleVelocityMax(){return this._particleVelocityMax}set particleVelocityMax(t){this._particleVelocityMax=t}get particleLifeMin(){return this._particleLifeMin}set particleLifeMin(t){this._particleLifeMin=t}get particleLifeMax(){return this._particleLifeMax}set particleLifeMax(t){this._particleLifeMax=t}get particleSize1Min(){return this._particleSize1Min}set particleSize1Min(t){this._particleSize1Min=t}get particleSize1Max(){return this._particleSize1Max}set particleSize1Max(t){this._particleSize1Max=t}get particleSize2Min(){return this._particleSize2Min}set particleSize2Min(t){this._particleSize2Min=t}get particleSize2Max(){return this._particleSize2Max}set particleSize2Max(t){this._particleSize2Max=t}get particleAccelMin(){return this._particleAccelMin}set particleAccelMin(t){this._particleAccelMin=t}get particleAccelMax(){return this._particleAccelMax}set particleAccelMax(t){this._particleAccelMax=t}get emitterShapeSizeMin(){return this._emitterShapeSizeMin}set emitterShapeSizeMin(t){this._emitterShapeSizeMin.set(t)}get emitterShapeSizeMax(){return this._emitterShapeSizeMax}set emitterShapeSizeMax(t){this._emitterShapeSizeMax.set(t)}get directional(){return this._material.get().directional}set directional(t){this._material.get().directional=t}get worldSpace(){return!!(this.flags&y_)}set worldSpace(t){t?this.flags|=y_:this.flags&=-257}get flags(){return this._flags}set flags(t){this._flags=t}computeBoundingVolume(){return this._wsBoundingBox}initParticle(t){return t=t??{position:new z,velocity:new z},this.getParticleInitialPosition(t.position,t.velocity),t.size1=this._particleSize1Min+Math.random()*(this._particleSize1Max-this._particleSize1Min),t.size2=this._particleSize2Min+Math.random()*(this._particleSize2Max-this._particleSize2Min),t.rotation=this._particleRotationMin+Math.random()*(this._particleRotationMax-this._particleRotationMin),t.lifeSpan=Math.max(this._particleLifeMin+Math.random()*(this._particleLifeMax-this._particleLifeMin),.01),t.acceleartion=this._particleAccelMin+Math.random()*(this._particleAccelMax-this._particleAccelMin),t}getParticleInitialPosition(t,e){if("point"===this._emitterShape){t.setXYZ(0,0,0);const i=this._emitterConeRadiusMin+Math.random()*(this._emitterConeRadiusMax-this._emitterConeRadiusMin);e.x=-i+2*Math.random()*i,e.y=1,e.z=-i+2*Math.random()*i}else{const i=Math.max(this._emitterShapeSizeMin.x+(this._emitterShapeSizeMax.x-this._emitterShapeSizeMin.x)*Math.random(),.01),s=Math.max(this._emitterShapeSizeMin.y+(this._emitterShapeSizeMax.y-this._emitterShapeSizeMin.y)*Math.random(),.01),r=Math.max(this._emitterShapeSizeMin.z+(this._emitterShapeSizeMax.z-this._emitterShapeSizeMin.z)*Math.random(),.01);switch(this._emitterShape){case"sphere":{const a=Math.PI*Math.random(),n=2*Math.PI*Math.random(),o=Math.sin(a),h=Math.cos(a),l=Math.sin(n)*o,u=Math.cos(n)*o;if(t.x=l*i,t.y=h*s,t.z=u*r,e.x=t.x,e.y=t.y,e.z=t.z,"volume"===this._emitterBehavior){const e=Math.random();t.x*=e,t.y*=e,t.z*=e}break}case"box":{let a=2*Math.random()-1,n=2*Math.random()-1,o=2*Math.random()-1;if("volume"===this._emitterBehavior){const t=Math.max(Math.abs(a),Math.abs(n),Math.abs(o));0!==t&&(a/=t,n/=t,o/=t)}t.x=a*i,t.y=n*s,t.z=o*r;const h=this._emitterConeRadiusMin+(this._emitterConeRadiusMax-this._emitterConeRadiusMin)*Math.random();e.x=-h+2*Math.random()*h,e.y=1,e.z=-h+2*Math.random()*h;break}case"cylinder":{const a=Math.random()*Math.PI*2;let n=Math.sin(a),o=Math.cos(a);const h=2*Math.random()-1,l=this._emitterConeRadiusMin+(this._emitterConeRadiusMax-this._emitterConeRadiusMin)*Math.random();if(e.x=n*i,e.y=(-l+2*Math.random()*l)*s,e.z=o*r,"volume"===this._emitterBehavior){const t=Math.random();n*=t,o*=t}t.x=n*i,t.y=h*s,t.z=o*r;break}case"cone":{const a=Math.random()*Math.PI*2,n=Math.random(),o=Math.sin(a),h=Math.cos(a);t.x=o*n*i,t.y=(2-2*n)*s,t.z=h*n*r;const l=s*s/Math.hypot(s*s+i+i);e.x=o*i*l,e.y=-l*s,e.z=h*i*l;break}}}e.inplaceNormalize(),e.scaleBy(this._particleVelocityMin+Math.random()*(this._particleVelocityMax-this._particleVelocityMin))}resizeVertexBuffers(){this._primitive.get()||(this._primitive.set(new Cl),this._primitive.get().createAndSetVertexBuffer("position_f32x4",new Float32Array([0,0,0,0,0,0,0,1,0,0,0,2,0,0,0,3])),this._primitive.get().createAndSetIndexBuffer(new Uint16Array([0,1,2,3])),this._primitive.get().primitiveType="triangle-strip"),(!this._instanceData||this._instanceData.length<10*this._maxParticleCount)&&(this._primitive.get().removeVertexBuffer("texCoord0"),this._instanceData=new Float32Array(10*M(this._maxParticleCount)),this._primitive.get().createAndSetVertexBuffer(["tex0_f32x3","tex1_f32x4","tex2_f32x3"],this._instanceData,"instance"))}update(t,e,i){if(!this.attached)return;this.scene.queueUpdateNode(this);const s=this._animationSet.get();s&&s.numAnimations>0&&s.update(i);const r=e;if(0===this._startTick&&(this._startTick=r),this._delay>0&&r-this._startTick<this._delay)return;this.invalidateBoundingVolume();const a=i;for(let t=this._activeParticleList.length-1;t>=0;t--){const e=this._activeParticleList[t],i=e.particle;e.elapsedTime+=a;const s=e.elapsedTime/i.lifeSpan;if(s>=1)this._activeParticleList.splice(t,1);else{i.velocity.x+=this._gravity.x*a,i.velocity.y+=this._gravity.y*a,i.velocity.z+=this._gravity.z*a,this._airResistence&&(i.velocity.x+=(this._wind.x-i.velocity.x)*a,i.velocity.y+=(this._wind.y-i.velocity.y)*a,i.velocity.z+=(this._wind.z-i.velocity.z)*a);const t=i.velocity.length;if(t>1e-4){const e=1+a*i.acceleartion/t;i.velocity.scaleBy(e<0?0:e)}i.position.x+=i.velocity.x*a*this._scalar,i.position.y+=i.velocity.y*a*this._scalar,i.position.z+=i.velocity.z*a*this._scalar,e.jitterAngle=(e.elapsedTime+i.lifeSpan*e.ageBias)*this._jitterSpeed,e.size=Math.max(i.size1+i.size2*s,0),e.rotation+=i.rotation*a}}let n=0;if(0===this._startEmitTime)n=this._emitCount>this._maxParticleCount?this._maxParticleCount:this._emitCount,this._numEmitCount=1,this._startEmitTime=r;else{const t=1+(1e3*(r-this._startEmitTime)/this._emitInterval|0);t>this._numEmitCount&&(n=this._emitCount,this._numEmitCount=t,this._activeParticleList.length+n>this._maxParticleCount&&(n=this._maxParticleCount-this._activeParticleList.length))}n>0&&this.newParticle(n,this.worldMatrix),this.resizeVertexBuffers(),this._wsBoundingBox.beginExtend();let o=0;const h=!!(this._flags&y_),l=this.invWorldMatrix;for(const t of this._activeParticleList)h?(l.transformPointAffine(t.particle.position,v_),this._instanceData[o++]=v_.x,this._instanceData[o++]=v_.y,this._instanceData[o++]=v_.z,this._wsBoundingBox.extend(v_)):(this._instanceData[o++]=t.particle.position.x,this._instanceData[o++]=t.particle.position.y,this._instanceData[o++]=t.particle.position.z,this._wsBoundingBox.extend(t.particle.position)),this._instanceData[o++]=t.size,this._instanceData[o++]=t.rotation,this._instanceData[o++]=t.jitterAngle,this._instanceData[o++]=t.elapsedTime/t.particle.lifeSpan,h?(l.transformVectorAffine(t.particle.velocity,v_),this._instanceData[o++]=v_.x,this._instanceData[o++]=v_.y,this._instanceData[o++]=v_.z):(this._instanceData[o++]=t.particle.velocity.x,this._instanceData[o++]=t.particle.velocity.y,this._instanceData[o++]=t.particle.velocity.z);let u=Math.max(Math.abs(this.particleSize1Min),Math.abs(this.particleSize1Max),Math.abs(this.particleSize2Min),Math.abs(this.particleSize2Max));l.decompose(v_,null,null);u*=Math.max(Math.abs(v_.x),Math.abs(v_.y),Math.abs(v_.z)),0!==this._jitterSpeed&&0!==this.jitterPower&&(u+=2*Math.abs(this.jitterPower)),this._wsBoundingBox.minPoint.x-=u,this._wsBoundingBox.minPoint.y-=u,this._wsBoundingBox.minPoint.z-=u,this._wsBoundingBox.maxPoint.x+=u,this._wsBoundingBox.maxPoint.y+=u,this._wsBoundingBox.maxPoint.z+=u,this._primitive.get().getVertexBuffer("texCoord0").bufferSubData(0,this._instanceData)}newParticle(t,e){for(let i=0;i<t;i++){const t=this.initParticle();t.size1*=this._scalar,t.size2*=this._scalar,t.size2-=t.size1;const i={particle:t,elapsedTime:0,rotation:0,size:t.size1,ageBias:Math.random(),jitterAngle:0};this._flags&y_&&(e.transformPointAffine(t.position,t.position),e.transformVectorAffine(t.velocity,t.velocity)),this._activeParticleList.push(i)}}getPickTarget(){return this._pickTarget}getMorphData(){return null}getMorphInfo(){return null}getQueueType(){return this._material.get()?.getQueueType()??1}isUnlit(){return!this._material.get()?.supportLighting()}needSceneColor(){return this._material.get()?.needSceneColor()}needSceneDepth(){return this._material.get()?.needSceneDepth()}getMaterial(){return this._material.get()}getPrimitive(){return this._primitive.get()}isParticleSystem(){return!0}draw(t){this._activeParticleList.length>0&&(this.bind(t),this._material.get().draw(this._primitive.get(),t,this._activeParticleList.length))}onDispose(){super.onDispose(),this._primitive.dispose(),this._material.dispose();const t=T_.updateFuncMap.get(this);t&&this._scene.off("update",t)}}const w_=new W;class S_ extends Nf{_renderQueueMap;_bindGroupAllocator;_changeTag;_staticBV;constructor(t){super(t),this._renderQueueMap=new Map,this._changeTag=0,this._bindGroupAllocator=new Pm,this._staticBV=!1;const e=function(){this._staticBV||this.invalidateBoundingVolume()}.bind(this);this.on("visiblechanged",t=>{t.iterate(t=>!!t.isMesh()&&(this._changeTag++,!0))}),this.on("nodeattached",t=>{t.iterate(t=>{t.isMesh()&&(t.placeToOctree=!1,this._staticBV||this.invalidateBoundingVolume(),t.on("bvchanged",e),this._changeTag++)})}),this.on("noderemoved",t=>{t.iterate(t=>{t.isMesh()&&(t.placeToOctree=!0,this._staticBV||this.invalidateBoundingVolume(),t.off("bvchanged",e),this._changeTag++)})})}getName(){return this._name}isBatchGroup(){return!0}invalidate(){this._changeTag++}_onDetached(){super._onDetached(),this._renderQueueMap.forEach(t=>{t.queue.reset()}),this.invalidate()}_onAttached(){this.invalidate()}computeBoundingVolume(){const t=new hu,e=W.invertAffine(this.worldMatrix);return t.beginExtend(),this.iterate(i=>{if(i.isMesh()){W.multiplyAffine(e,i.worldMatrix,w_);const s=i.getBoundingVolume().transform(w_).toAABB();t.extend(s.minPoint),t.extend(s.maxPoint)}}),t.isValid()?t:null}setBoundingVolume(t){this._staticBV=!!t,super.setBoundingVolume(t)}cull(t){let e=this._renderQueueMap.get(t.renderPass);if(e||(e={queue:new Rm(t.renderPass,this._bindGroupAllocator),tag:-1},this._renderQueueMap.set(t.renderPass,e)),e.tag!==this._changeTag){e.tag=this._changeTag,e.queue.reset();const i=t.frustumCulling,s=t.renderQueue;t.frustumCulling=!1,t.renderQueue=e.queue,this.iterate(e=>{e.isMesh()&&t.visit(e)}),e.queue.end(t.camera,!0),t.frustumCulling=i,t.renderQueue=s}t.pushRenderQueue(e.queue)}}class A_ extends gt{_terrain;constructor(t){super(),this._terrain=t}getNode(){return this._terrain}}class C_ extends(a(A_,f_)){_geometry;_quadtree;_mipLevel;_offsetX;_offsetZ;_step;_boundingBox;_lodDistance;_maxError;_parent;_offsetScale;constructor(t){super(t),this._geometry=null,this._mipLevel=0,this._offsetX=0,this._offsetZ=0,this._boundingBox=null,this._parent=null,this._offsetScale=null,this._quadtree=null,this._step=0,this._lodDistance=0}initialize(t,e,i,s,r,a,n,o){const h=t.getPatchSize(),l=t.getRootSize();this._mipLevel=e?e.getMipLevel()+1:0;const u=Math.floor((l-1)/(h-1))>>this._mipLevel,c=(h-1)*u,d=e?e.getOffsetX():0,p=e?e.getOffsetZ():0;if(this._offsetX=d+i*c,this._offsetZ=p+s*c,(this._offsetX+c>=t.getRootSizeX()||this._offsetZ+c>=t.getRootSizeZ())&&(r=null),this._quadtree=t,this._step=u,this._parent=e,this._geometry=r?new Cl:null,this._maxError=r?this.computeMaxError():0,r){const t=this._quadtree.getScaleX(),e=this._quadtree.getScaleZ();1===u&&(this._boundingBox=new hu,this._boundingBox.minPoint.x=this._offsetX*t,this._boundingBox.minPoint.y=Number.MAX_VALUE,this._boundingBox.minPoint.z=this._offsetZ*e,this._boundingBox.maxPoint.x=this._offsetX*t+(this._quadtree.getPatchSize()-1)*this._step*t,this._boundingBox.maxPoint.y=-Number.MAX_VALUE,this._boundingBox.maxPoint.z=this._offsetZ*e+(this._quadtree.getPatchSize()-1)*this._step*e),this.setupVertices(this.computeSkirtLength(),r,a,n,o),this._offsetScale=new O(this._step*t,this._offsetX*t,this._step*e,this._offsetZ*e)}return!0}getPickTarget(){return{node:this._terrain}}getMaterial(){return this._terrain.material}getPrimitive(){return this._geometry}draw(t){this.bind(t),this._terrain.material.draw(this._geometry,t)}setupCamera(t,e,i){this._lodDistance=i>0&&e>0?this.computeLodDistance(t,e,i):-1}getName(){return"TerrainPatch"}getBoneMatrices(){return null}getMorphData(){return null}getMorphInfo(){return null}getSortDistance(t){return this._quadtree.getTerrain().getSortDistance(t)}getQueueType(){return 1}isUnlit(){return!1}needSceneColor(){return!1}needSceneDepth(){return!1}isBatchable(){return!1}setupVertices(t,e,i,s,r){const a=this,n=this._quadtree.getScaleX()*this._step,o=this._quadtree.getScaleZ()*this._step,h=this._quadtree.getScaleX()*this._offsetX,l=this._quadtree.getScaleZ()*this._offsetZ;function u(t,u,c,d,p,m,f){const _=d+p*m,g=r[_]*s;return u[3*c+0]=i[_].x,u[3*c+1]=i[_].y,u[3*c+2]=i[_].z,t[3*c+0]=e[3*c+0]*n+h,t[3*c+1]=g+f,t[3*c+2]=e[3*c+2]*o+l,a._boundingBox&&(a._boundingBox.maxPoint.y<g&&(a._boundingBox.maxPoint.y=g),a._boundingBox.minPoint.y>g&&(a._boundingBox.minPoint.y=g)),c+1}const c=this._quadtree.getPatchSize(),d=(c+2)*(c+2),p=new Float32Array(3*d),m=new Float32Array(3*d);let f=this._offsetX,_=this._offsetZ,g=0;const x=this._quadtree.getHeightField().getSizeX();g=u(p,m,g,f,_,x,-t);for(let e=0;e<c;e++,f+=this._step)g=u(p,m,g,f,_,x,-t);g=u(p,m,g,f-this._step,_,x,-t),_=this._offsetZ;for(let e=0;e<c;e++,_+=this._step){f=this._offsetX,g=u(p,m,g,f,_,x,-t);for(let t=0;t<c;t++,f+=this._step)g=u(p,m,g,f,_,x,0);g=u(p,m,g,f-this._step,_,x,-t)}f=this._offsetX,_-=this._step,g=u(p,m,g,f,_,x,-t);for(let e=0;e<c;e++,f+=this._step)g=u(p,m,g,f,_,x,-t);g=u(p,m,g,f-this._step,_,x,-t),this._geometry.createAndSetVertexBuffer("position_f32x3",p),this._geometry.createAndSetVertexBuffer("normal_f32x3",m),this._geometry.setIndexBuffer(this._quadtree.getIndices()),this._geometry.indexStart=0,this._geometry.indexCount=this._quadtree.getIndices().length,this._geometry.primitiveType="triangle-strip"}getOffsetScale(){if(!this._offsetScale){const t=this._quadtree.getScaleX(),e=this._quadtree.getScaleZ();this._offsetScale=new O(this._step*t,this._offsetX*t,this._step*e,this._offsetZ*e)}return this._offsetScale}getBoundingBox(){return this._boundingBox}setBoundingBox(t){this._boundingBox=t}getMipLevel(){return this._mipLevel}getOffsetX(){return this._offsetX}getOffsetZ(){return this._offsetZ}getStep(){return this._step}getLODDistance(){return this._lodDistance}getGeometry(){return this._geometry}getHeight(t,e){const i=this._offsetX+this._step*Math.floor((t-this._offsetX)/this._step),s=this._offsetZ+this._step*Math.floor((e-this._offsetZ)/this._step),r=i==t?i:i+this._step,a=s==e?s:s+this._step,n=this._quadtree.getHeightField(),o=n.getHeight(i,s),h=n.getHeight(r,s),l=n.getHeight(i,a),u=n.getHeight(r,a),c=(t-i)/this._step,d=o+(h-o)*c;return d+(l+(u-l)*c-d)*((e-s)/this._step)}computeMaxError(){if(1===this._step)return 0;let t=0;const e=this._step*(this._quadtree.getPatchSize()-1),i=this._quadtree.getRootSize(),s=this._quadtree.getHeightField();for(let r=this._offsetZ;r<=this._offsetZ+e;r++)for(let a=this._offsetX;a<=this._offsetX+e;a++){const e=this._offsetZ+Math.floor((r-this._offsetZ)/this._step)*this._step,n=this._offsetX+Math.floor((a-this._offsetX)/this._step)*this._step;if(e===i-1||n===i-1)continue;const o=e+this._step,h=n+this._step,l=s.getHeight(n,e),u=s.getHeight(h,e),c=s.getHeight(n,o),d=s.getHeight(h,o),p=(r-e)/this._step,m=(a-n)/this._step,f=s.getHeight(a,r),_=l+m*(u-l),g=_+p*(c+m*(d-c)-_),x=Math.abs(f-g);x>t&&(t=x)}return t}computeSkirtLength(){let t=0,e=this._parent;for(;e;){const i=this.computeErrorMetric(e);i>t&&(t=i),e=e._parent}return t}computeErrorMetric(t){let e=0;if(t.getMipLevel()>this._mipLevel){const i=t.getOffsetX(),s=t.getOffsetZ(),r=t.getStep(),a=t.getStep()*this._quadtree.getPatchSize();for(let n=s;n<s+a;n+=r)for(let s=i;s<i+a;s+=r){const i=Math.abs(this.getHeight(s,n)-t.getHeight(s,n));i>e&&(e=i)}}else if(t.getMipLevel()<this._mipLevel){const i=this._step*(this._quadtree.getPatchSize()-1);for(let s=this._offsetZ;s<=this._offsetZ+i;s+=this._step)for(let r=this._offsetX;r<=this._offsetX+i;r+=this._step){const i=Math.abs(this.getHeight(r,s)-t.getHeight(r,s));i>e&&(e=i)}}return e}computeBoundingBox(t){const[e,i]=this.computeHeightBound(),s=this._quadtree.getScaleX(),r=this._quadtree.getScaleZ();t.minPoint=new z(this._offsetX*s,i,this._offsetZ*r),t.maxPoint=new z(this._offsetX*s+(this._quadtree.getPatchSize()-1)*this._step*s,e,this._offsetZ*r+(this._quadtree.getPatchSize()-1)*this._step*r)}computeLodDistance(t,e,i){return.5*this._maxError*t/(i*e)}sqrDistanceToPoint(t){const e=this.getBoundingBox(),i=Math.hypot(e.extents.x,e.extents.z),s=t.x-e.center.x,r=t.z-e.center.z,a=Math.max(0,Math.hypot(s,r)-i),n=t.y>e.maxPoint.y?t.y-e.maxPoint.y:t.y<e.minPoint.y?e.minPoint.y-t.y:0;return a*a+n*n}sqrDistancePointToTriangle(t,e,i,s){const r=e,a=z.sub(i,r),n=z.sub(s,r),o=z.sub(r,t),h=z.dot(a,a),l=z.dot(a,n),u=z.dot(n,n),c=z.dot(a,o),d=z.dot(n,o),p=z.dot(o,o),m=h*u-l*l;let f,_=l*d-u*c,g=l*c-h*d;if(_+g<=m)_<0?g<0&&c<0?(g=0,-c>=h?(_=1,f=h+2*c+p):(_=-c/h,f=c*_+p)):(_=0,d>=0?(g=0,f=p):-d>=u?(g=1,f=u+2*d+p):(g=-d/u,f=d*g+p)):g<0?(g=0,c>=0?(_=0,f=p):-c>=h?(_=1,f=h+2*c+p):(_=-c/h,f=c*_+p)):(_/=m,g/=m,f=_*(h*_+l*g+2*c)+g*(l*_+u*g+2*d)+p);else if(_<0){const t=l+c,e=u+d;if(e>t){const i=e-t,s=h-2*l+u;i>=s?(_=1,g=0,f=h+2*c+p):(_=i/s,g=1-_,f=_*(h*_+l*g+2*c)+g*(l*_+u*g+2*d)+p)}else _=0,e<=0?(g=1,f=u+2*d+p):d>=0?(g=0,f=p):(g=-d/u,f=d*g+p)}else if(g<0){const t=l+d,e=h+c;if(e>t){const i=e-t,s=h-2*l+u;i>=s?(g=1,_=0,f=u+2*d+p):(g=i/s,_=1-g,f=_*(h*_+l*g+2*c)+g*(l*_+u*g+2*d)+p)}else g=0,e<=0?(_=1,f=h+2*c+p):c>=0?(_=0,f=p):(_=-c/h,f=c*_+p)}else{const t=u+d-l-c;if(t<=0)_=0,g=1,f=u+2*d+p;else{const e=h-2*l+u;t>=e?(_=1,g=0,f=h+2*c+p):(_=t/e,g=1-_,f=_*(h*_+l*g+2*c)+g*(l*_+u*g+2*d)+p)}}return f<0&&(f=0),f}computeHeightBound(){let t=-Number.MAX_VALUE,e=Number.MAX_VALUE;const i=this._step*(this._quadtree.getPatchSize()-1),s=this._quadtree.getHeightField(),r=Math.min(s.getSizeZ()-1,this._offsetZ+i),a=Math.min(s.getSizeX()-1,this._offsetX+i);for(let i=this._offsetZ;i<=r;i++)for(let r=this._offsetX;r<=a;r++){const a=s.getHeight(r,i);a>t&&(t=a),a<e&&(e=a)}return[t,e]}isDummy(){return!this._geometry&&!!this._quadtree}onDispose(){super.onDispose(),this._geometry?.dispose()}}class E_ extends gt{_terrain;constructor(t){super(),this._terrain=t}getNode(){return this._terrain}}class M_ extends(a(E_,f_)){_primitive;_numInstances;_material;constructor(t,e,i,s,r){super(t),this._primitive=new Cl,this._primitive.setVertexBuffer(e,"vertex"),this._primitive.createAndSetVertexBuffer("tex1_f32x4",r,"instance"),this._primitive.setIndexBuffer(i),this._primitive.primitiveType="triangle-list",this._numInstances=r.length>>2,this._material=s}getName(){return"GrassCluster"}getMaterial(){return this._material}getPrimitive(){return this._primitive}getPickTarget(){return{node:this._terrain}}getBoneMatrices(){return null}getMorphData(){return null}getMorphInfo(){return null}getSortDistance(t){return this._terrain.getSortDistance(t)}getQueueType(){return this._material.getQueueType()}isUnlit(){return!this._material.supportLighting()}needSceneColor(){return!1}needSceneDepth(){return!1}isBatchable(){return!1}draw(t){this.bind(t),this._material.draw(this._primitive,t,this._numInstances)}onDispose(){super.onDispose(),this._primitive.dispose()}}class B_ extends gt{_clusterSize;_baseVertexBuffer;_indexBuffer;_layers;constructor(t,e){super(),this._clusterSize=t,this._baseVertexBuffer=new Map,this._indexBuffer=new wt,this._layers=[]}onDispose(){super.onDispose(),this._indexBuffer?.dispose(),this._indexBuffer=null;for(const t of this._baseVertexBuffer)t[1].dispose();this._baseVertexBuffer.clear();for(const t of this._layers)t.material.dispose();for(const t of this._layers){t.material.dispose();for(const e of t.clusters)e[1].dispose()}this._layers=[]}getBaseVertexBuffer(t,e,i){const s=`${e}-${i}`;let r=this._baseVertexBuffer.get(s)?.get();if(r)return r;const a=.5*e,n=i,o=a*Math.cos(Math.PI/3),h=a*Math.sin(Math.PI/3),l=new Float32Array([a,0,0,0,1,a,n,0,0,0,-a,n,0,1,0,-a,0,0,1,1,o,0,h,0,1,-o,0,-h,1,1,-o,n,-h,1,0,o,n,h,0,0,-o,0,h,0,1,o,0,-h,1,1,o,n,-h,1,0,-o,n,h,0,0]);return r=t.createInterleavedVertexBuffer(["position_f32x3","tex0_f32x2"],l),this._baseVertexBuffer.set(s,new wt(r)),r}getIndexBuffer(t){return this._indexBuffer.get()||this._indexBuffer.set(t.createIndexBuffer(new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11]))),this._indexBuffer.get()}addGrassLayer(t,e,i,s,r,a,n){const o=i.length,h=i[0].length,l=e.heightFieldScale;this._clusterSize=Math.min(M(this._clusterSize),e.width-1,e.height-1);let u=null;return e.traverseQuadtree(c=>{if(c.getPatch().getStep()*(e.patchSize-1)===this._clusterSize){const d=c.getPatch().getBoundingBox(),p=[],m=d.minPoint.x,f=d.minPoint.z;let _=0;for(let t=0;t<this._clusterSize;t++)for(let s=0;s<this._clusterSize;s++){const r=m+s*l.x,n=f+t*l.z,u=r+l.x,c=n+l.z,d=r/e.scaledWidth,g=n/e.scaledHeight,x=h*d|0,b=i[o*g|0][x]*l.x*l.z;let v=0;b>0&&(v=b<1?Math.random()<=b?1:0:b|0);for(let t=0;t<v;t++){const t=Math.random()*(u-r)+r,i=Math.random()*(c-n)+n,s=e.getElevation(t,i),o=Math.random()*Math.PI*2;p[_++]=t,p[_++]=s+a,p[_++]=i,p[_++]=o}}if(p.length>0){u||(u={material:new wt(new gd(new L(e.scaledWidth,e.scaledHeight),e.quadtree.normalMap,n)),clusters:new Map},this._layers.push(u));const i=new M_(e,this.getBaseVertexBuffer(t,s,r),this.getIndexBuffer(t),u.material.get(),new Float32Array(p));u.clusters.set(c,i),c.grassClusters.push(i)}}}),u}}class I_{_program;_bindGroup;_srcSize;_dstSize;setupUniforms(t){}applyUniformValues(t){}constructor(){this._program=new wt,this._bindGroup=new wt,this._srcSize=new Float32Array(2),this._dstSize=new Float32Array(2)}render(t){const e=Sl();if(this.prepare(e),e.pushDeviceStates(),"webgpu"===e.type)for(let i=0;i<t.mipLevelCount-1;i++)this.renderLevel(e,i,t,t);else{const i=e.createTexture2D(t.format,t.width,t.height),s=e.createFrameBuffer([i],null),r=s.getColorAttachments()[0];for(let i=0;i<t.mipLevelCount-1;i++)this.renderLevel(e,i,t,r);s.dispose(),i.dispose()}e.popDeviceStates()}renderLevel(t,e,i,s){const r=Gl("clamp_nearest"),a=t.createFrameBuffer([s],null);a.setColorAttachmentMipLevel(0,e+1);const n=this._bindGroup.get();a.setColorAttachmentGenerateMipmaps(0,!1),this._srcSize[0]=Math.max(i.width>>e,1),this._srcSize[1]=Math.max(i.height>>e,1),this._dstSize[0]=Math.max(this._srcSize[0]>>1,1),this._dstSize[1]=Math.max(this._srcSize[1]>>1,1),n.setValue("srcSize",this._srcSize),n.setValue("dstSize",this._dstSize),"webgpu"===t.type?n.setTextureView("srcTex",i,e,0,1,r):(n.setTexture("srcTex",i,r),n.setValue("srcMipLevel",e)),this.applyUniformValues(n),t.setProgram(this._program.get()),t.setBindGroup(0,this._bindGroup.get()),t.setFramebuffer(a),Ru(),i!==s&&t.copyFramebufferToTexture2D(a,0,i,e+1),a.dispose()}prepare(t){if(!this._program.get()){const e=this,i=t.buildRenderProgram({vertex(i){this.$inputs.pos=i.vec2().attrib("position"),this.$outputs.uv=i.vec2(),e.setupUniforms(this),i.main(function(){this.$builtins.position=i.vec4(this.$inputs.pos,1,1),this.$outputs.uv=i.add(i.mul(this.$inputs.pos.xy,.5),i.vec2(.5)),"webgpu"===t.type&&(this.$builtins.position.y=i.neg(this.$builtins.position.y))})},fragment(i){this.$outputs.color=i.vec4(),this.srcTex=i.tex2D().sampleType("unfilterable-float").uniform(0),this.srcSize=i.vec2().uniform(0),this.dstSize=i.vec2().uniform(0),e.setupUniforms(this),"webgpu"!==t.type&&(this.srcMipLevel=i.float().uniform(0)),i.main(function(){const s="webgpu"===t.type?0:this.srcMipLevel;this.$l.invSize=i.div(i.vec2(1),this.srcSize),this.$l.uv=i.div(this.$builtins.fragCoord.xy,this.dstSize),this.$l.d0=i.textureSampleLevel(this.srcTex,i.add(this.uv,i.mul(i.vec2(-.5,-.5),this.invSize)),s),this.$l.d1=i.textureSampleLevel(this.srcTex,i.add(this.uv,i.mul(i.vec2(.5,-.5),this.invSize)),s),this.$l.d2=i.textureSampleLevel(this.srcTex,i.add(this.uv,i.mul(i.vec2(-.5,.5),this.invSize)),s),this.$l.d3=i.textureSampleLevel(this.srcTex,i.add(this.uv,i.mul(i.vec2(.5,.5),this.invSize)),s),this.$outputs.color=e.renderPixel(this,this.d0,this.d1,this.d2,this.d3,this.uv)})}});i.name="@RenderMipmap",this._program.set(i),this._bindGroup.set(t.createBindGroup(i.bindGroupLayouts[0]))}}}class P_ extends(Yc(ed,fd,_d)){_terrain;_terrainPosScale;_heightMapSize;_textureSize;constructor(t){super(),this.metallic=0,this.roughness=1,this.doubleSidedLighting=!1,this.specularFactor=new O(1,1,1,.2),this._terrain=new St(t),this._terrainPosScale=new O,this._heightMapSize=new L(1/t.heightMap.width,1/t.heightMap.height),this._textureSize=L.one()}clone(){const t=new P_(this._terrain.get());return t.copyFrom(this),t}copyFrom(t){super.copyFrom(t),this._terrainPosScale.set(t._terrainPosScale),this._heightMapSize.set(t._heightMapSize),this._textureSize.set(t._textureSize)}setTextureSize(t,e){this._textureSize.setXY(t,e),this.uniformChanged()}isTransparentPass(t){return!1}supportLighting(){return!0}supportInstancing(){return!1}applyUniformValues(t,e,i){super.applyUniformValues(t,e,i);const s=this._terrain.get();this._terrainPosScale.setXYZW(s.scale.x,s.scale.y,s.scale.z,s.worldMatrix.m13),t.setTexture("terrainHeightMap",s.heightMap,Gl("clamp_linear_nomip")),t.setValue("heightMapSize",this._heightMapSize),t.setValue("terrainRegion",s.worldRegion),t.setValue("terrainPosScale",this._terrainPosScale),this.needFragmentColor(e)&&t.setValue("albedoTextureSize",this._textureSize)}vertexShader(t){super.vertexShader(t);const e=t.$builder;t.$inputs.pos=e.vec3().attrib("position"),t.$inputs.albedoUV=e.vec2().attrib("texCoord0"),t.$inputs.placement=e.vec4().attrib("texCoord1"),t.terrainHeightMap=e.tex2D().uniform(2),t.heightMapSize=e.vec2().uniform(2),t.terrainRegion=e.vec4().uniform(2),t.terrainPosScale=e.vec4().uniform(2),e.func("calcHeightMapNormal",[e.vec2("uv"),e.vec2("texelSize"),e.vec3("scale")],function(){this.$l.hL=e.textureSampleLevel(this.terrainHeightMap,e.sub(this.uv,e.vec2(this.texelSize.x,0)),0).r,this.$l.hR=e.textureSampleLevel(this.terrainHeightMap,e.add(this.uv,e.vec2(this.texelSize.x,0)),0).r,this.$l.hD=e.textureSampleLevel(this.terrainHeightMap,e.add(this.uv,e.vec2(0,this.texelSize.y)),0).r,this.$l.hU=e.textureSampleLevel(this.terrainHeightMap,e.sub(this.uv,e.vec2(0,this.texelSize.y)),0).r,this.$l.dHdU=e.div(e.mul(e.sub(this.hR,this.hL),this.scale.y),e.mul(this.scale.x,2)),this.$l.dHdV=e.div(e.mul(e.sub(this.hD,this.hU),this.scale.y),e.mul(this.scale.z,2)),this.t=e.normalize(e.vec3(1,this.dHdU,0)),this.b=e.normalize(e.vec3(0,this.dHdV,1)),this.$return(e.normalize(e.cross(this.b,this.t)))}),t.$l.uv=t.$inputs.placement.xy,t.$l.heightSample=e.textureSampleLevel(t.terrainHeightMap,t.uv,0),t.$l.height=e.add(e.mul(t.heightSample.r,t.terrainPosScale.y),t.terrainPosScale.w),t.$l.normal=t.calcHeightMapNormal(t.uv,t.heightMapSize,t.terrainPosScale.xyz),t.$l.axisX=e.vec3(t.$inputs.placement.z,0,t.$inputs.placement.w),t.$l.axisZ=e.cross(t.axisX,t.normal),t.$l.axisX=e.cross(t.normal,t.axisZ),t.$l.rotPos=e.mul(e.mat3(t.axisX,t.normal,t.axisZ),t.$inputs.pos),t.$l.posXZ=e.add(e.mul(t.$inputs.placement.xy,e.sub(t.terrainRegion.zw,t.terrainRegion.xy)),t.terrainRegion.xy),t.$outputs.zAlbedoTexCoord=t.$inputs.albedoUV,t.$outputs.worldPos=e.add(t.rotPos,e.vec3(t.posXZ.x,t.height,t.posXZ.y)),Qc.setClipSpacePosition(t,e.mul(Qc.getViewProjectionMatrix(t),e.vec4(t.$outputs.worldPos,1))),t.$outputs.worldNorm=t.normal,Qc.resolveMotionVector(t,t.$outputs.worldPos,t.$outputs.worldPos)}fragmentShader(t){super.fragmentShader(t);const e=t.$builder,i=this;this.needFragmentColor()?(t.albedoTextureSize=e.vec2().uniform(2),t.$l.albedo=this.calculateAlbedoColor(t),t.albedo=i.calculateFoliageAlbedo(t,t.albedo,e.mul(i.getAlbedoTexCoord(t),t.albedoTextureSize)),t.$l.litColor=e.vec3(0),0===this.drawContext.renderPass.type&&(t.$l.normalInfo=this.calculateNormalAndTBN(t,t.$inputs.worldPos,t.$inputs.worldNorm),t.$l.viewVec=this.calculateViewVector(t,t.$inputs.worldPos),t.$l.litColor=this.PBRLight(t,t.$inputs.worldPos,t.normalInfo.normal,t.viewVec,t.albedo,t.normalInfo.TBN)),this.outputFragmentColor(t,t.$inputs.worldPos,e.vec4(t.litColor,t.albedo.a))):this.outputFragmentColor(t,t.$inputs.worldPos,null)}apply(t){return this.alphaToCoverage=t.device.getFrameBufferSampleCount()>1,this.alphaCutoff=this.alphaToCoverage?1:.8,super.apply(t)}updateRenderStates(t,e,i){super.updateRenderStates(t,e,i),e.useRasterizerState().setCullMode("none")}}class $_ extends gt{_instances;_baseVertexBuffer;_indexBuffer;_instanceBuffer;_primitive;constructor(t,e){super(),this._instances=[],this._baseVertexBuffer=new wt(t),this._indexBuffer=new wt(e),this._instanceBuffer=new wt,this._primitive=new wt}get numInstances(){return this._instances.length}get instanceBuffer(){return this._instanceBuffer.get()}setBaseVertexBuffer(t){t!==this._baseVertexBuffer.get()&&(this._baseVertexBuffer.set(t),this._primitive.dispose())}draw(){if(this._instances.length>0){if(!this._primitive.get()){const t=new Cl;t.setVertexBuffer(this._baseVertexBuffer.get()),t.setVertexBuffer(this._instanceBuffer.get(),"instance"),t.setIndexBuffer(this._indexBuffer.get()),t.primitiveType="triangle-list",t.indexStart=0,t.indexCount=this._indexBuffer.get().length,this._primitive.set(t)}this._primitive.get().drawInstanced(this._instances.length)}}updateBuffers(){const t=Sl();if(0===this._instances.length)return void this._instanceBuffer.set(null);this._instances.length>0&&!this._instanceBuffer.get()&&this._instanceBuffer.set(t.createVertexBuffer("tex1_f32x4",new Uint8Array(16*this._instances.length)));let e=this._instanceBuffer.get();const i=e.byteLength,s=16*this._instances.length;i<s&&(e=t.createVertexBuffer("tex1_f32x4",new Uint8Array(M(s))),this._instanceBuffer.set(e),this._primitive.dispose());const r=new Float32Array(4*this._instances.length);for(let t=0;t<this._instances.length;t++)r[4*t+0]=this._instances[t].x,r[4*t+1]=this._instances[t].y,r[4*t+2]=Math.sin(this._instances[t].angle),r[4*t+3]=Math.cos(this._instances[t].angle);e.bufferSubData(0,r)}removeInstances(t,e,i,s,r){if(r<=0)return 0;let a=0;for(let n=this._instances.length-1;n>=0;n--){const o=this._instances[n];if(o.x>=t&&o.x<=i&&o.y>=e&&o.y<=s&&(this._instances.splice(n,1),a++,a===r))break}return a>0&&this.updateBuffers(),a}addInstances(t){this._instances.push(...t),this.updateBuffers()}onDispose(){super.onDispose(),this._baseVertexBuffer.dispose(),this._indexBuffer.dispose(),this._instanceBuffer.dispose(),this._primitive.dispose()}}class R_ extends gt{static _indexBuffer=new wt;_material;_quadtree;_bladeWidth;_bladeHeight;_baseVertexBuffer;constructor(t,e,i,s){super(),this._material=new wt(new P_(t)),this._material.get().albedoTexture=s,s&&this._material.get().setTextureSize(s.width,s.height),this._bladeWidth=e,this._bladeHeight=i,this._baseVertexBuffer=new wt(this.createBaseVertexBuffer(this._bladeWidth,this._bladeHeight)),this._quadtree=new wt(new D_(this._baseVertexBuffer.get(),R_._getIndexBuffer()))}get quadtree(){return this._quadtree.get()}updateMaterial(){this._material.get().uniformChanged()}setAlbedoMap(t){this._material.get().albedoTexture=t,t&&this._material.get().setTextureSize(t.width,t.height)}getAlbedoMap(){return this._material.get().albedoTexture}addInstances(t){return this._quadtree.get().addInstances(t)}removeInstances(t,e,i,s,r){this._quadtree.get().removeInstances(t,e,i,s,r)}get bladeWidth(){return this._bladeWidth}set bladeWidth(t){this.setBladeSize(t,this._bladeHeight)}get bladeHeight(){return this._bladeHeight}set bladeHeight(t){this.setBladeSize(this._bladeWidth,t)}setBladeSize(t,e){t===this._bladeWidth&&e===this._bladeHeight||(this._bladeWidth=t,this._bladeHeight=e,this._baseVertexBuffer.set(this.createBaseVertexBuffer(this._bladeWidth,this._bladeHeight)),this._quadtree.get().setBaseVertexBuffer(this._baseVertexBuffer.get()))}static _getIndexBuffer(){return this._indexBuffer.get()||this._indexBuffer.set(Sl().createIndexBuffer(new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11]))),this._indexBuffer.get()}createBaseVertexBuffer(t,e){const i=Sl(),s=.5*t,r=e,a=s*Math.cos(Math.PI/3),n=s*Math.sin(Math.PI/3),o=new Float32Array([s,0,0,0,1,s,r,0,0,0,-s,r,0,1,0,-s,0,0,1,1,a,0,n,0,1,-a,0,-n,1,1,-a,r,-n,1,0,a,r,n,0,0,-a,0,n,0,1,a,0,-n,1,1,a,r,-n,1,0,-a,r,n,0,0]);return i.createInterleavedVertexBuffer(["position_f32x3","tex0_f32x2"],o)}draw(t,e,i,s){this._material.get().apply(t);for(let r=0;r<this._material.get().numPasses;r++)this._material.get().bind(t.device,r),this._quadtree.get().draw(t.camera,e,i,s,!1)}onDispose(){super.onDispose(),this._material.dispose(),this._quadtree.dispose(),this._baseVertexBuffer.dispose()}}class F_ extends gt{_terrain;_numGrassBlades;_layers;constructor(t){super(),this._terrain=new St(t),this._numGrassBlades=0,this._layers=[]}updateMaterial(){for(const t of this._layers)t.updateMaterial()}get numGrassBlades(){return this._numGrassBlades}get numLayers(){return this._layers.length}getLayer(t){return this._layers[t]}addLayer(t,e,i){const s=new R_(this._terrain.get(),t,e,i);return this._layers.push(s),this._layers.length-1}getGrassTexture(t){return this._layers[t]?.getAlbedoMap()??null}setGrassTexture(t,e){const i=this._layers[t];i?i.setAlbedoMap(e):console.error(`Invalid grass layer: ${t}`)}getBladeWidth(t){return this._layers[t]?.bladeWidth??0}getBladeHeight(t){return this._layers[t]?.bladeHeight??0}setBladeSize(t,e,i){const s=this._layers[t];s?s.setBladeSize(e,i):console.error(`Invalid grass layer: ${t}`)}addInstances(t,e){const i=this._layers[t];i?this._numGrassBlades+=i.addInstances(e):console.error(`Invalid grass layer: ${t}`)}removeInstances(t,e,i,s,r,a){const n=this._layers[t];n?n.removeInstances(e,i,s,r,a):console.error(`Invalid grass layer: ${t}`)}draw(t){const e=this._terrain.get().getWorldBoundingVolume().toAABB(),i=e.minPoint.y,s=e.maxPoint.y;for(const e of this._layers)e.draw(t,this._terrain.get().worldRegion,i-e.bladeHeight,s+e.bladeHeight)}onDispose(){super.onDispose(),this._terrain.dispose();for(const t of this._layers)t.dispose();this._layers=null}}class D_ extends gt{static _cullAABB=new q;_grassInstances;_children;_baseVertexBuffer;_indexBuffer;_minX;_minZ;_maxX;_maxZ;constructor(t,e){super(),this._baseVertexBuffer=new wt(t),this._indexBuffer=new wt(e),this._grassInstances=new wt(new $_(t,e)),this._children=null,this._minX=0,this._minZ=0,this._maxX=1,this._maxZ=1}get grassInstances(){return this._grassInstances.get()}get children(){return this._children}draw(t,e,i,s,r){if(!r){const a=D_._cullAABB,n=e.x,o=e.y,h=e.z-n,l=e.w-o;a.minPoint.setXYZ(n+this._minX*h,i,o+this._minZ*l),a.maxPoint.setXYZ(n+this._maxX*h,s,o+this._maxZ*l);const u=t.clipMask?a.getClipStateWithFrustumMask(t.frustum,t.clipMask):a.getClipStateWithFrustum(t.frustum);if(u===$.NOT_CLIPPED)return;r=u===$.A_INSIDE_B}if(this._grassInstances.get().numInstances>0&&this._grassInstances.get().draw(),this._children)for(const a of this._children)a.draw(t,e,i,s,r)}setBaseVertexBuffer(t){if(t!==this._baseVertexBuffer.get()&&(this._baseVertexBuffer.set(t),this._grassInstances.get().setBaseVertexBuffer(t),this._children))for(const e of this._children)e.setBaseVertexBuffer(t)}removeInstances(t,e,i,s,r){let a=Math.min(this._grassInstances.get().numInstances,r);if(a<=0)return 0;let n=0;if(this._children)for(const r of this._children)r._minX<i&&r._minZ<s&&r._maxX>t&&r._maxZ>e&&(n+=r.removeInstances(t,e,i,s,a),a-=n);return a>0&&(n+=this._grassInstances.get().removeInstances(t,e,i,s,a)),n}addInstances(t){if(0===t.length)return 0;let e=Math.min(t.length,2048-this._grassInstances.get().numInstances);if(this._grassInstances.get().addInstances(t.slice(0,e)),e<t.length){this._children||(this._children=[new D_(this._baseVertexBuffer.get(),this._indexBuffer.get()),new D_(this._baseVertexBuffer.get(),this._indexBuffer.get()),new D_(this._baseVertexBuffer.get(),this._indexBuffer.get()),new D_(this._baseVertexBuffer.get(),this._indexBuffer.get())],this._children[0]._minX=this._minX,this._children[0]._minZ=this._minZ,this._children[0]._maxX=.5*(this._minX+this._maxX),this._children[0]._maxZ=.5*(this._minZ+this._maxZ),this._children[1]._minX=this._children[0]._maxX,this._children[1]._minZ=this._minZ,this._children[1]._maxX=this._maxX,this._children[1]._maxZ=this._children[0]._maxZ,this._children[2]._minX=this._minX,this._children[2]._minZ=this._children[0]._maxZ,this._children[2]._maxX=this._children[0]._maxX,this._children[2]._maxZ=this._maxZ,this._children[3]._minX=this._children[0]._maxX,this._children[3]._minZ=this._children[0]._maxZ,this._children[3]._maxX=this._maxX,this._children[3]._maxZ=this._maxZ),t=t.slice(e);for(const i of this._children)if(t.length>0){const s=t.filter(t=>t.x>=i._minX&&t.y>=i._minZ&&t.x<i._maxX&&t.y<i._maxZ);e+=i.addInstances(s),t=t.filter(t=>!(t.x>=i._minX&&t.y>=i._minZ&&t.x<i._maxX&&t.y<i._maxZ))}}return e}onDispose(){if(super.onDispose(),this._baseVertexBuffer.dispose(),this._indexBuffer.dispose(),this._grassInstances.dispose(),this._children)for(const t of this._children)t.dispose()}}class N_ extends zl{filter(t,e,i,s,r,a){return this.readTexel(t,e,i,s,r,a).xxxx}}class L_ extends I_{renderPixel(t,e,i,s,r){const a=t.$builder;return t.$l.maxHeight=a.max(a.max(e.r,i.r),a.max(s.r,r.r)),t.$l.minHeight=a.min(a.min(e.g,i.g),a.min(s.g,r.g)),a.vec4(t.maxHeight,t.minHeight,e.r,1)}}class z_ extends(a(Nf,f_)){static _heightBoundingGenerator=new L_;static _copyBlitter=new N_;static _tmpBuffer=new Float32Array(512);_pickTarget;_clipmap;_renderData;_gridScale;_material;_grassRenderer;_castShadow;_sizeX;_sizeZ;_heightMapAssetId;_splatMapAssetId;_grassAssetId;_minHeight;_maxHeight;_tmpTexture;constructor(t,e=256,i=256,s=64){super(t),this._pickTarget={node:this},this._clipmap=new Mf(s,["tex1_f32"],64),this._renderData=null,this._grassRenderer=new wt(new F_(this)),this._gridScale=1,this._castShadow=!0,this._sizeX=e,this._sizeZ=i,this._heightMapAssetId=`assets/.embedded.dir/${this.persistentId}-heightmap.bin`,this._grassAssetId=`assets/.embedded.dir/${this.persistentId}-grass.bin`,this._splatMapAssetId=`assets/.embedded.dir/${this.persistentId}-splatmap.bin`,this._minHeight=0,this._maxHeight=0,this._material=new wt(new bd(this.createHeightMapTexture(this._sizeX,this._sizeZ))),this._tmpTexture=new wt,this.updateRegion(),t.queuePerCameraUpdateNode(this)}get grassRenderer(){return this._grassRenderer.get()}get MAX_DETAIL_MAP_COUNT(){return bd.MAX_DETAIL_MAP_COUNT}get heightMapAssetId(){return this._heightMapAssetId||(this._heightMapAssetId=r()),this._heightMapAssetId}set heightMapAssetId(t){this._heightMapAssetId=t}get splatMapAssetId(){return this._splatMapAssetId||(this._splatMapAssetId=r()),this._splatMapAssetId}set splatMapAssetId(t){this._splatMapAssetId=t}get grassAssetId(){return this._grassAssetId||(this._grassAssetId=r()),this._grassAssetId}set grassAssetId(t){this._grassAssetId=t}get numDetailMaps(){return this.material.numDetailMaps}set numDetailMaps(t){this.material.numDetailMaps=t}async clone(){return console.error("Cloning clipmap terrain not implemented"),null}setSize(t,e){t===this._sizeX&&e===this._sizeZ||(this._sizeX=t,this._sizeZ=e,this.resizeHeightMap(this._sizeX,this._sizeZ))}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=!!t}get sizeX(){return this._sizeX}set sizeX(t){t!==this._sizeX&&(this._sizeX=t,this.resizeHeightMap(this._sizeX,this._sizeZ))}get sizeZ(){return this._sizeZ}set sizeZ(t){t!==this._sizeZ&&(this._sizeZ=t,this.resizeHeightMap(this._sizeX,this._sizeZ))}get heightMap(){return this.material.heightMap}set heightMap(t){t&&(this.material.heightMap=t,this.updateRegion())}get splatMap(){return this.material.getSplatMap()}get material(){return this._material?.get()??null}get wireframe(){return this._clipmap.wireframe}set wireframe(t){this._clipmap.wireframe=t}getPickTarget(){return this._pickTarget}getMorphData(){return null}getMorphInfo(){return null}getQueueType(){return this.material.getQueueType()}isUnlit(){return!this.material.supportLighting()}needSceneColor(){return this.material.needSceneColor()}needSceneDepth(){return this.material.needSceneDepth()}getMaterial(){return this._material.get()}getPrimitive(){return null}isClipmapTerrain(){return!0}computeBoundingVolume(){return null}computeWorldBoundingVolume(){const t=this.worldMatrix.transformPointAffine(z.zero()),e=this._minHeight*this.scale.y,i=this._maxHeight*this.scale.y;return new hu(new z(this.material.region.x,t.y+Math.min(e,i),this.material.region.y),new z(this.material.region.z,t.y+Math.max(e,i),this.material.region.w))}get worldRegion(){return this.material.region}calculateLocalTransform(t){t.translation(this._position)}calculateWorldTransform(t){t.set(this.localMatrix),this.parent&&(t.m03+=this.parent.worldMatrix.m03,t.m13+=this.parent.worldMatrix.m13,t.m23+=this.parent.worldMatrix.m23)}updateBoundingBox(){const t=this.heightMap,e=Sl();let i=this._tmpTexture.get();!i||i.width===t.width&&i.height===t.height||this._tmpTexture.dispose(),this._tmpTexture.get()||(i=Sl().createTexture2D("webgl"===e.type?"rgba32f":"rg32f",t.width,t.height),i.name="TerrainBoundingBoxTexture",this._tmpTexture.set(i));const s=e.createFrameBuffer([i],null);z_._copyBlitter.blit(t,s,Gl("clamp_nearest_nomip")),s.dispose(),z_._heightBoundingGenerator.render(i);const r=new Float32Array(4);i.readPixels(0,0,1,1,0,i.mipLevelCount-1,r).then(()=>{this._minHeight=r[0],this._maxHeight=r[1],this.invalidateWorldBoundingVolume(!1)}).catch(t=>{console.error("Read pixels failed")})}createHeightMapTexture(t,e){return Sl().createTexture2D("webgl"===Sl().type?"rgba16f":"r16f",t,e)}_onTransformChanged(t){super._onTransformChanged(t),this.updateRegion()}updatePerCamera(t,e,i){const s=this._material.get(),r=this,a=this.getWorldBoundingVolume().toAABB();this._renderData=this._clipmap.gather({camera:t,minMaxWorldPos:s.region,gridScale:this._gridScale,userData:this,frustumCulling:!this.castShadow,calcAABB(t,e,i,s,n,o){const h=r.worldMatrix.transformPointAffine(z.zero());o.minPoint.setXYZ(e,a?a.minPoint.y:h.y-9999,s),o.maxPoint.setXYZ(i,a?a.maxPoint.y:h.y+9999,n)}});let n=0;for(const t of this._renderData){t.primitive.getVertexBuffer("texCoord1").bufferSubData(0,t.mipLevels,0,t.numInstances),t.maxMiplevel>n&&(n=t.maxMiplevel)}const o=this._clipmap.calcLevelAABB(t,s.region,this._gridScale),h=t.getWorldPosition(),l=z_._tmpBuffer;for(let t=0;t<=n;t++){if(0===t)l[8*t+0]=h.x,l[8*t+1]=h.z,l[8*t+2]=h.x,l[8*t+3]=h.z;else{const e=o[t-1];l[8*t+0]=e.minPoint.x,l[8*t+1]=e.minPoint.z,l[8*t+2]=e.maxPoint.x,l[8*t+3]=e.maxPoint.z}const e=o[t];l[8*t+4]=1/(e.minPoint.x-l[8*t+0]),l[8*t+5]=1/(e.minPoint.z-l[8*t+1]),l[8*t+6]=1/(e.maxPoint.x-l[8*t+2]),l[8*t+7]=1/(e.maxPoint.z-l[8*t+3])}s.setLevelData(l,8*(n+1)),this.scene.queuePerCameraUpdateNode(this)}updateRegion(){if(this.material){const t=Math.abs(this.scale.x),e=Math.abs(this.scale.z),i=this.position.x+(this.parent?.worldMatrix.m03??0),s=this.position.z+(this.parent?.worldMatrix.m23??0);this._gridScale=Math.max(t*this._sizeX/this.material.heightMap.width,e*this._sizeZ/this.material.heightMap.height),this.material.update(new O(i,s,i+t*this._sizeX,s+e*this._sizeZ),this.scale)}this._grassRenderer?.get().updateMaterial()}draw(t){const e=this._material?.get();this.bind(t),e.setClipmapGridInfo(this._gridScale,this.worldMatrix.m03,this.worldMatrix.m23),e.apply(t);for(const i of this._renderData)e.draw(i.primitive,t,i.numInstances);3!==t.renderPass.type&&1!==t.renderPass.type&&this._grassRenderer.get().draw(t)}resizeHeightMap(t,e){const i=this.material.heightMap,s=Sl(),r=s.getDeviceCaps().textureCaps.maxTextureSize;if(t=Math.min(Math.max(t,1),r)|0,e=Math.min(Math.max(e,1),r)|0,t!==i.width||e!==i.height){const r=s.createTexture2D("webgl"===s.type?"rgba16f":"r16f",t,e),a=s.createFrameBuffer([r],null);z_._copyBlitter.blit(i,a,Gl("clamp_linear_nomip")),a.dispose(),this.heightMap=r,this.updateBoundingBox()}}onDispose(){super.onDispose(),this._clipmap?.dispose(),this._clipmap=null,this._material?.dispose(),this._material=null,this._grassRenderer?.dispose(),this._grassRenderer=null}}class V_ extends df{_left;_right;_top;_bottom;_near;_far;_window;constructor(t,e=-1,i=1,s=-1,r=1,a=-1,n=1){super(t),this._left=e,this._right=i,this._bottom=s,this._top=r,this._near=a,this._far=n,this._window=null,this._invalidate(!0)}get window(){return this._window}set window(t){this._window=t?.slice()??null,this._invalidate(!0)}get near(){return this._near}set near(t){t!==this._near&&(this._near=t,this._invalidate(!0))}get far(){return this._far}set far(t){t!==this._far&&(this._far=t,this._invalidate(!0))}get left(){return this._left}set left(t){t!==this._left&&(this._left=t,this._invalidate(!0))}get right(){return this._right}set right(t){t!==this._right&&(this._right=t,this._invalidate(!0))}get top(){return this._top}set top(t){t!==this._top&&(this._top=t,this._invalidate(!0))}get bottom(){return this._bottom}set bottom(t){t!==this._bottom&&(this._bottom=t,this._invalidate(!0))}setPerspective(){throw new Error("setPerspective() not allowed on OrthoCamera")}setOrtho(t,e,i,s,r,a){return this._left=t,this._right=e,this._bottom=i,this._top=s,this._near=r,this._far=a,this._invalidate(!0),this}setProjectionMatrix(t){if(t!==this._projMatrix){if(!t?.isOrtho())throw new Error("OrthoCamera.setProjectionMatrix(): param is not an orthogonal projection matrix");super.setProjectionMatrix(t),this._left=t.getLeftPlane(),this._right=t.getRightPlane(),this._near=t.getNearPlane(),this._far=t.getFarPlane(),this._top=t.getTopPlane(),this._bottom=t.getBottomPlane()}}_computeProj(){let t=this._left,e=this._right,i=this._bottom,s=this._top;if(this._window){const r=e-t,a=s-i;t+=r*this._window[0],i+=a*this._window[1],e=t+r*this._window[2],s=i+a*this._window[3]}this._projMatrix.ortho(t,e,i,s,this._near,this._far),W.invert(this._projMatrix,this._invProjMatrix)}}class O_ extends df{_near;_far;_fovY;_aspect;_autoAspect;_window;constructor(t,e=Math.PI/3,i=1,s=1e3,r=1){super(t),this._fovY=e,this._aspect=r,this._near=i,this._far=s,this._autoAspect=!0,this._window=null,this._invalidate(!0)}get window(){return this._window}set window(t){this._window=t?.slice()??null,this._invalidate(!0)}get autoAspect(){return this._autoAspect}set autoAspect(t){this._autoAspect=!!t}get near(){return this._near}set near(t){t!==this._near&&(this._near=t,this._invalidate(!0))}get far(){return this._far}set far(t){t!==this._far&&(this._far=t,this._invalidate(!0))}get fovY(){return this._fovY}set fovY(t){t!==this._fovY&&(this._fovY=t,this._invalidate(!0))}get aspect(){return this._aspect}set aspect(t){t!==this._aspect&&(this._aspect=t,this._invalidate(!0))}adjustAspectRatio(){if(this._viewport)this.aspect=this._viewport[2]/this._viewport[3];else{const t=Sl().getViewport();this.aspect=t.width/t.height}}setPerspective(t,e,i,s){return this._aspect=e,this._fovY=t,this._near=i,this._far=s,this._invalidate(!0),this}setOrtho(t,e,i,s,r,a){throw new Error("setOrtho() not allowed on PerspectiveCamera")}setProjectionMatrix(t){if(t!==this._projMatrix){if(!t?.isPerspective())throw new Error("PerspectiveCamera.setProjectionMatrix(): param is not a perspective projection matrix");super.setProjectionMatrix(t),this._aspect=t.getAspect(),this._fovY=t.getFov(),this._near=t.getNearPlane(),this._far=t.getFarPlane()}}render(t){this._autoAspect&&this.adjustAspectRatio(),super.render(t)}_computeProj(){const t=this._near*Math.tan(.5*this._fovY),e=t*this._aspect;let i=-e,s=e,r=t,a=-t;if(this._window){const t=s-i,e=r-a;i+=t*this._window[0],a+=e*this._window[1],s=i+t*this._window[2],r=a+e*this._window[3]}this._projMatrix.frustum(i,s,a,r,this._near,this._far),W.invert(this._projMatrix,this._invProjMatrix)}}class k_ extends Nf{_type;_intensity;_positionRange;_directionCutoff;_diffuseIntensity;constructor(t,e){super(t),this._intensity=1,this._type=e,this._positionRange=null,this._directionCutoff=null,this._diffuseIntensity=null}get lightType(){return this._type}get intensity(){return this._intensity}set intensity(t){this.setIntensity(t)}get positionAndRange(){return this._positionRange||this.computeUniforms(),this._positionRange}get directionAndCutoff(){return this._directionCutoff||this.computeUniforms(),this._directionCutoff}get diffuseAndIntensity(){return this._diffuseIntensity||this.computeUniforms(),this._diffuseIntensity}get viewMatrix(){return this.invWorldMatrix}setIntensity(t){return this._intensity!==t&&(this._intensity=t,this.invalidateUniforms()),this}invalidateUniforms(){this._positionRange=null,this._directionCutoff=null,this._diffuseIntensity=null}isLight(){return!0}isPunctualLight(){return!1}isDirectionLight(){return!1}isPointLight(){return!1}isSpotLight(){return!1}}class U_ extends k_{_color;_castShadow;_shadowMapper;constructor(t,e){super(t,e),this._color=O.one(),this._castShadow=!1,this._shadowMapper=new o_(this)}get color(){return this._color.clone()}set color(t){this.setColor(t)}setColor(t){return this._color.set(t),this.invalidateUniforms(),this}get castShadow(){return this._castShadow}set castShadow(t){this.setCastShadow(t)}setCastShadow(t){return this._castShadow=t,this}get shadow(){return this._shadowMapper}isPunctualLight(){return!0}_onTransformChanged(t){super._onTransformChanged(t),this.invalidateUniforms()}computeUniforms(){}}class G_ extends U_{static _currentSunLight=new WeakMap;constructor(t){super(t,1),this.intensity=10,G_.getSunLight(t)||G_.setSunLight(t,this)}static getSunLight(t){return this._currentSunLight.get(t)?.get()??null}static setSunLight(t,e){if(e&&t!==e.scene)throw new Error("setSunLight(): Light does not belongs to scene");const i=this._currentSunLight.get(t);i?i.set(e):this._currentSunLight.set(t,new St(e))}get sunLight(){return G_.getSunLight(this.scene)===this}set sunLight(t){t?G_.setSunLight(this.scene,this):G_.getSunLight(this.scene)===this&&G_.setSunLight(this.scene,null)}isDirectionLight(){return!0}computeBoundingVolume(){return null}computeUniforms(){const t=this.worldMatrix.getRow(3),e=this.worldMatrix.getRow(2).scaleBy(-1);this._positionRange=new O(t.x,t.y,t.z,-1),this._directionCutoff=new O(e.x,e.y,e.z,0),this._diffuseIntensity=new O(this.color.x,this.color.y,this.color.z,this.intensity)}}class H_ extends U_{_range;constructor(t){super(t,2),this._range=10,this.invalidateBoundingVolume()}get range(){return this._range}set range(t){this.setRange(t)}setRange(t){return t=t<0?0:t,this._range!==t&&(this._range=t,this.invalidateUniforms(),this.invalidateBoundingVolume()),this}isPointLight(){return!0}computeBoundingVolume(){const t=new hu;return t.minPoint=new z(-this._range,-this._range,-this._range),t.maxPoint=new z(this._range,this._range,this._range),t}computeUniforms(){const t=this.worldMatrix.getRow(3),e=this.worldMatrix.getRow(2);this._positionRange=new O(t.x,t.y,t.z,this.range),this._directionCutoff=new O(e.x,e.y,e.z,-1),this._diffuseIntensity=new O(this.color.x,this.color.y,this.color.z,this.intensity)}}class W_ extends U_{_range;_cutoff;constructor(t){super(t,3),this._range=10,this._cutoff=Math.cos(Math.PI/4),this.invalidateBoundingVolume()}get range(){return this._range}set range(t){this.setRange(t)}setRange(t){return t=t<0?0:t,this._range!==t&&(this._range=t,this.invalidateUniforms(),this.invalidateBoundingVolume()),this}get cutoff(){return this._cutoff}set cutoff(t){this.setCutoff(t)}setCutoff(t){return t=t<0?0:t,this._cutoff!==t&&(this._cutoff=t,this.invalidateUniforms(),this.invalidateBoundingVolume()),this}isSpotLight(){return!0}computeBoundingVolume(){const t=new hu,e=Math.cos(this._cutoff),i=this._range/e*Math.sqrt(1-e*e);return t.minPoint=new z(-i,-i,0),t.maxPoint=new z(i,i,this._range),t}computeUniforms(){const t=this.worldMatrix.getRow(3),e=this.worldMatrix.getRow(2).scaleBy(-1);this._positionRange=new O(t.x,t.y,t.z,this.range),this._directionCutoff=new O(e.x,e.y,e.z,this.cutoff),this._diffuseIntensity=new O(this.color.x,this.color.y,this.color.z,this.intensity)}}class X_{_resX;_resY;_spacingX;_spacingZ;_leafSize;_heights;_rootNode;constructor(t,e,i,s,r){this._rootNode=null,this._leafSize=16,this._spacingX=i,this._spacingZ=s,this._resX=t,this._resY=e,this._heights=new Float32Array(r)}create(){return this._rootNode=this.allocNode(),this.createChildNode(this._rootNode,0,0,this._resX-1,this._resY-1),!0}getHeight(t,e){return this._heights[(this._resY-1-e)*this._resX+t]}getNormal(t,e,i){i=i??new z,t=Math.max(0,Math.min(t,this._resX-2)),e=Math.max(0,Math.min(e,this._resY-2));const s=this._heights[t+e*this._resX],r=this._heights[t+(e+1)*this._resX],a=this._heights[t+1+(e+1)*this._resX],n=this._heights[t+1+e*this._resX],o=.5*(s+r-a-n),h=.5*(s+n-r-a),l=this._spacingX,u=this._spacingZ;return i.setXYZ(o*u,2*l*u,-h*l).inplaceNormalize(),i}getRealNormal(t,e,i){i=i??new z;const s=t/this._spacingX,r=e/this._spacingZ;let a=Math.floor(s),n=Math.floor(r),o=a+1,h=n+1;a<0&&(a=0),n<0&&(n=0),o>=this._resX&&(o=this._resX-1),h>=this._resY&&(h=this._resY-1);const l=this.getNormal(a,n),u=this.getNormal(a,h),c=this.getNormal(o,n),d=this.getNormal(o,h);return l.addBy(u).addBy(c).addBy(d).scaleBy(.25).inplaceNormalize(),i.set(l),i}getRealHeight(t,e){const i=t/this._spacingX,s=e/this._spacingZ,r=Math.floor(i),a=Math.floor(s),n=r+1,o=a+1;if(r<0||a<0||n>=this._resX||o>=this._resY)return 0;if(r===n){if(a===o)return this.getHeight(r,a);{const t=this.getHeight(r,a);return t+(this.getHeight(r,o)-t)*(s-a)}}{const t=this.getHeight(r,a),e=t+(this.getHeight(n,a)-t)*(i-r);if(a===o)return e;{const t=this.getHeight(r,o);return e+(t+(this.getHeight(n,o)-t)*(i-r)-e)*(s-a)}}}getHeights(){return this._heights}allocNode(){return{bbox:new hu,rc:{x:0,y:0,w:0,h:0},left:null,right:null}}computeNodeBoundingBox(t,e,i){e.beginExtend();for(let s=0;s<t.rc.w;s++)for(let r=0;r<t.rc.h;r++){const a=i[t.rc.x+s+(t.rc.y+r)*this._resX];e.extend3(a.x,a.y,a.z)}}createChildNode(t,e,i,s,r){if(t.rc.x=e,t.rc.y=i,t.rc.w=s,t.rc.h=r,s<=this._leafSize&&r<=this._leafSize){t.left=null,t.right=null;let a=1/0,n=-1/0;for(let t=e;t<=e+s;t++)for(let e=i;e<=i+r;e++){const i=this.getHeight(t,e);i>n&&(n=i),i<a&&(a=i)}t.bbox=new hu(new z(e*this._spacingX,a,i*this._spacingZ),new z((e+s)*this._spacingX,n,(i+r)*this._spacingZ))}else{if(s>=r){const a=s>>1,n=s-a;t.left=this.allocNode(),this.createChildNode(t.left,e,i,a,r),t.right=this.allocNode(),this.createChildNode(t.right,e+a,i,n,r)}else{const a=r>>1,n=r-a;t.left=this.allocNode(),this.createChildNode(t.left,e,i,s,a),t.right=this.allocNode(),this.createChildNode(t.right,e,i+a,s,n)}t.bbox.beginExtend(),t.bbox.extend(t.left.bbox.minPoint),t.bbox.extend(t.left.bbox.maxPoint),t.bbox.extend(t.right.bbox.minPoint),t.bbox.extend(t.right.bbox.maxPoint)}return!0}rayIntersect(t){return this.rayIntersectRecursive(t)}rayIntersectDDA(t,e,i,s,r){let a=t.origin.x,n=t.origin.z,o=t.direction.x,h=t.direction.z;const l=this._spacingX,u=this._spacingZ,c=.001;let d=0,p=0;const m=e*l,f=m+s*l,_=i*u,g=_+r*u;let x=!1,b=!1;if(o<0&&(o=-o,a+=2*((m+f)/2-a),x=!0),h<0&&(h=-h,n+=2*((_+g)/2-n),b=!0),a<m)d=(m-a)/o;else if(a>f)return;if(n<_)p=(_-n)/h;else if(n>g)return;const v=d>p?d:p;a+=v*o,n+=v*h;let y=Math.floor((a-m+c)/l),T=Math.floor((n-_+c)/u);for(;y>=0&&y<=s&&T>=0&&T<=r;){if(y<s&&T<r){const a=e+(x?s-y-1:y),n=i+(b?r-T-1:T),o=new z(a*this._spacingX,this.getHeight(a,n),n*this._spacingZ),h=new z((a+1)*this._spacingX,this.getHeight(a+1,n),n*this._spacingZ),l=new z((a+1)*this._spacingX,this.getHeight(a+1,n+1),(n+1)*this._spacingZ),u=new z(a*this._spacingX,this.getHeight(a,n+1),(n+1)*this._spacingZ);let c=!1,d=t.intersectionTestTriangle(o,h,u,!1);null!==d&&d>0?c=!0:d=Number.MAX_VALUE;let p=t.intersectionTestTriangle(u,h,l,!1);if(null!==p&&p>0?c=!0:p=Number.MAX_VALUE,c)return d<p?d:p}let d=1/0;if(o>0){const t=(y+e+1)*l;d=Math.min(d,(t-a)/o)}if(0!==h){const t=(T+i+1)*u;d=Math.min(d,(t-n)/h)}a+=d*o,n+=d*h,y=Math.floor((a-m+c)/l),T=Math.floor((n-_+c)/u)}return null}rayIntersectLeaf(t,e){return this.rayIntersectDDA(t,e.rc.x,e.rc.y,e.rc.w,e.rc.h)}rayIntersectRecursive(t){if(!this._rootNode)return this.rayIntersectDDA(t,0,0,this._resX-1,this._resY-1);const e=[this._rootNode];for(;e.length>0;){const i=e.shift();if(i.left){const s=t.bboxIntersectionTestEx(i.left.bbox),r=t.bboxIntersectionTestEx(i.right.bbox);null!==s&&null!==r?s<r?(e.unshift(i.right),e.unshift(i.left)):(e.unshift(i.left),e.unshift(i.right)):null!==s?e.unshift(i.left):null!==r&&e.unshift(i.right)}else{const e=this.rayIntersectLeaf(t,i);if(null!==e)return e}}return null}}class j_{m_v4Range;m_scale;m_sizeX;m_sizeZ;m_bboxTree;m_normals;m_boundingBox;constructor(){this.m_v4Range=O.zero(),this.m_bboxTree=null,this.m_scale=z.one(),this.m_sizeX=0,this.m_sizeZ=0,this.m_normals=null,this.m_boundingBox=null}init(t,e,i,s){const r=[];let a=1/0,n=-1/0;for(let o=0;o<e;++o){const h=o*t,l=(e-o-1)*t;for(let e=0;e<t;++e){const t=s[h+e]*i.y;r[l+e]=t,t>n&&(n=t),t<a&&(a=t)}}return this.m_bboxTree=new X_(t,e,i.x,i.z,r),this.m_boundingBox=new hu(new z(0,a,0),new z((t-1)*i.x,n,(e-1)*i.z)),this.m_v4Range.setXYZW(0,0,(t-1)*i.x,(e-1)*i.z),this.m_scale.set(i),this.m_sizeX=t,this.m_sizeZ=e,this.m_normals=this.computeNormalVectors(),!0}get normals(){return this.m_normals}clear(){this.m_bboxTree=null,this.m_v4Range.setXYZW(0,0,0,0),this.m_scale.setXYZ(1,1,1),this.m_sizeX=0,this.m_sizeZ=0}rayIntersect(t){return this.m_bboxTree.rayIntersect(t)}computeNormals(){const t=this.m_scale.x,e=this.m_scale.z,i=this.getHeights(),s=new z,r=new Uint8Array((this.m_sizeZ-1)*(this.m_sizeX-1)*4);for(let a=0;a<this.m_sizeZ-1;++a)for(let n=0;n<this.m_sizeX-1;++n){const o=i[n+a*this.m_sizeX],h=i[n+(a+1)*this.m_sizeX],l=i[n+1+(a+1)*this.m_sizeX],u=i[n+1+a*this.m_sizeX],c=.5*(o+h-l-u),d=.5*(o+u-h-l),p=n+(this.m_sizeZ-2-a)*(this.m_sizeX-1);s.setXYZ(c*e,2*t*e,-d*t).inplaceNormalize(),r[4*p+0]=Math.floor(255*(.5*s.x+.5)),r[4*p+1]=Math.floor(255*(.5*s.y+.5)),r[4*p+2]=Math.floor(255*(.5*s.z+.5)),r[4*p+3]=255}return r}computeNormalVectors(){const t=this.m_scale.x,e=this.m_scale.z,i=this.getHeights(),s=[];for(let r=0;r<this.m_sizeZ;++r)for(let a=0;a<this.m_sizeX;++a){const n=i[a+r*this.m_sizeX],o=a>0&&r>0?i[a-1+(r-1)*this.m_sizeX]:n,h=r>0&&r<this.m_sizeZ-1?i[a-1+(r+1)*this.m_sizeX]:n,l=a<this.m_sizeX-1&&r<this.m_sizeZ-1?i[a+1+(r+1)*this.m_sizeX]:n,u=a<this.m_sizeX-1&&r>0?i[a+1+(r-1)*this.m_sizeX]:n,c=.5*(o+h-l-u),d=.5*(o+u-h-l);s[a+(this.m_sizeZ-1-r)*this.m_sizeX]=new z(c*e,2*t*e,-d*t).inplaceNormalize()}return s}getBBoxTree(){return this.m_bboxTree}getSpacingX(){return this.m_scale.x}getSpacingZ(){return this.m_scale.z}getVerticalScale(){return this.m_scale.y}getSizeX(){return this.m_sizeX}getSizeZ(){return this.m_sizeZ}getOffsetX(){return this.m_v4Range.x}getOffsetZ(){return this.m_v4Range.y}getBoundingbox(){return this.m_boundingBox}getHeights(){return this.m_bboxTree?.getHeights()||null}getHeight(t,e){return this.m_bboxTree?this.m_bboxTree.getHeight(t,e):0}getRealHeight(t,e){return this.m_bboxTree?this.m_bboxTree.getRealHeight(t,e):0}getRealNormal(t,e,i){i=i??new z;const s=t/this.m_scale.x,r=e/this.m_scale.z;let a=Math.floor(s),n=Math.floor(r),o=a+1,h=n+1;return a<0&&(a=0),n<0&&(n=0),o>=this.m_sizeX&&(o=this.m_sizeX-1),h>=this.m_sizeZ&&(h=this.m_sizeZ-1),i.set(this.m_normals[a+n*this.m_sizeX]),i.addBy(this.m_normals[o+n*this.m_sizeX]),i.addBy(this.m_normals[o+h*this.m_sizeX]),i.addBy(this.m_normals[a+h*this.m_sizeX]),i.scaleBy(.4).inplaceNormalize(),i}}class Q_ extends gt{_patch;_grassClusters;_parent;_children;constructor(){super(),this._patch=null,this._grassClusters=[],this._parent=null,this._children=null}get grassClusters(){return this._grassClusters}addGrassCluster(t){this._grassClusters.push(t)}initialize(t,e,i,s,r,a,n,o){if(this._parent=e,this._children=[],this._patch=new C_(t.terrain),!this._patch.initialize(t,this._parent?._patch||null,i,s,r,a,n,o))return!1;if(this._patch.getStep()>1){let e=null;const i=(t.getPatchSize()-1)*(this._patch.getStep()>>1),s=this._patch.getOffsetX(),h=this._patch.getOffsetZ(),l=[[s,h],[s+i,h],[s,h+i],[s+i,h+i]],u=t.getRootSizeX()-1,c=t.getRootSizeZ()-1;for(let i=0;i<4;++i)if(l[i][0]>=u||l[i][1]>=c)this._children[i]=null;else{if(this._children[i]=new Q_,!this._children[i].initialize(t,this,1&i,i>>1,r,a,n,o))return!1;const s=this._children[i]._patch.getBoundingBox();s&&(e||(e=new hu,e.beginExtend()),e.extend(s.minPoint),e.extend(s.maxPoint))}this._patch.setBoundingBox(e)}return!0}setupCamera(t,e,i){this._patch&&!this._patch.isDummy()&&this._patch.setupCamera(t,e,i);for(let s=0;s<4;++s)this._children[s]&&this._children[s].setupCamera(t,e,i)}getBoundingbox(){return this._patch.getBoundingBox()}getPatch(){return this._patch}getParent(){return this._parent}getChild(t){return this._children[t]}onDispose(){super.onDispose(),this._patch?.dispose()}}class q_ extends gt{_baseVertices;_indices;_indicesWireframe;_normalMap;_scaleX;_scaleZ;_patchSize;_rootSizeX;_rootSizeZ;_rootSize;_primitiveCount;_primitiveType;_rootNode;_terrain;_heightField;constructor(t){super(),this._terrain=t,this._baseVertices=null,this._indices=new wt,this._indicesWireframe=new wt,this._normalMap=new wt,this._scaleX=1,this._scaleZ=1,this._patchSize=0,this._rootSizeX=0,this._rootSizeZ=0,this._rootSize=0,this._heightField=null,this._rootNode=null,this._primitiveCount=0,this._primitiveType="triangle-strip"}get normalMap(){return this._normalMap.get()}get rootNode(){return this._rootNode}get terrain(){return this._terrain}build(t,e,i,s,r,a){if(!E(t-1)||(e-1)%(t-1)||(i-1)%(t-1)||!s)return!1;if(this._heightField=new j_,!this._heightField.init(e,i,r,s))return this._heightField=null,!1;const n=Sl();this._patchSize=t,this._rootSizeX=e,this._rootSizeZ=i,this._rootSize=M(Math.max(e-1,i-1))+1,this._scaleX=r.x,this._scaleZ=r.z;const o=t+2,h=new Float32Array(o*o*3);let l=0;h[0]=0,h[1]=0,h[2]=0;for(let t=1;t<o-1;++t)h[3*t+0]=t-1,h[3*t+1]=0,h[3*t+2]=0;h[3*(o-1)+0]=o-3,h[3*(o-1)+1]=0,h[3*(o-1)+2]=0,l+=3*o;for(let t=1;t<o-1;++t,l+=3*o){h[l+0]=0,h[l+1]=0,h[l+2]=t-1;for(let e=1;e<o-1;++e)h[l+3*e+0]=e-1,h[l+3*e+1]=0,h[l+3*e+2]=t-1;h[l+3*(o-1)+0]=o-3,h[l+3*(o-1)+1]=0,h[l+3*(o-1)+2]=t-1}h[l+0]=0,h[l+1]=0,h[l+2]=o-3;for(let t=1;t<o-1;++t)h[l+3*t+0]=t-1,h[l+3*t+1]=0,h[l+3*t+2]=o-3;h[l+3*(o-1)+0]=o-3,h[l+3*(o-1)+1]=0,h[l+3*(o-1)+2]=o-3,this._baseVertices=h;const u=this.strip(a);this._indices.set(n.createIndexBuffer(u,{managed:!0}));const c=this.line(u);this._indicesWireframe.set(n.createIndexBuffer(c,{managed:!0})),this._primitiveCount=u.length-2,this._primitiveType="triangle-strip",this._rootNode=new Q_;const d=this._heightField.normals,p=new Uint8Array(4*d.length);for(let t=0;t<d.length;t++){const e=d[t];p[4*t+0]=Math.floor(255*(.5*e.x+.5)),p[4*t+1]=Math.floor(255*(.5*e.y+.5)),p[4*t+2]=Math.floor(255*(.5*e.z+.5)),p[4*t+3]=255}return this._normalMap.set(n.createTexture2D("rgba8unorm",e,i,{mipmapping:!1})),this._normalMap.get().name=`TerrainNormalMap-${this._normalMap.get().uid}`,this._normalMap.get().update(p,0,0,this._normalMap.get().width,this._normalMap.get().height),this._rootNode.initialize(this,null,0,0,this._baseVertices,d,r.y,s)}strip(t){const e=this._patchSize+2,i=(t>>1)-1,s=[];for(let t=0;t<e-1;t+=i){const r=t,a=t+i>e-1?e-1:t+i;for(let t=0;t<e-1;++t){for(let i=r;i<=a;++i)s.push((e-1-i)*e+t),s.push((e-1-i)*e+t+1);s.push((e-1-a)*e+t+1),s.push(t==e-2?(e-1-a)*e:(e-1-r)*e+t+1)}}return s.length=s.length-2,new Uint16Array(s)}line(t){const e=t.length-2,i=[];let s,r,a,n=!0;for(let o=0;o<e;o++){o%2==0?(s=t[o],r=t[o+1],a=t[o+2]):(s=t[o+1],r=t[o],a=t[o+2]);const e=s===r||s===a||r===a;e||(n&&i.push(s,r),i.push(r,a,a,s)),n=e}return new Uint16Array(i)}setupCamera(t,e,i){this._rootNode?.setupCamera(t,e,i)}getBoundingBox(t){this._heightField?(t.minPoint=this._heightField.getBoundingbox().minPoint,t.maxPoint=this._heightField.getBoundingbox().maxPoint):(t.minPoint=z.zero(),t.maxPoint=z.zero())}getPatchSize(){return this._patchSize}getRootSize(){return this._rootSize}getRootSizeX(){return this._rootSizeX}getRootSizeZ(){return this._rootSizeZ}getTerrain(){return this._terrain}getElevations(){return this._heightField?.getHeights()||null}getScaleX(){return this._scaleX}getScaleZ(){return this._scaleZ}getIndices(){return this._indices.get()}getIndicesWireframe(){return this._indicesWireframe.get()}getPrimitiveCount(){return this._primitiveCount}getPrimitiveType(){return this._primitiveType}getHeightField(){return this._heightField}cull(t,e,i){if(this._rootNode&&this._terrain){const s=new Q(W.multiply(t.camera.viewProjectionMatrix,i));return this.cull_r(t,this._rootNode,e,i,s,t.frustumCulling,!1)}return 0}cull_r(t,e,i,s,r,a,n){const o=t.camera,h=e.getBoundingbox();let l,u=0;if(a){if(l=o.clipMask?h.getClipStateWithFrustumMask(r,o.clipMask):h.getClipStateWithFrustum(r),l===$.NOT_CLIPPED)return u;l===$.A_INSIDE_B&&(a=!1)}else l=$.A_INSIDE_B;if(!n){const s=e.getPatch().isDummy()?-1:e.getPatch().getLODDistance(),r=s>=0?s*s:Number.MAX_VALUE;((s>=0?e.getPatch().sqrDistanceToPoint(i):0)>=r||!e.getChild(0))&&(e.getPatch().isDummy()||(t.push(o,e.getPatch()),n=!0,u=1))}if(e.grassClusters.length>0&&1!==t.renderPass.type)for(const i of e.grassClusters)t.push(o,i);for(let o=0;o<4;o++){const h=e.getChild(o);h&&(u+=this.cull_r(t,h,i,s,r,a,n))}return u}onDispose(){if(super.onDispose(),this._rootNode){const t=[this._rootNode];for(;t.length>0;){const e=t.shift();if(e){for(let i=0;i<4;i++){const s=e.getChild(i);s&&t.push(s)}e.dispose()}}this._rootNode=null}this._indices?.dispose(),this._indices=null,this._indicesWireframe?.dispose(),this._indicesWireframe=null,this._normalMap?.dispose(),this._normalMap=null}}class Y_ extends Nf{_quadtree;_grassManager;_maxPixelError;_maxPixelErrorDirty;_lodCamera;_heightFieldScale;_patchSize;_lastTanHalfFOVY;_width;_height;_material;_viewPoint;_castShadow;constructor(t){super(t),this._quadtree=new wt,this._grassManager=new wt,this._maxPixelError=10,this._maxPixelErrorDirty=!0,this._lodCamera=null,this._heightFieldScale=z.one(),this._patchSize=33,this._lastTanHalfFOVY=0,this._width=0,this._height=0,this._material=null,this._viewPoint=null,this._castShadow=!0}async clone(){return console.error("Cloning terrain not implemented"),null}get quadtree(){return this._quadtree.get()}getName(){return this._name}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=!!t}get maxPixelError(){return this._maxPixelError}set maxPixelError(t){t!==this._maxPixelError&&(this._maxPixelError=t,this._maxPixelErrorDirty=!0)}get LODCamera(){return this._lodCamera}set LODCamera(t){this._lodCamera=t}get scaledWidth(){return this._width*this._heightFieldScale.x}get scaledHeight(){return this._height*this._heightFieldScale.z}get heightFieldScale(){return this._heightFieldScale}get patchSize(){return this._patchSize}get width(){return this._width}get height(){return this._height}get material(){return this._material}get normalMap(){return this._quadtree.get()?.normalMap??null}create(t,e,i,s,r,a){if(this._quadtree.set(new q_(this)),a?.splatMap&&"rgba8unorm"!==a.splatMap.format)throw new Error("SplatMap must be rgba8unorm format");if(this._material=new xd(a),!this._quadtree.get().build(r,t,e,i,s,24))return this._quadtree.dispose(),!1;if(this._patchSize=r,this._heightFieldScale.set(s),this._width=t,this._height=e,this._material.normalTexture=this._quadtree.get().normalMap,this._material.normalTexCoordIndex=-1,this._material.terrainInfo=new O(this.scaledWidth,this.scaledHeight,0,0),this.invalidateBoundingVolume(),a?.splatMap&&a?.detailMaps?.grass&&a.detailMaps.grass.findIndex(t=>t&&t.findIndex(t=>!!t)>=0)>=0){const t=a.splatMap,e=new Uint8Array(t.width*t.height*4);t.readPixels(0,0,t.width,t.height,0,0,e).then(()=>{for(let i=0;i<4;i++)if(a.detailMaps.grass[i])for(const s of a.detailMaps.grass[i])if(s){const r=s.density??1,a=s.bladeWidth??4,n=s.bladeHeigh??2,o=s.offset??0,h=s.texture??null,l=[];for(let s=0;s<t.height;s++){const a=[];for(let n=0;n<t.width;n++){const o=e[4*s*t.width+4*n+i]/255;a.push(o*r)}l.push(a)}this.createGrass(l,a,n,o,h)}})}return!0}createGrass(t,e,i,s,r){this._grassManager.get()||this._grassManager.set(new B_(64,t)),this._grassManager.get().addGrassLayer(Sl(),this,t,e,i,s,r)}getElevation(t,e){return this._quadtree.get().getHeightField().getRealHeight(t,e)}getNormal(t,e,i){return this._quadtree.get().getHeightField().getRealNormal(t,e,i)}rayIntersect(t){return this._quadtree.get().getHeightField().rayIntersect(t)}computeBoundingVolume(){return this._quadtree.get()?.getHeightField().getBoundingbox()}traverseQuadtree(t){this._quadtree.get().rootNode&&function e(i){t(i);for(let t=0;t<4;t++){const s=i.getChild(t);s&&e(s)}}(this._quadtree.get().rootNode)}cull(t){const e=t.primaryCamera.getTanHalfFovy();(e!==this._lastTanHalfFOVY||this._maxPixelErrorDirty)&&(this._maxPixelErrorDirty=!1,this._lastTanHalfFOVY=e,this._quadtree.get().setupCamera(1024,e,this._maxPixelError));const i=t.primaryCamera.getWorldPosition();return this._viewPoint=this.invWorldMatrix.transformPointAffine(i),this._quadtree.get().cull(t,this._viewPoint,this.worldMatrix)}isTerrain(){return!0}onDispose(){super.onDispose(),this._grassManager.dispose(),this._material?.dispose(),this._quadtree.dispose()}}const Z_=new Map;function K_(t){let e=Z_.get(t);if(!e){class i{material;materialId;constructor(t){this.material=t,this.materialId=wl().resourceManager.getAssetId(t.coreMaterial)??""}}const s={ctor:i,name:`${t.name}InstanceUniforms`,async createFunc(t,e){const s=await wl().resourceManager.fetchMaterial(e);return{obj:new i(s.createInstance())}},getInitParams:t=>t.materialId,getProps:()=>t.INSTANCE_UNIFORMS.filter(t=>!!t.name).map(t=>({name:t.name,type:t.type,get(e){const i=this.material[t.prop];"float"===t.type?e.num[0]=i:"vec2"===t.type?(e.num[0]=i.x,e.num[1]=i.y):"vec3"===t.type||"rgb"===t.type?(e.num[0]=i.x,e.num[1]=i.y,e.num[2]=i.z):"vec4"!==t.type&&"rgba"!==t.type||(e.num[0]=i.x,e.num[1]=i.y,e.num[2]=i.z,e.num[3]=i.w)},set(e){"float"===t.type?this.material[t.prop]=e.num[0]:"vec2"===t.type?this.material[t.prop]=new L(e.num[0],e.num[1]):"vec3"===t.type||"rgb"===t.type?this.material[t.prop]=new z(e.num[0],e.num[1],e.num[2]):"vec4"!==t.type&&"rgba"!==t.type||(this.material[t.prop]=new O(e.num[0],e.num[1],e.num[2],e.num[3]))}}))};e={C:i,S:s},Z_.set(t,e)}return e.S}class J_ extends cu{_state;_interpolator;constructor(t,e,i){if(void 0===t)super(!1),this._interpolator=null;else if(t instanceof ot){if("vec3"!==t.target)throw new Error("TranslationTrack(): interpolator target must be 'vec3'");super(e??!1),this._interpolator=t}else{const s=e,r=new Float32Array(s.map(t=>t.time)),a=new Float32Array(3*s.length);for(let t=0;t<s.length;t++)a[3*t+0]=s[t].value.x,a[3*t+1]=s[t].value.y,a[3*t+2]=s[t].value.z;super(i??!1),this._interpolator=new ot(t,"vec3",r,a)}this._state=new z,this._jointIndex=-1}get interpolator(){return this._interpolator}set interpolator(t){if(t&&"vec3"!==t.target)throw new Error("TranslationTrack(): interpolator target must be 'vec3'");this._interpolator=t??null}calculateState(t,e){return this._interpolator.interpolate(e,this._state),this._state}applyState(t,e){t.position.set(e)}mixState(t,e,i){return new z(t.x+i*(e.x-t.x),t.y+i*(e.y-t.y),t.z+i*(e.z-t.z))}getBlendId(){return"node-translation"}getDuration(){return this._interpolator.maxTime}}class tg extends cu{_state;_interpolator;constructor(t,e,i){if(void 0===t)super(!1),this._interpolator=null;else if(t instanceof ot){if("quat"!==t.target)throw new Error("RotationTrack(): interpolator target must be 'quat'");super(e??!1),this._interpolator=t}else{const s=e,r=new Float32Array(s.map(t=>t.time)),a=new Float32Array(4*s.length);for(let t=0;t<s.length;t++)a[4*t+0]=s[t].value.x,a[4*t+1]=s[t].value.y,a[4*t+2]=s[t].value.z,a[4*t+3]=s[t].value.w;super(i??!1),this._interpolator=new ot(t,"quat",r,a)}this._state=new U}get interpolator(){return this._interpolator}set interpolator(t){if(t&&"quat"!==t.target)throw new Error("RotationTrack(): interpolator target must be 'quat'");this._interpolator=t??null}calculateState(t,e){return this._interpolator.interpolate(e,this._state),this._state}applyState(t,e){t.rotation.set(e)}mixState(t,e,i){return U.slerp(t,e,i)}getBlendId(){return"node-rotation"}getDuration(){return this._interpolator.maxTime}}class eg extends cu{_state;_interpolator;constructor(t,e,i){if(void 0===t)super(!1),this._interpolator=null;else if(t instanceof ot){if("vec3"!==t.target)throw new Error("ScaleTrack(): interpolator target must be 'vec3'");super(e??!1),this._interpolator=t}else{const s=e,r=new Float32Array(s.map(t=>t.time)),a=new Float32Array(3*s.length);for(let t=0;t<s.length;t++)a[3*t+0]=s[t].value.x,a[3*t+1]=s[t].value.y,a[3*t+2]=s[t].value.z;super(i??!1),this._interpolator=new ot(t,"vec3",r,a)}this._state=new z}get interpolator(){return this._interpolator}set interpolator(t){if(t&&"vec3"!==t.target)throw new Error("ScaleTrack(): interpolator target must be 'vec3'");this._interpolator=t??null}calculateState(t,e){return this._interpolator.interpolate(e,this._state),this._state}applyState(t,e){t.scale.set(e)}mixState(t,e,i){return new z(t.x+i*(e.x-t.x),t.y+i*(e.y-t.y),t.z+i*(e.z-t.z))}getBlendId(){return"node-scale"}getDuration(){return this._interpolator.maxTime}}class ig{parent;name;constructor(t){if(this.parent=t,!this.parent||this.parent instanceof og)this.name="";else for(let t=1;;t++){const e=`field${t}`;if(!this.parent.value.find(t=>t?.name===e)){this.name=e;break}}}}class sg extends ig{value;constructor(t,e=""){super(t),this.value=e}}class rg extends ig{value;constructor(t,e=0){super(t),this.value=e}}class ag extends ig{value;constructor(t,e=!1){super(t),this.value=e}}class ng extends ig{value;data;isnull;isundefined;constructor(t,e={}){super(t),this.updateObject(e)}updateObject(t){this.value=[],this.data=t,this.isnull=null===this.data,this.data&&this.parseObject()}parseObject(){for(const t of Object.keys(this.data)){const e=this.data[t];let i;if("string"==typeof e)i=new sg(this,e);else if("number"==typeof e)i=new rg(this,e);else if("boolean"==typeof e)i=new ag(this,e);else{if("object"!=typeof e)continue;i=Array.isArray(e)?new og(this,e):new ng(this,e)}i.name=t,this.value.push(i)}}updateProps(){for(const t of Object.keys(this.data))delete this.data[t];for(const t of this.value)this.data[t.name]=t instanceof ng?t.data:t.value;return this.data}}class og extends ng{constructor(t,e=[]){super(t),this.updateObject(e)}updateObject(t){this.value=[],this.data=t,this.isnull=null===this.data,this.data&&this.parseObject()}parseObject(){const t=this.data;if(t?.length>0)for(let e=0;e<t.length;e++){const i=t[e];let s;if("string"==typeof i)s=new sg(this,i);else if("number"==typeof i)s=new rg(this,i);else if("boolean"==typeof i)s=new ag(this,i);else{if("object"!=typeof i)continue;s=i?Array.isArray(i)?new og(this,i):new ng(this,i):null}this.value.push(s)}}updateProps(){const t=this.data;t.splice(0,t.length);for(let t=0;t<this.value.length;t++){const e=this.value[t];this.data[t]=e instanceof og||e instanceof ng?e.data:e?.value??null}return this.data}}function hg(t){return{ctor:Au,name:"SceneNode",async createFunc(e,i){const s=e instanceof Df?e:e.scene;if(i){const r=g((await t.loadPrefabContent(i.prefabId)).data,i.patch),a=new wt(new Au(s));a.get().remove(),a.get().prefabId=i.prefabId;const n=await t.deserializeObject(a.get(),r);return n.prefabId=i.prefabId,n.parent=e instanceof Au?e:e.rootNode,a.dispose(),{obj:n,loadProps:!1}}const r=new Au(s);return e instanceof Au&&(r.parent=e),{obj:r}},async getInitParams(i,s){const r=i.prefabId;let a;if(r){try{i.prefabId="";const s=(await t.loadPrefabContent(r)).data,n=await t.serializeObject(i);a=c(s,n),e(0===c(g(s,a),n).length,"Patch test failed")}finally{i.prefabId=r}s.saveProps=!1}return r?{prefabId:r,patch:a}:null},getProps:()=>[{name:"Id",type:"string",get(t){t.str[0]=this.persistentId},set(t){this.persistentId=t.str[0]}},{name:"PrefabId",type:"string",isHidden:()=>!0,get(t){t.str[0]=this.prefabId}},{name:"Name",type:"string",defaultValue:"",get(t){t.str[0]=this.name},set(t){this.name=t.str[0]}},{name:"Position",type:"vec3",options:{animatable:!0},isPersistent(){return"animated"!==this.jointTypeT},get(t){t.num[0]=this.position.x,t.num[1]=this.position.y,t.num[2]=this.position.z},set(t){this.position.setXYZ(t.num[0],t.num[1],t.num[2])}},{name:"Scale",type:"vec3",options:{animatable:!0},isPersistent(){return"animated"!==this.jointTypeS},get(t){t.num[0]=this.scale.x,t.num[1]=this.scale.y,t.num[2]=this.scale.z},set(t){this.scale.setXYZ(t.num[0],t.num[1],t.num[2])}},{name:"Rotation",type:"vec3",options:{animatable:!0,edit:"quaternion"},isPersistent:()=>!1,get(t){const e=this.rotation.toEulerAngles();t.num[0]=Math.round(A(e.x)),t.num[1]=Math.round(A(e.y)),t.num[2]=Math.round(A(e.z))},set(t){this.rotation.fromEulerAngle(S(t.num[0]),S(t.num[1]),S(t.num[2]))}},{name:"QuatRotation",type:"vec4",isHidden:()=>!0,isPersistent(){return"animated"!==this.jointTypeR},get(t){t.num[0]=this.rotation.x,t.num[1]=this.rotation.y,t.num[2]=this.rotation.z,t.num[3]=this.rotation.w},set(t){this.rotation.setXYZW(t.num[0],t.num[1],t.num[2],t.num[3])}},{name:"Pickable",type:"bool",default:!1,get(t){t.bool[0]=this.pickable},set(t){this.pickable=t.bool[0]}},{name:"Visible",type:"string",default:"inherit",options:{enum:{labels:["Visible","Hidden","Inherit"],values:["visible","hidden","inherit"]}},get(t){t.str[0]=this.showState},set(t){this.showState=t.str[0]}},{name:"Children",type:"object_array",phase:0,isHidden:()=>!0,get(t){t.object=[];for(const e of this.children)e.get().sealed||t.object.push(e.get())},set(t){for(let e=this.children.length-1;e>=0;e--){const i=this.children[e].get();t.object.includes(i)||i.sealed||i.remove()}for(const e of t.object)e instanceof Au?e.parent=this:console.error(`Invalid scene node: ${e}`)}},{name:"Animations",type:"object_array",phase:2,readonly:!0,options:{objectTypes:[lu]},get(t){const e=this.animationSet;t.object=e.getAnimationNames().map(t=>e.getAnimationClip(t))},set(e){for(const i of e.object){const e=i;for(const t of e.tracks)for(const i of t[1])i.embedded||(e.addTrack(t[0],i),t[0]instanceof Au&&(i instanceof J_?t[0].jointTypeT="animated":i instanceof eg?t[0].jointTypeS="animated":i instanceof tg&&(t[0].jointTypeR="animated")));!t.editorMode&&e.autoPlay&&this.animationSet.playAnimation(e.name,{repeat:0})}},delete(t){const e=this.animationSet,i=e.getAnimationNames()[t];e.getAnimationClip(i)&&e.deleteAnimation(i)}},{name:"Skeletons",type:"object_array",phase:1,isHidden:()=>!0,get(t){const e=this.animationSet;t.object=e.skeletons.map(t=>t.get())},set(t){const e=this.animationSet;e.skeletons.forEach(t=>t.dispose()),e.skeletons.splice(0,e.skeletons.length),e.skeletons.push(...t.object.map(t=>new wt(t)))}},{name:"Script",type:"object",options:{mimeTypes:["text/x-typescript"]},isNullable:()=>!0,get(t){t.str[0]=this.script},set(t){this.script=t?.str?.[0]??""}},{name:"Metadata",type:"object",options:{objectTypes:[ng]},isNullable:()=>!0,get(t){t.object[0]=this.metaData?new ng(null,this.metaData):null},set(t){this.metaData=t?.object[0]?.data??null}}]}}function lg(t,e,i,s,r,a){return[{name:e[0].toUpperCase()+e.slice(1),type:"object",default:null,phase:r,options:{mimeTypes:"2D"===i?["image/jpeg","image/png","image/tga","image/vnd.radiance","image/x-dds","image/webp"]:["image/x-dds"]},isNullable:()=>!0,get(i){i.str[0]=t.getAssetId(this[e])??""},async set(r){if(r){if(r.str[0]){const a=r.str[0];let n;try{n=await t.fetchTexture(a,{linearColorSpace:!s})}catch(t){console.error(`Load asset failed: ${r.str[0]}: ${t}`),n=null}("2D"===i?n?.isTexture2D():"Cube"===i&&n?.isTextureCube())?this[e]=n:console.error("Invalid texture type")}}else this[e]=null},isValid(){return!this.$isInstance&&(!a||a.call(this))}},{name:e[0].toUpperCase()+e.slice(1,e.length-7)+"TexCoordScale",type:"vec2",phase:r+1,default:[1,1],options:{animatable:!0},get(t){const i=this[e.slice(0,e.length-7)+"TexCoordMatrix"];if(i){const e=new z;i.decompose(e,null,null),t.num[0]=e.x,t.num[1]=e.y}else t.num[0]=1,t.num[1]=1},set(t){1===t.num[0]&&1===t.num[1]?this[e.slice(0,e.length-7)+"TexCoordMatrix"]=null:this[e.slice(0,e.length-7)+"TexCoordMatrix"]=W.scaling(new z(t.num[0],t.num[1],1))},isValid(){return!this.$isInstance&&(a?!!this[e]&&a.call(this):!!this[e])}},{name:e[0].toUpperCase()+e.slice(1,e.length-7)+"TexCoordAddressU",type:"string",options:{enum:{labels:["Clamp","Repeat","MirroredRepeat"],values:["clamp","repeat","mirrored_repeat"]}},phase:r+1,default:"clamp",get(t){const i=this[e.slice(0,e.length-7)+"TextureSampler"]??this[e].getDefaultSampler(!1);t.str[0]=i.addressModeU},set(t){const i=this[e.slice(0,e.length-7)+"TextureSampler"]??this[e].getDefaultSampler(!1);this[e.slice(0,e.length-7)+"TextureSampler"]=Sl().createSampler({addressU:t.str[0],addressV:i.addressModeV,lodMax:i.lodMax,lodMin:i.lodMin,magFilter:i.magFilter,minFilter:i.minFilter,mipFilter:i.mipFilter,maxAnisotropy:i.maxAnisotropy})},isValid(){return!this.$isInstance&&(a?!!this[e]&&a.call(this):!!this[e])}},{name:e[0].toUpperCase()+e.slice(1,e.length-7)+"TexCoordAddressV",type:"string",options:{enum:{labels:["Clamp","Repeat","MirroredRepeat"],values:["clamp","repeat","mirrored_repeat"]}},phase:r+1,default:"clamp",get(t){const i=this[e.slice(0,e.length-7)+"TextureSampler"]??this[e].getDefaultSampler(!1);t.str[0]=i.addressModeV},set(t){const i=this[e.slice(0,e.length-7)+"TextureSampler"]??this[e].getDefaultSampler(!1);this[e.slice(0,e.length-7)+"TextureSampler"]=Sl().createSampler({addressU:i.addressModeU,addressV:t.str[0],lodMax:i.lodMax,lodMin:i.lodMin,magFilter:i.magFilter,minFilter:i.minFilter,mipFilter:i.mipFilter,maxAnisotropy:i.maxAnisotropy})},isValid(){return!this.$isInstance&&(a?!!this[e]&&a.call(this):!!this[e])}},{name:e[0].toUpperCase()+e.slice(1,e.length-7)+"TexCoordIndex",type:"int",phase:r+1,default:0,get(t){t.num[0]=this[e.slice(0,e.length-7)+"TexCoordIndex"]},set(t){this[e.slice(0,e.length-7)+"TexCoordIndex"]=t.num[0]},isValid(){return!this.$isInstance&&(a?!!this[e]&&a.call(this):!!this[e])}}]}function ug(t){return[{name:"IOR",type:"float",default:1.5,options:{animatable:!0},get(t){t.num[0]=this.ior},set(t){this.ior=t.num[0]},isValid(){return!this.$isInstance}},{name:"OcclusionStrength",type:"float",phase:2,default:1,options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.occlusionStrength},set(t){this.occlusionStrength=t.num[0]},isValid(){return!this.$isInstance&&!!this.occlusionTexture}},...lg(t,"occlusionTexture","2D",!1,0),{name:"EmissiveColor",type:"rgb",options:{animatable:!0},get(t){t.num[0]=this.emissiveColor.x,t.num[1]=this.emissiveColor.y,t.num[2]=this.emissiveColor.z},set(t){this.emissiveColor=new z(t.num[0],t.num[1],t.num[2])},getDefaultValue(){return this.$isInstance?this.coreMaterial.emissiveColor:[0,0,0]}},{name:"EmissiveStrength",type:"float",options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.emissiveStrength},set(t){this.emissiveStrength=t.num[0]},getDefaultValue(){return this.$isInstance?this.coreMaterial.emissiveStrength:1}},...lg(t,"emissiveTexture","2D",!0,0),...lg(t,"specularTexture","2D",!1,0),{name:"Transmission",type:"bool",phase:0,default:!1,get(t){t.bool[0]=this.transmission},set(t){this.transmission=t.bool[0]},isValid(){return!this.$isInstance}},{name:"TransmissionFactor",type:"float",phase:1,default:0,options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.transmissionFactor},set(t){this.transmissionFactor=t.num[0]},isValid(){return!this.$isInstance&&!!this.transmission}},...lg(t,"transmissionTexture","2D",!1,1,function(){return this.transmission}),{name:"ThicknessFactor",type:"float",phase:1,default:0,options:{animatable:!0,minValue:0,maxValue:99999},get(t){t.num[0]=this.thicknessFactor},set(t){this.thicknessFactor=t.num[0]},isValid(){return!this.$isInstance&&!!this.transmission}},...lg(t,"thicknessTexture","2D",!1,1,function(){return this.transmission}),{name:"AttenuationColor",type:"rgb",phase:1,default:[1,1,1],options:{animatable:!0},get(t){t.num[0]=this.attenuationColor.x,t.num[1]=this.attenuationColor.y,t.num[2]=this.attenuationColor.z},set(t){this.attenuationColor=new z(t.num[0],t.num[1],t.num[2])},isValid(){return!this.$isInstance&&!!this.transmission}},{name:"AttenuationDistance",type:"float",phase:1,default:99999,options:{animatable:!0,minValue:0,maxValue:99999},get(t){t.num[0]=this.attenuationDistance},set(t){this.attenuationDistance=t.num[0]},isValid(){return!this.$isInstance&&!!this.transmission}},{name:"Iridescence",type:"bool",phase:0,default:!1,get(t){t.bool[0]=this.iridescence},set(t){this.iridescence=t.bool[0]},isValid(){return!this.$isInstance}},{name:"IridescenceFactor",type:"float",phase:1,default:0,options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.iridescenceFactor},set(t){this.iridescenceFactor=t.num[0]},isValid(){return!this.$isInstance&&!!this.iridescence}},...lg(t,"iridescenceTexture","2D",!1,1,function(){return this.iridescence}),{name:"IridescenceIOR",type:"float",phase:1,default:1.3,options:{animatable:!0},get(t){t.num[0]=this.iridescenceIor},set(t){this.iridescenceIor=t.num[0]},isValid(){return!this.$isInstance&&!!this.iridescence}},{name:"IridescenceThicknessMin",type:"float",phase:1,default:100,options:{animatable:!0,minValue:0,maxValue:1e3},get(t){t.num[0]=this.iridescenceThicknessMin},set(t){this.iridescenceThicknessMin=t.num[0]},isValid(){return!this.$isInstance&&!!this.iridescence}},{name:"IridescenceThicknessMax",type:"float",phase:1,default:400,options:{animatable:!0,minValue:0,maxValue:1e3},get(t){t.num[0]=this.iridescenceThicknessMax},set(t){this.iridescenceThicknessMax=t.num[0]},isValid(){return!this.$isInstance&&!!this.iridescence}},...lg(t,"iridescenceThicknessTexture","2D",!1,1,function(){return this.iridescence}),{name:"ClearCoat",type:"bool",phase:0,default:!1,get(t){t.bool[0]=this.clearcoat},set(t){this.clearcoat=t.bool[0]},isValid(){return!this.$isInstance}},{name:"ClearCoatIntensity",type:"float",phase:1,default:0,options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.clearcoatIntensity},set(t){this.clearcoatIntensity=t.num[0]},isValid(){return!this.$isInstance&&!!this.clearcoat}},...lg(t,"clearcoatIntensityTexture","2D",!1,1,function(){return this.clearcoat}),{name:"ClearCoatRoughnessFactor",type:"float",phase:1,default:0,options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.clearcoatRoughnessFactor},set(t){this.clearcoatRoughnessFactor=t.num[0]},isValid(){return!this.$isInstance&&!!this.clearcoat}},...lg(t,"clearcoatRoughnessTexture","2D",!1,1,function(){return this.clearcoat}),...lg(t,"clearcoatNormalTexture","2D",!1,1,function(){return this.clearcoat}),{name:"Sheen",type:"bool",phase:0,default:!1,get(t){t.bool[0]=this.sheen},set(t){this.sheen=t.bool[0]},isValid(){return!this.$isInstance}},{name:"SheenColorFactor",type:"rgb",phase:1,default:[0,0,0],options:{animatable:!0},get(t){t.num[0]=this.sheenColorFactor.x,t.num[1]=this.sheenColorFactor.y,t.num[2]=this.sheenColorFactor.z},set(t){this.sheenColorFactor=new z(t.num[0],t.num[1],t.num[2])},isValid(){return!this.$isInstance&&!!this.sheen}},...lg(t,"sheenColorTexture","2D",!0,1,function(){return this.sheen}),{name:"SheenRoughnessFactor",type:"float",phase:1,default:0,options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.sheenRoughnessFactor},set(t){this.sheenRoughnessFactor=t.num[0]},isValid(){return!this.$isInstance&&!!this.sheen}},...lg(t,"sheenRoughnessTexture","2D",!1,1,function(){return this.sheen}),...cg(t)]}function cg(t){return[...dg(t),{name:"vertexNormal",type:"bool",default:!0,get(t){t.bool[0]=this.vertexNormal},set(t){this.vertexNormal=t.bool[0]},isValid(){return!this.$isInstance}},{name:"vertexTangent",type:"bool",default:!1,get(t){t.bool[0]=this.vertexTangent},set(t){this.vertexTangent=t.bool[0]},isValid(){return!this.$isInstance&&!!this.vertexNormal}},...lg(t,"normalTexture","2D",!1,0)]}function dg(t){return[{name:"vertexColor",type:"bool",default:!1,get(t){t.bool[0]=this.vertexColor},set(t){this.vertexColor=t.bool[0]},isValid(){return!this.$isInstance}},{name:"AlbedoColor",type:"rgba",options:{animatable:!0},get(t){const e=this.albedoColor;t.num[0]=e.x,t.num[1]=e.y,t.num[2]=e.z,t.num[3]=e.w},set(t){this.albedoColor=new O(t.num[0],t.num[1],t.num[2],t.num[3])},getDefaultValue(){return this.$isInstance?this.coreMaterial.albedoColor:[1,1,1,1]}},...lg(t,"albedoTexture","2D",!0,0)]}function pg(t){return[{ctor:ud,name:"ParticleMaterial",parent:ed,getProps:()=>[{name:"AlphaMap",type:"object",default:null,options:{mimeTypes:["image/jpeg","image/png","image/tga","image/vnd.radiance","image/x-dds","image/webp"]},isNullable:()=>!0,get(e){e.str[0]=t.getAssetId(this.alphaMap)??""},async set(e){if(e.str[0]){const i=e.str[0];let s;try{s=await t.fetchTexture(i,{linearColorSpace:!0})}catch(t){console.error(`Load asset failed: ${e.str[0]}: ${t}`)}s?.isTexture2D()?this.alphaMap=s:console.error("Invalid albedo texture")}}},{name:"RampMap",type:"object",default:null,options:{mimeTypes:["image/jpeg","image/png","image/tga","image/vnd.radiance","image/x-dds","image/webp"]},isNullable:()=>!0,get(e){e.str[0]=t.getAssetId(this.rampMap)??""},async set(e){if(e.str[0]){const i=e.str[0];let s;try{s=await t.fetchTexture(i)}catch(t){console.error(`Load asset failed: ${e.str[0]}: ${t}`)}s?.isTexture2D()?this.rampMap=s:console.error("Invalid albedo texture")}}}]},K_(ud)]}function mg(t){return[{ctor:ld,parent:ed,name:"UnlitMaterial",getProps:()=>dg(t)},K_(ld)]}function fg(t){return[{ctor:nd,parent:ed,name:"LambertMaterial",getProps:()=>cg(t)},K_(nd)]}function _g(t){return[{ctor:hd,parent:ed,name:"BlinnMaterial",getProps:()=>[{name:"Shininess",type:"float",options:{animatable:!0,minValue:0,maxValue:2048},get(t){t.num[0]=this.shininess},set(t){this.shininess=t.num[0]},getDefaultValue(){return this.$isInstance?this.coreMaterial.shininess:32}},...cg(t)]},K_(hd)]}function gg(t){return[{ctor:vd,parent:ed,name:"PBRMetallicRoughnessMaterial",getProps:()=>[{name:"Metallic",type:"float",options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.metallic},set(t){this.metallic=t.num[0]},getDefaultValue(){return this.$isInstance?this.coreMaterial.metallic:1}},{name:"Roughness",type:"float",options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.roughness},set(t){this.roughness=t.num[0]},getDefaultValue(){return this.$isInstance?this.coreMaterial.roughness:1}},{name:"SpecularFactor",type:"rgba",options:{animatable:!0},get(t){t.num[0]=this.specularFactor.x,t.num[1]=this.specularFactor.y,t.num[2]=this.specularFactor.z,t.num[3]=this.specularFactor.w},set(t){this.specularFactor=new O(t.num[0],t.num[1],t.num[2],t.num[3])},getDefaultValue(){return this.$isInstance?this.coreMaterial.specularFactor:[1,1,1,1]}},...lg(t,"metallicRoughnessTexture","2D",!1,0),...lg(t,"specularColorTexture","2D",!0,0),...ug(t)]},K_(vd)]}function xg(t){return[{ctor:Td,name:"PBRSpecularGlossinessMaterial",parent:ed,getProps:()=>[{name:"SpecularFactor",type:"rgb",options:{animatable:!0},get(t){t.num[0]=this.specularFactor.x,t.num[1]=this.specularFactor.y,t.num[2]=this.specularFactor.z},set(t){this.specularFactor=new z(t.num[0],t.num[1],t.num[2])},getDefaultValue(){return this.$isInstance?this.coreMaterial.specularFactor:[1,1,1]}},{name:"GlossnessFactor",type:"float",options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.glossinessFactor},set(t){this.glossinessFactor=t.num[0]},getDefaultValue(){return this.$isInstance?this.coreMaterial.glossinessFactor:1}},...ug(t)]},K_(Td)]}function bg(t){return{ctor:Df,name:"Scene",createFunc:()=>({obj:new Df}),getProps:()=>[{name:"Name",type:"string",default:"",isHidden:()=>!0,get(t){t.str[0]=this.name},set(t){this.name=t.str[0]}},{name:"EnvLightType",phase:0,type:"string",options:{enum:{labels:["None","Constant","Hemispheric","IBL"],values:["none","constant","hemisphere","ibl"]}},default:"ibl",get(t){t.str[0]=this.env.light.type},set(t){this.env.light.type=t.str[0]}},{name:"AmbientColor",type:"rgb",phase:1,default:[.2,.2,.2],options:{animatable:!0},get(t){const e=this.env.light.ambientColor;t.num[0]=e.x,t.num[1]=e.y,t.num[2]=e.z},set(t){this.env.light.ambientColor.setXYZW(t.num[0],t.num[1],t.num[2],1)},isValid(){return"constant"===this.env.light.type}},{name:"AmbientUp",type:"rgb",phase:1,default:[.3,.5,.8],options:{animatable:!0},get(t){const e=this.env.light.ambientUp;t.num[0]=e.x,t.num[1]=e.y,t.num[2]=e.z},set(t){this.env.light.ambientUp.setXYZW(t.num[0],t.num[1],t.num[2],1)},isValid(){return"hemisphere"===this.env.light.type}},{name:"AmbientDown",type:"rgb",phase:1,default:[.2,.2,.2],options:{animatable:!0},get(t){const e=this.env.light.ambientDown;t.num[0]=e.x,t.num[1]=e.y,t.num[2]=e.z},set(t){this.env.light.ambientDown.setXYZW(t.num[0],t.num[1],t.num[2],1)},isValid(){return"hemisphere"===this.env.light.type}},{name:"EnvLightStrength",type:"float",phase:0,options:{animatable:!0,minValue:0,maxValue:10},default:1,get(t){t.num[0]=this.env.light.strength},set(t){this.env.light.strength=t.num[0]}},{name:"SHWindowWeights",type:"vec3",options:{minValue:0,maxValue:1},default:[1,1,1],get(t){const e=this.env.sky.shWindowWeights;t.num[0]=e.x,t.num[1]=e.y,t.num[2]=e.z},set(t){this.env.sky.shWindowWeights=new z(t.num[0],t.num[1],t.num[2])}},{name:"RadianceConvSamples",type:"int",options:{minValue:1,maxValue:2048},default:64,get(t){t.num[0]=this.env.sky.radianceConvSamples},set(t){this.env.sky.radianceConvSamples=t.num[0]}},{name:"IrradianceConvSamples",type:"int",options:{minValue:1,maxValue:2048},default:256,get(t){t.num[0]=this.env.sky.irradianceConvSamples},set(t){this.env.sky.irradianceConvSamples=t.num[0]}},{name:"SkyType",type:"string",phase:0,options:{enum:{labels:["None","Image","SkyBox","Scatter"],values:["none","image","skybox","scatter"]}},default:"scatter",get(t){t.str[0]=this.env.sky.skyType},set(t){this.env.sky.skyType=t.str[0]}},{name:"SkyColor",type:"rgb",phase:1,default:[1,1,1],options:{animatable:!0},isValid(){return"image"===this.env.sky.skyType},get(t){const e=this.env.sky.skyColor;t.num[0]=e.x,t.num[1]=e.y,t.num[2]=e.z},set(t){this.env.sky.skyColor=new O(t.num[0],t.num[1],t.num[2],1),this.env.sky.invalidate()}},{name:"SkyImage",type:"object",default:null,options:{mimeTypes:["image/jpeg","image/png","image/tga","image/vnd.radiance","image/x-dds","image/webp"]},isValid(){return"image"===this.env.sky.skyType},isNullable:()=>!0,get(e){e.str[0]=t.getAssetId(this.env.sky.skyImage)??""},async set(e){if(e){if(e.str[0]){const i=e.str[0];let s;try{s=await t.fetchTexture(i)}catch(t){console.error(`Load asset failed: ${e.str[0]}: ${t}`),s=null}!!s?.isTexture2D()?this.env.sky.skyImage=s:console.error("Invalid texture type")}}else this.env.sky.skyImage=null}},{name:"FogType",type:"string",phase:0,options:{enum:{labels:["None","ExponentialHeightFog"],values:["none","height_fog"]}},default:"none",get(t){t.str[0]=this.env.sky.fogType},set(t){this.env.sky.fogType=t.str[0]}},{type:"float",name:"HeightFogDensity",default:.04,options:{group:"HeightFog",label:"Density",minValue:0,maxValue:1},isValid(){return"height_fog"===this.env.sky.fogType},get(t){t.num[0]=this.env.sky.heightFogDensity},set(t){this.env.sky.heightFogDensity=t.num[0]}},{name:"HeightFogFalloff",type:"float",default:.2,options:{group:"HeightFog",label:"Falloff",minValue:0,maxValue:1},isValid(){return"height_fog"===this.env.sky.fogType},get(t){t.num[0]=this.env.sky.heightFogFalloff},set(t){this.env.sky.heightFogFalloff=t.num[0]}},{name:"HeightFogStartHeight",type:"float",default:0,options:{group:"HeightFog",label:"StartHeight",minValue:0,maxValue:1e3},isValid(){return"height_fog"===this.env.sky.fogType},get(t){t.num[0]=this.env.sky.heightFogStartHeight},set(t){this.env.sky.heightFogStartHeight=t.num[0]}},{name:"HeightFogColor",type:"rgb",phase:1,default:[0,0,0],options:{group:"HeightFog",label:"FogColor",animatable:!0},isValid(){return"height_fog"===this.env.sky.fogType},get(t){const e=this.env.sky.heightFogColor;t.num[0]=e.x,t.num[1]=e.y,t.num[2]=e.z},set(t){this.env.sky.heightFogColor=new z(t.num[0],t.num[1],t.num[2])}},{name:"HeightFogStartDistance",type:"float",default:0,options:{group:"HeightFog",label:"StartDistance"},isValid(){return"height_fog"===this.env.sky.fogType},get(t){t.num[0]=this.env.sky.heightFogStartDistance},set(t){this.env.sky.heightFogStartDistance=t.num[0]}},{name:"HeightFogEndDistance",type:"float",default:1e4,options:{group:"HeightFog",label:"EndDistance"},isValid(){return"height_fog"===this.env.sky.fogType},get(t){t.num[0]=this.env.sky.heightFogEndDistance},set(t){this.env.sky.heightFogEndDistance=t.num[0]}},{name:"HeightFogMaxOpacity",type:"float",options:{group:"HeightFog",label:"MaxOpacity",minValue:0,maxValue:1},default:1,isValid(){return"height_fog"===this.env.sky.fogType},get(t){t.num[0]=this.env.sky.heightFogMaxOpacity},set(t){this.env.sky.heightFogMaxOpacity=t.num[0]}},{name:"HeightFogAtmosphereStrength",type:"float",options:{group:"HeightFog",label:"AtmosphereStrength",minValue:0,maxValue:10},default:1,isValid(){return"height_fog"===this.env.sky.fogType},get(t){t.num[0]=this.env.sky.heightFogAtmosphereContribution},set(t){this.env.sky.heightFogAtmosphereContribution=t.num[0]}},{name:"HeightFogDirExponent",type:"float",default:4,options:{group:"HeightFog",label:"DirectionalExponent"},isValid(){return"height_fog"===this.env.sky.fogType},get(t){t.num[0]=this.env.sky.heightFogDirExponent},set(t){this.env.sky.heightFogDirExponent=t.num[0]}},{name:"HeightFogDirColor",type:"rgb",default:[0,0,0],options:{group:"HeightFog",label:"DirectionalInscattering"},isValid(){return"height_fog"===this.env.sky.fogType},get(t){t.num[0]=this.env.sky.heightFogDirColor.x,t.num[1]=this.env.sky.heightFogDirColor.y,t.num[2]=this.env.sky.heightFogDirColor.z},set(t){this.env.sky.heightFogDirColor=new z(t.num[0],t.num[1],t.num[2])}},{name:"AerialPerspectiveDistance",type:"float",phase:1,options:{animatable:!0,minValue:1,maxValue:5e4},default:1,get(t){t.num[0]=this.env.sky.aerialPerspectiveDistance},set(t){this.env.sky.aerialPerspectiveDistance=t.num[0]},isValid(){return"scatter"===this.env.sky.skyType}},{name:"CameraHeightScale",type:"float",phase:1,options:{animatable:!0,minValue:1,maxValue:1e3},default:1,get(t){t.num[0]=this.env.sky.cameraHeightScale},set(t){this.env.sky.cameraHeightScale=t.num[0]},isValid(){return"scatter"===this.env.sky.skyType}},{name:"AtmosphereExposure",type:"float",options:{animatable:!0,minValue:0,maxValue:8},default:1,get(t){t.num[0]=this.env.sky.atmosphereExposure},set(t){this.env.sky.atmosphereExposure=t.num[0]},isValid(){return"scatter"===this.env.sky.skyType}},{name:"Cloudy",type:"float",default:.6,phase:1,options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.env.sky.cloudy},set(t){this.env.sky.cloudy=t.num[0]},isValid(){return"scatter"===this.env.sky.skyType}},{name:"CloudIntensity",type:"float",default:40,phase:1,options:{animatable:!0,minValue:0,maxValue:200},get(t){t.num[0]=this.env.sky.cloudIntensity},set(t){this.env.sky.cloudIntensity=t.num[0]},isValid(){return"scatter"===this.env.sky.skyType}},{name:"Wind",type:"vec2",default:[0,0],phase:1,options:{animatable:!0,minValue:-100,maxValue:100},get(t){t.num[0]=this.env.sky.wind.x,t.num[1]=this.env.sky.wind.y},set(t){this.env.sky.wind.setXY(t.num[0],t.num[1])},isValid(){return"scatter"===this.env.sky.skyType}},{name:"SkyBoxTextureSize",type:"int",default:1024,get(t){t.num[0]=this.env.sky.skyboxTextureSize},set(t){this.env.sky.skyboxTextureSize=t.num[0]},isValid(){return"skybox"===this.env.sky.skyType}},{name:"PanoramaTexture",type:"object",phase:1,options:{mimeTypes:["image/vnd.radiance"]},get(t){t.str[0]=this.env.sky.panoramaTextureAsset},async set(t){this.env.sky.panoramaTextureAsset=t.str[0]},isValid(){return"skybox"===this.env.sky.skyType}},{name:"NodeHierarchy",type:"object",isHidden:()=>!0,get(t){t.object[0]=this.rootNode},set(t){const e=t.object[0];if(e){e.remove();for(const t of e.children.slice())t.get().parent=this.rootNode}}},{name:"MainCamera",type:"string",isHidden:()=>!0,get(t){t.str[0]=this.mainCamera?.persistentId??""},set(t){this.mainCamera=t.str[0]?this.findNodeById(t.str[0]):null}},{name:"Script",type:"object",options:{mimeTypes:["text/x-typescript"]},isNullable:()=>!0,get(t){t.str[0]=this.script},set(t){this.script=t?.str?.[0]??""}},{name:"Metadata",type:"object",default:null,options:{objectTypes:[ng,og]},isNullable:()=>!0,get(t){t.object[0]=this.metaData?Array.isArray(this.metaData)?new og(null,this.metaData):new ng(null,this.metaData):null},set(t){this.metaData=t?.object[0]?.data??null}}]}}function vg(t,e){const i=new t(e.reduce((t,e)=>t+e.length,0));let s=0;for(const t of e)i.set(t,s),s+=t.length;return i}function yg(t){return{ctor:z_,name:"ClipmapTerrain",parent:Nf,createFunc(t,e){const i=new z_(t.scene);return i.numDetailMaps=e,i.parent=t,{obj:i}},getInitParams:t=>t.numDetailMaps,getProps:()=>[{name:"Resolution",type:"int2",default:[256,256],options:{minValue:1,maxValue:4096},get(t){t.num[0]=this.sizeX,t.num[1]=this.sizeZ},set(t){this.setSize(t.num[0],t.num[1])}},{name:"CastShadow",type:"bool",default:!0,get(t){t.bool[0]=this.castShadow},set(t){this.castShadow=t.bool[0]}},{name:"Wireframe",type:"bool",default:!1,isPersistent:()=>!1,get(t){t.bool[0]=this.wireframe},set(t){this.wireframe=t.bool[0]}},{name:"Debug",type:"string",options:{enum:{labels:["None","UV","VertexNormal","DetailNormal","Tangent","Binormal","Albedo"],values:["none","uv","vertex_normal","detail_normal","tangent","bitangent","albedo"]}},default:"none",isPersistent:()=>!1,get(t){t.str[0]=this.material.debugMode},set(t){this.material.debugMode=t.str[0]}},{name:"GrassMaps",type:"object",default:null,options:{objectTypes:[og]},phase:0,isNullable:()=>!0,isHidden:()=>!1,get(e){const i=[],s=this.grassRenderer.numLayers;for(let e=0;e<s;e++){const s=this.grassRenderer.getGrassTexture(e),r=s?t.getAssetId(s)??"":"";i.push({texture:r,bladeWidth:this.grassRenderer.getBladeWidth(e),bladeHeight:this.grassRenderer.getBladeHeight(e)})}e.object[0]=new og(null,i)},async set(e){const i=e.object[0],s=i?.data??[];for(let i=0;i<s.length;i++){const r=s[i],a=r.texture;let n=null;if(a){try{n=await t.fetchTexture(a)}catch(t){console.error(`Load asset failed: ${e.str[0]}: ${t}`),n=null}n?.isTexture2D()||(console.error("Invalid texture type"),n?.dispose(),n=null)}this.grassRenderer.addLayer(r.bladeWidth??1,r.bladeHeight??1,n)}}},{name:"DetailMaps",type:"object",default:null,options:{objectTypes:[og]},isNullable:()=>!0,isHidden:()=>!1,get(e){const i=[],s=this.material;for(let e=0;e<s.numDetailMaps;e++)i.push({albedo:t.getAssetId(s.getDetailMap(e))??"",normal:t.getAssetId(s.getDetailNormalMap(e))??"",roughness:s.getDetailMapRoughness(e),uvscale:s.getDetailMapUVScale(e)});e.object[0]=new og(null,i)},async set(e){const i=e.object[0];if(!i)return void(this.material.numDetailMaps=0);const s=i.data??[],r=this.material;r.numDetailMaps=s.length;for(let i=0;i<this.numDetailMaps;i++){const a=s[i];if(a?.albedo){let s;try{s=await t.fetchTexture(a.albedo)}catch(t){console.error(`Load asset failed: ${e.str[0]}: ${t}`),s=null}s?.isTexture2D()?r.setDetailMap(i,s):console.error("Invalid texture type")}else r.setDetailMap(i,null);if(a?.normal){let s;try{s=await t.fetchTexture(a.normal)}catch(t){console.error(`Load asset failed: ${e.str[0]}: ${t}`),s=null}s?.isTexture2D()?r.setDetailMap(i,s):console.error("Invalid texture type")}else r.setDetailNormalMap(i,null);r.setDetailMapRoughness(i,a.roughness??1),r.setDetailMapUVScale(i,a.uvscale??100)}}},{name:"SplatMap",type:"embedded",default:null,isHidden:()=>!0,get(t){t.str[0]=this.splatMapAssetId,t.object[0]=async function(t){const e=Sl(),i=t.splatMap,s=t.material.numDetailMaps+3>>2,r=e.getDeviceCaps().textureCaps.getTextureFormatInfo(i.format),a=new ArrayBuffer(12+s*i.width*i.height*r.blockWidth*r.blockHeight*r.size),n=new DataView(a);n.setUint32(0,i.width,!0),n.setUint32(4,i.height,!0),n.setUint32(8,s,!0);for(let t=0;t<s;t++){const e=new Uint8Array(a,12+t*i.width*i.height*r.blockWidth*r.blockHeight*r.size);await i.readPixels(0,0,i.width,i.height,0,0,e)}return a}(this)},async set(e){if(e.str[0]){const i=e.str[0],s=await t.VFS.readFile(i,{encoding:"binary"});if(!s)return void console.error("Load height map failed");const r=new DataView(s),a=r.getUint32(0,!0),n=r.getUint32(4,!0),o=r.getUint32(8,!0),h=this.splatMap;if(h.width!==a||h.height!==n)return void console.error("Invalid splatmap data");for(let t=0;t<o;t++){const e=new Uint8Array(s,12+t*a*n*4,a*n*4);h.update(e,0,0,t,a,n,1)}this.splatMapAssetId=e.str[0]}}},{name:"Grass",type:"embedded",default:null,phase:1,isHidden:()=>!0,get(t){t.str[0]=this.grassAssetId,t.object[0]=async function(t){const e=t.grassRenderer,i=[];let s=4+4*e.numLayers;for(let t=0;t<e.numLayers;t++){const r=[],a=[e.getLayer(t).quadtree];for(;a.length>0;){const t=a.shift();t.children&&a.push(...t.children);const e=t.grassInstances;if(e.numInstances>0){const t=e.instanceBuffer.getBufferSubData(null,0,4*e.numInstances*4);r.push(t)}}if(r.length>0){const t=await Promise.all(r),e=vg(Uint8Array,t);s+=e.length,i.push(e)}else i.push(new Uint8Array)}const r=new DataView(new ArrayBuffer(s)),a=new Uint8Array(r.buffer,r.byteOffset,r.byteLength);let n=0;r.setUint32(n,e.numLayers,!0),n+=4;for(let t=0;t<e.numLayers;t++)r.setUint32(n,i[t].length,!0),n+=4,a.set(i[t],n),n+=i[t].length;return r.buffer}(this)},async set(e){if(e.str[0]){const i=e.str[0],s=await t.VFS.readFile(i,{encoding:"binary"});if(!s)return void console.error("Load grass data failed");const r=new DataView(s);let a=0;const n=r.getUint32(a,!0);if(n!==this.grassRenderer.numLayers)return void console.error("Number of grass layers mismatch");a+=4;for(let t=0;t<n;t++){const e=r.getUint32(a,!0);if(a+=4,e>0){const i=new Float32Array(r.buffer,r.byteOffset+a,e>>2),s=i.length>>2,n=[];for(let t=0;t<s;t++)n.push({x:i[4*t+0],y:i[4*t+1],angle:Math.atan2(i[4*t+2],i[4*t+3])});this.grassRenderer.addInstances(t,n),a+=e}}this.grassAssetId=e.str[0]}}},{name:"HeightMap",type:"embedded",default:null,isHidden:()=>!0,get(t){t.str[0]=this.heightMapAssetId,t.object[0]=async function(t){const e=t.heightMap,i=new ArrayBuffer(8+e.width*e.height*2),s=new DataView(i);s.setUint32(0,e.width,!0),s.setUint32(4,e.height,!0);const r=new Uint16Array(i,8);if("r16f"===e.format)await e.readPixels(0,0,e.width,e.height,0,0,r);else if("rgba16f"===e.format){const t=new Uint16Array(e.width*e.height*4);await e.readPixels(0,0,e.width,e.height,0,0,t);for(let i=0;i<e.width*e.height;i++)r[i]=t[4*i+0]}return i}(this)},async set(e){if(e.str[0]){const i=e.str[0],s=await t.VFS.readFile(i,{encoding:"binary"});if(!s)return void console.error("Load height map failed");const r=new DataView(s),a=r.getUint32(0,!0),n=r.getUint32(4,!0),o=this.createHeightMapTexture(a,n);if("r16f"!==o.format){if("rgba16f"!==o.format)throw new Error(`Unsupported height map format: ${o.format}`);{const t=new Uint16Array(a*n*4),e=new Uint16Array(s,8);for(let i=0;i<a*n;i++)t[4*i+0]=e[i];o.update(t,0,0,a,n)}}else o.update(new Uint16Array(s,8),0,0,a,n);this.heightMap=o,this.heightMapAssetId=e.str[0],this.updateBoundingBox()}}}]}}function Tg(t,e){return e?t.$builtins.globalInvocationId.xy:t.$builtins.fragCoord.xy}function wg(t=!1,e,i="rgba32f",s){function r(t,e){return function(i){this.N2=i.float().uniform(0),t?(this.output="rgba32f"===e?i.texStorage2DArray.rgba32float().storage(0):i.texStorage2DArray.rgba16float().storage(0),this.ifft=i.tex2DArray().uniform(0)):(s&&4!==s||(this.$outputs.dx_hy_dz_dxdz0=i.vec4(),this.$outputs.sx_sz_dxdx_dzdz0=i.vec4(),this.$outputs.dx_hy_dz_dxdz1=i.vec4(),this.$outputs.sx_sz_dxdx_dzdz1=i.vec4(),this.ifft0=i.tex2D().uniform(0),this.ifft1=i.tex2D().uniform(0),this.ifft2=i.tex2D().uniform(0),this.ifft3=i.tex2D().uniform(0)),s&&2!==s||(this.$outputs.dx_hy_dz_dxdz2=i.vec4(),this.$outputs.sx_sz_dxdx_dzdz2=i.vec4(),this.ifft4=i.tex2D().uniform(0),this.ifft5=i.tex2D().uniform(0))),"webgl"===i.getDevice().type&&(this.ifftTexSize=i.vec2().uniform(0)),i.main(function(){if(this.$l.fragPos=Tg(this,t),this.$l.p=i.float(i.add(this.fragPos.x,this.fragPos.y)),this.$l.s=i.sub(i.mul(i.sub(1,i.mod(this.p,2)),2),1),this.$l.m=i.mul(this.s,this.N2),"webgl"===i.getDevice().type)this.$l.uv=i.div(i.vec2(this.fragPos),this.ifftTexSize),s&&4!==s||(this.$outputs.dx_hy_dz_dxdz0=i.mul(i.textureSampleLevel(this.ifft0,this.uv,0),this.m),this.$outputs.sx_sz_dxdx_dzdz0=i.mul(i.textureSampleLevel(this.ifft1,this.uv,0),this.m),this.$outputs.dx_hy_dz_dxdz1=i.mul(i.textureSampleLevel(this.ifft2,this.uv,0),this.m),this.$outputs.sx_sz_dxdx_dzdz1=i.mul(i.textureSampleLevel(this.ifft3,this.uv,0),this.m)),s&&2!==s||(this.$outputs.dx_hy_dz_dxdz2=i.mul(i.textureSampleLevel(this.ifft4,this.uv,0),this.m),this.$outputs.sx_sz_dxdx_dzdz2=i.mul(i.textureSampleLevel(this.ifft5,this.uv,0),this.m));else if(t){this.$l.uv=i.ivec2(this.fragPos);for(let t=0;t<6;t++)i.textureArrayStore(this.output,this.$builtins.globalInvocationId.xy,t,i.mul(i.textureArrayLoad(this.ifft,this.uv,t,0),this.m))}else this.$l.uv=i.ivec2(this.fragPos),s&&4!==s||(this.$outputs.dx_hy_dz_dxdz0=i.mul(i.textureLoad(this.ifft0,this.uv,0),this.m),this.$outputs.sx_sz_dxdx_dzdz0=i.mul(i.textureLoad(this.ifft1,this.uv,0),this.m),this.$outputs.dx_hy_dz_dxdz1=i.mul(i.textureLoad(this.ifft2,this.uv,0),this.m),this.$outputs.sx_sz_dxdx_dzdz1=i.mul(i.textureLoad(this.ifft3,this.uv,0),this.m)),s&&2!==s||(this.$outputs.dx_hy_dz_dxdz2=i.mul(i.textureLoad(this.ifft4,this.uv,0),this.m),this.$outputs.sx_sz_dxdx_dzdz2=i.mul(i.textureLoad(this.ifft5,this.uv,0),this.m))})}}let a;return a=t?Sl().buildComputeProgram({workgroupSize:[e,e,1],compute:r(t,i)}):Sl().buildRenderProgram({vertex(t){this.$inputs.position=t.vec3().attrib("position"),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.position,1)})},fragment:r(t,i)}),a.name="@Water_PostFFT2",a}function Sg(t=!1,e=8,i="rgba32f",s){function r(t=!1,e){return function(i){t?this.spectrum="rgba32f"===e?i.texStorage2DArray.rgba32float().storage(0):i.texStorage2DArray.rgba16float().storage(0):(s&&4!==s||(this.$outputs.spectrum0=i.vec4(),this.$outputs.spectrum1=i.vec4(),this.$outputs.spectrum2=i.vec4(),this.$outputs.spectrum3=i.vec4()),s&&2!==s||(this.$outputs.spectrum4=i.vec4(),this.$outputs.spectrum5=i.vec4())),this.resolution=i.int().uniform(0),this.sizes=i.vec4().uniform(0),this.t=i.float().uniform(0),t?this.h0Texture=i.tex2DArray().uniform(0):(s&&4!==s||(this.h0Texture0=i.tex2D().uniform(0),this.h0Texture1=i.tex2D().uniform(0)),s&&2!==s||(this.h0Texture2=i.tex2D().uniform(0))),"webgl"===i.getDevice().type&&(this.h0TexSize=i.vec2().uniform(0)),this.RATIO=i.float(.618033989036),this.g=i.float(9.81);const r=i.defineStruct([i.float("re"),i.float("im")],"Complex"),a=i.defineStruct([r("dx"),r("hy"),r("dz"),r("sx"),r("sz"),r("dxdx"),r("dxdz"),r("dzdz")],"Spectrum");i.func("add",[r("a"),r("b")],function(){this.$return(r(i.add(this.a.re,this.b.re),i.add(this.a.im,this.b.im)))}),i.func("mul",[r("a"),r("b")],function(){this.$return(r(i.sub(i.mul(this.a.re,this.b.re),i.mul(this.a.im,this.b.im)),i.add(i.mul(this.a.re,this.b.im),i.mul(this.a.im,this.b.re))))}),i.func("eix",[i.float("x")],function(){this.$return(r(i.cos(this.x),i.sin(this.x)))}),i.func("conj",[r("a")],function(){this.$return(r(this.a.re,i.neg(this.a.im)))}),i.func("scale",[r("a"),i.float("v")],function(){this.$return(r(i.mul(this.a.re,this.v),i.mul(this.a.im,this.v)))}),i.func("negate",[r("a")],function(){this.$return(r(i.neg(this.a.re),i.neg(this.a.im)))});for(let e=0;e<=2;e++)e<2&&2===s||2===e&&4===s||i.func(`getSpectrum${e}`,[i.vec2("x"),i.float("size"),i.ivec2("fragCoord")],function(){this.$l.hy=r(0,0),this.$l.sx=r(0,0),this.$l.sz=r(0,0),this.$l.dx=r(0,0),this.$l.dz=r(0,0),this.$l.dxdx=r(0,0),this.$l.dxdz=r(0,0),this.$l.dzdz=r(0,0),this.$if(i.lessThanEqual(this.size,.001),function(){this.$return(a(this.dx,this.hy,this.dz,this.sx,this.sz,this.dxdx,this.dxdz,this.dzdz))}),this.$l.k=i.mul(this.x,i.div(2*Math.PI,this.size)),this.$l.kLen=i.length(this.k),this.$if(i.greaterThan(this.kLen,1e-6),function(){this.$l.w=i.sqrt(i.mul(this.kLen,this.g)),"webgl"===i.getDevice().type?this.$l.h0Texel=i.textureSampleLevel(this[`h0Texture${e}`],i.div(i.vec2(this.fragCoord),this.h0TexSize),0):this.$l.h0Texel=t?i.textureArrayLoad(this.h0Texture,this.fragCoord,e,0):i.textureLoad(this[`h0Texture${e}`],this.fragCoord,0),this.$l.e=this.eix(i.mul(this.w,this.t)),this.$l.h0=r(this.h0Texel.x,this.h0Texel.y),this.$l.h0MinConj=r(this.h0Texel.z,this.h0Texel.w),this.hy=this.add(this.mul(this.h0,this.e),this.mul(this.h0MinConj,this.conj(this.e))),this.$if(i.notEqual(this.fragCoord.x,0),function(){this.sx=this.mul(r(0,this.k.x),this.hy),this.dx=this.mul(r(0,i.div(i.neg(this.k.x),this.kLen)),this.hy),this.dxdx=this.scale(this.hy,i.div(i.mul(this.k.x,this.k.x),this.kLen))}),this.$if(i.notEqual(this.fragCoord.y,0),function(){this.sz=this.mul(r(0,this.k.y),this.hy),this.dz=this.mul(r(0,i.div(i.neg(this.k.y),this.kLen)),this.hy),this.dzdz=this.scale(this.hy,i.div(i.mul(this.k.y,this.k.y),this.kLen)),this.$if(i.notEqual(this.fragCoord.x,0),function(){this.dxdz=this.scale(this.hy,i.div(i.mul(this.k.x,this.k.y),this.kLen))})})}),this.$return(a(this.dx,this.hy,this.dz,this.sx,this.sz,this.dxdx,this.dxdz,this.dzdz))});i.func("compressSpectrum",[a("spec"),i.vec4("part0").out(),i.vec4("part1").out()],function(){this.$l.i=r(0,1),this.$l.dx_hy=this.add(this.spec.dx,this.mul(this.i,this.spec.hy)),this.$l.dz_dxdz=this.add(this.spec.dz,this.mul(this.i,this.spec.dxdz)),this.$l.sx_sz=this.add(this.spec.sx,this.mul(this.i,this.spec.sz)),this.$l.dxdx_dzdz=this.add(this.spec.dxdx,this.mul(this.i,this.spec.dzdz)),this.part0=i.vec4(this.dx_hy.re,this.dx_hy.im,this.dz_dxdz.re,this.dz_dxdz.im),this.part1=i.vec4(this.sx_sz.re,this.sx_sz.im,this.dxdx_dzdz.re,this.dxdx_dzdz.im)}),i.main(function(){this.fragXY=i.ivec2(Tg(this,t)),this.$l.x=i.vec2(i.sub(this.fragXY,i.ivec2(i.div(this.resolution,2)))),!t&&s&&4!==s||(this.$l.s0=i.vec4(),this.$l.s1=i.vec4(),this.$l.s2=i.vec4(),this.$l.s3=i.vec4(),this.$l.spec0=this.getSpectrum0(this.x,this.sizes.x,this.fragXY),this.$l.spec1=this.getSpectrum1(this.x,this.sizes.y,this.fragXY),this.compressSpectrum(this.spec0,this.s0,this.s1),this.compressSpectrum(this.spec1,this.s2,this.s3),t?(i.textureArrayStore(this.spectrum,this.$builtins.globalInvocationId.xy,0,this.s0),i.textureArrayStore(this.spectrum,this.$builtins.globalInvocationId.xy,1,this.s1),i.textureArrayStore(this.spectrum,this.$builtins.globalInvocationId.xy,2,this.s2),i.textureArrayStore(this.spectrum,this.$builtins.globalInvocationId.xy,3,this.s3)):(this.$outputs.spectrum0=this.s0,this.$outputs.spectrum1=this.s1,this.$outputs.spectrum2=this.s2,this.$outputs.spectrum3=this.s3)),!t&&s&&2!==s||(this.$l.s4=i.vec4(),this.$l.s5=i.vec4(),this.$l.spec2=this.getSpectrum2(this.x,this.sizes.z,this.fragXY),this.compressSpectrum(this.spec2,this.s4,this.s5),t?(i.textureArrayStore(this.spectrum,this.$builtins.globalInvocationId.xy,4,this.s4),i.textureArrayStore(this.spectrum,this.$builtins.globalInvocationId.xy,5,this.s5)):(this.$outputs.spectrum4=this.s4,this.$outputs.spectrum5=this.s5))})}}let a;return a=t?Sl().buildComputeProgram({workgroupSize:[e,e,1],compute:r(t,i)}):Sl().buildRenderProgram({vertex(t){this.$inputs.position=t.vec3().attrib("position"),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.position,1)})},fragment:r(t,i)}),a.name="@Water_Hk",a}function Ag(t=!1,e=8,i="rgba32f"){function s(t=!1,e){return function(i){t?this.spectrum="rgba32f"===e?i.texStorage2DArray.rgba32float().storage(0):i.texStorage2DArray.rgba16float().storage(0):(this.$outputs.spectrum0=i.vec4(),this.$outputs.spectrum1=i.vec4(),this.$outputs.spectrum2=i.vec4()),this.noise=i.tex2D().uniform(0),this.resolution=i.int().uniform(0),this.wind=i.vec2().uniform(0),this.alignment=i.float().uniform(0),this.g=i.float(9.81),this.cascade0=i.vec4().uniform(0),this.cascade1=i.vec4().uniform(0),this.cascade2=i.vec4().uniform(0),i.func("gauss",[i.ivec2("fragCoord")],function(){this.$l.uv=i.div(i.vec2(this.fragCoord),i.float(this.resolution)),this.$l.noise0=i.textureSampleLevel(this.noise,this.uv,0).rg,this.$l.noise1=i.textureSampleLevel(this.noise,i.neg(this.uv),0).rg,this.$l.u0=i.mul(this.noise0.x,2*Math.PI),this.$l.v0=i.sqrt(i.mul(i.log(this.noise0.y),-2)),this.$l.u1=i.mul(this.noise1.x,2*Math.PI),this.$l.v1=i.sqrt(i.mul(i.log(this.noise1.y),-2)),this.$return(i.vec4(i.mul(this.v0,i.cos(this.u0)),i.mul(this.v0,i.sin(this.u0)),i.mul(this.v1,i.cos(this.u1)),i.mul(i.neg(this.v1),i.sin(this.u1))))}),i.func("phillips",[i.vec2("k"),i.float("A"),i.float("minK"),i.float("maxK")],function(){this.$l.k2=i.dot(this.k,this.k),this.$if(i.or(i.lessThanEqual(this.k2,i.mul(this.minK,this.minK)),i.greaterThanEqual(this.k2,i.mul(this.maxK,this.maxK))),function(){this.$return(i.vec4(0))}),this.$l.L=i.div(i.dot(this.wind,this.wind),this.g),this.$l.L2=i.mul(this.L,this.L),this.$l.h0k=i.mul(i.div(i.div(this.A,this.k2),this.k2),i.exp(i.div(-1,i.mul(this.k2,this.L2))),.5),this.$l.h0mk=this.h0k,this.$if(i.greaterThan(this.alignment,0),function(){this.h0k=i.mul(this.h0k,i.pow(i.max(0,i.dot(i.normalize(this.wind),i.normalize(this.k))),this.alignment)),this.h0mk=i.mul(this.h0mk,i.pow(i.max(0,i.dot(i.normalize(this.wind),i.normalize(i.neg(this.k)))),this.alignment))}),this.$return(i.sqrt(i.vec4(this.h0k,this.h0k,this.h0mk,this.h0mk)))}),i.main(function(){this.$l.x=i.vec2(i.sub(i.ivec2(Tg(this,t)),i.ivec2(i.div(this.resolution,2)))),this.$l.k=i.mul(i.vec2(2*Math.PI),this.x),this.$l.rnd=this.gauss(i.ivec2(Tg(this,t))),t?(i.textureArrayStore(this.spectrum,this.$builtins.globalInvocationId.xy,0,i.mul(this.phillips(i.div(this.k,this.cascade0.x),this.cascade0.y,this.cascade0.z,this.cascade0.w),this.rnd)),i.textureArrayStore(this.spectrum,this.$builtins.globalInvocationId.xy,1,i.mul(this.phillips(i.div(this.k,this.cascade1.x),this.cascade1.y,this.cascade1.z,this.cascade1.w),this.rnd)),i.textureArrayStore(this.spectrum,this.$builtins.globalInvocationId.xy,2,i.mul(this.phillips(i.div(this.k,this.cascade2.x),this.cascade2.y,this.cascade2.z,this.cascade2.w),this.rnd))):(this.$outputs.spectrum0=i.mul(this.phillips(i.div(this.k,this.cascade0.x),this.cascade0.y,this.cascade0.z,this.cascade0.w),this.rnd),this.$outputs.spectrum1=i.mul(this.phillips(i.div(this.k,this.cascade1.x),this.cascade1.y,this.cascade1.z,this.cascade1.w),this.rnd),this.$outputs.spectrum2=i.mul(this.phillips(i.div(this.k,this.cascade2.x),this.cascade2.y,this.cascade2.z,this.cascade2.w),this.rnd))})}}let r;return r=t?Sl().buildComputeProgram({workgroupSize:[e,e,1],compute:s(t,i)}):Sl().buildRenderProgram({vertex(t){this.$inputs.position=t.vec3().attrib("position"),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.position,1)})},fragment:s(t,i)}),r.name="@Water_H0",r}function Cg(t=!1,e,i="rgba32f",s){function r(t,e){return function(i){t?(this.spectrum=i.tex2DArray().sampleType("unfilterable-float").uniform(0),this.ifft="rgba32f"===e?i.texStorage2DArray.rgba32float().storage(0):i.texStorage2DArray.rgba16float().storage(0)):(s&&4!==s||(this.$outputs.ifft0=i.vec4(),this.$outputs.ifft1=i.vec4(),this.$outputs.ifft2=i.vec4(),this.$outputs.ifft3=i.vec4(),this.spectrum0=i.tex2D().sampleType("unfilterable-float").uniform(0),this.spectrum1=i.tex2D().sampleType("unfilterable-float").uniform(0),this.spectrum2=i.tex2D().sampleType("unfilterable-float").uniform(0),this.spectrum3=i.tex2D().sampleType("unfilterable-float").uniform(0)),s&&2!==s||(this.$outputs.ifft4=i.vec4(),this.$outputs.ifft5=i.vec4(),this.spectrum4=i.tex2D().sampleType("unfilterable-float").uniform(0),this.spectrum5=i.tex2D().sampleType("unfilterable-float").uniform(0))),this.butterfly=i.tex2D().sampleType("unfilterable-float").uniform(0),"webgl"===i.getDevice().type&&(this.texSize=i.vec4().uniform(0)),this.phase=i.int().uniform(0);const r=i.defineStruct([i.float("re"),i.float("im")],"Complex");i.func("add",[r("a"),r("b")],function(){this.$return(r(i.add(this.a.re,this.b.re),i.add(this.a.im,this.b.im)))}),i.func("mul",[r("a"),r("b")],function(){this.$return(r(i.sub(i.mul(this.a.re,this.b.re),i.mul(this.a.im,this.b.im)),i.add(i.mul(this.a.re,this.b.im),i.mul(this.a.im,this.b.re))))}),i.func("scale",[r("a"),i.float("v")],function(){this.$return(r(i.mul(this.a.re,this.v),i.mul(this.a.im,this.v)))});for(let e=0;e<=5;e++)e<4&&2===s||e>3&&4===s||i.func(`twiddle${e}`,[i.vec4("texelButt"),i.int("x")],function(){"webgl"===i.getDevice().type?(this.$l.texelA=i.textureSampleLevel(this[`spectrum${e}`],i.div(i.vec2(i.float(this.x),this.texelButt.b),this.texSize.xy),0),this.$l.texelB=i.textureSampleLevel(this[`spectrum${e}`],i.div(i.vec2(i.float(this.x),this.texelButt.a),this.texSize.xy),0)):t?(this.$l.texelA=i.textureArrayLoad(this.spectrum,i.ivec2(this.x,i.int(this.texelButt.b)),e,0),this.$l.texelB=i.textureArrayLoad(this.spectrum,i.ivec2(this.x,i.int(this.texelButt.a)),e,0)):(this.$l.texelA=i.textureLoad(this[`spectrum${e}`],i.ivec2(this.x,i.int(this.texelButt.b)),0),this.$l.texelB=i.textureLoad(this[`spectrum${e}`],i.ivec2(this.x,i.int(this.texelButt.a)),0)),this.$l.w=r(this.texelButt.r,this.texelButt.g),this.$l.a1=r(this.texelA.x,this.texelA.y),this.$l.b1=r(this.texelB.x,this.texelB.y),this.$l.r1=this.scale(this.add(this.a1,this.mul(this.b1,this.w)),.5),this.$l.a2=r(this.texelA.z,this.texelA.w),this.$l.b2=r(this.texelB.z,this.texelB.w),this.$l.r2=this.scale(this.add(this.a2,this.mul(this.b2,this.w)),.5),this.$return(i.vec4(this.r1.re,this.r1.im,this.r2.re,this.r2.im))});i.main(function(){this.$l.x=i.int(Tg(this,t).x),this.$l.y=i.int(Tg(this,t).y),"webgl"===i.getDevice().type?this.$l.texelButt=i.textureSampleLevel(this.butterfly,i.div(i.vec2(i.float(this.phase),i.float(this.y)),this.texSize.zw),0):this.$l.texelButt=i.textureLoad(this.butterfly,i.ivec2(this.phase,this.y),0),t?(i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,0,this.twiddle0(this.texelButt,this.x)),i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,1,this.twiddle1(this.texelButt,this.x)),i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,2,this.twiddle2(this.texelButt,this.x)),i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,3,this.twiddle3(this.texelButt,this.x)),i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,4,this.twiddle4(this.texelButt,this.x)),i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,5,this.twiddle5(this.texelButt,this.x))):(s&&4!==s||(this.$outputs.ifft0=this.twiddle0(this.texelButt,this.x),this.$outputs.ifft1=this.twiddle1(this.texelButt,this.x),this.$outputs.ifft2=this.twiddle2(this.texelButt,this.x),this.$outputs.ifft3=this.twiddle3(this.texelButt,this.x)),s&&2!==s||(this.$outputs.ifft4=this.twiddle4(this.texelButt,this.x),this.$outputs.ifft5=this.twiddle5(this.texelButt,this.x)))})}}let a;return a=t?Sl().buildComputeProgram({workgroupSize:[e,e,1],compute:r(t,i)}):Sl().buildRenderProgram({vertex(t){this.$inputs.position=t.vec3().attrib("position"),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.position,1)})},fragment:r(t,i)}),a.name="@Water_PreFFT2",a}function Eg(t=!1,e,i="rgba32f",s){function r(t,e){return function(i){t?(this.spectrum=i.tex2DArray().sampleType("unfilterable-float").uniform(0),this.ifft="rgba32f"===e?i.texStorage2DArray.rgba32float().storage(0):i.texStorage2DArray.rgba16float().storage(0)):(s&&4!==s||(this.$outputs.ifft0=i.vec4(),this.$outputs.ifft1=i.vec4(),this.$outputs.ifft2=i.vec4(),this.$outputs.ifft3=i.vec4(),this.spectrum0=i.tex2D().sampleType("unfilterable-float").uniform(0),this.spectrum1=i.tex2D().sampleType("unfilterable-float").uniform(0),this.spectrum2=i.tex2D().sampleType("unfilterable-float").uniform(0),this.spectrum3=i.tex2D().sampleType("unfilterable-float").uniform(0)),s&&2!==s||(this.$outputs.ifft4=i.vec4(),this.$outputs.ifft5=i.vec4(),this.spectrum4=i.tex2D().sampleType("unfilterable-float").uniform(0),this.spectrum5=i.tex2D().sampleType("unfilterable-float").uniform(0))),this.butterfly=i.tex2D().sampleType("unfilterable-float").uniform(0),this.phase=i.int().uniform(0),"webgl"===i.getDevice().type&&(this.texSize=i.vec4().uniform(0));const r=i.defineStruct([i.float("re"),i.float("im")],"Complex");i.func("add",[r("a"),r("b")],function(){this.$return(r(i.add(this.a.re,this.b.re),i.add(this.a.im,this.b.im)))}),i.func("mul",[r("a"),r("b")],function(){this.$return(r(i.sub(i.mul(this.a.re,this.b.re),i.mul(this.a.im,this.b.im)),i.add(i.mul(this.a.re,this.b.im),i.mul(this.a.im,this.b.re))))}),i.func("scale",[r("a"),i.float("v")],function(){this.$return(r(i.mul(this.a.re,this.v),i.mul(this.a.im,this.v)))});for(let e=0;e<=5;e++)e<4&&2===s||e>3&&4===s||i.func(`twiddle${e}`,[i.vec4("texelButt"),i.int("y")],function(){"webgl"===i.getDevice().type?(this.$l.texelA=i.textureSampleLevel(this[`spectrum${e}`],i.div(i.vec2(this.texelButt.b,i.float(this.y)),this.texSize.xy),0),this.$l.texelB=i.textureSampleLevel(this[`spectrum${e}`],i.div(i.vec2(this.texelButt.a,i.float(this.y)),this.texSize.xy),0)):t?(this.$l.texelA=i.textureArrayLoad(this.spectrum,i.ivec2(i.int(this.texelButt.b),this.y),e,0),this.$l.texelB=i.textureArrayLoad(this.spectrum,i.ivec2(i.int(this.texelButt.a),this.y),e,0)):(this.$l.texelA=i.textureLoad(this[`spectrum${e}`],i.ivec2(i.int(this.texelButt.b),this.y),0),this.$l.texelB=i.textureLoad(this[`spectrum${e}`],i.ivec2(i.int(this.texelButt.a),this.y),0)),this.$l.w=r(this.texelButt.r,this.texelButt.g),this.$l.a1=r(this.texelA.x,this.texelA.y),this.$l.b1=r(this.texelB.x,this.texelB.y),this.$l.r1=this.scale(this.add(this.a1,this.mul(this.b1,this.w)),.5),this.$l.a2=r(this.texelA.z,this.texelA.w),this.$l.b2=r(this.texelB.z,this.texelB.w),this.$l.r2=this.scale(this.add(this.a2,this.mul(this.b2,this.w)),.5),this.$return(i.vec4(this.r1.re,this.r1.im,this.r2.re,this.r2.im))});i.main(function(){this.$l.x=i.int(Tg(this,t).x),this.$l.y=i.int(Tg(this,t).y),"webgl"===i.getDevice().type?this.$l.texelButt=i.textureSampleLevel(this.butterfly,i.div(i.vec2(i.float(this.phase),i.float(this.x)),this.texSize.zw),0):this.$l.texelButt=i.textureLoad(this.butterfly,i.ivec2(this.phase,this.x),0),t?(i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,0,this.twiddle0(this.texelButt,this.y)),i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,1,this.twiddle1(this.texelButt,this.y)),i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,2,this.twiddle2(this.texelButt,this.y)),i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,3,this.twiddle3(this.texelButt,this.y)),i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,4,this.twiddle4(this.texelButt,this.y)),i.textureArrayStore(this.ifft,this.$builtins.globalInvocationId.xy,5,this.twiddle5(this.texelButt,this.y))):(s&&4!==s||(this.$outputs.ifft0=this.twiddle0(this.texelButt,this.y),this.$outputs.ifft1=this.twiddle1(this.texelButt,this.y),this.$outputs.ifft2=this.twiddle2(this.texelButt,this.y),this.$outputs.ifft3=this.twiddle3(this.texelButt,this.y)),s&&2!==s||(this.$outputs.ifft4=this.twiddle4(this.texelButt,this.y),this.$outputs.ifft5=this.twiddle5(this.texelButt,this.y)))})}}let a;return a=t?Sl().buildComputeProgram({workgroupSize:[e,e,1],compute:r(t,i)}):Sl().buildRenderProgram({vertex(t){this.$inputs.position=t.vec3().attrib("position"),t.main(function(){this.$builtins.position=t.vec4(this.$inputs.position,1)})},fragment:r(t,i)}),a.name="@Water_FFT2H",a}const Mg=16;class Bg extends gt{static _globals=null;_useComputeShader;_h0BindGroup;_hkBindGroup;_hkBindGroup2;_hkBindGroup4;_fft2hBindGroup;_fft2vBindGroup;_fft2hBindGroup2Used;_fft2hBindGroup2Free;_fft2hBindGroup4Used;_fft2hBindGroup4Free;_fft2vBindGroup2Used;_fft2vBindGroup2Free;_fft2vBindGroup4Used;_fft2vBindGroup4Free;_postfft2BindGroup;_postfft2BindGroup2;_postfft2BindGroup4;_updateRenderStates;_sizes;_croppinesses;_params;_instanceData;_ifftTextures;_cascades;_paramsChanged;_version;_resolutionChanged;_textureFormat;_h0TextureFormat;_dataTextureFormat;_renderMode;constructor(t){super();const e=Sl(),i=e.getDeviceCaps().textureCaps.supportHalfFloatColorBuffer?e.getDeviceCaps().framebufferCaps.maxDrawBuffers:0;this._textureFormat="rgba16f",this._h0TextureFormat="rgba16f",this._dataTextureFormat="rgba16f",this._useComputeShader="webgpu"===e.type;const s=e.getDeviceCaps().framebufferCaps.maxColorAttachmentBytesPerSample;if(0===i?this._renderMode=0:this._useComputeShader||s>=48?this._renderMode=1:this._renderMode=2,0!==this._renderMode){Bg._globals=Bg._globals??{programs:{h0Program:Ag(this._useComputeShader,Mg,this._h0TextureFormat),hkProgram:1===this._renderMode?Sg(this._useComputeShader,Mg,this._dataTextureFormat):null,hkProgram2:2===this._renderMode?Sg(!1,0,null,2):null,hkProgram4:2===this._renderMode?Sg(!1,0,null,4):null,fft2hProgram:1===this._renderMode?Eg(this._useComputeShader,Mg,this._dataTextureFormat):null,fft2hProgram2:2===this._renderMode?Eg(!1,0,null,2):null,fft2hProgram4:2===this._renderMode?Eg(!1,0,null,4):null,fft2vProgram:1===this._renderMode?Cg(this._useComputeShader,Mg,this._dataTextureFormat):null,fft2vProgram2:2===this._renderMode?Cg(!1,0,null,2):null,fft2vProgram4:2===this._renderMode?Cg(!1,0,null,4):null,postfft2Program:1===this._renderMode?wg(this._useComputeShader,Mg,this._dataTextureFormat):null,postfft2Program2:2===this._renderMode?wg(!1,0,null,2):null,postfft2Program4:2===this._renderMode?wg(!1,0,null,4):null},quad:Bg.createQuad(),noiseTextures:new Map,butterflyTextures:new Map},this._params=t??{cascades:[{size:400,strength:.4,croppiness:-1.5,minWave:0,maxWave:100},{size:100,strength:.4,croppiness:-1.2,minWave:0,maxWave:100},{size:15,strength:.2,croppiness:-.5,minWave:0,maxWave:7}],resolution:256,wind:new L(2,2),alignment:1,foamParams:new L(1.2,7.2),randomSeed:0};const i=Bg._globals.programs;this._h0BindGroup=e.createBindGroup(i.h0Program.bindGroupLayouts[0]),this._hkBindGroup=i.hkProgram?e.createBindGroup(Bg._globals.programs.hkProgram.bindGroupLayouts[0]):null,this._hkBindGroup2=i.hkProgram2?e.createBindGroup(Bg._globals.programs.hkProgram2.bindGroupLayouts[0]):null,this._hkBindGroup4=i.hkProgram4?e.createBindGroup(Bg._globals.programs.hkProgram4.bindGroupLayouts[0]):null,this._fft2hBindGroup=i.fft2hProgram?e.createBindGroup(Bg._globals.programs.fft2hProgram.bindGroupLayouts[0]):null,this._fft2vBindGroup=i.fft2vProgram?e.createBindGroup(Bg._globals.programs.fft2vProgram.bindGroupLayouts[0]):null,this._fft2hBindGroup2Used=[[],[]],this._fft2hBindGroup2Free=[[],[]],this._fft2hBindGroup4Used=[[],[]],this._fft2hBindGroup4Free=[[],[]],this._fft2vBindGroup2Used=[[],[]],this._fft2vBindGroup2Free=[[],[]],this._fft2vBindGroup4Used=[[],[]],this._fft2vBindGroup4Free=[[],[]],this._postfft2BindGroup=i.postfft2Program?e.createBindGroup(Bg._globals.programs.postfft2Program.bindGroupLayouts[0]):null,this._postfft2BindGroup2=i.postfft2Program2?e.createBindGroup(Bg._globals.programs.postfft2Program2.bindGroupLayouts[0]):null,this._postfft2BindGroup4=i.postfft2Program4?e.createBindGroup(Bg._globals.programs.postfft2Program4.bindGroupLayouts[0]):null,this._instanceData=null,this._ifftTextures=null,this._sizes=new O,this._croppinesses=new O,this._cascades=[new O,new O,new O,new O],this._updateRenderStates=Sl().createRenderStateSet(),this._updateRenderStates.useRasterizerState().setCullMode("none"),this._updateRenderStates.useDepthState().enableTest(!1).enableWrite(!1),this._version=0,this.paramsChanged()}}get version(){return this._version}clone(){return new Bg(this._params)}paramsChanged(){this._paramsChanged=!0,this._version++}get alignment(){return this._params.alignment}set alignment(t){this._params.alignment!==t&&(this._params.alignment=t,this.paramsChanged())}get wind(){return this._params.wind}set wind(t){t===this._params.wind||t.x===this._params.wind.x&&t.y===this._params.wind.y||(this._params.wind.x=t.x,this._params.wind.y=t.y,this.paramsChanged())}get foamWidth(){return this._params.foamParams.x}set foamWidth(t){t!==this._params.foamParams.x&&(this._params.foamParams.x=t,this.paramsChanged())}get foamContrast(){return this._params.foamParams.y}set foamContrast(t){t!==this._params.foamParams.y&&(this._params.foamParams.y=t,this.paramsChanged())}getWaveLength(t){return this._params.cascades[t].size}setWaveLength(t,e){this._params.cascades[t].size!==e&&(this._params.cascades[t].size=e,this.paramsChanged())}getWaveStrength(t){return this._params.cascades[t].strength}setWaveStrength(t,e){this._params.cascades[t].strength!==e&&(this._params.cascades[t].strength=e,this.paramsChanged())}getWaveCroppiness(t){return this._params.cascades[t].croppiness}setWaveCroppiness(t,e){this._params.cascades[t].croppiness!==e&&(this._params.cascades[t].croppiness=e,this.paramsChanged())}static createQuad(){const t=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,1,1,0,1,1,-1,1,0,0,1]),e=new Uint32Array([0,1,2,0,2,3]),i=new Cl;return i.createAndSetVertexBuffer(["position_f32x3","tex0_f32x2"],t),i.createAndSetIndexBuffer(e),i.primitiveType="triangle-list",i.indexStart=0,i.indexCount=e.length,i}getButterflyTexture(t){const e=Sl();let i=Bg._globals.butterflyTextures.get(t);return i||(i=e.createTexture2D("rgba32f",Math.log2(t),t,{mipmapping:!1}),i.name=`butterfly${t}`,i.update(this.createButterflyTexture(t),0,0,i.width,i.height),Bg._globals.butterflyTextures.set(t,i)),i}generateInitialSpectrum(){const t=Sl(),e=this.getInstanceData();t.setProgram(Bg._globals.programs.h0Program),t.setBindGroup(0,this._h0BindGroup),this._h0BindGroup.setTexture("noise",this.getNoiseTexture(this._params.resolution,this._params.randomSeed),Gl("repeat_nearest_nomip")),this._h0BindGroup.setValue("resolution",this._params.resolution),this._h0BindGroup.setValue("wind",this._params.wind),this._h0BindGroup.setValue("alignment",this._params.alignment);for(let t=0;t<this._params.cascades.length;t++)this._cascades[t].x=this._params.cascades[t].size,this._cascades[t].y=.081*this._params.cascades[t].strength/(this._params.cascades[t].size*this._params.cascades[t].size),this._cascades[t].z=2*Math.PI/this._params.cascades[t].maxWave,this._cascades[t].w=2*Math.PI/this._params.cascades[t].minWave;this._h0BindGroup.setValue("cascade0",this._cascades[0]),this._h0BindGroup.setValue("cascade1",this._cascades[1]),this._h0BindGroup.setValue("cascade2",this._cascades[2]),"webgpu"===t.type?(this._h0BindGroup.setTexture("spectrum",e.h0Textures),t.compute(this._params.resolution/Mg,this._params.resolution/Mg,1)):(t.setFramebuffer(e.h0Framebuffer),t.clearFrameBuffer(O.zero(),null,null),Bg._globals.quad.draw())}getNoiseTexture(t,e){const i=Sl();let s=Bg._globals.noiseTextures.get(t);return s||(s=i.createTexture2D("webgl"===i.type?"rgba32f":"rg32f",t,t,{mipmapping:!1}),s.name=`noiseTex${t}`,s.update(this.getNoise2d(t,e,"webgl"===i.type),0,0,t,t),Bg._globals.noiseTextures.set(t,s)),s}getNoise2d(t,e,i){const s=new ut(e);if(i){const e=new Float32Array(t*t*4);for(let i=0;i<t*t;i++)e[4*i+0]=s.get(),e[4*i+1]=s.get();return e}return Float32Array.from([...Array(t*t*2)].map(()=>s.get()))}reverseBits(t,e){return parseInt(t.toString(2).padStart(e,"0").split("").reverse().join(""),2)}createButterflyTexture(t){const e=Math.log2(t),i=t,s=new Float32Array(e*i*4),r=2*Math.PI/t,a=[...Array(t).keys()].map(t=>this.reverseBits(t,e));for(let n=0;n<e;n++)for(let o=0;o<i;o++){const i=o*(t>>n+1),h=Math.cos(i*r),l=Math.sin(i*r),u=2**n,c=o%2**(n+1)<u?0:1,d=new O;0===n?0===c?d.setXYZW(h,l,a[o],a[o+1]):d.setXYZW(h,l,a[o-1],a[o]):0===c?d.setXYZW(h,l,o,o+u):d.setXYZW(h,l,o-u,o),s[4*(e*o+n)]=d[0],s[4*(e*o+n)+1]=d[1],s[4*(e*o+n)+2]=d[2],s[4*(e*o+n)+3]=d[3]}return s}getInstanceData(){if(!this._instanceData){const t=Sl(),e=this.createNTextures(t,this._h0TextureFormat,this._params.resolution,3,"Water-h0",!1),i=this.createNTextures(t,this._dataTextureFormat,this._params.resolution,6,"Water-data",!0),s=this.createNTextures(t,this._textureFormat,this._params.resolution,6,"Water-spectrum",!0),r=this.createNTextures(t,this._textureFormat,this._params.resolution,6,"Water-pingpong",!1);this._instanceData={dataTextures:i,h0Textures:e,pingpongTextures:r,spectrumTextures:s,h0Framebuffer:this._useComputeShader?null:t.createFrameBuffer(e,null),spectrumFramebuffer:this._useComputeShader||1!==this._renderMode?null:t.createFrameBuffer(s,null),spectrumFramebuffer2:2===this._renderMode?t.createFrameBuffer(s.slice(4,6),null):null,spectrumFramebuffer4:2===this._renderMode?t.createFrameBuffer(s.slice(0,4),null):null,pingpongFramebuffer:this._useComputeShader||1!==this._renderMode?null:t.createFrameBuffer(r,null),pingpongFramebuffer2:2===this._renderMode?t.createFrameBuffer(r.slice(4,6),null):null,pingpongFramebuffer4:2===this._renderMode?t.createFrameBuffer(r.slice(0,4),null):null,postIfft2Framebuffer:this._useComputeShader||1!==this._renderMode?null:t.createFrameBuffer(i,null),postIfft2Framebuffer2:2===this._renderMode?t.createFrameBuffer(i.slice(4,6),null):null,postIfft2Framebuffer4:2===this._renderMode?t.createFrameBuffer(i.slice(0,4),null):null}}return this._instanceData}createNTextures(t,e,i,s,r,a){const n={samplerOptions:{minFilter:a?"linear":"nearest",magFilter:a?"linear":"nearest",mipFilter:"none",addressU:"repeat",addressV:"repeat"},writable:!!this._useComputeShader,mipmapping:!1};if(this._useComputeShader){const a=t.createTexture2DArray(e,i,i,s,n);return a.name=r,a}return Array.from({length:s}).map((s,a)=>{const o=t.createTexture2D(e,i,i,n);return o.name=`${r}-${a}`,o})}update(t){const e=Sl();e.pushDeviceStates(),e.setRenderStates(this._updateRenderStates),this._resolutionChanged&&this.disposeInstanceData(),this._paramsChanged&&this.generateInitialSpectrum(),this._resolutionChanged=!1,this._paramsChanged=!1;for(let t=0;t<3;t++)this._sizes[t]=this._params.cascades[t].size,this._croppinesses[t]=this._params.cascades[t].croppiness;1===this._renderMode?(this.generateSpectrum(t),this.ifft2(),this.postIfft2()):(this.generateSpectrumTwoPass(t),this.ifft2TwoPass(),this.postIfft2TwoPass()),e.popDeviceStates()}needUpdate(){return!0}disposeNTextures(t){Array.isArray(t)?t.forEach(t=>t.dispose()):t&&t.dispose()}disposeInstanceData(){this._instanceData&&(this.disposeNTextures(this._instanceData.dataTextures),this._instanceData.dataTextures=null,this.disposeNTextures(this._instanceData.h0Textures),this._instanceData.h0Textures=null,this.disposeNTextures(this._instanceData.pingpongTextures),this._instanceData.pingpongTextures=null,this.disposeNTextures(this._instanceData.spectrumTextures),this._instanceData.spectrumTextures=null,this._instanceData.h0Framebuffer?.dispose(),this._instanceData.pingpongFramebuffer?.dispose(),this._instanceData.pingpongFramebuffer2?.dispose(),this._instanceData.pingpongFramebuffer4?.dispose(),this._instanceData.spectrumFramebuffer?.dispose(),this._instanceData.spectrumFramebuffer2?.dispose(),this._instanceData.spectrumFramebuffer4?.dispose(),this._instanceData.postIfft2Framebuffer?.dispose(),this._instanceData.postIfft2Framebuffer2?.dispose(),this._instanceData.postIfft2Framebuffer4?.dispose(),this._instanceData=null)}generateSpectrum(t){const e=Sl(),i=this.getInstanceData(),s=Gl("repeat_nearest_nomip");e.setProgram(Bg._globals.programs.hkProgram),e.setBindGroup(0,this._hkBindGroup),this._hkBindGroup.setValue("t",t),this._hkBindGroup.setValue("resolution",this._params.resolution),this._hkBindGroup.setValue("sizes",this._sizes),this._useComputeShader?(this._hkBindGroup.setTexture("h0Texture",i.h0Textures),this._hkBindGroup.setTexture("spectrum",i.spectrumTextures),e.compute(this._params.resolution/Mg,this._params.resolution/Mg,1)):(this._hkBindGroup.setTexture("h0Texture0",i.h0Textures[0],s),this._hkBindGroup.setTexture("h0Texture1",i.h0Textures[1],s),this._hkBindGroup.setTexture("h0Texture2",i.h0Textures[2],s),"webgl"===e.type&&this._hkBindGroup.setValue("h0TexSize",new L(i.h0Textures[0].width,i.h0Textures[0].height)),e.setFramebuffer(i.spectrumFramebuffer),Bg._globals.quad.draw())}generateSpectrumTwoPass(t){const e=Sl(),i=this.getInstanceData(),s=Gl("repeat_nearest_nomip");e.setProgram(Bg._globals.programs.hkProgram4),e.setBindGroup(0,this._hkBindGroup4),this._hkBindGroup4.setValue("resolution",this._params.resolution),this._hkBindGroup4.setValue("sizes",this._sizes),this._hkBindGroup4.setTexture("h0Texture0",i.h0Textures[0],s),this._hkBindGroup4.setTexture("h0Texture1",i.h0Textures[1],s),this._hkBindGroup4.setValue("t",t),"webgl"===e.type&&this._hkBindGroup4.setValue("h0TexSize",new L(i.h0Textures[0].width,i.h0Textures[0].height)),e.setFramebuffer(i.spectrumFramebuffer4),Bg._globals.quad.draw(),e.setProgram(Bg._globals.programs.hkProgram2),e.setBindGroup(0,this._hkBindGroup2),this._hkBindGroup2.setValue("resolution",this._params.resolution),this._hkBindGroup2.setValue("sizes",this._sizes),this._hkBindGroup2.setTexture("h0Texture2",i.h0Textures[2],s),this._hkBindGroup2.setValue("t",t),"webgl"===e.type&&this._hkBindGroup2.setValue("h0TexSize",new L(i.h0Textures[0].width,i.h0Textures[0].height)),e.setFramebuffer(i.spectrumFramebuffer2),Bg._globals.quad.draw()}ifft2(){const t=Sl(),e=this.getInstanceData(),i=Gl("repeat_nearest_nomip"),s=Math.log2(this._params.resolution),r=[e.spectrumTextures,e.pingpongTextures],a=this._useComputeShader?[e.pingpongTextures,e.spectrumTextures]:[e.pingpongFramebuffer,e.spectrumFramebuffer],n=this.getButterflyTexture(this._params.resolution);let o=0;t.setProgram(Bg._globals.programs.fft2hProgram),t.setBindGroup(0,this._fft2hBindGroup),this._fft2hBindGroup.setTexture("butterfly",n,i);for(let e=0;e<s;e++)this._fft2hBindGroup.setValue("phase",e),this._useComputeShader?(this._fft2hBindGroup.setTexture("spectrum",r[o],i),this._fft2hBindGroup.setTexture("ifft",a[o]),t.compute(this._params.resolution/Mg,this._params.resolution/Mg,1)):(t.setFramebuffer(a[o]),this._fft2hBindGroup.setTexture("spectrum0",r[o][0],i),this._fft2hBindGroup.setTexture("spectrum1",r[o][1],i),this._fft2hBindGroup.setTexture("spectrum2",r[o][2],i),this._fft2hBindGroup.setTexture("spectrum3",r[o][3],i),this._fft2hBindGroup.setTexture("spectrum4",r[o][4],i),this._fft2hBindGroup.setTexture("spectrum5",r[o][5],i),"webgl"===t.type&&this._fft2hBindGroup.setValue("texSize",new O(r[o][0].width,r[o][0].height,n.width,n.height)),Bg._globals.quad.draw()),o=1-o;t.setProgram(Bg._globals.programs.fft2vProgram),t.setBindGroup(0,this._fft2vBindGroup),this._fft2vBindGroup.setTexture("butterfly",n,i);for(let e=0;e<s;e++)this._fft2vBindGroup.setValue("phase",e),this._useComputeShader?(this._fft2vBindGroup.setTexture("spectrum",r[o],i),this._fft2vBindGroup.setTexture("ifft",a[o]),t.compute(this._params.resolution/Mg,this._params.resolution/Mg,1)):(t.setFramebuffer(a[o]),this._fft2vBindGroup.setTexture("spectrum0",r[o][0],i),this._fft2vBindGroup.setTexture("spectrum1",r[o][1],i),this._fft2vBindGroup.setTexture("spectrum2",r[o][2],i),this._fft2vBindGroup.setTexture("spectrum3",r[o][3],i),this._fft2vBindGroup.setTexture("spectrum4",r[o][4],i),this._fft2vBindGroup.setTexture("spectrum5",r[o][5],i),"webgl"===t.type&&this._fft2vBindGroup.setValue("texSize",new O(r[o][0].width,r[o][0].height,n.width,n.height)),Bg._globals.quad.draw()),o=1-o;this._ifftTextures=r[o]}getFFT2hBindGroup2(t,e){let i=this._fft2hBindGroup2Used[e].pop();return i||(i=t.createBindGroup(Bg._globals.programs.fft2hProgram2.bindGroupLayouts[0])),this._fft2hBindGroup2Free[e].push(i),i}getFFT2hBindGroup4(t,e){let i=this._fft2hBindGroup4Used[e].pop();return i||(i=t.createBindGroup(Bg._globals.programs.fft2hProgram4.bindGroupLayouts[0])),this._fft2hBindGroup4Free[e].push(i),i}getFFT2vBindGroup2(t,e){let i=this._fft2vBindGroup2Used[e].pop();return i||(i=t.createBindGroup(Bg._globals.programs.fft2vProgram2.bindGroupLayouts[0])),this._fft2vBindGroup2Free[e].push(i),i}getFFT2vBindGroup4(t,e){let i=this._fft2vBindGroup4Used[e].pop();return i||(i=t.createBindGroup(Bg._globals.programs.fft2vProgram4.bindGroupLayouts[0])),this._fft2vBindGroup4Free[e].push(i),i}ifft2TwoPass(){const t=Sl(),e=this.getInstanceData(),i=Gl("repeat_nearest_nomip"),s=Math.log2(this._params.resolution),r=[e.spectrumTextures,e.pingpongTextures],a=[e.pingpongFramebuffer4,e.spectrumFramebuffer4],n=[e.pingpongFramebuffer2,e.spectrumFramebuffer2],o=this.getButterflyTexture(this._params.resolution);let h=0;for(let e=0;e<s;e++){t.setFramebuffer(a[h]),t.setProgram(Bg._globals.programs.fft2hProgram4);const s=this.getFFT2hBindGroup4(t,h);t.setBindGroup(0,s),s.setTexture("butterfly",o,i),s.setValue("phase",e),s.setTexture("spectrum0",r[h][0],i),s.setTexture("spectrum1",r[h][1],i),s.setTexture("spectrum2",r[h][2],i),s.setTexture("spectrum3",r[h][3],i),"webgl"===t.type&&s.setValue("texSize",new O(r[h][0].width,r[h][0].height,o.width,o.height)),Bg._globals.quad.draw(),t.setFramebuffer(n[h]),t.setProgram(Bg._globals.programs.fft2hProgram2);const l=this.getFFT2hBindGroup2(t,h);t.setBindGroup(0,l),l.setTexture("butterfly",o,i),l.setValue("phase",e),l.setTexture("spectrum4",r[h][4],i),l.setTexture("spectrum5",r[h][5],i),"webgl"===t.type&&l.setValue("texSize",new O(r[h][0].width,r[h][0].height,o.width,o.height)),Bg._globals.quad.draw(),h=(h+1)%2}for(let e=0;e<s;e++){t.setFramebuffer(a[h]),t.setProgram(Bg._globals.programs.fft2vProgram4);const s=this.getFFT2vBindGroup4(t,h);t.setBindGroup(0,s),s.setTexture("butterfly",o,i),s.setValue("phase",e),s.setTexture("spectrum0",r[h][0],i),s.setTexture("spectrum1",r[h][1],i),s.setTexture("spectrum2",r[h][2],i),s.setTexture("spectrum3",r[h][3],i),"webgl"===t.type&&s.setValue("texSize",new O(r[h][0].width,r[h][0].height,o.width,o.height)),Bg._globals.quad.draw(),t.setFramebuffer(n[h]),t.setProgram(Bg._globals.programs.fft2vProgram2);const l=this.getFFT2vBindGroup2(t,h);t.setBindGroup(0,l),l.setTexture("butterfly",o,i),l.setValue("phase",e),l.setTexture("spectrum4",r[h][4],i),l.setTexture("spectrum5",r[h][5],i),"webgl"===t.type&&l.setValue("texSize",new O(r[h][0].width,r[h][0].height,o.width,o.height)),Bg._globals.quad.draw(),h=(h+1)%2}this._ifftTextures=r[h];for(let t=0;t<2;t++)this._fft2hBindGroup2Used[t].push(...this._fft2hBindGroup2Free[t]),this._fft2hBindGroup2Free[t].length=0,this._fft2hBindGroup4Used[t].push(...this._fft2hBindGroup4Free[t]),this._fft2hBindGroup4Free[t].length=0,this._fft2vBindGroup2Used[t].push(...this._fft2vBindGroup2Free[t]),this._fft2vBindGroup2Free[t].length=0,this._fft2vBindGroup4Used[t].push(...this._fft2vBindGroup4Free[t]),this._fft2vBindGroup4Free[t].length=0}postIfft2(){const t=Sl(),e=this.getInstanceData(),i=Gl("repeat_nearest_nomip");t.setProgram(Bg._globals.programs.postfft2Program),t.setBindGroup(0,this._postfft2BindGroup),this._postfft2BindGroup.setValue("N2",this._params.resolution*this._params.resolution),this._useComputeShader?(this._postfft2BindGroup.setTexture("output",e.dataTextures),this._postfft2BindGroup.setTexture("ifft",this._ifftTextures,i),t.compute(this._params.resolution/Mg,this._params.resolution/Mg,1)):(t.setFramebuffer(e.postIfft2Framebuffer),this._postfft2BindGroup.setTexture("ifft0",this._ifftTextures[0],i),this._postfft2BindGroup.setTexture("ifft1",this._ifftTextures[1],i),this._postfft2BindGroup.setTexture("ifft2",this._ifftTextures[2],i),this._postfft2BindGroup.setTexture("ifft3",this._ifftTextures[3],i),this._postfft2BindGroup.setTexture("ifft4",this._ifftTextures[4],i),this._postfft2BindGroup.setTexture("ifft5",this._ifftTextures[5],i),"webgl"===t.type&&this._postfft2BindGroup.setValue("ifftTexSize",new L(this._ifftTextures[0].width,this._ifftTextures[0].height)),Bg._globals.quad.draw())}postIfft2TwoPass(){const t=Sl(),e=this.getInstanceData(),i=Gl("repeat_nearest_nomip");t.setFramebuffer(e.postIfft2Framebuffer4),t.setProgram(Bg._globals.programs.postfft2Program4),t.setBindGroup(0,this._postfft2BindGroup4),this._postfft2BindGroup4.setValue("N2",this._params.resolution*this._params.resolution),this._postfft2BindGroup4.setTexture("ifft0",this._ifftTextures[0],i),this._postfft2BindGroup4.setTexture("ifft1",this._ifftTextures[1],i),this._postfft2BindGroup4.setTexture("ifft2",this._ifftTextures[2],i),this._postfft2BindGroup4.setTexture("ifft3",this._ifftTextures[3],i),"webgl"===t.type&&this._postfft2BindGroup4.setValue("ifftTexSize",new L(this._ifftTextures[0].width,this._ifftTextures[0].height)),Bg._globals.quad.draw(),t.setFramebuffer(e.postIfft2Framebuffer2),t.setProgram(Bg._globals.programs.postfft2Program2),t.setBindGroup(0,this._postfft2BindGroup2),this._postfft2BindGroup2.setValue("N2",this._params.resolution*this._params.resolution),this._postfft2BindGroup2.setTexture("ifft4",this._ifftTextures[4],i),this._postfft2BindGroup2.setTexture("ifft5",this._ifftTextures[5],i),"webgl"===t.type&&this._postfft2BindGroup2.setValue("ifftTexSize",new L(this._ifftTextures[0].width,this._ifftTextures[0].height)),Bg._globals.quad.draw()}setupUniforms(t,e){const i=t.$builder;t.sizes=i.vec4().uniform(e),t.croppinesses=i.vec4().uniform(e),this._useComputeShader?t.dataTexture=i.tex2DArray().uniform(e):(t.dx_hy_dz_dxdz0=i.tex2D().uniform(e),t.sx_sz_dxdx_dzdz0=i.tex2D().uniform(e),t.dx_hy_dz_dxdz1=i.tex2D().uniform(e),t.sx_sz_dxdx_dzdz1=i.tex2D().uniform(e),t.dx_hy_dz_dxdz2=i.tex2D().uniform(e),t.sx_sz_dxdx_dzdz2=i.tex2D().uniform(e)),"fragment"===i.shaderKind&&(t.foamParams=i.vec2().uniform(e))}calcVertexPositionAndNormal(t,e,i,s){const r=t.$builder,a=this;r.func("calcPositionAndNormal",[r.vec3("inPos"),r.vec3("outPos").out(),r.vec3("outNormal").out()],function(){this.$l.xz=this.inPos.xz,this.$l.uv0=r.div(this.xz,this.sizes.x),this.$l.uv1=r.div(this.xz,this.sizes.y),this.$l.uv2=r.div(this.xz,this.sizes.z),a._useComputeShader?(this.$l.a=r.mul(r.textureArraySampleLevel(this.dataTexture,this.uv0,0,0).rgb,r.vec3(this.croppinesses.x,1,this.croppinesses.x)),this.$l.b=r.mul(r.textureArraySampleLevel(this.dataTexture,this.uv1,2,0).rgb,r.vec3(this.croppinesses.y,1,this.croppinesses.y)),this.$l.c=r.mul(r.textureArraySampleLevel(this.dataTexture,this.uv2,4,0).rgb,r.vec3(this.croppinesses.z,1,this.croppinesses.z))):(this.$l.a=r.mul(r.textureSampleLevel(this.dx_hy_dz_dxdz0,this.uv0,0).rgb,r.vec3(this.croppinesses.x,1,this.croppinesses.x)),this.$l.b=r.mul(r.textureSampleLevel(this.dx_hy_dz_dxdz1,this.uv1,0).rgb,r.vec3(this.croppinesses.y,1,this.croppinesses.y)),this.$l.c=r.mul(r.textureSampleLevel(this.dx_hy_dz_dxdz2,this.uv2,0).rgb,r.vec3(this.croppinesses.z,1,this.croppinesses.z))),this.$l.displacement=r.add(this.a,this.b,this.c),this.outPos=r.add(this.inPos,this.displacement),this.outNormal=r.vec3(0,1,0)}),t.calcPositionAndNormal(e,i,s)}calcFragmentNormal(t,e,i){const s=t.$builder,r=this;return s.func("calcFragmentNormal",[s.vec2("xz")],function(){this.$l.uv0=s.div(this.xz,this.sizes.x),this.$l.uv1=s.div(this.xz,this.sizes.y),this.$l.uv2=s.div(this.xz,this.sizes.z),r._useComputeShader?(this.$l._sx_sz_dxdx_dzdz0=s.textureArraySampleLevel(this.dataTexture,this.uv0,1,0),this.$l._sx_sz_dxdx_dzdz1=s.textureArraySampleLevel(this.dataTexture,this.uv1,3,0),this.$l._sx_sz_dxdx_dzdz2=s.textureArraySampleLevel(this.dataTexture,this.uv2,5,0)):(this.$l._sx_sz_dxdx_dzdz0=s.textureSampleLevel(this.sx_sz_dxdx_dzdz0,this.uv0,0),this.$l._sx_sz_dxdx_dzdz1=s.textureSampleLevel(this.sx_sz_dxdx_dzdz1,this.uv1,0),this.$l._sx_sz_dxdx_dzdz2=s.textureSampleLevel(this.sx_sz_dxdx_dzdz2,this.uv2,0)),this.$l.sx=s.add(this._sx_sz_dxdx_dzdz0.x,this._sx_sz_dxdx_dzdz1.x,this._sx_sz_dxdx_dzdz2.x),this.$l.sz=s.add(this._sx_sz_dxdx_dzdz0.y,this._sx_sz_dxdx_dzdz1.y,this._sx_sz_dxdx_dzdz2.y),this.$l.dxdx_dzdz=s.add(s.mul(this._sx_sz_dxdx_dzdz0.zw,this.croppinesses.x),s.mul(this._sx_sz_dxdx_dzdz1.zw,this.croppinesses.y),s.mul(this._sx_sz_dxdx_dzdz2.zw,this.croppinesses.z)),this.$l.slope=s.vec2(s.div(this.sx,s.add(1,this.dxdx_dzdz.x)),s.div(this.sz,s.add(1,this.dxdx_dzdz.y))),this.$l.normal=s.normalize(s.vec3(s.neg(this.slope.x),1,s.neg(this.slope.y))),this.$return(this.normal)}),t.calcFragmentNormal(e)}calcFragmentNormalAndFoam(t,e){const i=t.$builder,s=this;return i.func("jacobian",[i.float("dxdx"),i.float("dxdz"),i.float("dzdz")],function(){this.$l.Jxx=i.add(this.dxdx,1),this.$l.Jxz=this.dxdz,this.$l.Jzz=i.add(this.dzdz,1),this.$return(i.vec4(this.Jxx,this.Jxz,this.Jxz,this.Jzz))}),i.func("det",[i.vec4("jacobian")],function(){this.$return(i.sub(i.mul(this.jacobian.x,this.jacobian.w),i.mul(this.jacobian.y,this.jacobian.z)))}),i.func("calcNormalAndFoam",[i.vec2("xz")],function(){this.$l.uv0=i.div(this.xz,this.sizes.x),this.$l.uv1=i.div(this.xz,this.sizes.y),this.$l.uv2=i.div(this.xz,this.sizes.z),s._useComputeShader?(this.$l._sx_sz_dxdx_dzdz0=i.textureArraySampleLevel(this.dataTexture,this.uv0,1,0),this.$l._sx_sz_dxdx_dzdz1=i.textureArraySampleLevel(this.dataTexture,this.uv1,3,0),this.$l._sx_sz_dxdx_dzdz2=i.textureArraySampleLevel(this.dataTexture,this.uv2,5,0)):(this.$l._sx_sz_dxdx_dzdz0=i.textureSampleLevel(this.sx_sz_dxdx_dzdz0,this.uv0,0),this.$l._sx_sz_dxdx_dzdz1=i.textureSampleLevel(this.sx_sz_dxdx_dzdz1,this.uv1,0),this.$l._sx_sz_dxdx_dzdz2=i.textureSampleLevel(this.sx_sz_dxdx_dzdz2,this.uv2,0)),this.$l.sx=i.add(this._sx_sz_dxdx_dzdz0.x,this._sx_sz_dxdx_dzdz1.x,this._sx_sz_dxdx_dzdz2.x),this.$l.sz=i.add(this._sx_sz_dxdx_dzdz0.y,this._sx_sz_dxdx_dzdz1.y,this._sx_sz_dxdx_dzdz2.y),this.$l.dxdx_dzdz=i.add(i.mul(this._sx_sz_dxdx_dzdz0.zw,this.croppinesses.x),i.mul(this._sx_sz_dxdx_dzdz1.zw,this.croppinesses.y),i.mul(this._sx_sz_dxdx_dzdz2.zw,this.croppinesses.z)),this.$l.slope=i.vec2(i.div(this.sx,i.add(1,this.dxdx_dzdz.x)),i.div(this.sz,i.add(1,this.dxdx_dzdz.y))),this.$l.normal=i.normalize(i.vec3(i.neg(this.slope.x),1,i.neg(this.slope.y))),this.$l.dxdx_dzdz0=this._sx_sz_dxdx_dzdz0.zw,this.$l.dxdx_dzdz1=this._sx_sz_dxdx_dzdz1.zw,this.$l.dxdx_dzdz2=this._sx_sz_dxdx_dzdz2.zw,s._useComputeShader?(this.$l.dxdz0=i.textureArraySampleLevel(this.dataTexture,this.uv0,0,0).w,this.$l.dxdz1=i.textureArraySampleLevel(this.dataTexture,this.uv1,2,0).w,this.$l.dxdz2=i.textureArraySampleLevel(this.dataTexture,this.uv2,4,0).w):(this.$l.dxdz0=i.textureSampleLevel(this.dx_hy_dz_dxdz0,this.uv0,0).w,this.$l.dxdz1=i.textureSampleLevel(this.dx_hy_dz_dxdz1,this.uv1,0).w,this.$l.dxdz2=i.textureSampleLevel(this.dx_hy_dz_dxdz2,this.uv2,0).w),this.$l.dxdz=i.add(i.mul(this.dxdz0,this.croppinesses.x),i.mul(this.dxdz1,this.croppinesses.y),i.mul(this.dxdz2,this.croppinesses.z)),this.$l.val=this.det(this.jacobian(this.dxdx_dzdz.x,this.dxdz,this.dxdx_dzdz.y)),this.$l.foam=i.abs(i.pow(i.neg(i.min(0,i.sub(this.val,this.foamParams.x))),this.foamParams.y)),this.$return(i.vec4(this.normal,this.foam))}),t.calcNormalAndFoam(e)}isOk(){return 0!==this._renderMode}applyWaterBindGroup(t){const e=this.getInstanceData(),i=Gl("repeat_linear_nomip");this._useComputeShader?t.setTexture("dataTexture",e.dataTextures,i):(t.setTexture("dx_hy_dz_dxdz0",e.dataTextures[0],i),t.setTexture("sx_sz_dxdx_dzdz0",e.dataTextures[1],i),t.setTexture("dx_hy_dz_dxdz1",e.dataTextures[2],i),t.setTexture("sx_sz_dxdx_dzdz1",e.dataTextures[3],i),t.setTexture("dx_hy_dz_dxdz2",e.dataTextures[4],i),t.setTexture("sx_sz_dxdx_dzdz2",e.dataTextures[5],i)),t.setValue("foamParams",this._params.foamParams),t.setValue("sizes",this._sizes),t.setValue("croppinesses",this._croppinesses)}calcClipmapTileAABB(t,e,i,s,r,a){const n=Math.max(Math.abs(this.wind.x),Math.abs(this.wind.y),2);a.minPoint.setXYZ(t-8*n,r-8*n,i-8*n),a.maxPoint.setXYZ(e+8*n,r+8*n,s+8*n)}getHash(){return"FFTWaveGenerator"}onDispose(){super.onDispose(),this.disposeInstanceData()}}function Ig(t){return{ctor:b_,name:"Water",parent:Nf,createFunc(t){const e=new b_(t.scene);return e.parent=t,{obj:e}},getProps:()=>[{name:"WaveGenerator",type:"object",default:null,options:{objectTypes:[Bg,g_]},isNullable:()=>!0,get(t){t.object[0]=this.waveGenerator??null},set(t){t.object[0]?this.waveGenerator=t.object[0]:this.waveGenerator=null}},{name:"GridScale",type:"float",default:1,options:{minValue:0,maxValue:1},get(t){t.num[0]=this.gridScale},set(t){this.gridScale=t.num[0]}},{name:"Wireframe",type:"bool",default:!1,get(t){t.bool[0]=this.wireframe},set(t){this.wireframe=t.bool[0]}},{name:"AnimationSpeed",type:"float",default:1,options:{animatable:!0,minValue:0,maxValue:100},get(t){t.num[0]=this.animationSpeed},set(t){this.animationSpeed=t.num[0]}},{name:"DepthScale",type:"float",default:10,options:{animatable:!0,minValue:0,maxValue:100},get(t){t.num[0]=this.material.depthMulti},set(t){this.material.depthMulti=t.num[0]}},{name:"RefractionStrength",type:"float",default:0,options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.material.refractionStrength},set(t){this.material.refractionStrength=t.num[0]}},{name:"Displace",type:"float",default:16,options:{minValue:1,maxValue:256},get(t){t.num[0]=this.material.displace},set(t){this.material.displace=t.num[0]}},{name:"TAAStrength",type:"float",default:.4,options:{minValue:0,maxValue:1},get(t){t.num[0]=this.TAAStrength},set(t){this.TAAStrength=t.num[0]}},{name:"ScatterRampTexture",type:"object",default:null,isNullable:()=>!0,get(e){e.str[0]=t.getAssetId(this.material.scatterRampTexture)??""},async set(e){if(e){if(e.str[0]){const i=e.str[0];let s;try{s=await t.fetchTexture(i)}catch(t){console.error(`Load asset failed: ${e.str[0]}: ${t}`),s=null}s?.isTexture2D()?this.material.scatterRampTexture=s:console.error("Invalid texture type")}}else this.material.scatterRampTexture=null}},{name:"AbsorptionRampTexture",type:"object",default:null,isNullable:()=>!0,get(e){e.str[0]=t.getAssetId(this.material.absorptionRampTexture)??""},async set(e){if(e){if(e.str[0]){const i=e.str[0];let s;try{s=await t.fetchTexture(i)}catch(t){console.error(`Load asset failed: ${e.str[0]}: ${t}`),s=null}s?.isTexture2D()?this.material.absorptionRampTexture=s:console.error("Invalid texture type")}}else this.material.absorptionRampTexture=null}}]}}class Pg extends cu{_state;_stateAlpha;_prop;_count;_interpolator;_interpolatorAlpha;constructor(t,e,i){switch(super(i),this._prop=t,this._state={num:[0,0,0,0]},this._stateAlpha=null,this._interpolator=null,this._interpolatorAlpha=null,e&&(this._state.num=e.slice()),this._prop.type){case"float":this._count=1,this._interpolator=new ot("cubicspline-natural","number",new Float32Array([0,1]),new Float32Array([this._state.num[0],this._state.num[0]]));break;case"vec2":this._count=2,this._interpolator=new ot("cubicspline-natural","vec2",new Float32Array([0,1]),new Float32Array([...this._state.num.slice(0,2),...this._state.num.slice(0,2)]));break;case"rgb":case"vec3":this._count=3,this._interpolator=new ot("cubicspline-natural","vec3",new Float32Array([0,1]),new Float32Array([...this._state.num.slice(0,3),...this._state.num.slice(0,3)]));break;case"vec4":this._count=4,this._interpolator=new ot("cubicspline-natural","vec4",new Float32Array([0,1]),new Float32Array([...this._state.num.slice(0,4),...this._state.num.slice(0,4)]));break;case"rgba":this._count=4,this._interpolator=new ot("linear","vec3",new Float32Array([0,1]),new Float32Array([...this._state.num.slice(0,3),...this._state.num.slice(0,3)])),this._interpolatorAlpha=new ot("linear","number",new Float32Array([0,1]),new Float32Array([this._state.num[3],this._state.num[3]])),this._stateAlpha={num:[this._state.num[3]]};break;default:throw new Error(`Property '${this._prop.name}' cannot be animated`)}}get interpolator(){return this._interpolator}set interpolator(t){this._interpolator=t}get interpolatorAlpha(){return this._interpolatorAlpha}set interpolatorAlpha(t){this._interpolatorAlpha=t??null,!this._stateAlpha&&this._interpolatorAlpha&&(this._stateAlpha={num:[0]})}calculateState(t,e){return this._interpolator.interpolate(e,this._state.num),this._interpolatorAlpha&&(this._interpolatorAlpha.interpolate(e,this._stateAlpha.num),this._state.num[3]=this._stateAlpha.num[0]),this._state}applyState(t,e){this._prop.set.call(t,e)}mixState(t,e,i){const s=[];for(let r=0;r<this._count;r++)s[r]=t.num[r]+i*(e.num[r]-t.num[r]);return{num:s}}getBlendId(){return this._prop}getDuration(){return this._interpolator.maxTime}getProp(){return this._prop}}function $g(t,e){const i=Sl(),s=t.numTargets;if(0===s)return;const r=Object.getOwnPropertyNames(t.targets),a=t.primitive.get().getNumVertices(),n=new Float32Array(268);for(let t=0;t<s;t++)n[4+t]=e?.[t]??0;const o=Math.ceil(Math.sqrt(a*r.length*s));if(o>i.getDeviceCaps().textureCaps.maxTextureSize)throw new Error("Morph target data too large");n[0]=o,n[1]=o,n[2]=a,n[3]=s;let h=0;const l=new Float32Array(o*o*4);for(let e=0;e<8;e++){if(r.indexOf(String(e))<0){n[260+e]=-1;continue}n[260+e]=h>>2;const i=t.targets[e];if(i.data.length!==s)return void console.error("Invalid morph target data");for(let t=0;t<s;t++){const e=i.data[t];for(let t=0;t<a;t++)for(let s=0;s<4;s++)l[h++]=s<i.numComponents?e[t*i.numComponents+s]:1}}const u=new hu;Rg(u,t.targetBox,n.subarray(4,260),s);const c=t.mesh.getBoundingVolume().toAABB();u.minPoint.addBy(c.minPoint),u.maxPoint.addBy(c.maxPoint),t.mesh.setMorphData({width:o,height:o,data:l}),t.mesh.setMorphInfo({data:n}),t.mesh.setAnimatedBoundingBox(u)}function Rg(t,e,i,s){t.minPoint.setXYZ(0,0,0),t.maxPoint.setXYZ(0,0,0);for(let r=0;r<s;r++){const s=i[r],a=e[r];t.minPoint.x+=a.minPoint.x*s,t.minPoint.y+=a.minPoint.y*s,t.minPoint.y+=a.minPoint.z*s,t.maxPoint.x+=a.maxPoint.x*s,t.maxPoint.y+=a.maxPoint.y*s,t.maxPoint.y+=a.maxPoint.z*s}}class Fg extends cu{_state;_originBox;_boundingBox;_defaultWeights;_interpolator;constructor(t,e,i,s,r){super(r),void 0===t?(this._interpolator=null,this._state=null,this._boundingBox=null,this._originBox=null,this._defaultWeights=null):(this._interpolator=t,this._state={numTargets:t.stride,boundingBox:new hu,weights:new Float32Array(_u)},this._boundingBox=i,this._originBox=s,this._defaultWeights=e??Array.from({length:this._state.numTargets}).map(()=>0))}get interpolator(){return this._interpolator}set interpolator(t){this._interpolator=t??null,this._state=this._interpolator?{numTargets:this._interpolator.stride,boundingBox:new hu,weights:new Float32Array(_u)}:null}get boundingBox(){return this._boundingBox}set boundingBox(t){this._boundingBox=t}get defaultWeights(){return this._defaultWeights}set defaultWeights(t){this._defaultWeights=t}get originBoundingBox(){return this._originBox}set originBoundingBox(t){this._originBox=t}calculateState(t,e){return this._interpolator.interpolate(e,this._state.weights),Rg(this._state.boundingBox,this._boundingBox,this._state.weights,this._state.numTargets),this._state}applyState(t,e){t.getMorphInfo().buffer.get().bufferSubData(16,e.weights),e.boundingBox.minPoint.addBy(this._originBox.minPoint),e.boundingBox.maxPoint.addBy(this._originBox.maxPoint),t.setAnimatedBoundingBox(e.boundingBox)}mixState(t,e,i){const s={weights:new Float32Array(t.numTargets),boundingBox:new hu,numTargets:t.numTargets};for(let r=0;r<t.numTargets;r++)s.weights[r]=t.weights[r]+(e.weights[r]-t.weights[r])*i,s.boundingBox.minPoint=z.min(t.boundingBox.minPoint,e.boundingBox.minPoint),s.boundingBox.maxPoint=z.max(t.boundingBox.maxPoint,e.boundingBox.maxPoint);return s}getBlendId(){return"node-morph"}getDuration(){return this._interpolator.maxTime}reset(t){this._state.weights.set(this._defaultWeights),this.applyState(t,this._state)}}function Dg(t){return{ctor:Pg,name:"PropertyTrack",createFunc:(e,i)=>({obj:new Pg(t.getPropertyByName(i))}),getInitParams:e=>t.getPropertyName(e.getProp()),getProps:()=>[{name:"TrackName",type:"string",options:{label:"Name"},get(t){t.str[0]=this.name},set(t){this.name=t.str[0]}},{name:"TrackTarget",type:"string",options:{label:"Target"},get(t){t.str[0]=this.target},set(t){this.target=t.str[0]}},{name:"TrackProp",type:"string",get(e){e.str[0]=t.getPropertyName(this.getProp())}},{name:"TrackData",type:"object_array",options:{objectTypes:[ot]},isHidden:t=>t>=0,get(t){t.object=this.interpolatorAlpha?[this.interpolator,this.interpolatorAlpha]:[this.interpolator]},set(t){this.interpolator=t.object[0],this.interpolatorAlpha=t.object[1]}}]}}class Ng{name;constructor(t){this.name=t}}class Lg extends Ng{_parent;_position;_rotation;_scaling;_mesh;_skeleton;_attachToSkeleton;_meshAttached;_matrix;_worldMatrix;_weights;_children;_instances;constructor(t,e){super(t),this._parent=null,this._position=z.zero(),this._rotation=U.identity(),this._scaling=z.one(),this._children=[],this._mesh=null,this._skeleton=null,this._attachToSkeleton=null,this._meshAttached=!1,this._matrix=null,this._weights=null,this._worldMatrix=null,this._instances=[],e?.addChild(this)}get parent(){return this._parent}get matrix(){return this._matrix}get worldMatrix(){return this._worldMatrix}get mesh(){return this._mesh}set mesh(t){this._mesh=t,this.setMeshAttached()}get instances(){return this._instances}get weights(){return this._weights}set weights(t){this._weights=t}get skeleton(){return this._skeleton}set skeleton(t){this._skeleton=t}get position(){return this._position}set position(t){this._position=t}get rotation(){return this._rotation}set rotation(t){this._rotation=t}get scaling(){return this._scaling}set scaling(t){this._scaling=t}get meshAttached(){return this._meshAttached}get children(){return this._children}get skeletonAttached(){return this._attachToSkeleton}computeTransforms(t){this._matrix=W.scaling(this._scaling).rotateLeft(this._rotation).translateLeft(this._position),this._worldMatrix=t?W.multiply(t,this._matrix):new W(this._matrix);for(const t of this._children)t.computeTransforms(this._worldMatrix)}addChild(t){if(!t||t.parent)throw new Error("AssetHierarchyNode.addChild(): invalid child node");this._children.push(t),t._parent=this,t.meshAttached&&this.setMeshAttached()}removeChild(t){const e=this._children.indexOf(t);if(e<0)throw new Error("AssetHierarchyNode.removeChild(): invalid child node");this._children[e]._parent=null,this._children.splice(e,1)}attachToSkeleton(t){this._attachToSkeleton||(this._attachToSkeleton=new Set),this._attachToSkeleton.add(t)}setMeshAttached(){this._meshAttached=!0,this._parent?.setMeshAttached()}}class zg extends Ng{pivot;joints;inverseBindMatrices;bindPoseMatrices;constructor(t){super(t),this.name=t,this.pivot=null,this.joints=[],this.inverseBindMatrices=[],this.bindPoseMatrices=[]}addJoint(t,e){t.attachToSkeleton(this),this.joints.push(t),this.inverseBindMatrices.push(e),this.bindPoseMatrices.push(t.worldMatrix)}}class Vg extends Ng{rootNodes;constructor(t){super(t),this.rootNodes=[]}}class Og extends gt{_name;_skeletons;_nodes;_animations;_scenes;_activeScene;constructor(t){super(),this._name=t||"",this._skeletons=[],this._nodes=[],this._scenes=[],this._animations=[],this._activeScene=-1}get name(){return this._name}set name(t){this._name=t}get scenes(){return this._scenes}get animations(){return this._animations}get skeletons(){return this._skeletons}get nodes(){return this._nodes}get activeScene(){return this._activeScene}set activeScene(t){this._activeScene=t}addNode(t,e,i){const s=new Lg(i,t);return this._nodes[e]=s,s}addSkeleton(t){this._skeletons.push(t)}addAnimation(t){this._animations.push(t)}createSceneNode(t,e){const i=new Au(t);i.name=this.name;const s=i.animationSet;for(let r=0;r<this.scenes.length;r++){const a=this.scenes[r],n=new Map,o=new Map;for(let s=0;s<a.rootNodes.length;s++)this.setAssetNodeToSceneNode(t,i,a.rootNodes[s],n,o,e);for(const t of this.animations){let e=t.name??"_embbeded_animation";if(s.getAnimationClip(e)){const t=e;for(let i=1;e=`${t}_${i}`,s.getAnimationClip(e);i++);}const i=s.createAnimation(e,!0);for(const e of t.tracks)if("translation"===e.type)i.addTrack(o.get(e.node),new J_(e.interpolator,!0));else if("scale"===e.type)i.addTrack(o.get(e.node),new eg(e.interpolator,!0));else if("rotation"===e.type)i.addTrack(o.get(e.node),new tg(e.interpolator,!0));else if("weights"===e.type)for(const t of e.node.mesh.subMeshes)if(e.interpolator.stride>_u)console.error(`Morph target too large: ${e.interpolator.stride}, the maximum is 256`);else{const s=new Fg(e.interpolator,e.defaultMorphWeights,t.targetBox,t.mesh.getBoundingVolume().toAABB(),!0);i.addTrack(t.mesh,s)}else console.error(`Invalid animation track type: ${e.type}`);for(const e of t.skeletons){const t=n.get(e);if(t){if(!t.skeleton){t.skeleton=new Su(e.joints.map(t=>o.get(t)),e.inverseBindMatrices,e.bindPoseMatrices);for(let e=0;e<t.mesh.length;e++){const i=t.mesh[e],s={positions:t.bounding[e].rawPositions,blendIndices:t.bounding[e].rawBlendIndices,weights:t.bounding[e].rawJointWeights};i.setSkinnedBoundingInfo(t.skeleton.getBoundingInfo(s)),i.skeletonName=t.skeleton.persistentId}s.skeletons.push(new wt(t.skeleton))}i.addSkeleton(t.skeleton.persistentId)}}}}return i.iterate(t=>{t!==i&&(t.sealed=!0)}),i.sharedModel=this,i}onDispose(){super.onDispose();const t=[...this._nodes];for(;t.length>0;){const e=t.shift();t.push(...e.children);const i=e.mesh;if(i)for(const t of i.subMeshes)t.primitive?.dispose(),t.material?.dispose()}this._nodes=[],this._skeletons=[],this._scenes=[],this._animations=[]}setAssetNodeToSceneNode(t,e,i,s,r,a){const n=new Au(t);if(r.set(i,n),n.name=i.name??"",n.position.set(i.position),n.rotation.set(i.rotation),n.scale.set(i.scaling),i.mesh){const e=i.mesh,r=i.skeleton;for(const o of e.subMeshes)for(const h of i.instances){const i=new __(t);i.position=h.t,i.scale=h.s,i.rotation=h.r,i.name=o.name,i.clipTestEnabled=!0,i.showState="inherit",i.skinAnimation=!!r,i.morphAnimation=o.numTargets>0,i.primitive=o.primitive.get(),i.material=!a||i.skinAnimation||i.morphAnimation?o.material.get().clone():o.material.get().createInstance(),i.parent=n,o.mesh=i,$g(o,e.morphWeights),r&&(s.has(r)?(s.get(r).mesh.push(i),s.get(r).bounding.push(o)):s.set(r,{mesh:[i],bounding:[o]}))}}n.parent=e;for(const e of i.children)this.setAssetNodeToSceneNode(t,n,e,s,r,a)}}var kg=function(t){return t[t.UNKNOWN=0]="UNKNOWN",t[t.BYTE=5120]="BYTE",t[t.UBYTE=5121]="UBYTE",t[t.SHORT=5122]="SHORT",t[t.USHORT=5123]="USHORT",t[t.INT=5124]="INT",t[t.UINT=5125]="UINT",t[t.FLOAT=5126]="FLOAT",t}({});class Ug{bufferView;byteOffset;componentType;normalized;count;type;max;min;sparse;name;_typedView;_filteredView;_normalizedFilteredView;_normalizedTypedView;constructor(t){this.bufferView=t.bufferView,this.byteOffset=t.byteOffset??0,this.componentType=t.componentType,this.normalized=!!t.normalized,this.count=t.count,this.type=t.type,this.max=t.max,this.min=t.min,this.sparse=t.sparse,this.name=t.name,this._typedView=null,this._filteredView=null,this._normalizedFilteredView=null,this._normalizedTypedView=null}getTypedView(t){if(this._typedView)return this._typedView;if(void 0!==this.bufferView){const e=t.bufferViews[this.bufferView],i=t._loadedBuffers[e.buffer],s=this.byteOffset+(e.byteOffset??0),r=this.getComponentSize(this.componentType),a=this.getComponentCount(this.type);let n=0;switch(void 0!==e.byteStride&&0!==e.byteStride?0!==r?n=e.byteStride/r*(this.count-1)+a:console.warn("Invalid component type in accessor '"+(this.name?this.name:"")+"'"):n=this.count*a,n*r>i.byteLength-s&&(n=(i.byteLength-s)/r,console.warn("Count in accessor '"+(this.name?this.name:"")+"' is too large.")),this.componentType){case 5120:this._typedView=new Int8Array(i,s,n);break;case 5121:this._typedView=new Uint8Array(i,s,n);break;case 5122:this._typedView=new Int16Array(i,s,n);break;case 5123:this._typedView=new Uint16Array(i,s,n);break;case 5124:this._typedView=new Int32Array(i,s,n);break;case 5125:this._typedView=new Uint32Array(i,s,n);break;case 5126:this._typedView=new Float32Array(i,s,n)}}else void 0!==this.sparse&&(this._typedView=this.createView());return this._typedView?void 0!==this.sparse&&this.applySparse(t,this._typedView):console.warn("Failed to convert buffer view to typed view!: "+this.bufferView),this._typedView}getNormalizedTypedView(t){if(this._normalizedTypedView)return this._normalizedTypedView;const e=this.getTypedView(t);return this._normalizedTypedView=this.normalized?Ug.dequantize(e,this.componentType):e,this._normalizedTypedView}getDeinterlacedView(t){if(this._filteredView)return this._filteredView;const e=this.getComponentSize(this.componentType),i=this.getComponentCount(this.type),s=this.count*i;let r="getFloat32";switch(this.componentType){case 5120:this._filteredView=new Int8Array(s),r="getInt8";break;case 5121:this._filteredView=new Uint8Array(s),r="getUint8";break;case 5122:this._filteredView=new Int16Array(s),r="getInt16";break;case 5123:this._filteredView=new Uint16Array(s),r="getUint16";break;case 5124:this._filteredView=new Int32Array(s),r="getInt32";break;case 5125:this._filteredView=new Uint32Array(s),r="getUint32";break;case 5126:this._filteredView=new Float32Array(s),r="getFloat32";break;default:return}if(void 0!==this.bufferView){const a=t.bufferViews[this.bufferView],n=t._loadedBuffers[a.buffer],o=this.byteOffset+(a.byteOffset??0),h=void 0!==a.byteStride&&0!==a.byteStride?a.byteStride:i*e,l=new DataView(n,o,this.count*h);for(let t=0;t<s;++t){const s=Math.floor(t/i)*h+t%i*e;this._filteredView[t]=l[r](s,!0)}}else void 0!==this.sparse&&(this._filteredView=this.createView());return void 0!==this.sparse&&this.applySparse(t,this._filteredView),this._filteredView}createView(){const t=this.count*this.getComponentCount(this.type);return 5120==this.componentType?new Int8Array(t):5121==this.componentType?new Uint8Array(t):5122==this.componentType?new Int16Array(t):5123==this.componentType?new Uint16Array(t):5124==this.componentType?new Int32Array(t):5125==this.componentType?new Uint32Array(t):5126==this.componentType?new Float32Array(t):void 0}getNormalizedDeinterlacedView(t){if(this._normalizedFilteredView)return this._normalizedFilteredView;const e=this.getDeinterlacedView(t);return this._normalizedFilteredView=this.normalized?Ug.dequantize(e,this.componentType):e,this._normalizedFilteredView}applySparse(t,e){const i=t.bufferViews[this.sparse.indices.bufferView],s=t._loadedBuffers[i.buffer],r=this.sparse.indices.byteOffset+(i.byteOffset??0),a=this.getComponentSize(this.sparse.indices.componentType);let n=1;void 0!==i.byteStride&&0!==i.byteStride&&(n=i.byteStride/a);const o=this.sparse.count*n;let h;switch(this.sparse.indices.componentType){case 5121:h=new Uint8Array(s,r,o);break;case 5123:h=new Uint16Array(s,r,o);break;case 5125:h=new Uint32Array(s,r,o)}const l=t.bufferViews[this.sparse.values.bufferView],u=t._loadedBuffers[l.buffer],c=this.sparse.values.byteOffset+(l.byteOffset??0),d=this.getComponentSize(this.componentType);let p=this.getComponentCount(this.type);void 0!==l.byteStride&&0!==l.byteStride&&(p=l.byteStride/d);const m=this.sparse.count*p;let f;switch(this.componentType){case 5120:f=new Int8Array(u,c,m);break;case 5121:f=new Uint8Array(u,c,m);break;case 5122:f=new Int16Array(u,c,m);break;case 5123:f=new Uint16Array(u,c,m);break;case 5124:f=new Int32Array(u,c,m);break;case 5125:f=new Uint32Array(u,c,m);break;case 5126:f=new Float32Array(u,c,m)}for(let t=0;t<this.sparse.count;++t)for(let i=0;i<p;++i)e[h[t]*p+i]=f[t*p+i]}static dequantize(t,e){switch(e){case 5120:return new Float32Array(t).map(t=>Math.max(t/127,-1));case 5121:return new Float32Array(t).map(t=>t/255);case 5122:return new Float32Array(t).map(t=>Math.max(t/32767,-1));case 5123:return new Float32Array(t).map(t=>t/65535);default:return t}}getComponentCount(t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 0}}getComponentSize(t){switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}}}class Gg{_urlResolver;constructor(){this._urlResolver=null}get urlResolver(){return this._urlResolver}set urlResolver(t){this._urlResolver=t}async request(t,e={},i="anonymous"){return(t=this._urlResolver?this._urlResolver(t):null)?fetch(t,{credentials:"anonymous"===i?"same-origin":"include",headers:e}):null}}class Hg extends Gg{}class Wg extends Gg{}class Xg{_module;_decoder;_mesh;constructor(t,e){this._module=e,this._decoder=new this._module.Decoder;const i=new this._module.DecoderBuffer;i.Init(t,t.byteLength);const s=this._decoder.GetEncodedGeometryType(i);if(s!==this._module.TRIANGULAR_MESH)throw this._module.destroy(i),this._module.destroy(this._decoder),this._decoder=null,new Error(`Unsupported geometry type: ${s}`);this._mesh=new this._module.Mesh;const r=this._decoder.DecodeBufferToMesh(i,this._mesh);if(this._module.destroy(i),!r.ok()||0===this._mesh.ptr)throw this._module.destroy(this._decoder),this._decoder=null,this._module.destroy(this._mesh),this._mesh=null,new Error(r.error_msg())}getIndexBuffer(){if(!this._decoder||!this._mesh)return null;const t=3*this._mesh.num_faces(),e=new Uint32Array(t),i=this._module._malloc(e.byteLength);this._decoder.GetTrianglesUInt32Array(this._mesh,e.byteLength,i);const s=new Uint32Array(this._module.HEAPU32.buffer,i,t);return e.set(s),this._module._free(i),e}getAttributeBuffer(t,e){if(!this._decoder||!this._mesh)return null;const i=this._decoder.GetAttributeByUniqueId(this._mesh,t);if(!i)return null;const s=i.num_components(),r=this._mesh.num_points()*s;if(e.length!==r)return console.error(`getAttributeBuffer(): buffer length must be ${r}`),null;const a=this._module._malloc(e.byteLength);this._decoder.GetAttributeDataArrayForAllPoints(this._mesh,i,this.getDracoDataType(e),e.byteLength,a);const n=new e.constructor(this.getDracoHeap(e).buffer,a,r);return e.set(n),this._module._free(a),e}getDracoDataType(t){if(t instanceof Float32Array)return this._module.DT_FLOAT32;if(t instanceof Int8Array)return this._module.DT_INT8;if(t instanceof Int16Array)return this._module.DT_INT16;if(t instanceof Int32Array)return this._module.DT_INT32;if(t instanceof Uint8Array)return this._module.DT_UINT8;if(t instanceof Uint16Array)return this._module.DT_UINT16;if(t instanceof Uint32Array)return this._module.DT_UINT32;throw new Error("getDracoDataType(): invalid buffer type")}getDracoHeap(t){if(t instanceof Float32Array)return this._module.HEAPF32;if(t instanceof Int8Array)return this._module.HEAP8;if(t instanceof Int16Array)return this._module.HEAP16;if(t instanceof Int32Array)return this._module.HEAP32;if(t instanceof Uint8Array)return this._module.HEAPU8;if(t instanceof Uint16Array)return this._module.HEAPU16;if(t instanceof Uint32Array)return this._module.HEAPU32;throw new Error("getDracoHeap(): invalid buffer type")}}class jg extends Wg{supportMIMEType(t){return"model/gltf+json"===t||"model/gltf-binary"===t}async load(t,e,i,s,r,a){const n=await s.arrayBuffer();if(this.isGLB(n))return this.loadBinary(t,e,n,a,r);const o=await new Response(s).json();return o._manager=t,o._VFSs=a,o._loadedBuffers=null,this.loadJson(e,o,r)}async loadBinary(t,e,i,s,r){let a=null;const n=[],o=this.getGLBChunkInfos(i);for(const t of o)if(1313821514!==t.type||a)5130562===t.type&&n.push(i.slice(t.start,t.start+t.length));else{const e=new Uint8Array(i,20,t.length),s=new TextDecoder("utf-8").decode(e);a=JSON.parse(s)}return a?(a._manager=t,a._VFSs=s,a._loadedBuffers=n,this.loadJson(e,a,r)):null}async loadJson(t,e,i){if(!i&&e.extensionsRequired&&e.extensionsRequired.indexOf("KHR_draco_mesh_compression")>=0)return console.error("Draco3d is required for loading model"),null;e._dracoModule=i,e._accessors=[],e._bufferCache={},e._textureCache={},e._materialCache={},e._nodes=[],e._meshes=[];const s=e.asset;if(s){const t=s.version;if("2.0"!==t)return console.error(`Invalid GLTF version: ${t}`),null}if(e._baseURI=t.substring(0,t.lastIndexOf("/")+1),!e._loadedBuffers){e._loadedBuffers=[];const t=e.buffers;if(t)for(const i of t){const t=this._normalizeURI(e._baseURI,i.uri),s=await e._manager.fetchBinaryData(t,null,null,e._VFSs);if(i.byteLength!==s.byteLength)return console.error("Invalid GLTF: buffer byte length error."),null;e._loadedBuffers.push(s)}}if(e.accessors)for(const t of e.accessors)e._accessors.push(new Ug(t));const r=e.scenes;if(r){const t=new Og;await this._loadMeshes(e),this._loadNodes(e,t),this._loadSkins(e,t);for(let i=0;i<e.nodes?.length;i++)"number"==typeof e.nodes[i].skin&&e.nodes[i].skin>=0&&(e._nodes[i].skeleton=t.skeletons[e.nodes[i].skin]);this._loadAnimations(e,t);for(const i of r){const s=new Vg(i.name);for(const t of i.nodes)s.rootNodes.push(e._nodes[t]);t.scenes.push(s)}return"number"==typeof e.scene&&(t.activeScene=e.scene),t}return null}_normalizeURI(t,e){const i=e.toLowerCase();return i.startsWith("http://")||i.startsWith("https://")||i.startsWith("blob:")||i.startsWith("data:")?encodeURI(e):(e=e.replace(/\.\//g,""),"/"===(e=decodeURIComponent(e))[0]&&(e=e.slice(1)),t+(e=e.split("/").map(t=>encodeURIComponent(t)).join("/")))}_loadNodes(t,e){if(t.nodes){for(let i=0;i<t.nodes.length;i++)this._loadNode(t,i,null,e);for(const e of t._nodes)e.parent||e.computeTransforms(null)}}_loadSkins(t,e){if(t.skins)for(let i=0;i<t.skins.length;i++){const s=t.skins[i],r=new zg(s.name);"number"==typeof s.skeleton&&(r.pivot=t._nodes[s.skeleton]);const a=t._accessors[s.inverseBindMatrices];if(!a||"MAT4"!==a.type||a.componentType!==kg.FLOAT)throw new Error("Invalid GLTF inverse bind matricies accessor");const n="number"==typeof s.inverseBindMatrices?a.getDeinterlacedView(t):null;s.joints.forEach((e,i)=>{const s=16*i;r.addJoint(t._nodes[e],n?new W(n.subarray(s,s+16)):W.identity())}),e.addSkeleton(r)}}_loadAnimations(t,e){if(t.animations)for(let i=0;i<t.animations.length;i++){const s=this._loadAnimation(t,i);e.addAnimation(s)}}collectNodes(t){const e=new Map;for(const i of t._nodes)e.set(i,{translate:i.position||z.zero(),rotation:i.rotation||U.identity(),scale:i.scaling||z.one(),worldTransform:null});return e}getAnimationInfo(t,e){const i=t.animations[e],s=i.name||null,r=i.channels,a=i.samplers,n=[],o=[],h=this.collectNodes(t);let l=0;for(let e=0;e<r.length;e++){const i=r[e],s=a[i.sampler],h=t._accessors[s.input].getNormalizedDeinterlacedView(t),u=t._accessors[s.output].getNormalizedDeinterlacedView(t);if(!(h instanceof Float32Array&&u instanceof Float32Array)){console.error("Input/output channel of animation must be Float32Array");continue}const c="STEP"===s.interpolation?"step":"CUBICSPLINE"===s.interpolation?"cubicspline":"linear";if("rotation"===i.target.path)n.push(new ot(c,"quat",h,u)),o.push("rotation");else if("translation"===i.target.path)n.push(new ot(c,"vec3",h,u)),o.push("translation");else if("scale"===i.target.path)n.push(new ot(c,"vec3",h,u)),o.push("scale");else{if("weights"!==i.target.path)continue;n.push(new ot(c,null,h,u)),o.push("weights")}const d=h[h.length-1];d>l&&(l=d)}return{name:s,channels:r,samplers:a,interpolators:n,interpolatorTypes:o,maxTime:l,nodes:h}}_loadAnimation(t,e){const i=this.getAnimationInfo(t,e),s={name:i.name,tracks:[],skeletons:[],nodes:[]};for(let e=0;e<i.channels.length;e++){const r=t._nodes[i.channels[e].target.node],a={node:r,type:i.interpolatorTypes[e],interpolator:i.interpolators[e]};if("weights"===a.type&&(a.defaultMorphWeights=r.weights),s.tracks.push(a),s.nodes.indexOf(r)<0&&s.nodes.push(r),r.skeletonAttached)for(const t of r.skeletonAttached)s.skeletons.indexOf(t)<0&&s.skeletons.push(t)}return s}_loadNode(t,e,i,s){let r=t._nodes[e];if(r){if(i){if(r.parent)throw new Error("invalid node hierarchy");i.addChild(r)}return r}const a=t.nodes?.[e];if(!a)throw new Error(`invalid GLTF node: ${e}`);if(r=s.addNode(i,e,a.name),"number"==typeof a.mesh){r.mesh=t._meshes[a.mesh],r.weights&&(r.mesh.morphWeights=r.weights);const e=a.extensions?.EXT_mesh_gpu_instancing;if(e){const i=e.attributes;if(i){const e="number"==typeof i.TRANSLATION?t._accessors[i.TRANSLATION]:null,s="number"==typeof i.SCALE?t._accessors[i.SCALE]:null,a="number"==typeof i.ROTATION?t._accessors[i.ROTATION]:null,n=e?.count??s?.count??a.count??0,o=e?.getNormalizedDeinterlacedView(t),h=s?.getNormalizedDeinterlacedView(t),l=a?.getNormalizedDeinterlacedView(t);for(let t=0;t<n;t++){const e=o?new z(o[3*t],o[3*t+1],o[3*t+2]):z.zero(),i=h?new z(h[3*t],h[3*t+1],h[3*t+2]):z.one(),s=l?new U(l[4*t],l[4*t+1],l[4*t+2],l[4*t+3]):U.identity();r.instances.push({t:e,s:i,r:s})}}}else r.instances.push({t:z.zero(),s:z.one(),r:U.identity()})}if("number"!=typeof a.skin||a.skin<0)if(a.matrix){new W(a.matrix).decompose(r.scaling,r.rotation,r.position)}else a.rotation&&r.rotation.set(a.rotation),a.scale&&r.scaling.set(a.scale),a.translation&&r.position.set(a.translation);if(t._nodes[e]=r,a.children)for(const e of a.children)this._loadNode(t,e,r,s);return r}async _loadMeshes(t){if(t.meshes)for(let e=0;e<t.meshes.length;e++)t._meshes[e]=await this._loadMesh(t,e)}async _loadMesh(t,e){const i=t.meshes&&t.meshes[e];let s=null;if(i){s={morphWeights:i.weights??null,subMeshes:[]};const e=i.primitives,r=i.name||null;if(e)for(let i=0;i<e.length;i++){const a=e[i],n={name:`${r}-${i}`,primitive:new wt,material:new wt,rawPositions:null,rawBlendIndices:null,rawJointWeights:null,numTargets:0},o=new Cl,h=a.attributes,l=t._dracoModule?a.extensions?.KHR_draco_mesh_compression:null;let u=null;if(l){const e=t.bufferViews&&t.bufferViews[l.bufferView];if(!e)throw new Error("Draco buffer view not set");const i=t._loadedBuffers&&t._loadedBuffers[e.buffer];if(!i)throw new Error("Draco buffer view does not point to a valid ArrayBuffer");u=new Xg(new Int8Array(i,e.byteOffset??0,e.byteLength),t._dracoModule)}for(const e in h)this._loadVertexBuffer(t,e,h[e],o,n,l,u);if(a.targets&&"webgl"===Sl().type)if(void 0!==h.TEXCOORD_7)console.error("Could not load morph target animation"),a.targets=null;else{const t=new Float32Array(o.getNumVertices());for(let e=0;e<t.length;e++)t[e]=e;o.createAndSetVertexBuffer("tex7_f32",t)}if(a.targets){const e={},i=[],s={POSITION:0,NORMAL:1,TANGENT:2,TEXCOORD_0:4,TEXCOORD_1:5,TEXCOORD_2:6,TEXCOORD_3:7,COLOR_0:3},r=new Set;for(const n of a.targets)for(const a in n){const o=s[a];if(void 0!==o){e[o]=e[o]??{numComponents:0,data:[]};const s=n[a],h=t._accessors[s];if(e[o].numComponents=h.getComponentCount(h.type),e[o].data.push(h.getNormalizedDeinterlacedView(t)),"POSITION"===a){const t=h.min?new z(h.min[0],h.min[1],h.min[2]):z.zero(),e=h.max?new z(h.max[0],h.max[1],h.max[2]):z.zero();i.push(new hu(t,e))}r.add(o)}}n.numTargets=a.targets.length,n.targets=e,n.targetBox=i,n.morphAttribCount=r.size}const c=a.indices;"number"==typeof c&&this._loadIndexBuffer(t,c,o,n,l,u);let d=a.mode;"number"!=typeof d&&(d=4),o.primitiveType=this._primitiveType(d);const p=!!o.getVertexBuffer("normal"),m=!!o.getVertexBuffer("diffuse"),f=!!o.getVertexBuffer("tangent"),_=`${a.material}.${Number(p)}.${Number(m)}.${Number(f)}`;let g=t._materialCache[_];if(!g){const e=void 0!==a.material?t.materials[a.material]:null;g=await this._loadMaterial(t,e,m,p,f),t._materialCache[_]=g}n.primitive.set(o),n.material.set(g),s.subMeshes.push(n)}}return s}async _createMaterial(t){if("unlit"===t.type){const e=t,i=new ld;return i.albedoColor=e.diffuse??O.one(),e.diffuseMap&&(i.albedoTexture=e.diffuseMap.texture,i.albedoTextureSampler=e.diffuseMap.sampler,i.albedoTexCoordIndex=e.diffuseMap.texCoord,i.albedoTexCoordMatrix=e.diffuseMap.transform),i.vertexColor=e.common.vertexColor,"blend"===t.common.alphaMode?i.blendMode="blend":"mask"===t.common.alphaMode&&(i.alphaCutoff=t.common.alphaCutoff),t.common.doubleSided&&(i.cullMode="none"),i}if("pbrSpecularGlossiness"===t.type){const e=t,i=new Td;return i.ior=e.ior,i.albedoColor=e.diffuse,i.specularFactor=new z(e.specular.x,e.specular.y,e.specular.z),i.glossinessFactor=e.glossness,e.diffuseMap&&(i.albedoTexture=e.diffuseMap.texture,i.albedoTextureSampler=e.diffuseMap.sampler,i.albedoTexCoordIndex=e.diffuseMap.texCoord,i.albedoTexCoordMatrix=e.diffuseMap.transform),e.common.normalMap&&(i.normalTexture=e.common.normalMap.texture,i.normalTextureSampler=e.common.normalMap.sampler,i.normalTexCoordIndex=e.common.normalMap.texCoord,i.normalTexCoordMatrix=e.common.normalMap.transform),i.normalScale=e.common.bumpScale,e.common.emissiveMap&&(i.emissiveTexture=e.common.emissiveMap.texture,i.emissiveTextureSampler=e.common.emissiveMap.sampler,i.emissiveTexCoordIndex=e.common.emissiveMap.texCoord,i.emissiveTexCoordMatrix=e.common.emissiveMap.transform),i.emissiveColor=e.common.emissiveColor,i.emissiveStrength=e.common.emissiveStrength,e.common.occlusionMap&&(i.occlusionTexture=e.common.occlusionMap.texture,i.occlusionTextureSampler=e.common.occlusionMap.sampler,i.occlusionTexCoordIndex=e.common.occlusionMap.texCoord,i.occlusionTexCoordMatrix=e.common.occlusionMap.transform),i.occlusionStrength=e.common.occlusionStrength,e.specularGlossnessMap&&(i.specularTexture=e.specularGlossnessMap.texture,i.specularTextureSampler=e.specularGlossnessMap.sampler,i.specularTexCoordIndex=e.specularGlossnessMap.texCoord,i.specularTexCoordMatrix=e.specularGlossnessMap.transform),i.vertexTangent=e.common.useTangent,i.vertexColor=e.common.vertexColor,"blend"===e.common.alphaMode?i.blendMode="blend":"mask"===e.common.alphaMode&&(i.alphaCutoff=e.common.alphaCutoff),e.common.doubleSided&&(i.cullMode="none"),i.vertexNormal=!!t.common.vertexNormal,i}if("pbrMetallicRoughness"===t.type){const e=t,i=new vd;if(i.ior=e.ior,i.albedoColor=e.diffuse,i.metallic=e.metallic,i.roughness=e.roughness,e.diffuseMap&&(i.albedoTexture=e.diffuseMap.texture,i.albedoTextureSampler=e.diffuseMap.sampler,i.albedoTexCoordIndex=e.diffuseMap.texCoord,i.albedoTexCoordMatrix=e.diffuseMap.transform),e.common.normalMap&&(i.normalTexture=e.common.normalMap.texture,i.normalTextureSampler=e.common.normalMap.sampler,i.normalTexCoordIndex=e.common.normalMap.texCoord,i.normalTexCoordMatrix=e.common.normalMap.transform),i.normalScale=e.common.bumpScale,e.common.emissiveMap&&(i.emissiveTexture=e.common.emissiveMap.texture,i.emissiveTextureSampler=e.common.emissiveMap.sampler,i.emissiveTexCoordIndex=e.common.emissiveMap.texCoord,i.emissiveTexCoordMatrix=e.common.emissiveMap.transform),i.emissiveColor=e.common.emissiveColor,i.emissiveStrength=e.common.emissiveStrength,e.common.occlusionMap&&(i.occlusionTexture=e.common.occlusionMap.texture,i.occlusionTextureSampler=e.common.occlusionMap.sampler,i.occlusionTexCoordIndex=e.common.occlusionMap.texCoord,i.occlusionTexCoordMatrix=e.common.occlusionMap.transform,i.occlusionStrength=e.common.occlusionStrength),e.metallicMap&&(i.metallicRoughnessTexture=e.metallicMap.texture,i.metallicRoughnessTextureSampler=e.metallicMap.sampler,i.metallicRoughnessTexCoordIndex=e.metallicMap.texCoord,i.metallicRoughnessTexCoordMatrix=e.metallicMap.transform),i.specularFactor=e.specularFactor,e.specularMap&&(i.specularTexture=e.specularMap.texture,i.specularTextureSampler=e.specularMap.sampler,i.specularTexCoordIndex=e.specularMap.texCoord,i.specularTexCoordMatrix=e.specularMap.transform),e.specularColorMap&&(i.specularColorTexture=e.specularColorMap.texture,i.specularColorTextureSampler=e.specularColorMap.sampler,i.specularColorTexCoordIndex=e.specularColorMap.texCoord,i.specularColorTexCoordMatrix=e.specularColorMap.transform),e.sheen){const t=e.sheen;i.sheen=!0,i.sheenColorFactor=t.sheenColorFactor,i.sheenRoughnessFactor=t.sheenRoughnessFactor,t.sheenColorMap&&(i.sheenColorTexture=t.sheenColorMap.texture,i.sheenColorTextureSampler=t.sheenColorMap.sampler,i.sheenColorTexCoordIndex=t.sheenColorMap.texCoord,i.sheenColorTexCoordMatrix=t.sheenColorMap.transform),t.sheenRoughnessMap&&(i.sheenRoughnessTexture=t.sheenRoughnessMap.texture,i.sheenRoughnessTextureSampler=t.sheenRoughnessMap.sampler,i.sheenRoughnessTexCoordIndex=t.sheenRoughnessMap.texCoord,i.sheenRoughnessTexCoordMatrix=t.sheenRoughnessMap.transform)}if(e.iridescence){const t=e.iridescence;i.iridescence=!0,i.iridescenceFactor=t.iridescenceFactor,i.iridescenceIor=t.iridescenceIor,t.iridescenceMap&&(i.iridescenceTexture=t.iridescenceMap.texture,i.iridescenceTextureSampler=t.iridescenceMap.sampler,i.iridescenceTexCoordIndex=t.iridescenceMap.texCoord,i.iridescenceTexCoordMatrix=t.iridescenceMap.transform),i.iridescenceThicknessMin=t.iridescenceThicknessMinimum,i.iridescenceThicknessMax=t.iridescenceThicknessMaximum,t.iridescenceThicknessMap&&(i.iridescenceThicknessTexture=t.iridescenceThicknessMap.texture,i.iridescenceThicknessTextureSampler=t.iridescenceThicknessMap.sampler,i.iridescenceThicknessTexCoordIndex=t.iridescenceThicknessMap.texCoord,i.iridescenceThicknessTexCoordMatrix=t.iridescenceThicknessMap.transform)}if(e.transmission){const t=e.transmission;i.transmission=!0,i.transmissionFactor=t.transmissionFactor,t.transmissionMap&&(i.transmissionTexture=t.transmissionMap.texture,i.transmissionTextureSampler=t.transmissionMap.sampler,i.transmissionTexCoordIndex=t.transmissionMap.texCoord,i.transmissionTexCoordMatrix=t.transmissionMap.transform),i.thicknessFactor=t.thicknessFactor,t.thicknessMap&&(i.thicknessTexture=t.thicknessMap.texture,i.thicknessTextureSampler=t.thicknessMap.sampler,i.thicknessTexCoordIndex=t.thicknessMap.texCoord,i.thicknessTexCoordMatrix=t.thicknessMap.transform),i.attenuationDistance=t.attenuationDistance,i.attenuationColor=t.attenuationColor}if(e.clearcoat){const t=e.clearcoat;i.clearcoat=!0,i.clearcoatIntensity=t.clearCoatFactor,i.clearcoatRoughnessFactor=t.clearCoatRoughnessFactor,t.clearCoatIntensityMap&&(i.clearcoatIntensityTexture=t.clearCoatIntensityMap.texture,i.clearcoatIntensityTextureSampler=t.clearCoatIntensityMap.sampler,i.clearcoatIntensityTexCoordIndex=t.clearCoatIntensityMap.texCoord,i.clearcoatIntensityTexCoordMatrix=t.clearCoatIntensityMap.transform),t.clearCoatRoughnessMap&&(i.clearcoatRoughnessTexture=t.clearCoatRoughnessMap.texture,i.clearcoatRoughnessTextureSampler=t.clearCoatRoughnessMap.sampler,i.clearcoatRoughnessTexCoordIndex=t.clearCoatRoughnessMap.texCoord,i.clearcoatRoughnessTexCoordMatrix=t.clearCoatRoughnessMap.transform),t.clearCoatNormalMap&&(i.clearcoatNormalTexture=t.clearCoatNormalMap.texture,i.clearcoatNormalTextureSampler=t.clearCoatNormalMap.sampler,i.clearcoatNormalTexCoordIndex=t.clearCoatNormalMap.texCoord,i.clearcoatNormalTexCoordMatrix=t.clearCoatNormalMap.transform)}return i.vertexTangent=e.common.useTangent,i.vertexColor=e.common.vertexColor,"blend"===e.common.alphaMode?i.blendMode="blend":"mask"===e.common.alphaMode&&(i.alphaCutoff=e.common.alphaCutoff),e.common.doubleSided&&(i.cullMode="none"),i.vertexNormal=!!t.common.vertexNormal,i}}async _loadMaterial(t,e,i,s,r){let a=null,n=null,o=null;const h={useTangent:r,vertexColor:i,vertexNormal:s,bumpScale:1,emissiveColor:z.zero(),emissiveStrength:1,occlusionStrength:1};switch(e?.alphaMode){case"BLEND":h.alphaMode="blend";break;case"MASK":h.alphaMode="mask",h.alphaCutoff=e.alphaCutoff??.5}if(e?.doubleSided&&(h.doubleSided=!0),(e?.pbrMetallicRoughness||e?.extensions?.KHR_materials_pbrSpecularGlossiness)&&(h.normalMap=e.normalTexture?await this._loadTexture(t,e.normalTexture,!1):null,h.bumpScale=e.normalTexture?.scale??1,h.occlusionMap=e.occlusionTexture?await this._loadTexture(t,e.occlusionTexture,!1):null,h.occlusionStrength=e.occlusionTexture?.strength??1,h.emissiveMap=e.emissiveTexture?await this._loadTexture(t,e.emissiveTexture,!1):null,h.emissiveStrength=e?.extensions?.KHR_materials_emissive_strength?.emissiveStrength??1,h.emissiveColor=e.emissiveFactor?new z(e.emissiveFactor):z.zero()),e?.pbrMetallicRoughness&&(n={type:"pbrMetallicRoughness",ior:1.5,common:h},n.diffuse=new O(e.pbrMetallicRoughness.baseColorFactor??[1,1,1,1]),n.metallic=e.pbrMetallicRoughness.metallicFactor??1,n.roughness=e.pbrMetallicRoughness.roughnessFactor??1,n.diffuseMap=e.pbrMetallicRoughness.baseColorTexture?await this._loadTexture(t,e.pbrMetallicRoughness.baseColorTexture,!0):null,n.metallicMap=e.pbrMetallicRoughness.metallicRoughnessTexture?await this._loadTexture(t,e.pbrMetallicRoughness.metallicRoughnessTexture,!1):null,n.metallicIndex=2,n.roughnessIndex=1),e?.extensions?.KHR_materials_pbrSpecularGlossiness){const i=e.extensions?.KHR_materials_pbrSpecularGlossiness;o={type:"pbrSpecularGlossiness",ior:1.5,common:h},o.diffuse=new O(i.diffuseFactor??[1,1,1,1]),o.specular=new z(i.specularFactor??[1,1,1]),o.glossness=i.glossnessFactor??1,o.diffuseMap=i.diffuseTexture?await this._loadTexture(t,i.diffuseTexture,!0):null,o.specularGlossnessMap=i.specularGlossinessTexture?await this._loadTexture(t,i.specularGlossinessTexture,!0):null}if(a=o||n,a&&!e?.extensions?.KHR_materials_unlit||(a=e?.extensions?.KHR_materials_unlit?{type:"unlit",common:h,diffuse:n?.diffuse??O.one(),diffuseMap:n?.diffuseMap??null}:{type:"pbrMetallicRoughness",common:h,diffuse:O.one(),metallic:1,roughness:1,diffuseMap:null,metallicMap:null,metallicIndex:2,roughnessIndex:1}),"unlit"!==a.type&&e?.extensions?.KHR_materials_ior&&(a.ior=e.extensions.KHR_materials_ior.ior??1.5),"pbrMetallicRoughness"===a.type){n=a;const i=e?.extensions?.KHR_materials_specular?.specularColorFactor??[1,1,1];n.specularFactor=new O(...i,e?.extensions?.KHR_materials_specular?.specularFactor??1),n.specularMap=e?.extensions?.KHR_materials_specular?.specularTexture?await this._loadTexture(t,e.extensions.KHR_materials_specular.specularTexture,!1):null,n.specularColorMap=e?.extensions?.KHR_materials_specular?.specularColorTexture?await this._loadTexture(t,e.extensions.KHR_materials_specular.specularColorTexture,!0):null;const s=e?.extensions?.KHR_materials_iridescence;s&&(n.iridescence={iridescenceFactor:s.iridescenceFactor??0,iridescenceMap:s.iridescenceTexture?await this._loadTexture(t,s.iridescenceTexture,!1):null,iridescenceIor:s.iridescenceIor??1.3,iridescenceThicknessMinimum:s.iridescenceThicknessMinimum??100,iridescenceThicknessMaximum:s.iridescenceThicknessMaximum??400,iridescenceThicknessMap:s.iridescenceThicknessTexture?await this._loadTexture(t,s.iridescenceThicknessTexture,!1):null});const r=e?.extensions?.KHR_materials_transmission;if(r){n.transmission={transmissionFactor:r.transmissionFactor??0,transmissionMap:r.transmissionTexture?await this._loadTexture(t,r.transmissionTexture,!1):null,thicknessFactor:0,thicknessMap:null,attenuationDistance:99999,attenuationColor:z.one()};const i=e?.extensions?.KHR_materials_volume;if(i){n.transmission.thicknessFactor=i.thicknessFactor??0,n.transmission.thicknessMap=i.thicknessTexture?await this._loadTexture(t,i.thicknessTexture,!1):null,n.transmission.attenuationDistance=i.attenuationDistance??99999;const e=i.attenuationColor??[1,1,1];n.transmission.attenuationColor=new z(...e)}}const o=e?.extensions?.KHR_materials_sheen;o&&(n.sheen={sheenColorFactor:new z(o.sheenColorFactor??[0,0,0]),sheenColorMap:o.sheenColorTexture?await this._loadTexture(t,o.sheenColorTexture,!0):null,sheenRoughnessFactor:o.sheenRoughnessFactor??0,sheenRoughnessMap:o.sheenRoughnessTexture?await this._loadTexture(t,o.sheenRoughnessTexture,!0):null});const h=e?.extensions?.KHR_materials_clearcoat;h&&(n.clearcoat={clearCoatFactor:h.clearcoatFactor??0,clearCoatIntensityMap:h.clearcoatTexture?await this._loadTexture(t,h.clearcoatTexture,!1):null,clearCoatRoughnessFactor:h.clearcoatRoughnessFactor??0,clearCoatRoughnessMap:h.clearcoatRoughnessTexture?await this._loadTexture(t,h.clearcoatRoughnessTexture,!1):null,clearCoatNormalMap:h.clearcoatNormalTexture?await this._loadTexture(t,h.clearcoatNormalTexture,!1):null})}return await this._createMaterial(a)}async _loadTexture(t,e,i){const s={texture:null,sampler:null,texCoord:e.texCoord??0,transform:null},r=t.textures[e.index];if(r){if(e.extensions?.KHR_texture_transform){const t=e.extensions.KHR_texture_transform;void 0!==t.texCoord&&(s.texCoord=t.texCoord);const i=void 0!==t.rotation?W.rotationZ(-t.rotation):W.identity(),r=void 0!==t.scale?new z(t.scale[0],t.scale[1],1):z.one(),a=void 0!==t.offset?new z(t.offset[0],t.offset[1],0):z.zero();s.transform=W.scaling(r).multiplyLeft(i).translateLeft(a)}let a="repeat",n="repeat",o="linear",h="linear",l="linear";const u=r.sampler,c=t.samplers&&t.samplers[u];if(c){switch(c.wrapS){case 10497:a="repeat";break;case 33648:a="mirrored-repeat";break;case 33071:a="clamp"}switch(c.wrapT){case 10497:n="repeat";break;case 33648:n="mirrored-repeat";break;case 33071:n="clamp"}switch(c.magFilter){case 9728:o="nearest";break;case 9729:o="linear"}switch(c.minFilter){case 9728:h="nearest",l="none";break;case 9729:h="linear",l="none";break;case 9984:h="nearest",l="nearest";break;case 9985:h="linear",l="nearest";break;case 9986:h="nearest",l="linear";break;case 9987:h="linear",l="linear"}}const d=r.source,p=`${d}:${!!i}:${a}:${n}:${h}:${o}:${l}`;if(s.texture=t._textureCache[p],!s.texture){const e=t.images[d];if(e)if(e.uri){const r=this._normalizeURI(t._baseURI,e.uri);s.texture=await t._manager.fetchTexture(r,{linearColorSpace:!i},t._VFSs),s.texture.name=r}else if("number"==typeof e.bufferView&&e.mimeType){const r=t.bufferViews&&t.bufferViews[e.bufferView];if(r){const a=t._loadedBuffers&&t._loadedBuffers[r.buffer];if(a){const n=new Uint8Array(a,r.byteOffset||0,r.byteLength),o=e.mimeType;s.texture=await t._manager.loadTextureFromBuffer(n,o,i)}}}s.texture&&(t._textureCache[p]=s.texture)}s.texture&&(s.sampler=Sl().createSampler({addressU:a,addressV:n,magFilter:o,minFilter:h,mipFilter:l}))}return s}_primitiveType(t){switch(t){case 0:return"point-list";case 1:return"line-list";case 3:return"line-strip";case 4:return"triangle-list";case 5:return"triangle-strip";case 6:return"triangle-fan";default:return null}}_loadIndexBuffer(t,e,i,s,r,a){const n=t._accessors[e];if(a){const e=a.getIndexBuffer();if(!e||e.length!==n.count)throw new Error("Decode index buffer failed");if(e.length!==n.count)throw new Error("Decode index buffer failed");t._loadedBuffers.push(e.buffer),t.bufferViews||(t.bufferViews=[]),t.bufferViews.push({buffer:t._loadedBuffers.length-1,byteOffset:0,byteLength:e.byteLength}),n.componentType=kg.UINT,n.bufferView=t.bufferViews.length-1}this._setBuffer(t,e,i,null,s)}_loadVertexBuffer(t,e,i,s,r,a,n){const o=a?.attributes?.[e];if(void 0!==o){const e=t._accessors[i];let s=null;const r=e.count*e.getComponentCount(e.type);switch(e.componentType){case kg.FLOAT:s=new Float32Array(r);break;case kg.BYTE:s=new Int8Array(r);break;case kg.SHORT:s=new Int16Array(r);break;case kg.INT:s=new Int32Array(r);break;case kg.UBYTE:s=new Uint8Array(r);break;case kg.USHORT:s=new Uint16Array(r);break;case kg.UINT:s=new Uint32Array(r);break;default:throw new Error(`Invalid component type: ${e.componentType}`)}if(!n.getAttributeBuffer(o,s))throw new Error("Decode draco mesh failed");t._loadedBuffers.push(s.buffer),t.bufferViews||(t.bufferViews=[]),t.bufferViews.push({buffer:t._loadedBuffers.length-1,byteOffset:0,byteLength:s.byteLength}),e.bufferView=t.bufferViews.length-1}let h=null;switch(e){case"POSITION":h="position";break;case"NORMAL":h="normal";break;case"TANGENT":h="tangent";break;case"TEXCOORD_0":h="texCoord0";break;case"TEXCOORD_1":h="texCoord1";break;case"TEXCOORD_2":h="texCoord2";break;case"TEXCOORD_3":h="texCoord3";break;case"TEXCOORD_4":h="texCoord4";break;case"TEXCOORD_5":h="texCoord5";break;case"TEXCOORD_6":h="texCoord6";break;case"TEXCOORD_7":h="texCoord7";break;case"COLOR_0":h="diffuse";break;case"JOINTS_0":h="blendIndices";break;case"WEIGHTS_0":h="blendWeights";break;default:return}this._setBuffer(t,i,s,h,r)}_setBuffer(t,e,i,s,r){const a=Sl(),n=t._accessors[e],o=n.getComponentCount(n.type),h=!!n.normalized,l=`${e}:${s||""}:${Number(h)}`;let u=t._bufferCache[l];if(!u){let e=n.getNormalizedDeinterlacedView(t);if(s&&!(e instanceof Float32Array)){const t=new Float32Array(e.length);t.set(e),e=t}if(!s){if(!(e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array))return void console.error("Invalid index buffer component type");if(e instanceof Uint32Array&&!a.getDeviceCaps().miscCaps.support32BitIndex)return void console.error("Device does not support 32bit vertex index");if(e instanceof Uint8Array){const t=new Uint16Array(e.length);t.set(e),e=t}}if(s){const t=a.getVertexAttribFormat(s,"f32",o);u=Sl().createVertexBuffer(t,e)}else u=Sl().createIndexBuffer(e,{managed:!0});t._bufferCache[l]=u}if(u)if(s)if(i.setVertexBuffer(u),"position"===s){i.getIndexBuffer()||(i.indexCount=Math.floor(u.byteLength/12));const e=n.getNormalizedDeinterlacedView(t);r.rawPositions=e;const s=n.min,a=n.max;if(s&&a)i.setBoundingVolume(new hu(new z(s),new z(a)));else{const t=new hu;t.beginExtend();for(let i=0;i<e.length;i++){const s=new z(e[i*o],e[i*o+1],e[i*o+2]);t.extend(s)}t.isValid()&&i.setBoundingVolume(t)}}else"blendIndices"===s?r.rawBlendIndices=n.getNormalizedDeinterlacedView(t):"blendWeights"===s&&(r.rawJointWeights=n.getNormalizedDeinterlacedView(t));else i.setIndexBuffer(u),i.indexCount=u.length;return u}isGLB(t){if(t.byteLength>12){const e=new Uint32Array(t,0,3);if(1179937895===e[0]&&2===e[1]&&e[2]===t.byteLength)return!0}return!1}getGLBChunkInfo(t,e){const i=new Uint32Array(t,e,2);return{start:e+8,length:i[0],type:i[1]}}getGLBChunkInfos(t){const e=[];let i=12;for(;i<t.byteLength;){const s=this.getGLBChunkInfo(t,i);e.push(s),i+=s.length+8}return e}}class Qg extends Hg{supportMIMEType(t){return"image/jpeg"===t||"image/png"===t||"image/webp"===t}async load(t,e,i,s,r){if(!t)throw new Error("unknown image file type");const a=new Blob([e],{type:t}),n={texture:r,samplerOptions:s};try{const t=await createImageBitmap(a,{premultiplyAlpha:"none"}),e=Sl().createTexture2DFromImage(t,i,n);if(!e)throw new Error("create texture from ImageBitmap failed");return t.close?.(),e}catch{const t=URL.createObjectURL(a);try{const e=await this.loadHTMLImage(t),s=document.createElement("canvas");s.width=e.naturalWidth||e.width,s.height=e.naturalHeight||e.height;const r=s.getContext("2d");if(!r)throw new Error("2D context not available");r.drawImage(e,0,0);const a=Sl().createTexture2DFromImage(s,i,n);if(!a)throw new Error("create texture from canvas failed");return a}finally{URL.revokeObjectURL(t)}}}async loadHTMLImage(t){return new Promise((e,i)=>{const s=new Image;s.onload=()=>e(s),s.onerror=t=>i(t),s.src=t})}}function qg(t){return t.codePointAt(0)+(t.codePointAt(1)<<8)+(t.codePointAt(2)<<16)+(t.codePointAt(3)<<24)}function Yg(t,e){const i={},s=new Uint32Array(t,e,32);if(542327876!==s[0])return console.error("Invalid DDS magic"),null;if(i.dwSize=s[1],124!==i.dwSize)return console.error("Invalid DDS header size"),null;if(i.dataOffset=i.dwSize+4,i.dwFlags=s[2],i.dwHeight=s[3],i.dwWidth=s[4],i.dwPitchOrLinearSize=s[5],i.dwDepth=s[6],i.dwMipmapCount=s[7],i.ddsPixelFormat={},i.ddsPixelFormat.dwFlags=s[20],i.ddsPixelFormat.dwFourCC=s[21],i.ddsPixelFormat.dwRGBBitCount=s[22],i.ddsPixelFormat.dwRBitMask=s[23],i.ddsPixelFormat.dwGBitMask=s[24],i.ddsPixelFormat.dwBBitMask=s[25],i.ddsPixelFormat.dwABitMask=s[26],i.dwCaps=s[27],i.dwCaps2=s[28],i.dwCaps3=s[29],i.dwCaps4=s[30],"DX10"===(r=i.ddsPixelFormat.dwFourCC,String.fromCodePoint(255&r,r>>8&255,r>>16&255,r>>24&255))){const s=new Uint32Array(t,e,37);i.ddsHeaderDX10={},i.ddsHeaderDX10.dxgiFormat=s[32],i.ddsPixelFormat.dwFourCC=i.ddsHeaderDX10.dxgiFormat,i.ddsHeaderDX10.dimension=s[33],i.ddsHeaderDX10.miscFlag=s[34],i.ddsHeaderDX10.arraySize=s[35],i.dataOffset+=20}var r;return i}const Zg={2:"rgba32f",3:"rgba32ui",4:"rgba32i",10:"rgba16f",12:"rgba16ui",14:"rgba16i",16:"rg32f",17:"rg32ui",18:"rg32i",28:"rgba8unorm",29:"rgba8unorm-srgb",30:"rgba8ui",31:"rgba8snorm",32:"rgba8i",34:"rg16f",36:"rg16ui",38:"rg16i",41:"r32f",42:"r32ui",43:"r32i",49:"rg8unorm",50:"rg8ui",51:"rg8snorm",52:"rg8i",54:"r16f",57:"r16ui",59:"r16i",61:"r8unorm",62:"r8ui",63:"r8snorm",64:"r8i",71:"dxt1",72:"dxt1-srgb",74:"dxt3",75:"dxt3-srgb",77:"dxt5",78:"dxt5-srgb",80:"bc4",81:"bc4-signed",83:"bc5",84:"bc5-signed",95:"bc6h",96:"bc6h-signed",98:"bc7",99:"bc7-srgb"},Kg=[{format:"dxt1",convertFlags:0,pf:{dwFlags:4,dwFourCC:qg("DXT1")}},{format:"dxt3",convertFlags:0,pf:{dwFlags:4,dwFourCC:qg("DXT3")}},{format:"dxt5",convertFlags:0,pf:{dwFlags:4,dwFourCC:qg("DXT5")}},{format:"bc4",convertFlags:0,pf:{dwFlags:4,dwFourCC:qg("ATI1")}},{format:"bc4",convertFlags:0,pf:{dwFlags:4,dwFourCC:qg("BC4U")}},{format:"bc4-signed",convertFlags:0,pf:{dwFlags:4,dwFourCC:qg("BC4S")}},{format:"bc5",convertFlags:0,pf:{dwFlags:4,dwFourCC:qg("ATI2")}},{format:"bc5",convertFlags:0,pf:{dwFlags:4,dwFourCC:qg("ATI2")}},{format:"bc5",convertFlags:0,pf:{dwFlags:4,dwFourCC:qg("BC5U")}},{format:"bc5-signed",convertFlags:0,pf:{dwFlags:4,dwFourCC:qg("BC5S")}},{format:"bgra8unorm",convertFlags:1,pf:{dwFlags:65,dwRGBBitCount:32,dwRBitMask:16711680,dwGBitMask:65280,dwBBitMask:255,dwABitMask:4278190080}},{format:"bgra8unorm",convertFlags:23,pf:{dwFlags:64,dwRGBBitCount:32,dwRBitMask:16711680,dwGBitMask:65280,dwBBitMask:255}},{format:"rgba8unorm",convertFlags:0,pf:{dwFlags:65,dwRGBBitCount:32,dwRBitMask:255,dwGBitMask:65280,dwBBitMask:16711680,dwABitMask:4278190080}},{format:"rgba8unorm",convertFlags:22,pf:{dwFlags:64,dwRGBBitCount:32,dwRBitMask:255,dwGBitMask:65280,dwBBitMask:16711680}},{format:"r16f",convertFlags:0,pf:{dwFlags:4,dwFourCC:111}},{format:"r16f",convertFlags:0,pf:{dwFlags:4,dwFourCC:54}},{format:"rg16f",convertFlags:0,pf:{dwFlags:4,dwFourCC:112}},{format:"rg16f",convertFlags:0,pf:{dwFlags:4,dwFourCC:34}},{format:"rgba16f",convertFlags:0,pf:{dwFlags:4,dwFourCC:113}},{format:"rgba16f",convertFlags:0,pf:{dwFlags:4,dwFourCC:10}},{format:"r32f",convertFlags:0,pf:{dwFlags:4,dwFourCC:114}},{format:"r32f",convertFlags:0,pf:{dwFlags:4,dwFourCC:41}},{format:"rg32f",convertFlags:0,pf:{dwFlags:4,dwFourCC:115}},{format:"rg32f",convertFlags:0,pf:{dwFlags:4,dwFourCC:16}},{format:"rgba32f",convertFlags:0,pf:{dwFlags:4,dwFourCC:116}},{format:"rgba32f",convertFlags:0,pf:{dwFlags:4,dwFourCC:2}}];function Jg(t,e){return(e=e||{}).format=function(t){if(t.ddsHeaderDX10){const e=t.ddsHeaderDX10?Zg[t.ddsHeaderDX10.dxgiFormat]:null;if(e)return e}const e=t.ddsPixelFormat,i=e.dwFlags;let s;for(s=0;s<Kg.length;s++){const t=Kg[s];if(4&i&&4&t.pf.dwFlags){if(e.dwFourCC===t.pf.dwFourCC)break}else if(i===t.pf.dwFlags)if(2&i){if(e.dwRGBBitCount===t.pf.dwRGBBitCount&&e.dwABitMask===t.pf.dwABitMask)break}else if(131072&i){if(!(e.dwRGBBitCount!==t.pf.dwRGBBitCount||e.dwRBitMask!==t.pf.dwRBitMask||e.dwABitMask!==t.pf.dwABitMask&&1&i))break}else if(e.dwRGBBitCount===t.pf.dwRGBBitCount&&!(e.dwRBitMask!==t.pf.dwRBitMask||e.dwGBitMask!==t.pf.dwGBitMask||e.dwBBitMask!==t.pf.dwBBitMask||e.dwABitMask!==t.pf.dwABitMask&&1&i))break}return s===Kg.length?null:Kg[s].format}(t),null===e.format?null:(e.isCompressed="dxt1"===e.format||"dxt3"===e.format||"dxt5"===e.format||"bc4"===e.format||"bc4-signed"===e.format||"bc5"===e.format||"bc5-signed"===e.format||"bc6h"===e.format||"bc6h-signed"===e.format||"bc7"===e.format||"bc7-srgb"===e.format,e.dataOffset=t.ddsHeaderDX10?148:128,e.width=t.dwWidth,e.height=t.dwHeight,e.depth=1,e.mipLevels=t.dwMipmapCount||1,e.arraySize=t.ddsHeaderDX10?t.ddsHeaderDX10.arraySize:1,e.isCubemap=e.isVolume=!1,65024&t.dwCaps2?(e.isCubemap=!0,e.arraySize*=6):2097152&t.dwCaps2?(e.isVolume=!0,e.depth=t.dwDepth):t.ddsHeaderDX10&&t.ddsHeaderDX10.arraySize>1&&(e.isArray=!0,e.depth=t.ddsHeaderDX10.arraySize),e)}function tx(t,e,i,s,r){switch(s){case"r16f":return new Uint16Array(t,r,e*i);case"rg16f":return new Uint16Array(t,r,e*i*2);case"r32f":return new Float32Array(t,r,e*i);case"rgba8unorm":case"bgra8unorm":return new Uint8Array(t,r,e*i*4);case"rgba16f":return new Uint16Array(t,r,e*i*4);case"rg32f":return new Float32Array(t,r,e*i*2);case"rgba32f":return new Float32Array(t,r,e*i*4);case"dxt1":case"bc4":case"bc4-signed":return new Uint8Array(t,r,Math.max(4,e)/4*Math.max(4,i)/4*8);case"dxt3":case"dxt5":case"bc5":case"bc5-signed":case"bc6h":case"bc6h-signed":case"bc7":case"bc7-srgb":return new Uint8Array(t,r,Math.max(4,e)/4*Math.max(4,i)/4*16);default:return null}}class ex extends Hg{supportMIMEType(t){return"image/dds"===t||"image/x-dds"===t}async load(t,e,i,s,r){const a=function(t,e){const i=Yg(t,e);if(!i)return null;const s={};Jg(i,s),s.mipDatas=[];let r=s.dataOffset;for(let i=0;i<s.arraySize;i++){const i=[];let a=s.width,n=s.height;for(let o=0;o<s.mipLevels;o++){const o=tx(t,a,n,s.format,r+e);i.push({data:o,width:a,height:n}),r+=o.byteLength,a=Math.max(1,a>>1),n=Math.max(1,n>>1)}s.mipDatas.push(i)}return s}(e instanceof ArrayBuffer?e:e.buffer,e instanceof ArrayBuffer?0:e.byteOffset);if(!a)throw new Error("read DDS file failed");const n={texture:r,samplerOptions:s};return Sl().createTextureFromMipmapData(a,i,n)}}const ix=B(1);class sx extends Hg{supportMIMEType(t){return"image/hdr"===t||"image/x-hdr"===t||"image/vnd.radiance"===t}async load(t,e,i,s,r){let a;for(const t of["rg11b10uf","rgba16f","rgba32f","rgba8unorm"]){const e=Sl().getDeviceCaps().textureCaps.getTextureFormatInfo(t);if(e&&e.filterable&&e.renderable){a=t;break}}const n=e instanceof ArrayBuffer?e:e.buffer,o=e instanceof ArrayBuffer?0:e.byteOffset,h=await this.loadHDR(new Uint8Array(n,o),a),l={texture:r,samplerOptions:s},u=Sl().createTexture2D(a,h.width,h.height,l);return u.update(h.dataFloat,0,0,h.width,h.height),u}_rgbeToFloat32(t){const e=t.byteLength>>2,i=new Float32Array(4*e);for(let s=0;s<e;s++){const e=Math.pow(2,t[4*s+3]-136);i[4*s]=t[4*s]*e,i[4*s+1]=t[4*s+1]*e,i[4*s+2]=t[4*s+2]*e,i[4*s+3]=1}return i}_rgbeToFloat16(t){const e=t.byteLength>>2,i=new Uint16Array(4*e);for(let s=0;s<e;s++){const e=Math.pow(2,t[4*s+3]-136);i[4*s+0]=B(Math.max(-65504,Math.min(t[4*s]*e,65504))),i[4*s+1]=B(Math.max(-65504,Math.min(t[4*s+1]*e,65504))),i[4*s+2]=B(Math.max(-65504,Math.min(t[4*s+2]*e,65504))),i[4*s+3]=ix}return i}_rgbeToR11G11B10(t){const e=t.byteLength>>2,i=new Uint32Array(e);for(let s=0;s<e;s++){const e=Math.pow(2,t[4*s+3]-136),r=t[4*s]*e,a=t[4*s+1]*e,n=t[4*s+2]*e;i[s]=I(r,a,n)}return i}_rgbeToRGBM(t){const e=t.byteLength>>2,i=new Uint8Array(4*e);for(let s=0;s<e;s++){const e=Math.pow(2,t[4*s+3]-136),r=Math.pow(t[4*s]*e,1/2.2),a=Math.pow(t[4*s+1]*e,1/2.2),n=Math.pow(t[4*s+2]*e,1/2.2),o=Math.max(r,a,n),h=Math.ceil(255*o/6)/255,l=6*h;i[4*s]=Math.ceil(255*r/l),i[4*s+1]=Math.ceil(255*a/l),i[4*s+2]=Math.ceil(255*n/l),i[4*s+3]=Math.ceil(255*Math.min(h,1))}return i}async loadHDR(t,e){let i="",s=0;const r=t;let a;for(;!i.match(/\n\n[^\n]+\n/g);)i+=String.fromCodePoint(r[s++]);if(a=i.match(/FORMAT=(.*)$/m),a.length<2)return;if(a=a[1],"32-bit_rle_rgbe"!=a)return console.warn("unknown format : "+a),null;let n=i.split(/\n/).reverse();if(n.length<2)return;if(n=n[1].split(" "),n.length<4)return;const o=1*Number(n[3]),h=1*Number(n[1]),l=new Uint8Array(o*h*4);let u=0;for(let t=0;t<h;t++){const t=[];let e=r.slice(s,s+=4);if(2==e[0]&&2==e[1]&&e[2]==(o>>8&255)&&e[3]==(255&o)&&o>=8&&o<32768){for(let e=0;e<4;e++){let i=e*o;const a=(e+1)*o;let n,h;for(;i<a;)if(n=r.slice(s,s+=2),n[0]>128)for(h=n[0]-128;h-- >0;)t[i++]=n[1];else for(h=n[0]-1,t[i++]=n[1];h-- >0;)t[i++]=r[s++]}for(let e=0;e<o;e++)l[u++]=t[e+0*o],l[u++]=t[e+1*o],l[u++]=t[e+2*o],l[u++]=t[e+3*o]}else{s-=4;for(let t=0;t<o;t++)e=r.slice(s,s+=4),l[u++]=e[0],l[u++]=e[1],l[u++]=e[2],l[u++]=e[3]}}return{dataFloat:"rgba32f"===e?this._rgbeToFloat32(l):"rgba16f"===e?this._rgbeToFloat16(l):"rg11b10uf"===e?this._rgbeToR11G11B10(l):this._rgbeToRGBM(l),width:o,height:h}}}function rx(t){const e=new Uint32Array(1);function i(t,i,s){s.setXY(t*i,function(t){return e[0]=t,e[0]=(e[0]<<16|e[0]>>16)>>>0,e[0]=(1431655765&e[0])<<1|(2863311530&e[0])>>>1>>>0,e[0]=(858993459&e[0])<<2|(3435973836&e[0])>>>2>>>0,e[0]=(252645135&e[0])<<4|(4042322160&e[0])>>>4>>>0,e[0]=(16711935&e[0])<<8|(4278255360&e[0])>>>8>>>0,2.3283064365386963e-10*e[0]}(t))}function s(t,e){const i=1/e,s=1-t*t;return(2+i)*Math.pow(s,.5*i)/(2*Math.PI)}function r(t,e){return Math.min(Math.max(1/(4*(e+t-e*t)),0),1)}function a(t,e){const i=2*Math.PI*t.x,s=1-t.y,r=Math.sqrt(1-s*s);e.setXYZ(r*Math.cos(i),r*Math.sin(i),s)}function n(t,e,n){let o=0;const h=new z(Math.sqrt(1-t*t),0,t),l=new L,u=new z,c=new z;for(let d=0;d<n;d++){i(d,1/n,l),a(l,u),z.scale(u,2*z.dot(h,u),c).subBy(h);const p=Math.min(Math.max(z.dot(h,u),0),1),m=Math.min(Math.max(c.z,0),1),f=Math.min(Math.max(u.z,0),1);if(m>0){o+=r(t,m)*s(f,e)*m*p}}return o*(8*Math.PI/n)}const o=function(){const t=new ArrayBuffer(4),e=new Float32Array(t),i=new Uint32Array(t),s=new Uint32Array(512),r=new Uint32Array(512);for(let t=0;t<256;++t){const e=t-127;e<-27?(s[t]=0,s[256|t]=32768,r[t]=24,r[256|t]=24):e<-14?(s[t]=1024>>-e-14,s[256|t]=1024>>-e-14|32768,r[t]=-e-1,r[256|t]=-e-1):e<=15?(s[t]=e+15<<10,s[256|t]=e+15<<10|32768,r[t]=13,r[256|t]=13):e<128?(s[t]=31744,s[256|t]=64512,r[t]=24,r[256|t]=24):(s[t]=31744,s[256|t]=64512,r[t]=13,r[256|t]=13)}const a=new Uint32Array(2048),n=new Uint32Array(64),o=new Uint32Array(64);for(let t=1;t<1024;++t){let e=t<<13,i=0;for(;!(8388608&e);)e<<=1,i-=8388608;e&=-8388609,i+=947912704,a[t]=e|i}for(let t=1024;t<2048;++t)a[t]=939524096+(t-1024<<13);for(let t=1;t<31;++t)n[t]=t<<23;n[31]=1199570944,n[32]=2147483648;for(let t=33;t<63;++t)n[t]=2147483648+(t-32<<23);n[63]=3347054592;for(let t=1;t<64;++t)32!==t&&(o[t]=1024);return{floatView:e,uint32View:i,baseTable:s,shiftTable:r,mantissaTable:a,exponentTable:n,offsetTable:o}}();function h(t){t=Math.min(Math.max(t,-65504),65504),o.floatView[0]=t;const e=o.uint32View[0],i=e>>23&511;return o.baseTable[i]+((8388607&e)>>o.shiftTable[i])}return function(e,i){if(i){if(!i.isTexture2D())throw new Error("can not reload sheen lut texture: invalid texture type");if("rgba16f"!==i.format)throw new Error("can not reload sheen lut texture: invalid texture format");if(i.width!==t||i.height!==t)throw new Error("can not reload sheen lut texture: invalid texture size")}const s=i||Sl().createTexture2D("rgba16f",t,t),r=new Uint16Array(t*t*4);let a=0;const o=h(1);for(let e=t-1;e>=0;e--){const i=Math.min(Math.max((e+.5)/t,0),1),s=i*i;for(let e=0;e<t;e++){const i=h(n(Math.min(Math.max((e+.5)/t,0),1),s,512));r[a++]=0,r[a++]=0,r[a++]=i,r[a++]=o}}return s.update(r,0,0,t,t),s.name=`builtin:${mu}`,s}}class ax extends Hg{supportMIMEType(t){return"image/tga"===t||"image/x-tga"===t}parseTGA(t,e,i,s){const r=t instanceof ArrayBuffer?t:t.buffer,a=t instanceof ArrayBuffer?0:t.byteOffset,n=new DataView(r,a),o=[0,0,0,0];t:{let t=0;t+=n.getUint8(0);const r=n.getUint8(1);if(0!==r&&1!==r)break t;const a=n.getUint8(2);if(2!==a&&10!==a)break t;t+=n.getUint16(5,!0)*r;const h=n.getUint16(12,!0),l=n.getUint16(14,!0),u=n.getUint8(16);if(16!==u&&24!==u&&32!==u)break t;let c=18+t;const d=u/8,p=new Uint8Array(h*l*4);let m=0;for(;m<h*l;)if(2===a){for(let t=0;t<d;t++)o[t]=n.getUint8(c++);this.mergeBytes(p,4*m,o,d),m++}else{const t=n.getUint8(c++);for(let t=0;t<d;t++)o[t]=n.getUint8(c++);const e=127&t;if(this.mergeBytes(p,4*m,o,d),m++,128&t)for(let t=0;t<e;t++)this.mergeBytes(p,4*m,o,d),m++;else for(let t=0;t<e;t++){for(let e=0;e<d;e++)o[t]=n.getUint8(c++);this.mergeBytes(p,4*m,o,d),m++}}const f={texture:s};i&&(f.mipmapping=!1);const _=Sl().createTexture2D(e?"rgba8unorm-srgb":"rgba8unorm",h,l,f);return _.update(p,0,0,h,l),_}throw new Error("Unsupported TGA file format")}mergeBytes(t,e,i,s){4===s?(t[e+0]=i[2],t[e+1]=i[1],t[e+2]=i[0],t[e+3]=i[3]):3===s?(t[e+0]=i[2],t[e+1]=i[1],t[e+2]=i[0],t[e+3]=255):2===s&&(t[e+0]=(124&i[1])<<1,t[e+1]=(3&i[1])<<6|(224&i[0])>>2,t[e+2]=(31&i[0])<<3,t[e+3]=128&i[1])}async load(t,e,i,s,r){return new Promise(t=>{t(this.parseTGA(e,i,"none"===s?.mipFilter,r))})}}class nx{static _builtinTextures={};static _builtinTextureLoaders={[mu]:rx(64)};static _textureLoaders=[new Qg,new ex,new sx,new ax];static _modelLoaders=[new jg];_textures;_models;_binaryDatas;_textDatas;_bluePrints;_materials;_primitives;_skeletons;_jsonDatas;_resourceManager;constructor(t){this._resourceManager=t??wl().resourceManager,this._textures={},this._models={},this._materials={},this._primitives={},this._bluePrints={},this._binaryDatas={},this._textDatas={},this._jsonDatas={}}get vfs(){return this._resourceManager.VFS}clearCache(){for(const t in Object.keys(this._textures)){const e=this._textures[t];e instanceof St&&e.dispose()}this._textures={};for(const t in Object.keys(this._models)){const e=this._models[t];e instanceof St&&e.dispose()}this._models={};for(const t in Object.keys(this._materials)){const e=this._materials[t];e instanceof St&&e.dispose()}this._materials={};for(const t in Object.keys(this._primitives)){const e=this._primitives[t];e instanceof St&&e.dispose()}this._primitives={};for(const t in Object.keys(this._skeletons)){const e=this._skeletons[t];e instanceof St&&e.dispose()}this._skeletons={},this._binaryDatas={},this._textDatas={},this._jsonDatas={}}static addTextureLoader(t){t&&this._textureLoaders.unshift(t)}static addModelLoader(t){t&&this._modelLoaders.unshift(t)}async fetchTextData(t,e,i,s){const r=i?.urlResolver?.(t)??t;let a=this._textDatas[r];return a||(a=this.loadTextData(t,e,s),this._textDatas[r]=a),a}async fetchJsonData(t,e,i,s){const r=i?.urlResolver?.(t)??t;let a=this._jsonDatas[r];return a||(a=this.loadJsonData(t,e,s),this._jsonDatas[r]=a),a}async fetchBinaryData(t,e,i,s){const r=i?.urlResolver?.(t)??t;let a=this._binaryDatas[r];return a||(a=this.loadBinaryData(t,e,s),this._binaryDatas[r]=a),a}async fetchBluePrint(t,e){const i=t;let s=this._bluePrints[i];return s||(s=this.loadBluePrint(t,e),this._bluePrints[i]=s),s}async fetchMaterial(t,e){const i=t;let s=this._materials[i];if(s instanceof St&&s.get()&&!s.get().disposed)return s.get();(!s||s instanceof St)&&(s=this.loadMaterial(t,!1,e),this._materials[i]=s);const r=await s;return this._materials[i]instanceof Promise&&(this._materials[i]=new St(r)),r}async fetchPrimitive(t,e){const i=t;let s=this._primitives[i];if(s instanceof St&&s.get()&&!s.get().disposed)return s.get();(!s||s instanceof St)&&(s=this.loadPrimitive(t,e),this._primitives[i]=s);const r=await s;return this._primitives[i]instanceof Promise&&(this._primitives[i]=new St(r)),r}async fetchTexture(t,e,i){if(e?.texture)return this.loadTexture(t,e.mimeType??null,!e.linearColorSpace,e.samplerOptions,e.texture,i);{const s=this.getHash("2d",t,e);let r=this._textures[s];if(r instanceof St&&r.get()&&!r.get().disposed)return r.get();(!r||r instanceof St)&&(r=this.loadTexture(t,e?.mimeType??null,!e?.linearColorSpace,e?.samplerOptions,null,i),this._textures[s]=r);const a=await r;return this._textures[s]instanceof Promise&&(this._textures[s]=new St(a)),a}}async fetchModelData(t,e,i){const s=t;let r=this._models[s];if(r instanceof St&&r.get()&&!r.get().disposed)return r.get();(!r||r instanceof St)&&(r=this.loadModel(t,e,i),this._models[s]=r);const a=await r;return this._models[s]instanceof Promise&&(this._models[s]=new St(a)),a}async fetchModel(t,e,i,s){const r=(await this.fetchModelData(e,i,s)).createSceneNode(t,!!i?.enableInstancing);return{group:r,animationSet:r.animationSet}}async loadTextData(t,e,i){let s=await this.readFileFromVFSs(t,{encoding:"utf8"},i);if(e)try{s=e(s)}catch(t){throw new Error(`Load text data post process failed: ${t}`)}return s}async loadJsonData(t,e,i){let s=JSON.parse(await this.readFileFromVFSs(t,{encoding:"utf8"},i));if(e)try{s=e(s)}catch(t){throw new Error(`Load json data post process failed: ${t}`)}return s}async loadBinaryData(t,e,i){try{let s=await this.readFileFromVFSs(t,{encoding:"binary"},i);return e&&(s=e(s)),s}catch(t){return console.error(`Load binary data failed: ${t}`),null}}async loadPrimitive(t,i){try{const r=await this.readFileFromVFSs(t,{encoding:"utf8"},i),a=JSON.parse(r);if(e("Primitive"===a.type||"Default"===a.type,`Unsupported primitive type: ${a.type}`),"Primitive"===a.type){const t=a.data,e=new Cl;for(const i in t.vertices){const r=t.vertices[i],a=s(r.data);e.createAndSetVertexBuffer(r.format,a)}if(t.indices){const i=s(t.indices),r="u16"===t.indexType?new Uint16Array(i.buffer):"u32"===t.indexType?new Uint32Array(i.buffer):null;if(!r)return console.error(`Invalid index type in primitive data: ${t.indexType}`),null;e.createAndSetIndexBuffer(r)}return e.primitiveType=t.type,e.indexCount=t.indexCount,e.setBoundingVolume(new hu(new z(t.boxMin[0],t.boxMin[1],t.boxMin[2]),new z(t.boxMax[0],t.boxMax[1],t.boxMax[2]))),e}{const t=await this._resourceManager.deserializeObject(null,a.data);return t instanceof Cl?t:("function"==typeof t.dispose&&t.dispose(),null)}}catch(t){return console.error(`Load primitive failed: ${t}`),null}}async reloadBluePrintMaterials(t){const e=[],i=[];for(const t of Object.keys(this._materials)){const s=this._materials[t];s instanceof Promise?(e.push(s),i.push(t)):s instanceof St&&s.get()&&(e.push(Promise.resolve(s.get())),i.push(t))}const s=await Promise.all(e);for(let e=0;e<s.length;e++){const r=s[e];if(r instanceof Mm&&(!t||t(r))){const t=await this.loadBluePrintMaterialData(i[e],!0);r.fragmentIR=t.irFragment,r.vertexIR=t.irVertex,r.uniformValues=t.uniformValues,r.uniformTextures=t.uniformTextures}}}async loadBluePrintMaterialData(t,i,s){try{const r=await this.readFileFromVFSs(t,{encoding:"utf8"},s),a=JSON.parse(r);e("PBRBluePrintMaterial"===a.type,`Unsupported material type: ${a.type}`);const n=i?await this.loadBluePrint(a.data.IR,s):await this.fetchBluePrint(a.data.IR,s),o=a.data.uniformValues.map(t=>({...t,finalValue:1===t.value.length?t.value[0]:new Float32Array(t.value)})),h=[],l=a.data.uniformTextures;for(const t of l){const e=await this.fetchTexture(t.texture,{linearColorSpace:!t.sRGB},s);h.push({...t,finalTexture:new wt(e),finalSampler:Sl().createSampler({addressU:t.wrapS,addressV:t.wrapT,minFilter:t.minFilter,magFilter:t.magFilter,mipFilter:t.mipFilter}),params:e?new O(e.width,e.height,e.depth,e.mipLevelCount):O.zero()})}return{irFragment:n.fragment,irVertex:n.vertex,uniformValues:o,uniformTextures:h}}catch(t){return console.error(`Load material failed: ${t}`),null}}async loadMaterial(t,i,s){try{const r=await this.readFileFromVFSs(t,{encoding:"utf8"},s),a=JSON.parse(r);if(e("PBRBluePrintMaterial"===a.type||"Default"===a.type,`Unsupported material type: ${a.type}`),"PBRBluePrintMaterial"===a.type){const e=await this.loadBluePrintMaterialData(t,i,s);return new Mm(e.irFragment,e.irVertex,e.uniformValues,e.uniformTextures)}{const t=await this._resourceManager.deserializeObject(null,a.data);return t instanceof qc?t:("function"==typeof t.dispose&&t.dispose(),null)}}catch(t){return console.error(`Load material failed: ${t}`),null}}rebuildGraphStructure(t,e){const i={outgoing:{},incoming:{}};for(const e in t)i.outgoing[e]=[],i.incoming[e]=[];for(const t of e){const e={targetNodeId:t.endNodeId,startSlotId:t.startSlotId,endSlotId:t.endSlotId},s={targetNodeId:t.startNodeId,startSlotId:t.startSlotId,endSlotId:t.endSlotId};i.outgoing[t.startNodeId]?.push(e),i.incoming[t.endNodeId]?.push(s)}return i}collectReachableBackward(t,e,i){const s=new Set,r=[];for(const t of i)e[t]&&(s.add(t),r.push(t));for(;r.length>0;){const e=r.shift(),i=t.incoming[e]||[];for(const t of i){const e=t.targetNodeId;s.has(e)||(s.add(e),r.push(e))}}return s}getReverseTopologicalOrderFromRoots(t,e,i){if(!i||0===i.length)return{order:[],levels:[]};const s=this.collectReachableBackward(t,e,i);if(0===s.size)return{order:[],levels:[]};const r=new Map;for(const e of s){const i=(t.outgoing[e]||[]).filter(t=>s.has(t.targetNodeId));r.set(e,i.length)}let a=Array.from(r.entries()).filter(([,t])=>0===t).map(([t])=>t);const n=[],o=[];for(;a.length>0;){o.push([...a]),n.push(...a);const e=[];for(const i of a){const a=t.incoming[i]||[];for(const t of a){const i=t.targetNodeId;if(!s.has(i))continue;const a=r.get(i)-1;r.set(i,a),0===a&&e.push(i)}}a=e}return n.length!==s.size?(console.warn("Subgraph contains cycles (from given roots)."),null):{order:n,levels:o}}createBluePrintDAG(t,e,i){const s=this.rebuildGraphStructure(t,i);for(const e in s.incoming){const i=t[e];for(const r of s.incoming[e]){const e=i.inputs.find(t=>t.id===r.endSlotId);e.inputNode=t[r.targetNodeId],e.inputId=r.startSlotId}}return{graph:s,nodeMap:t,roots:e,order:this.getReverseTopologicalOrderFromRoots(s,t,e).order.reverse()}}async loadBluePrint(t,i){try{const s=await this.readFileFromVFSs(t,{encoding:"utf8"},i),r=JSON.parse(s);e("PBRMaterial"===r.type||"MaterialFunction"===r.type,`Unsupported blueprint type: ${r.type}`);const a=r.state,n={};for(const e of Object.keys(a)){const i=[],s={},r=a[e];for(const t of r.nodes){const e=await this._resourceManager.deserializeObject(null,t.node);s[t.id]=e,0===e.outputs.length&&i.push(t.id)}const o=await this.createBluePrintDAG(s,i,r.links);n[e]=new Em(o,t)}return n}catch(t){const e=`Load material failed: ${t}`;return console.error(e),null}}async loadTextureFromBuffer(t,e,i,s,r){for(const a of nx._textureLoaders){if(!a.supportMIMEType(e))continue;return await this.doLoadTexture(a,e,t,!!i,s,r)}throw new Error(`Can not find loader for MIME type '${e}'`)}async loadTexture(t,e,i,s,r,a){const n=await this.readFileFromVFSs(t,{encoding:"binary"},a);e=e??this.vfs.guessMIMEType(t);for(const a of nx._textureLoaders){if(!a.supportMIMEType(e))continue;const o=await this.doLoadTexture(a,e,n,!!i,s,r);return o.name=this.vfs.basename(t),o}throw new Error(`Can not find loader for asset ${t}`)}async doLoadTexture(t,e,i,s,r,a){const n=Sl();if("webgl"!==n.type)return await t.load(e,i,s,r,a);{let o=await t.load(e,i,s,r);if(a){const t=o.width!==a.width||o.height!==a.height?"linear":"nearest",e=t,i="none",s=n.createSampler({addressU:"clamp",addressV:"clamp",magFilter:t,minFilter:e,mipFilter:i});(new zl).blit(o,a,s),o=a}else{const t=E(o.width),e=E(o.height),i=o.isSRGBFormat();if(i||!t||!e){const s=t?o.width:M(o.width),r=e?o.height:M(o.height),a=s!==o.width||r!==o.height?"linear":"nearest",h=a,l="none",u=n.createSampler({addressU:"clamp",addressV:"clamp",magFilter:a,minFilter:h,mipFilter:l}),c=i?"rgba8unorm":o.format,d=new zl,p=o.isTexture2D()?n.createTexture2D(c,s,r):n.createCubeTexture(c,s);d.blit(o,p,u),o.dispose(),o=p}}return o}}async loadModel(t,e,i){const s=await this.readFileFromVFSs(t,{encoding:"binary"},i),r=e?.mimeType||this.vfs.guessMIMEType(t),a=new Blob([s],{type:r}),n=this.vfs.basename(t);for(const s of nx._modelLoaders){if(!s.supportMIMEType(r))continue;let o=await s.load(this,t,e?.mimeType||a.type,a,e?.dracoDecoderModule,i);if(!o)throw new Error(`Load asset failed: ${t}`);if(e?.postProcess)try{o=e.postProcess(o)}catch(t){throw new Error(`Model loader post process failed: ${t}`)}return o.name=n,o}throw new Error(`Can not find loader for asset ${t}`)}fetchBuiltinTexture(t,e){const i=nx._builtinTextureLoaders[t];if(!i)throw new Error(`Unknown builtin texture name: ${t}`);return e?i(this,e):((e=nx._builtinTextures[t])||(e=i(this),nx._builtinTextures[t]=e),e.restoreHandler=t=>{i(this,t)},e)}static setBuiltinTextureLoader(t,e){this._builtinTextureLoaders[t]=e||void 0}getHash(t,e,i){return`${t}:${e}:${!i?.linearColorSpace}`}async readFileFromVFSs(t,e,i){i=i??[this.vfs];for(const s of i){if(!await s.exists(t))continue;const i=await s.stat(t);if(i&&i.isFile)return await s.readFile(t,e)}throw new dt(`File does not exist: ${t}`,"ENOENT",t)}async writeFileToVFSs(t,e,i,s){s=s??[this.vfs];for(const r of s)await r.writeFile(t,e,i)}}const ox={bool:!1,float:0,int:0,int2:[0,0],int3:[0,0,0],int4:[0,0,0,0],object:null,object_array:[],embedded:"",rgb:[0,0,0],rgba:[0,0,0,0],string:"",vec2:[0,0],vec3:[0,0,0],vec4:[0,0,0,0],command:null};class hx{_classMap;_vfs;_propMap;_propNameMap;_clsPropMap;_assetManager;_editorMode;_allocated;constructor(t,e=!1){var r;this._vfs=t,this._editorMode=e,this._allocated=new WeakMap,this._assetManager=new nx(this),this._propMap={},this._propNameMap=new Map,this._clsPropMap=new Map,this._classMap=new Map([{ctor:ig,name:"JSONProp",noTitle:!0,createFunc:t=>({obj:new ig(t)}),getProps:()=>[{name:"name",type:"string",default:"",isHidden(){return!this.parent||this.parent instanceof og},get(t){t.str[0]=this.name},set(t){const e=this.parent;e&&t.str[0]&&!e.value.find(e=>e!==this&&e.name===t.str[0])&&(this.name=t.str[0],this.parent.updateProps())}}]},{ctor:rg,parent:ig,name:"JSONNumber",noTitle:!0,createFunc:t=>({obj:new sg(t)}),getProps:()=>[{name:"value",type:"float",isHidden(){return this.name.startsWith(".")},get(t){t.num[0]=this.value},set(t){this.value!==t.num[0]&&(this.value=t.num[0],this.parent.updateProps())}}]},{ctor:sg,parent:ig,name:"JSONString",noTitle:!0,createFunc:t=>({obj:new sg(t)}),getProps:()=>[{name:"value",type:"string",isHidden(){return this.name.startsWith(".")},get(t){t.str[0]=this.value},set(t){this.value!==t.str[0]&&(this.value=t.str[0],this.parent.updateProps())}}]},{ctor:ag,parent:ig,name:"JSONBool",noTitle:!0,createFunc:t=>({obj:new ag(t)}),getProps:()=>[{name:"value",type:"bool",isHidden(){return this.name.startsWith(".")},get(t){t.bool[0]=this.value},set(t){this.value!==t.bool[0]&&(this.value=t.bool[0],this.parent.updateProps())}}]},{ctor:ng,parent:ig,name:"JSONData",noTitle:!0,createFunc:t=>({obj:new ng(t instanceof ng?t:null)}),getProps:()=>[{name:"JSONData",type:"object_array",options:{objectTypes:[sg,rg,ag,ng,og]},default:[],isNullable:()=>!1,isHidden(){return this.name.startsWith(".")},get(t){t.object=this.value.slice()},set(t,e){null===t?this.isnull=!0:e>=0?(this.value[e]=t.object[0],this.updateProps()):(this.value=t.object.slice(),this.updateProps())},create(t){return t?new t(this):null},add(t,e){this.value.splice(e,0,t.object[0]),this.updateProps()},delete(t){this.value.splice(t,1),this.updateProps()}}]},{ctor:og,parent:ig,name:"JSONArray",noTitle:!0,createFunc:t=>({obj:new og(t instanceof ng||t instanceof og?t:null)}),getProps:()=>[{name:"JSONArray",type:"object_array",options:{objectTypes:[sg,rg,ag,ng,og]},default:[],isNullable:()=>!0,get(t){t.object=this.value.slice()},set(t,e){null===t?this.isnull=!0:e>=0?(this.value[e]=t.object[0],this.updateProps()):(this.value=t.object.slice(),this.updateProps())},create(t,e){const i=t?new t(this):null;return i&&(i.name=String(e)),i},add(t,e){this.value.splice(e,0,t.object[0]),this.updateProps()},delete(t){this.value.splice(t,1),this.updateProps()}}]},{ctor:q,name:"AABB",getProps:()=>[{name:"Min",type:"vec3",get(t){t.num[0]=this.minPoint.x,t.num[1]=this.minPoint.y,t.num[2]=this.minPoint.z},set(t){this.minPoint.setXYZ(t.num[0],t.num[1],t.num[2])}},{name:"Max",type:"vec3",get(t){t.num[0]=this.maxPoint.x,t.num[1]=this.maxPoint.y,t.num[2]=this.maxPoint.z},set(t){this.maxPoint.setXYZ(t.num[0],t.num[1],t.num[2])}}]},{ctor:ot,name:"Interpolator",createFunc(t,e){const i=e.inputs?new Float32Array(s(e.inputs).buffer):new Float32Array,r=e.outputs?new Float32Array(s(e.outputs).buffer):new Float32Array;return{obj:new ot(e.mode,e.target,i,r)}},getInitParams(t){const e=t.inputs instanceof Float32Array?t.inputs:t.inputs?new Float32Array(t.inputs):new Float32Array,s=t.outputs instanceof Float32Array?t.outputs:t.outputs?new Float32Array(t.outputs):new Float32Array;return{mode:t.mode,target:t.target,inputs:i(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),outputs:i(new Uint8Array(s.buffer,s.byteOffset,s.byteLength))}},getProps:()=>[{name:"Mode",type:"string",get(t){t.str[0]=this.mode}},{name:"Target",type:"string",get(t){t.str[0]=this.target}}]},{ctor:Su,name:"Skeleton",createFunc(t,e){const i=t.getPrefabNode(),r=e.joints.map(t=>i.findNodeById(t)).map(t=>(t.jointTypeT="static",t.jointTypeS="static",t.jointTypeR="static",t)),a=new Float32Array(s(e.inverseBindMatrices).buffer),n=new Float32Array(s(e.bindPoseMatrices).buffer),o=new Float32Array(s(e.jointTransforms).buffer),h=[],l=[],u=[];for(let t=0;t<r.length;t++)h.push(new W(a.slice(16*t,16*t+16))),l.push(new W(n.slice(16*t,16*t+16))),u.push({position:new z(o.slice(10*t+0,10*t+3)),rotation:new U(o.slice(10*t+3,10*t+7)),scale:new z(o.slice(10*t+7,10*t+10))});const c=new Su(r,h,l,u);return c.persistentId=e.id,{obj:c,loadProps:!1}},getInitParams(t){const e=t.inverseBindMatrices.map(t=>[...t]).reduce((t,e)=>[...t,...e],[]),s=t.bindPoseMatrices.map(t=>[...t]).reduce((t,e)=>[...t,...e],[]),r=t.jointTransforms.map(t=>[...t.position,...t.rotation,...t.scale]).reduce((t,e)=>[...t,...e],[]);return{joints:t.joints.map(t=>t.persistentId),inverseBindMatrices:i(new Uint8Array(new Float32Array(e).buffer)),bindPoseMatrices:i(new Uint8Array(new Float32Array(s).buffer)),jointTransforms:i(new Uint8Array(new Float32Array(r).buffer)),id:t.persistentId}},getProps:()=>[]},(r=this,{ctor:lu,name:"AnimationClip",createFunc:(t,e)=>({obj:t.animationSet.get(e)??t.animationSet.createAnimation(e,!1)}),getInitParams:t=>t.name,getProps:()=>[{name:"Name",type:"string",get(t){t.str[0]=this.name}},{name:"Duration",type:"float",default:1,get(t){t.num[0]=this.timeDuration},set(t){this.timeDuration=t.num[0]}},{name:"Weight",type:"float",default:1,get(t){t.num[0]=this.weight},set(t){this.weight=t.num[0]}},{name:"AutoPlay",type:"bool",default:!1,get(t){t.bool[0]=this.autoPlay},set(t){this.autoPlay=t.bool[0]}},{name:"Skeletons",type:"object",isHidden:()=>!0,get(t){t.object[0]=[...this.skeletons]},set(t){this.skeletons||(this.skeletons=new Set);for(const e of t.object[0]??[])this.skeletons.add(e)}},{name:"Tracks",type:"object_array",options:{edit:"proptrack",objectTypes:[Pg]},readonly:!0,isHidden:(t,e)=>!(t<0||e instanceof Pg),get(t){t.object=[];for(const e of this.tracks){for(const t of e[1])e[0]instanceof Au&&!(t instanceof Pg)&&(t.target=e[0].persistentId);t.object.push(...e[1])}},set(t){for(const e of t.object)if(e instanceof Pg){const t=r.findAnimationTarget(this._animationSet.model,e);t&&this.addTrack(t,e)}else if(e instanceof cu){const t=this._animationSet.model.getPrefabNode().findNodeById(e.target);t?this.addTrack(t,e):console.error(`No node found with id = ${e.target}`)}},delete(t){const e=[];for(const t of this.tracks)e.push(...t[1].filter(t=>t instanceof Pg));const i=e[t];i&&this.deleteTrack(i)}}]}),Dg(this),{ctor:tg,name:"NodeRotationTrack",getProps:()=>[{name:"TrackName",type:"string",options:{label:"Name"},get(t){t.str[0]=this.name},set(t){this.name=t.str[0]}},{name:"Interpolator",type:"object",options:{objectTypes:[ot]},isHidden:()=>!0,get(t){t.object[0]=this.interpolator},set(t){this.interpolator=t.object[0]}},{name:"TrackTarget",type:"string",isHidden:()=>!0,get(t){t.str[0]=this.target},set(t){this.target=t.str[0]}}]},{ctor:eg,name:"NodeScaleTrack",getProps:()=>[{name:"TrackName",type:"string",options:{label:"Name"},get(t){t.str[0]=this.name},set(t){this.name=t.str[0]}},{name:"Interpolator",type:"object",options:{objectTypes:[ot]},isHidden:()=>!0,get(t){t.object[0]=this.interpolator},set(t){this.interpolator=t.object[0]}},{name:"TrackTarget",type:"string",isHidden:()=>!0,get(t){t.str[0]=this.target},set(t){this.target=t.str[0]}}]},{ctor:J_,name:"NodeTranslationTrack",getProps:()=>[{name:"TrackName",type:"string",options:{label:"Name"},get(t){t.str[0]=this.name},set(t){this.name=t.str[0]}},{name:"Interpolator",type:"object",options:{objectTypes:[ot]},isHidden:()=>!0,get(t){t.object[0]=this.interpolator},set(t){this.interpolator=t.object[0]}},{name:"TrackTarget",type:"string",isHidden:()=>!0,get(t){t.str[0]=this.target},set(t){this.target=t.str[0]}}]},{ctor:pu,name:"NodeEulerRotationTrack",getProps:()=>[{name:"TrackName",type:"string",options:{label:"Name"},get(t){t.str[0]=this.name},set(t){this.name=t.str[0]}},{name:"Interpolator",type:"object",options:{objectTypes:[ot]},isHidden:()=>!0,get(t){t.object[0]=this.interpolator},set(t){this.interpolator=t.object[0]}},{name:"TrackTarget",type:"string",isHidden:()=>!0,get(t){t.str[0]=this.target},set(t){this.target=t.str[0]}}]},{ctor:Fg,name:"MorphTargetTrack",getProps:()=>[{name:"TrackName",type:"string",options:{label:"Name"},get(t){t.str[0]=this.name},set(t){this.name=t.str[0]}},{name:"Interpolator",type:"object",options:{objectTypes:[ot]},isHidden:()=>!0,get(t){t.object[0]=this.interpolator},set(t){this.interpolator=t.object[0]}},{name:"DefaultWeights",type:"object",get(t){t.object[0]=this.defaultWeights??null},set(t){this.defaultWeights=t.object[0]??null}},{name:"OriginBoundingBox",type:"object",get(t){if(this.originBoundingBox){const e=[...this.originBoundingBox.minPoint,...this.originBoundingBox.maxPoint];t.object[0]=e}else t.object[0]=null},set(t){if(t.object[0]){const e=new q,i=t.object[0];e.minPoint.setXYZ(i[0],i[1],i[2]),e.maxPoint.setXYZ(i[3],i[4],i[5]),this.originBoundingBox=e}else this.originBoundingBox=null}},{name:"BoundingBox",type:"object",get(t){if(this.boundingBox){const e=[];for(const t of this.boundingBox)e.push(...t.minPoint),e.push(...t.maxPoint);t.object[0]=e}else t.object[0]=null},set(t){if(t.object[0]){const e=[],i=t.object[0];for(let t=0;t<i.length/6;t++)e.push(new hu(new z(i[6*t+0],i[6*t+1],i[6*t+2]),new z(i[6*t+3],i[6*t+4],i[6*t+5])));this.boundingBox=e}else this.boundingBox=null}},{name:"TrackTarget",type:"string",isHidden:()=>!0,get(t){t.str[0]=this.target},set(t){this.target=t.str[0]}}]},hg(this),{ctor:Nf,parent:Au,name:"GraphNode",createFunc(t){const e=new Nf(t.scene);return e.parent=t,{obj:e}},getProps:()=>[]},{ctor:__,name:"Mesh",parent:Nf,noTitle:!0,createFunc(t){const e=new __(t.scene);return e.parent=t,{obj:e}},getProps:()=>[{name:"CastShadow",type:"bool",default:!1,get(t){t.bool[0]=this.castShadow},set(t){this.castShadow=t.bool[0]}},{name:"SkinnedBoundingInfo",type:"string",isHidden:()=>!0,get(t){if(this.skinnedBoundingInfo){const e=new Float32Array(66);e.set(this.skinnedBoundingInfo.boundingVertexBlendIndices,0),e.set(this.skinnedBoundingInfo.boundingVertexJointWeights,24);for(let t=0;t<6;t++)e.set(this.skinnedBoundingInfo.boundingVertices[t],48+3*t);t.str[0]=i(new Uint8Array(e.buffer))}else t.str[0]=""},set(t){if(t.str[0]){const e=new Float32Array(s(t.str[0]).buffer),i=e.subarray(0,24),r=e.subarray(24,48),a=[];for(let t=0;t<6;t++)a.push(new z(e.subarray(48+3*t,48+3*(t+1))));this.setSkinnedBoundingInfo({boundingVertexBlendIndices:i,boundingVertexJointWeights:r,boundingVertices:a,boundingBox:new hu})}else this.setSkinnedBoundingInfo(null)}},{name:"Skeleton",type:"string",isHidden:()=>!1,get(t){t.str[0]=this.skeletonName},set(t){this.skeletonName=t.str[0]}},{name:"MorphData",type:"string",isHidden:()=>!0,async get(t){const e=this.getMorphData();if(e){const s=new ArrayBuffer(8+16*e.width*e.height),r=new DataView(s);r.setUint32(0,e.width,!0),r.setUint32(4,e.height,!0),new Float32Array(s,8,4*e.width*e.height).set(e.data),t.str[0]=i(new Uint8Array(s))}else t.str[0]=""},set(t){if(t.str[0]){const e=s(t.str[0]),i=new DataView(e.buffer),r=i.getUint32(0,!0),a=i.getUint32(4,!0),n=new Float32Array(e.buffer,8,4*r*a);this.setMorphData({width:r,height:a,data:n})}else this.setMorphData(null)}},{name:"MorphInfo",type:"string",isHidden:()=>!0,async get(t){const e=this.getMorphInfo();if(e){const s=new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.byteLength);t.str[0]=i(s)}else t.str[0]=""},set(t){if(t.str[0]){const e=s(t.str[0]);this.setMorphInfo({data:e})}else this.setMorphInfo(null)}},{name:"MorphBoundingBox",type:"string",isHidden:()=>!0,get(t){if(t.str[0]="",this.getMorphData()){const e=this.getAnimatedBoundingBox();if(e){const s=new Float32Array([...e.minPoint,...e.maxPoint]);t.str[0]=i(new Uint8Array(s.buffer))}}},set(t){if(t.str[0]){const e=new Float32Array(s(t.str[0]).buffer),i=new hu;i.minPoint.setXYZ(e[0],e[1],e[2]),i.maxPoint.setXYZ(e[3],e[4],e[5]),this.setAnimatedBoundingBox(i)}else this.setAnimatedBoundingBox(null)}},{name:"Primitive",type:"object",options:{mimeTypes:["application/vnd.zephyr3d.mesh+json"]},get(t){t.str[0]=this.primitive?wl().resourceManager.getAssetId(this.primitive):""},async set(t){if(t?.str[0]){const e=await wl().resourceManager.fetchPrimitive(t.str[0]);e?this.primitive=e:console.error(`Primitive not found: ${t.str[0]}`)}}},{name:"Material",type:"object",options:{mimeTypes:["application/vnd.zephyr3d.material+json"]},get(t){const e=this.material?.coreMaterial;t.str[0]=wl().resourceManager.getAssetId(e)??""},async set(t){if(t?.str[0]){const e=await wl().resourceManager.fetchMaterial(t.str[0]);e?this.material=e:console.error(`Material not found: ${t.str[0]}`)}}},{name:"MaterialObject",type:"object",isPersistent:()=>!1,options:{objectTypes:[ed]},get(t){t.object[0]=this.material??null}},{name:"Geometry Instance",type:"bool",get(t){t.bool[0]=!!this.material?.$isInstance},set(t){this.material=t.bool[0]?this.material?.createInstance():this.material?.coreMaterial}},{name:"MaterialInstanceUniforms",type:"object",phase:1,options:{objectTypes:[]},isHidden(){return this.material&&!this.material?.$isInstance},isNullable:()=>!0,get(t){const e=this.material?.$isInstance?Z_.get(this.material.coreMaterial.constructor):null;t.object[0]=e?new e.C(this.material):null},set(t){t.object[0]&&(this.material=t.object[0]?.material)}}]},Ig(this),yg(this),{ctor:Bg,name:"FFTWaveGenerator",getProps:()=>[{name:"Alignment",type:"float",options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.alignment},set(t){this.alignment=t.num[0]}},{name:"Wind",type:"vec2",options:{animatable:!0},get(t){t.num[0]=this.wind.x,t.num[1]=this.wind.y},set(t){this.wind=new L(t.num[0],t.num[1])}},{name:"FoamWidth",type:"float",default:1.2,options:{animatable:!0,minValue:0,maxValue:10},get(t){t.num[0]=this.foamWidth},set(t){this.foamWidth=t.num[0]}},{name:"FoamContrast",type:"float",default:7.2,options:{animatable:!0,minValue:0,maxValue:10},get(t){t.num[0]=this.foamContrast},set(t){this.foamContrast=t.num[0]}},{name:"WaveLengthCascades",type:"vec3",default:[400,100,15],options:{animatable:!0,minValue:0,maxValue:1e3},get(t){t.num[0]=this.getWaveLength(0),t.num[1]=this.getWaveLength(1),t.num[2]=this.getWaveLength(2)},set(t){this.setWaveLength(0,t.num[0]),this.setWaveLength(1,t.num[1]),this.setWaveLength(2,t.num[2])}},{name:"WaveStrengthCascades",type:"vec3",default:[.4,.4,.2],options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.getWaveStrength(0),t.num[1]=this.getWaveStrength(1),t.num[2]=this.getWaveStrength(2)},set(t){this.setWaveStrength(0,t.num[0]),this.setWaveStrength(1,t.num[1]),this.setWaveStrength(2,t.num[2])}},{name:"WaveCroppinessCascades",type:"vec3",default:[-1.5,-1.2,-.5],options:{animatable:!0,minValue:-4,maxValue:0},get(t){t.num[0]=this.getWaveCroppiness(0),t.num[1]=this.getWaveCroppiness(1),t.num[2]=this.getWaveCroppiness(2)},set(t){this.setWaveCroppiness(0,t.num[0]),this.setWaveCroppiness(1,t.num[1]),this.setWaveCroppiness(2,t.num[2])}}]},{ctor:g_,name:"FBMWaveGenerator",getProps:()=>[{name:"NumOctaves",type:"int",options:{minValue:1,maxValue:8},default:4,get(t){t.num[0]=this.numOctaves},set(t){this.numOctaves=t.num[0]}},{name:"Wind",type:"vec2",default:[.1,0],options:{animatable:!0},get(t){t.num[0]=this.wind.x,t.num[1]=this.wind.y},set(t){this.wind=new L(t.num[0],t.num[1])}},{name:"Amplitude",type:"float",options:{animatable:!0,minValue:0,maxValue:5},default:.3,get(t){t.num[0]=this.amplitude},set(t){this.amplitude=t.num[0]}},{name:"Frequency",type:"float",options:{animatable:!0,minValue:0,maxValue:16},default:3,get(t){t.num[0]=this.frequency},set(t){this.frequency=t.num[0]}}]},{ctor:T_,name:"ParticleSystem",parent:Nf,createFunc(t){const e=new T_(t.scene);return e.parent=t,{obj:e}},getProps:()=>[{name:"WorldSpace",type:"bool",default:!0,get(t){t.bool[0]=this.worldSpace},set(t){this.worldSpace=t.bool[0]}},{name:"MaxParticleCount",type:"int",default:100,get(t){t.num[0]=this.maxParticleCount},set(t){this.maxParticleCount=t.num[0]}},{name:"EmitInterval",type:"int",default:100,get(t){t.num[0]=this.emitInterval},set(t){this.emitInterval=t.num[0]}},{name:"EmitCount",type:"int",default:1,get(t){t.num[0]=this.emitCount},set(t){this.emitCount=t.num[0]}},{name:"Gravity",type:"vec3",default:[0,0,0],options:{animatable:!0},get(t){const e=this.gravity;t.num[0]=e.x,t.num[1]=e.y,t.num[2]=e.z},set(t){this.gravity.setXYZ(t.num[0],t.num[1],t.num[2])}},{name:"Wind",type:"vec3",default:[0,0,0],options:{animatable:!0},get(t){const e=this.wind;t.num[0]=e.x,t.num[1]=e.y,t.num[2]=e.z},set(t){this.wind.setXYZ(t.num[0],t.num[1],t.num[2])}},{name:"Scalar",type:"float",default:1,options:{animatable:!0},get(t){t.num[0]=this.scalar},set(t){this.scalar=t.num[0]}},{name:"Aspect",type:"float",default:1,options:{animatable:!0},get(t){t.num[0]=this.aspect},set(t){this.aspect=t.num[0]}},{name:"AirResistence",type:"bool",default:!1,get(t){t.bool[0]=this.airResistence},set(t){this.airResistence=t.bool[0]}},{name:"JitterSpeed",type:"float",default:1,options:{animatable:!0},get(t){t.num[0]=this.jitterSpeed},set(t){this.jitterSpeed=t.num[0]}},{name:"JitterPower",type:"float",default:0,options:{animatable:!0},get(t){t.num[0]=this.jitterPower},set(t){this.jitterPower=t.num[0]}},{name:"EmitterShape",type:"string",options:{enum:{labels:["Point","Sphere","Box","Cylinder","Cone"],values:["point","sphere","box","cylinder","cone"]}},default:"point",get(t){t.str[0]=this.emitterShape},set(t){this.emitterShape=t.str[0]}},{name:"EmitterBehavior",type:"string",options:{enum:{labels:["Surface","Volume"],values:["surface","volume"]}},default:"surface",get(t){t.str[0]=this.emitterBehavior},set(t){this.emitterBehavior=t.str[0]}},{name:"Directional",type:"bool",default:!1,get(t){t.bool[0]=this.directional},set(t){this.directional=t.bool[0]}},{name:"Rotation",type:"vec2",default:[0,0],options:{animatable:!0},get(t){t.num[0]=this.particleRotationMin,t.num[1]=this.particleRotationMax},set(t){this.particleRotationMin=t.num[0],this.particleRotationMax=t.num[1]}},{name:"ConeRadius",type:"vec2",default:[0,.1],options:{animatable:!0},get(t){t.num[0]=this.emitterConeRadiusMin,t.num[1]=this.emitterConeRadiusMax},set(t){this.emitterConeRadiusMin=t.num[0],this.emitterConeRadiusMax=t.num[1]}},{name:"Velocity",type:"vec2",default:[2,3],options:{animatable:!0},get(t){t.num[0]=this.particleVelocityMin,t.num[1]=this.particleVelocityMax},set(t){this.particleVelocityMin=t.num[0],this.particleVelocityMax=t.num[1]}},{name:"Life",type:"vec2",default:[1,1.5],options:{animatable:!0},get(t){t.num[0]=this.particleLifeMin,t.num[1]=this.particleLifeMax},set(t){this.particleLifeMin=t.num[0],this.particleLifeMax=t.num[1]}},{name:"Size1",type:"vec2",default:[.4,.5],options:{animatable:!0},get(t){t.num[0]=this.particleSize1Min,t.num[1]=this.particleSize1Max},set(t){this.particleSize1Min=t.num[0],this.particleSize1Max=t.num[1]}},{name:"Size2",type:"vec2",default:[0,.1],options:{animatable:!0},get(t){t.num[0]=this.particleSize2Min,t.num[1]=this.particleSize2Max},set(t){this.particleSize2Min=t.num[0],this.particleSize2Max=t.num[1]}},{name:"Acceleration",type:"vec2",default:[-.01,-.02],options:{animatable:!0},get(t){t.num[0]=this.particleAccelMin,t.num[1]=this.particleAccelMax},set(t){this.particleAccelMin=t.num[0],this.particleAccelMax=t.num[1]}},{name:"Material",type:"object",default:null,options:{objectTypes:[ud]},get(t){t.object[0]=this.getMaterial()},set(t){t.object[0]?t.object[0]instanceof ud?this.material=t.object[0]:console.error("Invalid material type"):this.material=null}}]},{ctor:U_,parent:Au,name:"PunctualLight",getProps:()=>[{name:"Color",type:"rgb",default:[1,1,1],options:{animatable:!0},get(t){t.num[0]=this.color.x,t.num[1]=this.color.y,t.num[2]=this.color.z},set(t){this.color=new O(t.num[0],t.num[1],t.num[2],1)}},{name:"Intensity",type:"float",default:1,options:{animatable:!0,minValue:0,maxValue:100},get(t){t.num[0]=this.intensity},set(t){this.intensity=t.num[0]}},{name:"CastShadow",type:"bool",phase:0,default:!1,get(t){t.bool[0]=this.castShadow},set(t){this.castShadow=t.bool[0]}},{name:"ShadowType",type:"string",phase:1,default:"hard",options:{enum:{labels:["Hard","PCF","PCF-PD","VSM","ESM"],values:["hard","pcf-opt","pcf-pd","vsm","esm"]}},get(t){t.str[0]=this.shadow.mode},set(t){this.shadow.mode=t.str[0]},isValid(){return!!this.castShadow}},{name:"ShadowDistance",type:"float",phase:1,default:2e3,options:{minValue:0,maxValue:5e3},get(t){t.num[0]=this.shadow.shadowDistance},set(t){this.shadow.shadowDistance=t.num[0]},isValid(){return!!this.castShadow}},{name:"ShadowMapSize",phase:1,type:"int",default:1024,options:{enum:{labels:["128x128","256x256","512x512","1024x1024","2048x2048","4096x4096"],values:[128,256,512,1024,2048,4096]}},get(t){t.num[0]=this.shadow.shadowMapSize},set(t){this.shadow.shadowMapSize=t.num[0]},isValid(){return!!this.castShadow}},{name:"ShadowRegion",phase:1,type:"object",default:null,options:{edit:"aabb",objectTypes:[q]},isNullable:()=>!0,create(){const t=new q;return t.beginExtend(),this.scene.rootNode.iterate(e=>{if((e instanceof __||e instanceof Y_||e instanceof z_)&&e.castShadow){const i=e.getWorldBoundingVolume().toAABB();t.extend(i.minPoint),t.extend(i.maxPoint)}}),t.isValid()||(t.minPoint.setXYZ(-1,-1,-1),t.maxPoint.setXYZ(1,1,1)),t},get(t){t.object[0]=this.shadow.shadowRegion},set(t){this.shadow.shadowRegion=t.object[0]},isValid(){return!!this.castShadow&&this.isDirectionLight()}},{name:"ShadowDepthBias",type:"float",phase:1,default:.5,options:{minValue:0,maxValue:5},get(t){t.num[0]=this.shadow.depthBias},set(t){this.shadow.depthBias=t.num[0]},isValid(){return!!this.castShadow}},{name:"ShadowNormalBias",type:"float",phase:1,default:.2,options:{minValue:0,maxValue:5},get(t){t.num[0]=this.shadow.normalBias},set(t){this.shadow.normalBias=t.num[0]},isValid(){return!!this.castShadow}},{name:"ShadowCascades",type:"int",phase:1,default:1,options:{minValue:1,maxValue:4},get(t){t.num[0]=this.shadow.numShadowCascades},set(t){this.shadow.numShadowCascades=t.num[0]},isValid(){return!!this.castShadow}},{name:"PCFKernelSize",phase:2,type:"int",default:5,options:{enum:{labels:["3x3","5x5","7x7"],values:[3,5,7]}},get(t){t.num[0]=this.shadow.pcfKernelSize},set(t){this.shadow.pcfKernelSize=t.num[0]},isValid(){return!!this.castShadow&&"pcf-opt"===this.shadow.mode}},{name:"PCFSampleCount",type:"int",phase:2,options:{minValue:1,maxValue:128},default:12,get(t){t.num[0]=this.shadow.pdSampleCount},set(t){this.shadow.pdSampleCount=t.num[0]},isValid(){return!!this.castShadow&&"pcf-pd"===this.shadow.mode}},{name:"PCFSampleRadius",type:"float",phase:2,options:{minValue:0,maxValue:64},default:4,get(t){t.num[0]=this.shadow.pdSampleRadius},set(t){this.shadow.pdSampleRadius=t.num[0]},isValid(){return!!this.castShadow&&"pcf-pd"===this.shadow.mode}},{name:"VSMBlurKernelSize",type:"int",phase:2,options:{minValue:1,maxValue:33},default:5,get(t){t.num[0]=this.shadow.vsmBlurKernelSize},set(t){this.shadow.vsmBlurKernelSize=t.num[0]},isValid(){return!!this.castShadow&&"vsm"===this.shadow.mode}},{name:"VSMBlurRadius",type:"float",phase:2,options:{minValue:0,maxValue:32},default:4,get(t){t.num[0]=this.shadow.vsmBlurRadius},set(t){this.shadow.vsmBlurRadius=t.num[0]},isValid(){return!!this.castShadow&&"vsm"===this.shadow.mode}},{name:"VSMDarkness",type:"float",phase:2,options:{minValue:0,maxValue:1},default:.5,get(t){t.num[0]=this.shadow.vsmDarkness},set(t){this.shadow.vsmDarkness=t.num[0]},isValid(){return!!this.castShadow&&"vsm"===this.shadow.mode}},{name:"ESMDepthScale",type:"float",phase:2,options:{minValue:1,maxValue:2e3},default:200,get(t){t.num[0]=this.shadow.esmDepthScale},set(t){this.shadow.esmDepthScale=t.num[0]},isValid(){return!!this.castShadow&&"esm"===this.shadow.mode}},{name:"ESMBlur",type:"bool",phase:2,default:!0,get(t){t.bool[0]=this.shadow.esmBlur},set(t){this.shadow.esmBlur=t.bool[0]},isValid(){return!!this.castShadow&&"esm"===this.shadow.mode}},{name:"ESMBlurKernelSize",type:"int",phase:2,default:5,options:{minValue:1,maxValue:33},get(t){t.num[0]=this.shadow.esmBlurKernelSize},set(t){this.shadow.esmBlurKernelSize=t.num[0]},isValid(){return!!this.castShadow&&"esm"===this.shadow.mode&&this.shadow.esmBlur}},{name:"ESMBlurRadius",type:"float",phase:2,default:4,options:{minValue:0,maxValue:32},get(t){t.num[0]=this.shadow.esmBlurRadius},set(t){this.shadow.esmBlurRadius=t.num[0]},isValid(){return!!this.castShadow&&"esm"===this.shadow.mode&&this.shadow.esmBlur}}]},{ctor:G_,name:"DirectionalLight",parent:U_,createFunc(t){const e=new G_(t.scene);return e.parent=t,{obj:e}},getProps:()=>[{name:"SunLight",type:"bool",default:!1,get(t){t.bool[0]=this.sunLight},set(t){this.sunLight=t.bool[0]}}]},{ctor:W_,name:"SpotLight",parent:U_,createFunc(t){const e=new W_(t.scene);return e.parent=t,{obj:e}},getProps:()=>[{name:"Range",type:"float",default:10,options:{animatable:!0,minValue:0,maxValue:1e3},get(t){t.num[0]=this.range},set(t){this.range=t.num[0]}},{name:"BeamAngle",type:"float",default:90,options:{animatable:!0,minValue:0,maxValue:180},get(t){t.num[0]=A(2*Math.acos(this.cutoff))},set(t){this.cutoff=Math.cos(.5*S(t.num[0]))}}]},{ctor:H_,name:"PointLight",parent:U_,createFunc(t){const e=new H_(t.scene);return e.parent=t,{obj:e}},getProps:()=>[{name:"Range",type:"float",default:10,options:{animatable:!0,minValue:0,maxValue:1e3},get(t){t.num[0]=this.range},set(t){this.range=t.num[0]}}]},{ctor:df,name:"Camera",parent:Au,createFunc(t){const e=new df(t.scene);return e.parent=t,{obj:e}},getProps:()=>[{name:"HDR",type:"bool",default:!1,get(t){t.bool[0]=this.HDR},set(t){this.HDR=t.bool[0]}},{name:"HiZ",type:"bool",default:!1,get(t){t.bool[0]=this.HiZ},set(t){this.HiZ=t.bool[0]}},{name:"ToneMapEnabled",type:"bool",phase:0,default:!0,options:{label:"Enabled",group:"PostProcessing/ToneMap"},get(t){t.bool[0]=this.toneMap},set(t){this.toneMap=t.bool[0]}},{name:"ToneMapExposure",type:"float",options:{minValue:0,maxValue:8,label:"Exposure",group:"PostProcessing/ToneMap"},phase:0,default:1,get(t){t.num[0]=this.toneMapExposure},set(t){this.toneMapExposure=t.num[0]}},{name:"BloomEnabled",type:"bool",phase:0,default:!0,options:{label:"Enabled",group:"PostProcessing/Bloom"},get(t){t.bool[0]=this.bloom},set(t){this.bloom=t.bool[0]}},{name:"BloomMaxDownsampleLevels",type:"int",options:{minValue:0,maxValue:8,label:"MaxDownsampleLevels",group:"PostProcessing/Bloom"},phase:0,default:4,get(t){t.num[0]=this.bloomMaxDownsampleLevels},set(t){this.bloomMaxDownsampleLevels=t.num[0]}},{name:"BloomDownsampleLimit",type:"int",options:{minValue:2,maxValue:64,label:"DownsampleLimit",group:"PostProcessing/Bloom"},phase:0,default:32,get(t){t.num[0]=this.bloomDownsampleLimit},set(t){this.bloomDownsampleLimit=t.num[0]}},{name:"BloomThreshold",type:"float",options:{animatable:!0,minValue:0,maxValue:1,label:"Threshold",group:"PostProcessing/Bloom"},phase:0,default:.8,get(t){t.num[0]=this.bloomThreshold},set(t){this.bloomThreshold=t.num[0]}},{name:"BloomThresholdKnee",type:"float",options:{animatable:!0,minValue:0,maxValue:1,label:"ThresholdKnee",group:"PostProcessing/Bloom"},phase:0,default:0,get(t){t.num[0]=this.bloomThresholdKnee},set(t){this.bloomThresholdKnee=t.num[0]}},{name:"BloomIntensity",type:"float",options:{animatable:!0,minValue:0,maxValue:8,label:"Intensity",group:"PostProcessing/Bloom"},phase:0,default:1,get(t){t.num[0]=this.bloomIntensity},set(t){this.bloomIntensity=t.num[0]}},{name:"FXAAEnabled",type:"bool",phase:0,default:!0,options:{label:"Enabled",group:"PostProcessing/FXAA"},get(t){t.bool[0]=this.FXAA},set(t){this.FXAA=t.bool[0]}},{name:"TAAEnabled",type:"bool",phase:0,default:!1,options:{label:"Enabled",group:"PostProcessing/TAA"},get(t){t.bool[0]=this.TAA},set(t){this.TAA=t.bool[0]}},{name:"TAADebug",type:"int",phase:1,options:{label:"Debug",group:"PostProcessing/TAA",enum:{labels:["None","Current Color","History Color","Velocity","Edge","Alpha","Motion Vector","Strength"],values:[0,1,2,3,4,5,6,7]}},default:0,get(t){t.num[0]=this.TAADebug},set(t){this.TAADebug=t.num[0]},isValid(){return!!this.TAA}},{name:"MotionBlurEnabled",type:"bool",phase:0,default:!1,options:{label:"Enabled",group:"PostProcessing/MotionBlur"},get(t){t.bool[0]=this.motionBlur},set(t){this.motionBlur=t.bool[0]}},{name:"MotionBlurStrength",type:"float",phase:1,default:1,options:{label:"Strength",group:"PostProcessing/MotionBlur",animatable:!0,minValue:0,maxValue:10},get(t){t.num[0]=this.motionBlurStrength},set(t){this.motionBlurStrength=t.num[0]},isValid(){return this.motionBlur}},{name:"SSREnabled",type:"bool",phase:0,default:!1,options:{label:"Enabled",group:"PostProcessing/SSR"},get(t){t.bool[0]=this.SSR},set(t){this.SSR=t.bool[0]}},{name:"SSRMaxRoughness",type:"float",phase:1,default:.8,options:{label:"RoughnessThreshold",group:"PostProcessing/SSR",minValue:0,maxValue:1},get(t){t.num[0]=this.ssrMaxRoughness},set(t){this.ssrMaxRoughness=t.num[0]},isValid(){return this.SSR}},{name:"SSRRoughnessFactor",type:"float",phase:1,default:1,options:{label:"RoughnessFactor",group:"PostProcessing/SSR",minValue:0,maxValue:1},get(t){t.num[0]=this.ssrRoughnessFactor},set(t){this.ssrRoughnessFactor=t.num[0]},isValid(){return this.SSR}},{name:"SSRStride",type:"int",phase:1,default:2,options:{label:"Stride",group:"PostProcessing/SSR",minValue:1,maxValue:32},get(t){t.num[0]=this.ssrStride},set(t){this.ssrStride=t.num[0]},isValid(){return this.SSR&&!this.HiZ}},{name:"SSRMaxDistance",type:"float",phase:1,default:100,options:{label:"MaxDistance",group:"PostProcessing/SSR",minValue:0,maxValue:9999},get(t){t.num[0]=this.ssrMaxDistance},set(t){this.ssrMaxDistance=t.num[0]},isValid(){return this.SSR}},{name:"SSRMaxSteps",type:"int",phase:1,default:120,options:{label:"MaxSteps",group:"PostProcessing/SSR",minValue:1,maxValue:2e3},get(t){t.num[0]=this.ssrIterations},set(t){this.ssrIterations=t.num[0]},isValid(){return this.SSR}},{name:"SSRThickness",type:"float",phase:1,default:.5,options:{label:"Thickness",group:"PostProcessing/SSR",minValue:0,maxValue:8},get(t){t.num[0]=this.ssrThickness},set(t){this.ssrThickness=t.num[0]},isValid(){return this.SSR}},{name:"SSRBlurScale",phase:1,type:"float",default:.01,options:{label:"BlurScale",group:"PostProcessing/SSR",minValue:0,maxValue:1},get(t){t.num[0]=this.ssrBlurScale},set(t){this.ssrBlurScale=t.num[0]},isValid(){return this.SSR}},{name:"SSRBlurDepthCutoff",phase:1,type:"float",default:2,options:{label:"BlurDepthCutoff",group:"PostProcessing/SSR",minValue:0,maxValue:8},get(t){t.num[0]=this.ssrBlurDepthCutoff},set(t){this.ssrBlurDepthCutoff=t.num[0]},isValid(){return this.SSR}},{name:"SSRBlurKernelSize",type:"int",phase:1,default:10,options:{label:"BlurKernelSize",group:"PostProcessing/SSR",minValue:1,maxValue:65},get(t){t.num[0]=this.ssrBlurKernelSize},set(t){this.ssrBlurKernelSize=t.num[0]},isValid(){return this.SSR}},{name:"SSRBlurStdDev",type:"float",phase:1,default:10,options:{label:"BlurStdDev",group:"PostProcessing/SSR",minValue:0,maxValue:100},get(t){t.num[0]=this.ssrBlurStdDev},set(t){this.ssrBlurStdDev=t.num[0]},isValid(){return this.SSR}},{name:"SSRCalcThickness",type:"bool",phase:1,default:!1,options:{label:"CalcThickness",group:"PostProcessing/SSR"},get(t){t.bool[0]=this.ssrCalcThickness},set(t){this.ssrCalcThickness=t.bool[0]},isValid(){return this.SSR}},{name:"SSAOEnabled",type:"bool",phase:0,default:!1,options:{label:"Enabled",group:"PostProcessing/SSAO"},get(t){t.bool[0]=this.SSAO},set(t){this.SSAO=t.bool[0]}},{name:"SSAOScale",type:"float",phase:0,default:10,options:{label:"Scale",group:"PostProcessing/SSAO"},get(t){t.num[0]=this.SSAOScale},set(t){this.SSAOScale=t.num[0]}},{name:"SSAOBias",type:"float",phase:0,default:1,options:{label:"Bias",group:"PostProcessing/SSAO"},get(t){t.num[0]=this.SSAOBias},set(t){this.SSAOBias=t.num[0]}},{name:"SSAORadius",type:"float",phase:0,default:100,options:{label:"Radius",group:"PostProcessing/SSAO"},get(t){t.num[0]=this.SSAORadius},set(t){this.SSAORadius=t.num[0]}},{name:"SSAOIntensity",type:"float",phase:0,default:2.5,options:{label:"Intensity",group:"PostProcessing/SSAO"},get(t){t.num[0]=100*this.SSAOIntensity},set(t){this.SSAOIntensity=.01*t.num[0]}}]},{ctor:O_,parent:df,name:"PerspectiveCamera",createFunc(t){const e=new O_(t.scene);return e.parent=t,{obj:e}},getProps:()=>[{name:"FovVertical",type:"float",default:Math.PI/3,options:{minValue:0,maxValue:Math.PI},get(t){t.num[0]=this.fovY},set(t){this.fovY=t.num[0]}},{name:"Near",type:"float",default:1,get(t){t.num[0]=this.near},set(t){this.near=t.num[0]}},{name:"Far",type:"float",default:1e3,get(t){t.num[0]=this.far},set(t){this.far=t.num[0]}},{name:"AutoAspect",type:"bool",default:!0,get(t){t.bool[0]=this.autoAspect},set(t){this.autoAspect=t.bool[0]}}]},{ctor:V_,parent:df,name:"OrthoCamera",createFunc(t){const e=new V_(t.scene);return e.parent=t,{obj:e}},getProps:()=>[{name:"Left",type:"float",default:-1,get(t){t.num[0]=this.left},set(t){this.left=t.num[0]}},{name:"Right",type:"float",default:1,get(t){t.num[0]=this.right},set(t){this.right=t.num[0]}},{name:"Bottom",type:"float",default:-1,get(t){t.num[0]=this.bottom},set(t){this.bottom=t.num[0]}},{name:"Top",type:"float",default:1,get(t){t.num[0]=this.top},set(t){this.top=t.num[0]}},{name:"Near",type:"float",default:-1,get(t){t.num[0]=this.near},set(t){this.near=t.num[0]}},{name:"Far",type:"float",default:1,get(t){t.num[0]=this.far},set(t){this.far=t.num[0]}}]},{ctor:S_,parent:Nf,name:"BatchGroup",createFunc(t){const e=new S_(t.scene);return e.parent=t,{obj:e}},getProps:()=>[]},bg(this),{ctor:ed,name:"MeshMaterial",getProps:()=>[{name:"AlphaCutoff",type:"float",default:0,options:{animatable:!0,minValue:0,maxValue:1},get(t){t.num[0]=this.alphaCutoff},set(t){this.alphaCutoff=t.num[0]},isValid(){return!this.$isInstance}},{name:"AlphaToCoverage",type:"bool",default:!1,get(t){t.bool[0]=this.alphaToCoverage},set(t){this.alphaToCoverage=t.bool[0]},isValid(){return!this.$isInstance}},{name:"BlendMode",type:"string",options:{enum:{labels:["None","Blend","Additive"],values:["none","blend","additive"]}},default:"none",get(t){t.str[0]=this.blendMode},set(t){this.blendMode=t.str[0]},isValid(){return!this.$isInstance}},{name:"CullMode",type:"string",options:{enum:{labels:["None","Front","Back"],values:["none","front","back"]}},default:"back",get(t){t.str[0]=this.cullMode},set(t){this.cullMode=t.str[0]},isValid(){return!this.$isInstance}},{name:"Opacity",type:"float",options:{animatable:!0,minValue:0,maxValue:1},default:1,get(t){t.num[0]=this.opacity},set(t){this.opacity=t.num[0]},getDefaultValue(){return this.$isInstance?this.coreMaterial.opacity:1}},{name:"TAAStrength",type:"float",options:{minValue:0,maxValue:1},default:15/16,get(t){t.num[0]=this.TAAStrength},set(t){this.TAAStrength=t.num[0]},isValid(){return!this.$isInstance}}]},K_(ed),K_(Mm),...mg(this),...fg(this),..._g(this),...gg(this),...xg(this),...pg(this),{ctor:Um,parent:Cl,name:"BoxShape",getProps:()=>[{name:"Size",type:"vec3",default:[1,1,1],get(t){t.num[0]=this.options.sizeX??this.options.size,t.num[1]=this.options.sizeY??this.options.size,t.num[2]=this.options.sizeZ??this.options.size},set(t){this.options={...this.options,sizeX:t.num[0],sizeY:t.num[1],sizeZ:t.num[2]}}},{name:"Anchor",type:"vec3",default:[.5,.5,.5],get(t){t.num[0]=this.options.anchorX??this.options.anchor,t.num[1]=this.options.anchorY??this.options.anchor,t.num[2]=this.options.anchorZ??this.options.anchor},set(t){this.options={...this.options,anchorX:t.num[0],anchorY:t.num[1],anchorZ:t.num[2]}}}]},{ctor:Gm,parent:Cl,name:"BoxFrameShape",getProps:()=>[{name:"Size",type:"vec3",default:[1,1,1],get(t){t.num[0]=this.options.sizeX??this.options.size,t.num[1]=this.options.sizeY??this.options.size,t.num[2]=this.options.sizeZ??this.options.size},set(t){this.options={...this.options,sizeX:t.num[0],sizeY:t.num[1],sizeZ:t.num[2]}}},{name:"Anchor",type:"vec3",default:[.5,.5,.5],get(t){t.num[0]=this.options.anchorX??this.options.anchor,t.num[1]=this.options.anchorY??this.options.anchor,t.num[2]=this.options.anchorZ??this.options.anchor},set(t){this.options={...this.options,anchorX:t.num[0],anchorY:t.num[1],anchorZ:t.num[2]}}}]},{ctor:jm,parent:Cl,name:"SphereShape",getProps:()=>[{name:"Radius",type:"float",default:1,get(t){t.num[0]=this.options.radius},set(t){this.options={...this.options,radius:t.num[0]}}},{name:"VerticalDetail",type:"int",options:{minValue:2,maxValue:100},default:20,get(t){t.num[0]=this.options.verticalDetail},set(t){this.options={...this.options,verticalDetail:Math.max(2,Math.min(t.num[0],100))}}},{name:"HorizontalDetail",type:"int",options:{minValue:2,maxValue:100},default:20,get(t){t.num[0]=this.options.horizonalDetail},set(t){this.options={...this.options,horizonalDetail:Math.max(2,Math.min(t.num[0],100))}}}]},{ctor:Wm,parent:Cl,name:"TorusShape",getProps:()=>[{name:"NumSlices",type:"int",options:{minValue:3,maxValue:100},default:40,get(t){t.num[0]=this.options.numSlices},set(t){this.options={...this.options,numSlices:Math.max(3,Math.min(100,t.num[0]))}}},{name:"NumSegments",type:"int",options:{minValue:3,maxValue:100},default:16,get(t){t.num[0]=this.options.numSegments},set(t){this.options={...this.options,numSegments:Math.max(3,Math.min(100,t.num[0]))}}},{name:"OuterRadius",type:"float",options:{minValue:0,maxValue:9999},default:1,get(t){t.num[0]=this.options.outerRadius},set(t){this.options={...this.options,outerRadius:t.num[0]}}},{name:"InnerRadius",type:"float",options:{minValue:0,maxValue:9999},default:.3,get(t){t.num[0]=this.options.innerRadius},set(t){this.options={...this.options,innerRadius:t.num[0]}}},{name:"RadialDetail",type:"int",options:{minValue:3,maxValue:100},default:20,get(t){t.num[0]=this.options.radialDetail},set(t){this.options={...this.options,radialDetail:Math.max(3,Math.min(100,t.num[0]))}}}]},{ctor:Hm,parent:Cl,name:"CylinderShape",getProps:()=>[{name:"Height",type:"float",default:1,get(t){t.num[0]=this.options.height},set(t){this.options={...this.options,height:t.num[0]}}},{name:"BottomRadius",type:"float",default:1,options:{minValue:0,maxValue:9999},get(t){t.num[0]=this.options.bottomRadius},set(t){this.options={...this.options,bottomRadius:t.num[0]}}},{name:"TopRadius",type:"float",default:1,options:{minValue:0,maxValue:9999},get(t){t.num[0]=this.options.topRadius},set(t){this.options={...this.options,topRadius:t.num[0]}}},{name:"HeightDetail",type:"int",default:1,options:{minValue:1,maxValue:100},get(t){t.num[0]=this.options.heightDetail},set(t){this.options={...this.options,heightDetail:Math.max(1,Math.min(t.num[0],100))}}},{name:"RadialDetail",type:"int",default:20,options:{minValue:2,maxValue:100},get(t){t.num[0]=this.options.radialDetail},set(t){this.options={...this.options,radialDetail:Math.max(2,Math.min(t.num[0],100))}}},{name:"Anchor",type:"float",default:0,options:{minValue:0,maxValue:1},get(t){t.num[0]=this.options.anchor},set(t){this.options={...this.options,anchor:t.num[0]}}},{name:"TopCap",type:"bool",default:!0,get(t){t.bool[0]=this.options.topCap},set(t){this.options={...this.options,topCap:t.bool[0]}}},{name:"BottomCap",type:"bool",default:!0,get(t){t.bool[0]=this.options.bottomCap},set(t){this.options={...this.options,bottomCap:t.bool[0]}}}]},{ctor:Xm,parent:Cl,name:"PlaneShape",getProps:()=>[{name:"Size",type:"vec2",default:[1,1],get(t){t.num[0]=this.options.sizeX??this.options.size,t.num[1]=this.options.sizeY??this.options.size},set(t){this.options={...this.options,sizeX:t.num[0],sizeY:t.num[1]}}},{name:"Resolution",type:"int2",default:[1,1],get(t){t.num[0]=this.options.resolutionX??this.options.resolution,t.num[1]=this.options.resolutionY??this.options.resolution},set(t){this.options={...this.options,resolutionX:t.num[0],resolutionY:t.num[1]}}},{name:"Anchor",type:"vec2",default:[.5,.5],options:{minValue:0,maxValue:1},get(t){t.num[0]=this.options.anchorX??this.options.anchor,t.num[1]=this.options.anchorY??this.options.anchor},set(t){this.options={...this.options,anchorX:t.num[0],anchorY:t.num[1]}}},{name:"TwoSided",type:"bool",default:!1,get(t){t.bool[0]=this.options.twoSided},set(t){this.options={...this.options,twoSided:t.bool[0]}}}]},{ctor:Qm,parent:Cl,name:"TetrahedronShape",getProps:()=>[{name:"Height",type:"float",default:1,get(t){t.num[0]=this.options.height},set(t){this.options={...this.options,height:t.num[0]}}},{name:"SizeX",type:"float",get(t){t.num[0]=this.options.sizeX},set(t){this.options={...this.options,sizeX:t.num[0]}}},{name:"SizeZ",type:"float",get(t){t.num[0]=this.options.sizeZ},set(t){this.options={...this.options,sizeZ:t.num[0]}}}]},Ed.getSerializationCls(),Md.getSerializationCls(),Bd.getSerializationCls(),Id.getSerializationCls(),Rd.getSerializationCls(),Fd.getSerializationCls(),Dd.getSerializationCls(),Ld.getSerializationCls(),zd.getSerializationCls(),kd.getSerializationCls(),Ud.getSerializationCls(),Gd.getSerializationCls(),Hd.getSerializationCls(),Wd.getSerializationCls(),Xd.getSerializationCls(),jd.getSerializationCls(),Qd.getSerializationCls(),qd.getSerializationCls(),Yd.getSerializationCls(),Zd.getSerializationCls(),Kd.getSerializationCls(),Jd.getSerializationCls(),tp.getSerializationCls(),ep.getSerializationCls(),ip.getSerializationCls(),sp.getSerializationCls(),rp.getSerializationCls(),ap.getSerializationCls(),np.getSerializationCls(),op.getSerializationCls(),hp.getSerializationCls(),lp.getSerializationCls(),up.getSerializationCls(),cp.getSerializationCls(),dp.getSerializationCls(),pp.getSerializationCls(),mp.getSerializationCls(),fp.getSerializationCls(),_p.getSerializationCls(),gp.getSerializationCls(),xp.getSerializationCls(),bp.getSerializationCls(),vp.getSerializationCls(),yp.getSerializationCls(),Tp.getSerializationCls(),wp.getSerializationCls(),Sp.getSerializationCls(),Ap.getSerializationCls(),Cp.getSerializationCls(),Ep.getSerializationCls(),Mp.getSerializationCls(),Bp.getSerializationCls(),Vd.getSerializationCls(),Ip.getSerializationCls(),Pp.getSerializationCls(),$p.getSerializationCls(),Rp.getSerializationCls(),Fp.getSerializationCls(),Dp.getSerializationCls(),Np.getSerializationCls(),Vp.getSerializationCls(),Op.getSerializationCls(),kp.getSerializationCls(),Lp.getSerializationCls(),zp.getSerializationCls(),Up.getSerializationCls(),Gp.getSerializationCls(),Hp.getSerializationCls(),Wp.getSerializationCls(),Xp.getSerializationCls(),jp.getSerializationCls(),qp.getSerializationCls(),Qp.getSerializationCls(),Yp.getSerializationCls(),Zp.getSerializationCls(),Kp.getSerializationCls(),Jp.getSerializationCls(),em.getSerializationCls(),sm.getSerializationCls(),im.getSerializationCls(),tm.getSerializationCls(),mm.getSerializationCls(),fm.getSerializationCls(),rm.getSerializationCls(),nm.getSerializationCls(),am.getSerializationCls(),hm.getSerializationCls(),lm.getSerializationCls(),om.getSerializationCls(this),Nd.getSerializationCls()].map(t=>[t.ctor,t]));for(const t of this._classMap)this.registerProps(t[1])}get VFS(){return this._vfs}set VFS(t){this._vfs=t}get editorMode(){return this._editorMode}get assetManager(){return this._assetManager}getClasses(){return[...this._classMap.values()]}getClassByConstructor(t){return this._classMap.get(t)??null}getClassByObject(t){return this.getClassByConstructor(t.constructor)}getClassByName(t){for(const e of this._classMap)if(e[0].name===t)return e[1];return null}getClassByProperty(t){for(const e of this._clsPropMap)if(e[1].indexOf(t)>=0)return e[0];return null}getPropertiesByClass(t){return this._clsPropMap.get(t)??null}getPropertyByClass(t,e){return this.getPropertiesByClass(t)?.find(t=>t.name===e)??null}getPropertyByName(t){return this._propMap[t]??null}getPropertyName(t){return this._propNameMap.get(t)??null}registerClass(t){this._classMap.has(t.ctor)||(this._classMap.set(t.ctor,t),this.registerProps(t))}getAssetId(t){return this._allocated.get(t)??null}setAssetId(t,e){t&&(e?this._allocated.set(t,e):this._allocated.delete(t))}async fetchBinary(t){const e=await this._assetManager.fetchBinaryData(t);return e&&this._allocated.set(e,t),e}async serializeObject(t,e,i){if(null==t)return t;const s=this.getClasses(),r=s.findIndex(e=>e.ctor===t.constructor);if(r<0)throw new Error("Serialize object failed: Cannot found serialization meta data");let a=s[r];const n={saveProps:!0},o=await(a?.getInitParams?.(t,n));if((e=e??{}).ClassName=a.name,e.Object={},null!=o&&(e.Init=o),n.saveProps)for(;a;)await this.serializeObjectProps(t,a,e.Object,i),a=this.getClassByConstructor(a.parent);return e}async deserializeObject(t,e){const i=this.getClasses(),s=e.ClassName,r=i.findIndex(t=>t.name===s);if(r<0)throw new Error("Deserialize object failed: Cannot found serialization meta data");let a=i[r];const n=e.Init;let o;e=e.Object;let h=!0;if(a.createFunc){let e=a.createFunc(t,n);e instanceof Promise&&(e=await e),o=e.obj,h=e.loadProps??!0}else o=new a.ctor;if(!o)return null;const l=o instanceof Promise?await o:o;if(h)for(;a;)await this.deserializeObjectProps(l,a,e),a=this.getClassByConstructor(a.parent);return l}async fetchModel(t,e,i){const s=await this._assetManager.fetchModel(e,t,i);return s&&this._allocated.set(s.group,t),s}async loadTextureFromBuffer(t,e,i,s,r){return this._assetManager.loadTextureFromBuffer(t,e,i,s,r)}async fetchTexture(t,e){const i=await this._assetManager.fetchTexture(t,e);return i&&this._allocated.set(i,t),i}async fetchMaterial(t){const e=await this._assetManager.fetchMaterial(t);return e&&this._allocated.set(e,t),e}async reloadBluePrintMaterials(t){await this._assetManager.reloadBluePrintMaterials(t)}async fetchPrimitive(t){const e=await this._assetManager.fetchPrimitive(t);return e&&this._allocated.set(e,t),e}async loadPrefabContent(t){try{const e=await this._vfs.readFile(t,{encoding:"utf8"});return JSON.parse(e)}catch(e){return console.error(`Failed to load prefab from ${t}:`,e),null}}async instantiatePrefab(t,i){try{const s=await this.loadPrefabContent(i);e("SceneNode"===s?.type,"Invalid prefab format");const a=new wt(new Au(t.scene));a.get().remove(),a.get().prefabId=this._vfs.normalizePath(i);const n=await this.deserializeObject(a.get(),s.data);return n.prefabId=a.get().prefabId,n.parent=t,n.persistentId=r(),a.dispose(),n}catch(t){return console.error(`Failed to instantiate prefab from ${i}:`,t),null}}async loadScene(t){const e=await this._vfs.readFile(t,{encoding:"utf8"}),i=JSON.parse(e);return await this.deserializeObject(null,i)}async saveScene(t,e){const i=[],s=await this.serializeObject(t,null,i);await Promise.all(i),await this._vfs.writeFile(e,JSON.stringify(s,null,2),{encoding:"utf8",create:!0})}rebuildGraphStructure(t,e){const i={outgoing:{},incoming:{}};for(const e in t)i.outgoing[e]=[],i.incoming[e]=[];for(const t of e){const e={targetNodeId:t.endNodeId,startSlotId:t.startSlotId,endSlotId:t.endSlotId},s={targetNodeId:t.startNodeId,startSlotId:t.startSlotId,endSlotId:t.endSlotId};i.outgoing[t.startNodeId]?.push(e),i.incoming[t.endNodeId]?.push(s)}return i}collectReachableBackward(t,e,i){const s=new Set,r=[];for(const t of i)e[t]&&(s.add(t),r.push(t));for(;r.length>0;){const e=r.shift(),i=t.incoming[e]||[];for(const t of i){const e=t.targetNodeId;s.has(e)||(s.add(e),r.push(e))}}return s}getReverseTopologicalOrderFromRoots(t,e,i){if(!i||0===i.length)return{order:[],levels:[]};const s=this.collectReachableBackward(t,e,i);if(0===s.size)return{order:[],levels:[]};const r=new Map;for(const e of s){const i=(t.outgoing[e]||[]).filter(t=>s.has(t.targetNodeId));r.set(e,i.length)}let a=Array.from(r.entries()).filter(([,t])=>0===t).map(([t])=>t);const n=[],o=[];for(;a.length>0;){o.push([...a]),n.push(...a);const e=[];for(const i of a){const a=t.incoming[i]||[];for(const t of a){const i=t.targetNodeId;if(!s.has(i))continue;const a=r.get(i)-1;r.set(i,a),0===a&&e.push(i)}}a=e}return n.length!==s.size?(console.warn("Subgraph contains cycles (from given roots)."),null):{order:n,levels:o}}createBluePrintDAG(t,e,i){const s=this.rebuildGraphStructure(t,i);for(const e in s.incoming){const i=t[e];for(const r of s.incoming[e]){const e=i.inputs.find(t=>t.id===r.endSlotId);e.inputNode=t[r.targetNodeId],e.inputId=r.startSlotId}}return{graph:s,nodeMap:t,roots:e,order:this.getReverseTopologicalOrderFromRoots(s,t,e).order.reverse()}}async loadBluePrint(t){return this._assetManager.loadBluePrint(t)}clearCache(){this._allocated=new WeakMap,this._assetManager.clearCache()}static _pathPattern=/^([^\][]+)(?:\[(\d+)\])?$/;static parsePropertyPath(t){const e=t.match(this._pathPattern);return e?{original:e[0],prefix:e[1],index:e[2]||null,indexValue:e[2]?parseInt(e[2],10):null,hasIndex:!!e[2]}:null}findAnimationTarget(t,e){const i={object:[]},s=(e.target??"").split("/").filter(t=>!!t);let r=t;for(;s.length>0;){const t=s.shift(),e=hx.parsePropertyPath(t);if(!e)return null;const a=this.getClassByConstructor(r.constructor);if(!a)return null;const n=this.getPropertyByClass(a,e.prefix);if(!n)return null;if(e.hasIndex){if("object_array"!==n.type)return null;n.get.call(r,i),r=i.object?.[e.indexValue]??null}else{if("object"!==n.type)return null;n.get.call(r,i),r=i.object?.[0]??null}if(!r)return null}return r}registerProps(t){if(!this._clsPropMap.get(t)){const e=t.getProps()??[];this._clsPropMap.set(t,e);for(const i of e){const e=`/${t.name}/${i.name}`;if(this._propMap[e])throw new Error(`Cannot register property ${e}: property name already exists`);this._propMap[e]=i,this._propNameMap.set(i,e)}}}getDefaultValue(t,e){let i=e.getDefaultValue?.call(t)??e.default;return void 0===i&&(i=ox[e.type]),i}async deserializeObjectProps(t,e,i){const s=(this.getPropertiesByClass(e)??[]).sort((t,e)=>(t.phase??0)-(e.phase??0));let r;const a=[];for(const e of s){const s=e.phase??0;if(s!==r&&(r=s,a.length>0&&await Promise.all(a)),"command"===e.type)continue;if(!e.set)continue;if(e.isValid&&!e.isValid.call(t))continue;if(!(e.isPersistent?.call(t)??!0))continue;const n=i[e.name]??this.getDefaultValue(t,e),o={num:[0,0,0,0],str:[""],bool:[!1],object:[null]};switch(e.type){case"object":"string"==typeof n&&n?o.str[0]=n:o.object[0]=n?Array.isArray(n)?n:await this.deserializeObject(t,n)??null:null;break;case"object_array":if(o.object=[],Array.isArray(n))for(const e of n)"string"==typeof e&&e?o.str[0]=e:o.object.push(e?await this.deserializeObject(t,e)??null:null);break;case"embedded":"string"==typeof n&&n&&(o.str[0]=n);break;case"float":case"int":o.num[0]=n;break;case"string":o.str[0]=n;break;case"bool":o.bool[0]=n;break;case"vec2":case"int2":o.num[0]=n[0],o.num[1]=n[1];break;case"vec3":case"int3":case"rgb":o.num[0]=n[0],o.num[1]=n[1],o.num[2]=n[2];break;case"vec4":case"int4":case"rgba":o.num[0]=n[0],o.num[1]=n[1],o.num[2]=n[2],o.num[3]=n[3]}a.push(Promise.resolve(e.set.call(t,o,-1)))}a.length>0&&await Promise.all(a)}async serializeObjectProps(t,e,i,s){const r=this.getPropertiesByClass(e)??[];for(const e of r){if(e.isValid&&!e.isValid.call(t))continue;if("command"===e.type)continue;if(!(e.isPersistent?.call(t)??!0))continue;const r={num:[0,0,0,0],str:[""],bool:[!1],object:[null]},a=e.name;switch(e.get.call(t,r),e.type){case"object":{const t="string"==typeof r.str[0]&&r.str[0]?r.str[0]:r.object[0]?Array.isArray(r.object[0])?r.object[0]:await this.serializeObject(r.object[0],{},s):null;t&&(i[a]=t);break}case"object_array":if(r.object.length>0){i[a]=[];for(const t of r.object)i[a].push(await this.serializeObject(t,{},s))}break;case"embedded":{const t=r.str[0].startsWith("/")?r.str[0].slice(1):r.str[0];if(i[a]=t,s){const e=r.object[0];s.push((async()=>{const i=await e;await this.VFS.writeFile(t,i,{encoding:"binary",create:!0})})())}break}case"float":case"int":(void 0===e.default&&!e.getDefaultValue||this.getDefaultValue(t,e)!==r.num[0])&&(i[a]=r.num[0]);break;case"string":(void 0===e.default&&!e.getDefaultValue||this.getDefaultValue(t,e)!==r.str[0])&&(i[a]=r.str[0]);break;case"bool":(void 0===e.default&&!e.getDefaultValue||this.getDefaultValue(t,e)!==r.bool[0])&&(i[a]=r.bool[0]);break;case"vec2":case"int2":if(void 0!==e.default||e.getDefaultValue){const i=this.getDefaultValue(t,e);if(i[0]===r.num[0]&&i[1]===r.num[1])break}i[a]=[r.num[0],r.num[1]];break;case"vec3":case"int3":case"rgb":if(void 0!==e.default||e.getDefaultValue){const i=this.getDefaultValue(t,e);if(i[0]===r.num[0]&&i[1]===r.num[1]&&i[2]===r.num[2])break}i[a]=[r.num[0],r.num[1],r.num[2]];break;case"vec4":case"int4":case"rgba":if(void 0!==e.default||e.getDefaultValue){const i=this.getDefaultValue(t,e);if(i[0]===r.num[0]&&i[1]===r.num[1]&&i[2]===r.num[2]&&i[3]===r.num[3])break}i[a]=[r.num[0],r.num[1],r.num[2],r.num[3]]}}}}class lx{_camera;constructor(){this._camera=null}_getCamera(){return this._camera}_setCamera(t){this._camera!==t&&(this._camera=t,this.reset())}lookAt(t,e,i){this._camera.lookAt(t,e,i)}reset(){}onMouseDown(t){return this._onMouseDown(t)}onMouseUp(t){return this._onMouseUp(t)}onMouseWheel(t){return this._onMouseWheel(t)}onMouseMove(t){return this._onMouseMove(t)}onKeyDown(t){return this._onKeyDown(t)}onKeyUp(t){return this._onKeyUp(t)}update(){}_onMouseDown(t){return!1}_onMouseUp(t){return!1}_onMouseWheel(t){return!1}_onMouseMove(t){return!1}_onKeyDown(t){return!1}_onKeyUp(t){return!1}}class ux extends lx{options;mouseDown;lastMouseX;lastMouseY;keyUp;keyDown;keyLeft;keyRight;keyForward;keyBackward;constructor(t){super(),this.options=Object.assign({controlKeys:{up:"KeyQ",down:"KeyE",forward:"KeyW",backward:"KeyS",left:"KeyA",right:"KeyD"},moveSpeed:.2,rotateSpeed:.01},t||{}),this.reset()}reset(){this.mouseDown=!1,this.lastMouseX=0,this.lastMouseY=0,this.keyUp=!1,this.keyDown=!1,this.keyLeft=!1,this.keyRight=!1,this.keyForward=!1,this.keyBackward=!1}_onMouseDown(t){return 0===t.button&&(this.mouseDown=!0,this.lastMouseX=t.offsetX,this.lastMouseY=t.offsetY,!0)}_onMouseUp(t){return!(0!==t.button||!this.mouseDown)&&(this.mouseDown=!1,!0)}_onMouseMove(t){if(this.mouseDown){const e=t.offsetX-this.lastMouseX,i=t.offsetY-this.lastMouseY;this.lastMouseX=t.offsetX,this.lastMouseY=t.offsetY;const s=this._getCamera().worldMatrix.getRow(2).xyz(),r=Math.atan2(s.z,s.x)+e*this.options.rotateSpeed,a=Math.min(Math.PI/2.1,Math.max(-Math.PI/2.1,Math.asin(s.y)+i*this.options.rotateSpeed)),n=Math.sin(a),o=Math.sqrt(Math.max(0,1-n*n)),h=Math.sin(r)*o,l=Math.cos(r)*o;s.setXYZ(l,n,h).inplaceNormalize();const u=z.cross(z.axisPY(),s).inplaceNormalize(),c=z.cross(s,u).inplaceNormalize(),d=U.fromRotationMatrix(new H([u.x,u.y,u.z,c.x,c.y,c.z,s.x,s.y,s.z]));if(this._getCamera().parent){const t=new z,e=new z;this._getCamera().worldMatrix.decompose(e,null,t);const i=W.scaling(e).rotateLeft(d).translateLeft(t);(this._getCamera().parent?i.multiplyLeftAffine(W.invertAffine(this._getCamera().parent.worldMatrix)):i).decompose(e,d,t),this._getCamera().position.set(t),this._getCamera().scale.set(e),this._getCamera().rotation.set(d)}else this._getCamera().rotation.set(d);return!0}return!1}_onKeyDown(t){switch(t.code){case this.options.controlKeys.up:this.keyUp=!0;break;case this.options.controlKeys.down:this.keyDown=!0;break;case this.options.controlKeys.left:this.keyLeft=!0;break;case this.options.controlKeys.right:this.keyRight=!0;break;case this.options.controlKeys.forward:this.keyForward=!0;break;case this.options.controlKeys.backward:this.keyBackward=!0;break;default:return!1}return!0}_onKeyUp(t){switch(t.code){case this.options.controlKeys.up:this.keyUp=!1;break;case this.options.controlKeys.down:this.keyDown=!1;break;case this.options.controlKeys.left:this.keyLeft=!1;break;case this.options.controlKeys.right:this.keyRight=!1;break;case this.options.controlKeys.forward:this.keyForward=!1;break;case this.options.controlKeys.backward:this.keyBackward=!1;break;default:return!1}return!0}setOptions(t){Object.assign(this.options,t??{}),this.reset()}update(){const t=this._getCamera().worldMatrix.getRow(0).xyz();t.y=0,t.inplaceNormalize();const e=this._getCamera().worldMatrix.getRow(2).xyz().inplaceNormalize(),i=new z(0,0,0);let s=!1;if(this.keyForward&&(s=!0,i.subBy(z.scale(e,this.options.moveSpeed))),this.keyBackward&&(s=!0,i.addBy(z.scale(e,this.options.moveSpeed))),this.keyUp&&(s=!0,i.y+=this.options.moveSpeed),this.keyDown&&(s=!0,i.y-=this.options.moveSpeed),this.keyLeft&&(s=!0,i.subBy(z.scale(t,this.options.moveSpeed))),this.keyRight&&(s=!0,i.addBy(z.scale(t,this.options.moveSpeed))),s)if(this._getCamera().parent){const t=new z,e=new z,s=new U;this._getCamera().worldMatrix.decompose(e,s,t),t.addBy(i);W.scaling(e).rotateLeft(s).translateLeft(t).multiplyLeftAffine(W.invertAffine(this._getCamera().parent.worldMatrix)).decompose(e,s,t),this._getCamera().position.set(t),this._getCamera().scale.set(e),this._getCamera().rotation.set(s)}else this._getCamera().moveBy(i)}}class cx{_app;_target;_started;_clickDistTolerance;_clickTimeTolerance;_dblclickDistTolerance;_dblclickTimeTolerance;_pointerDownHandler;_pointerUpHandler;_pointerMoveHandler;_pointerCancelHandler;_contextMenuHandler;_keyboardHandler;_dragHandler;_wheelHandler;_compositionHandler;_enableContextMenu;_captureId;_middlewares;_lastEventDatas;constructor(t){this._app=t,this._target=t.options.canvas,this._started=!1,this._clickDistTolerance=16,this._clickTimeTolerance=400,this._dblclickDistTolerance=16,this._dblclickTimeTolerance=400,this._lastEventDatas=[],this._enableContextMenu=!1,this._pointerDownHandler=this._getPointerDownHandler(),this._pointerUpHandler=this._getPointerUpHandler(),this._pointerMoveHandler=this._getPointerMoveHander(),this._pointerCancelHandler=this._getPointerCancelHandler(),this._contextMenuHandler=this._getContextMenuHandler(),this._keyboardHandler=this._getKeyboardHandler(),this._dragHandler=this._getDragHandler(),this._wheelHandler=this._getWheelHandler(),this._compositionHandler=this._getCompositionHandler(),this._captureId=-1,this._middlewares=[]}start(){this._started||(this._started=!0,this._target.addEventListener("pointerdown",this._pointerDownHandler),this._target.addEventListener("pointerup",this._pointerUpHandler),this._target.addEventListener("pointermove",this._pointerMoveHandler),this._target.addEventListener("pointercancel",this._pointerCancelHandler),this._target.addEventListener("contextmenu",this._contextMenuHandler),this._target.addEventListener("keydown",this._keyboardHandler),this._target.addEventListener("keyup",this._keyboardHandler),this._target.addEventListener("keypress",this._keyboardHandler),this._target.addEventListener("drag",this._dragHandler),this._target.addEventListener("dragenter",this._dragHandler),this._target.addEventListener("dragleave",this._dragHandler),this._target.addEventListener("dragstart",this._dragHandler),this._target.addEventListener("dragend",this._dragHandler),this._target.addEventListener("dragover",this._dragHandler),this._target.addEventListener("drop",this._dragHandler),this._target.addEventListener("wheel",this._wheelHandler),this._target.addEventListener("compositionstart",this._compositionHandler),this._target.addEventListener("compositionupdate",this._compositionHandler),this._target.addEventListener("compositionend",this._compositionHandler))}stop(){this._started&&(this._started=!1,this._target.removeEventListener("pointerdown",this._pointerDownHandler),this._target.removeEventListener("pointerup",this._pointerUpHandler),this._target.removeEventListener("pointermove",this._pointerMoveHandler),this._target.removeEventListener("pointercancel",this._pointerCancelHandler),this._target.removeEventListener("contextmenu",this._contextMenuHandler),this._target.removeEventListener("keydown",this._keyboardHandler),this._target.removeEventListener("keyup",this._keyboardHandler),this._target.removeEventListener("keypress",this._keyboardHandler),this._target.removeEventListener("drag",this._dragHandler),this._target.removeEventListener("dragenter",this._dragHandler),this._target.removeEventListener("dragleave",this._dragHandler),this._target.removeEventListener("dragstart",this._dragHandler),this._target.removeEventListener("dragend",this._dragHandler),this._target.removeEventListener("dragover",this._dragHandler),this._target.removeEventListener("drop",this._dragHandler),this._target.removeEventListener("wheel",this._wheelHandler),this._target.removeEventListener("compositionstart",this._compositionHandler),this._target.removeEventListener("compositionupdate",this._compositionHandler),this._target.removeEventListener("compositionend",this._compositionHandler),this._lastEventDatas=[])}use(t,e){return t&&this._middlewares.push({handler:t,ctx:e}),this}useFirst(t,e){return t&&this._middlewares.unshift({handler:t,ctx:e}),this}unuse(t,e){const i=this._middlewares.findIndex(i=>i.handler===t&&i.ctx===e);return i>=0&&this._middlewares.splice(i,1),this}enableSystemContextMenu(t){this._enableContextMenu=!!t}static log(t,e){return console.log("Event log:",e??t.type),!1}_callMiddlewares(t,e){for(const i of this._middlewares)if(i.handler.call(i.ctx,t,e??t.type))return!0;return!1}_getPointerCancelHandler(){const t=this;return function(e){const i=t._getPointerEventData(e.pointerId);i.lastDown=!1,i.lastClick=!1,t._callMiddlewares(e)||t._app.dispatchEvent(e.type,e)}}_getContextMenuHandler(){const t=this;return function(e){t._enableContextMenu||e.preventDefault(),t._callMiddlewares(e)||t._app.dispatchEvent(e.type,e)}}_getPointerMoveHander(){const t=this;return function(e){const i=t._getPointerEventData(e.pointerId);i.lastMoveX=e.offsetX,i.lastMoveY=e.offsetY,t._callMiddlewares(e)||t._app.dispatchEvent(e.type,e)}}_getPointerDownHandler(){const t=this;return function(e){"mouse"===e.pointerType&&(t._captureId=e.pointerId,t._app.options.canvas.setPointerCapture(e.pointerId));const i=t._getPointerEventData(e.pointerId);i.lastDown=!0,i.lastDownX=e.offsetX,i.lastDownY=e.offsetY,i.lastDownTime=Date.now(),t._app.focus(),t._callMiddlewares(e)||t._app.dispatchEvent(e.type,e)}}_getPointerUpHandler(){const t=this;return function(e){const i=t._getPointerEventData(e.pointerId);let s=!1,r=!1;const a=Date.now();if(i.lastDown&&a<=i.lastDownTime+t._clickTimeTolerance){let n=e.offsetX-i.lastDownX,o=e.offsetY-i.lastDownY;n*n+o*o<=t._clickDistTolerance&&(s=!0,i.lastClick&&a<=i.lastClickTime+t._dblclickTimeTolerance&&(n=e.offsetX-i.lastClickX,o=e.offsetY-i.lastClickY,n*n+o*o<=t._dblclickDistTolerance&&(r=!0)))}i.lastDown=!1,i.lastMoveX=e.offsetX,i.lastMoveY=e.offsetY,t._callMiddlewares(e)||t._app.dispatchEvent(e.type,e),s&&(t._callMiddlewares(e,"click")||t._app.dispatchEvent("click",e),r?(t._callMiddlewares(e,"dblclick")||t._app.dispatchEvent("dblclick",e),i.lastClick=!1):(i.lastClick=!0,i.lastClickX=e.offsetX,i.lastClickY=e.offsetY,i.lastClickTime=a)),"mouse"===e.pointerType&&t._captureId===e.pointerId&&(t._app.options.canvas.releasePointerCapture(e.pointerId),t._captureId=-1)}}_getKeyboardHandler(){const t=this;return function(e){t._callMiddlewares(e)||t._app.dispatchEvent(e.type,e)}}_getDragHandler(){const t=this;return function(e){t._callMiddlewares(e)||t._app.dispatchEvent(e.type,e)}}_getWheelHandler(){const t=this;return function(e){t._callMiddlewares(e)||t._app.dispatchEvent(e.type)}}_getCompositionHandler(){const t=this;return function(e){t._callMiddlewares(e)||t._app.dispatchEvent(e.type)}}_getPointerEventData(t){return this._lastEventDatas[t]??(this._lastEventDatas[t]={lastClick:!1,lastClickX:0,lastClickY:0,lastClickTime:0,lastDown:!1,lastDownX:0,lastDownY:0,lastDownTime:0,lastMoveX:0,lastMoveY:0})}}var dx;!function(t){t[t.Static=1]="Static",t[t.Dynamic=2]="Dynamic",t[t.ImportMeta=3]="ImportMeta",t[t.StaticSourcePhase=4]="StaticSourcePhase",t[t.DynamicSourcePhase=5]="DynamicSourcePhase",t[t.StaticDeferPhase=6]="StaticDeferPhase",t[t.DynamicDeferPhase=7]="DynamicDeferPhase"}(dx||(dx={}));const px=1===new Uint8Array(new Uint16Array([1]).buffer)[0];function mx(t,e="@"){if(!gx)return xx.then(()=>mx(t));const i=t.length+1,s=(gx.__heap_base.value||gx.__heap_base)+4*i-gx.memory.buffer.byteLength;s>0&&gx.memory.grow(Math.ceil(s/65536));const r=gx.sa(i-1);if((px?_x:fx)(t,new Uint16Array(gx.memory.buffer,r,i)),!gx.parse())throw Object.assign(new Error(`Parse error ${e}:${t.slice(0,gx.e()).split("\n").length}:${gx.e()-t.lastIndexOf("\n",gx.e()-1)}`),{idx:gx.e()});const a=[],n=[];for(;gx.ri();){const e=gx.is(),i=gx.ie(),s=gx.it(),r=gx.ai(),n=gx.id(),h=gx.ss(),l=gx.se();let u;gx.ip()&&(u=o(t.slice(-1===n?e-1:e,-1===n?i+1:i))),a.push({n:u,t:s,s:e,e:i,ss:h,se:l,d:n,a:r})}for(;gx.re();){const e=gx.es(),i=gx.ee(),s=gx.els(),r=gx.ele(),a=t.slice(e,i),h=a[0],l=s<0?void 0:t.slice(s,r),u=l?l[0]:"";n.push({s:e,e:i,ls:s,le:r,n:'"'===h||"'"===h?o(a):a,ln:'"'===u||"'"===u?o(l):l})}function o(t){try{return(0,eval)(t)}catch(t){}}return[a,n,!!gx.f(),!!gx.ms()]}function fx(t,e){const i=t.length;let s=0;for(;s<i;){const i=t.charCodeAt(s);e[s++]=(255&i)<<8|i>>>8}}function _x(t,e){const i=t.length;let s=0;for(;s<i;)e[s]=t.charCodeAt(s++)}let gx;const xx=WebAssembly.compile((()=>{return t="AGFzbQEAAAABKwhgAX8Bf2AEf39/fwBgAAF/YAAAYAF/AGADf39/AX9gAn9/AX9gA39/fwADMTAAAQECAgICAgICAgICAgICAgICAgIAAwMDBAQAAAUAAAAAAAMDAwAGAAAABwAGAgUEBQFwAQEBBQMBAAEGDwJ/AUHA8gALfwBBwPIACwd6FQZtZW1vcnkCAAJzYQAAAWUAAwJpcwAEAmllAAUCc3MABgJzZQAHAml0AAgCYWkACQJpZAAKAmlwAAsCZXMADAJlZQANA2VscwAOA2VsZQAPAnJpABACcmUAEQFmABICbXMAEwVwYXJzZQAUC19faGVhcF9iYXNlAwEKzkQwaAEBf0EAIAA2AoAKQQAoAtwJIgEgAEEBdGoiAEEAOwEAQQAgAEECaiIANgKECkEAIAA2AogKQQBBADYC4AlBAEEANgLwCUEAQQA2AugJQQBBADYC5AlBAEEANgL4CUEAQQA2AuwJIAEL0wEBA39BACgC8AkhBEEAQQAoAogKIgU2AvAJQQAgBDYC9AlBACAFQSRqNgKICiAEQSBqQeAJIAQbIAU2AgBBACgC1AkhBEEAKALQCSEGIAUgATYCACAFIAA2AgggBSACIAJBAmpBACAGIANGIgAbIAQgA0YiBBs2AgwgBSADNgIUIAVBADYCECAFIAI2AgQgBUEANgIgIAVBA0EBQQIgABsgBBs2AhwgBUEAKALQCSADRiICOgAYAkACQCACDQBBACgC1AkgA0cNAQtBAEEBOgCMCgsLXgEBf0EAKAL4CSIEQRBqQeQJIAQbQQAoAogKIgQ2AgBBACAENgL4CUEAIARBFGo2AogKQQBBAToAjAogBEEANgIQIAQgAzYCDCAEIAI2AgggBCABNgIEIAQgADYCAAsIAEEAKAKQCgsVAEEAKALoCSgCAEEAKALcCWtBAXULHgEBf0EAKALoCSgCBCIAQQAoAtwJa0EBdUF/IAAbCxUAQQAoAugJKAIIQQAoAtwJa0EBdQseAQF/QQAoAugJKAIMIgBBACgC3AlrQQF1QX8gABsLCwBBACgC6AkoAhwLHgEBf0EAKALoCSgCECIAQQAoAtwJa0EBdUF/IAAbCzsBAX8CQEEAKALoCSgCFCIAQQAoAtAJRw0AQX8PCwJAIABBACgC1AlHDQBBfg8LIABBACgC3AlrQQF1CwsAQQAoAugJLQAYCxUAQQAoAuwJKAIAQQAoAtwJa0EBdQsVAEEAKALsCSgCBEEAKALcCWtBAXULHgEBf0EAKALsCSgCCCIAQQAoAtwJa0EBdUF/IAAbCx4BAX9BACgC7AkoAgwiAEEAKALcCWtBAXVBfyAAGwslAQF/QQBBACgC6AkiAEEgakHgCSAAGygCACIANgLoCSAAQQBHCyUBAX9BAEEAKALsCSIAQRBqQeQJIAAbKAIAIgA2AuwJIABBAEcLCABBAC0AlAoLCABBAC0AjAoL3Q0BBX8jAEGA0ABrIgAkAEEAQQE6AJQKQQBBACgC2Ak2ApwKQQBBACgC3AlBfmoiATYCsApBACABQQAoAoAKQQF0aiICNgK0CkEAQQA6AIwKQQBBADsBlgpBAEEAOwGYCkEAQQA6AKAKQQBBADYCkApBAEEAOgD8CUEAIABBgBBqNgKkCkEAIAA2AqgKQQBBADoArAoCQAJAAkACQANAQQAgAUECaiIDNgKwCiABIAJPDQECQCADLwEAIgJBd2pBBUkNAAJAAkACQAJAAkAgAkGbf2oOBQEICAgCAAsgAkEgRg0EIAJBL0YNAyACQTtGDQIMBwtBAC8BmAoNASADEBVFDQEgAUEEakGCCEEKEC8NARAWQQAtAJQKDQFBAEEAKAKwCiIBNgKcCgwHCyADEBVFDQAgAUEEakGMCEEKEC8NABAXC0EAQQAoArAKNgKcCgwBCwJAIAEvAQQiA0EqRg0AIANBL0cNBBAYDAELQQEQGQtBACgCtAohAkEAKAKwCiEBDAALC0EAIQIgAyEBQQAtAPwJDQIMAQtBACABNgKwCkEAQQA6AJQKCwNAQQAgAUECaiIDNgKwCgJAAkACQAJAAkACQAJAIAFBACgCtApPDQAgAy8BACICQXdqQQVJDQYCQAJAAkACQAJAAkACQAJAAkACQCACQWBqDgoQDwYPDw8PBQECAAsCQAJAAkACQCACQaB/ag4KCxISAxIBEhISAgALIAJBhX9qDgMFEQYJC0EALwGYCg0QIAMQFUUNECABQQRqQYIIQQoQLw0QEBYMEAsgAxAVRQ0PIAFBBGpBjAhBChAvDQ8QFwwPCyADEBVFDQ4gASkABELsgISDsI7AOVINDiABLwEMIgNBd2oiAUEXSw0MQQEgAXRBn4CABHFFDQwMDQtBAEEALwGYCiIBQQFqOwGYCkEAKAKkCiABQQN0aiIBQQE2AgAgAUEAKAKcCjYCBAwNC0EALwGYCiIDRQ0JQQAgA0F/aiIDOwGYCkEALwGWCiICRQ0MQQAoAqQKIANB//8DcUEDdGooAgBBBUcNDAJAIAJBAnRBACgCqApqQXxqKAIAIgMoAgQNACADQQAoApwKQQJqNgIEC0EAIAJBf2o7AZYKIAMgAUEEajYCDAwMCwJAQQAoApwKIgEvAQBBKUcNAEEAKALwCSIDRQ0AIAMoAgQgAUcNAEEAQQAoAvQJIgM2AvAJAkAgA0UNACADQQA2AiAMAQtBAEEANgLgCQtBAEEALwGYCiIDQQFqOwGYCkEAKAKkCiADQQN0aiIDQQZBAkEALQCsChs2AgAgAyABNgIEQQBBADoArAoMCwtBAC8BmAoiAUUNB0EAIAFBf2oiATsBmApBACgCpAogAUH//wNxQQN0aigCAEEERg0EDAoLQScQGgwJC0EiEBoMCAsgAkEvRw0HAkACQCABLwEEIgFBKkYNACABQS9HDQEQGAwKC0EBEBkMCQsCQAJAAkACQEEAKAKcCiIBLwEAIgMQG0UNAAJAAkAgA0FVag4EAAkBAwkLIAFBfmovAQBBK0YNAwwICyABQX5qLwEAQS1GDQIMBwsgA0EpRw0BQQAoAqQKQQAvAZgKIgJBA3RqKAIEEBxFDQIMBgsgAUF+ai8BAEFQakH//wNxQQpPDQULQQAvAZgKIQILAkACQCACQf//A3EiAkUNACADQeYARw0AQQAoAqQKIAJBf2pBA3RqIgQoAgBBAUcNACABQX5qLwEAQe8ARw0BIAQoAgRBlghBAxAdRQ0BDAULIANB/QBHDQBBACgCpAogAkEDdGoiAigCBBAeDQQgAigCAEEGRg0ECyABEB8NAyADRQ0DIANBL0ZBAC0AoApBAEdxDQMCQEEAKAL4CSICRQ0AIAEgAigCAEkNACABIAIoAgRNDQQLIAFBfmohAUEAKALcCSECAkADQCABQQJqIgQgAk0NAUEAIAE2ApwKIAEvAQAhAyABQX5qIgQhASADECBFDQALIARBAmohBAsCQCADQf//A3EQIUUNACAEQX5qIQECQANAIAFBAmoiAyACTQ0BQQAgATYCnAogAS8BACEDIAFBfmoiBCEBIAMQIQ0ACyAEQQJqIQMLIAMQIg0EC0EAQQE6AKAKDAcLQQAoAqQKQQAvAZgKIgFBA3QiA2pBACgCnAo2AgRBACABQQFqOwGYCkEAKAKkCiADakEDNgIACxAjDAULQQAtAPwJQQAvAZYKQQAvAZgKcnJFIQIMBwsQJEEAQQA6AKAKDAMLECVBACECDAULIANBoAFHDQELQQBBAToArAoLQQBBACgCsAo2ApwKC0EAKAKwCiEBDAALCyAAQYDQAGokACACCxoAAkBBACgC3AkgAEcNAEEBDwsgAEF+ahAmC/4KAQZ/QQBBACgCsAoiAEEMaiIBNgKwCkEAKAL4CSECQQEQKSEDAkACQAJAAkACQAJAAkACQAJAQQAoArAKIgQgAUcNACADEChFDQELAkACQAJAAkACQAJAAkAgA0EqRg0AIANB+wBHDQFBACAEQQJqNgKwCkEBECkhA0EAKAKwCiEEA0ACQAJAIANB//8DcSIDQSJGDQAgA0EnRg0AIAMQLBpBACgCsAohAwwBCyADEBpBAEEAKAKwCkECaiIDNgKwCgtBARApGgJAIAQgAxAtIgNBLEcNAEEAQQAoArAKQQJqNgKwCkEBECkhAwsgA0H9AEYNA0EAKAKwCiIFIARGDQ8gBSEEIAVBACgCtApNDQAMDwsLQQAgBEECajYCsApBARApGkEAKAKwCiIDIAMQLRoMAgtBAEEAOgCUCgJAAkACQAJAAkACQCADQZ9/ag4MAgsEAQsDCwsLCwsFAAsgA0H2AEYNBAwKC0EAIARBDmoiAzYCsAoCQAJAAkBBARApQZ9/ag4GABICEhIBEgtBACgCsAoiBSkAAkLzgOSD4I3AMVINESAFLwEKECFFDRFBACAFQQpqNgKwCkEAECkaC0EAKAKwCiIFQQJqQbIIQQ4QLw0QIAUvARAiAkF3aiIBQRdLDQ1BASABdEGfgIAEcUUNDQwOC0EAKAKwCiIFKQACQuyAhIOwjsA5Ug0PIAUvAQoiAkF3aiIBQRdNDQYMCgtBACAEQQpqNgKwCkEAECkaQQAoArAKIQQLQQAgBEEQajYCsAoCQEEBECkiBEEqRw0AQQBBACgCsApBAmo2ArAKQQEQKSEEC0EAKAKwCiEDIAQQLBogA0EAKAKwCiIEIAMgBBACQQBBACgCsApBfmo2ArAKDwsCQCAEKQACQuyAhIOwjsA5Ug0AIAQvAQoQIEUNAEEAIARBCmo2ArAKQQEQKSEEQQAoArAKIQMgBBAsGiADQQAoArAKIgQgAyAEEAJBAEEAKAKwCkF+ajYCsAoPC0EAIARBBGoiBDYCsAoLQQAgBEEGajYCsApBAEEAOgCUCkEBECkhBEEAKAKwCiEDIAQQLCEEQQAoArAKIQIgBEHf/wNxIgFB2wBHDQNBACACQQJqNgKwCkEBECkhBUEAKAKwCiEDQQAhBAwEC0EAQQE6AIwKQQBBACgCsApBAmo2ArAKC0EBECkhBEEAKAKwCiEDAkAgBEHmAEcNACADQQJqQawIQQYQLw0AQQAgA0EIajYCsAogAEEBEClBABArIAJBEGpB5AkgAhshAwNAIAMoAgAiA0UNBSADQgA3AgggA0EQaiEDDAALC0EAIANBfmo2ArAKDAMLQQEgAXRBn4CABHFFDQMMBAtBASEECwNAAkACQCAEDgIAAQELIAVB//8DcRAsGkEBIQQMAQsCQAJAQQAoArAKIgQgA0YNACADIAQgAyAEEAJBARApIQQCQCABQdsARw0AIARBIHJB/QBGDQQLQQAoArAKIQMCQCAEQSxHDQBBACADQQJqNgKwCkEBECkhBUEAKAKwCiEDIAVBIHJB+wBHDQILQQAgA0F+ajYCsAoLIAFB2wBHDQJBACACQX5qNgKwCg8LQQAhBAwACwsPCyACQaABRg0AIAJB+wBHDQQLQQAgBUEKajYCsApBARApIgVB+wBGDQMMAgsCQCACQVhqDgMBAwEACyACQaABRw0CC0EAIAVBEGo2ArAKAkBBARApIgVBKkcNAEEAQQAoArAKQQJqNgKwCkEBECkhBQsgBUEoRg0BC0EAKAKwCiEBIAUQLBpBACgCsAoiBSABTQ0AIAQgAyABIAUQAkEAQQAoArAKQX5qNgKwCg8LIAQgA0EAQQAQAkEAIARBDGo2ArAKDwsQJQuFDAEKf0EAQQAoArAKIgBBDGoiATYCsApBARApIQJBACgCsAohAwJAAkACQAJAAkACQAJAAkAgAkEuRw0AQQAgA0ECajYCsAoCQEEBECkiAkHkAEYNAAJAIAJB8wBGDQAgAkHtAEcNB0EAKAKwCiICQQJqQZwIQQYQLw0HAkBBACgCnAoiAxAqDQAgAy8BAEEuRg0ICyAAIAAgAkEIakEAKALUCRABDwtBACgCsAoiAkECakGiCEEKEC8NBgJAQQAoApwKIgMQKg0AIAMvAQBBLkYNBwtBACEEQQAgAkEMajYCsApBASEFQQUhBkEBECkhAkEAIQdBASEIDAILQQAoArAKIgIpAAJC5YCYg9CMgDlSDQUCQEEAKAKcCiIDECoNACADLwEAQS5GDQYLQQAhBEEAIAJBCmo2ArAKQQIhCEEHIQZBASEHQQEQKSECQQEhBQwBCwJAAkACQAJAIAJB8wBHDQAgAyABTQ0AIANBAmpBoghBChAvDQACQCADLwEMIgRBd2oiB0EXSw0AQQEgB3RBn4CABHENAgsgBEGgAUYNAQtBACEHQQchBkEBIQQgAkHkAEYNAQwCC0EAIQRBACADQQxqIgI2ArAKQQEhBUEBECkhCQJAQQAoArAKIgYgAkYNAEHmACECAkAgCUHmAEYNAEEFIQZBACEHQQEhCCAJIQIMBAtBACEHQQEhCCAGQQJqQawIQQYQLw0EIAYvAQgQIEUNBAtBACEHQQAgAzYCsApBByEGQQEhBEEAIQVBACEIIAkhAgwCCyADIABBCmpNDQBBACEIQeQAIQICQCADKQACQuWAmIPQjIA5Ug0AAkACQCADLwEKIgRBd2oiB0EXSw0AQQEgB3RBn4CABHENAQtBACEIIARBoAFHDQELQQAhBUEAIANBCmo2ArAKQSohAkEBIQdBAiEIQQEQKSIJQSpGDQRBACADNgKwCkEBIQRBACEHQQAhCCAJIQIMAgsgAyEGQQAhBwwCC0EAIQVBACEICwJAIAJBKEcNAEEAKAKkCkEALwGYCiICQQN0aiIDQQAoArAKNgIEQQAgAkEBajsBmAogA0EFNgIAQQAoApwKLwEAQS5GDQRBAEEAKAKwCiIDQQJqNgKwCkEBECkhAiAAQQAoArAKQQAgAxABAkACQCAFDQBBACgC8AkhAQwBC0EAKALwCSIBIAY2AhwLQQBBAC8BlgoiA0EBajsBlgpBACgCqAogA0ECdGogATYCAAJAIAJBIkYNACACQSdGDQBBAEEAKAKwCkF+ajYCsAoPCyACEBpBAEEAKAKwCkECaiICNgKwCgJAAkACQEEBEClBV2oOBAECAgACC0EAQQAoArAKQQJqNgKwCkEBECkaQQAoAvAJIgMgAjYCBCADQQE6ABggA0EAKAKwCiICNgIQQQAgAkF+ajYCsAoPC0EAKALwCSIDIAI2AgQgA0EBOgAYQQBBAC8BmApBf2o7AZgKIANBACgCsApBAmo2AgxBAEEALwGWCkF/ajsBlgoPC0EAQQAoArAKQX5qNgKwCg8LAkAgBEEBcyACQfsAR3INAEEAKAKwCiECQQAvAZgKDQUDQAJAAkACQCACQQAoArQKTw0AQQEQKSICQSJGDQEgAkEnRg0BIAJB/QBHDQJBAEEAKAKwCkECajYCsAoLQQEQKSEDQQAoArAKIQICQCADQeYARw0AIAJBAmpBrAhBBhAvDQcLQQAgAkEIajYCsAoCQEEBECkiAkEiRg0AIAJBJ0cNBwsgACACQQAQKw8LIAIQGgtBAEEAKAKwCkECaiICNgKwCgwACwsCQAJAIAJBWWoOBAMBAQMACyACQSJGDQILQQAoArAKIQYLIAYgAUcNAEEAIABBCmo2ArAKDwsgAkEqRyAHcQ0DQQAvAZgKQf//A3ENA0EAKAKwCiECQQAoArQKIQEDQCACIAFPDQECQAJAIAIvAQAiA0EnRg0AIANBIkcNAQsgACADIAgQKw8LQQAgAkECaiICNgKwCgwACwsQJQsPC0EAIAJBfmo2ArAKDwtBAEEAKAKwCkF+ajYCsAoLRwEDf0EAKAKwCkECaiEAQQAoArQKIQECQANAIAAiAkF+aiABTw0BIAJBAmohACACLwEAQXZqDgQBAAABAAsLQQAgAjYCsAoLmAEBA39BAEEAKAKwCiIBQQJqNgKwCiABQQZqIQFBACgCtAohAgNAAkACQAJAIAFBfGogAk8NACABQX5qLwEAIQMCQAJAIAANACADQSpGDQEgA0F2ag4EAgQEAgQLIANBKkcNAwsgAS8BAEEvRw0CQQAgAUF+ajYCsAoMAQsgAUF+aiEBC0EAIAE2ArAKDwsgAUECaiEBDAALC4gBAQR/QQAoArAKIQFBACgCtAohAgJAAkADQCABIgNBAmohASADIAJPDQEgAS8BACIEIABGDQICQCAEQdwARg0AIARBdmoOBAIBAQIBCyADQQRqIQEgAy8BBEENRw0AIANBBmogASADLwEGQQpGGyEBDAALC0EAIAE2ArAKECUPC0EAIAE2ArAKC2wBAX8CQAJAIABBX2oiAUEFSw0AQQEgAXRBMXENAQsgAEFGakH//wNxQQZJDQAgAEEpRyAAQVhqQf//A3FBB0lxDQACQCAAQaV/ag4EAQAAAQALIABB/QBHIABBhX9qQf//A3FBBElxDwtBAQsuAQF/QQEhAQJAIABBpglBBRAdDQAgAEGWCEEDEB0NACAAQbAJQQIQHSEBCyABC0YBA39BACEDAkAgACACQQF0IgJrIgRBAmoiAEEAKALcCSIFSQ0AIAAgASACEC8NAAJAIAAgBUcNAEEBDwsgBBAmIQMLIAMLgwEBAn9BASEBAkACQAJAAkACQAJAIAAvAQAiAkFFag4EBQQEAQALAkAgAkGbf2oOBAMEBAIACyACQSlGDQQgAkH5AEcNAyAAQX5qQbwJQQYQHQ8LIABBfmovAQBBPUYPCyAAQX5qQbQJQQQQHQ8LIABBfmpByAlBAxAdDwtBACEBCyABC7QDAQJ/QQAhAQJAAkACQAJAAkACQAJAAkACQAJAIAAvAQBBnH9qDhQAAQIJCQkJAwkJBAUJCQYJBwkJCAkLAkACQCAAQX5qLwEAQZd/ag4EAAoKAQoLIABBfGpByghBAhAdDwsgAEF8akHOCEEDEB0PCwJAAkACQCAAQX5qLwEAQY1/ag4DAAECCgsCQCAAQXxqLwEAIgJB4QBGDQAgAkHsAEcNCiAAQXpqQeUAECcPCyAAQXpqQeMAECcPCyAAQXxqQdQIQQQQHQ8LIABBfGpB3AhBBhAdDwsgAEF+ai8BAEHvAEcNBiAAQXxqLwEAQeUARw0GAkAgAEF6ai8BACICQfAARg0AIAJB4wBHDQcgAEF4akHoCEEGEB0PCyAAQXhqQfQIQQIQHQ8LIABBfmpB+AhBBBAdDwtBASEBIABBfmoiAEHpABAnDQQgAEGACUEFEB0PCyAAQX5qQeQAECcPCyAAQX5qQYoJQQcQHQ8LIABBfmpBmAlBBBAdDwsCQCAAQX5qLwEAIgJB7wBGDQAgAkHlAEcNASAAQXxqQe4AECcPCyAAQXxqQaAJQQMQHSEBCyABCzQBAX9BASEBAkAgAEF3akH//wNxQQVJDQAgAEGAAXJBoAFGDQAgAEEuRyAAEChxIQELIAELMAEBfwJAAkAgAEF3aiIBQRdLDQBBASABdEGNgIAEcQ0BCyAAQaABRg0AQQAPC0EBC04BAn9BACEBAkACQCAALwEAIgJB5QBGDQAgAkHrAEcNASAAQX5qQfgIQQQQHQ8LIABBfmovAQBB9QBHDQAgAEF8akHcCEEGEB0hAQsgAQveAQEEf0EAKAKwCiEAQQAoArQKIQECQAJAAkADQCAAIgJBAmohACACIAFPDQECQAJAAkAgAC8BACIDQaR/ag4FAgMDAwEACyADQSRHDQIgAi8BBEH7AEcNAkEAIAJBBGoiADYCsApBAEEALwGYCiICQQFqOwGYCkEAKAKkCiACQQN0aiICQQQ2AgAgAiAANgIEDwtBACAANgKwCkEAQQAvAZgKQX9qIgA7AZgKQQAoAqQKIABB//8DcUEDdGooAgBBA0cNAwwECyACQQRqIQAMAAsLQQAgADYCsAoLECULC3ABAn8CQAJAA0BBAEEAKAKwCiIAQQJqIgE2ArAKIABBACgCtApPDQECQAJAAkAgAS8BACIBQaV/ag4CAQIACwJAIAFBdmoOBAQDAwQACyABQS9HDQIMBAsQLhoMAQtBACAAQQRqNgKwCgwACwsQJQsLNQEBf0EAQQE6APwJQQAoArAKIQBBAEEAKAK0CkECajYCsApBACAAQQAoAtwJa0EBdTYCkAoLQwECf0EBIQECQCAALwEAIgJBd2pB//8DcUEFSQ0AIAJBgAFyQaABRg0AQQAhASACEChFDQAgAkEuRyAAECpyDwsgAQs9AQJ/QQAhAgJAQQAoAtwJIgMgAEsNACAALwEAIAFHDQACQCADIABHDQBBAQ8LIABBfmovAQAQICECCyACC2gBAn9BASEBAkACQCAAQV9qIgJBBUsNAEEBIAJ0QTFxDQELIABB+P8DcUEoRg0AIABBRmpB//8DcUEGSQ0AAkAgAEGlf2oiAkEDSw0AIAJBAUcNAQsgAEGFf2pB//8DcUEESSEBCyABC5wBAQN/QQAoArAKIQECQANAAkACQCABLwEAIgJBL0cNAAJAIAEvAQIiAUEqRg0AIAFBL0cNBBAYDAILIAAQGQwBCwJAAkAgAEUNACACQXdqIgFBF0sNAUEBIAF0QZ+AgARxRQ0BDAILIAIQIUUNAwwBCyACQaABRw0CC0EAQQAoArAKIgNBAmoiATYCsAogA0EAKAK0CkkNAAsLIAILMQEBf0EAIQECQCAALwEAQS5HDQAgAEF+ai8BAEEuRw0AIABBfGovAQBBLkYhAQsgAQumBAEBfwJAIAFBIkYNACABQSdGDQAQJQ8LQQAoArAKIQMgARAaIAAgA0ECakEAKAKwCkEAKALQCRABAkAgAkEBSA0AQQAoAvAJQQRBBiACQQFGGzYCHAtBAEEAKAKwCkECajYCsAoCQAJAAkACQEEAECkiAUHhAEYNACABQfcARg0BQQAoArAKIQEMAgtBACgCsAoiAUECakHACEEKEC8NAUEGIQIMAgtBACgCsAoiAS8BAkHpAEcNACABLwEEQfQARw0AQQQhAiABLwEGQegARg0BC0EAIAFBfmo2ArAKDwtBACABIAJBAXRqNgKwCgJAQQEQKUH7AEYNAEEAIAE2ArAKDwtBACgCsAoiACECA0BBACACQQJqNgKwCgJAAkACQEEBECkiAkEiRg0AIAJBJ0cNAUEnEBpBAEEAKAKwCkECajYCsApBARApIQIMAgtBIhAaQQBBACgCsApBAmo2ArAKQQEQKSECDAELIAIQLCECCwJAIAJBOkYNAEEAIAE2ArAKDwtBAEEAKAKwCkECajYCsAoCQEEBECkiAkEiRg0AIAJBJ0YNAEEAIAE2ArAKDwsgAhAaQQBBACgCsApBAmo2ArAKAkACQEEBECkiAkEsRg0AIAJB/QBGDQFBACABNgKwCg8LQQBBACgCsApBAmo2ArAKQQEQKUH9AEYNAEEAKAKwCiECDAELC0EAKALwCSIBIAA2AhAgAUEAKAKwCkECajYCDAttAQJ/AkACQANAAkAgAEH//wNxIgFBd2oiAkEXSw0AQQEgAnRBn4CABHENAgsgAUGgAUYNASAAIQIgARAoDQJBACECQQBBACgCsAoiAEECajYCsAogAC8BAiIADQAMAgsLIAAhAgsgAkH//wNxC6sBAQR/AkACQEEAKAKwCiICLwEAIgNB4QBGDQAgASEEIAAhBQwBC0EAIAJBBGo2ArAKQQEQKSECQQAoArAKIQUCQAJAIAJBIkYNACACQSdGDQAgAhAsGkEAKAKwCiEEDAELIAIQGkEAQQAoArAKQQJqIgQ2ArAKC0EBECkhA0EAKAKwCiECCwJAIAIgBUYNACAFIARBACAAIAAgAUYiAhtBACABIAIbEAILIAMLcgEEf0EAKAKwCiEAQQAoArQKIQECQAJAA0AgAEECaiECIAAgAU8NAQJAAkAgAi8BACIDQaR/ag4CAQQACyACIQAgA0F2ag4EAgEBAgELIABBBGohAAwACwtBACACNgKwChAlQQAPC0EAIAI2ArAKQd0AC0kBA39BACEDAkAgAkUNAAJAA0AgAC0AACIEIAEtAAAiBUcNASABQQFqIQEgAEEBaiEAIAJBf2oiAg0ADAILCyAEIAVrIQMLIAMLC+wBAgBBgAgLzgEAAHgAcABvAHIAdABtAHAAbwByAHQAZgBvAHIAZQB0AGEAbwB1AHIAYwBlAHIAbwBtAHUAbgBjAHQAaQBvAG4AcwBzAGUAcgB0AHYAbwB5AGkAZQBkAGUAbABlAGMAbwBuAHQAaQBuAGkAbgBzAHQAYQBuAHQAeQBiAHIAZQBhAHIAZQB0AHUAcgBkAGUAYgB1AGcAZwBlAGEAdwBhAGkAdABoAHIAdwBoAGkAbABlAGkAZgBjAGEAdABjAGYAaQBuAGEAbABsAGUAbABzAABB0AkLEAEAAAACAAAAAAQAAEA5AAA=","undefined"!=typeof Buffer?Buffer.from(t,"base64"):Uint8Array.from(atob(t),t=>t.charCodeAt(0));var t})()).then(WebAssembly.instantiate).then(({exports:t})=>{gx=t});function bx(t,e){var s;return`data:text/javascript;base64,${s=t,i((new TextEncoder).encode(s))}#${encodeURIComponent(String(e))}`}function vx(t){return/^https?:\/\//i.test(t)}function yx(t){return/^(data|blob):/i.test(t)}function Tx(t){return!(t.startsWith("./")||t.startsWith("../")||t.startsWith("/")||t.startsWith("#/"))}class wx{_vfs;_scriptsRoot;_built=new Map;_editorMode=!1;constructor(t,e,i){this._vfs=t,this._scriptsRoot=e,this._editorMode=i}get VFS(){return this._vfs}set VFS(t){t!==this._vfs&&(this._vfs=t,this._built.clear())}get editorMode(){return this._editorMode}set editorMode(t){this._editorMode=t}get scriptsRoot(){return this._scriptsRoot}set scriptsRoot(t){this._scriptsRoot=t}async fetchSource(t){let e=null,i="";if(t.endsWith(".ts")?(i=t,e="ts"):t.endsWith(".js")&&(i=t,e="js"),e){await this._vfs.exists(i)||(e=null);(await this._vfs.stat(i)).isDirectory&&(e=null)}const s=["ts","js"];if(!e)for(const r of s){i=`${t}.${r}`;if(await this._vfs.exists(i)){if((await this._vfs.stat(i)).isFile){e=r;break}}}if(e){return{code:await this._vfs.readFile(i,{encoding:"utf8"}),type:e,path:i}}}async resolveRuntimeUrl(t){const e=await this.resolveLogicalId(t);return this._editorMode?await this.build(String(e)):e.endsWith(".js")?e:e.endsWith(".ts")?`${e.slice(0,-3)}.js`:`${e}.js`}async getDependencies(t,e,i){const s=await this.resolveLogicalId(t,e),r=await this.resolveSourcePath(s);if(!r||void 0!==i[r.path])return;const a=await this._vfs.readFile(r.path,{encoding:"utf8"});i[r.path]=a;const n=async(t,e)=>{for(;;){const r=e.exec(t);if(!r)break;const a=r[2];(a.startsWith("./")||a.startsWith("../"))&&await this.getDependencies(a,s,i)}};await n(a,/\b(?:import|export)\s+[^"']*?from\s+(['"])([^'"]+)\1/g),await n(a,/\bimport\s*\(\s*(['"])([^'"]+)\1\s*\)/g)}async build(t){const e=String(t),i=this._built.get(e);if(i)return i;const s=await this.resolveSourcePath(e);if(!s)return"";const r=await this._vfs.readFile(s.path,{encoding:"utf8"}),a=await this.rewriteImports(r,e),n=bx(await this.transpile(a,e,s.type),e);return this._built.set(e,n),n}async transpile(t,e,i){const s=String(e);if("js"===i)return`${t}\n//# sourceURL=${s}`;const r=window.ts;if(!r)throw new Error("TypeScript runtime (window.ts) not found. Load typescript.js first.");const a=r.transpileModule(t,{compilerOptions:{target:r.ScriptTarget.ES2015,module:r.ModuleKind.ESNext,sourceMap:!0,inlineSources:!0,experimentalDecorators:!0,useDefineForClassFields:!1},fileName:s});let n=a.outputText||"";if(a.sourceMapText){n+=`\n//# sourceMappingURL=data:application/json;base64,${btoa(unescape(encodeURIComponent(a.sourceMapText)))}`}return n+=`\n//# sourceURL=${s}`,n}async rewriteImports(t,e){await xx;const[i]=mx(t),s=[...i].sort((t,e)=>(t.s||0)-(e.s||0));let r="",a=0;for(const i of s){if(!(null!=i.ss&&null!=i.se)||i.se<=i.ss)continue;if(i.e<=i.s)continue;r+=t.slice(a,i.s);const s=t.slice(i.s,i.e);let n=s;if(vx(s)||yx(s)||Tx(s))if(s.startsWith("@zephyr3d/"))n=s;else{const t=await this.resolveLogicalId(s);n=await this.build(t)}else{const t=await this.resolveLogicalId(s,String(e));n=await this.build(t)}r+=n,a=i.e}return r+=t.slice(a),r}async resolveLogicalId(t,e){let i;if(t.startsWith("#/"))i=this._vfs.normalizePath(this._vfs.join(this._scriptsRoot,t.slice(2)));else if(t.startsWith("./")||t.startsWith("../")){if(!e)throw new Error(`Relative import "${t}" requires fromId`);i=this._vfs.normalizePath(this._vfs.join(this._vfs.dirname(this._vfs.normalizePath(e)),t))}else if(t.startsWith("/"))i=t.replace(/^\/+/,"/");else{if(!this._editorMode)return t;if(await this._vfs.exists("/libs/deps.lock.json")){const e=await this._vfs.readFile("/libs/deps.lock.json",{encoding:"utf8"}),s=JSON.parse(e);s?.dependencies[t]&&(i=this._vfs.normalizePath(s.dependencies[t].entry))}}return i}async resolveSourcePath(t){let e=null,i="";if(t.endsWith(".ts")?(i=t,e="ts"):(t.endsWith(".js")||t.endsWith(".mjs"))&&(i=t,e="js"),e){await this._vfs.exists(i)||(e=null);(await this._vfs.stat(i)).isDirectory&&(e=null)}const s=["ts","js","mjs"];if(!e)for(const r of s){i=`${t}.${r}`;if(await this._vfs.exists(i)){if((await this._vfs.stat(i)).isFile){e="ts"===r?"ts":"js";break}}}return e?{type:e,path:i}:null}}class Sx{onCreated(){}onAttached(t){}onUpdate(t,e){}onDetached(t){}onDestroy(){}}class Ax{_registry;_hostScripts;_scriptHosts;_onLoadError;_importComment;constructor(t={}){this._registry=new wx(t.VFS??new ft("./"),t.scriptsRoot??"/",t.editorMode??!1),this._hostScripts=new Map,this._scriptHosts=new Map,this._importComment=t.importComment,this._onLoadError=t.onLoadError}get registry(){return this._registry}async attachScript(t,e){try{const i=await this._registry.resolveRuntimeUrl(e);if(!i)return null;const s=await import(i+(this._importComment??""));let r=null;if("function"==typeof s?.default)if(r=new s.default,r instanceof Sx){if(!this._scriptHosts.has(r)){const t=r.onCreated();t instanceof Promise&&await t}}else r=null;if(!r)return console.warn(`Script '${e}' does not have RuntimeScript class exported as default`),null;let a=this._scriptHosts.get(r);if(a||(a=[],this._scriptHosts.set(r,a)),a.includes(t))return console.warn(`Script '${e}' already attached`),r;a.push(t);const n=r.onAttached(t);n instanceof Promise&&await n;const o={id:e,url:i,instance:r};let h=this._hostScripts.get(t);return h||(h=[],this._hostScripts.set(t,h),t&&t.on("dispose",()=>{this.detachScript(t)})),h.push(o),o.instance}catch(t){const i=e?String(e).slice(0,64):"";return console.error(`Load module '${i}' failed: ${t}`),this._onLoadError?.(t,e),null}}detachScript(t,e){const i=this._hostScripts.get(t);if(i&&0!==i.length){for(let s=i.length-1;s>=0;s--){const r=i[s];if(e&&"string"!=typeof e?r.instance===e:r.id===e){i.splice(s,1);try{r.instance.onDetached(t)}catch(t){console.error(`Error occured at onDetach() of module '${r.id}': ${t}`)}const e=this._scriptHosts.get(r.instance),a=e.indexOf(t);if(a>=0&&e.splice(a,1),0===e.length)try{r.instance.onDestroy()}catch(t){console.error(`Error occured at onDestroy() of module '${r.id}': ${t}`)}finally{this._scriptHosts.delete(r.instance)}}}0===i.length&&this._hostScripts.delete(t)}}getScriptObjects(t){return this._hostScripts.get(t)||[]}update(t,e){if(0!==this._hostScripts.size)for(const i of this._hostScripts.values())for(const s of i)try{s.instance.onUpdate(t,e)}catch(t){console.error(`Error occured at onUpdate() of module '${s.id}': ${t}`)}}detachAllScripts(){for(;this._hostScripts.size>0;)for(const t of this._hostScripts)this.detachScript(t[0])}}class Cx{_builtinsVFS;_scriptingSystem;_resourceManager;_enabled;_activeRenderables;_loadingScenes;constructor(t,e,i,s){t=t??new ft("./"),this._builtinsVFS=null,this._scriptingSystem=new Ax({VFS:t,scriptsRoot:e,editorMode:i}),this._resourceManager=new hx(t),this._enabled=s??!0,this._activeRenderables=[],this._loadingScenes=[]}get scriptingSystem(){return this._scriptingSystem}get VFS(){return this._scriptingSystem.registry.VFS}set VFS(t){t!==this._resourceManager.VFS&&(this._resourceManager.VFS?.close(),this._resourceManager.VFS=t,this._scriptingSystem.registry.VFS=t,this.ensureBuiltinVFS())}get resourceManager(){return this._resourceManager}async init(){await this.ensureBuiltinVFS()}detachAllScripts(){this._enabled&&this._scriptingSystem.detachAllScripts()}async attachScript(t,e){return this._enabled?await this._scriptingSystem.attachScript(t,e):null}detachScript(t,e){this._enabled&&this._scriptingSystem.detachScript(t,e)}getScriptObjects(t){return this._scriptingSystem.getScriptObjects(t)}update(t,e){this._enabled&&this._scriptingSystem.update(t,e)}async loadSceneFromFile(t){return t=this.VFS.normalizePath(t),this._loadingScenes[t]||(this._loadingScenes[t]=this._loadScene(t)),this._loadingScenes[t]}setRenderable(t,e=0,i){this._activeRenderables[e]||(this._activeRenderables[e]={renderable:new wt(null)}),this._activeRenderables[e].hook=i,this._activeRenderables[e].renderable.set(t)}async readFile(t,e){try{return await this.VFS.readFile(t,{encoding:e??"binary"})}catch(e){return console.error(`Read file '${t}' failed: ${e}`),null}}async startup(t,e,i){if(e){const t=await this.loadSceneFromFile(e);t&&this.setRenderable(t,9999)}if(i){const t=i.toLowerCase().endsWith(".ts")||i.toLowerCase().endsWith(".js")?i.slice(0,-3):i;await this.attachScript(null,t)}if(t){const e=await this.loadSceneFromFile(t);this.setRenderable(e,0)}this.setRenderable(null,9999)}render(){for(const t of Object.keys(this._activeRenderables)){const e=this._activeRenderables[t];(!e.hook?.beforeRender||(e.hook.beforeRender(e.renderable.get()??null)??!0))&&e.renderable.get()&&e.renderable.get().render(),e.hook?.afterRender&&e.hook.afterRender(e.renderable.get()??null)}}async ensureBuiltinVFS(){this._builtinsVFS||(this._builtinsVFS=await this.createBuiltinVFS()),this.VFS.unmount("/assets/@builtins"),this.VFS.mount("/assets/@builtins",this._builtinsVFS)}async createBuiltinVFS(){const t=new _t,e={"/primitives/box.zmsh":Um,"/primitives/sphere.zmsh":jm,"/primitives/cylinder.zmsh":Hm,"/primitives/plane.zmsh":Xm,"/primitives/torus.zmsh":Wm,"/primitives/tetrahedron.zmsh":Qm,"/materials/unlit.zmtl":ld,"/materials/lambert.zmtl":nd,"/materials/blinnphong.zmtl":hd,"/materials/pbr_metallic_roughness.zmtl":vd,"/materials/pbr_specular_glossiness.zmtl":Td};for(const i of Object.keys(e)){const s=new e[i];await this.writeSerializableObject(t,"Default",s,i),s.dispose()}return t.readOnly=!0,t}async writeSerializableObject(t,e,i,s){try{const r=await this.resourceManager.serializeObject(i),a=JSON.stringify({type:e,data:r},null,2);await t.writeFile(s,a,{encoding:"utf8",create:!0})}catch(t){console.error(`Write file '${s}' failed: ${t}`)}}async _loadScene(t){try{const e=await this._resourceManager.loadScene(t);if(e){if(e.script)try{await this.attachScript(e,e.script)}catch(t){console.error(`Attach script failed: ${t}`)}const t=[],i=[];if(e.rootNode.iterate(e=>{e.script&&(i.push(e.script),t.push(this.attachScript(e,e.script)))}),t.length>0){const e=await Promise.allSettled(t);for(let t=0;t<e.length;t++)"rejected"===e[t].status&&console.error(`Attach script failed: ${i[t]}`)}}return e}catch(e){return console.error(`Load scene from '${t}' failed: ${e}`),null}}}const Ex=new class extends b{_options;_device;_inputManager;_engine;_ready;constructor(t){if(super(),Tl)throw new Error("It is not allowed to have multiple Application instances");!function(t){Tl=t}(this),this._options={backend:t.backend,enableMSAA:t.enableMSAA??!1,pixelRatio:t.pixelRatio??window.devicePixelRatio??1,canvas:t.canvas},this._inputManager=new cx(this),this._engine=new Cx(t.runtimeOptions?.VFS,t.runtimeOptions?.scriptsRoot,t.runtimeOptions?.editorMode,t.runtimeOptions?.enabled),this._ready=!1}get inputManager(){return this._inputManager}get engine(){return this._engine}get options(){return this._options}get device(){return this._device}get deviceType(){return this._options.backend.typeName()}focus(){this._device.canvas.focus()}async ready(){if(!this._ready){if(this._device=await this._options.backend.createDevice(this._options.canvas,{dpr:this._options.pixelRatio,msaa:!!this._options.enableMSAA}),!this._device)throw new Error("App.init(): create device failed");this._device.canvas.focus(),await this._engine.init(),this._inputManager.start(),this._device.on("resize",(t,e)=>{this.dispatchEvent("resize",t,e)}),this._ready=!0}}frame(){if(function(){for(const t of vt)t.dispose(),bt.get(t)?.forEach(t=>{t.dispose()});vt.clear()}(),this._ready){this.device.setFramebuffer(null),this.device.setViewport(null),this.device.setScissor(null);const t=this.device.frameInfo.elapsedFrame,e=this.device.frameInfo.elapsedOverall;this.dispatchEvent("tick",t,e),this._engine.update(.001*t,.001*e),this._engine.render()}}run(){this.device.runLoop(()=>{this.frame()})}stop(){this.device.exitLoop()}}({backend:function(){if("webgpu"===function(t){return new URL(window.location.toString()).searchParams.get(t)||null}("dev")){if(yl.supported())return yl;console.warn("No WebGPU support, fall back to WebGL2")}return Ho.supported()?Ho:Go}(),canvas:document.querySelector("#canvas")});Ex.ready().then(async()=>{const t=new Df;t.env.sky.fogType="none",t.env.sky.skyType="scatter",t.env.light.radianceMap=t.env.sky.radianceMap,t.env.light.strength=.8;const e=new O_(t,Math.PI/3,1,1e3);e.position.setXYZ(200,0,12),e.controller=new ux,(Tl?.inputManager??null).use(e.handleEvent.bind(e));const i=new S_(t),s=new nx,r=await s.fetchModel(t,"https://cdn.zephyr3d.org/doc/assets/models/abandoned_building_room.glb");r.group.parent=i;const a=new Au(t);a.parent=r.group,a.position.y=151;const n=await s.fetchModel(t,"https://cdn.zephyr3d.org/doc/assets/models/cage/scene.gltf");n.group.scale.setXYZ(15,15,15),n.group.position.y=-40,n.group.parent=a;const o=new ld;o.albedoColor=new O(1,1,0,0);const h=new __(t,new jm({radius:.02}),o);h.position.y=.6,h.parent=n.group;const l=new H_(t).setCastShadow(!0).setColor(new O(1,1,.4,0)).setIntensity(2).setRange(1e4);l.shadow.mode="pcf-opt",l.shadow.pcfKernelSize=7,l.parent=h,Ex.on("resize",(t,i)=>{e.aspect=t/i});let u=0,c=0;Ex.on("tick",()=>{const i=Ex.device.frameInfo.elapsedOverall;0===u&&(u=i),c+=.01*Math.cos(.001*(i-u)),a.rotation.fromAxisAngle(new z(0,0,1),c),e.updateController(),e.render(t)}),Ex.run()});
//# sourceMappingURL=demo-8.js.map
